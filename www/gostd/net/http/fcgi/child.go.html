<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html" class="current">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6257773">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6257828">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6257882">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6257933">package</span>&nbsp;<span class="ident" id="6257941">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6257947">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6258021">import</span>&nbsp;<span class="op" id="6258028">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6258031">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6258041">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6258048">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6258054">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6258067">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6258074">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6258086">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6258102">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6258108">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6258119">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6258127">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6258134">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6258137">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="6258218">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="6258256">type</span>&nbsp;<span class="ident" id="6258261">request</span>&nbsp;<span class="keyword" id="6258269">struct</span>&nbsp;<span class="op" id="6258276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258279">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6258289">*</span><span class="ident" id="6258290">io</span><span class="op" id="6258292">.</span><span class="ident" id="6258293">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258305">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6258315">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258323">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6258333">map</span><span class="op" id="6258336">[</span><span class="builtintype" id="6258337">string</span><span class="op" id="6258343">]</span><span class="builtintype" id="6258344">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258352">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6258362">[</span><span class="num" id="6258363">1024</span><span class="op" id="6258367">]</span><span class="builtintype" id="6258368">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258374">rawParams</span>&nbsp;<span class="op" id="6258384">[</span><span class="op" id="6258385">]</span><span class="builtintype" id="6258386">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258392">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="6258402">bool</span><br>
<span class="lineno"></span><span class="op" id="6258407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6258410">func</span>&nbsp;<span class="ident" id="6258415">newRequest</span><span class="op" id="6258425">(</span><span class="ident" id="6258426">reqId</span>&nbsp;<span class="builtintype" id="6258432">uint16</span><span class="op" id="6258438">,</span>&nbsp;<span class="ident" id="6258440">flags</span>&nbsp;<span class="builtintype" id="6258446">uint8</span><span class="op" id="6258451">)</span>&nbsp;<span class="op" id="6258453">*</span><span class="ident" id="6258454">request</span>&nbsp;<span class="op" id="6258462">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258465">r</span>&nbsp;<span class="op" id="6258467">:=</span>&nbsp;<span class="op" id="6258470">&amp;</span><span class="ident" id="6258471">request</span><span class="op" id="6258478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258482">reqId</span><span class="op" id="6258487">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258492">reqId</span><span class="op" id="6258497">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258501">params</span><span class="op" id="6258507">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="6258511">map</span><span class="op" id="6258514">[</span><span class="builtintype" id="6258515">string</span><span class="op" id="6258521">]</span><span class="builtintype" id="6258522">string</span><span class="op" id="6258528">{</span><span class="op" id="6258529">}</span><span class="op" id="6258530">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258534">keepConn</span><span class="op" id="6258542">:</span>&nbsp;<span class="ident" id="6258544">flags</span><span class="op" id="6258549">&amp;</span><span class="ident" id="6258550">flagKeepConn</span>&nbsp;<span class="op" id="6258563">!=</span>&nbsp;<span class="num" id="6258566">0</span><span class="op" id="6258567">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6258570">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258573">r</span><span class="op" id="6258574">.</span><span class="ident" id="6258575">rawParams</span>&nbsp;<span class="op" id="6258585">=</span>&nbsp;<span class="ident" id="6258587">r</span><span class="op" id="6258588">.</span><span class="ident" id="6258589">buf</span><span class="op" id="6258592">[</span><span class="op" id="6258593">:</span><span class="num" id="6258594">0</span><span class="op" id="6258595">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6258598">return</span>&nbsp;<span class="ident" id="6258605">r</span><br>
<span class="lineno"></span><span class="op" id="6258607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6258610">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="6258662">func</span>&nbsp;<span class="op" id="6258667">(</span><span class="ident" id="6258668">r</span>&nbsp;<span class="op" id="6258670">*</span><span class="ident" id="6258671">request</span><span class="op" id="6258678">)</span>&nbsp;<span class="ident" id="6258680">parseParams</span><span class="op" id="6258691">(</span><span class="op" id="6258692">)</span>&nbsp;<span class="op" id="6258694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258697">text</span>&nbsp;<span class="op" id="6258702">:=</span>&nbsp;<span class="ident" id="6258705">r</span><span class="op" id="6258706">.</span><span class="ident" id="6258707">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258718">r</span><span class="op" id="6258719">.</span><span class="ident" id="6258720">rawParams</span>&nbsp;<span class="op" id="6258730">=</span>&nbsp;<span class="builtintype" id="6258732">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6258737">for</span>&nbsp;<span class="builtinfunc" id="6258741">len</span><span class="op" id="6258744">(</span><span class="ident" id="6258745">text</span><span class="op" id="6258749">)</span>&nbsp;<span class="op" id="6258751">&gt;</span>&nbsp;<span class="num" id="6258753">0</span>&nbsp;<span class="op" id="6258755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258759">keyLen</span><span class="op" id="6258765">,</span>&nbsp;<span class="ident" id="6258767">n</span>&nbsp;<span class="op" id="6258769">:=</span>&nbsp;<span class="ident" id="6258772">readSize</span><span class="op" id="6258780">(</span><span class="ident" id="6258781">text</span><span class="op" id="6258785">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6258789">if</span>&nbsp;<span class="ident" id="6258792">n</span>&nbsp;<span class="op" id="6258794">==</span>&nbsp;<span class="num" id="6258797">0</span>&nbsp;<span class="op" id="6258799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6258804">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6258813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258817">text</span>&nbsp;<span class="op" id="6258822">=</span>&nbsp;<span class="ident" id="6258824">text</span><span class="op" id="6258828">[</span><span class="ident" id="6258829">n</span><span class="op" id="6258830">:</span><span class="op" id="6258831">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258835">valLen</span><span class="op" id="6258841">,</span>&nbsp;<span class="ident" id="6258843">n</span>&nbsp;<span class="op" id="6258845">:=</span>&nbsp;<span class="ident" id="6258848">readSize</span><span class="op" id="6258856">(</span><span class="ident" id="6258857">text</span><span class="op" id="6258861">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6258865">if</span>&nbsp;<span class="ident" id="6258868">n</span>&nbsp;<span class="op" id="6258870">==</span>&nbsp;<span class="num" id="6258873">0</span>&nbsp;<span class="op" id="6258875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6258880">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6258889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258893">text</span>&nbsp;<span class="op" id="6258898">=</span>&nbsp;<span class="ident" id="6258900">text</span><span class="op" id="6258904">[</span><span class="ident" id="6258905">n</span><span class="op" id="6258906">:</span><span class="op" id="6258907">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258911">key</span>&nbsp;<span class="op" id="6258915">:=</span>&nbsp;<span class="ident" id="6258918">readString</span><span class="op" id="6258928">(</span><span class="ident" id="6258929">text</span><span class="op" id="6258933">,</span>&nbsp;<span class="ident" id="6258935">keyLen</span><span class="op" id="6258941">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258945">text</span>&nbsp;<span class="op" id="6258950">=</span>&nbsp;<span class="ident" id="6258952">text</span><span class="op" id="6258956">[</span><span class="ident" id="6258957">keyLen</span><span class="op" id="6258963">:</span><span class="op" id="6258964">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6258968">val</span>&nbsp;<span class="op" id="6258972">:=</span>&nbsp;<span class="ident" id="6258975">readString</span><span class="op" id="6258985">(</span><span class="ident" id="6258986">text</span><span class="op" id="6258990">,</span>&nbsp;<span class="ident" id="6258992">valLen</span><span class="op" id="6258998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259002">text</span>&nbsp;<span class="op" id="6259007">=</span>&nbsp;<span class="ident" id="6259009">text</span><span class="op" id="6259013">[</span><span class="ident" id="6259014">valLen</span><span class="op" id="6259020">:</span><span class="op" id="6259021">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259025">r</span><span class="op" id="6259026">.</span><span class="ident" id="6259027">params</span><span class="op" id="6259033">[</span><span class="ident" id="6259034">key</span><span class="op" id="6259037">]</span>&nbsp;<span class="op" id="6259039">=</span>&nbsp;<span class="ident" id="6259041">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6259046">}</span><br>
<span class="lineno">65</span><span class="op" id="6259048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6259051">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="6259095">type</span>&nbsp;<span class="ident" id="6259100">response</span>&nbsp;<span class="keyword" id="6259109">struct</span>&nbsp;<span class="op" id="6259116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259119">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6259131">*</span><span class="ident" id="6259132">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259141">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259153">http</span><span class="op" id="6259157">.</span><span class="ident" id="6259158">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259166">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6259178">*</span><span class="ident" id="6259179">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259190">wroteHeader</span>&nbsp;<span class="builtintype" id="6259202">bool</span><br>
<span class="lineno"></span><span class="op" id="6259207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="6259210">func</span>&nbsp;<span class="ident" id="6259215">newResponse</span><span class="op" id="6259226">(</span><span class="ident" id="6259227">c</span>&nbsp;<span class="op" id="6259229">*</span><span class="ident" id="6259230">child</span><span class="op" id="6259235">,</span>&nbsp;<span class="ident" id="6259237">req</span>&nbsp;<span class="op" id="6259241">*</span><span class="ident" id="6259242">request</span><span class="op" id="6259249">)</span>&nbsp;<span class="op" id="6259251">*</span><span class="ident" id="6259252">response</span>&nbsp;<span class="op" id="6259261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6259264">return</span>&nbsp;<span class="op" id="6259271">&amp;</span><span class="ident" id="6259272">response</span><span class="op" id="6259280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259284">req</span><span class="op" id="6259287">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259292">req</span><span class="op" id="6259295">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259299">header</span><span class="op" id="6259305">:</span>&nbsp;<span class="ident" id="6259307">http</span><span class="op" id="6259311">.</span><span class="ident" id="6259312">Header</span><span class="op" id="6259318">{</span><span class="op" id="6259319">}</span><span class="op" id="6259320">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259324">w</span><span class="op" id="6259325">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259332">newWriter</span><span class="op" id="6259341">(</span><span class="ident" id="6259342">c</span><span class="op" id="6259343">.</span><span class="ident" id="6259344">conn</span><span class="op" id="6259348">,</span>&nbsp;<span class="ident" id="6259350">typeStdout</span><span class="op" id="6259360">,</span>&nbsp;<span class="ident" id="6259362">req</span><span class="op" id="6259365">.</span><span class="ident" id="6259366">reqId</span><span class="op" id="6259371">)</span><span class="op" id="6259372">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6259375">}</span><br>
<span class="lineno"></span><span class="op" id="6259377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6259380">func</span>&nbsp;<span class="op" id="6259385">(</span><span class="ident" id="6259386">r</span>&nbsp;<span class="op" id="6259388">*</span><span class="ident" id="6259389">response</span><span class="op" id="6259397">)</span>&nbsp;<span class="ident" id="6259399">Header</span><span class="op" id="6259405">(</span><span class="op" id="6259406">)</span>&nbsp;<span class="ident" id="6259408">http</span><span class="op" id="6259412">.</span><span class="ident" id="6259413">Header</span>&nbsp;<span class="op" id="6259420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6259423">return</span>&nbsp;<span class="ident" id="6259430">r</span><span class="op" id="6259431">.</span><span class="ident" id="6259432">header</span><br>
<span class="lineno">85</span><span class="op" id="6259439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6259442">func</span>&nbsp;<span class="op" id="6259447">(</span><span class="ident" id="6259448">r</span>&nbsp;<span class="op" id="6259450">*</span><span class="ident" id="6259451">response</span><span class="op" id="6259459">)</span>&nbsp;<span class="ident" id="6259461">Write</span><span class="op" id="6259466">(</span><span class="ident" id="6259467">data</span>&nbsp;<span class="op" id="6259472">[</span><span class="op" id="6259473">]</span><span class="builtintype" id="6259474">byte</span><span class="op" id="6259478">)</span>&nbsp;<span class="op" id="6259480">(</span><span class="builtintype" id="6259481">int</span><span class="op" id="6259484">,</span>&nbsp;<span class="builtintype" id="6259486">error</span><span class="op" id="6259491">)</span>&nbsp;<span class="op" id="6259493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6259496">if</span>&nbsp;<span class="op" id="6259499">!</span><span class="ident" id="6259500">r</span><span class="op" id="6259501">.</span><span class="ident" id="6259502">wroteHeader</span>&nbsp;<span class="op" id="6259514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259518">r</span><span class="op" id="6259519">.</span><span class="ident" id="6259520">WriteHeader</span><span class="op" id="6259531">(</span><span class="ident" id="6259532">http</span><span class="op" id="6259536">.</span><span class="ident" id="6259537">StatusOK</span><span class="op" id="6259545">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6259548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6259551">return</span>&nbsp;<span class="ident" id="6259558">r</span><span class="op" id="6259559">.</span><span class="ident" id="6259560">w</span><span class="op" id="6259561">.</span><span class="ident" id="6259562">Write</span><span class="op" id="6259567">(</span><span class="ident" id="6259568">data</span><span class="op" id="6259572">)</span><br>
<span class="lineno"></span><span class="op" id="6259574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6259577">func</span>&nbsp;<span class="op" id="6259582">(</span><span class="ident" id="6259583">r</span>&nbsp;<span class="op" id="6259585">*</span><span class="ident" id="6259586">response</span><span class="op" id="6259594">)</span>&nbsp;<span class="ident" id="6259596">WriteHeader</span><span class="op" id="6259607">(</span><span class="ident" id="6259608">code</span>&nbsp;<span class="builtintype" id="6259613">int</span><span class="op" id="6259616">)</span>&nbsp;<span class="op" id="6259618">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6259621">if</span>&nbsp;<span class="ident" id="6259624">r</span><span class="op" id="6259625">.</span><span class="ident" id="6259626">wroteHeader</span>&nbsp;<span class="op" id="6259638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6259642">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6259650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259653">r</span><span class="op" id="6259654">.</span><span class="ident" id="6259655">wroteHeader</span>&nbsp;<span class="op" id="6259667">=</span>&nbsp;<span class="builtintype" id="6259669">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6259675">if</span>&nbsp;<span class="ident" id="6259678">code</span>&nbsp;<span class="op" id="6259683">==</span>&nbsp;<span class="ident" id="6259686">http</span><span class="op" id="6259690">.</span><span class="ident" id="6259691">StatusNotModified</span>&nbsp;<span class="op" id="6259709">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6259713">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259738">r</span><span class="op" id="6259739">.</span><span class="ident" id="6259740">header</span><span class="op" id="6259746">.</span><span class="ident" id="6259747">Del</span><span class="op" id="6259750">(</span><span class="string" id="6259751">&#34;Content-Type&#34;</span><span class="op" id="6259765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259769">r</span><span class="op" id="6259770">.</span><span class="ident" id="6259771">header</span><span class="op" id="6259777">.</span><span class="ident" id="6259778">Del</span><span class="op" id="6259781">(</span><span class="string" id="6259782">&#34;Content-Length&#34;</span><span class="op" id="6259798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259802">r</span><span class="op" id="6259803">.</span><span class="ident" id="6259804">header</span><span class="op" id="6259810">.</span><span class="ident" id="6259811">Del</span><span class="op" id="6259814">(</span><span class="string" id="6259815">&#34;Transfer-Encoding&#34;</span><span class="op" id="6259834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6259837">}</span>&nbsp;<span class="keyword" id="6259839">else</span>&nbsp;<span class="keyword" id="6259844">if</span>&nbsp;<span class="ident" id="6259847">r</span><span class="op" id="6259848">.</span><span class="ident" id="6259849">header</span><span class="op" id="6259855">.</span><span class="ident" id="6259856">Get</span><span class="op" id="6259859">(</span><span class="string" id="6259860">&#34;Content-Type&#34;</span><span class="op" id="6259874">)</span>&nbsp;<span class="op" id="6259876">==</span>&nbsp;<span class="string" id="6259879">&#34;&#34;</span>&nbsp;<span class="op" id="6259882">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259886">r</span><span class="op" id="6259887">.</span><span class="ident" id="6259888">header</span><span class="op" id="6259894">.</span><span class="ident" id="6259895">Set</span><span class="op" id="6259898">(</span><span class="string" id="6259899">&#34;Content-Type&#34;</span><span class="op" id="6259913">,</span>&nbsp;<span class="string" id="6259915">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6259941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6259944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6259948">if</span>&nbsp;<span class="ident" id="6259951">r</span><span class="op" id="6259952">.</span><span class="ident" id="6259953">header</span><span class="op" id="6259959">.</span><span class="ident" id="6259960">Get</span><span class="op" id="6259963">(</span><span class="string" id="6259964">&#34;Date&#34;</span><span class="op" id="6259970">)</span>&nbsp;<span class="op" id="6259972">==</span>&nbsp;<span class="string" id="6259975">&#34;&#34;</span>&nbsp;<span class="op" id="6259978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259982">r</span><span class="op" id="6259983">.</span><span class="ident" id="6259984">header</span><span class="op" id="6259990">.</span><span class="ident" id="6259991">Set</span><span class="op" id="6259994">(</span><span class="string" id="6259995">&#34;Date&#34;</span><span class="op" id="6260001">,</span>&nbsp;<span class="ident" id="6260003">time</span><span class="op" id="6260007">.</span><span class="ident" id="6260008">Now</span><span class="op" id="6260011">(</span><span class="op" id="6260012">)</span><span class="op" id="6260013">.</span><span class="ident" id="6260014">UTC</span><span class="op" id="6260017">(</span><span class="op" id="6260018">)</span><span class="op" id="6260019">.</span><span class="ident" id="6260020">Format</span><span class="op" id="6260026">(</span><span class="ident" id="6260027">http</span><span class="op" id="6260031">.</span><span class="ident" id="6260032">TimeFormat</span><span class="op" id="6260042">)</span><span class="op" id="6260043">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6260046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260050">fmt</span><span class="op" id="6260053">.</span><span class="ident" id="6260054">Fprintf</span><span class="op" id="6260061">(</span><span class="ident" id="6260062">r</span><span class="op" id="6260063">.</span><span class="ident" id="6260064">w</span><span class="op" id="6260065">,</span>&nbsp;<span class="string" id="6260067">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6260086">,</span>&nbsp;<span class="ident" id="6260088">code</span><span class="op" id="6260092">,</span>&nbsp;<span class="ident" id="6260094">http</span><span class="op" id="6260098">.</span><span class="ident" id="6260099">StatusText</span><span class="op" id="6260109">(</span><span class="ident" id="6260110">code</span><span class="op" id="6260114">)</span><span class="op" id="6260115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260118">r</span><span class="op" id="6260119">.</span><span class="ident" id="6260120">header</span><span class="op" id="6260126">.</span><span class="ident" id="6260127">Write</span><span class="op" id="6260132">(</span><span class="ident" id="6260133">r</span><span class="op" id="6260134">.</span><span class="ident" id="6260135">w</span><span class="op" id="6260136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260139">r</span><span class="op" id="6260140">.</span><span class="ident" id="6260141">w</span><span class="op" id="6260142">.</span><span class="ident" id="6260143">WriteString</span><span class="op" id="6260154">(</span><span class="string" id="6260155">&#34;\r\n&#34;</span><span class="op" id="6260161">)</span><br>
<span class="lineno">115</span><span class="op" id="6260163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6260166">func</span>&nbsp;<span class="op" id="6260171">(</span><span class="ident" id="6260172">r</span>&nbsp;<span class="op" id="6260174">*</span><span class="ident" id="6260175">response</span><span class="op" id="6260183">)</span>&nbsp;<span class="ident" id="6260185">Flush</span><span class="op" id="6260190">(</span><span class="op" id="6260191">)</span>&nbsp;<span class="op" id="6260193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6260196">if</span>&nbsp;<span class="op" id="6260199">!</span><span class="ident" id="6260200">r</span><span class="op" id="6260201">.</span><span class="ident" id="6260202">wroteHeader</span>&nbsp;<span class="op" id="6260214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260218">r</span><span class="op" id="6260219">.</span><span class="ident" id="6260220">WriteHeader</span><span class="op" id="6260231">(</span><span class="ident" id="6260232">http</span><span class="op" id="6260236">.</span><span class="ident" id="6260237">StatusOK</span><span class="op" id="6260245">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6260248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260251">r</span><span class="op" id="6260252">.</span><span class="ident" id="6260253">w</span><span class="op" id="6260254">.</span><span class="ident" id="6260255">Flush</span><span class="op" id="6260260">(</span><span class="op" id="6260261">)</span><br>
<span class="lineno"></span><span class="op" id="6260263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6260266">func</span>&nbsp;<span class="op" id="6260271">(</span><span class="ident" id="6260272">r</span>&nbsp;<span class="op" id="6260274">*</span><span class="ident" id="6260275">response</span><span class="op" id="6260283">)</span>&nbsp;<span class="ident" id="6260285">Close</span><span class="op" id="6260290">(</span><span class="op" id="6260291">)</span>&nbsp;<span class="builtintype" id="6260293">error</span>&nbsp;<span class="op" id="6260299">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260302">r</span><span class="op" id="6260303">.</span><span class="ident" id="6260304">Flush</span><span class="op" id="6260309">(</span><span class="op" id="6260310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6260313">return</span>&nbsp;<span class="ident" id="6260320">r</span><span class="op" id="6260321">.</span><span class="ident" id="6260322">w</span><span class="op" id="6260323">.</span><span class="ident" id="6260324">Close</span><span class="op" id="6260329">(</span><span class="op" id="6260330">)</span><br>
<span class="lineno"></span><span class="op" id="6260332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6260335">type</span>&nbsp;<span class="ident" id="6260340">child</span>&nbsp;<span class="keyword" id="6260346">struct</span>&nbsp;<span class="op" id="6260353">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260356">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6260364">*</span><span class="ident" id="6260365">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260371">handler</span>&nbsp;<span class="ident" id="6260379">http</span><span class="op" id="6260383">.</span><span class="ident" id="6260384">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260394">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260403">sync</span><span class="op" id="6260407">.</span><span class="ident" id="6260408">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6260423">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260446">requests</span>&nbsp;<span class="keyword" id="6260455">map</span><span class="op" id="6260458">[</span><span class="builtintype" id="6260459">uint16</span><span class="op" id="6260465">]</span><span class="op" id="6260466">*</span><span class="ident" id="6260467">request</span>&nbsp;<span class="comment" id="6260475">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="6260498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6260501">func</span>&nbsp;<span class="ident" id="6260506">newChild</span><span class="op" id="6260514">(</span><span class="ident" id="6260515">rwc</span>&nbsp;<span class="ident" id="6260519">io</span><span class="op" id="6260521">.</span><span class="ident" id="6260522">ReadWriteCloser</span><span class="op" id="6260537">,</span>&nbsp;<span class="ident" id="6260539">handler</span>&nbsp;<span class="ident" id="6260547">http</span><span class="op" id="6260551">.</span><span class="ident" id="6260552">Handler</span><span class="op" id="6260559">)</span>&nbsp;<span class="op" id="6260561">*</span><span class="ident" id="6260562">child</span>&nbsp;<span class="op" id="6260568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6260571">return</span>&nbsp;<span class="op" id="6260578">&amp;</span><span class="ident" id="6260579">child</span><span class="op" id="6260584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260588">conn</span><span class="op" id="6260592">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260598">newConn</span><span class="op" id="6260605">(</span><span class="ident" id="6260606">rwc</span><span class="op" id="6260609">)</span><span class="op" id="6260610">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260614">handler</span><span class="op" id="6260621">:</span>&nbsp;&nbsp;<span class="ident" id="6260624">handler</span><span class="op" id="6260631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6260635">requests</span><span class="op" id="6260643">:</span>&nbsp;<span class="builtinfunc" id="6260645">make</span><span class="op" id="6260649">(</span><span class="keyword" id="6260650">map</span><span class="op" id="6260653">[</span><span class="builtintype" id="6260654">uint16</span><span class="op" id="6260660">]</span><span class="op" id="6260661">*</span><span class="ident" id="6260662">request</span><span class="op" id="6260669">)</span><span class="op" id="6260670">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6260673">}</span><br>
<span class="lineno"></span><span class="op" id="6260675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6260678">func</span>&nbsp;<span class="op" id="6260683">(</span><span class="ident" id="6260684">c</span>&nbsp;<span class="op" id="6260686">*</span><span class="ident" id="6260687">child</span><span class="op" id="6260692">)</span>&nbsp;<span class="ident" id="6260694">serve</span><span class="op" id="6260699">(</span><span class="op" id="6260700">)</span>&nbsp;<span class="op" id="6260702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6260705">defer</span>&nbsp;<span class="ident" id="6260711">c</span><span class="op" id="6260712">.</span><span class="ident" id="6260713">conn</span><span class="op" id="6260717">.</span><span class="ident" id="6260718">Close</span><span class="op" id="6260723">(</span><span class="op" id="6260724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6260727">var</span>&nbsp;<span class="ident" id="6260731">rec</span>&nbsp;<span class="ident" id="6260735">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6260743">for</span>&nbsp;<span class="op" id="6260747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6260751">if</span>&nbsp;<span class="ident" id="6260754">err</span>&nbsp;<span class="op" id="6260758">:=</span>&nbsp;<span class="ident" id="6260761">rec</span><span class="op" id="6260764">.</span><span class="ident" id="6260765">read</span><span class="op" id="6260769">(</span><span class="ident" id="6260770">c</span><span class="op" id="6260771">.</span><span class="ident" id="6260772">conn</span><span class="op" id="6260776">.</span><span class="ident" id="6260777">rwc</span><span class="op" id="6260780">)</span><span class="op" id="6260781">;</span>&nbsp;<span class="ident" id="6260783">err</span>&nbsp;<span class="op" id="6260787">!=</span>&nbsp;<span class="builtintype" id="6260790">nil</span>&nbsp;<span class="op" id="6260794">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6260799">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6260808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6260812">if</span>&nbsp;<span class="ident" id="6260815">err</span>&nbsp;<span class="op" id="6260819">:=</span>&nbsp;<span class="ident" id="6260822">c</span><span class="op" id="6260823">.</span><span class="ident" id="6260824">handleRecord</span><span class="op" id="6260836">(</span><span class="op" id="6260837">&amp;</span><span class="ident" id="6260838">rec</span><span class="op" id="6260841">)</span><span class="op" id="6260842">;</span>&nbsp;<span class="ident" id="6260844">err</span>&nbsp;<span class="op" id="6260848">!=</span>&nbsp;<span class="builtintype" id="6260851">nil</span>&nbsp;<span class="op" id="6260855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6260860">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6260869">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6260872">}</span><br>
<span class="lineno"></span><span class="op" id="6260874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6260877">var</span>&nbsp;<span class="ident" id="6260881">errCloseConn</span>&nbsp;<span class="op" id="6260894">=</span>&nbsp;<span class="ident" id="6260896">errors</span><span class="op" id="6260902">.</span><span class="ident" id="6260903">New</span><span class="op" id="6260906">(</span><span class="string" id="6260907">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6260942">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="6260945">var</span>&nbsp;<span class="ident" id="6260949">emptyBody</span>&nbsp;<span class="op" id="6260959">=</span>&nbsp;<span class="ident" id="6260961">ioutil</span><span class="op" id="6260967">.</span><span class="ident" id="6260968">NopCloser</span><span class="op" id="6260977">(</span><span class="ident" id="6260978">strings</span><span class="op" id="6260985">.</span><span class="ident" id="6260986">NewReader</span><span class="op" id="6260995">(</span><span class="string" id="6260996">&#34;&#34;</span><span class="op" id="6260998">)</span><span class="op" id="6260999">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6261002">func</span>&nbsp;<span class="op" id="6261007">(</span><span class="ident" id="6261008">c</span>&nbsp;<span class="op" id="6261010">*</span><span class="ident" id="6261011">child</span><span class="op" id="6261016">)</span>&nbsp;<span class="ident" id="6261018">handleRecord</span><span class="op" id="6261030">(</span><span class="ident" id="6261031">rec</span>&nbsp;<span class="op" id="6261035">*</span><span class="ident" id="6261036">record</span><span class="op" id="6261042">)</span>&nbsp;<span class="builtintype" id="6261044">error</span>&nbsp;<span class="op" id="6261050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6261053">c</span><span class="op" id="6261054">.</span><span class="ident" id="6261055">mu</span><span class="op" id="6261057">.</span><span class="ident" id="6261058">Lock</span><span class="op" id="6261062">(</span><span class="op" id="6261063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6261066">req</span><span class="op" id="6261069">,</span>&nbsp;<span class="ident" id="6261071">ok</span>&nbsp;<span class="op" id="6261074">:=</span>&nbsp;<span class="ident" id="6261077">c</span><span class="op" id="6261078">.</span><span class="ident" id="6261079">requests</span><span class="op" id="6261087">[</span><span class="ident" id="6261088">rec</span><span class="op" id="6261091">.</span><span class="ident" id="6261092">h</span><span class="op" id="6261093">.</span><span class="ident" id="6261094">Id</span><span class="op" id="6261096">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6261099">c</span><span class="op" id="6261100">.</span><span class="ident" id="6261101">mu</span><span class="op" id="6261103">.</span><span class="ident" id="6261104">Unlock</span><span class="op" id="6261110">(</span><span class="op" id="6261111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261114">if</span>&nbsp;<span class="op" id="6261117">!</span><span class="ident" id="6261118">ok</span>&nbsp;<span class="op" id="6261121">&amp;&amp;</span>&nbsp;<span class="ident" id="6261124">rec</span><span class="op" id="6261127">.</span><span class="ident" id="6261128">h</span><span class="op" id="6261129">.</span><span class="ident" id="6261130">Type</span>&nbsp;<span class="op" id="6261135">!=</span>&nbsp;<span class="ident" id="6261138">typeBeginRequest</span>&nbsp;<span class="op" id="6261155">&amp;&amp;</span>&nbsp;<span class="ident" id="6261158">rec</span><span class="op" id="6261161">.</span><span class="ident" id="6261162">h</span><span class="op" id="6261163">.</span><span class="ident" id="6261164">Type</span>&nbsp;<span class="op" id="6261169">!=</span>&nbsp;<span class="ident" id="6261172">typeGetValues</span>&nbsp;<span class="op" id="6261186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6261190">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261240">return</span>&nbsp;<span class="builtintype" id="6261247">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6261252">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261256">switch</span>&nbsp;<span class="ident" id="6261263">rec</span><span class="op" id="6261266">.</span><span class="ident" id="6261267">h</span><span class="op" id="6261268">.</span><span class="ident" id="6261269">Type</span>&nbsp;<span class="op" id="6261274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261277">case</span>&nbsp;<span class="ident" id="6261282">typeBeginRequest</span><span class="op" id="6261298">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261302">if</span>&nbsp;<span class="ident" id="6261305">req</span>&nbsp;<span class="op" id="6261309">!=</span>&nbsp;<span class="builtintype" id="6261312">nil</span>&nbsp;<span class="op" id="6261316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6261321">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6261384">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261435">return</span>&nbsp;<span class="ident" id="6261442">errors</span><span class="op" id="6261448">.</span><span class="ident" id="6261449">New</span><span class="op" id="6261452">(</span><span class="string" id="6261453">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="6261498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6261502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261507">var</span>&nbsp;<span class="ident" id="6261511">br</span>&nbsp;<span class="ident" id="6261514">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261529">if</span>&nbsp;<span class="ident" id="6261532">err</span>&nbsp;<span class="op" id="6261536">:=</span>&nbsp;<span class="ident" id="6261539">br</span><span class="op" id="6261541">.</span><span class="ident" id="6261542">read</span><span class="op" id="6261546">(</span><span class="ident" id="6261547">rec</span><span class="op" id="6261550">.</span><span class="ident" id="6261551">content</span><span class="op" id="6261558">(</span><span class="op" id="6261559">)</span><span class="op" id="6261560">)</span><span class="op" id="6261561">;</span>&nbsp;<span class="ident" id="6261563">err</span>&nbsp;<span class="op" id="6261567">!=</span>&nbsp;<span class="builtintype" id="6261570">nil</span>&nbsp;<span class="op" id="6261574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261579">return</span>&nbsp;<span class="ident" id="6261586">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6261592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261596">if</span>&nbsp;<span class="ident" id="6261599">br</span><span class="op" id="6261601">.</span><span class="ident" id="6261602">role</span>&nbsp;<span class="op" id="6261607">!=</span>&nbsp;<span class="ident" id="6261610">roleResponder</span>&nbsp;<span class="op" id="6261624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6261629">c</span><span class="op" id="6261630">.</span><span class="ident" id="6261631">conn</span><span class="op" id="6261635">.</span><span class="ident" id="6261636">writeEndRequest</span><span class="op" id="6261651">(</span><span class="ident" id="6261652">rec</span><span class="op" id="6261655">.</span><span class="ident" id="6261656">h</span><span class="op" id="6261657">.</span><span class="ident" id="6261658">Id</span><span class="op" id="6261660">,</span>&nbsp;<span class="num" id="6261662">0</span><span class="op" id="6261663">,</span>&nbsp;<span class="ident" id="6261665">statusUnknownRole</span><span class="op" id="6261682">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261687">return</span>&nbsp;<span class="builtintype" id="6261694">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6261700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6261704">req</span>&nbsp;<span class="op" id="6261708">=</span>&nbsp;<span class="ident" id="6261710">newRequest</span><span class="op" id="6261720">(</span><span class="ident" id="6261721">rec</span><span class="op" id="6261724">.</span><span class="ident" id="6261725">h</span><span class="op" id="6261726">.</span><span class="ident" id="6261727">Id</span><span class="op" id="6261729">,</span>&nbsp;<span class="ident" id="6261731">br</span><span class="op" id="6261733">.</span><span class="ident" id="6261734">flags</span><span class="op" id="6261739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6261743">c</span><span class="op" id="6261744">.</span><span class="ident" id="6261745">mu</span><span class="op" id="6261747">.</span><span class="ident" id="6261748">Lock</span><span class="op" id="6261752">(</span><span class="op" id="6261753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6261757">c</span><span class="op" id="6261758">.</span><span class="ident" id="6261759">requests</span><span class="op" id="6261767">[</span><span class="ident" id="6261768">rec</span><span class="op" id="6261771">.</span><span class="ident" id="6261772">h</span><span class="op" id="6261773">.</span><span class="ident" id="6261774">Id</span><span class="op" id="6261776">]</span>&nbsp;<span class="op" id="6261778">=</span>&nbsp;<span class="ident" id="6261780">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6261786">c</span><span class="op" id="6261787">.</span><span class="ident" id="6261788">mu</span><span class="op" id="6261790">.</span><span class="ident" id="6261791">Unlock</span><span class="op" id="6261797">(</span><span class="op" id="6261798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261802">return</span>&nbsp;<span class="builtintype" id="6261809">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261814">case</span>&nbsp;<span class="ident" id="6261819">typeParams</span><span class="op" id="6261829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6261833">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6261904">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6261977">if</span>&nbsp;<span class="builtinfunc" id="6261980">len</span><span class="op" id="6261983">(</span><span class="ident" id="6261984">rec</span><span class="op" id="6261987">.</span><span class="ident" id="6261988">content</span><span class="op" id="6261995">(</span><span class="op" id="6261996">)</span><span class="op" id="6261997">)</span>&nbsp;<span class="op" id="6261999">&gt;</span>&nbsp;<span class="num" id="6262001">0</span>&nbsp;<span class="op" id="6262003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6262008">req</span><span class="op" id="6262011">.</span><span class="ident" id="6262012">rawParams</span>&nbsp;<span class="op" id="6262022">=</span>&nbsp;<span class="builtinfunc" id="6262024">append</span><span class="op" id="6262030">(</span><span class="ident" id="6262031">req</span><span class="op" id="6262034">.</span><span class="ident" id="6262035">rawParams</span><span class="op" id="6262044">,</span>&nbsp;<span class="ident" id="6262046">rec</span><span class="op" id="6262049">.</span><span class="ident" id="6262050">content</span><span class="op" id="6262057">(</span><span class="op" id="6262058">)</span><span class="op" id="6262059">...</span><span class="op" id="6262062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262067">return</span>&nbsp;<span class="builtintype" id="6262074">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6262080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6262084">req</span><span class="op" id="6262087">.</span><span class="ident" id="6262088">parseParams</span><span class="op" id="6262099">(</span><span class="op" id="6262100">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262104">return</span>&nbsp;<span class="builtintype" id="6262111">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262116">case</span>&nbsp;<span class="ident" id="6262121">typeStdin</span><span class="op" id="6262130">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6262134">content</span>&nbsp;<span class="op" id="6262142">:=</span>&nbsp;<span class="ident" id="6262145">rec</span><span class="op" id="6262148">.</span><span class="ident" id="6262149">content</span><span class="op" id="6262156">(</span><span class="op" id="6262157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262161">if</span>&nbsp;<span class="ident" id="6262164">req</span><span class="op" id="6262167">.</span><span class="ident" id="6262168">pw</span>&nbsp;<span class="op" id="6262171">==</span>&nbsp;<span class="builtintype" id="6262174">nil</span>&nbsp;<span class="op" id="6262178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262183">var</span>&nbsp;<span class="ident" id="6262187">body</span>&nbsp;<span class="ident" id="6262192">io</span><span class="op" id="6262194">.</span><span class="ident" id="6262195">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262209">if</span>&nbsp;<span class="builtinfunc" id="6262212">len</span><span class="op" id="6262215">(</span><span class="ident" id="6262216">content</span><span class="op" id="6262223">)</span>&nbsp;<span class="op" id="6262225">&gt;</span>&nbsp;<span class="num" id="6262227">0</span>&nbsp;<span class="op" id="6262229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6262235">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6262299">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6262342">body</span><span class="op" id="6262346">,</span>&nbsp;<span class="ident" id="6262348">req</span><span class="op" id="6262351">.</span><span class="ident" id="6262352">pw</span>&nbsp;<span class="op" id="6262355">=</span>&nbsp;<span class="ident" id="6262357">io</span><span class="op" id="6262359">.</span><span class="ident" id="6262360">Pipe</span><span class="op" id="6262364">(</span><span class="op" id="6262365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6262370">}</span>&nbsp;<span class="keyword" id="6262372">else</span>&nbsp;<span class="op" id="6262377">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6262383">body</span>&nbsp;<span class="op" id="6262388">=</span>&nbsp;<span class="ident" id="6262390">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6262403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262408">go</span>&nbsp;<span class="ident" id="6262411">c</span><span class="op" id="6262412">.</span><span class="ident" id="6262413">serveRequest</span><span class="op" id="6262425">(</span><span class="ident" id="6262426">req</span><span class="op" id="6262429">,</span>&nbsp;<span class="ident" id="6262431">body</span><span class="op" id="6262435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6262439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262443">if</span>&nbsp;<span class="builtinfunc" id="6262446">len</span><span class="op" id="6262449">(</span><span class="ident" id="6262450">content</span><span class="op" id="6262457">)</span>&nbsp;<span class="op" id="6262459">&gt;</span>&nbsp;<span class="num" id="6262461">0</span>&nbsp;<span class="op" id="6262463">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6262468">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6262536">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6262599">req</span><span class="op" id="6262602">.</span><span class="ident" id="6262603">pw</span><span class="op" id="6262605">.</span><span class="ident" id="6262606">Write</span><span class="op" id="6262611">(</span><span class="ident" id="6262612">content</span><span class="op" id="6262619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6262623">}</span>&nbsp;<span class="keyword" id="6262625">else</span>&nbsp;<span class="keyword" id="6262630">if</span>&nbsp;<span class="ident" id="6262633">req</span><span class="op" id="6262636">.</span><span class="ident" id="6262637">pw</span>&nbsp;<span class="op" id="6262640">!=</span>&nbsp;<span class="builtintype" id="6262643">nil</span>&nbsp;<span class="op" id="6262647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6262652">req</span><span class="op" id="6262655">.</span><span class="ident" id="6262656">pw</span><span class="op" id="6262658">.</span><span class="ident" id="6262659">Close</span><span class="op" id="6262664">(</span><span class="op" id="6262665">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6262669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262673">return</span>&nbsp;<span class="builtintype" id="6262680">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262685">case</span>&nbsp;<span class="ident" id="6262690">typeGetValues</span><span class="op" id="6262703">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6262707">values</span>&nbsp;<span class="op" id="6262714">:=</span>&nbsp;<span class="keyword" id="6262717">map</span><span class="op" id="6262720">[</span><span class="builtintype" id="6262721">string</span><span class="op" id="6262727">]</span><span class="builtintype" id="6262728">string</span><span class="op" id="6262734">{</span><span class="string" id="6262735">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="6262752">:</span>&nbsp;<span class="string" id="6262754">&#34;1&#34;</span><span class="op" id="6262757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6262761">c</span><span class="op" id="6262762">.</span><span class="ident" id="6262763">conn</span><span class="op" id="6262767">.</span><span class="ident" id="6262768">writePairs</span><span class="op" id="6262778">(</span><span class="ident" id="6262779">typeGetValuesResult</span><span class="op" id="6262798">,</span>&nbsp;<span class="num" id="6262800">0</span><span class="op" id="6262801">,</span>&nbsp;<span class="ident" id="6262803">values</span><span class="op" id="6262809">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262813">return</span>&nbsp;<span class="builtintype" id="6262820">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262825">case</span>&nbsp;<span class="ident" id="6262830">typeData</span><span class="op" id="6262838">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6262842">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262909">return</span>&nbsp;<span class="builtintype" id="6262916">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6262921">case</span>&nbsp;<span class="ident" id="6262926">typeAbortRequest</span><span class="op" id="6262942">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6262946">println</span><span class="op" id="6262953">(</span><span class="string" id="6262954">&#34;abort&#34;</span><span class="op" id="6262961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6262965">c</span><span class="op" id="6262966">.</span><span class="ident" id="6262967">mu</span><span class="op" id="6262969">.</span><span class="ident" id="6262970">Lock</span><span class="op" id="6262974">(</span><span class="op" id="6262975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6262979">delete</span><span class="op" id="6262985">(</span><span class="ident" id="6262986">c</span><span class="op" id="6262987">.</span><span class="ident" id="6262988">requests</span><span class="op" id="6262996">,</span>&nbsp;<span class="ident" id="6262998">rec</span><span class="op" id="6263001">.</span><span class="ident" id="6263002">h</span><span class="op" id="6263003">.</span><span class="ident" id="6263004">Id</span><span class="op" id="6263006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263010">c</span><span class="op" id="6263011">.</span><span class="ident" id="6263012">mu</span><span class="op" id="6263014">.</span><span class="ident" id="6263015">Unlock</span><span class="op" id="6263021">(</span><span class="op" id="6263022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263026">c</span><span class="op" id="6263027">.</span><span class="ident" id="6263028">conn</span><span class="op" id="6263032">.</span><span class="ident" id="6263033">writeEndRequest</span><span class="op" id="6263048">(</span><span class="ident" id="6263049">rec</span><span class="op" id="6263052">.</span><span class="ident" id="6263053">h</span><span class="op" id="6263054">.</span><span class="ident" id="6263055">Id</span><span class="op" id="6263057">,</span>&nbsp;<span class="num" id="6263059">0</span><span class="op" id="6263060">,</span>&nbsp;<span class="ident" id="6263062">statusRequestComplete</span><span class="op" id="6263083">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6263087">if</span>&nbsp;<span class="op" id="6263090">!</span><span class="ident" id="6263091">req</span><span class="op" id="6263094">.</span><span class="ident" id="6263095">keepConn</span>&nbsp;<span class="op" id="6263104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6263109">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6263149">return</span>&nbsp;<span class="ident" id="6263156">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6263171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6263175">return</span>&nbsp;<span class="builtintype" id="6263182">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6263187">default</span><span class="op" id="6263194">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263198">b</span>&nbsp;<span class="op" id="6263200">:=</span>&nbsp;<span class="builtinfunc" id="6263203">make</span><span class="op" id="6263207">(</span><span class="op" id="6263208">[</span><span class="op" id="6263209">]</span><span class="builtintype" id="6263210">byte</span><span class="op" id="6263214">,</span>&nbsp;<span class="num" id="6263216">8</span><span class="op" id="6263217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263221">b</span><span class="op" id="6263222">[</span><span class="num" id="6263223">0</span><span class="op" id="6263224">]</span>&nbsp;<span class="op" id="6263226">=</span>&nbsp;<span class="builtintype" id="6263228">byte</span><span class="op" id="6263232">(</span><span class="ident" id="6263233">rec</span><span class="op" id="6263236">.</span><span class="ident" id="6263237">h</span><span class="op" id="6263238">.</span><span class="ident" id="6263239">Type</span><span class="op" id="6263243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263247">c</span><span class="op" id="6263248">.</span><span class="ident" id="6263249">conn</span><span class="op" id="6263253">.</span><span class="ident" id="6263254">writeRecord</span><span class="op" id="6263265">(</span><span class="ident" id="6263266">typeUnknownType</span><span class="op" id="6263281">,</span>&nbsp;<span class="num" id="6263283">0</span><span class="op" id="6263284">,</span>&nbsp;<span class="ident" id="6263286">b</span><span class="op" id="6263287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6263291">return</span>&nbsp;<span class="builtintype" id="6263298">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6263303">}</span><br>
<span class="lineno"></span><span class="op" id="6263305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6263308">func</span>&nbsp;<span class="op" id="6263313">(</span><span class="ident" id="6263314">c</span>&nbsp;<span class="op" id="6263316">*</span><span class="ident" id="6263317">child</span><span class="op" id="6263322">)</span>&nbsp;<span class="ident" id="6263324">serveRequest</span><span class="op" id="6263336">(</span><span class="ident" id="6263337">req</span>&nbsp;<span class="op" id="6263341">*</span><span class="ident" id="6263342">request</span><span class="op" id="6263349">,</span>&nbsp;<span class="ident" id="6263351">body</span>&nbsp;<span class="ident" id="6263356">io</span><span class="op" id="6263358">.</span><span class="ident" id="6263359">ReadCloser</span><span class="op" id="6263369">)</span>&nbsp;<span class="op" id="6263371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263374">r</span>&nbsp;<span class="op" id="6263376">:=</span>&nbsp;<span class="ident" id="6263379">newResponse</span><span class="op" id="6263390">(</span><span class="ident" id="6263391">c</span><span class="op" id="6263392">,</span>&nbsp;<span class="ident" id="6263394">req</span><span class="op" id="6263397">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263400">httpReq</span><span class="op" id="6263407">,</span>&nbsp;<span class="ident" id="6263409">err</span>&nbsp;<span class="op" id="6263413">:=</span>&nbsp;<span class="ident" id="6263416">cgi</span><span class="op" id="6263419">.</span><span class="ident" id="6263420">RequestFromMap</span><span class="op" id="6263434">(</span><span class="ident" id="6263435">req</span><span class="op" id="6263438">.</span><span class="ident" id="6263439">params</span><span class="op" id="6263445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6263448">if</span>&nbsp;<span class="ident" id="6263451">err</span>&nbsp;<span class="op" id="6263455">!=</span>&nbsp;<span class="builtintype" id="6263458">nil</span>&nbsp;<span class="op" id="6263462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6263466">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263510">r</span><span class="op" id="6263511">.</span><span class="ident" id="6263512">WriteHeader</span><span class="op" id="6263523">(</span><span class="ident" id="6263524">http</span><span class="op" id="6263528">.</span><span class="ident" id="6263529">StatusInternalServerError</span><span class="op" id="6263554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263558">c</span><span class="op" id="6263559">.</span><span class="ident" id="6263560">conn</span><span class="op" id="6263564">.</span><span class="ident" id="6263565">writeRecord</span><span class="op" id="6263576">(</span><span class="ident" id="6263577">typeStderr</span><span class="op" id="6263587">,</span>&nbsp;<span class="ident" id="6263589">req</span><span class="op" id="6263592">.</span><span class="ident" id="6263593">reqId</span><span class="op" id="6263598">,</span>&nbsp;<span class="op" id="6263600">[</span><span class="op" id="6263601">]</span><span class="builtintype" id="6263602">byte</span><span class="op" id="6263606">(</span><span class="ident" id="6263607">err</span><span class="op" id="6263610">.</span><span class="ident" id="6263611">Error</span><span class="op" id="6263616">(</span><span class="op" id="6263617">)</span><span class="op" id="6263618">)</span><span class="op" id="6263619">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6263622">}</span>&nbsp;<span class="keyword" id="6263624">else</span>&nbsp;<span class="op" id="6263629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263633">httpReq</span><span class="op" id="6263640">.</span><span class="ident" id="6263641">Body</span>&nbsp;<span class="op" id="6263646">=</span>&nbsp;<span class="ident" id="6263648">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263655">c</span><span class="op" id="6263656">.</span><span class="ident" id="6263657">handler</span><span class="op" id="6263664">.</span><span class="ident" id="6263665">ServeHTTP</span><span class="op" id="6263674">(</span><span class="ident" id="6263675">r</span><span class="op" id="6263676">,</span>&nbsp;<span class="ident" id="6263678">httpReq</span><span class="op" id="6263685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6263688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263691">r</span><span class="op" id="6263692">.</span><span class="ident" id="6263693">Close</span><span class="op" id="6263698">(</span><span class="op" id="6263699">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263702">c</span><span class="op" id="6263703">.</span><span class="ident" id="6263704">mu</span><span class="op" id="6263706">.</span><span class="ident" id="6263707">Lock</span><span class="op" id="6263711">(</span><span class="op" id="6263712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6263715">delete</span><span class="op" id="6263721">(</span><span class="ident" id="6263722">c</span><span class="op" id="6263723">.</span><span class="ident" id="6263724">requests</span><span class="op" id="6263732">,</span>&nbsp;<span class="ident" id="6263734">req</span><span class="op" id="6263737">.</span><span class="ident" id="6263738">reqId</span><span class="op" id="6263743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263746">c</span><span class="op" id="6263747">.</span><span class="ident" id="6263748">mu</span><span class="op" id="6263750">.</span><span class="ident" id="6263751">Unlock</span><span class="op" id="6263757">(</span><span class="op" id="6263758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6263761">c</span><span class="op" id="6263762">.</span><span class="ident" id="6263763">conn</span><span class="op" id="6263767">.</span><span class="ident" id="6263768">writeEndRequest</span><span class="op" id="6263783">(</span><span class="ident" id="6263784">req</span><span class="op" id="6263787">.</span><span class="ident" id="6263788">reqId</span><span class="op" id="6263793">,</span>&nbsp;<span class="num" id="6263795">0</span><span class="op" id="6263796">,</span>&nbsp;<span class="ident" id="6263798">statusRequestComplete</span><span class="op" id="6263819">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6263823">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6263887">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6263948">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6264003">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6264061">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6264117">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6264175">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6264214">io</span><span class="op" id="6264216">.</span><span class="ident" id="6264217">CopyN</span><span class="op" id="6264222">(</span><span class="ident" id="6264223">ioutil</span><span class="op" id="6264229">.</span><span class="ident" id="6264230">Discard</span><span class="op" id="6264237">,</span>&nbsp;<span class="ident" id="6264239">body</span><span class="op" id="6264243">,</span>&nbsp;<span class="num" id="6264245">100</span><span class="op" id="6264248">&lt;&lt;</span><span class="num" id="6264250">20</span><span class="op" id="6264252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6264255">body</span><span class="op" id="6264259">.</span><span class="ident" id="6264260">Close</span><span class="op" id="6264265">(</span><span class="op" id="6264266">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6264270">if</span>&nbsp;<span class="op" id="6264273">!</span><span class="ident" id="6264274">req</span><span class="op" id="6264277">.</span><span class="ident" id="6264278">keepConn</span>&nbsp;<span class="op" id="6264287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6264291">c</span><span class="op" id="6264292">.</span><span class="ident" id="6264293">conn</span><span class="op" id="6264297">.</span><span class="ident" id="6264298">Close</span><span class="op" id="6264303">(</span><span class="op" id="6264304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6264307">}</span><br>
<span class="lineno"></span><span class="op" id="6264309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="6264312">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6264392">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="6264467">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="6264488">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="6264545">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="6264597">func</span>&nbsp;<span class="ident" id="6264602">Serve</span><span class="op" id="6264607">(</span><span class="ident" id="6264608">l</span>&nbsp;<span class="ident" id="6264610">net</span><span class="op" id="6264613">.</span><span class="ident" id="6264614">Listener</span><span class="op" id="6264622">,</span>&nbsp;<span class="ident" id="6264624">handler</span>&nbsp;<span class="ident" id="6264632">http</span><span class="op" id="6264636">.</span><span class="ident" id="6264637">Handler</span><span class="op" id="6264644">)</span>&nbsp;<span class="builtintype" id="6264646">error</span>&nbsp;<span class="op" id="6264652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6264655">if</span>&nbsp;<span class="ident" id="6264658">l</span>&nbsp;<span class="op" id="6264660">==</span>&nbsp;<span class="builtintype" id="6264663">nil</span>&nbsp;<span class="op" id="6264667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6264671">var</span>&nbsp;<span class="ident" id="6264675">err</span>&nbsp;<span class="builtintype" id="6264679">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6264687">l</span><span class="op" id="6264688">,</span>&nbsp;<span class="ident" id="6264690">err</span>&nbsp;<span class="op" id="6264694">=</span>&nbsp;<span class="ident" id="6264696">net</span><span class="op" id="6264699">.</span><span class="ident" id="6264700">FileListener</span><span class="op" id="6264712">(</span><span class="ident" id="6264713">os</span><span class="op" id="6264715">.</span><span class="ident" id="6264716">Stdin</span><span class="op" id="6264721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6264725">if</span>&nbsp;<span class="ident" id="6264728">err</span>&nbsp;<span class="op" id="6264732">!=</span>&nbsp;<span class="builtintype" id="6264735">nil</span>&nbsp;<span class="op" id="6264739">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6264744">return</span>&nbsp;<span class="ident" id="6264751">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6264757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6264761">defer</span>&nbsp;<span class="ident" id="6264767">l</span><span class="op" id="6264768">.</span><span class="ident" id="6264769">Close</span><span class="op" id="6264774">(</span><span class="op" id="6264775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6264778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6264781">if</span>&nbsp;<span class="ident" id="6264784">handler</span>&nbsp;<span class="op" id="6264792">==</span>&nbsp;<span class="builtintype" id="6264795">nil</span>&nbsp;<span class="op" id="6264799">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6264803">handler</span>&nbsp;<span class="op" id="6264811">=</span>&nbsp;<span class="ident" id="6264813">http</span><span class="op" id="6264817">.</span><span class="ident" id="6264818">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6264835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6264838">for</span>&nbsp;<span class="op" id="6264842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6264846">rw</span><span class="op" id="6264848">,</span>&nbsp;<span class="ident" id="6264850">err</span>&nbsp;<span class="op" id="6264854">:=</span>&nbsp;<span class="ident" id="6264857">l</span><span class="op" id="6264858">.</span><span class="ident" id="6264859">Accept</span><span class="op" id="6264865">(</span><span class="op" id="6264866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6264870">if</span>&nbsp;<span class="ident" id="6264873">err</span>&nbsp;<span class="op" id="6264877">!=</span>&nbsp;<span class="builtintype" id="6264880">nil</span>&nbsp;<span class="op" id="6264884">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6264889">return</span>&nbsp;<span class="ident" id="6264896">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6264902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6264906">c</span>&nbsp;<span class="op" id="6264908">:=</span>&nbsp;<span class="ident" id="6264911">newChild</span><span class="op" id="6264919">(</span><span class="ident" id="6264920">rw</span><span class="op" id="6264922">,</span>&nbsp;<span class="ident" id="6264924">handler</span><span class="op" id="6264931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6264935">go</span>&nbsp;<span class="ident" id="6264938">c</span><span class="op" id="6264939">.</span><span class="ident" id="6264940">serve</span><span class="op" id="6264945">(</span><span class="op" id="6264946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6264949">}</span><br>
<span class="lineno">305</span><span class="op" id="6264951">}</span>
</div>
</body>
</html>
