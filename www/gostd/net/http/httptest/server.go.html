<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httptest</h2>
<ul>
<li><a href="/gostd/net/http/httptest/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder.go.html">recorder.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder_test.go.html">recorder_test.go</a></li>
<li><a href="/gostd/net/http/httptest/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/httptest/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5947494">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5947549">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5947603">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5947654">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5947683">package</span>&nbsp;<span class="ident" id="5947691">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5947701">import</span>&nbsp;<span class="op" id="5947708">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5947711">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5947725">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5947733">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5947740">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5947747">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5947759">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5947765">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5947772">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5947775">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="5947846">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="5947909">type</span>&nbsp;<span class="ident" id="5947914">Server</span>&nbsp;<span class="keyword" id="5947921">struct</span>&nbsp;<span class="op" id="5947928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5947931">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5947940">string</span>&nbsp;<span class="comment" id="5947947">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948010">Listener</span>&nbsp;<span class="ident" id="5948019">net</span><span class="op" id="5948022">.</span><span class="ident" id="5948023">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5948034">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5948105">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5948177">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948240">TLS</span>&nbsp;<span class="op" id="5948244">*</span><span class="ident" id="5948245">tls</span><span class="op" id="5948248">.</span><span class="ident" id="5948249">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5948258">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5948321">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948351">Config</span>&nbsp;<span class="op" id="5948358">*</span><span class="ident" id="5948359">http</span><span class="op" id="5948363">.</span><span class="ident" id="5948364">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5948373">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5948443">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948493">wg</span>&nbsp;<span class="ident" id="5948496">sync</span><span class="op" id="5948500">.</span><span class="ident" id="5948501">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="5948511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5948514">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="5948579">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="5948592">type</span>&nbsp;<span class="ident" id="5948597">historyListener</span>&nbsp;<span class="keyword" id="5948613">struct</span>&nbsp;<span class="op" id="5948620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948623">net</span><span class="op" id="5948626">.</span><span class="ident" id="5948627">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948637">sync</span><span class="op" id="5948641">.</span><span class="ident" id="5948642">Mutex</span>&nbsp;<span class="comment" id="5948648">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948669">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5948680">[</span><span class="op" id="5948681">]</span><span class="ident" id="5948682">net</span><span class="op" id="5948685">.</span><span class="ident" id="5948686">Conn</span><br>
<span class="lineno">45</span><span class="op" id="5948691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5948694">func</span>&nbsp;<span class="op" id="5948699">(</span><span class="ident" id="5948700">hs</span>&nbsp;<span class="op" id="5948703">*</span><span class="ident" id="5948704">historyListener</span><span class="op" id="5948719">)</span>&nbsp;<span class="ident" id="5948721">Accept</span><span class="op" id="5948727">(</span><span class="op" id="5948728">)</span>&nbsp;<span class="op" id="5948730">(</span><span class="ident" id="5948731">c</span>&nbsp;<span class="ident" id="5948733">net</span><span class="op" id="5948736">.</span><span class="ident" id="5948737">Conn</span><span class="op" id="5948741">,</span>&nbsp;<span class="ident" id="5948743">err</span>&nbsp;<span class="builtintype" id="5948747">error</span><span class="op" id="5948752">)</span>&nbsp;<span class="op" id="5948754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948757">c</span><span class="op" id="5948758">,</span>&nbsp;<span class="ident" id="5948760">err</span>&nbsp;<span class="op" id="5948764">=</span>&nbsp;<span class="ident" id="5948766">hs</span><span class="op" id="5948768">.</span><span class="ident" id="5948769">Listener</span><span class="op" id="5948777">.</span><span class="ident" id="5948778">Accept</span><span class="op" id="5948784">(</span><span class="op" id="5948785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5948788">if</span>&nbsp;<span class="ident" id="5948791">err</span>&nbsp;<span class="op" id="5948795">==</span>&nbsp;<span class="ident" id="5948798">nil</span>&nbsp;<span class="op" id="5948802">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948806">hs</span><span class="op" id="5948808">.</span><span class="ident" id="5948809">Lock</span><span class="op" id="5948813">(</span><span class="op" id="5948814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948818">hs</span><span class="op" id="5948820">.</span><span class="ident" id="5948821">history</span>&nbsp;<span class="op" id="5948829">=</span>&nbsp;<span class="builtinfunc" id="5948831">append</span><span class="op" id="5948837">(</span><span class="ident" id="5948838">hs</span><span class="op" id="5948840">.</span><span class="ident" id="5948841">history</span><span class="op" id="5948848">,</span>&nbsp;<span class="ident" id="5948850">c</span><span class="op" id="5948851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948855">hs</span><span class="op" id="5948857">.</span><span class="ident" id="5948858">Unlock</span><span class="op" id="5948864">(</span><span class="op" id="5948865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5948868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5948871">return</span><br>
<span class="lineno">55</span><span class="op" id="5948878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5948881">func</span>&nbsp;<span class="ident" id="5948886">newLocalListener</span><span class="op" id="5948902">(</span><span class="op" id="5948903">)</span>&nbsp;<span class="ident" id="5948905">net</span><span class="op" id="5948908">.</span><span class="ident" id="5948909">Listener</span>&nbsp;<span class="op" id="5948918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5948921">if</span>&nbsp;<span class="op" id="5948924">*</span><span class="ident" id="5948925">serve</span>&nbsp;<span class="op" id="5948931">!=</span>&nbsp;<span class="string" id="5948934">&#34;&#34;</span>&nbsp;<span class="op" id="5948937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5948941">l</span><span class="op" id="5948942">,</span>&nbsp;<span class="ident" id="5948944">err</span>&nbsp;<span class="op" id="5948948">:=</span>&nbsp;<span class="ident" id="5948951">net</span><span class="op" id="5948954">.</span><span class="ident" id="5948955">Listen</span><span class="op" id="5948961">(</span><span class="string" id="5948962">&#34;tcp&#34;</span><span class="op" id="5948967">,</span>&nbsp;<span class="op" id="5948969">*</span><span class="ident" id="5948970">serve</span><span class="op" id="5948975">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5948979">if</span>&nbsp;<span class="ident" id="5948982">err</span>&nbsp;<span class="op" id="5948986">!=</span>&nbsp;<span class="ident" id="5948989">nil</span>&nbsp;<span class="op" id="5948993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5948998">panic</span><span class="op" id="5949003">(</span><span class="ident" id="5949004">fmt</span><span class="op" id="5949007">.</span><span class="ident" id="5949008">Sprintf</span><span class="op" id="5949015">(</span><span class="string" id="5949016">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="5949054">,</span>&nbsp;<span class="op" id="5949056">*</span><span class="ident" id="5949057">serve</span><span class="op" id="5949062">,</span>&nbsp;<span class="ident" id="5949064">err</span><span class="op" id="5949067">)</span><span class="op" id="5949068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5949072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5949076">return</span>&nbsp;<span class="ident" id="5949083">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5949086">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5949089">l</span><span class="op" id="5949090">,</span>&nbsp;<span class="ident" id="5949092">err</span>&nbsp;<span class="op" id="5949096">:=</span>&nbsp;<span class="ident" id="5949099">net</span><span class="op" id="5949102">.</span><span class="ident" id="5949103">Listen</span><span class="op" id="5949109">(</span><span class="string" id="5949110">&#34;tcp&#34;</span><span class="op" id="5949115">,</span>&nbsp;<span class="string" id="5949117">&#34;127.0.0.1:0&#34;</span><span class="op" id="5949130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5949133">if</span>&nbsp;<span class="ident" id="5949136">err</span>&nbsp;<span class="op" id="5949140">!=</span>&nbsp;<span class="ident" id="5949143">nil</span>&nbsp;<span class="op" id="5949147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5949151">if</span>&nbsp;<span class="ident" id="5949154">l</span><span class="op" id="5949155">,</span>&nbsp;<span class="ident" id="5949157">err</span>&nbsp;<span class="op" id="5949161">=</span>&nbsp;<span class="ident" id="5949163">net</span><span class="op" id="5949166">.</span><span class="ident" id="5949167">Listen</span><span class="op" id="5949173">(</span><span class="string" id="5949174">&#34;tcp6&#34;</span><span class="op" id="5949180">,</span>&nbsp;<span class="string" id="5949182">&#34;[::1]:0&#34;</span><span class="op" id="5949191">)</span><span class="op" id="5949192">;</span>&nbsp;<span class="ident" id="5949194">err</span>&nbsp;<span class="op" id="5949198">!=</span>&nbsp;<span class="ident" id="5949201">nil</span>&nbsp;<span class="op" id="5949205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5949210">panic</span><span class="op" id="5949215">(</span><span class="ident" id="5949216">fmt</span><span class="op" id="5949219">.</span><span class="ident" id="5949220">Sprintf</span><span class="op" id="5949227">(</span><span class="string" id="5949228">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="5949270">,</span>&nbsp;<span class="ident" id="5949272">err</span><span class="op" id="5949275">)</span><span class="op" id="5949276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5949280">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5949283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5949286">return</span>&nbsp;<span class="ident" id="5949293">l</span><br>
<span class="lineno"></span><span class="op" id="5949295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5949298">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="5949353">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5949379">//&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="5949437">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="5949505">var</span>&nbsp;<span class="ident" id="5949509">serve</span>&nbsp;<span class="op" id="5949515">=</span>&nbsp;<span class="ident" id="5949517">flag</span><span class="op" id="5949521">.</span><span class="ident" id="5949522">String</span><span class="op" id="5949528">(</span><span class="string" id="5949529">&#34;httptest.serve&#34;</span><span class="op" id="5949545">,</span>&nbsp;<span class="string" id="5949547">&#34;&#34;</span><span class="op" id="5949549">,</span>&nbsp;<span class="string" id="5949551">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="5949619">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="5949622">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="5949668">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5949732">func</span>&nbsp;<span class="ident" id="5949737">NewServer</span><span class="op" id="5949746">(</span><span class="ident" id="5949747">handler</span>&nbsp;<span class="ident" id="5949755">http</span><span class="op" id="5949759">.</span><span class="ident" id="5949760">Handler</span><span class="op" id="5949767">)</span>&nbsp;<span class="op" id="5949769">*</span><span class="ident" id="5949770">Server</span>&nbsp;<span class="op" id="5949777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5949780">ts</span>&nbsp;<span class="op" id="5949783">:=</span>&nbsp;<span class="ident" id="5949786">NewUnstartedServer</span><span class="op" id="5949804">(</span><span class="ident" id="5949805">handler</span><span class="op" id="5949812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5949815">ts</span><span class="op" id="5949817">.</span><span class="ident" id="5949818">Start</span><span class="op" id="5949823">(</span><span class="op" id="5949824">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5949827">return</span>&nbsp;<span class="ident" id="5949834">ts</span><br>
<span class="lineno"></span><span class="op" id="5949837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5949840">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5949905">//</span><br>
<span class="lineno">90</span><span class="comment" id="5949908">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5949977">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="5949990">//</span><br>
<span class="lineno"></span><span class="comment" id="5949993">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5950057">func</span>&nbsp;<span class="ident" id="5950062">NewUnstartedServer</span><span class="op" id="5950080">(</span><span class="ident" id="5950081">handler</span>&nbsp;<span class="ident" id="5950089">http</span><span class="op" id="5950093">.</span><span class="ident" id="5950094">Handler</span><span class="op" id="5950101">)</span>&nbsp;<span class="op" id="5950103">*</span><span class="ident" id="5950104">Server</span>&nbsp;<span class="op" id="5950111">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5950114">return</span>&nbsp;<span class="op" id="5950121">&amp;</span><span class="ident" id="5950122">Server</span><span class="op" id="5950128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5950132">Listener</span><span class="op" id="5950140">:</span>&nbsp;<span class="ident" id="5950142">newLocalListener</span><span class="op" id="5950158">(</span><span class="op" id="5950159">)</span><span class="op" id="5950160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5950164">Config</span><span class="op" id="5950170">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5950174">&amp;</span><span class="ident" id="5950175">http</span><span class="op" id="5950179">.</span><span class="ident" id="5950180">Server</span><span class="op" id="5950186">{</span><span class="ident" id="5950187">Handler</span><span class="op" id="5950194">:</span>&nbsp;<span class="ident" id="5950196">handler</span><span class="op" id="5950203">}</span><span class="op" id="5950204">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5950207">}</span><br>
<span class="lineno"></span><span class="op" id="5950209">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5950212">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5950262">func</span>&nbsp;<span class="op" id="5950267">(</span><span class="ident" id="5950268">s</span>&nbsp;<span class="op" id="5950270">*</span><span class="ident" id="5950271">Server</span><span class="op" id="5950277">)</span>&nbsp;<span class="ident" id="5950279">Start</span><span class="op" id="5950284">(</span><span class="op" id="5950285">)</span>&nbsp;<span class="op" id="5950287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5950290">if</span>&nbsp;<span class="ident" id="5950293">s</span><span class="op" id="5950294">.</span><span class="ident" id="5950295">URL</span>&nbsp;<span class="op" id="5950299">!=</span>&nbsp;<span class="string" id="5950302">&#34;&#34;</span>&nbsp;<span class="op" id="5950305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5950309">panic</span><span class="op" id="5950314">(</span><span class="string" id="5950315">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5950339">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5950342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5950345">s</span><span class="op" id="5950346">.</span><span class="ident" id="5950347">Listener</span>&nbsp;<span class="op" id="5950356">=</span>&nbsp;<span class="op" id="5950358">&amp;</span><span class="ident" id="5950359">historyListener</span><span class="op" id="5950374">{</span><span class="ident" id="5950375">Listener</span><span class="op" id="5950383">:</span>&nbsp;<span class="ident" id="5950385">s</span><span class="op" id="5950386">.</span><span class="ident" id="5950387">Listener</span><span class="op" id="5950395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5950398">s</span><span class="op" id="5950399">.</span><span class="ident" id="5950400">URL</span>&nbsp;<span class="op" id="5950404">=</span>&nbsp;<span class="string" id="5950406">&#34;http://&#34;</span>&nbsp;<span class="op" id="5950416">+</span>&nbsp;<span class="ident" id="5950418">s</span><span class="op" id="5950419">.</span><span class="ident" id="5950420">Listener</span><span class="op" id="5950428">.</span><span class="ident" id="5950429">Addr</span><span class="op" id="5950433">(</span><span class="op" id="5950434">)</span><span class="op" id="5950435">.</span><span class="ident" id="5950436">String</span><span class="op" id="5950442">(</span><span class="op" id="5950443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5950446">s</span><span class="op" id="5950447">.</span><span class="ident" id="5950448">wrapHandler</span><span class="op" id="5950459">(</span><span class="op" id="5950460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5950463">go</span>&nbsp;<span class="ident" id="5950466">s</span><span class="op" id="5950467">.</span><span class="ident" id="5950468">Config</span><span class="op" id="5950474">.</span><span class="ident" id="5950475">Serve</span><span class="op" id="5950480">(</span><span class="ident" id="5950481">s</span><span class="op" id="5950482">.</span><span class="ident" id="5950483">Listener</span><span class="op" id="5950491">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5950494">if</span>&nbsp;<span class="op" id="5950497">*</span><span class="ident" id="5950498">serve</span>&nbsp;<span class="op" id="5950504">!=</span>&nbsp;<span class="string" id="5950507">&#34;&#34;</span>&nbsp;<span class="op" id="5950510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5950514">fmt</span><span class="op" id="5950517">.</span><span class="ident" id="5950518">Fprintln</span><span class="op" id="5950526">(</span><span class="ident" id="5950527">os</span><span class="op" id="5950529">.</span><span class="ident" id="5950530">Stderr</span><span class="op" id="5950536">,</span>&nbsp;<span class="string" id="5950538">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="5950560">,</span>&nbsp;<span class="ident" id="5950562">s</span><span class="op" id="5950563">.</span><span class="ident" id="5950564">URL</span><span class="op" id="5950567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5950571">select</span>&nbsp;<span class="op" id="5950578">{</span><span class="op" id="5950579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5950582">}</span><br>
<span class="lineno"></span><span class="op" id="5950584">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5950587">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5950647">func</span>&nbsp;<span class="op" id="5950652">(</span><span class="ident" id="5950653">s</span>&nbsp;<span class="op" id="5950655">*</span><span class="ident" id="5950656">Server</span><span class="op" id="5950662">)</span>&nbsp;<span class="ident" id="5950664">StartTLS</span><span class="op" id="5950672">(</span><span class="op" id="5950673">)</span>&nbsp;<span class="op" id="5950675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5950678">if</span>&nbsp;<span class="ident" id="5950681">s</span><span class="op" id="5950682">.</span><span class="ident" id="5950683">URL</span>&nbsp;<span class="op" id="5950687">!=</span>&nbsp;<span class="string" id="5950690">&#34;&#34;</span>&nbsp;<span class="op" id="5950693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5950697">panic</span><span class="op" id="5950702">(</span><span class="string" id="5950703">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="5950727">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5950730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5950733">cert</span><span class="op" id="5950737">,</span>&nbsp;<span class="ident" id="5950739">err</span>&nbsp;<span class="op" id="5950743">:=</span>&nbsp;<span class="ident" id="5950746">tls</span><span class="op" id="5950749">.</span><span class="ident" id="5950750">X509KeyPair</span><span class="op" id="5950761">(</span><span class="ident" id="5950762">localhostCert</span><span class="op" id="5950775">,</span>&nbsp;<span class="ident" id="5950777">localhostKey</span><span class="op" id="5950789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5950792">if</span>&nbsp;<span class="ident" id="5950795">err</span>&nbsp;<span class="op" id="5950799">!=</span>&nbsp;<span class="ident" id="5950802">nil</span>&nbsp;<span class="op" id="5950806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5950810">panic</span><span class="op" id="5950815">(</span><span class="ident" id="5950816">fmt</span><span class="op" id="5950819">.</span><span class="ident" id="5950820">Sprintf</span><span class="op" id="5950827">(</span><span class="string" id="5950828">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="5950856">,</span>&nbsp;<span class="ident" id="5950858">err</span><span class="op" id="5950861">)</span><span class="op" id="5950862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5950865">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5950869">existingConfig</span>&nbsp;<span class="op" id="5950884">:=</span>&nbsp;<span class="ident" id="5950887">s</span><span class="op" id="5950888">.</span><span class="ident" id="5950889">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5950894">s</span><span class="op" id="5950895">.</span><span class="ident" id="5950896">TLS</span>&nbsp;<span class="op" id="5950900">=</span>&nbsp;<span class="builtinfunc" id="5950902">new</span><span class="op" id="5950905">(</span><span class="ident" id="5950906">tls</span><span class="op" id="5950909">.</span><span class="ident" id="5950910">Config</span><span class="op" id="5950916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5950919">if</span>&nbsp;<span class="ident" id="5950922">existingConfig</span>&nbsp;<span class="op" id="5950937">!=</span>&nbsp;<span class="ident" id="5950940">nil</span>&nbsp;<span class="op" id="5950944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5950948">*</span><span class="ident" id="5950949">s</span><span class="op" id="5950950">.</span><span class="ident" id="5950951">TLS</span>&nbsp;<span class="op" id="5950955">=</span>&nbsp;<span class="op" id="5950957">*</span><span class="ident" id="5950958">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5950974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5950977">if</span>&nbsp;<span class="ident" id="5950980">s</span><span class="op" id="5950981">.</span><span class="ident" id="5950982">TLS</span><span class="op" id="5950985">.</span><span class="ident" id="5950986">NextProtos</span>&nbsp;<span class="op" id="5950997">==</span>&nbsp;<span class="ident" id="5951000">nil</span>&nbsp;<span class="op" id="5951004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951008">s</span><span class="op" id="5951009">.</span><span class="ident" id="5951010">TLS</span><span class="op" id="5951013">.</span><span class="ident" id="5951014">NextProtos</span>&nbsp;<span class="op" id="5951025">=</span>&nbsp;<span class="op" id="5951027">[</span><span class="op" id="5951028">]</span><span class="builtintype" id="5951029">string</span><span class="op" id="5951035">{</span><span class="string" id="5951036">&#34;http/1.1&#34;</span><span class="op" id="5951046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5951049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5951052">if</span>&nbsp;<span class="builtinfunc" id="5951055">len</span><span class="op" id="5951058">(</span><span class="ident" id="5951059">s</span><span class="op" id="5951060">.</span><span class="ident" id="5951061">TLS</span><span class="op" id="5951064">.</span><span class="ident" id="5951065">Certificates</span><span class="op" id="5951077">)</span>&nbsp;<span class="op" id="5951079">==</span>&nbsp;<span class="num" id="5951082">0</span>&nbsp;<span class="op" id="5951084">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951088">s</span><span class="op" id="5951089">.</span><span class="ident" id="5951090">TLS</span><span class="op" id="5951093">.</span><span class="ident" id="5951094">Certificates</span>&nbsp;<span class="op" id="5951107">=</span>&nbsp;<span class="op" id="5951109">[</span><span class="op" id="5951110">]</span><span class="ident" id="5951111">tls</span><span class="op" id="5951114">.</span><span class="ident" id="5951115">Certificate</span><span class="op" id="5951126">{</span><span class="ident" id="5951127">cert</span><span class="op" id="5951131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5951134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951137">tlsListener</span>&nbsp;<span class="op" id="5951149">:=</span>&nbsp;<span class="ident" id="5951152">tls</span><span class="op" id="5951155">.</span><span class="ident" id="5951156">NewListener</span><span class="op" id="5951167">(</span><span class="ident" id="5951168">s</span><span class="op" id="5951169">.</span><span class="ident" id="5951170">Listener</span><span class="op" id="5951178">,</span>&nbsp;<span class="ident" id="5951180">s</span><span class="op" id="5951181">.</span><span class="ident" id="5951182">TLS</span><span class="op" id="5951185">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951189">s</span><span class="op" id="5951190">.</span><span class="ident" id="5951191">Listener</span>&nbsp;<span class="op" id="5951200">=</span>&nbsp;<span class="op" id="5951202">&amp;</span><span class="ident" id="5951203">historyListener</span><span class="op" id="5951218">{</span><span class="ident" id="5951219">Listener</span><span class="op" id="5951227">:</span>&nbsp;<span class="ident" id="5951229">tlsListener</span><span class="op" id="5951240">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951243">s</span><span class="op" id="5951244">.</span><span class="ident" id="5951245">URL</span>&nbsp;<span class="op" id="5951249">=</span>&nbsp;<span class="string" id="5951251">&#34;https://&#34;</span>&nbsp;<span class="op" id="5951262">+</span>&nbsp;<span class="ident" id="5951264">s</span><span class="op" id="5951265">.</span><span class="ident" id="5951266">Listener</span><span class="op" id="5951274">.</span><span class="ident" id="5951275">Addr</span><span class="op" id="5951279">(</span><span class="op" id="5951280">)</span><span class="op" id="5951281">.</span><span class="ident" id="5951282">String</span><span class="op" id="5951288">(</span><span class="op" id="5951289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951292">s</span><span class="op" id="5951293">.</span><span class="ident" id="5951294">wrapHandler</span><span class="op" id="5951305">(</span><span class="op" id="5951306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5951309">go</span>&nbsp;<span class="ident" id="5951312">s</span><span class="op" id="5951313">.</span><span class="ident" id="5951314">Config</span><span class="op" id="5951320">.</span><span class="ident" id="5951321">Serve</span><span class="op" id="5951326">(</span><span class="ident" id="5951327">s</span><span class="op" id="5951328">.</span><span class="ident" id="5951329">Listener</span><span class="op" id="5951337">)</span><br>
<span class="lineno"></span><span class="op" id="5951339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5951342">func</span>&nbsp;<span class="op" id="5951347">(</span><span class="ident" id="5951348">s</span>&nbsp;<span class="op" id="5951350">*</span><span class="ident" id="5951351">Server</span><span class="op" id="5951357">)</span>&nbsp;<span class="ident" id="5951359">wrapHandler</span><span class="op" id="5951370">(</span><span class="op" id="5951371">)</span>&nbsp;<span class="op" id="5951373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951376">h</span>&nbsp;<span class="op" id="5951378">:=</span>&nbsp;<span class="ident" id="5951381">s</span><span class="op" id="5951382">.</span><span class="ident" id="5951383">Config</span><span class="op" id="5951389">.</span><span class="ident" id="5951390">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5951399">if</span>&nbsp;<span class="ident" id="5951402">h</span>&nbsp;<span class="op" id="5951404">==</span>&nbsp;<span class="ident" id="5951407">nil</span>&nbsp;<span class="op" id="5951411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951415">h</span>&nbsp;<span class="op" id="5951417">=</span>&nbsp;<span class="ident" id="5951419">http</span><span class="op" id="5951423">.</span><span class="ident" id="5951424">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5951441">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951444">s</span><span class="op" id="5951445">.</span><span class="ident" id="5951446">Config</span><span class="op" id="5951452">.</span><span class="ident" id="5951453">Handler</span>&nbsp;<span class="op" id="5951461">=</span>&nbsp;<span class="op" id="5951463">&amp;</span><span class="ident" id="5951464">waitGroupHandler</span><span class="op" id="5951480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951484">s</span><span class="op" id="5951485">:</span>&nbsp;<span class="ident" id="5951487">s</span><span class="op" id="5951488">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951492">h</span><span class="op" id="5951493">:</span>&nbsp;<span class="ident" id="5951495">h</span><span class="op" id="5951496">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5951499">}</span><br>
<span class="lineno"></span><span class="op" id="5951501">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5951504">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="5951563">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="5951627">func</span>&nbsp;<span class="ident" id="5951632">NewTLSServer</span><span class="op" id="5951644">(</span><span class="ident" id="5951645">handler</span>&nbsp;<span class="ident" id="5951653">http</span><span class="op" id="5951657">.</span><span class="ident" id="5951658">Handler</span><span class="op" id="5951665">)</span>&nbsp;<span class="op" id="5951667">*</span><span class="ident" id="5951668">Server</span>&nbsp;<span class="op" id="5951675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951678">ts</span>&nbsp;<span class="op" id="5951681">:=</span>&nbsp;<span class="ident" id="5951684">NewUnstartedServer</span><span class="op" id="5951702">(</span><span class="ident" id="5951703">handler</span><span class="op" id="5951710">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951713">ts</span><span class="op" id="5951715">.</span><span class="ident" id="5951716">StartTLS</span><span class="op" id="5951724">(</span><span class="op" id="5951725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5951728">return</span>&nbsp;<span class="ident" id="5951735">ts</span><br>
<span class="lineno"></span><span class="op" id="5951738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5951741">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="5951805">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="5951848">func</span>&nbsp;<span class="op" id="5951853">(</span><span class="ident" id="5951854">s</span>&nbsp;<span class="op" id="5951856">*</span><span class="ident" id="5951857">Server</span><span class="op" id="5951863">)</span>&nbsp;<span class="ident" id="5951865">Close</span><span class="op" id="5951870">(</span><span class="op" id="5951871">)</span>&nbsp;<span class="op" id="5951873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951876">s</span><span class="op" id="5951877">.</span><span class="ident" id="5951878">Listener</span><span class="op" id="5951886">.</span><span class="ident" id="5951887">Close</span><span class="op" id="5951892">(</span><span class="op" id="5951893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951896">s</span><span class="op" id="5951897">.</span><span class="ident" id="5951898">wg</span><span class="op" id="5951900">.</span><span class="ident" id="5951901">Wait</span><span class="op" id="5951905">(</span><span class="op" id="5951906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951909">s</span><span class="op" id="5951910">.</span><span class="ident" id="5951911">CloseClientConnections</span><span class="op" id="5951933">(</span><span class="op" id="5951934">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5951937">if</span>&nbsp;<span class="ident" id="5951940">t</span><span class="op" id="5951941">,</span>&nbsp;<span class="ident" id="5951943">ok</span>&nbsp;<span class="op" id="5951946">:=</span>&nbsp;<span class="ident" id="5951949">http</span><span class="op" id="5951953">.</span><span class="ident" id="5951954">DefaultTransport</span><span class="op" id="5951970">.</span><span class="op" id="5951971">(</span><span class="op" id="5951972">*</span><span class="ident" id="5951973">http</span><span class="op" id="5951977">.</span><span class="ident" id="5951978">Transport</span><span class="op" id="5951987">)</span><span class="op" id="5951988">;</span>&nbsp;<span class="ident" id="5951990">ok</span>&nbsp;<span class="op" id="5951993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5951997">t</span><span class="op" id="5951998">.</span><span class="ident" id="5951999">CloseIdleConnections</span><span class="op" id="5952019">(</span><span class="op" id="5952020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5952023">}</span><br>
<span class="lineno"></span><span class="op" id="5952025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5952028">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="5952097">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5952120">func</span>&nbsp;<span class="op" id="5952125">(</span><span class="ident" id="5952126">s</span>&nbsp;<span class="op" id="5952128">*</span><span class="ident" id="5952129">Server</span><span class="op" id="5952135">)</span>&nbsp;<span class="ident" id="5952137">CloseClientConnections</span><span class="op" id="5952159">(</span><span class="op" id="5952160">)</span>&nbsp;<span class="op" id="5952162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5952165">hl</span><span class="op" id="5952167">,</span>&nbsp;<span class="ident" id="5952169">ok</span>&nbsp;<span class="op" id="5952172">:=</span>&nbsp;<span class="ident" id="5952175">s</span><span class="op" id="5952176">.</span><span class="ident" id="5952177">Listener</span><span class="op" id="5952185">.</span><span class="op" id="5952186">(</span><span class="op" id="5952187">*</span><span class="ident" id="5952188">historyListener</span><span class="op" id="5952203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5952206">if</span>&nbsp;<span class="op" id="5952209">!</span><span class="ident" id="5952210">ok</span>&nbsp;<span class="op" id="5952213">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5952217">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5952225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5952228">hl</span><span class="op" id="5952230">.</span><span class="ident" id="5952231">Lock</span><span class="op" id="5952235">(</span><span class="op" id="5952236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5952239">for</span>&nbsp;<span class="ident" id="5952243">_</span><span class="op" id="5952244">,</span>&nbsp;<span class="ident" id="5952246">conn</span>&nbsp;<span class="op" id="5952251">:=</span>&nbsp;<span class="keyword" id="5952254">range</span>&nbsp;<span class="ident" id="5952260">hl</span><span class="op" id="5952262">.</span><span class="ident" id="5952263">history</span>&nbsp;<span class="op" id="5952271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5952275">conn</span><span class="op" id="5952279">.</span><span class="ident" id="5952280">Close</span><span class="op" id="5952285">(</span><span class="op" id="5952286">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5952289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5952292">hl</span><span class="op" id="5952294">.</span><span class="ident" id="5952295">Unlock</span><span class="op" id="5952301">(</span><span class="op" id="5952302">)</span><br>
<span class="lineno"></span><span class="op" id="5952304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5952307">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="5952376">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="5952443">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="5952487">type</span>&nbsp;<span class="ident" id="5952492">waitGroupHandler</span>&nbsp;<span class="keyword" id="5952509">struct</span>&nbsp;<span class="op" id="5952516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5952519">s</span>&nbsp;<span class="op" id="5952521">*</span><span class="ident" id="5952522">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5952530">h</span>&nbsp;<span class="ident" id="5952532">http</span><span class="op" id="5952536">.</span><span class="ident" id="5952537">Handler</span>&nbsp;<span class="comment" id="5952545">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="5952556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5952559">func</span>&nbsp;<span class="op" id="5952564">(</span><span class="ident" id="5952565">h</span>&nbsp;<span class="op" id="5952567">*</span><span class="ident" id="5952568">waitGroupHandler</span><span class="op" id="5952584">)</span>&nbsp;<span class="ident" id="5952586">ServeHTTP</span><span class="op" id="5952595">(</span><span class="ident" id="5952596">w</span>&nbsp;<span class="ident" id="5952598">http</span><span class="op" id="5952602">.</span><span class="ident" id="5952603">ResponseWriter</span><span class="op" id="5952617">,</span>&nbsp;<span class="ident" id="5952619">r</span>&nbsp;<span class="op" id="5952621">*</span><span class="ident" id="5952622">http</span><span class="op" id="5952626">.</span><span class="ident" id="5952627">Request</span><span class="op" id="5952634">)</span>&nbsp;<span class="op" id="5952636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5952639">h</span><span class="op" id="5952640">.</span><span class="ident" id="5952641">s</span><span class="op" id="5952642">.</span><span class="ident" id="5952643">wg</span><span class="op" id="5952645">.</span><span class="ident" id="5952646">Add</span><span class="op" id="5952649">(</span><span class="num" id="5952650">1</span><span class="op" id="5952651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5952654">defer</span>&nbsp;<span class="ident" id="5952660">h</span><span class="op" id="5952661">.</span><span class="ident" id="5952662">s</span><span class="op" id="5952663">.</span><span class="ident" id="5952664">wg</span><span class="op" id="5952666">.</span><span class="ident" id="5952667">Done</span><span class="op" id="5952671">(</span><span class="op" id="5952672">)</span>&nbsp;<span class="comment" id="5952674">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5952718">h</span><span class="op" id="5952719">.</span><span class="ident" id="5952720">h</span><span class="op" id="5952721">.</span><span class="ident" id="5952722">ServeHTTP</span><span class="op" id="5952731">(</span><span class="ident" id="5952732">w</span><span class="op" id="5952733">,</span>&nbsp;<span class="ident" id="5952735">r</span><span class="op" id="5952736">)</span><br>
<span class="lineno"></span><span class="op" id="5952738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5952741">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="5952797">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="5952870">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="5952889">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="5952923">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="5953059">var</span>&nbsp;<span class="ident" id="5953063">localhostCert</span>&nbsp;<span class="op" id="5953077">=</span>&nbsp;<span class="op" id="5953079">[</span><span class="op" id="5953080">]</span><span class="builtintype" id="5953081">byte</span><span class="op" id="5953085">(</span><span class="string" id="5953086">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="5953657">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5953660">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="5953714">var</span>&nbsp;<span class="ident" id="5953718">localhostKey</span>&nbsp;<span class="op" id="5953731">=</span>&nbsp;<span class="op" id="5953733">[</span><span class="op" id="5953734">]</span><span class="builtintype" id="5953735">byte</span><span class="op" id="5953739">(</span><span class="string" id="5953740">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="5954238">)</span>
</div>
</body>
</html>
