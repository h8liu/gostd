<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1544650">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1544705">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1544759">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1544810">package</span>&nbsp;<span class="ident" id="1544818">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1544827">import</span>&nbsp;<span class="op" id="1544834">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1544837">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1544846">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1544849">const</span>&nbsp;<span class="op" id="1544855">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544858">debugMalloc</span>&nbsp;<span class="op" id="1544870">=</span>&nbsp;<span class="builtintype" id="1544872">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544880">flagNoScan</span>&nbsp;<span class="op" id="1544891">=</span>&nbsp;<span class="ident" id="1544893">_FlagNoScan</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544906">flagNoZero</span>&nbsp;<span class="op" id="1544917">=</span>&nbsp;<span class="ident" id="1544919">_FlagNoZero</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544933">maxTinySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1544947">=</span>&nbsp;<span class="ident" id="1544949">_TinySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544960">tinySizeClass</span>&nbsp;<span class="op" id="1544974">=</span>&nbsp;<span class="ident" id="1544976">_TinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1544992">maxSmallSize</span>&nbsp;&nbsp;<span class="op" id="1545006">=</span>&nbsp;<span class="ident" id="1545008">_MaxSmallSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545024">pageShift</span>&nbsp;<span class="op" id="1545034">=</span>&nbsp;<span class="ident" id="1545036">_PageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545048">pageSize</span>&nbsp;&nbsp;<span class="op" id="1545058">=</span>&nbsp;<span class="ident" id="1545060">_PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545071">pageMask</span>&nbsp;&nbsp;<span class="op" id="1545081">=</span>&nbsp;<span class="ident" id="1545083">_PageMask</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545095">bitsPerPointer</span>&nbsp;&nbsp;<span class="op" id="1545111">=</span>&nbsp;<span class="ident" id="1545113">_BitsPerPointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545130">bitsMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545146">=</span>&nbsp;<span class="ident" id="1545148">_BitsMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545159">pointersPerByte</span>&nbsp;<span class="op" id="1545175">=</span>&nbsp;<span class="ident" id="1545177">_PointersPerByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545195">maxGCMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545211">=</span>&nbsp;<span class="ident" id="1545213">_MaxGCMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545225">bitsDead</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545241">=</span>&nbsp;<span class="ident" id="1545243">_BitsDead</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545254">bitsPointer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545270">=</span>&nbsp;<span class="ident" id="1545272">_BitsPointer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545287">mSpanInUse</span>&nbsp;<span class="op" id="1545298">=</span>&nbsp;<span class="ident" id="1545300">_MSpanInUse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545314">concurrentSweep</span>&nbsp;<span class="op" id="1545330">=</span>&nbsp;<span class="ident" id="1545332">_ConcurrentSweep</span>&nbsp;<span class="op" id="1545349">!=</span>&nbsp;<span class="num" id="1545352">0</span><br>
<span class="lineno">35</span><span class="op" id="1545354">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1545357">//&nbsp;Page&nbsp;number&nbsp;(address&gt;&gt;pageShift)</span><br>
<span class="lineno"></span><span class="keyword" id="1545393">type</span>&nbsp;<span class="ident" id="1545398">pageID</span>&nbsp;<span class="builtintype" id="1545405">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1545414">//&nbsp;base&nbsp;address&nbsp;for&nbsp;all&nbsp;0-byte&nbsp;allocations</span><br>
<span class="lineno"></span><span class="keyword" id="1545457">var</span>&nbsp;<span class="ident" id="1545461">zerobase</span>&nbsp;<span class="builtintype" id="1545470">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1545479">//&nbsp;Allocate&nbsp;an&nbsp;object&nbsp;of&nbsp;size&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1545516">//&nbsp;Small&nbsp;objects&nbsp;are&nbsp;allocated&nbsp;from&nbsp;the&nbsp;per-P&nbsp;cache&#39;s&nbsp;free&nbsp;lists.</span><br>
<span class="lineno">45</span><span class="comment" id="1545582">//&nbsp;Large&nbsp;objects&nbsp;(&gt;&nbsp;32&nbsp;kB)&nbsp;are&nbsp;allocated&nbsp;straight&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1545647">func</span>&nbsp;<span class="ident" id="1545652">mallocgc</span><span class="op" id="1545660">(</span><span class="ident" id="1545661">size</span>&nbsp;<span class="builtintype" id="1545666">uintptr</span><span class="op" id="1545673">,</span>&nbsp;<span class="ident" id="1545675">typ</span>&nbsp;<span class="op" id="1545679">*</span><span class="ident" id="1545680">_type</span><span class="op" id="1545685">,</span>&nbsp;<span class="ident" id="1545687">flags</span>&nbsp;<span class="builtintype" id="1545693">uint32</span><span class="op" id="1545699">)</span>&nbsp;<span class="ident" id="1545701">unsafe</span><span class="op" id="1545707">.</span><span class="ident" id="1545708">Pointer</span>&nbsp;<span class="op" id="1545716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545719">if</span>&nbsp;<span class="ident" id="1545722">size</span>&nbsp;<span class="op" id="1545727">==</span>&nbsp;<span class="num" id="1545730">0</span>&nbsp;<span class="op" id="1545732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545736">return</span>&nbsp;<span class="ident" id="1545743">unsafe</span><span class="op" id="1545749">.</span><span class="ident" id="1545750">Pointer</span><span class="op" id="1545757">(</span><span class="op" id="1545758">&amp;</span><span class="ident" id="1545759">zerobase</span><span class="op" id="1545767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545770">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545773">size0</span>&nbsp;<span class="op" id="1545779">:=</span>&nbsp;<span class="ident" id="1545782">size</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1545789">if</span>&nbsp;<span class="ident" id="1545792">flags</span><span class="op" id="1545797">&amp;</span><span class="ident" id="1545798">flagNoScan</span>&nbsp;<span class="op" id="1545809">==</span>&nbsp;<span class="num" id="1545812">0</span>&nbsp;<span class="op" id="1545814">&amp;&amp;</span>&nbsp;<span class="ident" id="1545817">typ</span>&nbsp;<span class="op" id="1545821">==</span>&nbsp;<span class="ident" id="1545824">nil</span>&nbsp;<span class="op" id="1545828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1545832">gothrow</span><span class="op" id="1545839">(</span><span class="string" id="1545840">&#34;malloc&nbsp;missing&nbsp;type&#34;</span><span class="op" id="1545861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1545864">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545868">//&nbsp;This&nbsp;function&nbsp;must&nbsp;be&nbsp;atomic&nbsp;wrt&nbsp;GC,&nbsp;but&nbsp;for&nbsp;performance&nbsp;reasons</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1545937">//&nbsp;we&nbsp;don&#39;t&nbsp;acquirem/releasem&nbsp;on&nbsp;fast&nbsp;path.&nbsp;The&nbsp;code&nbsp;below&nbsp;does&nbsp;not&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546011">//&nbsp;split&nbsp;stack&nbsp;checks,&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;preempted&nbsp;by&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546067">//&nbsp;Functions&nbsp;like&nbsp;roundup/add&nbsp;are&nbsp;inlined.&nbsp;And&nbsp;onM/racemalloc&nbsp;are&nbsp;nosplit.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546143">//&nbsp;If&nbsp;debugMalloc&nbsp;=&nbsp;true,&nbsp;these&nbsp;assumptions&nbsp;are&nbsp;checked&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546207">if</span>&nbsp;<span class="ident" id="1546210">debugMalloc</span>&nbsp;<span class="op" id="1546222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546226">mp</span>&nbsp;<span class="op" id="1546229">:=</span>&nbsp;<span class="ident" id="1546232">acquirem</span><span class="op" id="1546240">(</span><span class="op" id="1546241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546245">if</span>&nbsp;<span class="ident" id="1546248">mp</span><span class="op" id="1546250">.</span><span class="ident" id="1546251">mallocing</span>&nbsp;<span class="op" id="1546261">!=</span>&nbsp;<span class="num" id="1546264">0</span>&nbsp;<span class="op" id="1546266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546271">gothrow</span><span class="op" id="1546278">(</span><span class="string" id="1546279">&#34;malloc&nbsp;deadlock&#34;</span><span class="op" id="1546296">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546304">mp</span><span class="op" id="1546306">.</span><span class="ident" id="1546307">mallocing</span>&nbsp;<span class="op" id="1546317">=</span>&nbsp;<span class="num" id="1546319">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546323">if</span>&nbsp;<span class="ident" id="1546326">mp</span><span class="op" id="1546328">.</span><span class="ident" id="1546329">curg</span>&nbsp;<span class="op" id="1546334">!=</span>&nbsp;<span class="ident" id="1546337">nil</span>&nbsp;<span class="op" id="1546341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546346">mp</span><span class="op" id="1546348">.</span><span class="ident" id="1546349">curg</span><span class="op" id="1546353">.</span><span class="ident" id="1546354">stackguard0</span>&nbsp;<span class="op" id="1546366">=</span>&nbsp;<span class="op" id="1546368">^</span><span class="builtintype" id="1546369">uintptr</span><span class="op" id="1546376">(</span><span class="num" id="1546377">0xfff</span><span class="op" id="1546382">)</span>&nbsp;<span class="op" id="1546384">|</span>&nbsp;<span class="num" id="1546386">0xbad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546394">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1546397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1546401">c</span>&nbsp;<span class="op" id="1546403">:=</span>&nbsp;<span class="ident" id="1546406">gomcache</span><span class="op" id="1546414">(</span><span class="op" id="1546415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546418">var</span>&nbsp;<span class="ident" id="1546422">s</span>&nbsp;<span class="op" id="1546424">*</span><span class="ident" id="1546425">mspan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546432">var</span>&nbsp;<span class="ident" id="1546436">x</span>&nbsp;<span class="ident" id="1546438">unsafe</span><span class="op" id="1546444">.</span><span class="ident" id="1546445">Pointer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546454">if</span>&nbsp;<span class="ident" id="1546457">size</span>&nbsp;<span class="op" id="1546462">&lt;=</span>&nbsp;<span class="ident" id="1546465">maxSmallSize</span>&nbsp;<span class="op" id="1546478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1546482">if</span>&nbsp;<span class="ident" id="1546485">flags</span><span class="op" id="1546490">&amp;</span><span class="ident" id="1546491">flagNoScan</span>&nbsp;<span class="op" id="1546502">!=</span>&nbsp;<span class="num" id="1546505">0</span>&nbsp;<span class="op" id="1546507">&amp;&amp;</span>&nbsp;<span class="ident" id="1546510">size</span>&nbsp;<span class="op" id="1546515">&lt;</span>&nbsp;<span class="ident" id="1546517">maxTinySize</span>&nbsp;<span class="op" id="1546529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546534">//&nbsp;Tiny&nbsp;allocator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546556">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546562">//&nbsp;Tiny&nbsp;allocator&nbsp;combines&nbsp;several&nbsp;tiny&nbsp;allocation&nbsp;requests</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546625">//&nbsp;into&nbsp;a&nbsp;single&nbsp;memory&nbsp;block.&nbsp;The&nbsp;resulting&nbsp;memory&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546686">//&nbsp;is&nbsp;freed&nbsp;when&nbsp;all&nbsp;subobjects&nbsp;are&nbsp;unreachable.&nbsp;The&nbsp;subobjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546753">//&nbsp;must&nbsp;be&nbsp;FlagNoScan&nbsp;(don&#39;t&nbsp;have&nbsp;pointers),&nbsp;this&nbsp;ensures&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546819">//&nbsp;the&nbsp;amount&nbsp;of&nbsp;potentially&nbsp;wasted&nbsp;memory&nbsp;is&nbsp;bounded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546877">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546883">//&nbsp;Size&nbsp;of&nbsp;the&nbsp;memory&nbsp;block&nbsp;used&nbsp;for&nbsp;combining&nbsp;(maxTinySize)&nbsp;is&nbsp;tunable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1546959">//&nbsp;Current&nbsp;setting&nbsp;is&nbsp;16&nbsp;bytes,&nbsp;which&nbsp;relates&nbsp;to&nbsp;2x&nbsp;worst&nbsp;case&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547032">//&nbsp;wastage&nbsp;(when&nbsp;all&nbsp;but&nbsp;one&nbsp;subobjects&nbsp;are&nbsp;unreachable).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547093">//&nbsp;8&nbsp;bytes&nbsp;would&nbsp;result&nbsp;in&nbsp;no&nbsp;wastage&nbsp;at&nbsp;all,&nbsp;but&nbsp;provides&nbsp;less</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547160">//&nbsp;opportunities&nbsp;for&nbsp;combining.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547195">//&nbsp;32&nbsp;bytes&nbsp;provides&nbsp;more&nbsp;opportunities&nbsp;for&nbsp;combining,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547253">//&nbsp;but&nbsp;can&nbsp;lead&nbsp;to&nbsp;4x&nbsp;worst&nbsp;case&nbsp;wastage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547298">//&nbsp;The&nbsp;best&nbsp;case&nbsp;winning&nbsp;is&nbsp;8x&nbsp;regardless&nbsp;of&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547358">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547364">//&nbsp;Objects&nbsp;obtained&nbsp;from&nbsp;tiny&nbsp;allocator&nbsp;must&nbsp;not&nbsp;be&nbsp;freed&nbsp;explicitly.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547437">//&nbsp;So&nbsp;when&nbsp;an&nbsp;object&nbsp;will&nbsp;be&nbsp;freed&nbsp;explicitly,&nbsp;we&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547502">//&nbsp;its&nbsp;size&nbsp;&gt;=&nbsp;maxTinySize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547533">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547539">//&nbsp;SetFinalizer&nbsp;has&nbsp;a&nbsp;special&nbsp;case&nbsp;for&nbsp;objects&nbsp;potentially&nbsp;coming</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547608">//&nbsp;from&nbsp;tiny&nbsp;allocator,&nbsp;it&nbsp;such&nbsp;case&nbsp;it&nbsp;allows&nbsp;to&nbsp;set&nbsp;finalizers</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547676">//&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte&nbsp;of&nbsp;a&nbsp;memory&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547719">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547725">//&nbsp;The&nbsp;main&nbsp;targets&nbsp;of&nbsp;tiny&nbsp;allocator&nbsp;are&nbsp;small&nbsp;strings&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547788">//&nbsp;standalone&nbsp;escaping&nbsp;variables.&nbsp;On&nbsp;a&nbsp;json&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547845">//&nbsp;the&nbsp;allocator&nbsp;reduces&nbsp;number&nbsp;of&nbsp;allocations&nbsp;by&nbsp;~12%&nbsp;and</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1547907">//&nbsp;reduces&nbsp;heap&nbsp;size&nbsp;by&nbsp;~20%.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1547940">tinysize</span>&nbsp;<span class="op" id="1547949">:=</span>&nbsp;<span class="builtintype" id="1547952">uintptr</span><span class="op" id="1547959">(</span><span class="ident" id="1547960">c</span><span class="op" id="1547961">.</span><span class="ident" id="1547962">tinysize</span><span class="op" id="1547970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1547975">if</span>&nbsp;<span class="ident" id="1547978">size</span>&nbsp;<span class="op" id="1547983">&lt;=</span>&nbsp;<span class="ident" id="1547986">tinysize</span>&nbsp;<span class="op" id="1547995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548001">tiny</span>&nbsp;<span class="op" id="1548006">:=</span>&nbsp;<span class="ident" id="1548009">unsafe</span><span class="op" id="1548015">.</span><span class="ident" id="1548016">Pointer</span><span class="op" id="1548023">(</span><span class="ident" id="1548024">c</span><span class="op" id="1548025">.</span><span class="ident" id="1548026">tiny</span><span class="op" id="1548030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548036">//&nbsp;Align&nbsp;tiny&nbsp;pointer&nbsp;for&nbsp;required&nbsp;(conservative)&nbsp;alignment.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548101">if</span>&nbsp;<span class="ident" id="1548104">size</span><span class="op" id="1548108">&amp;</span><span class="num" id="1548109">7</span>&nbsp;<span class="op" id="1548111">==</span>&nbsp;<span class="num" id="1548114">0</span>&nbsp;<span class="op" id="1548116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548123">tiny</span>&nbsp;<span class="op" id="1548128">=</span>&nbsp;<span class="ident" id="1548130">roundup</span><span class="op" id="1548137">(</span><span class="ident" id="1548138">tiny</span><span class="op" id="1548142">,</span>&nbsp;<span class="num" id="1548144">8</span><span class="op" id="1548145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548151">}</span>&nbsp;<span class="keyword" id="1548153">else</span>&nbsp;<span class="keyword" id="1548158">if</span>&nbsp;<span class="ident" id="1548161">size</span><span class="op" id="1548165">&amp;</span><span class="num" id="1548166">3</span>&nbsp;<span class="op" id="1548168">==</span>&nbsp;<span class="num" id="1548171">0</span>&nbsp;<span class="op" id="1548173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548180">tiny</span>&nbsp;<span class="op" id="1548185">=</span>&nbsp;<span class="ident" id="1548187">roundup</span><span class="op" id="1548194">(</span><span class="ident" id="1548195">tiny</span><span class="op" id="1548199">,</span>&nbsp;<span class="num" id="1548201">4</span><span class="op" id="1548202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548208">}</span>&nbsp;<span class="keyword" id="1548210">else</span>&nbsp;<span class="keyword" id="1548215">if</span>&nbsp;<span class="ident" id="1548218">size</span><span class="op" id="1548222">&amp;</span><span class="num" id="1548223">1</span>&nbsp;<span class="op" id="1548225">==</span>&nbsp;<span class="num" id="1548228">0</span>&nbsp;<span class="op" id="1548230">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548237">tiny</span>&nbsp;<span class="op" id="1548242">=</span>&nbsp;<span class="ident" id="1548244">roundup</span><span class="op" id="1548251">(</span><span class="ident" id="1548252">tiny</span><span class="op" id="1548256">,</span>&nbsp;<span class="num" id="1548258">2</span><span class="op" id="1548259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548271">size1</span>&nbsp;<span class="op" id="1548277">:=</span>&nbsp;<span class="ident" id="1548280">size</span>&nbsp;<span class="op" id="1548285">+</span>&nbsp;<span class="op" id="1548287">(</span><span class="builtintype" id="1548288">uintptr</span><span class="op" id="1548295">(</span><span class="ident" id="1548296">tiny</span><span class="op" id="1548300">)</span>&nbsp;<span class="op" id="1548302">-</span>&nbsp;<span class="builtintype" id="1548304">uintptr</span><span class="op" id="1548311">(</span><span class="ident" id="1548312">unsafe</span><span class="op" id="1548318">.</span><span class="ident" id="1548319">Pointer</span><span class="op" id="1548326">(</span><span class="ident" id="1548327">c</span><span class="op" id="1548328">.</span><span class="ident" id="1548329">tiny</span><span class="op" id="1548333">)</span><span class="op" id="1548334">)</span><span class="op" id="1548335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548341">if</span>&nbsp;<span class="ident" id="1548344">size1</span>&nbsp;<span class="op" id="1548350">&lt;=</span>&nbsp;<span class="ident" id="1548353">tinysize</span>&nbsp;<span class="op" id="1548362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548369">//&nbsp;The&nbsp;object&nbsp;fits&nbsp;into&nbsp;existing&nbsp;tiny&nbsp;block.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548419">x</span>&nbsp;<span class="op" id="1548421">=</span>&nbsp;<span class="ident" id="1548423">tiny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548433">c</span><span class="op" id="1548434">.</span><span class="ident" id="1548435">tiny</span>&nbsp;<span class="op" id="1548440">=</span>&nbsp;<span class="op" id="1548442">(</span><span class="op" id="1548443">*</span><span class="builtintype" id="1548444">byte</span><span class="op" id="1548448">)</span><span class="op" id="1548449">(</span><span class="ident" id="1548450">add</span><span class="op" id="1548453">(</span><span class="ident" id="1548454">x</span><span class="op" id="1548455">,</span>&nbsp;<span class="ident" id="1548457">size</span><span class="op" id="1548461">)</span><span class="op" id="1548462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548469">c</span><span class="op" id="1548470">.</span><span class="ident" id="1548471">tinysize</span>&nbsp;<span class="op" id="1548480">-=</span>&nbsp;<span class="builtintype" id="1548483">uintptr</span><span class="op" id="1548490">(</span><span class="ident" id="1548491">size1</span><span class="op" id="1548496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548503">c</span><span class="op" id="1548504">.</span><span class="ident" id="1548505">local_tinyallocs</span><span class="op" id="1548521">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548529">if</span>&nbsp;<span class="ident" id="1548532">debugMalloc</span>&nbsp;<span class="op" id="1548544">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548552">mp</span>&nbsp;<span class="op" id="1548555">:=</span>&nbsp;<span class="ident" id="1548558">acquirem</span><span class="op" id="1548566">(</span><span class="op" id="1548567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548575">if</span>&nbsp;<span class="ident" id="1548578">mp</span><span class="op" id="1548580">.</span><span class="ident" id="1548581">mallocing</span>&nbsp;<span class="op" id="1548591">==</span>&nbsp;<span class="num" id="1548594">0</span>&nbsp;<span class="op" id="1548596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548605">gothrow</span><span class="op" id="1548612">(</span><span class="string" id="1548613">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1548625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548641">mp</span><span class="op" id="1548643">.</span><span class="ident" id="1548644">mallocing</span>&nbsp;<span class="op" id="1548654">=</span>&nbsp;<span class="num" id="1548656">0</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548664">if</span>&nbsp;<span class="ident" id="1548667">mp</span><span class="op" id="1548669">.</span><span class="ident" id="1548670">curg</span>&nbsp;<span class="op" id="1548675">!=</span>&nbsp;<span class="ident" id="1548678">nil</span>&nbsp;<span class="op" id="1548682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548691">mp</span><span class="op" id="1548693">.</span><span class="ident" id="1548694">curg</span><span class="op" id="1548698">.</span><span class="ident" id="1548699">stackguard0</span>&nbsp;<span class="op" id="1548711">=</span>&nbsp;<span class="ident" id="1548713">mp</span><span class="op" id="1548715">.</span><span class="ident" id="1548716">curg</span><span class="op" id="1548720">.</span><span class="ident" id="1548721">stack</span><span class="op" id="1548726">.</span><span class="ident" id="1548727">lo</span>&nbsp;<span class="op" id="1548730">+</span>&nbsp;<span class="ident" id="1548732">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548758">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548815">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548871">releasem</span><span class="op" id="1548879">(</span><span class="ident" id="1548880">mp</span><span class="op" id="1548882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548890">releasem</span><span class="op" id="1548898">(</span><span class="ident" id="1548899">mp</span><span class="op" id="1548901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1548915">return</span>&nbsp;<span class="ident" id="1548922">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548928">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1548933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1548938">//&nbsp;Allocate&nbsp;a&nbsp;new&nbsp;maxTinySize&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1548978">s</span>&nbsp;<span class="op" id="1548980">=</span>&nbsp;<span class="ident" id="1548982">c</span><span class="op" id="1548983">.</span><span class="ident" id="1548984">alloc</span><span class="op" id="1548989">[</span><span class="ident" id="1548990">tinySizeClass</span><span class="op" id="1549003">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549008">v</span>&nbsp;<span class="op" id="1549010">:=</span>&nbsp;<span class="ident" id="1549013">s</span><span class="op" id="1549014">.</span><span class="ident" id="1549015">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549027">if</span>&nbsp;<span class="ident" id="1549030">v</span>&nbsp;<span class="op" id="1549032">==</span>&nbsp;<span class="ident" id="1549035">nil</span>&nbsp;<span class="op" id="1549039">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549045">mp</span>&nbsp;<span class="op" id="1549048">:=</span>&nbsp;<span class="ident" id="1549051">acquirem</span><span class="op" id="1549059">(</span><span class="op" id="1549060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549066">mp</span><span class="op" id="1549068">.</span><span class="ident" id="1549069">scalararg</span><span class="op" id="1549078">[</span><span class="num" id="1549079">0</span><span class="op" id="1549080">]</span>&nbsp;<span class="op" id="1549082">=</span>&nbsp;<span class="ident" id="1549084">tinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549102">onM</span><span class="op" id="1549105">(</span><span class="ident" id="1549106">mcacheRefill_m</span><span class="op" id="1549120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549126">releasem</span><span class="op" id="1549134">(</span><span class="ident" id="1549135">mp</span><span class="op" id="1549137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549143">s</span>&nbsp;<span class="op" id="1549145">=</span>&nbsp;<span class="ident" id="1549147">c</span><span class="op" id="1549148">.</span><span class="ident" id="1549149">alloc</span><span class="op" id="1549154">[</span><span class="ident" id="1549155">tinySizeClass</span><span class="op" id="1549168">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549174">v</span>&nbsp;<span class="op" id="1549176">=</span>&nbsp;<span class="ident" id="1549178">s</span><span class="op" id="1549179">.</span><span class="ident" id="1549180">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549197">s</span><span class="op" id="1549198">.</span><span class="ident" id="1549199">freelist</span>&nbsp;<span class="op" id="1549208">=</span>&nbsp;<span class="ident" id="1549210">v</span><span class="op" id="1549211">.</span><span class="ident" id="1549212">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549220">s</span><span class="op" id="1549221">.</span><span class="ident" id="1549222">ref</span><span class="op" id="1549225">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1549231">//TODO:&nbsp;prefetch&nbsp;v.next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549258">x</span>&nbsp;<span class="op" id="1549260">=</span>&nbsp;<span class="ident" id="1549262">unsafe</span><span class="op" id="1549268">.</span><span class="ident" id="1549269">Pointer</span><span class="op" id="1549276">(</span><span class="ident" id="1549277">v</span><span class="op" id="1549278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549283">(</span><span class="op" id="1549284">*</span><span class="op" id="1549285">[</span><span class="num" id="1549286">2</span><span class="op" id="1549287">]</span><span class="ident" id="1549288">uint64</span><span class="op" id="1549294">)</span><span class="op" id="1549295">(</span><span class="ident" id="1549296">x</span><span class="op" id="1549297">)</span><span class="op" id="1549298">[</span><span class="num" id="1549299">0</span><span class="op" id="1549300">]</span>&nbsp;<span class="op" id="1549302">=</span>&nbsp;<span class="num" id="1549304">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549309">(</span><span class="op" id="1549310">*</span><span class="op" id="1549311">[</span><span class="num" id="1549312">2</span><span class="op" id="1549313">]</span><span class="ident" id="1549314">uint64</span><span class="op" id="1549320">)</span><span class="op" id="1549321">(</span><span class="ident" id="1549322">x</span><span class="op" id="1549323">)</span><span class="op" id="1549324">[</span><span class="num" id="1549325">1</span><span class="op" id="1549326">]</span>&nbsp;<span class="op" id="1549328">=</span>&nbsp;<span class="num" id="1549330">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1549335">//&nbsp;See&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;replace&nbsp;the&nbsp;existing&nbsp;tiny&nbsp;block&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1549408">//&nbsp;based&nbsp;on&nbsp;amount&nbsp;of&nbsp;remaining&nbsp;free&nbsp;space.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549455">if</span>&nbsp;<span class="ident" id="1549458">maxTinySize</span><span class="op" id="1549469">-</span><span class="ident" id="1549470">size</span>&nbsp;<span class="op" id="1549475">&gt;</span>&nbsp;<span class="ident" id="1549477">tinysize</span>&nbsp;<span class="op" id="1549486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549492">c</span><span class="op" id="1549493">.</span><span class="ident" id="1549494">tiny</span>&nbsp;<span class="op" id="1549499">=</span>&nbsp;<span class="op" id="1549501">(</span><span class="op" id="1549502">*</span><span class="builtintype" id="1549503">byte</span><span class="op" id="1549507">)</span><span class="op" id="1549508">(</span><span class="ident" id="1549509">add</span><span class="op" id="1549512">(</span><span class="ident" id="1549513">x</span><span class="op" id="1549514">,</span>&nbsp;<span class="ident" id="1549516">size</span><span class="op" id="1549520">)</span><span class="op" id="1549521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549527">c</span><span class="op" id="1549528">.</span><span class="ident" id="1549529">tinysize</span>&nbsp;<span class="op" id="1549538">=</span>&nbsp;<span class="builtintype" id="1549540">uintptr</span><span class="op" id="1549547">(</span><span class="ident" id="1549548">maxTinySize</span>&nbsp;<span class="op" id="1549560">-</span>&nbsp;<span class="ident" id="1549562">size</span><span class="op" id="1549566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549576">size</span>&nbsp;<span class="op" id="1549581">=</span>&nbsp;<span class="ident" id="1549583">maxTinySize</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549597">}</span>&nbsp;<span class="keyword" id="1549599">else</span>&nbsp;<span class="op" id="1549604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549609">var</span>&nbsp;<span class="ident" id="1549613">sizeclass</span>&nbsp;<span class="builtintype" id="1549623">int8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549631">if</span>&nbsp;<span class="ident" id="1549634">size</span>&nbsp;<span class="op" id="1549639">&lt;=</span>&nbsp;<span class="num" id="1549642">1024</span><span class="op" id="1549646">-</span><span class="num" id="1549647">8</span>&nbsp;<span class="op" id="1549649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549655">sizeclass</span>&nbsp;<span class="op" id="1549665">=</span>&nbsp;<span class="ident" id="1549667">size_to_class8</span><span class="op" id="1549681">[</span><span class="op" id="1549682">(</span><span class="ident" id="1549683">size</span><span class="op" id="1549687">+</span><span class="num" id="1549688">7</span><span class="op" id="1549689">)</span><span class="op" id="1549690">&gt;&gt;</span><span class="num" id="1549692">3</span><span class="op" id="1549693">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549698">}</span>&nbsp;<span class="keyword" id="1549700">else</span>&nbsp;<span class="op" id="1549705">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549711">sizeclass</span>&nbsp;<span class="op" id="1549721">=</span>&nbsp;<span class="ident" id="1549723">size_to_class128</span><span class="op" id="1549739">[</span><span class="op" id="1549740">(</span><span class="ident" id="1549741">size</span><span class="op" id="1549745">-</span><span class="num" id="1549746">1024</span><span class="op" id="1549750">+</span><span class="num" id="1549751">127</span><span class="op" id="1549754">)</span><span class="op" id="1549755">&gt;&gt;</span><span class="num" id="1549757">7</span><span class="op" id="1549758">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1549763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549768">size</span>&nbsp;<span class="op" id="1549773">=</span>&nbsp;<span class="builtintype" id="1549775">uintptr</span><span class="op" id="1549782">(</span><span class="ident" id="1549783">class_to_size</span><span class="op" id="1549796">[</span><span class="ident" id="1549797">sizeclass</span><span class="op" id="1549806">]</span><span class="op" id="1549807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549812">s</span>&nbsp;<span class="op" id="1549814">=</span>&nbsp;<span class="ident" id="1549816">c</span><span class="op" id="1549817">.</span><span class="ident" id="1549818">alloc</span><span class="op" id="1549823">[</span><span class="ident" id="1549824">sizeclass</span><span class="op" id="1549833">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549838">v</span>&nbsp;<span class="op" id="1549840">:=</span>&nbsp;<span class="ident" id="1549843">s</span><span class="op" id="1549844">.</span><span class="ident" id="1549845">freelist</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1549857">if</span>&nbsp;<span class="ident" id="1549860">v</span>&nbsp;<span class="op" id="1549862">==</span>&nbsp;<span class="ident" id="1549865">nil</span>&nbsp;<span class="op" id="1549869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549875">mp</span>&nbsp;<span class="op" id="1549878">:=</span>&nbsp;<span class="ident" id="1549881">acquirem</span><span class="op" id="1549889">(</span><span class="op" id="1549890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549896">mp</span><span class="op" id="1549898">.</span><span class="ident" id="1549899">scalararg</span><span class="op" id="1549908">[</span><span class="num" id="1549909">0</span><span class="op" id="1549910">]</span>&nbsp;<span class="op" id="1549912">=</span>&nbsp;<span class="builtintype" id="1549914">uintptr</span><span class="op" id="1549921">(</span><span class="ident" id="1549922">sizeclass</span><span class="op" id="1549931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549937">onM</span><span class="op" id="1549940">(</span><span class="ident" id="1549941">mcacheRefill_m</span><span class="op" id="1549955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549961">releasem</span><span class="op" id="1549969">(</span><span class="ident" id="1549970">mp</span><span class="op" id="1549972">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1549978">s</span>&nbsp;<span class="op" id="1549980">=</span>&nbsp;<span class="ident" id="1549982">c</span><span class="op" id="1549983">.</span><span class="ident" id="1549984">alloc</span><span class="op" id="1549989">[</span><span class="ident" id="1549990">sizeclass</span><span class="op" id="1549999">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550005">v</span>&nbsp;<span class="op" id="1550007">=</span>&nbsp;<span class="ident" id="1550009">s</span><span class="op" id="1550010">.</span><span class="ident" id="1550011">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550028">s</span><span class="op" id="1550029">.</span><span class="ident" id="1550030">freelist</span>&nbsp;<span class="op" id="1550039">=</span>&nbsp;<span class="ident" id="1550041">v</span><span class="op" id="1550042">.</span><span class="ident" id="1550043">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550051">s</span><span class="op" id="1550052">.</span><span class="ident" id="1550053">ref</span><span class="op" id="1550056">++</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550062">//TODO:&nbsp;prefetch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550082">x</span>&nbsp;<span class="op" id="1550084">=</span>&nbsp;<span class="ident" id="1550086">unsafe</span><span class="op" id="1550092">.</span><span class="ident" id="1550093">Pointer</span><span class="op" id="1550100">(</span><span class="ident" id="1550101">v</span><span class="op" id="1550102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550107">if</span>&nbsp;<span class="ident" id="1550110">flags</span><span class="op" id="1550115">&amp;</span><span class="ident" id="1550116">flagNoZero</span>&nbsp;<span class="op" id="1550127">==</span>&nbsp;<span class="num" id="1550130">0</span>&nbsp;<span class="op" id="1550132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550138">v</span><span class="op" id="1550139">.</span><span class="ident" id="1550140">next</span>&nbsp;<span class="op" id="1550145">=</span>&nbsp;<span class="ident" id="1550147">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550155">if</span>&nbsp;<span class="ident" id="1550158">size</span>&nbsp;<span class="op" id="1550163">&gt;</span>&nbsp;<span class="num" id="1550165">2</span><span class="op" id="1550166">*</span><span class="ident" id="1550167">ptrSize</span>&nbsp;<span class="op" id="1550175">&amp;&amp;</span>&nbsp;<span class="op" id="1550178">(</span><span class="op" id="1550179">(</span><span class="op" id="1550180">*</span><span class="op" id="1550181">[</span><span class="num" id="1550182">2</span><span class="op" id="1550183">]</span><span class="builtintype" id="1550184">uintptr</span><span class="op" id="1550191">)</span><span class="op" id="1550192">(</span><span class="ident" id="1550193">x</span><span class="op" id="1550194">)</span><span class="op" id="1550195">)</span><span class="op" id="1550196">[</span><span class="num" id="1550197">1</span><span class="op" id="1550198">]</span>&nbsp;<span class="op" id="1550200">!=</span>&nbsp;<span class="num" id="1550203">0</span>&nbsp;<span class="op" id="1550205">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550212">memclr</span><span class="op" id="1550218">(</span><span class="ident" id="1550219">unsafe</span><span class="op" id="1550225">.</span><span class="ident" id="1550226">Pointer</span><span class="op" id="1550233">(</span><span class="ident" id="1550234">v</span><span class="op" id="1550235">)</span><span class="op" id="1550236">,</span>&nbsp;<span class="ident" id="1550238">size</span><span class="op" id="1550242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550261">c</span><span class="op" id="1550262">.</span><span class="ident" id="1550263">local_cachealloc</span>&nbsp;<span class="op" id="1550280">+=</span>&nbsp;<span class="ident" id="1550283">intptr</span><span class="op" id="1550289">(</span><span class="ident" id="1550290">size</span><span class="op" id="1550294">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550297">}</span>&nbsp;<span class="keyword" id="1550299">else</span>&nbsp;<span class="op" id="1550304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550308">mp</span>&nbsp;<span class="op" id="1550311">:=</span>&nbsp;<span class="ident" id="1550314">acquirem</span><span class="op" id="1550322">(</span><span class="op" id="1550323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550327">mp</span><span class="op" id="1550329">.</span><span class="ident" id="1550330">scalararg</span><span class="op" id="1550339">[</span><span class="num" id="1550340">0</span><span class="op" id="1550341">]</span>&nbsp;<span class="op" id="1550343">=</span>&nbsp;<span class="builtintype" id="1550345">uintptr</span><span class="op" id="1550352">(</span><span class="ident" id="1550353">size</span><span class="op" id="1550357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550361">mp</span><span class="op" id="1550363">.</span><span class="ident" id="1550364">scalararg</span><span class="op" id="1550373">[</span><span class="num" id="1550374">1</span><span class="op" id="1550375">]</span>&nbsp;<span class="op" id="1550377">=</span>&nbsp;<span class="builtintype" id="1550379">uintptr</span><span class="op" id="1550386">(</span><span class="ident" id="1550387">flags</span><span class="op" id="1550392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550396">onM</span><span class="op" id="1550399">(</span><span class="ident" id="1550400">largeAlloc_m</span><span class="op" id="1550412">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550416">s</span>&nbsp;<span class="op" id="1550418">=</span>&nbsp;<span class="op" id="1550420">(</span><span class="op" id="1550421">*</span><span class="ident" id="1550422">mspan</span><span class="op" id="1550427">)</span><span class="op" id="1550428">(</span><span class="ident" id="1550429">mp</span><span class="op" id="1550431">.</span><span class="ident" id="1550432">ptrarg</span><span class="op" id="1550438">[</span><span class="num" id="1550439">0</span><span class="op" id="1550440">]</span><span class="op" id="1550441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550445">mp</span><span class="op" id="1550447">.</span><span class="ident" id="1550448">ptrarg</span><span class="op" id="1550454">[</span><span class="num" id="1550455">0</span><span class="op" id="1550456">]</span>&nbsp;<span class="op" id="1550458">=</span>&nbsp;<span class="ident" id="1550460">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550466">releasem</span><span class="op" id="1550474">(</span><span class="ident" id="1550475">mp</span><span class="op" id="1550477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550481">x</span>&nbsp;<span class="op" id="1550483">=</span>&nbsp;<span class="ident" id="1550485">unsafe</span><span class="op" id="1550491">.</span><span class="ident" id="1550492">Pointer</span><span class="op" id="1550499">(</span><span class="builtintype" id="1550500">uintptr</span><span class="op" id="1550507">(</span><span class="ident" id="1550508">s</span><span class="op" id="1550509">.</span><span class="ident" id="1550510">start</span>&nbsp;<span class="op" id="1550516">&lt;&lt;</span>&nbsp;<span class="ident" id="1550519">pageShift</span><span class="op" id="1550528">)</span><span class="op" id="1550529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1550533">size</span>&nbsp;<span class="op" id="1550538">=</span>&nbsp;<span class="builtintype" id="1550540">uintptr</span><span class="op" id="1550547">(</span><span class="ident" id="1550548">s</span><span class="op" id="1550549">.</span><span class="ident" id="1550550">elemsize</span><span class="op" id="1550558">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550565">if</span>&nbsp;<span class="ident" id="1550568">flags</span><span class="op" id="1550573">&amp;</span><span class="ident" id="1550574">flagNoScan</span>&nbsp;<span class="op" id="1550585">!=</span>&nbsp;<span class="num" id="1550588">0</span>&nbsp;<span class="op" id="1550590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550594">//&nbsp;All&nbsp;objects&nbsp;are&nbsp;pre-marked&nbsp;as&nbsp;noscan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1550637">goto</span>&nbsp;<span class="ident" id="1550642">marked</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1550650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550654">//&nbsp;If&nbsp;allocating&nbsp;a&nbsp;defer+arg&nbsp;block,&nbsp;now&nbsp;that&nbsp;we&#39;ve&nbsp;picked&nbsp;a&nbsp;malloc&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550727">//&nbsp;large&nbsp;enough&nbsp;to&nbsp;hold&nbsp;everything,&nbsp;cut&nbsp;the&nbsp;&#34;asked&nbsp;for&#34;&nbsp;size&nbsp;down&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550797">//&nbsp;just&nbsp;the&nbsp;defer&nbsp;header,&nbsp;so&nbsp;that&nbsp;the&nbsp;GC&nbsp;bitmap&nbsp;will&nbsp;record&nbsp;the&nbsp;arg&nbsp;block</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550872">//&nbsp;as&nbsp;containing&nbsp;nothing&nbsp;at&nbsp;all&nbsp;(as&nbsp;if&nbsp;it&nbsp;were&nbsp;unused&nbsp;space&nbsp;at&nbsp;the&nbsp;end&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550947">//&nbsp;a&nbsp;malloc&nbsp;block&nbsp;caused&nbsp;by&nbsp;size&nbsp;rounding).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1550992">//&nbsp;The&nbsp;defer&nbsp;arg&nbsp;areas&nbsp;are&nbsp;scanned&nbsp;as&nbsp;part&nbsp;of&nbsp;scanstack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551050">if</span>&nbsp;<span class="ident" id="1551053">typ</span>&nbsp;<span class="op" id="1551057">==</span>&nbsp;<span class="ident" id="1551060">deferType</span>&nbsp;<span class="op" id="1551070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551074">size0</span>&nbsp;<span class="op" id="1551080">=</span>&nbsp;<span class="ident" id="1551082">unsafe</span><span class="op" id="1551088">.</span><span class="ident" id="1551089">Sizeof</span><span class="op" id="1551095">(</span><span class="ident" id="1551096">_defer</span><span class="op" id="1551102">{</span><span class="op" id="1551103">}</span><span class="op" id="1551104">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551111">//&nbsp;From&nbsp;here&nbsp;till&nbsp;marked&nbsp;label&nbsp;marking&nbsp;the&nbsp;object&nbsp;as&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551175">//&nbsp;and&nbsp;storing&nbsp;type&nbsp;info&nbsp;in&nbsp;the&nbsp;GC&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551219">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551223">arena_start</span>&nbsp;<span class="op" id="1551235">:=</span>&nbsp;<span class="builtintype" id="1551238">uintptr</span><span class="op" id="1551245">(</span><span class="ident" id="1551246">unsafe</span><span class="op" id="1551252">.</span><span class="ident" id="1551253">Pointer</span><span class="op" id="1551260">(</span><span class="ident" id="1551261">mheap_</span><span class="op" id="1551267">.</span><span class="ident" id="1551268">arena_start</span><span class="op" id="1551279">)</span><span class="op" id="1551280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551284">off</span>&nbsp;<span class="op" id="1551288">:=</span>&nbsp;<span class="op" id="1551291">(</span><span class="builtintype" id="1551292">uintptr</span><span class="op" id="1551299">(</span><span class="ident" id="1551300">x</span><span class="op" id="1551301">)</span>&nbsp;<span class="op" id="1551303">-</span>&nbsp;<span class="ident" id="1551305">arena_start</span><span class="op" id="1551316">)</span>&nbsp;<span class="op" id="1551318">/</span>&nbsp;<span class="ident" id="1551320">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551330">xbits</span>&nbsp;<span class="op" id="1551336">:=</span>&nbsp;<span class="op" id="1551339">(</span><span class="op" id="1551340">*</span><span class="builtintype" id="1551341">uint8</span><span class="op" id="1551346">)</span><span class="op" id="1551347">(</span><span class="ident" id="1551348">unsafe</span><span class="op" id="1551354">.</span><span class="ident" id="1551355">Pointer</span><span class="op" id="1551362">(</span><span class="ident" id="1551363">arena_start</span>&nbsp;<span class="op" id="1551375">-</span>&nbsp;<span class="ident" id="1551377">off</span><span class="op" id="1551380">/</span><span class="ident" id="1551381">wordsPerBitmapByte</span>&nbsp;<span class="op" id="1551400">-</span>&nbsp;<span class="num" id="1551402">1</span><span class="op" id="1551403">)</span><span class="op" id="1551404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551408">shift</span>&nbsp;<span class="op" id="1551414">:=</span>&nbsp;<span class="op" id="1551417">(</span><span class="ident" id="1551418">off</span>&nbsp;<span class="op" id="1551422">%</span>&nbsp;<span class="ident" id="1551424">wordsPerBitmapByte</span><span class="op" id="1551442">)</span>&nbsp;<span class="op" id="1551444">*</span>&nbsp;<span class="ident" id="1551446">gcBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551455">if</span>&nbsp;<span class="ident" id="1551458">debugMalloc</span>&nbsp;<span class="op" id="1551470">&amp;&amp;</span>&nbsp;<span class="op" id="1551473">(</span><span class="op" id="1551474">(</span><span class="op" id="1551475">*</span><span class="ident" id="1551476">xbits</span><span class="op" id="1551481">&gt;&gt;</span><span class="ident" id="1551483">shift</span><span class="op" id="1551488">)</span><span class="op" id="1551489">&amp;</span><span class="op" id="1551490">(</span><span class="ident" id="1551491">bitMask</span><span class="op" id="1551498">|</span><span class="ident" id="1551499">bitPtrMask</span><span class="op" id="1551509">)</span><span class="op" id="1551510">)</span>&nbsp;<span class="op" id="1551512">!=</span>&nbsp;<span class="ident" id="1551515">bitBoundary</span>&nbsp;<span class="op" id="1551527">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1551532">println</span><span class="op" id="1551539">(</span><span class="string" id="1551540">&#34;runtime:&nbsp;bits&nbsp;=&#34;</span><span class="op" id="1551557">,</span>&nbsp;<span class="op" id="1551559">(</span><span class="op" id="1551560">*</span><span class="ident" id="1551561">xbits</span><span class="op" id="1551566">&gt;&gt;</span><span class="ident" id="1551568">shift</span><span class="op" id="1551573">)</span><span class="op" id="1551574">&amp;</span><span class="op" id="1551575">(</span><span class="ident" id="1551576">bitMask</span><span class="op" id="1551583">|</span><span class="ident" id="1551584">bitPtrMask</span><span class="op" id="1551594">)</span><span class="op" id="1551595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551600">gothrow</span><span class="op" id="1551607">(</span><span class="string" id="1551608">&#34;bad&nbsp;bits&nbsp;in&nbsp;markallocated&#34;</span><span class="op" id="1551635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551644">var</span>&nbsp;<span class="ident" id="1551648">ti</span><span class="op" id="1551650">,</span>&nbsp;<span class="ident" id="1551652">te</span>&nbsp;<span class="builtintype" id="1551655">uintptr</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551665">var</span>&nbsp;<span class="ident" id="1551669">ptrmask</span>&nbsp;<span class="op" id="1551677">*</span><span class="builtintype" id="1551678">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551686">if</span>&nbsp;<span class="ident" id="1551689">size</span>&nbsp;<span class="op" id="1551694">==</span>&nbsp;<span class="ident" id="1551697">ptrSize</span>&nbsp;<span class="op" id="1551705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1551710">//&nbsp;It&#39;s&nbsp;one&nbsp;word&nbsp;and&nbsp;it&nbsp;has&nbsp;pointers,&nbsp;it&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551773">*</span><span class="ident" id="1551774">xbits</span>&nbsp;<span class="op" id="1551780">|=</span>&nbsp;<span class="op" id="1551783">(</span><span class="ident" id="1551784">bitsPointer</span>&nbsp;<span class="op" id="1551796">&lt;&lt;</span>&nbsp;<span class="num" id="1551799">2</span><span class="op" id="1551800">)</span>&nbsp;<span class="op" id="1551802">&lt;&lt;</span>&nbsp;<span class="ident" id="1551805">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551814">goto</span>&nbsp;<span class="ident" id="1551819">marked</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551832">if</span>&nbsp;<span class="ident" id="1551835">typ</span><span class="op" id="1551838">.</span><span class="ident" id="1551839">kind</span><span class="op" id="1551843">&amp;</span><span class="ident" id="1551844">kindGCProg</span>&nbsp;<span class="op" id="1551855">!=</span>&nbsp;<span class="num" id="1551858">0</span>&nbsp;<span class="op" id="1551860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551865">nptr</span>&nbsp;<span class="op" id="1551870">:=</span>&nbsp;<span class="op" id="1551873">(</span><span class="builtintype" id="1551874">uintptr</span><span class="op" id="1551881">(</span><span class="ident" id="1551882">typ</span><span class="op" id="1551885">.</span><span class="ident" id="1551886">size</span><span class="op" id="1551890">)</span>&nbsp;<span class="op" id="1551892">+</span>&nbsp;<span class="ident" id="1551894">ptrSize</span>&nbsp;<span class="op" id="1551902">-</span>&nbsp;<span class="num" id="1551904">1</span><span class="op" id="1551905">)</span>&nbsp;<span class="op" id="1551907">/</span>&nbsp;<span class="ident" id="1551909">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551920">masksize</span>&nbsp;<span class="op" id="1551929">:=</span>&nbsp;<span class="ident" id="1551932">nptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1551940">if</span>&nbsp;<span class="ident" id="1551943">masksize</span><span class="op" id="1551951">%</span><span class="num" id="1551952">2</span>&nbsp;<span class="op" id="1551954">!=</span>&nbsp;<span class="num" id="1551957">0</span>&nbsp;<span class="op" id="1551959">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551965">masksize</span>&nbsp;<span class="op" id="1551974">*=</span>&nbsp;<span class="num" id="1551977">2</span>&nbsp;<span class="comment" id="1551979">//&nbsp;repeated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1551994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1551999">masksize</span>&nbsp;<span class="op" id="1552008">=</span>&nbsp;<span class="ident" id="1552010">masksize</span>&nbsp;<span class="op" id="1552019">*</span>&nbsp;<span class="ident" id="1552021">pointersPerByte</span>&nbsp;<span class="op" id="1552037">/</span>&nbsp;<span class="num" id="1552039">8</span>&nbsp;<span class="comment" id="1552041">//&nbsp;4&nbsp;bits&nbsp;per&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552063">masksize</span><span class="op" id="1552071">++</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552105">//&nbsp;unroll&nbsp;flag&nbsp;in&nbsp;the&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552140">if</span>&nbsp;<span class="ident" id="1552143">masksize</span>&nbsp;<span class="op" id="1552152">&gt;</span>&nbsp;<span class="ident" id="1552154">maxGCMask</span>&nbsp;<span class="op" id="1552164">&amp;&amp;</span>&nbsp;<span class="ident" id="1552167">typ</span><span class="op" id="1552170">.</span><span class="ident" id="1552171">gc</span><span class="op" id="1552173">[</span><span class="num" id="1552174">1</span><span class="op" id="1552175">]</span>&nbsp;<span class="op" id="1552177">!=</span>&nbsp;<span class="num" id="1552180">0</span>&nbsp;<span class="op" id="1552182">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552188">//&nbsp;If&nbsp;the&nbsp;mask&nbsp;is&nbsp;too&nbsp;large,&nbsp;unroll&nbsp;the&nbsp;program&nbsp;directly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552249">//&nbsp;into&nbsp;the&nbsp;GC&nbsp;bitmap.&nbsp;It&#39;s&nbsp;7&nbsp;times&nbsp;slower&nbsp;than&nbsp;copying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552309">//&nbsp;from&nbsp;the&nbsp;pre-unrolled&nbsp;mask,&nbsp;but&nbsp;saves&nbsp;1/16&nbsp;of&nbsp;type&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552372">//&nbsp;memory&nbsp;for&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552400">mp</span>&nbsp;<span class="op" id="1552403">:=</span>&nbsp;<span class="ident" id="1552406">acquirem</span><span class="op" id="1552414">(</span><span class="op" id="1552415">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552421">mp</span><span class="op" id="1552423">.</span><span class="ident" id="1552424">ptrarg</span><span class="op" id="1552430">[</span><span class="num" id="1552431">0</span><span class="op" id="1552432">]</span>&nbsp;<span class="op" id="1552434">=</span>&nbsp;<span class="ident" id="1552436">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552442">mp</span><span class="op" id="1552444">.</span><span class="ident" id="1552445">ptrarg</span><span class="op" id="1552451">[</span><span class="num" id="1552452">1</span><span class="op" id="1552453">]</span>&nbsp;<span class="op" id="1552455">=</span>&nbsp;<span class="ident" id="1552457">unsafe</span><span class="op" id="1552463">.</span><span class="ident" id="1552464">Pointer</span><span class="op" id="1552471">(</span><span class="ident" id="1552472">typ</span><span class="op" id="1552475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552481">mp</span><span class="op" id="1552483">.</span><span class="ident" id="1552484">scalararg</span><span class="op" id="1552493">[</span><span class="num" id="1552494">0</span><span class="op" id="1552495">]</span>&nbsp;<span class="op" id="1552497">=</span>&nbsp;<span class="builtintype" id="1552499">uintptr</span><span class="op" id="1552506">(</span><span class="ident" id="1552507">size</span><span class="op" id="1552511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552517">mp</span><span class="op" id="1552519">.</span><span class="ident" id="1552520">scalararg</span><span class="op" id="1552529">[</span><span class="num" id="1552530">1</span><span class="op" id="1552531">]</span>&nbsp;<span class="op" id="1552533">=</span>&nbsp;<span class="builtintype" id="1552535">uintptr</span><span class="op" id="1552542">(</span><span class="ident" id="1552543">size0</span><span class="op" id="1552548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552554">onM</span><span class="op" id="1552557">(</span><span class="ident" id="1552558">unrollgcproginplace_m</span><span class="op" id="1552579">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552585">releasem</span><span class="op" id="1552593">(</span><span class="ident" id="1552594">mp</span><span class="op" id="1552596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552602">goto</span>&nbsp;<span class="ident" id="1552607">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552622">ptrmask</span>&nbsp;<span class="op" id="1552630">=</span>&nbsp;<span class="op" id="1552632">(</span><span class="op" id="1552633">*</span><span class="builtintype" id="1552634">uint8</span><span class="op" id="1552639">)</span><span class="op" id="1552640">(</span><span class="ident" id="1552641">unsafe</span><span class="op" id="1552647">.</span><span class="ident" id="1552648">Pointer</span><span class="op" id="1552655">(</span><span class="builtintype" id="1552656">uintptr</span><span class="op" id="1552663">(</span><span class="ident" id="1552664">typ</span><span class="op" id="1552667">.</span><span class="ident" id="1552668">gc</span><span class="op" id="1552670">[</span><span class="num" id="1552671">0</span><span class="op" id="1552672">]</span><span class="op" id="1552673">)</span><span class="op" id="1552674">)</span><span class="op" id="1552675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1552680">//&nbsp;Check&nbsp;whether&nbsp;the&nbsp;program&nbsp;is&nbsp;already&nbsp;unrolled.</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1552733">if</span>&nbsp;<span class="builtintype" id="1552736">uintptr</span><span class="op" id="1552743">(</span><span class="ident" id="1552744">atomicloadp</span><span class="op" id="1552755">(</span><span class="ident" id="1552756">unsafe</span><span class="op" id="1552762">.</span><span class="ident" id="1552763">Pointer</span><span class="op" id="1552770">(</span><span class="ident" id="1552771">ptrmask</span><span class="op" id="1552778">)</span><span class="op" id="1552779">)</span><span class="op" id="1552780">)</span><span class="op" id="1552781">&amp;</span><span class="num" id="1552782">0xff</span>&nbsp;<span class="op" id="1552787">==</span>&nbsp;<span class="num" id="1552790">0</span>&nbsp;<span class="op" id="1552792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552798">mp</span>&nbsp;<span class="op" id="1552801">:=</span>&nbsp;<span class="ident" id="1552804">acquirem</span><span class="op" id="1552812">(</span><span class="op" id="1552813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552819">mp</span><span class="op" id="1552821">.</span><span class="ident" id="1552822">ptrarg</span><span class="op" id="1552828">[</span><span class="num" id="1552829">0</span><span class="op" id="1552830">]</span>&nbsp;<span class="op" id="1552832">=</span>&nbsp;<span class="ident" id="1552834">unsafe</span><span class="op" id="1552840">.</span><span class="ident" id="1552841">Pointer</span><span class="op" id="1552848">(</span><span class="ident" id="1552849">typ</span><span class="op" id="1552852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552858">onM</span><span class="op" id="1552861">(</span><span class="ident" id="1552862">unrollgcprog_m</span><span class="op" id="1552876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552882">releasem</span><span class="op" id="1552890">(</span><span class="ident" id="1552891">mp</span><span class="op" id="1552893">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552903">ptrmask</span>&nbsp;<span class="op" id="1552911">=</span>&nbsp;<span class="op" id="1552913">(</span><span class="op" id="1552914">*</span><span class="builtintype" id="1552915">uint8</span><span class="op" id="1552920">)</span><span class="op" id="1552921">(</span><span class="ident" id="1552922">add</span><span class="op" id="1552925">(</span><span class="ident" id="1552926">unsafe</span><span class="op" id="1552932">.</span><span class="ident" id="1552933">Pointer</span><span class="op" id="1552940">(</span><span class="ident" id="1552941">ptrmask</span><span class="op" id="1552948">)</span><span class="op" id="1552949">,</span>&nbsp;<span class="num" id="1552951">1</span><span class="op" id="1552952">)</span><span class="op" id="1552953">)</span>&nbsp;<span class="comment" id="1552955">//&nbsp;skip&nbsp;the&nbsp;unroll&nbsp;flag&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1552986">}</span>&nbsp;<span class="keyword" id="1552988">else</span>&nbsp;<span class="op" id="1552993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1552998">ptrmask</span>&nbsp;<span class="op" id="1553006">=</span>&nbsp;<span class="op" id="1553008">(</span><span class="op" id="1553009">*</span><span class="builtintype" id="1553010">uint8</span><span class="op" id="1553015">)</span><span class="op" id="1553016">(</span><span class="ident" id="1553017">unsafe</span><span class="op" id="1553023">.</span><span class="ident" id="1553024">Pointer</span><span class="op" id="1553031">(</span><span class="ident" id="1553032">typ</span><span class="op" id="1553035">.</span><span class="ident" id="1553036">gc</span><span class="op" id="1553038">[</span><span class="num" id="1553039">0</span><span class="op" id="1553040">]</span><span class="op" id="1553041">)</span><span class="op" id="1553042">)</span>&nbsp;<span class="comment" id="1553044">//&nbsp;pointer&nbsp;to&nbsp;unrolled&nbsp;mask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553074">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553078">if</span>&nbsp;<span class="ident" id="1553081">size</span>&nbsp;<span class="op" id="1553086">==</span>&nbsp;<span class="num" id="1553089">2</span><span class="op" id="1553090">*</span><span class="ident" id="1553091">ptrSize</span>&nbsp;<span class="op" id="1553099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553104">*</span><span class="ident" id="1553105">xbits</span>&nbsp;<span class="op" id="1553111">=</span>&nbsp;<span class="op" id="1553113">*</span><span class="ident" id="1553114">ptrmask</span>&nbsp;<span class="op" id="1553122">|</span>&nbsp;<span class="ident" id="1553124">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553139">goto</span>&nbsp;<span class="ident" id="1553144">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553157">te</span>&nbsp;<span class="op" id="1553160">=</span>&nbsp;<span class="builtintype" id="1553162">uintptr</span><span class="op" id="1553169">(</span><span class="ident" id="1553170">typ</span><span class="op" id="1553173">.</span><span class="ident" id="1553174">size</span><span class="op" id="1553178">)</span>&nbsp;<span class="op" id="1553180">/</span>&nbsp;<span class="ident" id="1553182">ptrSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1553192">//&nbsp;If&nbsp;the&nbsp;type&nbsp;occupies&nbsp;odd&nbsp;number&nbsp;of&nbsp;words,&nbsp;its&nbsp;mask&nbsp;is&nbsp;repeated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553261">if</span>&nbsp;<span class="ident" id="1553264">te</span><span class="op" id="1553266">%</span><span class="num" id="1553267">2</span>&nbsp;<span class="op" id="1553269">==</span>&nbsp;<span class="num" id="1553272">0</span>&nbsp;<span class="op" id="1553274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553279">te</span>&nbsp;<span class="op" id="1553282">/=</span>&nbsp;<span class="num" id="1553285">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1553293">//&nbsp;Copy&nbsp;pointer&nbsp;bitmask&nbsp;into&nbsp;the&nbsp;bitmap.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553336">for</span>&nbsp;<span class="ident" id="1553340">i</span>&nbsp;<span class="op" id="1553342">:=</span>&nbsp;<span class="builtintype" id="1553345">uintptr</span><span class="op" id="1553352">(</span><span class="num" id="1553353">0</span><span class="op" id="1553354">)</span><span class="op" id="1553355">;</span>&nbsp;<span class="ident" id="1553357">i</span>&nbsp;<span class="op" id="1553359">&lt;</span>&nbsp;<span class="ident" id="1553361">size0</span><span class="op" id="1553366">;</span>&nbsp;<span class="ident" id="1553368">i</span>&nbsp;<span class="op" id="1553370">+=</span>&nbsp;<span class="num" id="1553373">2</span>&nbsp;<span class="op" id="1553375">*</span>&nbsp;<span class="ident" id="1553377">ptrSize</span>&nbsp;<span class="op" id="1553385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553390">v</span>&nbsp;<span class="op" id="1553392">:=</span>&nbsp;<span class="op" id="1553395">*</span><span class="op" id="1553396">(</span><span class="op" id="1553397">*</span><span class="builtintype" id="1553398">uint8</span><span class="op" id="1553403">)</span><span class="op" id="1553404">(</span><span class="ident" id="1553405">add</span><span class="op" id="1553408">(</span><span class="ident" id="1553409">unsafe</span><span class="op" id="1553415">.</span><span class="ident" id="1553416">Pointer</span><span class="op" id="1553423">(</span><span class="ident" id="1553424">ptrmask</span><span class="op" id="1553431">)</span><span class="op" id="1553432">,</span>&nbsp;<span class="ident" id="1553434">ti</span><span class="op" id="1553436">)</span><span class="op" id="1553437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553442">ti</span><span class="op" id="1553444">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553450">if</span>&nbsp;<span class="ident" id="1553453">ti</span>&nbsp;<span class="op" id="1553456">==</span>&nbsp;<span class="ident" id="1553459">te</span>&nbsp;<span class="op" id="1553462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553468">ti</span>&nbsp;<span class="op" id="1553471">=</span>&nbsp;<span class="num" id="1553473">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553483">if</span>&nbsp;<span class="ident" id="1553486">i</span>&nbsp;<span class="op" id="1553488">==</span>&nbsp;<span class="num" id="1553491">0</span>&nbsp;<span class="op" id="1553493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553499">v</span>&nbsp;<span class="op" id="1553501">|=</span>&nbsp;<span class="ident" id="1553504">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553524">if</span>&nbsp;<span class="ident" id="1553527">i</span><span class="op" id="1553528">+</span><span class="ident" id="1553529">ptrSize</span>&nbsp;<span class="op" id="1553537">==</span>&nbsp;<span class="ident" id="1553540">size0</span>&nbsp;<span class="op" id="1553546">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553552">v</span>&nbsp;<span class="op" id="1553554">&amp;^=</span>&nbsp;<span class="builtintype" id="1553558">uint8</span><span class="op" id="1553563">(</span><span class="ident" id="1553564">bitPtrMask</span>&nbsp;<span class="op" id="1553575">&lt;&lt;</span>&nbsp;<span class="num" id="1553578">4</span><span class="op" id="1553579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553590">*</span><span class="ident" id="1553591">xbits</span>&nbsp;<span class="op" id="1553597">=</span>&nbsp;<span class="ident" id="1553599">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553604">xbits</span>&nbsp;<span class="op" id="1553610">=</span>&nbsp;<span class="op" id="1553612">(</span><span class="op" id="1553613">*</span><span class="builtintype" id="1553614">byte</span><span class="op" id="1553618">)</span><span class="op" id="1553619">(</span><span class="ident" id="1553620">add</span><span class="op" id="1553623">(</span><span class="ident" id="1553624">unsafe</span><span class="op" id="1553630">.</span><span class="ident" id="1553631">Pointer</span><span class="op" id="1553638">(</span><span class="ident" id="1553639">xbits</span><span class="op" id="1553644">)</span><span class="op" id="1553645">,</span>&nbsp;<span class="op" id="1553647">^</span><span class="builtintype" id="1553648">uintptr</span><span class="op" id="1553655">(</span><span class="num" id="1553656">0</span><span class="op" id="1553657">)</span><span class="op" id="1553658">)</span><span class="op" id="1553659">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553667">if</span>&nbsp;<span class="ident" id="1553670">size0</span><span class="op" id="1553675">%</span><span class="op" id="1553676">(</span><span class="num" id="1553677">2</span><span class="op" id="1553678">*</span><span class="ident" id="1553679">ptrSize</span><span class="op" id="1553686">)</span>&nbsp;<span class="op" id="1553688">==</span>&nbsp;<span class="num" id="1553691">0</span>&nbsp;<span class="op" id="1553693">&amp;&amp;</span>&nbsp;<span class="ident" id="1553696">size0</span>&nbsp;<span class="op" id="1553702">&lt;</span>&nbsp;<span class="ident" id="1553704">size</span>&nbsp;<span class="op" id="1553709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1553714">//&nbsp;Mark&nbsp;the&nbsp;word&nbsp;after&nbsp;last&nbsp;object&#39;s&nbsp;word&nbsp;as&nbsp;bitsDead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553772">*</span><span class="ident" id="1553773">xbits</span>&nbsp;<span class="op" id="1553779">=</span>&nbsp;<span class="ident" id="1553781">bitsDead</span>&nbsp;<span class="op" id="1553790">&lt;&lt;</span>&nbsp;<span class="num" id="1553793">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553797">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553800">}</span><br>
<span class="lineno"></span><span class="ident" id="1553802">marked</span><span class="op" id="1553808">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553811">if</span>&nbsp;<span class="ident" id="1553814">raceenabled</span>&nbsp;<span class="op" id="1553826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553830">racemalloc</span><span class="op" id="1553840">(</span><span class="ident" id="1553841">x</span><span class="op" id="1553842">,</span>&nbsp;<span class="ident" id="1553844">size</span><span class="op" id="1553848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553851">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553855">if</span>&nbsp;<span class="ident" id="1553858">debugMalloc</span>&nbsp;<span class="op" id="1553870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553874">mp</span>&nbsp;<span class="op" id="1553877">:=</span>&nbsp;<span class="ident" id="1553880">acquirem</span><span class="op" id="1553888">(</span><span class="op" id="1553889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553893">if</span>&nbsp;<span class="ident" id="1553896">mp</span><span class="op" id="1553898">.</span><span class="ident" id="1553899">mallocing</span>&nbsp;<span class="op" id="1553909">==</span>&nbsp;<span class="num" id="1553912">0</span>&nbsp;<span class="op" id="1553914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553919">gothrow</span><span class="op" id="1553926">(</span><span class="string" id="1553927">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1553939">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1553943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553947">mp</span><span class="op" id="1553949">.</span><span class="ident" id="1553950">mallocing</span>&nbsp;<span class="op" id="1553960">=</span>&nbsp;<span class="num" id="1553962">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1553966">if</span>&nbsp;<span class="ident" id="1553969">mp</span><span class="op" id="1553971">.</span><span class="ident" id="1553972">curg</span>&nbsp;<span class="op" id="1553977">!=</span>&nbsp;<span class="ident" id="1553980">nil</span>&nbsp;<span class="op" id="1553984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1553989">mp</span><span class="op" id="1553991">.</span><span class="ident" id="1553992">curg</span><span class="op" id="1553996">.</span><span class="ident" id="1553997">stackguard0</span>&nbsp;<span class="op" id="1554009">=</span>&nbsp;<span class="ident" id="1554011">mp</span><span class="op" id="1554013">.</span><span class="ident" id="1554014">curg</span><span class="op" id="1554018">.</span><span class="ident" id="1554019">stack</span><span class="op" id="1554024">.</span><span class="ident" id="1554025">lo</span>&nbsp;<span class="op" id="1554028">+</span>&nbsp;<span class="ident" id="1554030">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554044">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1554048">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1554101">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554153">releasem</span><span class="op" id="1554161">(</span><span class="ident" id="1554162">mp</span><span class="op" id="1554164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554168">releasem</span><span class="op" id="1554176">(</span><span class="ident" id="1554177">mp</span><span class="op" id="1554179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554182">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554186">if</span>&nbsp;<span class="ident" id="1554189">debug</span><span class="op" id="1554194">.</span><span class="ident" id="1554195">allocfreetrace</span>&nbsp;<span class="op" id="1554210">!=</span>&nbsp;<span class="num" id="1554213">0</span>&nbsp;<span class="op" id="1554215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554219">tracealloc</span><span class="op" id="1554229">(</span><span class="ident" id="1554230">x</span><span class="op" id="1554231">,</span>&nbsp;<span class="ident" id="1554233">size</span><span class="op" id="1554237">,</span>&nbsp;<span class="ident" id="1554239">typ</span><span class="op" id="1554242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554249">if</span>&nbsp;<span class="ident" id="1554252">rate</span>&nbsp;<span class="op" id="1554257">:=</span>&nbsp;<span class="ident" id="1554260">MemProfileRate</span><span class="op" id="1554274">;</span>&nbsp;<span class="ident" id="1554276">rate</span>&nbsp;<span class="op" id="1554281">&gt;</span>&nbsp;<span class="num" id="1554283">0</span>&nbsp;<span class="op" id="1554285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554289">if</span>&nbsp;<span class="ident" id="1554292">size</span>&nbsp;<span class="op" id="1554297">&lt;</span>&nbsp;<span class="builtintype" id="1554299">uintptr</span><span class="op" id="1554306">(</span><span class="ident" id="1554307">rate</span><span class="op" id="1554311">)</span>&nbsp;<span class="op" id="1554313">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1554316">int32</span><span class="op" id="1554321">(</span><span class="ident" id="1554322">size</span><span class="op" id="1554326">)</span>&nbsp;<span class="op" id="1554328">&lt;</span>&nbsp;<span class="ident" id="1554330">c</span><span class="op" id="1554331">.</span><span class="ident" id="1554332">next_sample</span>&nbsp;<span class="op" id="1554344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554349">c</span><span class="op" id="1554350">.</span><span class="ident" id="1554351">next_sample</span>&nbsp;<span class="op" id="1554363">-=</span>&nbsp;<span class="builtintype" id="1554366">int32</span><span class="op" id="1554371">(</span><span class="ident" id="1554372">size</span><span class="op" id="1554376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554380">}</span>&nbsp;<span class="keyword" id="1554382">else</span>&nbsp;<span class="op" id="1554387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554392">mp</span>&nbsp;<span class="op" id="1554395">:=</span>&nbsp;<span class="ident" id="1554398">acquirem</span><span class="op" id="1554406">(</span><span class="op" id="1554407">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554412">profilealloc</span><span class="op" id="1554424">(</span><span class="ident" id="1554425">mp</span><span class="op" id="1554427">,</span>&nbsp;<span class="ident" id="1554429">x</span><span class="op" id="1554430">,</span>&nbsp;<span class="ident" id="1554432">size</span><span class="op" id="1554436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554441">releasem</span><span class="op" id="1554449">(</span><span class="ident" id="1554450">mp</span><span class="op" id="1554452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554463">if</span>&nbsp;<span class="ident" id="1554466">memstats</span><span class="op" id="1554474">.</span><span class="ident" id="1554475">heap_alloc</span>&nbsp;<span class="op" id="1554486">&gt;=</span>&nbsp;<span class="ident" id="1554489">memstats</span><span class="op" id="1554497">.</span><span class="ident" id="1554498">next_gc</span>&nbsp;<span class="op" id="1554506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554510">gogc</span><span class="op" id="1554514">(</span><span class="num" id="1554515">0</span><span class="op" id="1554516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554523">return</span>&nbsp;<span class="ident" id="1554530">x</span><br>
<span class="lineno">345</span><span class="op" id="1554532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1554535">//&nbsp;implementation&nbsp;of&nbsp;new&nbsp;builtin</span><br>
<span class="lineno"></span><span class="keyword" id="1554568">func</span>&nbsp;<span class="ident" id="1554573">newobject</span><span class="op" id="1554582">(</span><span class="ident" id="1554583">typ</span>&nbsp;<span class="op" id="1554587">*</span><span class="ident" id="1554588">_type</span><span class="op" id="1554593">)</span>&nbsp;<span class="ident" id="1554595">unsafe</span><span class="op" id="1554601">.</span><span class="ident" id="1554602">Pointer</span>&nbsp;<span class="op" id="1554610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554613">flags</span>&nbsp;<span class="op" id="1554619">:=</span>&nbsp;<span class="builtintype" id="1554622">uint32</span><span class="op" id="1554628">(</span><span class="num" id="1554629">0</span><span class="op" id="1554630">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554633">if</span>&nbsp;<span class="ident" id="1554636">typ</span><span class="op" id="1554639">.</span><span class="ident" id="1554640">kind</span><span class="op" id="1554644">&amp;</span><span class="ident" id="1554645">kindNoPointers</span>&nbsp;<span class="op" id="1554660">!=</span>&nbsp;<span class="num" id="1554663">0</span>&nbsp;<span class="op" id="1554665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554669">flags</span>&nbsp;<span class="op" id="1554675">|=</span>&nbsp;<span class="ident" id="1554678">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554693">return</span>&nbsp;<span class="ident" id="1554700">mallocgc</span><span class="op" id="1554708">(</span><span class="builtintype" id="1554709">uintptr</span><span class="op" id="1554716">(</span><span class="ident" id="1554717">typ</span><span class="op" id="1554720">.</span><span class="ident" id="1554721">size</span><span class="op" id="1554725">)</span><span class="op" id="1554726">,</span>&nbsp;<span class="ident" id="1554728">typ</span><span class="op" id="1554731">,</span>&nbsp;<span class="ident" id="1554733">flags</span><span class="op" id="1554738">)</span><br>
<span class="lineno"></span><span class="op" id="1554740">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1554743">//&nbsp;implementation&nbsp;of&nbsp;make&nbsp;builtin&nbsp;for&nbsp;slices</span><br>
<span class="lineno"></span><span class="keyword" id="1554788">func</span>&nbsp;<span class="ident" id="1554793">newarray</span><span class="op" id="1554801">(</span><span class="ident" id="1554802">typ</span>&nbsp;<span class="op" id="1554806">*</span><span class="ident" id="1554807">_type</span><span class="op" id="1554812">,</span>&nbsp;<span class="ident" id="1554814">n</span>&nbsp;<span class="builtintype" id="1554816">uintptr</span><span class="op" id="1554823">)</span>&nbsp;<span class="ident" id="1554825">unsafe</span><span class="op" id="1554831">.</span><span class="ident" id="1554832">Pointer</span>&nbsp;<span class="op" id="1554840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554843">flags</span>&nbsp;<span class="op" id="1554849">:=</span>&nbsp;<span class="builtintype" id="1554852">uint32</span><span class="op" id="1554858">(</span><span class="num" id="1554859">0</span><span class="op" id="1554860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554863">if</span>&nbsp;<span class="ident" id="1554866">typ</span><span class="op" id="1554869">.</span><span class="ident" id="1554870">kind</span><span class="op" id="1554874">&amp;</span><span class="ident" id="1554875">kindNoPointers</span>&nbsp;<span class="op" id="1554890">!=</span>&nbsp;<span class="num" id="1554893">0</span>&nbsp;<span class="op" id="1554895">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1554899">flags</span>&nbsp;<span class="op" id="1554905">|=</span>&nbsp;<span class="ident" id="1554908">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1554920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1554923">if</span>&nbsp;<span class="builtintype" id="1554926">int</span><span class="op" id="1554929">(</span><span class="ident" id="1554930">n</span><span class="op" id="1554931">)</span>&nbsp;<span class="op" id="1554933">&lt;</span>&nbsp;<span class="num" id="1554935">0</span>&nbsp;<span class="op" id="1554937">||</span>&nbsp;<span class="op" id="1554940">(</span><span class="ident" id="1554941">typ</span><span class="op" id="1554944">.</span><span class="ident" id="1554945">size</span>&nbsp;<span class="op" id="1554950">&gt;</span>&nbsp;<span class="num" id="1554952">0</span>&nbsp;<span class="op" id="1554954">&amp;&amp;</span>&nbsp;<span class="ident" id="1554957">n</span>&nbsp;<span class="op" id="1554959">&gt;</span>&nbsp;<span class="ident" id="1554961">maxmem</span><span class="op" id="1554967">/</span><span class="builtintype" id="1554968">uintptr</span><span class="op" id="1554975">(</span><span class="ident" id="1554976">typ</span><span class="op" id="1554979">.</span><span class="ident" id="1554980">size</span><span class="op" id="1554984">)</span><span class="op" id="1554985">)</span>&nbsp;<span class="op" id="1554987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1554991">panic</span><span class="op" id="1554996">(</span><span class="string" id="1554997">&#34;runtime:&nbsp;allocation&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1555036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1555039">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555042">return</span>&nbsp;<span class="ident" id="1555049">mallocgc</span><span class="op" id="1555057">(</span><span class="builtintype" id="1555058">uintptr</span><span class="op" id="1555065">(</span><span class="ident" id="1555066">typ</span><span class="op" id="1555069">.</span><span class="ident" id="1555070">size</span><span class="op" id="1555074">)</span><span class="op" id="1555075">*</span><span class="ident" id="1555076">n</span><span class="op" id="1555077">,</span>&nbsp;<span class="ident" id="1555079">typ</span><span class="op" id="1555082">,</span>&nbsp;<span class="ident" id="1555084">flags</span><span class="op" id="1555089">)</span><br>
<span class="lineno"></span><span class="op" id="1555091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1555094">//&nbsp;rawmem&nbsp;returns&nbsp;a&nbsp;chunk&nbsp;of&nbsp;pointerless&nbsp;memory.&nbsp;&nbsp;It&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1555150">//&nbsp;not&nbsp;zeroed.</span><br>
<span class="lineno">370</span><span class="keyword" id="1555165">func</span>&nbsp;<span class="ident" id="1555170">rawmem</span><span class="op" id="1555176">(</span><span class="ident" id="1555177">size</span>&nbsp;<span class="builtintype" id="1555182">uintptr</span><span class="op" id="1555189">)</span>&nbsp;<span class="ident" id="1555191">unsafe</span><span class="op" id="1555197">.</span><span class="ident" id="1555198">Pointer</span>&nbsp;<span class="op" id="1555206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555209">return</span>&nbsp;<span class="ident" id="1555216">mallocgc</span><span class="op" id="1555224">(</span><span class="ident" id="1555225">size</span><span class="op" id="1555229">,</span>&nbsp;<span class="ident" id="1555231">nil</span><span class="op" id="1555234">,</span>&nbsp;<span class="ident" id="1555236">flagNoScan</span><span class="op" id="1555246">|</span><span class="ident" id="1555247">flagNoZero</span><span class="op" id="1555257">)</span><br>
<span class="lineno"></span><span class="op" id="1555259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1555262">//&nbsp;round&nbsp;size&nbsp;up&nbsp;to&nbsp;next&nbsp;size&nbsp;class</span><br>
<span class="lineno">375</span><span class="keyword" id="1555298">func</span>&nbsp;<span class="ident" id="1555303">goroundupsize</span><span class="op" id="1555316">(</span><span class="ident" id="1555317">size</span>&nbsp;<span class="builtintype" id="1555322">uintptr</span><span class="op" id="1555329">)</span>&nbsp;<span class="builtintype" id="1555331">uintptr</span>&nbsp;<span class="op" id="1555339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555342">if</span>&nbsp;<span class="ident" id="1555345">size</span>&nbsp;<span class="op" id="1555350">&lt;</span>&nbsp;<span class="ident" id="1555352">maxSmallSize</span>&nbsp;<span class="op" id="1555365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555369">if</span>&nbsp;<span class="ident" id="1555372">size</span>&nbsp;<span class="op" id="1555377">&lt;=</span>&nbsp;<span class="num" id="1555380">1024</span><span class="op" id="1555384">-</span><span class="num" id="1555385">8</span>&nbsp;<span class="op" id="1555387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555392">return</span>&nbsp;<span class="builtintype" id="1555399">uintptr</span><span class="op" id="1555406">(</span><span class="ident" id="1555407">class_to_size</span><span class="op" id="1555420">[</span><span class="ident" id="1555421">size_to_class8</span><span class="op" id="1555435">[</span><span class="op" id="1555436">(</span><span class="ident" id="1555437">size</span><span class="op" id="1555441">+</span><span class="num" id="1555442">7</span><span class="op" id="1555443">)</span><span class="op" id="1555444">&gt;&gt;</span><span class="num" id="1555446">3</span><span class="op" id="1555447">]</span><span class="op" id="1555448">]</span><span class="op" id="1555449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1555453">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555457">return</span>&nbsp;<span class="builtintype" id="1555464">uintptr</span><span class="op" id="1555471">(</span><span class="ident" id="1555472">class_to_size</span><span class="op" id="1555485">[</span><span class="ident" id="1555486">size_to_class128</span><span class="op" id="1555502">[</span><span class="op" id="1555503">(</span><span class="ident" id="1555504">size</span><span class="op" id="1555508">-</span><span class="num" id="1555509">1024</span><span class="op" id="1555513">+</span><span class="num" id="1555514">127</span><span class="op" id="1555517">)</span><span class="op" id="1555518">&gt;&gt;</span><span class="num" id="1555520">7</span><span class="op" id="1555521">]</span><span class="op" id="1555522">]</span><span class="op" id="1555523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1555526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555529">if</span>&nbsp;<span class="ident" id="1555532">size</span><span class="op" id="1555536">+</span><span class="ident" id="1555537">pageSize</span>&nbsp;<span class="op" id="1555546">&lt;</span>&nbsp;<span class="ident" id="1555548">size</span>&nbsp;<span class="op" id="1555553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555557">return</span>&nbsp;<span class="ident" id="1555564">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1555570">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555573">return</span>&nbsp;<span class="op" id="1555580">(</span><span class="ident" id="1555581">size</span>&nbsp;<span class="op" id="1555586">+</span>&nbsp;<span class="ident" id="1555588">pageSize</span>&nbsp;<span class="op" id="1555597">-</span>&nbsp;<span class="num" id="1555599">1</span><span class="op" id="1555600">)</span>&nbsp;<span class="op" id="1555602">&amp;^</span>&nbsp;<span class="ident" id="1555605">pageMask</span><br>
<span class="lineno"></span><span class="op" id="1555614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1555617">func</span>&nbsp;<span class="ident" id="1555622">profilealloc</span><span class="op" id="1555634">(</span><span class="ident" id="1555635">mp</span>&nbsp;<span class="op" id="1555638">*</span><span class="ident" id="1555639">m</span><span class="op" id="1555640">,</span>&nbsp;<span class="ident" id="1555642">x</span>&nbsp;<span class="ident" id="1555644">unsafe</span><span class="op" id="1555650">.</span><span class="ident" id="1555651">Pointer</span><span class="op" id="1555658">,</span>&nbsp;<span class="ident" id="1555660">size</span>&nbsp;<span class="builtintype" id="1555665">uintptr</span><span class="op" id="1555672">)</span>&nbsp;<span class="op" id="1555674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555677">c</span>&nbsp;<span class="op" id="1555679">:=</span>&nbsp;<span class="ident" id="1555682">mp</span><span class="op" id="1555684">.</span><span class="ident" id="1555685">mcache</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555693">rate</span>&nbsp;<span class="op" id="1555698">:=</span>&nbsp;<span class="ident" id="1555701">MemProfileRate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555717">if</span>&nbsp;<span class="ident" id="1555720">size</span>&nbsp;<span class="op" id="1555725">&lt;</span>&nbsp;<span class="builtintype" id="1555727">uintptr</span><span class="op" id="1555734">(</span><span class="ident" id="1555735">rate</span><span class="op" id="1555739">)</span>&nbsp;<span class="op" id="1555741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555745">//&nbsp;pick&nbsp;next&nbsp;profile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555773">//&nbsp;If&nbsp;you&nbsp;change&nbsp;this,&nbsp;also&nbsp;change&nbsp;allocmcache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1555823">if</span>&nbsp;<span class="ident" id="1555826">rate</span>&nbsp;<span class="op" id="1555831">&gt;</span>&nbsp;<span class="num" id="1555833">0x3fffffff</span>&nbsp;<span class="op" id="1555844">{</span>&nbsp;<span class="comment" id="1555846">//&nbsp;make&nbsp;2*rate&nbsp;not&nbsp;overflow</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555877">rate</span>&nbsp;<span class="op" id="1555882">=</span>&nbsp;<span class="num" id="1555884">0x3fffffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1555897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1555901">next</span>&nbsp;<span class="op" id="1555906">:=</span>&nbsp;<span class="builtintype" id="1555909">int32</span><span class="op" id="1555914">(</span><span class="ident" id="1555915">fastrand1</span><span class="op" id="1555924">(</span><span class="op" id="1555925">)</span><span class="op" id="1555926">)</span>&nbsp;<span class="op" id="1555928">%</span>&nbsp;<span class="op" id="1555930">(</span><span class="num" id="1555931">2</span>&nbsp;<span class="op" id="1555933">*</span>&nbsp;<span class="builtintype" id="1555935">int32</span><span class="op" id="1555940">(</span><span class="ident" id="1555941">rate</span><span class="op" id="1555945">)</span><span class="op" id="1555946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1555950">//&nbsp;Subtract&nbsp;the&nbsp;&#34;remainder&#34;&nbsp;of&nbsp;the&nbsp;current&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1556007">//&nbsp;Otherwise&nbsp;objects&nbsp;that&nbsp;are&nbsp;close&nbsp;in&nbsp;size&nbsp;to&nbsp;sampling&nbsp;rate</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1556070">//&nbsp;will&nbsp;be&nbsp;under-sampled,&nbsp;because&nbsp;we&nbsp;consistently&nbsp;discard&nbsp;this&nbsp;remainder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556146">next</span>&nbsp;<span class="op" id="1556151">-=</span>&nbsp;<span class="op" id="1556154">(</span><span class="builtintype" id="1556155">int32</span><span class="op" id="1556160">(</span><span class="ident" id="1556161">size</span><span class="op" id="1556165">)</span>&nbsp;<span class="op" id="1556167">-</span>&nbsp;<span class="ident" id="1556169">c</span><span class="op" id="1556170">.</span><span class="ident" id="1556171">next_sample</span><span class="op" id="1556182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556186">if</span>&nbsp;<span class="ident" id="1556189">next</span>&nbsp;<span class="op" id="1556194">&lt;</span>&nbsp;<span class="num" id="1556196">0</span>&nbsp;<span class="op" id="1556198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556203">next</span>&nbsp;<span class="op" id="1556208">=</span>&nbsp;<span class="num" id="1556210">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556214">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556218">c</span><span class="op" id="1556219">.</span><span class="ident" id="1556220">next_sample</span>&nbsp;<span class="op" id="1556232">=</span>&nbsp;<span class="ident" id="1556234">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556244">mProf_Malloc</span><span class="op" id="1556256">(</span><span class="ident" id="1556257">x</span><span class="op" id="1556258">,</span>&nbsp;<span class="ident" id="1556260">size</span><span class="op" id="1556264">)</span><br>
<span class="lineno"></span><span class="op" id="1556266">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="1556269">//&nbsp;force&nbsp;=&nbsp;1&nbsp;-&nbsp;do&nbsp;GC&nbsp;regardless&nbsp;of&nbsp;current&nbsp;heap&nbsp;usage</span><br>
<span class="lineno"></span><span class="comment" id="1556323">//&nbsp;force&nbsp;=&nbsp;2&nbsp;-&nbsp;go&nbsp;GC&nbsp;and&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span><span class="keyword" id="1556360">func</span>&nbsp;<span class="ident" id="1556365">gogc</span><span class="op" id="1556369">(</span><span class="ident" id="1556370">force</span>&nbsp;<span class="builtintype" id="1556376">int32</span><span class="op" id="1556381">)</span>&nbsp;<span class="op" id="1556383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1556386">//&nbsp;The&nbsp;gc&nbsp;is&nbsp;turned&nbsp;off&nbsp;(via&nbsp;enablegc)&nbsp;until&nbsp;the&nbsp;bootstrap&nbsp;has&nbsp;completed.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1556461">//&nbsp;Also,&nbsp;malloc&nbsp;gets&nbsp;called&nbsp;in&nbsp;the&nbsp;guts&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;libraries&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1556541">//&nbsp;holding&nbsp;locks.&nbsp;To&nbsp;avoid&nbsp;deadlocks&nbsp;during&nbsp;stoptheworld,&nbsp;don&#39;t&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1556613">//&nbsp;trying&nbsp;to&nbsp;run&nbsp;gc&nbsp;while&nbsp;holding&nbsp;a&nbsp;lock.&nbsp;The&nbsp;next&nbsp;mallocgc&nbsp;without&nbsp;a&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1556689">//&nbsp;will&nbsp;do&nbsp;the&nbsp;gc&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556717">mp</span>&nbsp;<span class="op" id="1556720">:=</span>&nbsp;<span class="ident" id="1556723">acquirem</span><span class="op" id="1556731">(</span><span class="op" id="1556732">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556735">if</span>&nbsp;<span class="ident" id="1556738">gp</span>&nbsp;<span class="op" id="1556741">:=</span>&nbsp;<span class="ident" id="1556744">getg</span><span class="op" id="1556748">(</span><span class="op" id="1556749">)</span><span class="op" id="1556750">;</span>&nbsp;<span class="ident" id="1556752">gp</span>&nbsp;<span class="op" id="1556755">==</span>&nbsp;<span class="ident" id="1556758">mp</span><span class="op" id="1556760">.</span><span class="ident" id="1556761">g0</span>&nbsp;<span class="op" id="1556764">||</span>&nbsp;<span class="ident" id="1556767">mp</span><span class="op" id="1556769">.</span><span class="ident" id="1556770">locks</span>&nbsp;<span class="op" id="1556776">&gt;</span>&nbsp;<span class="num" id="1556778">1</span>&nbsp;<span class="op" id="1556780">||</span>&nbsp;<span class="op" id="1556783">!</span><span class="ident" id="1556784">memstats</span><span class="op" id="1556792">.</span><span class="ident" id="1556793">enablegc</span>&nbsp;<span class="op" id="1556802">||</span>&nbsp;<span class="ident" id="1556805">panicking</span>&nbsp;<span class="op" id="1556815">!=</span>&nbsp;<span class="num" id="1556818">0</span>&nbsp;<span class="op" id="1556820">||</span>&nbsp;<span class="ident" id="1556823">gcpercent</span>&nbsp;<span class="op" id="1556833">&lt;</span>&nbsp;<span class="num" id="1556835">0</span>&nbsp;<span class="op" id="1556837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556841">releasem</span><span class="op" id="1556849">(</span><span class="ident" id="1556850">mp</span><span class="op" id="1556852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556856">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1556864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556867">releasem</span><span class="op" id="1556875">(</span><span class="ident" id="1556876">mp</span><span class="op" id="1556878">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556881">mp</span>&nbsp;<span class="op" id="1556884">=</span>&nbsp;<span class="ident" id="1556886">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1556892">semacquire</span><span class="op" id="1556902">(</span><span class="op" id="1556903">&amp;</span><span class="ident" id="1556904">worldsema</span><span class="op" id="1556913">,</span>&nbsp;<span class="builtintype" id="1556915">false</span><span class="op" id="1556920">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1556924">if</span>&nbsp;<span class="ident" id="1556927">force</span>&nbsp;<span class="op" id="1556933">==</span>&nbsp;<span class="num" id="1556936">0</span>&nbsp;<span class="op" id="1556938">&amp;&amp;</span>&nbsp;<span class="ident" id="1556941">memstats</span><span class="op" id="1556949">.</span><span class="ident" id="1556950">heap_alloc</span>&nbsp;<span class="op" id="1556961">&lt;</span>&nbsp;<span class="ident" id="1556963">memstats</span><span class="op" id="1556971">.</span><span class="ident" id="1556972">next_gc</span>&nbsp;<span class="op" id="1556980">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1556984">//&nbsp;typically&nbsp;threads&nbsp;which&nbsp;lost&nbsp;the&nbsp;race&nbsp;to&nbsp;grab</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1557035">//&nbsp;worldsema&nbsp;exit&nbsp;here&nbsp;when&nbsp;gc&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557077">semrelease</span><span class="op" id="1557087">(</span><span class="op" id="1557088">&amp;</span><span class="ident" id="1557089">worldsema</span><span class="op" id="1557098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557102">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557110">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1557114">//&nbsp;Ok,&nbsp;we&#39;re&nbsp;doing&nbsp;it!&nbsp;&nbsp;Stop&nbsp;everybody&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557159">startTime</span>&nbsp;<span class="op" id="1557169">:=</span>&nbsp;<span class="ident" id="1557172">nanotime</span><span class="op" id="1557180">(</span><span class="op" id="1557181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557184">mp</span>&nbsp;<span class="op" id="1557187">=</span>&nbsp;<span class="ident" id="1557189">acquirem</span><span class="op" id="1557197">(</span><span class="op" id="1557198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557201">mp</span><span class="op" id="1557203">.</span><span class="ident" id="1557204">gcing</span>&nbsp;<span class="op" id="1557210">=</span>&nbsp;<span class="num" id="1557212">1</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557215">releasem</span><span class="op" id="1557223">(</span><span class="ident" id="1557224">mp</span><span class="op" id="1557226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557229">onM</span><span class="op" id="1557232">(</span><span class="ident" id="1557233">stoptheworld</span><span class="op" id="1557245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557248">if</span>&nbsp;<span class="ident" id="1557251">mp</span>&nbsp;<span class="op" id="1557254">!=</span>&nbsp;<span class="ident" id="1557257">acquirem</span><span class="op" id="1557265">(</span><span class="op" id="1557266">)</span>&nbsp;<span class="op" id="1557268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557272">gothrow</span><span class="op" id="1557279">(</span><span class="string" id="1557280">&#34;gogc:&nbsp;rescheduled&#34;</span><span class="op" id="1557299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557302">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557306">clearpools</span><span class="op" id="1557316">(</span><span class="op" id="1557317">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1557321">//&nbsp;Run&nbsp;gc&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;so&nbsp;that&nbsp;the&nbsp;g&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1557381">//&nbsp;we&#39;re&nbsp;currently&nbsp;running&nbsp;on&nbsp;will&nbsp;no&nbsp;longer&nbsp;change.&nbsp;&nbsp;Cuts</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1557441">//&nbsp;the&nbsp;root&nbsp;set&nbsp;down&nbsp;a&nbsp;bit&nbsp;(g0&nbsp;stacks&nbsp;are&nbsp;not&nbsp;scanned,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1557501">//&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;scan&nbsp;gc&#39;s&nbsp;internal&nbsp;state).&nbsp;&nbsp;We&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1557558">//&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;g0&nbsp;so&nbsp;we&nbsp;can&nbsp;shrink&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557611">n</span>&nbsp;<span class="op" id="1557613">:=</span>&nbsp;<span class="num" id="1557616">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557619">if</span>&nbsp;<span class="ident" id="1557622">debug</span><span class="op" id="1557627">.</span><span class="ident" id="1557628">gctrace</span>&nbsp;<span class="op" id="1557636">&gt;</span>&nbsp;<span class="num" id="1557638">1</span>&nbsp;<span class="op" id="1557640">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557644">n</span>&nbsp;<span class="op" id="1557646">=</span>&nbsp;<span class="num" id="1557648">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557654">for</span>&nbsp;<span class="ident" id="1557658">i</span>&nbsp;<span class="op" id="1557660">:=</span>&nbsp;<span class="num" id="1557663">0</span><span class="op" id="1557664">;</span>&nbsp;<span class="ident" id="1557666">i</span>&nbsp;<span class="op" id="1557668">&lt;</span>&nbsp;<span class="ident" id="1557670">n</span><span class="op" id="1557671">;</span>&nbsp;<span class="ident" id="1557673">i</span><span class="op" id="1557674">++</span>&nbsp;<span class="op" id="1557677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557681">if</span>&nbsp;<span class="ident" id="1557684">i</span>&nbsp;<span class="op" id="1557686">&gt;</span>&nbsp;<span class="num" id="1557688">0</span>&nbsp;<span class="op" id="1557690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557695">startTime</span>&nbsp;<span class="op" id="1557705">=</span>&nbsp;<span class="ident" id="1557707">nanotime</span><span class="op" id="1557715">(</span><span class="op" id="1557716">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1557724">//&nbsp;switch&nbsp;to&nbsp;g0,&nbsp;call&nbsp;gc,&nbsp;then&nbsp;switch&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557769">mp</span><span class="op" id="1557771">.</span><span class="ident" id="1557772">scalararg</span><span class="op" id="1557781">[</span><span class="num" id="1557782">0</span><span class="op" id="1557783">]</span>&nbsp;<span class="op" id="1557785">=</span>&nbsp;<span class="builtintype" id="1557787">uintptr</span><span class="op" id="1557794">(</span><span class="builtintype" id="1557795">uint32</span><span class="op" id="1557801">(</span><span class="ident" id="1557802">startTime</span><span class="op" id="1557811">)</span><span class="op" id="1557812">)</span>&nbsp;<span class="comment" id="1557814">//&nbsp;low&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557831">mp</span><span class="op" id="1557833">.</span><span class="ident" id="1557834">scalararg</span><span class="op" id="1557843">[</span><span class="num" id="1557844">1</span><span class="op" id="1557845">]</span>&nbsp;<span class="op" id="1557847">=</span>&nbsp;<span class="builtintype" id="1557849">uintptr</span><span class="op" id="1557856">(</span><span class="ident" id="1557857">startTime</span>&nbsp;<span class="op" id="1557867">&gt;&gt;</span>&nbsp;<span class="num" id="1557870">32</span><span class="op" id="1557872">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1557876">//&nbsp;high&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1557894">if</span>&nbsp;<span class="ident" id="1557897">force</span>&nbsp;<span class="op" id="1557903">&gt;=</span>&nbsp;<span class="num" id="1557906">2</span>&nbsp;<span class="op" id="1557908">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557913">mp</span><span class="op" id="1557915">.</span><span class="ident" id="1557916">scalararg</span><span class="op" id="1557925">[</span><span class="num" id="1557926">2</span><span class="op" id="1557927">]</span>&nbsp;<span class="op" id="1557929">=</span>&nbsp;<span class="num" id="1557931">1</span>&nbsp;<span class="comment" id="1557933">//&nbsp;eagersweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557949">}</span>&nbsp;<span class="keyword" id="1557951">else</span>&nbsp;<span class="op" id="1557956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557961">mp</span><span class="op" id="1557963">.</span><span class="ident" id="1557964">scalararg</span><span class="op" id="1557973">[</span><span class="num" id="1557974">2</span><span class="op" id="1557975">]</span>&nbsp;<span class="op" id="1557977">=</span>&nbsp;<span class="num" id="1557979">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1557987">onM</span><span class="op" id="1557990">(</span><span class="ident" id="1557991">gc_m</span><span class="op" id="1557995">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1557998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1558002">//&nbsp;all&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558015">mp</span><span class="op" id="1558017">.</span><span class="ident" id="1558018">gcing</span>&nbsp;<span class="op" id="1558024">=</span>&nbsp;<span class="num" id="1558026">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558029">semrelease</span><span class="op" id="1558039">(</span><span class="op" id="1558040">&amp;</span><span class="ident" id="1558041">worldsema</span><span class="op" id="1558050">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558053">onM</span><span class="op" id="1558056">(</span><span class="ident" id="1558057">starttheworld</span><span class="op" id="1558070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558073">releasem</span><span class="op" id="1558081">(</span><span class="ident" id="1558082">mp</span><span class="op" id="1558084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558087">mp</span>&nbsp;<span class="op" id="1558090">=</span>&nbsp;<span class="ident" id="1558092">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1558098">//&nbsp;now&nbsp;that&nbsp;gc&nbsp;is&nbsp;done,&nbsp;kick&nbsp;off&nbsp;finalizer&nbsp;thread&nbsp;if&nbsp;needed</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1558159">if</span>&nbsp;<span class="op" id="1558162">!</span><span class="ident" id="1558163">concurrentSweep</span>&nbsp;<span class="op" id="1558179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1558183">//&nbsp;give&nbsp;the&nbsp;queued&nbsp;finalizers,&nbsp;if&nbsp;any,&nbsp;a&nbsp;chance&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558240">Gosched</span><span class="op" id="1558247">(</span><span class="op" id="1558248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1558251">}</span><br>
<span class="lineno"></span><span class="op" id="1558253">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="1558256">//&nbsp;GC&nbsp;runs&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword" id="1558289">func</span>&nbsp;<span class="ident" id="1558294">GC</span><span class="op" id="1558296">(</span><span class="op" id="1558297">)</span>&nbsp;<span class="op" id="1558299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1558302">gogc</span><span class="op" id="1558306">(</span><span class="num" id="1558307">2</span><span class="op" id="1558308">)</span><br>
<span class="lineno"></span><span class="op" id="1558310">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="comment" id="1558313">//&nbsp;linker-provided</span><br>
<span class="lineno"></span><span class="keyword" id="1558332">var</span>&nbsp;<span class="ident" id="1558336">noptrdata</span>&nbsp;<span class="keyword" id="1558346">struct</span><span class="op" id="1558352">{</span><span class="op" id="1558353">}</span><br>
<span class="lineno"></span><span class="keyword" id="1558355">var</span>&nbsp;<span class="ident" id="1558359">enoptrdata</span>&nbsp;<span class="keyword" id="1558370">struct</span><span class="op" id="1558376">{</span><span class="op" id="1558377">}</span><br>
<span class="lineno"></span><span class="keyword" id="1558379">var</span>&nbsp;<span class="ident" id="1558383">noptrbss</span>&nbsp;<span class="keyword" id="1558392">struct</span><span class="op" id="1558398">{</span><span class="op" id="1558399">}</span><br>
<span class="lineno">495</span><span class="keyword" id="1558401">var</span>&nbsp;<span class="ident" id="1558405">enoptrbss</span>&nbsp;<span class="keyword" id="1558415">struct</span><span class="op" id="1558421">{</span><span class="op" id="1558422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1558425">//&nbsp;SetFinalizer&nbsp;sets&nbsp;the&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1558484">//&nbsp;When&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;finds&nbsp;an&nbsp;unreachable&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="1558541">//&nbsp;with&nbsp;an&nbsp;associated&nbsp;finalizer,&nbsp;it&nbsp;clears&nbsp;the&nbsp;association&nbsp;and&nbsp;runs</span><br>
<span class="lineno">500</span><span class="comment" id="1558609">//&nbsp;f(x)&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.&nbsp;&nbsp;This&nbsp;makes&nbsp;x&nbsp;reachable&nbsp;again,&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="1558677">//&nbsp;now&nbsp;without&nbsp;an&nbsp;associated&nbsp;finalizer.&nbsp;&nbsp;Assuming&nbsp;that&nbsp;SetFinalizer</span><br>
<span class="lineno"></span><span class="comment" id="1558745">//&nbsp;is&nbsp;not&nbsp;called&nbsp;again,&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;sees</span><br>
<span class="lineno"></span><span class="comment" id="1558810">//&nbsp;that&nbsp;x&nbsp;is&nbsp;unreachable,&nbsp;it&nbsp;will&nbsp;free&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1558852">//</span><br>
<span class="lineno">505</span><span class="comment" id="1558855">//&nbsp;SetFinalizer(x,&nbsp;nil)&nbsp;clears&nbsp;any&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1558919">//</span><br>
<span class="lineno"></span><span class="comment" id="1558922">//&nbsp;The&nbsp;argument&nbsp;x&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object&nbsp;allocated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1558984">//&nbsp;calling&nbsp;new&nbsp;or&nbsp;by&nbsp;taking&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;composite&nbsp;literal.</span><br>
<span class="lineno"></span><span class="comment" id="1559048">//&nbsp;The&nbsp;argument&nbsp;f&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;single&nbsp;argument</span><br>
<span class="lineno">510</span><span class="comment" id="1559114">//&nbsp;to&nbsp;which&nbsp;x&#39;s&nbsp;type&nbsp;can&nbsp;be&nbsp;assigned,&nbsp;and&nbsp;can&nbsp;have&nbsp;arbitrary&nbsp;ignored&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1559190">//&nbsp;values.&nbsp;If&nbsp;either&nbsp;of&nbsp;these&nbsp;is&nbsp;not&nbsp;true,&nbsp;SetFinalizer&nbsp;aborts&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1559257">//&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1559269">//</span><br>
<span class="lineno"></span><span class="comment" id="1559272">//&nbsp;Finalizers&nbsp;are&nbsp;run&nbsp;in&nbsp;dependency&nbsp;order:&nbsp;if&nbsp;A&nbsp;points&nbsp;at&nbsp;B,&nbsp;both&nbsp;have</span><br>
<span class="lineno">515</span><span class="comment" id="1559343">//&nbsp;finalizers,&nbsp;and&nbsp;they&nbsp;are&nbsp;otherwise&nbsp;unreachable,&nbsp;only&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1559413">//&nbsp;for&nbsp;A&nbsp;runs;&nbsp;once&nbsp;A&nbsp;is&nbsp;freed,&nbsp;the&nbsp;finalizer&nbsp;for&nbsp;B&nbsp;can&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="1559474">//&nbsp;If&nbsp;a&nbsp;cyclic&nbsp;structure&nbsp;includes&nbsp;a&nbsp;block&nbsp;with&nbsp;a&nbsp;finalizer,&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1559539">//&nbsp;cycle&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;and&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1559608">//&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;run,&nbsp;because&nbsp;there&nbsp;is&nbsp;no&nbsp;ordering&nbsp;that</span><br>
<span class="lineno">520</span><span class="comment" id="1559671">//&nbsp;respects&nbsp;the&nbsp;dependencies.</span><br>
<span class="lineno"></span><span class="comment" id="1559701">//</span><br>
<span class="lineno"></span><span class="comment" id="1559704">//&nbsp;The&nbsp;finalizer&nbsp;for&nbsp;x&nbsp;is&nbsp;scheduled&nbsp;to&nbsp;run&nbsp;at&nbsp;some&nbsp;arbitrary&nbsp;time&nbsp;after</span><br>
<span class="lineno"></span><span class="comment" id="1559776">//&nbsp;x&nbsp;becomes&nbsp;unreachable.</span><br>
<span class="lineno"></span><span class="comment" id="1559802">//&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;finalizers&nbsp;will&nbsp;run&nbsp;before&nbsp;a&nbsp;program&nbsp;exits,</span><br>
<span class="lineno">525</span><span class="comment" id="1559876">//&nbsp;so&nbsp;typically&nbsp;they&nbsp;are&nbsp;useful&nbsp;only&nbsp;for&nbsp;releasing&nbsp;non-memory&nbsp;resources</span><br>
<span class="lineno"></span><span class="comment" id="1559948">//&nbsp;associated&nbsp;with&nbsp;an&nbsp;object&nbsp;during&nbsp;a&nbsp;long-running&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1560008">//&nbsp;For&nbsp;example,&nbsp;an&nbsp;os.File&nbsp;object&nbsp;could&nbsp;use&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;close&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1560077">//&nbsp;associated&nbsp;operating&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;when&nbsp;a&nbsp;program&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="1560148">//&nbsp;an&nbsp;os.File&nbsp;without&nbsp;calling&nbsp;Close,&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;mistake</span><br>
<span class="lineno">530</span><span class="comment" id="1560211">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;flush&nbsp;an&nbsp;in-memory&nbsp;I/O&nbsp;buffer&nbsp;such&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1560282">//&nbsp;bufio.Writer,&nbsp;because&nbsp;the&nbsp;buffer&nbsp;would&nbsp;not&nbsp;be&nbsp;flushed&nbsp;at&nbsp;program&nbsp;exit.</span><br>
<span class="lineno"></span><span class="comment" id="1560356">//</span><br>
<span class="lineno"></span><span class="comment" id="1560359">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;*x&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1560430">//&nbsp;zero&nbsp;bytes.</span><br>
<span class="lineno">535</span><span class="comment" id="1560445">//</span><br>
<span class="lineno"></span><span class="comment" id="1560448">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;for&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1560520">//&nbsp;in&nbsp;initializers&nbsp;for&nbsp;package-level&nbsp;variables.&nbsp;Such&nbsp;objects&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1560588">//&nbsp;linker-allocated,&nbsp;not&nbsp;heap-allocated.</span><br>
<span class="lineno"></span><span class="comment" id="1560629">//</span><br>
<span class="lineno">540</span><span class="comment" id="1560632">//&nbsp;A&nbsp;single&nbsp;goroutine&nbsp;runs&nbsp;all&nbsp;finalizers&nbsp;for&nbsp;a&nbsp;program,&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="comment" id="1560703">//&nbsp;If&nbsp;a&nbsp;finalizer&nbsp;must&nbsp;run&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;should&nbsp;do&nbsp;so&nbsp;by&nbsp;starting</span><br>
<span class="lineno"></span><span class="comment" id="1560775">//&nbsp;a&nbsp;new&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1560795">func</span>&nbsp;<span class="ident" id="1560800">SetFinalizer</span><span class="op" id="1560812">(</span><span class="ident" id="1560813">obj</span>&nbsp;<span class="keyword" id="1560817">interface</span><span class="op" id="1560826">{</span><span class="op" id="1560827">}</span><span class="op" id="1560828">,</span>&nbsp;<span class="ident" id="1560830">finalizer</span>&nbsp;<span class="keyword" id="1560840">interface</span><span class="op" id="1560849">{</span><span class="op" id="1560850">}</span><span class="op" id="1560851">)</span>&nbsp;<span class="op" id="1560853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560856">e</span>&nbsp;<span class="op" id="1560858">:=</span>&nbsp;<span class="op" id="1560861">(</span><span class="op" id="1560862">*</span><span class="ident" id="1560863">eface</span><span class="op" id="1560868">)</span><span class="op" id="1560869">(</span><span class="ident" id="1560870">unsafe</span><span class="op" id="1560876">.</span><span class="ident" id="1560877">Pointer</span><span class="op" id="1560884">(</span><span class="op" id="1560885">&amp;</span><span class="ident" id="1560886">obj</span><span class="op" id="1560889">)</span><span class="op" id="1560890">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560893">etyp</span>&nbsp;<span class="op" id="1560898">:=</span>&nbsp;<span class="ident" id="1560901">e</span><span class="op" id="1560902">.</span><span class="ident" id="1560903">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1560910">if</span>&nbsp;<span class="ident" id="1560913">etyp</span>&nbsp;<span class="op" id="1560918">==</span>&nbsp;<span class="ident" id="1560921">nil</span>&nbsp;<span class="op" id="1560925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1560929">gothrow</span><span class="op" id="1560936">(</span><span class="string" id="1560937">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;nil&#34;</span><span class="op" id="1560982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1560985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1560988">if</span>&nbsp;<span class="ident" id="1560991">etyp</span><span class="op" id="1560995">.</span><span class="ident" id="1560996">kind</span><span class="op" id="1561000">&amp;</span><span class="ident" id="1561001">kindMask</span>&nbsp;<span class="op" id="1561010">!=</span>&nbsp;<span class="ident" id="1561013">kindPtr</span>&nbsp;<span class="op" id="1561021">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561025">gothrow</span><span class="op" id="1561032">(</span><span class="string" id="1561033">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1561076">+</span>&nbsp;<span class="op" id="1561078">*</span><span class="ident" id="1561079">etyp</span><span class="op" id="1561083">.</span><span class="ident" id="1561084">_string</span>&nbsp;<span class="op" id="1561092">+</span>&nbsp;<span class="string" id="1561094">&#34;,&nbsp;not&nbsp;pointer&#34;</span><span class="op" id="1561109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1561112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561115">ot</span>&nbsp;<span class="op" id="1561118">:=</span>&nbsp;<span class="op" id="1561121">(</span><span class="op" id="1561122">*</span><span class="ident" id="1561123">ptrtype</span><span class="op" id="1561130">)</span><span class="op" id="1561131">(</span><span class="ident" id="1561132">unsafe</span><span class="op" id="1561138">.</span><span class="ident" id="1561139">Pointer</span><span class="op" id="1561146">(</span><span class="ident" id="1561147">etyp</span><span class="op" id="1561151">)</span><span class="op" id="1561152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1561155">if</span>&nbsp;<span class="ident" id="1561158">ot</span><span class="op" id="1561160">.</span><span class="ident" id="1561161">elem</span>&nbsp;<span class="op" id="1561166">==</span>&nbsp;<span class="ident" id="1561169">nil</span>&nbsp;<span class="op" id="1561173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561177">gothrow</span><span class="op" id="1561184">(</span><span class="string" id="1561185">&#34;nil&nbsp;elem&nbsp;type!&#34;</span><span class="op" id="1561201">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1561204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561208">//&nbsp;find&nbsp;the&nbsp;containing&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1561239">_</span><span class="op" id="1561240">,</span>&nbsp;<span class="ident" id="1561242">base</span><span class="op" id="1561246">,</span>&nbsp;<span class="ident" id="1561248">_</span>&nbsp;<span class="op" id="1561250">:=</span>&nbsp;<span class="ident" id="1561253">findObject</span><span class="op" id="1561263">(</span><span class="ident" id="1561264">e</span><span class="op" id="1561265">.</span><span class="ident" id="1561266">data</span><span class="op" id="1561270">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1561274">if</span>&nbsp;<span class="ident" id="1561277">base</span>&nbsp;<span class="op" id="1561282">==</span>&nbsp;<span class="ident" id="1561285">nil</span>&nbsp;<span class="op" id="1561289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561293">//&nbsp;0-length&nbsp;objects&nbsp;are&nbsp;okay.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1561325">if</span>&nbsp;<span class="ident" id="1561328">e</span><span class="op" id="1561329">.</span><span class="ident" id="1561330">data</span>&nbsp;<span class="op" id="1561335">==</span>&nbsp;<span class="ident" id="1561338">unsafe</span><span class="op" id="1561344">.</span><span class="ident" id="1561345">Pointer</span><span class="op" id="1561352">(</span><span class="op" id="1561353">&amp;</span><span class="ident" id="1561354">zerobase</span><span class="op" id="1561362">)</span>&nbsp;<span class="op" id="1561364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1561369">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1561378">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561383">//&nbsp;Global&nbsp;initializers&nbsp;might&nbsp;be&nbsp;linker-allocated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561435">//&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;Foo&nbsp;=&nbsp;&amp;Object{}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561460">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561479">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspruntime.SetFinalizer(Foo,&nbsp;nil)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561516">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561523">//&nbsp;The&nbsp;relevant&nbsp;segments&nbsp;are:&nbsp;noptrdata,&nbsp;data,&nbsp;bss,&nbsp;noptrbss.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561587">//&nbsp;We&nbsp;cannot&nbsp;assume&nbsp;they&nbsp;are&nbsp;in&nbsp;any&nbsp;order&nbsp;or&nbsp;even&nbsp;contiguous,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1561651">//&nbsp;due&nbsp;to&nbsp;external&nbsp;linking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1561681">if</span>&nbsp;<span class="builtintype" id="1561684">uintptr</span><span class="op" id="1561691">(</span><span class="ident" id="1561692">unsafe</span><span class="op" id="1561698">.</span><span class="ident" id="1561699">Pointer</span><span class="op" id="1561706">(</span><span class="op" id="1561707">&amp;</span><span class="ident" id="1561708">noptrdata</span><span class="op" id="1561717">)</span><span class="op" id="1561718">)</span>&nbsp;<span class="op" id="1561720">&lt;=</span>&nbsp;<span class="builtintype" id="1561723">uintptr</span><span class="op" id="1561730">(</span><span class="ident" id="1561731">e</span><span class="op" id="1561732">.</span><span class="ident" id="1561733">data</span><span class="op" id="1561737">)</span>&nbsp;<span class="op" id="1561739">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1561742">uintptr</span><span class="op" id="1561749">(</span><span class="ident" id="1561750">e</span><span class="op" id="1561751">.</span><span class="ident" id="1561752">data</span><span class="op" id="1561756">)</span>&nbsp;<span class="op" id="1561758">&lt;</span>&nbsp;<span class="builtintype" id="1561760">uintptr</span><span class="op" id="1561767">(</span><span class="ident" id="1561768">unsafe</span><span class="op" id="1561774">.</span><span class="ident" id="1561775">Pointer</span><span class="op" id="1561782">(</span><span class="op" id="1561783">&amp;</span><span class="ident" id="1561784">enoptrdata</span><span class="op" id="1561794">)</span><span class="op" id="1561795">)</span>&nbsp;<span class="op" id="1561797">||</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1561803">uintptr</span><span class="op" id="1561810">(</span><span class="ident" id="1561811">unsafe</span><span class="op" id="1561817">.</span><span class="ident" id="1561818">Pointer</span><span class="op" id="1561825">(</span><span class="op" id="1561826">&amp;</span><span class="ident" id="1561827">data</span><span class="op" id="1561831">)</span><span class="op" id="1561832">)</span>&nbsp;<span class="op" id="1561834">&lt;=</span>&nbsp;<span class="builtintype" id="1561837">uintptr</span><span class="op" id="1561844">(</span><span class="ident" id="1561845">e</span><span class="op" id="1561846">.</span><span class="ident" id="1561847">data</span><span class="op" id="1561851">)</span>&nbsp;<span class="op" id="1561853">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1561856">uintptr</span><span class="op" id="1561863">(</span><span class="ident" id="1561864">e</span><span class="op" id="1561865">.</span><span class="ident" id="1561866">data</span><span class="op" id="1561870">)</span>&nbsp;<span class="op" id="1561872">&lt;</span>&nbsp;<span class="builtintype" id="1561874">uintptr</span><span class="op" id="1561881">(</span><span class="ident" id="1561882">unsafe</span><span class="op" id="1561888">.</span><span class="ident" id="1561889">Pointer</span><span class="op" id="1561896">(</span><span class="op" id="1561897">&amp;</span><span class="ident" id="1561898">edata</span><span class="op" id="1561903">)</span><span class="op" id="1561904">)</span>&nbsp;<span class="op" id="1561906">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1561912">uintptr</span><span class="op" id="1561919">(</span><span class="ident" id="1561920">unsafe</span><span class="op" id="1561926">.</span><span class="ident" id="1561927">Pointer</span><span class="op" id="1561934">(</span><span class="op" id="1561935">&amp;</span><span class="ident" id="1561936">bss</span><span class="op" id="1561939">)</span><span class="op" id="1561940">)</span>&nbsp;<span class="op" id="1561942">&lt;=</span>&nbsp;<span class="builtintype" id="1561945">uintptr</span><span class="op" id="1561952">(</span><span class="ident" id="1561953">e</span><span class="op" id="1561954">.</span><span class="ident" id="1561955">data</span><span class="op" id="1561959">)</span>&nbsp;<span class="op" id="1561961">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1561964">uintptr</span><span class="op" id="1561971">(</span><span class="ident" id="1561972">e</span><span class="op" id="1561973">.</span><span class="ident" id="1561974">data</span><span class="op" id="1561978">)</span>&nbsp;<span class="op" id="1561980">&lt;</span>&nbsp;<span class="builtintype" id="1561982">uintptr</span><span class="op" id="1561989">(</span><span class="ident" id="1561990">unsafe</span><span class="op" id="1561996">.</span><span class="ident" id="1561997">Pointer</span><span class="op" id="1562004">(</span><span class="op" id="1562005">&amp;</span><span class="ident" id="1562006">ebss</span><span class="op" id="1562010">)</span><span class="op" id="1562011">)</span>&nbsp;<span class="op" id="1562013">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1562019">uintptr</span><span class="op" id="1562026">(</span><span class="ident" id="1562027">unsafe</span><span class="op" id="1562033">.</span><span class="ident" id="1562034">Pointer</span><span class="op" id="1562041">(</span><span class="op" id="1562042">&amp;</span><span class="ident" id="1562043">noptrbss</span><span class="op" id="1562051">)</span><span class="op" id="1562052">)</span>&nbsp;<span class="op" id="1562054">&lt;=</span>&nbsp;<span class="builtintype" id="1562057">uintptr</span><span class="op" id="1562064">(</span><span class="ident" id="1562065">e</span><span class="op" id="1562066">.</span><span class="ident" id="1562067">data</span><span class="op" id="1562071">)</span>&nbsp;<span class="op" id="1562073">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1562076">uintptr</span><span class="op" id="1562083">(</span><span class="ident" id="1562084">e</span><span class="op" id="1562085">.</span><span class="ident" id="1562086">data</span><span class="op" id="1562090">)</span>&nbsp;<span class="op" id="1562092">&lt;</span>&nbsp;<span class="builtintype" id="1562094">uintptr</span><span class="op" id="1562101">(</span><span class="ident" id="1562102">unsafe</span><span class="op" id="1562108">.</span><span class="ident" id="1562109">Pointer</span><span class="op" id="1562116">(</span><span class="op" id="1562117">&amp;</span><span class="ident" id="1562118">enoptrbss</span><span class="op" id="1562127">)</span><span class="op" id="1562128">)</span>&nbsp;<span class="op" id="1562130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562135">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562144">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562148">gothrow</span><span class="op" id="1562155">(</span><span class="string" id="1562156">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;in&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1562210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562217">if</span>&nbsp;<span class="ident" id="1562220">e</span><span class="op" id="1562221">.</span><span class="ident" id="1562222">data</span>&nbsp;<span class="op" id="1562227">!=</span>&nbsp;<span class="ident" id="1562230">base</span>&nbsp;<span class="op" id="1562235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1562239">//&nbsp;As&nbsp;an&nbsp;implementation&nbsp;detail&nbsp;we&nbsp;allow&nbsp;to&nbsp;set&nbsp;finalizers&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1562317">//&nbsp;of&nbsp;an&nbsp;object&nbsp;if&nbsp;it&nbsp;could&nbsp;come&nbsp;from&nbsp;tiny&nbsp;alloc&nbsp;(see&nbsp;mallocgc&nbsp;for&nbsp;details).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562396">if</span>&nbsp;<span class="ident" id="1562399">ot</span><span class="op" id="1562401">.</span><span class="ident" id="1562402">elem</span>&nbsp;<span class="op" id="1562407">==</span>&nbsp;<span class="ident" id="1562410">nil</span>&nbsp;<span class="op" id="1562414">||</span>&nbsp;<span class="ident" id="1562417">ot</span><span class="op" id="1562419">.</span><span class="ident" id="1562420">elem</span><span class="op" id="1562424">.</span><span class="ident" id="1562425">kind</span><span class="op" id="1562429">&amp;</span><span class="ident" id="1562430">kindNoPointers</span>&nbsp;<span class="op" id="1562445">==</span>&nbsp;<span class="num" id="1562448">0</span>&nbsp;<span class="op" id="1562450">||</span>&nbsp;<span class="ident" id="1562453">ot</span><span class="op" id="1562455">.</span><span class="ident" id="1562456">elem</span><span class="op" id="1562460">.</span><span class="ident" id="1562461">size</span>&nbsp;<span class="op" id="1562466">&gt;=</span>&nbsp;<span class="ident" id="1562469">maxTinySize</span>&nbsp;<span class="op" id="1562481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562486">gothrow</span><span class="op" id="1562493">(</span><span class="string" id="1562494">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;at&nbsp;beginning&nbsp;of&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1562561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562568">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562572">f</span>&nbsp;<span class="op" id="1562574">:=</span>&nbsp;<span class="op" id="1562577">(</span><span class="op" id="1562578">*</span><span class="ident" id="1562579">eface</span><span class="op" id="1562584">)</span><span class="op" id="1562585">(</span><span class="ident" id="1562586">unsafe</span><span class="op" id="1562592">.</span><span class="ident" id="1562593">Pointer</span><span class="op" id="1562600">(</span><span class="op" id="1562601">&amp;</span><span class="ident" id="1562602">finalizer</span><span class="op" id="1562611">)</span><span class="op" id="1562612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562615">ftyp</span>&nbsp;<span class="op" id="1562620">:=</span>&nbsp;<span class="ident" id="1562623">f</span><span class="op" id="1562624">.</span><span class="ident" id="1562625">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562632">if</span>&nbsp;<span class="ident" id="1562635">ftyp</span>&nbsp;<span class="op" id="1562640">==</span>&nbsp;<span class="ident" id="1562643">nil</span>&nbsp;<span class="op" id="1562647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1562651">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;and&nbsp;remove&nbsp;finalizer</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562695">mp</span>&nbsp;<span class="op" id="1562698">:=</span>&nbsp;<span class="ident" id="1562701">acquirem</span><span class="op" id="1562709">(</span><span class="op" id="1562710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562714">mp</span><span class="op" id="1562716">.</span><span class="ident" id="1562717">ptrarg</span><span class="op" id="1562723">[</span><span class="num" id="1562724">0</span><span class="op" id="1562725">]</span>&nbsp;<span class="op" id="1562727">=</span>&nbsp;<span class="ident" id="1562729">e</span><span class="op" id="1562730">.</span><span class="ident" id="1562731">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562738">onM</span><span class="op" id="1562741">(</span><span class="ident" id="1562742">removeFinalizer_m</span><span class="op" id="1562759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562763">releasem</span><span class="op" id="1562771">(</span><span class="ident" id="1562772">mp</span><span class="op" id="1562774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562778">return</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1562790">if</span>&nbsp;<span class="ident" id="1562793">ftyp</span><span class="op" id="1562797">.</span><span class="ident" id="1562798">kind</span><span class="op" id="1562802">&amp;</span><span class="ident" id="1562803">kindMask</span>&nbsp;<span class="op" id="1562812">!=</span>&nbsp;<span class="ident" id="1562815">kindFunc</span>&nbsp;<span class="op" id="1562824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562828">gothrow</span><span class="op" id="1562835">(</span><span class="string" id="1562836">&#34;runtime.SetFinalizer:&nbsp;second&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1562880">+</span>&nbsp;<span class="op" id="1562882">*</span><span class="ident" id="1562883">ftyp</span><span class="op" id="1562887">.</span><span class="ident" id="1562888">_string</span>&nbsp;<span class="op" id="1562896">+</span>&nbsp;<span class="string" id="1562898">&#34;,&nbsp;not&nbsp;a&nbsp;function&#34;</span><span class="op" id="1562916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1562919">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562922">ft</span>&nbsp;<span class="op" id="1562925">:=</span>&nbsp;<span class="op" id="1562928">(</span><span class="op" id="1562929">*</span><span class="ident" id="1562930">functype</span><span class="op" id="1562938">)</span><span class="op" id="1562939">(</span><span class="ident" id="1562940">unsafe</span><span class="op" id="1562946">.</span><span class="ident" id="1562947">Pointer</span><span class="op" id="1562954">(</span><span class="ident" id="1562955">ftyp</span><span class="op" id="1562959">)</span><span class="op" id="1562960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1562963">ins</span>&nbsp;<span class="op" id="1562967">:=</span>&nbsp;<span class="op" id="1562970">*</span><span class="op" id="1562971">(</span><span class="op" id="1562972">*</span><span class="op" id="1562973">[</span><span class="op" id="1562974">]</span><span class="op" id="1562975">*</span><span class="ident" id="1562976">_type</span><span class="op" id="1562981">)</span><span class="op" id="1562982">(</span><span class="ident" id="1562983">unsafe</span><span class="op" id="1562989">.</span><span class="ident" id="1562990">Pointer</span><span class="op" id="1562997">(</span><span class="op" id="1562998">&amp;</span><span class="ident" id="1562999">ft</span><span class="op" id="1563001">.</span><span class="ident" id="1563002">in</span><span class="op" id="1563004">)</span><span class="op" id="1563005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563008">if</span>&nbsp;<span class="ident" id="1563011">ft</span><span class="op" id="1563013">.</span><span class="ident" id="1563014">dotdotdot</span>&nbsp;<span class="op" id="1563024">||</span>&nbsp;<span class="builtinfunc" id="1563027">len</span><span class="op" id="1563030">(</span><span class="ident" id="1563031">ins</span><span class="op" id="1563034">)</span>&nbsp;<span class="op" id="1563036">!=</span>&nbsp;<span class="num" id="1563039">1</span>&nbsp;<span class="op" id="1563041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563045">gothrow</span><span class="op" id="1563052">(</span><span class="string" id="1563053">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1563090">+</span>&nbsp;<span class="op" id="1563092">*</span><span class="ident" id="1563093">etyp</span><span class="op" id="1563097">.</span><span class="ident" id="1563098">_string</span>&nbsp;<span class="op" id="1563106">+</span>&nbsp;<span class="string" id="1563108">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1563125">+</span>&nbsp;<span class="op" id="1563127">*</span><span class="ident" id="1563128">ftyp</span><span class="op" id="1563132">.</span><span class="ident" id="1563133">_string</span><span class="op" id="1563140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563143">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563146">fint</span>&nbsp;<span class="op" id="1563151">:=</span>&nbsp;<span class="ident" id="1563154">ins</span><span class="op" id="1563157">[</span><span class="num" id="1563158">0</span><span class="op" id="1563159">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563162">switch</span>&nbsp;<span class="op" id="1563169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563172">case</span>&nbsp;<span class="ident" id="1563177">fint</span>&nbsp;<span class="op" id="1563182">==</span>&nbsp;<span class="ident" id="1563185">etyp</span><span class="op" id="1563189">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563193">//&nbsp;ok&nbsp;-&nbsp;same&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563213">goto</span>&nbsp;<span class="ident" id="1563218">okarg</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563225">case</span>&nbsp;<span class="ident" id="1563230">fint</span><span class="op" id="1563234">.</span><span class="ident" id="1563235">kind</span><span class="op" id="1563239">&amp;</span><span class="ident" id="1563240">kindMask</span>&nbsp;<span class="op" id="1563249">==</span>&nbsp;<span class="ident" id="1563252">kindPtr</span><span class="op" id="1563259">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563263">if</span>&nbsp;<span class="op" id="1563266">(</span><span class="ident" id="1563267">fint</span><span class="op" id="1563271">.</span><span class="ident" id="1563272">x</span>&nbsp;<span class="op" id="1563274">==</span>&nbsp;<span class="ident" id="1563277">nil</span>&nbsp;<span class="op" id="1563281">||</span>&nbsp;<span class="ident" id="1563284">fint</span><span class="op" id="1563288">.</span><span class="ident" id="1563289">x</span><span class="op" id="1563290">.</span><span class="ident" id="1563291">name</span>&nbsp;<span class="op" id="1563296">==</span>&nbsp;<span class="ident" id="1563299">nil</span>&nbsp;<span class="op" id="1563303">||</span>&nbsp;<span class="ident" id="1563306">etyp</span><span class="op" id="1563310">.</span><span class="ident" id="1563311">x</span>&nbsp;<span class="op" id="1563313">==</span>&nbsp;<span class="ident" id="1563316">nil</span>&nbsp;<span class="op" id="1563320">||</span>&nbsp;<span class="ident" id="1563323">etyp</span><span class="op" id="1563327">.</span><span class="ident" id="1563328">x</span><span class="op" id="1563329">.</span><span class="ident" id="1563330">name</span>&nbsp;<span class="op" id="1563335">==</span>&nbsp;<span class="ident" id="1563338">nil</span><span class="op" id="1563341">)</span>&nbsp;<span class="op" id="1563343">&amp;&amp;</span>&nbsp;<span class="op" id="1563346">(</span><span class="op" id="1563347">*</span><span class="ident" id="1563348">ptrtype</span><span class="op" id="1563355">)</span><span class="op" id="1563356">(</span><span class="ident" id="1563357">unsafe</span><span class="op" id="1563363">.</span><span class="ident" id="1563364">Pointer</span><span class="op" id="1563371">(</span><span class="ident" id="1563372">fint</span><span class="op" id="1563376">)</span><span class="op" id="1563377">)</span><span class="op" id="1563378">.</span><span class="ident" id="1563379">elem</span>&nbsp;<span class="op" id="1563384">==</span>&nbsp;<span class="ident" id="1563387">ot</span><span class="op" id="1563389">.</span><span class="ident" id="1563390">elem</span>&nbsp;<span class="op" id="1563395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563400">//&nbsp;ok&nbsp;-&nbsp;not&nbsp;same&nbsp;type,&nbsp;but&nbsp;both&nbsp;pointers,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563445">//&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;is&nbsp;unnamed,&nbsp;and&nbsp;same&nbsp;element&nbsp;type,&nbsp;so&nbsp;assignable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563518">goto</span>&nbsp;<span class="ident" id="1563523">okarg</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563534">case</span>&nbsp;<span class="ident" id="1563539">fint</span><span class="op" id="1563543">.</span><span class="ident" id="1563544">kind</span><span class="op" id="1563548">&amp;</span><span class="ident" id="1563549">kindMask</span>&nbsp;<span class="op" id="1563558">==</span>&nbsp;<span class="ident" id="1563561">kindInterface</span><span class="op" id="1563574">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563578">ityp</span>&nbsp;<span class="op" id="1563583">:=</span>&nbsp;<span class="op" id="1563586">(</span><span class="op" id="1563587">*</span><span class="ident" id="1563588">interfacetype</span><span class="op" id="1563601">)</span><span class="op" id="1563602">(</span><span class="ident" id="1563603">unsafe</span><span class="op" id="1563609">.</span><span class="ident" id="1563610">Pointer</span><span class="op" id="1563617">(</span><span class="ident" id="1563618">fint</span><span class="op" id="1563622">)</span><span class="op" id="1563623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563627">if</span>&nbsp;<span class="builtinfunc" id="1563630">len</span><span class="op" id="1563633">(</span><span class="ident" id="1563634">ityp</span><span class="op" id="1563638">.</span><span class="ident" id="1563639">mhdr</span><span class="op" id="1563643">)</span>&nbsp;<span class="op" id="1563645">==</span>&nbsp;<span class="num" id="1563648">0</span>&nbsp;<span class="op" id="1563650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563655">//&nbsp;ok&nbsp;-&nbsp;satisfies&nbsp;empty&nbsp;interface</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563692">goto</span>&nbsp;<span class="ident" id="1563697">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563709">if</span>&nbsp;<span class="ident" id="1563712">_</span><span class="op" id="1563713">,</span>&nbsp;<span class="ident" id="1563715">ok</span>&nbsp;<span class="op" id="1563718">:=</span>&nbsp;<span class="ident" id="1563721">assertE2I2</span><span class="op" id="1563731">(</span><span class="ident" id="1563732">ityp</span><span class="op" id="1563736">,</span>&nbsp;<span class="ident" id="1563738">obj</span><span class="op" id="1563741">)</span><span class="op" id="1563742">;</span>&nbsp;<span class="ident" id="1563744">ok</span>&nbsp;<span class="op" id="1563747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563752">goto</span>&nbsp;<span class="ident" id="1563757">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563765">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1563768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563771">gothrow</span><span class="op" id="1563778">(</span><span class="string" id="1563779">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1563816">+</span>&nbsp;<span class="op" id="1563818">*</span><span class="ident" id="1563819">etyp</span><span class="op" id="1563823">.</span><span class="ident" id="1563824">_string</span>&nbsp;<span class="op" id="1563832">+</span>&nbsp;<span class="string" id="1563834">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1563851">+</span>&nbsp;<span class="op" id="1563853">*</span><span class="ident" id="1563854">ftyp</span><span class="op" id="1563858">.</span><span class="ident" id="1563859">_string</span><span class="op" id="1563866">)</span><br>
<span class="lineno"></span><span class="ident" id="1563868">okarg</span><span class="op" id="1563873">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1563876">//&nbsp;compute&nbsp;size&nbsp;needed&nbsp;for&nbsp;return&nbsp;parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1563922">nret</span>&nbsp;<span class="op" id="1563927">:=</span>&nbsp;<span class="builtintype" id="1563930">uintptr</span><span class="op" id="1563937">(</span><span class="num" id="1563938">0</span><span class="op" id="1563939">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1563942">for</span>&nbsp;<span class="ident" id="1563946">_</span><span class="op" id="1563947">,</span>&nbsp;<span class="ident" id="1563949">t</span>&nbsp;<span class="op" id="1563951">:=</span>&nbsp;<span class="keyword" id="1563954">range</span>&nbsp;<span class="op" id="1563960">*</span><span class="op" id="1563961">(</span><span class="op" id="1563962">*</span><span class="op" id="1563963">[</span><span class="op" id="1563964">]</span><span class="op" id="1563965">*</span><span class="ident" id="1563966">_type</span><span class="op" id="1563971">)</span><span class="op" id="1563972">(</span><span class="ident" id="1563973">unsafe</span><span class="op" id="1563979">.</span><span class="ident" id="1563980">Pointer</span><span class="op" id="1563987">(</span><span class="op" id="1563988">&amp;</span><span class="ident" id="1563989">ft</span><span class="op" id="1563991">.</span><span class="ident" id="1563992">out</span><span class="op" id="1563995">)</span><span class="op" id="1563996">)</span>&nbsp;<span class="op" id="1563998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564002">nret</span>&nbsp;<span class="op" id="1564007">=</span>&nbsp;<span class="ident" id="1564009">round</span><span class="op" id="1564014">(</span><span class="ident" id="1564015">nret</span><span class="op" id="1564019">,</span>&nbsp;<span class="builtintype" id="1564021">uintptr</span><span class="op" id="1564028">(</span><span class="ident" id="1564029">t</span><span class="op" id="1564030">.</span><span class="ident" id="1564031">align</span><span class="op" id="1564036">)</span><span class="op" id="1564037">)</span>&nbsp;<span class="op" id="1564039">+</span>&nbsp;<span class="builtintype" id="1564041">uintptr</span><span class="op" id="1564048">(</span><span class="ident" id="1564049">t</span><span class="op" id="1564050">.</span><span class="ident" id="1564051">size</span><span class="op" id="1564055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1564058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564061">nret</span>&nbsp;<span class="op" id="1564066">=</span>&nbsp;<span class="ident" id="1564068">round</span><span class="op" id="1564073">(</span><span class="ident" id="1564074">nret</span><span class="op" id="1564078">,</span>&nbsp;<span class="ident" id="1564080">ptrSize</span><span class="op" id="1564087">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1564091">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;have&nbsp;a&nbsp;finalizer&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564135">createfing</span><span class="op" id="1564145">(</span><span class="op" id="1564146">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1564150">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;to&nbsp;add&nbsp;finalizer&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564196">mp</span>&nbsp;<span class="op" id="1564199">:=</span>&nbsp;<span class="ident" id="1564202">acquirem</span><span class="op" id="1564210">(</span><span class="op" id="1564211">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564214">mp</span><span class="op" id="1564216">.</span><span class="ident" id="1564217">ptrarg</span><span class="op" id="1564223">[</span><span class="num" id="1564224">0</span><span class="op" id="1564225">]</span>&nbsp;<span class="op" id="1564227">=</span>&nbsp;<span class="ident" id="1564229">f</span><span class="op" id="1564230">.</span><span class="ident" id="1564231">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564237">mp</span><span class="op" id="1564239">.</span><span class="ident" id="1564240">ptrarg</span><span class="op" id="1564246">[</span><span class="num" id="1564247">1</span><span class="op" id="1564248">]</span>&nbsp;<span class="op" id="1564250">=</span>&nbsp;<span class="ident" id="1564252">e</span><span class="op" id="1564253">.</span><span class="ident" id="1564254">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564260">mp</span><span class="op" id="1564262">.</span><span class="ident" id="1564263">scalararg</span><span class="op" id="1564272">[</span><span class="num" id="1564273">0</span><span class="op" id="1564274">]</span>&nbsp;<span class="op" id="1564276">=</span>&nbsp;<span class="ident" id="1564278">nret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564284">mp</span><span class="op" id="1564286">.</span><span class="ident" id="1564287">ptrarg</span><span class="op" id="1564293">[</span><span class="num" id="1564294">2</span><span class="op" id="1564295">]</span>&nbsp;<span class="op" id="1564297">=</span>&nbsp;<span class="ident" id="1564299">unsafe</span><span class="op" id="1564305">.</span><span class="ident" id="1564306">Pointer</span><span class="op" id="1564313">(</span><span class="ident" id="1564314">fint</span><span class="op" id="1564318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564321">mp</span><span class="op" id="1564323">.</span><span class="ident" id="1564324">ptrarg</span><span class="op" id="1564330">[</span><span class="num" id="1564331">3</span><span class="op" id="1564332">]</span>&nbsp;<span class="op" id="1564334">=</span>&nbsp;<span class="ident" id="1564336">unsafe</span><span class="op" id="1564342">.</span><span class="ident" id="1564343">Pointer</span><span class="op" id="1564350">(</span><span class="ident" id="1564351">ot</span><span class="op" id="1564353">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564356">onM</span><span class="op" id="1564359">(</span><span class="ident" id="1564360">setFinalizer_m</span><span class="op" id="1564374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1564377">if</span>&nbsp;<span class="ident" id="1564380">mp</span><span class="op" id="1564382">.</span><span class="ident" id="1564383">scalararg</span><span class="op" id="1564392">[</span><span class="num" id="1564393">0</span><span class="op" id="1564394">]</span>&nbsp;<span class="op" id="1564396">!=</span>&nbsp;<span class="num" id="1564399">1</span>&nbsp;<span class="op" id="1564401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564405">gothrow</span><span class="op" id="1564412">(</span><span class="string" id="1564413">&#34;runtime.SetFinalizer:&nbsp;finalizer&nbsp;already&nbsp;set&#34;</span><span class="op" id="1564458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1564461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564464">releasem</span><span class="op" id="1564472">(</span><span class="ident" id="1564473">mp</span><span class="op" id="1564475">)</span><br>
<span class="lineno">655</span><span class="op" id="1564477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1564480">//&nbsp;round&nbsp;n&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;a.&nbsp;&nbsp;a&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;of&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="1564539">func</span>&nbsp;<span class="ident" id="1564544">round</span><span class="op" id="1564549">(</span><span class="ident" id="1564550">n</span><span class="op" id="1564551">,</span>&nbsp;<span class="ident" id="1564553">a</span>&nbsp;<span class="builtintype" id="1564555">uintptr</span><span class="op" id="1564562">)</span>&nbsp;<span class="builtintype" id="1564564">uintptr</span>&nbsp;<span class="op" id="1564572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1564575">return</span>&nbsp;<span class="op" id="1564582">(</span><span class="ident" id="1564583">n</span>&nbsp;<span class="op" id="1564585">+</span>&nbsp;<span class="ident" id="1564587">a</span>&nbsp;<span class="op" id="1564589">-</span>&nbsp;<span class="num" id="1564591">1</span><span class="op" id="1564592">)</span>&nbsp;<span class="op" id="1564594">&amp;^</span>&nbsp;<span class="op" id="1564597">(</span><span class="ident" id="1564598">a</span>&nbsp;<span class="op" id="1564600">-</span>&nbsp;<span class="num" id="1564602">1</span><span class="op" id="1564603">)</span><br>
<span class="lineno">660</span><span class="op" id="1564605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1564608">//&nbsp;Look&nbsp;up&nbsp;pointer&nbsp;v&nbsp;in&nbsp;heap.&nbsp;&nbsp;Return&nbsp;the&nbsp;span&nbsp;containing&nbsp;the&nbsp;object,</span><br>
<span class="lineno"></span><span class="comment" id="1564678">//&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;object,&nbsp;and&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;If&nbsp;the&nbsp;object</span><br>
<span class="lineno"></span><span class="comment" id="1564749">//&nbsp;does&nbsp;not&nbsp;exist,&nbsp;return&nbsp;nil,&nbsp;nil,&nbsp;0.</span><br>
<span class="lineno">665</span><span class="keyword" id="1564788">func</span>&nbsp;<span class="ident" id="1564793">findObject</span><span class="op" id="1564803">(</span><span class="ident" id="1564804">v</span>&nbsp;<span class="ident" id="1564806">unsafe</span><span class="op" id="1564812">.</span><span class="ident" id="1564813">Pointer</span><span class="op" id="1564820">)</span>&nbsp;<span class="op" id="1564822">(</span><span class="ident" id="1564823">s</span>&nbsp;<span class="op" id="1564825">*</span><span class="ident" id="1564826">mspan</span><span class="op" id="1564831">,</span>&nbsp;<span class="ident" id="1564833">x</span>&nbsp;<span class="ident" id="1564835">unsafe</span><span class="op" id="1564841">.</span><span class="ident" id="1564842">Pointer</span><span class="op" id="1564849">,</span>&nbsp;<span class="ident" id="1564851">n</span>&nbsp;<span class="builtintype" id="1564853">uintptr</span><span class="op" id="1564860">)</span>&nbsp;<span class="op" id="1564862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564865">c</span>&nbsp;<span class="op" id="1564867">:=</span>&nbsp;<span class="ident" id="1564870">gomcache</span><span class="op" id="1564878">(</span><span class="op" id="1564879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564882">c</span><span class="op" id="1564883">.</span><span class="ident" id="1564884">local_nlookup</span><span class="op" id="1564897">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1564901">if</span>&nbsp;<span class="ident" id="1564904">ptrSize</span>&nbsp;<span class="op" id="1564912">==</span>&nbsp;<span class="num" id="1564915">4</span>&nbsp;<span class="op" id="1564917">&amp;&amp;</span>&nbsp;<span class="ident" id="1564920">c</span><span class="op" id="1564921">.</span><span class="ident" id="1564922">local_nlookup</span>&nbsp;<span class="op" id="1564936">&gt;=</span>&nbsp;<span class="num" id="1564939">1</span><span class="op" id="1564940">&lt;&lt;</span><span class="num" id="1564942">30</span>&nbsp;<span class="op" id="1564945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1564949">//&nbsp;purge&nbsp;cache&nbsp;stats&nbsp;to&nbsp;prevent&nbsp;overflow</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1564992">lock</span><span class="op" id="1564996">(</span><span class="op" id="1564997">&amp;</span><span class="ident" id="1564998">mheap_</span><span class="op" id="1565004">.</span><span class="ident" id="1565005">lock</span><span class="op" id="1565009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565013">purgecachedstats</span><span class="op" id="1565029">(</span><span class="ident" id="1565030">c</span><span class="op" id="1565031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565035">unlock</span><span class="op" id="1565041">(</span><span class="op" id="1565042">&amp;</span><span class="ident" id="1565043">mheap_</span><span class="op" id="1565049">.</span><span class="ident" id="1565050">lock</span><span class="op" id="1565054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1565061">//&nbsp;find&nbsp;span</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565075">arena_start</span>&nbsp;<span class="op" id="1565087">:=</span>&nbsp;<span class="builtintype" id="1565090">uintptr</span><span class="op" id="1565097">(</span><span class="ident" id="1565098">unsafe</span><span class="op" id="1565104">.</span><span class="ident" id="1565105">Pointer</span><span class="op" id="1565112">(</span><span class="ident" id="1565113">mheap_</span><span class="op" id="1565119">.</span><span class="ident" id="1565120">arena_start</span><span class="op" id="1565131">)</span><span class="op" id="1565132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565135">arena_used</span>&nbsp;<span class="op" id="1565146">:=</span>&nbsp;<span class="builtintype" id="1565149">uintptr</span><span class="op" id="1565156">(</span><span class="ident" id="1565157">unsafe</span><span class="op" id="1565163">.</span><span class="ident" id="1565164">Pointer</span><span class="op" id="1565171">(</span><span class="ident" id="1565172">mheap_</span><span class="op" id="1565178">.</span><span class="ident" id="1565179">arena_used</span><span class="op" id="1565189">)</span><span class="op" id="1565190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565193">if</span>&nbsp;<span class="builtintype" id="1565196">uintptr</span><span class="op" id="1565203">(</span><span class="ident" id="1565204">v</span><span class="op" id="1565205">)</span>&nbsp;<span class="op" id="1565207">&lt;</span>&nbsp;<span class="ident" id="1565209">arena_start</span>&nbsp;<span class="op" id="1565221">||</span>&nbsp;<span class="builtintype" id="1565224">uintptr</span><span class="op" id="1565231">(</span><span class="ident" id="1565232">v</span><span class="op" id="1565233">)</span>&nbsp;<span class="op" id="1565235">&gt;=</span>&nbsp;<span class="ident" id="1565238">arena_used</span>&nbsp;<span class="op" id="1565249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565253">return</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565264">p</span>&nbsp;<span class="op" id="1565266">:=</span>&nbsp;<span class="builtintype" id="1565269">uintptr</span><span class="op" id="1565276">(</span><span class="ident" id="1565277">v</span><span class="op" id="1565278">)</span>&nbsp;<span class="op" id="1565280">&gt;&gt;</span>&nbsp;<span class="ident" id="1565283">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565294">q</span>&nbsp;<span class="op" id="1565296">:=</span>&nbsp;<span class="ident" id="1565299">p</span>&nbsp;<span class="op" id="1565301">-</span>&nbsp;<span class="ident" id="1565303">arena_start</span><span class="op" id="1565314">&gt;&gt;</span><span class="ident" id="1565316">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565327">s</span>&nbsp;<span class="op" id="1565329">=</span>&nbsp;<span class="op" id="1565331">*</span><span class="op" id="1565332">(</span><span class="op" id="1565333">*</span><span class="op" id="1565334">*</span><span class="ident" id="1565335">mspan</span><span class="op" id="1565340">)</span><span class="op" id="1565341">(</span><span class="ident" id="1565342">add</span><span class="op" id="1565345">(</span><span class="ident" id="1565346">unsafe</span><span class="op" id="1565352">.</span><span class="ident" id="1565353">Pointer</span><span class="op" id="1565360">(</span><span class="ident" id="1565361">mheap_</span><span class="op" id="1565367">.</span><span class="ident" id="1565368">spans</span><span class="op" id="1565373">)</span><span class="op" id="1565374">,</span>&nbsp;<span class="ident" id="1565376">q</span><span class="op" id="1565377">*</span><span class="ident" id="1565378">ptrSize</span><span class="op" id="1565385">)</span><span class="op" id="1565386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565389">if</span>&nbsp;<span class="ident" id="1565392">s</span>&nbsp;<span class="op" id="1565394">==</span>&nbsp;<span class="ident" id="1565397">nil</span>&nbsp;<span class="op" id="1565401">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565405">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565416">x</span>&nbsp;<span class="op" id="1565418">=</span>&nbsp;<span class="ident" id="1565420">unsafe</span><span class="op" id="1565426">.</span><span class="ident" id="1565427">Pointer</span><span class="op" id="1565434">(</span><span class="builtintype" id="1565435">uintptr</span><span class="op" id="1565442">(</span><span class="ident" id="1565443">s</span><span class="op" id="1565444">.</span><span class="ident" id="1565445">start</span><span class="op" id="1565450">)</span>&nbsp;<span class="op" id="1565452">&lt;&lt;</span>&nbsp;<span class="ident" id="1565455">pageShift</span><span class="op" id="1565464">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565468">if</span>&nbsp;<span class="builtintype" id="1565471">uintptr</span><span class="op" id="1565478">(</span><span class="ident" id="1565479">v</span><span class="op" id="1565480">)</span>&nbsp;<span class="op" id="1565482">&lt;</span>&nbsp;<span class="builtintype" id="1565484">uintptr</span><span class="op" id="1565491">(</span><span class="ident" id="1565492">x</span><span class="op" id="1565493">)</span>&nbsp;<span class="op" id="1565495">||</span>&nbsp;<span class="builtintype" id="1565498">uintptr</span><span class="op" id="1565505">(</span><span class="ident" id="1565506">v</span><span class="op" id="1565507">)</span>&nbsp;<span class="op" id="1565509">&gt;=</span>&nbsp;<span class="builtintype" id="1565512">uintptr</span><span class="op" id="1565519">(</span><span class="ident" id="1565520">unsafe</span><span class="op" id="1565526">.</span><span class="ident" id="1565527">Pointer</span><span class="op" id="1565534">(</span><span class="ident" id="1565535">s</span><span class="op" id="1565536">.</span><span class="ident" id="1565537">limit</span><span class="op" id="1565542">)</span><span class="op" id="1565543">)</span>&nbsp;<span class="op" id="1565545">||</span>&nbsp;<span class="ident" id="1565548">s</span><span class="op" id="1565549">.</span><span class="ident" id="1565550">state</span>&nbsp;<span class="op" id="1565556">!=</span>&nbsp;<span class="ident" id="1565559">mSpanInUse</span>&nbsp;<span class="op" id="1565570">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565574">s</span>&nbsp;<span class="op" id="1565576">=</span>&nbsp;<span class="ident" id="1565578">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565584">x</span>&nbsp;<span class="op" id="1565586">=</span>&nbsp;<span class="ident" id="1565588">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565594">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565606">n</span>&nbsp;<span class="op" id="1565608">=</span>&nbsp;<span class="builtintype" id="1565610">uintptr</span><span class="op" id="1565617">(</span><span class="ident" id="1565618">s</span><span class="op" id="1565619">.</span><span class="ident" id="1565620">elemsize</span><span class="op" id="1565628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565631">if</span>&nbsp;<span class="ident" id="1565634">s</span><span class="op" id="1565635">.</span><span class="ident" id="1565636">sizeclass</span>&nbsp;<span class="op" id="1565646">!=</span>&nbsp;<span class="num" id="1565649">0</span>&nbsp;<span class="op" id="1565651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565655">x</span>&nbsp;<span class="op" id="1565657">=</span>&nbsp;<span class="ident" id="1565659">add</span><span class="op" id="1565662">(</span><span class="ident" id="1565663">x</span><span class="op" id="1565664">,</span>&nbsp;<span class="op" id="1565666">(</span><span class="builtintype" id="1565667">uintptr</span><span class="op" id="1565674">(</span><span class="ident" id="1565675">v</span><span class="op" id="1565676">)</span><span class="op" id="1565677">-</span><span class="builtintype" id="1565678">uintptr</span><span class="op" id="1565685">(</span><span class="ident" id="1565686">x</span><span class="op" id="1565687">)</span><span class="op" id="1565688">)</span><span class="op" id="1565689">/</span><span class="ident" id="1565690">n</span><span class="op" id="1565691">*</span><span class="ident" id="1565692">n</span><span class="op" id="1565693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565699">return</span><br>
<span class="lineno">700</span><span class="op" id="1565706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1565709">var</span>&nbsp;<span class="ident" id="1565713">fingCreate</span>&nbsp;<span class="builtintype" id="1565724">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1565732">func</span>&nbsp;<span class="ident" id="1565737">createfing</span><span class="op" id="1565747">(</span><span class="op" id="1565748">)</span>&nbsp;<span class="op" id="1565750">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1565753">//&nbsp;start&nbsp;the&nbsp;finalizer&nbsp;goroutine&nbsp;exactly&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565800">if</span>&nbsp;<span class="ident" id="1565803">fingCreate</span>&nbsp;<span class="op" id="1565814">==</span>&nbsp;<span class="num" id="1565817">0</span>&nbsp;<span class="op" id="1565819">&amp;&amp;</span>&nbsp;<span class="ident" id="1565822">cas</span><span class="op" id="1565825">(</span><span class="op" id="1565826">&amp;</span><span class="ident" id="1565827">fingCreate</span><span class="op" id="1565837">,</span>&nbsp;<span class="num" id="1565839">0</span><span class="op" id="1565840">,</span>&nbsp;<span class="num" id="1565842">1</span><span class="op" id="1565843">)</span>&nbsp;<span class="op" id="1565845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565849">go</span>&nbsp;<span class="ident" id="1565852">runfinq</span><span class="op" id="1565859">(</span><span class="op" id="1565860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565863">}</span><br>
<span class="lineno"></span><span class="op" id="1565865">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1565868">//&nbsp;This&nbsp;is&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;runs&nbsp;all&nbsp;of&nbsp;the&nbsp;finalizers</span><br>
<span class="lineno"></span><span class="keyword" id="1565925">func</span>&nbsp;<span class="ident" id="1565930">runfinq</span><span class="op" id="1565937">(</span><span class="op" id="1565938">)</span>&nbsp;<span class="op" id="1565940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565943">var</span>&nbsp;<span class="op" id="1565947">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565951">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1565960">unsafe</span><span class="op" id="1565966">.</span><span class="ident" id="1565967">Pointer</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1565977">framecap</span>&nbsp;<span class="builtintype" id="1565986">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1565995">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1565999">for</span>&nbsp;<span class="op" id="1566003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566007">lock</span><span class="op" id="1566011">(</span><span class="op" id="1566012">&amp;</span><span class="ident" id="1566013">finlock</span><span class="op" id="1566020">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566024">fb</span>&nbsp;<span class="op" id="1566027">:=</span>&nbsp;<span class="ident" id="1566030">finq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566037">finq</span>&nbsp;<span class="op" id="1566042">=</span>&nbsp;<span class="ident" id="1566044">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566050">if</span>&nbsp;<span class="ident" id="1566053">fb</span>&nbsp;<span class="op" id="1566056">==</span>&nbsp;<span class="ident" id="1566059">nil</span>&nbsp;<span class="op" id="1566063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566068">gp</span>&nbsp;<span class="op" id="1566071">:=</span>&nbsp;<span class="ident" id="1566074">getg</span><span class="op" id="1566078">(</span><span class="op" id="1566079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566084">fing</span>&nbsp;<span class="op" id="1566089">=</span>&nbsp;<span class="ident" id="1566091">gp</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566097">fingwait</span>&nbsp;<span class="op" id="1566106">=</span>&nbsp;<span class="builtintype" id="1566108">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566116">gp</span><span class="op" id="1566118">.</span><span class="ident" id="1566119">issystem</span>&nbsp;<span class="op" id="1566128">=</span>&nbsp;<span class="builtintype" id="1566130">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566138">goparkunlock</span><span class="op" id="1566150">(</span><span class="op" id="1566151">&amp;</span><span class="ident" id="1566152">finlock</span><span class="op" id="1566159">,</span>&nbsp;<span class="string" id="1566161">&#34;finalizer&nbsp;wait&#34;</span><span class="op" id="1566177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566182">gp</span><span class="op" id="1566184">.</span><span class="ident" id="1566185">issystem</span>&nbsp;<span class="op" id="1566194">=</span>&nbsp;<span class="builtintype" id="1566196">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566205">continue</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566220">unlock</span><span class="op" id="1566226">(</span><span class="op" id="1566227">&amp;</span><span class="ident" id="1566228">finlock</span><span class="op" id="1566235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566239">if</span>&nbsp;<span class="ident" id="1566242">raceenabled</span>&nbsp;<span class="op" id="1566254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566259">racefingo</span><span class="op" id="1566268">(</span><span class="op" id="1566269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566273">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566277">for</span>&nbsp;<span class="ident" id="1566281">fb</span>&nbsp;<span class="op" id="1566284">!=</span>&nbsp;<span class="ident" id="1566287">nil</span>&nbsp;<span class="op" id="1566291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566296">for</span>&nbsp;<span class="ident" id="1566300">i</span>&nbsp;<span class="op" id="1566302">:=</span>&nbsp;<span class="builtintype" id="1566305">int32</span><span class="op" id="1566310">(</span><span class="num" id="1566311">0</span><span class="op" id="1566312">)</span><span class="op" id="1566313">;</span>&nbsp;<span class="ident" id="1566315">i</span>&nbsp;<span class="op" id="1566317">&lt;</span>&nbsp;<span class="ident" id="1566319">fb</span><span class="op" id="1566321">.</span><span class="ident" id="1566322">cnt</span><span class="op" id="1566325">;</span>&nbsp;<span class="ident" id="1566327">i</span><span class="op" id="1566328">++</span>&nbsp;<span class="op" id="1566331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566337">f</span>&nbsp;<span class="op" id="1566339">:=</span>&nbsp;<span class="op" id="1566342">(</span><span class="op" id="1566343">*</span><span class="ident" id="1566344">finalizer</span><span class="op" id="1566353">)</span><span class="op" id="1566354">(</span><span class="ident" id="1566355">add</span><span class="op" id="1566358">(</span><span class="ident" id="1566359">unsafe</span><span class="op" id="1566365">.</span><span class="ident" id="1566366">Pointer</span><span class="op" id="1566373">(</span><span class="op" id="1566374">&amp;</span><span class="ident" id="1566375">fb</span><span class="op" id="1566377">.</span><span class="ident" id="1566378">fin</span><span class="op" id="1566381">)</span><span class="op" id="1566382">,</span>&nbsp;<span class="builtintype" id="1566384">uintptr</span><span class="op" id="1566391">(</span><span class="ident" id="1566392">i</span><span class="op" id="1566393">)</span><span class="op" id="1566394">*</span><span class="ident" id="1566395">unsafe</span><span class="op" id="1566401">.</span><span class="ident" id="1566402">Sizeof</span><span class="op" id="1566408">(</span><span class="ident" id="1566409">finalizer</span><span class="op" id="1566418">{</span><span class="op" id="1566419">}</span><span class="op" id="1566420">)</span><span class="op" id="1566421">)</span><span class="op" id="1566422">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566429">framesz</span>&nbsp;<span class="op" id="1566437">:=</span>&nbsp;<span class="ident" id="1566440">unsafe</span><span class="op" id="1566446">.</span><span class="ident" id="1566447">Sizeof</span><span class="op" id="1566453">(</span><span class="op" id="1566454">(</span><span class="keyword" id="1566455">interface</span><span class="op" id="1566464">{</span><span class="op" id="1566465">}</span><span class="op" id="1566466">)</span><span class="op" id="1566467">(</span><span class="ident" id="1566468">nil</span><span class="op" id="1566471">)</span><span class="op" id="1566472">)</span>&nbsp;<span class="op" id="1566474">+</span>&nbsp;<span class="builtintype" id="1566476">uintptr</span><span class="op" id="1566483">(</span><span class="ident" id="1566484">f</span><span class="op" id="1566485">.</span><span class="ident" id="1566486">nret</span><span class="op" id="1566490">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566496">if</span>&nbsp;<span class="ident" id="1566499">framecap</span>&nbsp;<span class="op" id="1566508">&lt;</span>&nbsp;<span class="ident" id="1566510">framesz</span>&nbsp;<span class="op" id="1566518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1566525">//&nbsp;The&nbsp;frame&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1566589">//&nbsp;all&nbsp;not&nbsp;yet&nbsp;finalized&nbsp;objects&nbsp;are&nbsp;stored&nbsp;in&nbsp;finq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1566647">//&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;mark&nbsp;it&nbsp;as&nbsp;FlagNoScan,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1566691">//&nbsp;the&nbsp;last&nbsp;finalized&nbsp;object&nbsp;is&nbsp;not&nbsp;collected.</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566743">frame</span>&nbsp;<span class="op" id="1566749">=</span>&nbsp;<span class="ident" id="1566751">mallocgc</span><span class="op" id="1566759">(</span><span class="ident" id="1566760">framesz</span><span class="op" id="1566767">,</span>&nbsp;<span class="ident" id="1566769">nil</span><span class="op" id="1566772">,</span>&nbsp;<span class="ident" id="1566774">flagNoScan</span><span class="op" id="1566784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566791">framecap</span>&nbsp;<span class="op" id="1566800">=</span>&nbsp;<span class="ident" id="1566802">framesz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566821">if</span>&nbsp;<span class="ident" id="1566824">f</span><span class="op" id="1566825">.</span><span class="ident" id="1566826">fint</span>&nbsp;<span class="op" id="1566831">==</span>&nbsp;<span class="ident" id="1566834">nil</span>&nbsp;<span class="op" id="1566838">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1566845">gothrow</span><span class="op" id="1566852">(</span><span class="string" id="1566853">&#34;missing&nbsp;type&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1566878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566890">switch</span>&nbsp;<span class="ident" id="1566897">f</span><span class="op" id="1566898">.</span><span class="ident" id="1566899">fint</span><span class="op" id="1566903">.</span><span class="ident" id="1566904">kind</span>&nbsp;<span class="op" id="1566909">&amp;</span>&nbsp;<span class="ident" id="1566911">kindMask</span>&nbsp;<span class="op" id="1566920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1566926">case</span>&nbsp;<span class="ident" id="1566931">kindPtr</span><span class="op" id="1566938">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1566945">//&nbsp;direct&nbsp;use&nbsp;of&nbsp;pointer</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1566975">*</span><span class="op" id="1566976">(</span><span class="op" id="1566977">*</span><span class="ident" id="1566978">unsafe</span><span class="op" id="1566984">.</span><span class="ident" id="1566985">Pointer</span><span class="op" id="1566992">)</span><span class="op" id="1566993">(</span><span class="ident" id="1566994">frame</span><span class="op" id="1566999">)</span>&nbsp;<span class="op" id="1567001">=</span>&nbsp;<span class="ident" id="1567003">f</span><span class="op" id="1567004">.</span><span class="ident" id="1567005">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567013">case</span>&nbsp;<span class="ident" id="1567018">kindInterface</span><span class="op" id="1567031">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567038">ityp</span>&nbsp;<span class="op" id="1567043">:=</span>&nbsp;<span class="op" id="1567046">(</span><span class="op" id="1567047">*</span><span class="ident" id="1567048">interfacetype</span><span class="op" id="1567061">)</span><span class="op" id="1567062">(</span><span class="ident" id="1567063">unsafe</span><span class="op" id="1567069">.</span><span class="ident" id="1567070">Pointer</span><span class="op" id="1567077">(</span><span class="ident" id="1567078">f</span><span class="op" id="1567079">.</span><span class="ident" id="1567080">fint</span><span class="op" id="1567084">)</span><span class="op" id="1567085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1567092">//&nbsp;set&nbsp;up&nbsp;with&nbsp;empty&nbsp;interface</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567128">(</span><span class="op" id="1567129">*</span><span class="ident" id="1567130">eface</span><span class="op" id="1567135">)</span><span class="op" id="1567136">(</span><span class="ident" id="1567137">frame</span><span class="op" id="1567142">)</span><span class="op" id="1567143">.</span><span class="ident" id="1567144">_type</span>&nbsp;<span class="op" id="1567150">=</span>&nbsp;<span class="op" id="1567152">&amp;</span><span class="ident" id="1567153">f</span><span class="op" id="1567154">.</span><span class="ident" id="1567155">ot</span><span class="op" id="1567157">.</span><span class="ident" id="1567158">typ</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567167">(</span><span class="op" id="1567168">*</span><span class="ident" id="1567169">eface</span><span class="op" id="1567174">)</span><span class="op" id="1567175">(</span><span class="ident" id="1567176">frame</span><span class="op" id="1567181">)</span><span class="op" id="1567182">.</span><span class="ident" id="1567183">data</span>&nbsp;<span class="op" id="1567188">=</span>&nbsp;<span class="ident" id="1567190">f</span><span class="op" id="1567191">.</span><span class="ident" id="1567192">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567201">if</span>&nbsp;<span class="builtinfunc" id="1567204">len</span><span class="op" id="1567207">(</span><span class="ident" id="1567208">ityp</span><span class="op" id="1567212">.</span><span class="ident" id="1567213">mhdr</span><span class="op" id="1567217">)</span>&nbsp;<span class="op" id="1567219">!=</span>&nbsp;<span class="num" id="1567222">0</span>&nbsp;<span class="op" id="1567224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1567232">//&nbsp;convert&nbsp;to&nbsp;interface&nbsp;with&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1567275">//&nbsp;this&nbsp;conversion&nbsp;is&nbsp;guaranteed&nbsp;to&nbsp;succeed&nbsp;-&nbsp;we&nbsp;checked&nbsp;in&nbsp;SetFinalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567354">*</span><span class="op" id="1567355">(</span><span class="op" id="1567356">*</span><span class="ident" id="1567357">fInterface</span><span class="op" id="1567367">)</span><span class="op" id="1567368">(</span><span class="ident" id="1567369">frame</span><span class="op" id="1567374">)</span>&nbsp;<span class="op" id="1567376">=</span>&nbsp;<span class="ident" id="1567378">assertE2I</span><span class="op" id="1567387">(</span><span class="ident" id="1567388">ityp</span><span class="op" id="1567392">,</span>&nbsp;<span class="op" id="1567394">*</span><span class="op" id="1567395">(</span><span class="op" id="1567396">*</span><span class="keyword" id="1567397">interface</span><span class="op" id="1567406">{</span><span class="op" id="1567407">}</span><span class="op" id="1567408">)</span><span class="op" id="1567409">(</span><span class="ident" id="1567410">frame</span><span class="op" id="1567415">)</span><span class="op" id="1567416">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1567429">default</span><span class="op" id="1567436">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567443">gothrow</span><span class="op" id="1567450">(</span><span class="string" id="1567451">&#34;bad&nbsp;kind&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1567472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567484">reflectcall</span><span class="op" id="1567495">(</span><span class="ident" id="1567496">unsafe</span><span class="op" id="1567502">.</span><span class="ident" id="1567503">Pointer</span><span class="op" id="1567510">(</span><span class="ident" id="1567511">f</span><span class="op" id="1567512">.</span><span class="ident" id="1567513">fn</span><span class="op" id="1567515">)</span><span class="op" id="1567516">,</span>&nbsp;<span class="ident" id="1567518">frame</span><span class="op" id="1567523">,</span>&nbsp;<span class="builtintype" id="1567525">uint32</span><span class="op" id="1567531">(</span><span class="ident" id="1567532">framesz</span><span class="op" id="1567539">)</span><span class="op" id="1567540">,</span>&nbsp;<span class="builtintype" id="1567542">uint32</span><span class="op" id="1567548">(</span><span class="ident" id="1567549">framesz</span><span class="op" id="1567556">)</span><span class="op" id="1567557">)</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1567564">//&nbsp;drop&nbsp;finalizer&nbsp;queue&nbsp;references&nbsp;to&nbsp;finalized&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567623">f</span><span class="op" id="1567624">.</span><span class="ident" id="1567625">fn</span>&nbsp;<span class="op" id="1567628">=</span>&nbsp;<span class="ident" id="1567630">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567638">f</span><span class="op" id="1567639">.</span><span class="ident" id="1567640">arg</span>&nbsp;<span class="op" id="1567644">=</span>&nbsp;<span class="ident" id="1567646">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567654">f</span><span class="op" id="1567655">.</span><span class="ident" id="1567656">ot</span>&nbsp;<span class="op" id="1567659">=</span>&nbsp;<span class="ident" id="1567661">nil</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567673">fb</span><span class="op" id="1567675">.</span><span class="ident" id="1567676">cnt</span>&nbsp;<span class="op" id="1567680">=</span>&nbsp;<span class="num" id="1567682">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567687">next</span>&nbsp;<span class="op" id="1567692">:=</span>&nbsp;<span class="ident" id="1567695">fb</span><span class="op" id="1567697">.</span><span class="ident" id="1567698">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567706">lock</span><span class="op" id="1567710">(</span><span class="op" id="1567711">&amp;</span><span class="ident" id="1567712">finlock</span><span class="op" id="1567719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567724">fb</span><span class="op" id="1567726">.</span><span class="ident" id="1567727">next</span>&nbsp;<span class="op" id="1567732">=</span>&nbsp;<span class="ident" id="1567734">finc</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567742">finc</span>&nbsp;<span class="op" id="1567747">=</span>&nbsp;<span class="ident" id="1567749">fb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567755">unlock</span><span class="op" id="1567761">(</span><span class="op" id="1567762">&amp;</span><span class="ident" id="1567763">finlock</span><span class="op" id="1567770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567775">fb</span>&nbsp;<span class="op" id="1567778">=</span>&nbsp;<span class="ident" id="1567780">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1567790">}</span><br>
<span class="lineno">785</span><span class="op" id="1567792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1567795">var</span>&nbsp;<span class="ident" id="1567799">persistent</span>&nbsp;<span class="keyword" id="1567810">struct</span>&nbsp;<span class="op" id="1567817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567820">lock</span>&nbsp;<span class="ident" id="1567825">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567832">pos</span>&nbsp;&nbsp;<span class="ident" id="1567837">unsafe</span><span class="op" id="1567843">.</span><span class="ident" id="1567844">Pointer</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1567853">end</span>&nbsp;&nbsp;<span class="ident" id="1567858">unsafe</span><span class="op" id="1567864">.</span><span class="ident" id="1567865">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1567873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1567876">//&nbsp;Wrapper&nbsp;around&nbsp;sysAlloc&nbsp;that&nbsp;can&nbsp;allocate&nbsp;small&nbsp;chunks.</span><br>
<span class="lineno"></span><span class="comment" id="1567935">//&nbsp;There&nbsp;is&nbsp;no&nbsp;associated&nbsp;free&nbsp;operation.</span><br>
<span class="lineno">795</span><span class="comment" id="1567977">//&nbsp;Intended&nbsp;for&nbsp;things&nbsp;like&nbsp;function/type/debug-related&nbsp;persistent&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1568050">//&nbsp;If&nbsp;align&nbsp;is&nbsp;0,&nbsp;uses&nbsp;default&nbsp;align&nbsp;(currently&nbsp;8).</span><br>
<span class="lineno"></span><span class="keyword" id="1568102">func</span>&nbsp;<span class="ident" id="1568107">persistentalloc</span><span class="op" id="1568122">(</span><span class="ident" id="1568123">size</span><span class="op" id="1568127">,</span>&nbsp;<span class="ident" id="1568129">align</span>&nbsp;<span class="builtintype" id="1568135">uintptr</span><span class="op" id="1568142">,</span>&nbsp;<span class="ident" id="1568144">stat</span>&nbsp;<span class="op" id="1568149">*</span><span class="ident" id="1568150">uint64</span><span class="op" id="1568156">)</span>&nbsp;<span class="ident" id="1568158">unsafe</span><span class="op" id="1568164">.</span><span class="ident" id="1568165">Pointer</span>&nbsp;<span class="op" id="1568173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568176">const</span>&nbsp;<span class="op" id="1568182">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568186">chunk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1568195">=</span>&nbsp;<span class="num" id="1568197">256</span>&nbsp;<span class="op" id="1568201">&lt;&lt;</span>&nbsp;<span class="num" id="1568204">10</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568209">maxBlock</span>&nbsp;<span class="op" id="1568218">=</span>&nbsp;<span class="num" id="1568220">64</span>&nbsp;<span class="op" id="1568223">&lt;&lt;</span>&nbsp;<span class="num" id="1568226">10</span>&nbsp;<span class="comment" id="1568229">//&nbsp;VM&nbsp;reservation&nbsp;granularity&nbsp;is&nbsp;64K&nbsp;on&nbsp;windows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568278">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568282">if</span>&nbsp;<span class="ident" id="1568285">align</span>&nbsp;<span class="op" id="1568291">!=</span>&nbsp;<span class="num" id="1568294">0</span>&nbsp;<span class="op" id="1568296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568300">if</span>&nbsp;<span class="ident" id="1568303">align</span><span class="op" id="1568308">&amp;</span><span class="op" id="1568309">(</span><span class="ident" id="1568310">align</span><span class="op" id="1568315">-</span><span class="num" id="1568316">1</span><span class="op" id="1568317">)</span>&nbsp;<span class="op" id="1568319">!=</span>&nbsp;<span class="num" id="1568322">0</span>&nbsp;<span class="op" id="1568324">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568329">gothrow</span><span class="op" id="1568336">(</span><span class="string" id="1568337">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;not&nbsp;a&nbsp;power&nbsp;of&nbsp;2&#34;</span><span class="op" id="1568381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568389">if</span>&nbsp;<span class="ident" id="1568392">align</span>&nbsp;<span class="op" id="1568398">&gt;</span>&nbsp;<span class="ident" id="1568400">_PageSize</span>&nbsp;<span class="op" id="1568410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568415">gothrow</span><span class="op" id="1568422">(</span><span class="string" id="1568423">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;too&nbsp;large&#34;</span><span class="op" id="1568460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568464">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568467">}</span>&nbsp;<span class="keyword" id="1568469">else</span>&nbsp;<span class="op" id="1568474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568478">align</span>&nbsp;<span class="op" id="1568484">=</span>&nbsp;<span class="num" id="1568486">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568493">if</span>&nbsp;<span class="ident" id="1568496">size</span>&nbsp;<span class="op" id="1568501">&gt;=</span>&nbsp;<span class="ident" id="1568504">maxBlock</span>&nbsp;<span class="op" id="1568513">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568517">return</span>&nbsp;<span class="ident" id="1568524">sysAlloc</span><span class="op" id="1568532">(</span><span class="ident" id="1568533">size</span><span class="op" id="1568537">,</span>&nbsp;<span class="ident" id="1568539">stat</span><span class="op" id="1568543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568550">lock</span><span class="op" id="1568554">(</span><span class="op" id="1568555">&amp;</span><span class="ident" id="1568556">persistent</span><span class="op" id="1568566">.</span><span class="ident" id="1568567">lock</span><span class="op" id="1568571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568574">persistent</span><span class="op" id="1568584">.</span><span class="ident" id="1568585">pos</span>&nbsp;<span class="op" id="1568589">=</span>&nbsp;<span class="ident" id="1568591">roundup</span><span class="op" id="1568598">(</span><span class="ident" id="1568599">persistent</span><span class="op" id="1568609">.</span><span class="ident" id="1568610">pos</span><span class="op" id="1568613">,</span>&nbsp;<span class="ident" id="1568615">align</span><span class="op" id="1568620">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568623">if</span>&nbsp;<span class="builtintype" id="1568626">uintptr</span><span class="op" id="1568633">(</span><span class="ident" id="1568634">persistent</span><span class="op" id="1568644">.</span><span class="ident" id="1568645">pos</span><span class="op" id="1568648">)</span><span class="op" id="1568649">+</span><span class="ident" id="1568650">size</span>&nbsp;<span class="op" id="1568655">&gt;</span>&nbsp;<span class="builtintype" id="1568657">uintptr</span><span class="op" id="1568664">(</span><span class="ident" id="1568665">persistent</span><span class="op" id="1568675">.</span><span class="ident" id="1568676">end</span><span class="op" id="1568679">)</span>&nbsp;<span class="op" id="1568681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568685">persistent</span><span class="op" id="1568695">.</span><span class="ident" id="1568696">pos</span>&nbsp;<span class="op" id="1568700">=</span>&nbsp;<span class="ident" id="1568702">sysAlloc</span><span class="op" id="1568710">(</span><span class="ident" id="1568711">chunk</span><span class="op" id="1568716">,</span>&nbsp;<span class="op" id="1568718">&amp;</span><span class="ident" id="1568719">memstats</span><span class="op" id="1568727">.</span><span class="ident" id="1568728">other_sys</span><span class="op" id="1568737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568741">if</span>&nbsp;<span class="ident" id="1568744">persistent</span><span class="op" id="1568754">.</span><span class="ident" id="1568755">pos</span>&nbsp;<span class="op" id="1568759">==</span>&nbsp;<span class="ident" id="1568762">nil</span>&nbsp;<span class="op" id="1568766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568771">unlock</span><span class="op" id="1568777">(</span><span class="op" id="1568778">&amp;</span><span class="ident" id="1568779">persistent</span><span class="op" id="1568789">.</span><span class="ident" id="1568790">lock</span><span class="op" id="1568794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568799">gothrow</span><span class="op" id="1568806">(</span><span class="string" id="1568807">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1568840">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568848">persistent</span><span class="op" id="1568858">.</span><span class="ident" id="1568859">end</span>&nbsp;<span class="op" id="1568863">=</span>&nbsp;<span class="ident" id="1568865">add</span><span class="op" id="1568868">(</span><span class="ident" id="1568869">persistent</span><span class="op" id="1568879">.</span><span class="ident" id="1568880">pos</span><span class="op" id="1568883">,</span>&nbsp;<span class="ident" id="1568885">chunk</span><span class="op" id="1568890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1568893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568896">p</span>&nbsp;<span class="op" id="1568898">:=</span>&nbsp;<span class="ident" id="1568901">persistent</span><span class="op" id="1568911">.</span><span class="ident" id="1568912">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568917">persistent</span><span class="op" id="1568927">.</span><span class="ident" id="1568928">pos</span>&nbsp;<span class="op" id="1568932">=</span>&nbsp;<span class="ident" id="1568934">add</span><span class="op" id="1568937">(</span><span class="ident" id="1568938">persistent</span><span class="op" id="1568948">.</span><span class="ident" id="1568949">pos</span><span class="op" id="1568952">,</span>&nbsp;<span class="ident" id="1568954">size</span><span class="op" id="1568958">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1568961">unlock</span><span class="op" id="1568967">(</span><span class="op" id="1568968">&amp;</span><span class="ident" id="1568969">persistent</span><span class="op" id="1568979">.</span><span class="ident" id="1568980">lock</span><span class="op" id="1568984">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1568988">if</span>&nbsp;<span class="ident" id="1568991">stat</span>&nbsp;<span class="op" id="1568996">!=</span>&nbsp;<span class="op" id="1568999">&amp;</span><span class="ident" id="1569000">memstats</span><span class="op" id="1569008">.</span><span class="ident" id="1569009">other_sys</span>&nbsp;<span class="op" id="1569019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569023">xadd64</span><span class="op" id="1569029">(</span><span class="ident" id="1569030">stat</span><span class="op" id="1569034">,</span>&nbsp;<span class="ident" id="1569036">int64</span><span class="op" id="1569041">(</span><span class="ident" id="1569042">size</span><span class="op" id="1569046">)</span><span class="op" id="1569047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1569051">xadd64</span><span class="op" id="1569057">(</span><span class="op" id="1569058">&amp;</span><span class="ident" id="1569059">memstats</span><span class="op" id="1569067">.</span><span class="ident" id="1569068">other_sys</span><span class="op" id="1569077">,</span>&nbsp;<span class="op" id="1569079">-</span><span class="ident" id="1569080">int64</span><span class="op" id="1569085">(</span><span class="ident" id="1569086">size</span><span class="op" id="1569090">)</span><span class="op" id="1569091">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1569094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1569097">return</span>&nbsp;<span class="ident" id="1569104">p</span><br>
<span class="lineno"></span><span class="op" id="1569106">}</span>
</div>
</body>
</html>
