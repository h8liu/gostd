<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1380152">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1380207">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1380261">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1380312">package</span>&nbsp;<span class="ident" id="1380320">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1380325">import</span>&nbsp;<span class="string" id="1380332">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1380347">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="1380401">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="1380457">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="1380496">type</span>&nbsp;<span class="ident" id="1380501">fdMutex</span>&nbsp;<span class="keyword" id="1380509">struct</span>&nbsp;<span class="op" id="1380516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380519">state</span>&nbsp;<span class="ident" id="1380525">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380533">rsema</span>&nbsp;<span class="builtintype" id="1380539">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380547">wsema</span>&nbsp;<span class="builtintype" id="1380553">uint32</span><br>
<span class="lineno"></span><span class="op" id="1380560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1380563">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="1380605">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="1380690">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1380727">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1380765">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="1380824">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="1380873">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="1380923">const</span>&nbsp;<span class="op" id="1380929">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380932">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="1380945">=</span>&nbsp;<span class="num" id="1380947">1</span>&nbsp;<span class="op" id="1380949">&lt;&lt;</span>&nbsp;<span class="num" id="1380952">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380955">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1380968">=</span>&nbsp;<span class="num" id="1380970">1</span>&nbsp;<span class="op" id="1380972">&lt;&lt;</span>&nbsp;<span class="num" id="1380975">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380978">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1380991">=</span>&nbsp;<span class="num" id="1380993">1</span>&nbsp;<span class="op" id="1380995">&lt;&lt;</span>&nbsp;<span class="num" id="1380998">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1381001">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1381014">=</span>&nbsp;<span class="num" id="1381016">1</span>&nbsp;<span class="op" id="1381018">&lt;&lt;</span>&nbsp;<span class="num" id="1381021">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1381024">mutexRefMask</span>&nbsp;<span class="op" id="1381037">=</span>&nbsp;<span class="op" id="1381039">(</span><span class="num" id="1381040">1</span><span class="op" id="1381041">&lt;&lt;</span><span class="num" id="1381043">20</span>&nbsp;<span class="op" id="1381046">-</span>&nbsp;<span class="num" id="1381048">1</span><span class="op" id="1381049">)</span>&nbsp;<span class="op" id="1381051">&lt;&lt;</span>&nbsp;<span class="num" id="1381054">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1381057">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1381070">=</span>&nbsp;<span class="num" id="1381072">1</span>&nbsp;<span class="op" id="1381074">&lt;&lt;</span>&nbsp;<span class="num" id="1381077">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1381081">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1381094">=</span>&nbsp;<span class="op" id="1381096">(</span><span class="num" id="1381097">1</span><span class="op" id="1381098">&lt;&lt;</span><span class="num" id="1381100">20</span>&nbsp;<span class="op" id="1381103">-</span>&nbsp;<span class="num" id="1381105">1</span><span class="op" id="1381106">)</span>&nbsp;<span class="op" id="1381108">&lt;&lt;</span>&nbsp;<span class="num" id="1381111">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1381115">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1381128">=</span>&nbsp;<span class="num" id="1381130">1</span>&nbsp;<span class="op" id="1381132">&lt;&lt;</span>&nbsp;<span class="num" id="1381135">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1381139">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1381152">=</span>&nbsp;<span class="op" id="1381154">(</span><span class="num" id="1381155">1</span><span class="op" id="1381156">&lt;&lt;</span><span class="num" id="1381158">20</span>&nbsp;<span class="op" id="1381161">-</span>&nbsp;<span class="num" id="1381163">1</span><span class="op" id="1381164">)</span>&nbsp;<span class="op" id="1381166">&lt;&lt;</span>&nbsp;<span class="num" id="1381169">43</span><br>
<span class="lineno">35</span><span class="op" id="1381172">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1381175">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="1381231">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="1381290">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="1381371">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1381448">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="1381521">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="1381571">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="1381622">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="1381666">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1381753">func</span>&nbsp;<span class="op" id="1381758">(</span><span class="ident" id="1381759">mu</span>&nbsp;<span class="op" id="1381762">*</span><span class="ident" id="1381763"><a href="/net/fd_mutex.go.html#1380501">fdMutex</a></span><span class="op" id="1381770">)</span>&nbsp;<span class="ident" id="1381772">Incref</span><span class="op" id="1381778">(</span><span class="op" id="1381779">)</span>&nbsp;<span class="builtintype" id="1381781">bool</span>&nbsp;<span class="op" id="1381786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1381789">for</span>&nbsp;<span class="op" id="1381793">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1381797">old</span>&nbsp;<span class="op" id="1381801">:=</span>&nbsp;<span class="ident" id="1381804"><a href="/net/fd_mutex.go.html#1380332">atomic</a></span><span class="op" id="1381810">.</span><span class="ident" id="1381811">LoadUint64</span><span class="op" id="1381821">(</span><span class="op" id="1381822">&amp;</span><span class="ident" id="1381823"><a href="/net/fd_mutex.go.html#1381759">mu</a></span><span class="op" id="1381825">.</span><span class="ident" id="1381826">state</span><span class="op" id="1381831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1381835">if</span>&nbsp;<span class="ident" id="1381838"><a href="/net/fd_mutex.go.html#1381797">old</a></span><span class="op" id="1381841">&amp;</span><span class="ident" id="1381842"><a href="/net/fd_mutex.go.html#1380932">mutexClosed</a></span>&nbsp;<span class="op" id="1381854">!=</span>&nbsp;<span class="num" id="1381857">0</span>&nbsp;<span class="op" id="1381859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1381864">return</span>&nbsp;<span class="builtintype" id="1381871">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1381879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1381883">new</span>&nbsp;<span class="op" id="1381887">:=</span>&nbsp;<span class="ident" id="1381890"><a href="/net/fd_mutex.go.html#1381797">old</a></span>&nbsp;<span class="op" id="1381894">+</span>&nbsp;<span class="ident" id="1381896"><a href="/net/fd_mutex.go.html#1381001">mutexRef</a></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1381907">if</span>&nbsp;<span class="builtinfunc" id="1381910"><a href="/net/fd_mutex.go.html#1381883">new</a></span><span class="op" id="1381913">&amp;</span><span class="ident" id="1381914"><a href="/net/fd_mutex.go.html#1381024">mutexRefMask</a></span>&nbsp;<span class="op" id="1381927">==</span>&nbsp;<span class="num" id="1381930">0</span>&nbsp;<span class="op" id="1381932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1381937">panic</span><span class="op" id="1381942">(</span><span class="string" id="1381943">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="1381970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1381974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1381978">if</span>&nbsp;<span class="ident" id="1381981"><a href="/net/fd_mutex.go.html#1380332">atomic</a></span><span class="op" id="1381987">.</span><span class="ident" id="1381988">CompareAndSwapUint64</span><span class="op" id="1382008">(</span><span class="op" id="1382009">&amp;</span><span class="ident" id="1382010"><a href="/net/fd_mutex.go.html#1381759">mu</a></span><span class="op" id="1382012">.</span><span class="ident" id="1382013">state</span><span class="op" id="1382018">,</span>&nbsp;<span class="ident" id="1382020"><a href="/net/fd_mutex.go.html#1381797">old</a></span><span class="op" id="1382023">,</span>&nbsp;<span class="builtinfunc" id="1382025"><a href="/net/fd_mutex.go.html#1381883">new</a></span><span class="op" id="1382028">)</span>&nbsp;<span class="op" id="1382030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382035">return</span>&nbsp;<span class="builtintype" id="1382042">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1382049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1382052">}</span><br>
<span class="lineno"></span><span class="op" id="1382054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1382057">func</span>&nbsp;<span class="op" id="1382062">(</span><span class="ident" id="1382063">mu</span>&nbsp;<span class="op" id="1382066">*</span><span class="ident" id="1382067"><a href="/net/fd_mutex.go.html#1380501">fdMutex</a></span><span class="op" id="1382074">)</span>&nbsp;<span class="ident" id="1382076">IncrefAndClose</span><span class="op" id="1382090">(</span><span class="op" id="1382091">)</span>&nbsp;<span class="builtintype" id="1382093">bool</span>&nbsp;<span class="op" id="1382098">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382101">for</span>&nbsp;<span class="op" id="1382105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1382109">old</span>&nbsp;<span class="op" id="1382113">:=</span>&nbsp;<span class="ident" id="1382116"><a href="/net/fd_mutex.go.html#1380332">atomic</a></span><span class="op" id="1382122">.</span><span class="ident" id="1382123">LoadUint64</span><span class="op" id="1382133">(</span><span class="op" id="1382134">&amp;</span><span class="ident" id="1382135"><a href="/net/fd_mutex.go.html#1382063">mu</a></span><span class="op" id="1382137">.</span><span class="ident" id="1382138">state</span><span class="op" id="1382143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382147">if</span>&nbsp;<span class="ident" id="1382150"><a href="/net/fd_mutex.go.html#1382109">old</a></span><span class="op" id="1382153">&amp;</span><span class="ident" id="1382154"><a href="/net/fd_mutex.go.html#1380932">mutexClosed</a></span>&nbsp;<span class="op" id="1382166">!=</span>&nbsp;<span class="num" id="1382169">0</span>&nbsp;<span class="op" id="1382171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382176">return</span>&nbsp;<span class="builtintype" id="1382183">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1382191">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1382195">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1382240">new</span>&nbsp;<span class="op" id="1382244">:=</span>&nbsp;<span class="op" id="1382247">(</span><span class="ident" id="1382248"><a href="/net/fd_mutex.go.html#1382109">old</a></span>&nbsp;<span class="op" id="1382252">|</span>&nbsp;<span class="ident" id="1382254"><a href="/net/fd_mutex.go.html#1380932">mutexClosed</a></span><span class="op" id="1382265">)</span>&nbsp;<span class="op" id="1382267">+</span>&nbsp;<span class="ident" id="1382269"><a href="/net/fd_mutex.go.html#1381001">mutexRef</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382280">if</span>&nbsp;<span class="builtinfunc" id="1382283"><a href="/net/fd_mutex.go.html#1382240">new</a></span><span class="op" id="1382286">&amp;</span><span class="ident" id="1382287"><a href="/net/fd_mutex.go.html#1381024">mutexRefMask</a></span>&nbsp;<span class="op" id="1382300">==</span>&nbsp;<span class="num" id="1382303">0</span>&nbsp;<span class="op" id="1382305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1382310">panic</span><span class="op" id="1382315">(</span><span class="string" id="1382316">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="1382343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1382347">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1382351">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1382391"><a href="/net/fd_mutex.go.html#1382240">new</a></span>&nbsp;<span class="op" id="1382395">&amp;^=</span>&nbsp;<span class="ident" id="1382399"><a href="/net/fd_mutex.go.html#1381081">mutexRMask</a></span>&nbsp;<span class="op" id="1382410">|</span>&nbsp;<span class="ident" id="1382412"><a href="/net/fd_mutex.go.html#1381139">mutexWMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382425">if</span>&nbsp;<span class="ident" id="1382428"><a href="/net/fd_mutex.go.html#1380332">atomic</a></span><span class="op" id="1382434">.</span><span class="ident" id="1382435">CompareAndSwapUint64</span><span class="op" id="1382455">(</span><span class="op" id="1382456">&amp;</span><span class="ident" id="1382457"><a href="/net/fd_mutex.go.html#1382063">mu</a></span><span class="op" id="1382459">.</span><span class="ident" id="1382460">state</span><span class="op" id="1382465">,</span>&nbsp;<span class="ident" id="1382467"><a href="/net/fd_mutex.go.html#1382109">old</a></span><span class="op" id="1382470">,</span>&nbsp;<span class="builtinfunc" id="1382472"><a href="/net/fd_mutex.go.html#1382240">new</a></span><span class="op" id="1382475">)</span>&nbsp;<span class="op" id="1382477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1382482">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1382521">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382571">for</span>&nbsp;<span class="ident" id="1382575"><a href="/net/fd_mutex.go.html#1382109">old</a></span><span class="op" id="1382578">&amp;</span><span class="ident" id="1382579"><a href="/net/fd_mutex.go.html#1381081">mutexRMask</a></span>&nbsp;<span class="op" id="1382590">!=</span>&nbsp;<span class="num" id="1382593">0</span>&nbsp;<span class="op" id="1382595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1382601"><a href="/net/fd_mutex.go.html#1382109">old</a></span>&nbsp;<span class="op" id="1382605">-=</span>&nbsp;<span class="ident" id="1382608"><a href="/net/fd_mutex.go.html#1381057">mutexRWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1382623"><a href="/net/fd_mutex.go.html#1384889">runtime_Semrelease</a></span><span class="op" id="1382641">(</span><span class="op" id="1382642">&amp;</span><span class="ident" id="1382643"><a href="/net/fd_mutex.go.html#1382063">mu</a></span><span class="op" id="1382645">.</span><span class="ident" id="1382646">rsema</span><span class="op" id="1382651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1382656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382661">for</span>&nbsp;<span class="ident" id="1382665"><a href="/net/fd_mutex.go.html#1382109">old</a></span><span class="op" id="1382668">&amp;</span><span class="ident" id="1382669"><a href="/net/fd_mutex.go.html#1381139">mutexWMask</a></span>&nbsp;<span class="op" id="1382680">!=</span>&nbsp;<span class="num" id="1382683">0</span>&nbsp;<span class="op" id="1382685">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1382691"><a href="/net/fd_mutex.go.html#1382109">old</a></span>&nbsp;<span class="op" id="1382695">-=</span>&nbsp;<span class="ident" id="1382698"><a href="/net/fd_mutex.go.html#1381115">mutexWWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1382713"><a href="/net/fd_mutex.go.html#1384889">runtime_Semrelease</a></span><span class="op" id="1382731">(</span><span class="op" id="1382732">&amp;</span><span class="ident" id="1382733"><a href="/net/fd_mutex.go.html#1382063">mu</a></span><span class="op" id="1382735">.</span><span class="ident" id="1382736">wsema</span><span class="op" id="1382741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1382746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382751">return</span>&nbsp;<span class="builtintype" id="1382758">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1382765">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1382768">}</span><br>
<span class="lineno"></span><span class="op" id="1382770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1382773">func</span>&nbsp;<span class="op" id="1382778">(</span><span class="ident" id="1382779">mu</span>&nbsp;<span class="op" id="1382782">*</span><span class="ident" id="1382783"><a href="/net/fd_mutex.go.html#1380501">fdMutex</a></span><span class="op" id="1382790">)</span>&nbsp;<span class="ident" id="1382792">Decref</span><span class="op" id="1382798">(</span><span class="op" id="1382799">)</span>&nbsp;<span class="builtintype" id="1382801">bool</span>&nbsp;<span class="op" id="1382806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382809">for</span>&nbsp;<span class="op" id="1382813">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1382817">old</span>&nbsp;<span class="op" id="1382821">:=</span>&nbsp;<span class="ident" id="1382824"><a href="/net/fd_mutex.go.html#1380332">atomic</a></span><span class="op" id="1382830">.</span><span class="ident" id="1382831">LoadUint64</span><span class="op" id="1382841">(</span><span class="op" id="1382842">&amp;</span><span class="ident" id="1382843"><a href="/net/fd_mutex.go.html#1382779">mu</a></span><span class="op" id="1382845">.</span><span class="ident" id="1382846">state</span><span class="op" id="1382851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382855">if</span>&nbsp;<span class="ident" id="1382858"><a href="/net/fd_mutex.go.html#1382817">old</a></span><span class="op" id="1382861">&amp;</span><span class="ident" id="1382862"><a href="/net/fd_mutex.go.html#1381024">mutexRefMask</a></span>&nbsp;<span class="op" id="1382875">==</span>&nbsp;<span class="num" id="1382878">0</span>&nbsp;<span class="op" id="1382880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1382885">panic</span><span class="op" id="1382890">(</span><span class="string" id="1382891">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="1382918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1382922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1382926">new</span>&nbsp;<span class="op" id="1382930">:=</span>&nbsp;<span class="ident" id="1382933"><a href="/net/fd_mutex.go.html#1382817">old</a></span>&nbsp;<span class="op" id="1382937">-</span>&nbsp;<span class="ident" id="1382939"><a href="/net/fd_mutex.go.html#1381001">mutexRef</a></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1382950">if</span>&nbsp;<span class="ident" id="1382953"><a href="/net/fd_mutex.go.html#1380332">atomic</a></span><span class="op" id="1382959">.</span><span class="ident" id="1382960">CompareAndSwapUint64</span><span class="op" id="1382980">(</span><span class="op" id="1382981">&amp;</span><span class="ident" id="1382982"><a href="/net/fd_mutex.go.html#1382779">mu</a></span><span class="op" id="1382984">.</span><span class="ident" id="1382985">state</span><span class="op" id="1382990">,</span>&nbsp;<span class="ident" id="1382992"><a href="/net/fd_mutex.go.html#1382817">old</a></span><span class="op" id="1382995">,</span>&nbsp;<span class="builtinfunc" id="1382997"><a href="/net/fd_mutex.go.html#1382926">new</a></span><span class="op" id="1383000">)</span>&nbsp;<span class="op" id="1383002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383007">return</span>&nbsp;<span class="builtinfunc" id="1383014"><a href="/net/fd_mutex.go.html#1382926">new</a></span><span class="op" id="1383017">&amp;</span><span class="op" id="1383018">(</span><span class="ident" id="1383019"><a href="/net/fd_mutex.go.html#1380932">mutexClosed</a></span><span class="op" id="1383030">|</span><span class="ident" id="1383031"><a href="/net/fd_mutex.go.html#1381024">mutexRefMask</a></span><span class="op" id="1383043">)</span>&nbsp;<span class="op" id="1383045">==</span>&nbsp;<span class="ident" id="1383048"><a href="/net/fd_mutex.go.html#1380932">mutexClosed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383065">}</span><br>
<span class="lineno"></span><span class="op" id="1383067">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1383070">func</span>&nbsp;<span class="op" id="1383075">(</span><span class="ident" id="1383076">mu</span>&nbsp;<span class="op" id="1383079">*</span><span class="ident" id="1383080"><a href="/net/fd_mutex.go.html#1380501">fdMutex</a></span><span class="op" id="1383087">)</span>&nbsp;<span class="ident" id="1383089">RWLock</span><span class="op" id="1383095">(</span><span class="ident" id="1383096">read</span>&nbsp;<span class="builtintype" id="1383101">bool</span><span class="op" id="1383105">)</span>&nbsp;<span class="builtintype" id="1383107">bool</span>&nbsp;<span class="op" id="1383112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383115">var</span>&nbsp;<span class="ident" id="1383119">mutexBit</span><span class="op" id="1383127">,</span>&nbsp;<span class="ident" id="1383129">mutexWait</span><span class="op" id="1383138">,</span>&nbsp;<span class="ident" id="1383140">mutexMask</span>&nbsp;<span class="ident" id="1383150">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383158">var</span>&nbsp;<span class="ident" id="1383162">mutexSema</span>&nbsp;<span class="op" id="1383172">*</span><span class="builtintype" id="1383173">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383181">if</span>&nbsp;<span class="ident" id="1383184"><a href="/net/fd_mutex.go.html#1383096">read</a></span>&nbsp;<span class="op" id="1383189">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383193"><a href="/net/fd_mutex.go.html#1383119">mutexBit</a></span>&nbsp;<span class="op" id="1383202">=</span>&nbsp;<span class="ident" id="1383204"><a href="/net/fd_mutex.go.html#1380955">mutexRLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383217"><a href="/net/fd_mutex.go.html#1383129">mutexWait</a></span>&nbsp;<span class="op" id="1383227">=</span>&nbsp;<span class="ident" id="1383229"><a href="/net/fd_mutex.go.html#1381057">mutexRWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383242"><a href="/net/fd_mutex.go.html#1383140">mutexMask</a></span>&nbsp;<span class="op" id="1383252">=</span>&nbsp;<span class="ident" id="1383254"><a href="/net/fd_mutex.go.html#1381081">mutexRMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383267"><a href="/net/fd_mutex.go.html#1383162">mutexSema</a></span>&nbsp;<span class="op" id="1383277">=</span>&nbsp;<span class="op" id="1383279">&amp;</span><span class="ident" id="1383280"><a href="/net/fd_mutex.go.html#1383076">mu</a></span><span class="op" id="1383282">.</span><span class="ident" id="1383283">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383290">}</span>&nbsp;<span class="keyword" id="1383292">else</span>&nbsp;<span class="op" id="1383297">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383301"><a href="/net/fd_mutex.go.html#1383119">mutexBit</a></span>&nbsp;<span class="op" id="1383310">=</span>&nbsp;<span class="ident" id="1383312"><a href="/net/fd_mutex.go.html#1380978">mutexWLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383325"><a href="/net/fd_mutex.go.html#1383129">mutexWait</a></span>&nbsp;<span class="op" id="1383335">=</span>&nbsp;<span class="ident" id="1383337"><a href="/net/fd_mutex.go.html#1381115">mutexWWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383350"><a href="/net/fd_mutex.go.html#1383140">mutexMask</a></span>&nbsp;<span class="op" id="1383360">=</span>&nbsp;<span class="ident" id="1383362"><a href="/net/fd_mutex.go.html#1381139">mutexWMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383375"><a href="/net/fd_mutex.go.html#1383162">mutexSema</a></span>&nbsp;<span class="op" id="1383385">=</span>&nbsp;<span class="op" id="1383387">&amp;</span><span class="ident" id="1383388"><a href="/net/fd_mutex.go.html#1383076">mu</a></span><span class="op" id="1383390">.</span><span class="ident" id="1383391">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383398">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383401">for</span>&nbsp;<span class="op" id="1383405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383409">old</span>&nbsp;<span class="op" id="1383413">:=</span>&nbsp;<span class="ident" id="1383416"><a href="/net/fd_mutex.go.html#1380332">atomic</a></span><span class="op" id="1383422">.</span><span class="ident" id="1383423">LoadUint64</span><span class="op" id="1383433">(</span><span class="op" id="1383434">&amp;</span><span class="ident" id="1383435"><a href="/net/fd_mutex.go.html#1383076">mu</a></span><span class="op" id="1383437">.</span><span class="ident" id="1383438">state</span><span class="op" id="1383443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383447">if</span>&nbsp;<span class="ident" id="1383450"><a href="/net/fd_mutex.go.html#1383409">old</a></span><span class="op" id="1383453">&amp;</span><span class="ident" id="1383454"><a href="/net/fd_mutex.go.html#1380932">mutexClosed</a></span>&nbsp;<span class="op" id="1383466">!=</span>&nbsp;<span class="num" id="1383469">0</span>&nbsp;<span class="op" id="1383471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383476">return</span>&nbsp;<span class="builtintype" id="1383483">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383491">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383495">var</span>&nbsp;<span class="builtinfunc" id="1383499">new</span>&nbsp;<span class="ident" id="1383503">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383512">if</span>&nbsp;<span class="ident" id="1383515"><a href="/net/fd_mutex.go.html#1383409">old</a></span><span class="op" id="1383518">&amp;</span><span class="ident" id="1383519"><a href="/net/fd_mutex.go.html#1383119">mutexBit</a></span>&nbsp;<span class="op" id="1383528">==</span>&nbsp;<span class="num" id="1383531">0</span>&nbsp;<span class="op" id="1383533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1383538">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1383570"><a href="/net/fd_mutex.go.html#1383499">new</a></span>&nbsp;<span class="op" id="1383574">=</span>&nbsp;<span class="op" id="1383576">(</span><span class="ident" id="1383577"><a href="/net/fd_mutex.go.html#1383409">old</a></span>&nbsp;<span class="op" id="1383581">|</span>&nbsp;<span class="ident" id="1383583"><a href="/net/fd_mutex.go.html#1383119">mutexBit</a></span><span class="op" id="1383591">)</span>&nbsp;<span class="op" id="1383593">+</span>&nbsp;<span class="ident" id="1383595"><a href="/net/fd_mutex.go.html#1381001">mutexRef</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383607">if</span>&nbsp;<span class="builtinfunc" id="1383610"><a href="/net/fd_mutex.go.html#1383499">new</a></span><span class="op" id="1383613">&amp;</span><span class="ident" id="1383614"><a href="/net/fd_mutex.go.html#1381024">mutexRefMask</a></span>&nbsp;<span class="op" id="1383627">==</span>&nbsp;<span class="num" id="1383630">0</span>&nbsp;<span class="op" id="1383632">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1383638">panic</span><span class="op" id="1383643">(</span><span class="string" id="1383644">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="1383671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383680">}</span>&nbsp;<span class="keyword" id="1383682">else</span>&nbsp;<span class="op" id="1383687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1383692">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1383713"><a href="/net/fd_mutex.go.html#1383499">new</a></span>&nbsp;<span class="op" id="1383717">=</span>&nbsp;<span class="ident" id="1383719"><a href="/net/fd_mutex.go.html#1383409">old</a></span>&nbsp;<span class="op" id="1383723">+</span>&nbsp;<span class="ident" id="1383725"><a href="/net/fd_mutex.go.html#1383129">mutexWait</a></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383738">if</span>&nbsp;<span class="builtinfunc" id="1383741"><a href="/net/fd_mutex.go.html#1383499">new</a></span><span class="op" id="1383744">&amp;</span><span class="ident" id="1383745"><a href="/net/fd_mutex.go.html#1383140">mutexMask</a></span>&nbsp;<span class="op" id="1383755">==</span>&nbsp;<span class="num" id="1383758">0</span>&nbsp;<span class="op" id="1383760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1383766">panic</span><span class="op" id="1383771">(</span><span class="string" id="1383772">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="1383799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383812">if</span>&nbsp;<span class="ident" id="1383815"><a href="/net/fd_mutex.go.html#1380332">atomic</a></span><span class="op" id="1383821">.</span><span class="ident" id="1383822">CompareAndSwapUint64</span><span class="op" id="1383842">(</span><span class="op" id="1383843">&amp;</span><span class="ident" id="1383844"><a href="/net/fd_mutex.go.html#1383076">mu</a></span><span class="op" id="1383846">.</span><span class="ident" id="1383847">state</span><span class="op" id="1383852">,</span>&nbsp;<span class="ident" id="1383854"><a href="/net/fd_mutex.go.html#1383409">old</a></span><span class="op" id="1383857">,</span>&nbsp;<span class="builtinfunc" id="1383859"><a href="/net/fd_mutex.go.html#1383499">new</a></span><span class="op" id="1383862">)</span>&nbsp;<span class="op" id="1383864">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383869">if</span>&nbsp;<span class="ident" id="1383872"><a href="/net/fd_mutex.go.html#1383409">old</a></span><span class="op" id="1383875">&amp;</span><span class="ident" id="1383876"><a href="/net/fd_mutex.go.html#1383119">mutexBit</a></span>&nbsp;<span class="op" id="1383885">==</span>&nbsp;<span class="num" id="1383888">0</span>&nbsp;<span class="op" id="1383890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1383896">return</span>&nbsp;<span class="builtintype" id="1383903">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1383916"><a href="/net/fd_mutex.go.html#1384851">runtime_Semacquire</a></span><span class="op" id="1383934">(</span><span class="ident" id="1383935"><a href="/net/fd_mutex.go.html#1383162">mutexSema</a></span><span class="op" id="1383944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1383949">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1383997">}</span><br>
<span class="lineno"></span><span class="op" id="1383999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1384002">func</span>&nbsp;<span class="op" id="1384007">(</span><span class="ident" id="1384008">mu</span>&nbsp;<span class="op" id="1384011">*</span><span class="ident" id="1384012"><a href="/net/fd_mutex.go.html#1380501">fdMutex</a></span><span class="op" id="1384019">)</span>&nbsp;<span class="ident" id="1384021">RWUnlock</span><span class="op" id="1384029">(</span><span class="ident" id="1384030">read</span>&nbsp;<span class="builtintype" id="1384035">bool</span><span class="op" id="1384039">)</span>&nbsp;<span class="builtintype" id="1384041">bool</span>&nbsp;<span class="op" id="1384046">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384049">var</span>&nbsp;<span class="ident" id="1384053">mutexBit</span><span class="op" id="1384061">,</span>&nbsp;<span class="ident" id="1384063">mutexWait</span><span class="op" id="1384072">,</span>&nbsp;<span class="ident" id="1384074">mutexMask</span>&nbsp;<span class="ident" id="1384084">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384092">var</span>&nbsp;<span class="ident" id="1384096">mutexSema</span>&nbsp;<span class="op" id="1384106">*</span><span class="builtintype" id="1384107">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384115">if</span>&nbsp;<span class="ident" id="1384118"><a href="/net/fd_mutex.go.html#1384030">read</a></span>&nbsp;<span class="op" id="1384123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384127"><a href="/net/fd_mutex.go.html#1384053">mutexBit</a></span>&nbsp;<span class="op" id="1384136">=</span>&nbsp;<span class="ident" id="1384138"><a href="/net/fd_mutex.go.html#1380955">mutexRLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384151"><a href="/net/fd_mutex.go.html#1384063">mutexWait</a></span>&nbsp;<span class="op" id="1384161">=</span>&nbsp;<span class="ident" id="1384163"><a href="/net/fd_mutex.go.html#1381057">mutexRWait</a></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384176"><a href="/net/fd_mutex.go.html#1384074">mutexMask</a></span>&nbsp;<span class="op" id="1384186">=</span>&nbsp;<span class="ident" id="1384188"><a href="/net/fd_mutex.go.html#1381081">mutexRMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384201"><a href="/net/fd_mutex.go.html#1384096">mutexSema</a></span>&nbsp;<span class="op" id="1384211">=</span>&nbsp;<span class="op" id="1384213">&amp;</span><span class="ident" id="1384214"><a href="/net/fd_mutex.go.html#1384008">mu</a></span><span class="op" id="1384216">.</span><span class="ident" id="1384217">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384224">}</span>&nbsp;<span class="keyword" id="1384226">else</span>&nbsp;<span class="op" id="1384231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384235"><a href="/net/fd_mutex.go.html#1384053">mutexBit</a></span>&nbsp;<span class="op" id="1384244">=</span>&nbsp;<span class="ident" id="1384246"><a href="/net/fd_mutex.go.html#1380978">mutexWLock</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384259"><a href="/net/fd_mutex.go.html#1384063">mutexWait</a></span>&nbsp;<span class="op" id="1384269">=</span>&nbsp;<span class="ident" id="1384271"><a href="/net/fd_mutex.go.html#1381115">mutexWWait</a></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384284"><a href="/net/fd_mutex.go.html#1384074">mutexMask</a></span>&nbsp;<span class="op" id="1384294">=</span>&nbsp;<span class="ident" id="1384296"><a href="/net/fd_mutex.go.html#1381139">mutexWMask</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384309"><a href="/net/fd_mutex.go.html#1384096">mutexSema</a></span>&nbsp;<span class="op" id="1384319">=</span>&nbsp;<span class="op" id="1384321">&amp;</span><span class="ident" id="1384322"><a href="/net/fd_mutex.go.html#1384008">mu</a></span><span class="op" id="1384324">.</span><span class="ident" id="1384325">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384335">for</span>&nbsp;<span class="op" id="1384339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384343">old</span>&nbsp;<span class="op" id="1384347">:=</span>&nbsp;<span class="ident" id="1384350"><a href="/net/fd_mutex.go.html#1380332">atomic</a></span><span class="op" id="1384356">.</span><span class="ident" id="1384357">LoadUint64</span><span class="op" id="1384367">(</span><span class="op" id="1384368">&amp;</span><span class="ident" id="1384369"><a href="/net/fd_mutex.go.html#1384008">mu</a></span><span class="op" id="1384371">.</span><span class="ident" id="1384372">state</span><span class="op" id="1384377">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384381">if</span>&nbsp;<span class="ident" id="1384384"><a href="/net/fd_mutex.go.html#1384343">old</a></span><span class="op" id="1384387">&amp;</span><span class="ident" id="1384388"><a href="/net/fd_mutex.go.html#1384053">mutexBit</a></span>&nbsp;<span class="op" id="1384397">==</span>&nbsp;<span class="num" id="1384400">0</span>&nbsp;<span class="op" id="1384402">||</span>&nbsp;<span class="ident" id="1384405"><a href="/net/fd_mutex.go.html#1384343">old</a></span><span class="op" id="1384408">&amp;</span><span class="ident" id="1384409"><a href="/net/fd_mutex.go.html#1381024">mutexRefMask</a></span>&nbsp;<span class="op" id="1384422">==</span>&nbsp;<span class="num" id="1384425">0</span>&nbsp;<span class="op" id="1384427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1384432">panic</span><span class="op" id="1384437">(</span><span class="string" id="1384438">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="1384465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1384473">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1384537">new</span>&nbsp;<span class="op" id="1384541">:=</span>&nbsp;<span class="op" id="1384544">(</span><span class="ident" id="1384545"><a href="/net/fd_mutex.go.html#1384343">old</a></span>&nbsp;<span class="op" id="1384549">&amp;^</span>&nbsp;<span class="ident" id="1384552"><a href="/net/fd_mutex.go.html#1384053">mutexBit</a></span><span class="op" id="1384560">)</span>&nbsp;<span class="op" id="1384562">-</span>&nbsp;<span class="ident" id="1384564"><a href="/net/fd_mutex.go.html#1381001">mutexRef</a></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384575">if</span>&nbsp;<span class="ident" id="1384578"><a href="/net/fd_mutex.go.html#1384343">old</a></span><span class="op" id="1384581">&amp;</span><span class="ident" id="1384582"><a href="/net/fd_mutex.go.html#1384074">mutexMask</a></span>&nbsp;<span class="op" id="1384592">!=</span>&nbsp;<span class="num" id="1384595">0</span>&nbsp;<span class="op" id="1384597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1384602"><a href="/net/fd_mutex.go.html#1384537">new</a></span>&nbsp;<span class="op" id="1384606">-=</span>&nbsp;<span class="ident" id="1384609"><a href="/net/fd_mutex.go.html#1384063">mutexWait</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384625">if</span>&nbsp;<span class="ident" id="1384628"><a href="/net/fd_mutex.go.html#1380332">atomic</a></span><span class="op" id="1384634">.</span><span class="ident" id="1384635">CompareAndSwapUint64</span><span class="op" id="1384655">(</span><span class="op" id="1384656">&amp;</span><span class="ident" id="1384657"><a href="/net/fd_mutex.go.html#1384008">mu</a></span><span class="op" id="1384659">.</span><span class="ident" id="1384660">state</span><span class="op" id="1384665">,</span>&nbsp;<span class="ident" id="1384667"><a href="/net/fd_mutex.go.html#1384343">old</a></span><span class="op" id="1384670">,</span>&nbsp;<span class="builtinfunc" id="1384672"><a href="/net/fd_mutex.go.html#1384537">new</a></span><span class="op" id="1384675">)</span>&nbsp;<span class="op" id="1384677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384682">if</span>&nbsp;<span class="ident" id="1384685"><a href="/net/fd_mutex.go.html#1384343">old</a></span><span class="op" id="1384688">&amp;</span><span class="ident" id="1384689"><a href="/net/fd_mutex.go.html#1384074">mutexMask</a></span>&nbsp;<span class="op" id="1384699">!=</span>&nbsp;<span class="num" id="1384702">0</span>&nbsp;<span class="op" id="1384704">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1384710"><a href="/net/fd_mutex.go.html#1384889">runtime_Semrelease</a></span><span class="op" id="1384728">(</span><span class="ident" id="1384729"><a href="/net/fd_mutex.go.html#1384096">mutexSema</a></span><span class="op" id="1384738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1384748">return</span>&nbsp;<span class="builtinfunc" id="1384755"><a href="/net/fd_mutex.go.html#1384537">new</a></span><span class="op" id="1384758">&amp;</span><span class="op" id="1384759">(</span><span class="ident" id="1384760"><a href="/net/fd_mutex.go.html#1380932">mutexClosed</a></span><span class="op" id="1384771">|</span><span class="ident" id="1384772"><a href="/net/fd_mutex.go.html#1381024">mutexRefMask</a></span><span class="op" id="1384784">)</span>&nbsp;<span class="op" id="1384786">==</span>&nbsp;<span class="ident" id="1384789"><a href="/net/fd_mutex.go.html#1380932">mutexClosed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1384806">}</span><br>
<span class="lineno">180</span><span class="op" id="1384808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1384811">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="1384846">func</span>&nbsp;<span class="ident" id="1384851">runtime_Semacquire</span><span class="op" id="1384869">(</span><span class="ident" id="1384870">sema</span>&nbsp;<span class="op" id="1384875">*</span><span class="builtintype" id="1384876">uint32</span><span class="op" id="1384882">)</span><br>
<span class="lineno"></span><span class="keyword" id="1384884">func</span>&nbsp;<span class="ident" id="1384889">runtime_Semrelease</span><span class="op" id="1384907">(</span><span class="ident" id="1384908">sema</span>&nbsp;<span class="op" id="1384913">*</span><span class="builtintype" id="1384914">uint32</span><span class="op" id="1384920">)</span>
</div>
</body>
</html>
