<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1464257">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1464313">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1464367">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1464418">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1464436">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1464487">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1464534">//</span><br>
<span class="lineno"></span><span class="comment" id="1464537">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1464603">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1464674">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1464743">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1464782">//</span><br>
<span class="lineno"></span><span class="comment" id="1464785">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1464859">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1464931">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1465000">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1465072">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1465139">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1465215">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1465287">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1465361">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1465439">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1465517">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1465597">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1465668">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1465746">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1465819">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1465841">//</span><br>
<span class="lineno">30</span><span class="comment" id="1465844">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1465916">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1465997">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1466074">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1466144">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1466217">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1466293">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1466367">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1466448">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1466532">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1466614">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1466653">//</span><br>
<span class="lineno"></span><span class="comment" id="1466656">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1466717">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1466795">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1466861">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1466934">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1467008">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1467081">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1467157">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1467222">package</span>&nbsp;<span class="ident" id="1467230">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1467239">import</span>&nbsp;<span class="string" id="1467246">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1467256">const</span>&nbsp;<span class="op" id="1467262">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467265">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467281">=</span>&nbsp;<span class="num" id="1467283">1</span>&nbsp;<span class="op" id="1467285">&lt;&lt;</span>&nbsp;<span class="num" id="1467288">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467292">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467308">=</span>&nbsp;<span class="num" id="1467310">1</span>&nbsp;<span class="op" id="1467312">&lt;&lt;</span>&nbsp;<span class="num" id="1467315">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467319">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467335">=</span>&nbsp;<span class="num" id="1467337">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467340">maxCPUProfStack</span>&nbsp;<span class="op" id="1467356">=</span>&nbsp;<span class="num" id="1467358">64</span><br>
<span class="lineno">60</span><span class="op" id="1467361">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1467364">type</span>&nbsp;<span class="ident" id="1467369">cpuprofEntry</span>&nbsp;<span class="keyword" id="1467382">struct</span>&nbsp;<span class="op" id="1467389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467392">count</span>&nbsp;<span class="builtintype" id="1467398">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467407">depth</span>&nbsp;<span class="builtintype" id="1467413">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467422">stack</span>&nbsp;<span class="op" id="1467428">[</span><span class="ident" id="1467429">maxCPUProfStack</span><span class="op" id="1467444">]</span><span class="builtintype" id="1467445">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1467453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1467456">type</span>&nbsp;<span class="ident" id="1467461">cpuProfile</span>&nbsp;<span class="keyword" id="1467472">struct</span>&nbsp;<span class="op" id="1467479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467482">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1467489">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467497">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467517">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1467524">note</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1467532">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467557">count</span>&nbsp;&nbsp;<span class="builtintype" id="1467564">uintptr</span>&nbsp;<span class="comment" id="1467572">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467587">evicts</span>&nbsp;<span class="builtintype" id="1467594">uintptr</span>&nbsp;<span class="comment" id="1467602">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467621">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1467628">uintptr</span>&nbsp;<span class="comment" id="1467636">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467675">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467707">hash</span>&nbsp;<span class="op" id="1467712">[</span><span class="ident" id="1467713">numBuckets</span><span class="op" id="1467723">]</span><span class="keyword" id="1467724">struct</span>&nbsp;<span class="op" id="1467731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467735">entry</span>&nbsp;<span class="op" id="1467741">[</span><span class="ident" id="1467742">assoc</span><span class="op" id="1467747">]</span><span class="ident" id="1467748">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1467762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467766">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467803">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467853">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467903">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1467911">[</span><span class="num" id="1467912">2</span><span class="op" id="1467913">]</span><span class="op" id="1467914">[</span><span class="ident" id="1467915">logSize</span>&nbsp;<span class="op" id="1467923">/</span>&nbsp;<span class="num" id="1467925">2</span><span class="op" id="1467926">]</span><span class="builtintype" id="1467927">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467936">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1467944">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467953">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1467961">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467968">handoff</span>&nbsp;<span class="builtintype" id="1467976">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1467985">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468003">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1468054">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468094">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1468103">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468111">wholding</span>&nbsp;<span class="builtintype" id="1468120">bool</span>&nbsp;<span class="comment" id="1468125">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468166">flushing</span>&nbsp;<span class="builtintype" id="1468175">bool</span>&nbsp;<span class="comment" id="1468180">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468222">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1468231">bool</span>&nbsp;<span class="comment" id="1468236">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1468284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1468287">var</span>&nbsp;<span class="op" id="1468291">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468294">cpuprofLock</span>&nbsp;<span class="ident" id="1468306">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468313">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1468325">*</span><span class="ident" id="1468326">cpuProfile</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468339">eod</span>&nbsp;<span class="op" id="1468343">=</span>&nbsp;<span class="op" id="1468345">[</span><span class="num" id="1468346">3</span><span class="op" id="1468347">]</span><span class="builtintype" id="1468348">uintptr</span><span class="op" id="1468355">{</span><span class="num" id="1468356">0</span><span class="op" id="1468357">,</span>&nbsp;<span class="num" id="1468359">1</span><span class="op" id="1468360">,</span>&nbsp;<span class="num" id="1468362">0</span><span class="op" id="1468363">}</span><br>
<span class="lineno"></span><span class="op" id="1468365">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1468368">func</span>&nbsp;<span class="ident" id="1468373">setcpuprofilerate_m</span><span class="op" id="1468392">(</span><span class="op" id="1468393">)</span>&nbsp;<span class="comment" id="1468395">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1468406">func</span>&nbsp;<span class="ident" id="1468411">setcpuprofilerate</span><span class="op" id="1468428">(</span><span class="ident" id="1468429">hz</span>&nbsp;<span class="builtintype" id="1468432">int32</span><span class="op" id="1468437">)</span>&nbsp;<span class="op" id="1468439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468442">g</span>&nbsp;<span class="op" id="1468444">:=</span>&nbsp;<span class="ident" id="1468447">getg</span><span class="op" id="1468451">(</span><span class="op" id="1468452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468455">g</span><span class="op" id="1468456">.</span><span class="ident" id="1468457">m</span><span class="op" id="1468458">.</span><span class="ident" id="1468459">scalararg</span><span class="op" id="1468468">[</span><span class="num" id="1468469">0</span><span class="op" id="1468470">]</span>&nbsp;<span class="op" id="1468472">=</span>&nbsp;<span class="builtintype" id="1468474">uintptr</span><span class="op" id="1468481">(</span><span class="ident" id="1468482">hz</span><span class="op" id="1468484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468487">onM</span><span class="op" id="1468490">(</span><span class="ident" id="1468491">setcpuprofilerate_m</span><span class="op" id="1468510">)</span><br>
<span class="lineno">110</span><span class="op" id="1468512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1468515">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1468571">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1468629">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1468668">func</span>&nbsp;<span class="ident" id="1468673">lostProfileData</span><span class="op" id="1468688">(</span><span class="op" id="1468689">)</span>&nbsp;<span class="op" id="1468691">{</span><span class="op" id="1468692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1468695">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1468770">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1468824">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1468907">//</span><br>
<span class="lineno"></span><span class="comment" id="1468910">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1468966">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1469032">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1469063">func</span>&nbsp;<span class="ident" id="1469068">SetCPUProfileRate</span><span class="op" id="1469085">(</span><span class="ident" id="1469086">hz</span>&nbsp;<span class="builtintype" id="1469089">int</span><span class="op" id="1469092">)</span>&nbsp;<span class="op" id="1469094">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1469097">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469135">if</span>&nbsp;<span class="ident" id="1469138">hz</span>&nbsp;<span class="op" id="1469141">&lt;</span>&nbsp;<span class="num" id="1469143">0</span>&nbsp;<span class="op" id="1469145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469149">hz</span>&nbsp;<span class="op" id="1469152">=</span>&nbsp;<span class="num" id="1469154">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469160">if</span>&nbsp;<span class="ident" id="1469163">hz</span>&nbsp;<span class="op" id="1469166">&gt;</span>&nbsp;<span class="num" id="1469168">1000000</span>&nbsp;<span class="op" id="1469176">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469180">hz</span>&nbsp;<span class="op" id="1469183">=</span>&nbsp;<span class="num" id="1469185">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469198">lock</span><span class="op" id="1469202">(</span><span class="op" id="1469203">&amp;</span><span class="ident" id="1469204">cpuprofLock</span><span class="op" id="1469215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469218">if</span>&nbsp;<span class="ident" id="1469221">hz</span>&nbsp;<span class="op" id="1469224">&gt;</span>&nbsp;<span class="num" id="1469226">0</span>&nbsp;<span class="op" id="1469228">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469232">if</span>&nbsp;<span class="ident" id="1469235">cpuprof</span>&nbsp;<span class="op" id="1469243">==</span>&nbsp;<span class="ident" id="1469246">nil</span>&nbsp;<span class="op" id="1469250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469255">cpuprof</span>&nbsp;<span class="op" id="1469263">=</span>&nbsp;<span class="op" id="1469265">(</span><span class="op" id="1469266">*</span><span class="ident" id="1469267">cpuProfile</span><span class="op" id="1469277">)</span><span class="op" id="1469278">(</span><span class="ident" id="1469279">sysAlloc</span><span class="op" id="1469287">(</span><span class="ident" id="1469288">unsafe</span><span class="op" id="1469294">.</span><span class="ident" id="1469295">Sizeof</span><span class="op" id="1469301">(</span><span class="ident" id="1469302">cpuProfile</span><span class="op" id="1469312">{</span><span class="op" id="1469313">}</span><span class="op" id="1469314">)</span><span class="op" id="1469315">,</span>&nbsp;<span class="op" id="1469317">&amp;</span><span class="ident" id="1469318">memstats</span><span class="op" id="1469326">.</span><span class="ident" id="1469327">other_sys</span><span class="op" id="1469336">)</span><span class="op" id="1469337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469342">if</span>&nbsp;<span class="ident" id="1469345">cpuprof</span>&nbsp;<span class="op" id="1469353">==</span>&nbsp;<span class="ident" id="1469356">nil</span>&nbsp;<span class="op" id="1469360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1469366">print</span><span class="op" id="1469371">(</span><span class="string" id="1469372">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1469421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469427">unlock</span><span class="op" id="1469433">(</span><span class="op" id="1469434">&amp;</span><span class="ident" id="1469435">cpuprofLock</span><span class="op" id="1469446">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469452">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469470">if</span>&nbsp;<span class="ident" id="1469473">cpuprof</span><span class="op" id="1469480">.</span><span class="ident" id="1469481">on</span>&nbsp;<span class="op" id="1469484">||</span>&nbsp;<span class="ident" id="1469487">cpuprof</span><span class="op" id="1469494">.</span><span class="ident" id="1469495">handoff</span>&nbsp;<span class="op" id="1469503">!=</span>&nbsp;<span class="num" id="1469506">0</span>&nbsp;<span class="op" id="1469508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1469513">print</span><span class="op" id="1469518">(</span><span class="string" id="1469519">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1469596">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469601">unlock</span><span class="op" id="1469607">(</span><span class="op" id="1469608">&amp;</span><span class="ident" id="1469609">cpuprofLock</span><span class="op" id="1469620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469625">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469639">cpuprof</span><span class="op" id="1469646">.</span><span class="ident" id="1469647">on</span>&nbsp;<span class="op" id="1469650">=</span>&nbsp;<span class="builtintype" id="1469652">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1469659">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1469692">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469782">p</span>&nbsp;<span class="op" id="1469784">:=</span>&nbsp;<span class="op" id="1469787">&amp;</span><span class="ident" id="1469788">cpuprof</span><span class="op" id="1469795">.</span><span class="ident" id="1469796">log</span><span class="op" id="1469799">[</span><span class="num" id="1469800">0</span><span class="op" id="1469801">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469805">p</span><span class="op" id="1469806">[</span><span class="num" id="1469807">0</span><span class="op" id="1469808">]</span>&nbsp;<span class="op" id="1469810">=</span>&nbsp;<span class="num" id="1469812">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469830">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469852">p</span><span class="op" id="1469853">[</span><span class="num" id="1469854">1</span><span class="op" id="1469855">]</span>&nbsp;<span class="op" id="1469857">=</span>&nbsp;<span class="num" id="1469859">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469877">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469899">p</span><span class="op" id="1469900">[</span><span class="num" id="1469901">2</span><span class="op" id="1469902">]</span>&nbsp;<span class="op" id="1469904">=</span>&nbsp;<span class="num" id="1469906">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1469924">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469944">p</span><span class="op" id="1469945">[</span><span class="num" id="1469946">3</span><span class="op" id="1469947">]</span>&nbsp;<span class="op" id="1469949">=</span>&nbsp;<span class="builtintype" id="1469951">uintptr</span><span class="op" id="1469958">(</span><span class="num" id="1469959">1e6</span>&nbsp;<span class="op" id="1469963">/</span>&nbsp;<span class="ident" id="1469965">hz</span><span class="op" id="1469967">)</span>&nbsp;<span class="comment" id="1469969">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469996">p</span><span class="op" id="1469997">[</span><span class="num" id="1469998">4</span><span class="op" id="1469999">]</span>&nbsp;<span class="op" id="1470001">=</span>&nbsp;<span class="num" id="1470003">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470007">cpuprof</span><span class="op" id="1470014">.</span><span class="ident" id="1470015">nlog</span>&nbsp;<span class="op" id="1470020">=</span>&nbsp;<span class="num" id="1470022">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470026">cpuprof</span><span class="op" id="1470033">.</span><span class="ident" id="1470034">toggle</span>&nbsp;<span class="op" id="1470041">=</span>&nbsp;<span class="num" id="1470043">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470047">cpuprof</span><span class="op" id="1470054">.</span><span class="ident" id="1470055">wholding</span>&nbsp;<span class="op" id="1470064">=</span>&nbsp;<span class="builtintype" id="1470066">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470074">cpuprof</span><span class="op" id="1470081">.</span><span class="ident" id="1470082">wtoggle</span>&nbsp;<span class="op" id="1470090">=</span>&nbsp;<span class="num" id="1470092">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470096">cpuprof</span><span class="op" id="1470103">.</span><span class="ident" id="1470104">flushing</span>&nbsp;<span class="op" id="1470113">=</span>&nbsp;<span class="builtintype" id="1470115">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470123">cpuprof</span><span class="op" id="1470130">.</span><span class="ident" id="1470131">eodSent</span>&nbsp;<span class="op" id="1470139">=</span>&nbsp;<span class="builtintype" id="1470141">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470149">noteclear</span><span class="op" id="1470158">(</span><span class="op" id="1470159">&amp;</span><span class="ident" id="1470160">cpuprof</span><span class="op" id="1470167">.</span><span class="ident" id="1470168">wait</span><span class="op" id="1470172">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470177">setcpuprofilerate</span><span class="op" id="1470194">(</span><span class="builtintype" id="1470195">int32</span><span class="op" id="1470200">(</span><span class="ident" id="1470201">hz</span><span class="op" id="1470203">)</span><span class="op" id="1470204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470207">}</span>&nbsp;<span class="keyword" id="1470209">else</span>&nbsp;<span class="keyword" id="1470214">if</span>&nbsp;<span class="ident" id="1470217">cpuprof</span>&nbsp;<span class="op" id="1470225">!=</span>&nbsp;<span class="ident" id="1470228">nil</span>&nbsp;<span class="op" id="1470232">&amp;&amp;</span>&nbsp;<span class="ident" id="1470235">cpuprof</span><span class="op" id="1470242">.</span><span class="ident" id="1470243">on</span>&nbsp;<span class="op" id="1470246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470250">setcpuprofilerate</span><span class="op" id="1470267">(</span><span class="num" id="1470268">0</span><span class="op" id="1470269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470273">cpuprof</span><span class="op" id="1470280">.</span><span class="ident" id="1470281">on</span>&nbsp;<span class="op" id="1470284">=</span>&nbsp;<span class="builtintype" id="1470286">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1470295">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1470368">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470427">for</span>&nbsp;<span class="op" id="1470431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470436">n</span>&nbsp;<span class="op" id="1470438">:=</span>&nbsp;<span class="ident" id="1470441">cpuprof</span><span class="op" id="1470448">.</span><span class="ident" id="1470449">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470460">if</span>&nbsp;<span class="ident" id="1470463">n</span><span class="op" id="1470464">&amp;</span><span class="num" id="1470465">0x80000000</span>&nbsp;<span class="op" id="1470476">!=</span>&nbsp;<span class="num" id="1470479">0</span>&nbsp;<span class="op" id="1470481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1470487">print</span><span class="op" id="1470492">(</span><span class="string" id="1470493">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1470530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470540">if</span>&nbsp;<span class="ident" id="1470543">cas</span><span class="op" id="1470546">(</span><span class="op" id="1470547">&amp;</span><span class="ident" id="1470548">cpuprof</span><span class="op" id="1470555">.</span><span class="ident" id="1470556">handoff</span><span class="op" id="1470563">,</span>&nbsp;<span class="ident" id="1470565">n</span><span class="op" id="1470566">,</span>&nbsp;<span class="ident" id="1470568">n</span><span class="op" id="1470569">|</span><span class="num" id="1470570">0x80000000</span><span class="op" id="1470580">)</span>&nbsp;<span class="op" id="1470582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470588">if</span>&nbsp;<span class="ident" id="1470591">n</span>&nbsp;<span class="op" id="1470593">==</span>&nbsp;<span class="num" id="1470596">0</span>&nbsp;<span class="op" id="1470598">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1470605">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470675">notewakeup</span><span class="op" id="1470685">(</span><span class="op" id="1470686">&amp;</span><span class="ident" id="1470687">cpuprof</span><span class="op" id="1470694">.</span><span class="ident" id="1470695">wait</span><span class="op" id="1470699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470711">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470720">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470730">unlock</span><span class="op" id="1470736">(</span><span class="op" id="1470737">&amp;</span><span class="ident" id="1470738">cpuprofLock</span><span class="op" id="1470749">)</span><br>
<span class="lineno"></span><span class="op" id="1470751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1470754">func</span>&nbsp;<span class="ident" id="1470759">cpuproftick</span><span class="op" id="1470770">(</span><span class="ident" id="1470771">pc</span>&nbsp;<span class="op" id="1470774">*</span><span class="builtintype" id="1470775">uintptr</span><span class="op" id="1470782">,</span>&nbsp;<span class="ident" id="1470784">n</span>&nbsp;<span class="builtintype" id="1470786">int32</span><span class="op" id="1470791">)</span>&nbsp;<span class="op" id="1470793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470796">if</span>&nbsp;<span class="ident" id="1470799">n</span>&nbsp;<span class="op" id="1470801">&gt;</span>&nbsp;<span class="ident" id="1470803">maxCPUProfStack</span>&nbsp;<span class="op" id="1470819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470823">n</span>&nbsp;<span class="op" id="1470825">=</span>&nbsp;<span class="ident" id="1470827">maxCPUProfStack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470847">s</span>&nbsp;<span class="op" id="1470849">:=</span>&nbsp;<span class="op" id="1470852">(</span><span class="op" id="1470853">*</span><span class="op" id="1470854">[</span><span class="ident" id="1470855">maxCPUProfStack</span><span class="op" id="1470870">]</span><span class="builtintype" id="1470871">uintptr</span><span class="op" id="1470878">)</span><span class="op" id="1470879">(</span><span class="ident" id="1470880">unsafe</span><span class="op" id="1470886">.</span><span class="ident" id="1470887">Pointer</span><span class="op" id="1470894">(</span><span class="ident" id="1470895">pc</span><span class="op" id="1470897">)</span><span class="op" id="1470898">)</span><span class="op" id="1470899">[</span><span class="op" id="1470900">:</span><span class="ident" id="1470901">n</span><span class="op" id="1470902">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470905">cpuprof</span><span class="op" id="1470912">.</span><span class="ident" id="1470913">add</span><span class="op" id="1470916">(</span><span class="ident" id="1470917">s</span><span class="op" id="1470918">)</span><br>
<span class="lineno"></span><span class="op" id="1470920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1470923">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1470967">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1471035">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1471096">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1471166">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1471209">func</span>&nbsp;<span class="op" id="1471214">(</span><span class="ident" id="1471215">p</span>&nbsp;<span class="op" id="1471217">*</span><span class="ident" id="1471218">cpuProfile</span><span class="op" id="1471228">)</span>&nbsp;<span class="ident" id="1471230">add</span><span class="op" id="1471233">(</span><span class="ident" id="1471234">pc</span>&nbsp;<span class="op" id="1471237">[</span><span class="op" id="1471238">]</span><span class="builtintype" id="1471239">uintptr</span><span class="op" id="1471246">)</span>&nbsp;<span class="op" id="1471248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1471251">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471269">h</span>&nbsp;<span class="op" id="1471271">:=</span>&nbsp;<span class="builtintype" id="1471274">uintptr</span><span class="op" id="1471281">(</span><span class="num" id="1471282">0</span><span class="op" id="1471283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471286">for</span>&nbsp;<span class="ident" id="1471290">_</span><span class="op" id="1471291">,</span>&nbsp;<span class="ident" id="1471293">x</span>&nbsp;<span class="op" id="1471295">:=</span>&nbsp;<span class="keyword" id="1471298">range</span>&nbsp;<span class="ident" id="1471304">pc</span>&nbsp;<span class="op" id="1471307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471311">h</span>&nbsp;<span class="op" id="1471313">=</span>&nbsp;<span class="ident" id="1471315">h</span><span class="op" id="1471316">&lt;&lt;</span><span class="num" id="1471318">8</span>&nbsp;<span class="op" id="1471320">|</span>&nbsp;<span class="op" id="1471322">(</span><span class="ident" id="1471323">h</span>&nbsp;<span class="op" id="1471325">&gt;&gt;</span>&nbsp;<span class="op" id="1471328">(</span><span class="num" id="1471329">8</span>&nbsp;<span class="op" id="1471331">*</span>&nbsp;<span class="op" id="1471333">(</span><span class="ident" id="1471334">unsafe</span><span class="op" id="1471340">.</span><span class="ident" id="1471341">Sizeof</span><span class="op" id="1471347">(</span><span class="ident" id="1471348">h</span><span class="op" id="1471349">)</span>&nbsp;<span class="op" id="1471351">-</span>&nbsp;<span class="num" id="1471353">1</span><span class="op" id="1471354">)</span><span class="op" id="1471355">)</span><span class="op" id="1471356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471360">h</span>&nbsp;<span class="op" id="1471362">+=</span>&nbsp;<span class="ident" id="1471365">x</span><span class="op" id="1471366">*</span><span class="num" id="1471367">31</span>&nbsp;<span class="op" id="1471370">+</span>&nbsp;<span class="ident" id="1471372">x</span><span class="op" id="1471373">*</span><span class="num" id="1471374">7</span>&nbsp;<span class="op" id="1471376">+</span>&nbsp;<span class="ident" id="1471378">x</span><span class="op" id="1471379">*</span><span class="num" id="1471380">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471383">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471386">p</span><span class="op" id="1471387">.</span><span class="ident" id="1471388">count</span><span class="op" id="1471393">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1471398">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471450">b</span>&nbsp;<span class="op" id="1471452">:=</span>&nbsp;<span class="op" id="1471455">&amp;</span><span class="ident" id="1471456">p</span><span class="op" id="1471457">.</span><span class="ident" id="1471458">hash</span><span class="op" id="1471462">[</span><span class="ident" id="1471463">h</span><span class="op" id="1471464">%</span><span class="ident" id="1471465">numBuckets</span><span class="op" id="1471475">]</span><br>
<span class="lineno"></span><span class="ident" id="1471477">Assoc</span><span class="op" id="1471482">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471485">for</span>&nbsp;<span class="ident" id="1471489">i</span>&nbsp;<span class="op" id="1471491">:=</span>&nbsp;<span class="keyword" id="1471494">range</span>&nbsp;<span class="ident" id="1471500">b</span><span class="op" id="1471501">.</span><span class="ident" id="1471502">entry</span>&nbsp;<span class="op" id="1471508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471512">e</span>&nbsp;<span class="op" id="1471514">:=</span>&nbsp;<span class="op" id="1471517">&amp;</span><span class="ident" id="1471518">b</span><span class="op" id="1471519">.</span><span class="ident" id="1471520">entry</span><span class="op" id="1471525">[</span><span class="ident" id="1471526">i</span><span class="op" id="1471527">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471531">if</span>&nbsp;<span class="ident" id="1471534">e</span><span class="op" id="1471535">.</span><span class="ident" id="1471536">depth</span>&nbsp;<span class="op" id="1471542">!=</span>&nbsp;<span class="builtintype" id="1471545">uintptr</span><span class="op" id="1471552">(</span><span class="builtinfunc" id="1471553">len</span><span class="op" id="1471556">(</span><span class="ident" id="1471557">pc</span><span class="op" id="1471559">)</span><span class="op" id="1471560">)</span>&nbsp;<span class="op" id="1471562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471567">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471578">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471582">for</span>&nbsp;<span class="ident" id="1471586">j</span>&nbsp;<span class="op" id="1471588">:=</span>&nbsp;<span class="keyword" id="1471591">range</span>&nbsp;<span class="ident" id="1471597">pc</span>&nbsp;<span class="op" id="1471600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471605">if</span>&nbsp;<span class="ident" id="1471608">e</span><span class="op" id="1471609">.</span><span class="ident" id="1471610">stack</span><span class="op" id="1471615">[</span><span class="ident" id="1471616">j</span><span class="op" id="1471617">]</span>&nbsp;<span class="op" id="1471619">!=</span>&nbsp;<span class="ident" id="1471622">pc</span><span class="op" id="1471624">[</span><span class="ident" id="1471625">j</span><span class="op" id="1471626">]</span>&nbsp;<span class="op" id="1471628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471634">continue</span>&nbsp;<span class="ident" id="1471643">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471656">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471660">e</span><span class="op" id="1471661">.</span><span class="ident" id="1471662">count</span><span class="op" id="1471667">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471672">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1471684">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471721">var</span>&nbsp;<span class="ident" id="1471725">e</span>&nbsp;<span class="op" id="1471727">*</span><span class="ident" id="1471728">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471742">for</span>&nbsp;<span class="ident" id="1471746">i</span>&nbsp;<span class="op" id="1471748">:=</span>&nbsp;<span class="keyword" id="1471751">range</span>&nbsp;<span class="ident" id="1471757">b</span><span class="op" id="1471758">.</span><span class="ident" id="1471759">entry</span>&nbsp;<span class="op" id="1471765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471769">if</span>&nbsp;<span class="ident" id="1471772">e</span>&nbsp;<span class="op" id="1471774">==</span>&nbsp;<span class="ident" id="1471777">nil</span>&nbsp;<span class="op" id="1471781">||</span>&nbsp;<span class="ident" id="1471784">b</span><span class="op" id="1471785">.</span><span class="ident" id="1471786">entry</span><span class="op" id="1471791">[</span><span class="ident" id="1471792">i</span><span class="op" id="1471793">]</span><span class="op" id="1471794">.</span><span class="ident" id="1471795">count</span>&nbsp;<span class="op" id="1471801">&lt;</span>&nbsp;<span class="ident" id="1471803">e</span><span class="op" id="1471804">.</span><span class="ident" id="1471805">count</span>&nbsp;<span class="op" id="1471811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471816">e</span>&nbsp;<span class="op" id="1471818">=</span>&nbsp;<span class="op" id="1471820">&amp;</span><span class="ident" id="1471821">b</span><span class="op" id="1471822">.</span><span class="ident" id="1471823">entry</span><span class="op" id="1471828">[</span><span class="ident" id="1471829">i</span><span class="op" id="1471830">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471834">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471840">if</span>&nbsp;<span class="ident" id="1471843">e</span><span class="op" id="1471844">.</span><span class="ident" id="1471845">count</span>&nbsp;<span class="op" id="1471851">&gt;</span>&nbsp;<span class="num" id="1471853">0</span>&nbsp;<span class="op" id="1471855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471859">if</span>&nbsp;<span class="op" id="1471862">!</span><span class="ident" id="1471863">p</span><span class="op" id="1471864">.</span><span class="ident" id="1471865">evict</span><span class="op" id="1471870">(</span><span class="ident" id="1471871">e</span><span class="op" id="1471872">)</span>&nbsp;<span class="op" id="1471874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1471879">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471928">p</span><span class="op" id="1471929">.</span><span class="ident" id="1471930">lost</span><span class="op" id="1471934">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471940">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471953">p</span><span class="op" id="1471954">.</span><span class="ident" id="1471955">evicts</span><span class="op" id="1471961">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1471969">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472004">e</span><span class="op" id="1472005">.</span><span class="ident" id="1472006">depth</span>&nbsp;<span class="op" id="1472012">=</span>&nbsp;<span class="builtintype" id="1472014">uintptr</span><span class="op" id="1472021">(</span><span class="builtinfunc" id="1472022">len</span><span class="op" id="1472025">(</span><span class="ident" id="1472026">pc</span><span class="op" id="1472028">)</span><span class="op" id="1472029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472032">e</span><span class="op" id="1472033">.</span><span class="ident" id="1472034">count</span>&nbsp;<span class="op" id="1472040">=</span>&nbsp;<span class="num" id="1472042">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1472045">copy</span><span class="op" id="1472049">(</span><span class="ident" id="1472050">e</span><span class="op" id="1472051">.</span><span class="ident" id="1472052">stack</span><span class="op" id="1472057">[</span><span class="op" id="1472058">:</span><span class="op" id="1472059">]</span><span class="op" id="1472060">,</span>&nbsp;<span class="ident" id="1472062">pc</span><span class="op" id="1472064">)</span><br>
<span class="lineno"></span><span class="op" id="1472066">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1472069">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1472130">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1472191">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1472254">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1472313">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1472371">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1472412">func</span>&nbsp;<span class="op" id="1472417">(</span><span class="ident" id="1472418">p</span>&nbsp;<span class="op" id="1472420">*</span><span class="ident" id="1472421">cpuProfile</span><span class="op" id="1472431">)</span>&nbsp;<span class="ident" id="1472433">evict</span><span class="op" id="1472438">(</span><span class="ident" id="1472439">e</span>&nbsp;<span class="op" id="1472441">*</span><span class="ident" id="1472442">cpuprofEntry</span><span class="op" id="1472454">)</span>&nbsp;<span class="builtintype" id="1472456">bool</span>&nbsp;<span class="op" id="1472461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472464">d</span>&nbsp;<span class="op" id="1472466">:=</span>&nbsp;<span class="ident" id="1472469">e</span><span class="op" id="1472470">.</span><span class="ident" id="1472471">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472478">nslot</span>&nbsp;<span class="op" id="1472484">:=</span>&nbsp;<span class="ident" id="1472487">d</span>&nbsp;<span class="op" id="1472489">+</span>&nbsp;<span class="num" id="1472491">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472494">log</span>&nbsp;<span class="op" id="1472498">:=</span>&nbsp;<span class="op" id="1472501">&amp;</span><span class="ident" id="1472502">p</span><span class="op" id="1472503">.</span><span class="ident" id="1472504">log</span><span class="op" id="1472507">[</span><span class="ident" id="1472508">p</span><span class="op" id="1472509">.</span><span class="ident" id="1472510">toggle</span><span class="op" id="1472516">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472519">if</span>&nbsp;<span class="ident" id="1472522">p</span><span class="op" id="1472523">.</span><span class="ident" id="1472524">nlog</span><span class="op" id="1472528">+</span><span class="ident" id="1472529">nslot</span>&nbsp;<span class="op" id="1472535">&gt;</span>&nbsp;<span class="builtintype" id="1472537">uintptr</span><span class="op" id="1472544">(</span><span class="builtinfunc" id="1472545">len</span><span class="op" id="1472548">(</span><span class="ident" id="1472549">p</span><span class="op" id="1472550">.</span><span class="ident" id="1472551">log</span><span class="op" id="1472554">[</span><span class="num" id="1472555">0</span><span class="op" id="1472556">]</span><span class="op" id="1472557">)</span><span class="op" id="1472558">)</span>&nbsp;<span class="op" id="1472560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472564">if</span>&nbsp;<span class="op" id="1472567">!</span><span class="ident" id="1472568">p</span><span class="op" id="1472569">.</span><span class="ident" id="1472570">flushlog</span><span class="op" id="1472578">(</span><span class="op" id="1472579">)</span>&nbsp;<span class="op" id="1472581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472586">return</span>&nbsp;<span class="builtintype" id="1472593">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1472601">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472605">log</span>&nbsp;<span class="op" id="1472609">=</span>&nbsp;<span class="op" id="1472611">&amp;</span><span class="ident" id="1472612">p</span><span class="op" id="1472613">.</span><span class="ident" id="1472614">log</span><span class="op" id="1472617">[</span><span class="ident" id="1472618">p</span><span class="op" id="1472619">.</span><span class="ident" id="1472620">toggle</span><span class="op" id="1472626">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1472629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472633">q</span>&nbsp;<span class="op" id="1472635">:=</span>&nbsp;<span class="ident" id="1472638">p</span><span class="op" id="1472639">.</span><span class="ident" id="1472640">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472646">log</span><span class="op" id="1472649">[</span><span class="ident" id="1472650">q</span><span class="op" id="1472651">]</span>&nbsp;<span class="op" id="1472653">=</span>&nbsp;<span class="ident" id="1472655">e</span><span class="op" id="1472656">.</span><span class="ident" id="1472657">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472664">q</span><span class="op" id="1472665">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472669">log</span><span class="op" id="1472672">[</span><span class="ident" id="1472673">q</span><span class="op" id="1472674">]</span>&nbsp;<span class="op" id="1472676">=</span>&nbsp;<span class="ident" id="1472678">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472681">q</span><span class="op" id="1472682">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1472686">copy</span><span class="op" id="1472690">(</span><span class="ident" id="1472691">log</span><span class="op" id="1472694">[</span><span class="ident" id="1472695">q</span><span class="op" id="1472696">:</span><span class="op" id="1472697">]</span><span class="op" id="1472698">,</span>&nbsp;<span class="ident" id="1472700">e</span><span class="op" id="1472701">.</span><span class="ident" id="1472702">stack</span><span class="op" id="1472707">[</span><span class="op" id="1472708">:</span><span class="ident" id="1472709">d</span><span class="op" id="1472710">]</span><span class="op" id="1472711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472714">q</span>&nbsp;<span class="op" id="1472716">+=</span>&nbsp;<span class="ident" id="1472719">d</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472722">p</span><span class="op" id="1472723">.</span><span class="ident" id="1472724">nlog</span>&nbsp;<span class="op" id="1472729">=</span>&nbsp;<span class="ident" id="1472731">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472734">e</span><span class="op" id="1472735">.</span><span class="ident" id="1472736">count</span>&nbsp;<span class="op" id="1472742">=</span>&nbsp;<span class="num" id="1472744">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472747">return</span>&nbsp;<span class="builtintype" id="1472754">true</span><br>
<span class="lineno"></span><span class="op" id="1472759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1472762">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1472834">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1472917">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1472989">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1473068">func</span>&nbsp;<span class="op" id="1473073">(</span><span class="ident" id="1473074">p</span>&nbsp;<span class="op" id="1473076">*</span><span class="ident" id="1473077">cpuProfile</span><span class="op" id="1473087">)</span>&nbsp;<span class="ident" id="1473089">flushlog</span><span class="op" id="1473097">(</span><span class="op" id="1473098">)</span>&nbsp;<span class="builtintype" id="1473100">bool</span>&nbsp;<span class="op" id="1473105">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473108">if</span>&nbsp;<span class="op" id="1473111">!</span><span class="ident" id="1473112">cas</span><span class="op" id="1473115">(</span><span class="op" id="1473116">&amp;</span><span class="ident" id="1473117">p</span><span class="op" id="1473118">.</span><span class="ident" id="1473119">handoff</span><span class="op" id="1473126">,</span>&nbsp;<span class="num" id="1473128">0</span><span class="op" id="1473129">,</span>&nbsp;<span class="builtintype" id="1473131">uint32</span><span class="op" id="1473137">(</span><span class="ident" id="1473138">p</span><span class="op" id="1473139">.</span><span class="ident" id="1473140">nlog</span><span class="op" id="1473144">)</span><span class="op" id="1473145">)</span>&nbsp;<span class="op" id="1473147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473151">return</span>&nbsp;<span class="builtintype" id="1473158">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1473165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473168">notewakeup</span><span class="op" id="1473178">(</span><span class="op" id="1473179">&amp;</span><span class="ident" id="1473180">p</span><span class="op" id="1473181">.</span><span class="ident" id="1473182">wait</span><span class="op" id="1473186">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473190">p</span><span class="op" id="1473191">.</span><span class="ident" id="1473192">toggle</span>&nbsp;<span class="op" id="1473199">=</span>&nbsp;<span class="num" id="1473201">1</span>&nbsp;<span class="op" id="1473203">-</span>&nbsp;<span class="ident" id="1473205">p</span><span class="op" id="1473206">.</span><span class="ident" id="1473207">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473215">log</span>&nbsp;<span class="op" id="1473219">:=</span>&nbsp;<span class="op" id="1473222">&amp;</span><span class="ident" id="1473223">p</span><span class="op" id="1473224">.</span><span class="ident" id="1473225">log</span><span class="op" id="1473228">[</span><span class="ident" id="1473229">p</span><span class="op" id="1473230">.</span><span class="ident" id="1473231">toggle</span><span class="op" id="1473237">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473240">q</span>&nbsp;<span class="op" id="1473242">:=</span>&nbsp;<span class="builtintype" id="1473245">uintptr</span><span class="op" id="1473252">(</span><span class="num" id="1473253">0</span><span class="op" id="1473254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473257">if</span>&nbsp;<span class="ident" id="1473260">p</span><span class="op" id="1473261">.</span><span class="ident" id="1473262">lost</span>&nbsp;<span class="op" id="1473267">&gt;</span>&nbsp;<span class="num" id="1473269">0</span>&nbsp;<span class="op" id="1473271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473275">lostPC</span>&nbsp;<span class="op" id="1473282">:=</span>&nbsp;<span class="ident" id="1473285">funcPC</span><span class="op" id="1473291">(</span><span class="ident" id="1473292">lostProfileData</span><span class="op" id="1473307">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473311">log</span><span class="op" id="1473314">[</span><span class="num" id="1473315">0</span><span class="op" id="1473316">]</span>&nbsp;<span class="op" id="1473318">=</span>&nbsp;<span class="ident" id="1473320">p</span><span class="op" id="1473321">.</span><span class="ident" id="1473322">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473329">log</span><span class="op" id="1473332">[</span><span class="num" id="1473333">1</span><span class="op" id="1473334">]</span>&nbsp;<span class="op" id="1473336">=</span>&nbsp;<span class="num" id="1473338">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473342">log</span><span class="op" id="1473345">[</span><span class="num" id="1473346">2</span><span class="op" id="1473347">]</span>&nbsp;<span class="op" id="1473349">=</span>&nbsp;<span class="ident" id="1473351">lostPC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473360">q</span>&nbsp;<span class="op" id="1473362">=</span>&nbsp;<span class="num" id="1473364">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473368">p</span><span class="op" id="1473369">.</span><span class="ident" id="1473370">lost</span>&nbsp;<span class="op" id="1473375">=</span>&nbsp;<span class="num" id="1473377">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1473380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473383">p</span><span class="op" id="1473384">.</span><span class="ident" id="1473385">nlog</span>&nbsp;<span class="op" id="1473390">=</span>&nbsp;<span class="ident" id="1473392">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473395">return</span>&nbsp;<span class="builtintype" id="1473402">true</span><br>
<span class="lineno"></span><span class="op" id="1473407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1473410">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1473483">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1473556">func</span>&nbsp;<span class="op" id="1473561">(</span><span class="ident" id="1473562">p</span>&nbsp;<span class="op" id="1473564">*</span><span class="ident" id="1473565">cpuProfile</span><span class="op" id="1473575">)</span>&nbsp;<span class="ident" id="1473577">getprofile</span><span class="op" id="1473587">(</span><span class="op" id="1473588">)</span>&nbsp;<span class="op" id="1473590">[</span><span class="op" id="1473591">]</span><span class="builtintype" id="1473592">byte</span>&nbsp;<span class="op" id="1473597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473600">if</span>&nbsp;<span class="ident" id="1473603">p</span>&nbsp;<span class="op" id="1473605">==</span>&nbsp;<span class="ident" id="1473608">nil</span>&nbsp;<span class="op" id="1473612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473616">return</span>&nbsp;<span class="ident" id="1473623">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1473628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473632">if</span>&nbsp;<span class="ident" id="1473635">p</span><span class="op" id="1473636">.</span><span class="ident" id="1473637">wholding</span>&nbsp;<span class="op" id="1473646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1473650">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1473701">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473763">for</span>&nbsp;<span class="op" id="1473767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473772">n</span>&nbsp;<span class="op" id="1473774">:=</span>&nbsp;<span class="ident" id="1473777">p</span><span class="op" id="1473778">.</span><span class="ident" id="1473779">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473790">if</span>&nbsp;<span class="ident" id="1473793">n</span>&nbsp;<span class="op" id="1473795">==</span>&nbsp;<span class="num" id="1473798">0</span>&nbsp;<span class="op" id="1473800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1473806">print</span><span class="op" id="1473811">(</span><span class="string" id="1473812">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1473863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473869">return</span>&nbsp;<span class="ident" id="1473876">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1473883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473888">if</span>&nbsp;<span class="ident" id="1473891">n</span><span class="op" id="1473892">&amp;</span><span class="num" id="1473893">0x80000000</span>&nbsp;<span class="op" id="1473904">!=</span>&nbsp;<span class="num" id="1473907">0</span>&nbsp;<span class="op" id="1473909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473915">p</span><span class="op" id="1473916">.</span><span class="ident" id="1473917">wtoggle</span>&nbsp;<span class="op" id="1473925">=</span>&nbsp;<span class="num" id="1473927">1</span>&nbsp;<span class="op" id="1473929">-</span>&nbsp;<span class="ident" id="1473931">p</span><span class="op" id="1473932">.</span><span class="ident" id="1473933">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473945">p</span><span class="op" id="1473946">.</span><span class="ident" id="1473947">wholding</span>&nbsp;<span class="op" id="1473956">=</span>&nbsp;<span class="builtintype" id="1473958">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473968">p</span><span class="op" id="1473969">.</span><span class="ident" id="1473970">flushing</span>&nbsp;<span class="op" id="1473979">=</span>&nbsp;<span class="builtintype" id="1473981">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473990">goto</span>&nbsp;<span class="ident" id="1473995">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474009">if</span>&nbsp;<span class="ident" id="1474012">cas</span><span class="op" id="1474015">(</span><span class="op" id="1474016">&amp;</span><span class="ident" id="1474017">p</span><span class="op" id="1474018">.</span><span class="ident" id="1474019">handoff</span><span class="op" id="1474026">,</span>&nbsp;<span class="ident" id="1474028">n</span><span class="op" id="1474029">,</span>&nbsp;<span class="num" id="1474031">0</span><span class="op" id="1474032">)</span>&nbsp;<span class="op" id="1474034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474040">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474049">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474057">p</span><span class="op" id="1474058">.</span><span class="ident" id="1474059">wtoggle</span>&nbsp;<span class="op" id="1474067">=</span>&nbsp;<span class="num" id="1474069">1</span>&nbsp;<span class="op" id="1474071">-</span>&nbsp;<span class="ident" id="1474073">p</span><span class="op" id="1474074">.</span><span class="ident" id="1474075">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474085">p</span><span class="op" id="1474086">.</span><span class="ident" id="1474087">wholding</span>&nbsp;<span class="op" id="1474096">=</span>&nbsp;<span class="builtintype" id="1474098">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474109">if</span>&nbsp;<span class="ident" id="1474112">p</span><span class="op" id="1474113">.</span><span class="ident" id="1474114">flushing</span>&nbsp;<span class="op" id="1474123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474127">goto</span>&nbsp;<span class="ident" id="1474132">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474143">if</span>&nbsp;<span class="op" id="1474146">!</span><span class="ident" id="1474147">p</span><span class="op" id="1474148">.</span><span class="ident" id="1474149">on</span>&nbsp;<span class="op" id="1474152">&amp;&amp;</span>&nbsp;<span class="ident" id="1474155">p</span><span class="op" id="1474156">.</span><span class="ident" id="1474157">handoff</span>&nbsp;<span class="op" id="1474165">==</span>&nbsp;<span class="num" id="1474168">0</span>&nbsp;<span class="op" id="1474170">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474174">return</span>&nbsp;<span class="ident" id="1474181">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1474190">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474212">notetsleepg</span><span class="op" id="1474223">(</span><span class="op" id="1474224">&amp;</span><span class="ident" id="1474225">p</span><span class="op" id="1474226">.</span><span class="ident" id="1474227">wait</span><span class="op" id="1474231">,</span>&nbsp;<span class="op" id="1474233">-</span><span class="num" id="1474234">1</span><span class="op" id="1474235">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474238">noteclear</span><span class="op" id="1474247">(</span><span class="op" id="1474248">&amp;</span><span class="ident" id="1474249">p</span><span class="op" id="1474250">.</span><span class="ident" id="1474251">wait</span><span class="op" id="1474255">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474259">switch</span>&nbsp;<span class="ident" id="1474266">n</span>&nbsp;<span class="op" id="1474268">:=</span>&nbsp;<span class="ident" id="1474271">p</span><span class="op" id="1474272">.</span><span class="ident" id="1474273">handoff</span><span class="op" id="1474280">;</span>&nbsp;<span class="op" id="1474282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474285">case</span>&nbsp;<span class="ident" id="1474290">n</span>&nbsp;<span class="op" id="1474292">==</span>&nbsp;<span class="num" id="1474295">0</span><span class="op" id="1474296">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1474300">print</span><span class="op" id="1474305">(</span><span class="string" id="1474306">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1474354">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474358">return</span>&nbsp;<span class="ident" id="1474365">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474370">case</span>&nbsp;<span class="ident" id="1474375">n</span>&nbsp;<span class="op" id="1474377">==</span>&nbsp;<span class="num" id="1474380">0x80000000</span><span class="op" id="1474390">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474394">p</span><span class="op" id="1474395">.</span><span class="ident" id="1474396">flushing</span>&nbsp;<span class="op" id="1474405">=</span>&nbsp;<span class="builtintype" id="1474407">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474414">goto</span>&nbsp;<span class="ident" id="1474419">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474426">default</span><span class="op" id="1474433">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474437">n</span>&nbsp;<span class="op" id="1474439">&amp;^=</span>&nbsp;<span class="num" id="1474443">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1474457">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474488">p</span><span class="op" id="1474489">.</span><span class="ident" id="1474490">wholding</span>&nbsp;<span class="op" id="1474499">=</span>&nbsp;<span class="builtintype" id="1474501">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474509">return</span>&nbsp;<span class="ident" id="1474516">uintptrBytes</span><span class="op" id="1474528">(</span><span class="ident" id="1474529">p</span><span class="op" id="1474530">.</span><span class="ident" id="1474531">log</span><span class="op" id="1474534">[</span><span class="ident" id="1474535">p</span><span class="op" id="1474536">.</span><span class="ident" id="1474537">wtoggle</span><span class="op" id="1474544">]</span><span class="op" id="1474545">[</span><span class="op" id="1474546">:</span><span class="ident" id="1474547">n</span><span class="op" id="1474548">]</span><span class="op" id="1474549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1474556">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1474575">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1474627">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1474692">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1474744">Flush</span><span class="op" id="1474749">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474752">for</span>&nbsp;<span class="ident" id="1474756">i</span>&nbsp;<span class="op" id="1474758">:=</span>&nbsp;<span class="keyword" id="1474761">range</span>&nbsp;<span class="ident" id="1474767">p</span><span class="op" id="1474768">.</span><span class="ident" id="1474769">hash</span>&nbsp;<span class="op" id="1474774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474778">b</span>&nbsp;<span class="op" id="1474780">:=</span>&nbsp;<span class="op" id="1474783">&amp;</span><span class="ident" id="1474784">p</span><span class="op" id="1474785">.</span><span class="ident" id="1474786">hash</span><span class="op" id="1474790">[</span><span class="ident" id="1474791">i</span><span class="op" id="1474792">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474796">for</span>&nbsp;<span class="ident" id="1474800">j</span>&nbsp;<span class="op" id="1474802">:=</span>&nbsp;<span class="keyword" id="1474805">range</span>&nbsp;<span class="ident" id="1474811">b</span><span class="op" id="1474812">.</span><span class="ident" id="1474813">entry</span>&nbsp;<span class="op" id="1474819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474824">e</span>&nbsp;<span class="op" id="1474826">:=</span>&nbsp;<span class="op" id="1474829">&amp;</span><span class="ident" id="1474830">b</span><span class="op" id="1474831">.</span><span class="ident" id="1474832">entry</span><span class="op" id="1474837">[</span><span class="ident" id="1474838">j</span><span class="op" id="1474839">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474844">if</span>&nbsp;<span class="ident" id="1474847">e</span><span class="op" id="1474848">.</span><span class="ident" id="1474849">count</span>&nbsp;<span class="op" id="1474855">&gt;</span>&nbsp;<span class="num" id="1474857">0</span>&nbsp;<span class="op" id="1474859">&amp;&amp;</span>&nbsp;<span class="op" id="1474862">!</span><span class="ident" id="1474863">p</span><span class="op" id="1474864">.</span><span class="ident" id="1474865">evict</span><span class="op" id="1474870">(</span><span class="ident" id="1474871">e</span><span class="op" id="1474872">)</span>&nbsp;<span class="op" id="1474874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1474880">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474945">break</span>&nbsp;<span class="ident" id="1474951">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1474971">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475000">if</span>&nbsp;<span class="ident" id="1475003">p</span><span class="op" id="1475004">.</span><span class="ident" id="1475005">nlog</span>&nbsp;<span class="op" id="1475010">&gt;</span>&nbsp;<span class="num" id="1475012">0</span>&nbsp;<span class="op" id="1475014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475018">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475070">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475118">n</span>&nbsp;<span class="op" id="1475120">:=</span>&nbsp;<span class="ident" id="1475123">p</span><span class="op" id="1475124">.</span><span class="ident" id="1475125">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475132">p</span><span class="op" id="1475133">.</span><span class="ident" id="1475134">nlog</span>&nbsp;<span class="op" id="1475139">=</span>&nbsp;<span class="num" id="1475141">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475145">return</span>&nbsp;<span class="ident" id="1475152">uintptrBytes</span><span class="op" id="1475164">(</span><span class="ident" id="1475165">p</span><span class="op" id="1475166">.</span><span class="ident" id="1475167">log</span><span class="op" id="1475170">[</span><span class="ident" id="1475171">p</span><span class="op" id="1475172">.</span><span class="ident" id="1475173">toggle</span><span class="op" id="1475179">]</span><span class="op" id="1475180">[</span><span class="op" id="1475181">:</span><span class="ident" id="1475182">n</span><span class="op" id="1475183">]</span><span class="op" id="1475184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1475187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475191">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475254">if</span>&nbsp;<span class="op" id="1475257">!</span><span class="ident" id="1475258">p</span><span class="op" id="1475259">.</span><span class="ident" id="1475260">eodSent</span>&nbsp;<span class="op" id="1475268">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475272">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475338">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475403">p</span><span class="op" id="1475404">.</span><span class="ident" id="1475405">eodSent</span>&nbsp;<span class="op" id="1475413">=</span>&nbsp;<span class="builtintype" id="1475415">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475422">return</span>&nbsp;<span class="ident" id="1475429">uintptrBytes</span><span class="op" id="1475441">(</span><span class="ident" id="1475442">eod</span><span class="op" id="1475445">[</span><span class="op" id="1475446">:</span><span class="op" id="1475447">]</span><span class="op" id="1475448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1475451">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475455">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475499">p</span><span class="op" id="1475500">.</span><span class="ident" id="1475501">flushing</span>&nbsp;<span class="op" id="1475510">=</span>&nbsp;<span class="builtintype" id="1475512">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475519">if</span>&nbsp;<span class="op" id="1475522">!</span><span class="ident" id="1475523">cas</span><span class="op" id="1475526">(</span><span class="op" id="1475527">&amp;</span><span class="ident" id="1475528">p</span><span class="op" id="1475529">.</span><span class="ident" id="1475530">handoff</span><span class="op" id="1475537">,</span>&nbsp;<span class="ident" id="1475539">p</span><span class="op" id="1475540">.</span><span class="ident" id="1475541">handoff</span><span class="op" id="1475548">,</span>&nbsp;<span class="num" id="1475550">0</span><span class="op" id="1475551">)</span>&nbsp;<span class="op" id="1475553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1475557">print</span><span class="op" id="1475562">(</span><span class="string" id="1475563">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1475611">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1475614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475617">return</span>&nbsp;<span class="ident" id="1475624">nil</span><br>
<span class="lineno"></span><span class="op" id="1475628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1475631">func</span>&nbsp;<span class="ident" id="1475636">uintptrBytes</span><span class="op" id="1475648">(</span><span class="ident" id="1475649">p</span>&nbsp;<span class="op" id="1475651">[</span><span class="op" id="1475652">]</span><span class="builtintype" id="1475653">uintptr</span><span class="op" id="1475660">)</span>&nbsp;<span class="op" id="1475662">(</span><span class="ident" id="1475663">ret</span>&nbsp;<span class="op" id="1475667">[</span><span class="op" id="1475668">]</span><span class="builtintype" id="1475669">byte</span><span class="op" id="1475673">)</span>&nbsp;<span class="op" id="1475675">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475678">pp</span>&nbsp;<span class="op" id="1475681">:=</span>&nbsp;<span class="op" id="1475684">(</span><span class="op" id="1475685">*</span><span class="ident" id="1475686">sliceStruct</span><span class="op" id="1475697">)</span><span class="op" id="1475698">(</span><span class="ident" id="1475699">unsafe</span><span class="op" id="1475705">.</span><span class="ident" id="1475706">Pointer</span><span class="op" id="1475713">(</span><span class="op" id="1475714">&amp;</span><span class="ident" id="1475715">p</span><span class="op" id="1475716">)</span><span class="op" id="1475717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475720">rp</span>&nbsp;<span class="op" id="1475723">:=</span>&nbsp;<span class="op" id="1475726">(</span><span class="op" id="1475727">*</span><span class="ident" id="1475728">sliceStruct</span><span class="op" id="1475739">)</span><span class="op" id="1475740">(</span><span class="ident" id="1475741">unsafe</span><span class="op" id="1475747">.</span><span class="ident" id="1475748">Pointer</span><span class="op" id="1475755">(</span><span class="op" id="1475756">&amp;</span><span class="ident" id="1475757">ret</span><span class="op" id="1475760">)</span><span class="op" id="1475761">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475765">rp</span><span class="op" id="1475767">.</span><span class="ident" id="1475768">array</span>&nbsp;<span class="op" id="1475774">=</span>&nbsp;<span class="ident" id="1475776">pp</span><span class="op" id="1475778">.</span><span class="ident" id="1475779">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475786">rp</span><span class="op" id="1475788">.</span><span class="builtinfunc" id="1475789">len</span>&nbsp;<span class="op" id="1475793">=</span>&nbsp;<span class="ident" id="1475795">pp</span><span class="op" id="1475797">.</span><span class="builtinfunc" id="1475798">len</span>&nbsp;<span class="op" id="1475802">*</span>&nbsp;<span class="builtintype" id="1475804">int</span><span class="op" id="1475807">(</span><span class="ident" id="1475808">unsafe</span><span class="op" id="1475814">.</span><span class="ident" id="1475815">Sizeof</span><span class="op" id="1475821">(</span><span class="ident" id="1475822">p</span><span class="op" id="1475823">[</span><span class="num" id="1475824">0</span><span class="op" id="1475825">]</span><span class="op" id="1475826">)</span><span class="op" id="1475827">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475830">rp</span><span class="op" id="1475832">.</span><span class="builtinfunc" id="1475833">cap</span>&nbsp;<span class="op" id="1475837">=</span>&nbsp;<span class="ident" id="1475839">rp</span><span class="op" id="1475841">.</span><span class="builtinfunc" id="1475842">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475848">return</span><br>
<span class="lineno"></span><span class="op" id="1475855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1475858">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1475937">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1476022">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1476101">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1476176">//</span><br>
<span class="lineno">420</span><span class="comment" id="1476179">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1476235">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1476301">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1476325">func</span>&nbsp;<span class="ident" id="1476330">CPUProfile</span><span class="op" id="1476340">(</span><span class="op" id="1476341">)</span>&nbsp;<span class="op" id="1476343">[</span><span class="op" id="1476344">]</span><span class="builtintype" id="1476345">byte</span>&nbsp;<span class="op" id="1476350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476353">return</span>&nbsp;<span class="ident" id="1476360">cpuprof</span><span class="op" id="1476367">.</span><span class="ident" id="1476368">getprofile</span><span class="op" id="1476378">(</span><span class="op" id="1476379">)</span><br>
<span class="lineno">425</span><span class="op" id="1476381">}</span>
</div>
</body>
</html>
