<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5864059">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5864114">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5864168">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5864219">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspPackage&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspnetwork&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspas&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspmethods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspOnly&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspother&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspIn&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbspwhere&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThese&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbspsecond&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspsees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspwill&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptypically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplistener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbspNewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspClient&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspcall,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspparameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplaunches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspstructure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbspUnless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptransport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspHere&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspA,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspQuo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsparith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspl,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspAt&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspclient,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbspThen&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspargs&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspor<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspdivCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreplyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbspclient.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5868048">package</span>&nbsp;<span class="ident" id="5868056">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5868061">import</span>&nbsp;<span class="op" id="5868068">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868071">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868080">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868096">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868106">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868112">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868119">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868126">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868138">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868149">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868160">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868168">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5868179">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5868194">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5868197">const</span>&nbsp;<span class="op" id="5868203">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5868206">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868238">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5868255">=</span>&nbsp;<span class="string" id="5868257">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868269">DefaultDebugPath</span>&nbsp;<span class="op" id="5868286">=</span>&nbsp;<span class="string" id="5868288">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="5868301">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="5868304">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5868372">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="5868441">var</span>&nbsp;<span class="ident" id="5868445">typeOfError</span>&nbsp;<span class="op" id="5868457">=</span>&nbsp;<span class="ident" id="5868459">reflect</span><span class="op" id="5868466">.</span><span class="ident" id="5868467">TypeOf</span><span class="op" id="5868473">(</span><span class="op" id="5868474">(</span><span class="op" id="5868475">*</span><span class="builtintype" id="5868476">error</span><span class="op" id="5868481">)</span><span class="op" id="5868482">(</span><span class="ident" id="5868483">nil</span><span class="op" id="5868486">)</span><span class="op" id="5868487">)</span><span class="op" id="5868488">.</span><span class="ident" id="5868489">Elem</span><span class="op" id="5868493">(</span><span class="op" id="5868494">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5868497">type</span>&nbsp;<span class="ident" id="5868502">methodType</span>&nbsp;<span class="keyword" id="5868513">struct</span>&nbsp;<span class="op" id="5868520">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868523">sync</span><span class="op" id="5868527">.</span><span class="ident" id="5868528">Mutex</span>&nbsp;<span class="comment" id="5868534">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868556">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868567">reflect</span><span class="op" id="5868574">.</span><span class="ident" id="5868575">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868583">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868594">reflect</span><span class="op" id="5868601">.</span><span class="ident" id="5868602">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868608">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="5868619">reflect</span><span class="op" id="5868626">.</span><span class="ident" id="5868627">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868633">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5868644">uint</span><br>
<span class="lineno">155</span><span class="op" id="5868649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5868652">type</span>&nbsp;<span class="ident" id="5868657">service</span>&nbsp;<span class="keyword" id="5868665">struct</span>&nbsp;<span class="op" id="5868672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868675">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5868682">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5868705">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868725">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5868732">reflect</span><span class="op" id="5868739">.</span><span class="ident" id="5868740">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5868755">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868795">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868802">reflect</span><span class="op" id="5868809">.</span><span class="ident" id="5868810">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5868825">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5868850">method</span>&nbsp;<span class="keyword" id="5868857">map</span><span class="op" id="5868860">[</span><span class="builtintype" id="5868861">string</span><span class="op" id="5868867">]</span><span class="op" id="5868868">*</span><span class="ident" id="5868869">methodType</span>&nbsp;<span class="comment" id="5868880">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="5868902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5868905">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="5868982">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="5869052">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5869072">type</span>&nbsp;<span class="ident" id="5869077">Request</span>&nbsp;<span class="keyword" id="5869085">struct</span>&nbsp;<span class="op" id="5869092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869095">ServiceMethod</span>&nbsp;<span class="builtintype" id="5869109">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5869118">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869147">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869161">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5869170">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869207">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869221">*</span><span class="ident" id="5869222">Request</span>&nbsp;<span class="comment" id="5869230">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5869257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5869260">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="5869340">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="5869410">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5869430">type</span>&nbsp;<span class="ident" id="5869435">Response</span>&nbsp;<span class="keyword" id="5869444">struct</span>&nbsp;<span class="op" id="5869451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869454">ServiceMethod</span>&nbsp;<span class="builtintype" id="5869468">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5869478">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869509">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869523">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5869533">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869564">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5869578">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5869588">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869607">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869621">*</span><span class="ident" id="5869622">Response</span>&nbsp;<span class="comment" id="5869631">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5869658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5869661">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5869697">type</span>&nbsp;<span class="ident" id="5869702">Server</span>&nbsp;<span class="keyword" id="5869709">struct</span>&nbsp;<span class="op" id="5869716">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869719">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869730">sync</span><span class="op" id="5869734">.</span><span class="ident" id="5869735">RWMutex</span>&nbsp;<span class="comment" id="5869743">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869771">serviceMap</span>&nbsp;<span class="keyword" id="5869782">map</span><span class="op" id="5869785">[</span><span class="builtintype" id="5869786">string</span><span class="op" id="5869792">]</span><span class="op" id="5869793">*</span><span class="ident" id="5869794">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869803">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869814">sync</span><span class="op" id="5869818">.</span><span class="ident" id="5869819">Mutex</span>&nbsp;<span class="comment" id="5869825">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869846">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869857">*</span><span class="ident" id="5869858">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869867">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5869878">sync</span><span class="op" id="5869882">.</span><span class="ident" id="5869883">Mutex</span>&nbsp;<span class="comment" id="5869889">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5869911">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5869922">*</span><span class="ident" id="5869923">Response</span><br>
<span class="lineno"></span><span class="op" id="5869932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5869935">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5869970">func</span>&nbsp;<span class="ident" id="5869975">NewServer</span><span class="op" id="5869984">(</span><span class="op" id="5869985">)</span>&nbsp;<span class="op" id="5869987">*</span><span class="ident" id="5869988">Server</span>&nbsp;<span class="op" id="5869995">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5869998">return</span>&nbsp;<span class="op" id="5870005">&amp;</span><span class="ident" id="5870006">Server</span><span class="op" id="5870012">{</span><span class="ident" id="5870013">serviceMap</span><span class="op" id="5870023">:</span>&nbsp;<span class="builtinfunc" id="5870025">make</span><span class="op" id="5870029">(</span><span class="keyword" id="5870030">map</span><span class="op" id="5870033">[</span><span class="builtintype" id="5870034">string</span><span class="op" id="5870040">]</span><span class="op" id="5870041">*</span><span class="ident" id="5870042">service</span><span class="op" id="5870049">)</span><span class="op" id="5870050">}</span><br>
<span class="lineno"></span><span class="op" id="5870052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5870055">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5870108">var</span>&nbsp;<span class="ident" id="5870112">DefaultServer</span>&nbsp;<span class="op" id="5870126">=</span>&nbsp;<span class="ident" id="5870128">NewServer</span><span class="op" id="5870137">(</span><span class="op" id="5870138">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5870141">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="5870185">func</span>&nbsp;<span class="ident" id="5870190">isExported</span><span class="op" id="5870200">(</span><span class="ident" id="5870201">name</span>&nbsp;<span class="builtintype" id="5870206">string</span><span class="op" id="5870212">)</span>&nbsp;<span class="builtintype" id="5870214">bool</span>&nbsp;<span class="op" id="5870219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5870222">rune</span><span class="op" id="5870226">,</span>&nbsp;<span class="ident" id="5870228">_</span>&nbsp;<span class="op" id="5870230">:=</span>&nbsp;<span class="ident" id="5870233">utf8</span><span class="op" id="5870237">.</span><span class="ident" id="5870238">DecodeRuneInString</span><span class="op" id="5870256">(</span><span class="ident" id="5870257">name</span><span class="op" id="5870261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870264">return</span>&nbsp;<span class="ident" id="5870271">unicode</span><span class="op" id="5870278">.</span><span class="ident" id="5870279">IsUpper</span><span class="op" id="5870286">(</span><span class="builtintype" id="5870287">rune</span><span class="op" id="5870291">)</span><br>
<span class="lineno">205</span><span class="op" id="5870293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5870296">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="5870335">func</span>&nbsp;<span class="ident" id="5870340">isExportedOrBuiltinType</span><span class="op" id="5870363">(</span><span class="ident" id="5870364">t</span>&nbsp;<span class="ident" id="5870366">reflect</span><span class="op" id="5870373">.</span><span class="ident" id="5870374">Type</span><span class="op" id="5870378">)</span>&nbsp;<span class="builtintype" id="5870380">bool</span>&nbsp;<span class="op" id="5870385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870388">for</span>&nbsp;<span class="ident" id="5870392">t</span><span class="op" id="5870393">.</span><span class="ident" id="5870394">Kind</span><span class="op" id="5870398">(</span><span class="op" id="5870399">)</span>&nbsp;<span class="op" id="5870401">==</span>&nbsp;<span class="ident" id="5870404">reflect</span><span class="op" id="5870411">.</span><span class="ident" id="5870412">Ptr</span>&nbsp;<span class="op" id="5870416">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5870420">t</span>&nbsp;<span class="op" id="5870422">=</span>&nbsp;<span class="ident" id="5870424">t</span><span class="op" id="5870425">.</span><span class="ident" id="5870426">Elem</span><span class="op" id="5870430">(</span><span class="op" id="5870431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5870434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5870437">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5870494">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5870541">return</span>&nbsp;<span class="ident" id="5870548">isExported</span><span class="op" id="5870558">(</span><span class="ident" id="5870559">t</span><span class="op" id="5870560">.</span><span class="ident" id="5870561">Name</span><span class="op" id="5870565">(</span><span class="op" id="5870566">)</span><span class="op" id="5870567">)</span>&nbsp;<span class="op" id="5870569">||</span>&nbsp;<span class="ident" id="5870572">t</span><span class="op" id="5870573">.</span><span class="ident" id="5870574">PkgPath</span><span class="op" id="5870581">(</span><span class="op" id="5870582">)</span>&nbsp;<span class="op" id="5870584">==</span>&nbsp;<span class="string" id="5870587">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="5870590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5870593">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5870655">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="5870712">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="5870733">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5870775">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="5870813">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5870850">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5870920">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="5870986">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5871063">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5871110">func</span>&nbsp;<span class="op" id="5871115">(</span><span class="ident" id="5871116">server</span>&nbsp;<span class="op" id="5871123">*</span><span class="ident" id="5871124">Server</span><span class="op" id="5871130">)</span>&nbsp;<span class="ident" id="5871132">Register</span><span class="op" id="5871140">(</span><span class="ident" id="5871141">rcvr</span>&nbsp;<span class="keyword" id="5871146">interface</span><span class="op" id="5871155">{</span><span class="op" id="5871156">}</span><span class="op" id="5871157">)</span>&nbsp;<span class="builtintype" id="5871159">error</span>&nbsp;<span class="op" id="5871165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871168">return</span>&nbsp;<span class="ident" id="5871175">server</span><span class="op" id="5871181">.</span><span class="ident" id="5871182">register</span><span class="op" id="5871190">(</span><span class="ident" id="5871191">rcvr</span><span class="op" id="5871195">,</span>&nbsp;<span class="string" id="5871197">&#34;&#34;</span><span class="op" id="5871199">,</span>&nbsp;<span class="builtintype" id="5871201">false</span><span class="op" id="5871206">)</span><br>
<span class="lineno"></span><span class="op" id="5871208">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5871211">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5871284">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5871328">func</span>&nbsp;<span class="op" id="5871333">(</span><span class="ident" id="5871334">server</span>&nbsp;<span class="op" id="5871341">*</span><span class="ident" id="5871342">Server</span><span class="op" id="5871348">)</span>&nbsp;<span class="ident" id="5871350">RegisterName</span><span class="op" id="5871362">(</span><span class="ident" id="5871363">name</span>&nbsp;<span class="builtintype" id="5871368">string</span><span class="op" id="5871374">,</span>&nbsp;<span class="ident" id="5871376">rcvr</span>&nbsp;<span class="keyword" id="5871381">interface</span><span class="op" id="5871390">{</span><span class="op" id="5871391">}</span><span class="op" id="5871392">)</span>&nbsp;<span class="builtintype" id="5871394">error</span>&nbsp;<span class="op" id="5871400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871403">return</span>&nbsp;<span class="ident" id="5871410">server</span><span class="op" id="5871416">.</span><span class="ident" id="5871417">register</span><span class="op" id="5871425">(</span><span class="ident" id="5871426">rcvr</span><span class="op" id="5871430">,</span>&nbsp;<span class="ident" id="5871432">name</span><span class="op" id="5871436">,</span>&nbsp;<span class="builtintype" id="5871438">true</span><span class="op" id="5871442">)</span><br>
<span class="lineno">235</span><span class="op" id="5871444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5871447">func</span>&nbsp;<span class="op" id="5871452">(</span><span class="ident" id="5871453">server</span>&nbsp;<span class="op" id="5871460">*</span><span class="ident" id="5871461">Server</span><span class="op" id="5871467">)</span>&nbsp;<span class="ident" id="5871469">register</span><span class="op" id="5871477">(</span><span class="ident" id="5871478">rcvr</span>&nbsp;<span class="keyword" id="5871483">interface</span><span class="op" id="5871492">{</span><span class="op" id="5871493">}</span><span class="op" id="5871494">,</span>&nbsp;<span class="ident" id="5871496">name</span>&nbsp;<span class="builtintype" id="5871501">string</span><span class="op" id="5871507">,</span>&nbsp;<span class="ident" id="5871509">useName</span>&nbsp;<span class="builtintype" id="5871517">bool</span><span class="op" id="5871521">)</span>&nbsp;<span class="builtintype" id="5871523">error</span>&nbsp;<span class="op" id="5871529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871532">server</span><span class="op" id="5871538">.</span><span class="ident" id="5871539">mu</span><span class="op" id="5871541">.</span><span class="ident" id="5871542">Lock</span><span class="op" id="5871546">(</span><span class="op" id="5871547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871550">defer</span>&nbsp;<span class="ident" id="5871556">server</span><span class="op" id="5871562">.</span><span class="ident" id="5871563">mu</span><span class="op" id="5871565">.</span><span class="ident" id="5871566">Unlock</span><span class="op" id="5871572">(</span><span class="op" id="5871573">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871576">if</span>&nbsp;<span class="ident" id="5871579">server</span><span class="op" id="5871585">.</span><span class="ident" id="5871586">serviceMap</span>&nbsp;<span class="op" id="5871597">==</span>&nbsp;<span class="ident" id="5871600">nil</span>&nbsp;<span class="op" id="5871604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871608">server</span><span class="op" id="5871614">.</span><span class="ident" id="5871615">serviceMap</span>&nbsp;<span class="op" id="5871626">=</span>&nbsp;<span class="builtinfunc" id="5871628">make</span><span class="op" id="5871632">(</span><span class="keyword" id="5871633">map</span><span class="op" id="5871636">[</span><span class="builtintype" id="5871637">string</span><span class="op" id="5871643">]</span><span class="op" id="5871644">*</span><span class="ident" id="5871645">service</span><span class="op" id="5871652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5871655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871658">s</span>&nbsp;<span class="op" id="5871660">:=</span>&nbsp;<span class="builtinfunc" id="5871663">new</span><span class="op" id="5871666">(</span><span class="ident" id="5871667">service</span><span class="op" id="5871674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871677">s</span><span class="op" id="5871678">.</span><span class="ident" id="5871679">typ</span>&nbsp;<span class="op" id="5871683">=</span>&nbsp;<span class="ident" id="5871685">reflect</span><span class="op" id="5871692">.</span><span class="ident" id="5871693">TypeOf</span><span class="op" id="5871699">(</span><span class="ident" id="5871700">rcvr</span><span class="op" id="5871704">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871707">s</span><span class="op" id="5871708">.</span><span class="ident" id="5871709">rcvr</span>&nbsp;<span class="op" id="5871714">=</span>&nbsp;<span class="ident" id="5871716">reflect</span><span class="op" id="5871723">.</span><span class="ident" id="5871724">ValueOf</span><span class="op" id="5871731">(</span><span class="ident" id="5871732">rcvr</span><span class="op" id="5871736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871739">sname</span>&nbsp;<span class="op" id="5871745">:=</span>&nbsp;<span class="ident" id="5871748">reflect</span><span class="op" id="5871755">.</span><span class="ident" id="5871756">Indirect</span><span class="op" id="5871764">(</span><span class="ident" id="5871765">s</span><span class="op" id="5871766">.</span><span class="ident" id="5871767">rcvr</span><span class="op" id="5871771">)</span><span class="op" id="5871772">.</span><span class="ident" id="5871773">Type</span><span class="op" id="5871777">(</span><span class="op" id="5871778">)</span><span class="op" id="5871779">.</span><span class="ident" id="5871780">Name</span><span class="op" id="5871784">(</span><span class="op" id="5871785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871788">if</span>&nbsp;<span class="ident" id="5871791">useName</span>&nbsp;<span class="op" id="5871799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871803">sname</span>&nbsp;<span class="op" id="5871809">=</span>&nbsp;<span class="ident" id="5871811">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5871817">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871820">if</span>&nbsp;<span class="ident" id="5871823">sname</span>&nbsp;<span class="op" id="5871829">==</span>&nbsp;<span class="string" id="5871832">&#34;&#34;</span>&nbsp;<span class="op" id="5871835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871839">s</span>&nbsp;<span class="op" id="5871841">:=</span>&nbsp;<span class="string" id="5871844">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5871886">+</span>&nbsp;<span class="ident" id="5871888">s</span><span class="op" id="5871889">.</span><span class="ident" id="5871890">typ</span><span class="op" id="5871893">.</span><span class="ident" id="5871894">String</span><span class="op" id="5871900">(</span><span class="op" id="5871901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871905">log</span><span class="op" id="5871908">.</span><span class="ident" id="5871909">Print</span><span class="op" id="5871914">(</span><span class="ident" id="5871915">s</span><span class="op" id="5871916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871920">return</span>&nbsp;<span class="ident" id="5871927">errors</span><span class="op" id="5871933">.</span><span class="ident" id="5871934">New</span><span class="op" id="5871937">(</span><span class="ident" id="5871938">s</span><span class="op" id="5871939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5871942">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5871945">if</span>&nbsp;<span class="op" id="5871948">!</span><span class="ident" id="5871949">isExported</span><span class="op" id="5871959">(</span><span class="ident" id="5871960">sname</span><span class="op" id="5871965">)</span>&nbsp;<span class="op" id="5871967">&amp;&amp;</span>&nbsp;<span class="op" id="5871970">!</span><span class="ident" id="5871971">useName</span>&nbsp;<span class="op" id="5871979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5871983">s</span>&nbsp;<span class="op" id="5871985">:=</span>&nbsp;<span class="string" id="5871988">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5872010">+</span>&nbsp;<span class="ident" id="5872012">sname</span>&nbsp;<span class="op" id="5872018">+</span>&nbsp;<span class="string" id="5872020">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872041">log</span><span class="op" id="5872044">.</span><span class="ident" id="5872045">Print</span><span class="op" id="5872050">(</span><span class="ident" id="5872051">s</span><span class="op" id="5872052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5872056">return</span>&nbsp;<span class="ident" id="5872063">errors</span><span class="op" id="5872069">.</span><span class="ident" id="5872070">New</span><span class="op" id="5872073">(</span><span class="ident" id="5872074">s</span><span class="op" id="5872075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5872078">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5872081">if</span>&nbsp;<span class="ident" id="5872084">_</span><span class="op" id="5872085">,</span>&nbsp;<span class="ident" id="5872087">present</span>&nbsp;<span class="op" id="5872095">:=</span>&nbsp;<span class="ident" id="5872098">server</span><span class="op" id="5872104">.</span><span class="ident" id="5872105">serviceMap</span><span class="op" id="5872115">[</span><span class="ident" id="5872116">sname</span><span class="op" id="5872121">]</span><span class="op" id="5872122">;</span>&nbsp;<span class="ident" id="5872124">present</span>&nbsp;<span class="op" id="5872132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5872136">return</span>&nbsp;<span class="ident" id="5872143">errors</span><span class="op" id="5872149">.</span><span class="ident" id="5872150">New</span><span class="op" id="5872153">(</span><span class="string" id="5872154">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="5872187">+</span>&nbsp;<span class="ident" id="5872189">sname</span><span class="op" id="5872194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5872197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872200">s</span><span class="op" id="5872201">.</span><span class="ident" id="5872202">name</span>&nbsp;<span class="op" id="5872207">=</span>&nbsp;<span class="ident" id="5872209">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5872217">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872241">s</span><span class="op" id="5872242">.</span><span class="ident" id="5872243">method</span>&nbsp;<span class="op" id="5872250">=</span>&nbsp;<span class="ident" id="5872252">suitableMethods</span><span class="op" id="5872267">(</span><span class="ident" id="5872268">s</span><span class="op" id="5872269">.</span><span class="ident" id="5872270">typ</span><span class="op" id="5872273">,</span>&nbsp;<span class="builtintype" id="5872275">true</span><span class="op" id="5872279">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5872283">if</span>&nbsp;<span class="builtinfunc" id="5872286">len</span><span class="op" id="5872289">(</span><span class="ident" id="5872290">s</span><span class="op" id="5872291">.</span><span class="ident" id="5872292">method</span><span class="op" id="5872298">)</span>&nbsp;<span class="op" id="5872300">==</span>&nbsp;<span class="num" id="5872303">0</span>&nbsp;<span class="op" id="5872305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872309">str</span>&nbsp;<span class="op" id="5872313">:=</span>&nbsp;<span class="string" id="5872316">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5872322">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872383">method</span>&nbsp;<span class="op" id="5872390">:=</span>&nbsp;<span class="ident" id="5872393">suitableMethods</span><span class="op" id="5872408">(</span><span class="ident" id="5872409">reflect</span><span class="op" id="5872416">.</span><span class="ident" id="5872417">PtrTo</span><span class="op" id="5872422">(</span><span class="ident" id="5872423">s</span><span class="op" id="5872424">.</span><span class="ident" id="5872425">typ</span><span class="op" id="5872428">)</span><span class="op" id="5872429">,</span>&nbsp;<span class="builtintype" id="5872431">false</span><span class="op" id="5872436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5872440">if</span>&nbsp;<span class="builtinfunc" id="5872443">len</span><span class="op" id="5872446">(</span><span class="ident" id="5872447">method</span><span class="op" id="5872453">)</span>&nbsp;<span class="op" id="5872455">!=</span>&nbsp;<span class="num" id="5872458">0</span>&nbsp;<span class="op" id="5872460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872465">str</span>&nbsp;<span class="op" id="5872469">=</span>&nbsp;<span class="string" id="5872471">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5872493">+</span>&nbsp;<span class="ident" id="5872495">sname</span>&nbsp;<span class="op" id="5872501">+</span>&nbsp;<span class="string" id="5872503">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5872594">}</span>&nbsp;<span class="keyword" id="5872596">else</span>&nbsp;<span class="op" id="5872601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872606">str</span>&nbsp;<span class="op" id="5872610">=</span>&nbsp;<span class="string" id="5872612">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5872634">+</span>&nbsp;<span class="ident" id="5872636">sname</span>&nbsp;<span class="op" id="5872642">+</span>&nbsp;<span class="string" id="5872644">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5872690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872694">log</span><span class="op" id="5872697">.</span><span class="ident" id="5872698">Print</span><span class="op" id="5872703">(</span><span class="ident" id="5872704">str</span><span class="op" id="5872707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5872711">return</span>&nbsp;<span class="ident" id="5872718">errors</span><span class="op" id="5872724">.</span><span class="ident" id="5872725">New</span><span class="op" id="5872728">(</span><span class="ident" id="5872729">str</span><span class="op" id="5872732">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5872735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872738">server</span><span class="op" id="5872744">.</span><span class="ident" id="5872745">serviceMap</span><span class="op" id="5872755">[</span><span class="ident" id="5872756">s</span><span class="op" id="5872757">.</span><span class="ident" id="5872758">name</span><span class="op" id="5872762">]</span>&nbsp;<span class="op" id="5872764">=</span>&nbsp;<span class="ident" id="5872766">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5872769">return</span>&nbsp;<span class="ident" id="5872776">nil</span><br>
<span class="lineno"></span><span class="op" id="5872780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5872783">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="5872854">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5872895">func</span>&nbsp;<span class="ident" id="5872900">suitableMethods</span><span class="op" id="5872915">(</span><span class="ident" id="5872916">typ</span>&nbsp;<span class="ident" id="5872920">reflect</span><span class="op" id="5872927">.</span><span class="ident" id="5872928">Type</span><span class="op" id="5872932">,</span>&nbsp;<span class="ident" id="5872934">reportErr</span>&nbsp;<span class="builtintype" id="5872944">bool</span><span class="op" id="5872948">)</span>&nbsp;<span class="keyword" id="5872950">map</span><span class="op" id="5872953">[</span><span class="builtintype" id="5872954">string</span><span class="op" id="5872960">]</span><span class="op" id="5872961">*</span><span class="ident" id="5872962">methodType</span>&nbsp;<span class="op" id="5872973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5872976">methods</span>&nbsp;<span class="op" id="5872984">:=</span>&nbsp;<span class="builtinfunc" id="5872987">make</span><span class="op" id="5872991">(</span><span class="keyword" id="5872992">map</span><span class="op" id="5872995">[</span><span class="builtintype" id="5872996">string</span><span class="op" id="5873002">]</span><span class="op" id="5873003">*</span><span class="ident" id="5873004">methodType</span><span class="op" id="5873014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873017">for</span>&nbsp;<span class="ident" id="5873021">m</span>&nbsp;<span class="op" id="5873023">:=</span>&nbsp;<span class="num" id="5873026">0</span><span class="op" id="5873027">;</span>&nbsp;<span class="ident" id="5873029">m</span>&nbsp;<span class="op" id="5873031">&lt;</span>&nbsp;<span class="ident" id="5873033">typ</span><span class="op" id="5873036">.</span><span class="ident" id="5873037">NumMethod</span><span class="op" id="5873046">(</span><span class="op" id="5873047">)</span><span class="op" id="5873048">;</span>&nbsp;<span class="ident" id="5873050">m</span><span class="op" id="5873051">++</span>&nbsp;<span class="op" id="5873054">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873058">method</span>&nbsp;<span class="op" id="5873065">:=</span>&nbsp;<span class="ident" id="5873068">typ</span><span class="op" id="5873071">.</span><span class="ident" id="5873072">Method</span><span class="op" id="5873078">(</span><span class="ident" id="5873079">m</span><span class="op" id="5873080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873084">mtype</span>&nbsp;<span class="op" id="5873090">:=</span>&nbsp;<span class="ident" id="5873093">method</span><span class="op" id="5873099">.</span><span class="ident" id="5873100">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873107">mname</span>&nbsp;<span class="op" id="5873113">:=</span>&nbsp;<span class="ident" id="5873116">method</span><span class="op" id="5873122">.</span><span class="ident" id="5873123">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5873130">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873160">if</span>&nbsp;<span class="ident" id="5873163">method</span><span class="op" id="5873169">.</span><span class="ident" id="5873170">PkgPath</span>&nbsp;<span class="op" id="5873178">!=</span>&nbsp;<span class="string" id="5873181">&#34;&#34;</span>&nbsp;<span class="op" id="5873184">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873189">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5873204">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873258">if</span>&nbsp;<span class="ident" id="5873261">mtype</span><span class="op" id="5873266">.</span><span class="ident" id="5873267">NumIn</span><span class="op" id="5873272">(</span><span class="op" id="5873273">)</span>&nbsp;<span class="op" id="5873275">!=</span>&nbsp;<span class="num" id="5873278">3</span>&nbsp;<span class="op" id="5873280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873285">if</span>&nbsp;<span class="ident" id="5873288">reportErr</span>&nbsp;<span class="op" id="5873298">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873304">log</span><span class="op" id="5873307">.</span><span class="ident" id="5873308">Println</span><span class="op" id="5873315">(</span><span class="string" id="5873316">&#34;method&#34;</span><span class="op" id="5873324">,</span>&nbsp;<span class="ident" id="5873326">mname</span><span class="op" id="5873331">,</span>&nbsp;<span class="string" id="5873333">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="5873359">,</span>&nbsp;<span class="ident" id="5873361">mtype</span><span class="op" id="5873366">.</span><span class="ident" id="5873367">NumIn</span><span class="op" id="5873372">(</span><span class="op" id="5873373">)</span><span class="op" id="5873374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873384">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5873399">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873437">argType</span>&nbsp;<span class="op" id="5873445">:=</span>&nbsp;<span class="ident" id="5873448">mtype</span><span class="op" id="5873453">.</span><span class="ident" id="5873454">In</span><span class="op" id="5873456">(</span><span class="num" id="5873457">1</span><span class="op" id="5873458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873462">if</span>&nbsp;<span class="op" id="5873465">!</span><span class="ident" id="5873466">isExportedOrBuiltinType</span><span class="op" id="5873489">(</span><span class="ident" id="5873490">argType</span><span class="op" id="5873497">)</span>&nbsp;<span class="op" id="5873499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873504">if</span>&nbsp;<span class="ident" id="5873507">reportErr</span>&nbsp;<span class="op" id="5873517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873523">log</span><span class="op" id="5873526">.</span><span class="ident" id="5873527">Println</span><span class="op" id="5873534">(</span><span class="ident" id="5873535">mname</span><span class="op" id="5873540">,</span>&nbsp;<span class="string" id="5873542">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5873571">,</span>&nbsp;<span class="ident" id="5873573">argType</span><span class="op" id="5873580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873585">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873590">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5873605">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873640">replyType</span>&nbsp;<span class="op" id="5873650">:=</span>&nbsp;<span class="ident" id="5873653">mtype</span><span class="op" id="5873658">.</span><span class="ident" id="5873659">In</span><span class="op" id="5873661">(</span><span class="num" id="5873662">2</span><span class="op" id="5873663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873667">if</span>&nbsp;<span class="ident" id="5873670">replyType</span><span class="op" id="5873679">.</span><span class="ident" id="5873680">Kind</span><span class="op" id="5873684">(</span><span class="op" id="5873685">)</span>&nbsp;<span class="op" id="5873687">!=</span>&nbsp;<span class="ident" id="5873690">reflect</span><span class="op" id="5873697">.</span><span class="ident" id="5873698">Ptr</span>&nbsp;<span class="op" id="5873702">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873707">if</span>&nbsp;<span class="ident" id="5873710">reportErr</span>&nbsp;<span class="op" id="5873720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873726">log</span><span class="op" id="5873729">.</span><span class="ident" id="5873730">Println</span><span class="op" id="5873737">(</span><span class="string" id="5873738">&#34;method&#34;</span><span class="op" id="5873746">,</span>&nbsp;<span class="ident" id="5873748">mname</span><span class="op" id="5873753">,</span>&nbsp;<span class="string" id="5873755">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="5873782">,</span>&nbsp;<span class="ident" id="5873784">replyType</span><span class="op" id="5873793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873803">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873814">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5873818">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873852">if</span>&nbsp;<span class="op" id="5873855">!</span><span class="ident" id="5873856">isExportedOrBuiltinType</span><span class="op" id="5873879">(</span><span class="ident" id="5873880">replyType</span><span class="op" id="5873889">)</span>&nbsp;<span class="op" id="5873891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873896">if</span>&nbsp;<span class="ident" id="5873899">reportErr</span>&nbsp;<span class="op" id="5873909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5873915">log</span><span class="op" id="5873918">.</span><span class="ident" id="5873919">Println</span><span class="op" id="5873926">(</span><span class="string" id="5873927">&#34;method&#34;</span><span class="op" id="5873935">,</span>&nbsp;<span class="ident" id="5873937">mname</span><span class="op" id="5873942">,</span>&nbsp;<span class="string" id="5873944">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5873970">,</span>&nbsp;<span class="ident" id="5873972">replyType</span><span class="op" id="5873981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5873986">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5873991">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5874006">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874033">if</span>&nbsp;<span class="ident" id="5874036">mtype</span><span class="op" id="5874041">.</span><span class="ident" id="5874042">NumOut</span><span class="op" id="5874048">(</span><span class="op" id="5874049">)</span>&nbsp;<span class="op" id="5874051">!=</span>&nbsp;<span class="num" id="5874054">1</span>&nbsp;<span class="op" id="5874056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874061">if</span>&nbsp;<span class="ident" id="5874064">reportErr</span>&nbsp;<span class="op" id="5874074">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874080">log</span><span class="op" id="5874083">.</span><span class="ident" id="5874084">Println</span><span class="op" id="5874091">(</span><span class="string" id="5874092">&#34;method&#34;</span><span class="op" id="5874100">,</span>&nbsp;<span class="ident" id="5874102">mname</span><span class="op" id="5874107">,</span>&nbsp;<span class="string" id="5874109">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="5874136">,</span>&nbsp;<span class="ident" id="5874138">mtype</span><span class="op" id="5874143">.</span><span class="ident" id="5874144">NumOut</span><span class="op" id="5874150">(</span><span class="op" id="5874151">)</span><span class="op" id="5874152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874162">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5874177">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874227">if</span>&nbsp;<span class="ident" id="5874230">returnType</span>&nbsp;<span class="op" id="5874241">:=</span>&nbsp;<span class="ident" id="5874244">mtype</span><span class="op" id="5874249">.</span><span class="ident" id="5874250">Out</span><span class="op" id="5874253">(</span><span class="num" id="5874254">0</span><span class="op" id="5874255">)</span><span class="op" id="5874256">;</span>&nbsp;<span class="ident" id="5874258">returnType</span>&nbsp;<span class="op" id="5874269">!=</span>&nbsp;<span class="ident" id="5874272">typeOfError</span>&nbsp;<span class="op" id="5874284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874289">if</span>&nbsp;<span class="ident" id="5874292">reportErr</span>&nbsp;<span class="op" id="5874302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874308">log</span><span class="op" id="5874311">.</span><span class="ident" id="5874312">Println</span><span class="op" id="5874319">(</span><span class="string" id="5874320">&#34;method&#34;</span><span class="op" id="5874328">,</span>&nbsp;<span class="ident" id="5874330">mname</span><span class="op" id="5874335">,</span>&nbsp;<span class="string" id="5874337">&#34;returns&#34;</span><span class="op" id="5874346">,</span>&nbsp;<span class="ident" id="5874348">returnType</span><span class="op" id="5874358">.</span><span class="ident" id="5874359">String</span><span class="op" id="5874365">(</span><span class="op" id="5874366">)</span><span class="op" id="5874367">,</span>&nbsp;<span class="string" id="5874369">&#34;not&nbsp;error&#34;</span><span class="op" id="5874380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874390">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874405">methods</span><span class="op" id="5874412">[</span><span class="ident" id="5874413">mname</span><span class="op" id="5874418">]</span>&nbsp;<span class="op" id="5874420">=</span>&nbsp;<span class="op" id="5874422">&amp;</span><span class="ident" id="5874423">methodType</span><span class="op" id="5874433">{</span><span class="ident" id="5874434">method</span><span class="op" id="5874440">:</span>&nbsp;<span class="ident" id="5874442">method</span><span class="op" id="5874448">,</span>&nbsp;<span class="ident" id="5874450">ArgType</span><span class="op" id="5874457">:</span>&nbsp;<span class="ident" id="5874459">argType</span><span class="op" id="5874466">,</span>&nbsp;<span class="ident" id="5874468">ReplyType</span><span class="op" id="5874477">:</span>&nbsp;<span class="ident" id="5874479">replyType</span><span class="op" id="5874488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5874491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874494">return</span>&nbsp;<span class="ident" id="5874501">methods</span><br>
<span class="lineno"></span><span class="op" id="5874509">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="5874512">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="5874593">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="5874678">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5874716">var</span>&nbsp;<span class="ident" id="5874720">invalidRequest</span>&nbsp;<span class="op" id="5874735">=</span>&nbsp;<span class="keyword" id="5874737">struct</span><span class="op" id="5874743">{</span><span class="op" id="5874744">}</span><span class="op" id="5874745">{</span><span class="op" id="5874746">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="5874749">func</span>&nbsp;<span class="op" id="5874754">(</span><span class="ident" id="5874755">server</span>&nbsp;<span class="op" id="5874762">*</span><span class="ident" id="5874763">Server</span><span class="op" id="5874769">)</span>&nbsp;<span class="ident" id="5874771">sendResponse</span><span class="op" id="5874783">(</span><span class="ident" id="5874784">sending</span>&nbsp;<span class="op" id="5874792">*</span><span class="ident" id="5874793">sync</span><span class="op" id="5874797">.</span><span class="ident" id="5874798">Mutex</span><span class="op" id="5874803">,</span>&nbsp;<span class="ident" id="5874805">req</span>&nbsp;<span class="op" id="5874809">*</span><span class="ident" id="5874810">Request</span><span class="op" id="5874817">,</span>&nbsp;<span class="ident" id="5874819">reply</span>&nbsp;<span class="keyword" id="5874825">interface</span><span class="op" id="5874834">{</span><span class="op" id="5874835">}</span><span class="op" id="5874836">,</span>&nbsp;<span class="ident" id="5874838">codec</span>&nbsp;<span class="ident" id="5874844">ServerCodec</span><span class="op" id="5874855">,</span>&nbsp;<span class="ident" id="5874857">errmsg</span>&nbsp;<span class="builtintype" id="5874864">string</span><span class="op" id="5874870">)</span>&nbsp;<span class="op" id="5874872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874875">resp</span>&nbsp;<span class="op" id="5874880">:=</span>&nbsp;<span class="ident" id="5874883">server</span><span class="op" id="5874889">.</span><span class="ident" id="5874890">getResponse</span><span class="op" id="5874901">(</span><span class="op" id="5874902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5874905">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874936">resp</span><span class="op" id="5874940">.</span><span class="ident" id="5874941">ServiceMethod</span>&nbsp;<span class="op" id="5874955">=</span>&nbsp;<span class="ident" id="5874957">req</span><span class="op" id="5874960">.</span><span class="ident" id="5874961">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5874976">if</span>&nbsp;<span class="ident" id="5874979">errmsg</span>&nbsp;<span class="op" id="5874986">!=</span>&nbsp;<span class="string" id="5874989">&#34;&#34;</span>&nbsp;<span class="op" id="5874992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5874996">resp</span><span class="op" id="5875000">.</span><span class="ident" id="5875001">Error</span>&nbsp;<span class="op" id="5875007">=</span>&nbsp;<span class="ident" id="5875009">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875018">reply</span>&nbsp;<span class="op" id="5875024">=</span>&nbsp;<span class="ident" id="5875026">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875045">resp</span><span class="op" id="5875049">.</span><span class="ident" id="5875050">Seq</span>&nbsp;<span class="op" id="5875054">=</span>&nbsp;<span class="ident" id="5875056">req</span><span class="op" id="5875059">.</span><span class="ident" id="5875060">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875065">sending</span><span class="op" id="5875072">.</span><span class="ident" id="5875073">Lock</span><span class="op" id="5875077">(</span><span class="op" id="5875078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875081">err</span>&nbsp;<span class="op" id="5875085">:=</span>&nbsp;<span class="ident" id="5875088">codec</span><span class="op" id="5875093">.</span><span class="ident" id="5875094">WriteResponse</span><span class="op" id="5875107">(</span><span class="ident" id="5875108">resp</span><span class="op" id="5875112">,</span>&nbsp;<span class="ident" id="5875114">reply</span><span class="op" id="5875119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875122">if</span>&nbsp;<span class="ident" id="5875125">debugLog</span>&nbsp;<span class="op" id="5875134">&amp;&amp;</span>&nbsp;<span class="ident" id="5875137">err</span>&nbsp;<span class="op" id="5875141">!=</span>&nbsp;<span class="ident" id="5875144">nil</span>&nbsp;<span class="op" id="5875148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875152">log</span><span class="op" id="5875155">.</span><span class="ident" id="5875156">Println</span><span class="op" id="5875163">(</span><span class="string" id="5875164">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="5875188">,</span>&nbsp;<span class="ident" id="5875190">err</span><span class="op" id="5875193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875196">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875199">sending</span><span class="op" id="5875206">.</span><span class="ident" id="5875207">Unlock</span><span class="op" id="5875213">(</span><span class="op" id="5875214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875217">server</span><span class="op" id="5875223">.</span><span class="ident" id="5875224">freeResponse</span><span class="op" id="5875236">(</span><span class="ident" id="5875237">resp</span><span class="op" id="5875241">)</span><br>
<span class="lineno"></span><span class="op" id="5875243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5875246">func</span>&nbsp;<span class="op" id="5875251">(</span><span class="ident" id="5875252">m</span>&nbsp;<span class="op" id="5875254">*</span><span class="ident" id="5875255">methodType</span><span class="op" id="5875265">)</span>&nbsp;<span class="ident" id="5875267">NumCalls</span><span class="op" id="5875275">(</span><span class="op" id="5875276">)</span>&nbsp;<span class="op" id="5875278">(</span><span class="ident" id="5875279">n</span>&nbsp;<span class="builtintype" id="5875281">uint</span><span class="op" id="5875285">)</span>&nbsp;<span class="op" id="5875287">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875290">m</span><span class="op" id="5875291">.</span><span class="ident" id="5875292">Lock</span><span class="op" id="5875296">(</span><span class="op" id="5875297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875300">n</span>&nbsp;<span class="op" id="5875302">=</span>&nbsp;<span class="ident" id="5875304">m</span><span class="op" id="5875305">.</span><span class="ident" id="5875306">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875316">m</span><span class="op" id="5875317">.</span><span class="ident" id="5875318">Unlock</span><span class="op" id="5875324">(</span><span class="op" id="5875325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875328">return</span>&nbsp;<span class="ident" id="5875335">n</span><br>
<span class="lineno"></span><span class="op" id="5875337">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="5875340">func</span>&nbsp;<span class="op" id="5875345">(</span><span class="ident" id="5875346">s</span>&nbsp;<span class="op" id="5875348">*</span><span class="ident" id="5875349">service</span><span class="op" id="5875356">)</span>&nbsp;<span class="ident" id="5875358">call</span><span class="op" id="5875362">(</span><span class="ident" id="5875363">server</span>&nbsp;<span class="op" id="5875370">*</span><span class="ident" id="5875371">Server</span><span class="op" id="5875377">,</span>&nbsp;<span class="ident" id="5875379">sending</span>&nbsp;<span class="op" id="5875387">*</span><span class="ident" id="5875388">sync</span><span class="op" id="5875392">.</span><span class="ident" id="5875393">Mutex</span><span class="op" id="5875398">,</span>&nbsp;<span class="ident" id="5875400">mtype</span>&nbsp;<span class="op" id="5875406">*</span><span class="ident" id="5875407">methodType</span><span class="op" id="5875417">,</span>&nbsp;<span class="ident" id="5875419">req</span>&nbsp;<span class="op" id="5875423">*</span><span class="ident" id="5875424">Request</span><span class="op" id="5875431">,</span>&nbsp;<span class="ident" id="5875433">argv</span><span class="op" id="5875437">,</span>&nbsp;<span class="ident" id="5875439">replyv</span>&nbsp;<span class="ident" id="5875446">reflect</span><span class="op" id="5875453">.</span><span class="ident" id="5875454">Value</span><span class="op" id="5875459">,</span>&nbsp;<span class="ident" id="5875461">codec</span>&nbsp;<span class="ident" id="5875467">ServerCodec</span><span class="op" id="5875478">)</span>&nbsp;<span class="op" id="5875480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875483">mtype</span><span class="op" id="5875488">.</span><span class="ident" id="5875489">Lock</span><span class="op" id="5875493">(</span><span class="op" id="5875494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875497">mtype</span><span class="op" id="5875502">.</span><span class="ident" id="5875503">numCalls</span><span class="op" id="5875511">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875515">mtype</span><span class="op" id="5875520">.</span><span class="ident" id="5875521">Unlock</span><span class="op" id="5875527">(</span><span class="op" id="5875528">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875531">function</span>&nbsp;<span class="op" id="5875540">:=</span>&nbsp;<span class="ident" id="5875543">mtype</span><span class="op" id="5875548">.</span><span class="ident" id="5875549">method</span><span class="op" id="5875555">.</span><span class="ident" id="5875556">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5875562">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875622">returnValues</span>&nbsp;<span class="op" id="5875635">:=</span>&nbsp;<span class="ident" id="5875638">function</span><span class="op" id="5875646">.</span><span class="ident" id="5875647">Call</span><span class="op" id="5875651">(</span><span class="op" id="5875652">[</span><span class="op" id="5875653">]</span><span class="ident" id="5875654">reflect</span><span class="op" id="5875661">.</span><span class="ident" id="5875662">Value</span><span class="op" id="5875667">{</span><span class="ident" id="5875668">s</span><span class="op" id="5875669">.</span><span class="ident" id="5875670">rcvr</span><span class="op" id="5875674">,</span>&nbsp;<span class="ident" id="5875676">argv</span><span class="op" id="5875680">,</span>&nbsp;<span class="ident" id="5875682">replyv</span><span class="op" id="5875688">}</span><span class="op" id="5875689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5875692">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875741">errInter</span>&nbsp;<span class="op" id="5875750">:=</span>&nbsp;<span class="ident" id="5875753">returnValues</span><span class="op" id="5875765">[</span><span class="num" id="5875766">0</span><span class="op" id="5875767">]</span><span class="op" id="5875768">.</span><span class="ident" id="5875769">Interface</span><span class="op" id="5875778">(</span><span class="op" id="5875779">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875782">errmsg</span>&nbsp;<span class="op" id="5875789">:=</span>&nbsp;<span class="string" id="5875792">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5875796">if</span>&nbsp;<span class="ident" id="5875799">errInter</span>&nbsp;<span class="op" id="5875808">!=</span>&nbsp;<span class="ident" id="5875811">nil</span>&nbsp;<span class="op" id="5875815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875819">errmsg</span>&nbsp;<span class="op" id="5875826">=</span>&nbsp;<span class="ident" id="5875828">errInter</span><span class="op" id="5875836">.</span><span class="op" id="5875837">(</span><span class="builtintype" id="5875838">error</span><span class="op" id="5875843">)</span><span class="op" id="5875844">.</span><span class="ident" id="5875845">Error</span><span class="op" id="5875850">(</span><span class="op" id="5875851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5875854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875857">server</span><span class="op" id="5875863">.</span><span class="ident" id="5875864">sendResponse</span><span class="op" id="5875876">(</span><span class="ident" id="5875877">sending</span><span class="op" id="5875884">,</span>&nbsp;<span class="ident" id="5875886">req</span><span class="op" id="5875889">,</span>&nbsp;<span class="ident" id="5875891">replyv</span><span class="op" id="5875897">.</span><span class="ident" id="5875898">Interface</span><span class="op" id="5875907">(</span><span class="op" id="5875908">)</span><span class="op" id="5875909">,</span>&nbsp;<span class="ident" id="5875911">codec</span><span class="op" id="5875916">,</span>&nbsp;<span class="ident" id="5875918">errmsg</span><span class="op" id="5875924">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875927">server</span><span class="op" id="5875933">.</span><span class="ident" id="5875934">freeRequest</span><span class="op" id="5875945">(</span><span class="ident" id="5875946">req</span><span class="op" id="5875949">)</span><br>
<span class="lineno"></span><span class="op" id="5875951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5875954">type</span>&nbsp;<span class="ident" id="5875959">gobServerCodec</span>&nbsp;<span class="keyword" id="5875974">struct</span>&nbsp;<span class="op" id="5875981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5875984">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875991">io</span><span class="op" id="5875993">.</span><span class="ident" id="5875994">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876011">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5876018">*</span><span class="ident" id="5876019">gob</span><span class="op" id="5876022">.</span><span class="ident" id="5876023">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876032">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5876039">*</span><span class="ident" id="5876040">gob</span><span class="op" id="5876043">.</span><span class="ident" id="5876044">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876053">encBuf</span>&nbsp;<span class="op" id="5876060">*</span><span class="ident" id="5876061">bufio</span><span class="op" id="5876066">.</span><span class="ident" id="5876067">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876075">closed</span>&nbsp;<span class="builtintype" id="5876082">bool</span><br>
<span class="lineno"></span><span class="op" id="5876087">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="5876090">func</span>&nbsp;<span class="op" id="5876095">(</span><span class="ident" id="5876096">c</span>&nbsp;<span class="op" id="5876098">*</span><span class="ident" id="5876099">gobServerCodec</span><span class="op" id="5876113">)</span>&nbsp;<span class="ident" id="5876115">ReadRequestHeader</span><span class="op" id="5876132">(</span><span class="ident" id="5876133">r</span>&nbsp;<span class="op" id="5876135">*</span><span class="ident" id="5876136">Request</span><span class="op" id="5876143">)</span>&nbsp;<span class="builtintype" id="5876145">error</span>&nbsp;<span class="op" id="5876151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876154">return</span>&nbsp;<span class="ident" id="5876161">c</span><span class="op" id="5876162">.</span><span class="ident" id="5876163">dec</span><span class="op" id="5876166">.</span><span class="ident" id="5876167">Decode</span><span class="op" id="5876173">(</span><span class="ident" id="5876174">r</span><span class="op" id="5876175">)</span><br>
<span class="lineno"></span><span class="op" id="5876177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="5876180">func</span>&nbsp;<span class="op" id="5876185">(</span><span class="ident" id="5876186">c</span>&nbsp;<span class="op" id="5876188">*</span><span class="ident" id="5876189">gobServerCodec</span><span class="op" id="5876203">)</span>&nbsp;<span class="ident" id="5876205">ReadRequestBody</span><span class="op" id="5876220">(</span><span class="ident" id="5876221">body</span>&nbsp;<span class="keyword" id="5876226">interface</span><span class="op" id="5876235">{</span><span class="op" id="5876236">}</span><span class="op" id="5876237">)</span>&nbsp;<span class="builtintype" id="5876239">error</span>&nbsp;<span class="op" id="5876245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876248">return</span>&nbsp;<span class="ident" id="5876255">c</span><span class="op" id="5876256">.</span><span class="ident" id="5876257">dec</span><span class="op" id="5876260">.</span><span class="ident" id="5876261">Decode</span><span class="op" id="5876267">(</span><span class="ident" id="5876268">body</span><span class="op" id="5876272">)</span><br>
<span class="lineno"></span><span class="op" id="5876274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5876277">func</span>&nbsp;<span class="op" id="5876282">(</span><span class="ident" id="5876283">c</span>&nbsp;<span class="op" id="5876285">*</span><span class="ident" id="5876286">gobServerCodec</span><span class="op" id="5876300">)</span>&nbsp;<span class="ident" id="5876302">WriteResponse</span><span class="op" id="5876315">(</span><span class="ident" id="5876316">r</span>&nbsp;<span class="op" id="5876318">*</span><span class="ident" id="5876319">Response</span><span class="op" id="5876327">,</span>&nbsp;<span class="ident" id="5876329">body</span>&nbsp;<span class="keyword" id="5876334">interface</span><span class="op" id="5876343">{</span><span class="op" id="5876344">}</span><span class="op" id="5876345">)</span>&nbsp;<span class="op" id="5876347">(</span><span class="ident" id="5876348">err</span>&nbsp;<span class="builtintype" id="5876352">error</span><span class="op" id="5876357">)</span>&nbsp;<span class="op" id="5876359">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876362">if</span>&nbsp;<span class="ident" id="5876365">err</span>&nbsp;<span class="op" id="5876369">=</span>&nbsp;<span class="ident" id="5876371">c</span><span class="op" id="5876372">.</span><span class="ident" id="5876373">enc</span><span class="op" id="5876376">.</span><span class="ident" id="5876377">Encode</span><span class="op" id="5876383">(</span><span class="ident" id="5876384">r</span><span class="op" id="5876385">)</span><span class="op" id="5876386">;</span>&nbsp;<span class="ident" id="5876388">err</span>&nbsp;<span class="op" id="5876392">!=</span>&nbsp;<span class="ident" id="5876395">nil</span>&nbsp;<span class="op" id="5876399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876403">if</span>&nbsp;<span class="ident" id="5876406">c</span><span class="op" id="5876407">.</span><span class="ident" id="5876408">encBuf</span><span class="op" id="5876414">.</span><span class="ident" id="5876415">Flush</span><span class="op" id="5876420">(</span><span class="op" id="5876421">)</span>&nbsp;<span class="op" id="5876423">==</span>&nbsp;<span class="ident" id="5876426">nil</span>&nbsp;<span class="op" id="5876430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5876435">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5876507">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876579">log</span><span class="op" id="5876582">.</span><span class="ident" id="5876583">Println</span><span class="op" id="5876590">(</span><span class="string" id="5876591">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="5876626">,</span>&nbsp;<span class="ident" id="5876628">err</span><span class="op" id="5876631">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876636">c</span><span class="op" id="5876637">.</span><span class="ident" id="5876638">Close</span><span class="op" id="5876643">(</span><span class="op" id="5876644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5876648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876652">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5876660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876663">if</span>&nbsp;<span class="ident" id="5876666">err</span>&nbsp;<span class="op" id="5876670">=</span>&nbsp;<span class="ident" id="5876672">c</span><span class="op" id="5876673">.</span><span class="ident" id="5876674">enc</span><span class="op" id="5876677">.</span><span class="ident" id="5876678">Encode</span><span class="op" id="5876684">(</span><span class="ident" id="5876685">body</span><span class="op" id="5876689">)</span><span class="op" id="5876690">;</span>&nbsp;<span class="ident" id="5876692">err</span>&nbsp;<span class="op" id="5876696">!=</span>&nbsp;<span class="ident" id="5876699">nil</span>&nbsp;<span class="op" id="5876703">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876707">if</span>&nbsp;<span class="ident" id="5876710">c</span><span class="op" id="5876711">.</span><span class="ident" id="5876712">encBuf</span><span class="op" id="5876718">.</span><span class="ident" id="5876719">Flush</span><span class="op" id="5876724">(</span><span class="op" id="5876725">)</span>&nbsp;<span class="op" id="5876727">==</span>&nbsp;<span class="ident" id="5876730">nil</span>&nbsp;<span class="op" id="5876734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5876739">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5876814">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876886">log</span><span class="op" id="5876889">.</span><span class="ident" id="5876890">Println</span><span class="op" id="5876897">(</span><span class="string" id="5876898">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="5876929">,</span>&nbsp;<span class="ident" id="5876931">err</span><span class="op" id="5876934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5876939">c</span><span class="op" id="5876940">.</span><span class="ident" id="5876941">Close</span><span class="op" id="5876946">(</span><span class="op" id="5876947">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5876951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876955">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5876963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5876966">return</span>&nbsp;<span class="ident" id="5876973">c</span><span class="op" id="5876974">.</span><span class="ident" id="5876975">encBuf</span><span class="op" id="5876981">.</span><span class="ident" id="5876982">Flush</span><span class="op" id="5876987">(</span><span class="op" id="5876988">)</span><br>
<span class="lineno"></span><span class="op" id="5876990">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5876993">func</span>&nbsp;<span class="op" id="5876998">(</span><span class="ident" id="5876999">c</span>&nbsp;<span class="op" id="5877001">*</span><span class="ident" id="5877002">gobServerCodec</span><span class="op" id="5877016">)</span>&nbsp;<span class="ident" id="5877018">Close</span><span class="op" id="5877023">(</span><span class="op" id="5877024">)</span>&nbsp;<span class="builtintype" id="5877026">error</span>&nbsp;<span class="op" id="5877032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877035">if</span>&nbsp;<span class="ident" id="5877038">c</span><span class="op" id="5877039">.</span><span class="ident" id="5877040">closed</span>&nbsp;<span class="op" id="5877047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5877051">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877123">return</span>&nbsp;<span class="ident" id="5877130">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5877135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877138">c</span><span class="op" id="5877139">.</span><span class="ident" id="5877140">closed</span>&nbsp;<span class="op" id="5877147">=</span>&nbsp;<span class="builtintype" id="5877149">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877155">return</span>&nbsp;<span class="ident" id="5877162">c</span><span class="op" id="5877163">.</span><span class="ident" id="5877164">rwc</span><span class="op" id="5877167">.</span><span class="ident" id="5877168">Close</span><span class="op" id="5877173">(</span><span class="op" id="5877174">)</span><br>
<span class="lineno"></span><span class="op" id="5877176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="5877179">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5877232">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5877303">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5877364">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5877427">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="5877486">func</span>&nbsp;<span class="op" id="5877491">(</span><span class="ident" id="5877492">server</span>&nbsp;<span class="op" id="5877499">*</span><span class="ident" id="5877500">Server</span><span class="op" id="5877506">)</span>&nbsp;<span class="ident" id="5877508">ServeConn</span><span class="op" id="5877517">(</span><span class="ident" id="5877518">conn</span>&nbsp;<span class="ident" id="5877523">io</span><span class="op" id="5877525">.</span><span class="ident" id="5877526">ReadWriteCloser</span><span class="op" id="5877541">)</span>&nbsp;<span class="op" id="5877543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877546">buf</span>&nbsp;<span class="op" id="5877550">:=</span>&nbsp;<span class="ident" id="5877553">bufio</span><span class="op" id="5877558">.</span><span class="ident" id="5877559">NewWriter</span><span class="op" id="5877568">(</span><span class="ident" id="5877569">conn</span><span class="op" id="5877573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877576">srv</span>&nbsp;<span class="op" id="5877580">:=</span>&nbsp;<span class="op" id="5877583">&amp;</span><span class="ident" id="5877584">gobServerCodec</span><span class="op" id="5877598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877602">rwc</span><span class="op" id="5877605">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5877610">conn</span><span class="op" id="5877614">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877618">dec</span><span class="op" id="5877621">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5877626">gob</span><span class="op" id="5877629">.</span><span class="ident" id="5877630">NewDecoder</span><span class="op" id="5877640">(</span><span class="ident" id="5877641">conn</span><span class="op" id="5877645">)</span><span class="op" id="5877646">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877650">enc</span><span class="op" id="5877653">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5877658">gob</span><span class="op" id="5877661">.</span><span class="ident" id="5877662">NewEncoder</span><span class="op" id="5877672">(</span><span class="ident" id="5877673">buf</span><span class="op" id="5877676">)</span><span class="op" id="5877677">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877681">encBuf</span><span class="op" id="5877687">:</span>&nbsp;<span class="ident" id="5877689">buf</span><span class="op" id="5877692">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5877695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877698">server</span><span class="op" id="5877704">.</span><span class="ident" id="5877705">ServeCodec</span><span class="op" id="5877715">(</span><span class="ident" id="5877716">srv</span><span class="op" id="5877719">)</span><br>
<span class="lineno"></span><span class="op" id="5877721">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5877724">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5877788">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5877829">func</span>&nbsp;<span class="op" id="5877834">(</span><span class="ident" id="5877835">server</span>&nbsp;<span class="op" id="5877842">*</span><span class="ident" id="5877843">Server</span><span class="op" id="5877849">)</span>&nbsp;<span class="ident" id="5877851">ServeCodec</span><span class="op" id="5877861">(</span><span class="ident" id="5877862">codec</span>&nbsp;<span class="ident" id="5877868">ServerCodec</span><span class="op" id="5877879">)</span>&nbsp;<span class="op" id="5877881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877884">sending</span>&nbsp;<span class="op" id="5877892">:=</span>&nbsp;<span class="builtinfunc" id="5877895">new</span><span class="op" id="5877898">(</span><span class="ident" id="5877899">sync</span><span class="op" id="5877903">.</span><span class="ident" id="5877904">Mutex</span><span class="op" id="5877909">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5877912">for</span>&nbsp;<span class="op" id="5877916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5877920">service</span><span class="op" id="5877927">,</span>&nbsp;<span class="ident" id="5877929">mtype</span><span class="op" id="5877934">,</span>&nbsp;<span class="ident" id="5877936">req</span><span class="op" id="5877939">,</span>&nbsp;<span class="ident" id="5877941">argv</span><span class="op" id="5877945">,</span>&nbsp;<span class="ident" id="5877947">replyv</span><span class="op" id="5877953">,</span>&nbsp;<span class="ident" id="5877955">keepReading</span><span class="op" id="5877966">,</span>&nbsp;<span class="ident" id="5877968">err</span>&nbsp;<span class="op" id="5877972">:=</span>&nbsp;<span class="ident" id="5877975">server</span><span class="op" id="5877981">.</span><span class="ident" id="5877982">readRequest</span><span class="op" id="5877993">(</span><span class="ident" id="5877994">codec</span><span class="op" id="5877999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878003">if</span>&nbsp;<span class="ident" id="5878006">err</span>&nbsp;<span class="op" id="5878010">!=</span>&nbsp;<span class="ident" id="5878013">nil</span>&nbsp;<span class="op" id="5878017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878022">if</span>&nbsp;<span class="ident" id="5878025">debugLog</span>&nbsp;<span class="op" id="5878034">&amp;&amp;</span>&nbsp;<span class="ident" id="5878037">err</span>&nbsp;<span class="op" id="5878041">!=</span>&nbsp;<span class="ident" id="5878044">io</span><span class="op" id="5878046">.</span><span class="ident" id="5878047">EOF</span>&nbsp;<span class="op" id="5878051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878057">log</span><span class="op" id="5878060">.</span><span class="ident" id="5878061">Println</span><span class="op" id="5878068">(</span><span class="string" id="5878069">&#34;rpc:&#34;</span><span class="op" id="5878075">,</span>&nbsp;<span class="ident" id="5878077">err</span><span class="op" id="5878080">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878090">if</span>&nbsp;<span class="op" id="5878093">!</span><span class="ident" id="5878094">keepReading</span>&nbsp;<span class="op" id="5878106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878112">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878126">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878189">if</span>&nbsp;<span class="ident" id="5878192">req</span>&nbsp;<span class="op" id="5878196">!=</span>&nbsp;<span class="ident" id="5878199">nil</span>&nbsp;<span class="op" id="5878203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878209">server</span><span class="op" id="5878215">.</span><span class="ident" id="5878216">sendResponse</span><span class="op" id="5878228">(</span><span class="ident" id="5878229">sending</span><span class="op" id="5878236">,</span>&nbsp;<span class="ident" id="5878238">req</span><span class="op" id="5878241">,</span>&nbsp;<span class="ident" id="5878243">invalidRequest</span><span class="op" id="5878257">,</span>&nbsp;<span class="ident" id="5878259">codec</span><span class="op" id="5878264">,</span>&nbsp;<span class="ident" id="5878266">err</span><span class="op" id="5878269">.</span><span class="ident" id="5878270">Error</span><span class="op" id="5878275">(</span><span class="op" id="5878276">)</span><span class="op" id="5878277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878283">server</span><span class="op" id="5878289">.</span><span class="ident" id="5878290">freeRequest</span><span class="op" id="5878301">(</span><span class="ident" id="5878302">req</span><span class="op" id="5878305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878315">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878330">go</span>&nbsp;<span class="ident" id="5878333">service</span><span class="op" id="5878340">.</span><span class="ident" id="5878341">call</span><span class="op" id="5878345">(</span><span class="ident" id="5878346">server</span><span class="op" id="5878352">,</span>&nbsp;<span class="ident" id="5878354">sending</span><span class="op" id="5878361">,</span>&nbsp;<span class="ident" id="5878363">mtype</span><span class="op" id="5878368">,</span>&nbsp;<span class="ident" id="5878370">req</span><span class="op" id="5878373">,</span>&nbsp;<span class="ident" id="5878375">argv</span><span class="op" id="5878379">,</span>&nbsp;<span class="ident" id="5878381">replyv</span><span class="op" id="5878387">,</span>&nbsp;<span class="ident" id="5878389">codec</span><span class="op" id="5878394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878400">codec</span><span class="op" id="5878405">.</span><span class="ident" id="5878406">Close</span><span class="op" id="5878411">(</span><span class="op" id="5878412">)</span><br>
<span class="lineno"></span><span class="op" id="5878414">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5878417">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5878495">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5878543">func</span>&nbsp;<span class="op" id="5878548">(</span><span class="ident" id="5878549">server</span>&nbsp;<span class="op" id="5878556">*</span><span class="ident" id="5878557">Server</span><span class="op" id="5878563">)</span>&nbsp;<span class="ident" id="5878565">ServeRequest</span><span class="op" id="5878577">(</span><span class="ident" id="5878578">codec</span>&nbsp;<span class="ident" id="5878584">ServerCodec</span><span class="op" id="5878595">)</span>&nbsp;<span class="builtintype" id="5878597">error</span>&nbsp;<span class="op" id="5878603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878606">sending</span>&nbsp;<span class="op" id="5878614">:=</span>&nbsp;<span class="builtinfunc" id="5878617">new</span><span class="op" id="5878620">(</span><span class="ident" id="5878621">sync</span><span class="op" id="5878625">.</span><span class="ident" id="5878626">Mutex</span><span class="op" id="5878631">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878634">service</span><span class="op" id="5878641">,</span>&nbsp;<span class="ident" id="5878643">mtype</span><span class="op" id="5878648">,</span>&nbsp;<span class="ident" id="5878650">req</span><span class="op" id="5878653">,</span>&nbsp;<span class="ident" id="5878655">argv</span><span class="op" id="5878659">,</span>&nbsp;<span class="ident" id="5878661">replyv</span><span class="op" id="5878667">,</span>&nbsp;<span class="ident" id="5878669">keepReading</span><span class="op" id="5878680">,</span>&nbsp;<span class="ident" id="5878682">err</span>&nbsp;<span class="op" id="5878686">:=</span>&nbsp;<span class="ident" id="5878689">server</span><span class="op" id="5878695">.</span><span class="ident" id="5878696">readRequest</span><span class="op" id="5878707">(</span><span class="ident" id="5878708">codec</span><span class="op" id="5878713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878716">if</span>&nbsp;<span class="ident" id="5878719">err</span>&nbsp;<span class="op" id="5878723">!=</span>&nbsp;<span class="ident" id="5878726">nil</span>&nbsp;<span class="op" id="5878730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878734">if</span>&nbsp;<span class="op" id="5878737">!</span><span class="ident" id="5878738">keepReading</span>&nbsp;<span class="op" id="5878750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878755">return</span>&nbsp;<span class="ident" id="5878762">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878768">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5878772">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878834">if</span>&nbsp;<span class="ident" id="5878837">req</span>&nbsp;<span class="op" id="5878841">!=</span>&nbsp;<span class="ident" id="5878844">nil</span>&nbsp;<span class="op" id="5878848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878853">server</span><span class="op" id="5878859">.</span><span class="ident" id="5878860">sendResponse</span><span class="op" id="5878872">(</span><span class="ident" id="5878873">sending</span><span class="op" id="5878880">,</span>&nbsp;<span class="ident" id="5878882">req</span><span class="op" id="5878885">,</span>&nbsp;<span class="ident" id="5878887">invalidRequest</span><span class="op" id="5878901">,</span>&nbsp;<span class="ident" id="5878903">codec</span><span class="op" id="5878908">,</span>&nbsp;<span class="ident" id="5878910">err</span><span class="op" id="5878913">.</span><span class="ident" id="5878914">Error</span><span class="op" id="5878919">(</span><span class="op" id="5878920">)</span><span class="op" id="5878921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878926">server</span><span class="op" id="5878932">.</span><span class="ident" id="5878933">freeRequest</span><span class="op" id="5878944">(</span><span class="ident" id="5878945">req</span><span class="op" id="5878948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878952">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5878956">return</span>&nbsp;<span class="ident" id="5878963">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5878968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5878971">service</span><span class="op" id="5878978">.</span><span class="ident" id="5878979">call</span><span class="op" id="5878983">(</span><span class="ident" id="5878984">server</span><span class="op" id="5878990">,</span>&nbsp;<span class="ident" id="5878992">sending</span><span class="op" id="5878999">,</span>&nbsp;<span class="ident" id="5879001">mtype</span><span class="op" id="5879006">,</span>&nbsp;<span class="ident" id="5879008">req</span><span class="op" id="5879011">,</span>&nbsp;<span class="ident" id="5879013">argv</span><span class="op" id="5879017">,</span>&nbsp;<span class="ident" id="5879019">replyv</span><span class="op" id="5879025">,</span>&nbsp;<span class="ident" id="5879027">codec</span><span class="op" id="5879032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879035">return</span>&nbsp;<span class="ident" id="5879042">nil</span><br>
<span class="lineno"></span><span class="op" id="5879046">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5879049">func</span>&nbsp;<span class="op" id="5879054">(</span><span class="ident" id="5879055">server</span>&nbsp;<span class="op" id="5879062">*</span><span class="ident" id="5879063">Server</span><span class="op" id="5879069">)</span>&nbsp;<span class="ident" id="5879071">getRequest</span><span class="op" id="5879081">(</span><span class="op" id="5879082">)</span>&nbsp;<span class="op" id="5879084">*</span><span class="ident" id="5879085">Request</span>&nbsp;<span class="op" id="5879093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879096">server</span><span class="op" id="5879102">.</span><span class="ident" id="5879103">reqLock</span><span class="op" id="5879110">.</span><span class="ident" id="5879111">Lock</span><span class="op" id="5879115">(</span><span class="op" id="5879116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879119">req</span>&nbsp;<span class="op" id="5879123">:=</span>&nbsp;<span class="ident" id="5879126">server</span><span class="op" id="5879132">.</span><span class="ident" id="5879133">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879142">if</span>&nbsp;<span class="ident" id="5879145">req</span>&nbsp;<span class="op" id="5879149">==</span>&nbsp;<span class="ident" id="5879152">nil</span>&nbsp;<span class="op" id="5879156">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879160">req</span>&nbsp;<span class="op" id="5879164">=</span>&nbsp;<span class="builtinfunc" id="5879166">new</span><span class="op" id="5879169">(</span><span class="ident" id="5879170">Request</span><span class="op" id="5879177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879180">}</span>&nbsp;<span class="keyword" id="5879182">else</span>&nbsp;<span class="op" id="5879187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879191">server</span><span class="op" id="5879197">.</span><span class="ident" id="5879198">freeReq</span>&nbsp;<span class="op" id="5879206">=</span>&nbsp;<span class="ident" id="5879208">req</span><span class="op" id="5879211">.</span><span class="ident" id="5879212">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879219">*</span><span class="ident" id="5879220">req</span>&nbsp;<span class="op" id="5879224">=</span>&nbsp;<span class="ident" id="5879226">Request</span><span class="op" id="5879233">{</span><span class="op" id="5879234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879237">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879240">server</span><span class="op" id="5879246">.</span><span class="ident" id="5879247">reqLock</span><span class="op" id="5879254">.</span><span class="ident" id="5879255">Unlock</span><span class="op" id="5879261">(</span><span class="op" id="5879262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879265">return</span>&nbsp;<span class="ident" id="5879272">req</span><br>
<span class="lineno"></span><span class="op" id="5879276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5879279">func</span>&nbsp;<span class="op" id="5879284">(</span><span class="ident" id="5879285">server</span>&nbsp;<span class="op" id="5879292">*</span><span class="ident" id="5879293">Server</span><span class="op" id="5879299">)</span>&nbsp;<span class="ident" id="5879301">freeRequest</span><span class="op" id="5879312">(</span><span class="ident" id="5879313">req</span>&nbsp;<span class="op" id="5879317">*</span><span class="ident" id="5879318">Request</span><span class="op" id="5879325">)</span>&nbsp;<span class="op" id="5879327">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879330">server</span><span class="op" id="5879336">.</span><span class="ident" id="5879337">reqLock</span><span class="op" id="5879344">.</span><span class="ident" id="5879345">Lock</span><span class="op" id="5879349">(</span><span class="op" id="5879350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879353">req</span><span class="op" id="5879356">.</span><span class="ident" id="5879357">next</span>&nbsp;<span class="op" id="5879362">=</span>&nbsp;<span class="ident" id="5879364">server</span><span class="op" id="5879370">.</span><span class="ident" id="5879371">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879380">server</span><span class="op" id="5879386">.</span><span class="ident" id="5879387">freeReq</span>&nbsp;<span class="op" id="5879395">=</span>&nbsp;<span class="ident" id="5879397">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879402">server</span><span class="op" id="5879408">.</span><span class="ident" id="5879409">reqLock</span><span class="op" id="5879416">.</span><span class="ident" id="5879417">Unlock</span><span class="op" id="5879423">(</span><span class="op" id="5879424">)</span><br>
<span class="lineno"></span><span class="op" id="5879426">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="5879429">func</span>&nbsp;<span class="op" id="5879434">(</span><span class="ident" id="5879435">server</span>&nbsp;<span class="op" id="5879442">*</span><span class="ident" id="5879443">Server</span><span class="op" id="5879449">)</span>&nbsp;<span class="ident" id="5879451">getResponse</span><span class="op" id="5879462">(</span><span class="op" id="5879463">)</span>&nbsp;<span class="op" id="5879465">*</span><span class="ident" id="5879466">Response</span>&nbsp;<span class="op" id="5879475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879478">server</span><span class="op" id="5879484">.</span><span class="ident" id="5879485">respLock</span><span class="op" id="5879493">.</span><span class="ident" id="5879494">Lock</span><span class="op" id="5879498">(</span><span class="op" id="5879499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879502">resp</span>&nbsp;<span class="op" id="5879507">:=</span>&nbsp;<span class="ident" id="5879510">server</span><span class="op" id="5879516">.</span><span class="ident" id="5879517">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879527">if</span>&nbsp;<span class="ident" id="5879530">resp</span>&nbsp;<span class="op" id="5879535">==</span>&nbsp;<span class="ident" id="5879538">nil</span>&nbsp;<span class="op" id="5879542">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879546">resp</span>&nbsp;<span class="op" id="5879551">=</span>&nbsp;<span class="builtinfunc" id="5879553">new</span><span class="op" id="5879556">(</span><span class="ident" id="5879557">Response</span><span class="op" id="5879565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879568">}</span>&nbsp;<span class="keyword" id="5879570">else</span>&nbsp;<span class="op" id="5879575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879579">server</span><span class="op" id="5879585">.</span><span class="ident" id="5879586">freeResp</span>&nbsp;<span class="op" id="5879595">=</span>&nbsp;<span class="ident" id="5879597">resp</span><span class="op" id="5879601">.</span><span class="ident" id="5879602">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879609">*</span><span class="ident" id="5879610">resp</span>&nbsp;<span class="op" id="5879615">=</span>&nbsp;<span class="ident" id="5879617">Response</span><span class="op" id="5879625">{</span><span class="op" id="5879626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5879629">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879632">server</span><span class="op" id="5879638">.</span><span class="ident" id="5879639">respLock</span><span class="op" id="5879647">.</span><span class="ident" id="5879648">Unlock</span><span class="op" id="5879654">(</span><span class="op" id="5879655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5879658">return</span>&nbsp;<span class="ident" id="5879665">resp</span><br>
<span class="lineno"></span><span class="op" id="5879670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5879673">func</span>&nbsp;<span class="op" id="5879678">(</span><span class="ident" id="5879679">server</span>&nbsp;<span class="op" id="5879686">*</span><span class="ident" id="5879687">Server</span><span class="op" id="5879693">)</span>&nbsp;<span class="ident" id="5879695">freeResponse</span><span class="op" id="5879707">(</span><span class="ident" id="5879708">resp</span>&nbsp;<span class="op" id="5879713">*</span><span class="ident" id="5879714">Response</span><span class="op" id="5879722">)</span>&nbsp;<span class="op" id="5879724">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879727">server</span><span class="op" id="5879733">.</span><span class="ident" id="5879734">respLock</span><span class="op" id="5879742">.</span><span class="ident" id="5879743">Lock</span><span class="op" id="5879747">(</span><span class="op" id="5879748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879751">resp</span><span class="op" id="5879755">.</span><span class="ident" id="5879756">next</span>&nbsp;<span class="op" id="5879761">=</span>&nbsp;<span class="ident" id="5879763">server</span><span class="op" id="5879769">.</span><span class="ident" id="5879770">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879780">server</span><span class="op" id="5879786">.</span><span class="ident" id="5879787">freeResp</span>&nbsp;<span class="op" id="5879796">=</span>&nbsp;<span class="ident" id="5879798">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879804">server</span><span class="op" id="5879810">.</span><span class="ident" id="5879811">respLock</span><span class="op" id="5879819">.</span><span class="ident" id="5879820">Unlock</span><span class="op" id="5879826">(</span><span class="op" id="5879827">)</span><br>
<span class="lineno"></span><span class="op" id="5879829">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="5879832">func</span>&nbsp;<span class="op" id="5879837">(</span><span class="ident" id="5879838">server</span>&nbsp;<span class="op" id="5879845">*</span><span class="ident" id="5879846">Server</span><span class="op" id="5879852">)</span>&nbsp;<span class="ident" id="5879854">readRequest</span><span class="op" id="5879865">(</span><span class="ident" id="5879866">codec</span>&nbsp;<span class="ident" id="5879872">ServerCodec</span><span class="op" id="5879883">)</span>&nbsp;<span class="op" id="5879885">(</span><span class="ident" id="5879886">service</span>&nbsp;<span class="op" id="5879894">*</span><span class="ident" id="5879895">service</span><span class="op" id="5879902">,</span>&nbsp;<span class="ident" id="5879904">mtype</span>&nbsp;<span class="op" id="5879910">*</span><span class="ident" id="5879911">methodType</span><span class="op" id="5879921">,</span>&nbsp;<span class="ident" id="5879923">req</span>&nbsp;<span class="op" id="5879927">*</span><span class="ident" id="5879928">Request</span><span class="op" id="5879935">,</span>&nbsp;<span class="ident" id="5879937">argv</span><span class="op" id="5879941">,</span>&nbsp;<span class="ident" id="5879943">replyv</span>&nbsp;<span class="ident" id="5879950">reflect</span><span class="op" id="5879957">.</span><span class="ident" id="5879958">Value</span><span class="op" id="5879963">,</span>&nbsp;<span class="ident" id="5879965">keepReading</span>&nbsp;<span class="builtintype" id="5879977">bool</span><span class="op" id="5879981">,</span>&nbsp;<span class="ident" id="5879983">err</span>&nbsp;<span class="builtintype" id="5879987">error</span><span class="op" id="5879992">)</span>&nbsp;<span class="op" id="5879994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5879997">service</span><span class="op" id="5880004">,</span>&nbsp;<span class="ident" id="5880006">mtype</span><span class="op" id="5880011">,</span>&nbsp;<span class="ident" id="5880013">req</span><span class="op" id="5880016">,</span>&nbsp;<span class="ident" id="5880018">keepReading</span><span class="op" id="5880029">,</span>&nbsp;<span class="ident" id="5880031">err</span>&nbsp;<span class="op" id="5880035">=</span>&nbsp;<span class="ident" id="5880037">server</span><span class="op" id="5880043">.</span><span class="ident" id="5880044">readRequestHeader</span><span class="op" id="5880061">(</span><span class="ident" id="5880062">codec</span><span class="op" id="5880067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880070">if</span>&nbsp;<span class="ident" id="5880073">err</span>&nbsp;<span class="op" id="5880077">!=</span>&nbsp;<span class="ident" id="5880080">nil</span>&nbsp;<span class="op" id="5880084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880088">if</span>&nbsp;<span class="op" id="5880091">!</span><span class="ident" id="5880092">keepReading</span>&nbsp;<span class="op" id="5880104">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880109">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880122">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880140">codec</span><span class="op" id="5880145">.</span><span class="ident" id="5880146">ReadRequestBody</span><span class="op" id="5880161">(</span><span class="ident" id="5880162">nil</span><span class="op" id="5880165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880169">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880181">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880212">argIsValue</span>&nbsp;<span class="op" id="5880223">:=</span>&nbsp;<span class="builtintype" id="5880226">false</span>&nbsp;<span class="comment" id="5880232">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880278">if</span>&nbsp;<span class="ident" id="5880281">mtype</span><span class="op" id="5880286">.</span><span class="ident" id="5880287">ArgType</span><span class="op" id="5880294">.</span><span class="ident" id="5880295">Kind</span><span class="op" id="5880299">(</span><span class="op" id="5880300">)</span>&nbsp;<span class="op" id="5880302">==</span>&nbsp;<span class="ident" id="5880305">reflect</span><span class="op" id="5880312">.</span><span class="ident" id="5880313">Ptr</span>&nbsp;<span class="op" id="5880317">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880321">argv</span>&nbsp;<span class="op" id="5880326">=</span>&nbsp;<span class="ident" id="5880328">reflect</span><span class="op" id="5880335">.</span><span class="ident" id="5880336">New</span><span class="op" id="5880339">(</span><span class="ident" id="5880340">mtype</span><span class="op" id="5880345">.</span><span class="ident" id="5880346">ArgType</span><span class="op" id="5880353">.</span><span class="ident" id="5880354">Elem</span><span class="op" id="5880358">(</span><span class="op" id="5880359">)</span><span class="op" id="5880360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880363">}</span>&nbsp;<span class="keyword" id="5880365">else</span>&nbsp;<span class="op" id="5880370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880374">argv</span>&nbsp;<span class="op" id="5880379">=</span>&nbsp;<span class="ident" id="5880381">reflect</span><span class="op" id="5880388">.</span><span class="ident" id="5880389">New</span><span class="op" id="5880392">(</span><span class="ident" id="5880393">mtype</span><span class="op" id="5880398">.</span><span class="ident" id="5880399">ArgType</span><span class="op" id="5880406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880410">argIsValue</span>&nbsp;<span class="op" id="5880421">=</span>&nbsp;<span class="builtintype" id="5880423">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880429">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880432">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880473">if</span>&nbsp;<span class="ident" id="5880476">err</span>&nbsp;<span class="op" id="5880480">=</span>&nbsp;<span class="ident" id="5880482">codec</span><span class="op" id="5880487">.</span><span class="ident" id="5880488">ReadRequestBody</span><span class="op" id="5880503">(</span><span class="ident" id="5880504">argv</span><span class="op" id="5880508">.</span><span class="ident" id="5880509">Interface</span><span class="op" id="5880518">(</span><span class="op" id="5880519">)</span><span class="op" id="5880520">)</span><span class="op" id="5880521">;</span>&nbsp;<span class="ident" id="5880523">err</span>&nbsp;<span class="op" id="5880527">!=</span>&nbsp;<span class="ident" id="5880530">nil</span>&nbsp;<span class="op" id="5880534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880538">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880549">if</span>&nbsp;<span class="ident" id="5880552">argIsValue</span>&nbsp;<span class="op" id="5880563">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880567">argv</span>&nbsp;<span class="op" id="5880572">=</span>&nbsp;<span class="ident" id="5880574">argv</span><span class="op" id="5880578">.</span><span class="ident" id="5880579">Elem</span><span class="op" id="5880583">(</span><span class="op" id="5880584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880591">replyv</span>&nbsp;<span class="op" id="5880598">=</span>&nbsp;<span class="ident" id="5880600">reflect</span><span class="op" id="5880607">.</span><span class="ident" id="5880608">New</span><span class="op" id="5880611">(</span><span class="ident" id="5880612">mtype</span><span class="op" id="5880617">.</span><span class="ident" id="5880618">ReplyType</span><span class="op" id="5880627">.</span><span class="ident" id="5880628">Elem</span><span class="op" id="5880632">(</span><span class="op" id="5880633">)</span><span class="op" id="5880634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880637">return</span><br>
<span class="lineno">570</span><span class="op" id="5880644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5880647">func</span>&nbsp;<span class="op" id="5880652">(</span><span class="ident" id="5880653">server</span>&nbsp;<span class="op" id="5880660">*</span><span class="ident" id="5880661">Server</span><span class="op" id="5880667">)</span>&nbsp;<span class="ident" id="5880669">readRequestHeader</span><span class="op" id="5880686">(</span><span class="ident" id="5880687">codec</span>&nbsp;<span class="ident" id="5880693">ServerCodec</span><span class="op" id="5880704">)</span>&nbsp;<span class="op" id="5880706">(</span><span class="ident" id="5880707">service</span>&nbsp;<span class="op" id="5880715">*</span><span class="ident" id="5880716">service</span><span class="op" id="5880723">,</span>&nbsp;<span class="ident" id="5880725">mtype</span>&nbsp;<span class="op" id="5880731">*</span><span class="ident" id="5880732">methodType</span><span class="op" id="5880742">,</span>&nbsp;<span class="ident" id="5880744">req</span>&nbsp;<span class="op" id="5880748">*</span><span class="ident" id="5880749">Request</span><span class="op" id="5880756">,</span>&nbsp;<span class="ident" id="5880758">keepReading</span>&nbsp;<span class="builtintype" id="5880770">bool</span><span class="op" id="5880774">,</span>&nbsp;<span class="ident" id="5880776">err</span>&nbsp;<span class="builtintype" id="5880780">error</span><span class="op" id="5880785">)</span>&nbsp;<span class="op" id="5880787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5880790">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880819">req</span>&nbsp;<span class="op" id="5880823">=</span>&nbsp;<span class="ident" id="5880825">server</span><span class="op" id="5880831">.</span><span class="ident" id="5880832">getRequest</span><span class="op" id="5880842">(</span><span class="op" id="5880843">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880846">err</span>&nbsp;<span class="op" id="5880850">=</span>&nbsp;<span class="ident" id="5880852">codec</span><span class="op" id="5880857">.</span><span class="ident" id="5880858">ReadRequestHeader</span><span class="op" id="5880875">(</span><span class="ident" id="5880876">req</span><span class="op" id="5880879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880882">if</span>&nbsp;<span class="ident" id="5880885">err</span>&nbsp;<span class="op" id="5880889">!=</span>&nbsp;<span class="ident" id="5880892">nil</span>&nbsp;<span class="op" id="5880896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880900">req</span>&nbsp;<span class="op" id="5880904">=</span>&nbsp;<span class="ident" id="5880906">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880912">if</span>&nbsp;<span class="ident" id="5880915">err</span>&nbsp;<span class="op" id="5880919">==</span>&nbsp;<span class="ident" id="5880922">io</span><span class="op" id="5880924">.</span><span class="ident" id="5880925">EOF</span>&nbsp;<span class="op" id="5880929">||</span>&nbsp;<span class="ident" id="5880932">err</span>&nbsp;<span class="op" id="5880936">==</span>&nbsp;<span class="ident" id="5880939">io</span><span class="op" id="5880941">.</span><span class="ident" id="5880942">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5880959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5880964">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5880973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5880977">err</span>&nbsp;<span class="op" id="5880981">=</span>&nbsp;<span class="ident" id="5880983">errors</span><span class="op" id="5880989">.</span><span class="ident" id="5880990">New</span><span class="op" id="5880993">(</span><span class="string" id="5880994">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="5881032">+</span>&nbsp;<span class="ident" id="5881034">err</span><span class="op" id="5881037">.</span><span class="ident" id="5881038">Error</span><span class="op" id="5881043">(</span><span class="op" id="5881044">)</span><span class="op" id="5881045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881049">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5881061">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5881123">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881181">keepReading</span>&nbsp;<span class="op" id="5881193">=</span>&nbsp;<span class="builtintype" id="5881195">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881202">dot</span>&nbsp;<span class="op" id="5881206">:=</span>&nbsp;<span class="ident" id="5881209">strings</span><span class="op" id="5881216">.</span><span class="ident" id="5881217">LastIndex</span><span class="op" id="5881226">(</span><span class="ident" id="5881227">req</span><span class="op" id="5881230">.</span><span class="ident" id="5881231">ServiceMethod</span><span class="op" id="5881244">,</span>&nbsp;<span class="string" id="5881246">&#34;.&#34;</span><span class="op" id="5881249">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881252">if</span>&nbsp;<span class="ident" id="5881255">dot</span>&nbsp;<span class="op" id="5881259">&lt;</span>&nbsp;<span class="num" id="5881261">0</span>&nbsp;<span class="op" id="5881263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881267">err</span>&nbsp;<span class="op" id="5881271">=</span>&nbsp;<span class="ident" id="5881273">errors</span><span class="op" id="5881279">.</span><span class="ident" id="5881280">New</span><span class="op" id="5881283">(</span><span class="string" id="5881284">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="5881327">+</span>&nbsp;<span class="ident" id="5881329">req</span><span class="op" id="5881332">.</span><span class="ident" id="5881333">ServiceMethod</span><span class="op" id="5881346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881350">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881361">serviceName</span>&nbsp;<span class="op" id="5881373">:=</span>&nbsp;<span class="ident" id="5881376">req</span><span class="op" id="5881379">.</span><span class="ident" id="5881380">ServiceMethod</span><span class="op" id="5881393">[</span><span class="op" id="5881394">:</span><span class="ident" id="5881395">dot</span><span class="op" id="5881398">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881401">methodName</span>&nbsp;<span class="op" id="5881412">:=</span>&nbsp;<span class="ident" id="5881415">req</span><span class="op" id="5881418">.</span><span class="ident" id="5881419">ServiceMethod</span><span class="op" id="5881432">[</span><span class="ident" id="5881433">dot</span><span class="op" id="5881436">+</span><span class="num" id="5881437">1</span><span class="op" id="5881438">:</span><span class="op" id="5881439">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5881443">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881468">server</span><span class="op" id="5881474">.</span><span class="ident" id="5881475">mu</span><span class="op" id="5881477">.</span><span class="ident" id="5881478">RLock</span><span class="op" id="5881483">(</span><span class="op" id="5881484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881487">service</span>&nbsp;<span class="op" id="5881495">=</span>&nbsp;<span class="ident" id="5881497">server</span><span class="op" id="5881503">.</span><span class="ident" id="5881504">serviceMap</span><span class="op" id="5881514">[</span><span class="ident" id="5881515">serviceName</span><span class="op" id="5881526">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881529">server</span><span class="op" id="5881535">.</span><span class="ident" id="5881536">mu</span><span class="op" id="5881538">.</span><span class="ident" id="5881539">RUnlock</span><span class="op" id="5881546">(</span><span class="op" id="5881547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881550">if</span>&nbsp;<span class="ident" id="5881553">service</span>&nbsp;<span class="op" id="5881561">==</span>&nbsp;<span class="ident" id="5881564">nil</span>&nbsp;<span class="op" id="5881568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881572">err</span>&nbsp;<span class="op" id="5881576">=</span>&nbsp;<span class="ident" id="5881578">errors</span><span class="op" id="5881584">.</span><span class="ident" id="5881585">New</span><span class="op" id="5881588">(</span><span class="string" id="5881589">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="5881616">+</span>&nbsp;<span class="ident" id="5881618">req</span><span class="op" id="5881621">.</span><span class="ident" id="5881622">ServiceMethod</span><span class="op" id="5881635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881639">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881647">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881650">mtype</span>&nbsp;<span class="op" id="5881656">=</span>&nbsp;<span class="ident" id="5881658">service</span><span class="op" id="5881665">.</span><span class="ident" id="5881666">method</span><span class="op" id="5881672">[</span><span class="ident" id="5881673">methodName</span><span class="op" id="5881683">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881686">if</span>&nbsp;<span class="ident" id="5881689">mtype</span>&nbsp;<span class="op" id="5881695">==</span>&nbsp;<span class="ident" id="5881698">nil</span>&nbsp;<span class="op" id="5881702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5881706">err</span>&nbsp;<span class="op" id="5881710">=</span>&nbsp;<span class="ident" id="5881712">errors</span><span class="op" id="5881718">.</span><span class="ident" id="5881719">New</span><span class="op" id="5881722">(</span><span class="string" id="5881723">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="5881749">+</span>&nbsp;<span class="ident" id="5881751">req</span><span class="op" id="5881754">.</span><span class="ident" id="5881755">ServiceMethod</span><span class="op" id="5881768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5881771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5881774">return</span><br>
<span class="lineno">610</span><span class="op" id="5881781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5881784">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5881850">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="5881920">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="5881953">func</span>&nbsp;<span class="op" id="5881958">(</span><span class="ident" id="5881959">server</span>&nbsp;<span class="op" id="5881966">*</span><span class="ident" id="5881967">Server</span><span class="op" id="5881973">)</span>&nbsp;<span class="ident" id="5881975">Accept</span><span class="op" id="5881981">(</span><span class="ident" id="5881982">lis</span>&nbsp;<span class="ident" id="5881986">net</span><span class="op" id="5881989">.</span><span class="ident" id="5881990">Listener</span><span class="op" id="5881998">)</span>&nbsp;<span class="op" id="5882000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882003">for</span>&nbsp;<span class="op" id="5882007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882011">conn</span><span class="op" id="5882015">,</span>&nbsp;<span class="ident" id="5882017">err</span>&nbsp;<span class="op" id="5882021">:=</span>&nbsp;<span class="ident" id="5882024">lis</span><span class="op" id="5882027">.</span><span class="ident" id="5882028">Accept</span><span class="op" id="5882034">(</span><span class="op" id="5882035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882039">if</span>&nbsp;<span class="ident" id="5882042">err</span>&nbsp;<span class="op" id="5882046">!=</span>&nbsp;<span class="ident" id="5882049">nil</span>&nbsp;<span class="op" id="5882053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5882058">log</span><span class="op" id="5882061">.</span><span class="ident" id="5882062">Fatal</span><span class="op" id="5882067">(</span><span class="string" id="5882068">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="5882088">,</span>&nbsp;<span class="ident" id="5882090">err</span><span class="op" id="5882093">.</span><span class="ident" id="5882094">Error</span><span class="op" id="5882099">(</span><span class="op" id="5882100">)</span><span class="op" id="5882101">)</span>&nbsp;<span class="comment" id="5882103">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882127">go</span>&nbsp;<span class="ident" id="5882130">server</span><span class="op" id="5882136">.</span><span class="ident" id="5882137">ServeConn</span><span class="op" id="5882146">(</span><span class="ident" id="5882147">conn</span><span class="op" id="5882151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5882154">}</span><br>
<span class="lineno"></span><span class="op" id="5882156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="5882159">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5882226">func</span>&nbsp;<span class="ident" id="5882231">Register</span><span class="op" id="5882239">(</span><span class="ident" id="5882240">rcvr</span>&nbsp;<span class="keyword" id="5882245">interface</span><span class="op" id="5882254">{</span><span class="op" id="5882255">}</span><span class="op" id="5882256">)</span>&nbsp;<span class="builtintype" id="5882258">error</span>&nbsp;<span class="op" id="5882264">{</span>&nbsp;<span class="keyword" id="5882266">return</span>&nbsp;<span class="ident" id="5882273">DefaultServer</span><span class="op" id="5882286">.</span><span class="ident" id="5882287">Register</span><span class="op" id="5882295">(</span><span class="ident" id="5882296">rcvr</span><span class="op" id="5882300">)</span>&nbsp;<span class="op" id="5882302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5882305">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5882378">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="5882422">func</span>&nbsp;<span class="ident" id="5882427">RegisterName</span><span class="op" id="5882439">(</span><span class="ident" id="5882440">name</span>&nbsp;<span class="builtintype" id="5882445">string</span><span class="op" id="5882451">,</span>&nbsp;<span class="ident" id="5882453">rcvr</span>&nbsp;<span class="keyword" id="5882458">interface</span><span class="op" id="5882467">{</span><span class="op" id="5882468">}</span><span class="op" id="5882469">)</span>&nbsp;<span class="builtintype" id="5882471">error</span>&nbsp;<span class="op" id="5882477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5882480">return</span>&nbsp;<span class="ident" id="5882487">DefaultServer</span><span class="op" id="5882500">.</span><span class="ident" id="5882501">RegisterName</span><span class="op" id="5882513">(</span><span class="ident" id="5882514">name</span><span class="op" id="5882518">,</span>&nbsp;<span class="ident" id="5882520">rcvr</span><span class="op" id="5882524">)</span><br>
<span class="lineno"></span><span class="op" id="5882526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5882529">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="5882596">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="5882652">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="5882719">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5882790">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5882863">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="5882919">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5882990">type</span>&nbsp;<span class="ident" id="5882995">ServerCodec</span>&nbsp;<span class="keyword" id="5883007">interface</span>&nbsp;<span class="op" id="5883017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883020">ReadRequestHeader</span><span class="op" id="5883037">(</span><span class="op" id="5883038">*</span><span class="ident" id="5883039">Request</span><span class="op" id="5883046">)</span>&nbsp;<span class="builtintype" id="5883048">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883055">ReadRequestBody</span><span class="op" id="5883070">(</span><span class="keyword" id="5883071">interface</span><span class="op" id="5883080">{</span><span class="op" id="5883081">}</span><span class="op" id="5883082">)</span>&nbsp;<span class="builtintype" id="5883084">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5883091">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883165">WriteResponse</span><span class="op" id="5883178">(</span><span class="op" id="5883179">*</span><span class="ident" id="5883180">Response</span><span class="op" id="5883188">,</span>&nbsp;<span class="keyword" id="5883190">interface</span><span class="op" id="5883199">{</span><span class="op" id="5883200">}</span><span class="op" id="5883201">)</span>&nbsp;<span class="builtintype" id="5883203">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883211">Close</span><span class="op" id="5883216">(</span><span class="op" id="5883217">)</span>&nbsp;<span class="builtintype" id="5883219">error</span><br>
<span class="lineno"></span><span class="op" id="5883225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="5883228">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5883288">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5883359">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5883420">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5883483">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="5883542">func</span>&nbsp;<span class="ident" id="5883547">ServeConn</span><span class="op" id="5883556">(</span><span class="ident" id="5883557">conn</span>&nbsp;<span class="ident" id="5883562">io</span><span class="op" id="5883564">.</span><span class="ident" id="5883565">ReadWriteCloser</span><span class="op" id="5883580">)</span>&nbsp;<span class="op" id="5883582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883585">DefaultServer</span><span class="op" id="5883598">.</span><span class="ident" id="5883599">ServeConn</span><span class="op" id="5883608">(</span><span class="ident" id="5883609">conn</span><span class="op" id="5883613">)</span><br>
<span class="lineno"></span><span class="op" id="5883615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5883618">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="5883682">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5883723">func</span>&nbsp;<span class="ident" id="5883728">ServeCodec</span><span class="op" id="5883738">(</span><span class="ident" id="5883739">codec</span>&nbsp;<span class="ident" id="5883745">ServerCodec</span><span class="op" id="5883756">)</span>&nbsp;<span class="op" id="5883758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5883761">DefaultServer</span><span class="op" id="5883774">.</span><span class="ident" id="5883775">ServeCodec</span><span class="op" id="5883785">(</span><span class="ident" id="5883786">codec</span><span class="op" id="5883791">)</span><br>
<span class="lineno"></span><span class="op" id="5883793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="5883796">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5883874">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5883922">func</span>&nbsp;<span class="ident" id="5883927">ServeRequest</span><span class="op" id="5883939">(</span><span class="ident" id="5883940">codec</span>&nbsp;<span class="ident" id="5883946">ServerCodec</span><span class="op" id="5883957">)</span>&nbsp;<span class="builtintype" id="5883959">error</span>&nbsp;<span class="op" id="5883965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5883968">return</span>&nbsp;<span class="ident" id="5883975">DefaultServer</span><span class="op" id="5883988">.</span><span class="ident" id="5883989">ServeRequest</span><span class="op" id="5884001">(</span><span class="ident" id="5884002">codec</span><span class="op" id="5884007">)</span><br>
<span class="lineno"></span><span class="op" id="5884009">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="5884012">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5884078">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5884128">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5884197">func</span>&nbsp;<span class="ident" id="5884202">Accept</span><span class="op" id="5884208">(</span><span class="ident" id="5884209">lis</span>&nbsp;<span class="ident" id="5884213">net</span><span class="op" id="5884216">.</span><span class="ident" id="5884217">Listener</span><span class="op" id="5884225">)</span>&nbsp;<span class="op" id="5884227">{</span>&nbsp;<span class="ident" id="5884229">DefaultServer</span><span class="op" id="5884242">.</span><span class="ident" id="5884243">Accept</span><span class="op" id="5884249">(</span><span class="ident" id="5884250">lis</span><span class="op" id="5884253">)</span>&nbsp;<span class="op" id="5884255">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="5884258">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="5884319">var</span>&nbsp;<span class="ident" id="5884323">connected</span>&nbsp;<span class="op" id="5884333">=</span>&nbsp;<span class="string" id="5884335">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5884362">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="5884429">func</span>&nbsp;<span class="op" id="5884434">(</span><span class="ident" id="5884435">server</span>&nbsp;<span class="op" id="5884442">*</span><span class="ident" id="5884443">Server</span><span class="op" id="5884449">)</span>&nbsp;<span class="ident" id="5884451">ServeHTTP</span><span class="op" id="5884460">(</span><span class="ident" id="5884461">w</span>&nbsp;<span class="ident" id="5884463">http</span><span class="op" id="5884467">.</span><span class="ident" id="5884468">ResponseWriter</span><span class="op" id="5884482">,</span>&nbsp;<span class="ident" id="5884484">req</span>&nbsp;<span class="op" id="5884488">*</span><span class="ident" id="5884489">http</span><span class="op" id="5884493">.</span><span class="ident" id="5884494">Request</span><span class="op" id="5884501">)</span>&nbsp;<span class="op" id="5884503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884506">if</span>&nbsp;<span class="ident" id="5884509">req</span><span class="op" id="5884512">.</span><span class="ident" id="5884513">Method</span>&nbsp;<span class="op" id="5884520">!=</span>&nbsp;<span class="string" id="5884523">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="5884533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884537">w</span><span class="op" id="5884538">.</span><span class="ident" id="5884539">Header</span><span class="op" id="5884545">(</span><span class="op" id="5884546">)</span><span class="op" id="5884547">.</span><span class="ident" id="5884548">Set</span><span class="op" id="5884551">(</span><span class="string" id="5884552">&#34;Content-Type&#34;</span><span class="op" id="5884566">,</span>&nbsp;<span class="string" id="5884568">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="5884595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884599">w</span><span class="op" id="5884600">.</span><span class="ident" id="5884601">WriteHeader</span><span class="op" id="5884612">(</span><span class="ident" id="5884613">http</span><span class="op" id="5884617">.</span><span class="ident" id="5884618">StatusMethodNotAllowed</span><span class="op" id="5884640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884644">io</span><span class="op" id="5884646">.</span><span class="ident" id="5884647">WriteString</span><span class="op" id="5884658">(</span><span class="ident" id="5884659">w</span><span class="op" id="5884660">,</span>&nbsp;<span class="string" id="5884662">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="5884682">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884686">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884697">conn</span><span class="op" id="5884701">,</span>&nbsp;<span class="ident" id="5884703">_</span><span class="op" id="5884704">,</span>&nbsp;<span class="ident" id="5884706">err</span>&nbsp;<span class="op" id="5884710">:=</span>&nbsp;<span class="ident" id="5884713">w</span><span class="op" id="5884714">.</span><span class="op" id="5884715">(</span><span class="ident" id="5884716">http</span><span class="op" id="5884720">.</span><span class="ident" id="5884721">Hijacker</span><span class="op" id="5884729">)</span><span class="op" id="5884730">.</span><span class="ident" id="5884731">Hijack</span><span class="op" id="5884737">(</span><span class="op" id="5884738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884741">if</span>&nbsp;<span class="ident" id="5884744">err</span>&nbsp;<span class="op" id="5884748">!=</span>&nbsp;<span class="ident" id="5884751">nil</span>&nbsp;<span class="op" id="5884755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884759">log</span><span class="op" id="5884762">.</span><span class="ident" id="5884763">Print</span><span class="op" id="5884768">(</span><span class="string" id="5884769">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="5884785">,</span>&nbsp;<span class="ident" id="5884787">req</span><span class="op" id="5884790">.</span><span class="ident" id="5884791">RemoteAddr</span><span class="op" id="5884801">,</span>&nbsp;<span class="string" id="5884803">&#34;:&nbsp;&#34;</span><span class="op" id="5884807">,</span>&nbsp;<span class="ident" id="5884809">err</span><span class="op" id="5884812">.</span><span class="ident" id="5884813">Error</span><span class="op" id="5884818">(</span><span class="op" id="5884819">)</span><span class="op" id="5884820">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5884824">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5884832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884835">io</span><span class="op" id="5884837">.</span><span class="ident" id="5884838">WriteString</span><span class="op" id="5884849">(</span><span class="ident" id="5884850">conn</span><span class="op" id="5884854">,</span>&nbsp;<span class="string" id="5884856">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="5884867">+</span><span class="ident" id="5884868">connected</span><span class="op" id="5884877">+</span><span class="string" id="5884878">&#34;\n\n&#34;</span><span class="op" id="5884884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5884887">server</span><span class="op" id="5884893">.</span><span class="ident" id="5884894">ServeConn</span><span class="op" id="5884903">(</span><span class="ident" id="5884904">conn</span><span class="op" id="5884908">)</span><br>
<span class="lineno"></span><span class="op" id="5884910">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="5884913">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="5884982">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5885023">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5885101">func</span>&nbsp;<span class="op" id="5885106">(</span><span class="ident" id="5885107">server</span>&nbsp;<span class="op" id="5885114">*</span><span class="ident" id="5885115">Server</span><span class="op" id="5885121">)</span>&nbsp;<span class="ident" id="5885123">HandleHTTP</span><span class="op" id="5885133">(</span><span class="ident" id="5885134">rpcPath</span><span class="op" id="5885141">,</span>&nbsp;<span class="ident" id="5885143">debugPath</span>&nbsp;<span class="builtintype" id="5885153">string</span><span class="op" id="5885159">)</span>&nbsp;<span class="op" id="5885161">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885164">http</span><span class="op" id="5885168">.</span><span class="ident" id="5885169">Handle</span><span class="op" id="5885175">(</span><span class="ident" id="5885176">rpcPath</span><span class="op" id="5885183">,</span>&nbsp;<span class="ident" id="5885185">server</span><span class="op" id="5885191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885194">http</span><span class="op" id="5885198">.</span><span class="ident" id="5885199">Handle</span><span class="op" id="5885205">(</span><span class="ident" id="5885206">debugPath</span><span class="op" id="5885215">,</span>&nbsp;<span class="ident" id="5885217">debugHTTP</span><span class="op" id="5885226">{</span><span class="ident" id="5885227">server</span><span class="op" id="5885233">}</span><span class="op" id="5885234">)</span><br>
<span class="lineno"></span><span class="op" id="5885236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5885239">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="5885313">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5885379">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5885457">func</span>&nbsp;<span class="ident" id="5885462">HandleHTTP</span><span class="op" id="5885472">(</span><span class="op" id="5885473">)</span>&nbsp;<span class="op" id="5885475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5885478">DefaultServer</span><span class="op" id="5885491">.</span><span class="ident" id="5885492">HandleHTTP</span><span class="op" id="5885502">(</span><span class="ident" id="5885503">DefaultRPCPath</span><span class="op" id="5885517">,</span>&nbsp;<span class="ident" id="5885519">DefaultDebugPath</span><span class="op" id="5885535">)</span><br>
<span class="lineno"></span><span class="op" id="5885537">}</span>
</div>
</body>
</html>
