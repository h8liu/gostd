<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html" class="current">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1420781">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1420837">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1420891">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1420942">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1420960">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1421011">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1421058">//</span><br>
<span class="lineno"></span><span class="comment" id="1421061">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1421127">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1421198">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1421267">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1421306">//</span><br>
<span class="lineno"></span><span class="comment" id="1421309">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1421383">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1421455">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1421524">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1421596">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1421663">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1421739">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1421811">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1421885">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1421963">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1422041">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1422121">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1422192">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1422270">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1422343">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1422365">//</span><br>
<span class="lineno">30</span><span class="comment" id="1422368">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1422440">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1422521">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1422598">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1422668">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1422741">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1422817">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1422891">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1422972">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1423056">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1423138">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1423177">//</span><br>
<span class="lineno"></span><span class="comment" id="1423180">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1423241">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1423319">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1423385">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1423458">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1423532">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1423605">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1423681">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1423746">package</span>&nbsp;<span class="ident" id="1423754">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1423763">import</span>&nbsp;<span class="string" id="1423770">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1423780">const</span>&nbsp;<span class="op" id="1423786">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423789">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1423805">=</span>&nbsp;<span class="num" id="1423807">1</span>&nbsp;<span class="op" id="1423809">&lt;&lt;</span>&nbsp;<span class="num" id="1423812">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423816">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1423832">=</span>&nbsp;<span class="num" id="1423834">1</span>&nbsp;<span class="op" id="1423836">&lt;&lt;</span>&nbsp;<span class="num" id="1423839">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423843">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1423859">=</span>&nbsp;<span class="num" id="1423861">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423864">maxCPUProfStack</span>&nbsp;<span class="op" id="1423880">=</span>&nbsp;<span class="num" id="1423882">64</span><br>
<span class="lineno">60</span><span class="op" id="1423885">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1423888">type</span>&nbsp;<span class="ident" id="1423893">cpuprofEntry</span>&nbsp;<span class="keyword" id="1423906">struct</span>&nbsp;<span class="op" id="1423913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423916">count</span>&nbsp;<span class="builtintype" id="1423922">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423931">depth</span>&nbsp;<span class="builtintype" id="1423937">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1423946">stack</span>&nbsp;<span class="op" id="1423952">[</span><span class="ident" id="1423953">maxCPUProfStack</span><span class="op" id="1423968">]</span><span class="builtintype" id="1423969">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1423977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1423980">type</span>&nbsp;<span class="ident" id="1423985">cpuProfile</span>&nbsp;<span class="keyword" id="1423996">struct</span>&nbsp;<span class="op" id="1424003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424006">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1424013">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1424021">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424041">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1424048">note</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1424056">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424081">count</span>&nbsp;&nbsp;<span class="builtintype" id="1424088">uintptr</span>&nbsp;<span class="comment" id="1424096">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424111">evicts</span>&nbsp;<span class="builtintype" id="1424118">uintptr</span>&nbsp;<span class="comment" id="1424126">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424145">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1424152">uintptr</span>&nbsp;<span class="comment" id="1424160">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1424199">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424231">hash</span>&nbsp;<span class="op" id="1424236">[</span><span class="ident" id="1424237">numBuckets</span><span class="op" id="1424247">]</span><span class="keyword" id="1424248">struct</span>&nbsp;<span class="op" id="1424255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424259">entry</span>&nbsp;<span class="op" id="1424265">[</span><span class="ident" id="1424266">assoc</span><span class="op" id="1424271">]</span><span class="ident" id="1424272">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1424286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1424290">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1424327">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1424377">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424427">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1424435">[</span><span class="num" id="1424436">2</span><span class="op" id="1424437">]</span><span class="op" id="1424438">[</span><span class="ident" id="1424439">logSize</span>&nbsp;<span class="op" id="1424447">/</span>&nbsp;<span class="num" id="1424449">2</span><span class="op" id="1424450">]</span><span class="builtintype" id="1424451">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424460">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1424468">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424477">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1424485">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424492">handoff</span>&nbsp;<span class="builtintype" id="1424500">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1424509">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1424527">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1424578">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424618">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1424627">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424635">wholding</span>&nbsp;<span class="builtintype" id="1424644">bool</span>&nbsp;<span class="comment" id="1424649">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424690">flushing</span>&nbsp;<span class="builtintype" id="1424699">bool</span>&nbsp;<span class="comment" id="1424704">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424746">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1424755">bool</span>&nbsp;<span class="comment" id="1424760">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1424808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1424811">var</span>&nbsp;<span class="op" id="1424815">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424818">cpuprofLock</span>&nbsp;<span class="ident" id="1424830">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424837">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1424849">*</span><span class="ident" id="1424850">cpuProfile</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424863">eod</span>&nbsp;<span class="op" id="1424867">=</span>&nbsp;<span class="op" id="1424869">[</span><span class="num" id="1424870">3</span><span class="op" id="1424871">]</span><span class="builtintype" id="1424872">uintptr</span><span class="op" id="1424879">{</span><span class="num" id="1424880">0</span><span class="op" id="1424881">,</span>&nbsp;<span class="num" id="1424883">1</span><span class="op" id="1424884">,</span>&nbsp;<span class="num" id="1424886">0</span><span class="op" id="1424887">}</span><br>
<span class="lineno"></span><span class="op" id="1424889">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1424892">func</span>&nbsp;<span class="ident" id="1424897">setcpuprofilerate_m</span><span class="op" id="1424916">(</span><span class="op" id="1424917">)</span>&nbsp;<span class="comment" id="1424919">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1424930">func</span>&nbsp;<span class="ident" id="1424935">setcpuprofilerate</span><span class="op" id="1424952">(</span><span class="ident" id="1424953">hz</span>&nbsp;<span class="builtintype" id="1424956">int32</span><span class="op" id="1424961">)</span>&nbsp;<span class="op" id="1424963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424966">g</span>&nbsp;<span class="op" id="1424968">:=</span>&nbsp;<span class="ident" id="1424971">getg</span><span class="op" id="1424975">(</span><span class="op" id="1424976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1424979">g</span><span class="op" id="1424980">.</span><span class="ident" id="1424981">m</span><span class="op" id="1424982">.</span><span class="ident" id="1424983">scalararg</span><span class="op" id="1424992">[</span><span class="num" id="1424993">0</span><span class="op" id="1424994">]</span>&nbsp;<span class="op" id="1424996">=</span>&nbsp;<span class="builtintype" id="1424998">uintptr</span><span class="op" id="1425005">(</span><span class="ident" id="1425006">hz</span><span class="op" id="1425008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1425011">onM</span><span class="op" id="1425014">(</span><span class="ident" id="1425015">setcpuprofilerate_m</span><span class="op" id="1425034">)</span><br>
<span class="lineno">110</span><span class="op" id="1425036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1425039">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1425095">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1425153">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1425192">func</span>&nbsp;<span class="ident" id="1425197">lostProfileData</span><span class="op" id="1425212">(</span><span class="op" id="1425213">)</span>&nbsp;<span class="op" id="1425215">{</span><span class="op" id="1425216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1425219">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1425294">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1425348">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1425431">//</span><br>
<span class="lineno"></span><span class="comment" id="1425434">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1425490">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1425556">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1425587">func</span>&nbsp;<span class="ident" id="1425592">SetCPUProfileRate</span><span class="op" id="1425609">(</span><span class="ident" id="1425610">hz</span>&nbsp;<span class="builtintype" id="1425613">int</span><span class="op" id="1425616">)</span>&nbsp;<span class="op" id="1425618">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1425621">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1425659">if</span>&nbsp;<span class="ident" id="1425662">hz</span>&nbsp;<span class="op" id="1425665">&lt;</span>&nbsp;<span class="num" id="1425667">0</span>&nbsp;<span class="op" id="1425669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1425673">hz</span>&nbsp;<span class="op" id="1425676">=</span>&nbsp;<span class="num" id="1425678">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1425681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1425684">if</span>&nbsp;<span class="ident" id="1425687">hz</span>&nbsp;<span class="op" id="1425690">&gt;</span>&nbsp;<span class="num" id="1425692">1000000</span>&nbsp;<span class="op" id="1425700">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1425704">hz</span>&nbsp;<span class="op" id="1425707">=</span>&nbsp;<span class="num" id="1425709">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1425718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1425722">lock</span><span class="op" id="1425726">(</span><span class="op" id="1425727">&amp;</span><span class="ident" id="1425728">cpuprofLock</span><span class="op" id="1425739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1425742">if</span>&nbsp;<span class="ident" id="1425745">hz</span>&nbsp;<span class="op" id="1425748">&gt;</span>&nbsp;<span class="num" id="1425750">0</span>&nbsp;<span class="op" id="1425752">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1425756">if</span>&nbsp;<span class="ident" id="1425759">cpuprof</span>&nbsp;<span class="op" id="1425767">==</span>&nbsp;<span class="builtintype" id="1425770">nil</span>&nbsp;<span class="op" id="1425774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1425779">cpuprof</span>&nbsp;<span class="op" id="1425787">=</span>&nbsp;<span class="op" id="1425789">(</span><span class="op" id="1425790">*</span><span class="ident" id="1425791">cpuProfile</span><span class="op" id="1425801">)</span><span class="op" id="1425802">(</span><span class="ident" id="1425803">sysAlloc</span><span class="op" id="1425811">(</span><span class="ident" id="1425812">unsafe</span><span class="op" id="1425818">.</span><span class="ident" id="1425819">Sizeof</span><span class="op" id="1425825">(</span><span class="ident" id="1425826">cpuProfile</span><span class="op" id="1425836">{</span><span class="op" id="1425837">}</span><span class="op" id="1425838">)</span><span class="op" id="1425839">,</span>&nbsp;<span class="op" id="1425841">&amp;</span><span class="ident" id="1425842">memstats</span><span class="op" id="1425850">.</span><span class="ident" id="1425851">other_sys</span><span class="op" id="1425860">)</span><span class="op" id="1425861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1425866">if</span>&nbsp;<span class="ident" id="1425869">cpuprof</span>&nbsp;<span class="op" id="1425877">==</span>&nbsp;<span class="builtintype" id="1425880">nil</span>&nbsp;<span class="op" id="1425884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1425890">print</span><span class="op" id="1425895">(</span><span class="string" id="1425896">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1425945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1425951">unlock</span><span class="op" id="1425957">(</span><span class="op" id="1425958">&amp;</span><span class="ident" id="1425959">cpuprofLock</span><span class="op" id="1425970">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1425976">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1425986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1425990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1425994">if</span>&nbsp;<span class="ident" id="1425997">cpuprof</span><span class="op" id="1426004">.</span><span class="ident" id="1426005">on</span>&nbsp;<span class="op" id="1426008">||</span>&nbsp;<span class="ident" id="1426011">cpuprof</span><span class="op" id="1426018">.</span><span class="ident" id="1426019">handoff</span>&nbsp;<span class="op" id="1426027">!=</span>&nbsp;<span class="num" id="1426030">0</span>&nbsp;<span class="op" id="1426032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1426037">print</span><span class="op" id="1426042">(</span><span class="string" id="1426043">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1426120">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426125">unlock</span><span class="op" id="1426131">(</span><span class="op" id="1426132">&amp;</span><span class="ident" id="1426133">cpuprofLock</span><span class="op" id="1426144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1426149">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1426158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426163">cpuprof</span><span class="op" id="1426170">.</span><span class="ident" id="1426171">on</span>&nbsp;<span class="op" id="1426174">=</span>&nbsp;<span class="builtintype" id="1426176">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1426183">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1426216">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426306">p</span>&nbsp;<span class="op" id="1426308">:=</span>&nbsp;<span class="op" id="1426311">&amp;</span><span class="ident" id="1426312">cpuprof</span><span class="op" id="1426319">.</span><span class="ident" id="1426320">log</span><span class="op" id="1426323">[</span><span class="num" id="1426324">0</span><span class="op" id="1426325">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426329">p</span><span class="op" id="1426330">[</span><span class="num" id="1426331">0</span><span class="op" id="1426332">]</span>&nbsp;<span class="op" id="1426334">=</span>&nbsp;<span class="num" id="1426336">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1426354">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426376">p</span><span class="op" id="1426377">[</span><span class="num" id="1426378">1</span><span class="op" id="1426379">]</span>&nbsp;<span class="op" id="1426381">=</span>&nbsp;<span class="num" id="1426383">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1426401">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426423">p</span><span class="op" id="1426424">[</span><span class="num" id="1426425">2</span><span class="op" id="1426426">]</span>&nbsp;<span class="op" id="1426428">=</span>&nbsp;<span class="num" id="1426430">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1426448">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426468">p</span><span class="op" id="1426469">[</span><span class="num" id="1426470">3</span><span class="op" id="1426471">]</span>&nbsp;<span class="op" id="1426473">=</span>&nbsp;<span class="builtintype" id="1426475">uintptr</span><span class="op" id="1426482">(</span><span class="num" id="1426483">1e6</span>&nbsp;<span class="op" id="1426487">/</span>&nbsp;<span class="ident" id="1426489">hz</span><span class="op" id="1426491">)</span>&nbsp;<span class="comment" id="1426493">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426520">p</span><span class="op" id="1426521">[</span><span class="num" id="1426522">4</span><span class="op" id="1426523">]</span>&nbsp;<span class="op" id="1426525">=</span>&nbsp;<span class="num" id="1426527">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426531">cpuprof</span><span class="op" id="1426538">.</span><span class="ident" id="1426539">nlog</span>&nbsp;<span class="op" id="1426544">=</span>&nbsp;<span class="num" id="1426546">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426550">cpuprof</span><span class="op" id="1426557">.</span><span class="ident" id="1426558">toggle</span>&nbsp;<span class="op" id="1426565">=</span>&nbsp;<span class="num" id="1426567">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426571">cpuprof</span><span class="op" id="1426578">.</span><span class="ident" id="1426579">wholding</span>&nbsp;<span class="op" id="1426588">=</span>&nbsp;<span class="builtintype" id="1426590">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426598">cpuprof</span><span class="op" id="1426605">.</span><span class="ident" id="1426606">wtoggle</span>&nbsp;<span class="op" id="1426614">=</span>&nbsp;<span class="num" id="1426616">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426620">cpuprof</span><span class="op" id="1426627">.</span><span class="ident" id="1426628">flushing</span>&nbsp;<span class="op" id="1426637">=</span>&nbsp;<span class="builtintype" id="1426639">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426647">cpuprof</span><span class="op" id="1426654">.</span><span class="ident" id="1426655">eodSent</span>&nbsp;<span class="op" id="1426663">=</span>&nbsp;<span class="builtintype" id="1426665">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426673">noteclear</span><span class="op" id="1426682">(</span><span class="op" id="1426683">&amp;</span><span class="ident" id="1426684">cpuprof</span><span class="op" id="1426691">.</span><span class="ident" id="1426692">wait</span><span class="op" id="1426696">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426701">setcpuprofilerate</span><span class="op" id="1426718">(</span><span class="builtintype" id="1426719">int32</span><span class="op" id="1426724">(</span><span class="ident" id="1426725">hz</span><span class="op" id="1426727">)</span><span class="op" id="1426728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1426731">}</span>&nbsp;<span class="keyword" id="1426733">else</span>&nbsp;<span class="keyword" id="1426738">if</span>&nbsp;<span class="ident" id="1426741">cpuprof</span>&nbsp;<span class="op" id="1426749">!=</span>&nbsp;<span class="builtintype" id="1426752">nil</span>&nbsp;<span class="op" id="1426756">&amp;&amp;</span>&nbsp;<span class="ident" id="1426759">cpuprof</span><span class="op" id="1426766">.</span><span class="ident" id="1426767">on</span>&nbsp;<span class="op" id="1426770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426774">setcpuprofilerate</span><span class="op" id="1426791">(</span><span class="num" id="1426792">0</span><span class="op" id="1426793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426797">cpuprof</span><span class="op" id="1426804">.</span><span class="ident" id="1426805">on</span>&nbsp;<span class="op" id="1426808">=</span>&nbsp;<span class="builtintype" id="1426810">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1426819">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1426892">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1426951">for</span>&nbsp;<span class="op" id="1426955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1426960">n</span>&nbsp;<span class="op" id="1426962">:=</span>&nbsp;<span class="ident" id="1426965">cpuprof</span><span class="op" id="1426972">.</span><span class="ident" id="1426973">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1426984">if</span>&nbsp;<span class="ident" id="1426987">n</span><span class="op" id="1426988">&amp;</span><span class="num" id="1426989">0x80000000</span>&nbsp;<span class="op" id="1427000">!=</span>&nbsp;<span class="num" id="1427003">0</span>&nbsp;<span class="op" id="1427005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1427011">print</span><span class="op" id="1427016">(</span><span class="string" id="1427017">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1427054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1427059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1427064">if</span>&nbsp;<span class="ident" id="1427067">cas</span><span class="op" id="1427070">(</span><span class="op" id="1427071">&amp;</span><span class="ident" id="1427072">cpuprof</span><span class="op" id="1427079">.</span><span class="ident" id="1427080">handoff</span><span class="op" id="1427087">,</span>&nbsp;<span class="ident" id="1427089">n</span><span class="op" id="1427090">,</span>&nbsp;<span class="ident" id="1427092">n</span><span class="op" id="1427093">|</span><span class="num" id="1427094">0x80000000</span><span class="op" id="1427104">)</span>&nbsp;<span class="op" id="1427106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1427112">if</span>&nbsp;<span class="ident" id="1427115">n</span>&nbsp;<span class="op" id="1427117">==</span>&nbsp;<span class="num" id="1427120">0</span>&nbsp;<span class="op" id="1427122">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1427129">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1427199">notewakeup</span><span class="op" id="1427209">(</span><span class="op" id="1427210">&amp;</span><span class="ident" id="1427211">cpuprof</span><span class="op" id="1427218">.</span><span class="ident" id="1427219">wait</span><span class="op" id="1427223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1427229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1427235">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1427244">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1427248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1427251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1427254">unlock</span><span class="op" id="1427260">(</span><span class="op" id="1427261">&amp;</span><span class="ident" id="1427262">cpuprofLock</span><span class="op" id="1427273">)</span><br>
<span class="lineno"></span><span class="op" id="1427275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1427278">func</span>&nbsp;<span class="ident" id="1427283">cpuproftick</span><span class="op" id="1427294">(</span><span class="ident" id="1427295">pc</span>&nbsp;<span class="op" id="1427298">*</span><span class="builtintype" id="1427299">uintptr</span><span class="op" id="1427306">,</span>&nbsp;<span class="ident" id="1427308">n</span>&nbsp;<span class="builtintype" id="1427310">int32</span><span class="op" id="1427315">)</span>&nbsp;<span class="op" id="1427317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1427320">if</span>&nbsp;<span class="ident" id="1427323">n</span>&nbsp;<span class="op" id="1427325">&gt;</span>&nbsp;<span class="ident" id="1427327">maxCPUProfStack</span>&nbsp;<span class="op" id="1427343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1427347">n</span>&nbsp;<span class="op" id="1427349">=</span>&nbsp;<span class="ident" id="1427351">maxCPUProfStack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1427368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1427371">s</span>&nbsp;<span class="op" id="1427373">:=</span>&nbsp;<span class="op" id="1427376">(</span><span class="op" id="1427377">*</span><span class="op" id="1427378">[</span><span class="ident" id="1427379">maxCPUProfStack</span><span class="op" id="1427394">]</span><span class="builtintype" id="1427395">uintptr</span><span class="op" id="1427402">)</span><span class="op" id="1427403">(</span><span class="ident" id="1427404">unsafe</span><span class="op" id="1427410">.</span><span class="ident" id="1427411">Pointer</span><span class="op" id="1427418">(</span><span class="ident" id="1427419">pc</span><span class="op" id="1427421">)</span><span class="op" id="1427422">)</span><span class="op" id="1427423">[</span><span class="op" id="1427424">:</span><span class="ident" id="1427425">n</span><span class="op" id="1427426">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1427429">cpuprof</span><span class="op" id="1427436">.</span><span class="ident" id="1427437">add</span><span class="op" id="1427440">(</span><span class="ident" id="1427441">s</span><span class="op" id="1427442">)</span><br>
<span class="lineno"></span><span class="op" id="1427444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1427447">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1427491">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1427559">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1427620">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1427690">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1427733">func</span>&nbsp;<span class="op" id="1427738">(</span><span class="ident" id="1427739">p</span>&nbsp;<span class="op" id="1427741">*</span><span class="ident" id="1427742">cpuProfile</span><span class="op" id="1427752">)</span>&nbsp;<span class="ident" id="1427754">add</span><span class="op" id="1427757">(</span><span class="ident" id="1427758">pc</span>&nbsp;<span class="op" id="1427761">[</span><span class="op" id="1427762">]</span><span class="builtintype" id="1427763">uintptr</span><span class="op" id="1427770">)</span>&nbsp;<span class="op" id="1427772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1427775">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1427793">h</span>&nbsp;<span class="op" id="1427795">:=</span>&nbsp;<span class="builtintype" id="1427798">uintptr</span><span class="op" id="1427805">(</span><span class="num" id="1427806">0</span><span class="op" id="1427807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1427810">for</span>&nbsp;<span class="ident" id="1427814">_</span><span class="op" id="1427815">,</span>&nbsp;<span class="ident" id="1427817">x</span>&nbsp;<span class="op" id="1427819">:=</span>&nbsp;<span class="keyword" id="1427822">range</span>&nbsp;<span class="ident" id="1427828">pc</span>&nbsp;<span class="op" id="1427831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1427835">h</span>&nbsp;<span class="op" id="1427837">=</span>&nbsp;<span class="ident" id="1427839">h</span><span class="op" id="1427840">&lt;&lt;</span><span class="num" id="1427842">8</span>&nbsp;<span class="op" id="1427844">|</span>&nbsp;<span class="op" id="1427846">(</span><span class="ident" id="1427847">h</span>&nbsp;<span class="op" id="1427849">&gt;&gt;</span>&nbsp;<span class="op" id="1427852">(</span><span class="num" id="1427853">8</span>&nbsp;<span class="op" id="1427855">*</span>&nbsp;<span class="op" id="1427857">(</span><span class="ident" id="1427858">unsafe</span><span class="op" id="1427864">.</span><span class="ident" id="1427865">Sizeof</span><span class="op" id="1427871">(</span><span class="ident" id="1427872">h</span><span class="op" id="1427873">)</span>&nbsp;<span class="op" id="1427875">-</span>&nbsp;<span class="num" id="1427877">1</span><span class="op" id="1427878">)</span><span class="op" id="1427879">)</span><span class="op" id="1427880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1427884">h</span>&nbsp;<span class="op" id="1427886">+=</span>&nbsp;<span class="ident" id="1427889">x</span><span class="op" id="1427890">*</span><span class="num" id="1427891">31</span>&nbsp;<span class="op" id="1427894">+</span>&nbsp;<span class="ident" id="1427896">x</span><span class="op" id="1427897">*</span><span class="num" id="1427898">7</span>&nbsp;<span class="op" id="1427900">+</span>&nbsp;<span class="ident" id="1427902">x</span><span class="op" id="1427903">*</span><span class="num" id="1427904">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1427907">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1427910">p</span><span class="op" id="1427911">.</span><span class="ident" id="1427912">count</span><span class="op" id="1427917">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1427922">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1427974">b</span>&nbsp;<span class="op" id="1427976">:=</span>&nbsp;<span class="op" id="1427979">&amp;</span><span class="ident" id="1427980">p</span><span class="op" id="1427981">.</span><span class="ident" id="1427982">hash</span><span class="op" id="1427986">[</span><span class="ident" id="1427987">h</span><span class="op" id="1427988">%</span><span class="ident" id="1427989">numBuckets</span><span class="op" id="1427999">]</span><br>
<span class="lineno"></span><span class="ident" id="1428001">Assoc</span><span class="op" id="1428006">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428009">for</span>&nbsp;<span class="ident" id="1428013">i</span>&nbsp;<span class="op" id="1428015">:=</span>&nbsp;<span class="keyword" id="1428018">range</span>&nbsp;<span class="ident" id="1428024">b</span><span class="op" id="1428025">.</span><span class="ident" id="1428026">entry</span>&nbsp;<span class="op" id="1428032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1428036">e</span>&nbsp;<span class="op" id="1428038">:=</span>&nbsp;<span class="op" id="1428041">&amp;</span><span class="ident" id="1428042">b</span><span class="op" id="1428043">.</span><span class="ident" id="1428044">entry</span><span class="op" id="1428049">[</span><span class="ident" id="1428050">i</span><span class="op" id="1428051">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428055">if</span>&nbsp;<span class="ident" id="1428058">e</span><span class="op" id="1428059">.</span><span class="ident" id="1428060">depth</span>&nbsp;<span class="op" id="1428066">!=</span>&nbsp;<span class="builtintype" id="1428069">uintptr</span><span class="op" id="1428076">(</span><span class="builtinfunc" id="1428077">len</span><span class="op" id="1428080">(</span><span class="ident" id="1428081">pc</span><span class="op" id="1428083">)</span><span class="op" id="1428084">)</span>&nbsp;<span class="op" id="1428086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428091">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1428102">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428106">for</span>&nbsp;<span class="ident" id="1428110">j</span>&nbsp;<span class="op" id="1428112">:=</span>&nbsp;<span class="keyword" id="1428115">range</span>&nbsp;<span class="ident" id="1428121">pc</span>&nbsp;<span class="op" id="1428124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428129">if</span>&nbsp;<span class="ident" id="1428132">e</span><span class="op" id="1428133">.</span><span class="ident" id="1428134">stack</span><span class="op" id="1428139">[</span><span class="ident" id="1428140">j</span><span class="op" id="1428141">]</span>&nbsp;<span class="op" id="1428143">!=</span>&nbsp;<span class="ident" id="1428146">pc</span><span class="op" id="1428148">[</span><span class="ident" id="1428149">j</span><span class="op" id="1428150">]</span>&nbsp;<span class="op" id="1428152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428158">continue</span>&nbsp;<span class="ident" id="1428167">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1428176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1428180">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1428184">e</span><span class="op" id="1428185">.</span><span class="ident" id="1428186">count</span><span class="op" id="1428191">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428196">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1428204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1428208">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428245">var</span>&nbsp;<span class="ident" id="1428249">e</span>&nbsp;<span class="op" id="1428251">*</span><span class="ident" id="1428252">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428266">for</span>&nbsp;<span class="ident" id="1428270">i</span>&nbsp;<span class="op" id="1428272">:=</span>&nbsp;<span class="keyword" id="1428275">range</span>&nbsp;<span class="ident" id="1428281">b</span><span class="op" id="1428282">.</span><span class="ident" id="1428283">entry</span>&nbsp;<span class="op" id="1428289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428293">if</span>&nbsp;<span class="ident" id="1428296">e</span>&nbsp;<span class="op" id="1428298">==</span>&nbsp;<span class="builtintype" id="1428301">nil</span>&nbsp;<span class="op" id="1428305">||</span>&nbsp;<span class="ident" id="1428308">b</span><span class="op" id="1428309">.</span><span class="ident" id="1428310">entry</span><span class="op" id="1428315">[</span><span class="ident" id="1428316">i</span><span class="op" id="1428317">]</span><span class="op" id="1428318">.</span><span class="ident" id="1428319">count</span>&nbsp;<span class="op" id="1428325">&lt;</span>&nbsp;<span class="ident" id="1428327">e</span><span class="op" id="1428328">.</span><span class="ident" id="1428329">count</span>&nbsp;<span class="op" id="1428335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1428340">e</span>&nbsp;<span class="op" id="1428342">=</span>&nbsp;<span class="op" id="1428344">&amp;</span><span class="ident" id="1428345">b</span><span class="op" id="1428346">.</span><span class="ident" id="1428347">entry</span><span class="op" id="1428352">[</span><span class="ident" id="1428353">i</span><span class="op" id="1428354">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1428358">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1428361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428364">if</span>&nbsp;<span class="ident" id="1428367">e</span><span class="op" id="1428368">.</span><span class="ident" id="1428369">count</span>&nbsp;<span class="op" id="1428375">&gt;</span>&nbsp;<span class="num" id="1428377">0</span>&nbsp;<span class="op" id="1428379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428383">if</span>&nbsp;<span class="op" id="1428386">!</span><span class="ident" id="1428387">p</span><span class="op" id="1428388">.</span><span class="ident" id="1428389">evict</span><span class="op" id="1428394">(</span><span class="ident" id="1428395">e</span><span class="op" id="1428396">)</span>&nbsp;<span class="op" id="1428398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1428403">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1428452">p</span><span class="op" id="1428453">.</span><span class="ident" id="1428454">lost</span><span class="op" id="1428458">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1428464">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1428473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1428477">p</span><span class="op" id="1428478">.</span><span class="ident" id="1428479">evicts</span><span class="op" id="1428485">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1428489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1428493">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1428528">e</span><span class="op" id="1428529">.</span><span class="ident" id="1428530">depth</span>&nbsp;<span class="op" id="1428536">=</span>&nbsp;<span class="builtintype" id="1428538">uintptr</span><span class="op" id="1428545">(</span><span class="builtinfunc" id="1428546">len</span><span class="op" id="1428549">(</span><span class="ident" id="1428550">pc</span><span class="op" id="1428552">)</span><span class="op" id="1428553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1428556">e</span><span class="op" id="1428557">.</span><span class="ident" id="1428558">count</span>&nbsp;<span class="op" id="1428564">=</span>&nbsp;<span class="num" id="1428566">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1428569">copy</span><span class="op" id="1428573">(</span><span class="ident" id="1428574">e</span><span class="op" id="1428575">.</span><span class="ident" id="1428576">stack</span><span class="op" id="1428581">[</span><span class="op" id="1428582">:</span><span class="op" id="1428583">]</span><span class="op" id="1428584">,</span>&nbsp;<span class="ident" id="1428586">pc</span><span class="op" id="1428588">)</span><br>
<span class="lineno"></span><span class="op" id="1428590">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1428593">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1428654">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1428715">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1428778">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1428837">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1428895">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1428936">func</span>&nbsp;<span class="op" id="1428941">(</span><span class="ident" id="1428942">p</span>&nbsp;<span class="op" id="1428944">*</span><span class="ident" id="1428945">cpuProfile</span><span class="op" id="1428955">)</span>&nbsp;<span class="ident" id="1428957">evict</span><span class="op" id="1428962">(</span><span class="ident" id="1428963">e</span>&nbsp;<span class="op" id="1428965">*</span><span class="ident" id="1428966">cpuprofEntry</span><span class="op" id="1428978">)</span>&nbsp;<span class="builtintype" id="1428980">bool</span>&nbsp;<span class="op" id="1428985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1428988">d</span>&nbsp;<span class="op" id="1428990">:=</span>&nbsp;<span class="ident" id="1428993">e</span><span class="op" id="1428994">.</span><span class="ident" id="1428995">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429002">nslot</span>&nbsp;<span class="op" id="1429008">:=</span>&nbsp;<span class="ident" id="1429011">d</span>&nbsp;<span class="op" id="1429013">+</span>&nbsp;<span class="num" id="1429015">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429018">log</span>&nbsp;<span class="op" id="1429022">:=</span>&nbsp;<span class="op" id="1429025">&amp;</span><span class="ident" id="1429026">p</span><span class="op" id="1429027">.</span><span class="ident" id="1429028">log</span><span class="op" id="1429031">[</span><span class="ident" id="1429032">p</span><span class="op" id="1429033">.</span><span class="ident" id="1429034">toggle</span><span class="op" id="1429040">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1429043">if</span>&nbsp;<span class="ident" id="1429046">p</span><span class="op" id="1429047">.</span><span class="ident" id="1429048">nlog</span><span class="op" id="1429052">+</span><span class="ident" id="1429053">nslot</span>&nbsp;<span class="op" id="1429059">&gt;</span>&nbsp;<span class="builtintype" id="1429061">uintptr</span><span class="op" id="1429068">(</span><span class="builtinfunc" id="1429069">len</span><span class="op" id="1429072">(</span><span class="ident" id="1429073">p</span><span class="op" id="1429074">.</span><span class="ident" id="1429075">log</span><span class="op" id="1429078">[</span><span class="num" id="1429079">0</span><span class="op" id="1429080">]</span><span class="op" id="1429081">)</span><span class="op" id="1429082">)</span>&nbsp;<span class="op" id="1429084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1429088">if</span>&nbsp;<span class="op" id="1429091">!</span><span class="ident" id="1429092">p</span><span class="op" id="1429093">.</span><span class="ident" id="1429094">flushlog</span><span class="op" id="1429102">(</span><span class="op" id="1429103">)</span>&nbsp;<span class="op" id="1429105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1429110">return</span>&nbsp;<span class="builtintype" id="1429117">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1429125">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429129">log</span>&nbsp;<span class="op" id="1429133">=</span>&nbsp;<span class="op" id="1429135">&amp;</span><span class="ident" id="1429136">p</span><span class="op" id="1429137">.</span><span class="ident" id="1429138">log</span><span class="op" id="1429141">[</span><span class="ident" id="1429142">p</span><span class="op" id="1429143">.</span><span class="ident" id="1429144">toggle</span><span class="op" id="1429150">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1429153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429157">q</span>&nbsp;<span class="op" id="1429159">:=</span>&nbsp;<span class="ident" id="1429162">p</span><span class="op" id="1429163">.</span><span class="ident" id="1429164">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429170">log</span><span class="op" id="1429173">[</span><span class="ident" id="1429174">q</span><span class="op" id="1429175">]</span>&nbsp;<span class="op" id="1429177">=</span>&nbsp;<span class="ident" id="1429179">e</span><span class="op" id="1429180">.</span><span class="ident" id="1429181">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429188">q</span><span class="op" id="1429189">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429193">log</span><span class="op" id="1429196">[</span><span class="ident" id="1429197">q</span><span class="op" id="1429198">]</span>&nbsp;<span class="op" id="1429200">=</span>&nbsp;<span class="ident" id="1429202">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429205">q</span><span class="op" id="1429206">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1429210">copy</span><span class="op" id="1429214">(</span><span class="ident" id="1429215">log</span><span class="op" id="1429218">[</span><span class="ident" id="1429219">q</span><span class="op" id="1429220">:</span><span class="op" id="1429221">]</span><span class="op" id="1429222">,</span>&nbsp;<span class="ident" id="1429224">e</span><span class="op" id="1429225">.</span><span class="ident" id="1429226">stack</span><span class="op" id="1429231">[</span><span class="op" id="1429232">:</span><span class="ident" id="1429233">d</span><span class="op" id="1429234">]</span><span class="op" id="1429235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429238">q</span>&nbsp;<span class="op" id="1429240">+=</span>&nbsp;<span class="ident" id="1429243">d</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429246">p</span><span class="op" id="1429247">.</span><span class="ident" id="1429248">nlog</span>&nbsp;<span class="op" id="1429253">=</span>&nbsp;<span class="ident" id="1429255">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429258">e</span><span class="op" id="1429259">.</span><span class="ident" id="1429260">count</span>&nbsp;<span class="op" id="1429266">=</span>&nbsp;<span class="num" id="1429268">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1429271">return</span>&nbsp;<span class="builtintype" id="1429278">true</span><br>
<span class="lineno"></span><span class="op" id="1429283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1429286">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1429358">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1429441">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1429513">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1429592">func</span>&nbsp;<span class="op" id="1429597">(</span><span class="ident" id="1429598">p</span>&nbsp;<span class="op" id="1429600">*</span><span class="ident" id="1429601">cpuProfile</span><span class="op" id="1429611">)</span>&nbsp;<span class="ident" id="1429613">flushlog</span><span class="op" id="1429621">(</span><span class="op" id="1429622">)</span>&nbsp;<span class="builtintype" id="1429624">bool</span>&nbsp;<span class="op" id="1429629">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1429632">if</span>&nbsp;<span class="op" id="1429635">!</span><span class="ident" id="1429636">cas</span><span class="op" id="1429639">(</span><span class="op" id="1429640">&amp;</span><span class="ident" id="1429641">p</span><span class="op" id="1429642">.</span><span class="ident" id="1429643">handoff</span><span class="op" id="1429650">,</span>&nbsp;<span class="num" id="1429652">0</span><span class="op" id="1429653">,</span>&nbsp;<span class="builtintype" id="1429655">uint32</span><span class="op" id="1429661">(</span><span class="ident" id="1429662">p</span><span class="op" id="1429663">.</span><span class="ident" id="1429664">nlog</span><span class="op" id="1429668">)</span><span class="op" id="1429669">)</span>&nbsp;<span class="op" id="1429671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1429675">return</span>&nbsp;<span class="builtintype" id="1429682">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1429689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429692">notewakeup</span><span class="op" id="1429702">(</span><span class="op" id="1429703">&amp;</span><span class="ident" id="1429704">p</span><span class="op" id="1429705">.</span><span class="ident" id="1429706">wait</span><span class="op" id="1429710">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429714">p</span><span class="op" id="1429715">.</span><span class="ident" id="1429716">toggle</span>&nbsp;<span class="op" id="1429723">=</span>&nbsp;<span class="num" id="1429725">1</span>&nbsp;<span class="op" id="1429727">-</span>&nbsp;<span class="ident" id="1429729">p</span><span class="op" id="1429730">.</span><span class="ident" id="1429731">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429739">log</span>&nbsp;<span class="op" id="1429743">:=</span>&nbsp;<span class="op" id="1429746">&amp;</span><span class="ident" id="1429747">p</span><span class="op" id="1429748">.</span><span class="ident" id="1429749">log</span><span class="op" id="1429752">[</span><span class="ident" id="1429753">p</span><span class="op" id="1429754">.</span><span class="ident" id="1429755">toggle</span><span class="op" id="1429761">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429764">q</span>&nbsp;<span class="op" id="1429766">:=</span>&nbsp;<span class="builtintype" id="1429769">uintptr</span><span class="op" id="1429776">(</span><span class="num" id="1429777">0</span><span class="op" id="1429778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1429781">if</span>&nbsp;<span class="ident" id="1429784">p</span><span class="op" id="1429785">.</span><span class="ident" id="1429786">lost</span>&nbsp;<span class="op" id="1429791">&gt;</span>&nbsp;<span class="num" id="1429793">0</span>&nbsp;<span class="op" id="1429795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429799">lostPC</span>&nbsp;<span class="op" id="1429806">:=</span>&nbsp;<span class="ident" id="1429809">funcPC</span><span class="op" id="1429815">(</span><span class="ident" id="1429816">lostProfileData</span><span class="op" id="1429831">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429835">log</span><span class="op" id="1429838">[</span><span class="num" id="1429839">0</span><span class="op" id="1429840">]</span>&nbsp;<span class="op" id="1429842">=</span>&nbsp;<span class="ident" id="1429844">p</span><span class="op" id="1429845">.</span><span class="ident" id="1429846">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429853">log</span><span class="op" id="1429856">[</span><span class="num" id="1429857">1</span><span class="op" id="1429858">]</span>&nbsp;<span class="op" id="1429860">=</span>&nbsp;<span class="num" id="1429862">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429866">log</span><span class="op" id="1429869">[</span><span class="num" id="1429870">2</span><span class="op" id="1429871">]</span>&nbsp;<span class="op" id="1429873">=</span>&nbsp;<span class="ident" id="1429875">lostPC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429884">q</span>&nbsp;<span class="op" id="1429886">=</span>&nbsp;<span class="num" id="1429888">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429892">p</span><span class="op" id="1429893">.</span><span class="ident" id="1429894">lost</span>&nbsp;<span class="op" id="1429899">=</span>&nbsp;<span class="num" id="1429901">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1429904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1429907">p</span><span class="op" id="1429908">.</span><span class="ident" id="1429909">nlog</span>&nbsp;<span class="op" id="1429914">=</span>&nbsp;<span class="ident" id="1429916">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1429919">return</span>&nbsp;<span class="builtintype" id="1429926">true</span><br>
<span class="lineno"></span><span class="op" id="1429931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1429934">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1430007">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1430080">func</span>&nbsp;<span class="op" id="1430085">(</span><span class="ident" id="1430086">p</span>&nbsp;<span class="op" id="1430088">*</span><span class="ident" id="1430089">cpuProfile</span><span class="op" id="1430099">)</span>&nbsp;<span class="ident" id="1430101">getprofile</span><span class="op" id="1430111">(</span><span class="op" id="1430112">)</span>&nbsp;<span class="op" id="1430114">[</span><span class="op" id="1430115">]</span><span class="builtintype" id="1430116">byte</span>&nbsp;<span class="op" id="1430121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430124">if</span>&nbsp;<span class="ident" id="1430127">p</span>&nbsp;<span class="op" id="1430129">==</span>&nbsp;<span class="builtintype" id="1430132">nil</span>&nbsp;<span class="op" id="1430136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430140">return</span>&nbsp;<span class="builtintype" id="1430147">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1430152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430156">if</span>&nbsp;<span class="ident" id="1430159">p</span><span class="op" id="1430160">.</span><span class="ident" id="1430161">wholding</span>&nbsp;<span class="op" id="1430170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1430174">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1430225">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430287">for</span>&nbsp;<span class="op" id="1430291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1430296">n</span>&nbsp;<span class="op" id="1430298">:=</span>&nbsp;<span class="ident" id="1430301">p</span><span class="op" id="1430302">.</span><span class="ident" id="1430303">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430314">if</span>&nbsp;<span class="ident" id="1430317">n</span>&nbsp;<span class="op" id="1430319">==</span>&nbsp;<span class="num" id="1430322">0</span>&nbsp;<span class="op" id="1430324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1430330">print</span><span class="op" id="1430335">(</span><span class="string" id="1430336">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1430387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430393">return</span>&nbsp;<span class="builtintype" id="1430400">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1430407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430412">if</span>&nbsp;<span class="ident" id="1430415">n</span><span class="op" id="1430416">&amp;</span><span class="num" id="1430417">0x80000000</span>&nbsp;<span class="op" id="1430428">!=</span>&nbsp;<span class="num" id="1430431">0</span>&nbsp;<span class="op" id="1430433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1430439">p</span><span class="op" id="1430440">.</span><span class="ident" id="1430441">wtoggle</span>&nbsp;<span class="op" id="1430449">=</span>&nbsp;<span class="num" id="1430451">1</span>&nbsp;<span class="op" id="1430453">-</span>&nbsp;<span class="ident" id="1430455">p</span><span class="op" id="1430456">.</span><span class="ident" id="1430457">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1430469">p</span><span class="op" id="1430470">.</span><span class="ident" id="1430471">wholding</span>&nbsp;<span class="op" id="1430480">=</span>&nbsp;<span class="builtintype" id="1430482">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1430492">p</span><span class="op" id="1430493">.</span><span class="ident" id="1430494">flushing</span>&nbsp;<span class="op" id="1430503">=</span>&nbsp;<span class="builtintype" id="1430505">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430514">goto</span>&nbsp;<span class="ident" id="1430519">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1430528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430533">if</span>&nbsp;<span class="ident" id="1430536">cas</span><span class="op" id="1430539">(</span><span class="op" id="1430540">&amp;</span><span class="ident" id="1430541">p</span><span class="op" id="1430542">.</span><span class="ident" id="1430543">handoff</span><span class="op" id="1430550">,</span>&nbsp;<span class="ident" id="1430552">n</span><span class="op" id="1430553">,</span>&nbsp;<span class="num" id="1430555">0</span><span class="op" id="1430556">)</span>&nbsp;<span class="op" id="1430558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430564">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1430573">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1430577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1430581">p</span><span class="op" id="1430582">.</span><span class="ident" id="1430583">wtoggle</span>&nbsp;<span class="op" id="1430591">=</span>&nbsp;<span class="num" id="1430593">1</span>&nbsp;<span class="op" id="1430595">-</span>&nbsp;<span class="ident" id="1430597">p</span><span class="op" id="1430598">.</span><span class="ident" id="1430599">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1430609">p</span><span class="op" id="1430610">.</span><span class="ident" id="1430611">wholding</span>&nbsp;<span class="op" id="1430620">=</span>&nbsp;<span class="builtintype" id="1430622">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1430629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430633">if</span>&nbsp;<span class="ident" id="1430636">p</span><span class="op" id="1430637">.</span><span class="ident" id="1430638">flushing</span>&nbsp;<span class="op" id="1430647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430651">goto</span>&nbsp;<span class="ident" id="1430656">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1430663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430667">if</span>&nbsp;<span class="op" id="1430670">!</span><span class="ident" id="1430671">p</span><span class="op" id="1430672">.</span><span class="ident" id="1430673">on</span>&nbsp;<span class="op" id="1430676">&amp;&amp;</span>&nbsp;<span class="ident" id="1430679">p</span><span class="op" id="1430680">.</span><span class="ident" id="1430681">handoff</span>&nbsp;<span class="op" id="1430689">==</span>&nbsp;<span class="num" id="1430692">0</span>&nbsp;<span class="op" id="1430694">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430698">return</span>&nbsp;<span class="builtintype" id="1430705">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1430710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1430714">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1430736">notetsleepg</span><span class="op" id="1430747">(</span><span class="op" id="1430748">&amp;</span><span class="ident" id="1430749">p</span><span class="op" id="1430750">.</span><span class="ident" id="1430751">wait</span><span class="op" id="1430755">,</span>&nbsp;<span class="op" id="1430757">-</span><span class="num" id="1430758">1</span><span class="op" id="1430759">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1430762">noteclear</span><span class="op" id="1430771">(</span><span class="op" id="1430772">&amp;</span><span class="ident" id="1430773">p</span><span class="op" id="1430774">.</span><span class="ident" id="1430775">wait</span><span class="op" id="1430779">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430783">switch</span>&nbsp;<span class="ident" id="1430790">n</span>&nbsp;<span class="op" id="1430792">:=</span>&nbsp;<span class="ident" id="1430795">p</span><span class="op" id="1430796">.</span><span class="ident" id="1430797">handoff</span><span class="op" id="1430804">;</span>&nbsp;<span class="op" id="1430806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430809">case</span>&nbsp;<span class="ident" id="1430814">n</span>&nbsp;<span class="op" id="1430816">==</span>&nbsp;<span class="num" id="1430819">0</span><span class="op" id="1430820">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1430824">print</span><span class="op" id="1430829">(</span><span class="string" id="1430830">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1430878">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430882">return</span>&nbsp;<span class="builtintype" id="1430889">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430894">case</span>&nbsp;<span class="ident" id="1430899">n</span>&nbsp;<span class="op" id="1430901">==</span>&nbsp;<span class="num" id="1430904">0x80000000</span><span class="op" id="1430914">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1430918">p</span><span class="op" id="1430919">.</span><span class="ident" id="1430920">flushing</span>&nbsp;<span class="op" id="1430929">=</span>&nbsp;<span class="builtintype" id="1430931">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430938">goto</span>&nbsp;<span class="ident" id="1430943">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1430950">default</span><span class="op" id="1430957">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1430961">n</span>&nbsp;<span class="op" id="1430963">&amp;^=</span>&nbsp;<span class="num" id="1430967">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1430981">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1431012">p</span><span class="op" id="1431013">.</span><span class="ident" id="1431014">wholding</span>&nbsp;<span class="op" id="1431023">=</span>&nbsp;<span class="builtintype" id="1431025">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1431033">return</span>&nbsp;<span class="ident" id="1431040">uintptrBytes</span><span class="op" id="1431052">(</span><span class="ident" id="1431053">p</span><span class="op" id="1431054">.</span><span class="ident" id="1431055">log</span><span class="op" id="1431058">[</span><span class="ident" id="1431059">p</span><span class="op" id="1431060">.</span><span class="ident" id="1431061">wtoggle</span><span class="op" id="1431068">]</span><span class="op" id="1431069">[</span><span class="op" id="1431070">:</span><span class="ident" id="1431071">n</span><span class="op" id="1431072">]</span><span class="op" id="1431073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1431076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431080">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431099">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431151">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431216">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1431268">Flush</span><span class="op" id="1431273">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1431276">for</span>&nbsp;<span class="ident" id="1431280">i</span>&nbsp;<span class="op" id="1431282">:=</span>&nbsp;<span class="keyword" id="1431285">range</span>&nbsp;<span class="ident" id="1431291">p</span><span class="op" id="1431292">.</span><span class="ident" id="1431293">hash</span>&nbsp;<span class="op" id="1431298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1431302">b</span>&nbsp;<span class="op" id="1431304">:=</span>&nbsp;<span class="op" id="1431307">&amp;</span><span class="ident" id="1431308">p</span><span class="op" id="1431309">.</span><span class="ident" id="1431310">hash</span><span class="op" id="1431314">[</span><span class="ident" id="1431315">i</span><span class="op" id="1431316">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1431320">for</span>&nbsp;<span class="ident" id="1431324">j</span>&nbsp;<span class="op" id="1431326">:=</span>&nbsp;<span class="keyword" id="1431329">range</span>&nbsp;<span class="ident" id="1431335">b</span><span class="op" id="1431336">.</span><span class="ident" id="1431337">entry</span>&nbsp;<span class="op" id="1431343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1431348">e</span>&nbsp;<span class="op" id="1431350">:=</span>&nbsp;<span class="op" id="1431353">&amp;</span><span class="ident" id="1431354">b</span><span class="op" id="1431355">.</span><span class="ident" id="1431356">entry</span><span class="op" id="1431361">[</span><span class="ident" id="1431362">j</span><span class="op" id="1431363">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1431368">if</span>&nbsp;<span class="ident" id="1431371">e</span><span class="op" id="1431372">.</span><span class="ident" id="1431373">count</span>&nbsp;<span class="op" id="1431379">&gt;</span>&nbsp;<span class="num" id="1431381">0</span>&nbsp;<span class="op" id="1431383">&amp;&amp;</span>&nbsp;<span class="op" id="1431386">!</span><span class="ident" id="1431387">p</span><span class="op" id="1431388">.</span><span class="ident" id="1431389">evict</span><span class="op" id="1431394">(</span><span class="ident" id="1431395">e</span><span class="op" id="1431396">)</span>&nbsp;<span class="op" id="1431398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431404">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1431469">break</span>&nbsp;<span class="ident" id="1431475">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1431484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1431488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1431491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431495">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1431524">if</span>&nbsp;<span class="ident" id="1431527">p</span><span class="op" id="1431528">.</span><span class="ident" id="1431529">nlog</span>&nbsp;<span class="op" id="1431534">&gt;</span>&nbsp;<span class="num" id="1431536">0</span>&nbsp;<span class="op" id="1431538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431542">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431594">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1431642">n</span>&nbsp;<span class="op" id="1431644">:=</span>&nbsp;<span class="ident" id="1431647">p</span><span class="op" id="1431648">.</span><span class="ident" id="1431649">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1431656">p</span><span class="op" id="1431657">.</span><span class="ident" id="1431658">nlog</span>&nbsp;<span class="op" id="1431663">=</span>&nbsp;<span class="num" id="1431665">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1431669">return</span>&nbsp;<span class="ident" id="1431676">uintptrBytes</span><span class="op" id="1431688">(</span><span class="ident" id="1431689">p</span><span class="op" id="1431690">.</span><span class="ident" id="1431691">log</span><span class="op" id="1431694">[</span><span class="ident" id="1431695">p</span><span class="op" id="1431696">.</span><span class="ident" id="1431697">toggle</span><span class="op" id="1431703">]</span><span class="op" id="1431704">[</span><span class="op" id="1431705">:</span><span class="ident" id="1431706">n</span><span class="op" id="1431707">]</span><span class="op" id="1431708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1431711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431715">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1431778">if</span>&nbsp;<span class="op" id="1431781">!</span><span class="ident" id="1431782">p</span><span class="op" id="1431783">.</span><span class="ident" id="1431784">eodSent</span>&nbsp;<span class="op" id="1431792">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431796">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431862">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1431927">p</span><span class="op" id="1431928">.</span><span class="ident" id="1431929">eodSent</span>&nbsp;<span class="op" id="1431937">=</span>&nbsp;<span class="builtintype" id="1431939">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1431946">return</span>&nbsp;<span class="ident" id="1431953">uintptrBytes</span><span class="op" id="1431965">(</span><span class="ident" id="1431966">eod</span><span class="op" id="1431969">[</span><span class="op" id="1431970">:</span><span class="op" id="1431971">]</span><span class="op" id="1431972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1431975">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1431979">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1432023">p</span><span class="op" id="1432024">.</span><span class="ident" id="1432025">flushing</span>&nbsp;<span class="op" id="1432034">=</span>&nbsp;<span class="builtintype" id="1432036">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1432043">if</span>&nbsp;<span class="op" id="1432046">!</span><span class="ident" id="1432047">cas</span><span class="op" id="1432050">(</span><span class="op" id="1432051">&amp;</span><span class="ident" id="1432052">p</span><span class="op" id="1432053">.</span><span class="ident" id="1432054">handoff</span><span class="op" id="1432061">,</span>&nbsp;<span class="ident" id="1432063">p</span><span class="op" id="1432064">.</span><span class="ident" id="1432065">handoff</span><span class="op" id="1432072">,</span>&nbsp;<span class="num" id="1432074">0</span><span class="op" id="1432075">)</span>&nbsp;<span class="op" id="1432077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1432081">print</span><span class="op" id="1432086">(</span><span class="string" id="1432087">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1432135">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1432138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1432141">return</span>&nbsp;<span class="builtintype" id="1432148">nil</span><br>
<span class="lineno"></span><span class="op" id="1432152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1432155">func</span>&nbsp;<span class="ident" id="1432160">uintptrBytes</span><span class="op" id="1432172">(</span><span class="ident" id="1432173">p</span>&nbsp;<span class="op" id="1432175">[</span><span class="op" id="1432176">]</span><span class="builtintype" id="1432177">uintptr</span><span class="op" id="1432184">)</span>&nbsp;<span class="op" id="1432186">(</span><span class="ident" id="1432187">ret</span>&nbsp;<span class="op" id="1432191">[</span><span class="op" id="1432192">]</span><span class="builtintype" id="1432193">byte</span><span class="op" id="1432197">)</span>&nbsp;<span class="op" id="1432199">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1432202">pp</span>&nbsp;<span class="op" id="1432205">:=</span>&nbsp;<span class="op" id="1432208">(</span><span class="op" id="1432209">*</span><span class="ident" id="1432210">sliceStruct</span><span class="op" id="1432221">)</span><span class="op" id="1432222">(</span><span class="ident" id="1432223">unsafe</span><span class="op" id="1432229">.</span><span class="ident" id="1432230">Pointer</span><span class="op" id="1432237">(</span><span class="op" id="1432238">&amp;</span><span class="ident" id="1432239">p</span><span class="op" id="1432240">)</span><span class="op" id="1432241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1432244">rp</span>&nbsp;<span class="op" id="1432247">:=</span>&nbsp;<span class="op" id="1432250">(</span><span class="op" id="1432251">*</span><span class="ident" id="1432252">sliceStruct</span><span class="op" id="1432263">)</span><span class="op" id="1432264">(</span><span class="ident" id="1432265">unsafe</span><span class="op" id="1432271">.</span><span class="ident" id="1432272">Pointer</span><span class="op" id="1432279">(</span><span class="op" id="1432280">&amp;</span><span class="ident" id="1432281">ret</span><span class="op" id="1432284">)</span><span class="op" id="1432285">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1432289">rp</span><span class="op" id="1432291">.</span><span class="ident" id="1432292">array</span>&nbsp;<span class="op" id="1432298">=</span>&nbsp;<span class="ident" id="1432300">pp</span><span class="op" id="1432302">.</span><span class="ident" id="1432303">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1432310">rp</span><span class="op" id="1432312">.</span><span class="builtinfunc" id="1432313">len</span>&nbsp;<span class="op" id="1432317">=</span>&nbsp;<span class="ident" id="1432319">pp</span><span class="op" id="1432321">.</span><span class="builtinfunc" id="1432322">len</span>&nbsp;<span class="op" id="1432326">*</span>&nbsp;<span class="builtintype" id="1432328">int</span><span class="op" id="1432331">(</span><span class="ident" id="1432332">unsafe</span><span class="op" id="1432338">.</span><span class="ident" id="1432339">Sizeof</span><span class="op" id="1432345">(</span><span class="ident" id="1432346">p</span><span class="op" id="1432347">[</span><span class="num" id="1432348">0</span><span class="op" id="1432349">]</span><span class="op" id="1432350">)</span><span class="op" id="1432351">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1432354">rp</span><span class="op" id="1432356">.</span><span class="builtinfunc" id="1432357">cap</span>&nbsp;<span class="op" id="1432361">=</span>&nbsp;<span class="ident" id="1432363">rp</span><span class="op" id="1432365">.</span><span class="builtinfunc" id="1432366">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1432372">return</span><br>
<span class="lineno"></span><span class="op" id="1432379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1432382">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1432461">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1432546">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1432625">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1432700">//</span><br>
<span class="lineno">420</span><span class="comment" id="1432703">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1432759">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1432825">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1432849">func</span>&nbsp;<span class="ident" id="1432854">CPUProfile</span><span class="op" id="1432864">(</span><span class="op" id="1432865">)</span>&nbsp;<span class="op" id="1432867">[</span><span class="op" id="1432868">]</span><span class="builtintype" id="1432869">byte</span>&nbsp;<span class="op" id="1432874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1432877">return</span>&nbsp;<span class="ident" id="1432884">cpuprof</span><span class="op" id="1432891">.</span><span class="ident" id="1432892">getprofile</span><span class="op" id="1432902">(</span><span class="op" id="1432903">)</span><br>
<span class="lineno">425</span><span class="op" id="1432905">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
