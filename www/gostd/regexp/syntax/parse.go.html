<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5269760">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5269816">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5269870">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5269921">package</span>&nbsp;<span class="ident" id="5269929">syntax</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5269937">import</span>&nbsp;<span class="op" id="5269944">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5269947">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5269955">&#34;strings&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5269966">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5269977">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5269992">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5269995">//&nbsp;An&nbsp;Error&nbsp;describes&nbsp;a&nbsp;failure&nbsp;to&nbsp;parse&nbsp;a&nbsp;regular&nbsp;expression</span><br>
<span class="lineno">15</span><span class="comment" id="5270057">//&nbsp;and&nbsp;gives&nbsp;the&nbsp;offending&nbsp;expression.</span><br>
<span class="lineno"></span><span class="keyword" id="5270096">type</span>&nbsp;<span class="ident" id="5270101">Error</span>&nbsp;<span class="keyword" id="5270107">struct</span>&nbsp;<span class="op" id="5270114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270117">Code</span>&nbsp;<span class="ident" id="5270122">ErrorCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270133">Expr</span>&nbsp;<span class="builtintype" id="5270138">string</span><br>
<span class="lineno"></span><span class="op" id="5270145">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5270148">func</span>&nbsp;<span class="op" id="5270153">(</span><span class="ident" id="5270154">e</span>&nbsp;<span class="op" id="5270156">*</span><span class="ident" id="5270157">Error</span><span class="op" id="5270162">)</span>&nbsp;<span class="ident" id="5270164">Error</span><span class="op" id="5270169">(</span><span class="op" id="5270170">)</span>&nbsp;<span class="builtintype" id="5270172">string</span>&nbsp;<span class="op" id="5270179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270182">return</span>&nbsp;<span class="string" id="5270189">&#34;error&nbsp;parsing&nbsp;regexp:&nbsp;&#34;</span>&nbsp;<span class="op" id="5270214">+</span>&nbsp;<span class="ident" id="5270216">e</span><span class="op" id="5270217">.</span><span class="ident" id="5270218">Code</span><span class="op" id="5270222">.</span><span class="ident" id="5270223">String</span><span class="op" id="5270229">(</span><span class="op" id="5270230">)</span>&nbsp;<span class="op" id="5270232">+</span>&nbsp;<span class="string" id="5270234">&#34;:&nbsp;`&#34;</span>&nbsp;<span class="op" id="5270240">+</span>&nbsp;<span class="ident" id="5270242">e</span><span class="op" id="5270243">.</span><span class="ident" id="5270244">Expr</span>&nbsp;<span class="op" id="5270249">+</span>&nbsp;<span class="string" id="5270251">&#34;`&#34;</span><br>
<span class="lineno"></span><span class="op" id="5270255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5270258">//&nbsp;An&nbsp;ErrorCode&nbsp;describes&nbsp;a&nbsp;failure&nbsp;to&nbsp;parse&nbsp;a&nbsp;regular&nbsp;expression.</span><br>
<span class="lineno"></span><span class="keyword" id="5270325">type</span>&nbsp;<span class="ident" id="5270330">ErrorCode</span>&nbsp;<span class="builtintype" id="5270340">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5270348">const</span>&nbsp;<span class="op" id="5270354">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5270357">//&nbsp;Unexpected&nbsp;error</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270378">ErrInternalError</span>&nbsp;<span class="ident" id="5270395">ErrorCode</span>&nbsp;<span class="op" id="5270405">=</span>&nbsp;<span class="string" id="5270407">&#34;regexp/syntax:&nbsp;internal&nbsp;error&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5270441">//&nbsp;Parse&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270458">ErrInvalidCharClass</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5270483">ErrorCode</span>&nbsp;<span class="op" id="5270493">=</span>&nbsp;<span class="string" id="5270495">&#34;invalid&nbsp;character&nbsp;class&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270522">ErrInvalidCharRange</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5270547">ErrorCode</span>&nbsp;<span class="op" id="5270557">=</span>&nbsp;<span class="string" id="5270559">&#34;invalid&nbsp;character&nbsp;class&nbsp;range&#34;</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270592">ErrInvalidEscape</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5270617">ErrorCode</span>&nbsp;<span class="op" id="5270627">=</span>&nbsp;<span class="string" id="5270629">&#34;invalid&nbsp;escape&nbsp;sequence&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270656">ErrInvalidNamedCapture</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5270681">ErrorCode</span>&nbsp;<span class="op" id="5270691">=</span>&nbsp;<span class="string" id="5270693">&#34;invalid&nbsp;named&nbsp;capture&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270718">ErrInvalidPerlOp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5270743">ErrorCode</span>&nbsp;<span class="op" id="5270753">=</span>&nbsp;<span class="string" id="5270755">&#34;invalid&nbsp;or&nbsp;unsupported&nbsp;Perl&nbsp;syntax&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270793">ErrInvalidRepeatOp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5270818">ErrorCode</span>&nbsp;<span class="op" id="5270828">=</span>&nbsp;<span class="string" id="5270830">&#34;invalid&nbsp;nested&nbsp;repetition&nbsp;operator&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270868">ErrInvalidRepeatSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5270893">ErrorCode</span>&nbsp;<span class="op" id="5270903">=</span>&nbsp;<span class="string" id="5270905">&#34;invalid&nbsp;repeat&nbsp;count&#34;</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270929">ErrInvalidUTF8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5270954">ErrorCode</span>&nbsp;<span class="op" id="5270964">=</span>&nbsp;<span class="string" id="5270966">&#34;invalid&nbsp;UTF-8&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270983">ErrMissingBracket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5271008">ErrorCode</span>&nbsp;<span class="op" id="5271018">=</span>&nbsp;<span class="string" id="5271020">&#34;missing&nbsp;closing&nbsp;]&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271041">ErrMissingParen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5271066">ErrorCode</span>&nbsp;<span class="op" id="5271076">=</span>&nbsp;<span class="string" id="5271078">&#34;missing&nbsp;closing&nbsp;)&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271099">ErrMissingRepeatArgument</span>&nbsp;<span class="ident" id="5271124">ErrorCode</span>&nbsp;<span class="op" id="5271134">=</span>&nbsp;<span class="string" id="5271136">&#34;missing&nbsp;argument&nbsp;to&nbsp;repetition&nbsp;operator&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271179">ErrTrailingBackslash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5271204">ErrorCode</span>&nbsp;<span class="op" id="5271214">=</span>&nbsp;<span class="string" id="5271216">&#34;trailing&nbsp;backslash&nbsp;at&nbsp;end&nbsp;of&nbsp;expression&#34;</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271259">ErrUnexpectedParen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5271284">ErrorCode</span>&nbsp;<span class="op" id="5271294">=</span>&nbsp;<span class="string" id="5271296">&#34;unexpected&nbsp;)&#34;</span><br>
<span class="lineno"></span><span class="op" id="5271311">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5271314">func</span>&nbsp;<span class="op" id="5271319">(</span><span class="ident" id="5271320">e</span>&nbsp;<span class="ident" id="5271322">ErrorCode</span><span class="op" id="5271331">)</span>&nbsp;<span class="ident" id="5271333">String</span><span class="op" id="5271339">(</span><span class="op" id="5271340">)</span>&nbsp;<span class="builtintype" id="5271342">string</span>&nbsp;<span class="op" id="5271349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271352">return</span>&nbsp;<span class="builtintype" id="5271359">string</span><span class="op" id="5271365">(</span><span class="ident" id="5271366">e</span><span class="op" id="5271367">)</span><br>
<span class="lineno">50</span><span class="op" id="5271369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5271372">//&nbsp;Flags&nbsp;control&nbsp;the&nbsp;behavior&nbsp;of&nbsp;the&nbsp;parser&nbsp;and&nbsp;record&nbsp;information&nbsp;about&nbsp;regexp&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="5271461">type</span>&nbsp;<span class="ident" id="5271466">Flags</span>&nbsp;<span class="builtintype" id="5271472">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5271480">const</span>&nbsp;<span class="op" id="5271486">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271489">FoldCase</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5271503">Flags</span>&nbsp;<span class="op" id="5271509">=</span>&nbsp;<span class="num" id="5271511">1</span>&nbsp;<span class="op" id="5271513">&lt;&lt;</span>&nbsp;<span class="ident" id="5271516">iota</span>&nbsp;<span class="comment" id="5271521">//&nbsp;case-insensitive&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271548">Literal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5271580">//&nbsp;treat&nbsp;pattern&nbsp;as&nbsp;literal&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271616">ClassNL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5271648">//&nbsp;allow&nbsp;character&nbsp;classes&nbsp;like&nbsp;[^a-z]&nbsp;and&nbsp;[[:space:]]&nbsp;to&nbsp;match&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271721">DotNL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5271753">//&nbsp;allow&nbsp;.&nbsp;to&nbsp;match&nbsp;newline</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271782">OneLine</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5271814">//&nbsp;treat&nbsp;^&nbsp;and&nbsp;$&nbsp;as&nbsp;only&nbsp;matching&nbsp;at&nbsp;beginning&nbsp;and&nbsp;end&nbsp;of&nbsp;text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271878">NonGreedy</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5271910">//&nbsp;make&nbsp;repetition&nbsp;operators&nbsp;default&nbsp;to&nbsp;non-greedy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271962">PerlX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5271994">//&nbsp;allow&nbsp;Perl&nbsp;extensions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272020">UnicodeGroups</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5272052">//&nbsp;allow&nbsp;\p{Han},&nbsp;\P{Han}&nbsp;for&nbsp;Unicode&nbsp;group&nbsp;and&nbsp;negation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272110">WasDollar</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5272142">//&nbsp;regexp&nbsp;OpEndText&nbsp;was&nbsp;$,&nbsp;not&nbsp;\z</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272177">Simple</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5272209">//&nbsp;regexp&nbsp;contains&nbsp;no&nbsp;counted&nbsp;repetition</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272252">MatchNL</span>&nbsp;<span class="op" id="5272260">=</span>&nbsp;<span class="ident" id="5272262">ClassNL</span>&nbsp;<span class="op" id="5272270">|</span>&nbsp;<span class="ident" id="5272272">DotNL</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272280">Perl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5272292">=</span>&nbsp;<span class="ident" id="5272294">ClassNL</span>&nbsp;<span class="op" id="5272302">|</span>&nbsp;<span class="ident" id="5272304">OneLine</span>&nbsp;<span class="op" id="5272312">|</span>&nbsp;<span class="ident" id="5272314">PerlX</span>&nbsp;<span class="op" id="5272320">|</span>&nbsp;<span class="ident" id="5272322">UnicodeGroups</span>&nbsp;<span class="comment" id="5272336">//&nbsp;as&nbsp;close&nbsp;to&nbsp;Perl&nbsp;as&nbsp;possible</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272369">POSIX</span>&nbsp;<span class="ident" id="5272375">Flags</span>&nbsp;<span class="op" id="5272381">=</span>&nbsp;<span class="num" id="5272383">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5272425">//&nbsp;POSIX&nbsp;syntax</span><br>
<span class="lineno"></span><span class="op" id="5272441">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5272444">//&nbsp;Pseudo-ops&nbsp;for&nbsp;parsing&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="5272477">const</span>&nbsp;<span class="op" id="5272483">(</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272486">opLeftParen</span>&nbsp;<span class="op" id="5272498">=</span>&nbsp;<span class="ident" id="5272500">opPseudo</span>&nbsp;<span class="op" id="5272509">+</span>&nbsp;<span class="ident" id="5272511">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272517">opVerticalBar</span><br>
<span class="lineno"></span><span class="op" id="5272531">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5272534">type</span>&nbsp;<span class="ident" id="5272539">parser</span>&nbsp;<span class="keyword" id="5272546">struct</span>&nbsp;<span class="op" id="5272553">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272556">flags</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5272568">Flags</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5272578">//&nbsp;parse&nbsp;mode&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272599">stack</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5272611">[</span><span class="op" id="5272612">]</span><span class="op" id="5272613">*</span><span class="ident" id="5272614">Regexp</span>&nbsp;<span class="comment" id="5272621">//&nbsp;stack&nbsp;of&nbsp;parsed&nbsp;expressions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272653">free</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5272665">*</span><span class="ident" id="5272666">Regexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272674">numCap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5272686">int</span>&nbsp;<span class="comment" id="5272690">//&nbsp;number&nbsp;of&nbsp;capturing&nbsp;groups&nbsp;seen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272726">wholeRegexp</span>&nbsp;<span class="builtintype" id="5272738">string</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272746">tmpClass</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5272758">[</span><span class="op" id="5272759">]</span><span class="builtintype" id="5272760">rune</span>&nbsp;<span class="comment" id="5272765">//&nbsp;temporary&nbsp;char&nbsp;class&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span><span class="op" id="5272800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5272803">func</span>&nbsp;<span class="op" id="5272808">(</span><span class="ident" id="5272809">p</span>&nbsp;<span class="op" id="5272811">*</span><span class="ident" id="5272812">parser</span><span class="op" id="5272818">)</span>&nbsp;<span class="ident" id="5272820">newRegexp</span><span class="op" id="5272829">(</span><span class="ident" id="5272830">op</span>&nbsp;<span class="ident" id="5272833">Op</span><span class="op" id="5272835">)</span>&nbsp;<span class="op" id="5272837">*</span><span class="ident" id="5272838">Regexp</span>&nbsp;<span class="op" id="5272845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272848">re</span>&nbsp;<span class="op" id="5272851">:=</span>&nbsp;<span class="ident" id="5272854">p</span><span class="op" id="5272855">.</span><span class="ident" id="5272856">free</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272862">if</span>&nbsp;<span class="ident" id="5272865">re</span>&nbsp;<span class="op" id="5272868">!=</span>&nbsp;<span class="ident" id="5272871">nil</span>&nbsp;<span class="op" id="5272875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272879">p</span><span class="op" id="5272880">.</span><span class="ident" id="5272881">free</span>&nbsp;<span class="op" id="5272886">=</span>&nbsp;<span class="ident" id="5272888">re</span><span class="op" id="5272890">.</span><span class="ident" id="5272891">Sub0</span><span class="op" id="5272895">[</span><span class="num" id="5272896">0</span><span class="op" id="5272897">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272901">*</span><span class="ident" id="5272902">re</span>&nbsp;<span class="op" id="5272905">=</span>&nbsp;<span class="ident" id="5272907">Regexp</span><span class="op" id="5272913">{</span><span class="op" id="5272914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272917">}</span>&nbsp;<span class="keyword" id="5272919">else</span>&nbsp;<span class="op" id="5272924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272928">re</span>&nbsp;<span class="op" id="5272931">=</span>&nbsp;<span class="builtinfunc" id="5272933">new</span><span class="op" id="5272936">(</span><span class="ident" id="5272937">Regexp</span><span class="op" id="5272943">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272949">re</span><span class="op" id="5272951">.</span><span class="ident" id="5272952">Op</span>&nbsp;<span class="op" id="5272955">=</span>&nbsp;<span class="ident" id="5272957">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272961">return</span>&nbsp;<span class="ident" id="5272968">re</span><br>
<span class="lineno"></span><span class="op" id="5272971">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5272974">func</span>&nbsp;<span class="op" id="5272979">(</span><span class="ident" id="5272980">p</span>&nbsp;<span class="op" id="5272982">*</span><span class="ident" id="5272983">parser</span><span class="op" id="5272989">)</span>&nbsp;<span class="ident" id="5272991">reuse</span><span class="op" id="5272996">(</span><span class="ident" id="5272997">re</span>&nbsp;<span class="op" id="5273000">*</span><span class="ident" id="5273001">Regexp</span><span class="op" id="5273007">)</span>&nbsp;<span class="op" id="5273009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273012">re</span><span class="op" id="5273014">.</span><span class="ident" id="5273015">Sub0</span><span class="op" id="5273019">[</span><span class="num" id="5273020">0</span><span class="op" id="5273021">]</span>&nbsp;<span class="op" id="5273023">=</span>&nbsp;<span class="ident" id="5273025">p</span><span class="op" id="5273026">.</span><span class="ident" id="5273027">free</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273033">p</span><span class="op" id="5273034">.</span><span class="ident" id="5273035">free</span>&nbsp;<span class="op" id="5273040">=</span>&nbsp;<span class="ident" id="5273042">re</span><br>
<span class="lineno"></span><span class="op" id="5273045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="5273048">//&nbsp;Parse&nbsp;stack&nbsp;manipulation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5273078">//&nbsp;push&nbsp;pushes&nbsp;the&nbsp;regexp&nbsp;re&nbsp;onto&nbsp;the&nbsp;parse&nbsp;stack&nbsp;and&nbsp;returns&nbsp;the&nbsp;regexp.</span><br>
<span class="lineno"></span><span class="keyword" id="5273152">func</span>&nbsp;<span class="op" id="5273157">(</span><span class="ident" id="5273158">p</span>&nbsp;<span class="op" id="5273160">*</span><span class="ident" id="5273161">parser</span><span class="op" id="5273167">)</span>&nbsp;<span class="ident" id="5273169">push</span><span class="op" id="5273173">(</span><span class="ident" id="5273174">re</span>&nbsp;<span class="op" id="5273177">*</span><span class="ident" id="5273178">Regexp</span><span class="op" id="5273184">)</span>&nbsp;<span class="op" id="5273186">*</span><span class="ident" id="5273187">Regexp</span>&nbsp;<span class="op" id="5273194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273197">if</span>&nbsp;<span class="ident" id="5273200">re</span><span class="op" id="5273202">.</span><span class="ident" id="5273203">Op</span>&nbsp;<span class="op" id="5273206">==</span>&nbsp;<span class="ident" id="5273209">OpCharClass</span>&nbsp;<span class="op" id="5273221">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5273224">len</span><span class="op" id="5273227">(</span><span class="ident" id="5273228">re</span><span class="op" id="5273230">.</span><span class="ident" id="5273231">Rune</span><span class="op" id="5273235">)</span>&nbsp;<span class="op" id="5273237">==</span>&nbsp;<span class="num" id="5273240">2</span>&nbsp;<span class="op" id="5273242">&amp;&amp;</span>&nbsp;<span class="ident" id="5273245">re</span><span class="op" id="5273247">.</span><span class="ident" id="5273248">Rune</span><span class="op" id="5273252">[</span><span class="num" id="5273253">0</span><span class="op" id="5273254">]</span>&nbsp;<span class="op" id="5273256">==</span>&nbsp;<span class="ident" id="5273259">re</span><span class="op" id="5273261">.</span><span class="ident" id="5273262">Rune</span><span class="op" id="5273266">[</span><span class="num" id="5273267">1</span><span class="op" id="5273268">]</span>&nbsp;<span class="op" id="5273270">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5273274">//&nbsp;Single&nbsp;rune.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273292">if</span>&nbsp;<span class="ident" id="5273295">p</span><span class="op" id="5273296">.</span><span class="ident" id="5273297">maybeConcat</span><span class="op" id="5273308">(</span><span class="ident" id="5273309">re</span><span class="op" id="5273311">.</span><span class="ident" id="5273312">Rune</span><span class="op" id="5273316">[</span><span class="num" id="5273317">0</span><span class="op" id="5273318">]</span><span class="op" id="5273319">,</span>&nbsp;<span class="ident" id="5273321">p</span><span class="op" id="5273322">.</span><span class="ident" id="5273323">flags</span><span class="op" id="5273328">&amp;^</span><span class="ident" id="5273330">FoldCase</span><span class="op" id="5273338">)</span>&nbsp;<span class="op" id="5273340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273345">return</span>&nbsp;<span class="ident" id="5273352">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273362">re</span><span class="op" id="5273364">.</span><span class="ident" id="5273365">Op</span>&nbsp;<span class="op" id="5273368">=</span>&nbsp;<span class="ident" id="5273370">OpLiteral</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273382">re</span><span class="op" id="5273384">.</span><span class="ident" id="5273385">Rune</span>&nbsp;<span class="op" id="5273390">=</span>&nbsp;<span class="ident" id="5273392">re</span><span class="op" id="5273394">.</span><span class="ident" id="5273395">Rune</span><span class="op" id="5273399">[</span><span class="op" id="5273400">:</span><span class="num" id="5273401">1</span><span class="op" id="5273402">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273406">re</span><span class="op" id="5273408">.</span><span class="ident" id="5273409">Flags</span>&nbsp;<span class="op" id="5273415">=</span>&nbsp;<span class="ident" id="5273417">p</span><span class="op" id="5273418">.</span><span class="ident" id="5273419">flags</span>&nbsp;<span class="op" id="5273425">&amp;^</span>&nbsp;<span class="ident" id="5273428">FoldCase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273438">}</span>&nbsp;<span class="keyword" id="5273440">else</span>&nbsp;<span class="keyword" id="5273445">if</span>&nbsp;<span class="ident" id="5273448">re</span><span class="op" id="5273450">.</span><span class="ident" id="5273451">Op</span>&nbsp;<span class="op" id="5273454">==</span>&nbsp;<span class="ident" id="5273457">OpCharClass</span>&nbsp;<span class="op" id="5273469">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5273472">len</span><span class="op" id="5273475">(</span><span class="ident" id="5273476">re</span><span class="op" id="5273478">.</span><span class="ident" id="5273479">Rune</span><span class="op" id="5273483">)</span>&nbsp;<span class="op" id="5273485">==</span>&nbsp;<span class="num" id="5273488">4</span>&nbsp;<span class="op" id="5273490">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273495">re</span><span class="op" id="5273497">.</span><span class="ident" id="5273498">Rune</span><span class="op" id="5273502">[</span><span class="num" id="5273503">0</span><span class="op" id="5273504">]</span>&nbsp;<span class="op" id="5273506">==</span>&nbsp;<span class="ident" id="5273509">re</span><span class="op" id="5273511">.</span><span class="ident" id="5273512">Rune</span><span class="op" id="5273516">[</span><span class="num" id="5273517">1</span><span class="op" id="5273518">]</span>&nbsp;<span class="op" id="5273520">&amp;&amp;</span>&nbsp;<span class="ident" id="5273523">re</span><span class="op" id="5273525">.</span><span class="ident" id="5273526">Rune</span><span class="op" id="5273530">[</span><span class="num" id="5273531">2</span><span class="op" id="5273532">]</span>&nbsp;<span class="op" id="5273534">==</span>&nbsp;<span class="ident" id="5273537">re</span><span class="op" id="5273539">.</span><span class="ident" id="5273540">Rune</span><span class="op" id="5273544">[</span><span class="num" id="5273545">3</span><span class="op" id="5273546">]</span>&nbsp;<span class="op" id="5273548">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273553">unicode</span><span class="op" id="5273560">.</span><span class="ident" id="5273561">SimpleFold</span><span class="op" id="5273571">(</span><span class="ident" id="5273572">re</span><span class="op" id="5273574">.</span><span class="ident" id="5273575">Rune</span><span class="op" id="5273579">[</span><span class="num" id="5273580">0</span><span class="op" id="5273581">]</span><span class="op" id="5273582">)</span>&nbsp;<span class="op" id="5273584">==</span>&nbsp;<span class="ident" id="5273587">re</span><span class="op" id="5273589">.</span><span class="ident" id="5273590">Rune</span><span class="op" id="5273594">[</span><span class="num" id="5273595">2</span><span class="op" id="5273596">]</span>&nbsp;<span class="op" id="5273598">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273603">unicode</span><span class="op" id="5273610">.</span><span class="ident" id="5273611">SimpleFold</span><span class="op" id="5273621">(</span><span class="ident" id="5273622">re</span><span class="op" id="5273624">.</span><span class="ident" id="5273625">Rune</span><span class="op" id="5273629">[</span><span class="num" id="5273630">2</span><span class="op" id="5273631">]</span><span class="op" id="5273632">)</span>&nbsp;<span class="op" id="5273634">==</span>&nbsp;<span class="ident" id="5273637">re</span><span class="op" id="5273639">.</span><span class="ident" id="5273640">Rune</span><span class="op" id="5273644">[</span><span class="num" id="5273645">0</span><span class="op" id="5273646">]</span>&nbsp;<span class="op" id="5273648">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273653">re</span><span class="op" id="5273655">.</span><span class="ident" id="5273656">Op</span>&nbsp;<span class="op" id="5273659">==</span>&nbsp;<span class="ident" id="5273662">OpCharClass</span>&nbsp;<span class="op" id="5273674">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5273677">len</span><span class="op" id="5273680">(</span><span class="ident" id="5273681">re</span><span class="op" id="5273683">.</span><span class="ident" id="5273684">Rune</span><span class="op" id="5273688">)</span>&nbsp;<span class="op" id="5273690">==</span>&nbsp;<span class="num" id="5273693">2</span>&nbsp;<span class="op" id="5273695">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273701">re</span><span class="op" id="5273703">.</span><span class="ident" id="5273704">Rune</span><span class="op" id="5273708">[</span><span class="num" id="5273709">0</span><span class="op" id="5273710">]</span><span class="op" id="5273711">+</span><span class="num" id="5273712">1</span>&nbsp;<span class="op" id="5273714">==</span>&nbsp;<span class="ident" id="5273717">re</span><span class="op" id="5273719">.</span><span class="ident" id="5273720">Rune</span><span class="op" id="5273724">[</span><span class="num" id="5273725">1</span><span class="op" id="5273726">]</span>&nbsp;<span class="op" id="5273728">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273734">unicode</span><span class="op" id="5273741">.</span><span class="ident" id="5273742">SimpleFold</span><span class="op" id="5273752">(</span><span class="ident" id="5273753">re</span><span class="op" id="5273755">.</span><span class="ident" id="5273756">Rune</span><span class="op" id="5273760">[</span><span class="num" id="5273761">0</span><span class="op" id="5273762">]</span><span class="op" id="5273763">)</span>&nbsp;<span class="op" id="5273765">==</span>&nbsp;<span class="ident" id="5273768">re</span><span class="op" id="5273770">.</span><span class="ident" id="5273771">Rune</span><span class="op" id="5273775">[</span><span class="num" id="5273776">1</span><span class="op" id="5273777">]</span>&nbsp;<span class="op" id="5273779">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273785">unicode</span><span class="op" id="5273792">.</span><span class="ident" id="5273793">SimpleFold</span><span class="op" id="5273803">(</span><span class="ident" id="5273804">re</span><span class="op" id="5273806">.</span><span class="ident" id="5273807">Rune</span><span class="op" id="5273811">[</span><span class="num" id="5273812">1</span><span class="op" id="5273813">]</span><span class="op" id="5273814">)</span>&nbsp;<span class="op" id="5273816">==</span>&nbsp;<span class="ident" id="5273819">re</span><span class="op" id="5273821">.</span><span class="ident" id="5273822">Rune</span><span class="op" id="5273826">[</span><span class="num" id="5273827">0</span><span class="op" id="5273828">]</span>&nbsp;<span class="op" id="5273830">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5273834">//&nbsp;Case-insensitive&nbsp;rune&nbsp;like&nbsp;[Aa]&nbsp;or&nbsp;[Δδ].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273882">if</span>&nbsp;<span class="ident" id="5273885">p</span><span class="op" id="5273886">.</span><span class="ident" id="5273887">maybeConcat</span><span class="op" id="5273898">(</span><span class="ident" id="5273899">re</span><span class="op" id="5273901">.</span><span class="ident" id="5273902">Rune</span><span class="op" id="5273906">[</span><span class="num" id="5273907">0</span><span class="op" id="5273908">]</span><span class="op" id="5273909">,</span>&nbsp;<span class="ident" id="5273911">p</span><span class="op" id="5273912">.</span><span class="ident" id="5273913">flags</span><span class="op" id="5273918">|</span><span class="ident" id="5273919">FoldCase</span><span class="op" id="5273927">)</span>&nbsp;<span class="op" id="5273929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273934">return</span>&nbsp;<span class="ident" id="5273941">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5273952">//&nbsp;Rewrite&nbsp;as&nbsp;(case-insensitive)&nbsp;literal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273996">re</span><span class="op" id="5273998">.</span><span class="ident" id="5273999">Op</span>&nbsp;<span class="op" id="5274002">=</span>&nbsp;<span class="ident" id="5274004">OpLiteral</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274016">re</span><span class="op" id="5274018">.</span><span class="ident" id="5274019">Rune</span>&nbsp;<span class="op" id="5274024">=</span>&nbsp;<span class="ident" id="5274026">re</span><span class="op" id="5274028">.</span><span class="ident" id="5274029">Rune</span><span class="op" id="5274033">[</span><span class="op" id="5274034">:</span><span class="num" id="5274035">1</span><span class="op" id="5274036">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274040">re</span><span class="op" id="5274042">.</span><span class="ident" id="5274043">Flags</span>&nbsp;<span class="op" id="5274049">=</span>&nbsp;<span class="ident" id="5274051">p</span><span class="op" id="5274052">.</span><span class="ident" id="5274053">flags</span>&nbsp;<span class="op" id="5274059">|</span>&nbsp;<span class="ident" id="5274061">FoldCase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274071">}</span>&nbsp;<span class="keyword" id="5274073">else</span>&nbsp;<span class="op" id="5274078">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274082">//&nbsp;Incremental&nbsp;concatenation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274114">p</span><span class="op" id="5274115">.</span><span class="ident" id="5274116">maybeConcat</span><span class="op" id="5274127">(</span><span class="op" id="5274128">-</span><span class="num" id="5274129">1</span><span class="op" id="5274130">,</span>&nbsp;<span class="num" id="5274132">0</span><span class="op" id="5274133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274140">p</span><span class="op" id="5274141">.</span><span class="ident" id="5274142">stack</span>&nbsp;<span class="op" id="5274148">=</span>&nbsp;<span class="builtinfunc" id="5274150">append</span><span class="op" id="5274156">(</span><span class="ident" id="5274157">p</span><span class="op" id="5274158">.</span><span class="ident" id="5274159">stack</span><span class="op" id="5274164">,</span>&nbsp;<span class="ident" id="5274166">re</span><span class="op" id="5274168">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274171">return</span>&nbsp;<span class="ident" id="5274178">re</span><br>
<span class="lineno"></span><span class="op" id="5274181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5274184">//&nbsp;maybeConcat&nbsp;implements&nbsp;incremental&nbsp;concatenation</span><br>
<span class="lineno"></span><span class="comment" id="5274236">//&nbsp;of&nbsp;literal&nbsp;runes&nbsp;into&nbsp;string&nbsp;nodes.&nbsp;&nbsp;The&nbsp;parser&nbsp;calls&nbsp;this</span><br>
<span class="lineno">145</span><span class="comment" id="5274298">//&nbsp;before&nbsp;each&nbsp;push,&nbsp;so&nbsp;only&nbsp;the&nbsp;top&nbsp;fragment&nbsp;of&nbsp;the&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="5274357">//&nbsp;might&nbsp;need&nbsp;processing.&nbsp;&nbsp;Since&nbsp;this&nbsp;is&nbsp;called&nbsp;before&nbsp;a&nbsp;push,</span><br>
<span class="lineno"></span><span class="comment" id="5274420">//&nbsp;the&nbsp;topmost&nbsp;literal&nbsp;is&nbsp;no&nbsp;longer&nbsp;subject&nbsp;to&nbsp;operators&nbsp;like&nbsp;*</span><br>
<span class="lineno"></span><span class="comment" id="5274484">//&nbsp;(Otherwise&nbsp;ab*&nbsp;would&nbsp;turn&nbsp;into&nbsp;(ab)*.)</span><br>
<span class="lineno"></span><span class="comment" id="5274526">//&nbsp;If&nbsp;r&nbsp;&gt;=&nbsp;0&nbsp;and&nbsp;there&#39;s&nbsp;a&nbsp;node&nbsp;left&nbsp;over,&nbsp;maybeConcat&nbsp;uses&nbsp;it</span><br>
<span class="lineno">150</span><span class="comment" id="5274589">//&nbsp;to&nbsp;push&nbsp;r&nbsp;with&nbsp;the&nbsp;given&nbsp;flags.</span><br>
<span class="lineno"></span><span class="comment" id="5274624">//&nbsp;maybeConcat&nbsp;reports&nbsp;whether&nbsp;r&nbsp;was&nbsp;pushed.</span><br>
<span class="lineno"></span><span class="keyword" id="5274669">func</span>&nbsp;<span class="op" id="5274674">(</span><span class="ident" id="5274675">p</span>&nbsp;<span class="op" id="5274677">*</span><span class="ident" id="5274678">parser</span><span class="op" id="5274684">)</span>&nbsp;<span class="ident" id="5274686">maybeConcat</span><span class="op" id="5274697">(</span><span class="ident" id="5274698">r</span>&nbsp;<span class="builtintype" id="5274700">rune</span><span class="op" id="5274704">,</span>&nbsp;<span class="ident" id="5274706">flags</span>&nbsp;<span class="ident" id="5274712">Flags</span><span class="op" id="5274717">)</span>&nbsp;<span class="builtintype" id="5274719">bool</span>&nbsp;<span class="op" id="5274724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274727">n</span>&nbsp;<span class="op" id="5274729">:=</span>&nbsp;<span class="builtinfunc" id="5274732">len</span><span class="op" id="5274735">(</span><span class="ident" id="5274736">p</span><span class="op" id="5274737">.</span><span class="ident" id="5274738">stack</span><span class="op" id="5274743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274746">if</span>&nbsp;<span class="ident" id="5274749">n</span>&nbsp;<span class="op" id="5274751">&lt;</span>&nbsp;<span class="num" id="5274753">2</span>&nbsp;<span class="op" id="5274755">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274759">return</span>&nbsp;<span class="builtintype" id="5274766">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274777">re1</span>&nbsp;<span class="op" id="5274781">:=</span>&nbsp;<span class="ident" id="5274784">p</span><span class="op" id="5274785">.</span><span class="ident" id="5274786">stack</span><span class="op" id="5274791">[</span><span class="ident" id="5274792">n</span><span class="op" id="5274793">-</span><span class="num" id="5274794">1</span><span class="op" id="5274795">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274798">re2</span>&nbsp;<span class="op" id="5274802">:=</span>&nbsp;<span class="ident" id="5274805">p</span><span class="op" id="5274806">.</span><span class="ident" id="5274807">stack</span><span class="op" id="5274812">[</span><span class="ident" id="5274813">n</span><span class="op" id="5274814">-</span><span class="num" id="5274815">2</span><span class="op" id="5274816">]</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274819">if</span>&nbsp;<span class="ident" id="5274822">re1</span><span class="op" id="5274825">.</span><span class="ident" id="5274826">Op</span>&nbsp;<span class="op" id="5274829">!=</span>&nbsp;<span class="ident" id="5274832">OpLiteral</span>&nbsp;<span class="op" id="5274842">||</span>&nbsp;<span class="ident" id="5274845">re2</span><span class="op" id="5274848">.</span><span class="ident" id="5274849">Op</span>&nbsp;<span class="op" id="5274852">!=</span>&nbsp;<span class="ident" id="5274855">OpLiteral</span>&nbsp;<span class="op" id="5274865">||</span>&nbsp;<span class="ident" id="5274868">re1</span><span class="op" id="5274871">.</span><span class="ident" id="5274872">Flags</span><span class="op" id="5274877">&amp;</span><span class="ident" id="5274878">FoldCase</span>&nbsp;<span class="op" id="5274887">!=</span>&nbsp;<span class="ident" id="5274890">re2</span><span class="op" id="5274893">.</span><span class="ident" id="5274894">Flags</span><span class="op" id="5274899">&amp;</span><span class="ident" id="5274900">FoldCase</span>&nbsp;<span class="op" id="5274909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274913">return</span>&nbsp;<span class="builtintype" id="5274920">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274931">//&nbsp;Push&nbsp;re1&nbsp;into&nbsp;re2.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274954">re2</span><span class="op" id="5274957">.</span><span class="ident" id="5274958">Rune</span>&nbsp;<span class="op" id="5274963">=</span>&nbsp;<span class="builtinfunc" id="5274965">append</span><span class="op" id="5274971">(</span><span class="ident" id="5274972">re2</span><span class="op" id="5274975">.</span><span class="ident" id="5274976">Rune</span><span class="op" id="5274980">,</span>&nbsp;<span class="ident" id="5274982">re1</span><span class="op" id="5274985">.</span><span class="ident" id="5274986">Rune</span><span class="op" id="5274990">...</span><span class="op" id="5274993">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274997">//&nbsp;Reuse&nbsp;re1&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275024">if</span>&nbsp;<span class="ident" id="5275027">r</span>&nbsp;<span class="op" id="5275029">&gt;=</span>&nbsp;<span class="num" id="5275032">0</span>&nbsp;<span class="op" id="5275034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275038">re1</span><span class="op" id="5275041">.</span><span class="ident" id="5275042">Rune</span>&nbsp;<span class="op" id="5275047">=</span>&nbsp;<span class="ident" id="5275049">re1</span><span class="op" id="5275052">.</span><span class="ident" id="5275053">Rune0</span><span class="op" id="5275058">[</span><span class="op" id="5275059">:</span><span class="num" id="5275060">1</span><span class="op" id="5275061">]</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275065">re1</span><span class="op" id="5275068">.</span><span class="ident" id="5275069">Rune</span><span class="op" id="5275073">[</span><span class="num" id="5275074">0</span><span class="op" id="5275075">]</span>&nbsp;<span class="op" id="5275077">=</span>&nbsp;<span class="ident" id="5275079">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275083">re1</span><span class="op" id="5275086">.</span><span class="ident" id="5275087">Flags</span>&nbsp;<span class="op" id="5275093">=</span>&nbsp;<span class="ident" id="5275095">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275103">return</span>&nbsp;<span class="builtintype" id="5275110">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275120">p</span><span class="op" id="5275121">.</span><span class="ident" id="5275122">stack</span>&nbsp;<span class="op" id="5275128">=</span>&nbsp;<span class="ident" id="5275130">p</span><span class="op" id="5275131">.</span><span class="ident" id="5275132">stack</span><span class="op" id="5275137">[</span><span class="op" id="5275138">:</span><span class="ident" id="5275139">n</span><span class="op" id="5275140">-</span><span class="num" id="5275141">1</span><span class="op" id="5275142">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275145">p</span><span class="op" id="5275146">.</span><span class="ident" id="5275147">reuse</span><span class="op" id="5275152">(</span><span class="ident" id="5275153">re1</span><span class="op" id="5275156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275159">return</span>&nbsp;<span class="builtintype" id="5275166">false</span>&nbsp;<span class="comment" id="5275172">//&nbsp;did&nbsp;not&nbsp;push&nbsp;r</span><br>
<span class="lineno"></span><span class="op" id="5275190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="5275193">//&nbsp;newLiteral&nbsp;returns&nbsp;a&nbsp;new&nbsp;OpLiteral&nbsp;Regexp&nbsp;with&nbsp;the&nbsp;given&nbsp;flags</span><br>
<span class="lineno"></span><span class="keyword" id="5275259">func</span>&nbsp;<span class="op" id="5275264">(</span><span class="ident" id="5275265">p</span>&nbsp;<span class="op" id="5275267">*</span><span class="ident" id="5275268">parser</span><span class="op" id="5275274">)</span>&nbsp;<span class="ident" id="5275276">newLiteral</span><span class="op" id="5275286">(</span><span class="ident" id="5275287">r</span>&nbsp;<span class="builtintype" id="5275289">rune</span><span class="op" id="5275293">,</span>&nbsp;<span class="ident" id="5275295">flags</span>&nbsp;<span class="ident" id="5275301">Flags</span><span class="op" id="5275306">)</span>&nbsp;<span class="op" id="5275308">*</span><span class="ident" id="5275309">Regexp</span>&nbsp;<span class="op" id="5275316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275319">re</span>&nbsp;<span class="op" id="5275322">:=</span>&nbsp;<span class="ident" id="5275325">p</span><span class="op" id="5275326">.</span><span class="ident" id="5275327">newRegexp</span><span class="op" id="5275336">(</span><span class="ident" id="5275337">OpLiteral</span><span class="op" id="5275346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275349">re</span><span class="op" id="5275351">.</span><span class="ident" id="5275352">Flags</span>&nbsp;<span class="op" id="5275358">=</span>&nbsp;<span class="ident" id="5275360">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275367">if</span>&nbsp;<span class="ident" id="5275370">flags</span><span class="op" id="5275375">&amp;</span><span class="ident" id="5275376">FoldCase</span>&nbsp;<span class="op" id="5275385">!=</span>&nbsp;<span class="num" id="5275388">0</span>&nbsp;<span class="op" id="5275390">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275394">r</span>&nbsp;<span class="op" id="5275396">=</span>&nbsp;<span class="ident" id="5275398">minFoldRune</span><span class="op" id="5275409">(</span><span class="ident" id="5275410">r</span><span class="op" id="5275411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275417">re</span><span class="op" id="5275419">.</span><span class="ident" id="5275420">Rune0</span><span class="op" id="5275425">[</span><span class="num" id="5275426">0</span><span class="op" id="5275427">]</span>&nbsp;<span class="op" id="5275429">=</span>&nbsp;<span class="ident" id="5275431">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275434">re</span><span class="op" id="5275436">.</span><span class="ident" id="5275437">Rune</span>&nbsp;<span class="op" id="5275442">=</span>&nbsp;<span class="ident" id="5275444">re</span><span class="op" id="5275446">.</span><span class="ident" id="5275447">Rune0</span><span class="op" id="5275452">[</span><span class="op" id="5275453">:</span><span class="num" id="5275454">1</span><span class="op" id="5275455">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275458">return</span>&nbsp;<span class="ident" id="5275465">re</span><br>
<span class="lineno">190</span><span class="op" id="5275468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5275471">//&nbsp;minFoldRune&nbsp;returns&nbsp;the&nbsp;minimum&nbsp;rune&nbsp;fold-equivalent&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5275533">func</span>&nbsp;<span class="ident" id="5275538">minFoldRune</span><span class="op" id="5275549">(</span><span class="ident" id="5275550">r</span>&nbsp;<span class="builtintype" id="5275552">rune</span><span class="op" id="5275556">)</span>&nbsp;<span class="builtintype" id="5275558">rune</span>&nbsp;<span class="op" id="5275563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275566">if</span>&nbsp;<span class="ident" id="5275569">r</span>&nbsp;<span class="op" id="5275571">&lt;</span>&nbsp;<span class="ident" id="5275573">minFold</span>&nbsp;<span class="op" id="5275581">||</span>&nbsp;<span class="ident" id="5275584">r</span>&nbsp;<span class="op" id="5275586">&gt;</span>&nbsp;<span class="ident" id="5275588">maxFold</span>&nbsp;<span class="op" id="5275596">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275600">return</span>&nbsp;<span class="ident" id="5275607">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275613">min</span>&nbsp;<span class="op" id="5275617">:=</span>&nbsp;<span class="ident" id="5275620">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275623">r0</span>&nbsp;<span class="op" id="5275626">:=</span>&nbsp;<span class="ident" id="5275629">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275632">for</span>&nbsp;<span class="ident" id="5275636">r</span>&nbsp;<span class="op" id="5275638">=</span>&nbsp;<span class="ident" id="5275640">unicode</span><span class="op" id="5275647">.</span><span class="ident" id="5275648">SimpleFold</span><span class="op" id="5275658">(</span><span class="ident" id="5275659">r</span><span class="op" id="5275660">)</span><span class="op" id="5275661">;</span>&nbsp;<span class="ident" id="5275663">r</span>&nbsp;<span class="op" id="5275665">!=</span>&nbsp;<span class="ident" id="5275668">r0</span><span class="op" id="5275670">;</span>&nbsp;<span class="ident" id="5275672">r</span>&nbsp;<span class="op" id="5275674">=</span>&nbsp;<span class="ident" id="5275676">unicode</span><span class="op" id="5275683">.</span><span class="ident" id="5275684">SimpleFold</span><span class="op" id="5275694">(</span><span class="ident" id="5275695">r</span><span class="op" id="5275696">)</span>&nbsp;<span class="op" id="5275698">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275702">if</span>&nbsp;<span class="ident" id="5275705">min</span>&nbsp;<span class="op" id="5275709">&gt;</span>&nbsp;<span class="ident" id="5275711">r</span>&nbsp;<span class="op" id="5275713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275718">min</span>&nbsp;<span class="op" id="5275722">=</span>&nbsp;<span class="ident" id="5275724">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275734">return</span>&nbsp;<span class="ident" id="5275741">min</span><br>
<span class="lineno">205</span><span class="op" id="5275745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5275748">//&nbsp;literal&nbsp;pushes&nbsp;a&nbsp;literal&nbsp;regexp&nbsp;for&nbsp;the&nbsp;rune&nbsp;r&nbsp;on&nbsp;the&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="5275811">//&nbsp;and&nbsp;returns&nbsp;that&nbsp;regexp.</span><br>
<span class="lineno"></span><span class="keyword" id="5275839">func</span>&nbsp;<span class="op" id="5275844">(</span><span class="ident" id="5275845">p</span>&nbsp;<span class="op" id="5275847">*</span><span class="ident" id="5275848">parser</span><span class="op" id="5275854">)</span>&nbsp;<span class="ident" id="5275856">literal</span><span class="op" id="5275863">(</span><span class="ident" id="5275864">r</span>&nbsp;<span class="builtintype" id="5275866">rune</span><span class="op" id="5275870">)</span>&nbsp;<span class="op" id="5275872">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275875">p</span><span class="op" id="5275876">.</span><span class="ident" id="5275877">push</span><span class="op" id="5275881">(</span><span class="ident" id="5275882">p</span><span class="op" id="5275883">.</span><span class="ident" id="5275884">newLiteral</span><span class="op" id="5275894">(</span><span class="ident" id="5275895">r</span><span class="op" id="5275896">,</span>&nbsp;<span class="ident" id="5275898">p</span><span class="op" id="5275899">.</span><span class="ident" id="5275900">flags</span><span class="op" id="5275905">)</span><span class="op" id="5275906">)</span><br>
<span class="lineno"></span><span class="op" id="5275908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5275911">//&nbsp;op&nbsp;pushes&nbsp;a&nbsp;regexp&nbsp;with&nbsp;the&nbsp;given&nbsp;op&nbsp;onto&nbsp;the&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="5275966">//&nbsp;and&nbsp;returns&nbsp;that&nbsp;regexp.</span><br>
<span class="lineno">215</span><span class="keyword" id="5275994">func</span>&nbsp;<span class="op" id="5275999">(</span><span class="ident" id="5276000">p</span>&nbsp;<span class="op" id="5276002">*</span><span class="ident" id="5276003">parser</span><span class="op" id="5276009">)</span>&nbsp;<span class="ident" id="5276011">op</span><span class="op" id="5276013">(</span><span class="ident" id="5276014">op</span>&nbsp;<span class="ident" id="5276017">Op</span><span class="op" id="5276019">)</span>&nbsp;<span class="op" id="5276021">*</span><span class="ident" id="5276022">Regexp</span>&nbsp;<span class="op" id="5276029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276032">re</span>&nbsp;<span class="op" id="5276035">:=</span>&nbsp;<span class="ident" id="5276038">p</span><span class="op" id="5276039">.</span><span class="ident" id="5276040">newRegexp</span><span class="op" id="5276049">(</span><span class="ident" id="5276050">op</span><span class="op" id="5276052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276055">re</span><span class="op" id="5276057">.</span><span class="ident" id="5276058">Flags</span>&nbsp;<span class="op" id="5276064">=</span>&nbsp;<span class="ident" id="5276066">p</span><span class="op" id="5276067">.</span><span class="ident" id="5276068">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276075">return</span>&nbsp;<span class="ident" id="5276082">p</span><span class="op" id="5276083">.</span><span class="ident" id="5276084">push</span><span class="op" id="5276088">(</span><span class="ident" id="5276089">re</span><span class="op" id="5276091">)</span><br>
<span class="lineno"></span><span class="op" id="5276093">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="5276096">//&nbsp;repeat&nbsp;replaces&nbsp;the&nbsp;top&nbsp;stack&nbsp;element&nbsp;with&nbsp;itself&nbsp;repeated&nbsp;according&nbsp;to&nbsp;op,&nbsp;min,&nbsp;max.</span><br>
<span class="lineno"></span><span class="comment" id="5276185">//&nbsp;before&nbsp;is&nbsp;the&nbsp;regexp&nbsp;suffix&nbsp;starting&nbsp;at&nbsp;the&nbsp;repetition&nbsp;operator.</span><br>
<span class="lineno"></span><span class="comment" id="5276253">//&nbsp;after&nbsp;is&nbsp;the&nbsp;regexp&nbsp;suffix&nbsp;following&nbsp;after&nbsp;the&nbsp;repetition&nbsp;operator.</span><br>
<span class="lineno"></span><span class="comment" id="5276324">//&nbsp;repeat&nbsp;returns&nbsp;an&nbsp;updated&nbsp;&#39;after&#39;&nbsp;and&nbsp;an&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">225</span><span class="keyword" id="5276383">func</span>&nbsp;<span class="op" id="5276388">(</span><span class="ident" id="5276389">p</span>&nbsp;<span class="op" id="5276391">*</span><span class="ident" id="5276392">parser</span><span class="op" id="5276398">)</span>&nbsp;<span class="ident" id="5276400">repeat</span><span class="op" id="5276406">(</span><span class="ident" id="5276407">op</span>&nbsp;<span class="ident" id="5276410">Op</span><span class="op" id="5276412">,</span>&nbsp;<span class="ident" id="5276414">min</span><span class="op" id="5276417">,</span>&nbsp;<span class="ident" id="5276419">max</span>&nbsp;<span class="builtintype" id="5276423">int</span><span class="op" id="5276426">,</span>&nbsp;<span class="ident" id="5276428">before</span><span class="op" id="5276434">,</span>&nbsp;<span class="ident" id="5276436">after</span><span class="op" id="5276441">,</span>&nbsp;<span class="ident" id="5276443">lastRepeat</span>&nbsp;<span class="builtintype" id="5276454">string</span><span class="op" id="5276460">)</span>&nbsp;<span class="op" id="5276462">(</span><span class="builtintype" id="5276463">string</span><span class="op" id="5276469">,</span>&nbsp;<span class="builtintype" id="5276471">error</span><span class="op" id="5276476">)</span>&nbsp;<span class="op" id="5276478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276481">flags</span>&nbsp;<span class="op" id="5276487">:=</span>&nbsp;<span class="ident" id="5276490">p</span><span class="op" id="5276491">.</span><span class="ident" id="5276492">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276499">if</span>&nbsp;<span class="ident" id="5276502">p</span><span class="op" id="5276503">.</span><span class="ident" id="5276504">flags</span><span class="op" id="5276509">&amp;</span><span class="ident" id="5276510">PerlX</span>&nbsp;<span class="op" id="5276516">!=</span>&nbsp;<span class="num" id="5276519">0</span>&nbsp;<span class="op" id="5276521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276525">if</span>&nbsp;<span class="builtinfunc" id="5276528">len</span><span class="op" id="5276531">(</span><span class="ident" id="5276532">after</span><span class="op" id="5276537">)</span>&nbsp;<span class="op" id="5276539">&gt;</span>&nbsp;<span class="num" id="5276541">0</span>&nbsp;<span class="op" id="5276543">&amp;&amp;</span>&nbsp;<span class="ident" id="5276546">after</span><span class="op" id="5276551">[</span><span class="num" id="5276552">0</span><span class="op" id="5276553">]</span>&nbsp;<span class="op" id="5276555">==</span>&nbsp;<span class="string" id="5276558">&#39;?&#39;</span>&nbsp;<span class="op" id="5276562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276567">after</span>&nbsp;<span class="op" id="5276573">=</span>&nbsp;<span class="ident" id="5276575">after</span><span class="op" id="5276580">[</span><span class="num" id="5276581">1</span><span class="op" id="5276582">:</span><span class="op" id="5276583">]</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276588">flags</span>&nbsp;<span class="op" id="5276594">^=</span>&nbsp;<span class="ident" id="5276597">NonGreedy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276613">if</span>&nbsp;<span class="ident" id="5276616">lastRepeat</span>&nbsp;<span class="op" id="5276627">!=</span>&nbsp;<span class="string" id="5276630">&#34;&#34;</span>&nbsp;<span class="op" id="5276633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276638">//&nbsp;In&nbsp;Perl&nbsp;it&nbsp;is&nbsp;not&nbsp;allowed&nbsp;to&nbsp;stack&nbsp;repetition&nbsp;operators:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276701">//&nbsp;a**&nbsp;is&nbsp;a&nbsp;syntax&nbsp;error,&nbsp;not&nbsp;a&nbsp;doubled&nbsp;star,&nbsp;and&nbsp;a++&nbsp;means</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276764">//&nbsp;something&nbsp;else&nbsp;entirely,&nbsp;which&nbsp;we&nbsp;don&#39;t&nbsp;support!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276819">return</span>&nbsp;<span class="string" id="5276826">&#34;&#34;</span><span class="op" id="5276828">,</span>&nbsp;<span class="op" id="5276830">&amp;</span><span class="ident" id="5276831">Error</span><span class="op" id="5276836">{</span><span class="ident" id="5276837">ErrInvalidRepeatOp</span><span class="op" id="5276855">,</span>&nbsp;<span class="ident" id="5276857">lastRepeat</span><span class="op" id="5276867">[</span><span class="op" id="5276868">:</span><span class="builtinfunc" id="5276869">len</span><span class="op" id="5276872">(</span><span class="ident" id="5276873">lastRepeat</span><span class="op" id="5276883">)</span><span class="op" id="5276884">-</span><span class="builtinfunc" id="5276885">len</span><span class="op" id="5276888">(</span><span class="ident" id="5276889">after</span><span class="op" id="5276894">)</span><span class="op" id="5276895">]</span><span class="op" id="5276896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276906">n</span>&nbsp;<span class="op" id="5276908">:=</span>&nbsp;<span class="builtinfunc" id="5276911">len</span><span class="op" id="5276914">(</span><span class="ident" id="5276915">p</span><span class="op" id="5276916">.</span><span class="ident" id="5276917">stack</span><span class="op" id="5276922">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276925">if</span>&nbsp;<span class="ident" id="5276928">n</span>&nbsp;<span class="op" id="5276930">==</span>&nbsp;<span class="num" id="5276933">0</span>&nbsp;<span class="op" id="5276935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276939">return</span>&nbsp;<span class="string" id="5276946">&#34;&#34;</span><span class="op" id="5276948">,</span>&nbsp;<span class="op" id="5276950">&amp;</span><span class="ident" id="5276951">Error</span><span class="op" id="5276956">{</span><span class="ident" id="5276957">ErrMissingRepeatArgument</span><span class="op" id="5276981">,</span>&nbsp;<span class="ident" id="5276983">before</span><span class="op" id="5276989">[</span><span class="op" id="5276990">:</span><span class="builtinfunc" id="5276991">len</span><span class="op" id="5276994">(</span><span class="ident" id="5276995">before</span><span class="op" id="5277001">)</span><span class="op" id="5277002">-</span><span class="builtinfunc" id="5277003">len</span><span class="op" id="5277006">(</span><span class="ident" id="5277007">after</span><span class="op" id="5277012">)</span><span class="op" id="5277013">]</span><span class="op" id="5277014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277020">sub</span>&nbsp;<span class="op" id="5277024">:=</span>&nbsp;<span class="ident" id="5277027">p</span><span class="op" id="5277028">.</span><span class="ident" id="5277029">stack</span><span class="op" id="5277034">[</span><span class="ident" id="5277035">n</span><span class="op" id="5277036">-</span><span class="num" id="5277037">1</span><span class="op" id="5277038">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277041">if</span>&nbsp;<span class="ident" id="5277044">sub</span><span class="op" id="5277047">.</span><span class="ident" id="5277048">Op</span>&nbsp;<span class="op" id="5277051">&gt;=</span>&nbsp;<span class="ident" id="5277054">opPseudo</span>&nbsp;<span class="op" id="5277063">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277067">return</span>&nbsp;<span class="string" id="5277074">&#34;&#34;</span><span class="op" id="5277076">,</span>&nbsp;<span class="op" id="5277078">&amp;</span><span class="ident" id="5277079">Error</span><span class="op" id="5277084">{</span><span class="ident" id="5277085">ErrMissingRepeatArgument</span><span class="op" id="5277109">,</span>&nbsp;<span class="ident" id="5277111">before</span><span class="op" id="5277117">[</span><span class="op" id="5277118">:</span><span class="builtinfunc" id="5277119">len</span><span class="op" id="5277122">(</span><span class="ident" id="5277123">before</span><span class="op" id="5277129">)</span><span class="op" id="5277130">-</span><span class="builtinfunc" id="5277131">len</span><span class="op" id="5277134">(</span><span class="ident" id="5277135">after</span><span class="op" id="5277140">)</span><span class="op" id="5277141">]</span><span class="op" id="5277142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277149">re</span>&nbsp;<span class="op" id="5277152">:=</span>&nbsp;<span class="ident" id="5277155">p</span><span class="op" id="5277156">.</span><span class="ident" id="5277157">newRegexp</span><span class="op" id="5277166">(</span><span class="ident" id="5277167">op</span><span class="op" id="5277169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277172">re</span><span class="op" id="5277174">.</span><span class="ident" id="5277175">Min</span>&nbsp;<span class="op" id="5277179">=</span>&nbsp;<span class="ident" id="5277181">min</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277186">re</span><span class="op" id="5277188">.</span><span class="ident" id="5277189">Max</span>&nbsp;<span class="op" id="5277193">=</span>&nbsp;<span class="ident" id="5277195">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277200">re</span><span class="op" id="5277202">.</span><span class="ident" id="5277203">Flags</span>&nbsp;<span class="op" id="5277209">=</span>&nbsp;<span class="ident" id="5277211">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277218">re</span><span class="op" id="5277220">.</span><span class="ident" id="5277221">Sub</span>&nbsp;<span class="op" id="5277225">=</span>&nbsp;<span class="ident" id="5277227">re</span><span class="op" id="5277229">.</span><span class="ident" id="5277230">Sub0</span><span class="op" id="5277234">[</span><span class="op" id="5277235">:</span><span class="num" id="5277236">1</span><span class="op" id="5277237">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277240">re</span><span class="op" id="5277242">.</span><span class="ident" id="5277243">Sub</span><span class="op" id="5277246">[</span><span class="num" id="5277247">0</span><span class="op" id="5277248">]</span>&nbsp;<span class="op" id="5277250">=</span>&nbsp;<span class="ident" id="5277252">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277257">p</span><span class="op" id="5277258">.</span><span class="ident" id="5277259">stack</span><span class="op" id="5277264">[</span><span class="ident" id="5277265">n</span><span class="op" id="5277266">-</span><span class="num" id="5277267">1</span><span class="op" id="5277268">]</span>&nbsp;<span class="op" id="5277270">=</span>&nbsp;<span class="ident" id="5277272">re</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277277">if</span>&nbsp;<span class="ident" id="5277280">op</span>&nbsp;<span class="op" id="5277283">==</span>&nbsp;<span class="ident" id="5277286">OpRepeat</span>&nbsp;<span class="op" id="5277295">&amp;&amp;</span>&nbsp;<span class="op" id="5277298">(</span><span class="ident" id="5277299">min</span>&nbsp;<span class="op" id="5277303">&gt;=</span>&nbsp;<span class="num" id="5277306">2</span>&nbsp;<span class="op" id="5277308">||</span>&nbsp;<span class="ident" id="5277311">max</span>&nbsp;<span class="op" id="5277315">&gt;=</span>&nbsp;<span class="num" id="5277318">2</span><span class="op" id="5277319">)</span>&nbsp;<span class="op" id="5277321">&amp;&amp;</span>&nbsp;<span class="op" id="5277324">!</span><span class="ident" id="5277325">repeatIsValid</span><span class="op" id="5277338">(</span><span class="ident" id="5277339">re</span><span class="op" id="5277341">,</span>&nbsp;<span class="num" id="5277343">1000</span><span class="op" id="5277347">)</span>&nbsp;<span class="op" id="5277349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277353">return</span>&nbsp;<span class="string" id="5277360">&#34;&#34;</span><span class="op" id="5277362">,</span>&nbsp;<span class="op" id="5277364">&amp;</span><span class="ident" id="5277365">Error</span><span class="op" id="5277370">{</span><span class="ident" id="5277371">ErrInvalidRepeatSize</span><span class="op" id="5277391">,</span>&nbsp;<span class="ident" id="5277393">before</span><span class="op" id="5277399">[</span><span class="op" id="5277400">:</span><span class="builtinfunc" id="5277401">len</span><span class="op" id="5277404">(</span><span class="ident" id="5277405">before</span><span class="op" id="5277411">)</span><span class="op" id="5277412">-</span><span class="builtinfunc" id="5277413">len</span><span class="op" id="5277416">(</span><span class="ident" id="5277417">after</span><span class="op" id="5277422">)</span><span class="op" id="5277423">]</span><span class="op" id="5277424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277431">return</span>&nbsp;<span class="ident" id="5277438">after</span><span class="op" id="5277443">,</span>&nbsp;<span class="ident" id="5277445">nil</span><br>
<span class="lineno"></span><span class="op" id="5277449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5277452">//&nbsp;repeatIsValid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;repetition&nbsp;re&nbsp;is&nbsp;valid.</span><br>
<span class="lineno"></span><span class="comment" id="5277513">//&nbsp;Valid&nbsp;means&nbsp;that&nbsp;the&nbsp;combination&nbsp;of&nbsp;the&nbsp;top-level&nbsp;repetition</span><br>
<span class="lineno">265</span><span class="comment" id="5277577">//&nbsp;and&nbsp;any&nbsp;inner&nbsp;repetitions&nbsp;does&nbsp;not&nbsp;exceed&nbsp;n&nbsp;copies&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5277638">//&nbsp;innermost&nbsp;thing.</span><br>
<span class="lineno"></span><span class="comment" id="5277658">//&nbsp;This&nbsp;function&nbsp;rewalks&nbsp;the&nbsp;regexp&nbsp;tree&nbsp;and&nbsp;is&nbsp;called&nbsp;for&nbsp;every&nbsp;repetition,</span><br>
<span class="lineno"></span><span class="comment" id="5277735">//&nbsp;so&nbsp;we&nbsp;have&nbsp;to&nbsp;worry&nbsp;about&nbsp;inducing&nbsp;quadratic&nbsp;behavior&nbsp;in&nbsp;the&nbsp;parser.</span><br>
<span class="lineno"></span><span class="comment" id="5277807">//&nbsp;We&nbsp;avoid&nbsp;this&nbsp;by&nbsp;only&nbsp;calling&nbsp;repeatIsValid&nbsp;when&nbsp;min&nbsp;or&nbsp;max&nbsp;&gt;=&nbsp;2.</span><br>
<span class="lineno">270</span><span class="comment" id="5277876">//&nbsp;In&nbsp;that&nbsp;case&nbsp;the&nbsp;depth&nbsp;of&nbsp;any&nbsp;&gt;=&nbsp;2&nbsp;nesting&nbsp;can&nbsp;only&nbsp;get&nbsp;to&nbsp;9&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5277948">//&nbsp;triggering&nbsp;a&nbsp;parse&nbsp;error,&nbsp;so&nbsp;each&nbsp;subtree&nbsp;can&nbsp;only&nbsp;be&nbsp;rewalked&nbsp;9&nbsp;times.</span><br>
<span class="lineno"></span><span class="keyword" id="5278023">func</span>&nbsp;<span class="ident" id="5278028">repeatIsValid</span><span class="op" id="5278041">(</span><span class="ident" id="5278042">re</span>&nbsp;<span class="op" id="5278045">*</span><span class="ident" id="5278046">Regexp</span><span class="op" id="5278052">,</span>&nbsp;<span class="ident" id="5278054">n</span>&nbsp;<span class="builtintype" id="5278056">int</span><span class="op" id="5278059">)</span>&nbsp;<span class="builtintype" id="5278061">bool</span>&nbsp;<span class="op" id="5278066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278069">if</span>&nbsp;<span class="ident" id="5278072">re</span><span class="op" id="5278074">.</span><span class="ident" id="5278075">Op</span>&nbsp;<span class="op" id="5278078">==</span>&nbsp;<span class="ident" id="5278081">OpRepeat</span>&nbsp;<span class="op" id="5278090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278094">m</span>&nbsp;<span class="op" id="5278096">:=</span>&nbsp;<span class="ident" id="5278099">re</span><span class="op" id="5278101">.</span><span class="ident" id="5278102">Max</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278108">if</span>&nbsp;<span class="ident" id="5278111">m</span>&nbsp;<span class="op" id="5278113">==</span>&nbsp;<span class="num" id="5278116">0</span>&nbsp;<span class="op" id="5278118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278123">return</span>&nbsp;<span class="builtintype" id="5278130">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278141">if</span>&nbsp;<span class="ident" id="5278144">m</span>&nbsp;<span class="op" id="5278146">&lt;</span>&nbsp;<span class="num" id="5278148">0</span>&nbsp;<span class="op" id="5278150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278155">m</span>&nbsp;<span class="op" id="5278157">=</span>&nbsp;<span class="ident" id="5278159">re</span><span class="op" id="5278161">.</span><span class="ident" id="5278162">Min</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278172">if</span>&nbsp;<span class="ident" id="5278175">m</span>&nbsp;<span class="op" id="5278177">&gt;</span>&nbsp;<span class="ident" id="5278179">n</span>&nbsp;<span class="op" id="5278181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278186">return</span>&nbsp;<span class="builtintype" id="5278193">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278205">if</span>&nbsp;<span class="ident" id="5278208">m</span>&nbsp;<span class="op" id="5278210">&gt;</span>&nbsp;<span class="num" id="5278212">0</span>&nbsp;<span class="op" id="5278214">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278219">n</span>&nbsp;<span class="op" id="5278221">/=</span>&nbsp;<span class="ident" id="5278224">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278234">for</span>&nbsp;<span class="ident" id="5278238">_</span><span class="op" id="5278239">,</span>&nbsp;<span class="ident" id="5278241">sub</span>&nbsp;<span class="op" id="5278245">:=</span>&nbsp;<span class="keyword" id="5278248">range</span>&nbsp;<span class="ident" id="5278254">re</span><span class="op" id="5278256">.</span><span class="ident" id="5278257">Sub</span>&nbsp;<span class="op" id="5278261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278265">if</span>&nbsp;<span class="op" id="5278268">!</span><span class="ident" id="5278269">repeatIsValid</span><span class="op" id="5278282">(</span><span class="ident" id="5278283">sub</span><span class="op" id="5278286">,</span>&nbsp;<span class="ident" id="5278288">n</span><span class="op" id="5278289">)</span>&nbsp;<span class="op" id="5278291">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278296">return</span>&nbsp;<span class="builtintype" id="5278303">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278317">return</span>&nbsp;<span class="builtintype" id="5278324">true</span><br>
<span class="lineno"></span><span class="op" id="5278329">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="5278332">//&nbsp;concat&nbsp;replaces&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;stack&nbsp;(above&nbsp;the&nbsp;topmost&nbsp;&#39;|&#39;&nbsp;or&nbsp;&#39;(&#39;)&nbsp;with&nbsp;its&nbsp;concatenation.</span><br>
<span class="lineno"></span><span class="keyword" id="5278427">func</span>&nbsp;<span class="op" id="5278432">(</span><span class="ident" id="5278433">p</span>&nbsp;<span class="op" id="5278435">*</span><span class="ident" id="5278436">parser</span><span class="op" id="5278442">)</span>&nbsp;<span class="ident" id="5278444">concat</span><span class="op" id="5278450">(</span><span class="op" id="5278451">)</span>&nbsp;<span class="op" id="5278453">*</span><span class="ident" id="5278454">Regexp</span>&nbsp;<span class="op" id="5278461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278464">p</span><span class="op" id="5278465">.</span><span class="ident" id="5278466">maybeConcat</span><span class="op" id="5278477">(</span><span class="op" id="5278478">-</span><span class="num" id="5278479">1</span><span class="op" id="5278480">,</span>&nbsp;<span class="num" id="5278482">0</span><span class="op" id="5278483">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278487">//&nbsp;Scan&nbsp;down&nbsp;to&nbsp;find&nbsp;pseudo-operator&nbsp;|&nbsp;or&nbsp;(.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278533">i</span>&nbsp;<span class="op" id="5278535">:=</span>&nbsp;<span class="builtinfunc" id="5278538">len</span><span class="op" id="5278541">(</span><span class="ident" id="5278542">p</span><span class="op" id="5278543">.</span><span class="ident" id="5278544">stack</span><span class="op" id="5278549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278552">for</span>&nbsp;<span class="ident" id="5278556">i</span>&nbsp;<span class="op" id="5278558">&gt;</span>&nbsp;<span class="num" id="5278560">0</span>&nbsp;<span class="op" id="5278562">&amp;&amp;</span>&nbsp;<span class="ident" id="5278565">p</span><span class="op" id="5278566">.</span><span class="ident" id="5278567">stack</span><span class="op" id="5278572">[</span><span class="ident" id="5278573">i</span><span class="op" id="5278574">-</span><span class="num" id="5278575">1</span><span class="op" id="5278576">]</span><span class="op" id="5278577">.</span><span class="ident" id="5278578">Op</span>&nbsp;<span class="op" id="5278581">&lt;</span>&nbsp;<span class="ident" id="5278583">opPseudo</span>&nbsp;<span class="op" id="5278592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278596">i</span><span class="op" id="5278597">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278601">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278604">subs</span>&nbsp;<span class="op" id="5278609">:=</span>&nbsp;<span class="ident" id="5278612">p</span><span class="op" id="5278613">.</span><span class="ident" id="5278614">stack</span><span class="op" id="5278619">[</span><span class="ident" id="5278620">i</span><span class="op" id="5278621">:</span><span class="op" id="5278622">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278625">p</span><span class="op" id="5278626">.</span><span class="ident" id="5278627">stack</span>&nbsp;<span class="op" id="5278633">=</span>&nbsp;<span class="ident" id="5278635">p</span><span class="op" id="5278636">.</span><span class="ident" id="5278637">stack</span><span class="op" id="5278642">[</span><span class="op" id="5278643">:</span><span class="ident" id="5278644">i</span><span class="op" id="5278645">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278649">//&nbsp;Empty&nbsp;concatenation&nbsp;is&nbsp;special&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278690">if</span>&nbsp;<span class="builtinfunc" id="5278693">len</span><span class="op" id="5278696">(</span><span class="ident" id="5278697">subs</span><span class="op" id="5278701">)</span>&nbsp;<span class="op" id="5278703">==</span>&nbsp;<span class="num" id="5278706">0</span>&nbsp;<span class="op" id="5278708">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278712">return</span>&nbsp;<span class="ident" id="5278719">p</span><span class="op" id="5278720">.</span><span class="ident" id="5278721">push</span><span class="op" id="5278725">(</span><span class="ident" id="5278726">p</span><span class="op" id="5278727">.</span><span class="ident" id="5278728">newRegexp</span><span class="op" id="5278737">(</span><span class="ident" id="5278738">OpEmptyMatch</span><span class="op" id="5278750">)</span><span class="op" id="5278751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278758">return</span>&nbsp;<span class="ident" id="5278765">p</span><span class="op" id="5278766">.</span><span class="ident" id="5278767">push</span><span class="op" id="5278771">(</span><span class="ident" id="5278772">p</span><span class="op" id="5278773">.</span><span class="ident" id="5278774">collapse</span><span class="op" id="5278782">(</span><span class="ident" id="5278783">subs</span><span class="op" id="5278787">,</span>&nbsp;<span class="ident" id="5278789">OpConcat</span><span class="op" id="5278797">)</span><span class="op" id="5278798">)</span><br>
<span class="lineno"></span><span class="op" id="5278800">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="comment" id="5278803">//&nbsp;alternate&nbsp;replaces&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;stack&nbsp;(above&nbsp;the&nbsp;topmost&nbsp;&#39;(&#39;)&nbsp;with&nbsp;its&nbsp;alternation.</span><br>
<span class="lineno"></span><span class="keyword" id="5278892">func</span>&nbsp;<span class="op" id="5278897">(</span><span class="ident" id="5278898">p</span>&nbsp;<span class="op" id="5278900">*</span><span class="ident" id="5278901">parser</span><span class="op" id="5278907">)</span>&nbsp;<span class="ident" id="5278909">alternate</span><span class="op" id="5278918">(</span><span class="op" id="5278919">)</span>&nbsp;<span class="op" id="5278921">*</span><span class="ident" id="5278922">Regexp</span>&nbsp;<span class="op" id="5278929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278932">//&nbsp;Scan&nbsp;down&nbsp;to&nbsp;find&nbsp;pseudo-operator&nbsp;(.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278973">//&nbsp;There&nbsp;are&nbsp;no&nbsp;|&nbsp;above&nbsp;(.</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279001">i</span>&nbsp;<span class="op" id="5279003">:=</span>&nbsp;<span class="builtinfunc" id="5279006">len</span><span class="op" id="5279009">(</span><span class="ident" id="5279010">p</span><span class="op" id="5279011">.</span><span class="ident" id="5279012">stack</span><span class="op" id="5279017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279020">for</span>&nbsp;<span class="ident" id="5279024">i</span>&nbsp;<span class="op" id="5279026">&gt;</span>&nbsp;<span class="num" id="5279028">0</span>&nbsp;<span class="op" id="5279030">&amp;&amp;</span>&nbsp;<span class="ident" id="5279033">p</span><span class="op" id="5279034">.</span><span class="ident" id="5279035">stack</span><span class="op" id="5279040">[</span><span class="ident" id="5279041">i</span><span class="op" id="5279042">-</span><span class="num" id="5279043">1</span><span class="op" id="5279044">]</span><span class="op" id="5279045">.</span><span class="ident" id="5279046">Op</span>&nbsp;<span class="op" id="5279049">&lt;</span>&nbsp;<span class="ident" id="5279051">opPseudo</span>&nbsp;<span class="op" id="5279060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279064">i</span><span class="op" id="5279065">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279072">subs</span>&nbsp;<span class="op" id="5279077">:=</span>&nbsp;<span class="ident" id="5279080">p</span><span class="op" id="5279081">.</span><span class="ident" id="5279082">stack</span><span class="op" id="5279087">[</span><span class="ident" id="5279088">i</span><span class="op" id="5279089">:</span><span class="op" id="5279090">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279093">p</span><span class="op" id="5279094">.</span><span class="ident" id="5279095">stack</span>&nbsp;<span class="op" id="5279101">=</span>&nbsp;<span class="ident" id="5279103">p</span><span class="op" id="5279104">.</span><span class="ident" id="5279105">stack</span><span class="op" id="5279110">[</span><span class="op" id="5279111">:</span><span class="ident" id="5279112">i</span><span class="op" id="5279113">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5279117">//&nbsp;Make&nbsp;sure&nbsp;top&nbsp;class&nbsp;is&nbsp;clean.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5279151">//&nbsp;All&nbsp;the&nbsp;others&nbsp;already&nbsp;are&nbsp;(see&nbsp;swapVerticalBar).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279205">if</span>&nbsp;<span class="builtinfunc" id="5279208">len</span><span class="op" id="5279211">(</span><span class="ident" id="5279212">subs</span><span class="op" id="5279216">)</span>&nbsp;<span class="op" id="5279218">&gt;</span>&nbsp;<span class="num" id="5279220">0</span>&nbsp;<span class="op" id="5279222">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279226">cleanAlt</span><span class="op" id="5279234">(</span><span class="ident" id="5279235">subs</span><span class="op" id="5279239">[</span><span class="builtinfunc" id="5279240">len</span><span class="op" id="5279243">(</span><span class="ident" id="5279244">subs</span><span class="op" id="5279248">)</span><span class="op" id="5279249">-</span><span class="num" id="5279250">1</span><span class="op" id="5279251">]</span><span class="op" id="5279252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5279259">//&nbsp;Empty&nbsp;alternate&nbsp;is&nbsp;special&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5279295">//&nbsp;(shouldn&#39;t&nbsp;happen&nbsp;but&nbsp;easy&nbsp;to&nbsp;handle).</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279338">if</span>&nbsp;<span class="builtinfunc" id="5279341">len</span><span class="op" id="5279344">(</span><span class="ident" id="5279345">subs</span><span class="op" id="5279349">)</span>&nbsp;<span class="op" id="5279351">==</span>&nbsp;<span class="num" id="5279354">0</span>&nbsp;<span class="op" id="5279356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279360">return</span>&nbsp;<span class="ident" id="5279367">p</span><span class="op" id="5279368">.</span><span class="ident" id="5279369">push</span><span class="op" id="5279373">(</span><span class="ident" id="5279374">p</span><span class="op" id="5279375">.</span><span class="ident" id="5279376">newRegexp</span><span class="op" id="5279385">(</span><span class="ident" id="5279386">OpNoMatch</span><span class="op" id="5279395">)</span><span class="op" id="5279396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279403">return</span>&nbsp;<span class="ident" id="5279410">p</span><span class="op" id="5279411">.</span><span class="ident" id="5279412">push</span><span class="op" id="5279416">(</span><span class="ident" id="5279417">p</span><span class="op" id="5279418">.</span><span class="ident" id="5279419">collapse</span><span class="op" id="5279427">(</span><span class="ident" id="5279428">subs</span><span class="op" id="5279432">,</span>&nbsp;<span class="ident" id="5279434">OpAlternate</span><span class="op" id="5279445">)</span><span class="op" id="5279446">)</span><br>
<span class="lineno">340</span><span class="op" id="5279448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5279451">//&nbsp;cleanAlt&nbsp;cleans&nbsp;re&nbsp;for&nbsp;eventual&nbsp;inclusion&nbsp;in&nbsp;an&nbsp;alternation.</span><br>
<span class="lineno"></span><span class="keyword" id="5279515">func</span>&nbsp;<span class="ident" id="5279520">cleanAlt</span><span class="op" id="5279528">(</span><span class="ident" id="5279529">re</span>&nbsp;<span class="op" id="5279532">*</span><span class="ident" id="5279533">Regexp</span><span class="op" id="5279539">)</span>&nbsp;<span class="op" id="5279541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279544">switch</span>&nbsp;<span class="ident" id="5279551">re</span><span class="op" id="5279553">.</span><span class="ident" id="5279554">Op</span>&nbsp;<span class="op" id="5279557">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279560">case</span>&nbsp;<span class="ident" id="5279565">OpCharClass</span><span class="op" id="5279576">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279580">re</span><span class="op" id="5279582">.</span><span class="ident" id="5279583">Rune</span>&nbsp;<span class="op" id="5279588">=</span>&nbsp;<span class="ident" id="5279590">cleanClass</span><span class="op" id="5279600">(</span><span class="op" id="5279601">&amp;</span><span class="ident" id="5279602">re</span><span class="op" id="5279604">.</span><span class="ident" id="5279605">Rune</span><span class="op" id="5279609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279613">if</span>&nbsp;<span class="builtinfunc" id="5279616">len</span><span class="op" id="5279619">(</span><span class="ident" id="5279620">re</span><span class="op" id="5279622">.</span><span class="ident" id="5279623">Rune</span><span class="op" id="5279627">)</span>&nbsp;<span class="op" id="5279629">==</span>&nbsp;<span class="num" id="5279632">2</span>&nbsp;<span class="op" id="5279634">&amp;&amp;</span>&nbsp;<span class="ident" id="5279637">re</span><span class="op" id="5279639">.</span><span class="ident" id="5279640">Rune</span><span class="op" id="5279644">[</span><span class="num" id="5279645">0</span><span class="op" id="5279646">]</span>&nbsp;<span class="op" id="5279648">==</span>&nbsp;<span class="num" id="5279651">0</span>&nbsp;<span class="op" id="5279653">&amp;&amp;</span>&nbsp;<span class="ident" id="5279656">re</span><span class="op" id="5279658">.</span><span class="ident" id="5279659">Rune</span><span class="op" id="5279663">[</span><span class="num" id="5279664">1</span><span class="op" id="5279665">]</span>&nbsp;<span class="op" id="5279667">==</span>&nbsp;<span class="ident" id="5279670">unicode</span><span class="op" id="5279677">.</span><span class="ident" id="5279678">MaxRune</span>&nbsp;<span class="op" id="5279686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279691">re</span><span class="op" id="5279693">.</span><span class="ident" id="5279694">Rune</span>&nbsp;<span class="op" id="5279699">=</span>&nbsp;<span class="ident" id="5279701">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279708">re</span><span class="op" id="5279710">.</span><span class="ident" id="5279711">Op</span>&nbsp;<span class="op" id="5279714">=</span>&nbsp;<span class="ident" id="5279716">OpAnyChar</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279729">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279742">if</span>&nbsp;<span class="builtinfunc" id="5279745">len</span><span class="op" id="5279748">(</span><span class="ident" id="5279749">re</span><span class="op" id="5279751">.</span><span class="ident" id="5279752">Rune</span><span class="op" id="5279756">)</span>&nbsp;<span class="op" id="5279758">==</span>&nbsp;<span class="num" id="5279761">4</span>&nbsp;<span class="op" id="5279763">&amp;&amp;</span>&nbsp;<span class="ident" id="5279766">re</span><span class="op" id="5279768">.</span><span class="ident" id="5279769">Rune</span><span class="op" id="5279773">[</span><span class="num" id="5279774">0</span><span class="op" id="5279775">]</span>&nbsp;<span class="op" id="5279777">==</span>&nbsp;<span class="num" id="5279780">0</span>&nbsp;<span class="op" id="5279782">&amp;&amp;</span>&nbsp;<span class="ident" id="5279785">re</span><span class="op" id="5279787">.</span><span class="ident" id="5279788">Rune</span><span class="op" id="5279792">[</span><span class="num" id="5279793">1</span><span class="op" id="5279794">]</span>&nbsp;<span class="op" id="5279796">==</span>&nbsp;<span class="string" id="5279799">&#39;\n&#39;</span><span class="op" id="5279803">-</span><span class="num" id="5279804">1</span>&nbsp;<span class="op" id="5279806">&amp;&amp;</span>&nbsp;<span class="ident" id="5279809">re</span><span class="op" id="5279811">.</span><span class="ident" id="5279812">Rune</span><span class="op" id="5279816">[</span><span class="num" id="5279817">2</span><span class="op" id="5279818">]</span>&nbsp;<span class="op" id="5279820">==</span>&nbsp;<span class="string" id="5279823">&#39;\n&#39;</span><span class="op" id="5279827">+</span><span class="num" id="5279828">1</span>&nbsp;<span class="op" id="5279830">&amp;&amp;</span>&nbsp;<span class="ident" id="5279833">re</span><span class="op" id="5279835">.</span><span class="ident" id="5279836">Rune</span><span class="op" id="5279840">[</span><span class="num" id="5279841">3</span><span class="op" id="5279842">]</span>&nbsp;<span class="op" id="5279844">==</span>&nbsp;<span class="ident" id="5279847">unicode</span><span class="op" id="5279854">.</span><span class="ident" id="5279855">MaxRune</span>&nbsp;<span class="op" id="5279863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279868">re</span><span class="op" id="5279870">.</span><span class="ident" id="5279871">Rune</span>&nbsp;<span class="op" id="5279876">=</span>&nbsp;<span class="ident" id="5279878">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279885">re</span><span class="op" id="5279887">.</span><span class="ident" id="5279888">Op</span>&nbsp;<span class="op" id="5279891">=</span>&nbsp;<span class="ident" id="5279893">OpAnyCharNotNL</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279911">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279924">if</span>&nbsp;<span class="builtinfunc" id="5279927">cap</span><span class="op" id="5279930">(</span><span class="ident" id="5279931">re</span><span class="op" id="5279933">.</span><span class="ident" id="5279934">Rune</span><span class="op" id="5279938">)</span><span class="op" id="5279939">-</span><span class="builtinfunc" id="5279940">len</span><span class="op" id="5279943">(</span><span class="ident" id="5279944">re</span><span class="op" id="5279946">.</span><span class="ident" id="5279947">Rune</span><span class="op" id="5279951">)</span>&nbsp;<span class="op" id="5279953">&gt;</span>&nbsp;<span class="num" id="5279955">100</span>&nbsp;<span class="op" id="5279959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5279964">//&nbsp;re.Rune&nbsp;will&nbsp;not&nbsp;grow&nbsp;any&nbsp;more.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5280002">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;or&nbsp;inline&nbsp;to&nbsp;reclaim&nbsp;storage.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280050">re</span><span class="op" id="5280052">.</span><span class="ident" id="5280053">Rune</span>&nbsp;<span class="op" id="5280058">=</span>&nbsp;<span class="builtinfunc" id="5280060">append</span><span class="op" id="5280066">(</span><span class="ident" id="5280067">re</span><span class="op" id="5280069">.</span><span class="ident" id="5280070">Rune0</span><span class="op" id="5280075">[</span><span class="op" id="5280076">:</span><span class="num" id="5280077">0</span><span class="op" id="5280078">]</span><span class="op" id="5280079">,</span>&nbsp;<span class="ident" id="5280081">re</span><span class="op" id="5280083">.</span><span class="ident" id="5280084">Rune</span><span class="op" id="5280088">...</span><span class="op" id="5280091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5280095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5280098">}</span><br>
<span class="lineno"></span><span class="op" id="5280100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="5280103">//&nbsp;collapse&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;applying&nbsp;op&nbsp;to&nbsp;sub.</span><br>
<span class="lineno"></span><span class="comment" id="5280157">//&nbsp;If&nbsp;sub&nbsp;contains&nbsp;op&nbsp;nodes,&nbsp;they&nbsp;all&nbsp;get&nbsp;hoisted&nbsp;up</span><br>
<span class="lineno"></span><span class="comment" id="5280210">//&nbsp;so&nbsp;that&nbsp;there&nbsp;is&nbsp;never&nbsp;a&nbsp;concat&nbsp;of&nbsp;a&nbsp;concat&nbsp;or&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5280263">//&nbsp;alternate&nbsp;of&nbsp;an&nbsp;alternate.</span><br>
<span class="lineno"></span><span class="keyword" id="5280293">func</span>&nbsp;<span class="op" id="5280298">(</span><span class="ident" id="5280299">p</span>&nbsp;<span class="op" id="5280301">*</span><span class="ident" id="5280302">parser</span><span class="op" id="5280308">)</span>&nbsp;<span class="ident" id="5280310">collapse</span><span class="op" id="5280318">(</span><span class="ident" id="5280319">subs</span>&nbsp;<span class="op" id="5280324">[</span><span class="op" id="5280325">]</span><span class="op" id="5280326">*</span><span class="ident" id="5280327">Regexp</span><span class="op" id="5280333">,</span>&nbsp;<span class="ident" id="5280335">op</span>&nbsp;<span class="ident" id="5280338">Op</span><span class="op" id="5280340">)</span>&nbsp;<span class="op" id="5280342">*</span><span class="ident" id="5280343">Regexp</span>&nbsp;<span class="op" id="5280350">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280353">if</span>&nbsp;<span class="builtinfunc" id="5280356">len</span><span class="op" id="5280359">(</span><span class="ident" id="5280360">subs</span><span class="op" id="5280364">)</span>&nbsp;<span class="op" id="5280366">==</span>&nbsp;<span class="num" id="5280369">1</span>&nbsp;<span class="op" id="5280371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280375">return</span>&nbsp;<span class="ident" id="5280382">subs</span><span class="op" id="5280386">[</span><span class="num" id="5280387">0</span><span class="op" id="5280388">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5280391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280394">re</span>&nbsp;<span class="op" id="5280397">:=</span>&nbsp;<span class="ident" id="5280400">p</span><span class="op" id="5280401">.</span><span class="ident" id="5280402">newRegexp</span><span class="op" id="5280411">(</span><span class="ident" id="5280412">op</span><span class="op" id="5280414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280417">re</span><span class="op" id="5280419">.</span><span class="ident" id="5280420">Sub</span>&nbsp;<span class="op" id="5280424">=</span>&nbsp;<span class="ident" id="5280426">re</span><span class="op" id="5280428">.</span><span class="ident" id="5280429">Sub0</span><span class="op" id="5280433">[</span><span class="op" id="5280434">:</span><span class="num" id="5280435">0</span><span class="op" id="5280436">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280439">for</span>&nbsp;<span class="ident" id="5280443">_</span><span class="op" id="5280444">,</span>&nbsp;<span class="ident" id="5280446">sub</span>&nbsp;<span class="op" id="5280450">:=</span>&nbsp;<span class="keyword" id="5280453">range</span>&nbsp;<span class="ident" id="5280459">subs</span>&nbsp;<span class="op" id="5280464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280468">if</span>&nbsp;<span class="ident" id="5280471">sub</span><span class="op" id="5280474">.</span><span class="ident" id="5280475">Op</span>&nbsp;<span class="op" id="5280478">==</span>&nbsp;<span class="ident" id="5280481">op</span>&nbsp;<span class="op" id="5280484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280489">re</span><span class="op" id="5280491">.</span><span class="ident" id="5280492">Sub</span>&nbsp;<span class="op" id="5280496">=</span>&nbsp;<span class="builtinfunc" id="5280498">append</span><span class="op" id="5280504">(</span><span class="ident" id="5280505">re</span><span class="op" id="5280507">.</span><span class="ident" id="5280508">Sub</span><span class="op" id="5280511">,</span>&nbsp;<span class="ident" id="5280513">sub</span><span class="op" id="5280516">.</span><span class="ident" id="5280517">Sub</span><span class="op" id="5280520">...</span><span class="op" id="5280523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280528">p</span><span class="op" id="5280529">.</span><span class="ident" id="5280530">reuse</span><span class="op" id="5280535">(</span><span class="ident" id="5280536">sub</span><span class="op" id="5280539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5280543">}</span>&nbsp;<span class="keyword" id="5280545">else</span>&nbsp;<span class="op" id="5280550">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280555">re</span><span class="op" id="5280557">.</span><span class="ident" id="5280558">Sub</span>&nbsp;<span class="op" id="5280562">=</span>&nbsp;<span class="builtinfunc" id="5280564">append</span><span class="op" id="5280570">(</span><span class="ident" id="5280571">re</span><span class="op" id="5280573">.</span><span class="ident" id="5280574">Sub</span><span class="op" id="5280577">,</span>&nbsp;<span class="ident" id="5280579">sub</span><span class="op" id="5280582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5280586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5280589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280592">if</span>&nbsp;<span class="ident" id="5280595">op</span>&nbsp;<span class="op" id="5280598">==</span>&nbsp;<span class="ident" id="5280601">OpAlternate</span>&nbsp;<span class="op" id="5280613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280617">re</span><span class="op" id="5280619">.</span><span class="ident" id="5280620">Sub</span>&nbsp;<span class="op" id="5280624">=</span>&nbsp;<span class="ident" id="5280626">p</span><span class="op" id="5280627">.</span><span class="ident" id="5280628">factor</span><span class="op" id="5280634">(</span><span class="ident" id="5280635">re</span><span class="op" id="5280637">.</span><span class="ident" id="5280638">Sub</span><span class="op" id="5280641">,</span>&nbsp;<span class="ident" id="5280643">re</span><span class="op" id="5280645">.</span><span class="ident" id="5280646">Flags</span><span class="op" id="5280651">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280655">if</span>&nbsp;<span class="builtinfunc" id="5280658">len</span><span class="op" id="5280661">(</span><span class="ident" id="5280662">re</span><span class="op" id="5280664">.</span><span class="ident" id="5280665">Sub</span><span class="op" id="5280668">)</span>&nbsp;<span class="op" id="5280670">==</span>&nbsp;<span class="num" id="5280673">1</span>&nbsp;<span class="op" id="5280675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280680">old</span>&nbsp;<span class="op" id="5280684">:=</span>&nbsp;<span class="ident" id="5280687">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280693">re</span>&nbsp;<span class="op" id="5280696">=</span>&nbsp;<span class="ident" id="5280698">re</span><span class="op" id="5280700">.</span><span class="ident" id="5280701">Sub</span><span class="op" id="5280704">[</span><span class="num" id="5280705">0</span><span class="op" id="5280706">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280711">p</span><span class="op" id="5280712">.</span><span class="ident" id="5280713">reuse</span><span class="op" id="5280718">(</span><span class="ident" id="5280719">old</span><span class="op" id="5280722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5280726">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5280729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280732">return</span>&nbsp;<span class="ident" id="5280739">re</span><br>
<span class="lineno"></span><span class="op" id="5280742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5280745">//&nbsp;factor&nbsp;factors&nbsp;common&nbsp;prefixes&nbsp;from&nbsp;the&nbsp;alternation&nbsp;list&nbsp;sub.</span><br>
<span class="lineno">395</span><span class="comment" id="5280810">//&nbsp;It&nbsp;returns&nbsp;a&nbsp;replacement&nbsp;list&nbsp;that&nbsp;reuses&nbsp;the&nbsp;same&nbsp;storage&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5280876">//&nbsp;frees&nbsp;(passes&nbsp;to&nbsp;p.reuse)&nbsp;any&nbsp;removed&nbsp;*Regexps.</span><br>
<span class="lineno"></span><span class="comment" id="5280927">//</span><br>
<span class="lineno"></span><span class="comment" id="5280930">//&nbsp;For&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="5280946">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ABC|ABD|AEF|BCX|BCY</span><br>
<span class="lineno">400</span><span class="comment" id="5280973">//&nbsp;simplifies&nbsp;by&nbsp;literal&nbsp;prefix&nbsp;extraction&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5281019">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A(B(C|D)|EF)|BC(X|Y)</span><br>
<span class="lineno"></span><span class="comment" id="5281047">//&nbsp;which&nbsp;simplifies&nbsp;by&nbsp;character&nbsp;class&nbsp;introduction&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5281102">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A(B[CD]|EF)|BC[XY]</span><br>
<span class="lineno"></span><span class="comment" id="5281128">//</span><br>
<span class="lineno">405</span><span class="keyword" id="5281131">func</span>&nbsp;<span class="op" id="5281136">(</span><span class="ident" id="5281137">p</span>&nbsp;<span class="op" id="5281139">*</span><span class="ident" id="5281140">parser</span><span class="op" id="5281146">)</span>&nbsp;<span class="ident" id="5281148">factor</span><span class="op" id="5281154">(</span><span class="ident" id="5281155">sub</span>&nbsp;<span class="op" id="5281159">[</span><span class="op" id="5281160">]</span><span class="op" id="5281161">*</span><span class="ident" id="5281162">Regexp</span><span class="op" id="5281168">,</span>&nbsp;<span class="ident" id="5281170">flags</span>&nbsp;<span class="ident" id="5281176">Flags</span><span class="op" id="5281181">)</span>&nbsp;<span class="op" id="5281183">[</span><span class="op" id="5281184">]</span><span class="op" id="5281185">*</span><span class="ident" id="5281186">Regexp</span>&nbsp;<span class="op" id="5281193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281196">if</span>&nbsp;<span class="builtinfunc" id="5281199">len</span><span class="op" id="5281202">(</span><span class="ident" id="5281203">sub</span><span class="op" id="5281206">)</span>&nbsp;<span class="op" id="5281208">&lt;</span>&nbsp;<span class="num" id="5281210">2</span>&nbsp;<span class="op" id="5281212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281216">return</span>&nbsp;<span class="ident" id="5281223">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5281228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281232">//&nbsp;Round&nbsp;1:&nbsp;Factor&nbsp;out&nbsp;common&nbsp;literal&nbsp;prefixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281281">var</span>&nbsp;<span class="ident" id="5281285">str</span>&nbsp;<span class="op" id="5281289">[</span><span class="op" id="5281290">]</span><span class="builtintype" id="5281291">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281297">var</span>&nbsp;<span class="ident" id="5281301">strflags</span>&nbsp;<span class="ident" id="5281310">Flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281317">start</span>&nbsp;<span class="op" id="5281323">:=</span>&nbsp;<span class="num" id="5281326">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281329">out</span>&nbsp;<span class="op" id="5281333">:=</span>&nbsp;<span class="ident" id="5281336">sub</span><span class="op" id="5281339">[</span><span class="op" id="5281340">:</span><span class="num" id="5281341">0</span><span class="op" id="5281342">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281345">for</span>&nbsp;<span class="ident" id="5281349">i</span>&nbsp;<span class="op" id="5281351">:=</span>&nbsp;<span class="num" id="5281354">0</span><span class="op" id="5281355">;</span>&nbsp;<span class="ident" id="5281357">i</span>&nbsp;<span class="op" id="5281359">&lt;=</span>&nbsp;<span class="builtinfunc" id="5281362">len</span><span class="op" id="5281365">(</span><span class="ident" id="5281366">sub</span><span class="op" id="5281369">)</span><span class="op" id="5281370">;</span>&nbsp;<span class="ident" id="5281372">i</span><span class="op" id="5281373">++</span>&nbsp;<span class="op" id="5281376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281380">//&nbsp;Invariant:&nbsp;the&nbsp;Regexps&nbsp;that&nbsp;were&nbsp;in&nbsp;sub[0:start]&nbsp;have&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281444">//&nbsp;used&nbsp;or&nbsp;marked&nbsp;for&nbsp;reuse,&nbsp;and&nbsp;the&nbsp;slice&nbsp;space&nbsp;has&nbsp;been&nbsp;reused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281511">//&nbsp;for&nbsp;out&nbsp;(len(out)&nbsp;&lt;=&nbsp;start).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281545">//</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281550">//&nbsp;Invariant:&nbsp;sub[start:i]&nbsp;consists&nbsp;of&nbsp;regexps&nbsp;that&nbsp;all&nbsp;begin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281614">//&nbsp;with&nbsp;str&nbsp;as&nbsp;modified&nbsp;by&nbsp;strflags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281653">var</span>&nbsp;<span class="ident" id="5281657">istr</span>&nbsp;<span class="op" id="5281662">[</span><span class="op" id="5281663">]</span><span class="builtintype" id="5281664">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281671">var</span>&nbsp;<span class="ident" id="5281675">iflags</span>&nbsp;<span class="ident" id="5281682">Flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281690">if</span>&nbsp;<span class="ident" id="5281693">i</span>&nbsp;<span class="op" id="5281695">&lt;</span>&nbsp;<span class="builtinfunc" id="5281697">len</span><span class="op" id="5281700">(</span><span class="ident" id="5281701">sub</span><span class="op" id="5281704">)</span>&nbsp;<span class="op" id="5281706">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281711">istr</span><span class="op" id="5281715">,</span>&nbsp;<span class="ident" id="5281717">iflags</span>&nbsp;<span class="op" id="5281724">=</span>&nbsp;<span class="ident" id="5281726">p</span><span class="op" id="5281727">.</span><span class="ident" id="5281728">leadingString</span><span class="op" id="5281741">(</span><span class="ident" id="5281742">sub</span><span class="op" id="5281745">[</span><span class="ident" id="5281746">i</span><span class="op" id="5281747">]</span><span class="op" id="5281748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281753">if</span>&nbsp;<span class="ident" id="5281756">iflags</span>&nbsp;<span class="op" id="5281763">==</span>&nbsp;<span class="ident" id="5281766">strflags</span>&nbsp;<span class="op" id="5281775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281781">same</span>&nbsp;<span class="op" id="5281786">:=</span>&nbsp;<span class="num" id="5281789">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281795">for</span>&nbsp;<span class="ident" id="5281799">same</span>&nbsp;<span class="op" id="5281804">&lt;</span>&nbsp;<span class="builtinfunc" id="5281806">len</span><span class="op" id="5281809">(</span><span class="ident" id="5281810">str</span><span class="op" id="5281813">)</span>&nbsp;<span class="op" id="5281815">&amp;&amp;</span>&nbsp;<span class="ident" id="5281818">same</span>&nbsp;<span class="op" id="5281823">&lt;</span>&nbsp;<span class="builtinfunc" id="5281825">len</span><span class="op" id="5281828">(</span><span class="ident" id="5281829">istr</span><span class="op" id="5281833">)</span>&nbsp;<span class="op" id="5281835">&amp;&amp;</span>&nbsp;<span class="ident" id="5281838">str</span><span class="op" id="5281841">[</span><span class="ident" id="5281842">same</span><span class="op" id="5281846">]</span>&nbsp;<span class="op" id="5281848">==</span>&nbsp;<span class="ident" id="5281851">istr</span><span class="op" id="5281855">[</span><span class="ident" id="5281856">same</span><span class="op" id="5281860">]</span>&nbsp;<span class="op" id="5281862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281869">same</span><span class="op" id="5281873">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5281880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281886">if</span>&nbsp;<span class="ident" id="5281889">same</span>&nbsp;<span class="op" id="5281894">&gt;</span>&nbsp;<span class="num" id="5281896">0</span>&nbsp;<span class="op" id="5281898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281905">//&nbsp;Matches&nbsp;at&nbsp;least&nbsp;one&nbsp;rune&nbsp;in&nbsp;current&nbsp;range.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281957">//&nbsp;Keep&nbsp;going&nbsp;around.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281984">str</span>&nbsp;<span class="op" id="5281988">=</span>&nbsp;<span class="ident" id="5281990">str</span><span class="op" id="5281993">[</span><span class="op" id="5281994">:</span><span class="ident" id="5281995">same</span><span class="op" id="5281999">]</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282006">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282033">//&nbsp;Found&nbsp;end&nbsp;of&nbsp;a&nbsp;run&nbsp;with&nbsp;common&nbsp;leading&nbsp;literal&nbsp;string:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282093">//&nbsp;sub[start:i]&nbsp;all&nbsp;begin&nbsp;with&nbsp;str[0:len(str)],&nbsp;but&nbsp;sub[i]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282154">//&nbsp;does&nbsp;not&nbsp;even&nbsp;begin&nbsp;with&nbsp;str[0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282192">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282197">//&nbsp;Factor&nbsp;out&nbsp;common&nbsp;string&nbsp;and&nbsp;append&nbsp;factored&nbsp;expression&nbsp;to&nbsp;out.</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282266">if</span>&nbsp;<span class="ident" id="5282269">i</span>&nbsp;<span class="op" id="5282271">==</span>&nbsp;<span class="ident" id="5282274">start</span>&nbsp;<span class="op" id="5282280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282285">//&nbsp;Nothing&nbsp;to&nbsp;do&nbsp;-&nbsp;run&nbsp;of&nbsp;length&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282323">}</span>&nbsp;<span class="keyword" id="5282325">else</span>&nbsp;<span class="keyword" id="5282330">if</span>&nbsp;<span class="ident" id="5282333">i</span>&nbsp;<span class="op" id="5282335">==</span>&nbsp;<span class="ident" id="5282338">start</span><span class="op" id="5282343">+</span><span class="num" id="5282344">1</span>&nbsp;<span class="op" id="5282346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282351">//&nbsp;Just&nbsp;one:&nbsp;don&#39;t&nbsp;bother&nbsp;factoring.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282391">out</span>&nbsp;<span class="op" id="5282395">=</span>&nbsp;<span class="builtinfunc" id="5282397">append</span><span class="op" id="5282403">(</span><span class="ident" id="5282404">out</span><span class="op" id="5282407">,</span>&nbsp;<span class="ident" id="5282409">sub</span><span class="op" id="5282412">[</span><span class="ident" id="5282413">start</span><span class="op" id="5282418">]</span><span class="op" id="5282419">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282423">}</span>&nbsp;<span class="keyword" id="5282425">else</span>&nbsp;<span class="op" id="5282430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282435">//&nbsp;Construct&nbsp;factored&nbsp;form:&nbsp;prefix(suffix1|suffix2|...)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282494">prefix</span>&nbsp;<span class="op" id="5282501">:=</span>&nbsp;<span class="ident" id="5282504">p</span><span class="op" id="5282505">.</span><span class="ident" id="5282506">newRegexp</span><span class="op" id="5282515">(</span><span class="ident" id="5282516">OpLiteral</span><span class="op" id="5282525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282530">prefix</span><span class="op" id="5282536">.</span><span class="ident" id="5282537">Flags</span>&nbsp;<span class="op" id="5282543">=</span>&nbsp;<span class="ident" id="5282545">strflags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282557">prefix</span><span class="op" id="5282563">.</span><span class="ident" id="5282564">Rune</span>&nbsp;<span class="op" id="5282569">=</span>&nbsp;<span class="builtinfunc" id="5282571">append</span><span class="op" id="5282577">(</span><span class="ident" id="5282578">prefix</span><span class="op" id="5282584">.</span><span class="ident" id="5282585">Rune</span><span class="op" id="5282589">[</span><span class="op" id="5282590">:</span><span class="num" id="5282591">0</span><span class="op" id="5282592">]</span><span class="op" id="5282593">,</span>&nbsp;<span class="ident" id="5282595">str</span><span class="op" id="5282598">...</span><span class="op" id="5282601">)</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282607">for</span>&nbsp;<span class="ident" id="5282611">j</span>&nbsp;<span class="op" id="5282613">:=</span>&nbsp;<span class="ident" id="5282616">start</span><span class="op" id="5282621">;</span>&nbsp;<span class="ident" id="5282623">j</span>&nbsp;<span class="op" id="5282625">&lt;</span>&nbsp;<span class="ident" id="5282627">i</span><span class="op" id="5282628">;</span>&nbsp;<span class="ident" id="5282630">j</span><span class="op" id="5282631">++</span>&nbsp;<span class="op" id="5282634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282640">sub</span><span class="op" id="5282643">[</span><span class="ident" id="5282644">j</span><span class="op" id="5282645">]</span>&nbsp;<span class="op" id="5282647">=</span>&nbsp;<span class="ident" id="5282649">p</span><span class="op" id="5282650">.</span><span class="ident" id="5282651">removeLeadingString</span><span class="op" id="5282670">(</span><span class="ident" id="5282671">sub</span><span class="op" id="5282674">[</span><span class="ident" id="5282675">j</span><span class="op" id="5282676">]</span><span class="op" id="5282677">,</span>&nbsp;<span class="builtinfunc" id="5282679">len</span><span class="op" id="5282682">(</span><span class="ident" id="5282683">str</span><span class="op" id="5282686">)</span><span class="op" id="5282687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282697">suffix</span>&nbsp;<span class="op" id="5282704">:=</span>&nbsp;<span class="ident" id="5282707">p</span><span class="op" id="5282708">.</span><span class="ident" id="5282709">collapse</span><span class="op" id="5282717">(</span><span class="ident" id="5282718">sub</span><span class="op" id="5282721">[</span><span class="ident" id="5282722">start</span><span class="op" id="5282727">:</span><span class="ident" id="5282728">i</span><span class="op" id="5282729">]</span><span class="op" id="5282730">,</span>&nbsp;<span class="ident" id="5282732">OpAlternate</span><span class="op" id="5282743">)</span>&nbsp;<span class="comment" id="5282745">//&nbsp;recurse</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282760">re</span>&nbsp;<span class="op" id="5282763">:=</span>&nbsp;<span class="ident" id="5282766">p</span><span class="op" id="5282767">.</span><span class="ident" id="5282768">newRegexp</span><span class="op" id="5282777">(</span><span class="ident" id="5282778">OpConcat</span><span class="op" id="5282786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282791">re</span><span class="op" id="5282793">.</span><span class="ident" id="5282794">Sub</span>&nbsp;<span class="op" id="5282798">=</span>&nbsp;<span class="builtinfunc" id="5282800">append</span><span class="op" id="5282806">(</span><span class="ident" id="5282807">re</span><span class="op" id="5282809">.</span><span class="ident" id="5282810">Sub</span><span class="op" id="5282813">[</span><span class="op" id="5282814">:</span><span class="num" id="5282815">0</span><span class="op" id="5282816">]</span><span class="op" id="5282817">,</span>&nbsp;<span class="ident" id="5282819">prefix</span><span class="op" id="5282825">,</span>&nbsp;<span class="ident" id="5282827">suffix</span><span class="op" id="5282833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282838">out</span>&nbsp;<span class="op" id="5282842">=</span>&nbsp;<span class="builtinfunc" id="5282844">append</span><span class="op" id="5282850">(</span><span class="ident" id="5282851">out</span><span class="op" id="5282854">,</span>&nbsp;<span class="ident" id="5282856">re</span><span class="op" id="5282858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282862">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282867">//&nbsp;Prepare&nbsp;for&nbsp;next&nbsp;iteration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282900">start</span>&nbsp;<span class="op" id="5282906">=</span>&nbsp;<span class="ident" id="5282908">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282912">str</span>&nbsp;<span class="op" id="5282916">=</span>&nbsp;<span class="ident" id="5282918">istr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282925">strflags</span>&nbsp;<span class="op" id="5282934">=</span>&nbsp;<span class="ident" id="5282936">iflags</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282947">sub</span>&nbsp;<span class="op" id="5282951">=</span>&nbsp;<span class="ident" id="5282953">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282959">//&nbsp;Round&nbsp;2:&nbsp;Factor&nbsp;out&nbsp;common&nbsp;complex&nbsp;prefixes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283008">//&nbsp;just&nbsp;the&nbsp;first&nbsp;piece&nbsp;of&nbsp;each&nbsp;concatenation,</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283056">//&nbsp;whatever&nbsp;it&nbsp;is.&nbsp;&nbsp;This&nbsp;is&nbsp;good&nbsp;enough&nbsp;a&nbsp;lot&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283116">start</span>&nbsp;<span class="op" id="5283122">=</span>&nbsp;<span class="num" id="5283124">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283127">out</span>&nbsp;<span class="op" id="5283131">=</span>&nbsp;<span class="ident" id="5283133">sub</span><span class="op" id="5283136">[</span><span class="op" id="5283137">:</span><span class="num" id="5283138">0</span><span class="op" id="5283139">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283142">var</span>&nbsp;<span class="ident" id="5283146">first</span>&nbsp;<span class="op" id="5283152">*</span><span class="ident" id="5283153">Regexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283161">for</span>&nbsp;<span class="ident" id="5283165">i</span>&nbsp;<span class="op" id="5283167">:=</span>&nbsp;<span class="num" id="5283170">0</span><span class="op" id="5283171">;</span>&nbsp;<span class="ident" id="5283173">i</span>&nbsp;<span class="op" id="5283175">&lt;=</span>&nbsp;<span class="builtinfunc" id="5283178">len</span><span class="op" id="5283181">(</span><span class="ident" id="5283182">sub</span><span class="op" id="5283185">)</span><span class="op" id="5283186">;</span>&nbsp;<span class="ident" id="5283188">i</span><span class="op" id="5283189">++</span>&nbsp;<span class="op" id="5283192">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283196">//&nbsp;Invariant:&nbsp;the&nbsp;Regexps&nbsp;that&nbsp;were&nbsp;in&nbsp;sub[0:start]&nbsp;have&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283260">//&nbsp;used&nbsp;or&nbsp;marked&nbsp;for&nbsp;reuse,&nbsp;and&nbsp;the&nbsp;slice&nbsp;space&nbsp;has&nbsp;been&nbsp;reused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283327">//&nbsp;for&nbsp;out&nbsp;(len(out)&nbsp;&lt;=&nbsp;start).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283361">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283366">//&nbsp;Invariant:&nbsp;sub[start:i]&nbsp;consists&nbsp;of&nbsp;regexps&nbsp;that&nbsp;all&nbsp;begin&nbsp;with&nbsp;ifirst.</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283443">var</span>&nbsp;<span class="ident" id="5283447">ifirst</span>&nbsp;<span class="op" id="5283454">*</span><span class="ident" id="5283455">Regexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283464">if</span>&nbsp;<span class="ident" id="5283467">i</span>&nbsp;<span class="op" id="5283469">&lt;</span>&nbsp;<span class="builtinfunc" id="5283471">len</span><span class="op" id="5283474">(</span><span class="ident" id="5283475">sub</span><span class="op" id="5283478">)</span>&nbsp;<span class="op" id="5283480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283485">ifirst</span>&nbsp;<span class="op" id="5283492">=</span>&nbsp;<span class="ident" id="5283494">p</span><span class="op" id="5283495">.</span><span class="ident" id="5283496">leadingRegexp</span><span class="op" id="5283509">(</span><span class="ident" id="5283510">sub</span><span class="op" id="5283513">[</span><span class="ident" id="5283514">i</span><span class="op" id="5283515">]</span><span class="op" id="5283516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283521">if</span>&nbsp;<span class="ident" id="5283524">first</span>&nbsp;<span class="op" id="5283530">!=</span>&nbsp;<span class="ident" id="5283533">nil</span>&nbsp;<span class="op" id="5283537">&amp;&amp;</span>&nbsp;<span class="ident" id="5283540">first</span><span class="op" id="5283545">.</span><span class="ident" id="5283546">Equal</span><span class="op" id="5283551">(</span><span class="ident" id="5283552">ifirst</span><span class="op" id="5283558">)</span>&nbsp;<span class="op" id="5283560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283566">continue</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283587">//&nbsp;Found&nbsp;end&nbsp;of&nbsp;a&nbsp;run&nbsp;with&nbsp;common&nbsp;leading&nbsp;regexp:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283639">//&nbsp;sub[start:i]&nbsp;all&nbsp;begin&nbsp;with&nbsp;first&nbsp;but&nbsp;sub[i]&nbsp;does&nbsp;not.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283699">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283704">//&nbsp;Factor&nbsp;out&nbsp;common&nbsp;regexp&nbsp;and&nbsp;append&nbsp;factored&nbsp;expression&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283773">if</span>&nbsp;<span class="ident" id="5283776">i</span>&nbsp;<span class="op" id="5283778">==</span>&nbsp;<span class="ident" id="5283781">start</span>&nbsp;<span class="op" id="5283787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283792">//&nbsp;Nothing&nbsp;to&nbsp;do&nbsp;-&nbsp;run&nbsp;of&nbsp;length&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283830">}</span>&nbsp;<span class="keyword" id="5283832">else</span>&nbsp;<span class="keyword" id="5283837">if</span>&nbsp;<span class="ident" id="5283840">i</span>&nbsp;<span class="op" id="5283842">==</span>&nbsp;<span class="ident" id="5283845">start</span><span class="op" id="5283850">+</span><span class="num" id="5283851">1</span>&nbsp;<span class="op" id="5283853">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283858">//&nbsp;Just&nbsp;one:&nbsp;don&#39;t&nbsp;bother&nbsp;factoring.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283898">out</span>&nbsp;<span class="op" id="5283902">=</span>&nbsp;<span class="builtinfunc" id="5283904">append</span><span class="op" id="5283910">(</span><span class="ident" id="5283911">out</span><span class="op" id="5283914">,</span>&nbsp;<span class="ident" id="5283916">sub</span><span class="op" id="5283919">[</span><span class="ident" id="5283920">start</span><span class="op" id="5283925">]</span><span class="op" id="5283926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283930">}</span>&nbsp;<span class="keyword" id="5283932">else</span>&nbsp;<span class="op" id="5283937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283942">//&nbsp;Construct&nbsp;factored&nbsp;form:&nbsp;prefix(suffix1|suffix2|...)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284001">prefix</span>&nbsp;<span class="op" id="5284008">:=</span>&nbsp;<span class="ident" id="5284011">first</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284020">for</span>&nbsp;<span class="ident" id="5284024">j</span>&nbsp;<span class="op" id="5284026">:=</span>&nbsp;<span class="ident" id="5284029">start</span><span class="op" id="5284034">;</span>&nbsp;<span class="ident" id="5284036">j</span>&nbsp;<span class="op" id="5284038">&lt;</span>&nbsp;<span class="ident" id="5284040">i</span><span class="op" id="5284041">;</span>&nbsp;<span class="ident" id="5284043">j</span><span class="op" id="5284044">++</span>&nbsp;<span class="op" id="5284047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284053">reuse</span>&nbsp;<span class="op" id="5284059">:=</span>&nbsp;<span class="ident" id="5284062">j</span>&nbsp;<span class="op" id="5284064">!=</span>&nbsp;<span class="ident" id="5284067">start</span>&nbsp;<span class="comment" id="5284073">//&nbsp;prefix&nbsp;came&nbsp;from&nbsp;sub[start]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284108">sub</span><span class="op" id="5284111">[</span><span class="ident" id="5284112">j</span><span class="op" id="5284113">]</span>&nbsp;<span class="op" id="5284115">=</span>&nbsp;<span class="ident" id="5284117">p</span><span class="op" id="5284118">.</span><span class="ident" id="5284119">removeLeadingRegexp</span><span class="op" id="5284138">(</span><span class="ident" id="5284139">sub</span><span class="op" id="5284142">[</span><span class="ident" id="5284143">j</span><span class="op" id="5284144">]</span><span class="op" id="5284145">,</span>&nbsp;<span class="ident" id="5284147">reuse</span><span class="op" id="5284152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284162">suffix</span>&nbsp;<span class="op" id="5284169">:=</span>&nbsp;<span class="ident" id="5284172">p</span><span class="op" id="5284173">.</span><span class="ident" id="5284174">collapse</span><span class="op" id="5284182">(</span><span class="ident" id="5284183">sub</span><span class="op" id="5284186">[</span><span class="ident" id="5284187">start</span><span class="op" id="5284192">:</span><span class="ident" id="5284193">i</span><span class="op" id="5284194">]</span><span class="op" id="5284195">,</span>&nbsp;<span class="ident" id="5284197">OpAlternate</span><span class="op" id="5284208">)</span>&nbsp;<span class="comment" id="5284210">//&nbsp;recurse</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284225">re</span>&nbsp;<span class="op" id="5284228">:=</span>&nbsp;<span class="ident" id="5284231">p</span><span class="op" id="5284232">.</span><span class="ident" id="5284233">newRegexp</span><span class="op" id="5284242">(</span><span class="ident" id="5284243">OpConcat</span><span class="op" id="5284251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284256">re</span><span class="op" id="5284258">.</span><span class="ident" id="5284259">Sub</span>&nbsp;<span class="op" id="5284263">=</span>&nbsp;<span class="builtinfunc" id="5284265">append</span><span class="op" id="5284271">(</span><span class="ident" id="5284272">re</span><span class="op" id="5284274">.</span><span class="ident" id="5284275">Sub</span><span class="op" id="5284278">[</span><span class="op" id="5284279">:</span><span class="num" id="5284280">0</span><span class="op" id="5284281">]</span><span class="op" id="5284282">,</span>&nbsp;<span class="ident" id="5284284">prefix</span><span class="op" id="5284290">,</span>&nbsp;<span class="ident" id="5284292">suffix</span><span class="op" id="5284298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284303">out</span>&nbsp;<span class="op" id="5284307">=</span>&nbsp;<span class="builtinfunc" id="5284309">append</span><span class="op" id="5284315">(</span><span class="ident" id="5284316">out</span><span class="op" id="5284319">,</span>&nbsp;<span class="ident" id="5284321">re</span><span class="op" id="5284323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284327">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284332">//&nbsp;Prepare&nbsp;for&nbsp;next&nbsp;iteration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284365">start</span>&nbsp;<span class="op" id="5284371">=</span>&nbsp;<span class="ident" id="5284373">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284377">first</span>&nbsp;<span class="op" id="5284383">=</span>&nbsp;<span class="ident" id="5284385">ifirst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284393">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284396">sub</span>&nbsp;<span class="op" id="5284400">=</span>&nbsp;<span class="ident" id="5284402">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284408">//&nbsp;Round&nbsp;3:&nbsp;Collapse&nbsp;runs&nbsp;of&nbsp;single&nbsp;literals&nbsp;into&nbsp;character&nbsp;classes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284478">start</span>&nbsp;<span class="op" id="5284484">=</span>&nbsp;<span class="num" id="5284486">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284489">out</span>&nbsp;<span class="op" id="5284493">=</span>&nbsp;<span class="ident" id="5284495">sub</span><span class="op" id="5284498">[</span><span class="op" id="5284499">:</span><span class="num" id="5284500">0</span><span class="op" id="5284501">]</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284504">for</span>&nbsp;<span class="ident" id="5284508">i</span>&nbsp;<span class="op" id="5284510">:=</span>&nbsp;<span class="num" id="5284513">0</span><span class="op" id="5284514">;</span>&nbsp;<span class="ident" id="5284516">i</span>&nbsp;<span class="op" id="5284518">&lt;=</span>&nbsp;<span class="builtinfunc" id="5284521">len</span><span class="op" id="5284524">(</span><span class="ident" id="5284525">sub</span><span class="op" id="5284528">)</span><span class="op" id="5284529">;</span>&nbsp;<span class="ident" id="5284531">i</span><span class="op" id="5284532">++</span>&nbsp;<span class="op" id="5284535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284539">//&nbsp;Invariant:&nbsp;the&nbsp;Regexps&nbsp;that&nbsp;were&nbsp;in&nbsp;sub[0:start]&nbsp;have&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284603">//&nbsp;used&nbsp;or&nbsp;marked&nbsp;for&nbsp;reuse,&nbsp;and&nbsp;the&nbsp;slice&nbsp;space&nbsp;has&nbsp;been&nbsp;reused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284670">//&nbsp;for&nbsp;out&nbsp;(len(out)&nbsp;&lt;=&nbsp;start).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284704">//</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284709">//&nbsp;Invariant:&nbsp;sub[start:i]&nbsp;consists&nbsp;of&nbsp;regexps&nbsp;that&nbsp;are&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284774">//&nbsp;literal&nbsp;runes&nbsp;or&nbsp;character&nbsp;classes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284815">if</span>&nbsp;<span class="ident" id="5284818">i</span>&nbsp;<span class="op" id="5284820">&lt;</span>&nbsp;<span class="builtinfunc" id="5284822">len</span><span class="op" id="5284825">(</span><span class="ident" id="5284826">sub</span><span class="op" id="5284829">)</span>&nbsp;<span class="op" id="5284831">&amp;&amp;</span>&nbsp;<span class="ident" id="5284834">isCharClass</span><span class="op" id="5284845">(</span><span class="ident" id="5284846">sub</span><span class="op" id="5284849">[</span><span class="ident" id="5284850">i</span><span class="op" id="5284851">]</span><span class="op" id="5284852">)</span>&nbsp;<span class="op" id="5284854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284859">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284870">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284875">//&nbsp;sub[i]&nbsp;is&nbsp;not&nbsp;a&nbsp;char&nbsp;or&nbsp;char&nbsp;class;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284916">//&nbsp;emit&nbsp;char&nbsp;class&nbsp;for&nbsp;sub[start:i]...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284957">if</span>&nbsp;<span class="ident" id="5284960">i</span>&nbsp;<span class="op" id="5284962">==</span>&nbsp;<span class="ident" id="5284965">start</span>&nbsp;<span class="op" id="5284971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284976">//&nbsp;Nothing&nbsp;to&nbsp;do&nbsp;-&nbsp;run&nbsp;of&nbsp;length&nbsp;0.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285014">}</span>&nbsp;<span class="keyword" id="5285016">else</span>&nbsp;<span class="keyword" id="5285021">if</span>&nbsp;<span class="ident" id="5285024">i</span>&nbsp;<span class="op" id="5285026">==</span>&nbsp;<span class="ident" id="5285029">start</span><span class="op" id="5285034">+</span><span class="num" id="5285035">1</span>&nbsp;<span class="op" id="5285037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285042">out</span>&nbsp;<span class="op" id="5285046">=</span>&nbsp;<span class="builtinfunc" id="5285048">append</span><span class="op" id="5285054">(</span><span class="ident" id="5285055">out</span><span class="op" id="5285058">,</span>&nbsp;<span class="ident" id="5285060">sub</span><span class="op" id="5285063">[</span><span class="ident" id="5285064">start</span><span class="op" id="5285069">]</span><span class="op" id="5285070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285074">}</span>&nbsp;<span class="keyword" id="5285076">else</span>&nbsp;<span class="op" id="5285081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5285086">//&nbsp;Make&nbsp;new&nbsp;char&nbsp;class.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5285113">//&nbsp;Start&nbsp;with&nbsp;most&nbsp;complex&nbsp;regexp&nbsp;in&nbsp;sub[start].</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285165">max</span>&nbsp;<span class="op" id="5285169">:=</span>&nbsp;<span class="ident" id="5285172">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285181">for</span>&nbsp;<span class="ident" id="5285185">j</span>&nbsp;<span class="op" id="5285187">:=</span>&nbsp;<span class="ident" id="5285190">start</span>&nbsp;<span class="op" id="5285196">+</span>&nbsp;<span class="num" id="5285198">1</span><span class="op" id="5285199">;</span>&nbsp;<span class="ident" id="5285201">j</span>&nbsp;<span class="op" id="5285203">&lt;</span>&nbsp;<span class="ident" id="5285205">i</span><span class="op" id="5285206">;</span>&nbsp;<span class="ident" id="5285208">j</span><span class="op" id="5285209">++</span>&nbsp;<span class="op" id="5285212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285218">if</span>&nbsp;<span class="ident" id="5285221">sub</span><span class="op" id="5285224">[</span><span class="ident" id="5285225">max</span><span class="op" id="5285228">]</span><span class="op" id="5285229">.</span><span class="ident" id="5285230">Op</span>&nbsp;<span class="op" id="5285233">&lt;</span>&nbsp;<span class="ident" id="5285235">sub</span><span class="op" id="5285238">[</span><span class="ident" id="5285239">j</span><span class="op" id="5285240">]</span><span class="op" id="5285241">.</span><span class="ident" id="5285242">Op</span>&nbsp;<span class="op" id="5285245">||</span>&nbsp;<span class="ident" id="5285248">sub</span><span class="op" id="5285251">[</span><span class="ident" id="5285252">max</span><span class="op" id="5285255">]</span><span class="op" id="5285256">.</span><span class="ident" id="5285257">Op</span>&nbsp;<span class="op" id="5285260">==</span>&nbsp;<span class="ident" id="5285263">sub</span><span class="op" id="5285266">[</span><span class="ident" id="5285267">j</span><span class="op" id="5285268">]</span><span class="op" id="5285269">.</span><span class="ident" id="5285270">Op</span>&nbsp;<span class="op" id="5285273">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5285276">len</span><span class="op" id="5285279">(</span><span class="ident" id="5285280">sub</span><span class="op" id="5285283">[</span><span class="ident" id="5285284">max</span><span class="op" id="5285287">]</span><span class="op" id="5285288">.</span><span class="ident" id="5285289">Rune</span><span class="op" id="5285293">)</span>&nbsp;<span class="op" id="5285295">&lt;</span>&nbsp;<span class="builtinfunc" id="5285297">len</span><span class="op" id="5285300">(</span><span class="ident" id="5285301">sub</span><span class="op" id="5285304">[</span><span class="ident" id="5285305">j</span><span class="op" id="5285306">]</span><span class="op" id="5285307">.</span><span class="ident" id="5285308">Rune</span><span class="op" id="5285312">)</span>&nbsp;<span class="op" id="5285314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285321">max</span>&nbsp;<span class="op" id="5285325">=</span>&nbsp;<span class="ident" id="5285327">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285333">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285343">sub</span><span class="op" id="5285346">[</span><span class="ident" id="5285347">start</span><span class="op" id="5285352">]</span><span class="op" id="5285353">,</span>&nbsp;<span class="ident" id="5285355">sub</span><span class="op" id="5285358">[</span><span class="ident" id="5285359">max</span><span class="op" id="5285362">]</span>&nbsp;<span class="op" id="5285364">=</span>&nbsp;<span class="ident" id="5285366">sub</span><span class="op" id="5285369">[</span><span class="ident" id="5285370">max</span><span class="op" id="5285373">]</span><span class="op" id="5285374">,</span>&nbsp;<span class="ident" id="5285376">sub</span><span class="op" id="5285379">[</span><span class="ident" id="5285380">start</span><span class="op" id="5285385">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285391">for</span>&nbsp;<span class="ident" id="5285395">j</span>&nbsp;<span class="op" id="5285397">:=</span>&nbsp;<span class="ident" id="5285400">start</span>&nbsp;<span class="op" id="5285406">+</span>&nbsp;<span class="num" id="5285408">1</span><span class="op" id="5285409">;</span>&nbsp;<span class="ident" id="5285411">j</span>&nbsp;<span class="op" id="5285413">&lt;</span>&nbsp;<span class="ident" id="5285415">i</span><span class="op" id="5285416">;</span>&nbsp;<span class="ident" id="5285418">j</span><span class="op" id="5285419">++</span>&nbsp;<span class="op" id="5285422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285428">mergeCharClass</span><span class="op" id="5285442">(</span><span class="ident" id="5285443">sub</span><span class="op" id="5285446">[</span><span class="ident" id="5285447">start</span><span class="op" id="5285452">]</span><span class="op" id="5285453">,</span>&nbsp;<span class="ident" id="5285455">sub</span><span class="op" id="5285458">[</span><span class="ident" id="5285459">j</span><span class="op" id="5285460">]</span><span class="op" id="5285461">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285467">p</span><span class="op" id="5285468">.</span><span class="ident" id="5285469">reuse</span><span class="op" id="5285474">(</span><span class="ident" id="5285475">sub</span><span class="op" id="5285478">[</span><span class="ident" id="5285479">j</span><span class="op" id="5285480">]</span><span class="op" id="5285481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285491">cleanAlt</span><span class="op" id="5285499">(</span><span class="ident" id="5285500">sub</span><span class="op" id="5285503">[</span><span class="ident" id="5285504">start</span><span class="op" id="5285509">]</span><span class="op" id="5285510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285515">out</span>&nbsp;<span class="op" id="5285519">=</span>&nbsp;<span class="builtinfunc" id="5285521">append</span><span class="op" id="5285527">(</span><span class="ident" id="5285528">out</span><span class="op" id="5285531">,</span>&nbsp;<span class="ident" id="5285533">sub</span><span class="op" id="5285536">[</span><span class="ident" id="5285537">start</span><span class="op" id="5285542">]</span><span class="op" id="5285543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285547">}</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5285552">//&nbsp;...&nbsp;and&nbsp;then&nbsp;emit&nbsp;sub[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285583">if</span>&nbsp;<span class="ident" id="5285586">i</span>&nbsp;<span class="op" id="5285588">&lt;</span>&nbsp;<span class="builtinfunc" id="5285590">len</span><span class="op" id="5285593">(</span><span class="ident" id="5285594">sub</span><span class="op" id="5285597">)</span>&nbsp;<span class="op" id="5285599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285604">out</span>&nbsp;<span class="op" id="5285608">=</span>&nbsp;<span class="builtinfunc" id="5285610">append</span><span class="op" id="5285616">(</span><span class="ident" id="5285617">out</span><span class="op" id="5285620">,</span>&nbsp;<span class="ident" id="5285622">sub</span><span class="op" id="5285625">[</span><span class="ident" id="5285626">i</span><span class="op" id="5285627">]</span><span class="op" id="5285628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285632">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285636">start</span>&nbsp;<span class="op" id="5285642">=</span>&nbsp;<span class="ident" id="5285644">i</span>&nbsp;<span class="op" id="5285646">+</span>&nbsp;<span class="num" id="5285648">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285654">sub</span>&nbsp;<span class="op" id="5285658">=</span>&nbsp;<span class="ident" id="5285660">out</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5285666">//&nbsp;Round&nbsp;4:&nbsp;Collapse&nbsp;runs&nbsp;of&nbsp;empty&nbsp;matches&nbsp;into&nbsp;a&nbsp;single&nbsp;empty&nbsp;match.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285737">start</span>&nbsp;<span class="op" id="5285743">=</span>&nbsp;<span class="num" id="5285745">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285748">out</span>&nbsp;<span class="op" id="5285752">=</span>&nbsp;<span class="ident" id="5285754">sub</span><span class="op" id="5285757">[</span><span class="op" id="5285758">:</span><span class="num" id="5285759">0</span><span class="op" id="5285760">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285763">for</span>&nbsp;<span class="ident" id="5285767">i</span>&nbsp;<span class="op" id="5285769">:=</span>&nbsp;<span class="keyword" id="5285772">range</span>&nbsp;<span class="ident" id="5285778">sub</span>&nbsp;<span class="op" id="5285782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285786">if</span>&nbsp;<span class="ident" id="5285789">i</span><span class="op" id="5285790">+</span><span class="num" id="5285791">1</span>&nbsp;<span class="op" id="5285793">&lt;</span>&nbsp;<span class="builtinfunc" id="5285795">len</span><span class="op" id="5285798">(</span><span class="ident" id="5285799">sub</span><span class="op" id="5285802">)</span>&nbsp;<span class="op" id="5285804">&amp;&amp;</span>&nbsp;<span class="ident" id="5285807">sub</span><span class="op" id="5285810">[</span><span class="ident" id="5285811">i</span><span class="op" id="5285812">]</span><span class="op" id="5285813">.</span><span class="ident" id="5285814">Op</span>&nbsp;<span class="op" id="5285817">==</span>&nbsp;<span class="ident" id="5285820">OpEmptyMatch</span>&nbsp;<span class="op" id="5285833">&amp;&amp;</span>&nbsp;<span class="ident" id="5285836">sub</span><span class="op" id="5285839">[</span><span class="ident" id="5285840">i</span><span class="op" id="5285841">+</span><span class="num" id="5285842">1</span><span class="op" id="5285843">]</span><span class="op" id="5285844">.</span><span class="ident" id="5285845">Op</span>&nbsp;<span class="op" id="5285848">==</span>&nbsp;<span class="ident" id="5285851">OpEmptyMatch</span>&nbsp;<span class="op" id="5285864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285869">continue</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285884">out</span>&nbsp;<span class="op" id="5285888">=</span>&nbsp;<span class="builtinfunc" id="5285890">append</span><span class="op" id="5285896">(</span><span class="ident" id="5285897">out</span><span class="op" id="5285900">,</span>&nbsp;<span class="ident" id="5285902">sub</span><span class="op" id="5285905">[</span><span class="ident" id="5285906">i</span><span class="op" id="5285907">]</span><span class="op" id="5285908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285914">sub</span>&nbsp;<span class="op" id="5285918">=</span>&nbsp;<span class="ident" id="5285920">out</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285926">return</span>&nbsp;<span class="ident" id="5285933">sub</span><br>
<span class="lineno"></span><span class="op" id="5285937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5285940">//&nbsp;leadingString&nbsp;returns&nbsp;the&nbsp;leading&nbsp;literal&nbsp;string&nbsp;that&nbsp;re&nbsp;begins&nbsp;with.</span><br>
<span class="lineno"></span><span class="comment" id="5286013">//&nbsp;The&nbsp;string&nbsp;refers&nbsp;to&nbsp;storage&nbsp;in&nbsp;re&nbsp;or&nbsp;its&nbsp;children.</span><br>
<span class="lineno">585</span><span class="keyword" id="5286068">func</span>&nbsp;<span class="op" id="5286073">(</span><span class="ident" id="5286074">p</span>&nbsp;<span class="op" id="5286076">*</span><span class="ident" id="5286077">parser</span><span class="op" id="5286083">)</span>&nbsp;<span class="ident" id="5286085">leadingString</span><span class="op" id="5286098">(</span><span class="ident" id="5286099">re</span>&nbsp;<span class="op" id="5286102">*</span><span class="ident" id="5286103">Regexp</span><span class="op" id="5286109">)</span>&nbsp;<span class="op" id="5286111">(</span><span class="op" id="5286112">[</span><span class="op" id="5286113">]</span><span class="builtintype" id="5286114">rune</span><span class="op" id="5286118">,</span>&nbsp;<span class="ident" id="5286120">Flags</span><span class="op" id="5286125">)</span>&nbsp;<span class="op" id="5286127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286130">if</span>&nbsp;<span class="ident" id="5286133">re</span><span class="op" id="5286135">.</span><span class="ident" id="5286136">Op</span>&nbsp;<span class="op" id="5286139">==</span>&nbsp;<span class="ident" id="5286142">OpConcat</span>&nbsp;<span class="op" id="5286151">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5286154">len</span><span class="op" id="5286157">(</span><span class="ident" id="5286158">re</span><span class="op" id="5286160">.</span><span class="ident" id="5286161">Sub</span><span class="op" id="5286164">)</span>&nbsp;<span class="op" id="5286166">&gt;</span>&nbsp;<span class="num" id="5286168">0</span>&nbsp;<span class="op" id="5286170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5286174">re</span>&nbsp;<span class="op" id="5286177">=</span>&nbsp;<span class="ident" id="5286179">re</span><span class="op" id="5286181">.</span><span class="ident" id="5286182">Sub</span><span class="op" id="5286185">[</span><span class="num" id="5286186">0</span><span class="op" id="5286187">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5286190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286193">if</span>&nbsp;<span class="ident" id="5286196">re</span><span class="op" id="5286198">.</span><span class="ident" id="5286199">Op</span>&nbsp;<span class="op" id="5286202">!=</span>&nbsp;<span class="ident" id="5286205">OpLiteral</span>&nbsp;<span class="op" id="5286215">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286219">return</span>&nbsp;<span class="ident" id="5286226">nil</span><span class="op" id="5286229">,</span>&nbsp;<span class="num" id="5286231">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5286234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286237">return</span>&nbsp;<span class="ident" id="5286244">re</span><span class="op" id="5286246">.</span><span class="ident" id="5286247">Rune</span><span class="op" id="5286251">,</span>&nbsp;<span class="ident" id="5286253">re</span><span class="op" id="5286255">.</span><span class="ident" id="5286256">Flags</span>&nbsp;<span class="op" id="5286262">&amp;</span>&nbsp;<span class="ident" id="5286264">FoldCase</span><br>
<span class="lineno"></span><span class="op" id="5286273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="comment" id="5286276">//&nbsp;removeLeadingString&nbsp;removes&nbsp;the&nbsp;first&nbsp;n&nbsp;leading&nbsp;runes</span><br>
<span class="lineno"></span><span class="comment" id="5286333">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;re.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;replacement&nbsp;for&nbsp;re.</span><br>
<span class="lineno"></span><span class="keyword" id="5286398">func</span>&nbsp;<span class="op" id="5286403">(</span><span class="ident" id="5286404">p</span>&nbsp;<span class="op" id="5286406">*</span><span class="ident" id="5286407">parser</span><span class="op" id="5286413">)</span>&nbsp;<span class="ident" id="5286415">removeLeadingString</span><span class="op" id="5286434">(</span><span class="ident" id="5286435">re</span>&nbsp;<span class="op" id="5286438">*</span><span class="ident" id="5286439">Regexp</span><span class="op" id="5286445">,</span>&nbsp;<span class="ident" id="5286447">n</span>&nbsp;<span class="builtintype" id="5286449">int</span><span class="op" id="5286452">)</span>&nbsp;<span class="op" id="5286454">*</span><span class="ident" id="5286455">Regexp</span>&nbsp;<span class="op" id="5286462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286465">if</span>&nbsp;<span class="ident" id="5286468">re</span><span class="op" id="5286470">.</span><span class="ident" id="5286471">Op</span>&nbsp;<span class="op" id="5286474">==</span>&nbsp;<span class="ident" id="5286477">OpConcat</span>&nbsp;<span class="op" id="5286486">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5286489">len</span><span class="op" id="5286492">(</span><span class="ident" id="5286493">re</span><span class="op" id="5286495">.</span><span class="ident" id="5286496">Sub</span><span class="op" id="5286499">)</span>&nbsp;<span class="op" id="5286501">&gt;</span>&nbsp;<span class="num" id="5286503">0</span>&nbsp;<span class="op" id="5286505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5286509">//&nbsp;Removing&nbsp;a&nbsp;leading&nbsp;string&nbsp;in&nbsp;a&nbsp;concatenation</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5286559">//&nbsp;might&nbsp;simplify&nbsp;the&nbsp;concatenation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5286598">sub</span>&nbsp;<span class="op" id="5286602">:=</span>&nbsp;<span class="ident" id="5286605">re</span><span class="op" id="5286607">.</span><span class="ident" id="5286608">Sub</span><span class="op" id="5286611">[</span><span class="num" id="5286612">0</span><span class="op" id="5286613">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5286617">sub</span>&nbsp;<span class="op" id="5286621">=</span>&nbsp;<span class="ident" id="5286623">p</span><span class="op" id="5286624">.</span><span class="ident" id="5286625">removeLeadingString</span><span class="op" id="5286644">(</span><span class="ident" id="5286645">sub</span><span class="op" id="5286648">,</span>&nbsp;<span class="ident" id="5286650">n</span><span class="op" id="5286651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5286655">re</span><span class="op" id="5286657">.</span><span class="ident" id="5286658">Sub</span><span class="op" id="5286661">[</span><span class="num" id="5286662">0</span><span class="op" id="5286663">]</span>&nbsp;<span class="op" id="5286665">=</span>&nbsp;<span class="ident" id="5286667">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286673">if</span>&nbsp;<span class="ident" id="5286676">sub</span><span class="op" id="5286679">.</span><span class="ident" id="5286680">Op</span>&nbsp;<span class="op" id="5286683">==</span>&nbsp;<span class="ident" id="5286686">OpEmptyMatch</span>&nbsp;<span class="op" id="5286699">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5286704">p</span><span class="op" id="5286705">.</span><span class="ident" id="5286706">reuse</span><span class="op" id="5286711">(</span><span class="ident" id="5286712">sub</span><span class="op" id="5286715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286720">switch</span>&nbsp;<span class="builtinfunc" id="5286727">len</span><span class="op" id="5286730">(</span><span class="ident" id="5286731">re</span><span class="op" id="5286733">.</span><span class="ident" id="5286734">Sub</span><span class="op" id="5286737">)</span>&nbsp;<span class="op" id="5286739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286744">case</span>&nbsp;<span class="num" id="5286749">0</span><span class="op" id="5286750">,</span>&nbsp;<span class="num" id="5286752">1</span><span class="op" id="5286753">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5286759">//&nbsp;Impossible&nbsp;but&nbsp;handle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5286789">re</span><span class="op" id="5286791">.</span><span class="ident" id="5286792">Op</span>&nbsp;<span class="op" id="5286795">=</span>&nbsp;<span class="ident" id="5286797">OpEmptyMatch</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5286814">re</span><span class="op" id="5286816">.</span><span class="ident" id="5286817">Sub</span>&nbsp;<span class="op" id="5286821">=</span>&nbsp;<span class="ident" id="5286823">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286830">case</span>&nbsp;<span class="num" id="5286835">2</span><span class="op" id="5286836">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5286842">old</span>&nbsp;<span class="op" id="5286846">:=</span>&nbsp;<span class="ident" id="5286849">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5286856">re</span>&nbsp;<span class="op" id="5286859">=</span>&nbsp;<span class="ident" id="5286861">re</span><span class="op" id="5286863">.</span><span class="ident" id="5286864">Sub</span><span class="op" id="5286867">[</span><span class="num" id="5286868">1</span><span class="op" id="5286869">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5286875">p</span><span class="op" id="5286876">.</span><span class="ident" id="5286877">reuse</span><span class="op" id="5286882">(</span><span class="ident" id="5286883">old</span><span class="op" id="5286886">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286891">default</span><span class="op" id="5286898">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5286904">copy</span><span class="op" id="5286908">(</span><span class="ident" id="5286909">re</span><span class="op" id="5286911">.</span><span class="ident" id="5286912">Sub</span><span class="op" id="5286915">,</span>&nbsp;<span class="ident" id="5286917">re</span><span class="op" id="5286919">.</span><span class="ident" id="5286920">Sub</span><span class="op" id="5286923">[</span><span class="num" id="5286924">1</span><span class="op" id="5286925">:</span><span class="op" id="5286926">]</span><span class="op" id="5286927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5286933">re</span><span class="op" id="5286935">.</span><span class="ident" id="5286936">Sub</span>&nbsp;<span class="op" id="5286940">=</span>&nbsp;<span class="ident" id="5286942">re</span><span class="op" id="5286944">.</span><span class="ident" id="5286945">Sub</span><span class="op" id="5286948">[</span><span class="op" id="5286949">:</span><span class="builtinfunc" id="5286950">len</span><span class="op" id="5286953">(</span><span class="ident" id="5286954">re</span><span class="op" id="5286956">.</span><span class="ident" id="5286957">Sub</span><span class="op" id="5286960">)</span><span class="op" id="5286961">-</span><span class="num" id="5286962">1</span><span class="op" id="5286963">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5286968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5286972">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286976">return</span>&nbsp;<span class="ident" id="5286983">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5286987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5286991">if</span>&nbsp;<span class="ident" id="5286994">re</span><span class="op" id="5286996">.</span><span class="ident" id="5286997">Op</span>&nbsp;<span class="op" id="5287000">==</span>&nbsp;<span class="ident" id="5287003">OpLiteral</span>&nbsp;<span class="op" id="5287013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5287017">re</span><span class="op" id="5287019">.</span><span class="ident" id="5287020">Rune</span>&nbsp;<span class="op" id="5287025">=</span>&nbsp;<span class="ident" id="5287027">re</span><span class="op" id="5287029">.</span><span class="ident" id="5287030">Rune</span><span class="op" id="5287034">[</span><span class="op" id="5287035">:</span><span class="builtinfunc" id="5287036">copy</span><span class="op" id="5287040">(</span><span class="ident" id="5287041">re</span><span class="op" id="5287043">.</span><span class="ident" id="5287044">Rune</span><span class="op" id="5287048">,</span>&nbsp;<span class="ident" id="5287050">re</span><span class="op" id="5287052">.</span><span class="ident" id="5287053">Rune</span><span class="op" id="5287057">[</span><span class="ident" id="5287058">n</span><span class="op" id="5287059">:</span><span class="op" id="5287060">]</span><span class="op" id="5287061">)</span><span class="op" id="5287062">]</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287066">if</span>&nbsp;<span class="builtinfunc" id="5287069">len</span><span class="op" id="5287072">(</span><span class="ident" id="5287073">re</span><span class="op" id="5287075">.</span><span class="ident" id="5287076">Rune</span><span class="op" id="5287080">)</span>&nbsp;<span class="op" id="5287082">==</span>&nbsp;<span class="num" id="5287085">0</span>&nbsp;<span class="op" id="5287087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5287092">re</span><span class="op" id="5287094">.</span><span class="ident" id="5287095">Op</span>&nbsp;<span class="op" id="5287098">=</span>&nbsp;<span class="ident" id="5287100">OpEmptyMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5287115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5287118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287121">return</span>&nbsp;<span class="ident" id="5287128">re</span><br>
<span class="lineno">630</span><span class="op" id="5287131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5287134">//&nbsp;leadingRegexp&nbsp;returns&nbsp;the&nbsp;leading&nbsp;regexp&nbsp;that&nbsp;re&nbsp;begins&nbsp;with.</span><br>
<span class="lineno"></span><span class="comment" id="5287199">//&nbsp;The&nbsp;regexp&nbsp;refers&nbsp;to&nbsp;storage&nbsp;in&nbsp;re&nbsp;or&nbsp;its&nbsp;children.</span><br>
<span class="lineno"></span><span class="keyword" id="5287254">func</span>&nbsp;<span class="op" id="5287259">(</span><span class="ident" id="5287260">p</span>&nbsp;<span class="op" id="5287262">*</span><span class="ident" id="5287263">parser</span><span class="op" id="5287269">)</span>&nbsp;<span class="ident" id="5287271">leadingRegexp</span><span class="op" id="5287284">(</span><span class="ident" id="5287285">re</span>&nbsp;<span class="op" id="5287288">*</span><span class="ident" id="5287289">Regexp</span><span class="op" id="5287295">)</span>&nbsp;<span class="op" id="5287297">*</span><span class="ident" id="5287298">Regexp</span>&nbsp;<span class="op" id="5287305">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287308">if</span>&nbsp;<span class="ident" id="5287311">re</span><span class="op" id="5287313">.</span><span class="ident" id="5287314">Op</span>&nbsp;<span class="op" id="5287317">==</span>&nbsp;<span class="ident" id="5287320">OpEmptyMatch</span>&nbsp;<span class="op" id="5287333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287337">return</span>&nbsp;<span class="ident" id="5287344">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5287349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287352">if</span>&nbsp;<span class="ident" id="5287355">re</span><span class="op" id="5287357">.</span><span class="ident" id="5287358">Op</span>&nbsp;<span class="op" id="5287361">==</span>&nbsp;<span class="ident" id="5287364">OpConcat</span>&nbsp;<span class="op" id="5287373">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5287376">len</span><span class="op" id="5287379">(</span><span class="ident" id="5287380">re</span><span class="op" id="5287382">.</span><span class="ident" id="5287383">Sub</span><span class="op" id="5287386">)</span>&nbsp;<span class="op" id="5287388">&gt;</span>&nbsp;<span class="num" id="5287390">0</span>&nbsp;<span class="op" id="5287392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5287396">sub</span>&nbsp;<span class="op" id="5287400">:=</span>&nbsp;<span class="ident" id="5287403">re</span><span class="op" id="5287405">.</span><span class="ident" id="5287406">Sub</span><span class="op" id="5287409">[</span><span class="num" id="5287410">0</span><span class="op" id="5287411">]</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287415">if</span>&nbsp;<span class="ident" id="5287418">sub</span><span class="op" id="5287421">.</span><span class="ident" id="5287422">Op</span>&nbsp;<span class="op" id="5287425">==</span>&nbsp;<span class="ident" id="5287428">OpEmptyMatch</span>&nbsp;<span class="op" id="5287441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287446">return</span>&nbsp;<span class="ident" id="5287453">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5287459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287463">return</span>&nbsp;<span class="ident" id="5287470">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5287475">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287478">return</span>&nbsp;<span class="ident" id="5287485">re</span><br>
<span class="lineno"></span><span class="op" id="5287488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5287491">//&nbsp;removeLeadingRegexp&nbsp;removes&nbsp;the&nbsp;leading&nbsp;regexp&nbsp;in&nbsp;re.</span><br>
<span class="lineno"></span><span class="comment" id="5287548">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;replacement&nbsp;for&nbsp;re.</span><br>
<span class="lineno">650</span><span class="comment" id="5287586">//&nbsp;If&nbsp;reuse&nbsp;is&nbsp;true,&nbsp;it&nbsp;passes&nbsp;the&nbsp;removed&nbsp;regexp&nbsp;(if&nbsp;no&nbsp;longer&nbsp;needed)&nbsp;to&nbsp;p.reuse.</span><br>
<span class="lineno"></span><span class="keyword" id="5287670">func</span>&nbsp;<span class="op" id="5287675">(</span><span class="ident" id="5287676">p</span>&nbsp;<span class="op" id="5287678">*</span><span class="ident" id="5287679">parser</span><span class="op" id="5287685">)</span>&nbsp;<span class="ident" id="5287687">removeLeadingRegexp</span><span class="op" id="5287706">(</span><span class="ident" id="5287707">re</span>&nbsp;<span class="op" id="5287710">*</span><span class="ident" id="5287711">Regexp</span><span class="op" id="5287717">,</span>&nbsp;<span class="ident" id="5287719">reuse</span>&nbsp;<span class="builtintype" id="5287725">bool</span><span class="op" id="5287729">)</span>&nbsp;<span class="op" id="5287731">*</span><span class="ident" id="5287732">Regexp</span>&nbsp;<span class="op" id="5287739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287742">if</span>&nbsp;<span class="ident" id="5287745">re</span><span class="op" id="5287747">.</span><span class="ident" id="5287748">Op</span>&nbsp;<span class="op" id="5287751">==</span>&nbsp;<span class="ident" id="5287754">OpConcat</span>&nbsp;<span class="op" id="5287763">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5287766">len</span><span class="op" id="5287769">(</span><span class="ident" id="5287770">re</span><span class="op" id="5287772">.</span><span class="ident" id="5287773">Sub</span><span class="op" id="5287776">)</span>&nbsp;<span class="op" id="5287778">&gt;</span>&nbsp;<span class="num" id="5287780">0</span>&nbsp;<span class="op" id="5287782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287786">if</span>&nbsp;<span class="ident" id="5287789">reuse</span>&nbsp;<span class="op" id="5287795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5287800">p</span><span class="op" id="5287801">.</span><span class="ident" id="5287802">reuse</span><span class="op" id="5287807">(</span><span class="ident" id="5287808">re</span><span class="op" id="5287810">.</span><span class="ident" id="5287811">Sub</span><span class="op" id="5287814">[</span><span class="num" id="5287815">0</span><span class="op" id="5287816">]</span><span class="op" id="5287817">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5287821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5287825">re</span><span class="op" id="5287827">.</span><span class="ident" id="5287828">Sub</span>&nbsp;<span class="op" id="5287832">=</span>&nbsp;<span class="ident" id="5287834">re</span><span class="op" id="5287836">.</span><span class="ident" id="5287837">Sub</span><span class="op" id="5287840">[</span><span class="op" id="5287841">:</span><span class="builtinfunc" id="5287842">copy</span><span class="op" id="5287846">(</span><span class="ident" id="5287847">re</span><span class="op" id="5287849">.</span><span class="ident" id="5287850">Sub</span><span class="op" id="5287853">,</span>&nbsp;<span class="ident" id="5287855">re</span><span class="op" id="5287857">.</span><span class="ident" id="5287858">Sub</span><span class="op" id="5287861">[</span><span class="num" id="5287862">1</span><span class="op" id="5287863">:</span><span class="op" id="5287864">]</span><span class="op" id="5287865">)</span><span class="op" id="5287866">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287870">switch</span>&nbsp;<span class="builtinfunc" id="5287877">len</span><span class="op" id="5287880">(</span><span class="ident" id="5287881">re</span><span class="op" id="5287883">.</span><span class="ident" id="5287884">Sub</span><span class="op" id="5287887">)</span>&nbsp;<span class="op" id="5287889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287893">case</span>&nbsp;<span class="num" id="5287898">0</span><span class="op" id="5287899">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5287904">re</span><span class="op" id="5287906">.</span><span class="ident" id="5287907">Op</span>&nbsp;<span class="op" id="5287910">=</span>&nbsp;<span class="ident" id="5287912">OpEmptyMatch</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5287928">re</span><span class="op" id="5287930">.</span><span class="ident" id="5287931">Sub</span>&nbsp;<span class="op" id="5287935">=</span>&nbsp;<span class="ident" id="5287937">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5287943">case</span>&nbsp;<span class="num" id="5287948">1</span><span class="op" id="5287949">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5287954">old</span>&nbsp;<span class="op" id="5287958">:=</span>&nbsp;<span class="ident" id="5287961">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5287967">re</span>&nbsp;<span class="op" id="5287970">=</span>&nbsp;<span class="ident" id="5287972">re</span><span class="op" id="5287974">.</span><span class="ident" id="5287975">Sub</span><span class="op" id="5287978">[</span><span class="num" id="5287979">0</span><span class="op" id="5287980">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5287985">p</span><span class="op" id="5287986">.</span><span class="ident" id="5287987">reuse</span><span class="op" id="5287992">(</span><span class="ident" id="5287993">old</span><span class="op" id="5287996">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5288000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288004">return</span>&nbsp;<span class="ident" id="5288011">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5288015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288018">if</span>&nbsp;<span class="ident" id="5288021">reuse</span>&nbsp;<span class="op" id="5288027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5288031">p</span><span class="op" id="5288032">.</span><span class="ident" id="5288033">reuse</span><span class="op" id="5288038">(</span><span class="ident" id="5288039">re</span><span class="op" id="5288041">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5288044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288047">return</span>&nbsp;<span class="ident" id="5288054">p</span><span class="op" id="5288055">.</span><span class="ident" id="5288056">newRegexp</span><span class="op" id="5288065">(</span><span class="ident" id="5288066">OpEmptyMatch</span><span class="op" id="5288078">)</span><br>
<span class="lineno"></span><span class="op" id="5288080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5288083">func</span>&nbsp;<span class="ident" id="5288088">literalRegexp</span><span class="op" id="5288101">(</span><span class="ident" id="5288102">s</span>&nbsp;<span class="builtintype" id="5288104">string</span><span class="op" id="5288110">,</span>&nbsp;<span class="ident" id="5288112">flags</span>&nbsp;<span class="ident" id="5288118">Flags</span><span class="op" id="5288123">)</span>&nbsp;<span class="op" id="5288125">*</span><span class="ident" id="5288126">Regexp</span>&nbsp;<span class="op" id="5288133">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5288136">re</span>&nbsp;<span class="op" id="5288139">:=</span>&nbsp;<span class="op" id="5288142">&amp;</span><span class="ident" id="5288143">Regexp</span><span class="op" id="5288149">{</span><span class="ident" id="5288150">Op</span><span class="op" id="5288152">:</span>&nbsp;<span class="ident" id="5288154">OpLiteral</span><span class="op" id="5288163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5288166">re</span><span class="op" id="5288168">.</span><span class="ident" id="5288169">Flags</span>&nbsp;<span class="op" id="5288175">=</span>&nbsp;<span class="ident" id="5288177">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5288184">re</span><span class="op" id="5288186">.</span><span class="ident" id="5288187">Rune</span>&nbsp;<span class="op" id="5288192">=</span>&nbsp;<span class="ident" id="5288194">re</span><span class="op" id="5288196">.</span><span class="ident" id="5288197">Rune0</span><span class="op" id="5288202">[</span><span class="op" id="5288203">:</span><span class="num" id="5288204">0</span><span class="op" id="5288205">]</span>&nbsp;<span class="comment" id="5288207">//&nbsp;use&nbsp;local&nbsp;storage&nbsp;for&nbsp;small&nbsp;strings</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288247">for</span>&nbsp;<span class="ident" id="5288251">_</span><span class="op" id="5288252">,</span>&nbsp;<span class="ident" id="5288254">c</span>&nbsp;<span class="op" id="5288256">:=</span>&nbsp;<span class="keyword" id="5288259">range</span>&nbsp;<span class="ident" id="5288265">s</span>&nbsp;<span class="op" id="5288267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288271">if</span>&nbsp;<span class="builtinfunc" id="5288274">len</span><span class="op" id="5288277">(</span><span class="ident" id="5288278">re</span><span class="op" id="5288280">.</span><span class="ident" id="5288281">Rune</span><span class="op" id="5288285">)</span>&nbsp;<span class="op" id="5288287">&gt;=</span>&nbsp;<span class="builtinfunc" id="5288290">cap</span><span class="op" id="5288293">(</span><span class="ident" id="5288294">re</span><span class="op" id="5288296">.</span><span class="ident" id="5288297">Rune</span><span class="op" id="5288301">)</span>&nbsp;<span class="op" id="5288303">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5288308">//&nbsp;string&nbsp;is&nbsp;too&nbsp;long&nbsp;to&nbsp;fit&nbsp;in&nbsp;Rune0.&nbsp;&nbsp;let&nbsp;Go&nbsp;handle&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5288368">re</span><span class="op" id="5288370">.</span><span class="ident" id="5288371">Rune</span>&nbsp;<span class="op" id="5288376">=</span>&nbsp;<span class="op" id="5288378">[</span><span class="op" id="5288379">]</span><span class="builtintype" id="5288380">rune</span><span class="op" id="5288384">(</span><span class="ident" id="5288385">s</span><span class="op" id="5288386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288391">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5288399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5288403">re</span><span class="op" id="5288405">.</span><span class="ident" id="5288406">Rune</span>&nbsp;<span class="op" id="5288411">=</span>&nbsp;<span class="builtinfunc" id="5288413">append</span><span class="op" id="5288419">(</span><span class="ident" id="5288420">re</span><span class="op" id="5288422">.</span><span class="ident" id="5288423">Rune</span><span class="op" id="5288427">,</span>&nbsp;<span class="ident" id="5288429">c</span><span class="op" id="5288430">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5288433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288436">return</span>&nbsp;<span class="ident" id="5288443">re</span><br>
<span class="lineno"></span><span class="op" id="5288446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5288449">//&nbsp;Parsing.</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="comment" id="5288462">//&nbsp;Parse&nbsp;parses&nbsp;a&nbsp;regular&nbsp;expression&nbsp;string&nbsp;s,&nbsp;controlled&nbsp;by&nbsp;the&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="5288537">//&nbsp;Flags,&nbsp;and&nbsp;returns&nbsp;a&nbsp;regular&nbsp;expression&nbsp;parse&nbsp;tree.&nbsp;The&nbsp;syntax&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5288606">//&nbsp;described&nbsp;in&nbsp;the&nbsp;top-level&nbsp;comment.</span><br>
<span class="lineno"></span><span class="keyword" id="5288645">func</span>&nbsp;<span class="ident" id="5288650">Parse</span><span class="op" id="5288655">(</span><span class="ident" id="5288656">s</span>&nbsp;<span class="builtintype" id="5288658">string</span><span class="op" id="5288664">,</span>&nbsp;<span class="ident" id="5288666">flags</span>&nbsp;<span class="ident" id="5288672">Flags</span><span class="op" id="5288677">)</span>&nbsp;<span class="op" id="5288679">(</span><span class="op" id="5288680">*</span><span class="ident" id="5288681">Regexp</span><span class="op" id="5288687">,</span>&nbsp;<span class="builtintype" id="5288689">error</span><span class="op" id="5288694">)</span>&nbsp;<span class="op" id="5288696">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288699">if</span>&nbsp;<span class="ident" id="5288702">flags</span><span class="op" id="5288707">&amp;</span><span class="ident" id="5288708">Literal</span>&nbsp;<span class="op" id="5288716">!=</span>&nbsp;<span class="num" id="5288719">0</span>&nbsp;<span class="op" id="5288721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5288725">//&nbsp;Trivial&nbsp;parser&nbsp;for&nbsp;literal&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288765">if</span>&nbsp;<span class="ident" id="5288768">err</span>&nbsp;<span class="op" id="5288772">:=</span>&nbsp;<span class="ident" id="5288775">checkUTF8</span><span class="op" id="5288784">(</span><span class="ident" id="5288785">s</span><span class="op" id="5288786">)</span><span class="op" id="5288787">;</span>&nbsp;<span class="ident" id="5288789">err</span>&nbsp;<span class="op" id="5288793">!=</span>&nbsp;<span class="ident" id="5288796">nil</span>&nbsp;<span class="op" id="5288800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288805">return</span>&nbsp;<span class="ident" id="5288812">nil</span><span class="op" id="5288815">,</span>&nbsp;<span class="ident" id="5288817">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5288823">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288827">return</span>&nbsp;<span class="ident" id="5288834">literalRegexp</span><span class="op" id="5288847">(</span><span class="ident" id="5288848">s</span><span class="op" id="5288849">,</span>&nbsp;<span class="ident" id="5288851">flags</span><span class="op" id="5288856">)</span><span class="op" id="5288857">,</span>&nbsp;<span class="ident" id="5288859">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5288864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5288868">//&nbsp;Otherwise,&nbsp;must&nbsp;do&nbsp;real&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5288902">var</span>&nbsp;<span class="op" id="5288906">(</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5288910">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288921">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5288930">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5288941">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5288949">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5288960">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5288967">op</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288978">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5288983">lastRepeat</span>&nbsp;<span class="builtintype" id="5288994">string</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5289002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289005">p</span><span class="op" id="5289006">.</span><span class="ident" id="5289007">flags</span>&nbsp;<span class="op" id="5289013">=</span>&nbsp;<span class="ident" id="5289015">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289022">p</span><span class="op" id="5289023">.</span><span class="ident" id="5289024">wholeRegexp</span>&nbsp;<span class="op" id="5289036">=</span>&nbsp;<span class="ident" id="5289038">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289041">t</span>&nbsp;<span class="op" id="5289043">:=</span>&nbsp;<span class="ident" id="5289046">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289049">for</span>&nbsp;<span class="ident" id="5289053">t</span>&nbsp;<span class="op" id="5289055">!=</span>&nbsp;<span class="string" id="5289058">&#34;&#34;</span>&nbsp;<span class="op" id="5289061">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289065">repeat</span>&nbsp;<span class="op" id="5289072">:=</span>&nbsp;<span class="string" id="5289075">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289079">BigSwitch</span><span class="op" id="5289088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289092">switch</span>&nbsp;<span class="ident" id="5289099">t</span><span class="op" id="5289100">[</span><span class="num" id="5289101">0</span><span class="op" id="5289102">]</span>&nbsp;<span class="op" id="5289104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289108">default</span><span class="op" id="5289115">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289120">if</span>&nbsp;<span class="ident" id="5289123">c</span><span class="op" id="5289124">,</span>&nbsp;<span class="ident" id="5289126">t</span><span class="op" id="5289127">,</span>&nbsp;<span class="ident" id="5289129">err</span>&nbsp;<span class="op" id="5289133">=</span>&nbsp;<span class="ident" id="5289135">nextRune</span><span class="op" id="5289143">(</span><span class="ident" id="5289144">t</span><span class="op" id="5289145">)</span><span class="op" id="5289146">;</span>&nbsp;<span class="ident" id="5289148">err</span>&nbsp;<span class="op" id="5289152">!=</span>&nbsp;<span class="ident" id="5289155">nil</span>&nbsp;<span class="op" id="5289159">{</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289165">return</span>&nbsp;<span class="ident" id="5289172">nil</span><span class="op" id="5289175">,</span>&nbsp;<span class="ident" id="5289177">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5289184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289189">p</span><span class="op" id="5289190">.</span><span class="ident" id="5289191">literal</span><span class="op" id="5289198">(</span><span class="ident" id="5289199">c</span><span class="op" id="5289200">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289205">case</span>&nbsp;<span class="string" id="5289210">&#39;(&#39;</span><span class="op" id="5289213">:</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289218">if</span>&nbsp;<span class="ident" id="5289221">p</span><span class="op" id="5289222">.</span><span class="ident" id="5289223">flags</span><span class="op" id="5289228">&amp;</span><span class="ident" id="5289229">PerlX</span>&nbsp;<span class="op" id="5289235">!=</span>&nbsp;<span class="num" id="5289238">0</span>&nbsp;<span class="op" id="5289240">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5289243">len</span><span class="op" id="5289246">(</span><span class="ident" id="5289247">t</span><span class="op" id="5289248">)</span>&nbsp;<span class="op" id="5289250">&gt;=</span>&nbsp;<span class="num" id="5289253">2</span>&nbsp;<span class="op" id="5289255">&amp;&amp;</span>&nbsp;<span class="ident" id="5289258">t</span><span class="op" id="5289259">[</span><span class="num" id="5289260">1</span><span class="op" id="5289261">]</span>&nbsp;<span class="op" id="5289263">==</span>&nbsp;<span class="string" id="5289266">&#39;?&#39;</span>&nbsp;<span class="op" id="5289270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5289276">//&nbsp;Flag&nbsp;changes&nbsp;and&nbsp;non-capturing&nbsp;groups.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289322">if</span>&nbsp;<span class="ident" id="5289325">t</span><span class="op" id="5289326">,</span>&nbsp;<span class="ident" id="5289328">err</span>&nbsp;<span class="op" id="5289332">=</span>&nbsp;<span class="ident" id="5289334">p</span><span class="op" id="5289335">.</span><span class="ident" id="5289336">parsePerlFlags</span><span class="op" id="5289350">(</span><span class="ident" id="5289351">t</span><span class="op" id="5289352">)</span><span class="op" id="5289353">;</span>&nbsp;<span class="ident" id="5289355">err</span>&nbsp;<span class="op" id="5289359">!=</span>&nbsp;<span class="ident" id="5289362">nil</span>&nbsp;<span class="op" id="5289366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289373">return</span>&nbsp;<span class="ident" id="5289380">nil</span><span class="op" id="5289383">,</span>&nbsp;<span class="ident" id="5289385">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5289393">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289399">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5289408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289413">p</span><span class="op" id="5289414">.</span><span class="ident" id="5289415">numCap</span><span class="op" id="5289421">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289427">p</span><span class="op" id="5289428">.</span><span class="ident" id="5289429">op</span><span class="op" id="5289431">(</span><span class="ident" id="5289432">opLeftParen</span><span class="op" id="5289443">)</span><span class="op" id="5289444">.</span><span class="ident" id="5289445">Cap</span>&nbsp;<span class="op" id="5289449">=</span>&nbsp;<span class="ident" id="5289451">p</span><span class="op" id="5289452">.</span><span class="ident" id="5289453">numCap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289463">t</span>&nbsp;<span class="op" id="5289465">=</span>&nbsp;<span class="ident" id="5289467">t</span><span class="op" id="5289468">[</span><span class="num" id="5289469">1</span><span class="op" id="5289470">:</span><span class="op" id="5289471">]</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289475">case</span>&nbsp;<span class="string" id="5289480">&#39;|&#39;</span><span class="op" id="5289483">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289488">if</span>&nbsp;<span class="ident" id="5289491">err</span>&nbsp;<span class="op" id="5289495">=</span>&nbsp;<span class="ident" id="5289497">p</span><span class="op" id="5289498">.</span><span class="ident" id="5289499">parseVerticalBar</span><span class="op" id="5289515">(</span><span class="op" id="5289516">)</span><span class="op" id="5289517">;</span>&nbsp;<span class="ident" id="5289519">err</span>&nbsp;<span class="op" id="5289523">!=</span>&nbsp;<span class="ident" id="5289526">nil</span>&nbsp;<span class="op" id="5289530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289536">return</span>&nbsp;<span class="ident" id="5289543">nil</span><span class="op" id="5289546">,</span>&nbsp;<span class="ident" id="5289548">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5289555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289560">t</span>&nbsp;<span class="op" id="5289562">=</span>&nbsp;<span class="ident" id="5289564">t</span><span class="op" id="5289565">[</span><span class="num" id="5289566">1</span><span class="op" id="5289567">:</span><span class="op" id="5289568">]</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289572">case</span>&nbsp;<span class="string" id="5289577">&#39;)&#39;</span><span class="op" id="5289580">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289585">if</span>&nbsp;<span class="ident" id="5289588">err</span>&nbsp;<span class="op" id="5289592">=</span>&nbsp;<span class="ident" id="5289594">p</span><span class="op" id="5289595">.</span><span class="ident" id="5289596">parseRightParen</span><span class="op" id="5289611">(</span><span class="op" id="5289612">)</span><span class="op" id="5289613">;</span>&nbsp;<span class="ident" id="5289615">err</span>&nbsp;<span class="op" id="5289619">!=</span>&nbsp;<span class="ident" id="5289622">nil</span>&nbsp;<span class="op" id="5289626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289632">return</span>&nbsp;<span class="ident" id="5289639">nil</span><span class="op" id="5289642">,</span>&nbsp;<span class="ident" id="5289644">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5289651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289656">t</span>&nbsp;<span class="op" id="5289658">=</span>&nbsp;<span class="ident" id="5289660">t</span><span class="op" id="5289661">[</span><span class="num" id="5289662">1</span><span class="op" id="5289663">:</span><span class="op" id="5289664">]</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289668">case</span>&nbsp;<span class="string" id="5289673">&#39;^&#39;</span><span class="op" id="5289676">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289681">if</span>&nbsp;<span class="ident" id="5289684">p</span><span class="op" id="5289685">.</span><span class="ident" id="5289686">flags</span><span class="op" id="5289691">&amp;</span><span class="ident" id="5289692">OneLine</span>&nbsp;<span class="op" id="5289700">!=</span>&nbsp;<span class="num" id="5289703">0</span>&nbsp;<span class="op" id="5289705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289711">p</span><span class="op" id="5289712">.</span><span class="ident" id="5289713">op</span><span class="op" id="5289715">(</span><span class="ident" id="5289716">OpBeginText</span><span class="op" id="5289727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5289732">}</span>&nbsp;<span class="keyword" id="5289734">else</span>&nbsp;<span class="op" id="5289739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289745">p</span><span class="op" id="5289746">.</span><span class="ident" id="5289747">op</span><span class="op" id="5289749">(</span><span class="ident" id="5289750">OpBeginLine</span><span class="op" id="5289761">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5289766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289771">t</span>&nbsp;<span class="op" id="5289773">=</span>&nbsp;<span class="ident" id="5289775">t</span><span class="op" id="5289776">[</span><span class="num" id="5289777">1</span><span class="op" id="5289778">:</span><span class="op" id="5289779">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289783">case</span>&nbsp;<span class="string" id="5289788">&#39;$&#39;</span><span class="op" id="5289791">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289796">if</span>&nbsp;<span class="ident" id="5289799">p</span><span class="op" id="5289800">.</span><span class="ident" id="5289801">flags</span><span class="op" id="5289806">&amp;</span><span class="ident" id="5289807">OneLine</span>&nbsp;<span class="op" id="5289815">!=</span>&nbsp;<span class="num" id="5289818">0</span>&nbsp;<span class="op" id="5289820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289826">p</span><span class="op" id="5289827">.</span><span class="ident" id="5289828">op</span><span class="op" id="5289830">(</span><span class="ident" id="5289831">OpEndText</span><span class="op" id="5289840">)</span><span class="op" id="5289841">.</span><span class="ident" id="5289842">Flags</span>&nbsp;<span class="op" id="5289848">|=</span>&nbsp;<span class="ident" id="5289851">WasDollar</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5289864">}</span>&nbsp;<span class="keyword" id="5289866">else</span>&nbsp;<span class="op" id="5289871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289877">p</span><span class="op" id="5289878">.</span><span class="ident" id="5289879">op</span><span class="op" id="5289881">(</span><span class="ident" id="5289882">OpEndLine</span><span class="op" id="5289891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5289896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289901">t</span>&nbsp;<span class="op" id="5289903">=</span>&nbsp;<span class="ident" id="5289905">t</span><span class="op" id="5289906">[</span><span class="num" id="5289907">1</span><span class="op" id="5289908">:</span><span class="op" id="5289909">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289913">case</span>&nbsp;<span class="string" id="5289918">&#39;.&#39;</span><span class="op" id="5289921">:</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5289926">if</span>&nbsp;<span class="ident" id="5289929">p</span><span class="op" id="5289930">.</span><span class="ident" id="5289931">flags</span><span class="op" id="5289936">&amp;</span><span class="ident" id="5289937">DotNL</span>&nbsp;<span class="op" id="5289943">!=</span>&nbsp;<span class="num" id="5289946">0</span>&nbsp;<span class="op" id="5289948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289954">p</span><span class="op" id="5289955">.</span><span class="ident" id="5289956">op</span><span class="op" id="5289958">(</span><span class="ident" id="5289959">OpAnyChar</span><span class="op" id="5289968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5289973">}</span>&nbsp;<span class="keyword" id="5289975">else</span>&nbsp;<span class="op" id="5289980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5289986">p</span><span class="op" id="5289987">.</span><span class="ident" id="5289988">op</span><span class="op" id="5289990">(</span><span class="ident" id="5289991">OpAnyCharNotNL</span><span class="op" id="5290005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5290010">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290015">t</span>&nbsp;<span class="op" id="5290017">=</span>&nbsp;<span class="ident" id="5290019">t</span><span class="op" id="5290020">[</span><span class="num" id="5290021">1</span><span class="op" id="5290022">:</span><span class="op" id="5290023">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290027">case</span>&nbsp;<span class="string" id="5290032">&#39;[&#39;</span><span class="op" id="5290035">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290040">if</span>&nbsp;<span class="ident" id="5290043">t</span><span class="op" id="5290044">,</span>&nbsp;<span class="ident" id="5290046">err</span>&nbsp;<span class="op" id="5290050">=</span>&nbsp;<span class="ident" id="5290052">p</span><span class="op" id="5290053">.</span><span class="ident" id="5290054">parseClass</span><span class="op" id="5290064">(</span><span class="ident" id="5290065">t</span><span class="op" id="5290066">)</span><span class="op" id="5290067">;</span>&nbsp;<span class="ident" id="5290069">err</span>&nbsp;<span class="op" id="5290073">!=</span>&nbsp;<span class="ident" id="5290076">nil</span>&nbsp;<span class="op" id="5290080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290086">return</span>&nbsp;<span class="ident" id="5290093">nil</span><span class="op" id="5290096">,</span>&nbsp;<span class="ident" id="5290098">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5290105">}</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290109">case</span>&nbsp;<span class="string" id="5290114">&#39;*&#39;</span><span class="op" id="5290117">,</span>&nbsp;<span class="string" id="5290119">&#39;+&#39;</span><span class="op" id="5290122">,</span>&nbsp;<span class="string" id="5290124">&#39;?&#39;</span><span class="op" id="5290127">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290132">before</span>&nbsp;<span class="op" id="5290139">:=</span>&nbsp;<span class="ident" id="5290142">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290147">switch</span>&nbsp;<span class="ident" id="5290154">t</span><span class="op" id="5290155">[</span><span class="num" id="5290156">0</span><span class="op" id="5290157">]</span>&nbsp;<span class="op" id="5290159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290164">case</span>&nbsp;<span class="string" id="5290169">&#39;*&#39;</span><span class="op" id="5290172">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290178">op</span>&nbsp;<span class="op" id="5290181">=</span>&nbsp;<span class="ident" id="5290183">OpStar</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290193">case</span>&nbsp;<span class="string" id="5290198">&#39;+&#39;</span><span class="op" id="5290201">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290207">op</span>&nbsp;<span class="op" id="5290210">=</span>&nbsp;<span class="ident" id="5290212">OpPlus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290222">case</span>&nbsp;<span class="string" id="5290227">&#39;?&#39;</span><span class="op" id="5290230">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290236">op</span>&nbsp;<span class="op" id="5290239">=</span>&nbsp;<span class="ident" id="5290241">OpQuest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5290252">}</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290257">after</span>&nbsp;<span class="op" id="5290263">:=</span>&nbsp;<span class="ident" id="5290266">t</span><span class="op" id="5290267">[</span><span class="num" id="5290268">1</span><span class="op" id="5290269">:</span><span class="op" id="5290270">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290275">if</span>&nbsp;<span class="ident" id="5290278">after</span><span class="op" id="5290283">,</span>&nbsp;<span class="ident" id="5290285">err</span>&nbsp;<span class="op" id="5290289">=</span>&nbsp;<span class="ident" id="5290291">p</span><span class="op" id="5290292">.</span><span class="ident" id="5290293">repeat</span><span class="op" id="5290299">(</span><span class="ident" id="5290300">op</span><span class="op" id="5290302">,</span>&nbsp;<span class="num" id="5290304">0</span><span class="op" id="5290305">,</span>&nbsp;<span class="num" id="5290307">0</span><span class="op" id="5290308">,</span>&nbsp;<span class="ident" id="5290310">before</span><span class="op" id="5290316">,</span>&nbsp;<span class="ident" id="5290318">after</span><span class="op" id="5290323">,</span>&nbsp;<span class="ident" id="5290325">lastRepeat</span><span class="op" id="5290335">)</span><span class="op" id="5290336">;</span>&nbsp;<span class="ident" id="5290338">err</span>&nbsp;<span class="op" id="5290342">!=</span>&nbsp;<span class="ident" id="5290345">nil</span>&nbsp;<span class="op" id="5290349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290355">return</span>&nbsp;<span class="ident" id="5290362">nil</span><span class="op" id="5290365">,</span>&nbsp;<span class="ident" id="5290367">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5290374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290379">repeat</span>&nbsp;<span class="op" id="5290386">=</span>&nbsp;<span class="ident" id="5290388">before</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290398">t</span>&nbsp;<span class="op" id="5290400">=</span>&nbsp;<span class="ident" id="5290402">after</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290410">case</span>&nbsp;<span class="string" id="5290415">&#39;{&#39;</span><span class="op" id="5290418">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290423">op</span>&nbsp;<span class="op" id="5290426">=</span>&nbsp;<span class="ident" id="5290428">OpRepeat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290440">before</span>&nbsp;<span class="op" id="5290447">:=</span>&nbsp;<span class="ident" id="5290450">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290455">min</span><span class="op" id="5290458">,</span>&nbsp;<span class="ident" id="5290460">max</span><span class="op" id="5290463">,</span>&nbsp;<span class="ident" id="5290465">after</span><span class="op" id="5290470">,</span>&nbsp;<span class="ident" id="5290472">ok</span>&nbsp;<span class="op" id="5290475">:=</span>&nbsp;<span class="ident" id="5290478">p</span><span class="op" id="5290479">.</span><span class="ident" id="5290480">parseRepeat</span><span class="op" id="5290491">(</span><span class="ident" id="5290492">t</span><span class="op" id="5290493">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290498">if</span>&nbsp;<span class="op" id="5290501">!</span><span class="ident" id="5290502">ok</span>&nbsp;<span class="op" id="5290505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5290511">//&nbsp;If&nbsp;the&nbsp;repeat&nbsp;cannot&nbsp;be&nbsp;parsed,&nbsp;{&nbsp;is&nbsp;a&nbsp;literal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290566">p</span><span class="op" id="5290567">.</span><span class="ident" id="5290568">literal</span><span class="op" id="5290575">(</span><span class="string" id="5290576">&#39;{&#39;</span><span class="op" id="5290579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290585">t</span>&nbsp;<span class="op" id="5290587">=</span>&nbsp;<span class="ident" id="5290589">t</span><span class="op" id="5290590">[</span><span class="num" id="5290591">1</span><span class="op" id="5290592">:</span><span class="op" id="5290593">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290599">break</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5290608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290613">if</span>&nbsp;<span class="ident" id="5290616">min</span>&nbsp;<span class="op" id="5290620">&lt;</span>&nbsp;<span class="num" id="5290622">0</span>&nbsp;<span class="op" id="5290624">||</span>&nbsp;<span class="ident" id="5290627">min</span>&nbsp;<span class="op" id="5290631">&gt;</span>&nbsp;<span class="num" id="5290633">1000</span>&nbsp;<span class="op" id="5290638">||</span>&nbsp;<span class="ident" id="5290641">max</span>&nbsp;<span class="op" id="5290645">&gt;</span>&nbsp;<span class="num" id="5290647">1000</span>&nbsp;<span class="op" id="5290652">||</span>&nbsp;<span class="ident" id="5290655">max</span>&nbsp;<span class="op" id="5290659">&gt;=</span>&nbsp;<span class="num" id="5290662">0</span>&nbsp;<span class="op" id="5290664">&amp;&amp;</span>&nbsp;<span class="ident" id="5290667">min</span>&nbsp;<span class="op" id="5290671">&gt;</span>&nbsp;<span class="ident" id="5290673">max</span>&nbsp;<span class="op" id="5290677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5290683">//&nbsp;Numbers&nbsp;were&nbsp;too&nbsp;big,&nbsp;or&nbsp;max&nbsp;is&nbsp;present&nbsp;and&nbsp;min&nbsp;&gt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290745">return</span>&nbsp;<span class="ident" id="5290752">nil</span><span class="op" id="5290755">,</span>&nbsp;<span class="op" id="5290757">&amp;</span><span class="ident" id="5290758">Error</span><span class="op" id="5290763">{</span><span class="ident" id="5290764">ErrInvalidRepeatSize</span><span class="op" id="5290784">,</span>&nbsp;<span class="ident" id="5290786">before</span><span class="op" id="5290792">[</span><span class="op" id="5290793">:</span><span class="builtinfunc" id="5290794">len</span><span class="op" id="5290797">(</span><span class="ident" id="5290798">before</span><span class="op" id="5290804">)</span><span class="op" id="5290805">-</span><span class="builtinfunc" id="5290806">len</span><span class="op" id="5290809">(</span><span class="ident" id="5290810">after</span><span class="op" id="5290815">)</span><span class="op" id="5290816">]</span><span class="op" id="5290817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5290822">}</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290827">if</span>&nbsp;<span class="ident" id="5290830">after</span><span class="op" id="5290835">,</span>&nbsp;<span class="ident" id="5290837">err</span>&nbsp;<span class="op" id="5290841">=</span>&nbsp;<span class="ident" id="5290843">p</span><span class="op" id="5290844">.</span><span class="ident" id="5290845">repeat</span><span class="op" id="5290851">(</span><span class="ident" id="5290852">op</span><span class="op" id="5290854">,</span>&nbsp;<span class="ident" id="5290856">min</span><span class="op" id="5290859">,</span>&nbsp;<span class="ident" id="5290861">max</span><span class="op" id="5290864">,</span>&nbsp;<span class="ident" id="5290866">before</span><span class="op" id="5290872">,</span>&nbsp;<span class="ident" id="5290874">after</span><span class="op" id="5290879">,</span>&nbsp;<span class="ident" id="5290881">lastRepeat</span><span class="op" id="5290891">)</span><span class="op" id="5290892">;</span>&nbsp;<span class="ident" id="5290894">err</span>&nbsp;<span class="op" id="5290898">!=</span>&nbsp;<span class="ident" id="5290901">nil</span>&nbsp;<span class="op" id="5290905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290911">return</span>&nbsp;<span class="ident" id="5290918">nil</span><span class="op" id="5290921">,</span>&nbsp;<span class="ident" id="5290923">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5290930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290935">repeat</span>&nbsp;<span class="op" id="5290942">=</span>&nbsp;<span class="ident" id="5290944">before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5290954">t</span>&nbsp;<span class="op" id="5290956">=</span>&nbsp;<span class="ident" id="5290958">after</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290966">case</span>&nbsp;<span class="string" id="5290971">&#39;\\&#39;</span><span class="op" id="5290975">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5290980">if</span>&nbsp;<span class="ident" id="5290983">p</span><span class="op" id="5290984">.</span><span class="ident" id="5290985">flags</span><span class="op" id="5290990">&amp;</span><span class="ident" id="5290991">PerlX</span>&nbsp;<span class="op" id="5290997">!=</span>&nbsp;<span class="num" id="5291000">0</span>&nbsp;<span class="op" id="5291002">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5291005">len</span><span class="op" id="5291008">(</span><span class="ident" id="5291009">t</span><span class="op" id="5291010">)</span>&nbsp;<span class="op" id="5291012">&gt;=</span>&nbsp;<span class="num" id="5291015">2</span>&nbsp;<span class="op" id="5291017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291023">switch</span>&nbsp;<span class="ident" id="5291030">t</span><span class="op" id="5291031">[</span><span class="num" id="5291032">1</span><span class="op" id="5291033">]</span>&nbsp;<span class="op" id="5291035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291041">case</span>&nbsp;<span class="string" id="5291046">&#39;A&#39;</span><span class="op" id="5291049">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291056">p</span><span class="op" id="5291057">.</span><span class="ident" id="5291058">op</span><span class="op" id="5291060">(</span><span class="ident" id="5291061">OpBeginText</span><span class="op" id="5291072">)</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291079">t</span>&nbsp;<span class="op" id="5291081">=</span>&nbsp;<span class="ident" id="5291083">t</span><span class="op" id="5291084">[</span><span class="num" id="5291085">2</span><span class="op" id="5291086">:</span><span class="op" id="5291087">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291094">break</span>&nbsp;<span class="ident" id="5291100">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291114">case</span>&nbsp;<span class="string" id="5291119">&#39;b&#39;</span><span class="op" id="5291122">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291129">p</span><span class="op" id="5291130">.</span><span class="ident" id="5291131">op</span><span class="op" id="5291133">(</span><span class="ident" id="5291134">OpWordBoundary</span><span class="op" id="5291148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291155">t</span>&nbsp;<span class="op" id="5291157">=</span>&nbsp;<span class="ident" id="5291159">t</span><span class="op" id="5291160">[</span><span class="num" id="5291161">2</span><span class="op" id="5291162">:</span><span class="op" id="5291163">]</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291170">break</span>&nbsp;<span class="ident" id="5291176">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291190">case</span>&nbsp;<span class="string" id="5291195">&#39;B&#39;</span><span class="op" id="5291198">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291205">p</span><span class="op" id="5291206">.</span><span class="ident" id="5291207">op</span><span class="op" id="5291209">(</span><span class="ident" id="5291210">OpNoWordBoundary</span><span class="op" id="5291226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291233">t</span>&nbsp;<span class="op" id="5291235">=</span>&nbsp;<span class="ident" id="5291237">t</span><span class="op" id="5291238">[</span><span class="num" id="5291239">2</span><span class="op" id="5291240">:</span><span class="op" id="5291241">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291248">break</span>&nbsp;<span class="ident" id="5291254">BigSwitch</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291268">case</span>&nbsp;<span class="string" id="5291273">&#39;C&#39;</span><span class="op" id="5291276">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5291283">//&nbsp;any&nbsp;byte;&nbsp;not&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291315">return</span>&nbsp;<span class="ident" id="5291322">nil</span><span class="op" id="5291325">,</span>&nbsp;<span class="op" id="5291327">&amp;</span><span class="ident" id="5291328">Error</span><span class="op" id="5291333">{</span><span class="ident" id="5291334">ErrInvalidEscape</span><span class="op" id="5291350">,</span>&nbsp;<span class="ident" id="5291352">t</span><span class="op" id="5291353">[</span><span class="op" id="5291354">:</span><span class="num" id="5291355">2</span><span class="op" id="5291356">]</span><span class="op" id="5291357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291363">case</span>&nbsp;<span class="string" id="5291368">&#39;Q&#39;</span><span class="op" id="5291371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5291378">//&nbsp;\Q&nbsp;...&nbsp;\E:&nbsp;the&nbsp;...&nbsp;is&nbsp;always&nbsp;literals</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291424">var</span>&nbsp;<span class="ident" id="5291428">lit</span>&nbsp;<span class="builtintype" id="5291432">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291444">if</span>&nbsp;<span class="ident" id="5291447">i</span>&nbsp;<span class="op" id="5291449">:=</span>&nbsp;<span class="ident" id="5291452">strings</span><span class="op" id="5291459">.</span><span class="ident" id="5291460">Index</span><span class="op" id="5291465">(</span><span class="ident" id="5291466">t</span><span class="op" id="5291467">,</span>&nbsp;<span class="string" id="5291469">`\E`</span><span class="op" id="5291473">)</span><span class="op" id="5291474">;</span>&nbsp;<span class="ident" id="5291476">i</span>&nbsp;<span class="op" id="5291478">&lt;</span>&nbsp;<span class="num" id="5291480">0</span>&nbsp;<span class="op" id="5291482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291490">lit</span>&nbsp;<span class="op" id="5291494">=</span>&nbsp;<span class="ident" id="5291496">t</span><span class="op" id="5291497">[</span><span class="num" id="5291498">2</span><span class="op" id="5291499">:</span><span class="op" id="5291500">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291508">t</span>&nbsp;<span class="op" id="5291510">=</span>&nbsp;<span class="string" id="5291512">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5291520">}</span>&nbsp;<span class="keyword" id="5291522">else</span>&nbsp;<span class="op" id="5291527">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291535">lit</span>&nbsp;<span class="op" id="5291539">=</span>&nbsp;<span class="ident" id="5291541">t</span><span class="op" id="5291542">[</span><span class="num" id="5291543">2</span><span class="op" id="5291544">:</span><span class="ident" id="5291545">i</span><span class="op" id="5291546">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291554">t</span>&nbsp;<span class="op" id="5291556">=</span>&nbsp;<span class="ident" id="5291558">t</span><span class="op" id="5291559">[</span><span class="ident" id="5291560">i</span><span class="op" id="5291561">+</span><span class="num" id="5291562">2</span><span class="op" id="5291563">:</span><span class="op" id="5291564">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5291571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291578">p</span><span class="op" id="5291579">.</span><span class="ident" id="5291580">push</span><span class="op" id="5291584">(</span><span class="ident" id="5291585">literalRegexp</span><span class="op" id="5291598">(</span><span class="ident" id="5291599">lit</span><span class="op" id="5291602">,</span>&nbsp;<span class="ident" id="5291604">p</span><span class="op" id="5291605">.</span><span class="ident" id="5291606">flags</span><span class="op" id="5291611">)</span><span class="op" id="5291612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291619">break</span>&nbsp;<span class="ident" id="5291625">BigSwitch</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291639">case</span>&nbsp;<span class="string" id="5291644">&#39;z&#39;</span><span class="op" id="5291647">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291654">p</span><span class="op" id="5291655">.</span><span class="ident" id="5291656">op</span><span class="op" id="5291658">(</span><span class="ident" id="5291659">OpEndText</span><span class="op" id="5291668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291675">t</span>&nbsp;<span class="op" id="5291677">=</span>&nbsp;<span class="ident" id="5291679">t</span><span class="op" id="5291680">[</span><span class="num" id="5291681">2</span><span class="op" id="5291682">:</span><span class="op" id="5291683">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291690">break</span>&nbsp;<span class="ident" id="5291696">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5291710">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5291715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291721">re</span>&nbsp;<span class="op" id="5291724">:=</span>&nbsp;<span class="ident" id="5291727">p</span><span class="op" id="5291728">.</span><span class="ident" id="5291729">newRegexp</span><span class="op" id="5291738">(</span><span class="ident" id="5291739">OpCharClass</span><span class="op" id="5291750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291755">re</span><span class="op" id="5291757">.</span><span class="ident" id="5291758">Flags</span>&nbsp;<span class="op" id="5291764">=</span>&nbsp;<span class="ident" id="5291766">p</span><span class="op" id="5291767">.</span><span class="ident" id="5291768">flags</span><br>
<span class="lineno"></span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5291778">//&nbsp;Look&nbsp;for&nbsp;Unicode&nbsp;character&nbsp;group&nbsp;like&nbsp;\p{Han}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291830">if</span>&nbsp;<span class="builtinfunc" id="5291833">len</span><span class="op" id="5291836">(</span><span class="ident" id="5291837">t</span><span class="op" id="5291838">)</span>&nbsp;<span class="op" id="5291840">&gt;=</span>&nbsp;<span class="num" id="5291843">2</span>&nbsp;<span class="op" id="5291845">&amp;&amp;</span>&nbsp;<span class="op" id="5291848">(</span><span class="ident" id="5291849">t</span><span class="op" id="5291850">[</span><span class="num" id="5291851">1</span><span class="op" id="5291852">]</span>&nbsp;<span class="op" id="5291854">==</span>&nbsp;<span class="string" id="5291857">&#39;p&#39;</span>&nbsp;<span class="op" id="5291861">||</span>&nbsp;<span class="ident" id="5291864">t</span><span class="op" id="5291865">[</span><span class="num" id="5291866">1</span><span class="op" id="5291867">]</span>&nbsp;<span class="op" id="5291869">==</span>&nbsp;<span class="string" id="5291872">&#39;P&#39;</span><span class="op" id="5291875">)</span>&nbsp;<span class="op" id="5291877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5291883">r</span><span class="op" id="5291884">,</span>&nbsp;<span class="ident" id="5291886">rest</span><span class="op" id="5291890">,</span>&nbsp;<span class="ident" id="5291892">err</span>&nbsp;<span class="op" id="5291896">:=</span>&nbsp;<span class="ident" id="5291899">p</span><span class="op" id="5291900">.</span><span class="ident" id="5291901">parseUnicodeClass</span><span class="op" id="5291918">(</span><span class="ident" id="5291919">t</span><span class="op" id="5291920">,</span>&nbsp;<span class="ident" id="5291922">re</span><span class="op" id="5291924">.</span><span class="ident" id="5291925">Rune0</span><span class="op" id="5291930">[</span><span class="op" id="5291931">:</span><span class="num" id="5291932">0</span><span class="op" id="5291933">]</span><span class="op" id="5291934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291940">if</span>&nbsp;<span class="ident" id="5291943">err</span>&nbsp;<span class="op" id="5291947">!=</span>&nbsp;<span class="ident" id="5291950">nil</span>&nbsp;<span class="op" id="5291954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291961">return</span>&nbsp;<span class="ident" id="5291968">nil</span><span class="op" id="5291971">,</span>&nbsp;<span class="ident" id="5291973">err</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5291981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5291987">if</span>&nbsp;<span class="ident" id="5291990">r</span>&nbsp;<span class="op" id="5291992">!=</span>&nbsp;<span class="ident" id="5291995">nil</span>&nbsp;<span class="op" id="5291999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292006">re</span><span class="op" id="5292008">.</span><span class="ident" id="5292009">Rune</span>&nbsp;<span class="op" id="5292014">=</span>&nbsp;<span class="ident" id="5292016">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292023">t</span>&nbsp;<span class="op" id="5292025">=</span>&nbsp;<span class="ident" id="5292027">rest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292037">p</span><span class="op" id="5292038">.</span><span class="ident" id="5292039">push</span><span class="op" id="5292043">(</span><span class="ident" id="5292044">re</span><span class="op" id="5292046">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292053">break</span>&nbsp;<span class="ident" id="5292059">BigSwitch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5292073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5292078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5292084">//&nbsp;Perl&nbsp;character&nbsp;class&nbsp;escape.</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292119">if</span>&nbsp;<span class="ident" id="5292122">r</span><span class="op" id="5292123">,</span>&nbsp;<span class="ident" id="5292125">rest</span>&nbsp;<span class="op" id="5292130">:=</span>&nbsp;<span class="ident" id="5292133">p</span><span class="op" id="5292134">.</span><span class="ident" id="5292135">parsePerlClassEscape</span><span class="op" id="5292155">(</span><span class="ident" id="5292156">t</span><span class="op" id="5292157">,</span>&nbsp;<span class="ident" id="5292159">re</span><span class="op" id="5292161">.</span><span class="ident" id="5292162">Rune0</span><span class="op" id="5292167">[</span><span class="op" id="5292168">:</span><span class="num" id="5292169">0</span><span class="op" id="5292170">]</span><span class="op" id="5292171">)</span><span class="op" id="5292172">;</span>&nbsp;<span class="ident" id="5292174">r</span>&nbsp;<span class="op" id="5292176">!=</span>&nbsp;<span class="ident" id="5292179">nil</span>&nbsp;<span class="op" id="5292183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292189">re</span><span class="op" id="5292191">.</span><span class="ident" id="5292192">Rune</span>&nbsp;<span class="op" id="5292197">=</span>&nbsp;<span class="ident" id="5292199">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292205">t</span>&nbsp;<span class="op" id="5292207">=</span>&nbsp;<span class="ident" id="5292209">rest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292218">p</span><span class="op" id="5292219">.</span><span class="ident" id="5292220">push</span><span class="op" id="5292224">(</span><span class="ident" id="5292225">re</span><span class="op" id="5292227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292233">break</span>&nbsp;<span class="ident" id="5292239">BigSwitch</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5292252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292257">p</span><span class="op" id="5292258">.</span><span class="ident" id="5292259">reuse</span><span class="op" id="5292264">(</span><span class="ident" id="5292265">re</span><span class="op" id="5292267">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5292273">//&nbsp;Ordinary&nbsp;single-character&nbsp;escape.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292313">if</span>&nbsp;<span class="ident" id="5292316">c</span><span class="op" id="5292317">,</span>&nbsp;<span class="ident" id="5292319">t</span><span class="op" id="5292320">,</span>&nbsp;<span class="ident" id="5292322">err</span>&nbsp;<span class="op" id="5292326">=</span>&nbsp;<span class="ident" id="5292328">p</span><span class="op" id="5292329">.</span><span class="ident" id="5292330">parseEscape</span><span class="op" id="5292341">(</span><span class="ident" id="5292342">t</span><span class="op" id="5292343">)</span><span class="op" id="5292344">;</span>&nbsp;<span class="ident" id="5292346">err</span>&nbsp;<span class="op" id="5292350">!=</span>&nbsp;<span class="ident" id="5292353">nil</span>&nbsp;<span class="op" id="5292357">{</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292363">return</span>&nbsp;<span class="ident" id="5292370">nil</span><span class="op" id="5292373">,</span>&nbsp;<span class="ident" id="5292375">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5292382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292387">p</span><span class="op" id="5292388">.</span><span class="ident" id="5292389">literal</span><span class="op" id="5292396">(</span><span class="ident" id="5292397">c</span><span class="op" id="5292398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5292402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292406">lastRepeat</span>&nbsp;<span class="op" id="5292417">=</span>&nbsp;<span class="ident" id="5292419">repeat</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5292427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292431">p</span><span class="op" id="5292432">.</span><span class="ident" id="5292433">concat</span><span class="op" id="5292439">(</span><span class="op" id="5292440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292443">if</span>&nbsp;<span class="ident" id="5292446">p</span><span class="op" id="5292447">.</span><span class="ident" id="5292448">swapVerticalBar</span><span class="op" id="5292463">(</span><span class="op" id="5292464">)</span>&nbsp;<span class="op" id="5292466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5292470">//&nbsp;pop&nbsp;vertical&nbsp;bar</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292492">p</span><span class="op" id="5292493">.</span><span class="ident" id="5292494">stack</span>&nbsp;<span class="op" id="5292500">=</span>&nbsp;<span class="ident" id="5292502">p</span><span class="op" id="5292503">.</span><span class="ident" id="5292504">stack</span><span class="op" id="5292509">[</span><span class="op" id="5292510">:</span><span class="builtinfunc" id="5292511">len</span><span class="op" id="5292514">(</span><span class="ident" id="5292515">p</span><span class="op" id="5292516">.</span><span class="ident" id="5292517">stack</span><span class="op" id="5292522">)</span><span class="op" id="5292523">-</span><span class="num" id="5292524">1</span><span class="op" id="5292525">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5292528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292531">p</span><span class="op" id="5292532">.</span><span class="ident" id="5292533">alternate</span><span class="op" id="5292542">(</span><span class="op" id="5292543">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292547">n</span>&nbsp;<span class="op" id="5292549">:=</span>&nbsp;<span class="builtinfunc" id="5292552">len</span><span class="op" id="5292555">(</span><span class="ident" id="5292556">p</span><span class="op" id="5292557">.</span><span class="ident" id="5292558">stack</span><span class="op" id="5292563">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292566">if</span>&nbsp;<span class="ident" id="5292569">n</span>&nbsp;<span class="op" id="5292571">!=</span>&nbsp;<span class="num" id="5292574">1</span>&nbsp;<span class="op" id="5292576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292580">return</span>&nbsp;<span class="ident" id="5292587">nil</span><span class="op" id="5292590">,</span>&nbsp;<span class="op" id="5292592">&amp;</span><span class="ident" id="5292593">Error</span><span class="op" id="5292598">{</span><span class="ident" id="5292599">ErrMissingParen</span><span class="op" id="5292614">,</span>&nbsp;<span class="ident" id="5292616">s</span><span class="op" id="5292617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5292620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292623">return</span>&nbsp;<span class="ident" id="5292630">p</span><span class="op" id="5292631">.</span><span class="ident" id="5292632">stack</span><span class="op" id="5292637">[</span><span class="num" id="5292638">0</span><span class="op" id="5292639">]</span><span class="op" id="5292640">,</span>&nbsp;<span class="ident" id="5292642">nil</span><br>
<span class="lineno"></span><span class="op" id="5292646">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span><span class="comment" id="5292649">//&nbsp;parseRepeat&nbsp;parses&nbsp;{min}&nbsp;(max=min)&nbsp;or&nbsp;{min,}&nbsp;(max=-1)&nbsp;or&nbsp;{min,max}.</span><br>
<span class="lineno"></span><span class="comment" id="5292720">//&nbsp;If&nbsp;s&nbsp;is&nbsp;not&nbsp;of&nbsp;that&nbsp;form,&nbsp;it&nbsp;returns&nbsp;ok&nbsp;==&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="5292773">//&nbsp;If&nbsp;s&nbsp;has&nbsp;the&nbsp;right&nbsp;form&nbsp;but&nbsp;the&nbsp;values&nbsp;are&nbsp;too&nbsp;big,&nbsp;it&nbsp;returns&nbsp;min&nbsp;==&nbsp;-1,&nbsp;ok&nbsp;==&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5292862">func</span>&nbsp;<span class="op" id="5292867">(</span><span class="ident" id="5292868">p</span>&nbsp;<span class="op" id="5292870">*</span><span class="ident" id="5292871">parser</span><span class="op" id="5292877">)</span>&nbsp;<span class="ident" id="5292879">parseRepeat</span><span class="op" id="5292890">(</span><span class="ident" id="5292891">s</span>&nbsp;<span class="builtintype" id="5292893">string</span><span class="op" id="5292899">)</span>&nbsp;<span class="op" id="5292901">(</span><span class="ident" id="5292902">min</span><span class="op" id="5292905">,</span>&nbsp;<span class="ident" id="5292907">max</span>&nbsp;<span class="builtintype" id="5292911">int</span><span class="op" id="5292914">,</span>&nbsp;<span class="ident" id="5292916">rest</span>&nbsp;<span class="builtintype" id="5292921">string</span><span class="op" id="5292927">,</span>&nbsp;<span class="ident" id="5292929">ok</span>&nbsp;<span class="builtintype" id="5292932">bool</span><span class="op" id="5292936">)</span>&nbsp;<span class="op" id="5292938">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292941">if</span>&nbsp;<span class="ident" id="5292944">s</span>&nbsp;<span class="op" id="5292946">==</span>&nbsp;<span class="string" id="5292949">&#34;&#34;</span>&nbsp;<span class="op" id="5292952">||</span>&nbsp;<span class="ident" id="5292955">s</span><span class="op" id="5292956">[</span><span class="num" id="5292957">0</span><span class="op" id="5292958">]</span>&nbsp;<span class="op" id="5292960">!=</span>&nbsp;<span class="string" id="5292963">&#39;{&#39;</span>&nbsp;<span class="op" id="5292967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292971">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5292979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5292982">s</span>&nbsp;<span class="op" id="5292984">=</span>&nbsp;<span class="ident" id="5292986">s</span><span class="op" id="5292987">[</span><span class="num" id="5292988">1</span><span class="op" id="5292989">:</span><span class="op" id="5292990">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5292993">var</span>&nbsp;<span class="ident" id="5292997">ok1</span>&nbsp;<span class="builtintype" id="5293001">bool</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293007">if</span>&nbsp;<span class="ident" id="5293010">min</span><span class="op" id="5293013">,</span>&nbsp;<span class="ident" id="5293015">s</span><span class="op" id="5293016">,</span>&nbsp;<span class="ident" id="5293018">ok1</span>&nbsp;<span class="op" id="5293022">=</span>&nbsp;<span class="ident" id="5293024">p</span><span class="op" id="5293025">.</span><span class="ident" id="5293026">parseInt</span><span class="op" id="5293034">(</span><span class="ident" id="5293035">s</span><span class="op" id="5293036">)</span><span class="op" id="5293037">;</span>&nbsp;<span class="op" id="5293039">!</span><span class="ident" id="5293040">ok1</span>&nbsp;<span class="op" id="5293044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293048">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5293056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293059">if</span>&nbsp;<span class="ident" id="5293062">s</span>&nbsp;<span class="op" id="5293064">==</span>&nbsp;<span class="string" id="5293067">&#34;&#34;</span>&nbsp;<span class="op" id="5293070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293074">return</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5293082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293085">if</span>&nbsp;<span class="ident" id="5293088">s</span><span class="op" id="5293089">[</span><span class="num" id="5293090">0</span><span class="op" id="5293091">]</span>&nbsp;<span class="op" id="5293093">!=</span>&nbsp;<span class="string" id="5293096">&#39;,&#39;</span>&nbsp;<span class="op" id="5293100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5293104">max</span>&nbsp;<span class="op" id="5293108">=</span>&nbsp;<span class="ident" id="5293110">min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5293115">}</span>&nbsp;<span class="keyword" id="5293117">else</span>&nbsp;<span class="op" id="5293122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5293126">s</span>&nbsp;<span class="op" id="5293128">=</span>&nbsp;<span class="ident" id="5293130">s</span><span class="op" id="5293131">[</span><span class="num" id="5293132">1</span><span class="op" id="5293133">:</span><span class="op" id="5293134">]</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293138">if</span>&nbsp;<span class="ident" id="5293141">s</span>&nbsp;<span class="op" id="5293143">==</span>&nbsp;<span class="string" id="5293146">&#34;&#34;</span>&nbsp;<span class="op" id="5293149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293154">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5293163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293167">if</span>&nbsp;<span class="ident" id="5293170">s</span><span class="op" id="5293171">[</span><span class="num" id="5293172">0</span><span class="op" id="5293173">]</span>&nbsp;<span class="op" id="5293175">==</span>&nbsp;<span class="string" id="5293178">&#39;}&#39;</span>&nbsp;<span class="op" id="5293182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5293187">max</span>&nbsp;<span class="op" id="5293191">=</span>&nbsp;<span class="op" id="5293193">-</span><span class="num" id="5293194">1</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5293198">}</span>&nbsp;<span class="keyword" id="5293200">else</span>&nbsp;<span class="keyword" id="5293205">if</span>&nbsp;<span class="ident" id="5293208">max</span><span class="op" id="5293211">,</span>&nbsp;<span class="ident" id="5293213">s</span><span class="op" id="5293214">,</span>&nbsp;<span class="ident" id="5293216">ok1</span>&nbsp;<span class="op" id="5293220">=</span>&nbsp;<span class="ident" id="5293222">p</span><span class="op" id="5293223">.</span><span class="ident" id="5293224">parseInt</span><span class="op" id="5293232">(</span><span class="ident" id="5293233">s</span><span class="op" id="5293234">)</span><span class="op" id="5293235">;</span>&nbsp;<span class="op" id="5293237">!</span><span class="ident" id="5293238">ok1</span>&nbsp;<span class="op" id="5293242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293247">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5293256">}</span>&nbsp;<span class="keyword" id="5293258">else</span>&nbsp;<span class="keyword" id="5293263">if</span>&nbsp;<span class="ident" id="5293266">max</span>&nbsp;<span class="op" id="5293270">&lt;</span>&nbsp;<span class="num" id="5293272">0</span>&nbsp;<span class="op" id="5293274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5293279">//&nbsp;parseInt&nbsp;found&nbsp;too&nbsp;big&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5293317">min</span>&nbsp;<span class="op" id="5293321">=</span>&nbsp;<span class="op" id="5293323">-</span><span class="num" id="5293324">1</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5293328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5293331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293334">if</span>&nbsp;<span class="ident" id="5293337">s</span>&nbsp;<span class="op" id="5293339">==</span>&nbsp;<span class="string" id="5293342">&#34;&#34;</span>&nbsp;<span class="op" id="5293345">||</span>&nbsp;<span class="ident" id="5293348">s</span><span class="op" id="5293349">[</span><span class="num" id="5293350">0</span><span class="op" id="5293351">]</span>&nbsp;<span class="op" id="5293353">!=</span>&nbsp;<span class="string" id="5293356">&#39;}&#39;</span>&nbsp;<span class="op" id="5293360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293364">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5293372">}</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5293375">rest</span>&nbsp;<span class="op" id="5293380">=</span>&nbsp;<span class="ident" id="5293382">s</span><span class="op" id="5293383">[</span><span class="num" id="5293384">1</span><span class="op" id="5293385">:</span><span class="op" id="5293386">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5293389">ok</span>&nbsp;<span class="op" id="5293392">=</span>&nbsp;<span class="builtintype" id="5293394">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5293400">return</span><br>
<span class="lineno"></span><span class="op" id="5293407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">930</span><span class="comment" id="5293410">//&nbsp;parsePerlFlags&nbsp;parses&nbsp;a&nbsp;Perl&nbsp;flag&nbsp;setting&nbsp;or&nbsp;non-capturing&nbsp;group&nbsp;or&nbsp;both,</span><br>
<span class="lineno"></span><span class="comment" id="5293487">//&nbsp;like&nbsp;(?i)&nbsp;or&nbsp;(?:&nbsp;or&nbsp;(?i:.&nbsp;&nbsp;It&nbsp;removes&nbsp;the&nbsp;prefix&nbsp;from&nbsp;s&nbsp;and&nbsp;updates&nbsp;the&nbsp;parse&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="5293575">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;ensured&nbsp;that&nbsp;s&nbsp;begins&nbsp;with&nbsp;&#34;(?&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5293632">func</span>&nbsp;<span class="op" id="5293637">(</span><span class="ident" id="5293638">p</span>&nbsp;<span class="op" id="5293640">*</span><span class="ident" id="5293641">parser</span><span class="op" id="5293647">)</span>&nbsp;<span class="ident" id="5293649">parsePerlFlags</span><span class="op" id="5293663">(</span><span class="ident" id="5293664">s</span>&nbsp;<span class="builtintype" id="5293666">string</span><span class="op" id="5293672">)</span>&nbsp;<span class="op" id="5293674">(</span><span class="ident" id="5293675">rest</span>&nbsp;<span class="builtintype" id="5293680">string</span><span class="op" id="5293686">,</span>&nbsp;<span class="ident" id="5293688">err</span>&nbsp;<span class="builtintype" id="5293692">error</span><span class="op" id="5293697">)</span>&nbsp;<span class="op" id="5293699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5293702">t</span>&nbsp;<span class="op" id="5293704">:=</span>&nbsp;<span class="ident" id="5293707">s</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5293711">//&nbsp;Check&nbsp;for&nbsp;named&nbsp;captures,&nbsp;first&nbsp;introduced&nbsp;in&nbsp;Python&#39;s&nbsp;regexp&nbsp;library.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5293786">//&nbsp;As&nbsp;usual,&nbsp;there&nbsp;are&nbsp;three&nbsp;slightly&nbsp;different&nbsp;syntaxes:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5293845">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5293849">//&nbsp;&nbsp;&nbsp;(?P&lt;name&gt;expr)&nbsp;&nbsp;&nbsp;the&nbsp;original,&nbsp;introduced&nbsp;by&nbsp;Python</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5293907">//&nbsp;&nbsp;&nbsp;(?&lt;name&gt;expr)&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;.NET&nbsp;alteration,&nbsp;adopted&nbsp;by&nbsp;Perl&nbsp;5.10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5293972">//&nbsp;&nbsp;&nbsp;(?&#39;name&#39;expr)&nbsp;&nbsp;&nbsp;&nbsp;another&nbsp;.NET&nbsp;alteration,&nbsp;adopted&nbsp;by&nbsp;Perl&nbsp;5.10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5294041">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5294045">//&nbsp;Perl&nbsp;5.10&nbsp;gave&nbsp;in&nbsp;and&nbsp;implemented&nbsp;the&nbsp;Python&nbsp;version&nbsp;too,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5294107">//&nbsp;but&nbsp;they&nbsp;claim&nbsp;that&nbsp;the&nbsp;last&nbsp;two&nbsp;are&nbsp;the&nbsp;preferred&nbsp;forms.</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5294169">//&nbsp;PCRE&nbsp;and&nbsp;languages&nbsp;based&nbsp;on&nbsp;it&nbsp;(specifically,&nbsp;PHP&nbsp;and&nbsp;Ruby)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5294233">//&nbsp;support&nbsp;all&nbsp;three&nbsp;as&nbsp;well.&nbsp;&nbsp;EcmaScript&nbsp;4&nbsp;uses&nbsp;only&nbsp;the&nbsp;Python&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5294305">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5294309">//&nbsp;In&nbsp;both&nbsp;the&nbsp;open&nbsp;source&nbsp;world&nbsp;(via&nbsp;Code&nbsp;Search)&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5294369">//&nbsp;Google&nbsp;source&nbsp;tree,&nbsp;(?P&lt;expr&gt;name)&nbsp;is&nbsp;the&nbsp;dominant&nbsp;form,</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5294430">//&nbsp;so&nbsp;that&#39;s&nbsp;the&nbsp;one&nbsp;we&nbsp;implement.&nbsp;&nbsp;One&nbsp;is&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5294482">if</span>&nbsp;<span class="builtinfunc" id="5294485">len</span><span class="op" id="5294488">(</span><span class="ident" id="5294489">t</span><span class="op" id="5294490">)</span>&nbsp;<span class="op" id="5294492">&gt;</span>&nbsp;<span class="num" id="5294494">4</span>&nbsp;<span class="op" id="5294496">&amp;&amp;</span>&nbsp;<span class="ident" id="5294499">t</span><span class="op" id="5294500">[</span><span class="num" id="5294501">2</span><span class="op" id="5294502">]</span>&nbsp;<span class="op" id="5294504">==</span>&nbsp;<span class="string" id="5294507">&#39;P&#39;</span>&nbsp;<span class="op" id="5294511">&amp;&amp;</span>&nbsp;<span class="ident" id="5294514">t</span><span class="op" id="5294515">[</span><span class="num" id="5294516">3</span><span class="op" id="5294517">]</span>&nbsp;<span class="op" id="5294519">==</span>&nbsp;<span class="string" id="5294522">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5294526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5294530">//&nbsp;Pull&nbsp;out&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5294550">end</span>&nbsp;<span class="op" id="5294554">:=</span>&nbsp;<span class="ident" id="5294557">strings</span><span class="op" id="5294564">.</span><span class="ident" id="5294565">IndexRune</span><span class="op" id="5294574">(</span><span class="ident" id="5294575">t</span><span class="op" id="5294576">,</span>&nbsp;<span class="string" id="5294578">&#39;&gt;&#39;</span><span class="op" id="5294581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5294585">if</span>&nbsp;<span class="ident" id="5294588">end</span>&nbsp;<span class="op" id="5294592">&lt;</span>&nbsp;<span class="num" id="5294594">0</span>&nbsp;<span class="op" id="5294596">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5294601">if</span>&nbsp;<span class="ident" id="5294604">err</span>&nbsp;<span class="op" id="5294608">=</span>&nbsp;<span class="ident" id="5294610">checkUTF8</span><span class="op" id="5294619">(</span><span class="ident" id="5294620">t</span><span class="op" id="5294621">)</span><span class="op" id="5294622">;</span>&nbsp;<span class="ident" id="5294624">err</span>&nbsp;<span class="op" id="5294628">!=</span>&nbsp;<span class="ident" id="5294631">nil</span>&nbsp;<span class="op" id="5294635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5294641">return</span>&nbsp;<span class="string" id="5294648">&#34;&#34;</span><span class="op" id="5294650">,</span>&nbsp;<span class="ident" id="5294652">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5294659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5294664">return</span>&nbsp;<span class="string" id="5294671">&#34;&#34;</span><span class="op" id="5294673">,</span>&nbsp;<span class="op" id="5294675">&amp;</span><span class="ident" id="5294676">Error</span><span class="op" id="5294681">{</span><span class="ident" id="5294682">ErrInvalidNamedCapture</span><span class="op" id="5294704">,</span>&nbsp;<span class="ident" id="5294706">s</span><span class="op" id="5294707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5294711">}</span><br>
<span class="lineno">960</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5294716">capture</span>&nbsp;<span class="op" id="5294724">:=</span>&nbsp;<span class="ident" id="5294727">t</span><span class="op" id="5294728">[</span><span class="op" id="5294729">:</span><span class="ident" id="5294730">end</span><span class="op" id="5294733">+</span><span class="num" id="5294734">1</span><span class="op" id="5294735">]</span>&nbsp;<span class="comment" id="5294737">//&nbsp;&#34;(?P&lt;name&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5294754">name</span>&nbsp;<span class="op" id="5294759">:=</span>&nbsp;<span class="ident" id="5294762">t</span><span class="op" id="5294763">[</span><span class="num" id="5294764">4</span><span class="op" id="5294765">:</span><span class="ident" id="5294766">end</span><span class="op" id="5294769">]</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5294775">//&nbsp;&#34;name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5294787">if</span>&nbsp;<span class="ident" id="5294790">err</span>&nbsp;<span class="op" id="5294794">=</span>&nbsp;<span class="ident" id="5294796">checkUTF8</span><span class="op" id="5294805">(</span><span class="ident" id="5294806">name</span><span class="op" id="5294810">)</span><span class="op" id="5294811">;</span>&nbsp;<span class="ident" id="5294813">err</span>&nbsp;<span class="op" id="5294817">!=</span>&nbsp;<span class="ident" id="5294820">nil</span>&nbsp;<span class="op" id="5294824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5294829">return</span>&nbsp;<span class="string" id="5294836">&#34;&#34;</span><span class="op" id="5294838">,</span>&nbsp;<span class="ident" id="5294840">err</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5294846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5294850">if</span>&nbsp;<span class="op" id="5294853">!</span><span class="ident" id="5294854">isValidCaptureName</span><span class="op" id="5294872">(</span><span class="ident" id="5294873">name</span><span class="op" id="5294877">)</span>&nbsp;<span class="op" id="5294879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5294884">return</span>&nbsp;<span class="string" id="5294891">&#34;&#34;</span><span class="op" id="5294893">,</span>&nbsp;<span class="op" id="5294895">&amp;</span><span class="ident" id="5294896">Error</span><span class="op" id="5294901">{</span><span class="ident" id="5294902">ErrInvalidNamedCapture</span><span class="op" id="5294924">,</span>&nbsp;<span class="ident" id="5294926">capture</span><span class="op" id="5294933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5294937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5294942">//&nbsp;Like&nbsp;ordinary&nbsp;capture,&nbsp;but&nbsp;named.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5294981">p</span><span class="op" id="5294982">.</span><span class="ident" id="5294983">numCap</span><span class="op" id="5294989">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5294994">re</span>&nbsp;<span class="op" id="5294997">:=</span>&nbsp;<span class="ident" id="5295000">p</span><span class="op" id="5295001">.</span><span class="ident" id="5295002">op</span><span class="op" id="5295004">(</span><span class="ident" id="5295005">opLeftParen</span><span class="op" id="5295016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295020">re</span><span class="op" id="5295022">.</span><span class="ident" id="5295023">Cap</span>&nbsp;<span class="op" id="5295027">=</span>&nbsp;<span class="ident" id="5295029">p</span><span class="op" id="5295030">.</span><span class="ident" id="5295031">numCap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295040">re</span><span class="op" id="5295042">.</span><span class="ident" id="5295043">Name</span>&nbsp;<span class="op" id="5295048">=</span>&nbsp;<span class="ident" id="5295050">name</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295057">return</span>&nbsp;<span class="ident" id="5295064">t</span><span class="op" id="5295065">[</span><span class="ident" id="5295066">end</span><span class="op" id="5295069">+</span><span class="num" id="5295070">1</span><span class="op" id="5295071">:</span><span class="op" id="5295072">]</span><span class="op" id="5295073">,</span>&nbsp;<span class="ident" id="5295075">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5295080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5295084">//&nbsp;Non-capturing&nbsp;group.&nbsp;&nbsp;Might&nbsp;also&nbsp;twiddle&nbsp;Perl&nbsp;flags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295141">var</span>&nbsp;<span class="ident" id="5295145">c</span>&nbsp;<span class="builtintype" id="5295147">rune</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295153">t</span>&nbsp;<span class="op" id="5295155">=</span>&nbsp;<span class="ident" id="5295157">t</span><span class="op" id="5295158">[</span><span class="num" id="5295159">2</span><span class="op" id="5295160">:</span><span class="op" id="5295161">]</span>&nbsp;<span class="comment" id="5295163">//&nbsp;skip&nbsp;(?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295175">flags</span>&nbsp;<span class="op" id="5295181">:=</span>&nbsp;<span class="ident" id="5295184">p</span><span class="op" id="5295185">.</span><span class="ident" id="5295186">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295193">sign</span>&nbsp;<span class="op" id="5295198">:=</span>&nbsp;<span class="op" id="5295201">+</span><span class="num" id="5295202">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295205">sawFlag</span>&nbsp;<span class="op" id="5295213">:=</span>&nbsp;<span class="builtintype" id="5295216">false</span><br>
<span class="lineno"></span><span class="ident" id="5295222">Loop</span><span class="op" id="5295226">:</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295229">for</span>&nbsp;<span class="ident" id="5295233">t</span>&nbsp;<span class="op" id="5295235">!=</span>&nbsp;<span class="string" id="5295238">&#34;&#34;</span>&nbsp;<span class="op" id="5295241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295245">if</span>&nbsp;<span class="ident" id="5295248">c</span><span class="op" id="5295249">,</span>&nbsp;<span class="ident" id="5295251">t</span><span class="op" id="5295252">,</span>&nbsp;<span class="ident" id="5295254">err</span>&nbsp;<span class="op" id="5295258">=</span>&nbsp;<span class="ident" id="5295260">nextRune</span><span class="op" id="5295268">(</span><span class="ident" id="5295269">t</span><span class="op" id="5295270">)</span><span class="op" id="5295271">;</span>&nbsp;<span class="ident" id="5295273">err</span>&nbsp;<span class="op" id="5295277">!=</span>&nbsp;<span class="ident" id="5295280">nil</span>&nbsp;<span class="op" id="5295284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295289">return</span>&nbsp;<span class="string" id="5295296">&#34;&#34;</span><span class="op" id="5295298">,</span>&nbsp;<span class="ident" id="5295300">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5295306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295310">switch</span>&nbsp;<span class="ident" id="5295317">c</span>&nbsp;<span class="op" id="5295319">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295323">default</span><span class="op" id="5295330">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295335">break</span>&nbsp;<span class="ident" id="5295341">Loop</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5295349">//&nbsp;Flags.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295361">case</span>&nbsp;<span class="string" id="5295366">&#39;i&#39;</span><span class="op" id="5295369">:</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295374">flags</span>&nbsp;<span class="op" id="5295380">|=</span>&nbsp;<span class="ident" id="5295383">FoldCase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295395">sawFlag</span>&nbsp;<span class="op" id="5295403">=</span>&nbsp;<span class="builtintype" id="5295405">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295412">case</span>&nbsp;<span class="string" id="5295417">&#39;m&#39;</span><span class="op" id="5295420">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295425">flags</span>&nbsp;<span class="op" id="5295431">&amp;^=</span>&nbsp;<span class="ident" id="5295435">OneLine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295446">sawFlag</span>&nbsp;<span class="op" id="5295454">=</span>&nbsp;<span class="builtintype" id="5295456">true</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295463">case</span>&nbsp;<span class="string" id="5295468">&#39;s&#39;</span><span class="op" id="5295471">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295476">flags</span>&nbsp;<span class="op" id="5295482">|=</span>&nbsp;<span class="ident" id="5295485">DotNL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295494">sawFlag</span>&nbsp;<span class="op" id="5295502">=</span>&nbsp;<span class="builtintype" id="5295504">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295511">case</span>&nbsp;<span class="string" id="5295516">&#39;U&#39;</span><span class="op" id="5295519">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295524">flags</span>&nbsp;<span class="op" id="5295530">|=</span>&nbsp;<span class="ident" id="5295533">NonGreedy</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295546">sawFlag</span>&nbsp;<span class="op" id="5295554">=</span>&nbsp;<span class="builtintype" id="5295556">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5295564">//&nbsp;Switch&nbsp;to&nbsp;negation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295589">case</span>&nbsp;<span class="string" id="5295594">&#39;-&#39;</span><span class="op" id="5295597">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295602">if</span>&nbsp;<span class="ident" id="5295605">sign</span>&nbsp;<span class="op" id="5295610">&lt;</span>&nbsp;<span class="num" id="5295612">0</span>&nbsp;<span class="op" id="5295614">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295620">break</span>&nbsp;<span class="ident" id="5295626">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5295634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295639">sign</span>&nbsp;<span class="op" id="5295644">=</span>&nbsp;<span class="op" id="5295646">-</span><span class="num" id="5295647">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5295652">//&nbsp;Invert&nbsp;flags&nbsp;so&nbsp;that&nbsp;|&nbsp;above&nbsp;turn&nbsp;into&nbsp;&amp;^&nbsp;and&nbsp;vice&nbsp;versa.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5295716">//&nbsp;We&#39;ll&nbsp;invert&nbsp;flags&nbsp;again&nbsp;before&nbsp;using&nbsp;it&nbsp;below.</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295770">flags</span>&nbsp;<span class="op" id="5295776">=</span>&nbsp;<span class="op" id="5295778">^</span><span class="ident" id="5295779">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295788">sawFlag</span>&nbsp;<span class="op" id="5295796">=</span>&nbsp;<span class="builtintype" id="5295798">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5295807">//&nbsp;End&nbsp;of&nbsp;flags,&nbsp;starting&nbsp;group&nbsp;or&nbsp;not.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295849">case</span>&nbsp;<span class="string" id="5295854">&#39;:&#39;</span><span class="op" id="5295857">,</span>&nbsp;<span class="string" id="5295859">&#39;)&#39;</span><span class="op" id="5295862">:</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295867">if</span>&nbsp;<span class="ident" id="5295870">sign</span>&nbsp;<span class="op" id="5295875">&lt;</span>&nbsp;<span class="num" id="5295877">0</span>&nbsp;<span class="op" id="5295879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295885">if</span>&nbsp;<span class="op" id="5295888">!</span><span class="ident" id="5295889">sawFlag</span>&nbsp;<span class="op" id="5295897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295904">break</span>&nbsp;<span class="ident" id="5295910">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5295919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295925">flags</span>&nbsp;<span class="op" id="5295931">=</span>&nbsp;<span class="op" id="5295933">^</span><span class="ident" id="5295934">flags</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5295943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5295948">if</span>&nbsp;<span class="ident" id="5295951">c</span>&nbsp;<span class="op" id="5295953">==</span>&nbsp;<span class="string" id="5295956">&#39;:&#39;</span>&nbsp;<span class="op" id="5295960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5295966">//&nbsp;Open&nbsp;new&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5295988">p</span><span class="op" id="5295989">.</span><span class="ident" id="5295990">op</span><span class="op" id="5295992">(</span><span class="ident" id="5295993">opLeftParen</span><span class="op" id="5296004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5296009">}</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5296014">p</span><span class="op" id="5296015">.</span><span class="ident" id="5296016">flags</span>&nbsp;<span class="op" id="5296022">=</span>&nbsp;<span class="ident" id="5296024">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296033">return</span>&nbsp;<span class="ident" id="5296040">t</span><span class="op" id="5296041">,</span>&nbsp;<span class="ident" id="5296043">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5296049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5296052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296056">return</span>&nbsp;<span class="string" id="5296063">&#34;&#34;</span><span class="op" id="5296065">,</span>&nbsp;<span class="op" id="5296067">&amp;</span><span class="ident" id="5296068">Error</span><span class="op" id="5296073">{</span><span class="ident" id="5296074">ErrInvalidPerlOp</span><span class="op" id="5296090">,</span>&nbsp;<span class="ident" id="5296092">s</span><span class="op" id="5296093">[</span><span class="op" id="5296094">:</span><span class="builtinfunc" id="5296095">len</span><span class="op" id="5296098">(</span><span class="ident" id="5296099">s</span><span class="op" id="5296100">)</span><span class="op" id="5296101">-</span><span class="builtinfunc" id="5296102">len</span><span class="op" id="5296105">(</span><span class="ident" id="5296106">t</span><span class="op" id="5296107">)</span><span class="op" id="5296108">]</span><span class="op" id="5296109">}</span><br>
<span class="lineno"></span><span class="op" id="5296111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5296114">//&nbsp;isValidCaptureName&nbsp;reports&nbsp;whether&nbsp;name</span><br>
<span class="lineno"></span><span class="comment" id="5296157">//&nbsp;is&nbsp;a&nbsp;valid&nbsp;capture&nbsp;name:&nbsp;[A-Za-z0-9_]+.</span><br>
<span class="lineno">1040</span><span class="comment" id="5296200">//&nbsp;PCRE&nbsp;limits&nbsp;names&nbsp;to&nbsp;32&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="5296234">//&nbsp;Python&nbsp;rejects&nbsp;names&nbsp;starting&nbsp;with&nbsp;digits.</span><br>
<span class="lineno"></span><span class="comment" id="5296280">//&nbsp;We&nbsp;don&#39;t&nbsp;enforce&nbsp;either&nbsp;of&nbsp;those.</span><br>
<span class="lineno"></span><span class="keyword" id="5296317">func</span>&nbsp;<span class="ident" id="5296322">isValidCaptureName</span><span class="op" id="5296340">(</span><span class="ident" id="5296341">name</span>&nbsp;<span class="builtintype" id="5296346">string</span><span class="op" id="5296352">)</span>&nbsp;<span class="builtintype" id="5296354">bool</span>&nbsp;<span class="op" id="5296359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296362">if</span>&nbsp;<span class="ident" id="5296365">name</span>&nbsp;<span class="op" id="5296370">==</span>&nbsp;<span class="string" id="5296373">&#34;&#34;</span>&nbsp;<span class="op" id="5296376">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296380">return</span>&nbsp;<span class="builtintype" id="5296387">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5296394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296397">for</span>&nbsp;<span class="ident" id="5296401">_</span><span class="op" id="5296402">,</span>&nbsp;<span class="ident" id="5296404">c</span>&nbsp;<span class="op" id="5296406">:=</span>&nbsp;<span class="keyword" id="5296409">range</span>&nbsp;<span class="ident" id="5296415">name</span>&nbsp;<span class="op" id="5296420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296424">if</span>&nbsp;<span class="ident" id="5296427">c</span>&nbsp;<span class="op" id="5296429">!=</span>&nbsp;<span class="string" id="5296432">&#39;_&#39;</span>&nbsp;<span class="op" id="5296436">&amp;&amp;</span>&nbsp;<span class="op" id="5296439">!</span><span class="ident" id="5296440">isalnum</span><span class="op" id="5296447">(</span><span class="ident" id="5296448">c</span><span class="op" id="5296449">)</span>&nbsp;<span class="op" id="5296451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296456">return</span>&nbsp;<span class="builtintype" id="5296463">false</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5296471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5296474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296477">return</span>&nbsp;<span class="builtintype" id="5296484">true</span><br>
<span class="lineno"></span><span class="op" id="5296489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span><span class="comment" id="5296492">//&nbsp;parseInt&nbsp;parses&nbsp;a&nbsp;decimal&nbsp;integer.</span><br>
<span class="lineno"></span><span class="keyword" id="5296530">func</span>&nbsp;<span class="op" id="5296535">(</span><span class="ident" id="5296536">p</span>&nbsp;<span class="op" id="5296538">*</span><span class="ident" id="5296539">parser</span><span class="op" id="5296545">)</span>&nbsp;<span class="ident" id="5296547">parseInt</span><span class="op" id="5296555">(</span><span class="ident" id="5296556">s</span>&nbsp;<span class="builtintype" id="5296558">string</span><span class="op" id="5296564">)</span>&nbsp;<span class="op" id="5296566">(</span><span class="ident" id="5296567">n</span>&nbsp;<span class="builtintype" id="5296569">int</span><span class="op" id="5296572">,</span>&nbsp;<span class="ident" id="5296574">rest</span>&nbsp;<span class="builtintype" id="5296579">string</span><span class="op" id="5296585">,</span>&nbsp;<span class="ident" id="5296587">ok</span>&nbsp;<span class="builtintype" id="5296590">bool</span><span class="op" id="5296594">)</span>&nbsp;<span class="op" id="5296596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296599">if</span>&nbsp;<span class="ident" id="5296602">s</span>&nbsp;<span class="op" id="5296604">==</span>&nbsp;<span class="string" id="5296607">&#34;&#34;</span>&nbsp;<span class="op" id="5296610">||</span>&nbsp;<span class="ident" id="5296613">s</span><span class="op" id="5296614">[</span><span class="num" id="5296615">0</span><span class="op" id="5296616">]</span>&nbsp;<span class="op" id="5296618">&lt;</span>&nbsp;<span class="string" id="5296620">&#39;0&#39;</span>&nbsp;<span class="op" id="5296624">||</span>&nbsp;<span class="string" id="5296627">&#39;9&#39;</span>&nbsp;<span class="op" id="5296631">&lt;</span>&nbsp;<span class="ident" id="5296633">s</span><span class="op" id="5296634">[</span><span class="num" id="5296635">0</span><span class="op" id="5296636">]</span>&nbsp;<span class="op" id="5296638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296642">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5296650">}</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5296653">//&nbsp;Disallow&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296681">if</span>&nbsp;<span class="builtinfunc" id="5296684">len</span><span class="op" id="5296687">(</span><span class="ident" id="5296688">s</span><span class="op" id="5296689">)</span>&nbsp;<span class="op" id="5296691">&gt;=</span>&nbsp;<span class="num" id="5296694">2</span>&nbsp;<span class="op" id="5296696">&amp;&amp;</span>&nbsp;<span class="ident" id="5296699">s</span><span class="op" id="5296700">[</span><span class="num" id="5296701">0</span><span class="op" id="5296702">]</span>&nbsp;<span class="op" id="5296704">==</span>&nbsp;<span class="string" id="5296707">&#39;0&#39;</span>&nbsp;<span class="op" id="5296711">&amp;&amp;</span>&nbsp;<span class="string" id="5296714">&#39;0&#39;</span>&nbsp;<span class="op" id="5296718">&lt;=</span>&nbsp;<span class="ident" id="5296721">s</span><span class="op" id="5296722">[</span><span class="num" id="5296723">1</span><span class="op" id="5296724">]</span>&nbsp;<span class="op" id="5296726">&amp;&amp;</span>&nbsp;<span class="ident" id="5296729">s</span><span class="op" id="5296730">[</span><span class="num" id="5296731">1</span><span class="op" id="5296732">]</span>&nbsp;<span class="op" id="5296734">&lt;=</span>&nbsp;<span class="string" id="5296737">&#39;9&#39;</span>&nbsp;<span class="op" id="5296741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296745">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5296753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5296756">t</span>&nbsp;<span class="op" id="5296758">:=</span>&nbsp;<span class="ident" id="5296761">s</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296764">for</span>&nbsp;<span class="ident" id="5296768">s</span>&nbsp;<span class="op" id="5296770">!=</span>&nbsp;<span class="string" id="5296773">&#34;&#34;</span>&nbsp;<span class="op" id="5296776">&amp;&amp;</span>&nbsp;<span class="string" id="5296779">&#39;0&#39;</span>&nbsp;<span class="op" id="5296783">&lt;=</span>&nbsp;<span class="ident" id="5296786">s</span><span class="op" id="5296787">[</span><span class="num" id="5296788">0</span><span class="op" id="5296789">]</span>&nbsp;<span class="op" id="5296791">&amp;&amp;</span>&nbsp;<span class="ident" id="5296794">s</span><span class="op" id="5296795">[</span><span class="num" id="5296796">0</span><span class="op" id="5296797">]</span>&nbsp;<span class="op" id="5296799">&lt;=</span>&nbsp;<span class="string" id="5296802">&#39;9&#39;</span>&nbsp;<span class="op" id="5296806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5296810">s</span>&nbsp;<span class="op" id="5296812">=</span>&nbsp;<span class="ident" id="5296814">s</span><span class="op" id="5296815">[</span><span class="num" id="5296816">1</span><span class="op" id="5296817">:</span><span class="op" id="5296818">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5296821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5296824">rest</span>&nbsp;<span class="op" id="5296829">=</span>&nbsp;<span class="ident" id="5296831">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5296834">ok</span>&nbsp;<span class="op" id="5296837">=</span>&nbsp;<span class="builtintype" id="5296839">true</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5296845">//&nbsp;Have&nbsp;digits,&nbsp;compute&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5296877">t</span>&nbsp;<span class="op" id="5296879">=</span>&nbsp;<span class="ident" id="5296881">t</span><span class="op" id="5296882">[</span><span class="op" id="5296883">:</span><span class="builtinfunc" id="5296884">len</span><span class="op" id="5296887">(</span><span class="ident" id="5296888">t</span><span class="op" id="5296889">)</span><span class="op" id="5296890">-</span><span class="builtinfunc" id="5296891">len</span><span class="op" id="5296894">(</span><span class="ident" id="5296895">s</span><span class="op" id="5296896">)</span><span class="op" id="5296897">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296900">for</span>&nbsp;<span class="ident" id="5296904">i</span>&nbsp;<span class="op" id="5296906">:=</span>&nbsp;<span class="num" id="5296909">0</span><span class="op" id="5296910">;</span>&nbsp;<span class="ident" id="5296912">i</span>&nbsp;<span class="op" id="5296914">&lt;</span>&nbsp;<span class="builtinfunc" id="5296916">len</span><span class="op" id="5296919">(</span><span class="ident" id="5296920">t</span><span class="op" id="5296921">)</span><span class="op" id="5296922">;</span>&nbsp;<span class="ident" id="5296924">i</span><span class="op" id="5296925">++</span>&nbsp;<span class="op" id="5296928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5296932">//&nbsp;Avoid&nbsp;overflow.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296953">if</span>&nbsp;<span class="ident" id="5296956">n</span>&nbsp;<span class="op" id="5296958">&gt;=</span>&nbsp;<span class="num" id="5296961">1e8</span>&nbsp;<span class="op" id="5296965">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5296970">n</span>&nbsp;<span class="op" id="5296972">=</span>&nbsp;<span class="op" id="5296974">-</span><span class="num" id="5296975">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5296980">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5296988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5296992">n</span>&nbsp;<span class="op" id="5296994">=</span>&nbsp;<span class="ident" id="5296996">n</span><span class="op" id="5296997">*</span><span class="num" id="5296998">10</span>&nbsp;<span class="op" id="5297001">+</span>&nbsp;<span class="builtintype" id="5297003">int</span><span class="op" id="5297006">(</span><span class="ident" id="5297007">t</span><span class="op" id="5297008">[</span><span class="ident" id="5297009">i</span><span class="op" id="5297010">]</span><span class="op" id="5297011">)</span>&nbsp;<span class="op" id="5297013">-</span>&nbsp;<span class="string" id="5297015">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5297020">}</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297023">return</span><br>
<span class="lineno"></span><span class="op" id="5297030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5297033">//&nbsp;can&nbsp;this&nbsp;be&nbsp;represented&nbsp;as&nbsp;a&nbsp;character&nbsp;class?</span><br>
<span class="lineno"></span><span class="comment" id="5297082">//&nbsp;single-rune&nbsp;literal&nbsp;string,&nbsp;char&nbsp;class,&nbsp;.,&nbsp;and&nbsp;.|\n.</span><br>
<span class="lineno">1085</span><span class="keyword" id="5297138">func</span>&nbsp;<span class="ident" id="5297143">isCharClass</span><span class="op" id="5297154">(</span><span class="ident" id="5297155">re</span>&nbsp;<span class="op" id="5297158">*</span><span class="ident" id="5297159">Regexp</span><span class="op" id="5297165">)</span>&nbsp;<span class="builtintype" id="5297167">bool</span>&nbsp;<span class="op" id="5297172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297175">return</span>&nbsp;<span class="ident" id="5297182">re</span><span class="op" id="5297184">.</span><span class="ident" id="5297185">Op</span>&nbsp;<span class="op" id="5297188">==</span>&nbsp;<span class="ident" id="5297191">OpLiteral</span>&nbsp;<span class="op" id="5297201">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5297204">len</span><span class="op" id="5297207">(</span><span class="ident" id="5297208">re</span><span class="op" id="5297210">.</span><span class="ident" id="5297211">Rune</span><span class="op" id="5297215">)</span>&nbsp;<span class="op" id="5297217">==</span>&nbsp;<span class="num" id="5297220">1</span>&nbsp;<span class="op" id="5297222">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5297227">re</span><span class="op" id="5297229">.</span><span class="ident" id="5297230">Op</span>&nbsp;<span class="op" id="5297233">==</span>&nbsp;<span class="ident" id="5297236">OpCharClass</span>&nbsp;<span class="op" id="5297248">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5297253">re</span><span class="op" id="5297255">.</span><span class="ident" id="5297256">Op</span>&nbsp;<span class="op" id="5297259">==</span>&nbsp;<span class="ident" id="5297262">OpAnyCharNotNL</span>&nbsp;<span class="op" id="5297277">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5297282">re</span><span class="op" id="5297284">.</span><span class="ident" id="5297285">Op</span>&nbsp;<span class="op" id="5297288">==</span>&nbsp;<span class="ident" id="5297291">OpAnyChar</span><br>
<span class="lineno">1090</span><span class="op" id="5297301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5297304">//&nbsp;does&nbsp;re&nbsp;match&nbsp;r?</span><br>
<span class="lineno"></span><span class="keyword" id="5297324">func</span>&nbsp;<span class="ident" id="5297329">matchRune</span><span class="op" id="5297338">(</span><span class="ident" id="5297339">re</span>&nbsp;<span class="op" id="5297342">*</span><span class="ident" id="5297343">Regexp</span><span class="op" id="5297349">,</span>&nbsp;<span class="ident" id="5297351">r</span>&nbsp;<span class="builtintype" id="5297353">rune</span><span class="op" id="5297357">)</span>&nbsp;<span class="builtintype" id="5297359">bool</span>&nbsp;<span class="op" id="5297364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297367">switch</span>&nbsp;<span class="ident" id="5297374">re</span><span class="op" id="5297376">.</span><span class="ident" id="5297377">Op</span>&nbsp;<span class="op" id="5297380">{</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297383">case</span>&nbsp;<span class="ident" id="5297388">OpLiteral</span><span class="op" id="5297397">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297401">return</span>&nbsp;<span class="builtinfunc" id="5297408">len</span><span class="op" id="5297411">(</span><span class="ident" id="5297412">re</span><span class="op" id="5297414">.</span><span class="ident" id="5297415">Rune</span><span class="op" id="5297419">)</span>&nbsp;<span class="op" id="5297421">==</span>&nbsp;<span class="num" id="5297424">1</span>&nbsp;<span class="op" id="5297426">&amp;&amp;</span>&nbsp;<span class="ident" id="5297429">re</span><span class="op" id="5297431">.</span><span class="ident" id="5297432">Rune</span><span class="op" id="5297436">[</span><span class="num" id="5297437">0</span><span class="op" id="5297438">]</span>&nbsp;<span class="op" id="5297440">==</span>&nbsp;<span class="ident" id="5297443">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297446">case</span>&nbsp;<span class="ident" id="5297451">OpCharClass</span><span class="op" id="5297462">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297466">for</span>&nbsp;<span class="ident" id="5297470">i</span>&nbsp;<span class="op" id="5297472">:=</span>&nbsp;<span class="num" id="5297475">0</span><span class="op" id="5297476">;</span>&nbsp;<span class="ident" id="5297478">i</span>&nbsp;<span class="op" id="5297480">&lt;</span>&nbsp;<span class="builtinfunc" id="5297482">len</span><span class="op" id="5297485">(</span><span class="ident" id="5297486">re</span><span class="op" id="5297488">.</span><span class="ident" id="5297489">Rune</span><span class="op" id="5297493">)</span><span class="op" id="5297494">;</span>&nbsp;<span class="ident" id="5297496">i</span>&nbsp;<span class="op" id="5297498">+=</span>&nbsp;<span class="num" id="5297501">2</span>&nbsp;<span class="op" id="5297503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297508">if</span>&nbsp;<span class="ident" id="5297511">re</span><span class="op" id="5297513">.</span><span class="ident" id="5297514">Rune</span><span class="op" id="5297518">[</span><span class="ident" id="5297519">i</span><span class="op" id="5297520">]</span>&nbsp;<span class="op" id="5297522">&lt;=</span>&nbsp;<span class="ident" id="5297525">r</span>&nbsp;<span class="op" id="5297527">&amp;&amp;</span>&nbsp;<span class="ident" id="5297530">r</span>&nbsp;<span class="op" id="5297532">&lt;=</span>&nbsp;<span class="ident" id="5297535">re</span><span class="op" id="5297537">.</span><span class="ident" id="5297538">Rune</span><span class="op" id="5297542">[</span><span class="ident" id="5297543">i</span><span class="op" id="5297544">+</span><span class="num" id="5297545">1</span><span class="op" id="5297546">]</span>&nbsp;<span class="op" id="5297548">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297554">return</span>&nbsp;<span class="builtintype" id="5297561">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5297569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5297573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297577">return</span>&nbsp;<span class="builtintype" id="5297584">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297591">case</span>&nbsp;<span class="ident" id="5297596">OpAnyCharNotNL</span><span class="op" id="5297610">:</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297614">return</span>&nbsp;<span class="ident" id="5297621">r</span>&nbsp;<span class="op" id="5297623">!=</span>&nbsp;<span class="string" id="5297626">&#39;\n&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297632">case</span>&nbsp;<span class="ident" id="5297637">OpAnyChar</span><span class="op" id="5297646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297650">return</span>&nbsp;<span class="builtintype" id="5297657">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5297663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297666">return</span>&nbsp;<span class="builtintype" id="5297673">false</span><br>
<span class="lineno">1110</span><span class="op" id="5297679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5297682">//&nbsp;parseVerticalBar&nbsp;handles&nbsp;a&nbsp;|&nbsp;in&nbsp;the&nbsp;input.</span><br>
<span class="lineno"></span><span class="keyword" id="5297728">func</span>&nbsp;<span class="op" id="5297733">(</span><span class="ident" id="5297734">p</span>&nbsp;<span class="op" id="5297736">*</span><span class="ident" id="5297737">parser</span><span class="op" id="5297743">)</span>&nbsp;<span class="ident" id="5297745">parseVerticalBar</span><span class="op" id="5297761">(</span><span class="op" id="5297762">)</span>&nbsp;<span class="builtintype" id="5297764">error</span>&nbsp;<span class="op" id="5297770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5297773">p</span><span class="op" id="5297774">.</span><span class="ident" id="5297775">concat</span><span class="op" id="5297781">(</span><span class="op" id="5297782">)</span><br>
<span class="lineno">1115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5297786">//&nbsp;The&nbsp;concatenation&nbsp;we&nbsp;just&nbsp;parsed&nbsp;is&nbsp;on&nbsp;top&nbsp;of&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5297847">//&nbsp;If&nbsp;it&nbsp;sits&nbsp;above&nbsp;an&nbsp;opVerticalBar,&nbsp;swap&nbsp;it&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5297900">//&nbsp;(things&nbsp;below&nbsp;an&nbsp;opVerticalBar&nbsp;become&nbsp;an&nbsp;alternation).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5297959">//&nbsp;Otherwise,&nbsp;push&nbsp;a&nbsp;new&nbsp;vertical&nbsp;bar.</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5297999">if</span>&nbsp;<span class="op" id="5298002">!</span><span class="ident" id="5298003">p</span><span class="op" id="5298004">.</span><span class="ident" id="5298005">swapVerticalBar</span><span class="op" id="5298020">(</span><span class="op" id="5298021">)</span>&nbsp;<span class="op" id="5298023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5298027">p</span><span class="op" id="5298028">.</span><span class="ident" id="5298029">op</span><span class="op" id="5298031">(</span><span class="ident" id="5298032">opVerticalBar</span><span class="op" id="5298045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5298048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5298052">return</span>&nbsp;<span class="ident" id="5298059">nil</span><br>
<span class="lineno">1125</span><span class="op" id="5298063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5298066">//&nbsp;mergeCharClass&nbsp;makes&nbsp;dst&nbsp;=&nbsp;dst|src.</span><br>
<span class="lineno"></span><span class="comment" id="5298105">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;ensure&nbsp;that&nbsp;dst.Op&nbsp;&gt;=&nbsp;src.Op,</span><br>
<span class="lineno"></span><span class="comment" id="5298154">//&nbsp;to&nbsp;reduce&nbsp;the&nbsp;amount&nbsp;of&nbsp;copying.</span><br>
<span class="lineno">1130</span><span class="keyword" id="5298190">func</span>&nbsp;<span class="ident" id="5298195">mergeCharClass</span><span class="op" id="5298209">(</span><span class="ident" id="5298210">dst</span><span class="op" id="5298213">,</span>&nbsp;<span class="ident" id="5298215">src</span>&nbsp;<span class="op" id="5298219">*</span><span class="ident" id="5298220">Regexp</span><span class="op" id="5298226">)</span>&nbsp;<span class="op" id="5298228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5298231">switch</span>&nbsp;<span class="ident" id="5298238">dst</span><span class="op" id="5298241">.</span><span class="ident" id="5298242">Op</span>&nbsp;<span class="op" id="5298245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5298248">case</span>&nbsp;<span class="ident" id="5298253">OpAnyChar</span><span class="op" id="5298262">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5298266">//&nbsp;src&nbsp;doesn&#39;t&nbsp;add&nbsp;anything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5298296">case</span>&nbsp;<span class="ident" id="5298301">OpAnyCharNotNL</span><span class="op" id="5298315">:</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5298319">//&nbsp;src&nbsp;might&nbsp;add&nbsp;\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5298341">if</span>&nbsp;<span class="ident" id="5298344">matchRune</span><span class="op" id="5298353">(</span><span class="ident" id="5298354">src</span><span class="op" id="5298357">,</span>&nbsp;<span class="string" id="5298359">&#39;\n&#39;</span><span class="op" id="5298363">)</span>&nbsp;<span class="op" id="5298365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5298370">dst</span><span class="op" id="5298373">.</span><span class="ident" id="5298374">Op</span>&nbsp;<span class="op" id="5298377">=</span>&nbsp;<span class="ident" id="5298379">OpAnyChar</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5298391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5298394">case</span>&nbsp;<span class="ident" id="5298399">OpCharClass</span><span class="op" id="5298410">:</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5298414">//&nbsp;src&nbsp;is&nbsp;simpler,&nbsp;so&nbsp;either&nbsp;literal&nbsp;or&nbsp;char&nbsp;class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5298467">if</span>&nbsp;<span class="ident" id="5298470">src</span><span class="op" id="5298473">.</span><span class="ident" id="5298474">Op</span>&nbsp;<span class="op" id="5298477">==</span>&nbsp;<span class="ident" id="5298480">OpLiteral</span>&nbsp;<span class="op" id="5298490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5298495">dst</span><span class="op" id="5298498">.</span><span class="ident" id="5298499">Rune</span>&nbsp;<span class="op" id="5298504">=</span>&nbsp;<span class="ident" id="5298506">appendLiteral</span><span class="op" id="5298519">(</span><span class="ident" id="5298520">dst</span><span class="op" id="5298523">.</span><span class="ident" id="5298524">Rune</span><span class="op" id="5298528">,</span>&nbsp;<span class="ident" id="5298530">src</span><span class="op" id="5298533">.</span><span class="ident" id="5298534">Rune</span><span class="op" id="5298538">[</span><span class="num" id="5298539">0</span><span class="op" id="5298540">]</span><span class="op" id="5298541">,</span>&nbsp;<span class="ident" id="5298543">src</span><span class="op" id="5298546">.</span><span class="ident" id="5298547">Flags</span><span class="op" id="5298552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5298556">}</span>&nbsp;<span class="keyword" id="5298558">else</span>&nbsp;<span class="op" id="5298563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5298568">dst</span><span class="op" id="5298571">.</span><span class="ident" id="5298572">Rune</span>&nbsp;<span class="op" id="5298577">=</span>&nbsp;<span class="ident" id="5298579">appendClass</span><span class="op" id="5298590">(</span><span class="ident" id="5298591">dst</span><span class="op" id="5298594">.</span><span class="ident" id="5298595">Rune</span><span class="op" id="5298599">,</span>&nbsp;<span class="ident" id="5298601">src</span><span class="op" id="5298604">.</span><span class="ident" id="5298605">Rune</span><span class="op" id="5298609">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5298613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5298616">case</span>&nbsp;<span class="ident" id="5298621">OpLiteral</span><span class="op" id="5298630">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5298634">//&nbsp;both&nbsp;literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5298652">if</span>&nbsp;<span class="ident" id="5298655">src</span><span class="op" id="5298658">.</span><span class="ident" id="5298659">Rune</span><span class="op" id="5298663">[</span><span class="num" id="5298664">0</span><span class="op" id="5298665">]</span>&nbsp;<span class="op" id="5298667">==</span>&nbsp;<span class="ident" id="5298670">dst</span><span class="op" id="5298673">.</span><span class="ident" id="5298674">Rune</span><span class="op" id="5298678">[</span><span class="num" id="5298679">0</span><span class="op" id="5298680">]</span>&nbsp;<span class="op" id="5298682">&amp;&amp;</span>&nbsp;<span class="ident" id="5298685">src</span><span class="op" id="5298688">.</span><span class="ident" id="5298689">Flags</span>&nbsp;<span class="op" id="5298695">==</span>&nbsp;<span class="ident" id="5298698">dst</span><span class="op" id="5298701">.</span><span class="ident" id="5298702">Flags</span>&nbsp;<span class="op" id="5298708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5298713">break</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5298721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5298725">dst</span><span class="op" id="5298728">.</span><span class="ident" id="5298729">Op</span>&nbsp;<span class="op" id="5298732">=</span>&nbsp;<span class="ident" id="5298734">OpCharClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5298748">dst</span><span class="op" id="5298751">.</span><span class="ident" id="5298752">Rune</span>&nbsp;<span class="op" id="5298757">=</span>&nbsp;<span class="ident" id="5298759">appendLiteral</span><span class="op" id="5298772">(</span><span class="ident" id="5298773">dst</span><span class="op" id="5298776">.</span><span class="ident" id="5298777">Rune</span><span class="op" id="5298781">[</span><span class="op" id="5298782">:</span><span class="num" id="5298783">0</span><span class="op" id="5298784">]</span><span class="op" id="5298785">,</span>&nbsp;<span class="ident" id="5298787">dst</span><span class="op" id="5298790">.</span><span class="ident" id="5298791">Rune</span><span class="op" id="5298795">[</span><span class="num" id="5298796">0</span><span class="op" id="5298797">]</span><span class="op" id="5298798">,</span>&nbsp;<span class="ident" id="5298800">dst</span><span class="op" id="5298803">.</span><span class="ident" id="5298804">Flags</span><span class="op" id="5298809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5298813">dst</span><span class="op" id="5298816">.</span><span class="ident" id="5298817">Rune</span>&nbsp;<span class="op" id="5298822">=</span>&nbsp;<span class="ident" id="5298824">appendLiteral</span><span class="op" id="5298837">(</span><span class="ident" id="5298838">dst</span><span class="op" id="5298841">.</span><span class="ident" id="5298842">Rune</span><span class="op" id="5298846">,</span>&nbsp;<span class="ident" id="5298848">src</span><span class="op" id="5298851">.</span><span class="ident" id="5298852">Rune</span><span class="op" id="5298856">[</span><span class="num" id="5298857">0</span><span class="op" id="5298858">]</span><span class="op" id="5298859">,</span>&nbsp;<span class="ident" id="5298861">src</span><span class="op" id="5298864">.</span><span class="ident" id="5298865">Flags</span><span class="op" id="5298870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5298873">}</span><br>
<span class="lineno">1155</span><span class="op" id="5298875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5298878">//&nbsp;If&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;stack&nbsp;is&nbsp;an&nbsp;element&nbsp;followed&nbsp;by&nbsp;an&nbsp;opVerticalBar</span><br>
<span class="lineno"></span><span class="comment" id="5298948">//&nbsp;swapVerticalBar&nbsp;swaps&nbsp;the&nbsp;two&nbsp;and&nbsp;returns&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="5298999">//&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">1160</span><span class="keyword" id="5299030">func</span>&nbsp;<span class="op" id="5299035">(</span><span class="ident" id="5299036">p</span>&nbsp;<span class="op" id="5299038">*</span><span class="ident" id="5299039">parser</span><span class="op" id="5299045">)</span>&nbsp;<span class="ident" id="5299047">swapVerticalBar</span><span class="op" id="5299062">(</span><span class="op" id="5299063">)</span>&nbsp;<span class="builtintype" id="5299065">bool</span>&nbsp;<span class="op" id="5299070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5299073">//&nbsp;If&nbsp;above&nbsp;and&nbsp;below&nbsp;vertical&nbsp;bar&nbsp;are&nbsp;literal&nbsp;or&nbsp;char&nbsp;class,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5299136">//&nbsp;can&nbsp;merge&nbsp;into&nbsp;a&nbsp;single&nbsp;char&nbsp;class.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299176">n</span>&nbsp;<span class="op" id="5299178">:=</span>&nbsp;<span class="builtinfunc" id="5299181">len</span><span class="op" id="5299184">(</span><span class="ident" id="5299185">p</span><span class="op" id="5299186">.</span><span class="ident" id="5299187">stack</span><span class="op" id="5299192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5299195">if</span>&nbsp;<span class="ident" id="5299198">n</span>&nbsp;<span class="op" id="5299200">&gt;=</span>&nbsp;<span class="num" id="5299203">3</span>&nbsp;<span class="op" id="5299205">&amp;&amp;</span>&nbsp;<span class="ident" id="5299208">p</span><span class="op" id="5299209">.</span><span class="ident" id="5299210">stack</span><span class="op" id="5299215">[</span><span class="ident" id="5299216">n</span><span class="op" id="5299217">-</span><span class="num" id="5299218">2</span><span class="op" id="5299219">]</span><span class="op" id="5299220">.</span><span class="ident" id="5299221">Op</span>&nbsp;<span class="op" id="5299224">==</span>&nbsp;<span class="ident" id="5299227">opVerticalBar</span>&nbsp;<span class="op" id="5299241">&amp;&amp;</span>&nbsp;<span class="ident" id="5299244">isCharClass</span><span class="op" id="5299255">(</span><span class="ident" id="5299256">p</span><span class="op" id="5299257">.</span><span class="ident" id="5299258">stack</span><span class="op" id="5299263">[</span><span class="ident" id="5299264">n</span><span class="op" id="5299265">-</span><span class="num" id="5299266">1</span><span class="op" id="5299267">]</span><span class="op" id="5299268">)</span>&nbsp;<span class="op" id="5299270">&amp;&amp;</span>&nbsp;<span class="ident" id="5299273">isCharClass</span><span class="op" id="5299284">(</span><span class="ident" id="5299285">p</span><span class="op" id="5299286">.</span><span class="ident" id="5299287">stack</span><span class="op" id="5299292">[</span><span class="ident" id="5299293">n</span><span class="op" id="5299294">-</span><span class="num" id="5299295">3</span><span class="op" id="5299296">]</span><span class="op" id="5299297">)</span>&nbsp;<span class="op" id="5299299">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299303">re1</span>&nbsp;<span class="op" id="5299307">:=</span>&nbsp;<span class="ident" id="5299310">p</span><span class="op" id="5299311">.</span><span class="ident" id="5299312">stack</span><span class="op" id="5299317">[</span><span class="ident" id="5299318">n</span><span class="op" id="5299319">-</span><span class="num" id="5299320">1</span><span class="op" id="5299321">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299325">re3</span>&nbsp;<span class="op" id="5299329">:=</span>&nbsp;<span class="ident" id="5299332">p</span><span class="op" id="5299333">.</span><span class="ident" id="5299334">stack</span><span class="op" id="5299339">[</span><span class="ident" id="5299340">n</span><span class="op" id="5299341">-</span><span class="num" id="5299342">3</span><span class="op" id="5299343">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5299347">//&nbsp;Make&nbsp;re3&nbsp;the&nbsp;more&nbsp;complex&nbsp;of&nbsp;the&nbsp;two.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5299390">if</span>&nbsp;<span class="ident" id="5299393">re1</span><span class="op" id="5299396">.</span><span class="ident" id="5299397">Op</span>&nbsp;<span class="op" id="5299400">&gt;</span>&nbsp;<span class="ident" id="5299402">re3</span><span class="op" id="5299405">.</span><span class="ident" id="5299406">Op</span>&nbsp;<span class="op" id="5299409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299414">re1</span><span class="op" id="5299417">,</span>&nbsp;<span class="ident" id="5299419">re3</span>&nbsp;<span class="op" id="5299423">=</span>&nbsp;<span class="ident" id="5299425">re3</span><span class="op" id="5299428">,</span>&nbsp;<span class="ident" id="5299430">re1</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299437">p</span><span class="op" id="5299438">.</span><span class="ident" id="5299439">stack</span><span class="op" id="5299444">[</span><span class="ident" id="5299445">n</span><span class="op" id="5299446">-</span><span class="num" id="5299447">3</span><span class="op" id="5299448">]</span>&nbsp;<span class="op" id="5299450">=</span>&nbsp;<span class="ident" id="5299452">re3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5299458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299462">mergeCharClass</span><span class="op" id="5299476">(</span><span class="ident" id="5299477">re3</span><span class="op" id="5299480">,</span>&nbsp;<span class="ident" id="5299482">re1</span><span class="op" id="5299485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299489">p</span><span class="op" id="5299490">.</span><span class="ident" id="5299491">reuse</span><span class="op" id="5299496">(</span><span class="ident" id="5299497">re1</span><span class="op" id="5299500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299504">p</span><span class="op" id="5299505">.</span><span class="ident" id="5299506">stack</span>&nbsp;<span class="op" id="5299512">=</span>&nbsp;<span class="ident" id="5299514">p</span><span class="op" id="5299515">.</span><span class="ident" id="5299516">stack</span><span class="op" id="5299521">[</span><span class="op" id="5299522">:</span><span class="ident" id="5299523">n</span><span class="op" id="5299524">-</span><span class="num" id="5299525">1</span><span class="op" id="5299526">]</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5299530">return</span>&nbsp;<span class="builtintype" id="5299537">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5299543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5299547">if</span>&nbsp;<span class="ident" id="5299550">n</span>&nbsp;<span class="op" id="5299552">&gt;=</span>&nbsp;<span class="num" id="5299555">2</span>&nbsp;<span class="op" id="5299557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299561">re1</span>&nbsp;<span class="op" id="5299565">:=</span>&nbsp;<span class="ident" id="5299568">p</span><span class="op" id="5299569">.</span><span class="ident" id="5299570">stack</span><span class="op" id="5299575">[</span><span class="ident" id="5299576">n</span><span class="op" id="5299577">-</span><span class="num" id="5299578">1</span><span class="op" id="5299579">]</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299583">re2</span>&nbsp;<span class="op" id="5299587">:=</span>&nbsp;<span class="ident" id="5299590">p</span><span class="op" id="5299591">.</span><span class="ident" id="5299592">stack</span><span class="op" id="5299597">[</span><span class="ident" id="5299598">n</span><span class="op" id="5299599">-</span><span class="num" id="5299600">2</span><span class="op" id="5299601">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5299605">if</span>&nbsp;<span class="ident" id="5299608">re2</span><span class="op" id="5299611">.</span><span class="ident" id="5299612">Op</span>&nbsp;<span class="op" id="5299615">==</span>&nbsp;<span class="ident" id="5299618">opVerticalBar</span>&nbsp;<span class="op" id="5299632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5299637">if</span>&nbsp;<span class="ident" id="5299640">n</span>&nbsp;<span class="op" id="5299642">&gt;=</span>&nbsp;<span class="num" id="5299645">3</span>&nbsp;<span class="op" id="5299647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5299653">//&nbsp;Now&nbsp;out&nbsp;of&nbsp;reach.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5299678">//&nbsp;Clean&nbsp;opportunistically.</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299710">cleanAlt</span><span class="op" id="5299718">(</span><span class="ident" id="5299719">p</span><span class="op" id="5299720">.</span><span class="ident" id="5299721">stack</span><span class="op" id="5299726">[</span><span class="ident" id="5299727">n</span><span class="op" id="5299728">-</span><span class="num" id="5299729">3</span><span class="op" id="5299730">]</span><span class="op" id="5299731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5299736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299741">p</span><span class="op" id="5299742">.</span><span class="ident" id="5299743">stack</span><span class="op" id="5299748">[</span><span class="ident" id="5299749">n</span><span class="op" id="5299750">-</span><span class="num" id="5299751">2</span><span class="op" id="5299752">]</span>&nbsp;<span class="op" id="5299754">=</span>&nbsp;<span class="ident" id="5299756">re1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299763">p</span><span class="op" id="5299764">.</span><span class="ident" id="5299765">stack</span><span class="op" id="5299770">[</span><span class="ident" id="5299771">n</span><span class="op" id="5299772">-</span><span class="num" id="5299773">1</span><span class="op" id="5299774">]</span>&nbsp;<span class="op" id="5299776">=</span>&nbsp;<span class="ident" id="5299778">re2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5299785">return</span>&nbsp;<span class="builtintype" id="5299792">true</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5299799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5299802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5299805">return</span>&nbsp;<span class="builtintype" id="5299812">false</span><br>
<span class="lineno"></span><span class="op" id="5299818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span><span class="comment" id="5299821">//&nbsp;parseRightParen&nbsp;handles&nbsp;a&nbsp;)&nbsp;in&nbsp;the&nbsp;input.</span><br>
<span class="lineno"></span><span class="keyword" id="5299866">func</span>&nbsp;<span class="op" id="5299871">(</span><span class="ident" id="5299872">p</span>&nbsp;<span class="op" id="5299874">*</span><span class="ident" id="5299875">parser</span><span class="op" id="5299881">)</span>&nbsp;<span class="ident" id="5299883">parseRightParen</span><span class="op" id="5299898">(</span><span class="op" id="5299899">)</span>&nbsp;<span class="builtintype" id="5299901">error</span>&nbsp;<span class="op" id="5299907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299910">p</span><span class="op" id="5299911">.</span><span class="ident" id="5299912">concat</span><span class="op" id="5299918">(</span><span class="op" id="5299919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5299922">if</span>&nbsp;<span class="ident" id="5299925">p</span><span class="op" id="5299926">.</span><span class="ident" id="5299927">swapVerticalBar</span><span class="op" id="5299942">(</span><span class="op" id="5299943">)</span>&nbsp;<span class="op" id="5299945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5299949">//&nbsp;pop&nbsp;vertical&nbsp;bar</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5299971">p</span><span class="op" id="5299972">.</span><span class="ident" id="5299973">stack</span>&nbsp;<span class="op" id="5299979">=</span>&nbsp;<span class="ident" id="5299981">p</span><span class="op" id="5299982">.</span><span class="ident" id="5299983">stack</span><span class="op" id="5299988">[</span><span class="op" id="5299989">:</span><span class="builtinfunc" id="5299990">len</span><span class="op" id="5299993">(</span><span class="ident" id="5299994">p</span><span class="op" id="5299995">.</span><span class="ident" id="5299996">stack</span><span class="op" id="5300001">)</span><span class="op" id="5300002">-</span><span class="num" id="5300003">1</span><span class="op" id="5300004">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5300007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300010">p</span><span class="op" id="5300011">.</span><span class="ident" id="5300012">alternate</span><span class="op" id="5300021">(</span><span class="op" id="5300022">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300026">n</span>&nbsp;<span class="op" id="5300028">:=</span>&nbsp;<span class="builtinfunc" id="5300031">len</span><span class="op" id="5300034">(</span><span class="ident" id="5300035">p</span><span class="op" id="5300036">.</span><span class="ident" id="5300037">stack</span><span class="op" id="5300042">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300045">if</span>&nbsp;<span class="ident" id="5300048">n</span>&nbsp;<span class="op" id="5300050">&lt;</span>&nbsp;<span class="num" id="5300052">2</span>&nbsp;<span class="op" id="5300054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300058">return</span>&nbsp;<span class="op" id="5300065">&amp;</span><span class="ident" id="5300066">Error</span><span class="op" id="5300071">{</span><span class="ident" id="5300072">ErrUnexpectedParen</span><span class="op" id="5300090">,</span>&nbsp;<span class="ident" id="5300092">p</span><span class="op" id="5300093">.</span><span class="ident" id="5300094">wholeRegexp</span><span class="op" id="5300105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5300108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300111">re1</span>&nbsp;<span class="op" id="5300115">:=</span>&nbsp;<span class="ident" id="5300118">p</span><span class="op" id="5300119">.</span><span class="ident" id="5300120">stack</span><span class="op" id="5300125">[</span><span class="ident" id="5300126">n</span><span class="op" id="5300127">-</span><span class="num" id="5300128">1</span><span class="op" id="5300129">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300132">re2</span>&nbsp;<span class="op" id="5300136">:=</span>&nbsp;<span class="ident" id="5300139">p</span><span class="op" id="5300140">.</span><span class="ident" id="5300141">stack</span><span class="op" id="5300146">[</span><span class="ident" id="5300147">n</span><span class="op" id="5300148">-</span><span class="num" id="5300149">2</span><span class="op" id="5300150">]</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300153">p</span><span class="op" id="5300154">.</span><span class="ident" id="5300155">stack</span>&nbsp;<span class="op" id="5300161">=</span>&nbsp;<span class="ident" id="5300163">p</span><span class="op" id="5300164">.</span><span class="ident" id="5300165">stack</span><span class="op" id="5300170">[</span><span class="op" id="5300171">:</span><span class="ident" id="5300172">n</span><span class="op" id="5300173">-</span><span class="num" id="5300174">2</span><span class="op" id="5300175">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300178">if</span>&nbsp;<span class="ident" id="5300181">re2</span><span class="op" id="5300184">.</span><span class="ident" id="5300185">Op</span>&nbsp;<span class="op" id="5300188">!=</span>&nbsp;<span class="ident" id="5300191">opLeftParen</span>&nbsp;<span class="op" id="5300203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300207">return</span>&nbsp;<span class="op" id="5300214">&amp;</span><span class="ident" id="5300215">Error</span><span class="op" id="5300220">{</span><span class="ident" id="5300221">ErrUnexpectedParen</span><span class="op" id="5300239">,</span>&nbsp;<span class="ident" id="5300241">p</span><span class="op" id="5300242">.</span><span class="ident" id="5300243">wholeRegexp</span><span class="op" id="5300254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5300257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5300260">//&nbsp;Restore&nbsp;flags&nbsp;at&nbsp;time&nbsp;of&nbsp;paren.</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300296">p</span><span class="op" id="5300297">.</span><span class="ident" id="5300298">flags</span>&nbsp;<span class="op" id="5300304">=</span>&nbsp;<span class="ident" id="5300306">re2</span><span class="op" id="5300309">.</span><span class="ident" id="5300310">Flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300317">if</span>&nbsp;<span class="ident" id="5300320">re2</span><span class="op" id="5300323">.</span><span class="ident" id="5300324">Cap</span>&nbsp;<span class="op" id="5300328">==</span>&nbsp;<span class="num" id="5300331">0</span>&nbsp;<span class="op" id="5300333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5300337">//&nbsp;Just&nbsp;for&nbsp;grouping.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300361">p</span><span class="op" id="5300362">.</span><span class="ident" id="5300363">push</span><span class="op" id="5300367">(</span><span class="ident" id="5300368">re1</span><span class="op" id="5300371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5300374">}</span>&nbsp;<span class="keyword" id="5300376">else</span>&nbsp;<span class="op" id="5300381">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300385">re2</span><span class="op" id="5300388">.</span><span class="ident" id="5300389">Op</span>&nbsp;<span class="op" id="5300392">=</span>&nbsp;<span class="ident" id="5300394">OpCapture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300406">re2</span><span class="op" id="5300409">.</span><span class="ident" id="5300410">Sub</span>&nbsp;<span class="op" id="5300414">=</span>&nbsp;<span class="ident" id="5300416">re2</span><span class="op" id="5300419">.</span><span class="ident" id="5300420">Sub0</span><span class="op" id="5300424">[</span><span class="op" id="5300425">:</span><span class="num" id="5300426">1</span><span class="op" id="5300427">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300431">re2</span><span class="op" id="5300434">.</span><span class="ident" id="5300435">Sub</span><span class="op" id="5300438">[</span><span class="num" id="5300439">0</span><span class="op" id="5300440">]</span>&nbsp;<span class="op" id="5300442">=</span>&nbsp;<span class="ident" id="5300444">re1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300450">p</span><span class="op" id="5300451">.</span><span class="ident" id="5300452">push</span><span class="op" id="5300456">(</span><span class="ident" id="5300457">re2</span><span class="op" id="5300460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5300463">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300466">return</span>&nbsp;<span class="ident" id="5300473">nil</span><br>
<span class="lineno"></span><span class="op" id="5300477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5300480">//&nbsp;parseEscape&nbsp;parses&nbsp;an&nbsp;escape&nbsp;sequence&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s</span><br>
<span class="lineno"></span><span class="comment" id="5300543">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;rune.</span><br>
<span class="lineno">1230</span><span class="keyword" id="5300568">func</span>&nbsp;<span class="op" id="5300573">(</span><span class="ident" id="5300574">p</span>&nbsp;<span class="op" id="5300576">*</span><span class="ident" id="5300577">parser</span><span class="op" id="5300583">)</span>&nbsp;<span class="ident" id="5300585">parseEscape</span><span class="op" id="5300596">(</span><span class="ident" id="5300597">s</span>&nbsp;<span class="builtintype" id="5300599">string</span><span class="op" id="5300605">)</span>&nbsp;<span class="op" id="5300607">(</span><span class="ident" id="5300608">r</span>&nbsp;<span class="builtintype" id="5300610">rune</span><span class="op" id="5300614">,</span>&nbsp;<span class="ident" id="5300616">rest</span>&nbsp;<span class="builtintype" id="5300621">string</span><span class="op" id="5300627">,</span>&nbsp;<span class="ident" id="5300629">err</span>&nbsp;<span class="builtintype" id="5300633">error</span><span class="op" id="5300638">)</span>&nbsp;<span class="op" id="5300640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300643">t</span>&nbsp;<span class="op" id="5300645">:=</span>&nbsp;<span class="ident" id="5300648">s</span><span class="op" id="5300649">[</span><span class="num" id="5300650">1</span><span class="op" id="5300651">:</span><span class="op" id="5300652">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300655">if</span>&nbsp;<span class="ident" id="5300658">t</span>&nbsp;<span class="op" id="5300660">==</span>&nbsp;<span class="string" id="5300663">&#34;&#34;</span>&nbsp;<span class="op" id="5300666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300670">return</span>&nbsp;<span class="num" id="5300677">0</span><span class="op" id="5300678">,</span>&nbsp;<span class="string" id="5300680">&#34;&#34;</span><span class="op" id="5300682">,</span>&nbsp;<span class="op" id="5300684">&amp;</span><span class="ident" id="5300685">Error</span><span class="op" id="5300690">{</span><span class="ident" id="5300691">ErrTrailingBackslash</span><span class="op" id="5300711">,</span>&nbsp;<span class="string" id="5300713">&#34;&#34;</span><span class="op" id="5300715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5300718">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5300721">c</span><span class="op" id="5300722">,</span>&nbsp;<span class="ident" id="5300724">t</span><span class="op" id="5300725">,</span>&nbsp;<span class="ident" id="5300727">err</span>&nbsp;<span class="op" id="5300731">:=</span>&nbsp;<span class="ident" id="5300734">nextRune</span><span class="op" id="5300742">(</span><span class="ident" id="5300743">t</span><span class="op" id="5300744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300747">if</span>&nbsp;<span class="ident" id="5300750">err</span>&nbsp;<span class="op" id="5300754">!=</span>&nbsp;<span class="ident" id="5300757">nil</span>&nbsp;<span class="op" id="5300761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300765">return</span>&nbsp;<span class="num" id="5300772">0</span><span class="op" id="5300773">,</span>&nbsp;<span class="string" id="5300775">&#34;&#34;</span><span class="op" id="5300777">,</span>&nbsp;<span class="ident" id="5300779">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5300784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1240</span><span class="ident" id="5300787">Switch</span><span class="op" id="5300793">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300796">switch</span>&nbsp;<span class="ident" id="5300803">c</span>&nbsp;<span class="op" id="5300805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300808">default</span><span class="op" id="5300815">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5300819">if</span>&nbsp;<span class="ident" id="5300822">c</span>&nbsp;<span class="op" id="5300824">&lt;</span>&nbsp;<span class="ident" id="5300826">utf8</span><span class="op" id="5300830">.</span><span class="ident" id="5300831">RuneSelf</span>&nbsp;<span class="op" id="5300840">&amp;&amp;</span>&nbsp;<span class="op" id="5300843">!</span><span class="ident" id="5300844">isalnum</span><span class="op" id="5300851">(</span><span class="ident" id="5300852">c</span><span class="op" id="5300853">)</span>&nbsp;<span class="op" id="5300855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5300860">//&nbsp;Escaped&nbsp;non-word&nbsp;characters&nbsp;are&nbsp;always&nbsp;themselves.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5300917">//&nbsp;PCRE&nbsp;is&nbsp;not&nbsp;quite&nbsp;so&nbsp;rigorous:&nbsp;it&nbsp;accepts&nbsp;things&nbsp;like</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5300977">//&nbsp;\q,&nbsp;but&nbsp;we&nbsp;don&#39;t.&nbsp;&nbsp;We&nbsp;once&nbsp;rejected&nbsp;\_,&nbsp;but&nbsp;too&nbsp;many</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5301036">//&nbsp;programs&nbsp;and&nbsp;people&nbsp;insist&nbsp;on&nbsp;using&nbsp;it,&nbsp;so&nbsp;allow&nbsp;\_.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301095">return</span>&nbsp;<span class="ident" id="5301102">c</span><span class="op" id="5301103">,</span>&nbsp;<span class="ident" id="5301105">t</span><span class="op" id="5301106">,</span>&nbsp;<span class="ident" id="5301108">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5301114">}</span><br>
<span class="lineno">1250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5301118">//&nbsp;Octal&nbsp;escapes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301137">case</span>&nbsp;<span class="string" id="5301142">&#39;1&#39;</span><span class="op" id="5301145">,</span>&nbsp;<span class="string" id="5301147">&#39;2&#39;</span><span class="op" id="5301150">,</span>&nbsp;<span class="string" id="5301152">&#39;3&#39;</span><span class="op" id="5301155">,</span>&nbsp;<span class="string" id="5301157">&#39;4&#39;</span><span class="op" id="5301160">,</span>&nbsp;<span class="string" id="5301162">&#39;5&#39;</span><span class="op" id="5301165">,</span>&nbsp;<span class="string" id="5301167">&#39;6&#39;</span><span class="op" id="5301170">,</span>&nbsp;<span class="string" id="5301172">&#39;7&#39;</span><span class="op" id="5301175">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5301179">//&nbsp;Single&nbsp;non-zero&nbsp;digit&nbsp;is&nbsp;a&nbsp;backreference;&nbsp;not&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301240">if</span>&nbsp;<span class="ident" id="5301243">t</span>&nbsp;<span class="op" id="5301245">==</span>&nbsp;<span class="string" id="5301248">&#34;&#34;</span>&nbsp;<span class="op" id="5301251">||</span>&nbsp;<span class="ident" id="5301254">t</span><span class="op" id="5301255">[</span><span class="num" id="5301256">0</span><span class="op" id="5301257">]</span>&nbsp;<span class="op" id="5301259">&lt;</span>&nbsp;<span class="string" id="5301261">&#39;0&#39;</span>&nbsp;<span class="op" id="5301265">||</span>&nbsp;<span class="ident" id="5301268">t</span><span class="op" id="5301269">[</span><span class="num" id="5301270">0</span><span class="op" id="5301271">]</span>&nbsp;<span class="op" id="5301273">&gt;</span>&nbsp;<span class="string" id="5301275">&#39;7&#39;</span>&nbsp;<span class="op" id="5301279">{</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301284">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5301292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301296">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301309">case</span>&nbsp;<span class="string" id="5301314">&#39;0&#39;</span><span class="op" id="5301317">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5301321">//&nbsp;Consume&nbsp;up&nbsp;to&nbsp;three&nbsp;octal&nbsp;digits;&nbsp;already&nbsp;have&nbsp;one.</span><br>
<span class="lineno">1260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5301378">r</span>&nbsp;<span class="op" id="5301380">=</span>&nbsp;<span class="ident" id="5301382">c</span>&nbsp;<span class="op" id="5301384">-</span>&nbsp;<span class="string" id="5301386">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301392">for</span>&nbsp;<span class="ident" id="5301396">i</span>&nbsp;<span class="op" id="5301398">:=</span>&nbsp;<span class="num" id="5301401">1</span><span class="op" id="5301402">;</span>&nbsp;<span class="ident" id="5301404">i</span>&nbsp;<span class="op" id="5301406">&lt;</span>&nbsp;<span class="num" id="5301408">3</span><span class="op" id="5301409">;</span>&nbsp;<span class="ident" id="5301411">i</span><span class="op" id="5301412">++</span>&nbsp;<span class="op" id="5301415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301420">if</span>&nbsp;<span class="ident" id="5301423">t</span>&nbsp;<span class="op" id="5301425">==</span>&nbsp;<span class="string" id="5301428">&#34;&#34;</span>&nbsp;<span class="op" id="5301431">||</span>&nbsp;<span class="ident" id="5301434">t</span><span class="op" id="5301435">[</span><span class="num" id="5301436">0</span><span class="op" id="5301437">]</span>&nbsp;<span class="op" id="5301439">&lt;</span>&nbsp;<span class="string" id="5301441">&#39;0&#39;</span>&nbsp;<span class="op" id="5301445">||</span>&nbsp;<span class="ident" id="5301448">t</span><span class="op" id="5301449">[</span><span class="num" id="5301450">0</span><span class="op" id="5301451">]</span>&nbsp;<span class="op" id="5301453">&gt;</span>&nbsp;<span class="string" id="5301455">&#39;7&#39;</span>&nbsp;<span class="op" id="5301459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301465">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5301474">}</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5301479">r</span>&nbsp;<span class="op" id="5301481">=</span>&nbsp;<span class="ident" id="5301483">r</span><span class="op" id="5301484">*</span><span class="num" id="5301485">8</span>&nbsp;<span class="op" id="5301487">+</span>&nbsp;<span class="builtintype" id="5301489">rune</span><span class="op" id="5301493">(</span><span class="ident" id="5301494">t</span><span class="op" id="5301495">[</span><span class="num" id="5301496">0</span><span class="op" id="5301497">]</span><span class="op" id="5301498">)</span>&nbsp;<span class="op" id="5301500">-</span>&nbsp;<span class="string" id="5301502">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5301509">t</span>&nbsp;<span class="op" id="5301511">=</span>&nbsp;<span class="ident" id="5301513">t</span><span class="op" id="5301514">[</span><span class="num" id="5301515">1</span><span class="op" id="5301516">:</span><span class="op" id="5301517">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5301521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301525">return</span>&nbsp;<span class="ident" id="5301532">r</span><span class="op" id="5301533">,</span>&nbsp;<span class="ident" id="5301535">t</span><span class="op" id="5301536">,</span>&nbsp;<span class="ident" id="5301538">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5301544">//&nbsp;Hexadecimal&nbsp;escapes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301569">case</span>&nbsp;<span class="string" id="5301574">&#39;x&#39;</span><span class="op" id="5301577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301581">if</span>&nbsp;<span class="ident" id="5301584">t</span>&nbsp;<span class="op" id="5301586">==</span>&nbsp;<span class="string" id="5301589">&#34;&#34;</span>&nbsp;<span class="op" id="5301592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301597">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5301605">}</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301609">if</span>&nbsp;<span class="ident" id="5301612">c</span><span class="op" id="5301613">,</span>&nbsp;<span class="ident" id="5301615">t</span><span class="op" id="5301616">,</span>&nbsp;<span class="ident" id="5301618">err</span>&nbsp;<span class="op" id="5301622">=</span>&nbsp;<span class="ident" id="5301624">nextRune</span><span class="op" id="5301632">(</span><span class="ident" id="5301633">t</span><span class="op" id="5301634">)</span><span class="op" id="5301635">;</span>&nbsp;<span class="ident" id="5301637">err</span>&nbsp;<span class="op" id="5301641">!=</span>&nbsp;<span class="ident" id="5301644">nil</span>&nbsp;<span class="op" id="5301648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301653">return</span>&nbsp;<span class="num" id="5301660">0</span><span class="op" id="5301661">,</span>&nbsp;<span class="string" id="5301663">&#34;&#34;</span><span class="op" id="5301665">,</span>&nbsp;<span class="ident" id="5301667">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5301673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301677">if</span>&nbsp;<span class="ident" id="5301680">c</span>&nbsp;<span class="op" id="5301682">==</span>&nbsp;<span class="string" id="5301685">&#39;{&#39;</span>&nbsp;<span class="op" id="5301689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5301694">//&nbsp;Any&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;braces.</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5301732">//&nbsp;Perl&nbsp;accepts&nbsp;any&nbsp;text&nbsp;at&nbsp;all;&nbsp;it&nbsp;ignores&nbsp;all&nbsp;text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5301788">//&nbsp;after&nbsp;the&nbsp;first&nbsp;non-hex&nbsp;digit.&nbsp;&nbsp;We&nbsp;require&nbsp;only&nbsp;hex&nbsp;digits,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5301854">//&nbsp;and&nbsp;at&nbsp;least&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5301878">nhex</span>&nbsp;<span class="op" id="5301883">:=</span>&nbsp;<span class="num" id="5301886">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5301891">r</span>&nbsp;<span class="op" id="5301893">=</span>&nbsp;<span class="num" id="5301895">0</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301900">for</span>&nbsp;<span class="op" id="5301904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301910">if</span>&nbsp;<span class="ident" id="5301913">t</span>&nbsp;<span class="op" id="5301915">==</span>&nbsp;<span class="string" id="5301918">&#34;&#34;</span>&nbsp;<span class="op" id="5301921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301928">break</span>&nbsp;<span class="ident" id="5301934">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5301945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301951">if</span>&nbsp;<span class="ident" id="5301954">c</span><span class="op" id="5301955">,</span>&nbsp;<span class="ident" id="5301957">t</span><span class="op" id="5301958">,</span>&nbsp;<span class="ident" id="5301960">err</span>&nbsp;<span class="op" id="5301964">=</span>&nbsp;<span class="ident" id="5301966">nextRune</span><span class="op" id="5301974">(</span><span class="ident" id="5301975">t</span><span class="op" id="5301976">)</span><span class="op" id="5301977">;</span>&nbsp;<span class="ident" id="5301979">err</span>&nbsp;<span class="op" id="5301983">!=</span>&nbsp;<span class="ident" id="5301986">nil</span>&nbsp;<span class="op" id="5301990">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5301997">return</span>&nbsp;<span class="num" id="5302004">0</span><span class="op" id="5302005">,</span>&nbsp;<span class="string" id="5302007">&#34;&#34;</span><span class="op" id="5302009">,</span>&nbsp;<span class="ident" id="5302011">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5302019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302025">if</span>&nbsp;<span class="ident" id="5302028">c</span>&nbsp;<span class="op" id="5302030">==</span>&nbsp;<span class="string" id="5302033">&#39;}&#39;</span>&nbsp;<span class="op" id="5302037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302044">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5302054">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5302060">v</span>&nbsp;<span class="op" id="5302062">:=</span>&nbsp;<span class="ident" id="5302065">unhex</span><span class="op" id="5302070">(</span><span class="ident" id="5302071">c</span><span class="op" id="5302072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302078">if</span>&nbsp;<span class="ident" id="5302081">v</span>&nbsp;<span class="op" id="5302083">&lt;</span>&nbsp;<span class="num" id="5302085">0</span>&nbsp;<span class="op" id="5302087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302094">break</span>&nbsp;<span class="ident" id="5302100">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5302111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5302117">r</span>&nbsp;<span class="op" id="5302119">=</span>&nbsp;<span class="ident" id="5302121">r</span><span class="op" id="5302122">*</span><span class="num" id="5302123">16</span>&nbsp;<span class="op" id="5302126">+</span>&nbsp;<span class="ident" id="5302128">v</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302134">if</span>&nbsp;<span class="ident" id="5302137">r</span>&nbsp;<span class="op" id="5302139">&gt;</span>&nbsp;<span class="ident" id="5302141">unicode</span><span class="op" id="5302148">.</span><span class="ident" id="5302149">MaxRune</span>&nbsp;<span class="op" id="5302157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302164">break</span>&nbsp;<span class="ident" id="5302170">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5302181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5302187">nhex</span><span class="op" id="5302191">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5302197">}</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302202">if</span>&nbsp;<span class="ident" id="5302205">nhex</span>&nbsp;<span class="op" id="5302210">==</span>&nbsp;<span class="num" id="5302213">0</span>&nbsp;<span class="op" id="5302215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302221">break</span>&nbsp;<span class="ident" id="5302227">Switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5302237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302242">return</span>&nbsp;<span class="ident" id="5302249">r</span><span class="op" id="5302250">,</span>&nbsp;<span class="ident" id="5302252">t</span><span class="op" id="5302253">,</span>&nbsp;<span class="ident" id="5302255">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5302261">}</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5302266">//&nbsp;Easy&nbsp;case:&nbsp;two&nbsp;hex&nbsp;digits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5302298">x</span>&nbsp;<span class="op" id="5302300">:=</span>&nbsp;<span class="ident" id="5302303">unhex</span><span class="op" id="5302308">(</span><span class="ident" id="5302309">c</span><span class="op" id="5302310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302314">if</span>&nbsp;<span class="ident" id="5302317">c</span><span class="op" id="5302318">,</span>&nbsp;<span class="ident" id="5302320">t</span><span class="op" id="5302321">,</span>&nbsp;<span class="ident" id="5302323">err</span>&nbsp;<span class="op" id="5302327">=</span>&nbsp;<span class="ident" id="5302329">nextRune</span><span class="op" id="5302337">(</span><span class="ident" id="5302338">t</span><span class="op" id="5302339">)</span><span class="op" id="5302340">;</span>&nbsp;<span class="ident" id="5302342">err</span>&nbsp;<span class="op" id="5302346">!=</span>&nbsp;<span class="ident" id="5302349">nil</span>&nbsp;<span class="op" id="5302353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302358">return</span>&nbsp;<span class="num" id="5302365">0</span><span class="op" id="5302366">,</span>&nbsp;<span class="string" id="5302368">&#34;&#34;</span><span class="op" id="5302370">,</span>&nbsp;<span class="ident" id="5302372">err</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5302378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5302382">y</span>&nbsp;<span class="op" id="5302384">:=</span>&nbsp;<span class="ident" id="5302387">unhex</span><span class="op" id="5302392">(</span><span class="ident" id="5302393">c</span><span class="op" id="5302394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302398">if</span>&nbsp;<span class="ident" id="5302401">x</span>&nbsp;<span class="op" id="5302403">&lt;</span>&nbsp;<span class="num" id="5302405">0</span>&nbsp;<span class="op" id="5302407">||</span>&nbsp;<span class="ident" id="5302410">y</span>&nbsp;<span class="op" id="5302412">&lt;</span>&nbsp;<span class="num" id="5302414">0</span>&nbsp;<span class="op" id="5302416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302421">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5302429">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302433">return</span>&nbsp;<span class="ident" id="5302440">x</span><span class="op" id="5302441">*</span><span class="num" id="5302442">16</span>&nbsp;<span class="op" id="5302445">+</span>&nbsp;<span class="ident" id="5302447">y</span><span class="op" id="5302448">,</span>&nbsp;<span class="ident" id="5302450">t</span><span class="op" id="5302451">,</span>&nbsp;<span class="ident" id="5302453">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5302459">//&nbsp;C&nbsp;escapes.&nbsp;&nbsp;There&nbsp;is&nbsp;no&nbsp;case&nbsp;&#39;b&#39;,&nbsp;to&nbsp;avoid&nbsp;misparsing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5302517">//&nbsp;the&nbsp;Perl&nbsp;word-boundary&nbsp;\b&nbsp;as&nbsp;the&nbsp;C&nbsp;backspace&nbsp;\b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5302569">//&nbsp;when&nbsp;in&nbsp;POSIX&nbsp;mode.&nbsp;&nbsp;In&nbsp;Perl,&nbsp;/\b/&nbsp;means&nbsp;word-boundary</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5302628">//&nbsp;but&nbsp;/[\b]/&nbsp;means&nbsp;backspace.&nbsp;&nbsp;We&nbsp;don&#39;t&nbsp;support&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5302684">//&nbsp;If&nbsp;you&nbsp;want&nbsp;a&nbsp;backspace,&nbsp;embed&nbsp;a&nbsp;literal&nbsp;backspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5302739">//&nbsp;character&nbsp;or&nbsp;use&nbsp;\x08.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302766">case</span>&nbsp;<span class="string" id="5302771">&#39;a&#39;</span><span class="op" id="5302774">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302778">return</span>&nbsp;<span class="string" id="5302785">&#39;\a&#39;</span><span class="op" id="5302789">,</span>&nbsp;<span class="ident" id="5302791">t</span><span class="op" id="5302792">,</span>&nbsp;<span class="ident" id="5302794">err</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302799">case</span>&nbsp;<span class="string" id="5302804">&#39;f&#39;</span><span class="op" id="5302807">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302811">return</span>&nbsp;<span class="string" id="5302818">&#39;\f&#39;</span><span class="op" id="5302822">,</span>&nbsp;<span class="ident" id="5302824">t</span><span class="op" id="5302825">,</span>&nbsp;<span class="ident" id="5302827">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302832">case</span>&nbsp;<span class="string" id="5302837">&#39;n&#39;</span><span class="op" id="5302840">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302844">return</span>&nbsp;<span class="string" id="5302851">&#39;\n&#39;</span><span class="op" id="5302855">,</span>&nbsp;<span class="ident" id="5302857">t</span><span class="op" id="5302858">,</span>&nbsp;<span class="ident" id="5302860">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302865">case</span>&nbsp;<span class="string" id="5302870">&#39;r&#39;</span><span class="op" id="5302873">:</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302877">return</span>&nbsp;<span class="string" id="5302884">&#39;\r&#39;</span><span class="op" id="5302888">,</span>&nbsp;<span class="ident" id="5302890">t</span><span class="op" id="5302891">,</span>&nbsp;<span class="ident" id="5302893">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302898">case</span>&nbsp;<span class="string" id="5302903">&#39;t&#39;</span><span class="op" id="5302906">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302910">return</span>&nbsp;<span class="string" id="5302917">&#39;\t&#39;</span><span class="op" id="5302921">,</span>&nbsp;<span class="ident" id="5302923">t</span><span class="op" id="5302924">,</span>&nbsp;<span class="ident" id="5302926">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302931">case</span>&nbsp;<span class="string" id="5302936">&#39;v&#39;</span><span class="op" id="5302939">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302943">return</span>&nbsp;<span class="string" id="5302950">&#39;\v&#39;</span><span class="op" id="5302954">,</span>&nbsp;<span class="ident" id="5302956">t</span><span class="op" id="5302957">,</span>&nbsp;<span class="ident" id="5302959">err</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5302964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5302967">return</span>&nbsp;<span class="num" id="5302974">0</span><span class="op" id="5302975">,</span>&nbsp;<span class="string" id="5302977">&#34;&#34;</span><span class="op" id="5302979">,</span>&nbsp;<span class="op" id="5302981">&amp;</span><span class="ident" id="5302982">Error</span><span class="op" id="5302987">{</span><span class="ident" id="5302988">ErrInvalidEscape</span><span class="op" id="5303004">,</span>&nbsp;<span class="ident" id="5303006">s</span><span class="op" id="5303007">[</span><span class="op" id="5303008">:</span><span class="builtinfunc" id="5303009">len</span><span class="op" id="5303012">(</span><span class="ident" id="5303013">s</span><span class="op" id="5303014">)</span><span class="op" id="5303015">-</span><span class="builtinfunc" id="5303016">len</span><span class="op" id="5303019">(</span><span class="ident" id="5303020">t</span><span class="op" id="5303021">)</span><span class="op" id="5303022">]</span><span class="op" id="5303023">}</span><br>
<span class="lineno"></span><span class="op" id="5303025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5303028">//&nbsp;parseClassChar&nbsp;parses&nbsp;a&nbsp;character&nbsp;class&nbsp;character&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s</span><br>
<span class="lineno">1345</span><span class="comment" id="5303103">//&nbsp;and&nbsp;returns&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5303122">func</span>&nbsp;<span class="op" id="5303127">(</span><span class="ident" id="5303128">p</span>&nbsp;<span class="op" id="5303130">*</span><span class="ident" id="5303131">parser</span><span class="op" id="5303137">)</span>&nbsp;<span class="ident" id="5303139">parseClassChar</span><span class="op" id="5303153">(</span><span class="ident" id="5303154">s</span><span class="op" id="5303155">,</span>&nbsp;<span class="ident" id="5303157">wholeClass</span>&nbsp;<span class="builtintype" id="5303168">string</span><span class="op" id="5303174">)</span>&nbsp;<span class="op" id="5303176">(</span><span class="ident" id="5303177">r</span>&nbsp;<span class="builtintype" id="5303179">rune</span><span class="op" id="5303183">,</span>&nbsp;<span class="ident" id="5303185">rest</span>&nbsp;<span class="builtintype" id="5303190">string</span><span class="op" id="5303196">,</span>&nbsp;<span class="ident" id="5303198">err</span>&nbsp;<span class="builtintype" id="5303202">error</span><span class="op" id="5303207">)</span>&nbsp;<span class="op" id="5303209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5303212">if</span>&nbsp;<span class="ident" id="5303215">s</span>&nbsp;<span class="op" id="5303217">==</span>&nbsp;<span class="string" id="5303220">&#34;&#34;</span>&nbsp;<span class="op" id="5303223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5303227">return</span>&nbsp;<span class="num" id="5303234">0</span><span class="op" id="5303235">,</span>&nbsp;<span class="string" id="5303237">&#34;&#34;</span><span class="op" id="5303239">,</span>&nbsp;<span class="op" id="5303241">&amp;</span><span class="ident" id="5303242">Error</span><span class="op" id="5303247">{</span><span class="ident" id="5303248">Code</span><span class="op" id="5303252">:</span>&nbsp;<span class="ident" id="5303254">ErrMissingBracket</span><span class="op" id="5303271">,</span>&nbsp;<span class="ident" id="5303273">Expr</span><span class="op" id="5303277">:</span>&nbsp;<span class="ident" id="5303279">wholeClass</span><span class="op" id="5303289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5303292">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5303296">//&nbsp;Allow&nbsp;regular&nbsp;escape&nbsp;sequences&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5303343">//&nbsp;many&nbsp;need&nbsp;not&nbsp;be&nbsp;escaped&nbsp;in&nbsp;this&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5303389">if</span>&nbsp;<span class="ident" id="5303392">s</span><span class="op" id="5303393">[</span><span class="num" id="5303394">0</span><span class="op" id="5303395">]</span>&nbsp;<span class="op" id="5303397">==</span>&nbsp;<span class="string" id="5303400">&#39;\\&#39;</span>&nbsp;<span class="op" id="5303405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5303409">return</span>&nbsp;<span class="ident" id="5303416">p</span><span class="op" id="5303417">.</span><span class="ident" id="5303418">parseEscape</span><span class="op" id="5303429">(</span><span class="ident" id="5303430">s</span><span class="op" id="5303431">)</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5303434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5303438">return</span>&nbsp;<span class="ident" id="5303445">nextRune</span><span class="op" id="5303453">(</span><span class="ident" id="5303454">s</span><span class="op" id="5303455">)</span><br>
<span class="lineno"></span><span class="op" id="5303457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1360</span><span class="keyword" id="5303460">type</span>&nbsp;<span class="ident" id="5303465">charGroup</span>&nbsp;<span class="keyword" id="5303475">struct</span>&nbsp;<span class="op" id="5303482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5303485">sign</span>&nbsp;&nbsp;<span class="builtintype" id="5303491">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5303496">class</span>&nbsp;<span class="op" id="5303502">[</span><span class="op" id="5303503">]</span><span class="builtintype" id="5303504">rune</span><br>
<span class="lineno"></span><span class="op" id="5303509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1365</span><span class="comment" id="5303512">//&nbsp;parsePerlClassEscape&nbsp;parses&nbsp;a&nbsp;leading&nbsp;Perl&nbsp;character&nbsp;class&nbsp;escape&nbsp;like&nbsp;\d</span><br>
<span class="lineno"></span><span class="comment" id="5303589">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s.&nbsp;&nbsp;If&nbsp;one&nbsp;is&nbsp;present,&nbsp;it&nbsp;appends&nbsp;the&nbsp;characters&nbsp;to&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5303668">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;new&nbsp;slice&nbsp;r&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="5303732">func</span>&nbsp;<span class="op" id="5303737">(</span><span class="ident" id="5303738">p</span>&nbsp;<span class="op" id="5303740">*</span><span class="ident" id="5303741">parser</span><span class="op" id="5303747">)</span>&nbsp;<span class="ident" id="5303749">parsePerlClassEscape</span><span class="op" id="5303769">(</span><span class="ident" id="5303770">s</span>&nbsp;<span class="builtintype" id="5303772">string</span><span class="op" id="5303778">,</span>&nbsp;<span class="ident" id="5303780">r</span>&nbsp;<span class="op" id="5303782">[</span><span class="op" id="5303783">]</span><span class="builtintype" id="5303784">rune</span><span class="op" id="5303788">)</span>&nbsp;<span class="op" id="5303790">(</span><span class="ident" id="5303791">out</span>&nbsp;<span class="op" id="5303795">[</span><span class="op" id="5303796">]</span><span class="builtintype" id="5303797">rune</span><span class="op" id="5303801">,</span>&nbsp;<span class="ident" id="5303803">rest</span>&nbsp;<span class="builtintype" id="5303808">string</span><span class="op" id="5303814">)</span>&nbsp;<span class="op" id="5303816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5303819">if</span>&nbsp;<span class="ident" id="5303822">p</span><span class="op" id="5303823">.</span><span class="ident" id="5303824">flags</span><span class="op" id="5303829">&amp;</span><span class="ident" id="5303830">PerlX</span>&nbsp;<span class="op" id="5303836">==</span>&nbsp;<span class="num" id="5303839">0</span>&nbsp;<span class="op" id="5303841">||</span>&nbsp;<span class="builtinfunc" id="5303844">len</span><span class="op" id="5303847">(</span><span class="ident" id="5303848">s</span><span class="op" id="5303849">)</span>&nbsp;<span class="op" id="5303851">&lt;</span>&nbsp;<span class="num" id="5303853">2</span>&nbsp;<span class="op" id="5303855">||</span>&nbsp;<span class="ident" id="5303858">s</span><span class="op" id="5303859">[</span><span class="num" id="5303860">0</span><span class="op" id="5303861">]</span>&nbsp;<span class="op" id="5303863">!=</span>&nbsp;<span class="string" id="5303866">&#39;\\&#39;</span>&nbsp;<span class="op" id="5303871">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5303875">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5303883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5303886">g</span>&nbsp;<span class="op" id="5303888">:=</span>&nbsp;<span class="ident" id="5303891">perlGroup</span><span class="op" id="5303900">[</span><span class="ident" id="5303901">s</span><span class="op" id="5303902">[</span><span class="num" id="5303903">0</span><span class="op" id="5303904">:</span><span class="num" id="5303905">2</span><span class="op" id="5303906">]</span><span class="op" id="5303907">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5303910">if</span>&nbsp;<span class="ident" id="5303913">g</span><span class="op" id="5303914">.</span><span class="ident" id="5303915">sign</span>&nbsp;<span class="op" id="5303920">==</span>&nbsp;<span class="num" id="5303923">0</span>&nbsp;<span class="op" id="5303925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5303929">return</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5303937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5303940">return</span>&nbsp;<span class="ident" id="5303947">p</span><span class="op" id="5303948">.</span><span class="ident" id="5303949">appendGroup</span><span class="op" id="5303960">(</span><span class="ident" id="5303961">r</span><span class="op" id="5303962">,</span>&nbsp;<span class="ident" id="5303964">g</span><span class="op" id="5303965">)</span><span class="op" id="5303966">,</span>&nbsp;<span class="ident" id="5303968">s</span><span class="op" id="5303969">[</span><span class="num" id="5303970">2</span><span class="op" id="5303971">:</span><span class="op" id="5303972">]</span><br>
<span class="lineno"></span><span class="op" id="5303974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5303977">//&nbsp;parseNamedClass&nbsp;parses&nbsp;a&nbsp;leading&nbsp;POSIX&nbsp;named&nbsp;character&nbsp;class&nbsp;like&nbsp;[:alnum:]</span><br>
<span class="lineno">1380</span><span class="comment" id="5304056">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s.&nbsp;&nbsp;If&nbsp;one&nbsp;is&nbsp;present,&nbsp;it&nbsp;appends&nbsp;the&nbsp;characters&nbsp;to&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5304135">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;new&nbsp;slice&nbsp;r&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="5304199">func</span>&nbsp;<span class="op" id="5304204">(</span><span class="ident" id="5304205">p</span>&nbsp;<span class="op" id="5304207">*</span><span class="ident" id="5304208">parser</span><span class="op" id="5304214">)</span>&nbsp;<span class="ident" id="5304216">parseNamedClass</span><span class="op" id="5304231">(</span><span class="ident" id="5304232">s</span>&nbsp;<span class="builtintype" id="5304234">string</span><span class="op" id="5304240">,</span>&nbsp;<span class="ident" id="5304242">r</span>&nbsp;<span class="op" id="5304244">[</span><span class="op" id="5304245">]</span><span class="builtintype" id="5304246">rune</span><span class="op" id="5304250">)</span>&nbsp;<span class="op" id="5304252">(</span><span class="ident" id="5304253">out</span>&nbsp;<span class="op" id="5304257">[</span><span class="op" id="5304258">]</span><span class="builtintype" id="5304259">rune</span><span class="op" id="5304263">,</span>&nbsp;<span class="ident" id="5304265">rest</span>&nbsp;<span class="builtintype" id="5304270">string</span><span class="op" id="5304276">,</span>&nbsp;<span class="ident" id="5304278">err</span>&nbsp;<span class="builtintype" id="5304282">error</span><span class="op" id="5304287">)</span>&nbsp;<span class="op" id="5304289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5304292">if</span>&nbsp;<span class="builtinfunc" id="5304295">len</span><span class="op" id="5304298">(</span><span class="ident" id="5304299">s</span><span class="op" id="5304300">)</span>&nbsp;<span class="op" id="5304302">&lt;</span>&nbsp;<span class="num" id="5304304">2</span>&nbsp;<span class="op" id="5304306">||</span>&nbsp;<span class="ident" id="5304309">s</span><span class="op" id="5304310">[</span><span class="num" id="5304311">0</span><span class="op" id="5304312">]</span>&nbsp;<span class="op" id="5304314">!=</span>&nbsp;<span class="string" id="5304317">&#39;[&#39;</span>&nbsp;<span class="op" id="5304321">||</span>&nbsp;<span class="ident" id="5304324">s</span><span class="op" id="5304325">[</span><span class="num" id="5304326">1</span><span class="op" id="5304327">]</span>&nbsp;<span class="op" id="5304329">!=</span>&nbsp;<span class="string" id="5304332">&#39;:&#39;</span>&nbsp;<span class="op" id="5304336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5304340">return</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5304348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304352">i</span>&nbsp;<span class="op" id="5304354">:=</span>&nbsp;<span class="ident" id="5304357">strings</span><span class="op" id="5304364">.</span><span class="ident" id="5304365">Index</span><span class="op" id="5304370">(</span><span class="ident" id="5304371">s</span><span class="op" id="5304372">[</span><span class="num" id="5304373">2</span><span class="op" id="5304374">:</span><span class="op" id="5304375">]</span><span class="op" id="5304376">,</span>&nbsp;<span class="string" id="5304378">&#34;:]&#34;</span><span class="op" id="5304382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5304385">if</span>&nbsp;<span class="ident" id="5304388">i</span>&nbsp;<span class="op" id="5304390">&lt;</span>&nbsp;<span class="num" id="5304392">0</span>&nbsp;<span class="op" id="5304394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5304398">return</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5304406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304409">i</span>&nbsp;<span class="op" id="5304411">+=</span>&nbsp;<span class="num" id="5304414">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304417">name</span><span class="op" id="5304421">,</span>&nbsp;<span class="ident" id="5304423">s</span>&nbsp;<span class="op" id="5304425">:=</span>&nbsp;<span class="ident" id="5304428">s</span><span class="op" id="5304429">[</span><span class="num" id="5304430">0</span><span class="op" id="5304431">:</span><span class="ident" id="5304432">i</span><span class="op" id="5304433">+</span><span class="num" id="5304434">2</span><span class="op" id="5304435">]</span><span class="op" id="5304436">,</span>&nbsp;<span class="ident" id="5304438">s</span><span class="op" id="5304439">[</span><span class="ident" id="5304440">i</span><span class="op" id="5304441">+</span><span class="num" id="5304442">2</span><span class="op" id="5304443">:</span><span class="op" id="5304444">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304447">g</span>&nbsp;<span class="op" id="5304449">:=</span>&nbsp;<span class="ident" id="5304452">posixGroup</span><span class="op" id="5304462">[</span><span class="ident" id="5304463">name</span><span class="op" id="5304467">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5304470">if</span>&nbsp;<span class="ident" id="5304473">g</span><span class="op" id="5304474">.</span><span class="ident" id="5304475">sign</span>&nbsp;<span class="op" id="5304480">==</span>&nbsp;<span class="num" id="5304483">0</span>&nbsp;<span class="op" id="5304485">{</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5304489">return</span>&nbsp;<span class="ident" id="5304496">nil</span><span class="op" id="5304499">,</span>&nbsp;<span class="string" id="5304501">&#34;&#34;</span><span class="op" id="5304503">,</span>&nbsp;<span class="op" id="5304505">&amp;</span><span class="ident" id="5304506">Error</span><span class="op" id="5304511">{</span><span class="ident" id="5304512">ErrInvalidCharRange</span><span class="op" id="5304531">,</span>&nbsp;<span class="ident" id="5304533">name</span><span class="op" id="5304537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5304540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5304543">return</span>&nbsp;<span class="ident" id="5304550">p</span><span class="op" id="5304551">.</span><span class="ident" id="5304552">appendGroup</span><span class="op" id="5304563">(</span><span class="ident" id="5304564">r</span><span class="op" id="5304565">,</span>&nbsp;<span class="ident" id="5304567">g</span><span class="op" id="5304568">)</span><span class="op" id="5304569">,</span>&nbsp;<span class="ident" id="5304571">s</span><span class="op" id="5304572">,</span>&nbsp;<span class="ident" id="5304574">nil</span><br>
<span class="lineno"></span><span class="op" id="5304578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1400</span><span class="keyword" id="5304581">func</span>&nbsp;<span class="op" id="5304586">(</span><span class="ident" id="5304587">p</span>&nbsp;<span class="op" id="5304589">*</span><span class="ident" id="5304590">parser</span><span class="op" id="5304596">)</span>&nbsp;<span class="ident" id="5304598">appendGroup</span><span class="op" id="5304609">(</span><span class="ident" id="5304610">r</span>&nbsp;<span class="op" id="5304612">[</span><span class="op" id="5304613">]</span><span class="builtintype" id="5304614">rune</span><span class="op" id="5304618">,</span>&nbsp;<span class="ident" id="5304620">g</span>&nbsp;<span class="ident" id="5304622">charGroup</span><span class="op" id="5304631">)</span>&nbsp;<span class="op" id="5304633">[</span><span class="op" id="5304634">]</span><span class="builtintype" id="5304635">rune</span>&nbsp;<span class="op" id="5304640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5304643">if</span>&nbsp;<span class="ident" id="5304646">p</span><span class="op" id="5304647">.</span><span class="ident" id="5304648">flags</span><span class="op" id="5304653">&amp;</span><span class="ident" id="5304654">FoldCase</span>&nbsp;<span class="op" id="5304663">==</span>&nbsp;<span class="num" id="5304666">0</span>&nbsp;<span class="op" id="5304668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5304672">if</span>&nbsp;<span class="ident" id="5304675">g</span><span class="op" id="5304676">.</span><span class="ident" id="5304677">sign</span>&nbsp;<span class="op" id="5304682">&lt;</span>&nbsp;<span class="num" id="5304684">0</span>&nbsp;<span class="op" id="5304686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304691">r</span>&nbsp;<span class="op" id="5304693">=</span>&nbsp;<span class="ident" id="5304695">appendNegatedClass</span><span class="op" id="5304713">(</span><span class="ident" id="5304714">r</span><span class="op" id="5304715">,</span>&nbsp;<span class="ident" id="5304717">g</span><span class="op" id="5304718">.</span><span class="ident" id="5304719">class</span><span class="op" id="5304724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5304728">}</span>&nbsp;<span class="keyword" id="5304730">else</span>&nbsp;<span class="op" id="5304735">{</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304740">r</span>&nbsp;<span class="op" id="5304742">=</span>&nbsp;<span class="ident" id="5304744">appendClass</span><span class="op" id="5304755">(</span><span class="ident" id="5304756">r</span><span class="op" id="5304757">,</span>&nbsp;<span class="ident" id="5304759">g</span><span class="op" id="5304760">.</span><span class="ident" id="5304761">class</span><span class="op" id="5304766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5304770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5304773">}</span>&nbsp;<span class="keyword" id="5304775">else</span>&nbsp;<span class="op" id="5304780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304784">tmp</span>&nbsp;<span class="op" id="5304788">:=</span>&nbsp;<span class="ident" id="5304791">p</span><span class="op" id="5304792">.</span><span class="ident" id="5304793">tmpClass</span><span class="op" id="5304801">[</span><span class="op" id="5304802">:</span><span class="num" id="5304803">0</span><span class="op" id="5304804">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304808">tmp</span>&nbsp;<span class="op" id="5304812">=</span>&nbsp;<span class="ident" id="5304814">appendFoldedClass</span><span class="op" id="5304831">(</span><span class="ident" id="5304832">tmp</span><span class="op" id="5304835">,</span>&nbsp;<span class="ident" id="5304837">g</span><span class="op" id="5304838">.</span><span class="ident" id="5304839">class</span><span class="op" id="5304844">)</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304848">p</span><span class="op" id="5304849">.</span><span class="ident" id="5304850">tmpClass</span>&nbsp;<span class="op" id="5304859">=</span>&nbsp;<span class="ident" id="5304861">tmp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304867">tmp</span>&nbsp;<span class="op" id="5304871">=</span>&nbsp;<span class="ident" id="5304873">cleanClass</span><span class="op" id="5304883">(</span><span class="op" id="5304884">&amp;</span><span class="ident" id="5304885">p</span><span class="op" id="5304886">.</span><span class="ident" id="5304887">tmpClass</span><span class="op" id="5304895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5304899">if</span>&nbsp;<span class="ident" id="5304902">g</span><span class="op" id="5304903">.</span><span class="ident" id="5304904">sign</span>&nbsp;<span class="op" id="5304909">&lt;</span>&nbsp;<span class="num" id="5304911">0</span>&nbsp;<span class="op" id="5304913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304918">r</span>&nbsp;<span class="op" id="5304920">=</span>&nbsp;<span class="ident" id="5304922">appendNegatedClass</span><span class="op" id="5304940">(</span><span class="ident" id="5304941">r</span><span class="op" id="5304942">,</span>&nbsp;<span class="ident" id="5304944">tmp</span><span class="op" id="5304947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5304951">}</span>&nbsp;<span class="keyword" id="5304953">else</span>&nbsp;<span class="op" id="5304958">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5304963">r</span>&nbsp;<span class="op" id="5304965">=</span>&nbsp;<span class="ident" id="5304967">appendClass</span><span class="op" id="5304978">(</span><span class="ident" id="5304979">r</span><span class="op" id="5304980">,</span>&nbsp;<span class="ident" id="5304982">tmp</span><span class="op" id="5304985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5304989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5304992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5304995">return</span>&nbsp;<span class="ident" id="5305002">r</span><br>
<span class="lineno"></span><span class="op" id="5305004">}</span><br>
<span class="lineno">1420</span><br>
<span class="lineno"></span><span class="keyword" id="5305007">var</span>&nbsp;<span class="ident" id="5305011">anyTable</span>&nbsp;<span class="op" id="5305020">=</span>&nbsp;<span class="op" id="5305022">&amp;</span><span class="ident" id="5305023">unicode</span><span class="op" id="5305030">.</span><span class="ident" id="5305031">RangeTable</span><span class="op" id="5305041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5305044">R16</span><span class="op" id="5305047">:</span>&nbsp;<span class="op" id="5305049">[</span><span class="op" id="5305050">]</span><span class="ident" id="5305051">unicode</span><span class="op" id="5305058">.</span><span class="ident" id="5305059">Range16</span><span class="op" id="5305066">{</span><span class="op" id="5305067">{</span><span class="ident" id="5305068">Lo</span><span class="op" id="5305070">:</span>&nbsp;<span class="num" id="5305072">0</span><span class="op" id="5305073">,</span>&nbsp;<span class="ident" id="5305075">Hi</span><span class="op" id="5305077">:</span>&nbsp;<span class="num" id="5305079">1</span><span class="op" id="5305080">&lt;&lt;</span><span class="num" id="5305082">16</span>&nbsp;<span class="op" id="5305085">-</span>&nbsp;<span class="num" id="5305087">1</span><span class="op" id="5305088">,</span>&nbsp;<span class="ident" id="5305090">Stride</span><span class="op" id="5305096">:</span>&nbsp;<span class="num" id="5305098">1</span><span class="op" id="5305099">}</span><span class="op" id="5305100">}</span><span class="op" id="5305101">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5305104">R32</span><span class="op" id="5305107">:</span>&nbsp;<span class="op" id="5305109">[</span><span class="op" id="5305110">]</span><span class="ident" id="5305111">unicode</span><span class="op" id="5305118">.</span><span class="ident" id="5305119">Range32</span><span class="op" id="5305126">{</span><span class="op" id="5305127">{</span><span class="ident" id="5305128">Lo</span><span class="op" id="5305130">:</span>&nbsp;<span class="num" id="5305132">1</span>&nbsp;<span class="op" id="5305134">&lt;&lt;</span>&nbsp;<span class="num" id="5305137">16</span><span class="op" id="5305139">,</span>&nbsp;<span class="ident" id="5305141">Hi</span><span class="op" id="5305143">:</span>&nbsp;<span class="ident" id="5305145">unicode</span><span class="op" id="5305152">.</span><span class="ident" id="5305153">MaxRune</span><span class="op" id="5305160">,</span>&nbsp;<span class="ident" id="5305162">Stride</span><span class="op" id="5305168">:</span>&nbsp;<span class="num" id="5305170">1</span><span class="op" id="5305171">}</span><span class="op" id="5305172">}</span><span class="op" id="5305173">,</span><br>
<span class="lineno"></span><span class="op" id="5305175">}</span><br>
<span class="lineno">1425</span><br>
<span class="lineno"></span><span class="comment" id="5305178">//&nbsp;unicodeTable&nbsp;returns&nbsp;the&nbsp;unicode.RangeTable&nbsp;identified&nbsp;by&nbsp;name</span><br>
<span class="lineno"></span><span class="comment" id="5305244">//&nbsp;and&nbsp;the&nbsp;table&nbsp;of&nbsp;additional&nbsp;fold-equivalent&nbsp;code&nbsp;points.</span><br>
<span class="lineno"></span><span class="keyword" id="5305304">func</span>&nbsp;<span class="ident" id="5305309">unicodeTable</span><span class="op" id="5305321">(</span><span class="ident" id="5305322">name</span>&nbsp;<span class="builtintype" id="5305327">string</span><span class="op" id="5305333">)</span>&nbsp;<span class="op" id="5305335">(</span><span class="op" id="5305336">*</span><span class="ident" id="5305337">unicode</span><span class="op" id="5305344">.</span><span class="ident" id="5305345">RangeTable</span><span class="op" id="5305355">,</span>&nbsp;<span class="op" id="5305357">*</span><span class="ident" id="5305358">unicode</span><span class="op" id="5305365">.</span><span class="ident" id="5305366">RangeTable</span><span class="op" id="5305376">)</span>&nbsp;<span class="op" id="5305378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5305381">//&nbsp;Special&nbsp;case:&nbsp;&#34;Any&#34;&nbsp;means&nbsp;any.</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5305416">if</span>&nbsp;<span class="ident" id="5305419">name</span>&nbsp;<span class="op" id="5305424">==</span>&nbsp;<span class="string" id="5305427">&#34;Any&#34;</span>&nbsp;<span class="op" id="5305433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5305437">return</span>&nbsp;<span class="ident" id="5305444">anyTable</span><span class="op" id="5305452">,</span>&nbsp;<span class="ident" id="5305454">anyTable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5305464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5305467">if</span>&nbsp;<span class="ident" id="5305470">t</span>&nbsp;<span class="op" id="5305472">:=</span>&nbsp;<span class="ident" id="5305475">unicode</span><span class="op" id="5305482">.</span><span class="ident" id="5305483">Categories</span><span class="op" id="5305493">[</span><span class="ident" id="5305494">name</span><span class="op" id="5305498">]</span><span class="op" id="5305499">;</span>&nbsp;<span class="ident" id="5305501">t</span>&nbsp;<span class="op" id="5305503">!=</span>&nbsp;<span class="ident" id="5305506">nil</span>&nbsp;<span class="op" id="5305510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5305514">return</span>&nbsp;<span class="ident" id="5305521">t</span><span class="op" id="5305522">,</span>&nbsp;<span class="ident" id="5305524">unicode</span><span class="op" id="5305531">.</span><span class="ident" id="5305532">FoldCategory</span><span class="op" id="5305544">[</span><span class="ident" id="5305545">name</span><span class="op" id="5305549">]</span><br>
<span class="lineno">1435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5305552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5305555">if</span>&nbsp;<span class="ident" id="5305558">t</span>&nbsp;<span class="op" id="5305560">:=</span>&nbsp;<span class="ident" id="5305563">unicode</span><span class="op" id="5305570">.</span><span class="ident" id="5305571">Scripts</span><span class="op" id="5305578">[</span><span class="ident" id="5305579">name</span><span class="op" id="5305583">]</span><span class="op" id="5305584">;</span>&nbsp;<span class="ident" id="5305586">t</span>&nbsp;<span class="op" id="5305588">!=</span>&nbsp;<span class="ident" id="5305591">nil</span>&nbsp;<span class="op" id="5305595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5305599">return</span>&nbsp;<span class="ident" id="5305606">t</span><span class="op" id="5305607">,</span>&nbsp;<span class="ident" id="5305609">unicode</span><span class="op" id="5305616">.</span><span class="ident" id="5305617">FoldScript</span><span class="op" id="5305627">[</span><span class="ident" id="5305628">name</span><span class="op" id="5305632">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5305635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5305638">return</span>&nbsp;<span class="ident" id="5305645">nil</span><span class="op" id="5305648">,</span>&nbsp;<span class="ident" id="5305650">nil</span><br>
<span class="lineno">1440</span><span class="op" id="5305654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5305657">//&nbsp;parseUnicodeClass&nbsp;parses&nbsp;a&nbsp;leading&nbsp;Unicode&nbsp;character&nbsp;class&nbsp;like&nbsp;\p{Han}</span><br>
<span class="lineno"></span><span class="comment" id="5305732">//&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s.&nbsp;&nbsp;If&nbsp;one&nbsp;is&nbsp;present,&nbsp;it&nbsp;appends&nbsp;the&nbsp;characters&nbsp;to&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5305811">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;new&nbsp;slice&nbsp;r&nbsp;and&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;string.</span><br>
<span class="lineno">1445</span><span class="keyword" id="5305875">func</span>&nbsp;<span class="op" id="5305880">(</span><span class="ident" id="5305881">p</span>&nbsp;<span class="op" id="5305883">*</span><span class="ident" id="5305884">parser</span><span class="op" id="5305890">)</span>&nbsp;<span class="ident" id="5305892">parseUnicodeClass</span><span class="op" id="5305909">(</span><span class="ident" id="5305910">s</span>&nbsp;<span class="builtintype" id="5305912">string</span><span class="op" id="5305918">,</span>&nbsp;<span class="ident" id="5305920">r</span>&nbsp;<span class="op" id="5305922">[</span><span class="op" id="5305923">]</span><span class="builtintype" id="5305924">rune</span><span class="op" id="5305928">)</span>&nbsp;<span class="op" id="5305930">(</span><span class="ident" id="5305931">out</span>&nbsp;<span class="op" id="5305935">[</span><span class="op" id="5305936">]</span><span class="builtintype" id="5305937">rune</span><span class="op" id="5305941">,</span>&nbsp;<span class="ident" id="5305943">rest</span>&nbsp;<span class="builtintype" id="5305948">string</span><span class="op" id="5305954">,</span>&nbsp;<span class="ident" id="5305956">err</span>&nbsp;<span class="builtintype" id="5305960">error</span><span class="op" id="5305965">)</span>&nbsp;<span class="op" id="5305967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5305970">if</span>&nbsp;<span class="ident" id="5305973">p</span><span class="op" id="5305974">.</span><span class="ident" id="5305975">flags</span><span class="op" id="5305980">&amp;</span><span class="ident" id="5305981">UnicodeGroups</span>&nbsp;<span class="op" id="5305995">==</span>&nbsp;<span class="num" id="5305998">0</span>&nbsp;<span class="op" id="5306000">||</span>&nbsp;<span class="builtinfunc" id="5306003">len</span><span class="op" id="5306006">(</span><span class="ident" id="5306007">s</span><span class="op" id="5306008">)</span>&nbsp;<span class="op" id="5306010">&lt;</span>&nbsp;<span class="num" id="5306012">2</span>&nbsp;<span class="op" id="5306014">||</span>&nbsp;<span class="ident" id="5306017">s</span><span class="op" id="5306018">[</span><span class="num" id="5306019">0</span><span class="op" id="5306020">]</span>&nbsp;<span class="op" id="5306022">!=</span>&nbsp;<span class="string" id="5306025">&#39;\\&#39;</span>&nbsp;<span class="op" id="5306030">||</span>&nbsp;<span class="ident" id="5306033">s</span><span class="op" id="5306034">[</span><span class="num" id="5306035">1</span><span class="op" id="5306036">]</span>&nbsp;<span class="op" id="5306038">!=</span>&nbsp;<span class="string" id="5306041">&#39;p&#39;</span>&nbsp;<span class="op" id="5306045">&amp;&amp;</span>&nbsp;<span class="ident" id="5306048">s</span><span class="op" id="5306049">[</span><span class="num" id="5306050">1</span><span class="op" id="5306051">]</span>&nbsp;<span class="op" id="5306053">!=</span>&nbsp;<span class="string" id="5306056">&#39;P&#39;</span>&nbsp;<span class="op" id="5306060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306064">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5306072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5306076">//&nbsp;Committed&nbsp;to&nbsp;parse&nbsp;or&nbsp;return&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306116">sign</span>&nbsp;<span class="op" id="5306121">:=</span>&nbsp;<span class="op" id="5306124">+</span><span class="num" id="5306125">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306128">if</span>&nbsp;<span class="ident" id="5306131">s</span><span class="op" id="5306132">[</span><span class="num" id="5306133">1</span><span class="op" id="5306134">]</span>&nbsp;<span class="op" id="5306136">==</span>&nbsp;<span class="string" id="5306139">&#39;P&#39;</span>&nbsp;<span class="op" id="5306143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306147">sign</span>&nbsp;<span class="op" id="5306152">=</span>&nbsp;<span class="op" id="5306154">-</span><span class="num" id="5306155">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5306158">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306161">t</span>&nbsp;<span class="op" id="5306163">:=</span>&nbsp;<span class="ident" id="5306166">s</span><span class="op" id="5306167">[</span><span class="num" id="5306168">2</span><span class="op" id="5306169">:</span><span class="op" id="5306170">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306173">c</span><span class="op" id="5306174">,</span>&nbsp;<span class="ident" id="5306176">t</span><span class="op" id="5306177">,</span>&nbsp;<span class="ident" id="5306179">err</span>&nbsp;<span class="op" id="5306183">:=</span>&nbsp;<span class="ident" id="5306186">nextRune</span><span class="op" id="5306194">(</span><span class="ident" id="5306195">t</span><span class="op" id="5306196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306199">if</span>&nbsp;<span class="ident" id="5306202">err</span>&nbsp;<span class="op" id="5306206">!=</span>&nbsp;<span class="ident" id="5306209">nil</span>&nbsp;<span class="op" id="5306213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306217">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5306225">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306228">var</span>&nbsp;<span class="ident" id="5306232">seq</span><span class="op" id="5306235">,</span>&nbsp;<span class="ident" id="5306237">name</span>&nbsp;<span class="builtintype" id="5306242">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306250">if</span>&nbsp;<span class="ident" id="5306253">c</span>&nbsp;<span class="op" id="5306255">!=</span>&nbsp;<span class="string" id="5306258">&#39;{&#39;</span>&nbsp;<span class="op" id="5306262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5306266">//&nbsp;Single-letter&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306291">seq</span>&nbsp;<span class="op" id="5306295">=</span>&nbsp;<span class="ident" id="5306297">s</span><span class="op" id="5306298">[</span><span class="op" id="5306299">:</span><span class="builtinfunc" id="5306300">len</span><span class="op" id="5306303">(</span><span class="ident" id="5306304">s</span><span class="op" id="5306305">)</span><span class="op" id="5306306">-</span><span class="builtinfunc" id="5306307">len</span><span class="op" id="5306310">(</span><span class="ident" id="5306311">t</span><span class="op" id="5306312">)</span><span class="op" id="5306313">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306317">name</span>&nbsp;<span class="op" id="5306322">=</span>&nbsp;<span class="ident" id="5306324">seq</span><span class="op" id="5306327">[</span><span class="num" id="5306328">2</span><span class="op" id="5306329">:</span><span class="op" id="5306330">]</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5306333">}</span>&nbsp;<span class="keyword" id="5306335">else</span>&nbsp;<span class="op" id="5306340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5306344">//&nbsp;Name&nbsp;is&nbsp;in&nbsp;braces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306368">end</span>&nbsp;<span class="op" id="5306372">:=</span>&nbsp;<span class="ident" id="5306375">strings</span><span class="op" id="5306382">.</span><span class="ident" id="5306383">IndexRune</span><span class="op" id="5306392">(</span><span class="ident" id="5306393">s</span><span class="op" id="5306394">,</span>&nbsp;<span class="string" id="5306396">&#39;}&#39;</span><span class="op" id="5306399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306403">if</span>&nbsp;<span class="ident" id="5306406">end</span>&nbsp;<span class="op" id="5306410">&lt;</span>&nbsp;<span class="num" id="5306412">0</span>&nbsp;<span class="op" id="5306414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306419">if</span>&nbsp;<span class="ident" id="5306422">err</span>&nbsp;<span class="op" id="5306426">=</span>&nbsp;<span class="ident" id="5306428">checkUTF8</span><span class="op" id="5306437">(</span><span class="ident" id="5306438">s</span><span class="op" id="5306439">)</span><span class="op" id="5306440">;</span>&nbsp;<span class="ident" id="5306442">err</span>&nbsp;<span class="op" id="5306446">!=</span>&nbsp;<span class="ident" id="5306449">nil</span>&nbsp;<span class="op" id="5306453">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306459">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5306469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306474">return</span>&nbsp;<span class="ident" id="5306481">nil</span><span class="op" id="5306484">,</span>&nbsp;<span class="string" id="5306486">&#34;&#34;</span><span class="op" id="5306488">,</span>&nbsp;<span class="op" id="5306490">&amp;</span><span class="ident" id="5306491">Error</span><span class="op" id="5306496">{</span><span class="ident" id="5306497">ErrInvalidCharRange</span><span class="op" id="5306516">,</span>&nbsp;<span class="ident" id="5306518">s</span><span class="op" id="5306519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5306523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306527">seq</span><span class="op" id="5306530">,</span>&nbsp;<span class="ident" id="5306532">t</span>&nbsp;<span class="op" id="5306534">=</span>&nbsp;<span class="ident" id="5306536">s</span><span class="op" id="5306537">[</span><span class="op" id="5306538">:</span><span class="ident" id="5306539">end</span><span class="op" id="5306542">+</span><span class="num" id="5306543">1</span><span class="op" id="5306544">]</span><span class="op" id="5306545">,</span>&nbsp;<span class="ident" id="5306547">s</span><span class="op" id="5306548">[</span><span class="ident" id="5306549">end</span><span class="op" id="5306552">+</span><span class="num" id="5306553">1</span><span class="op" id="5306554">:</span><span class="op" id="5306555">]</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306559">name</span>&nbsp;<span class="op" id="5306564">=</span>&nbsp;<span class="ident" id="5306566">s</span><span class="op" id="5306567">[</span><span class="num" id="5306568">3</span><span class="op" id="5306569">:</span><span class="ident" id="5306570">end</span><span class="op" id="5306573">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306577">if</span>&nbsp;<span class="ident" id="5306580">err</span>&nbsp;<span class="op" id="5306584">=</span>&nbsp;<span class="ident" id="5306586">checkUTF8</span><span class="op" id="5306595">(</span><span class="ident" id="5306596">name</span><span class="op" id="5306600">)</span><span class="op" id="5306601">;</span>&nbsp;<span class="ident" id="5306603">err</span>&nbsp;<span class="op" id="5306607">!=</span>&nbsp;<span class="ident" id="5306610">nil</span>&nbsp;<span class="op" id="5306614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306619">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5306628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5306631">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5306635">//&nbsp;Group&nbsp;can&nbsp;have&nbsp;leading&nbsp;negation&nbsp;too.&nbsp;&nbsp;\p{^Han}&nbsp;==&nbsp;\P{Han},&nbsp;\P{^Han}&nbsp;==&nbsp;\p{Han}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306719">if</span>&nbsp;<span class="ident" id="5306722">name</span>&nbsp;<span class="op" id="5306727">!=</span>&nbsp;<span class="string" id="5306730">&#34;&#34;</span>&nbsp;<span class="op" id="5306733">&amp;&amp;</span>&nbsp;<span class="ident" id="5306736">name</span><span class="op" id="5306740">[</span><span class="num" id="5306741">0</span><span class="op" id="5306742">]</span>&nbsp;<span class="op" id="5306744">==</span>&nbsp;<span class="string" id="5306747">&#39;^&#39;</span>&nbsp;<span class="op" id="5306751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306755">sign</span>&nbsp;<span class="op" id="5306760">=</span>&nbsp;<span class="op" id="5306762">-</span><span class="ident" id="5306763">sign</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306770">name</span>&nbsp;<span class="op" id="5306775">=</span>&nbsp;<span class="ident" id="5306777">name</span><span class="op" id="5306781">[</span><span class="num" id="5306782">1</span><span class="op" id="5306783">:</span><span class="op" id="5306784">]</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5306787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306791">tab</span><span class="op" id="5306794">,</span>&nbsp;<span class="ident" id="5306796">fold</span>&nbsp;<span class="op" id="5306801">:=</span>&nbsp;<span class="ident" id="5306804">unicodeTable</span><span class="op" id="5306816">(</span><span class="ident" id="5306817">name</span><span class="op" id="5306821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306824">if</span>&nbsp;<span class="ident" id="5306827">tab</span>&nbsp;<span class="op" id="5306831">==</span>&nbsp;<span class="ident" id="5306834">nil</span>&nbsp;<span class="op" id="5306838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306842">return</span>&nbsp;<span class="ident" id="5306849">nil</span><span class="op" id="5306852">,</span>&nbsp;<span class="string" id="5306854">&#34;&#34;</span><span class="op" id="5306856">,</span>&nbsp;<span class="op" id="5306858">&amp;</span><span class="ident" id="5306859">Error</span><span class="op" id="5306864">{</span><span class="ident" id="5306865">ErrInvalidCharRange</span><span class="op" id="5306884">,</span>&nbsp;<span class="ident" id="5306886">seq</span><span class="op" id="5306889">}</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5306892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306896">if</span>&nbsp;<span class="ident" id="5306899">p</span><span class="op" id="5306900">.</span><span class="ident" id="5306901">flags</span><span class="op" id="5306906">&amp;</span><span class="ident" id="5306907">FoldCase</span>&nbsp;<span class="op" id="5306916">==</span>&nbsp;<span class="num" id="5306919">0</span>&nbsp;<span class="op" id="5306921">||</span>&nbsp;<span class="ident" id="5306924">fold</span>&nbsp;<span class="op" id="5306929">==</span>&nbsp;<span class="ident" id="5306932">nil</span>&nbsp;<span class="op" id="5306936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5306940">if</span>&nbsp;<span class="ident" id="5306943">sign</span>&nbsp;<span class="op" id="5306948">&gt;</span>&nbsp;<span class="num" id="5306950">0</span>&nbsp;<span class="op" id="5306952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306957">r</span>&nbsp;<span class="op" id="5306959">=</span>&nbsp;<span class="ident" id="5306961">appendTable</span><span class="op" id="5306972">(</span><span class="ident" id="5306973">r</span><span class="op" id="5306974">,</span>&nbsp;<span class="ident" id="5306976">tab</span><span class="op" id="5306979">)</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5306983">}</span>&nbsp;<span class="keyword" id="5306985">else</span>&nbsp;<span class="op" id="5306990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5306995">r</span>&nbsp;<span class="op" id="5306997">=</span>&nbsp;<span class="ident" id="5306999">appendNegatedTable</span><span class="op" id="5307017">(</span><span class="ident" id="5307018">r</span><span class="op" id="5307019">,</span>&nbsp;<span class="ident" id="5307021">tab</span><span class="op" id="5307024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5307028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5307031">}</span>&nbsp;<span class="keyword" id="5307033">else</span>&nbsp;<span class="op" id="5307038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5307042">//&nbsp;Merge&nbsp;and&nbsp;clean&nbsp;tab&nbsp;and&nbsp;fold&nbsp;in&nbsp;a&nbsp;temporary&nbsp;buffer.</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5307099">//&nbsp;This&nbsp;is&nbsp;necessary&nbsp;for&nbsp;the&nbsp;negative&nbsp;case&nbsp;and&nbsp;just&nbsp;tidy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5307158">//&nbsp;for&nbsp;the&nbsp;positive&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307186">tmp</span>&nbsp;<span class="op" id="5307190">:=</span>&nbsp;<span class="ident" id="5307193">p</span><span class="op" id="5307194">.</span><span class="ident" id="5307195">tmpClass</span><span class="op" id="5307203">[</span><span class="op" id="5307204">:</span><span class="num" id="5307205">0</span><span class="op" id="5307206">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307210">tmp</span>&nbsp;<span class="op" id="5307214">=</span>&nbsp;<span class="ident" id="5307216">appendTable</span><span class="op" id="5307227">(</span><span class="ident" id="5307228">tmp</span><span class="op" id="5307231">,</span>&nbsp;<span class="ident" id="5307233">tab</span><span class="op" id="5307236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307240">tmp</span>&nbsp;<span class="op" id="5307244">=</span>&nbsp;<span class="ident" id="5307246">appendTable</span><span class="op" id="5307257">(</span><span class="ident" id="5307258">tmp</span><span class="op" id="5307261">,</span>&nbsp;<span class="ident" id="5307263">fold</span><span class="op" id="5307267">)</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307271">p</span><span class="op" id="5307272">.</span><span class="ident" id="5307273">tmpClass</span>&nbsp;<span class="op" id="5307282">=</span>&nbsp;<span class="ident" id="5307284">tmp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307290">tmp</span>&nbsp;<span class="op" id="5307294">=</span>&nbsp;<span class="ident" id="5307296">cleanClass</span><span class="op" id="5307306">(</span><span class="op" id="5307307">&amp;</span><span class="ident" id="5307308">p</span><span class="op" id="5307309">.</span><span class="ident" id="5307310">tmpClass</span><span class="op" id="5307318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5307322">if</span>&nbsp;<span class="ident" id="5307325">sign</span>&nbsp;<span class="op" id="5307330">&gt;</span>&nbsp;<span class="num" id="5307332">0</span>&nbsp;<span class="op" id="5307334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307339">r</span>&nbsp;<span class="op" id="5307341">=</span>&nbsp;<span class="ident" id="5307343">appendClass</span><span class="op" id="5307354">(</span><span class="ident" id="5307355">r</span><span class="op" id="5307356">,</span>&nbsp;<span class="ident" id="5307358">tmp</span><span class="op" id="5307361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5307365">}</span>&nbsp;<span class="keyword" id="5307367">else</span>&nbsp;<span class="op" id="5307372">{</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307377">r</span>&nbsp;<span class="op" id="5307379">=</span>&nbsp;<span class="ident" id="5307381">appendNegatedClass</span><span class="op" id="5307399">(</span><span class="ident" id="5307400">r</span><span class="op" id="5307401">,</span>&nbsp;<span class="ident" id="5307403">tmp</span><span class="op" id="5307406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5307410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5307413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5307416">return</span>&nbsp;<span class="ident" id="5307423">r</span><span class="op" id="5307424">,</span>&nbsp;<span class="ident" id="5307426">t</span><span class="op" id="5307427">,</span>&nbsp;<span class="ident" id="5307429">nil</span><br>
<span class="lineno"></span><span class="op" id="5307433">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="5307436">//&nbsp;parseClass&nbsp;parses&nbsp;a&nbsp;character&nbsp;class&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;s</span><br>
<span class="lineno"></span><span class="comment" id="5307497">//&nbsp;and&nbsp;pushes&nbsp;it&nbsp;onto&nbsp;the&nbsp;parse&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="5307536">func</span>&nbsp;<span class="op" id="5307541">(</span><span class="ident" id="5307542">p</span>&nbsp;<span class="op" id="5307544">*</span><span class="ident" id="5307545">parser</span><span class="op" id="5307551">)</span>&nbsp;<span class="ident" id="5307553">parseClass</span><span class="op" id="5307563">(</span><span class="ident" id="5307564">s</span>&nbsp;<span class="builtintype" id="5307566">string</span><span class="op" id="5307572">)</span>&nbsp;<span class="op" id="5307574">(</span><span class="ident" id="5307575">rest</span>&nbsp;<span class="builtintype" id="5307580">string</span><span class="op" id="5307586">,</span>&nbsp;<span class="ident" id="5307588">err</span>&nbsp;<span class="builtintype" id="5307592">error</span><span class="op" id="5307597">)</span>&nbsp;<span class="op" id="5307599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307602">t</span>&nbsp;<span class="op" id="5307604">:=</span>&nbsp;<span class="ident" id="5307607">s</span><span class="op" id="5307608">[</span><span class="num" id="5307609">1</span><span class="op" id="5307610">:</span><span class="op" id="5307611">]</span>&nbsp;<span class="comment" id="5307613">//&nbsp;chop&nbsp;[</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307624">re</span>&nbsp;<span class="op" id="5307627">:=</span>&nbsp;<span class="ident" id="5307630">p</span><span class="op" id="5307631">.</span><span class="ident" id="5307632">newRegexp</span><span class="op" id="5307641">(</span><span class="ident" id="5307642">OpCharClass</span><span class="op" id="5307653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307656">re</span><span class="op" id="5307658">.</span><span class="ident" id="5307659">Flags</span>&nbsp;<span class="op" id="5307665">=</span>&nbsp;<span class="ident" id="5307667">p</span><span class="op" id="5307668">.</span><span class="ident" id="5307669">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307676">re</span><span class="op" id="5307678">.</span><span class="ident" id="5307679">Rune</span>&nbsp;<span class="op" id="5307684">=</span>&nbsp;<span class="ident" id="5307686">re</span><span class="op" id="5307688">.</span><span class="ident" id="5307689">Rune0</span><span class="op" id="5307694">[</span><span class="op" id="5307695">:</span><span class="num" id="5307696">0</span><span class="op" id="5307697">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307701">sign</span>&nbsp;<span class="op" id="5307706">:=</span>&nbsp;<span class="op" id="5307709">+</span><span class="num" id="5307710">1</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5307713">if</span>&nbsp;<span class="ident" id="5307716">t</span>&nbsp;<span class="op" id="5307718">!=</span>&nbsp;<span class="string" id="5307721">&#34;&#34;</span>&nbsp;<span class="op" id="5307724">&amp;&amp;</span>&nbsp;<span class="ident" id="5307727">t</span><span class="op" id="5307728">[</span><span class="num" id="5307729">0</span><span class="op" id="5307730">]</span>&nbsp;<span class="op" id="5307732">==</span>&nbsp;<span class="string" id="5307735">&#39;^&#39;</span>&nbsp;<span class="op" id="5307739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307743">sign</span>&nbsp;<span class="op" id="5307748">=</span>&nbsp;<span class="op" id="5307750">-</span><span class="num" id="5307751">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307755">t</span>&nbsp;<span class="op" id="5307757">=</span>&nbsp;<span class="ident" id="5307759">t</span><span class="op" id="5307760">[</span><span class="num" id="5307761">1</span><span class="op" id="5307762">:</span><span class="op" id="5307763">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5307768">//&nbsp;If&nbsp;character&nbsp;class&nbsp;does&nbsp;not&nbsp;match&nbsp;\n,&nbsp;add&nbsp;it&nbsp;here,</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5307824">//&nbsp;so&nbsp;that&nbsp;negation&nbsp;later&nbsp;will&nbsp;do&nbsp;the&nbsp;right&nbsp;thing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5307877">if</span>&nbsp;<span class="ident" id="5307880">p</span><span class="op" id="5307881">.</span><span class="ident" id="5307882">flags</span><span class="op" id="5307887">&amp;</span><span class="ident" id="5307888">ClassNL</span>&nbsp;<span class="op" id="5307896">==</span>&nbsp;<span class="num" id="5307899">0</span>&nbsp;<span class="op" id="5307901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307906">re</span><span class="op" id="5307908">.</span><span class="ident" id="5307909">Rune</span>&nbsp;<span class="op" id="5307914">=</span>&nbsp;<span class="builtinfunc" id="5307916">append</span><span class="op" id="5307922">(</span><span class="ident" id="5307923">re</span><span class="op" id="5307925">.</span><span class="ident" id="5307926">Rune</span><span class="op" id="5307930">,</span>&nbsp;<span class="string" id="5307932">&#39;\n&#39;</span><span class="op" id="5307936">,</span>&nbsp;<span class="string" id="5307938">&#39;\n&#39;</span><span class="op" id="5307942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5307946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5307949">}</span><br>
<span class="lineno">1535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307953">class</span>&nbsp;<span class="op" id="5307959">:=</span>&nbsp;<span class="ident" id="5307962">re</span><span class="op" id="5307964">.</span><span class="ident" id="5307965">Rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5307971">first</span>&nbsp;<span class="op" id="5307977">:=</span>&nbsp;<span class="builtintype" id="5307980">true</span>&nbsp;<span class="comment" id="5307985">//&nbsp;]&nbsp;and&nbsp;-&nbsp;are&nbsp;okay&nbsp;as&nbsp;first&nbsp;char&nbsp;in&nbsp;class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308029">for</span>&nbsp;<span class="ident" id="5308033">t</span>&nbsp;<span class="op" id="5308035">==</span>&nbsp;<span class="string" id="5308038">&#34;&#34;</span>&nbsp;<span class="op" id="5308041">||</span>&nbsp;<span class="ident" id="5308044">t</span><span class="op" id="5308045">[</span><span class="num" id="5308046">0</span><span class="op" id="5308047">]</span>&nbsp;<span class="op" id="5308049">!=</span>&nbsp;<span class="string" id="5308052">&#39;]&#39;</span>&nbsp;<span class="op" id="5308056">||</span>&nbsp;<span class="ident" id="5308059">first</span>&nbsp;<span class="op" id="5308065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5308069">//&nbsp;POSIX:&nbsp;-&nbsp;is&nbsp;only&nbsp;okay&nbsp;unescaped&nbsp;as&nbsp;first&nbsp;or&nbsp;last&nbsp;in&nbsp;class.</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5308133">//&nbsp;Perl:&nbsp;-&nbsp;is&nbsp;okay&nbsp;anywhere.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308164">if</span>&nbsp;<span class="ident" id="5308167">t</span>&nbsp;<span class="op" id="5308169">!=</span>&nbsp;<span class="string" id="5308172">&#34;&#34;</span>&nbsp;<span class="op" id="5308175">&amp;&amp;</span>&nbsp;<span class="ident" id="5308178">t</span><span class="op" id="5308179">[</span><span class="num" id="5308180">0</span><span class="op" id="5308181">]</span>&nbsp;<span class="op" id="5308183">==</span>&nbsp;<span class="string" id="5308186">&#39;-&#39;</span>&nbsp;<span class="op" id="5308190">&amp;&amp;</span>&nbsp;<span class="ident" id="5308193">p</span><span class="op" id="5308194">.</span><span class="ident" id="5308195">flags</span><span class="op" id="5308200">&amp;</span><span class="ident" id="5308201">PerlX</span>&nbsp;<span class="op" id="5308207">==</span>&nbsp;<span class="num" id="5308210">0</span>&nbsp;<span class="op" id="5308212">&amp;&amp;</span>&nbsp;<span class="op" id="5308215">!</span><span class="ident" id="5308216">first</span>&nbsp;<span class="op" id="5308222">&amp;&amp;</span>&nbsp;<span class="op" id="5308225">(</span><span class="builtinfunc" id="5308226">len</span><span class="op" id="5308229">(</span><span class="ident" id="5308230">t</span><span class="op" id="5308231">)</span>&nbsp;<span class="op" id="5308233">==</span>&nbsp;<span class="num" id="5308236">1</span>&nbsp;<span class="op" id="5308238">||</span>&nbsp;<span class="ident" id="5308241">t</span><span class="op" id="5308242">[</span><span class="num" id="5308243">1</span><span class="op" id="5308244">]</span>&nbsp;<span class="op" id="5308246">!=</span>&nbsp;<span class="string" id="5308249">&#39;]&#39;</span><span class="op" id="5308252">)</span>&nbsp;<span class="op" id="5308254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5308259">_</span><span class="op" id="5308260">,</span>&nbsp;<span class="ident" id="5308262">size</span>&nbsp;<span class="op" id="5308267">:=</span>&nbsp;<span class="ident" id="5308270">utf8</span><span class="op" id="5308274">.</span><span class="ident" id="5308275">DecodeRuneInString</span><span class="op" id="5308293">(</span><span class="ident" id="5308294">t</span><span class="op" id="5308295">[</span><span class="num" id="5308296">1</span><span class="op" id="5308297">:</span><span class="op" id="5308298">]</span><span class="op" id="5308299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308304">return</span>&nbsp;<span class="string" id="5308311">&#34;&#34;</span><span class="op" id="5308313">,</span>&nbsp;<span class="op" id="5308315">&amp;</span><span class="ident" id="5308316">Error</span><span class="op" id="5308321">{</span><span class="ident" id="5308322">Code</span><span class="op" id="5308326">:</span>&nbsp;<span class="ident" id="5308328">ErrInvalidCharRange</span><span class="op" id="5308347">,</span>&nbsp;<span class="ident" id="5308349">Expr</span><span class="op" id="5308353">:</span>&nbsp;<span class="ident" id="5308355">t</span><span class="op" id="5308356">[</span><span class="op" id="5308357">:</span><span class="num" id="5308358">1</span><span class="op" id="5308359">+</span><span class="ident" id="5308360">size</span><span class="op" id="5308364">]</span><span class="op" id="5308365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5308369">}</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5308373">first</span>&nbsp;<span class="op" id="5308379">=</span>&nbsp;<span class="builtintype" id="5308381">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5308390">//&nbsp;Look&nbsp;for&nbsp;POSIX&nbsp;[:alnum:]&nbsp;etc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308425">if</span>&nbsp;<span class="builtinfunc" id="5308428">len</span><span class="op" id="5308431">(</span><span class="ident" id="5308432">t</span><span class="op" id="5308433">)</span>&nbsp;<span class="op" id="5308435">&gt;</span>&nbsp;<span class="num" id="5308437">2</span>&nbsp;<span class="op" id="5308439">&amp;&amp;</span>&nbsp;<span class="ident" id="5308442">t</span><span class="op" id="5308443">[</span><span class="num" id="5308444">0</span><span class="op" id="5308445">]</span>&nbsp;<span class="op" id="5308447">==</span>&nbsp;<span class="string" id="5308450">&#39;[&#39;</span>&nbsp;<span class="op" id="5308454">&amp;&amp;</span>&nbsp;<span class="ident" id="5308457">t</span><span class="op" id="5308458">[</span><span class="num" id="5308459">1</span><span class="op" id="5308460">]</span>&nbsp;<span class="op" id="5308462">==</span>&nbsp;<span class="string" id="5308465">&#39;:&#39;</span>&nbsp;<span class="op" id="5308469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5308474">nclass</span><span class="op" id="5308480">,</span>&nbsp;<span class="ident" id="5308482">nt</span><span class="op" id="5308484">,</span>&nbsp;<span class="ident" id="5308486">err</span>&nbsp;<span class="op" id="5308490">:=</span>&nbsp;<span class="ident" id="5308493">p</span><span class="op" id="5308494">.</span><span class="ident" id="5308495">parseNamedClass</span><span class="op" id="5308510">(</span><span class="ident" id="5308511">t</span><span class="op" id="5308512">,</span>&nbsp;<span class="ident" id="5308514">class</span><span class="op" id="5308519">)</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308524">if</span>&nbsp;<span class="ident" id="5308527">err</span>&nbsp;<span class="op" id="5308531">!=</span>&nbsp;<span class="ident" id="5308534">nil</span>&nbsp;<span class="op" id="5308538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308544">return</span>&nbsp;<span class="string" id="5308551">&#34;&#34;</span><span class="op" id="5308553">,</span>&nbsp;<span class="ident" id="5308555">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5308562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308567">if</span>&nbsp;<span class="ident" id="5308570">nclass</span>&nbsp;<span class="op" id="5308577">!=</span>&nbsp;<span class="ident" id="5308580">nil</span>&nbsp;<span class="op" id="5308584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5308590">class</span><span class="op" id="5308595">,</span>&nbsp;<span class="ident" id="5308597">t</span>&nbsp;<span class="op" id="5308599">=</span>&nbsp;<span class="ident" id="5308601">nclass</span><span class="op" id="5308607">,</span>&nbsp;<span class="ident" id="5308609">nt</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308616">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5308628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5308632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5308637">//&nbsp;Look&nbsp;for&nbsp;Unicode&nbsp;character&nbsp;group&nbsp;like&nbsp;\p{Han}.</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5308689">nclass</span><span class="op" id="5308695">,</span>&nbsp;<span class="ident" id="5308697">nt</span><span class="op" id="5308699">,</span>&nbsp;<span class="ident" id="5308701">err</span>&nbsp;<span class="op" id="5308705">:=</span>&nbsp;<span class="ident" id="5308708">p</span><span class="op" id="5308709">.</span><span class="ident" id="5308710">parseUnicodeClass</span><span class="op" id="5308727">(</span><span class="ident" id="5308728">t</span><span class="op" id="5308729">,</span>&nbsp;<span class="ident" id="5308731">class</span><span class="op" id="5308736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308740">if</span>&nbsp;<span class="ident" id="5308743">err</span>&nbsp;<span class="op" id="5308747">!=</span>&nbsp;<span class="ident" id="5308750">nil</span>&nbsp;<span class="op" id="5308754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308759">return</span>&nbsp;<span class="string" id="5308766">&#34;&#34;</span><span class="op" id="5308768">,</span>&nbsp;<span class="ident" id="5308770">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5308776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308780">if</span>&nbsp;<span class="ident" id="5308783">nclass</span>&nbsp;<span class="op" id="5308790">!=</span>&nbsp;<span class="ident" id="5308793">nil</span>&nbsp;<span class="op" id="5308797">{</span><br>
<span class="lineno">1565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5308802">class</span><span class="op" id="5308807">,</span>&nbsp;<span class="ident" id="5308809">t</span>&nbsp;<span class="op" id="5308811">=</span>&nbsp;<span class="ident" id="5308813">nclass</span><span class="op" id="5308819">,</span>&nbsp;<span class="ident" id="5308821">nt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308827">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5308838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5308843">//&nbsp;Look&nbsp;for&nbsp;Perl&nbsp;character&nbsp;class&nbsp;symbols&nbsp;(extension).</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308899">if</span>&nbsp;<span class="ident" id="5308902">nclass</span><span class="op" id="5308908">,</span>&nbsp;<span class="ident" id="5308910">nt</span>&nbsp;<span class="op" id="5308913">:=</span>&nbsp;<span class="ident" id="5308916">p</span><span class="op" id="5308917">.</span><span class="ident" id="5308918">parsePerlClassEscape</span><span class="op" id="5308938">(</span><span class="ident" id="5308939">t</span><span class="op" id="5308940">,</span>&nbsp;<span class="ident" id="5308942">class</span><span class="op" id="5308947">)</span><span class="op" id="5308948">;</span>&nbsp;<span class="ident" id="5308950">nclass</span>&nbsp;<span class="op" id="5308957">!=</span>&nbsp;<span class="ident" id="5308960">nil</span>&nbsp;<span class="op" id="5308964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5308969">class</span><span class="op" id="5308974">,</span>&nbsp;<span class="ident" id="5308976">t</span>&nbsp;<span class="op" id="5308978">=</span>&nbsp;<span class="ident" id="5308980">nclass</span><span class="op" id="5308986">,</span>&nbsp;<span class="ident" id="5308988">nt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5308994">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5309005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5309010">//&nbsp;Single&nbsp;character&nbsp;or&nbsp;simple&nbsp;range.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309049">rng</span>&nbsp;<span class="op" id="5309053">:=</span>&nbsp;<span class="ident" id="5309056">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5309060">var</span>&nbsp;<span class="ident" id="5309064">lo</span><span class="op" id="5309066">,</span>&nbsp;<span class="ident" id="5309068">hi</span>&nbsp;<span class="builtintype" id="5309071">rune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5309078">if</span>&nbsp;<span class="ident" id="5309081">lo</span><span class="op" id="5309083">,</span>&nbsp;<span class="ident" id="5309085">t</span><span class="op" id="5309086">,</span>&nbsp;<span class="ident" id="5309088">err</span>&nbsp;<span class="op" id="5309092">=</span>&nbsp;<span class="ident" id="5309094">p</span><span class="op" id="5309095">.</span><span class="ident" id="5309096">parseClassChar</span><span class="op" id="5309110">(</span><span class="ident" id="5309111">t</span><span class="op" id="5309112">,</span>&nbsp;<span class="ident" id="5309114">s</span><span class="op" id="5309115">)</span><span class="op" id="5309116">;</span>&nbsp;<span class="ident" id="5309118">err</span>&nbsp;<span class="op" id="5309122">!=</span>&nbsp;<span class="ident" id="5309125">nil</span>&nbsp;<span class="op" id="5309129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5309134">return</span>&nbsp;<span class="string" id="5309141">&#34;&#34;</span><span class="op" id="5309143">,</span>&nbsp;<span class="ident" id="5309145">err</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5309151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309155">hi</span>&nbsp;<span class="op" id="5309158">=</span>&nbsp;<span class="ident" id="5309160">lo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5309165">//&nbsp;[a-]&nbsp;means&nbsp;(a|-)&nbsp;so&nbsp;check&nbsp;for&nbsp;final&nbsp;].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5309209">if</span>&nbsp;<span class="builtinfunc" id="5309212">len</span><span class="op" id="5309215">(</span><span class="ident" id="5309216">t</span><span class="op" id="5309217">)</span>&nbsp;<span class="op" id="5309219">&gt;=</span>&nbsp;<span class="num" id="5309222">2</span>&nbsp;<span class="op" id="5309224">&amp;&amp;</span>&nbsp;<span class="ident" id="5309227">t</span><span class="op" id="5309228">[</span><span class="num" id="5309229">0</span><span class="op" id="5309230">]</span>&nbsp;<span class="op" id="5309232">==</span>&nbsp;<span class="string" id="5309235">&#39;-&#39;</span>&nbsp;<span class="op" id="5309239">&amp;&amp;</span>&nbsp;<span class="ident" id="5309242">t</span><span class="op" id="5309243">[</span><span class="num" id="5309244">1</span><span class="op" id="5309245">]</span>&nbsp;<span class="op" id="5309247">!=</span>&nbsp;<span class="string" id="5309250">&#39;]&#39;</span>&nbsp;<span class="op" id="5309254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309259">t</span>&nbsp;<span class="op" id="5309261">=</span>&nbsp;<span class="ident" id="5309263">t</span><span class="op" id="5309264">[</span><span class="num" id="5309265">1</span><span class="op" id="5309266">:</span><span class="op" id="5309267">]</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5309272">if</span>&nbsp;<span class="ident" id="5309275">hi</span><span class="op" id="5309277">,</span>&nbsp;<span class="ident" id="5309279">t</span><span class="op" id="5309280">,</span>&nbsp;<span class="ident" id="5309282">err</span>&nbsp;<span class="op" id="5309286">=</span>&nbsp;<span class="ident" id="5309288">p</span><span class="op" id="5309289">.</span><span class="ident" id="5309290">parseClassChar</span><span class="op" id="5309304">(</span><span class="ident" id="5309305">t</span><span class="op" id="5309306">,</span>&nbsp;<span class="ident" id="5309308">s</span><span class="op" id="5309309">)</span><span class="op" id="5309310">;</span>&nbsp;<span class="ident" id="5309312">err</span>&nbsp;<span class="op" id="5309316">!=</span>&nbsp;<span class="ident" id="5309319">nil</span>&nbsp;<span class="op" id="5309323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5309329">return</span>&nbsp;<span class="string" id="5309336">&#34;&#34;</span><span class="op" id="5309338">,</span>&nbsp;<span class="ident" id="5309340">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5309347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5309352">if</span>&nbsp;<span class="ident" id="5309355">hi</span>&nbsp;<span class="op" id="5309358">&lt;</span>&nbsp;<span class="ident" id="5309360">lo</span>&nbsp;<span class="op" id="5309363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309369">rng</span>&nbsp;<span class="op" id="5309373">=</span>&nbsp;<span class="ident" id="5309375">rng</span><span class="op" id="5309378">[</span><span class="op" id="5309379">:</span><span class="builtinfunc" id="5309380">len</span><span class="op" id="5309383">(</span><span class="ident" id="5309384">rng</span><span class="op" id="5309387">)</span><span class="op" id="5309388">-</span><span class="builtinfunc" id="5309389">len</span><span class="op" id="5309392">(</span><span class="ident" id="5309393">t</span><span class="op" id="5309394">)</span><span class="op" id="5309395">]</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5309401">return</span>&nbsp;<span class="string" id="5309408">&#34;&#34;</span><span class="op" id="5309410">,</span>&nbsp;<span class="op" id="5309412">&amp;</span><span class="ident" id="5309413">Error</span><span class="op" id="5309418">{</span><span class="ident" id="5309419">Code</span><span class="op" id="5309423">:</span>&nbsp;<span class="ident" id="5309425">ErrInvalidCharRange</span><span class="op" id="5309444">,</span>&nbsp;<span class="ident" id="5309446">Expr</span><span class="op" id="5309450">:</span>&nbsp;<span class="ident" id="5309452">rng</span><span class="op" id="5309455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5309460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5309464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5309468">if</span>&nbsp;<span class="ident" id="5309471">p</span><span class="op" id="5309472">.</span><span class="ident" id="5309473">flags</span><span class="op" id="5309478">&amp;</span><span class="ident" id="5309479">FoldCase</span>&nbsp;<span class="op" id="5309488">==</span>&nbsp;<span class="num" id="5309491">0</span>&nbsp;<span class="op" id="5309493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309498">class</span>&nbsp;<span class="op" id="5309504">=</span>&nbsp;<span class="ident" id="5309506">appendRange</span><span class="op" id="5309517">(</span><span class="ident" id="5309518">class</span><span class="op" id="5309523">,</span>&nbsp;<span class="ident" id="5309525">lo</span><span class="op" id="5309527">,</span>&nbsp;<span class="ident" id="5309529">hi</span><span class="op" id="5309531">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5309535">}</span>&nbsp;<span class="keyword" id="5309537">else</span>&nbsp;<span class="op" id="5309542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309547">class</span>&nbsp;<span class="op" id="5309553">=</span>&nbsp;<span class="ident" id="5309555">appendFoldedRange</span><span class="op" id="5309572">(</span><span class="ident" id="5309573">class</span><span class="op" id="5309578">,</span>&nbsp;<span class="ident" id="5309580">lo</span><span class="op" id="5309582">,</span>&nbsp;<span class="ident" id="5309584">hi</span><span class="op" id="5309586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5309590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5309593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309596">t</span>&nbsp;<span class="op" id="5309598">=</span>&nbsp;<span class="ident" id="5309600">t</span><span class="op" id="5309601">[</span><span class="num" id="5309602">1</span><span class="op" id="5309603">:</span><span class="op" id="5309604">]</span>&nbsp;<span class="comment" id="5309606">//&nbsp;chop&nbsp;]</span><br>
<span class="lineno">1600</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5309618">//&nbsp;Use&nbsp;&amp;re.Rune&nbsp;instead&nbsp;of&nbsp;&amp;class&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309674">re</span><span class="op" id="5309676">.</span><span class="ident" id="5309677">Rune</span>&nbsp;<span class="op" id="5309682">=</span>&nbsp;<span class="ident" id="5309684">class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309691">class</span>&nbsp;<span class="op" id="5309697">=</span>&nbsp;<span class="ident" id="5309699">cleanClass</span><span class="op" id="5309709">(</span><span class="op" id="5309710">&amp;</span><span class="ident" id="5309711">re</span><span class="op" id="5309713">.</span><span class="ident" id="5309714">Rune</span><span class="op" id="5309718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5309721">if</span>&nbsp;<span class="ident" id="5309724">sign</span>&nbsp;<span class="op" id="5309729">&lt;</span>&nbsp;<span class="num" id="5309731">0</span>&nbsp;<span class="op" id="5309733">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309737">class</span>&nbsp;<span class="op" id="5309743">=</span>&nbsp;<span class="ident" id="5309745">negateClass</span><span class="op" id="5309756">(</span><span class="ident" id="5309757">class</span><span class="op" id="5309762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5309765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309768">re</span><span class="op" id="5309770">.</span><span class="ident" id="5309771">Rune</span>&nbsp;<span class="op" id="5309776">=</span>&nbsp;<span class="ident" id="5309778">class</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5309785">p</span><span class="op" id="5309786">.</span><span class="ident" id="5309787">push</span><span class="op" id="5309791">(</span><span class="ident" id="5309792">re</span><span class="op" id="5309794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5309797">return</span>&nbsp;<span class="ident" id="5309804">t</span><span class="op" id="5309805">,</span>&nbsp;<span class="ident" id="5309807">nil</span><br>
<span class="lineno">1610</span><span class="op" id="5309811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5309814">//&nbsp;cleanClass&nbsp;sorts&nbsp;the&nbsp;ranges&nbsp;(pairs&nbsp;of&nbsp;elements&nbsp;of&nbsp;r),</span><br>
<span class="lineno"></span><span class="comment" id="5309871">//&nbsp;merges&nbsp;them,&nbsp;and&nbsp;eliminates&nbsp;duplicates.</span><br>
<span class="lineno"></span><span class="keyword" id="5309914">func</span>&nbsp;<span class="ident" id="5309919">cleanClass</span><span class="op" id="5309929">(</span><span class="ident" id="5309930">rp</span>&nbsp;<span class="op" id="5309933">*</span><span class="op" id="5309934">[</span><span class="op" id="5309935">]</span><span class="builtintype" id="5309936">rune</span><span class="op" id="5309940">)</span>&nbsp;<span class="op" id="5309942">[</span><span class="op" id="5309943">]</span><span class="builtintype" id="5309944">rune</span>&nbsp;<span class="op" id="5309949">{</span><br>
<span class="lineno">1615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5309953">//&nbsp;Sort&nbsp;by&nbsp;lo&nbsp;increasing,&nbsp;hi&nbsp;decreasing&nbsp;to&nbsp;break&nbsp;ties.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5310009">sort</span><span class="op" id="5310013">.</span><span class="ident" id="5310014">Sort</span><span class="op" id="5310018">(</span><span class="ident" id="5310019">ranges</span><span class="op" id="5310025">{</span><span class="ident" id="5310026">rp</span><span class="op" id="5310028">}</span><span class="op" id="5310029">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5310033">r</span>&nbsp;<span class="op" id="5310035">:=</span>&nbsp;<span class="op" id="5310038">*</span><span class="ident" id="5310039">rp</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5310043">if</span>&nbsp;<span class="builtinfunc" id="5310046">len</span><span class="op" id="5310049">(</span><span class="ident" id="5310050">r</span><span class="op" id="5310051">)</span>&nbsp;<span class="op" id="5310053">&lt;</span>&nbsp;<span class="num" id="5310055">2</span>&nbsp;<span class="op" id="5310057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5310061">return</span>&nbsp;<span class="ident" id="5310068">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5310071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5310075">//&nbsp;Merge&nbsp;abutting,&nbsp;overlapping.</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5310108">w</span>&nbsp;<span class="op" id="5310110">:=</span>&nbsp;<span class="num" id="5310113">2</span>&nbsp;<span class="comment" id="5310115">//&nbsp;write&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5310131">for</span>&nbsp;<span class="ident" id="5310135">i</span>&nbsp;<span class="op" id="5310137">:=</span>&nbsp;<span class="num" id="5310140">2</span><span class="op" id="5310141">;</span>&nbsp;<span class="ident" id="5310143">i</span>&nbsp;<span class="op" id="5310145">&lt;</span>&nbsp;<span class="builtinfunc" id="5310147">len</span><span class="op" id="5310150">(</span><span class="ident" id="5310151">r</span><span class="op" id="5310152">)</span><span class="op" id="5310153">;</span>&nbsp;<span class="ident" id="5310155">i</span>&nbsp;<span class="op" id="5310157">+=</span>&nbsp;<span class="num" id="5310160">2</span>&nbsp;<span class="op" id="5310162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5310166">lo</span><span class="op" id="5310168">,</span>&nbsp;<span class="ident" id="5310170">hi</span>&nbsp;<span class="op" id="5310173">:=</span>&nbsp;<span class="ident" id="5310176">r</span><span class="op" id="5310177">[</span><span class="ident" id="5310178">i</span><span class="op" id="5310179">]</span><span class="op" id="5310180">,</span>&nbsp;<span class="ident" id="5310182">r</span><span class="op" id="5310183">[</span><span class="ident" id="5310184">i</span><span class="op" id="5310185">+</span><span class="num" id="5310186">1</span><span class="op" id="5310187">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5310191">if</span>&nbsp;<span class="ident" id="5310194">lo</span>&nbsp;<span class="op" id="5310197">&lt;=</span>&nbsp;<span class="ident" id="5310200">r</span><span class="op" id="5310201">[</span><span class="ident" id="5310202">w</span><span class="op" id="5310203">-</span><span class="num" id="5310204">1</span><span class="op" id="5310205">]</span><span class="op" id="5310206">+</span><span class="num" id="5310207">1</span>&nbsp;<span class="op" id="5310209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5310214">//&nbsp;merge&nbsp;with&nbsp;previous&nbsp;range</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5310246">if</span>&nbsp;<span class="ident" id="5310249">hi</span>&nbsp;<span class="op" id="5310252">&gt;</span>&nbsp;<span class="ident" id="5310254">r</span><span class="op" id="5310255">[</span><span class="ident" id="5310256">w</span><span class="op" id="5310257">-</span><span class="num" id="5310258">1</span><span class="op" id="5310259">]</span>&nbsp;<span class="op" id="5310261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5310267">r</span><span class="op" id="5310268">[</span><span class="ident" id="5310269">w</span><span class="op" id="5310270">-</span><span class="num" id="5310271">1</span><span class="op" id="5310272">]</span>&nbsp;<span class="op" id="5310274">=</span>&nbsp;<span class="ident" id="5310276">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5310282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5310287">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5310298">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5310302">//&nbsp;new&nbsp;disjoint&nbsp;range</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5310326">r</span><span class="op" id="5310327">[</span><span class="ident" id="5310328">w</span><span class="op" id="5310329">]</span>&nbsp;<span class="op" id="5310331">=</span>&nbsp;<span class="ident" id="5310333">lo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5310338">r</span><span class="op" id="5310339">[</span><span class="ident" id="5310340">w</span><span class="op" id="5310341">+</span><span class="num" id="5310342">1</span><span class="op" id="5310343">]</span>&nbsp;<span class="op" id="5310345">=</span>&nbsp;<span class="ident" id="5310347">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5310352">w</span>&nbsp;<span class="op" id="5310354">+=</span>&nbsp;<span class="num" id="5310357">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5310360">}</span><br>
<span class="lineno">1640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5310364">return</span>&nbsp;<span class="ident" id="5310371">r</span><span class="op" id="5310372">[</span><span class="op" id="5310373">:</span><span class="ident" id="5310374">w</span><span class="op" id="5310375">]</span><br>
<span class="lineno"></span><span class="op" id="5310377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5310380">//&nbsp;appendLiteral&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;literal&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno">1645</span><span class="keyword" id="5310459">func</span>&nbsp;<span class="ident" id="5310464">appendLiteral</span><span class="op" id="5310477">(</span><span class="ident" id="5310478">r</span>&nbsp;<span class="op" id="5310480">[</span><span class="op" id="5310481">]</span><span class="builtintype" id="5310482">rune</span><span class="op" id="5310486">,</span>&nbsp;<span class="ident" id="5310488">x</span>&nbsp;<span class="builtintype" id="5310490">rune</span><span class="op" id="5310494">,</span>&nbsp;<span class="ident" id="5310496">flags</span>&nbsp;<span class="ident" id="5310502">Flags</span><span class="op" id="5310507">)</span>&nbsp;<span class="op" id="5310509">[</span><span class="op" id="5310510">]</span><span class="builtintype" id="5310511">rune</span>&nbsp;<span class="op" id="5310516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5310519">if</span>&nbsp;<span class="ident" id="5310522">flags</span><span class="op" id="5310527">&amp;</span><span class="ident" id="5310528">FoldCase</span>&nbsp;<span class="op" id="5310537">!=</span>&nbsp;<span class="num" id="5310540">0</span>&nbsp;<span class="op" id="5310542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5310546">return</span>&nbsp;<span class="ident" id="5310553">appendFoldedRange</span><span class="op" id="5310570">(</span><span class="ident" id="5310571">r</span><span class="op" id="5310572">,</span>&nbsp;<span class="ident" id="5310574">x</span><span class="op" id="5310575">,</span>&nbsp;<span class="ident" id="5310577">x</span><span class="op" id="5310578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5310581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5310584">return</span>&nbsp;<span class="ident" id="5310591">appendRange</span><span class="op" id="5310602">(</span><span class="ident" id="5310603">r</span><span class="op" id="5310604">,</span>&nbsp;<span class="ident" id="5310606">x</span><span class="op" id="5310607">,</span>&nbsp;<span class="ident" id="5310609">x</span><span class="op" id="5310610">)</span><br>
<span class="lineno">1650</span><span class="op" id="5310612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5310615">//&nbsp;appendRange&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;range&nbsp;lo-hi&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5310694">func</span>&nbsp;<span class="ident" id="5310699">appendRange</span><span class="op" id="5310710">(</span><span class="ident" id="5310711">r</span>&nbsp;<span class="op" id="5310713">[</span><span class="op" id="5310714">]</span><span class="builtintype" id="5310715">rune</span><span class="op" id="5310719">,</span>&nbsp;<span class="ident" id="5310721">lo</span><span class="op" id="5310723">,</span>&nbsp;<span class="ident" id="5310725">hi</span>&nbsp;<span class="builtintype" id="5310728">rune</span><span class="op" id="5310732">)</span>&nbsp;<span class="op" id="5310734">[</span><span class="op" id="5310735">]</span><span class="builtintype" id="5310736">rune</span>&nbsp;<span class="op" id="5310741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5310744">//&nbsp;Expand&nbsp;last&nbsp;range&nbsp;or&nbsp;next&nbsp;to&nbsp;last&nbsp;range&nbsp;if&nbsp;it&nbsp;overlaps&nbsp;or&nbsp;abuts.</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5310813">//&nbsp;Checking&nbsp;two&nbsp;ranges&nbsp;helps&nbsp;when&nbsp;appending&nbsp;case-folded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5310870">//&nbsp;alphabets,&nbsp;so&nbsp;that&nbsp;one&nbsp;range&nbsp;can&nbsp;be&nbsp;expanding&nbsp;A-Z&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5310932">//&nbsp;other&nbsp;expanding&nbsp;a-z.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5310957">n</span>&nbsp;<span class="op" id="5310959">:=</span>&nbsp;<span class="builtinfunc" id="5310962">len</span><span class="op" id="5310965">(</span><span class="ident" id="5310966">r</span><span class="op" id="5310967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5310970">for</span>&nbsp;<span class="ident" id="5310974">i</span>&nbsp;<span class="op" id="5310976">:=</span>&nbsp;<span class="num" id="5310979">2</span><span class="op" id="5310980">;</span>&nbsp;<span class="ident" id="5310982">i</span>&nbsp;<span class="op" id="5310984">&lt;=</span>&nbsp;<span class="num" id="5310987">4</span><span class="op" id="5310988">;</span>&nbsp;<span class="ident" id="5310990">i</span>&nbsp;<span class="op" id="5310992">+=</span>&nbsp;<span class="num" id="5310995">2</span>&nbsp;<span class="op" id="5310997">{</span>&nbsp;<span class="comment" id="5310999">//&nbsp;twice,&nbsp;using&nbsp;i=2,&nbsp;i=4</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311026">if</span>&nbsp;<span class="ident" id="5311029">n</span>&nbsp;<span class="op" id="5311031">&gt;=</span>&nbsp;<span class="ident" id="5311034">i</span>&nbsp;<span class="op" id="5311036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311041">rlo</span><span class="op" id="5311044">,</span>&nbsp;<span class="ident" id="5311046">rhi</span>&nbsp;<span class="op" id="5311050">:=</span>&nbsp;<span class="ident" id="5311053">r</span><span class="op" id="5311054">[</span><span class="ident" id="5311055">n</span><span class="op" id="5311056">-</span><span class="ident" id="5311057">i</span><span class="op" id="5311058">]</span><span class="op" id="5311059">,</span>&nbsp;<span class="ident" id="5311061">r</span><span class="op" id="5311062">[</span><span class="ident" id="5311063">n</span><span class="op" id="5311064">-</span><span class="ident" id="5311065">i</span><span class="op" id="5311066">+</span><span class="num" id="5311067">1</span><span class="op" id="5311068">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311073">if</span>&nbsp;<span class="ident" id="5311076">lo</span>&nbsp;<span class="op" id="5311079">&lt;=</span>&nbsp;<span class="ident" id="5311082">rhi</span><span class="op" id="5311085">+</span><span class="num" id="5311086">1</span>&nbsp;<span class="op" id="5311088">&amp;&amp;</span>&nbsp;<span class="ident" id="5311091">rlo</span>&nbsp;<span class="op" id="5311095">&lt;=</span>&nbsp;<span class="ident" id="5311098">hi</span><span class="op" id="5311100">+</span><span class="num" id="5311101">1</span>&nbsp;<span class="op" id="5311103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311109">if</span>&nbsp;<span class="ident" id="5311112">lo</span>&nbsp;<span class="op" id="5311115">&lt;</span>&nbsp;<span class="ident" id="5311117">rlo</span>&nbsp;<span class="op" id="5311121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311128">r</span><span class="op" id="5311129">[</span><span class="ident" id="5311130">n</span><span class="op" id="5311131">-</span><span class="ident" id="5311132">i</span><span class="op" id="5311133">]</span>&nbsp;<span class="op" id="5311135">=</span>&nbsp;<span class="ident" id="5311137">lo</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5311144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311150">if</span>&nbsp;<span class="ident" id="5311153">hi</span>&nbsp;<span class="op" id="5311156">&gt;</span>&nbsp;<span class="ident" id="5311158">rhi</span>&nbsp;<span class="op" id="5311162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311169">r</span><span class="op" id="5311170">[</span><span class="ident" id="5311171">n</span><span class="op" id="5311172">-</span><span class="ident" id="5311173">i</span><span class="op" id="5311174">+</span><span class="num" id="5311175">1</span><span class="op" id="5311176">]</span>&nbsp;<span class="op" id="5311178">=</span>&nbsp;<span class="ident" id="5311180">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5311187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311193">return</span>&nbsp;<span class="ident" id="5311200">r</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5311205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5311209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5311212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311216">return</span>&nbsp;<span class="builtinfunc" id="5311223">append</span><span class="op" id="5311229">(</span><span class="ident" id="5311230">r</span><span class="op" id="5311231">,</span>&nbsp;<span class="ident" id="5311233">lo</span><span class="op" id="5311235">,</span>&nbsp;<span class="ident" id="5311237">hi</span><span class="op" id="5311239">)</span><br>
<span class="lineno">1675</span><span class="op" id="5311241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5311244">const</span>&nbsp;<span class="op" id="5311250">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5311253">//&nbsp;minimum&nbsp;and&nbsp;maximum&nbsp;runes&nbsp;involved&nbsp;in&nbsp;folding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5311304">//&nbsp;checked&nbsp;during&nbsp;test.</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311329">minFold</span>&nbsp;<span class="op" id="5311337">=</span>&nbsp;<span class="num" id="5311339">0x0041</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311347">maxFold</span>&nbsp;<span class="op" id="5311355">=</span>&nbsp;<span class="num" id="5311357">0x118df</span><br>
<span class="lineno"></span><span class="op" id="5311365">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5311368">//&nbsp;appendFoldedRange&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;range&nbsp;lo-hi</span><br>
<span class="lineno">1685</span><span class="comment" id="5311437">//&nbsp;and&nbsp;its&nbsp;case&nbsp;folding-equivalent&nbsp;runes&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5311494">func</span>&nbsp;<span class="ident" id="5311499">appendFoldedRange</span><span class="op" id="5311516">(</span><span class="ident" id="5311517">r</span>&nbsp;<span class="op" id="5311519">[</span><span class="op" id="5311520">]</span><span class="builtintype" id="5311521">rune</span><span class="op" id="5311525">,</span>&nbsp;<span class="ident" id="5311527">lo</span><span class="op" id="5311529">,</span>&nbsp;<span class="ident" id="5311531">hi</span>&nbsp;<span class="builtintype" id="5311534">rune</span><span class="op" id="5311538">)</span>&nbsp;<span class="op" id="5311540">[</span><span class="op" id="5311541">]</span><span class="builtintype" id="5311542">rune</span>&nbsp;<span class="op" id="5311547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5311550">//&nbsp;Optimizations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311569">if</span>&nbsp;<span class="ident" id="5311572">lo</span>&nbsp;<span class="op" id="5311575">&lt;=</span>&nbsp;<span class="ident" id="5311578">minFold</span>&nbsp;<span class="op" id="5311586">&amp;&amp;</span>&nbsp;<span class="ident" id="5311589">hi</span>&nbsp;<span class="op" id="5311592">&gt;=</span>&nbsp;<span class="ident" id="5311595">maxFold</span>&nbsp;<span class="op" id="5311603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5311607">//&nbsp;Range&nbsp;is&nbsp;full:&nbsp;folding&nbsp;can&#39;t&nbsp;add&nbsp;more.</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311651">return</span>&nbsp;<span class="ident" id="5311658">appendRange</span><span class="op" id="5311669">(</span><span class="ident" id="5311670">r</span><span class="op" id="5311671">,</span>&nbsp;<span class="ident" id="5311673">lo</span><span class="op" id="5311675">,</span>&nbsp;<span class="ident" id="5311677">hi</span><span class="op" id="5311679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5311682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311685">if</span>&nbsp;<span class="ident" id="5311688">hi</span>&nbsp;<span class="op" id="5311691">&lt;</span>&nbsp;<span class="ident" id="5311693">minFold</span>&nbsp;<span class="op" id="5311701">||</span>&nbsp;<span class="ident" id="5311704">lo</span>&nbsp;<span class="op" id="5311707">&gt;</span>&nbsp;<span class="ident" id="5311709">maxFold</span>&nbsp;<span class="op" id="5311717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5311721">//&nbsp;Range&nbsp;is&nbsp;outside&nbsp;folding&nbsp;possibilities.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311766">return</span>&nbsp;<span class="ident" id="5311773">appendRange</span><span class="op" id="5311784">(</span><span class="ident" id="5311785">r</span><span class="op" id="5311786">,</span>&nbsp;<span class="ident" id="5311788">lo</span><span class="op" id="5311790">,</span>&nbsp;<span class="ident" id="5311792">hi</span><span class="op" id="5311794">)</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5311797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311800">if</span>&nbsp;<span class="ident" id="5311803">lo</span>&nbsp;<span class="op" id="5311806">&lt;</span>&nbsp;<span class="ident" id="5311808">minFold</span>&nbsp;<span class="op" id="5311816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5311820">//&nbsp;[lo,&nbsp;minFold-1]&nbsp;needs&nbsp;no&nbsp;folding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311859">r</span>&nbsp;<span class="op" id="5311861">=</span>&nbsp;<span class="ident" id="5311863">appendRange</span><span class="op" id="5311874">(</span><span class="ident" id="5311875">r</span><span class="op" id="5311876">,</span>&nbsp;<span class="ident" id="5311878">lo</span><span class="op" id="5311880">,</span>&nbsp;<span class="ident" id="5311882">minFold</span><span class="op" id="5311889">-</span><span class="num" id="5311890">1</span><span class="op" id="5311891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311895">lo</span>&nbsp;<span class="op" id="5311898">=</span>&nbsp;<span class="ident" id="5311900">minFold</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5311909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5311912">if</span>&nbsp;<span class="ident" id="5311915">hi</span>&nbsp;<span class="op" id="5311918">&gt;</span>&nbsp;<span class="ident" id="5311920">maxFold</span>&nbsp;<span class="op" id="5311928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5311932">//&nbsp;[maxFold+1,&nbsp;hi]&nbsp;needs&nbsp;no&nbsp;folding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5311971">r</span>&nbsp;<span class="op" id="5311973">=</span>&nbsp;<span class="ident" id="5311975">appendRange</span><span class="op" id="5311986">(</span><span class="ident" id="5311987">r</span><span class="op" id="5311988">,</span>&nbsp;<span class="ident" id="5311990">maxFold</span><span class="op" id="5311997">+</span><span class="num" id="5311998">1</span><span class="op" id="5311999">,</span>&nbsp;<span class="ident" id="5312001">hi</span><span class="op" id="5312003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312007">hi</span>&nbsp;<span class="op" id="5312010">=</span>&nbsp;<span class="ident" id="5312012">maxFold</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5312021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5312025">//&nbsp;Brute&nbsp;force.&nbsp;&nbsp;Depend&nbsp;on&nbsp;appendRange&nbsp;to&nbsp;coalesce&nbsp;ranges&nbsp;on&nbsp;the&nbsp;fly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312096">for</span>&nbsp;<span class="ident" id="5312100">c</span>&nbsp;<span class="op" id="5312102">:=</span>&nbsp;<span class="ident" id="5312105">lo</span><span class="op" id="5312107">;</span>&nbsp;<span class="ident" id="5312109">c</span>&nbsp;<span class="op" id="5312111">&lt;=</span>&nbsp;<span class="ident" id="5312114">hi</span><span class="op" id="5312116">;</span>&nbsp;<span class="ident" id="5312118">c</span><span class="op" id="5312119">++</span>&nbsp;<span class="op" id="5312122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312126">r</span>&nbsp;<span class="op" id="5312128">=</span>&nbsp;<span class="ident" id="5312130">appendRange</span><span class="op" id="5312141">(</span><span class="ident" id="5312142">r</span><span class="op" id="5312143">,</span>&nbsp;<span class="ident" id="5312145">c</span><span class="op" id="5312146">,</span>&nbsp;<span class="ident" id="5312148">c</span><span class="op" id="5312149">)</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312153">f</span>&nbsp;<span class="op" id="5312155">:=</span>&nbsp;<span class="ident" id="5312158">unicode</span><span class="op" id="5312165">.</span><span class="ident" id="5312166">SimpleFold</span><span class="op" id="5312176">(</span><span class="ident" id="5312177">c</span><span class="op" id="5312178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312182">for</span>&nbsp;<span class="ident" id="5312186">f</span>&nbsp;<span class="op" id="5312188">!=</span>&nbsp;<span class="ident" id="5312191">c</span>&nbsp;<span class="op" id="5312193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312198">r</span>&nbsp;<span class="op" id="5312200">=</span>&nbsp;<span class="ident" id="5312202">appendRange</span><span class="op" id="5312213">(</span><span class="ident" id="5312214">r</span><span class="op" id="5312215">,</span>&nbsp;<span class="ident" id="5312217">f</span><span class="op" id="5312218">,</span>&nbsp;<span class="ident" id="5312220">f</span><span class="op" id="5312221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312226">f</span>&nbsp;<span class="op" id="5312228">=</span>&nbsp;<span class="ident" id="5312230">unicode</span><span class="op" id="5312237">.</span><span class="ident" id="5312238">SimpleFold</span><span class="op" id="5312248">(</span><span class="ident" id="5312249">f</span><span class="op" id="5312250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5312254">}</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5312257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312260">return</span>&nbsp;<span class="ident" id="5312267">r</span><br>
<span class="lineno"></span><span class="op" id="5312269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5312272">//&nbsp;appendClass&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;class&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno">1720</span><span class="comment" id="5312347">//&nbsp;It&nbsp;assume&nbsp;x&nbsp;is&nbsp;clean.</span><br>
<span class="lineno"></span><span class="keyword" id="5312372">func</span>&nbsp;<span class="ident" id="5312377">appendClass</span><span class="op" id="5312388">(</span><span class="ident" id="5312389">r</span>&nbsp;<span class="op" id="5312391">[</span><span class="op" id="5312392">]</span><span class="builtintype" id="5312393">rune</span><span class="op" id="5312397">,</span>&nbsp;<span class="ident" id="5312399">x</span>&nbsp;<span class="op" id="5312401">[</span><span class="op" id="5312402">]</span><span class="builtintype" id="5312403">rune</span><span class="op" id="5312407">)</span>&nbsp;<span class="op" id="5312409">[</span><span class="op" id="5312410">]</span><span class="builtintype" id="5312411">rune</span>&nbsp;<span class="op" id="5312416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312419">for</span>&nbsp;<span class="ident" id="5312423">i</span>&nbsp;<span class="op" id="5312425">:=</span>&nbsp;<span class="num" id="5312428">0</span><span class="op" id="5312429">;</span>&nbsp;<span class="ident" id="5312431">i</span>&nbsp;<span class="op" id="5312433">&lt;</span>&nbsp;<span class="builtinfunc" id="5312435">len</span><span class="op" id="5312438">(</span><span class="ident" id="5312439">x</span><span class="op" id="5312440">)</span><span class="op" id="5312441">;</span>&nbsp;<span class="ident" id="5312443">i</span>&nbsp;<span class="op" id="5312445">+=</span>&nbsp;<span class="num" id="5312448">2</span>&nbsp;<span class="op" id="5312450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312454">r</span>&nbsp;<span class="op" id="5312456">=</span>&nbsp;<span class="ident" id="5312458">appendRange</span><span class="op" id="5312469">(</span><span class="ident" id="5312470">r</span><span class="op" id="5312471">,</span>&nbsp;<span class="ident" id="5312473">x</span><span class="op" id="5312474">[</span><span class="ident" id="5312475">i</span><span class="op" id="5312476">]</span><span class="op" id="5312477">,</span>&nbsp;<span class="ident" id="5312479">x</span><span class="op" id="5312480">[</span><span class="ident" id="5312481">i</span><span class="op" id="5312482">+</span><span class="num" id="5312483">1</span><span class="op" id="5312484">]</span><span class="op" id="5312485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5312488">}</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312491">return</span>&nbsp;<span class="ident" id="5312498">r</span><br>
<span class="lineno"></span><span class="op" id="5312500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5312503">//&nbsp;appendFolded&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;case&nbsp;folding&nbsp;of&nbsp;the&nbsp;class&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5312599">func</span>&nbsp;<span class="ident" id="5312604">appendFoldedClass</span><span class="op" id="5312621">(</span><span class="ident" id="5312622">r</span>&nbsp;<span class="op" id="5312624">[</span><span class="op" id="5312625">]</span><span class="builtintype" id="5312626">rune</span><span class="op" id="5312630">,</span>&nbsp;<span class="ident" id="5312632">x</span>&nbsp;<span class="op" id="5312634">[</span><span class="op" id="5312635">]</span><span class="builtintype" id="5312636">rune</span><span class="op" id="5312640">)</span>&nbsp;<span class="op" id="5312642">[</span><span class="op" id="5312643">]</span><span class="builtintype" id="5312644">rune</span>&nbsp;<span class="op" id="5312649">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312652">for</span>&nbsp;<span class="ident" id="5312656">i</span>&nbsp;<span class="op" id="5312658">:=</span>&nbsp;<span class="num" id="5312661">0</span><span class="op" id="5312662">;</span>&nbsp;<span class="ident" id="5312664">i</span>&nbsp;<span class="op" id="5312666">&lt;</span>&nbsp;<span class="builtinfunc" id="5312668">len</span><span class="op" id="5312671">(</span><span class="ident" id="5312672">x</span><span class="op" id="5312673">)</span><span class="op" id="5312674">;</span>&nbsp;<span class="ident" id="5312676">i</span>&nbsp;<span class="op" id="5312678">+=</span>&nbsp;<span class="num" id="5312681">2</span>&nbsp;<span class="op" id="5312683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312687">r</span>&nbsp;<span class="op" id="5312689">=</span>&nbsp;<span class="ident" id="5312691">appendFoldedRange</span><span class="op" id="5312708">(</span><span class="ident" id="5312709">r</span><span class="op" id="5312710">,</span>&nbsp;<span class="ident" id="5312712">x</span><span class="op" id="5312713">[</span><span class="ident" id="5312714">i</span><span class="op" id="5312715">]</span><span class="op" id="5312716">,</span>&nbsp;<span class="ident" id="5312718">x</span><span class="op" id="5312719">[</span><span class="ident" id="5312720">i</span><span class="op" id="5312721">+</span><span class="num" id="5312722">1</span><span class="op" id="5312723">]</span><span class="op" id="5312724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5312727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312730">return</span>&nbsp;<span class="ident" id="5312737">r</span><br>
<span class="lineno"></span><span class="op" id="5312739">}</span><br>
<span class="lineno">1735</span><br>
<span class="lineno"></span><span class="comment" id="5312742">//&nbsp;appendNegatedClass&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;negation&nbsp;of&nbsp;the&nbsp;class&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="5312840">//&nbsp;It&nbsp;assumes&nbsp;x&nbsp;is&nbsp;clean.</span><br>
<span class="lineno"></span><span class="keyword" id="5312866">func</span>&nbsp;<span class="ident" id="5312871">appendNegatedClass</span><span class="op" id="5312889">(</span><span class="ident" id="5312890">r</span>&nbsp;<span class="op" id="5312892">[</span><span class="op" id="5312893">]</span><span class="builtintype" id="5312894">rune</span><span class="op" id="5312898">,</span>&nbsp;<span class="ident" id="5312900">x</span>&nbsp;<span class="op" id="5312902">[</span><span class="op" id="5312903">]</span><span class="builtintype" id="5312904">rune</span><span class="op" id="5312908">)</span>&nbsp;<span class="op" id="5312910">[</span><span class="op" id="5312911">]</span><span class="builtintype" id="5312912">rune</span>&nbsp;<span class="op" id="5312917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312920">nextLo</span>&nbsp;<span class="op" id="5312927">:=</span>&nbsp;<span class="string" id="5312930">&#39;\u0000&#39;</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5312940">for</span>&nbsp;<span class="ident" id="5312944">i</span>&nbsp;<span class="op" id="5312946">:=</span>&nbsp;<span class="num" id="5312949">0</span><span class="op" id="5312950">;</span>&nbsp;<span class="ident" id="5312952">i</span>&nbsp;<span class="op" id="5312954">&lt;</span>&nbsp;<span class="builtinfunc" id="5312956">len</span><span class="op" id="5312959">(</span><span class="ident" id="5312960">x</span><span class="op" id="5312961">)</span><span class="op" id="5312962">;</span>&nbsp;<span class="ident" id="5312964">i</span>&nbsp;<span class="op" id="5312966">+=</span>&nbsp;<span class="num" id="5312969">2</span>&nbsp;<span class="op" id="5312971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5312975">lo</span><span class="op" id="5312977">,</span>&nbsp;<span class="ident" id="5312979">hi</span>&nbsp;<span class="op" id="5312982">:=</span>&nbsp;<span class="ident" id="5312985">x</span><span class="op" id="5312986">[</span><span class="ident" id="5312987">i</span><span class="op" id="5312988">]</span><span class="op" id="5312989">,</span>&nbsp;<span class="ident" id="5312991">x</span><span class="op" id="5312992">[</span><span class="ident" id="5312993">i</span><span class="op" id="5312994">+</span><span class="num" id="5312995">1</span><span class="op" id="5312996">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313000">if</span>&nbsp;<span class="ident" id="5313003">nextLo</span>&nbsp;<span class="op" id="5313010">&lt;=</span>&nbsp;<span class="ident" id="5313013">lo</span><span class="op" id="5313015">-</span><span class="num" id="5313016">1</span>&nbsp;<span class="op" id="5313018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313023">r</span>&nbsp;<span class="op" id="5313025">=</span>&nbsp;<span class="ident" id="5313027">appendRange</span><span class="op" id="5313038">(</span><span class="ident" id="5313039">r</span><span class="op" id="5313040">,</span>&nbsp;<span class="ident" id="5313042">nextLo</span><span class="op" id="5313048">,</span>&nbsp;<span class="ident" id="5313050">lo</span><span class="op" id="5313052">-</span><span class="num" id="5313053">1</span><span class="op" id="5313054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5313058">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313062">nextLo</span>&nbsp;<span class="op" id="5313069">=</span>&nbsp;<span class="ident" id="5313071">hi</span>&nbsp;<span class="op" id="5313074">+</span>&nbsp;<span class="num" id="5313076">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5313079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313082">if</span>&nbsp;<span class="ident" id="5313085">nextLo</span>&nbsp;<span class="op" id="5313092">&lt;=</span>&nbsp;<span class="ident" id="5313095">unicode</span><span class="op" id="5313102">.</span><span class="ident" id="5313103">MaxRune</span>&nbsp;<span class="op" id="5313111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313115">r</span>&nbsp;<span class="op" id="5313117">=</span>&nbsp;<span class="ident" id="5313119">appendRange</span><span class="op" id="5313130">(</span><span class="ident" id="5313131">r</span><span class="op" id="5313132">,</span>&nbsp;<span class="ident" id="5313134">nextLo</span><span class="op" id="5313140">,</span>&nbsp;<span class="ident" id="5313142">unicode</span><span class="op" id="5313149">.</span><span class="ident" id="5313150">MaxRune</span><span class="op" id="5313157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5313160">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313163">return</span>&nbsp;<span class="ident" id="5313170">r</span><br>
<span class="lineno"></span><span class="op" id="5313172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5313175">//&nbsp;appendTable&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5313240">func</span>&nbsp;<span class="ident" id="5313245">appendTable</span><span class="op" id="5313256">(</span><span class="ident" id="5313257">r</span>&nbsp;<span class="op" id="5313259">[</span><span class="op" id="5313260">]</span><span class="builtintype" id="5313261">rune</span><span class="op" id="5313265">,</span>&nbsp;<span class="ident" id="5313267">x</span>&nbsp;<span class="op" id="5313269">*</span><span class="ident" id="5313270">unicode</span><span class="op" id="5313277">.</span><span class="ident" id="5313278">RangeTable</span><span class="op" id="5313288">)</span>&nbsp;<span class="op" id="5313290">[</span><span class="op" id="5313291">]</span><span class="builtintype" id="5313292">rune</span>&nbsp;<span class="op" id="5313297">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313300">for</span>&nbsp;<span class="ident" id="5313304">_</span><span class="op" id="5313305">,</span>&nbsp;<span class="ident" id="5313307">xr</span>&nbsp;<span class="op" id="5313310">:=</span>&nbsp;<span class="keyword" id="5313313">range</span>&nbsp;<span class="ident" id="5313319">x</span><span class="op" id="5313320">.</span><span class="ident" id="5313321">R16</span>&nbsp;<span class="op" id="5313325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313329">lo</span><span class="op" id="5313331">,</span>&nbsp;<span class="ident" id="5313333">hi</span><span class="op" id="5313335">,</span>&nbsp;<span class="ident" id="5313337">stride</span>&nbsp;<span class="op" id="5313344">:=</span>&nbsp;<span class="builtintype" id="5313347">rune</span><span class="op" id="5313351">(</span><span class="ident" id="5313352">xr</span><span class="op" id="5313354">.</span><span class="ident" id="5313355">Lo</span><span class="op" id="5313357">)</span><span class="op" id="5313358">,</span>&nbsp;<span class="builtintype" id="5313360">rune</span><span class="op" id="5313364">(</span><span class="ident" id="5313365">xr</span><span class="op" id="5313367">.</span><span class="ident" id="5313368">Hi</span><span class="op" id="5313370">)</span><span class="op" id="5313371">,</span>&nbsp;<span class="builtintype" id="5313373">rune</span><span class="op" id="5313377">(</span><span class="ident" id="5313378">xr</span><span class="op" id="5313380">.</span><span class="ident" id="5313381">Stride</span><span class="op" id="5313387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313391">if</span>&nbsp;<span class="ident" id="5313394">stride</span>&nbsp;<span class="op" id="5313401">==</span>&nbsp;<span class="num" id="5313404">1</span>&nbsp;<span class="op" id="5313406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313411">r</span>&nbsp;<span class="op" id="5313413">=</span>&nbsp;<span class="ident" id="5313415">appendRange</span><span class="op" id="5313426">(</span><span class="ident" id="5313427">r</span><span class="op" id="5313428">,</span>&nbsp;<span class="ident" id="5313430">lo</span><span class="op" id="5313432">,</span>&nbsp;<span class="ident" id="5313434">hi</span><span class="op" id="5313436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313441">continue</span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5313452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313456">for</span>&nbsp;<span class="ident" id="5313460">c</span>&nbsp;<span class="op" id="5313462">:=</span>&nbsp;<span class="ident" id="5313465">lo</span><span class="op" id="5313467">;</span>&nbsp;<span class="ident" id="5313469">c</span>&nbsp;<span class="op" id="5313471">&lt;=</span>&nbsp;<span class="ident" id="5313474">hi</span><span class="op" id="5313476">;</span>&nbsp;<span class="ident" id="5313478">c</span>&nbsp;<span class="op" id="5313480">+=</span>&nbsp;<span class="ident" id="5313483">stride</span>&nbsp;<span class="op" id="5313490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313495">r</span>&nbsp;<span class="op" id="5313497">=</span>&nbsp;<span class="ident" id="5313499">appendRange</span><span class="op" id="5313510">(</span><span class="ident" id="5313511">r</span><span class="op" id="5313512">,</span>&nbsp;<span class="ident" id="5313514">c</span><span class="op" id="5313515">,</span>&nbsp;<span class="ident" id="5313517">c</span><span class="op" id="5313518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5313522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5313525">}</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313528">for</span>&nbsp;<span class="ident" id="5313532">_</span><span class="op" id="5313533">,</span>&nbsp;<span class="ident" id="5313535">xr</span>&nbsp;<span class="op" id="5313538">:=</span>&nbsp;<span class="keyword" id="5313541">range</span>&nbsp;<span class="ident" id="5313547">x</span><span class="op" id="5313548">.</span><span class="ident" id="5313549">R32</span>&nbsp;<span class="op" id="5313553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313557">lo</span><span class="op" id="5313559">,</span>&nbsp;<span class="ident" id="5313561">hi</span><span class="op" id="5313563">,</span>&nbsp;<span class="ident" id="5313565">stride</span>&nbsp;<span class="op" id="5313572">:=</span>&nbsp;<span class="builtintype" id="5313575">rune</span><span class="op" id="5313579">(</span><span class="ident" id="5313580">xr</span><span class="op" id="5313582">.</span><span class="ident" id="5313583">Lo</span><span class="op" id="5313585">)</span><span class="op" id="5313586">,</span>&nbsp;<span class="builtintype" id="5313588">rune</span><span class="op" id="5313592">(</span><span class="ident" id="5313593">xr</span><span class="op" id="5313595">.</span><span class="ident" id="5313596">Hi</span><span class="op" id="5313598">)</span><span class="op" id="5313599">,</span>&nbsp;<span class="builtintype" id="5313601">rune</span><span class="op" id="5313605">(</span><span class="ident" id="5313606">xr</span><span class="op" id="5313608">.</span><span class="ident" id="5313609">Stride</span><span class="op" id="5313615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313619">if</span>&nbsp;<span class="ident" id="5313622">stride</span>&nbsp;<span class="op" id="5313629">==</span>&nbsp;<span class="num" id="5313632">1</span>&nbsp;<span class="op" id="5313634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313639">r</span>&nbsp;<span class="op" id="5313641">=</span>&nbsp;<span class="ident" id="5313643">appendRange</span><span class="op" id="5313654">(</span><span class="ident" id="5313655">r</span><span class="op" id="5313656">,</span>&nbsp;<span class="ident" id="5313658">lo</span><span class="op" id="5313660">,</span>&nbsp;<span class="ident" id="5313662">hi</span><span class="op" id="5313664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313669">continue</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5313680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313684">for</span>&nbsp;<span class="ident" id="5313688">c</span>&nbsp;<span class="op" id="5313690">:=</span>&nbsp;<span class="ident" id="5313693">lo</span><span class="op" id="5313695">;</span>&nbsp;<span class="ident" id="5313697">c</span>&nbsp;<span class="op" id="5313699">&lt;=</span>&nbsp;<span class="ident" id="5313702">hi</span><span class="op" id="5313704">;</span>&nbsp;<span class="ident" id="5313706">c</span>&nbsp;<span class="op" id="5313708">+=</span>&nbsp;<span class="ident" id="5313711">stride</span>&nbsp;<span class="op" id="5313718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313723">r</span>&nbsp;<span class="op" id="5313725">=</span>&nbsp;<span class="ident" id="5313727">appendRange</span><span class="op" id="5313738">(</span><span class="ident" id="5313739">r</span><span class="op" id="5313740">,</span>&nbsp;<span class="ident" id="5313742">c</span><span class="op" id="5313743">,</span>&nbsp;<span class="ident" id="5313745">c</span><span class="op" id="5313746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5313750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5313753">}</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313756">return</span>&nbsp;<span class="ident" id="5313763">r</span><br>
<span class="lineno"></span><span class="op" id="5313765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5313768">//&nbsp;appendNegatedTable&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;appending&nbsp;the&nbsp;negation&nbsp;of&nbsp;x&nbsp;to&nbsp;the&nbsp;class&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5313856">func</span>&nbsp;<span class="ident" id="5313861">appendNegatedTable</span><span class="op" id="5313879">(</span><span class="ident" id="5313880">r</span>&nbsp;<span class="op" id="5313882">[</span><span class="op" id="5313883">]</span><span class="builtintype" id="5313884">rune</span><span class="op" id="5313888">,</span>&nbsp;<span class="ident" id="5313890">x</span>&nbsp;<span class="op" id="5313892">*</span><span class="ident" id="5313893">unicode</span><span class="op" id="5313900">.</span><span class="ident" id="5313901">RangeTable</span><span class="op" id="5313911">)</span>&nbsp;<span class="op" id="5313913">[</span><span class="op" id="5313914">]</span><span class="builtintype" id="5313915">rune</span>&nbsp;<span class="op" id="5313920">{</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5313923">nextLo</span>&nbsp;<span class="op" id="5313930">:=</span>&nbsp;<span class="string" id="5313933">&#39;\u0000&#39;</span>&nbsp;<span class="comment" id="5313942">//&nbsp;lo&nbsp;end&nbsp;of&nbsp;next&nbsp;class&nbsp;to&nbsp;add</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5313974">for</span>&nbsp;<span class="ident" id="5313978">_</span><span class="op" id="5313979">,</span>&nbsp;<span class="ident" id="5313981">xr</span>&nbsp;<span class="op" id="5313984">:=</span>&nbsp;<span class="keyword" id="5313987">range</span>&nbsp;<span class="ident" id="5313993">x</span><span class="op" id="5313994">.</span><span class="ident" id="5313995">R16</span>&nbsp;<span class="op" id="5313999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314003">lo</span><span class="op" id="5314005">,</span>&nbsp;<span class="ident" id="5314007">hi</span><span class="op" id="5314009">,</span>&nbsp;<span class="ident" id="5314011">stride</span>&nbsp;<span class="op" id="5314018">:=</span>&nbsp;<span class="builtintype" id="5314021">rune</span><span class="op" id="5314025">(</span><span class="ident" id="5314026">xr</span><span class="op" id="5314028">.</span><span class="ident" id="5314029">Lo</span><span class="op" id="5314031">)</span><span class="op" id="5314032">,</span>&nbsp;<span class="builtintype" id="5314034">rune</span><span class="op" id="5314038">(</span><span class="ident" id="5314039">xr</span><span class="op" id="5314041">.</span><span class="ident" id="5314042">Hi</span><span class="op" id="5314044">)</span><span class="op" id="5314045">,</span>&nbsp;<span class="builtintype" id="5314047">rune</span><span class="op" id="5314051">(</span><span class="ident" id="5314052">xr</span><span class="op" id="5314054">.</span><span class="ident" id="5314055">Stride</span><span class="op" id="5314061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314065">if</span>&nbsp;<span class="ident" id="5314068">stride</span>&nbsp;<span class="op" id="5314075">==</span>&nbsp;<span class="num" id="5314078">1</span>&nbsp;<span class="op" id="5314080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314085">if</span>&nbsp;<span class="ident" id="5314088">nextLo</span>&nbsp;<span class="op" id="5314095">&lt;=</span>&nbsp;<span class="ident" id="5314098">lo</span><span class="op" id="5314100">-</span><span class="num" id="5314101">1</span>&nbsp;<span class="op" id="5314103">{</span><br>
<span class="lineno">1785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314109">r</span>&nbsp;<span class="op" id="5314111">=</span>&nbsp;<span class="ident" id="5314113">appendRange</span><span class="op" id="5314124">(</span><span class="ident" id="5314125">r</span><span class="op" id="5314126">,</span>&nbsp;<span class="ident" id="5314128">nextLo</span><span class="op" id="5314134">,</span>&nbsp;<span class="ident" id="5314136">lo</span><span class="op" id="5314138">-</span><span class="num" id="5314139">1</span><span class="op" id="5314140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314150">nextLo</span>&nbsp;<span class="op" id="5314157">=</span>&nbsp;<span class="ident" id="5314159">hi</span>&nbsp;<span class="op" id="5314162">+</span>&nbsp;<span class="num" id="5314164">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314169">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314180">}</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314184">for</span>&nbsp;<span class="ident" id="5314188">c</span>&nbsp;<span class="op" id="5314190">:=</span>&nbsp;<span class="ident" id="5314193">lo</span><span class="op" id="5314195">;</span>&nbsp;<span class="ident" id="5314197">c</span>&nbsp;<span class="op" id="5314199">&lt;=</span>&nbsp;<span class="ident" id="5314202">hi</span><span class="op" id="5314204">;</span>&nbsp;<span class="ident" id="5314206">c</span>&nbsp;<span class="op" id="5314208">+=</span>&nbsp;<span class="ident" id="5314211">stride</span>&nbsp;<span class="op" id="5314218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314223">if</span>&nbsp;<span class="ident" id="5314226">nextLo</span>&nbsp;<span class="op" id="5314233">&lt;=</span>&nbsp;<span class="ident" id="5314236">c</span><span class="op" id="5314237">-</span><span class="num" id="5314238">1</span>&nbsp;<span class="op" id="5314240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314246">r</span>&nbsp;<span class="op" id="5314248">=</span>&nbsp;<span class="ident" id="5314250">appendRange</span><span class="op" id="5314261">(</span><span class="ident" id="5314262">r</span><span class="op" id="5314263">,</span>&nbsp;<span class="ident" id="5314265">nextLo</span><span class="op" id="5314271">,</span>&nbsp;<span class="ident" id="5314273">c</span><span class="op" id="5314274">-</span><span class="num" id="5314275">1</span><span class="op" id="5314276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314286">nextLo</span>&nbsp;<span class="op" id="5314293">=</span>&nbsp;<span class="ident" id="5314295">c</span>&nbsp;<span class="op" id="5314297">+</span>&nbsp;<span class="num" id="5314299">1</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314309">for</span>&nbsp;<span class="ident" id="5314313">_</span><span class="op" id="5314314">,</span>&nbsp;<span class="ident" id="5314316">xr</span>&nbsp;<span class="op" id="5314319">:=</span>&nbsp;<span class="keyword" id="5314322">range</span>&nbsp;<span class="ident" id="5314328">x</span><span class="op" id="5314329">.</span><span class="ident" id="5314330">R32</span>&nbsp;<span class="op" id="5314334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314338">lo</span><span class="op" id="5314340">,</span>&nbsp;<span class="ident" id="5314342">hi</span><span class="op" id="5314344">,</span>&nbsp;<span class="ident" id="5314346">stride</span>&nbsp;<span class="op" id="5314353">:=</span>&nbsp;<span class="builtintype" id="5314356">rune</span><span class="op" id="5314360">(</span><span class="ident" id="5314361">xr</span><span class="op" id="5314363">.</span><span class="ident" id="5314364">Lo</span><span class="op" id="5314366">)</span><span class="op" id="5314367">,</span>&nbsp;<span class="builtintype" id="5314369">rune</span><span class="op" id="5314373">(</span><span class="ident" id="5314374">xr</span><span class="op" id="5314376">.</span><span class="ident" id="5314377">Hi</span><span class="op" id="5314379">)</span><span class="op" id="5314380">,</span>&nbsp;<span class="builtintype" id="5314382">rune</span><span class="op" id="5314386">(</span><span class="ident" id="5314387">xr</span><span class="op" id="5314389">.</span><span class="ident" id="5314390">Stride</span><span class="op" id="5314396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314400">if</span>&nbsp;<span class="ident" id="5314403">stride</span>&nbsp;<span class="op" id="5314410">==</span>&nbsp;<span class="num" id="5314413">1</span>&nbsp;<span class="op" id="5314415">{</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314420">if</span>&nbsp;<span class="ident" id="5314423">nextLo</span>&nbsp;<span class="op" id="5314430">&lt;=</span>&nbsp;<span class="ident" id="5314433">lo</span><span class="op" id="5314435">-</span><span class="num" id="5314436">1</span>&nbsp;<span class="op" id="5314438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314444">r</span>&nbsp;<span class="op" id="5314446">=</span>&nbsp;<span class="ident" id="5314448">appendRange</span><span class="op" id="5314459">(</span><span class="ident" id="5314460">r</span><span class="op" id="5314461">,</span>&nbsp;<span class="ident" id="5314463">nextLo</span><span class="op" id="5314469">,</span>&nbsp;<span class="ident" id="5314471">lo</span><span class="op" id="5314473">-</span><span class="num" id="5314474">1</span><span class="op" id="5314475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314485">nextLo</span>&nbsp;<span class="op" id="5314492">=</span>&nbsp;<span class="ident" id="5314494">hi</span>&nbsp;<span class="op" id="5314497">+</span>&nbsp;<span class="num" id="5314499">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314504">continue</span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314519">for</span>&nbsp;<span class="ident" id="5314523">c</span>&nbsp;<span class="op" id="5314525">:=</span>&nbsp;<span class="ident" id="5314528">lo</span><span class="op" id="5314530">;</span>&nbsp;<span class="ident" id="5314532">c</span>&nbsp;<span class="op" id="5314534">&lt;=</span>&nbsp;<span class="ident" id="5314537">hi</span><span class="op" id="5314539">;</span>&nbsp;<span class="ident" id="5314541">c</span>&nbsp;<span class="op" id="5314543">+=</span>&nbsp;<span class="ident" id="5314546">stride</span>&nbsp;<span class="op" id="5314553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314558">if</span>&nbsp;<span class="ident" id="5314561">nextLo</span>&nbsp;<span class="op" id="5314568">&lt;=</span>&nbsp;<span class="ident" id="5314571">c</span><span class="op" id="5314572">-</span><span class="num" id="5314573">1</span>&nbsp;<span class="op" id="5314575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314581">r</span>&nbsp;<span class="op" id="5314583">=</span>&nbsp;<span class="ident" id="5314585">appendRange</span><span class="op" id="5314596">(</span><span class="ident" id="5314597">r</span><span class="op" id="5314598">,</span>&nbsp;<span class="ident" id="5314600">nextLo</span><span class="op" id="5314606">,</span>&nbsp;<span class="ident" id="5314608">c</span><span class="op" id="5314609">-</span><span class="num" id="5314610">1</span><span class="op" id="5314611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314616">}</span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314621">nextLo</span>&nbsp;<span class="op" id="5314628">=</span>&nbsp;<span class="ident" id="5314630">c</span>&nbsp;<span class="op" id="5314632">+</span>&nbsp;<span class="num" id="5314634">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314644">if</span>&nbsp;<span class="ident" id="5314647">nextLo</span>&nbsp;<span class="op" id="5314654">&lt;=</span>&nbsp;<span class="ident" id="5314657">unicode</span><span class="op" id="5314664">.</span><span class="ident" id="5314665">MaxRune</span>&nbsp;<span class="op" id="5314673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314677">r</span>&nbsp;<span class="op" id="5314679">=</span>&nbsp;<span class="ident" id="5314681">appendRange</span><span class="op" id="5314692">(</span><span class="ident" id="5314693">r</span><span class="op" id="5314694">,</span>&nbsp;<span class="ident" id="5314696">nextLo</span><span class="op" id="5314702">,</span>&nbsp;<span class="ident" id="5314704">unicode</span><span class="op" id="5314711">.</span><span class="ident" id="5314712">MaxRune</span><span class="op" id="5314719">)</span><br>
<span class="lineno">1815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5314722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314725">return</span>&nbsp;<span class="ident" id="5314732">r</span><br>
<span class="lineno"></span><span class="op" id="5314734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5314737">//&nbsp;negateClass&nbsp;overwrites&nbsp;r&nbsp;and&nbsp;returns&nbsp;r&#39;s&nbsp;negation.</span><br>
<span class="lineno">1820</span><span class="comment" id="5314791">//&nbsp;It&nbsp;assumes&nbsp;the&nbsp;class&nbsp;r&nbsp;is&nbsp;already&nbsp;clean.</span><br>
<span class="lineno"></span><span class="keyword" id="5314835">func</span>&nbsp;<span class="ident" id="5314840">negateClass</span><span class="op" id="5314851">(</span><span class="ident" id="5314852">r</span>&nbsp;<span class="op" id="5314854">[</span><span class="op" id="5314855">]</span><span class="builtintype" id="5314856">rune</span><span class="op" id="5314860">)</span>&nbsp;<span class="op" id="5314862">[</span><span class="op" id="5314863">]</span><span class="builtintype" id="5314864">rune</span>&nbsp;<span class="op" id="5314869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314872">nextLo</span>&nbsp;<span class="op" id="5314879">:=</span>&nbsp;<span class="string" id="5314882">&#39;\u0000&#39;</span>&nbsp;<span class="comment" id="5314891">//&nbsp;lo&nbsp;end&nbsp;of&nbsp;next&nbsp;class&nbsp;to&nbsp;add</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314923">w</span>&nbsp;<span class="op" id="5314925">:=</span>&nbsp;<span class="num" id="5314928">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5314942">//&nbsp;write&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5314958">for</span>&nbsp;<span class="ident" id="5314962">i</span>&nbsp;<span class="op" id="5314964">:=</span>&nbsp;<span class="num" id="5314967">0</span><span class="op" id="5314968">;</span>&nbsp;<span class="ident" id="5314970">i</span>&nbsp;<span class="op" id="5314972">&lt;</span>&nbsp;<span class="builtinfunc" id="5314974">len</span><span class="op" id="5314977">(</span><span class="ident" id="5314978">r</span><span class="op" id="5314979">)</span><span class="op" id="5314980">;</span>&nbsp;<span class="ident" id="5314982">i</span>&nbsp;<span class="op" id="5314984">+=</span>&nbsp;<span class="num" id="5314987">2</span>&nbsp;<span class="op" id="5314989">{</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5314993">lo</span><span class="op" id="5314995">,</span>&nbsp;<span class="ident" id="5314997">hi</span>&nbsp;<span class="op" id="5315000">:=</span>&nbsp;<span class="ident" id="5315003">r</span><span class="op" id="5315004">[</span><span class="ident" id="5315005">i</span><span class="op" id="5315006">]</span><span class="op" id="5315007">,</span>&nbsp;<span class="ident" id="5315009">r</span><span class="op" id="5315010">[</span><span class="ident" id="5315011">i</span><span class="op" id="5315012">+</span><span class="num" id="5315013">1</span><span class="op" id="5315014">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315018">if</span>&nbsp;<span class="ident" id="5315021">nextLo</span>&nbsp;<span class="op" id="5315028">&lt;=</span>&nbsp;<span class="ident" id="5315031">lo</span><span class="op" id="5315033">-</span><span class="num" id="5315034">1</span>&nbsp;<span class="op" id="5315036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315041">r</span><span class="op" id="5315042">[</span><span class="ident" id="5315043">w</span><span class="op" id="5315044">]</span>&nbsp;<span class="op" id="5315046">=</span>&nbsp;<span class="ident" id="5315048">nextLo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315058">r</span><span class="op" id="5315059">[</span><span class="ident" id="5315060">w</span><span class="op" id="5315061">+</span><span class="num" id="5315062">1</span><span class="op" id="5315063">]</span>&nbsp;<span class="op" id="5315065">=</span>&nbsp;<span class="ident" id="5315067">lo</span>&nbsp;<span class="op" id="5315070">-</span>&nbsp;<span class="num" id="5315072">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315077">w</span>&nbsp;<span class="op" id="5315079">+=</span>&nbsp;<span class="num" id="5315082">2</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5315086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315090">nextLo</span>&nbsp;<span class="op" id="5315097">=</span>&nbsp;<span class="ident" id="5315099">hi</span>&nbsp;<span class="op" id="5315102">+</span>&nbsp;<span class="num" id="5315104">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5315107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315110">r</span>&nbsp;<span class="op" id="5315112">=</span>&nbsp;<span class="ident" id="5315114">r</span><span class="op" id="5315115">[</span><span class="op" id="5315116">:</span><span class="ident" id="5315117">w</span><span class="op" id="5315118">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315121">if</span>&nbsp;<span class="ident" id="5315124">nextLo</span>&nbsp;<span class="op" id="5315131">&lt;=</span>&nbsp;<span class="ident" id="5315134">unicode</span><span class="op" id="5315141">.</span><span class="ident" id="5315142">MaxRune</span>&nbsp;<span class="op" id="5315150">{</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5315154">//&nbsp;It&#39;s&nbsp;possible&nbsp;for&nbsp;the&nbsp;negation&nbsp;to&nbsp;have&nbsp;one&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5315207">//&nbsp;range&nbsp;-&nbsp;this&nbsp;one&nbsp;-&nbsp;than&nbsp;the&nbsp;original&nbsp;class,&nbsp;so&nbsp;use&nbsp;append.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315271">r</span>&nbsp;<span class="op" id="5315273">=</span>&nbsp;<span class="builtinfunc" id="5315275">append</span><span class="op" id="5315281">(</span><span class="ident" id="5315282">r</span><span class="op" id="5315283">,</span>&nbsp;<span class="ident" id="5315285">nextLo</span><span class="op" id="5315291">,</span>&nbsp;<span class="ident" id="5315293">unicode</span><span class="op" id="5315300">.</span><span class="ident" id="5315301">MaxRune</span><span class="op" id="5315308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5315311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315314">return</span>&nbsp;<span class="ident" id="5315321">r</span><br>
<span class="lineno">1840</span><span class="op" id="5315323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5315326">//&nbsp;ranges&nbsp;implements&nbsp;sort.Interface&nbsp;on&nbsp;a&nbsp;[]rune.</span><br>
<span class="lineno"></span><span class="comment" id="5315375">//&nbsp;The&nbsp;choice&nbsp;of&nbsp;receiver&nbsp;type&nbsp;definition&nbsp;is&nbsp;strange</span><br>
<span class="lineno"></span><span class="comment" id="5315428">//&nbsp;but&nbsp;avoids&nbsp;an&nbsp;allocation&nbsp;since&nbsp;we&nbsp;already&nbsp;have</span><br>
<span class="lineno">1845</span><span class="comment" id="5315478">//&nbsp;a&nbsp;*[]rune.</span><br>
<span class="lineno"></span><span class="keyword" id="5315492">type</span>&nbsp;<span class="ident" id="5315497">ranges</span>&nbsp;<span class="keyword" id="5315504">struct</span>&nbsp;<span class="op" id="5315511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315514">p</span>&nbsp;<span class="op" id="5315516">*</span><span class="op" id="5315517">[</span><span class="op" id="5315518">]</span><span class="builtintype" id="5315519">rune</span><br>
<span class="lineno"></span><span class="op" id="5315524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span><span class="keyword" id="5315527">func</span>&nbsp;<span class="op" id="5315532">(</span><span class="ident" id="5315533">ra</span>&nbsp;<span class="ident" id="5315536">ranges</span><span class="op" id="5315542">)</span>&nbsp;<span class="ident" id="5315544">Less</span><span class="op" id="5315548">(</span><span class="ident" id="5315549">i</span><span class="op" id="5315550">,</span>&nbsp;<span class="ident" id="5315552">j</span>&nbsp;<span class="builtintype" id="5315554">int</span><span class="op" id="5315557">)</span>&nbsp;<span class="builtintype" id="5315559">bool</span>&nbsp;<span class="op" id="5315564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315567">p</span>&nbsp;<span class="op" id="5315569">:=</span>&nbsp;<span class="op" id="5315572">*</span><span class="ident" id="5315573">ra</span><span class="op" id="5315575">.</span><span class="ident" id="5315576">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315579">i</span>&nbsp;<span class="op" id="5315581">*=</span>&nbsp;<span class="num" id="5315584">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315587">j</span>&nbsp;<span class="op" id="5315589">*=</span>&nbsp;<span class="num" id="5315592">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315595">return</span>&nbsp;<span class="ident" id="5315602">p</span><span class="op" id="5315603">[</span><span class="ident" id="5315604">i</span><span class="op" id="5315605">]</span>&nbsp;<span class="op" id="5315607">&lt;</span>&nbsp;<span class="ident" id="5315609">p</span><span class="op" id="5315610">[</span><span class="ident" id="5315611">j</span><span class="op" id="5315612">]</span>&nbsp;<span class="op" id="5315614">||</span>&nbsp;<span class="ident" id="5315617">p</span><span class="op" id="5315618">[</span><span class="ident" id="5315619">i</span><span class="op" id="5315620">]</span>&nbsp;<span class="op" id="5315622">==</span>&nbsp;<span class="ident" id="5315625">p</span><span class="op" id="5315626">[</span><span class="ident" id="5315627">j</span><span class="op" id="5315628">]</span>&nbsp;<span class="op" id="5315630">&amp;&amp;</span>&nbsp;<span class="ident" id="5315633">p</span><span class="op" id="5315634">[</span><span class="ident" id="5315635">i</span><span class="op" id="5315636">+</span><span class="num" id="5315637">1</span><span class="op" id="5315638">]</span>&nbsp;<span class="op" id="5315640">&gt;</span>&nbsp;<span class="ident" id="5315642">p</span><span class="op" id="5315643">[</span><span class="ident" id="5315644">j</span><span class="op" id="5315645">+</span><span class="num" id="5315646">1</span><span class="op" id="5315647">]</span><br>
<span class="lineno">1855</span><span class="op" id="5315649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5315652">func</span>&nbsp;<span class="op" id="5315657">(</span><span class="ident" id="5315658">ra</span>&nbsp;<span class="ident" id="5315661">ranges</span><span class="op" id="5315667">)</span>&nbsp;<span class="ident" id="5315669">Len</span><span class="op" id="5315672">(</span><span class="op" id="5315673">)</span>&nbsp;<span class="builtintype" id="5315675">int</span>&nbsp;<span class="op" id="5315679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315682">return</span>&nbsp;<span class="builtinfunc" id="5315689">len</span><span class="op" id="5315692">(</span><span class="op" id="5315693">*</span><span class="ident" id="5315694">ra</span><span class="op" id="5315696">.</span><span class="ident" id="5315697">p</span><span class="op" id="5315698">)</span>&nbsp;<span class="op" id="5315700">/</span>&nbsp;<span class="num" id="5315702">2</span><br>
<span class="lineno"></span><span class="op" id="5315704">}</span><br>
<span class="lineno">1860</span><br>
<span class="lineno"></span><span class="keyword" id="5315707">func</span>&nbsp;<span class="op" id="5315712">(</span><span class="ident" id="5315713">ra</span>&nbsp;<span class="ident" id="5315716">ranges</span><span class="op" id="5315722">)</span>&nbsp;<span class="ident" id="5315724">Swap</span><span class="op" id="5315728">(</span><span class="ident" id="5315729">i</span><span class="op" id="5315730">,</span>&nbsp;<span class="ident" id="5315732">j</span>&nbsp;<span class="builtintype" id="5315734">int</span><span class="op" id="5315737">)</span>&nbsp;<span class="op" id="5315739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315742">p</span>&nbsp;<span class="op" id="5315744">:=</span>&nbsp;<span class="op" id="5315747">*</span><span class="ident" id="5315748">ra</span><span class="op" id="5315750">.</span><span class="ident" id="5315751">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315754">i</span>&nbsp;<span class="op" id="5315756">*=</span>&nbsp;<span class="num" id="5315759">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315762">j</span>&nbsp;<span class="op" id="5315764">*=</span>&nbsp;<span class="num" id="5315767">2</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5315770">p</span><span class="op" id="5315771">[</span><span class="ident" id="5315772">i</span><span class="op" id="5315773">]</span><span class="op" id="5315774">,</span>&nbsp;<span class="ident" id="5315776">p</span><span class="op" id="5315777">[</span><span class="ident" id="5315778">i</span><span class="op" id="5315779">+</span><span class="num" id="5315780">1</span><span class="op" id="5315781">]</span><span class="op" id="5315782">,</span>&nbsp;<span class="ident" id="5315784">p</span><span class="op" id="5315785">[</span><span class="ident" id="5315786">j</span><span class="op" id="5315787">]</span><span class="op" id="5315788">,</span>&nbsp;<span class="ident" id="5315790">p</span><span class="op" id="5315791">[</span><span class="ident" id="5315792">j</span><span class="op" id="5315793">+</span><span class="num" id="5315794">1</span><span class="op" id="5315795">]</span>&nbsp;<span class="op" id="5315797">=</span>&nbsp;<span class="ident" id="5315799">p</span><span class="op" id="5315800">[</span><span class="ident" id="5315801">j</span><span class="op" id="5315802">]</span><span class="op" id="5315803">,</span>&nbsp;<span class="ident" id="5315805">p</span><span class="op" id="5315806">[</span><span class="ident" id="5315807">j</span><span class="op" id="5315808">+</span><span class="num" id="5315809">1</span><span class="op" id="5315810">]</span><span class="op" id="5315811">,</span>&nbsp;<span class="ident" id="5315813">p</span><span class="op" id="5315814">[</span><span class="ident" id="5315815">i</span><span class="op" id="5315816">]</span><span class="op" id="5315817">,</span>&nbsp;<span class="ident" id="5315819">p</span><span class="op" id="5315820">[</span><span class="ident" id="5315821">i</span><span class="op" id="5315822">+</span><span class="num" id="5315823">1</span><span class="op" id="5315824">]</span><br>
<span class="lineno"></span><span class="op" id="5315826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5315829">func</span>&nbsp;<span class="ident" id="5315834">checkUTF8</span><span class="op" id="5315843">(</span><span class="ident" id="5315844">s</span>&nbsp;<span class="builtintype" id="5315846">string</span><span class="op" id="5315852">)</span>&nbsp;<span class="builtintype" id="5315854">error</span>&nbsp;<span class="op" id="5315860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315863">for</span>&nbsp;<span class="ident" id="5315867">s</span>&nbsp;<span class="op" id="5315869">!=</span>&nbsp;<span class="string" id="5315872">&#34;&#34;</span>&nbsp;<span class="op" id="5315875">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5315879">rune</span><span class="op" id="5315883">,</span>&nbsp;<span class="ident" id="5315885">size</span>&nbsp;<span class="op" id="5315890">:=</span>&nbsp;<span class="ident" id="5315893">utf8</span><span class="op" id="5315897">.</span><span class="ident" id="5315898">DecodeRuneInString</span><span class="op" id="5315916">(</span><span class="ident" id="5315917">s</span><span class="op" id="5315918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315922">if</span>&nbsp;<span class="builtintype" id="5315925">rune</span>&nbsp;<span class="op" id="5315930">==</span>&nbsp;<span class="ident" id="5315933">utf8</span><span class="op" id="5315937">.</span><span class="ident" id="5315938">RuneError</span>&nbsp;<span class="op" id="5315948">&amp;&amp;</span>&nbsp;<span class="ident" id="5315951">size</span>&nbsp;<span class="op" id="5315956">==</span>&nbsp;<span class="num" id="5315959">1</span>&nbsp;<span class="op" id="5315961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5315966">return</span>&nbsp;<span class="op" id="5315973">&amp;</span><span class="ident" id="5315974">Error</span><span class="op" id="5315979">{</span><span class="ident" id="5315980">Code</span><span class="op" id="5315984">:</span>&nbsp;<span class="ident" id="5315986">ErrInvalidUTF8</span><span class="op" id="5316000">,</span>&nbsp;<span class="ident" id="5316002">Expr</span><span class="op" id="5316006">:</span>&nbsp;<span class="ident" id="5316008">s</span><span class="op" id="5316009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5316013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316017">s</span>&nbsp;<span class="op" id="5316019">=</span>&nbsp;<span class="ident" id="5316021">s</span><span class="op" id="5316022">[</span><span class="ident" id="5316023">size</span><span class="op" id="5316027">:</span><span class="op" id="5316028">]</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5316031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316034">return</span>&nbsp;<span class="ident" id="5316041">nil</span><br>
<span class="lineno"></span><span class="op" id="5316045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5316048">func</span>&nbsp;<span class="ident" id="5316053">nextRune</span><span class="op" id="5316061">(</span><span class="ident" id="5316062">s</span>&nbsp;<span class="builtintype" id="5316064">string</span><span class="op" id="5316070">)</span>&nbsp;<span class="op" id="5316072">(</span><span class="ident" id="5316073">c</span>&nbsp;<span class="builtintype" id="5316075">rune</span><span class="op" id="5316079">,</span>&nbsp;<span class="ident" id="5316081">t</span>&nbsp;<span class="builtintype" id="5316083">string</span><span class="op" id="5316089">,</span>&nbsp;<span class="ident" id="5316091">err</span>&nbsp;<span class="builtintype" id="5316095">error</span><span class="op" id="5316100">)</span>&nbsp;<span class="op" id="5316102">{</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5316105">c</span><span class="op" id="5316106">,</span>&nbsp;<span class="ident" id="5316108">size</span>&nbsp;<span class="op" id="5316113">:=</span>&nbsp;<span class="ident" id="5316116">utf8</span><span class="op" id="5316120">.</span><span class="ident" id="5316121">DecodeRuneInString</span><span class="op" id="5316139">(</span><span class="ident" id="5316140">s</span><span class="op" id="5316141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316144">if</span>&nbsp;<span class="ident" id="5316147">c</span>&nbsp;<span class="op" id="5316149">==</span>&nbsp;<span class="ident" id="5316152">utf8</span><span class="op" id="5316156">.</span><span class="ident" id="5316157">RuneError</span>&nbsp;<span class="op" id="5316167">&amp;&amp;</span>&nbsp;<span class="ident" id="5316170">size</span>&nbsp;<span class="op" id="5316175">==</span>&nbsp;<span class="num" id="5316178">1</span>&nbsp;<span class="op" id="5316180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316184">return</span>&nbsp;<span class="num" id="5316191">0</span><span class="op" id="5316192">,</span>&nbsp;<span class="string" id="5316194">&#34;&#34;</span><span class="op" id="5316196">,</span>&nbsp;<span class="op" id="5316198">&amp;</span><span class="ident" id="5316199">Error</span><span class="op" id="5316204">{</span><span class="ident" id="5316205">Code</span><span class="op" id="5316209">:</span>&nbsp;<span class="ident" id="5316211">ErrInvalidUTF8</span><span class="op" id="5316225">,</span>&nbsp;<span class="ident" id="5316227">Expr</span><span class="op" id="5316231">:</span>&nbsp;<span class="ident" id="5316233">s</span><span class="op" id="5316234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5316237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316240">return</span>&nbsp;<span class="ident" id="5316247">c</span><span class="op" id="5316248">,</span>&nbsp;<span class="ident" id="5316250">s</span><span class="op" id="5316251">[</span><span class="ident" id="5316252">size</span><span class="op" id="5316256">:</span><span class="op" id="5316257">]</span><span class="op" id="5316258">,</span>&nbsp;<span class="ident" id="5316260">nil</span><br>
<span class="lineno">1885</span><span class="op" id="5316264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5316267">func</span>&nbsp;<span class="ident" id="5316272">isalnum</span><span class="op" id="5316279">(</span><span class="ident" id="5316280">c</span>&nbsp;<span class="builtintype" id="5316282">rune</span><span class="op" id="5316286">)</span>&nbsp;<span class="builtintype" id="5316288">bool</span>&nbsp;<span class="op" id="5316293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316296">return</span>&nbsp;<span class="string" id="5316303">&#39;0&#39;</span>&nbsp;<span class="op" id="5316307">&lt;=</span>&nbsp;<span class="ident" id="5316310">c</span>&nbsp;<span class="op" id="5316312">&amp;&amp;</span>&nbsp;<span class="ident" id="5316315">c</span>&nbsp;<span class="op" id="5316317">&lt;=</span>&nbsp;<span class="string" id="5316320">&#39;9&#39;</span>&nbsp;<span class="op" id="5316324">||</span>&nbsp;<span class="string" id="5316327">&#39;A&#39;</span>&nbsp;<span class="op" id="5316331">&lt;=</span>&nbsp;<span class="ident" id="5316334">c</span>&nbsp;<span class="op" id="5316336">&amp;&amp;</span>&nbsp;<span class="ident" id="5316339">c</span>&nbsp;<span class="op" id="5316341">&lt;=</span>&nbsp;<span class="string" id="5316344">&#39;Z&#39;</span>&nbsp;<span class="op" id="5316348">||</span>&nbsp;<span class="string" id="5316351">&#39;a&#39;</span>&nbsp;<span class="op" id="5316355">&lt;=</span>&nbsp;<span class="ident" id="5316358">c</span>&nbsp;<span class="op" id="5316360">&amp;&amp;</span>&nbsp;<span class="ident" id="5316363">c</span>&nbsp;<span class="op" id="5316365">&lt;=</span>&nbsp;<span class="string" id="5316368">&#39;z&#39;</span><br>
<span class="lineno"></span><span class="op" id="5316372">}</span><br>
<span class="lineno">1890</span><br>
<span class="lineno"></span><span class="keyword" id="5316375">func</span>&nbsp;<span class="ident" id="5316380">unhex</span><span class="op" id="5316385">(</span><span class="ident" id="5316386">c</span>&nbsp;<span class="builtintype" id="5316388">rune</span><span class="op" id="5316392">)</span>&nbsp;<span class="builtintype" id="5316394">rune</span>&nbsp;<span class="op" id="5316399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316402">if</span>&nbsp;<span class="string" id="5316405">&#39;0&#39;</span>&nbsp;<span class="op" id="5316409">&lt;=</span>&nbsp;<span class="ident" id="5316412">c</span>&nbsp;<span class="op" id="5316414">&amp;&amp;</span>&nbsp;<span class="ident" id="5316417">c</span>&nbsp;<span class="op" id="5316419">&lt;=</span>&nbsp;<span class="string" id="5316422">&#39;9&#39;</span>&nbsp;<span class="op" id="5316426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316430">return</span>&nbsp;<span class="ident" id="5316437">c</span>&nbsp;<span class="op" id="5316439">-</span>&nbsp;<span class="string" id="5316441">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5316446">}</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316449">if</span>&nbsp;<span class="string" id="5316452">&#39;a&#39;</span>&nbsp;<span class="op" id="5316456">&lt;=</span>&nbsp;<span class="ident" id="5316459">c</span>&nbsp;<span class="op" id="5316461">&amp;&amp;</span>&nbsp;<span class="ident" id="5316464">c</span>&nbsp;<span class="op" id="5316466">&lt;=</span>&nbsp;<span class="string" id="5316469">&#39;f&#39;</span>&nbsp;<span class="op" id="5316473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316477">return</span>&nbsp;<span class="ident" id="5316484">c</span>&nbsp;<span class="op" id="5316486">-</span>&nbsp;<span class="string" id="5316488">&#39;a&#39;</span>&nbsp;<span class="op" id="5316492">+</span>&nbsp;<span class="num" id="5316494">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5316498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316501">if</span>&nbsp;<span class="string" id="5316504">&#39;A&#39;</span>&nbsp;<span class="op" id="5316508">&lt;=</span>&nbsp;<span class="ident" id="5316511">c</span>&nbsp;<span class="op" id="5316513">&amp;&amp;</span>&nbsp;<span class="ident" id="5316516">c</span>&nbsp;<span class="op" id="5316518">&lt;=</span>&nbsp;<span class="string" id="5316521">&#39;F&#39;</span>&nbsp;<span class="op" id="5316525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316529">return</span>&nbsp;<span class="ident" id="5316536">c</span>&nbsp;<span class="op" id="5316538">-</span>&nbsp;<span class="string" id="5316540">&#39;A&#39;</span>&nbsp;<span class="op" id="5316544">+</span>&nbsp;<span class="num" id="5316546">10</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5316550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5316553">return</span>&nbsp;<span class="op" id="5316560">-</span><span class="num" id="5316561">1</span><br>
<span class="lineno"></span><span class="op" id="5316563">}</span>
</div>
</body>
</html>
