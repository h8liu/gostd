<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>regexp</h2>
<ul>
<li><a href="/gostd/regexp/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/regexp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/regexp/exec.go.html">exec.go</a></li>
<li><a href="/gostd/regexp/exec2_test.go.html">exec2_test.go</a></li>
<li><a href="/gostd/regexp/exec_test.go.html">exec_test.go</a></li>
<li><a href="/gostd/regexp/find_test.go.html">find_test.go</a></li>
<li><a href="/gostd/regexp/onepass.go.html" class="current">onepass.go</a></li>
<li><a href="/gostd/regexp/onepass_test.go.html">onepass_test.go</a></li>
<li><a href="/gostd/regexp/regexp.go.html">regexp.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3064036">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3064092">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3064146">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3064197">package</span>&nbsp;<span class="ident" id="3064205">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3064213">import</span>&nbsp;<span class="op" id="3064220">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3064223">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3064232">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3064249">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3064257">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="3064267">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3064270">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="3064302">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="3064368">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3064440">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3064494">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="3064542">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="3064610">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="3064678">type</span>&nbsp;<span class="ident" id="3064683">onePassProg</span>&nbsp;<span class="keyword" id="3064695">struct</span>&nbsp;<span class="op" id="3064702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3064705">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3064712">[</span><span class="op" id="3064713">]</span><span class="ident" id="3064714">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3064727">Start</span>&nbsp;&nbsp;<span class="builtintype" id="3064734">int</span>&nbsp;<span class="comment" id="3064738">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3064769">NumCap</span>&nbsp;<span class="builtintype" id="3064776">int</span>&nbsp;<span class="comment" id="3064780">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="3064817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3064820">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="3064903">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="3064969">type</span>&nbsp;<span class="ident" id="3064974">onePassInst</span>&nbsp;<span class="keyword" id="3064986">struct</span>&nbsp;<span class="op" id="3064993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3064996">syntax</span><span class="op" id="3065002">.</span><span class="ident" id="3065003">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065009">Next</span>&nbsp;<span class="op" id="3065014">[</span><span class="op" id="3065015">]</span><span class="builtintype" id="3065016">uint32</span><br>
<span class="lineno"></span><span class="op" id="3065023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3065026">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3065093">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="3065152">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="3065221">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="3065282">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="3065300">func</span>&nbsp;<span class="ident" id="3065305">onePassPrefix</span><span class="op" id="3065318">(</span><span class="ident" id="3065319">p</span>&nbsp;<span class="op" id="3065321">*</span><span class="ident" id="3065322">syntax</span><span class="op" id="3065328">.</span><span class="ident" id="3065329">Prog</span><span class="op" id="3065333">)</span>&nbsp;<span class="op" id="3065335">(</span><span class="ident" id="3065336">prefix</span>&nbsp;<span class="builtintype" id="3065343">string</span><span class="op" id="3065349">,</span>&nbsp;<span class="ident" id="3065351">complete</span>&nbsp;<span class="builtintype" id="3065360">bool</span><span class="op" id="3065364">,</span>&nbsp;<span class="ident" id="3065366">pc</span>&nbsp;<span class="builtintype" id="3065369">uint32</span><span class="op" id="3065375">)</span>&nbsp;<span class="op" id="3065377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065380">i</span>&nbsp;<span class="op" id="3065382">:=</span>&nbsp;<span class="op" id="3065385">&amp;</span><span class="ident" id="3065386">p</span><span class="op" id="3065387">.</span><span class="ident" id="3065388">Inst</span><span class="op" id="3065392">[</span><span class="ident" id="3065393">p</span><span class="op" id="3065394">.</span><span class="ident" id="3065395">Start</span><span class="op" id="3065400">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065403">if</span>&nbsp;<span class="ident" id="3065406">i</span><span class="op" id="3065407">.</span><span class="ident" id="3065408">Op</span>&nbsp;<span class="op" id="3065411">!=</span>&nbsp;<span class="ident" id="3065414">syntax</span><span class="op" id="3065420">.</span><span class="ident" id="3065421">InstEmptyWidth</span>&nbsp;<span class="op" id="3065436">||</span>&nbsp;<span class="op" id="3065439">(</span><span class="ident" id="3065440">syntax</span><span class="op" id="3065446">.</span><span class="ident" id="3065447">EmptyOp</span><span class="op" id="3065454">(</span><span class="ident" id="3065455">i</span><span class="op" id="3065456">.</span><span class="ident" id="3065457">Arg</span><span class="op" id="3065460">)</span><span class="op" id="3065461">)</span><span class="op" id="3065462">&amp;</span><span class="ident" id="3065463">syntax</span><span class="op" id="3065469">.</span><span class="ident" id="3065470">EmptyBeginText</span>&nbsp;<span class="op" id="3065485">==</span>&nbsp;<span class="num" id="3065488">0</span>&nbsp;<span class="op" id="3065490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065494">return</span>&nbsp;<span class="string" id="3065501">&#34;&#34;</span><span class="op" id="3065503">,</span>&nbsp;<span class="ident" id="3065505">i</span><span class="op" id="3065506">.</span><span class="ident" id="3065507">Op</span>&nbsp;<span class="op" id="3065510">==</span>&nbsp;<span class="ident" id="3065513">syntax</span><span class="op" id="3065519">.</span><span class="ident" id="3065520">InstMatch</span><span class="op" id="3065529">,</span>&nbsp;<span class="builtintype" id="3065531">uint32</span><span class="op" id="3065537">(</span><span class="ident" id="3065538">p</span><span class="op" id="3065539">.</span><span class="ident" id="3065540">Start</span><span class="op" id="3065545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3065548">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065551">pc</span>&nbsp;<span class="op" id="3065554">=</span>&nbsp;<span class="ident" id="3065556">i</span><span class="op" id="3065557">.</span><span class="ident" id="3065558">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065563">i</span>&nbsp;<span class="op" id="3065565">=</span>&nbsp;<span class="op" id="3065567">&amp;</span><span class="ident" id="3065568">p</span><span class="op" id="3065569">.</span><span class="ident" id="3065570">Inst</span><span class="op" id="3065574">[</span><span class="ident" id="3065575">pc</span><span class="op" id="3065577">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065580">for</span>&nbsp;<span class="ident" id="3065584">i</span><span class="op" id="3065585">.</span><span class="ident" id="3065586">Op</span>&nbsp;<span class="op" id="3065589">==</span>&nbsp;<span class="ident" id="3065592">syntax</span><span class="op" id="3065598">.</span><span class="ident" id="3065599">InstNop</span>&nbsp;<span class="op" id="3065607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065611">pc</span>&nbsp;<span class="op" id="3065614">=</span>&nbsp;<span class="ident" id="3065616">i</span><span class="op" id="3065617">.</span><span class="ident" id="3065618">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065624">i</span>&nbsp;<span class="op" id="3065626">=</span>&nbsp;<span class="op" id="3065628">&amp;</span><span class="ident" id="3065629">p</span><span class="op" id="3065630">.</span><span class="ident" id="3065631">Inst</span><span class="op" id="3065635">[</span><span class="ident" id="3065636">pc</span><span class="op" id="3065638">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3065641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3065644">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065695">if</span>&nbsp;<span class="ident" id="3065698">iop</span><span class="op" id="3065701">(</span><span class="ident" id="3065702">i</span><span class="op" id="3065703">)</span>&nbsp;<span class="op" id="3065705">!=</span>&nbsp;<span class="ident" id="3065708">syntax</span><span class="op" id="3065714">.</span><span class="ident" id="3065715">InstRune</span>&nbsp;<span class="op" id="3065724">||</span>&nbsp;<span class="builtinfunc" id="3065727">len</span><span class="op" id="3065730">(</span><span class="ident" id="3065731">i</span><span class="op" id="3065732">.</span><span class="ident" id="3065733">Rune</span><span class="op" id="3065737">)</span>&nbsp;<span class="op" id="3065739">!=</span>&nbsp;<span class="num" id="3065742">1</span>&nbsp;<span class="op" id="3065744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065748">return</span>&nbsp;<span class="string" id="3065755">&#34;&#34;</span><span class="op" id="3065757">,</span>&nbsp;<span class="ident" id="3065759">i</span><span class="op" id="3065760">.</span><span class="ident" id="3065761">Op</span>&nbsp;<span class="op" id="3065764">==</span>&nbsp;<span class="ident" id="3065767">syntax</span><span class="op" id="3065773">.</span><span class="ident" id="3065774">InstMatch</span><span class="op" id="3065783">,</span>&nbsp;<span class="builtintype" id="3065785">uint32</span><span class="op" id="3065791">(</span><span class="ident" id="3065792">p</span><span class="op" id="3065793">.</span><span class="ident" id="3065794">Start</span><span class="op" id="3065799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3065802">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3065806">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065842">var</span>&nbsp;<span class="ident" id="3065846">buf</span>&nbsp;<span class="ident" id="3065850">bytes</span><span class="op" id="3065855">.</span><span class="ident" id="3065856">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3065864">for</span>&nbsp;<span class="ident" id="3065868">iop</span><span class="op" id="3065871">(</span><span class="ident" id="3065872">i</span><span class="op" id="3065873">)</span>&nbsp;<span class="op" id="3065875">==</span>&nbsp;<span class="ident" id="3065878">syntax</span><span class="op" id="3065884">.</span><span class="ident" id="3065885">InstRune</span>&nbsp;<span class="op" id="3065894">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3065897">len</span><span class="op" id="3065900">(</span><span class="ident" id="3065901">i</span><span class="op" id="3065902">.</span><span class="ident" id="3065903">Rune</span><span class="op" id="3065907">)</span>&nbsp;<span class="op" id="3065909">==</span>&nbsp;<span class="num" id="3065912">1</span>&nbsp;<span class="op" id="3065914">&amp;&amp;</span>&nbsp;<span class="ident" id="3065917">syntax</span><span class="op" id="3065923">.</span><span class="ident" id="3065924">Flags</span><span class="op" id="3065929">(</span><span class="ident" id="3065930">i</span><span class="op" id="3065931">.</span><span class="ident" id="3065932">Arg</span><span class="op" id="3065935">)</span><span class="op" id="3065936">&amp;</span><span class="ident" id="3065937">syntax</span><span class="op" id="3065943">.</span><span class="ident" id="3065944">FoldCase</span>&nbsp;<span class="op" id="3065953">==</span>&nbsp;<span class="num" id="3065956">0</span>&nbsp;<span class="op" id="3065958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065962">buf</span><span class="op" id="3065965">.</span><span class="ident" id="3065966">WriteRune</span><span class="op" id="3065975">(</span><span class="ident" id="3065976">i</span><span class="op" id="3065977">.</span><span class="ident" id="3065978">Rune</span><span class="op" id="3065982">[</span><span class="num" id="3065983">0</span><span class="op" id="3065984">]</span><span class="op" id="3065985">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3065989">pc</span><span class="op" id="3065991">,</span>&nbsp;<span class="ident" id="3065993">i</span>&nbsp;<span class="op" id="3065995">=</span>&nbsp;<span class="ident" id="3065997">i</span><span class="op" id="3065998">.</span><span class="ident" id="3065999">Out</span><span class="op" id="3066002">,</span>&nbsp;<span class="op" id="3066004">&amp;</span><span class="ident" id="3066005">p</span><span class="op" id="3066006">.</span><span class="ident" id="3066007">Inst</span><span class="op" id="3066011">[</span><span class="ident" id="3066012">i</span><span class="op" id="3066013">.</span><span class="ident" id="3066014">Out</span><span class="op" id="3066017">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066023">return</span>&nbsp;<span class="ident" id="3066030">buf</span><span class="op" id="3066033">.</span><span class="ident" id="3066034">String</span><span class="op" id="3066040">(</span><span class="op" id="3066041">)</span><span class="op" id="3066042">,</span>&nbsp;<span class="ident" id="3066044">i</span><span class="op" id="3066045">.</span><span class="ident" id="3066046">Op</span>&nbsp;<span class="op" id="3066049">==</span>&nbsp;<span class="ident" id="3066052">syntax</span><span class="op" id="3066058">.</span><span class="ident" id="3066059">InstEmptyWidth</span>&nbsp;<span class="op" id="3066074">&amp;&amp;</span>&nbsp;<span class="op" id="3066077">(</span><span class="ident" id="3066078">syntax</span><span class="op" id="3066084">.</span><span class="ident" id="3066085">EmptyOp</span><span class="op" id="3066092">(</span><span class="ident" id="3066093">i</span><span class="op" id="3066094">.</span><span class="ident" id="3066095">Arg</span><span class="op" id="3066098">)</span><span class="op" id="3066099">)</span><span class="op" id="3066100">&amp;</span><span class="ident" id="3066101">syntax</span><span class="op" id="3066107">.</span><span class="ident" id="3066108">EmptyBeginText</span>&nbsp;<span class="op" id="3066123">!=</span>&nbsp;<span class="num" id="3066126">0</span><span class="op" id="3066127">,</span>&nbsp;<span class="ident" id="3066129">pc</span><br>
<span class="lineno"></span><span class="op" id="3066132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3066135">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="3066227">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="3066324">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="3066418">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="3066503">func</span>&nbsp;<span class="ident" id="3066508">onePassNext</span><span class="op" id="3066519">(</span><span class="ident" id="3066520">i</span>&nbsp;<span class="op" id="3066522">*</span><span class="ident" id="3066523">onePassInst</span><span class="op" id="3066534">,</span>&nbsp;<span class="ident" id="3066536">r</span>&nbsp;<span class="builtintype" id="3066538">rune</span><span class="op" id="3066542">)</span>&nbsp;<span class="builtintype" id="3066544">uint32</span>&nbsp;<span class="op" id="3066551">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066554">next</span>&nbsp;<span class="op" id="3066559">:=</span>&nbsp;<span class="ident" id="3066562">i</span><span class="op" id="3066563">.</span><span class="ident" id="3066564">MatchRunePos</span><span class="op" id="3066576">(</span><span class="ident" id="3066577">r</span><span class="op" id="3066578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066581">if</span>&nbsp;<span class="ident" id="3066584">next</span>&nbsp;<span class="op" id="3066589">&gt;=</span>&nbsp;<span class="num" id="3066592">0</span>&nbsp;<span class="op" id="3066594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066598">return</span>&nbsp;<span class="ident" id="3066605">i</span><span class="op" id="3066606">.</span><span class="ident" id="3066607">Next</span><span class="op" id="3066611">[</span><span class="ident" id="3066612">next</span><span class="op" id="3066616">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066622">if</span>&nbsp;<span class="ident" id="3066625">i</span><span class="op" id="3066626">.</span><span class="ident" id="3066627">Op</span>&nbsp;<span class="op" id="3066630">==</span>&nbsp;<span class="ident" id="3066633">syntax</span><span class="op" id="3066639">.</span><span class="ident" id="3066640">InstAltMatch</span>&nbsp;<span class="op" id="3066653">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066657">return</span>&nbsp;<span class="ident" id="3066664">i</span><span class="op" id="3066665">.</span><span class="ident" id="3066666">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066674">return</span>&nbsp;<span class="num" id="3066681">0</span><br>
<span class="lineno"></span><span class="op" id="3066683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="3066686">func</span>&nbsp;<span class="ident" id="3066691">iop</span><span class="op" id="3066694">(</span><span class="ident" id="3066695">i</span>&nbsp;<span class="op" id="3066697">*</span><span class="ident" id="3066698">syntax</span><span class="op" id="3066704">.</span><span class="ident" id="3066705">Inst</span><span class="op" id="3066709">)</span>&nbsp;<span class="ident" id="3066711">syntax</span><span class="op" id="3066717">.</span><span class="ident" id="3066718">InstOp</span>&nbsp;<span class="op" id="3066725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066728">op</span>&nbsp;<span class="op" id="3066731">:=</span>&nbsp;<span class="ident" id="3066734">i</span><span class="op" id="3066735">.</span><span class="ident" id="3066736">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066740">switch</span>&nbsp;<span class="ident" id="3066747">op</span>&nbsp;<span class="op" id="3066750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066753">case</span>&nbsp;<span class="ident" id="3066758">syntax</span><span class="op" id="3066764">.</span><span class="ident" id="3066765">InstRune1</span><span class="op" id="3066774">,</span>&nbsp;<span class="ident" id="3066776">syntax</span><span class="op" id="3066782">.</span><span class="ident" id="3066783">InstRuneAny</span><span class="op" id="3066794">,</span>&nbsp;<span class="ident" id="3066796">syntax</span><span class="op" id="3066802">.</span><span class="ident" id="3066803">InstRuneAnyNotNL</span><span class="op" id="3066819">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066823">op</span>&nbsp;<span class="op" id="3066826">=</span>&nbsp;<span class="ident" id="3066828">syntax</span><span class="op" id="3066834">.</span><span class="ident" id="3066835">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3066845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3066848">return</span>&nbsp;<span class="ident" id="3066855">op</span><br>
<span class="lineno"></span><span class="op" id="3066858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3066861">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="3066919">type</span>&nbsp;<span class="ident" id="3066924">queueOnePass</span>&nbsp;<span class="keyword" id="3066937">struct</span>&nbsp;<span class="op" id="3066944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066947">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3066963">[</span><span class="op" id="3066964">]</span><span class="builtintype" id="3066965">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066973">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3066989">[</span><span class="op" id="3066990">]</span><span class="builtintype" id="3066991">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3066999">size</span><span class="op" id="3067003">,</span>&nbsp;<span class="ident" id="3067005">nextIndex</span>&nbsp;<span class="builtintype" id="3067015">uint32</span><br>
<span class="lineno"></span><span class="op" id="3067022">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="3067025">func</span>&nbsp;<span class="op" id="3067030">(</span><span class="ident" id="3067031">q</span>&nbsp;<span class="op" id="3067033">*</span><span class="ident" id="3067034">queueOnePass</span><span class="op" id="3067046">)</span>&nbsp;<span class="ident" id="3067048">empty</span><span class="op" id="3067053">(</span><span class="op" id="3067054">)</span>&nbsp;<span class="builtintype" id="3067056">bool</span>&nbsp;<span class="op" id="3067061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067064">return</span>&nbsp;<span class="ident" id="3067071">q</span><span class="op" id="3067072">.</span><span class="ident" id="3067073">nextIndex</span>&nbsp;<span class="op" id="3067083">&gt;=</span>&nbsp;<span class="ident" id="3067086">q</span><span class="op" id="3067087">.</span><span class="ident" id="3067088">size</span><br>
<span class="lineno"></span><span class="op" id="3067093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="3067096">func</span>&nbsp;<span class="op" id="3067101">(</span><span class="ident" id="3067102">q</span>&nbsp;<span class="op" id="3067104">*</span><span class="ident" id="3067105">queueOnePass</span><span class="op" id="3067117">)</span>&nbsp;<span class="ident" id="3067119">next</span><span class="op" id="3067123">(</span><span class="op" id="3067124">)</span>&nbsp;<span class="op" id="3067126">(</span><span class="ident" id="3067127">n</span>&nbsp;<span class="builtintype" id="3067129">uint32</span><span class="op" id="3067135">)</span>&nbsp;<span class="op" id="3067137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067140">n</span>&nbsp;<span class="op" id="3067142">=</span>&nbsp;<span class="ident" id="3067144">q</span><span class="op" id="3067145">.</span><span class="ident" id="3067146">dense</span><span class="op" id="3067151">[</span><span class="ident" id="3067152">q</span><span class="op" id="3067153">.</span><span class="ident" id="3067154">nextIndex</span><span class="op" id="3067163">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067166">q</span><span class="op" id="3067167">.</span><span class="ident" id="3067168">nextIndex</span><span class="op" id="3067177">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067181">return</span><br>
<span class="lineno"></span><span class="op" id="3067188">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3067191">func</span>&nbsp;<span class="op" id="3067196">(</span><span class="ident" id="3067197">q</span>&nbsp;<span class="op" id="3067199">*</span><span class="ident" id="3067200">queueOnePass</span><span class="op" id="3067212">)</span>&nbsp;<span class="ident" id="3067214">clear</span><span class="op" id="3067219">(</span><span class="op" id="3067220">)</span>&nbsp;<span class="op" id="3067222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067225">q</span><span class="op" id="3067226">.</span><span class="ident" id="3067227">size</span>&nbsp;<span class="op" id="3067232">=</span>&nbsp;<span class="num" id="3067234">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067237">q</span><span class="op" id="3067238">.</span><span class="ident" id="3067239">nextIndex</span>&nbsp;<span class="op" id="3067249">=</span>&nbsp;<span class="num" id="3067251">0</span><br>
<span class="lineno"></span><span class="op" id="3067253">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="3067256">func</span>&nbsp;<span class="op" id="3067261">(</span><span class="ident" id="3067262">q</span>&nbsp;<span class="op" id="3067264">*</span><span class="ident" id="3067265">queueOnePass</span><span class="op" id="3067277">)</span>&nbsp;<span class="ident" id="3067279">reset</span><span class="op" id="3067284">(</span><span class="op" id="3067285">)</span>&nbsp;<span class="op" id="3067287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067290">q</span><span class="op" id="3067291">.</span><span class="ident" id="3067292">nextIndex</span>&nbsp;<span class="op" id="3067302">=</span>&nbsp;<span class="num" id="3067304">0</span><br>
<span class="lineno"></span><span class="op" id="3067306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="3067309">func</span>&nbsp;<span class="op" id="3067314">(</span><span class="ident" id="3067315">q</span>&nbsp;<span class="op" id="3067317">*</span><span class="ident" id="3067318">queueOnePass</span><span class="op" id="3067330">)</span>&nbsp;<span class="ident" id="3067332">contains</span><span class="op" id="3067340">(</span><span class="ident" id="3067341">u</span>&nbsp;<span class="builtintype" id="3067343">uint32</span><span class="op" id="3067349">)</span>&nbsp;<span class="builtintype" id="3067351">bool</span>&nbsp;<span class="op" id="3067356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067359">if</span>&nbsp;<span class="ident" id="3067362">u</span>&nbsp;<span class="op" id="3067364">&gt;=</span>&nbsp;<span class="builtintype" id="3067367">uint32</span><span class="op" id="3067373">(</span><span class="builtinfunc" id="3067374">len</span><span class="op" id="3067377">(</span><span class="ident" id="3067378">q</span><span class="op" id="3067379">.</span><span class="ident" id="3067380">sparse</span><span class="op" id="3067386">)</span><span class="op" id="3067387">)</span>&nbsp;<span class="op" id="3067389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067393">return</span>&nbsp;<span class="builtintype" id="3067400">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3067407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067410">return</span>&nbsp;<span class="ident" id="3067417">q</span><span class="op" id="3067418">.</span><span class="ident" id="3067419">sparse</span><span class="op" id="3067425">[</span><span class="ident" id="3067426">u</span><span class="op" id="3067427">]</span>&nbsp;<span class="op" id="3067429">&lt;</span>&nbsp;<span class="ident" id="3067431">q</span><span class="op" id="3067432">.</span><span class="ident" id="3067433">size</span>&nbsp;<span class="op" id="3067438">&amp;&amp;</span>&nbsp;<span class="ident" id="3067441">q</span><span class="op" id="3067442">.</span><span class="ident" id="3067443">dense</span><span class="op" id="3067448">[</span><span class="ident" id="3067449">q</span><span class="op" id="3067450">.</span><span class="ident" id="3067451">sparse</span><span class="op" id="3067457">[</span><span class="ident" id="3067458">u</span><span class="op" id="3067459">]</span><span class="op" id="3067460">]</span>&nbsp;<span class="op" id="3067462">==</span>&nbsp;<span class="ident" id="3067465">u</span><br>
<span class="lineno">120</span><span class="op" id="3067467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3067470">func</span>&nbsp;<span class="op" id="3067475">(</span><span class="ident" id="3067476">q</span>&nbsp;<span class="op" id="3067478">*</span><span class="ident" id="3067479">queueOnePass</span><span class="op" id="3067491">)</span>&nbsp;<span class="ident" id="3067493">insert</span><span class="op" id="3067499">(</span><span class="ident" id="3067500">u</span>&nbsp;<span class="builtintype" id="3067502">uint32</span><span class="op" id="3067508">)</span>&nbsp;<span class="op" id="3067510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067513">if</span>&nbsp;<span class="op" id="3067516">!</span><span class="ident" id="3067517">q</span><span class="op" id="3067518">.</span><span class="ident" id="3067519">contains</span><span class="op" id="3067527">(</span><span class="ident" id="3067528">u</span><span class="op" id="3067529">)</span>&nbsp;<span class="op" id="3067531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067535">q</span><span class="op" id="3067536">.</span><span class="ident" id="3067537">insertNew</span><span class="op" id="3067546">(</span><span class="ident" id="3067547">u</span><span class="op" id="3067548">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3067551">}</span><br>
<span class="lineno"></span><span class="op" id="3067553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3067556">func</span>&nbsp;<span class="op" id="3067561">(</span><span class="ident" id="3067562">q</span>&nbsp;<span class="op" id="3067564">*</span><span class="ident" id="3067565">queueOnePass</span><span class="op" id="3067577">)</span>&nbsp;<span class="ident" id="3067579">insertNew</span><span class="op" id="3067588">(</span><span class="ident" id="3067589">u</span>&nbsp;<span class="builtintype" id="3067591">uint32</span><span class="op" id="3067597">)</span>&nbsp;<span class="op" id="3067599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067602">if</span>&nbsp;<span class="ident" id="3067605">u</span>&nbsp;<span class="op" id="3067607">&gt;=</span>&nbsp;<span class="builtintype" id="3067610">uint32</span><span class="op" id="3067616">(</span><span class="builtinfunc" id="3067617">len</span><span class="op" id="3067620">(</span><span class="ident" id="3067621">q</span><span class="op" id="3067622">.</span><span class="ident" id="3067623">sparse</span><span class="op" id="3067629">)</span><span class="op" id="3067630">)</span>&nbsp;<span class="op" id="3067632">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067636">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3067644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067647">q</span><span class="op" id="3067648">.</span><span class="ident" id="3067649">sparse</span><span class="op" id="3067655">[</span><span class="ident" id="3067656">u</span><span class="op" id="3067657">]</span>&nbsp;<span class="op" id="3067659">=</span>&nbsp;<span class="ident" id="3067661">q</span><span class="op" id="3067662">.</span><span class="ident" id="3067663">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067669">q</span><span class="op" id="3067670">.</span><span class="ident" id="3067671">dense</span><span class="op" id="3067676">[</span><span class="ident" id="3067677">q</span><span class="op" id="3067678">.</span><span class="ident" id="3067679">size</span><span class="op" id="3067683">]</span>&nbsp;<span class="op" id="3067685">=</span>&nbsp;<span class="ident" id="3067687">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067690">q</span><span class="op" id="3067691">.</span><span class="ident" id="3067692">size</span><span class="op" id="3067696">++</span><br>
<span class="lineno">135</span><span class="op" id="3067699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3067702">func</span>&nbsp;<span class="ident" id="3067707">newQueue</span><span class="op" id="3067715">(</span><span class="ident" id="3067716">size</span>&nbsp;<span class="builtintype" id="3067721">int</span><span class="op" id="3067724">)</span>&nbsp;<span class="op" id="3067726">(</span><span class="ident" id="3067727">q</span>&nbsp;<span class="op" id="3067729">*</span><span class="ident" id="3067730">queueOnePass</span><span class="op" id="3067742">)</span>&nbsp;<span class="op" id="3067744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3067747">return</span>&nbsp;<span class="op" id="3067754">&amp;</span><span class="ident" id="3067755">queueOnePass</span><span class="op" id="3067767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067771">sparse</span><span class="op" id="3067777">:</span>&nbsp;<span class="builtinfunc" id="3067779">make</span><span class="op" id="3067783">(</span><span class="op" id="3067784">[</span><span class="op" id="3067785">]</span><span class="builtintype" id="3067786">uint32</span><span class="op" id="3067792">,</span>&nbsp;<span class="ident" id="3067794">size</span><span class="op" id="3067798">)</span><span class="op" id="3067799">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3067803">dense</span><span class="op" id="3067808">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="3067811">make</span><span class="op" id="3067815">(</span><span class="op" id="3067816">[</span><span class="op" id="3067817">]</span><span class="builtintype" id="3067818">uint32</span><span class="op" id="3067824">,</span>&nbsp;<span class="ident" id="3067826">size</span><span class="op" id="3067830">)</span><span class="op" id="3067831">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3067834">}</span><br>
<span class="lineno"></span><span class="op" id="3067836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3067839">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="3067925">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="3068009">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3068094">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="3068159">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="3068245">const</span>&nbsp;<span class="ident" id="3068251">mergeFailed</span>&nbsp;<span class="op" id="3068263">=</span>&nbsp;<span class="builtintype" id="3068265">uint32</span><span class="op" id="3068271">(</span><span class="num" id="3068272">0xffffffff</span><span class="op" id="3068282">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="3068285">var</span>&nbsp;<span class="op" id="3068289">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068292">noRune</span>&nbsp;<span class="op" id="3068299">=</span>&nbsp;<span class="op" id="3068301">[</span><span class="op" id="3068302">]</span><span class="builtintype" id="3068303">rune</span><span class="op" id="3068307">{</span><span class="op" id="3068308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068311">noNext</span>&nbsp;<span class="op" id="3068318">=</span>&nbsp;<span class="op" id="3068320">[</span><span class="op" id="3068321">]</span><span class="builtintype" id="3068322">uint32</span><span class="op" id="3068328">{</span><span class="ident" id="3068329">mergeFailed</span><span class="op" id="3068340">}</span><br>
<span class="lineno"></span><span class="op" id="3068342">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="3068345">func</span>&nbsp;<span class="ident" id="3068350">mergeRuneSets</span><span class="op" id="3068363">(</span><span class="ident" id="3068364">leftRunes</span><span class="op" id="3068373">,</span>&nbsp;<span class="ident" id="3068375">rightRunes</span>&nbsp;<span class="op" id="3068386">*</span><span class="op" id="3068387">[</span><span class="op" id="3068388">]</span><span class="builtintype" id="3068389">rune</span><span class="op" id="3068393">,</span>&nbsp;<span class="ident" id="3068395">leftPC</span><span class="op" id="3068401">,</span>&nbsp;<span class="ident" id="3068403">rightPC</span>&nbsp;<span class="builtintype" id="3068411">uint32</span><span class="op" id="3068417">)</span>&nbsp;<span class="op" id="3068419">(</span><span class="op" id="3068420">[</span><span class="op" id="3068421">]</span><span class="builtintype" id="3068422">rune</span><span class="op" id="3068426">,</span>&nbsp;<span class="op" id="3068428">[</span><span class="op" id="3068429">]</span><span class="builtintype" id="3068430">uint32</span><span class="op" id="3068436">)</span>&nbsp;<span class="op" id="3068438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068441">leftLen</span>&nbsp;<span class="op" id="3068449">:=</span>&nbsp;<span class="builtinfunc" id="3068452">len</span><span class="op" id="3068455">(</span><span class="op" id="3068456">*</span><span class="ident" id="3068457">leftRunes</span><span class="op" id="3068466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068469">rightLen</span>&nbsp;<span class="op" id="3068478">:=</span>&nbsp;<span class="builtinfunc" id="3068481">len</span><span class="op" id="3068484">(</span><span class="op" id="3068485">*</span><span class="ident" id="3068486">rightRunes</span><span class="op" id="3068496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068499">if</span>&nbsp;<span class="ident" id="3068502">leftLen</span><span class="op" id="3068509">&amp;</span><span class="num" id="3068510">0x1</span>&nbsp;<span class="op" id="3068514">!=</span>&nbsp;<span class="num" id="3068517">0</span>&nbsp;<span class="op" id="3068519">||</span>&nbsp;<span class="ident" id="3068522">rightLen</span><span class="op" id="3068530">&amp;</span><span class="num" id="3068531">0x1</span>&nbsp;<span class="op" id="3068535">!=</span>&nbsp;<span class="num" id="3068538">0</span>&nbsp;<span class="op" id="3068540">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3068544">panic</span><span class="op" id="3068549">(</span><span class="string" id="3068550">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="3068583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3068586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068589">var</span>&nbsp;<span class="op" id="3068593">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068597">lx</span><span class="op" id="3068599">,</span>&nbsp;<span class="ident" id="3068601">rx</span>&nbsp;<span class="builtintype" id="3068604">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3068609">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068612">merged</span>&nbsp;<span class="op" id="3068619">:=</span>&nbsp;<span class="builtinfunc" id="3068622">make</span><span class="op" id="3068626">(</span><span class="op" id="3068627">[</span><span class="op" id="3068628">]</span><span class="builtintype" id="3068629">rune</span><span class="op" id="3068633">,</span>&nbsp;<span class="num" id="3068635">0</span><span class="op" id="3068636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068639">next</span>&nbsp;<span class="op" id="3068644">:=</span>&nbsp;<span class="builtinfunc" id="3068647">make</span><span class="op" id="3068651">(</span><span class="op" id="3068652">[</span><span class="op" id="3068653">]</span><span class="builtintype" id="3068654">uint32</span><span class="op" id="3068660">,</span>&nbsp;<span class="num" id="3068662">0</span><span class="op" id="3068663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068666">ok</span>&nbsp;<span class="op" id="3068669">:=</span>&nbsp;<span class="builtintype" id="3068672">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068678">defer</span>&nbsp;<span class="keyword" id="3068684">func</span><span class="op" id="3068688">(</span><span class="op" id="3068689">)</span>&nbsp;<span class="op" id="3068691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068695">if</span>&nbsp;<span class="op" id="3068698">!</span><span class="ident" id="3068699">ok</span>&nbsp;<span class="op" id="3068702">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068707">merged</span>&nbsp;<span class="op" id="3068714">=</span>&nbsp;<span class="ident" id="3068716">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068723">next</span>&nbsp;<span class="op" id="3068728">=</span>&nbsp;<span class="ident" id="3068730">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3068736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3068739">}</span><span class="op" id="3068740">(</span><span class="op" id="3068741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068745">ix</span>&nbsp;<span class="op" id="3068748">:=</span>&nbsp;<span class="op" id="3068751">-</span><span class="num" id="3068752">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068755">extend</span>&nbsp;<span class="op" id="3068762">:=</span>&nbsp;<span class="keyword" id="3068765">func</span><span class="op" id="3068769">(</span><span class="ident" id="3068770">newLow</span>&nbsp;<span class="op" id="3068777">*</span><span class="builtintype" id="3068778">int</span><span class="op" id="3068781">,</span>&nbsp;<span class="ident" id="3068783">newArray</span>&nbsp;<span class="op" id="3068792">*</span><span class="op" id="3068793">[</span><span class="op" id="3068794">]</span><span class="builtintype" id="3068795">rune</span><span class="op" id="3068799">,</span>&nbsp;<span class="ident" id="3068801">pc</span>&nbsp;<span class="builtintype" id="3068804">uint32</span><span class="op" id="3068810">)</span>&nbsp;<span class="builtintype" id="3068812">bool</span>&nbsp;<span class="op" id="3068817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068821">if</span>&nbsp;<span class="ident" id="3068824">ix</span>&nbsp;<span class="op" id="3068827">&gt;</span>&nbsp;<span class="num" id="3068829">0</span>&nbsp;<span class="op" id="3068831">&amp;&amp;</span>&nbsp;<span class="op" id="3068834">(</span><span class="op" id="3068835">*</span><span class="ident" id="3068836">newArray</span><span class="op" id="3068844">)</span><span class="op" id="3068845">[</span><span class="op" id="3068846">*</span><span class="ident" id="3068847">newLow</span><span class="op" id="3068853">]</span>&nbsp;<span class="op" id="3068855">&lt;=</span>&nbsp;<span class="ident" id="3068858">merged</span><span class="op" id="3068864">[</span><span class="ident" id="3068865">ix</span><span class="op" id="3068867">]</span>&nbsp;<span class="op" id="3068869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3068874">return</span>&nbsp;<span class="builtintype" id="3068881">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3068889">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068893">merged</span>&nbsp;<span class="op" id="3068900">=</span>&nbsp;<span class="builtinfunc" id="3068902">append</span><span class="op" id="3068908">(</span><span class="ident" id="3068909">merged</span><span class="op" id="3068915">,</span>&nbsp;<span class="op" id="3068917">(</span><span class="op" id="3068918">*</span><span class="ident" id="3068919">newArray</span><span class="op" id="3068927">)</span><span class="op" id="3068928">[</span><span class="op" id="3068929">*</span><span class="ident" id="3068930">newLow</span><span class="op" id="3068936">]</span><span class="op" id="3068937">,</span>&nbsp;<span class="op" id="3068939">(</span><span class="op" id="3068940">*</span><span class="ident" id="3068941">newArray</span><span class="op" id="3068949">)</span><span class="op" id="3068950">[</span><span class="op" id="3068951">*</span><span class="ident" id="3068952">newLow</span><span class="op" id="3068958">+</span><span class="num" id="3068959">1</span><span class="op" id="3068960">]</span><span class="op" id="3068961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3068965">*</span><span class="ident" id="3068966">newLow</span>&nbsp;<span class="op" id="3068973">+=</span>&nbsp;<span class="num" id="3068976">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068980">ix</span>&nbsp;<span class="op" id="3068983">+=</span>&nbsp;<span class="num" id="3068986">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3068990">next</span>&nbsp;<span class="op" id="3068995">=</span>&nbsp;<span class="builtinfunc" id="3068997">append</span><span class="op" id="3069003">(</span><span class="ident" id="3069004">next</span><span class="op" id="3069008">,</span>&nbsp;<span class="ident" id="3069010">pc</span><span class="op" id="3069012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069016">return</span>&nbsp;<span class="builtintype" id="3069023">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3069029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069033">for</span>&nbsp;<span class="ident" id="3069037">lx</span>&nbsp;<span class="op" id="3069040">&lt;</span>&nbsp;<span class="ident" id="3069042">leftLen</span>&nbsp;<span class="op" id="3069050">||</span>&nbsp;<span class="ident" id="3069053">rx</span>&nbsp;<span class="op" id="3069056">&lt;</span>&nbsp;<span class="ident" id="3069058">rightLen</span>&nbsp;<span class="op" id="3069067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069071">switch</span>&nbsp;<span class="op" id="3069078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069082">case</span>&nbsp;<span class="ident" id="3069087">rx</span>&nbsp;<span class="op" id="3069090">&gt;=</span>&nbsp;<span class="ident" id="3069093">rightLen</span><span class="op" id="3069101">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069106">ok</span>&nbsp;<span class="op" id="3069109">=</span>&nbsp;<span class="ident" id="3069111">extend</span><span class="op" id="3069117">(</span><span class="op" id="3069118">&amp;</span><span class="ident" id="3069119">lx</span><span class="op" id="3069121">,</span>&nbsp;<span class="ident" id="3069123">leftRunes</span><span class="op" id="3069132">,</span>&nbsp;<span class="ident" id="3069134">leftPC</span><span class="op" id="3069140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069144">case</span>&nbsp;<span class="ident" id="3069149">lx</span>&nbsp;<span class="op" id="3069152">&gt;=</span>&nbsp;<span class="ident" id="3069155">leftLen</span><span class="op" id="3069162">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069167">ok</span>&nbsp;<span class="op" id="3069170">=</span>&nbsp;<span class="ident" id="3069172">extend</span><span class="op" id="3069178">(</span><span class="op" id="3069179">&amp;</span><span class="ident" id="3069180">rx</span><span class="op" id="3069182">,</span>&nbsp;<span class="ident" id="3069184">rightRunes</span><span class="op" id="3069194">,</span>&nbsp;<span class="ident" id="3069196">rightPC</span><span class="op" id="3069203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069207">case</span>&nbsp;<span class="op" id="3069212">(</span><span class="op" id="3069213">*</span><span class="ident" id="3069214">rightRunes</span><span class="op" id="3069224">)</span><span class="op" id="3069225">[</span><span class="ident" id="3069226">rx</span><span class="op" id="3069228">]</span>&nbsp;<span class="op" id="3069230">&lt;</span>&nbsp;<span class="op" id="3069232">(</span><span class="op" id="3069233">*</span><span class="ident" id="3069234">leftRunes</span><span class="op" id="3069243">)</span><span class="op" id="3069244">[</span><span class="ident" id="3069245">lx</span><span class="op" id="3069247">]</span><span class="op" id="3069248">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069253">ok</span>&nbsp;<span class="op" id="3069256">=</span>&nbsp;<span class="ident" id="3069258">extend</span><span class="op" id="3069264">(</span><span class="op" id="3069265">&amp;</span><span class="ident" id="3069266">rx</span><span class="op" id="3069268">,</span>&nbsp;<span class="ident" id="3069270">rightRunes</span><span class="op" id="3069280">,</span>&nbsp;<span class="ident" id="3069282">rightPC</span><span class="op" id="3069289">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069293">default</span><span class="op" id="3069300">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069305">ok</span>&nbsp;<span class="op" id="3069308">=</span>&nbsp;<span class="ident" id="3069310">extend</span><span class="op" id="3069316">(</span><span class="op" id="3069317">&amp;</span><span class="ident" id="3069318">lx</span><span class="op" id="3069320">,</span>&nbsp;<span class="ident" id="3069322">leftRunes</span><span class="op" id="3069331">,</span>&nbsp;<span class="ident" id="3069333">leftPC</span><span class="op" id="3069339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3069343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069347">if</span>&nbsp;<span class="op" id="3069350">!</span><span class="ident" id="3069351">ok</span>&nbsp;<span class="op" id="3069354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069359">return</span>&nbsp;<span class="ident" id="3069366">noRune</span><span class="op" id="3069372">,</span>&nbsp;<span class="ident" id="3069374">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3069383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3069386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069389">return</span>&nbsp;<span class="ident" id="3069396">merged</span><span class="op" id="3069402">,</span>&nbsp;<span class="ident" id="3069404">next</span><br>
<span class="lineno"></span><span class="op" id="3069409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="3069412">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="3069496">func</span>&nbsp;<span class="ident" id="3069501">cleanupOnePass</span><span class="op" id="3069515">(</span><span class="ident" id="3069516">prog</span>&nbsp;<span class="op" id="3069521">*</span><span class="ident" id="3069522">onePassProg</span><span class="op" id="3069533">,</span>&nbsp;<span class="ident" id="3069535">original</span>&nbsp;<span class="op" id="3069544">*</span><span class="ident" id="3069545">syntax</span><span class="op" id="3069551">.</span><span class="ident" id="3069552">Prog</span><span class="op" id="3069556">)</span>&nbsp;<span class="op" id="3069558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069561">for</span>&nbsp;<span class="ident" id="3069565">ix</span><span class="op" id="3069567">,</span>&nbsp;<span class="ident" id="3069569">instOriginal</span>&nbsp;<span class="op" id="3069582">:=</span>&nbsp;<span class="keyword" id="3069585">range</span>&nbsp;<span class="ident" id="3069591">original</span><span class="op" id="3069599">.</span><span class="ident" id="3069600">Inst</span>&nbsp;<span class="op" id="3069605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069609">switch</span>&nbsp;<span class="ident" id="3069616">instOriginal</span><span class="op" id="3069628">.</span><span class="ident" id="3069629">Op</span>&nbsp;<span class="op" id="3069632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069636">case</span>&nbsp;<span class="ident" id="3069641">syntax</span><span class="op" id="3069647">.</span><span class="ident" id="3069648">InstAlt</span><span class="op" id="3069655">,</span>&nbsp;<span class="ident" id="3069657">syntax</span><span class="op" id="3069663">.</span><span class="ident" id="3069664">InstAltMatch</span><span class="op" id="3069676">,</span>&nbsp;<span class="ident" id="3069678">syntax</span><span class="op" id="3069684">.</span><span class="ident" id="3069685">InstRune</span><span class="op" id="3069693">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069697">case</span>&nbsp;<span class="ident" id="3069702">syntax</span><span class="op" id="3069708">.</span><span class="ident" id="3069709">InstCapture</span><span class="op" id="3069720">,</span>&nbsp;<span class="ident" id="3069722">syntax</span><span class="op" id="3069728">.</span><span class="ident" id="3069729">InstEmptyWidth</span><span class="op" id="3069743">,</span>&nbsp;<span class="ident" id="3069745">syntax</span><span class="op" id="3069751">.</span><span class="ident" id="3069752">InstNop</span><span class="op" id="3069759">,</span>&nbsp;<span class="ident" id="3069761">syntax</span><span class="op" id="3069767">.</span><span class="ident" id="3069768">InstMatch</span><span class="op" id="3069777">,</span>&nbsp;<span class="ident" id="3069779">syntax</span><span class="op" id="3069785">.</span><span class="ident" id="3069786">InstFail</span><span class="op" id="3069794">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069799">prog</span><span class="op" id="3069803">.</span><span class="ident" id="3069804">Inst</span><span class="op" id="3069808">[</span><span class="ident" id="3069809">ix</span><span class="op" id="3069811">]</span><span class="op" id="3069812">.</span><span class="ident" id="3069813">Next</span>&nbsp;<span class="op" id="3069818">=</span>&nbsp;<span class="ident" id="3069820">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3069826">case</span>&nbsp;<span class="ident" id="3069831">syntax</span><span class="op" id="3069837">.</span><span class="ident" id="3069838">InstRune1</span><span class="op" id="3069847">,</span>&nbsp;<span class="ident" id="3069849">syntax</span><span class="op" id="3069855">.</span><span class="ident" id="3069856">InstRuneAny</span><span class="op" id="3069867">,</span>&nbsp;<span class="ident" id="3069869">syntax</span><span class="op" id="3069875">.</span><span class="ident" id="3069876">InstRuneAnyNotNL</span><span class="op" id="3069892">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069897">prog</span><span class="op" id="3069901">.</span><span class="ident" id="3069902">Inst</span><span class="op" id="3069906">[</span><span class="ident" id="3069907">ix</span><span class="op" id="3069909">]</span><span class="op" id="3069910">.</span><span class="ident" id="3069911">Next</span>&nbsp;<span class="op" id="3069916">=</span>&nbsp;<span class="ident" id="3069918">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3069925">prog</span><span class="op" id="3069929">.</span><span class="ident" id="3069930">Inst</span><span class="op" id="3069934">[</span><span class="ident" id="3069935">ix</span><span class="op" id="3069937">]</span>&nbsp;<span class="op" id="3069939">=</span>&nbsp;<span class="ident" id="3069941">onePassInst</span><span class="op" id="3069952">{</span><span class="ident" id="3069953">Inst</span><span class="op" id="3069957">:</span>&nbsp;<span class="ident" id="3069959">instOriginal</span><span class="op" id="3069971">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3069975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3069978">}</span><br>
<span class="lineno"></span><span class="op" id="3069980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3069983">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="3070060">func</span>&nbsp;<span class="ident" id="3070065">onePassCopy</span><span class="op" id="3070076">(</span><span class="ident" id="3070077">prog</span>&nbsp;<span class="op" id="3070082">*</span><span class="ident" id="3070083">syntax</span><span class="op" id="3070089">.</span><span class="ident" id="3070090">Prog</span><span class="op" id="3070094">)</span>&nbsp;<span class="op" id="3070096">*</span><span class="ident" id="3070097">onePassProg</span>&nbsp;<span class="op" id="3070109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070112">p</span>&nbsp;<span class="op" id="3070114">:=</span>&nbsp;<span class="op" id="3070117">&amp;</span><span class="ident" id="3070118">onePassProg</span><span class="op" id="3070129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070133">Start</span><span class="op" id="3070138">:</span>&nbsp;&nbsp;<span class="ident" id="3070141">prog</span><span class="op" id="3070145">.</span><span class="ident" id="3070146">Start</span><span class="op" id="3070151">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070155">NumCap</span><span class="op" id="3070161">:</span>&nbsp;<span class="ident" id="3070163">prog</span><span class="op" id="3070167">.</span><span class="ident" id="3070168">NumCap</span><span class="op" id="3070174">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3070177">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070180">for</span>&nbsp;<span class="ident" id="3070184">_</span><span class="op" id="3070185">,</span>&nbsp;<span class="ident" id="3070187">inst</span>&nbsp;<span class="op" id="3070192">:=</span>&nbsp;<span class="keyword" id="3070195">range</span>&nbsp;<span class="ident" id="3070201">prog</span><span class="op" id="3070205">.</span><span class="ident" id="3070206">Inst</span>&nbsp;<span class="op" id="3070211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070215">p</span><span class="op" id="3070216">.</span><span class="ident" id="3070217">Inst</span>&nbsp;<span class="op" id="3070222">=</span>&nbsp;<span class="builtinfunc" id="3070224">append</span><span class="op" id="3070230">(</span><span class="ident" id="3070231">p</span><span class="op" id="3070232">.</span><span class="ident" id="3070233">Inst</span><span class="op" id="3070237">,</span>&nbsp;<span class="ident" id="3070239">onePassInst</span><span class="op" id="3070250">{</span><span class="ident" id="3070251">Inst</span><span class="op" id="3070255">:</span>&nbsp;<span class="ident" id="3070257">inst</span><span class="op" id="3070261">}</span><span class="op" id="3070262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3070265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3070269">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3070344">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3070420">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3070456">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3070487">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070518">for</span>&nbsp;<span class="ident" id="3070522">pc</span>&nbsp;<span class="op" id="3070525">:=</span>&nbsp;<span class="keyword" id="3070528">range</span>&nbsp;<span class="ident" id="3070534">p</span><span class="op" id="3070535">.</span><span class="ident" id="3070536">Inst</span>&nbsp;<span class="op" id="3070541">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070545">switch</span>&nbsp;<span class="ident" id="3070552">p</span><span class="op" id="3070553">.</span><span class="ident" id="3070554">Inst</span><span class="op" id="3070558">[</span><span class="ident" id="3070559">pc</span><span class="op" id="3070561">]</span><span class="op" id="3070562">.</span><span class="ident" id="3070563">Op</span>&nbsp;<span class="op" id="3070566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070570">default</span><span class="op" id="3070577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070582">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070593">case</span>&nbsp;<span class="ident" id="3070598">syntax</span><span class="op" id="3070604">.</span><span class="ident" id="3070605">InstAlt</span><span class="op" id="3070612">,</span>&nbsp;<span class="ident" id="3070614">syntax</span><span class="op" id="3070620">.</span><span class="ident" id="3070621">InstAltMatch</span><span class="op" id="3070633">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3070638">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070656">p_A_Other</span>&nbsp;<span class="op" id="3070666">:=</span>&nbsp;<span class="op" id="3070669">&amp;</span><span class="ident" id="3070670">p</span><span class="op" id="3070671">.</span><span class="ident" id="3070672">Inst</span><span class="op" id="3070676">[</span><span class="ident" id="3070677">pc</span><span class="op" id="3070679">]</span><span class="op" id="3070680">.</span><span class="ident" id="3070681">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070688">p_A_Alt</span>&nbsp;<span class="op" id="3070696">:=</span>&nbsp;<span class="op" id="3070699">&amp;</span><span class="ident" id="3070700">p</span><span class="op" id="3070701">.</span><span class="ident" id="3070702">Inst</span><span class="op" id="3070706">[</span><span class="ident" id="3070707">pc</span><span class="op" id="3070709">]</span><span class="op" id="3070710">.</span><span class="ident" id="3070711">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3070718">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070758">instAlt</span>&nbsp;<span class="op" id="3070766">:=</span>&nbsp;<span class="ident" id="3070769">p</span><span class="op" id="3070770">.</span><span class="ident" id="3070771">Inst</span><span class="op" id="3070775">[</span><span class="op" id="3070776">*</span><span class="ident" id="3070777">p_A_Alt</span><span class="op" id="3070784">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070789">if</span>&nbsp;<span class="op" id="3070792">!</span><span class="op" id="3070793">(</span><span class="ident" id="3070794">instAlt</span><span class="op" id="3070801">.</span><span class="ident" id="3070802">Op</span>&nbsp;<span class="op" id="3070805">==</span>&nbsp;<span class="ident" id="3070808">syntax</span><span class="op" id="3070814">.</span><span class="ident" id="3070815">InstAlt</span>&nbsp;<span class="op" id="3070823">||</span>&nbsp;<span class="ident" id="3070826">instAlt</span><span class="op" id="3070833">.</span><span class="ident" id="3070834">Op</span>&nbsp;<span class="op" id="3070837">==</span>&nbsp;<span class="ident" id="3070840">syntax</span><span class="op" id="3070846">.</span><span class="ident" id="3070847">InstAltMatch</span><span class="op" id="3070859">)</span>&nbsp;<span class="op" id="3070861">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070867">p_A_Alt</span><span class="op" id="3070874">,</span>&nbsp;<span class="ident" id="3070876">p_A_Other</span>&nbsp;<span class="op" id="3070886">=</span>&nbsp;<span class="ident" id="3070888">p_A_Other</span><span class="op" id="3070897">,</span>&nbsp;<span class="ident" id="3070899">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3070911">instAlt</span>&nbsp;<span class="op" id="3070919">=</span>&nbsp;<span class="ident" id="3070921">p</span><span class="op" id="3070922">.</span><span class="ident" id="3070923">Inst</span><span class="op" id="3070927">[</span><span class="op" id="3070928">*</span><span class="ident" id="3070929">p_A_Alt</span><span class="op" id="3070936">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3070942">if</span>&nbsp;<span class="op" id="3070945">!</span><span class="op" id="3070946">(</span><span class="ident" id="3070947">instAlt</span><span class="op" id="3070954">.</span><span class="ident" id="3070955">Op</span>&nbsp;<span class="op" id="3070958">==</span>&nbsp;<span class="ident" id="3070961">syntax</span><span class="op" id="3070967">.</span><span class="ident" id="3070968">InstAlt</span>&nbsp;<span class="op" id="3070976">||</span>&nbsp;<span class="ident" id="3070979">instAlt</span><span class="op" id="3070986">.</span><span class="ident" id="3070987">Op</span>&nbsp;<span class="op" id="3070990">==</span>&nbsp;<span class="ident" id="3070993">syntax</span><span class="op" id="3070999">.</span><span class="ident" id="3071000">InstAltMatch</span><span class="op" id="3071012">)</span>&nbsp;<span class="op" id="3071014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071021">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071034">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071044">instOther</span>&nbsp;<span class="op" id="3071054">:=</span>&nbsp;<span class="ident" id="3071057">p</span><span class="op" id="3071058">.</span><span class="ident" id="3071059">Inst</span><span class="op" id="3071063">[</span><span class="op" id="3071064">*</span><span class="ident" id="3071065">p_A_Other</span><span class="op" id="3071074">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3071079">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071141">if</span>&nbsp;<span class="ident" id="3071144">instOther</span><span class="op" id="3071153">.</span><span class="ident" id="3071154">Op</span>&nbsp;<span class="op" id="3071157">==</span>&nbsp;<span class="ident" id="3071160">syntax</span><span class="op" id="3071166">.</span><span class="ident" id="3071167">InstAlt</span>&nbsp;<span class="op" id="3071175">||</span>&nbsp;<span class="ident" id="3071178">instOther</span><span class="op" id="3071187">.</span><span class="ident" id="3071188">Op</span>&nbsp;<span class="op" id="3071191">==</span>&nbsp;<span class="ident" id="3071194">syntax</span><span class="op" id="3071200">.</span><span class="ident" id="3071201">InstAltMatch</span>&nbsp;<span class="op" id="3071214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3071220">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071243">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3071260">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3071295">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071328">p_B_Alt</span>&nbsp;<span class="op" id="3071336">:=</span>&nbsp;<span class="op" id="3071339">&amp;</span><span class="ident" id="3071340">p</span><span class="op" id="3071341">.</span><span class="ident" id="3071342">Inst</span><span class="op" id="3071346">[</span><span class="op" id="3071347">*</span><span class="ident" id="3071348">p_A_Alt</span><span class="op" id="3071355">]</span><span class="op" id="3071356">.</span><span class="ident" id="3071357">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071364">p_B_Other</span>&nbsp;<span class="op" id="3071374">:=</span>&nbsp;<span class="op" id="3071377">&amp;</span><span class="ident" id="3071378">p</span><span class="op" id="3071379">.</span><span class="ident" id="3071380">Inst</span><span class="op" id="3071384">[</span><span class="op" id="3071385">*</span><span class="ident" id="3071386">p_A_Alt</span><span class="op" id="3071393">]</span><span class="op" id="3071394">.</span><span class="ident" id="3071395">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071402">patch</span>&nbsp;<span class="op" id="3071408">:=</span>&nbsp;<span class="builtintype" id="3071411">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071420">if</span>&nbsp;<span class="ident" id="3071423">instAlt</span><span class="op" id="3071430">.</span><span class="ident" id="3071431">Out</span>&nbsp;<span class="op" id="3071435">==</span>&nbsp;<span class="builtintype" id="3071438">uint32</span><span class="op" id="3071444">(</span><span class="ident" id="3071445">pc</span><span class="op" id="3071447">)</span>&nbsp;<span class="op" id="3071449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071455">patch</span>&nbsp;<span class="op" id="3071461">=</span>&nbsp;<span class="builtintype" id="3071463">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071471">}</span>&nbsp;<span class="keyword" id="3071473">else</span>&nbsp;<span class="keyword" id="3071478">if</span>&nbsp;<span class="ident" id="3071481">instAlt</span><span class="op" id="3071488">.</span><span class="ident" id="3071489">Arg</span>&nbsp;<span class="op" id="3071493">==</span>&nbsp;<span class="builtintype" id="3071496">uint32</span><span class="op" id="3071502">(</span><span class="ident" id="3071503">pc</span><span class="op" id="3071505">)</span>&nbsp;<span class="op" id="3071507">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071513">patch</span>&nbsp;<span class="op" id="3071519">=</span>&nbsp;<span class="builtintype" id="3071521">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3071530">p_B_Alt</span><span class="op" id="3071537">,</span>&nbsp;<span class="ident" id="3071539">p_B_Other</span>&nbsp;<span class="op" id="3071549">=</span>&nbsp;<span class="ident" id="3071551">p_B_Other</span><span class="op" id="3071560">,</span>&nbsp;<span class="ident" id="3071562">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071578">if</span>&nbsp;<span class="ident" id="3071581">patch</span>&nbsp;<span class="op" id="3071587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071593">*</span><span class="ident" id="3071594">p_B_Alt</span>&nbsp;<span class="op" id="3071602">=</span>&nbsp;<span class="op" id="3071604">*</span><span class="ident" id="3071605">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3071624">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3071664">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071697">if</span>&nbsp;<span class="op" id="3071700">*</span><span class="ident" id="3071701">p_A_Other</span>&nbsp;<span class="op" id="3071711">==</span>&nbsp;<span class="op" id="3071714">*</span><span class="ident" id="3071715">p_B_Alt</span>&nbsp;<span class="op" id="3071723">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071729">*</span><span class="ident" id="3071730">p_A_Alt</span>&nbsp;<span class="op" id="3071738">=</span>&nbsp;<span class="op" id="3071740">*</span><span class="ident" id="3071741">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3071761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3071764">return</span>&nbsp;<span class="ident" id="3071771">p</span><br>
<span class="lineno">280</span><span class="op" id="3071773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3071776">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="3071841">type</span>&nbsp;<span class="ident" id="3071846">runeSlice</span>&nbsp;<span class="op" id="3071856">[</span><span class="op" id="3071857">]</span><span class="builtintype" id="3071858">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="3071864">func</span>&nbsp;<span class="op" id="3071869">(</span><span class="ident" id="3071870">p</span>&nbsp;<span class="ident" id="3071872">runeSlice</span><span class="op" id="3071881">)</span>&nbsp;<span class="ident" id="3071883">Len</span><span class="op" id="3071886">(</span><span class="op" id="3071887">)</span>&nbsp;<span class="builtintype" id="3071889">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071903">{</span>&nbsp;<span class="keyword" id="3071905">return</span>&nbsp;<span class="builtinfunc" id="3071912">len</span><span class="op" id="3071915">(</span><span class="ident" id="3071916">p</span><span class="op" id="3071917">)</span>&nbsp;<span class="op" id="3071919">}</span><br>
<span class="lineno"></span><span class="keyword" id="3071921">func</span>&nbsp;<span class="op" id="3071926">(</span><span class="ident" id="3071927">p</span>&nbsp;<span class="ident" id="3071929">runeSlice</span><span class="op" id="3071938">)</span>&nbsp;<span class="ident" id="3071940">Less</span><span class="op" id="3071944">(</span><span class="ident" id="3071945">i</span><span class="op" id="3071946">,</span>&nbsp;<span class="ident" id="3071948">j</span>&nbsp;<span class="builtintype" id="3071950">int</span><span class="op" id="3071953">)</span>&nbsp;<span class="builtintype" id="3071955">bool</span>&nbsp;<span class="op" id="3071960">{</span>&nbsp;<span class="keyword" id="3071962">return</span>&nbsp;<span class="ident" id="3071969">p</span><span class="op" id="3071970">[</span><span class="ident" id="3071971">i</span><span class="op" id="3071972">]</span>&nbsp;<span class="op" id="3071974">&lt;</span>&nbsp;<span class="ident" id="3071976">p</span><span class="op" id="3071977">[</span><span class="ident" id="3071978">j</span><span class="op" id="3071979">]</span>&nbsp;<span class="op" id="3071981">}</span><br>
<span class="lineno"></span><span class="keyword" id="3071983">func</span>&nbsp;<span class="op" id="3071988">(</span><span class="ident" id="3071989">p</span>&nbsp;<span class="ident" id="3071991">runeSlice</span><span class="op" id="3072000">)</span>&nbsp;<span class="ident" id="3072002">Swap</span><span class="op" id="3072006">(</span><span class="ident" id="3072007">i</span><span class="op" id="3072008">,</span>&nbsp;<span class="ident" id="3072010">j</span>&nbsp;<span class="builtintype" id="3072012">int</span><span class="op" id="3072015">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072022">{</span>&nbsp;<span class="ident" id="3072024">p</span><span class="op" id="3072025">[</span><span class="ident" id="3072026">i</span><span class="op" id="3072027">]</span><span class="op" id="3072028">,</span>&nbsp;<span class="ident" id="3072030">p</span><span class="op" id="3072031">[</span><span class="ident" id="3072032">j</span><span class="op" id="3072033">]</span>&nbsp;<span class="op" id="3072035">=</span>&nbsp;<span class="ident" id="3072037">p</span><span class="op" id="3072038">[</span><span class="ident" id="3072039">j</span><span class="op" id="3072040">]</span><span class="op" id="3072041">,</span>&nbsp;<span class="ident" id="3072043">p</span><span class="op" id="3072044">[</span><span class="ident" id="3072045">i</span><span class="op" id="3072046">]</span>&nbsp;<span class="op" id="3072048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3072051">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="3072084">func</span>&nbsp;<span class="op" id="3072089">(</span><span class="ident" id="3072090">p</span>&nbsp;<span class="ident" id="3072092">runeSlice</span><span class="op" id="3072101">)</span>&nbsp;<span class="ident" id="3072103">Sort</span><span class="op" id="3072107">(</span><span class="op" id="3072108">)</span>&nbsp;<span class="op" id="3072110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072113">sort</span><span class="op" id="3072117">.</span><span class="ident" id="3072118">Sort</span><span class="op" id="3072122">(</span><span class="ident" id="3072123">p</span><span class="op" id="3072124">)</span><br>
<span class="lineno"></span><span class="op" id="3072126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3072129">var</span>&nbsp;<span class="ident" id="3072133">anyRuneNotNL</span>&nbsp;<span class="op" id="3072146">=</span>&nbsp;<span class="op" id="3072148">[</span><span class="op" id="3072149">]</span><span class="builtintype" id="3072150">rune</span><span class="op" id="3072154">{</span><span class="num" id="3072155">0</span><span class="op" id="3072156">,</span>&nbsp;<span class="string" id="3072158">&#39;\n&#39;</span>&nbsp;<span class="op" id="3072163">-</span>&nbsp;<span class="num" id="3072165">1</span><span class="op" id="3072166">,</span>&nbsp;<span class="string" id="3072168">&#39;\n&#39;</span>&nbsp;<span class="op" id="3072173">+</span>&nbsp;<span class="num" id="3072175">1</span><span class="op" id="3072176">,</span>&nbsp;<span class="ident" id="3072178">unicode</span><span class="op" id="3072185">.</span><span class="ident" id="3072186">MaxRune</span><span class="op" id="3072193">}</span><br>
<span class="lineno">295</span><span class="keyword" id="3072195">var</span>&nbsp;<span class="ident" id="3072199">anyRune</span>&nbsp;<span class="op" id="3072207">=</span>&nbsp;<span class="op" id="3072209">[</span><span class="op" id="3072210">]</span><span class="builtintype" id="3072211">rune</span><span class="op" id="3072215">{</span><span class="num" id="3072216">0</span><span class="op" id="3072217">,</span>&nbsp;<span class="ident" id="3072219">unicode</span><span class="op" id="3072226">.</span><span class="ident" id="3072227">MaxRune</span><span class="op" id="3072234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3072237">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="3072319">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="3072400">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="3072480">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="3072555">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="3072583">func</span>&nbsp;<span class="ident" id="3072588">makeOnePass</span><span class="op" id="3072599">(</span><span class="ident" id="3072600">p</span>&nbsp;<span class="op" id="3072602">*</span><span class="ident" id="3072603">onePassProg</span><span class="op" id="3072614">)</span>&nbsp;<span class="op" id="3072616">*</span><span class="ident" id="3072617">onePassProg</span>&nbsp;<span class="op" id="3072629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3072632">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3072722">if</span>&nbsp;<span class="builtinfunc" id="3072725">len</span><span class="op" id="3072728">(</span><span class="ident" id="3072729">p</span><span class="op" id="3072730">.</span><span class="ident" id="3072731">Inst</span><span class="op" id="3072735">)</span>&nbsp;<span class="op" id="3072737">&gt;=</span>&nbsp;<span class="num" id="3072740">1000</span>&nbsp;<span class="op" id="3072745">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3072749">return</span>&nbsp;<span class="ident" id="3072756">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3072768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3072772">var</span>&nbsp;<span class="op" id="3072776">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072780">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072793">=</span>&nbsp;<span class="ident" id="3072795">newQueue</span><span class="op" id="3072803">(</span><span class="builtinfunc" id="3072804">len</span><span class="op" id="3072807">(</span><span class="ident" id="3072808">p</span><span class="op" id="3072809">.</span><span class="ident" id="3072810">Inst</span><span class="op" id="3072814">)</span><span class="op" id="3072815">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072819">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3072832">=</span>&nbsp;<span class="ident" id="3072834">newQueue</span><span class="op" id="3072842">(</span><span class="builtinfunc" id="3072843">len</span><span class="op" id="3072846">(</span><span class="ident" id="3072847">p</span><span class="op" id="3072848">.</span><span class="ident" id="3072849">Inst</span><span class="op" id="3072853">)</span><span class="op" id="3072854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072858">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072871">func</span><span class="op" id="3072875">(</span><span class="builtintype" id="3072876">uint32</span><span class="op" id="3072882">,</span>&nbsp;<span class="op" id="3072884">*</span><span class="ident" id="3072885">queueOnePass</span><span class="op" id="3072897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072901">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072914">func</span><span class="op" id="3072918">(</span><span class="builtintype" id="3072919">uint32</span><span class="op" id="3072925">,</span>&nbsp;<span class="keyword" id="3072927">map</span><span class="op" id="3072930">[</span><span class="builtintype" id="3072931">uint32</span><span class="op" id="3072937">]</span><span class="builtintype" id="3072938">bool</span><span class="op" id="3072942">)</span>&nbsp;<span class="builtintype" id="3072944">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072951">onePassRunes</span>&nbsp;<span class="op" id="3072964">=</span>&nbsp;<span class="builtinfunc" id="3072966">make</span><span class="op" id="3072970">(</span><span class="op" id="3072971">[</span><span class="op" id="3072972">]</span><span class="op" id="3072973">[</span><span class="op" id="3072974">]</span><span class="builtintype" id="3072975">rune</span><span class="op" id="3072979">,</span>&nbsp;<span class="builtinfunc" id="3072981">len</span><span class="op" id="3072984">(</span><span class="ident" id="3072985">p</span><span class="op" id="3072986">.</span><span class="ident" id="3072987">Inst</span><span class="op" id="3072991">)</span><span class="op" id="3072992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3072995">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3072998">build</span>&nbsp;<span class="op" id="3073004">=</span>&nbsp;<span class="keyword" id="3073006">func</span><span class="op" id="3073010">(</span><span class="ident" id="3073011">pc</span>&nbsp;<span class="builtintype" id="3073014">uint32</span><span class="op" id="3073020">,</span>&nbsp;<span class="ident" id="3073022">q</span>&nbsp;<span class="op" id="3073024">*</span><span class="ident" id="3073025">queueOnePass</span><span class="op" id="3073037">)</span>&nbsp;<span class="op" id="3073039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073043">if</span>&nbsp;<span class="ident" id="3073046">q</span><span class="op" id="3073047">.</span><span class="ident" id="3073048">contains</span><span class="op" id="3073056">(</span><span class="ident" id="3073057">pc</span><span class="op" id="3073059">)</span>&nbsp;<span class="op" id="3073061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073066">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3073075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073079">inst</span>&nbsp;<span class="op" id="3073084">:=</span>&nbsp;<span class="ident" id="3073087">p</span><span class="op" id="3073088">.</span><span class="ident" id="3073089">Inst</span><span class="op" id="3073093">[</span><span class="ident" id="3073094">pc</span><span class="op" id="3073096">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073100">switch</span>&nbsp;<span class="ident" id="3073107">inst</span><span class="op" id="3073111">.</span><span class="ident" id="3073112">Op</span>&nbsp;<span class="op" id="3073115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073119">case</span>&nbsp;<span class="ident" id="3073124">syntax</span><span class="op" id="3073130">.</span><span class="ident" id="3073131">InstAlt</span><span class="op" id="3073138">,</span>&nbsp;<span class="ident" id="3073140">syntax</span><span class="op" id="3073146">.</span><span class="ident" id="3073147">InstAltMatch</span><span class="op" id="3073159">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073164">q</span><span class="op" id="3073165">.</span><span class="ident" id="3073166">insert</span><span class="op" id="3073172">(</span><span class="ident" id="3073173">inst</span><span class="op" id="3073177">.</span><span class="ident" id="3073178">Out</span><span class="op" id="3073181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073186">build</span><span class="op" id="3073191">(</span><span class="ident" id="3073192">inst</span><span class="op" id="3073196">.</span><span class="ident" id="3073197">Out</span><span class="op" id="3073200">,</span>&nbsp;<span class="ident" id="3073202">q</span><span class="op" id="3073203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073208">q</span><span class="op" id="3073209">.</span><span class="ident" id="3073210">insert</span><span class="op" id="3073216">(</span><span class="ident" id="3073217">inst</span><span class="op" id="3073221">.</span><span class="ident" id="3073222">Arg</span><span class="op" id="3073225">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073229">case</span>&nbsp;<span class="ident" id="3073234">syntax</span><span class="op" id="3073240">.</span><span class="ident" id="3073241">InstMatch</span><span class="op" id="3073250">,</span>&nbsp;<span class="ident" id="3073252">syntax</span><span class="op" id="3073258">.</span><span class="ident" id="3073259">InstFail</span><span class="op" id="3073267">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073271">default</span><span class="op" id="3073278">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073283">q</span><span class="op" id="3073284">.</span><span class="ident" id="3073285">insert</span><span class="op" id="3073291">(</span><span class="ident" id="3073292">inst</span><span class="op" id="3073296">.</span><span class="ident" id="3073297">Out</span><span class="op" id="3073300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3073304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3073307">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3073311">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3073391">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073424">check</span>&nbsp;<span class="op" id="3073430">=</span>&nbsp;<span class="keyword" id="3073432">func</span><span class="op" id="3073436">(</span><span class="ident" id="3073437">pc</span>&nbsp;<span class="builtintype" id="3073440">uint32</span><span class="op" id="3073446">,</span>&nbsp;<span class="ident" id="3073448">m</span>&nbsp;<span class="keyword" id="3073450">map</span><span class="op" id="3073453">[</span><span class="builtintype" id="3073454">uint32</span><span class="op" id="3073460">]</span><span class="builtintype" id="3073461">bool</span><span class="op" id="3073465">)</span>&nbsp;<span class="op" id="3073467">(</span><span class="ident" id="3073468">ok</span>&nbsp;<span class="builtintype" id="3073471">bool</span><span class="op" id="3073475">)</span>&nbsp;<span class="op" id="3073477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073481">ok</span>&nbsp;<span class="op" id="3073484">=</span>&nbsp;<span class="builtintype" id="3073486">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073493">inst</span>&nbsp;<span class="op" id="3073498">:=</span>&nbsp;<span class="op" id="3073501">&amp;</span><span class="ident" id="3073502">p</span><span class="op" id="3073503">.</span><span class="ident" id="3073504">Inst</span><span class="op" id="3073508">[</span><span class="ident" id="3073509">pc</span><span class="op" id="3073511">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073515">if</span>&nbsp;<span class="ident" id="3073518">visitQueue</span><span class="op" id="3073528">.</span><span class="ident" id="3073529">contains</span><span class="op" id="3073537">(</span><span class="ident" id="3073538">pc</span><span class="op" id="3073540">)</span>&nbsp;<span class="op" id="3073542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073547">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3073556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073560">visitQueue</span><span class="op" id="3073570">.</span><span class="ident" id="3073571">insert</span><span class="op" id="3073577">(</span><span class="ident" id="3073578">pc</span><span class="op" id="3073580">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073584">switch</span>&nbsp;<span class="ident" id="3073591">inst</span><span class="op" id="3073595">.</span><span class="ident" id="3073596">Op</span>&nbsp;<span class="op" id="3073599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073603">case</span>&nbsp;<span class="ident" id="3073608">syntax</span><span class="op" id="3073614">.</span><span class="ident" id="3073615">InstAlt</span><span class="op" id="3073622">,</span>&nbsp;<span class="ident" id="3073624">syntax</span><span class="op" id="3073630">.</span><span class="ident" id="3073631">InstAltMatch</span><span class="op" id="3073643">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073648">ok</span>&nbsp;<span class="op" id="3073651">=</span>&nbsp;<span class="ident" id="3073653">check</span><span class="op" id="3073658">(</span><span class="ident" id="3073659">inst</span><span class="op" id="3073663">.</span><span class="ident" id="3073664">Out</span><span class="op" id="3073667">,</span>&nbsp;<span class="ident" id="3073669">m</span><span class="op" id="3073670">)</span>&nbsp;<span class="op" id="3073672">&amp;&amp;</span>&nbsp;<span class="ident" id="3073675">check</span><span class="op" id="3073680">(</span><span class="ident" id="3073681">inst</span><span class="op" id="3073685">.</span><span class="ident" id="3073686">Arg</span><span class="op" id="3073689">,</span>&nbsp;<span class="ident" id="3073691">m</span><span class="op" id="3073692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3073697">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073737">matchOut</span>&nbsp;<span class="op" id="3073746">:=</span>&nbsp;<span class="ident" id="3073749">m</span><span class="op" id="3073750">[</span><span class="ident" id="3073751">inst</span><span class="op" id="3073755">.</span><span class="ident" id="3073756">Out</span><span class="op" id="3073759">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073764">matchArg</span>&nbsp;<span class="op" id="3073773">:=</span>&nbsp;<span class="ident" id="3073776">m</span><span class="op" id="3073777">[</span><span class="ident" id="3073778">inst</span><span class="op" id="3073782">.</span><span class="ident" id="3073783">Arg</span><span class="op" id="3073786">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073791">if</span>&nbsp;<span class="ident" id="3073794">matchOut</span>&nbsp;<span class="op" id="3073803">&amp;&amp;</span>&nbsp;<span class="ident" id="3073806">matchArg</span>&nbsp;<span class="op" id="3073815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073821">ok</span>&nbsp;<span class="op" id="3073824">=</span>&nbsp;<span class="builtintype" id="3073826">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073836">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3073845">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3073850">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073888">if</span>&nbsp;<span class="ident" id="3073891">matchArg</span>&nbsp;<span class="op" id="3073900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073906">inst</span><span class="op" id="3073910">.</span><span class="ident" id="3073911">Out</span><span class="op" id="3073914">,</span>&nbsp;<span class="ident" id="3073916">inst</span><span class="op" id="3073920">.</span><span class="ident" id="3073921">Arg</span>&nbsp;<span class="op" id="3073925">=</span>&nbsp;<span class="ident" id="3073927">inst</span><span class="op" id="3073931">.</span><span class="ident" id="3073932">Arg</span><span class="op" id="3073935">,</span>&nbsp;<span class="ident" id="3073937">inst</span><span class="op" id="3073941">.</span><span class="ident" id="3073942">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3073950">matchOut</span><span class="op" id="3073958">,</span>&nbsp;<span class="ident" id="3073960">matchArg</span>&nbsp;<span class="op" id="3073969">=</span>&nbsp;<span class="ident" id="3073971">matchArg</span><span class="op" id="3073979">,</span>&nbsp;<span class="ident" id="3073981">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3073993">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3073998">if</span>&nbsp;<span class="ident" id="3074001">matchOut</span>&nbsp;<span class="op" id="3074010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074016">m</span><span class="op" id="3074017">[</span><span class="ident" id="3074018">pc</span><span class="op" id="3074020">]</span>&nbsp;<span class="op" id="3074022">=</span>&nbsp;<span class="builtintype" id="3074024">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074033">inst</span><span class="op" id="3074037">.</span><span class="ident" id="3074038">Op</span>&nbsp;<span class="op" id="3074041">=</span>&nbsp;<span class="ident" id="3074043">syntax</span><span class="op" id="3074049">.</span><span class="ident" id="3074050">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3074066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3074072">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074134">onePassRunes</span><span class="op" id="3074146">[</span><span class="ident" id="3074147">pc</span><span class="op" id="3074149">]</span><span class="op" id="3074150">,</span>&nbsp;<span class="ident" id="3074152">inst</span><span class="op" id="3074156">.</span><span class="ident" id="3074157">Next</span>&nbsp;<span class="op" id="3074162">=</span>&nbsp;<span class="ident" id="3074164">mergeRuneSets</span><span class="op" id="3074177">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3074183">&amp;</span><span class="ident" id="3074184">onePassRunes</span><span class="op" id="3074196">[</span><span class="ident" id="3074197">inst</span><span class="op" id="3074201">.</span><span class="ident" id="3074202">Out</span><span class="op" id="3074205">]</span><span class="op" id="3074206">,</span>&nbsp;<span class="op" id="3074208">&amp;</span><span class="ident" id="3074209">onePassRunes</span><span class="op" id="3074221">[</span><span class="ident" id="3074222">inst</span><span class="op" id="3074226">.</span><span class="ident" id="3074227">Arg</span><span class="op" id="3074230">]</span><span class="op" id="3074231">,</span>&nbsp;<span class="ident" id="3074233">inst</span><span class="op" id="3074237">.</span><span class="ident" id="3074238">Out</span><span class="op" id="3074241">,</span>&nbsp;<span class="ident" id="3074243">inst</span><span class="op" id="3074247">.</span><span class="ident" id="3074248">Arg</span><span class="op" id="3074251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3074256">if</span>&nbsp;<span class="builtinfunc" id="3074259">len</span><span class="op" id="3074262">(</span><span class="ident" id="3074263">inst</span><span class="op" id="3074267">.</span><span class="ident" id="3074268">Next</span><span class="op" id="3074272">)</span>&nbsp;<span class="op" id="3074274">&gt;</span>&nbsp;<span class="num" id="3074276">0</span>&nbsp;<span class="op" id="3074278">&amp;&amp;</span>&nbsp;<span class="ident" id="3074281">inst</span><span class="op" id="3074285">.</span><span class="ident" id="3074286">Next</span><span class="op" id="3074290">[</span><span class="num" id="3074291">0</span><span class="op" id="3074292">]</span>&nbsp;<span class="op" id="3074294">==</span>&nbsp;<span class="ident" id="3074297">mergeFailed</span>&nbsp;<span class="op" id="3074309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074315">ok</span>&nbsp;<span class="op" id="3074318">=</span>&nbsp;<span class="builtintype" id="3074320">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3074330">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3074339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3074343">case</span>&nbsp;<span class="ident" id="3074348">syntax</span><span class="op" id="3074354">.</span><span class="ident" id="3074355">InstCapture</span><span class="op" id="3074366">,</span>&nbsp;<span class="ident" id="3074368">syntax</span><span class="op" id="3074374">.</span><span class="ident" id="3074375">InstNop</span><span class="op" id="3074382">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074387">ok</span>&nbsp;<span class="op" id="3074390">=</span>&nbsp;<span class="ident" id="3074392">check</span><span class="op" id="3074397">(</span><span class="ident" id="3074398">inst</span><span class="op" id="3074402">.</span><span class="ident" id="3074403">Out</span><span class="op" id="3074406">,</span>&nbsp;<span class="ident" id="3074408">m</span><span class="op" id="3074409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074414">m</span><span class="op" id="3074415">[</span><span class="ident" id="3074416">pc</span><span class="op" id="3074418">]</span>&nbsp;<span class="op" id="3074420">=</span>&nbsp;<span class="ident" id="3074422">m</span><span class="op" id="3074423">[</span><span class="ident" id="3074424">inst</span><span class="op" id="3074428">.</span><span class="ident" id="3074429">Out</span><span class="op" id="3074432">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3074437">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074490">onePassRunes</span><span class="op" id="3074502">[</span><span class="ident" id="3074503">pc</span><span class="op" id="3074505">]</span>&nbsp;<span class="op" id="3074507">=</span>&nbsp;<span class="builtinfunc" id="3074509">append</span><span class="op" id="3074515">(</span><span class="op" id="3074516">[</span><span class="op" id="3074517">]</span><span class="builtintype" id="3074518">rune</span><span class="op" id="3074522">{</span><span class="op" id="3074523">}</span><span class="op" id="3074524">,</span>&nbsp;<span class="ident" id="3074526">onePassRunes</span><span class="op" id="3074538">[</span><span class="ident" id="3074539">inst</span><span class="op" id="3074543">.</span><span class="ident" id="3074544">Out</span><span class="op" id="3074547">]</span><span class="op" id="3074548">...</span><span class="op" id="3074551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074556">inst</span><span class="op" id="3074560">.</span><span class="ident" id="3074561">Next</span>&nbsp;<span class="op" id="3074566">=</span>&nbsp;<span class="op" id="3074568">[</span><span class="op" id="3074569">]</span><span class="builtintype" id="3074570">uint32</span><span class="op" id="3074576">{</span><span class="op" id="3074577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3074582">for</span>&nbsp;<span class="ident" id="3074586">i</span>&nbsp;<span class="op" id="3074588">:=</span>&nbsp;<span class="builtinfunc" id="3074591">len</span><span class="op" id="3074594">(</span><span class="ident" id="3074595">onePassRunes</span><span class="op" id="3074607">[</span><span class="ident" id="3074608">pc</span><span class="op" id="3074610">]</span><span class="op" id="3074611">)</span>&nbsp;<span class="op" id="3074613">/</span>&nbsp;<span class="num" id="3074615">2</span><span class="op" id="3074616">;</span>&nbsp;<span class="ident" id="3074618">i</span>&nbsp;<span class="op" id="3074620">&gt;=</span>&nbsp;<span class="num" id="3074623">0</span><span class="op" id="3074624">;</span>&nbsp;<span class="ident" id="3074626">i</span><span class="op" id="3074627">--</span>&nbsp;<span class="op" id="3074630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074636">inst</span><span class="op" id="3074640">.</span><span class="ident" id="3074641">Next</span>&nbsp;<span class="op" id="3074646">=</span>&nbsp;<span class="builtinfunc" id="3074648">append</span><span class="op" id="3074654">(</span><span class="ident" id="3074655">inst</span><span class="op" id="3074659">.</span><span class="ident" id="3074660">Next</span><span class="op" id="3074664">,</span>&nbsp;<span class="ident" id="3074666">inst</span><span class="op" id="3074670">.</span><span class="ident" id="3074671">Out</span><span class="op" id="3074674">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3074679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3074683">case</span>&nbsp;<span class="ident" id="3074688">syntax</span><span class="op" id="3074694">.</span><span class="ident" id="3074695">InstEmptyWidth</span><span class="op" id="3074709">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074714">ok</span>&nbsp;<span class="op" id="3074717">=</span>&nbsp;<span class="ident" id="3074719">check</span><span class="op" id="3074724">(</span><span class="ident" id="3074725">inst</span><span class="op" id="3074729">.</span><span class="ident" id="3074730">Out</span><span class="op" id="3074733">,</span>&nbsp;<span class="ident" id="3074735">m</span><span class="op" id="3074736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074741">m</span><span class="op" id="3074742">[</span><span class="ident" id="3074743">pc</span><span class="op" id="3074745">]</span>&nbsp;<span class="op" id="3074747">=</span>&nbsp;<span class="ident" id="3074749">m</span><span class="op" id="3074750">[</span><span class="ident" id="3074751">inst</span><span class="op" id="3074755">.</span><span class="ident" id="3074756">Out</span><span class="op" id="3074759">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074764">onePassRunes</span><span class="op" id="3074776">[</span><span class="ident" id="3074777">pc</span><span class="op" id="3074779">]</span>&nbsp;<span class="op" id="3074781">=</span>&nbsp;<span class="builtinfunc" id="3074783">append</span><span class="op" id="3074789">(</span><span class="op" id="3074790">[</span><span class="op" id="3074791">]</span><span class="builtintype" id="3074792">rune</span><span class="op" id="3074796">{</span><span class="op" id="3074797">}</span><span class="op" id="3074798">,</span>&nbsp;<span class="ident" id="3074800">onePassRunes</span><span class="op" id="3074812">[</span><span class="ident" id="3074813">inst</span><span class="op" id="3074817">.</span><span class="ident" id="3074818">Out</span><span class="op" id="3074821">]</span><span class="op" id="3074822">...</span><span class="op" id="3074825">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074830">inst</span><span class="op" id="3074834">.</span><span class="ident" id="3074835">Next</span>&nbsp;<span class="op" id="3074840">=</span>&nbsp;<span class="op" id="3074842">[</span><span class="op" id="3074843">]</span><span class="builtintype" id="3074844">uint32</span><span class="op" id="3074850">{</span><span class="op" id="3074851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3074856">for</span>&nbsp;<span class="ident" id="3074860">i</span>&nbsp;<span class="op" id="3074862">:=</span>&nbsp;<span class="builtinfunc" id="3074865">len</span><span class="op" id="3074868">(</span><span class="ident" id="3074869">onePassRunes</span><span class="op" id="3074881">[</span><span class="ident" id="3074882">pc</span><span class="op" id="3074884">]</span><span class="op" id="3074885">)</span>&nbsp;<span class="op" id="3074887">/</span>&nbsp;<span class="num" id="3074889">2</span><span class="op" id="3074890">;</span>&nbsp;<span class="ident" id="3074892">i</span>&nbsp;<span class="op" id="3074894">&gt;=</span>&nbsp;<span class="num" id="3074897">0</span><span class="op" id="3074898">;</span>&nbsp;<span class="ident" id="3074900">i</span><span class="op" id="3074901">--</span>&nbsp;<span class="op" id="3074904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3074910">inst</span><span class="op" id="3074914">.</span><span class="ident" id="3074915">Next</span>&nbsp;<span class="op" id="3074920">=</span>&nbsp;<span class="builtinfunc" id="3074922">append</span><span class="op" id="3074928">(</span><span class="ident" id="3074929">inst</span><span class="op" id="3074933">.</span><span class="ident" id="3074934">Next</span><span class="op" id="3074938">,</span>&nbsp;<span class="ident" id="3074940">inst</span><span class="op" id="3074944">.</span><span class="ident" id="3074945">Out</span><span class="op" id="3074948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3074953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3074957">case</span>&nbsp;<span class="ident" id="3074962">syntax</span><span class="op" id="3074968">.</span><span class="ident" id="3074969">InstMatch</span><span class="op" id="3074978">,</span>&nbsp;<span class="ident" id="3074980">syntax</span><span class="op" id="3074986">.</span><span class="ident" id="3074987">InstFail</span><span class="op" id="3074995">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075000">m</span><span class="op" id="3075001">[</span><span class="ident" id="3075002">pc</span><span class="op" id="3075004">]</span>&nbsp;<span class="op" id="3075006">=</span>&nbsp;<span class="ident" id="3075008">inst</span><span class="op" id="3075012">.</span><span class="ident" id="3075013">Op</span>&nbsp;<span class="op" id="3075016">==</span>&nbsp;<span class="ident" id="3075019">syntax</span><span class="op" id="3075025">.</span><span class="ident" id="3075026">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075039">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075047">case</span>&nbsp;<span class="ident" id="3075052">syntax</span><span class="op" id="3075058">.</span><span class="ident" id="3075059">InstRune</span><span class="op" id="3075067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075072">ok</span>&nbsp;<span class="op" id="3075075">=</span>&nbsp;<span class="ident" id="3075077">check</span><span class="op" id="3075082">(</span><span class="ident" id="3075083">inst</span><span class="op" id="3075087">.</span><span class="ident" id="3075088">Out</span><span class="op" id="3075091">,</span>&nbsp;<span class="ident" id="3075093">m</span><span class="op" id="3075094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075099">m</span><span class="op" id="3075100">[</span><span class="ident" id="3075101">pc</span><span class="op" id="3075103">]</span>&nbsp;<span class="op" id="3075105">=</span>&nbsp;<span class="builtintype" id="3075107">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075116">if</span>&nbsp;<span class="builtinfunc" id="3075119">len</span><span class="op" id="3075122">(</span><span class="ident" id="3075123">inst</span><span class="op" id="3075127">.</span><span class="ident" id="3075128">Next</span><span class="op" id="3075132">)</span>&nbsp;<span class="op" id="3075134">&gt;</span>&nbsp;<span class="num" id="3075136">0</span>&nbsp;<span class="op" id="3075138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075144">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075158">if</span>&nbsp;<span class="builtinfunc" id="3075161">len</span><span class="op" id="3075164">(</span><span class="ident" id="3075165">inst</span><span class="op" id="3075169">.</span><span class="ident" id="3075170">Rune</span><span class="op" id="3075174">)</span>&nbsp;<span class="op" id="3075176">==</span>&nbsp;<span class="num" id="3075179">0</span>&nbsp;<span class="op" id="3075181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075187">onePassRunes</span><span class="op" id="3075199">[</span><span class="ident" id="3075200">pc</span><span class="op" id="3075202">]</span>&nbsp;<span class="op" id="3075204">=</span>&nbsp;<span class="op" id="3075206">[</span><span class="op" id="3075207">]</span><span class="builtintype" id="3075208">rune</span><span class="op" id="3075212">{</span><span class="op" id="3075213">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075219">inst</span><span class="op" id="3075223">.</span><span class="ident" id="3075224">Next</span>&nbsp;<span class="op" id="3075229">=</span>&nbsp;<span class="op" id="3075231">[</span><span class="op" id="3075232">]</span><span class="builtintype" id="3075233">uint32</span><span class="op" id="3075239">{</span><span class="ident" id="3075240">inst</span><span class="op" id="3075244">.</span><span class="ident" id="3075245">Out</span><span class="op" id="3075248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075254">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075268">runes</span>&nbsp;<span class="op" id="3075274">:=</span>&nbsp;<span class="builtinfunc" id="3075277">make</span><span class="op" id="3075281">(</span><span class="op" id="3075282">[</span><span class="op" id="3075283">]</span><span class="builtintype" id="3075284">rune</span><span class="op" id="3075288">,</span>&nbsp;<span class="num" id="3075290">0</span><span class="op" id="3075291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075296">if</span>&nbsp;<span class="builtinfunc" id="3075299">len</span><span class="op" id="3075302">(</span><span class="ident" id="3075303">inst</span><span class="op" id="3075307">.</span><span class="ident" id="3075308">Rune</span><span class="op" id="3075312">)</span>&nbsp;<span class="op" id="3075314">==</span>&nbsp;<span class="num" id="3075317">1</span>&nbsp;<span class="op" id="3075319">&amp;&amp;</span>&nbsp;<span class="ident" id="3075322">syntax</span><span class="op" id="3075328">.</span><span class="ident" id="3075329">Flags</span><span class="op" id="3075334">(</span><span class="ident" id="3075335">inst</span><span class="op" id="3075339">.</span><span class="ident" id="3075340">Arg</span><span class="op" id="3075343">)</span><span class="op" id="3075344">&amp;</span><span class="ident" id="3075345">syntax</span><span class="op" id="3075351">.</span><span class="ident" id="3075352">FoldCase</span>&nbsp;<span class="op" id="3075361">!=</span>&nbsp;<span class="num" id="3075364">0</span>&nbsp;<span class="op" id="3075366">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075372">r0</span>&nbsp;<span class="op" id="3075375">:=</span>&nbsp;<span class="ident" id="3075378">inst</span><span class="op" id="3075382">.</span><span class="ident" id="3075383">Rune</span><span class="op" id="3075387">[</span><span class="num" id="3075388">0</span><span class="op" id="3075389">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075395">runes</span>&nbsp;<span class="op" id="3075401">=</span>&nbsp;<span class="builtinfunc" id="3075403">append</span><span class="op" id="3075409">(</span><span class="ident" id="3075410">runes</span><span class="op" id="3075415">,</span>&nbsp;<span class="ident" id="3075417">r0</span><span class="op" id="3075419">,</span>&nbsp;<span class="ident" id="3075421">r0</span><span class="op" id="3075423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075429">for</span>&nbsp;<span class="ident" id="3075433">r1</span>&nbsp;<span class="op" id="3075436">:=</span>&nbsp;<span class="ident" id="3075439">unicode</span><span class="op" id="3075446">.</span><span class="ident" id="3075447">SimpleFold</span><span class="op" id="3075457">(</span><span class="ident" id="3075458">r0</span><span class="op" id="3075460">)</span><span class="op" id="3075461">;</span>&nbsp;<span class="ident" id="3075463">r1</span>&nbsp;<span class="op" id="3075466">!=</span>&nbsp;<span class="ident" id="3075469">r0</span><span class="op" id="3075471">;</span>&nbsp;<span class="ident" id="3075473">r1</span>&nbsp;<span class="op" id="3075476">=</span>&nbsp;<span class="ident" id="3075478">unicode</span><span class="op" id="3075485">.</span><span class="ident" id="3075486">SimpleFold</span><span class="op" id="3075496">(</span><span class="ident" id="3075497">r1</span><span class="op" id="3075499">)</span>&nbsp;<span class="op" id="3075501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075508">runes</span>&nbsp;<span class="op" id="3075514">=</span>&nbsp;<span class="builtinfunc" id="3075516">append</span><span class="op" id="3075522">(</span><span class="ident" id="3075523">runes</span><span class="op" id="3075528">,</span>&nbsp;<span class="ident" id="3075530">r1</span><span class="op" id="3075532">,</span>&nbsp;<span class="ident" id="3075534">r1</span><span class="op" id="3075536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075542">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075548">sort</span><span class="op" id="3075552">.</span><span class="ident" id="3075553">Sort</span><span class="op" id="3075557">(</span><span class="ident" id="3075558">runeSlice</span><span class="op" id="3075567">(</span><span class="ident" id="3075568">runes</span><span class="op" id="3075573">)</span><span class="op" id="3075574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075579">}</span>&nbsp;<span class="keyword" id="3075581">else</span>&nbsp;<span class="op" id="3075586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075592">runes</span>&nbsp;<span class="op" id="3075598">=</span>&nbsp;<span class="builtinfunc" id="3075600">append</span><span class="op" id="3075606">(</span><span class="ident" id="3075607">runes</span><span class="op" id="3075612">,</span>&nbsp;<span class="ident" id="3075614">inst</span><span class="op" id="3075618">.</span><span class="ident" id="3075619">Rune</span><span class="op" id="3075623">...</span><span class="op" id="3075626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075636">onePassRunes</span><span class="op" id="3075648">[</span><span class="ident" id="3075649">pc</span><span class="op" id="3075651">]</span>&nbsp;<span class="op" id="3075653">=</span>&nbsp;<span class="ident" id="3075655">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075664">inst</span><span class="op" id="3075668">.</span><span class="ident" id="3075669">Next</span>&nbsp;<span class="op" id="3075674">=</span>&nbsp;<span class="op" id="3075676">[</span><span class="op" id="3075677">]</span><span class="builtintype" id="3075678">uint32</span><span class="op" id="3075684">{</span><span class="op" id="3075685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075690">for</span>&nbsp;<span class="ident" id="3075694">i</span>&nbsp;<span class="op" id="3075696">:=</span>&nbsp;<span class="builtinfunc" id="3075699">len</span><span class="op" id="3075702">(</span><span class="ident" id="3075703">onePassRunes</span><span class="op" id="3075715">[</span><span class="ident" id="3075716">pc</span><span class="op" id="3075718">]</span><span class="op" id="3075719">)</span>&nbsp;<span class="op" id="3075721">/</span>&nbsp;<span class="num" id="3075723">2</span><span class="op" id="3075724">;</span>&nbsp;<span class="ident" id="3075726">i</span>&nbsp;<span class="op" id="3075728">&gt;=</span>&nbsp;<span class="num" id="3075731">0</span><span class="op" id="3075732">;</span>&nbsp;<span class="ident" id="3075734">i</span><span class="op" id="3075735">--</span>&nbsp;<span class="op" id="3075738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075744">inst</span><span class="op" id="3075748">.</span><span class="ident" id="3075749">Next</span>&nbsp;<span class="op" id="3075754">=</span>&nbsp;<span class="builtinfunc" id="3075756">append</span><span class="op" id="3075762">(</span><span class="ident" id="3075763">inst</span><span class="op" id="3075767">.</span><span class="ident" id="3075768">Next</span><span class="op" id="3075772">,</span>&nbsp;<span class="ident" id="3075774">inst</span><span class="op" id="3075778">.</span><span class="ident" id="3075779">Out</span><span class="op" id="3075782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075792">inst</span><span class="op" id="3075796">.</span><span class="ident" id="3075797">Op</span>&nbsp;<span class="op" id="3075800">=</span>&nbsp;<span class="ident" id="3075802">syntax</span><span class="op" id="3075808">.</span><span class="ident" id="3075809">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075820">case</span>&nbsp;<span class="ident" id="3075825">syntax</span><span class="op" id="3075831">.</span><span class="ident" id="3075832">InstRune1</span><span class="op" id="3075841">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075846">ok</span>&nbsp;<span class="op" id="3075849">=</span>&nbsp;<span class="ident" id="3075851">check</span><span class="op" id="3075856">(</span><span class="ident" id="3075857">inst</span><span class="op" id="3075861">.</span><span class="ident" id="3075862">Out</span><span class="op" id="3075865">,</span>&nbsp;<span class="ident" id="3075867">m</span><span class="op" id="3075868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075873">m</span><span class="op" id="3075874">[</span><span class="ident" id="3075875">pc</span><span class="op" id="3075877">]</span>&nbsp;<span class="op" id="3075879">=</span>&nbsp;<span class="builtintype" id="3075881">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075890">if</span>&nbsp;<span class="builtinfunc" id="3075893">len</span><span class="op" id="3075896">(</span><span class="ident" id="3075897">inst</span><span class="op" id="3075901">.</span><span class="ident" id="3075902">Next</span><span class="op" id="3075906">)</span>&nbsp;<span class="op" id="3075908">&gt;</span>&nbsp;<span class="num" id="3075910">0</span>&nbsp;<span class="op" id="3075912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075918">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3075927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3075932">runes</span>&nbsp;<span class="op" id="3075938">:=</span>&nbsp;<span class="op" id="3075941">[</span><span class="op" id="3075942">]</span><span class="builtintype" id="3075943">rune</span><span class="op" id="3075947">{</span><span class="op" id="3075948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3075953">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3075984">if</span>&nbsp;<span class="ident" id="3075987">syntax</span><span class="op" id="3075993">.</span><span class="ident" id="3075994">Flags</span><span class="op" id="3075999">(</span><span class="ident" id="3076000">inst</span><span class="op" id="3076004">.</span><span class="ident" id="3076005">Arg</span><span class="op" id="3076008">)</span><span class="op" id="3076009">&amp;</span><span class="ident" id="3076010">syntax</span><span class="op" id="3076016">.</span><span class="ident" id="3076017">FoldCase</span>&nbsp;<span class="op" id="3076026">!=</span>&nbsp;<span class="num" id="3076029">0</span>&nbsp;<span class="op" id="3076031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076037">r0</span>&nbsp;<span class="op" id="3076040">:=</span>&nbsp;<span class="ident" id="3076043">inst</span><span class="op" id="3076047">.</span><span class="ident" id="3076048">Rune</span><span class="op" id="3076052">[</span><span class="num" id="3076053">0</span><span class="op" id="3076054">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076060">runes</span>&nbsp;<span class="op" id="3076066">=</span>&nbsp;<span class="builtinfunc" id="3076068">append</span><span class="op" id="3076074">(</span><span class="ident" id="3076075">runes</span><span class="op" id="3076080">,</span>&nbsp;<span class="ident" id="3076082">r0</span><span class="op" id="3076084">,</span>&nbsp;<span class="ident" id="3076086">r0</span><span class="op" id="3076088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076094">for</span>&nbsp;<span class="ident" id="3076098">r1</span>&nbsp;<span class="op" id="3076101">:=</span>&nbsp;<span class="ident" id="3076104">unicode</span><span class="op" id="3076111">.</span><span class="ident" id="3076112">SimpleFold</span><span class="op" id="3076122">(</span><span class="ident" id="3076123">r0</span><span class="op" id="3076125">)</span><span class="op" id="3076126">;</span>&nbsp;<span class="ident" id="3076128">r1</span>&nbsp;<span class="op" id="3076131">!=</span>&nbsp;<span class="ident" id="3076134">r0</span><span class="op" id="3076136">;</span>&nbsp;<span class="ident" id="3076138">r1</span>&nbsp;<span class="op" id="3076141">=</span>&nbsp;<span class="ident" id="3076143">unicode</span><span class="op" id="3076150">.</span><span class="ident" id="3076151">SimpleFold</span><span class="op" id="3076161">(</span><span class="ident" id="3076162">r1</span><span class="op" id="3076164">)</span>&nbsp;<span class="op" id="3076166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076173">runes</span>&nbsp;<span class="op" id="3076179">=</span>&nbsp;<span class="builtinfunc" id="3076181">append</span><span class="op" id="3076187">(</span><span class="ident" id="3076188">runes</span><span class="op" id="3076193">,</span>&nbsp;<span class="ident" id="3076195">r1</span><span class="op" id="3076197">,</span>&nbsp;<span class="ident" id="3076199">r1</span><span class="op" id="3076201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3076207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076213">sort</span><span class="op" id="3076217">.</span><span class="ident" id="3076218">Sort</span><span class="op" id="3076222">(</span><span class="ident" id="3076223">runeSlice</span><span class="op" id="3076232">(</span><span class="ident" id="3076233">runes</span><span class="op" id="3076238">)</span><span class="op" id="3076239">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3076244">}</span>&nbsp;<span class="keyword" id="3076246">else</span>&nbsp;<span class="op" id="3076251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076257">runes</span>&nbsp;<span class="op" id="3076263">=</span>&nbsp;<span class="builtinfunc" id="3076265">append</span><span class="op" id="3076271">(</span><span class="ident" id="3076272">runes</span><span class="op" id="3076277">,</span>&nbsp;<span class="ident" id="3076279">inst</span><span class="op" id="3076283">.</span><span class="ident" id="3076284">Rune</span><span class="op" id="3076288">[</span><span class="num" id="3076289">0</span><span class="op" id="3076290">]</span><span class="op" id="3076291">,</span>&nbsp;<span class="ident" id="3076293">inst</span><span class="op" id="3076297">.</span><span class="ident" id="3076298">Rune</span><span class="op" id="3076302">[</span><span class="num" id="3076303">0</span><span class="op" id="3076304">]</span><span class="op" id="3076305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3076310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076315">onePassRunes</span><span class="op" id="3076327">[</span><span class="ident" id="3076328">pc</span><span class="op" id="3076330">]</span>&nbsp;<span class="op" id="3076332">=</span>&nbsp;<span class="ident" id="3076334">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076343">inst</span><span class="op" id="3076347">.</span><span class="ident" id="3076348">Next</span>&nbsp;<span class="op" id="3076353">=</span>&nbsp;<span class="op" id="3076355">[</span><span class="op" id="3076356">]</span><span class="builtintype" id="3076357">uint32</span><span class="op" id="3076363">{</span><span class="op" id="3076364">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076369">for</span>&nbsp;<span class="ident" id="3076373">i</span>&nbsp;<span class="op" id="3076375">:=</span>&nbsp;<span class="builtinfunc" id="3076378">len</span><span class="op" id="3076381">(</span><span class="ident" id="3076382">onePassRunes</span><span class="op" id="3076394">[</span><span class="ident" id="3076395">pc</span><span class="op" id="3076397">]</span><span class="op" id="3076398">)</span>&nbsp;<span class="op" id="3076400">/</span>&nbsp;<span class="num" id="3076402">2</span><span class="op" id="3076403">;</span>&nbsp;<span class="ident" id="3076405">i</span>&nbsp;<span class="op" id="3076407">&gt;=</span>&nbsp;<span class="num" id="3076410">0</span><span class="op" id="3076411">;</span>&nbsp;<span class="ident" id="3076413">i</span><span class="op" id="3076414">--</span>&nbsp;<span class="op" id="3076417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076423">inst</span><span class="op" id="3076427">.</span><span class="ident" id="3076428">Next</span>&nbsp;<span class="op" id="3076433">=</span>&nbsp;<span class="builtinfunc" id="3076435">append</span><span class="op" id="3076441">(</span><span class="ident" id="3076442">inst</span><span class="op" id="3076446">.</span><span class="ident" id="3076447">Next</span><span class="op" id="3076451">,</span>&nbsp;<span class="ident" id="3076453">inst</span><span class="op" id="3076457">.</span><span class="ident" id="3076458">Out</span><span class="op" id="3076461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3076466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076471">inst</span><span class="op" id="3076475">.</span><span class="ident" id="3076476">Op</span>&nbsp;<span class="op" id="3076479">=</span>&nbsp;<span class="ident" id="3076481">syntax</span><span class="op" id="3076487">.</span><span class="ident" id="3076488">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076499">case</span>&nbsp;<span class="ident" id="3076504">syntax</span><span class="op" id="3076510">.</span><span class="ident" id="3076511">InstRuneAny</span><span class="op" id="3076522">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076527">ok</span>&nbsp;<span class="op" id="3076530">=</span>&nbsp;<span class="ident" id="3076532">check</span><span class="op" id="3076537">(</span><span class="ident" id="3076538">inst</span><span class="op" id="3076542">.</span><span class="ident" id="3076543">Out</span><span class="op" id="3076546">,</span>&nbsp;<span class="ident" id="3076548">m</span><span class="op" id="3076549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076554">m</span><span class="op" id="3076555">[</span><span class="ident" id="3076556">pc</span><span class="op" id="3076558">]</span>&nbsp;<span class="op" id="3076560">=</span>&nbsp;<span class="builtintype" id="3076562">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076571">if</span>&nbsp;<span class="builtinfunc" id="3076574">len</span><span class="op" id="3076577">(</span><span class="ident" id="3076578">inst</span><span class="op" id="3076582">.</span><span class="ident" id="3076583">Next</span><span class="op" id="3076587">)</span>&nbsp;<span class="op" id="3076589">&gt;</span>&nbsp;<span class="num" id="3076591">0</span>&nbsp;<span class="op" id="3076593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076599">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3076608">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076613">onePassRunes</span><span class="op" id="3076625">[</span><span class="ident" id="3076626">pc</span><span class="op" id="3076628">]</span>&nbsp;<span class="op" id="3076630">=</span>&nbsp;<span class="builtinfunc" id="3076632">append</span><span class="op" id="3076638">(</span><span class="op" id="3076639">[</span><span class="op" id="3076640">]</span><span class="builtintype" id="3076641">rune</span><span class="op" id="3076645">{</span><span class="op" id="3076646">}</span><span class="op" id="3076647">,</span>&nbsp;<span class="ident" id="3076649">anyRune</span><span class="op" id="3076656">...</span><span class="op" id="3076659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076664">inst</span><span class="op" id="3076668">.</span><span class="ident" id="3076669">Next</span>&nbsp;<span class="op" id="3076674">=</span>&nbsp;<span class="op" id="3076676">[</span><span class="op" id="3076677">]</span><span class="builtintype" id="3076678">uint32</span><span class="op" id="3076684">{</span><span class="ident" id="3076685">inst</span><span class="op" id="3076689">.</span><span class="ident" id="3076690">Out</span><span class="op" id="3076693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076697">case</span>&nbsp;<span class="ident" id="3076702">syntax</span><span class="op" id="3076708">.</span><span class="ident" id="3076709">InstRuneAnyNotNL</span><span class="op" id="3076725">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076730">ok</span>&nbsp;<span class="op" id="3076733">=</span>&nbsp;<span class="ident" id="3076735">check</span><span class="op" id="3076740">(</span><span class="ident" id="3076741">inst</span><span class="op" id="3076745">.</span><span class="ident" id="3076746">Out</span><span class="op" id="3076749">,</span>&nbsp;<span class="ident" id="3076751">m</span><span class="op" id="3076752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076757">m</span><span class="op" id="3076758">[</span><span class="ident" id="3076759">pc</span><span class="op" id="3076761">]</span>&nbsp;<span class="op" id="3076763">=</span>&nbsp;<span class="builtintype" id="3076765">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076774">if</span>&nbsp;<span class="builtinfunc" id="3076777">len</span><span class="op" id="3076780">(</span><span class="ident" id="3076781">inst</span><span class="op" id="3076785">.</span><span class="ident" id="3076786">Next</span><span class="op" id="3076790">)</span>&nbsp;<span class="op" id="3076792">&gt;</span>&nbsp;<span class="num" id="3076794">0</span>&nbsp;<span class="op" id="3076796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076802">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3076811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076816">onePassRunes</span><span class="op" id="3076828">[</span><span class="ident" id="3076829">pc</span><span class="op" id="3076831">]</span>&nbsp;<span class="op" id="3076833">=</span>&nbsp;<span class="builtinfunc" id="3076835">append</span><span class="op" id="3076841">(</span><span class="op" id="3076842">[</span><span class="op" id="3076843">]</span><span class="builtintype" id="3076844">rune</span><span class="op" id="3076848">{</span><span class="op" id="3076849">}</span><span class="op" id="3076850">,</span>&nbsp;<span class="ident" id="3076852">anyRuneNotNL</span><span class="op" id="3076864">...</span><span class="op" id="3076867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076872">inst</span><span class="op" id="3076876">.</span><span class="ident" id="3076877">Next</span>&nbsp;<span class="op" id="3076882">=</span>&nbsp;<span class="op" id="3076884">[</span><span class="op" id="3076885">]</span><span class="builtintype" id="3076886">uint32</span><span class="op" id="3076892">{</span><span class="op" id="3076893">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3076898">for</span>&nbsp;<span class="ident" id="3076902">i</span>&nbsp;<span class="op" id="3076904">:=</span>&nbsp;<span class="builtinfunc" id="3076907">len</span><span class="op" id="3076910">(</span><span class="ident" id="3076911">onePassRunes</span><span class="op" id="3076923">[</span><span class="ident" id="3076924">pc</span><span class="op" id="3076926">]</span><span class="op" id="3076927">)</span>&nbsp;<span class="op" id="3076929">/</span>&nbsp;<span class="num" id="3076931">2</span><span class="op" id="3076932">;</span>&nbsp;<span class="ident" id="3076934">i</span>&nbsp;<span class="op" id="3076936">&gt;=</span>&nbsp;<span class="num" id="3076939">0</span><span class="op" id="3076940">;</span>&nbsp;<span class="ident" id="3076942">i</span><span class="op" id="3076943">--</span>&nbsp;<span class="op" id="3076946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3076952">inst</span><span class="op" id="3076956">.</span><span class="ident" id="3076957">Next</span>&nbsp;<span class="op" id="3076962">=</span>&nbsp;<span class="builtinfunc" id="3076964">append</span><span class="op" id="3076970">(</span><span class="ident" id="3076971">inst</span><span class="op" id="3076975">.</span><span class="ident" id="3076976">Next</span><span class="op" id="3076980">,</span>&nbsp;<span class="ident" id="3076982">inst</span><span class="op" id="3076986">.</span><span class="ident" id="3076987">Out</span><span class="op" id="3076990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3076995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3076999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077003">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077015">instQueue</span><span class="op" id="3077024">.</span><span class="ident" id="3077025">clear</span><span class="op" id="3077030">(</span><span class="op" id="3077031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077034">instQueue</span><span class="op" id="3077043">.</span><span class="ident" id="3077044">insert</span><span class="op" id="3077050">(</span><span class="builtintype" id="3077051">uint32</span><span class="op" id="3077057">(</span><span class="ident" id="3077058">p</span><span class="op" id="3077059">.</span><span class="ident" id="3077060">Start</span><span class="op" id="3077065">)</span><span class="op" id="3077066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077069">m</span>&nbsp;<span class="op" id="3077071">:=</span>&nbsp;<span class="builtinfunc" id="3077074">make</span><span class="op" id="3077078">(</span><span class="keyword" id="3077079">map</span><span class="op" id="3077082">[</span><span class="builtintype" id="3077083">uint32</span><span class="op" id="3077089">]</span><span class="builtintype" id="3077090">bool</span><span class="op" id="3077094">,</span>&nbsp;<span class="builtinfunc" id="3077096">len</span><span class="op" id="3077099">(</span><span class="ident" id="3077100">p</span><span class="op" id="3077101">.</span><span class="ident" id="3077102">Inst</span><span class="op" id="3077106">)</span><span class="op" id="3077107">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077110">for</span>&nbsp;<span class="op" id="3077114">!</span><span class="ident" id="3077115">instQueue</span><span class="op" id="3077124">.</span><span class="ident" id="3077125">empty</span><span class="op" id="3077130">(</span><span class="op" id="3077131">)</span>&nbsp;<span class="op" id="3077133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077137">pc</span>&nbsp;<span class="op" id="3077140">:=</span>&nbsp;<span class="ident" id="3077143">instQueue</span><span class="op" id="3077152">.</span><span class="ident" id="3077153">next</span><span class="op" id="3077157">(</span><span class="op" id="3077158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077162">inst</span>&nbsp;<span class="op" id="3077167">:=</span>&nbsp;<span class="ident" id="3077170">p</span><span class="op" id="3077171">.</span><span class="ident" id="3077172">Inst</span><span class="op" id="3077176">[</span><span class="ident" id="3077177">pc</span><span class="op" id="3077179">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077183">visitQueue</span><span class="op" id="3077193">.</span><span class="ident" id="3077194">clear</span><span class="op" id="3077199">(</span><span class="op" id="3077200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077204">if</span>&nbsp;<span class="op" id="3077207">!</span><span class="ident" id="3077208">check</span><span class="op" id="3077213">(</span><span class="builtintype" id="3077214">uint32</span><span class="op" id="3077220">(</span><span class="ident" id="3077221">pc</span><span class="op" id="3077223">)</span><span class="op" id="3077224">,</span>&nbsp;<span class="ident" id="3077226">m</span><span class="op" id="3077227">)</span>&nbsp;<span class="op" id="3077229">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077234">p</span>&nbsp;<span class="op" id="3077236">=</span>&nbsp;<span class="ident" id="3077238">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077252">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077264">switch</span>&nbsp;<span class="ident" id="3077271">inst</span><span class="op" id="3077275">.</span><span class="ident" id="3077276">Op</span>&nbsp;<span class="op" id="3077279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077283">case</span>&nbsp;<span class="ident" id="3077288">syntax</span><span class="op" id="3077294">.</span><span class="ident" id="3077295">InstAlt</span><span class="op" id="3077302">,</span>&nbsp;<span class="ident" id="3077304">syntax</span><span class="op" id="3077310">.</span><span class="ident" id="3077311">InstAltMatch</span><span class="op" id="3077323">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077328">instQueue</span><span class="op" id="3077337">.</span><span class="ident" id="3077338">insert</span><span class="op" id="3077344">(</span><span class="ident" id="3077345">inst</span><span class="op" id="3077349">.</span><span class="ident" id="3077350">Out</span><span class="op" id="3077353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077358">instQueue</span><span class="op" id="3077367">.</span><span class="ident" id="3077368">insert</span><span class="op" id="3077374">(</span><span class="ident" id="3077375">inst</span><span class="op" id="3077379">.</span><span class="ident" id="3077380">Arg</span><span class="op" id="3077383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077387">case</span>&nbsp;<span class="ident" id="3077392">syntax</span><span class="op" id="3077398">.</span><span class="ident" id="3077399">InstCapture</span><span class="op" id="3077410">,</span>&nbsp;<span class="ident" id="3077412">syntax</span><span class="op" id="3077418">.</span><span class="ident" id="3077419">InstEmptyWidth</span><span class="op" id="3077433">,</span>&nbsp;<span class="ident" id="3077435">syntax</span><span class="op" id="3077441">.</span><span class="ident" id="3077442">InstNop</span><span class="op" id="3077449">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077454">instQueue</span><span class="op" id="3077463">.</span><span class="ident" id="3077464">insert</span><span class="op" id="3077470">(</span><span class="ident" id="3077471">inst</span><span class="op" id="3077475">.</span><span class="ident" id="3077476">Out</span><span class="op" id="3077479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077483">case</span>&nbsp;<span class="ident" id="3077488">syntax</span><span class="op" id="3077494">.</span><span class="ident" id="3077495">InstMatch</span><span class="op" id="3077504">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077508">case</span>&nbsp;<span class="ident" id="3077513">syntax</span><span class="op" id="3077519">.</span><span class="ident" id="3077520">InstFail</span><span class="op" id="3077528">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077532">case</span>&nbsp;<span class="ident" id="3077537">syntax</span><span class="op" id="3077543">.</span><span class="ident" id="3077544">InstRune</span><span class="op" id="3077552">,</span>&nbsp;<span class="ident" id="3077554">syntax</span><span class="op" id="3077560">.</span><span class="ident" id="3077561">InstRune1</span><span class="op" id="3077570">,</span>&nbsp;<span class="ident" id="3077572">syntax</span><span class="op" id="3077578">.</span><span class="ident" id="3077579">InstRuneAny</span><span class="op" id="3077590">,</span>&nbsp;<span class="ident" id="3077592">syntax</span><span class="op" id="3077598">.</span><span class="ident" id="3077599">InstRuneAnyNotNL</span><span class="op" id="3077615">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077619">default</span><span class="op" id="3077626">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077633">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077636">if</span>&nbsp;<span class="ident" id="3077639">p</span>&nbsp;<span class="op" id="3077641">!=</span>&nbsp;<span class="ident" id="3077644">notOnePass</span>&nbsp;<span class="op" id="3077655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077659">for</span>&nbsp;<span class="ident" id="3077663">i</span>&nbsp;<span class="op" id="3077665">:=</span>&nbsp;<span class="keyword" id="3077668">range</span>&nbsp;<span class="ident" id="3077674">p</span><span class="op" id="3077675">.</span><span class="ident" id="3077676">Inst</span>&nbsp;<span class="op" id="3077681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077686">p</span><span class="op" id="3077687">.</span><span class="ident" id="3077688">Inst</span><span class="op" id="3077692">[</span><span class="ident" id="3077693">i</span><span class="op" id="3077694">]</span><span class="op" id="3077695">.</span><span class="ident" id="3077696">Rune</span>&nbsp;<span class="op" id="3077701">=</span>&nbsp;<span class="ident" id="3077703">onePassRunes</span><span class="op" id="3077715">[</span><span class="ident" id="3077716">i</span><span class="op" id="3077717">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3077724">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077727">return</span>&nbsp;<span class="ident" id="3077734">p</span><br>
<span class="lineno"></span><span class="op" id="3077736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3077739">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="3077807">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="3077844">func</span>&nbsp;<span class="ident" id="3077849">walk</span><span class="op" id="3077853">(</span><span class="ident" id="3077854">prog</span>&nbsp;<span class="op" id="3077859">*</span><span class="ident" id="3077860">syntax</span><span class="op" id="3077866">.</span><span class="ident" id="3077867">Prog</span><span class="op" id="3077871">,</span>&nbsp;<span class="ident" id="3077873">funcs</span>&nbsp;<span class="op" id="3077879">...</span><span class="keyword" id="3077882">func</span><span class="op" id="3077886">(</span><span class="ident" id="3077887">ip</span><span class="op" id="3077889">,</span>&nbsp;<span class="ident" id="3077891">next</span>&nbsp;<span class="builtintype" id="3077896">uint32</span><span class="op" id="3077902">)</span><span class="op" id="3077903">)</span>&nbsp;<span class="op" id="3077905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077908">var</span>&nbsp;<span class="ident" id="3077912">walk1</span>&nbsp;<span class="keyword" id="3077918">func</span><span class="op" id="3077922">(</span><span class="builtintype" id="3077923">uint32</span><span class="op" id="3077929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077932">progQueue</span>&nbsp;<span class="op" id="3077942">:=</span>&nbsp;<span class="ident" id="3077945">newQueue</span><span class="op" id="3077953">(</span><span class="builtinfunc" id="3077954">len</span><span class="op" id="3077957">(</span><span class="ident" id="3077958">prog</span><span class="op" id="3077962">.</span><span class="ident" id="3077963">Inst</span><span class="op" id="3077967">)</span><span class="op" id="3077968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3077971">walk1</span>&nbsp;<span class="op" id="3077977">=</span>&nbsp;<span class="keyword" id="3077979">func</span><span class="op" id="3077983">(</span><span class="ident" id="3077984">ip</span>&nbsp;<span class="builtintype" id="3077987">uint32</span><span class="op" id="3077993">)</span>&nbsp;<span class="op" id="3077995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3077999">if</span>&nbsp;<span class="ident" id="3078002">progQueue</span><span class="op" id="3078011">.</span><span class="ident" id="3078012">contains</span><span class="op" id="3078020">(</span><span class="ident" id="3078021">ip</span><span class="op" id="3078023">)</span>&nbsp;<span class="op" id="3078025">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078030">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078043">progQueue</span><span class="op" id="3078052">.</span><span class="ident" id="3078053">insert</span><span class="op" id="3078059">(</span><span class="ident" id="3078060">ip</span><span class="op" id="3078062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078066">inst</span>&nbsp;<span class="op" id="3078071">:=</span>&nbsp;<span class="ident" id="3078074">prog</span><span class="op" id="3078078">.</span><span class="ident" id="3078079">Inst</span><span class="op" id="3078083">[</span><span class="ident" id="3078084">ip</span><span class="op" id="3078086">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078090">switch</span>&nbsp;<span class="ident" id="3078097">inst</span><span class="op" id="3078101">.</span><span class="ident" id="3078102">Op</span>&nbsp;<span class="op" id="3078105">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078109">case</span>&nbsp;<span class="ident" id="3078114">syntax</span><span class="op" id="3078120">.</span><span class="ident" id="3078121">InstAlt</span><span class="op" id="3078128">,</span>&nbsp;<span class="ident" id="3078130">syntax</span><span class="op" id="3078136">.</span><span class="ident" id="3078137">InstAltMatch</span><span class="op" id="3078149">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078154">for</span>&nbsp;<span class="ident" id="3078158">_</span><span class="op" id="3078159">,</span>&nbsp;<span class="ident" id="3078161">f</span>&nbsp;<span class="op" id="3078163">:=</span>&nbsp;<span class="keyword" id="3078166">range</span>&nbsp;<span class="ident" id="3078172">funcs</span>&nbsp;<span class="op" id="3078178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078184">f</span><span class="op" id="3078185">(</span><span class="ident" id="3078186">ip</span><span class="op" id="3078188">,</span>&nbsp;<span class="ident" id="3078190">inst</span><span class="op" id="3078194">.</span><span class="ident" id="3078195">Out</span><span class="op" id="3078198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078204">f</span><span class="op" id="3078205">(</span><span class="ident" id="3078206">ip</span><span class="op" id="3078208">,</span>&nbsp;<span class="ident" id="3078210">inst</span><span class="op" id="3078214">.</span><span class="ident" id="3078215">Arg</span><span class="op" id="3078218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078223">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078228">walk1</span><span class="op" id="3078233">(</span><span class="ident" id="3078234">inst</span><span class="op" id="3078238">.</span><span class="ident" id="3078239">Out</span><span class="op" id="3078242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078247">walk1</span><span class="op" id="3078252">(</span><span class="ident" id="3078253">inst</span><span class="op" id="3078257">.</span><span class="ident" id="3078258">Arg</span><span class="op" id="3078261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078265">default</span><span class="op" id="3078272">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078277">for</span>&nbsp;<span class="ident" id="3078281">_</span><span class="op" id="3078282">,</span>&nbsp;<span class="ident" id="3078284">f</span>&nbsp;<span class="op" id="3078286">:=</span>&nbsp;<span class="keyword" id="3078289">range</span>&nbsp;<span class="ident" id="3078295">funcs</span>&nbsp;<span class="op" id="3078301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078307">f</span><span class="op" id="3078308">(</span><span class="ident" id="3078309">ip</span><span class="op" id="3078311">,</span>&nbsp;<span class="ident" id="3078313">inst</span><span class="op" id="3078317">.</span><span class="ident" id="3078318">Out</span><span class="op" id="3078321">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078331">walk1</span><span class="op" id="3078336">(</span><span class="ident" id="3078337">inst</span><span class="op" id="3078341">.</span><span class="ident" id="3078342">Out</span><span class="op" id="3078345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078355">walk1</span><span class="op" id="3078360">(</span><span class="builtintype" id="3078361">uint32</span><span class="op" id="3078367">(</span><span class="ident" id="3078368">prog</span><span class="op" id="3078372">.</span><span class="ident" id="3078373">Start</span><span class="op" id="3078378">)</span><span class="op" id="3078379">)</span><br>
<span class="lineno">520</span><span class="op" id="3078381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3078384">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="3078453">func</span>&nbsp;<span class="ident" id="3078458">find</span><span class="op" id="3078462">(</span><span class="ident" id="3078463">prog</span>&nbsp;<span class="op" id="3078468">*</span><span class="ident" id="3078469">syntax</span><span class="op" id="3078475">.</span><span class="ident" id="3078476">Prog</span><span class="op" id="3078480">,</span>&nbsp;<span class="ident" id="3078482">f</span>&nbsp;<span class="keyword" id="3078484">func</span><span class="op" id="3078488">(</span><span class="op" id="3078489">*</span><span class="ident" id="3078490">syntax</span><span class="op" id="3078496">.</span><span class="ident" id="3078497">Prog</span><span class="op" id="3078501">,</span>&nbsp;<span class="builtintype" id="3078503">int</span><span class="op" id="3078506">)</span>&nbsp;<span class="builtintype" id="3078508">bool</span><span class="op" id="3078512">)</span>&nbsp;<span class="op" id="3078514">(</span><span class="ident" id="3078515">matches</span>&nbsp;<span class="op" id="3078523">[</span><span class="op" id="3078524">]</span><span class="builtintype" id="3078525">uint32</span><span class="op" id="3078531">)</span>&nbsp;<span class="op" id="3078533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078536">matches</span>&nbsp;<span class="op" id="3078544">=</span>&nbsp;<span class="op" id="3078546">[</span><span class="op" id="3078547">]</span><span class="builtintype" id="3078548">uint32</span><span class="op" id="3078554">{</span><span class="op" id="3078555">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078559">for</span>&nbsp;<span class="ident" id="3078563">ip</span>&nbsp;<span class="op" id="3078566">:=</span>&nbsp;<span class="keyword" id="3078569">range</span>&nbsp;<span class="ident" id="3078575">prog</span><span class="op" id="3078579">.</span><span class="ident" id="3078580">Inst</span>&nbsp;<span class="op" id="3078585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078589">if</span>&nbsp;<span class="ident" id="3078592">f</span><span class="op" id="3078593">(</span><span class="ident" id="3078594">prog</span><span class="op" id="3078598">,</span>&nbsp;<span class="ident" id="3078600">ip</span><span class="op" id="3078602">)</span>&nbsp;<span class="op" id="3078604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3078609">matches</span>&nbsp;<span class="op" id="3078617">=</span>&nbsp;<span class="builtinfunc" id="3078619">append</span><span class="op" id="3078625">(</span><span class="ident" id="3078626">matches</span><span class="op" id="3078633">,</span>&nbsp;<span class="builtintype" id="3078635">uint32</span><span class="op" id="3078641">(</span><span class="ident" id="3078642">ip</span><span class="op" id="3078644">)</span><span class="op" id="3078645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078649">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3078652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3078655">return</span><br>
<span class="lineno"></span><span class="op" id="3078662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3078665">var</span>&nbsp;<span class="ident" id="3078669">notOnePass</span>&nbsp;<span class="op" id="3078680">*</span><span class="ident" id="3078681">onePassProg</span>&nbsp;<span class="op" id="3078693">=</span>&nbsp;<span class="ident" id="3078695">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="3078700">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="3078797">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3078881">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3078967">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="3079053">func</span>&nbsp;<span class="ident" id="3079058">compileOnePass</span><span class="op" id="3079072">(</span><span class="ident" id="3079073">prog</span>&nbsp;<span class="op" id="3079078">*</span><span class="ident" id="3079079">syntax</span><span class="op" id="3079085">.</span><span class="ident" id="3079086">Prog</span><span class="op" id="3079090">)</span>&nbsp;<span class="op" id="3079092">(</span><span class="ident" id="3079093">p</span>&nbsp;<span class="op" id="3079095">*</span><span class="ident" id="3079096">onePassProg</span><span class="op" id="3079107">)</span>&nbsp;<span class="op" id="3079109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079112">if</span>&nbsp;<span class="ident" id="3079115">prog</span><span class="op" id="3079119">.</span><span class="ident" id="3079120">Start</span>&nbsp;<span class="op" id="3079126">==</span>&nbsp;<span class="num" id="3079129">0</span>&nbsp;<span class="op" id="3079131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079135">return</span>&nbsp;<span class="ident" id="3079142">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079157">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079188">if</span>&nbsp;<span class="ident" id="3079191">prog</span><span class="op" id="3079195">.</span><span class="ident" id="3079196">Inst</span><span class="op" id="3079200">[</span><span class="ident" id="3079201">prog</span><span class="op" id="3079205">.</span><span class="ident" id="3079206">Start</span><span class="op" id="3079211">]</span><span class="op" id="3079212">.</span><span class="ident" id="3079213">Op</span>&nbsp;<span class="op" id="3079216">!=</span>&nbsp;<span class="ident" id="3079219">syntax</span><span class="op" id="3079225">.</span><span class="ident" id="3079226">InstEmptyWidth</span>&nbsp;<span class="op" id="3079241">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079246">syntax</span><span class="op" id="3079252">.</span><span class="ident" id="3079253">EmptyOp</span><span class="op" id="3079260">(</span><span class="ident" id="3079261">prog</span><span class="op" id="3079265">.</span><span class="ident" id="3079266">Inst</span><span class="op" id="3079270">[</span><span class="ident" id="3079271">prog</span><span class="op" id="3079275">.</span><span class="ident" id="3079276">Start</span><span class="op" id="3079281">]</span><span class="op" id="3079282">.</span><span class="ident" id="3079283">Arg</span><span class="op" id="3079286">)</span><span class="op" id="3079287">&amp;</span><span class="ident" id="3079288">syntax</span><span class="op" id="3079294">.</span><span class="ident" id="3079295">EmptyBeginText</span>&nbsp;<span class="op" id="3079310">!=</span>&nbsp;<span class="ident" id="3079313">syntax</span><span class="op" id="3079319">.</span><span class="ident" id="3079320">EmptyBeginText</span>&nbsp;<span class="op" id="3079335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079339">return</span>&nbsp;<span class="ident" id="3079346">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079361">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079425">for</span>&nbsp;<span class="ident" id="3079429">_</span><span class="op" id="3079430">,</span>&nbsp;<span class="ident" id="3079432">inst</span>&nbsp;<span class="op" id="3079437">:=</span>&nbsp;<span class="keyword" id="3079440">range</span>&nbsp;<span class="ident" id="3079446">prog</span><span class="op" id="3079450">.</span><span class="ident" id="3079451">Inst</span>&nbsp;<span class="op" id="3079456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3079460">opOut</span>&nbsp;<span class="op" id="3079466">:=</span>&nbsp;<span class="ident" id="3079469">prog</span><span class="op" id="3079473">.</span><span class="ident" id="3079474">Inst</span><span class="op" id="3079478">[</span><span class="ident" id="3079479">inst</span><span class="op" id="3079483">.</span><span class="ident" id="3079484">Out</span><span class="op" id="3079487">]</span><span class="op" id="3079488">.</span><span class="ident" id="3079489">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079494">switch</span>&nbsp;<span class="ident" id="3079501">inst</span><span class="op" id="3079505">.</span><span class="ident" id="3079506">Op</span>&nbsp;<span class="op" id="3079509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079513">default</span><span class="op" id="3079520">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079525">if</span>&nbsp;<span class="ident" id="3079528">opOut</span>&nbsp;<span class="op" id="3079534">==</span>&nbsp;<span class="ident" id="3079537">syntax</span><span class="op" id="3079543">.</span><span class="ident" id="3079544">InstMatch</span>&nbsp;<span class="op" id="3079554">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079560">return</span>&nbsp;<span class="ident" id="3079567">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079585">case</span>&nbsp;<span class="ident" id="3079590">syntax</span><span class="op" id="3079596">.</span><span class="ident" id="3079597">InstAlt</span><span class="op" id="3079604">,</span>&nbsp;<span class="ident" id="3079606">syntax</span><span class="op" id="3079612">.</span><span class="ident" id="3079613">InstAltMatch</span><span class="op" id="3079625">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079630">if</span>&nbsp;<span class="ident" id="3079633">opOut</span>&nbsp;<span class="op" id="3079639">==</span>&nbsp;<span class="ident" id="3079642">syntax</span><span class="op" id="3079648">.</span><span class="ident" id="3079649">InstMatch</span>&nbsp;<span class="op" id="3079659">||</span>&nbsp;<span class="ident" id="3079662">prog</span><span class="op" id="3079666">.</span><span class="ident" id="3079667">Inst</span><span class="op" id="3079671">[</span><span class="ident" id="3079672">inst</span><span class="op" id="3079676">.</span><span class="ident" id="3079677">Arg</span><span class="op" id="3079680">]</span><span class="op" id="3079681">.</span><span class="ident" id="3079682">Op</span>&nbsp;<span class="op" id="3079685">==</span>&nbsp;<span class="ident" id="3079688">syntax</span><span class="op" id="3079694">.</span><span class="ident" id="3079695">InstMatch</span>&nbsp;<span class="op" id="3079705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079711">return</span>&nbsp;<span class="ident" id="3079718">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079736">case</span>&nbsp;<span class="ident" id="3079741">syntax</span><span class="op" id="3079747">.</span><span class="ident" id="3079748">InstEmptyWidth</span><span class="op" id="3079762">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079767">if</span>&nbsp;<span class="ident" id="3079770">opOut</span>&nbsp;<span class="op" id="3079776">==</span>&nbsp;<span class="ident" id="3079779">syntax</span><span class="op" id="3079785">.</span><span class="ident" id="3079786">InstMatch</span>&nbsp;<span class="op" id="3079796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079802">if</span>&nbsp;<span class="ident" id="3079805">syntax</span><span class="op" id="3079811">.</span><span class="ident" id="3079812">EmptyOp</span><span class="op" id="3079819">(</span><span class="ident" id="3079820">inst</span><span class="op" id="3079824">.</span><span class="ident" id="3079825">Arg</span><span class="op" id="3079828">)</span><span class="op" id="3079829">&amp;</span><span class="ident" id="3079830">syntax</span><span class="op" id="3079836">.</span><span class="ident" id="3079837">EmptyEndText</span>&nbsp;<span class="op" id="3079850">==</span>&nbsp;<span class="ident" id="3079853">syntax</span><span class="op" id="3079859">.</span><span class="ident" id="3079860">EmptyEndText</span>&nbsp;<span class="op" id="3079873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079880">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3079899">return</span>&nbsp;<span class="ident" id="3079906">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3079927">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079930">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3079989">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080059">p</span>&nbsp;<span class="op" id="3080061">=</span>&nbsp;<span class="ident" id="3080063">onePassCopy</span><span class="op" id="3080074">(</span><span class="ident" id="3080075">prog</span><span class="op" id="3080079">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3080083">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080146">p</span>&nbsp;<span class="op" id="3080148">=</span>&nbsp;<span class="ident" id="3080150">makeOnePass</span><span class="op" id="3080161">(</span><span class="ident" id="3080162">p</span><span class="op" id="3080163">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080167">if</span>&nbsp;<span class="ident" id="3080170">p</span>&nbsp;<span class="op" id="3080172">!=</span>&nbsp;<span class="ident" id="3080175">notOnePass</span>&nbsp;<span class="op" id="3080186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3080190">cleanupOnePass</span><span class="op" id="3080204">(</span><span class="ident" id="3080205">p</span><span class="op" id="3080206">,</span>&nbsp;<span class="ident" id="3080208">prog</span><span class="op" id="3080212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3080215">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3080218">return</span>&nbsp;<span class="ident" id="3080225">p</span><br>
<span class="lineno"></span><span class="op" id="3080227">}</span>
</div>
</body>
</html>
