<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html" class="current">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1633642">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1633697">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1633751">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1633802">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1633880">package</span>&nbsp;<span class="ident" id="1633888">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1633897">import</span>&nbsp;<span class="string" id="1633904">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1633914">//&nbsp;Integrated&nbsp;network&nbsp;poller&nbsp;(platform-independent&nbsp;part).</span><br>
<span class="lineno"></span><span class="comment" id="1633972">//&nbsp;A&nbsp;particular&nbsp;implementation&nbsp;(epoll/kqueue)&nbsp;must&nbsp;define&nbsp;the&nbsp;following&nbsp;functions:</span><br>
<span class="lineno"></span><span class="comment" id="1634055">//&nbsp;func&nbsp;netpollinit()&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;initialize&nbsp;the&nbsp;poller</span><br>
<span class="lineno"></span><span class="comment" id="1634107">//&nbsp;func&nbsp;netpollopen(fd&nbsp;uintptr,&nbsp;pd&nbsp;*pollDesc)&nbsp;int32&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;arm&nbsp;edge-triggered&nbsp;notifications</span><br>
<span class="lineno">15</span><span class="comment" id="1634198">//&nbsp;and&nbsp;associate&nbsp;fd&nbsp;with&nbsp;pd.</span><br>
<span class="lineno"></span><span class="comment" id="1634227">//&nbsp;An&nbsp;implementation&nbsp;must&nbsp;call&nbsp;the&nbsp;following&nbsp;function&nbsp;to&nbsp;denote&nbsp;that&nbsp;the&nbsp;pd&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="comment" id="1634313">//&nbsp;func&nbsp;netpollready(gpp&nbsp;**g,&nbsp;pd&nbsp;*pollDesc,&nbsp;mode&nbsp;int32)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1634370">//&nbsp;pollDesc&nbsp;contains&nbsp;2&nbsp;binary&nbsp;semaphores,&nbsp;rg&nbsp;and&nbsp;wg,&nbsp;to&nbsp;park&nbsp;reader&nbsp;and&nbsp;writer</span><br>
<span class="lineno">20</span><span class="comment" id="1634449">//&nbsp;goroutines&nbsp;respectively.&nbsp;The&nbsp;semaphore&nbsp;can&nbsp;be&nbsp;in&nbsp;the&nbsp;following&nbsp;states:</span><br>
<span class="lineno"></span><span class="comment" id="1634523">//&nbsp;pdReady&nbsp;-&nbsp;io&nbsp;readiness&nbsp;notification&nbsp;is&nbsp;pending;</span><br>
<span class="lineno"></span><span class="comment" id="1634574">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;goroutine&nbsp;consumes&nbsp;the&nbsp;notification&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1634655">//&nbsp;pdWait&nbsp;-&nbsp;a&nbsp;goroutine&nbsp;prepares&nbsp;to&nbsp;park&nbsp;on&nbsp;the&nbsp;semaphore,&nbsp;but&nbsp;not&nbsp;yet&nbsp;parked;</span><br>
<span class="lineno"></span><span class="comment" id="1634734">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;goroutine&nbsp;commits&nbsp;to&nbsp;park&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;G&nbsp;pointer,</span><br>
<span class="lineno">25</span><span class="comment" id="1634812">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;io&nbsp;notification&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY,</span><br>
<span class="lineno"></span><span class="comment" id="1634898">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1634980">//&nbsp;G&nbsp;pointer&nbsp;-&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;blocked&nbsp;on&nbsp;the&nbsp;semaphore;</span><br>
<span class="lineno"></span><span class="comment" id="1635038">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;notification&nbsp;or&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY&nbsp;or&nbsp;nil&nbsp;respectively</span><br>
<span class="lineno"></span><span class="comment" id="1635133">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;unparks&nbsp;the&nbsp;goroutine.</span><br>
<span class="lineno">30</span><span class="comment" id="1635175">//&nbsp;nil&nbsp;-&nbsp;nothing&nbsp;of&nbsp;the&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="1635206">const</span>&nbsp;<span class="op" id="1635212">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635215">pdReady</span>&nbsp;<span class="builtintype" id="1635223">uintptr</span>&nbsp;<span class="op" id="1635231">=</span>&nbsp;<span class="num" id="1635233">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635236">pdWait</span>&nbsp;&nbsp;<span class="builtintype" id="1635244">uintptr</span>&nbsp;<span class="op" id="1635252">=</span>&nbsp;<span class="num" id="1635254">2</span><br>
<span class="lineno"></span><span class="op" id="1635256">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1635259">const</span>&nbsp;<span class="ident" id="1635265">pollBlockSize</span>&nbsp;<span class="op" id="1635279">=</span>&nbsp;<span class="num" id="1635281">4</span>&nbsp;<span class="op" id="1635283">*</span>&nbsp;<span class="num" id="1635285">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1635291">//&nbsp;Network&nbsp;poller&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1635321">type</span>&nbsp;<span class="ident" id="1635326">pollDesc</span>&nbsp;<span class="keyword" id="1635335">struct</span>&nbsp;<span class="op" id="1635342">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635345">link</span>&nbsp;<span class="op" id="1635350">*</span><span class="ident" id="1635351">pollDesc</span>&nbsp;<span class="comment" id="1635360">//&nbsp;in&nbsp;pollcache,&nbsp;protected&nbsp;by&nbsp;pollcache.lock</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635407">//&nbsp;The&nbsp;lock&nbsp;protects&nbsp;pollOpen,&nbsp;pollSetDeadline,&nbsp;pollUnblock&nbsp;and&nbsp;deadlineimpl&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635497">//&nbsp;This&nbsp;fully&nbsp;covers&nbsp;seq,&nbsp;rt&nbsp;and&nbsp;wt&nbsp;variables.&nbsp;fd&nbsp;is&nbsp;constant&nbsp;throughout&nbsp;the&nbsp;PollDesc&nbsp;lifetime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635594">//&nbsp;pollReset,&nbsp;pollWait,&nbsp;pollWaitCanceled&nbsp;and&nbsp;runtimeÂ·netpollready&nbsp;(IO&nbsp;readiness&nbsp;notification)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635690">//&nbsp;proceed&nbsp;w/o&nbsp;taking&nbsp;the&nbsp;lock.&nbsp;So&nbsp;closing,&nbsp;rg,&nbsp;rd,&nbsp;wg&nbsp;and&nbsp;wd&nbsp;are&nbsp;manipulated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635769">//&nbsp;in&nbsp;a&nbsp;lock-free&nbsp;way&nbsp;by&nbsp;all&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635811">//&nbsp;NOTE(dvyukov):&nbsp;the&nbsp;following&nbsp;code&nbsp;uses&nbsp;uintptr&nbsp;to&nbsp;store&nbsp;*g&nbsp;(rg/wg),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635883">//&nbsp;that&nbsp;will&nbsp;blow&nbsp;up&nbsp;when&nbsp;GC&nbsp;starts&nbsp;moving&nbsp;objects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635936">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1635944">mutex</span>&nbsp;<span class="comment" id="1635950">//&nbsp;protectes&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635985">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1635993">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636002">closing</span>&nbsp;<span class="builtintype" id="1636010">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636016">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1636024">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636039">//&nbsp;protects&nbsp;from&nbsp;stale&nbsp;timers&nbsp;and&nbsp;ready&nbsp;notifications</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636094">rg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1636102">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636117">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;read&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636164">rt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636172">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636187">//&nbsp;read&nbsp;deadline&nbsp;timer&nbsp;(set&nbsp;if&nbsp;rt.f&nbsp;!=&nbsp;nil)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636232">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636240">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636255">//&nbsp;read&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636273">wg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1636281">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636296">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;write&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636344">wt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636352">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636367">//&nbsp;write&nbsp;deadline&nbsp;timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636392">wd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636400">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1636415">//&nbsp;write&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636434">user</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1636442">unsafe</span><span class="op" id="1636448">.</span><span class="ident" id="1636449">Pointer</span>&nbsp;<span class="comment" id="1636457">//&nbsp;user&nbsp;settable&nbsp;cookie</span><br>
<span class="lineno">60</span><span class="op" id="1636481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1636484">type</span>&nbsp;<span class="ident" id="1636489">pollCache</span>&nbsp;<span class="keyword" id="1636499">struct</span>&nbsp;<span class="op" id="1636506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636509">lock</span>&nbsp;&nbsp;<span class="ident" id="1636515">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636522">first</span>&nbsp;<span class="op" id="1636528">*</span><span class="ident" id="1636529">pollDesc</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1636539">//&nbsp;PollDesc&nbsp;objects&nbsp;must&nbsp;be&nbsp;type-stable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1636581">//&nbsp;because&nbsp;we&nbsp;can&nbsp;get&nbsp;ready&nbsp;notification&nbsp;from&nbsp;epoll/kqueue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1636641">//&nbsp;after&nbsp;the&nbsp;descriptor&nbsp;is&nbsp;closed/reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1636684">//&nbsp;Stale&nbsp;notifications&nbsp;are&nbsp;detected&nbsp;using&nbsp;seq&nbsp;variable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1636741">//&nbsp;seq&nbsp;is&nbsp;incremented&nbsp;when&nbsp;deadlines&nbsp;are&nbsp;changed&nbsp;or&nbsp;descriptor&nbsp;is&nbsp;reused.</span><br>
<span class="lineno">70</span><span class="op" id="1636815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1636818">var</span>&nbsp;<span class="ident" id="1636822">pollcache</span>&nbsp;<span class="ident" id="1636832">pollCache</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1636843">func</span>&nbsp;<span class="ident" id="1636848">netpollServerInit</span><span class="op" id="1636865">(</span><span class="op" id="1636866">)</span>&nbsp;<span class="op" id="1636868">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636871">onM</span><span class="op" id="1636874">(</span><span class="ident" id="1636875">netpollinit</span><span class="op" id="1636886">)</span><br>
<span class="lineno"></span><span class="op" id="1636888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1636891">func</span>&nbsp;<span class="ident" id="1636896">netpollOpen</span><span class="op" id="1636907">(</span><span class="ident" id="1636908">fd</span>&nbsp;<span class="builtintype" id="1636911">uintptr</span><span class="op" id="1636918">)</span>&nbsp;<span class="op" id="1636920">(</span><span class="op" id="1636921">*</span><span class="ident" id="1636922">pollDesc</span><span class="op" id="1636930">,</span>&nbsp;<span class="builtintype" id="1636932">int</span><span class="op" id="1636935">)</span>&nbsp;<span class="op" id="1636937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636940">pd</span>&nbsp;<span class="op" id="1636943">:=</span>&nbsp;<span class="ident" id="1636946">pollcache</span><span class="op" id="1636955">.</span><span class="ident" id="1636956">alloc</span><span class="op" id="1636961">(</span><span class="op" id="1636962">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1636965">lock</span><span class="op" id="1636969">(</span><span class="op" id="1636970">&amp;</span><span class="ident" id="1636971">pd</span><span class="op" id="1636973">.</span><span class="ident" id="1636974">lock</span><span class="op" id="1636978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1636981">if</span>&nbsp;<span class="ident" id="1636984">pd</span><span class="op" id="1636986">.</span><span class="ident" id="1636987">wg</span>&nbsp;<span class="op" id="1636990">!=</span>&nbsp;<span class="num" id="1636993">0</span>&nbsp;<span class="op" id="1636995">&amp;&amp;</span>&nbsp;<span class="ident" id="1636998">pd</span><span class="op" id="1637000">.</span><span class="ident" id="1637001">wg</span>&nbsp;<span class="op" id="1637004">!=</span>&nbsp;<span class="ident" id="1637007">pdReady</span>&nbsp;<span class="op" id="1637015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637019">gothrow</span><span class="op" id="1637026">(</span><span class="string" id="1637027">&#34;netpollOpen:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1637074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637080">if</span>&nbsp;<span class="ident" id="1637083">pd</span><span class="op" id="1637085">.</span><span class="ident" id="1637086">rg</span>&nbsp;<span class="op" id="1637089">!=</span>&nbsp;<span class="num" id="1637092">0</span>&nbsp;<span class="op" id="1637094">&amp;&amp;</span>&nbsp;<span class="ident" id="1637097">pd</span><span class="op" id="1637099">.</span><span class="ident" id="1637100">rg</span>&nbsp;<span class="op" id="1637103">!=</span>&nbsp;<span class="ident" id="1637106">pdReady</span>&nbsp;<span class="op" id="1637114">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637118">gothrow</span><span class="op" id="1637125">(</span><span class="string" id="1637126">&#34;netpollOpen:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1637172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637178">pd</span><span class="op" id="1637180">.</span><span class="ident" id="1637181">fd</span>&nbsp;<span class="op" id="1637184">=</span>&nbsp;<span class="ident" id="1637186">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637190">pd</span><span class="op" id="1637192">.</span><span class="ident" id="1637193">closing</span>&nbsp;<span class="op" id="1637201">=</span>&nbsp;<span class="builtintype" id="1637203">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637210">pd</span><span class="op" id="1637212">.</span><span class="ident" id="1637213">seq</span><span class="op" id="1637216">++</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637220">pd</span><span class="op" id="1637222">.</span><span class="ident" id="1637223">rg</span>&nbsp;<span class="op" id="1637226">=</span>&nbsp;<span class="num" id="1637228">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637231">pd</span><span class="op" id="1637233">.</span><span class="ident" id="1637234">rd</span>&nbsp;<span class="op" id="1637237">=</span>&nbsp;<span class="num" id="1637239">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637242">pd</span><span class="op" id="1637244">.</span><span class="ident" id="1637245">wg</span>&nbsp;<span class="op" id="1637248">=</span>&nbsp;<span class="num" id="1637250">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637253">pd</span><span class="op" id="1637255">.</span><span class="ident" id="1637256">wd</span>&nbsp;<span class="op" id="1637259">=</span>&nbsp;<span class="num" id="1637261">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637264">unlock</span><span class="op" id="1637270">(</span><span class="op" id="1637271">&amp;</span><span class="ident" id="1637272">pd</span><span class="op" id="1637274">.</span><span class="ident" id="1637275">lock</span><span class="op" id="1637279">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637283">var</span>&nbsp;<span class="ident" id="1637287">errno</span>&nbsp;<span class="builtintype" id="1637293">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637300">onM</span><span class="op" id="1637303">(</span><span class="keyword" id="1637304">func</span><span class="op" id="1637308">(</span><span class="op" id="1637309">)</span>&nbsp;<span class="op" id="1637311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637315">errno</span>&nbsp;<span class="op" id="1637321">=</span>&nbsp;<span class="ident" id="1637323">netpollopen</span><span class="op" id="1637334">(</span><span class="ident" id="1637335">fd</span><span class="op" id="1637337">,</span>&nbsp;<span class="ident" id="1637339">pd</span><span class="op" id="1637341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637344">}</span><span class="op" id="1637345">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637348">return</span>&nbsp;<span class="ident" id="1637355">pd</span><span class="op" id="1637357">,</span>&nbsp;<span class="builtintype" id="1637359">int</span><span class="op" id="1637362">(</span><span class="ident" id="1637363">errno</span><span class="op" id="1637368">)</span><br>
<span class="lineno"></span><span class="op" id="1637370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1637373">func</span>&nbsp;<span class="ident" id="1637378">netpollClose</span><span class="op" id="1637390">(</span><span class="ident" id="1637391">pd</span>&nbsp;<span class="op" id="1637394">*</span><span class="ident" id="1637395">pollDesc</span><span class="op" id="1637403">)</span>&nbsp;<span class="op" id="1637405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637408">if</span>&nbsp;<span class="op" id="1637411">!</span><span class="ident" id="1637412">pd</span><span class="op" id="1637414">.</span><span class="ident" id="1637415">closing</span>&nbsp;<span class="op" id="1637423">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637427">gothrow</span><span class="op" id="1637434">(</span><span class="string" id="1637435">&#34;netpollClose:&nbsp;close&nbsp;w/o&nbsp;unblock&#34;</span><span class="op" id="1637468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637474">if</span>&nbsp;<span class="ident" id="1637477">pd</span><span class="op" id="1637479">.</span><span class="ident" id="1637480">wg</span>&nbsp;<span class="op" id="1637483">!=</span>&nbsp;<span class="num" id="1637486">0</span>&nbsp;<span class="op" id="1637488">&amp;&amp;</span>&nbsp;<span class="ident" id="1637491">pd</span><span class="op" id="1637493">.</span><span class="ident" id="1637494">wg</span>&nbsp;<span class="op" id="1637497">!=</span>&nbsp;<span class="ident" id="1637500">pdReady</span>&nbsp;<span class="op" id="1637508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637512">gothrow</span><span class="op" id="1637519">(</span><span class="string" id="1637520">&#34;netpollClose:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1637571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637574">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637577">if</span>&nbsp;<span class="ident" id="1637580">pd</span><span class="op" id="1637582">.</span><span class="ident" id="1637583">rg</span>&nbsp;<span class="op" id="1637586">!=</span>&nbsp;<span class="num" id="1637589">0</span>&nbsp;<span class="op" id="1637591">&amp;&amp;</span>&nbsp;<span class="ident" id="1637594">pd</span><span class="op" id="1637596">.</span><span class="ident" id="1637597">rg</span>&nbsp;<span class="op" id="1637600">!=</span>&nbsp;<span class="ident" id="1637603">pdReady</span>&nbsp;<span class="op" id="1637611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637615">gothrow</span><span class="op" id="1637622">(</span><span class="string" id="1637623">&#34;netpollClose:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1637673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637679">onM</span><span class="op" id="1637682">(</span><span class="keyword" id="1637683">func</span><span class="op" id="1637687">(</span><span class="op" id="1637688">)</span>&nbsp;<span class="op" id="1637690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637694">netpollclose</span><span class="op" id="1637706">(</span><span class="builtintype" id="1637707">uintptr</span><span class="op" id="1637714">(</span><span class="ident" id="1637715">pd</span><span class="op" id="1637717">.</span><span class="ident" id="1637718">fd</span><span class="op" id="1637720">)</span><span class="op" id="1637721">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637724">}</span><span class="op" id="1637725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637728">pollcache</span><span class="op" id="1637737">.</span><span class="ident" id="1637738">free</span><span class="op" id="1637742">(</span><span class="ident" id="1637743">pd</span><span class="op" id="1637745">)</span><br>
<span class="lineno"></span><span class="op" id="1637747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1637750">func</span>&nbsp;<span class="op" id="1637755">(</span><span class="ident" id="1637756">c</span>&nbsp;<span class="op" id="1637758">*</span><span class="ident" id="1637759">pollCache</span><span class="op" id="1637768">)</span>&nbsp;<span class="ident" id="1637770">free</span><span class="op" id="1637774">(</span><span class="ident" id="1637775">pd</span>&nbsp;<span class="op" id="1637778">*</span><span class="ident" id="1637779">pollDesc</span><span class="op" id="1637787">)</span>&nbsp;<span class="op" id="1637789">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637792">lock</span><span class="op" id="1637796">(</span><span class="op" id="1637797">&amp;</span><span class="ident" id="1637798">c</span><span class="op" id="1637799">.</span><span class="ident" id="1637800">lock</span><span class="op" id="1637804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637807">pd</span><span class="op" id="1637809">.</span><span class="ident" id="1637810">link</span>&nbsp;<span class="op" id="1637815">=</span>&nbsp;<span class="ident" id="1637817">c</span><span class="op" id="1637818">.</span><span class="ident" id="1637819">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637826">c</span><span class="op" id="1637827">.</span><span class="ident" id="1637828">first</span>&nbsp;<span class="op" id="1637834">=</span>&nbsp;<span class="ident" id="1637836">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637840">unlock</span><span class="op" id="1637846">(</span><span class="op" id="1637847">&amp;</span><span class="ident" id="1637848">c</span><span class="op" id="1637849">.</span><span class="ident" id="1637850">lock</span><span class="op" id="1637854">)</span><br>
<span class="lineno"></span><span class="op" id="1637856">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1637859">func</span>&nbsp;<span class="ident" id="1637864">netpollReset</span><span class="op" id="1637876">(</span><span class="ident" id="1637877">pd</span>&nbsp;<span class="op" id="1637880">*</span><span class="ident" id="1637881">pollDesc</span><span class="op" id="1637889">,</span>&nbsp;<span class="ident" id="1637891">mode</span>&nbsp;<span class="builtintype" id="1637896">int</span><span class="op" id="1637899">)</span>&nbsp;<span class="builtintype" id="1637901">int</span>&nbsp;<span class="op" id="1637905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637908">err</span>&nbsp;<span class="op" id="1637912">:=</span>&nbsp;<span class="ident" id="1637915">netpollcheckerr</span><span class="op" id="1637930">(</span><span class="ident" id="1637931">pd</span><span class="op" id="1637933">,</span>&nbsp;<span class="builtintype" id="1637935">int32</span><span class="op" id="1637940">(</span><span class="ident" id="1637941">mode</span><span class="op" id="1637945">)</span><span class="op" id="1637946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637949">if</span>&nbsp;<span class="ident" id="1637952">err</span>&nbsp;<span class="op" id="1637956">!=</span>&nbsp;<span class="num" id="1637959">0</span>&nbsp;<span class="op" id="1637961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637965">return</span>&nbsp;<span class="ident" id="1637972">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1637977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1637980">if</span>&nbsp;<span class="ident" id="1637983">mode</span>&nbsp;<span class="op" id="1637988">==</span>&nbsp;<span class="string" id="1637991">&#39;r&#39;</span>&nbsp;<span class="op" id="1637995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1637999">pd</span><span class="op" id="1638001">.</span><span class="ident" id="1638002">rg</span>&nbsp;<span class="op" id="1638005">=</span>&nbsp;<span class="num" id="1638007">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638010">}</span>&nbsp;<span class="keyword" id="1638012">else</span>&nbsp;<span class="keyword" id="1638017">if</span>&nbsp;<span class="ident" id="1638020">mode</span>&nbsp;<span class="op" id="1638025">==</span>&nbsp;<span class="string" id="1638028">&#39;w&#39;</span>&nbsp;<span class="op" id="1638032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638036">pd</span><span class="op" id="1638038">.</span><span class="ident" id="1638039">wg</span>&nbsp;<span class="op" id="1638042">=</span>&nbsp;<span class="num" id="1638044">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638050">return</span>&nbsp;<span class="num" id="1638057">0</span><br>
<span class="lineno"></span><span class="op" id="1638059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1638062">func</span>&nbsp;<span class="ident" id="1638067">netpollWait</span><span class="op" id="1638078">(</span><span class="ident" id="1638079">pd</span>&nbsp;<span class="op" id="1638082">*</span><span class="ident" id="1638083">pollDesc</span><span class="op" id="1638091">,</span>&nbsp;<span class="ident" id="1638093">mode</span>&nbsp;<span class="builtintype" id="1638098">int</span><span class="op" id="1638101">)</span>&nbsp;<span class="builtintype" id="1638103">int</span>&nbsp;<span class="op" id="1638107">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638110">err</span>&nbsp;<span class="op" id="1638114">:=</span>&nbsp;<span class="ident" id="1638117">netpollcheckerr</span><span class="op" id="1638132">(</span><span class="ident" id="1638133">pd</span><span class="op" id="1638135">,</span>&nbsp;<span class="builtintype" id="1638137">int32</span><span class="op" id="1638142">(</span><span class="ident" id="1638143">mode</span><span class="op" id="1638147">)</span><span class="op" id="1638148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638151">if</span>&nbsp;<span class="ident" id="1638154">err</span>&nbsp;<span class="op" id="1638158">!=</span>&nbsp;<span class="num" id="1638161">0</span>&nbsp;<span class="op" id="1638163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638167">return</span>&nbsp;<span class="ident" id="1638174">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1638182">//&nbsp;As&nbsp;for&nbsp;now&nbsp;only&nbsp;Solaris&nbsp;uses&nbsp;level-triggered&nbsp;IO.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638235">if</span>&nbsp;<span class="ident" id="1638238">GOOS</span>&nbsp;<span class="op" id="1638243">==</span>&nbsp;<span class="string" id="1638246">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1638256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638260">onM</span><span class="op" id="1638263">(</span><span class="keyword" id="1638264">func</span><span class="op" id="1638268">(</span><span class="op" id="1638269">)</span>&nbsp;<span class="op" id="1638271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638276">netpollarm</span><span class="op" id="1638286">(</span><span class="ident" id="1638287">pd</span><span class="op" id="1638289">,</span>&nbsp;<span class="ident" id="1638291">mode</span><span class="op" id="1638295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638299">}</span><span class="op" id="1638300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638303">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638306">for</span>&nbsp;<span class="op" id="1638310">!</span><span class="ident" id="1638311">netpollblock</span><span class="op" id="1638323">(</span><span class="ident" id="1638324">pd</span><span class="op" id="1638326">,</span>&nbsp;<span class="builtintype" id="1638328">int32</span><span class="op" id="1638333">(</span><span class="ident" id="1638334">mode</span><span class="op" id="1638338">)</span><span class="op" id="1638339">,</span>&nbsp;<span class="builtintype" id="1638341">false</span><span class="op" id="1638346">)</span>&nbsp;<span class="op" id="1638348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638352">err</span>&nbsp;<span class="op" id="1638356">=</span>&nbsp;<span class="ident" id="1638358">netpollcheckerr</span><span class="op" id="1638373">(</span><span class="ident" id="1638374">pd</span><span class="op" id="1638376">,</span>&nbsp;<span class="builtintype" id="1638378">int32</span><span class="op" id="1638383">(</span><span class="ident" id="1638384">mode</span><span class="op" id="1638388">)</span><span class="op" id="1638389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638393">if</span>&nbsp;<span class="ident" id="1638396">err</span>&nbsp;<span class="op" id="1638400">!=</span>&nbsp;<span class="num" id="1638403">0</span>&nbsp;<span class="op" id="1638405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638410">return</span>&nbsp;<span class="ident" id="1638417">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638423">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1638427">//&nbsp;Can&nbsp;happen&nbsp;if&nbsp;timeout&nbsp;has&nbsp;fired&nbsp;and&nbsp;unblocked&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1638482">//&nbsp;but&nbsp;before&nbsp;we&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;run,&nbsp;timeout&nbsp;has&nbsp;been&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1638546">//&nbsp;Pretend&nbsp;it&nbsp;has&nbsp;not&nbsp;happened&nbsp;and&nbsp;retry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638592">return</span>&nbsp;<span class="num" id="1638599">0</span><br>
<span class="lineno">160</span><span class="op" id="1638601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1638604">func</span>&nbsp;<span class="ident" id="1638609">netpollWaitCanceled</span><span class="op" id="1638628">(</span><span class="ident" id="1638629">pd</span>&nbsp;<span class="op" id="1638632">*</span><span class="ident" id="1638633">pollDesc</span><span class="op" id="1638641">,</span>&nbsp;<span class="ident" id="1638643">mode</span>&nbsp;<span class="builtintype" id="1638648">int</span><span class="op" id="1638651">)</span>&nbsp;<span class="op" id="1638653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1638656">//&nbsp;This&nbsp;function&nbsp;is&nbsp;used&nbsp;only&nbsp;on&nbsp;windows&nbsp;after&nbsp;a&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;cancel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1638731">//&nbsp;a&nbsp;pending&nbsp;async&nbsp;IO&nbsp;operation.&nbsp;Wait&nbsp;for&nbsp;ioready,&nbsp;ignore&nbsp;closing&nbsp;or&nbsp;timeouts.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638811">for</span>&nbsp;<span class="op" id="1638815">!</span><span class="ident" id="1638816">netpollblock</span><span class="op" id="1638828">(</span><span class="ident" id="1638829">pd</span><span class="op" id="1638831">,</span>&nbsp;<span class="builtintype" id="1638833">int32</span><span class="op" id="1638838">(</span><span class="ident" id="1638839">mode</span><span class="op" id="1638843">)</span><span class="op" id="1638844">,</span>&nbsp;<span class="builtintype" id="1638846">true</span><span class="op" id="1638850">)</span>&nbsp;<span class="op" id="1638852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638855">}</span><br>
<span class="lineno"></span><span class="op" id="1638857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1638860">func</span>&nbsp;<span class="ident" id="1638865">netpollSetDeadline</span><span class="op" id="1638883">(</span><span class="ident" id="1638884">pd</span>&nbsp;<span class="op" id="1638887">*</span><span class="ident" id="1638888">pollDesc</span><span class="op" id="1638896">,</span>&nbsp;<span class="ident" id="1638898">d</span>&nbsp;<span class="ident" id="1638900">int64</span><span class="op" id="1638905">,</span>&nbsp;<span class="ident" id="1638907">mode</span>&nbsp;<span class="builtintype" id="1638912">int</span><span class="op" id="1638915">)</span>&nbsp;<span class="op" id="1638917">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638920">lock</span><span class="op" id="1638924">(</span><span class="op" id="1638925">&amp;</span><span class="ident" id="1638926">pd</span><span class="op" id="1638928">.</span><span class="ident" id="1638929">lock</span><span class="op" id="1638933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638936">if</span>&nbsp;<span class="ident" id="1638939">pd</span><span class="op" id="1638941">.</span><span class="ident" id="1638942">closing</span>&nbsp;<span class="op" id="1638950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638954">unlock</span><span class="op" id="1638960">(</span><span class="op" id="1638961">&amp;</span><span class="ident" id="1638962">pd</span><span class="op" id="1638964">.</span><span class="ident" id="1638965">lock</span><span class="op" id="1638969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1638973">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1638981">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1638984">pd</span><span class="op" id="1638986">.</span><span class="ident" id="1638987">seq</span><span class="op" id="1638990">++</span>&nbsp;<span class="comment" id="1638993">//&nbsp;invalidate&nbsp;current&nbsp;timers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1639023">//&nbsp;Reset&nbsp;current&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1639049">if</span>&nbsp;<span class="ident" id="1639052">pd</span><span class="op" id="1639054">.</span><span class="ident" id="1639055">rt</span><span class="op" id="1639057">.</span><span class="ident" id="1639058">f</span>&nbsp;<span class="op" id="1639060">!=</span>&nbsp;<span class="ident" id="1639063">nil</span>&nbsp;<span class="op" id="1639067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639071">deltimer</span><span class="op" id="1639079">(</span><span class="op" id="1639080">&amp;</span><span class="ident" id="1639081">pd</span><span class="op" id="1639083">.</span><span class="ident" id="1639084">rt</span><span class="op" id="1639086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639090">pd</span><span class="op" id="1639092">.</span><span class="ident" id="1639093">rt</span><span class="op" id="1639095">.</span><span class="ident" id="1639096">f</span>&nbsp;<span class="op" id="1639098">=</span>&nbsp;<span class="ident" id="1639100">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1639105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1639108">if</span>&nbsp;<span class="ident" id="1639111">pd</span><span class="op" id="1639113">.</span><span class="ident" id="1639114">wt</span><span class="op" id="1639116">.</span><span class="ident" id="1639117">f</span>&nbsp;<span class="op" id="1639119">!=</span>&nbsp;<span class="ident" id="1639122">nil</span>&nbsp;<span class="op" id="1639126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639130">deltimer</span><span class="op" id="1639138">(</span><span class="op" id="1639139">&amp;</span><span class="ident" id="1639140">pd</span><span class="op" id="1639142">.</span><span class="ident" id="1639143">wt</span><span class="op" id="1639145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639149">pd</span><span class="op" id="1639151">.</span><span class="ident" id="1639152">wt</span><span class="op" id="1639154">.</span><span class="ident" id="1639155">f</span>&nbsp;<span class="op" id="1639157">=</span>&nbsp;<span class="ident" id="1639159">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1639164">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1639167">//&nbsp;Setup&nbsp;new&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1639189">if</span>&nbsp;<span class="ident" id="1639192">d</span>&nbsp;<span class="op" id="1639194">!=</span>&nbsp;<span class="num" id="1639197">0</span>&nbsp;<span class="op" id="1639199">&amp;&amp;</span>&nbsp;<span class="ident" id="1639202">d</span>&nbsp;<span class="op" id="1639204">&lt;=</span>&nbsp;<span class="ident" id="1639207">nanotime</span><span class="op" id="1639215">(</span><span class="op" id="1639216">)</span>&nbsp;<span class="op" id="1639218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639222">d</span>&nbsp;<span class="op" id="1639224">=</span>&nbsp;<span class="op" id="1639226">-</span><span class="num" id="1639227">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1639230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1639233">if</span>&nbsp;<span class="ident" id="1639236">mode</span>&nbsp;<span class="op" id="1639241">==</span>&nbsp;<span class="string" id="1639244">&#39;r&#39;</span>&nbsp;<span class="op" id="1639248">||</span>&nbsp;<span class="ident" id="1639251">mode</span>&nbsp;<span class="op" id="1639256">==</span>&nbsp;<span class="string" id="1639259">&#39;r&#39;</span><span class="op" id="1639262">+</span><span class="string" id="1639263">&#39;w&#39;</span>&nbsp;<span class="op" id="1639267">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639271">pd</span><span class="op" id="1639273">.</span><span class="ident" id="1639274">rd</span>&nbsp;<span class="op" id="1639277">=</span>&nbsp;<span class="ident" id="1639279">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1639282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1639285">if</span>&nbsp;<span class="ident" id="1639288">mode</span>&nbsp;<span class="op" id="1639293">==</span>&nbsp;<span class="string" id="1639296">&#39;w&#39;</span>&nbsp;<span class="op" id="1639300">||</span>&nbsp;<span class="ident" id="1639303">mode</span>&nbsp;<span class="op" id="1639308">==</span>&nbsp;<span class="string" id="1639311">&#39;r&#39;</span><span class="op" id="1639314">+</span><span class="string" id="1639315">&#39;w&#39;</span>&nbsp;<span class="op" id="1639319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639323">pd</span><span class="op" id="1639325">.</span><span class="ident" id="1639326">wd</span>&nbsp;<span class="op" id="1639329">=</span>&nbsp;<span class="ident" id="1639331">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1639334">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1639337">if</span>&nbsp;<span class="ident" id="1639340">pd</span><span class="op" id="1639342">.</span><span class="ident" id="1639343">rd</span>&nbsp;<span class="op" id="1639346">&gt;</span>&nbsp;<span class="num" id="1639348">0</span>&nbsp;<span class="op" id="1639350">&amp;&amp;</span>&nbsp;<span class="ident" id="1639353">pd</span><span class="op" id="1639355">.</span><span class="ident" id="1639356">rd</span>&nbsp;<span class="op" id="1639359">==</span>&nbsp;<span class="ident" id="1639362">pd</span><span class="op" id="1639364">.</span><span class="ident" id="1639365">wd</span>&nbsp;<span class="op" id="1639368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639372">pd</span><span class="op" id="1639374">.</span><span class="ident" id="1639375">rt</span><span class="op" id="1639377">.</span><span class="ident" id="1639378">f</span>&nbsp;<span class="op" id="1639380">=</span>&nbsp;<span class="ident" id="1639382">netpollDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639400">pd</span><span class="op" id="1639402">.</span><span class="ident" id="1639403">rt</span><span class="op" id="1639405">.</span><span class="ident" id="1639406">when</span>&nbsp;<span class="op" id="1639411">=</span>&nbsp;<span class="ident" id="1639413">pd</span><span class="op" id="1639415">.</span><span class="ident" id="1639416">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1639421">//&nbsp;Copy&nbsp;current&nbsp;seq&nbsp;into&nbsp;the&nbsp;timer&nbsp;arg.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1639463">//&nbsp;Timer&nbsp;func&nbsp;will&nbsp;check&nbsp;the&nbsp;seq&nbsp;against&nbsp;current&nbsp;descriptor&nbsp;seq,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1639530">//&nbsp;if&nbsp;they&nbsp;differ&nbsp;the&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639598">pd</span><span class="op" id="1639600">.</span><span class="ident" id="1639601">rt</span><span class="op" id="1639603">.</span><span class="ident" id="1639604">arg</span>&nbsp;<span class="op" id="1639608">=</span>&nbsp;<span class="ident" id="1639610">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639615">pd</span><span class="op" id="1639617">.</span><span class="ident" id="1639618">rt</span><span class="op" id="1639620">.</span><span class="ident" id="1639621">seq</span>&nbsp;<span class="op" id="1639625">=</span>&nbsp;<span class="ident" id="1639627">pd</span><span class="op" id="1639629">.</span><span class="ident" id="1639630">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639636">addtimer</span><span class="op" id="1639644">(</span><span class="op" id="1639645">&amp;</span><span class="ident" id="1639646">pd</span><span class="op" id="1639648">.</span><span class="ident" id="1639649">rt</span><span class="op" id="1639651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1639654">}</span>&nbsp;<span class="keyword" id="1639656">else</span>&nbsp;<span class="op" id="1639661">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1639665">if</span>&nbsp;<span class="ident" id="1639668">pd</span><span class="op" id="1639670">.</span><span class="ident" id="1639671">rd</span>&nbsp;<span class="op" id="1639674">&gt;</span>&nbsp;<span class="num" id="1639676">0</span>&nbsp;<span class="op" id="1639678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639683">pd</span><span class="op" id="1639685">.</span><span class="ident" id="1639686">rt</span><span class="op" id="1639688">.</span><span class="ident" id="1639689">f</span>&nbsp;<span class="op" id="1639691">=</span>&nbsp;<span class="ident" id="1639693">netpollReadDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639716">pd</span><span class="op" id="1639718">.</span><span class="ident" id="1639719">rt</span><span class="op" id="1639721">.</span><span class="ident" id="1639722">when</span>&nbsp;<span class="op" id="1639727">=</span>&nbsp;<span class="ident" id="1639729">pd</span><span class="op" id="1639731">.</span><span class="ident" id="1639732">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639738">pd</span><span class="op" id="1639740">.</span><span class="ident" id="1639741">rt</span><span class="op" id="1639743">.</span><span class="ident" id="1639744">arg</span>&nbsp;<span class="op" id="1639748">=</span>&nbsp;<span class="ident" id="1639750">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639756">pd</span><span class="op" id="1639758">.</span><span class="ident" id="1639759">rt</span><span class="op" id="1639761">.</span><span class="ident" id="1639762">seq</span>&nbsp;<span class="op" id="1639766">=</span>&nbsp;<span class="ident" id="1639768">pd</span><span class="op" id="1639770">.</span><span class="ident" id="1639771">seq</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639778">addtimer</span><span class="op" id="1639786">(</span><span class="op" id="1639787">&amp;</span><span class="ident" id="1639788">pd</span><span class="op" id="1639790">.</span><span class="ident" id="1639791">rt</span><span class="op" id="1639793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1639797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1639801">if</span>&nbsp;<span class="ident" id="1639804">pd</span><span class="op" id="1639806">.</span><span class="ident" id="1639807">wd</span>&nbsp;<span class="op" id="1639810">&gt;</span>&nbsp;<span class="num" id="1639812">0</span>&nbsp;<span class="op" id="1639814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639819">pd</span><span class="op" id="1639821">.</span><span class="ident" id="1639822">wt</span><span class="op" id="1639824">.</span><span class="ident" id="1639825">f</span>&nbsp;<span class="op" id="1639827">=</span>&nbsp;<span class="ident" id="1639829">netpollWriteDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639853">pd</span><span class="op" id="1639855">.</span><span class="ident" id="1639856">wt</span><span class="op" id="1639858">.</span><span class="ident" id="1639859">when</span>&nbsp;<span class="op" id="1639864">=</span>&nbsp;<span class="ident" id="1639866">pd</span><span class="op" id="1639868">.</span><span class="ident" id="1639869">wd</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639875">pd</span><span class="op" id="1639877">.</span><span class="ident" id="1639878">wt</span><span class="op" id="1639880">.</span><span class="ident" id="1639881">arg</span>&nbsp;<span class="op" id="1639885">=</span>&nbsp;<span class="ident" id="1639887">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639893">pd</span><span class="op" id="1639895">.</span><span class="ident" id="1639896">wt</span><span class="op" id="1639898">.</span><span class="ident" id="1639899">seq</span>&nbsp;<span class="op" id="1639903">=</span>&nbsp;<span class="ident" id="1639905">pd</span><span class="op" id="1639907">.</span><span class="ident" id="1639908">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639915">addtimer</span><span class="op" id="1639923">(</span><span class="op" id="1639924">&amp;</span><span class="ident" id="1639925">pd</span><span class="op" id="1639927">.</span><span class="ident" id="1639928">wt</span><span class="op" id="1639930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1639934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1639937">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1639940">//&nbsp;If&nbsp;we&nbsp;set&nbsp;the&nbsp;new&nbsp;deadline&nbsp;in&nbsp;the&nbsp;past,&nbsp;unblock&nbsp;currently&nbsp;pending&nbsp;IO&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640021">var</span>&nbsp;<span class="ident" id="1640025">rg</span><span class="op" id="1640027">,</span>&nbsp;<span class="ident" id="1640029">wg</span>&nbsp;<span class="op" id="1640032">*</span><span class="ident" id="1640033">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640036">atomicstorep</span><span class="op" id="1640048">(</span><span class="ident" id="1640049">unsafe</span><span class="op" id="1640055">.</span><span class="ident" id="1640056">Pointer</span><span class="op" id="1640063">(</span><span class="op" id="1640064">&amp;</span><span class="ident" id="1640065">wg</span><span class="op" id="1640067">)</span><span class="op" id="1640068">,</span>&nbsp;<span class="ident" id="1640070">nil</span><span class="op" id="1640073">)</span>&nbsp;<span class="comment" id="1640075">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;stores&nbsp;to&nbsp;rd/wd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640159">if</span>&nbsp;<span class="ident" id="1640162">pd</span><span class="op" id="1640164">.</span><span class="ident" id="1640165">rd</span>&nbsp;<span class="op" id="1640168">&lt;</span>&nbsp;<span class="num" id="1640170">0</span>&nbsp;<span class="op" id="1640172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640176">rg</span>&nbsp;<span class="op" id="1640179">=</span>&nbsp;<span class="ident" id="1640181">netpollunblock</span><span class="op" id="1640195">(</span><span class="ident" id="1640196">pd</span><span class="op" id="1640198">,</span>&nbsp;<span class="string" id="1640200">&#39;r&#39;</span><span class="op" id="1640203">,</span>&nbsp;<span class="builtintype" id="1640205">false</span><span class="op" id="1640210">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1640213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640216">if</span>&nbsp;<span class="ident" id="1640219">pd</span><span class="op" id="1640221">.</span><span class="ident" id="1640222">wd</span>&nbsp;<span class="op" id="1640225">&lt;</span>&nbsp;<span class="num" id="1640227">0</span>&nbsp;<span class="op" id="1640229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640233">wg</span>&nbsp;<span class="op" id="1640236">=</span>&nbsp;<span class="ident" id="1640238">netpollunblock</span><span class="op" id="1640252">(</span><span class="ident" id="1640253">pd</span><span class="op" id="1640255">,</span>&nbsp;<span class="string" id="1640257">&#39;w&#39;</span><span class="op" id="1640260">,</span>&nbsp;<span class="builtintype" id="1640262">false</span><span class="op" id="1640267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1640270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640273">unlock</span><span class="op" id="1640279">(</span><span class="op" id="1640280">&amp;</span><span class="ident" id="1640281">pd</span><span class="op" id="1640283">.</span><span class="ident" id="1640284">lock</span><span class="op" id="1640288">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640291">if</span>&nbsp;<span class="ident" id="1640294">rg</span>&nbsp;<span class="op" id="1640297">!=</span>&nbsp;<span class="ident" id="1640300">nil</span>&nbsp;<span class="op" id="1640304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640308">goready</span><span class="op" id="1640315">(</span><span class="ident" id="1640316">rg</span><span class="op" id="1640318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1640321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640324">if</span>&nbsp;<span class="ident" id="1640327">wg</span>&nbsp;<span class="op" id="1640330">!=</span>&nbsp;<span class="ident" id="1640333">nil</span>&nbsp;<span class="op" id="1640337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640341">goready</span><span class="op" id="1640348">(</span><span class="ident" id="1640349">wg</span><span class="op" id="1640351">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1640354">}</span><br>
<span class="lineno"></span><span class="op" id="1640356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1640359">func</span>&nbsp;<span class="ident" id="1640364">netpollUnblock</span><span class="op" id="1640378">(</span><span class="ident" id="1640379">pd</span>&nbsp;<span class="op" id="1640382">*</span><span class="ident" id="1640383">pollDesc</span><span class="op" id="1640391">)</span>&nbsp;<span class="op" id="1640393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640396">lock</span><span class="op" id="1640400">(</span><span class="op" id="1640401">&amp;</span><span class="ident" id="1640402">pd</span><span class="op" id="1640404">.</span><span class="ident" id="1640405">lock</span><span class="op" id="1640409">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640412">if</span>&nbsp;<span class="ident" id="1640415">pd</span><span class="op" id="1640417">.</span><span class="ident" id="1640418">closing</span>&nbsp;<span class="op" id="1640426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640430">gothrow</span><span class="op" id="1640437">(</span><span class="string" id="1640438">&#34;netpollUnblock:&nbsp;already&nbsp;closing&#34;</span><span class="op" id="1640471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1640474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640477">pd</span><span class="op" id="1640479">.</span><span class="ident" id="1640480">closing</span>&nbsp;<span class="op" id="1640488">=</span>&nbsp;<span class="builtintype" id="1640490">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640496">pd</span><span class="op" id="1640498">.</span><span class="ident" id="1640499">seq</span><span class="op" id="1640502">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640506">var</span>&nbsp;<span class="ident" id="1640510">rg</span><span class="op" id="1640512">,</span>&nbsp;<span class="ident" id="1640514">wg</span>&nbsp;<span class="op" id="1640517">*</span><span class="ident" id="1640518">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640521">atomicstorep</span><span class="op" id="1640533">(</span><span class="ident" id="1640534">unsafe</span><span class="op" id="1640540">.</span><span class="ident" id="1640541">Pointer</span><span class="op" id="1640548">(</span><span class="op" id="1640549">&amp;</span><span class="ident" id="1640550">rg</span><span class="op" id="1640552">)</span><span class="op" id="1640553">,</span>&nbsp;<span class="ident" id="1640555">nil</span><span class="op" id="1640558">)</span>&nbsp;<span class="comment" id="1640560">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;closing&nbsp;and&nbsp;read&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640645">rg</span>&nbsp;<span class="op" id="1640648">=</span>&nbsp;<span class="ident" id="1640650">netpollunblock</span><span class="op" id="1640664">(</span><span class="ident" id="1640665">pd</span><span class="op" id="1640667">,</span>&nbsp;<span class="string" id="1640669">&#39;r&#39;</span><span class="op" id="1640672">,</span>&nbsp;<span class="builtintype" id="1640674">false</span><span class="op" id="1640679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640682">wg</span>&nbsp;<span class="op" id="1640685">=</span>&nbsp;<span class="ident" id="1640687">netpollunblock</span><span class="op" id="1640701">(</span><span class="ident" id="1640702">pd</span><span class="op" id="1640704">,</span>&nbsp;<span class="string" id="1640706">&#39;w&#39;</span><span class="op" id="1640709">,</span>&nbsp;<span class="builtintype" id="1640711">false</span><span class="op" id="1640716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640719">if</span>&nbsp;<span class="ident" id="1640722">pd</span><span class="op" id="1640724">.</span><span class="ident" id="1640725">rt</span><span class="op" id="1640727">.</span><span class="ident" id="1640728">f</span>&nbsp;<span class="op" id="1640730">!=</span>&nbsp;<span class="ident" id="1640733">nil</span>&nbsp;<span class="op" id="1640737">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640741">deltimer</span><span class="op" id="1640749">(</span><span class="op" id="1640750">&amp;</span><span class="ident" id="1640751">pd</span><span class="op" id="1640753">.</span><span class="ident" id="1640754">rt</span><span class="op" id="1640756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640760">pd</span><span class="op" id="1640762">.</span><span class="ident" id="1640763">rt</span><span class="op" id="1640765">.</span><span class="ident" id="1640766">f</span>&nbsp;<span class="op" id="1640768">=</span>&nbsp;<span class="ident" id="1640770">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1640775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640778">if</span>&nbsp;<span class="ident" id="1640781">pd</span><span class="op" id="1640783">.</span><span class="ident" id="1640784">wt</span><span class="op" id="1640786">.</span><span class="ident" id="1640787">f</span>&nbsp;<span class="op" id="1640789">!=</span>&nbsp;<span class="ident" id="1640792">nil</span>&nbsp;<span class="op" id="1640796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640800">deltimer</span><span class="op" id="1640808">(</span><span class="op" id="1640809">&amp;</span><span class="ident" id="1640810">pd</span><span class="op" id="1640812">.</span><span class="ident" id="1640813">wt</span><span class="op" id="1640815">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640819">pd</span><span class="op" id="1640821">.</span><span class="ident" id="1640822">wt</span><span class="op" id="1640824">.</span><span class="ident" id="1640825">f</span>&nbsp;<span class="op" id="1640827">=</span>&nbsp;<span class="ident" id="1640829">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1640834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640837">unlock</span><span class="op" id="1640843">(</span><span class="op" id="1640844">&amp;</span><span class="ident" id="1640845">pd</span><span class="op" id="1640847">.</span><span class="ident" id="1640848">lock</span><span class="op" id="1640852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640855">if</span>&nbsp;<span class="ident" id="1640858">rg</span>&nbsp;<span class="op" id="1640861">!=</span>&nbsp;<span class="ident" id="1640864">nil</span>&nbsp;<span class="op" id="1640868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640872">goready</span><span class="op" id="1640879">(</span><span class="ident" id="1640880">rg</span><span class="op" id="1640882">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1640885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640888">if</span>&nbsp;<span class="ident" id="1640891">wg</span>&nbsp;<span class="op" id="1640894">!=</span>&nbsp;<span class="ident" id="1640897">nil</span>&nbsp;<span class="op" id="1640901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640905">goready</span><span class="op" id="1640912">(</span><span class="ident" id="1640913">wg</span><span class="op" id="1640915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1640918">}</span><br>
<span class="lineno"></span><span class="op" id="1640920">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1640923">func</span>&nbsp;<span class="ident" id="1640928">netpollfd</span><span class="op" id="1640937">(</span><span class="ident" id="1640938">pd</span>&nbsp;<span class="op" id="1640941">*</span><span class="ident" id="1640942">pollDesc</span><span class="op" id="1640950">)</span>&nbsp;<span class="builtintype" id="1640952">uintptr</span>&nbsp;<span class="op" id="1640960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640963">return</span>&nbsp;<span class="ident" id="1640970">pd</span><span class="op" id="1640972">.</span><span class="ident" id="1640973">fd</span><br>
<span class="lineno"></span><span class="op" id="1640976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1640979">func</span>&nbsp;<span class="ident" id="1640984">netpolluser</span><span class="op" id="1640995">(</span><span class="ident" id="1640996">pd</span>&nbsp;<span class="op" id="1640999">*</span><span class="ident" id="1641000">pollDesc</span><span class="op" id="1641008">)</span>&nbsp;<span class="op" id="1641010">*</span><span class="ident" id="1641011">unsafe</span><span class="op" id="1641017">.</span><span class="ident" id="1641018">Pointer</span>&nbsp;<span class="op" id="1641026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641029">return</span>&nbsp;<span class="op" id="1641036">&amp;</span><span class="ident" id="1641037">pd</span><span class="op" id="1641039">.</span><span class="ident" id="1641040">user</span><br>
<span class="lineno"></span><span class="op" id="1641045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1641048">func</span>&nbsp;<span class="ident" id="1641053">netpollclosing</span><span class="op" id="1641067">(</span><span class="ident" id="1641068">pd</span>&nbsp;<span class="op" id="1641071">*</span><span class="ident" id="1641072">pollDesc</span><span class="op" id="1641080">)</span>&nbsp;<span class="builtintype" id="1641082">bool</span>&nbsp;<span class="op" id="1641087">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641090">return</span>&nbsp;<span class="ident" id="1641097">pd</span><span class="op" id="1641099">.</span><span class="ident" id="1641100">closing</span><br>
<span class="lineno"></span><span class="op" id="1641108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1641111">func</span>&nbsp;<span class="ident" id="1641116">netpolllock</span><span class="op" id="1641127">(</span><span class="ident" id="1641128">pd</span>&nbsp;<span class="op" id="1641131">*</span><span class="ident" id="1641132">pollDesc</span><span class="op" id="1641140">)</span>&nbsp;<span class="op" id="1641142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1641145">lock</span><span class="op" id="1641149">(</span><span class="op" id="1641150">&amp;</span><span class="ident" id="1641151">pd</span><span class="op" id="1641153">.</span><span class="ident" id="1641154">lock</span><span class="op" id="1641158">)</span><br>
<span class="lineno">280</span><span class="op" id="1641160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1641163">func</span>&nbsp;<span class="ident" id="1641168">netpollunlock</span><span class="op" id="1641181">(</span><span class="ident" id="1641182">pd</span>&nbsp;<span class="op" id="1641185">*</span><span class="ident" id="1641186">pollDesc</span><span class="op" id="1641194">)</span>&nbsp;<span class="op" id="1641196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1641199">unlock</span><span class="op" id="1641205">(</span><span class="op" id="1641206">&amp;</span><span class="ident" id="1641207">pd</span><span class="op" id="1641209">.</span><span class="ident" id="1641210">lock</span><span class="op" id="1641214">)</span><br>
<span class="lineno"></span><span class="op" id="1641216">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="1641219">//&nbsp;make&nbsp;pd&nbsp;ready,&nbsp;newly&nbsp;runnable&nbsp;goroutines&nbsp;(if&nbsp;any)&nbsp;are&nbsp;returned&nbsp;in&nbsp;rg/wg</span><br>
<span class="lineno"></span><span class="keyword" id="1641294">func</span>&nbsp;<span class="ident" id="1641299">netpollready</span><span class="op" id="1641311">(</span><span class="ident" id="1641312">gpp</span>&nbsp;<span class="op" id="1641316">*</span><span class="op" id="1641317">*</span><span class="ident" id="1641318">g</span><span class="op" id="1641319">,</span>&nbsp;<span class="ident" id="1641321">pd</span>&nbsp;<span class="op" id="1641324">*</span><span class="ident" id="1641325">pollDesc</span><span class="op" id="1641333">,</span>&nbsp;<span class="ident" id="1641335">mode</span>&nbsp;<span class="builtintype" id="1641340">int32</span><span class="op" id="1641345">)</span>&nbsp;<span class="op" id="1641347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641350">var</span>&nbsp;<span class="ident" id="1641354">rg</span><span class="op" id="1641356">,</span>&nbsp;<span class="ident" id="1641358">wg</span>&nbsp;<span class="op" id="1641361">*</span><span class="ident" id="1641362">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641365">if</span>&nbsp;<span class="ident" id="1641368">mode</span>&nbsp;<span class="op" id="1641373">==</span>&nbsp;<span class="string" id="1641376">&#39;r&#39;</span>&nbsp;<span class="op" id="1641380">||</span>&nbsp;<span class="ident" id="1641383">mode</span>&nbsp;<span class="op" id="1641388">==</span>&nbsp;<span class="string" id="1641391">&#39;r&#39;</span><span class="op" id="1641394">+</span><span class="string" id="1641395">&#39;w&#39;</span>&nbsp;<span class="op" id="1641399">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1641403">rg</span>&nbsp;<span class="op" id="1641406">=</span>&nbsp;<span class="ident" id="1641408">netpollunblock</span><span class="op" id="1641422">(</span><span class="ident" id="1641423">pd</span><span class="op" id="1641425">,</span>&nbsp;<span class="string" id="1641427">&#39;r&#39;</span><span class="op" id="1641430">,</span>&nbsp;<span class="builtintype" id="1641432">true</span><span class="op" id="1641436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1641439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641442">if</span>&nbsp;<span class="ident" id="1641445">mode</span>&nbsp;<span class="op" id="1641450">==</span>&nbsp;<span class="string" id="1641453">&#39;w&#39;</span>&nbsp;<span class="op" id="1641457">||</span>&nbsp;<span class="ident" id="1641460">mode</span>&nbsp;<span class="op" id="1641465">==</span>&nbsp;<span class="string" id="1641468">&#39;r&#39;</span><span class="op" id="1641471">+</span><span class="string" id="1641472">&#39;w&#39;</span>&nbsp;<span class="op" id="1641476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1641480">wg</span>&nbsp;<span class="op" id="1641483">=</span>&nbsp;<span class="ident" id="1641485">netpollunblock</span><span class="op" id="1641499">(</span><span class="ident" id="1641500">pd</span><span class="op" id="1641502">,</span>&nbsp;<span class="string" id="1641504">&#39;w&#39;</span><span class="op" id="1641507">,</span>&nbsp;<span class="builtintype" id="1641509">true</span><span class="op" id="1641513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1641516">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641519">if</span>&nbsp;<span class="ident" id="1641522">rg</span>&nbsp;<span class="op" id="1641525">!=</span>&nbsp;<span class="ident" id="1641528">nil</span>&nbsp;<span class="op" id="1641532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1641536">rg</span><span class="op" id="1641538">.</span><span class="ident" id="1641539">schedlink</span>&nbsp;<span class="op" id="1641549">=</span>&nbsp;<span class="op" id="1641551">*</span><span class="ident" id="1641552">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1641558">*</span><span class="ident" id="1641559">gpp</span>&nbsp;<span class="op" id="1641563">=</span>&nbsp;<span class="ident" id="1641565">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1641569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641572">if</span>&nbsp;<span class="ident" id="1641575">wg</span>&nbsp;<span class="op" id="1641578">!=</span>&nbsp;<span class="ident" id="1641581">nil</span>&nbsp;<span class="op" id="1641585">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1641589">wg</span><span class="op" id="1641591">.</span><span class="ident" id="1641592">schedlink</span>&nbsp;<span class="op" id="1641602">=</span>&nbsp;<span class="op" id="1641604">*</span><span class="ident" id="1641605">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1641611">*</span><span class="ident" id="1641612">gpp</span>&nbsp;<span class="op" id="1641616">=</span>&nbsp;<span class="ident" id="1641618">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1641622">}</span><br>
<span class="lineno"></span><span class="op" id="1641624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="keyword" id="1641627">func</span>&nbsp;<span class="ident" id="1641632">netpollcheckerr</span><span class="op" id="1641647">(</span><span class="ident" id="1641648">pd</span>&nbsp;<span class="op" id="1641651">*</span><span class="ident" id="1641652">pollDesc</span><span class="op" id="1641660">,</span>&nbsp;<span class="ident" id="1641662">mode</span>&nbsp;<span class="builtintype" id="1641667">int32</span><span class="op" id="1641672">)</span>&nbsp;<span class="builtintype" id="1641674">int</span>&nbsp;<span class="op" id="1641678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641681">if</span>&nbsp;<span class="ident" id="1641684">pd</span><span class="op" id="1641686">.</span><span class="ident" id="1641687">closing</span>&nbsp;<span class="op" id="1641695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641699">return</span>&nbsp;<span class="num" id="1641706">1</span>&nbsp;<span class="comment" id="1641708">//&nbsp;errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1641723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641726">if</span>&nbsp;<span class="op" id="1641729">(</span><span class="ident" id="1641730">mode</span>&nbsp;<span class="op" id="1641735">==</span>&nbsp;<span class="string" id="1641738">&#39;r&#39;</span>&nbsp;<span class="op" id="1641742">&amp;&amp;</span>&nbsp;<span class="ident" id="1641745">pd</span><span class="op" id="1641747">.</span><span class="ident" id="1641748">rd</span>&nbsp;<span class="op" id="1641751">&lt;</span>&nbsp;<span class="num" id="1641753">0</span><span class="op" id="1641754">)</span>&nbsp;<span class="op" id="1641756">||</span>&nbsp;<span class="op" id="1641759">(</span><span class="ident" id="1641760">mode</span>&nbsp;<span class="op" id="1641765">==</span>&nbsp;<span class="string" id="1641768">&#39;w&#39;</span>&nbsp;<span class="op" id="1641772">&amp;&amp;</span>&nbsp;<span class="ident" id="1641775">pd</span><span class="op" id="1641777">.</span><span class="ident" id="1641778">wd</span>&nbsp;<span class="op" id="1641781">&lt;</span>&nbsp;<span class="num" id="1641783">0</span><span class="op" id="1641784">)</span>&nbsp;<span class="op" id="1641786">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641790">return</span>&nbsp;<span class="num" id="1641797">2</span>&nbsp;<span class="comment" id="1641799">//&nbsp;errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1641814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641817">return</span>&nbsp;<span class="num" id="1641824">0</span><br>
<span class="lineno"></span><span class="op" id="1641826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="keyword" id="1641829">func</span>&nbsp;<span class="ident" id="1641834">netpollblockcommit</span><span class="op" id="1641852">(</span><span class="ident" id="1641853">gp</span>&nbsp;<span class="op" id="1641856">*</span><span class="ident" id="1641857">g</span><span class="op" id="1641858">,</span>&nbsp;<span class="ident" id="1641860">gpp</span>&nbsp;<span class="ident" id="1641864">unsafe</span><span class="op" id="1641870">.</span><span class="ident" id="1641871">Pointer</span><span class="op" id="1641878">)</span>&nbsp;<span class="builtintype" id="1641880">bool</span>&nbsp;<span class="op" id="1641885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641888">return</span>&nbsp;<span class="ident" id="1641895">casuintptr</span><span class="op" id="1641905">(</span><span class="op" id="1641906">(</span><span class="op" id="1641907">*</span><span class="builtintype" id="1641908">uintptr</span><span class="op" id="1641915">)</span><span class="op" id="1641916">(</span><span class="ident" id="1641917">gpp</span><span class="op" id="1641920">)</span><span class="op" id="1641921">,</span>&nbsp;<span class="ident" id="1641923">pdWait</span><span class="op" id="1641929">,</span>&nbsp;<span class="builtintype" id="1641931">uintptr</span><span class="op" id="1641938">(</span><span class="ident" id="1641939">unsafe</span><span class="op" id="1641945">.</span><span class="ident" id="1641946">Pointer</span><span class="op" id="1641953">(</span><span class="ident" id="1641954">gp</span><span class="op" id="1641956">)</span><span class="op" id="1641957">)</span><span class="op" id="1641958">)</span><br>
<span class="lineno"></span><span class="op" id="1641960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1641963">//&nbsp;returns&nbsp;true&nbsp;if&nbsp;IO&nbsp;is&nbsp;ready,&nbsp;or&nbsp;false&nbsp;if&nbsp;timedout&nbsp;or&nbsp;closed</span><br>
<span class="lineno">320</span><span class="comment" id="1642026">//&nbsp;waitio&nbsp;-&nbsp;wait&nbsp;only&nbsp;for&nbsp;completed&nbsp;IO,&nbsp;ignore&nbsp;errors</span><br>
<span class="lineno"></span><span class="keyword" id="1642080">func</span>&nbsp;<span class="ident" id="1642085">netpollblock</span><span class="op" id="1642097">(</span><span class="ident" id="1642098">pd</span>&nbsp;<span class="op" id="1642101">*</span><span class="ident" id="1642102">pollDesc</span><span class="op" id="1642110">,</span>&nbsp;<span class="ident" id="1642112">mode</span>&nbsp;<span class="builtintype" id="1642117">int32</span><span class="op" id="1642122">,</span>&nbsp;<span class="ident" id="1642124">waitio</span>&nbsp;<span class="builtintype" id="1642131">bool</span><span class="op" id="1642135">)</span>&nbsp;<span class="builtintype" id="1642137">bool</span>&nbsp;<span class="op" id="1642142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642145">gpp</span>&nbsp;<span class="op" id="1642149">:=</span>&nbsp;<span class="op" id="1642152">&amp;</span><span class="ident" id="1642153">pd</span><span class="op" id="1642155">.</span><span class="ident" id="1642156">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642160">if</span>&nbsp;<span class="ident" id="1642163">mode</span>&nbsp;<span class="op" id="1642168">==</span>&nbsp;<span class="string" id="1642171">&#39;w&#39;</span>&nbsp;<span class="op" id="1642175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642179">gpp</span>&nbsp;<span class="op" id="1642183">=</span>&nbsp;<span class="op" id="1642185">&amp;</span><span class="ident" id="1642186">pd</span><span class="op" id="1642188">.</span><span class="ident" id="1642189">wg</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1642197">//&nbsp;set&nbsp;the&nbsp;gpp&nbsp;semaphore&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642231">for</span>&nbsp;<span class="op" id="1642235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642239">old</span>&nbsp;<span class="op" id="1642243">:=</span>&nbsp;<span class="op" id="1642246">*</span><span class="ident" id="1642247">gpp</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642253">if</span>&nbsp;<span class="ident" id="1642256">old</span>&nbsp;<span class="op" id="1642260">==</span>&nbsp;<span class="ident" id="1642263">pdReady</span>&nbsp;<span class="op" id="1642271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642276">*</span><span class="ident" id="1642277">gpp</span>&nbsp;<span class="op" id="1642281">=</span>&nbsp;<span class="num" id="1642283">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642288">return</span>&nbsp;<span class="builtintype" id="1642295">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642306">if</span>&nbsp;<span class="ident" id="1642309">old</span>&nbsp;<span class="op" id="1642313">!=</span>&nbsp;<span class="num" id="1642316">0</span>&nbsp;<span class="op" id="1642318">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642323">gothrow</span><span class="op" id="1642330">(</span><span class="string" id="1642331">&#34;netpollblock:&nbsp;double&nbsp;wait&#34;</span><span class="op" id="1642358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642366">if</span>&nbsp;<span class="ident" id="1642369">casuintptr</span><span class="op" id="1642379">(</span><span class="ident" id="1642380">gpp</span><span class="op" id="1642383">,</span>&nbsp;<span class="num" id="1642385">0</span><span class="op" id="1642386">,</span>&nbsp;<span class="ident" id="1642388">pdWait</span><span class="op" id="1642394">)</span>&nbsp;<span class="op" id="1642396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642401">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642409">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1642416">//&nbsp;need&nbsp;to&nbsp;recheck&nbsp;error&nbsp;states&nbsp;after&nbsp;setting&nbsp;gpp&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1642475">//&nbsp;this&nbsp;is&nbsp;necessary&nbsp;because&nbsp;runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1642562">//&nbsp;do&nbsp;the&nbsp;opposite:&nbsp;store&nbsp;to&nbsp;closing/rd/wd,&nbsp;membarrier,&nbsp;load&nbsp;of&nbsp;rg/wg</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642633">if</span>&nbsp;<span class="ident" id="1642636">waitio</span>&nbsp;<span class="op" id="1642643">||</span>&nbsp;<span class="ident" id="1642646">netpollcheckerr</span><span class="op" id="1642661">(</span><span class="ident" id="1642662">pd</span><span class="op" id="1642664">,</span>&nbsp;<span class="ident" id="1642666">mode</span><span class="op" id="1642670">)</span>&nbsp;<span class="op" id="1642672">==</span>&nbsp;<span class="num" id="1642675">0</span>&nbsp;<span class="op" id="1642677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642681">f</span>&nbsp;<span class="op" id="1642683">:=</span>&nbsp;<span class="ident" id="1642686">netpollblockcommit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642707">gopark</span><span class="op" id="1642713">(</span><span class="op" id="1642714">*</span><span class="op" id="1642715">*</span><span class="op" id="1642716">(</span><span class="op" id="1642717">*</span><span class="op" id="1642718">*</span><span class="ident" id="1642719">unsafe</span><span class="op" id="1642725">.</span><span class="ident" id="1642726">Pointer</span><span class="op" id="1642733">)</span><span class="op" id="1642734">(</span><span class="ident" id="1642735">unsafe</span><span class="op" id="1642741">.</span><span class="ident" id="1642742">Pointer</span><span class="op" id="1642749">(</span><span class="op" id="1642750">&amp;</span><span class="ident" id="1642751">f</span><span class="op" id="1642752">)</span><span class="op" id="1642753">)</span><span class="op" id="1642754">,</span>&nbsp;<span class="ident" id="1642756">unsafe</span><span class="op" id="1642762">.</span><span class="ident" id="1642763">Pointer</span><span class="op" id="1642770">(</span><span class="ident" id="1642771">gpp</span><span class="op" id="1642774">)</span><span class="op" id="1642775">,</span>&nbsp;<span class="string" id="1642777">&#34;IO&nbsp;wait&#34;</span><span class="op" id="1642786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1642792">//&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;lose&nbsp;concurrent&nbsp;READY&nbsp;notification</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642849">old</span>&nbsp;<span class="op" id="1642853">:=</span>&nbsp;<span class="ident" id="1642856">xchguintptr</span><span class="op" id="1642867">(</span><span class="ident" id="1642868">gpp</span><span class="op" id="1642871">,</span>&nbsp;<span class="num" id="1642873">0</span><span class="op" id="1642874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642877">if</span>&nbsp;<span class="ident" id="1642880">old</span>&nbsp;<span class="op" id="1642884">&gt;</span>&nbsp;<span class="ident" id="1642886">pdWait</span>&nbsp;<span class="op" id="1642893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642897">gothrow</span><span class="op" id="1642904">(</span><span class="string" id="1642905">&#34;netpollblock:&nbsp;corrupted&nbsp;state&#34;</span><span class="op" id="1642936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642942">return</span>&nbsp;<span class="ident" id="1642949">old</span>&nbsp;<span class="op" id="1642953">==</span>&nbsp;<span class="ident" id="1642956">pdReady</span><br>
<span class="lineno">355</span><span class="op" id="1642964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1642967">func</span>&nbsp;<span class="ident" id="1642972">netpollunblock</span><span class="op" id="1642986">(</span><span class="ident" id="1642987">pd</span>&nbsp;<span class="op" id="1642990">*</span><span class="ident" id="1642991">pollDesc</span><span class="op" id="1642999">,</span>&nbsp;<span class="ident" id="1643001">mode</span>&nbsp;<span class="builtintype" id="1643006">int32</span><span class="op" id="1643011">,</span>&nbsp;<span class="ident" id="1643013">ioready</span>&nbsp;<span class="builtintype" id="1643021">bool</span><span class="op" id="1643025">)</span>&nbsp;<span class="op" id="1643027">*</span><span class="ident" id="1643028">g</span>&nbsp;<span class="op" id="1643030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643033">gpp</span>&nbsp;<span class="op" id="1643037">:=</span>&nbsp;<span class="op" id="1643040">&amp;</span><span class="ident" id="1643041">pd</span><span class="op" id="1643043">.</span><span class="ident" id="1643044">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643048">if</span>&nbsp;<span class="ident" id="1643051">mode</span>&nbsp;<span class="op" id="1643056">==</span>&nbsp;<span class="string" id="1643059">&#39;w&#39;</span>&nbsp;<span class="op" id="1643063">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643067">gpp</span>&nbsp;<span class="op" id="1643071">=</span>&nbsp;<span class="op" id="1643073">&amp;</span><span class="ident" id="1643074">pd</span><span class="op" id="1643076">.</span><span class="ident" id="1643077">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643085">for</span>&nbsp;<span class="op" id="1643089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643093">old</span>&nbsp;<span class="op" id="1643097">:=</span>&nbsp;<span class="op" id="1643100">*</span><span class="ident" id="1643101">gpp</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643107">if</span>&nbsp;<span class="ident" id="1643110">old</span>&nbsp;<span class="op" id="1643114">==</span>&nbsp;<span class="ident" id="1643117">pdReady</span>&nbsp;<span class="op" id="1643125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643130">return</span>&nbsp;<span class="ident" id="1643137">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643147">if</span>&nbsp;<span class="ident" id="1643150">old</span>&nbsp;<span class="op" id="1643154">==</span>&nbsp;<span class="num" id="1643157">0</span>&nbsp;<span class="op" id="1643159">&amp;&amp;</span>&nbsp;<span class="op" id="1643162">!</span><span class="ident" id="1643163">ioready</span>&nbsp;<span class="op" id="1643171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1643176">//&nbsp;Only&nbsp;set&nbsp;READY&nbsp;for&nbsp;ioready.&nbsp;runtime_pollWait</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1643227">//&nbsp;will&nbsp;check&nbsp;for&nbsp;timeout/cancel&nbsp;before&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643279">return</span>&nbsp;<span class="ident" id="1643286">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643296">var</span>&nbsp;<span class="builtinfunc" id="1643300">new</span>&nbsp;<span class="builtintype" id="1643304">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643314">if</span>&nbsp;<span class="ident" id="1643317">ioready</span>&nbsp;<span class="op" id="1643325">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1643330">new</span>&nbsp;<span class="op" id="1643334">=</span>&nbsp;<span class="ident" id="1643336">pdReady</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643350">if</span>&nbsp;<span class="ident" id="1643353">casuintptr</span><span class="op" id="1643363">(</span><span class="ident" id="1643364">gpp</span><span class="op" id="1643367">,</span>&nbsp;<span class="ident" id="1643369">old</span><span class="op" id="1643372">,</span>&nbsp;<span class="builtinfunc" id="1643374">new</span><span class="op" id="1643377">)</span>&nbsp;<span class="op" id="1643379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643384">if</span>&nbsp;<span class="ident" id="1643387">old</span>&nbsp;<span class="op" id="1643391">==</span>&nbsp;<span class="ident" id="1643394">pdReady</span>&nbsp;<span class="op" id="1643402">||</span>&nbsp;<span class="ident" id="1643405">old</span>&nbsp;<span class="op" id="1643409">==</span>&nbsp;<span class="ident" id="1643412">pdWait</span>&nbsp;<span class="op" id="1643419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643425">old</span>&nbsp;<span class="op" id="1643429">=</span>&nbsp;<span class="num" id="1643431">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643441">return</span>&nbsp;<span class="op" id="1643448">(</span><span class="op" id="1643449">*</span><span class="ident" id="1643450">g</span><span class="op" id="1643451">)</span><span class="op" id="1643452">(</span><span class="ident" id="1643453">unsafe</span><span class="op" id="1643459">.</span><span class="ident" id="1643460">Pointer</span><span class="op" id="1643467">(</span><span class="ident" id="1643468">old</span><span class="op" id="1643471">)</span><span class="op" id="1643472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643479">}</span><br>
<span class="lineno"></span><span class="op" id="1643481">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="keyword" id="1643484">func</span>&nbsp;<span class="ident" id="1643489">netpolldeadlineimpl</span><span class="op" id="1643508">(</span><span class="ident" id="1643509">pd</span>&nbsp;<span class="op" id="1643512">*</span><span class="ident" id="1643513">pollDesc</span><span class="op" id="1643521">,</span>&nbsp;<span class="ident" id="1643523">seq</span>&nbsp;<span class="builtintype" id="1643527">uintptr</span><span class="op" id="1643534">,</span>&nbsp;<span class="ident" id="1643536">read</span><span class="op" id="1643540">,</span>&nbsp;<span class="ident" id="1643542">write</span>&nbsp;<span class="builtintype" id="1643548">bool</span><span class="op" id="1643552">)</span>&nbsp;<span class="op" id="1643554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643557">lock</span><span class="op" id="1643561">(</span><span class="op" id="1643562">&amp;</span><span class="ident" id="1643563">pd</span><span class="op" id="1643565">.</span><span class="ident" id="1643566">lock</span><span class="op" id="1643570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1643573">//&nbsp;Seq&nbsp;arg&nbsp;is&nbsp;seq&nbsp;when&nbsp;the&nbsp;timer&nbsp;was&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1643616">//&nbsp;If&nbsp;it&#39;s&nbsp;stale,&nbsp;ignore&nbsp;the&nbsp;timer&nbsp;event.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643659">if</span>&nbsp;<span class="ident" id="1643662">seq</span>&nbsp;<span class="op" id="1643666">!=</span>&nbsp;<span class="ident" id="1643669">pd</span><span class="op" id="1643671">.</span><span class="ident" id="1643672">seq</span>&nbsp;<span class="op" id="1643676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1643680">//&nbsp;The&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643733">unlock</span><span class="op" id="1643739">(</span><span class="op" id="1643740">&amp;</span><span class="ident" id="1643741">pd</span><span class="op" id="1643743">.</span><span class="ident" id="1643744">lock</span><span class="op" id="1643748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643752">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643760">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643763">var</span>&nbsp;<span class="ident" id="1643767">rg</span>&nbsp;<span class="op" id="1643770">*</span><span class="ident" id="1643771">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643774">if</span>&nbsp;<span class="ident" id="1643777">read</span>&nbsp;<span class="op" id="1643782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643786">if</span>&nbsp;<span class="ident" id="1643789">pd</span><span class="op" id="1643791">.</span><span class="ident" id="1643792">rd</span>&nbsp;<span class="op" id="1643795">&lt;=</span>&nbsp;<span class="num" id="1643798">0</span>&nbsp;<span class="op" id="1643800">||</span>&nbsp;<span class="ident" id="1643803">pd</span><span class="op" id="1643805">.</span><span class="ident" id="1643806">rt</span><span class="op" id="1643808">.</span><span class="ident" id="1643809">f</span>&nbsp;<span class="op" id="1643811">==</span>&nbsp;<span class="ident" id="1643814">nil</span>&nbsp;<span class="op" id="1643818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643823">gothrow</span><span class="op" id="1643830">(</span><span class="string" id="1643831">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;read&nbsp;deadline&#34;</span><span class="op" id="1643880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643884">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643888">pd</span><span class="op" id="1643890">.</span><span class="ident" id="1643891">rd</span>&nbsp;<span class="op" id="1643894">=</span>&nbsp;<span class="op" id="1643896">-</span><span class="num" id="1643897">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643901">atomicstorep</span><span class="op" id="1643913">(</span><span class="ident" id="1643914">unsafe</span><span class="op" id="1643920">.</span><span class="ident" id="1643921">Pointer</span><span class="op" id="1643928">(</span><span class="op" id="1643929">&amp;</span><span class="ident" id="1643930">pd</span><span class="op" id="1643932">.</span><span class="ident" id="1643933">rt</span><span class="op" id="1643935">.</span><span class="ident" id="1643936">f</span><span class="op" id="1643937">)</span><span class="op" id="1643938">,</span>&nbsp;<span class="ident" id="1643940">nil</span><span class="op" id="1643943">)</span>&nbsp;<span class="comment" id="1643945">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;rd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644023">rg</span>&nbsp;<span class="op" id="1644026">=</span>&nbsp;<span class="ident" id="1644028">netpollunblock</span><span class="op" id="1644042">(</span><span class="ident" id="1644043">pd</span><span class="op" id="1644045">,</span>&nbsp;<span class="string" id="1644047">&#39;r&#39;</span><span class="op" id="1644050">,</span>&nbsp;<span class="builtintype" id="1644052">false</span><span class="op" id="1644057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1644060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644063">var</span>&nbsp;<span class="ident" id="1644067">wg</span>&nbsp;<span class="op" id="1644070">*</span><span class="ident" id="1644071">g</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644074">if</span>&nbsp;<span class="ident" id="1644077">write</span>&nbsp;<span class="op" id="1644083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644087">if</span>&nbsp;<span class="ident" id="1644090">pd</span><span class="op" id="1644092">.</span><span class="ident" id="1644093">wd</span>&nbsp;<span class="op" id="1644096">&lt;=</span>&nbsp;<span class="num" id="1644099">0</span>&nbsp;<span class="op" id="1644101">||</span>&nbsp;<span class="ident" id="1644104">pd</span><span class="op" id="1644106">.</span><span class="ident" id="1644107">wt</span><span class="op" id="1644109">.</span><span class="ident" id="1644110">f</span>&nbsp;<span class="op" id="1644112">==</span>&nbsp;<span class="ident" id="1644115">nil</span>&nbsp;<span class="op" id="1644119">&amp;&amp;</span>&nbsp;<span class="op" id="1644122">!</span><span class="ident" id="1644123">read</span>&nbsp;<span class="op" id="1644128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644133">gothrow</span><span class="op" id="1644140">(</span><span class="string" id="1644141">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;write&nbsp;deadline&#34;</span><span class="op" id="1644191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1644195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644199">pd</span><span class="op" id="1644201">.</span><span class="ident" id="1644202">wd</span>&nbsp;<span class="op" id="1644205">=</span>&nbsp;<span class="op" id="1644207">-</span><span class="num" id="1644208">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644212">atomicstorep</span><span class="op" id="1644224">(</span><span class="ident" id="1644225">unsafe</span><span class="op" id="1644231">.</span><span class="ident" id="1644232">Pointer</span><span class="op" id="1644239">(</span><span class="op" id="1644240">&amp;</span><span class="ident" id="1644241">pd</span><span class="op" id="1644243">.</span><span class="ident" id="1644244">wt</span><span class="op" id="1644246">.</span><span class="ident" id="1644247">f</span><span class="op" id="1644248">)</span><span class="op" id="1644249">,</span>&nbsp;<span class="ident" id="1644251">nil</span><span class="op" id="1644254">)</span>&nbsp;<span class="comment" id="1644256">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;wd&nbsp;and&nbsp;load&nbsp;of&nbsp;wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644334">wg</span>&nbsp;<span class="op" id="1644337">=</span>&nbsp;<span class="ident" id="1644339">netpollunblock</span><span class="op" id="1644353">(</span><span class="ident" id="1644354">pd</span><span class="op" id="1644356">,</span>&nbsp;<span class="string" id="1644358">&#39;w&#39;</span><span class="op" id="1644361">,</span>&nbsp;<span class="builtintype" id="1644363">false</span><span class="op" id="1644368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1644371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644374">unlock</span><span class="op" id="1644380">(</span><span class="op" id="1644381">&amp;</span><span class="ident" id="1644382">pd</span><span class="op" id="1644384">.</span><span class="ident" id="1644385">lock</span><span class="op" id="1644389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644392">if</span>&nbsp;<span class="ident" id="1644395">rg</span>&nbsp;<span class="op" id="1644398">!=</span>&nbsp;<span class="ident" id="1644401">nil</span>&nbsp;<span class="op" id="1644405">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644409">goready</span><span class="op" id="1644416">(</span><span class="ident" id="1644417">rg</span><span class="op" id="1644419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1644422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644425">if</span>&nbsp;<span class="ident" id="1644428">wg</span>&nbsp;<span class="op" id="1644431">!=</span>&nbsp;<span class="ident" id="1644434">nil</span>&nbsp;<span class="op" id="1644438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644442">goready</span><span class="op" id="1644449">(</span><span class="ident" id="1644450">wg</span><span class="op" id="1644452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1644455">}</span><br>
<span class="lineno">420</span><span class="op" id="1644457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1644460">func</span>&nbsp;<span class="ident" id="1644465">netpollDeadline</span><span class="op" id="1644480">(</span><span class="ident" id="1644481">arg</span>&nbsp;<span class="keyword" id="1644485">interface</span><span class="op" id="1644494">{</span><span class="op" id="1644495">}</span><span class="op" id="1644496">,</span>&nbsp;<span class="ident" id="1644498">seq</span>&nbsp;<span class="builtintype" id="1644502">uintptr</span><span class="op" id="1644509">)</span>&nbsp;<span class="op" id="1644511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644514">netpolldeadlineimpl</span><span class="op" id="1644533">(</span><span class="ident" id="1644534">arg</span><span class="op" id="1644537">.</span><span class="op" id="1644538">(</span><span class="op" id="1644539">*</span><span class="ident" id="1644540">pollDesc</span><span class="op" id="1644548">)</span><span class="op" id="1644549">,</span>&nbsp;<span class="ident" id="1644551">seq</span><span class="op" id="1644554">,</span>&nbsp;<span class="builtintype" id="1644556">true</span><span class="op" id="1644560">,</span>&nbsp;<span class="builtintype" id="1644562">true</span><span class="op" id="1644566">)</span><br>
<span class="lineno"></span><span class="op" id="1644568">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1644571">func</span>&nbsp;<span class="ident" id="1644576">netpollReadDeadline</span><span class="op" id="1644595">(</span><span class="ident" id="1644596">arg</span>&nbsp;<span class="keyword" id="1644600">interface</span><span class="op" id="1644609">{</span><span class="op" id="1644610">}</span><span class="op" id="1644611">,</span>&nbsp;<span class="ident" id="1644613">seq</span>&nbsp;<span class="builtintype" id="1644617">uintptr</span><span class="op" id="1644624">)</span>&nbsp;<span class="op" id="1644626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644629">netpolldeadlineimpl</span><span class="op" id="1644648">(</span><span class="ident" id="1644649">arg</span><span class="op" id="1644652">.</span><span class="op" id="1644653">(</span><span class="op" id="1644654">*</span><span class="ident" id="1644655">pollDesc</span><span class="op" id="1644663">)</span><span class="op" id="1644664">,</span>&nbsp;<span class="ident" id="1644666">seq</span><span class="op" id="1644669">,</span>&nbsp;<span class="builtintype" id="1644671">true</span><span class="op" id="1644675">,</span>&nbsp;<span class="builtintype" id="1644677">false</span><span class="op" id="1644682">)</span><br>
<span class="lineno"></span><span class="op" id="1644684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="keyword" id="1644687">func</span>&nbsp;<span class="ident" id="1644692">netpollWriteDeadline</span><span class="op" id="1644712">(</span><span class="ident" id="1644713">arg</span>&nbsp;<span class="keyword" id="1644717">interface</span><span class="op" id="1644726">{</span><span class="op" id="1644727">}</span><span class="op" id="1644728">,</span>&nbsp;<span class="ident" id="1644730">seq</span>&nbsp;<span class="builtintype" id="1644734">uintptr</span><span class="op" id="1644741">)</span>&nbsp;<span class="op" id="1644743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644746">netpolldeadlineimpl</span><span class="op" id="1644765">(</span><span class="ident" id="1644766">arg</span><span class="op" id="1644769">.</span><span class="op" id="1644770">(</span><span class="op" id="1644771">*</span><span class="ident" id="1644772">pollDesc</span><span class="op" id="1644780">)</span><span class="op" id="1644781">,</span>&nbsp;<span class="ident" id="1644783">seq</span><span class="op" id="1644786">,</span>&nbsp;<span class="builtintype" id="1644788">false</span><span class="op" id="1644793">,</span>&nbsp;<span class="builtintype" id="1644795">true</span><span class="op" id="1644799">)</span><br>
<span class="lineno"></span><span class="op" id="1644801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1644804">func</span>&nbsp;<span class="op" id="1644809">(</span><span class="ident" id="1644810">c</span>&nbsp;<span class="op" id="1644812">*</span><span class="ident" id="1644813">pollCache</span><span class="op" id="1644822">)</span>&nbsp;<span class="ident" id="1644824">alloc</span><span class="op" id="1644829">(</span><span class="op" id="1644830">)</span>&nbsp;<span class="op" id="1644832">*</span><span class="ident" id="1644833">pollDesc</span>&nbsp;<span class="op" id="1644842">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644845">lock</span><span class="op" id="1644849">(</span><span class="op" id="1644850">&amp;</span><span class="ident" id="1644851">c</span><span class="op" id="1644852">.</span><span class="ident" id="1644853">lock</span><span class="op" id="1644857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644860">if</span>&nbsp;<span class="ident" id="1644863">c</span><span class="op" id="1644864">.</span><span class="ident" id="1644865">first</span>&nbsp;<span class="op" id="1644871">==</span>&nbsp;<span class="ident" id="1644874">nil</span>&nbsp;<span class="op" id="1644878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644882">const</span>&nbsp;<span class="ident" id="1644888">pdSize</span>&nbsp;<span class="op" id="1644895">=</span>&nbsp;<span class="ident" id="1644897">unsafe</span><span class="op" id="1644903">.</span><span class="ident" id="1644904">Sizeof</span><span class="op" id="1644910">(</span><span class="ident" id="1644911">pollDesc</span><span class="op" id="1644919">{</span><span class="op" id="1644920">}</span><span class="op" id="1644921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644925">n</span>&nbsp;<span class="op" id="1644927">:=</span>&nbsp;<span class="ident" id="1644930">pollBlockSize</span>&nbsp;<span class="op" id="1644944">/</span>&nbsp;<span class="ident" id="1644946">pdSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644955">if</span>&nbsp;<span class="ident" id="1644958">n</span>&nbsp;<span class="op" id="1644960">==</span>&nbsp;<span class="num" id="1644963">0</span>&nbsp;<span class="op" id="1644965">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644970">n</span>&nbsp;<span class="op" id="1644972">=</span>&nbsp;<span class="num" id="1644974">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1644978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1644982">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;non-GC&nbsp;memory&nbsp;because&nbsp;can&nbsp;be&nbsp;referenced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1645038">//&nbsp;only&nbsp;from&nbsp;epoll/kqueue&nbsp;internals.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645077">mem</span>&nbsp;<span class="op" id="1645081">:=</span>&nbsp;<span class="ident" id="1645084">persistentalloc</span><span class="op" id="1645099">(</span><span class="ident" id="1645100">n</span><span class="op" id="1645101">*</span><span class="ident" id="1645102">pdSize</span><span class="op" id="1645108">,</span>&nbsp;<span class="num" id="1645110">0</span><span class="op" id="1645111">,</span>&nbsp;<span class="op" id="1645113">&amp;</span><span class="ident" id="1645114">memstats</span><span class="op" id="1645122">.</span><span class="ident" id="1645123">other_sys</span><span class="op" id="1645132">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645136">for</span>&nbsp;<span class="ident" id="1645140">i</span>&nbsp;<span class="op" id="1645142">:=</span>&nbsp;<span class="builtintype" id="1645145">uintptr</span><span class="op" id="1645152">(</span><span class="num" id="1645153">0</span><span class="op" id="1645154">)</span><span class="op" id="1645155">;</span>&nbsp;<span class="ident" id="1645157">i</span>&nbsp;<span class="op" id="1645159">&lt;</span>&nbsp;<span class="ident" id="1645161">n</span><span class="op" id="1645162">;</span>&nbsp;<span class="ident" id="1645164">i</span><span class="op" id="1645165">++</span>&nbsp;<span class="op" id="1645168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645173">pd</span>&nbsp;<span class="op" id="1645176">:=</span>&nbsp;<span class="op" id="1645179">(</span><span class="op" id="1645180">*</span><span class="ident" id="1645181">pollDesc</span><span class="op" id="1645189">)</span><span class="op" id="1645190">(</span><span class="ident" id="1645191">add</span><span class="op" id="1645194">(</span><span class="ident" id="1645195">mem</span><span class="op" id="1645198">,</span>&nbsp;<span class="ident" id="1645200">i</span><span class="op" id="1645201">*</span><span class="ident" id="1645202">pdSize</span><span class="op" id="1645208">)</span><span class="op" id="1645209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645214">pd</span><span class="op" id="1645216">.</span><span class="ident" id="1645217">link</span>&nbsp;<span class="op" id="1645222">=</span>&nbsp;<span class="ident" id="1645224">c</span><span class="op" id="1645225">.</span><span class="ident" id="1645226">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645235">c</span><span class="op" id="1645236">.</span><span class="ident" id="1645237">first</span>&nbsp;<span class="op" id="1645243">=</span>&nbsp;<span class="ident" id="1645245">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1645250">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1645253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645256">pd</span>&nbsp;<span class="op" id="1645259">:=</span>&nbsp;<span class="ident" id="1645262">c</span><span class="op" id="1645263">.</span><span class="ident" id="1645264">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645271">c</span><span class="op" id="1645272">.</span><span class="ident" id="1645273">first</span>&nbsp;<span class="op" id="1645279">=</span>&nbsp;<span class="ident" id="1645281">pd</span><span class="op" id="1645283">.</span><span class="ident" id="1645284">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645290">unlock</span><span class="op" id="1645296">(</span><span class="op" id="1645297">&amp;</span><span class="ident" id="1645298">c</span><span class="op" id="1645299">.</span><span class="ident" id="1645300">lock</span><span class="op" id="1645304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645307">return</span>&nbsp;<span class="ident" id="1645314">pd</span><br>
<span class="lineno">455</span><span class="op" id="1645317">}</span>
</div>
</body>
</html>
