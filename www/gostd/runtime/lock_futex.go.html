<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1573919">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1573974">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1574028">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1574079">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1574114">package</span>&nbsp;<span class="ident" id="1574122">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1574131">import</span>&nbsp;<span class="string" id="1574138">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1574148">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1574213">//</span><br>
<span class="lineno"></span><span class="comment" id="1574216">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1574275">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspAtomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1574291">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1574319">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspMight&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1574369">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspDon&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1574423">//</span><br>
<span class="lineno"></span><span class="comment" id="1574426">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1574476">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1574537">const</span>&nbsp;<span class="op" id="1574543">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574546">mutex_unlocked</span>&nbsp;<span class="op" id="1574561">=</span>&nbsp;<span class="num" id="1574563">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574566">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1574581">=</span>&nbsp;<span class="num" id="1574583">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574586">mutex_sleeping</span>&nbsp;<span class="op" id="1574601">=</span>&nbsp;<span class="num" id="1574603">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574607">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1574623">=</span>&nbsp;<span class="num" id="1574625">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574628">active_spin_cnt</span>&nbsp;<span class="op" id="1574644">=</span>&nbsp;<span class="num" id="1574646">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1574650">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1574666">=</span>&nbsp;<span class="num" id="1574668">1</span><br>
<span class="lineno">30</span><span class="op" id="1574670">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1574673">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1574750">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1574829">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1574904">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1574930">func</span>&nbsp;<span class="ident" id="1574935">futexsleep</span><span class="op" id="1574945">(</span><span class="ident" id="1574946">addr</span>&nbsp;<span class="op" id="1574951">*</span><span class="builtintype" id="1574952">uint32</span><span class="op" id="1574958">,</span>&nbsp;<span class="ident" id="1574960">val</span>&nbsp;<span class="builtintype" id="1574964">uint32</span><span class="op" id="1574970">,</span>&nbsp;<span class="ident" id="1574972">ns</span>&nbsp;<span class="ident" id="1574975">int64</span><span class="op" id="1574980">)</span><br>
<span class="lineno"></span><span class="keyword" id="1574982">func</span>&nbsp;<span class="ident" id="1574987">futexwakeup</span><span class="op" id="1574998">(</span><span class="ident" id="1574999">addr</span>&nbsp;<span class="op" id="1575004">*</span><span class="builtintype" id="1575005">uint32</span><span class="op" id="1575011">,</span>&nbsp;<span class="ident" id="1575013">cnt</span>&nbsp;<span class="builtintype" id="1575017">uint32</span><span class="op" id="1575023">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1575026">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1575084">func</span>&nbsp;<span class="ident" id="1575089">key32</span><span class="op" id="1575094">(</span><span class="ident" id="1575095">p</span>&nbsp;<span class="op" id="1575097">*</span><span class="builtintype" id="1575098">uintptr</span><span class="op" id="1575105">)</span>&nbsp;<span class="op" id="1575107">*</span><span class="builtintype" id="1575108">uint32</span>&nbsp;<span class="op" id="1575115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575118">return</span>&nbsp;<span class="op" id="1575125">(</span><span class="op" id="1575126">*</span><span class="builtintype" id="1575127">uint32</span><span class="op" id="1575133">)</span><span class="op" id="1575134">(</span><span class="ident" id="1575135">unsafe</span><span class="op" id="1575141">.</span><span class="ident" id="1575142">Pointer</span><span class="op" id="1575149">(</span><span class="ident" id="1575150">p</span><span class="op" id="1575151">)</span><span class="op" id="1575152">)</span><br>
<span class="lineno"></span><span class="op" id="1575154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1575157">func</span>&nbsp;<span class="ident" id="1575162">lock</span><span class="op" id="1575166">(</span><span class="ident" id="1575167">l</span>&nbsp;<span class="op" id="1575169">*</span><span class="ident" id="1575170">mutex</span><span class="op" id="1575175">)</span>&nbsp;<span class="op" id="1575177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575180">gp</span>&nbsp;<span class="op" id="1575183">:=</span>&nbsp;<span class="ident" id="1575186">getg</span><span class="op" id="1575190">(</span><span class="op" id="1575191">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575195">if</span>&nbsp;<span class="ident" id="1575198">gp</span><span class="op" id="1575200">.</span><span class="ident" id="1575201">m</span><span class="op" id="1575202">.</span><span class="ident" id="1575203">locks</span>&nbsp;<span class="op" id="1575209">&lt;</span>&nbsp;<span class="num" id="1575211">0</span>&nbsp;<span class="op" id="1575213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575217">gothrow</span><span class="op" id="1575224">(</span><span class="string" id="1575225">&#34;runtime路lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1575252">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1575255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575258">gp</span><span class="op" id="1575260">.</span><span class="ident" id="1575261">m</span><span class="op" id="1575262">.</span><span class="ident" id="1575263">locks</span><span class="op" id="1575268">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575273">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575304">v</span>&nbsp;<span class="op" id="1575306">:=</span>&nbsp;<span class="ident" id="1575309">xchg</span><span class="op" id="1575313">(</span><span class="ident" id="1575314">key32</span><span class="op" id="1575319">(</span><span class="op" id="1575320">&amp;</span><span class="ident" id="1575321">l</span><span class="op" id="1575322">.</span><span class="ident" id="1575323">key</span><span class="op" id="1575326">)</span><span class="op" id="1575327">,</span>&nbsp;<span class="ident" id="1575329">mutex_locked</span><span class="op" id="1575341">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575344">if</span>&nbsp;<span class="ident" id="1575347">v</span>&nbsp;<span class="op" id="1575349">==</span>&nbsp;<span class="ident" id="1575352">mutex_unlocked</span>&nbsp;<span class="op" id="1575367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575371">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1575379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575383">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575433">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575485">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575535">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575586">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575641">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575696">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575717">wait</span>&nbsp;<span class="op" id="1575722">:=</span>&nbsp;<span class="ident" id="1575725">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575729">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575770">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575825">spin</span>&nbsp;<span class="op" id="1575830">:=</span>&nbsp;<span class="num" id="1575833">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575836">if</span>&nbsp;<span class="ident" id="1575839">ncpu</span>&nbsp;<span class="op" id="1575844">&gt;</span>&nbsp;<span class="num" id="1575846">1</span>&nbsp;<span class="op" id="1575848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1575852">spin</span>&nbsp;<span class="op" id="1575857">=</span>&nbsp;<span class="ident" id="1575859">active_spin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1575872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575875">for</span>&nbsp;<span class="op" id="1575879">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1575883">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575912">for</span>&nbsp;<span class="ident" id="1575916">i</span>&nbsp;<span class="op" id="1575918">:=</span>&nbsp;<span class="num" id="1575921">0</span><span class="op" id="1575922">;</span>&nbsp;<span class="ident" id="1575924">i</span>&nbsp;<span class="op" id="1575926">&lt;</span>&nbsp;<span class="ident" id="1575928">spin</span><span class="op" id="1575932">;</span>&nbsp;<span class="ident" id="1575934">i</span><span class="op" id="1575935">++</span>&nbsp;<span class="op" id="1575938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575943">for</span>&nbsp;<span class="ident" id="1575947">l</span><span class="op" id="1575948">.</span><span class="ident" id="1575949">key</span>&nbsp;<span class="op" id="1575953">==</span>&nbsp;<span class="ident" id="1575956">mutex_unlocked</span>&nbsp;<span class="op" id="1575971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1575977">if</span>&nbsp;<span class="ident" id="1575980">cas</span><span class="op" id="1575983">(</span><span class="ident" id="1575984">key32</span><span class="op" id="1575989">(</span><span class="op" id="1575990">&amp;</span><span class="ident" id="1575991">l</span><span class="op" id="1575992">.</span><span class="ident" id="1575993">key</span><span class="op" id="1575996">)</span><span class="op" id="1575997">,</span>&nbsp;<span class="ident" id="1575999">mutex_unlocked</span><span class="op" id="1576013">,</span>&nbsp;<span class="ident" id="1576015">wait</span><span class="op" id="1576019">)</span>&nbsp;<span class="op" id="1576021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576028">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576049">procyield</span><span class="op" id="1576058">(</span><span class="ident" id="1576059">active_spin_cnt</span><span class="op" id="1576074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1576083">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576116">for</span>&nbsp;<span class="ident" id="1576120">i</span>&nbsp;<span class="op" id="1576122">:=</span>&nbsp;<span class="num" id="1576125">0</span><span class="op" id="1576126">;</span>&nbsp;<span class="ident" id="1576128">i</span>&nbsp;<span class="op" id="1576130">&lt;</span>&nbsp;<span class="ident" id="1576132">passive_spin</span><span class="op" id="1576144">;</span>&nbsp;<span class="ident" id="1576146">i</span><span class="op" id="1576147">++</span>&nbsp;<span class="op" id="1576150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576155">for</span>&nbsp;<span class="ident" id="1576159">l</span><span class="op" id="1576160">.</span><span class="ident" id="1576161">key</span>&nbsp;<span class="op" id="1576165">==</span>&nbsp;<span class="ident" id="1576168">mutex_unlocked</span>&nbsp;<span class="op" id="1576183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576189">if</span>&nbsp;<span class="ident" id="1576192">cas</span><span class="op" id="1576195">(</span><span class="ident" id="1576196">key32</span><span class="op" id="1576201">(</span><span class="op" id="1576202">&amp;</span><span class="ident" id="1576203">l</span><span class="op" id="1576204">.</span><span class="ident" id="1576205">key</span><span class="op" id="1576208">)</span><span class="op" id="1576209">,</span>&nbsp;<span class="ident" id="1576211">mutex_unlocked</span><span class="op" id="1576225">,</span>&nbsp;<span class="ident" id="1576227">wait</span><span class="op" id="1576231">)</span>&nbsp;<span class="op" id="1576233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576240">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576261">osyield</span><span class="op" id="1576268">(</span><span class="op" id="1576269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1576278">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576290">v</span>&nbsp;<span class="op" id="1576292">=</span>&nbsp;<span class="ident" id="1576294">xchg</span><span class="op" id="1576298">(</span><span class="ident" id="1576299">key32</span><span class="op" id="1576304">(</span><span class="op" id="1576305">&amp;</span><span class="ident" id="1576306">l</span><span class="op" id="1576307">.</span><span class="ident" id="1576308">key</span><span class="op" id="1576311">)</span><span class="op" id="1576312">,</span>&nbsp;<span class="ident" id="1576314">mutex_sleeping</span><span class="op" id="1576328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576332">if</span>&nbsp;<span class="ident" id="1576335">v</span>&nbsp;<span class="op" id="1576337">==</span>&nbsp;<span class="ident" id="1576340">mutex_unlocked</span>&nbsp;<span class="op" id="1576355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576360">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576369">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576373">wait</span>&nbsp;<span class="op" id="1576378">=</span>&nbsp;<span class="ident" id="1576380">mutex_sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576397">futexsleep</span><span class="op" id="1576407">(</span><span class="ident" id="1576408">key32</span><span class="op" id="1576413">(</span><span class="op" id="1576414">&amp;</span><span class="ident" id="1576415">l</span><span class="op" id="1576416">.</span><span class="ident" id="1576417">key</span><span class="op" id="1576420">)</span><span class="op" id="1576421">,</span>&nbsp;<span class="ident" id="1576423">mutex_sleeping</span><span class="op" id="1576437">,</span>&nbsp;<span class="op" id="1576439">-</span><span class="num" id="1576440">1</span><span class="op" id="1576441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576444">}</span><br>
<span class="lineno"></span><span class="op" id="1576446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1576449">func</span>&nbsp;<span class="ident" id="1576454">unlock</span><span class="op" id="1576460">(</span><span class="ident" id="1576461">l</span>&nbsp;<span class="op" id="1576463">*</span><span class="ident" id="1576464">mutex</span><span class="op" id="1576469">)</span>&nbsp;<span class="op" id="1576471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576474">v</span>&nbsp;<span class="op" id="1576476">:=</span>&nbsp;<span class="ident" id="1576479">xchg</span><span class="op" id="1576483">(</span><span class="ident" id="1576484">key32</span><span class="op" id="1576489">(</span><span class="op" id="1576490">&amp;</span><span class="ident" id="1576491">l</span><span class="op" id="1576492">.</span><span class="ident" id="1576493">key</span><span class="op" id="1576496">)</span><span class="op" id="1576497">,</span>&nbsp;<span class="ident" id="1576499">mutex_unlocked</span><span class="op" id="1576513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576516">if</span>&nbsp;<span class="ident" id="1576519">v</span>&nbsp;<span class="op" id="1576521">==</span>&nbsp;<span class="ident" id="1576524">mutex_unlocked</span>&nbsp;<span class="op" id="1576539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576543">gothrow</span><span class="op" id="1576550">(</span><span class="string" id="1576551">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1576576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576579">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576582">if</span>&nbsp;<span class="ident" id="1576585">v</span>&nbsp;<span class="op" id="1576587">==</span>&nbsp;<span class="ident" id="1576590">mutex_sleeping</span>&nbsp;<span class="op" id="1576605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576609">futexwakeup</span><span class="op" id="1576620">(</span><span class="ident" id="1576621">key32</span><span class="op" id="1576626">(</span><span class="op" id="1576627">&amp;</span><span class="ident" id="1576628">l</span><span class="op" id="1576629">.</span><span class="ident" id="1576630">key</span><span class="op" id="1576633">)</span><span class="op" id="1576634">,</span>&nbsp;<span class="num" id="1576636">1</span><span class="op" id="1576637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576644">gp</span>&nbsp;<span class="op" id="1576647">:=</span>&nbsp;<span class="ident" id="1576650">getg</span><span class="op" id="1576654">(</span><span class="op" id="1576655">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576658">gp</span><span class="op" id="1576660">.</span><span class="ident" id="1576661">m</span><span class="op" id="1576662">.</span><span class="ident" id="1576663">locks</span><span class="op" id="1576668">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576672">if</span>&nbsp;<span class="ident" id="1576675">gp</span><span class="op" id="1576677">.</span><span class="ident" id="1576678">m</span><span class="op" id="1576679">.</span><span class="ident" id="1576680">locks</span>&nbsp;<span class="op" id="1576686">&lt;</span>&nbsp;<span class="num" id="1576688">0</span>&nbsp;<span class="op" id="1576690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576694">gothrow</span><span class="op" id="1576701">(</span><span class="string" id="1576702">&#34;runtime路unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1576731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1576737">if</span>&nbsp;<span class="ident" id="1576740">gp</span><span class="op" id="1576742">.</span><span class="ident" id="1576743">m</span><span class="op" id="1576744">.</span><span class="ident" id="1576745">locks</span>&nbsp;<span class="op" id="1576751">==</span>&nbsp;<span class="num" id="1576754">0</span>&nbsp;<span class="op" id="1576756">&amp;&amp;</span>&nbsp;<span class="ident" id="1576759">gp</span><span class="op" id="1576761">.</span><span class="ident" id="1576762">preempt</span>&nbsp;<span class="op" id="1576770">{</span>&nbsp;<span class="comment" id="1576772">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576845">gp</span><span class="op" id="1576847">.</span><span class="ident" id="1576848">stackguard0</span>&nbsp;<span class="op" id="1576860">=</span>&nbsp;<span class="ident" id="1576862">stackPreempt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1576876">}</span><br>
<span class="lineno"></span><span class="op" id="1576878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1576881">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1576908">func</span>&nbsp;<span class="ident" id="1576913">noteclear</span><span class="op" id="1576922">(</span><span class="ident" id="1576923">n</span>&nbsp;<span class="op" id="1576925">*</span><span class="ident" id="1576926">note</span><span class="op" id="1576930">)</span>&nbsp;<span class="op" id="1576932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576935">n</span><span class="op" id="1576936">.</span><span class="ident" id="1576937">key</span>&nbsp;<span class="op" id="1576941">=</span>&nbsp;<span class="num" id="1576943">0</span><br>
<span class="lineno"></span><span class="op" id="1576945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1576948">func</span>&nbsp;<span class="ident" id="1576953">notewakeup</span><span class="op" id="1576963">(</span><span class="ident" id="1576964">n</span>&nbsp;<span class="op" id="1576966">*</span><span class="ident" id="1576967">note</span><span class="op" id="1576971">)</span>&nbsp;<span class="op" id="1576973">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1576976">old</span>&nbsp;<span class="op" id="1576980">:=</span>&nbsp;<span class="ident" id="1576983">xchg</span><span class="op" id="1576987">(</span><span class="ident" id="1576988">key32</span><span class="op" id="1576993">(</span><span class="op" id="1576994">&amp;</span><span class="ident" id="1576995">n</span><span class="op" id="1576996">.</span><span class="ident" id="1576997">key</span><span class="op" id="1577000">)</span><span class="op" id="1577001">,</span>&nbsp;<span class="num" id="1577003">1</span><span class="op" id="1577004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577007">if</span>&nbsp;<span class="ident" id="1577010">old</span>&nbsp;<span class="op" id="1577014">!=</span>&nbsp;<span class="num" id="1577017">0</span>&nbsp;<span class="op" id="1577019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1577023">print</span><span class="op" id="1577028">(</span><span class="string" id="1577029">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1577059">,</span>&nbsp;<span class="ident" id="1577061">old</span><span class="op" id="1577064">,</span>&nbsp;<span class="string" id="1577066">&#34;)\n&#34;</span><span class="op" id="1577071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577075">gothrow</span><span class="op" id="1577082">(</span><span class="string" id="1577083">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1577111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577114">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577117">futexwakeup</span><span class="op" id="1577128">(</span><span class="ident" id="1577129">key32</span><span class="op" id="1577134">(</span><span class="op" id="1577135">&amp;</span><span class="ident" id="1577136">n</span><span class="op" id="1577137">.</span><span class="ident" id="1577138">key</span><span class="op" id="1577141">)</span><span class="op" id="1577142">,</span>&nbsp;<span class="num" id="1577144">1</span><span class="op" id="1577145">)</span><br>
<span class="lineno"></span><span class="op" id="1577147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1577150">func</span>&nbsp;<span class="ident" id="1577155">notesleep</span><span class="op" id="1577164">(</span><span class="ident" id="1577165">n</span>&nbsp;<span class="op" id="1577167">*</span><span class="ident" id="1577168">note</span><span class="op" id="1577172">)</span>&nbsp;<span class="op" id="1577174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577177">gp</span>&nbsp;<span class="op" id="1577180">:=</span>&nbsp;<span class="ident" id="1577183">getg</span><span class="op" id="1577187">(</span><span class="op" id="1577188">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577191">if</span>&nbsp;<span class="ident" id="1577194">gp</span>&nbsp;<span class="op" id="1577197">!=</span>&nbsp;<span class="ident" id="1577200">gp</span><span class="op" id="1577202">.</span><span class="ident" id="1577203">m</span><span class="op" id="1577204">.</span><span class="ident" id="1577205">g0</span>&nbsp;<span class="op" id="1577208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577212">gothrow</span><span class="op" id="1577219">(</span><span class="string" id="1577220">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1577241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577247">for</span>&nbsp;<span class="ident" id="1577251">atomicload</span><span class="op" id="1577261">(</span><span class="ident" id="1577262">key32</span><span class="op" id="1577267">(</span><span class="op" id="1577268">&amp;</span><span class="ident" id="1577269">n</span><span class="op" id="1577270">.</span><span class="ident" id="1577271">key</span><span class="op" id="1577274">)</span><span class="op" id="1577275">)</span>&nbsp;<span class="op" id="1577277">==</span>&nbsp;<span class="num" id="1577280">0</span>&nbsp;<span class="op" id="1577282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577286">gp</span><span class="op" id="1577288">.</span><span class="ident" id="1577289">m</span><span class="op" id="1577290">.</span><span class="ident" id="1577291">blocked</span>&nbsp;<span class="op" id="1577299">=</span>&nbsp;<span class="builtintype" id="1577301">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577308">futexsleep</span><span class="op" id="1577318">(</span><span class="ident" id="1577319">key32</span><span class="op" id="1577324">(</span><span class="op" id="1577325">&amp;</span><span class="ident" id="1577326">n</span><span class="op" id="1577327">.</span><span class="ident" id="1577328">key</span><span class="op" id="1577331">)</span><span class="op" id="1577332">,</span>&nbsp;<span class="num" id="1577334">0</span><span class="op" id="1577335">,</span>&nbsp;<span class="op" id="1577337">-</span><span class="num" id="1577338">1</span><span class="op" id="1577339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577343">gp</span><span class="op" id="1577345">.</span><span class="ident" id="1577346">m</span><span class="op" id="1577347">.</span><span class="ident" id="1577348">blocked</span>&nbsp;<span class="op" id="1577356">=</span>&nbsp;<span class="builtintype" id="1577358">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577365">}</span><br>
<span class="lineno"></span><span class="op" id="1577367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1577370">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1577383">func</span>&nbsp;<span class="ident" id="1577388">notetsleep_internal</span><span class="op" id="1577407">(</span><span class="ident" id="1577408">n</span>&nbsp;<span class="op" id="1577410">*</span><span class="ident" id="1577411">note</span><span class="op" id="1577415">,</span>&nbsp;<span class="ident" id="1577417">ns</span>&nbsp;<span class="ident" id="1577420">int64</span><span class="op" id="1577425">)</span>&nbsp;<span class="builtintype" id="1577427">bool</span>&nbsp;<span class="op" id="1577432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577435">gp</span>&nbsp;<span class="op" id="1577438">:=</span>&nbsp;<span class="ident" id="1577441">getg</span><span class="op" id="1577445">(</span><span class="op" id="1577446">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577450">if</span>&nbsp;<span class="ident" id="1577453">ns</span>&nbsp;<span class="op" id="1577456">&lt;</span>&nbsp;<span class="num" id="1577458">0</span>&nbsp;<span class="op" id="1577460">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577464">for</span>&nbsp;<span class="ident" id="1577468">atomicload</span><span class="op" id="1577478">(</span><span class="ident" id="1577479">key32</span><span class="op" id="1577484">(</span><span class="op" id="1577485">&amp;</span><span class="ident" id="1577486">n</span><span class="op" id="1577487">.</span><span class="ident" id="1577488">key</span><span class="op" id="1577491">)</span><span class="op" id="1577492">)</span>&nbsp;<span class="op" id="1577494">==</span>&nbsp;<span class="num" id="1577497">0</span>&nbsp;<span class="op" id="1577499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577504">gp</span><span class="op" id="1577506">.</span><span class="ident" id="1577507">m</span><span class="op" id="1577508">.</span><span class="ident" id="1577509">blocked</span>&nbsp;<span class="op" id="1577517">=</span>&nbsp;<span class="builtintype" id="1577519">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577527">futexsleep</span><span class="op" id="1577537">(</span><span class="ident" id="1577538">key32</span><span class="op" id="1577543">(</span><span class="op" id="1577544">&amp;</span><span class="ident" id="1577545">n</span><span class="op" id="1577546">.</span><span class="ident" id="1577547">key</span><span class="op" id="1577550">)</span><span class="op" id="1577551">,</span>&nbsp;<span class="num" id="1577553">0</span><span class="op" id="1577554">,</span>&nbsp;<span class="op" id="1577556">-</span><span class="num" id="1577557">1</span><span class="op" id="1577558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577563">gp</span><span class="op" id="1577565">.</span><span class="ident" id="1577566">m</span><span class="op" id="1577567">.</span><span class="ident" id="1577568">blocked</span>&nbsp;<span class="op" id="1577576">=</span>&nbsp;<span class="builtintype" id="1577578">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577586">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577590">return</span>&nbsp;<span class="builtintype" id="1577597">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577607">if</span>&nbsp;<span class="ident" id="1577610">atomicload</span><span class="op" id="1577620">(</span><span class="ident" id="1577621">key32</span><span class="op" id="1577626">(</span><span class="op" id="1577627">&amp;</span><span class="ident" id="1577628">n</span><span class="op" id="1577629">.</span><span class="ident" id="1577630">key</span><span class="op" id="1577633">)</span><span class="op" id="1577634">)</span>&nbsp;<span class="op" id="1577636">!=</span>&nbsp;<span class="num" id="1577639">0</span>&nbsp;<span class="op" id="1577641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577645">return</span>&nbsp;<span class="builtintype" id="1577652">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577662">deadline</span>&nbsp;<span class="op" id="1577671">:=</span>&nbsp;<span class="ident" id="1577674">nanotime</span><span class="op" id="1577682">(</span><span class="op" id="1577683">)</span>&nbsp;<span class="op" id="1577685">+</span>&nbsp;<span class="ident" id="1577687">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577691">for</span>&nbsp;<span class="op" id="1577695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577699">gp</span><span class="op" id="1577701">.</span><span class="ident" id="1577702">m</span><span class="op" id="1577703">.</span><span class="ident" id="1577704">blocked</span>&nbsp;<span class="op" id="1577712">=</span>&nbsp;<span class="builtintype" id="1577714">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577721">futexsleep</span><span class="op" id="1577731">(</span><span class="ident" id="1577732">key32</span><span class="op" id="1577737">(</span><span class="op" id="1577738">&amp;</span><span class="ident" id="1577739">n</span><span class="op" id="1577740">.</span><span class="ident" id="1577741">key</span><span class="op" id="1577744">)</span><span class="op" id="1577745">,</span>&nbsp;<span class="num" id="1577747">0</span><span class="op" id="1577748">,</span>&nbsp;<span class="ident" id="1577750">ns</span><span class="op" id="1577752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577756">gp</span><span class="op" id="1577758">.</span><span class="ident" id="1577759">m</span><span class="op" id="1577760">.</span><span class="ident" id="1577761">blocked</span>&nbsp;<span class="op" id="1577769">=</span>&nbsp;<span class="builtintype" id="1577771">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577779">if</span>&nbsp;<span class="ident" id="1577782">atomicload</span><span class="op" id="1577792">(</span><span class="ident" id="1577793">key32</span><span class="op" id="1577798">(</span><span class="op" id="1577799">&amp;</span><span class="ident" id="1577800">n</span><span class="op" id="1577801">.</span><span class="ident" id="1577802">key</span><span class="op" id="1577805">)</span><span class="op" id="1577806">)</span>&nbsp;<span class="op" id="1577808">!=</span>&nbsp;<span class="num" id="1577811">0</span>&nbsp;<span class="op" id="1577813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577818">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577826">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577830">now</span>&nbsp;<span class="op" id="1577834">:=</span>&nbsp;<span class="ident" id="1577837">nanotime</span><span class="op" id="1577845">(</span><span class="op" id="1577846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577850">if</span>&nbsp;<span class="ident" id="1577853">now</span>&nbsp;<span class="op" id="1577857">&gt;=</span>&nbsp;<span class="ident" id="1577860">deadline</span>&nbsp;<span class="op" id="1577869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577874">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577886">ns</span>&nbsp;<span class="op" id="1577889">=</span>&nbsp;<span class="ident" id="1577891">deadline</span>&nbsp;<span class="op" id="1577900">-</span>&nbsp;<span class="ident" id="1577902">now</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1577907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1577910">return</span>&nbsp;<span class="ident" id="1577917">atomicload</span><span class="op" id="1577927">(</span><span class="ident" id="1577928">key32</span><span class="op" id="1577933">(</span><span class="op" id="1577934">&amp;</span><span class="ident" id="1577935">n</span><span class="op" id="1577936">.</span><span class="ident" id="1577937">key</span><span class="op" id="1577940">)</span><span class="op" id="1577941">)</span>&nbsp;<span class="op" id="1577943">!=</span>&nbsp;<span class="num" id="1577946">0</span><br>
<span class="lineno"></span><span class="op" id="1577948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1577951">func</span>&nbsp;<span class="ident" id="1577956">notetsleep</span><span class="op" id="1577966">(</span><span class="ident" id="1577967">n</span>&nbsp;<span class="op" id="1577969">*</span><span class="ident" id="1577970">note</span><span class="op" id="1577974">,</span>&nbsp;<span class="ident" id="1577976">ns</span>&nbsp;<span class="ident" id="1577979">int64</span><span class="op" id="1577984">)</span>&nbsp;<span class="builtintype" id="1577986">bool</span>&nbsp;<span class="op" id="1577991">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1577994">gp</span>&nbsp;<span class="op" id="1577997">:=</span>&nbsp;<span class="ident" id="1578000">getg</span><span class="op" id="1578004">(</span><span class="op" id="1578005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578008">if</span>&nbsp;<span class="ident" id="1578011">gp</span>&nbsp;<span class="op" id="1578014">!=</span>&nbsp;<span class="ident" id="1578017">gp</span><span class="op" id="1578019">.</span><span class="ident" id="1578020">m</span><span class="op" id="1578021">.</span><span class="ident" id="1578022">g0</span>&nbsp;<span class="op" id="1578025">&amp;&amp;</span>&nbsp;<span class="ident" id="1578028">gp</span><span class="op" id="1578030">.</span><span class="ident" id="1578031">m</span><span class="op" id="1578032">.</span><span class="ident" id="1578033">gcing</span>&nbsp;<span class="op" id="1578039">==</span>&nbsp;<span class="num" id="1578042">0</span>&nbsp;<span class="op" id="1578044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578048">gothrow</span><span class="op" id="1578055">(</span><span class="string" id="1578056">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1578078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1578081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578085">return</span>&nbsp;<span class="ident" id="1578092">notetsleep_internal</span><span class="op" id="1578111">(</span><span class="ident" id="1578112">n</span><span class="op" id="1578113">,</span>&nbsp;<span class="ident" id="1578115">ns</span><span class="op" id="1578117">)</span><br>
<span class="lineno"></span><span class="op" id="1578119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1578122">//&nbsp;same&nbsp;as&nbsp;runtime路notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1578184">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1578254">func</span>&nbsp;<span class="ident" id="1578259">notetsleepg</span><span class="op" id="1578270">(</span><span class="ident" id="1578271">n</span>&nbsp;<span class="op" id="1578273">*</span><span class="ident" id="1578274">note</span><span class="op" id="1578278">,</span>&nbsp;<span class="ident" id="1578280">ns</span>&nbsp;<span class="ident" id="1578283">int64</span><span class="op" id="1578288">)</span>&nbsp;<span class="builtintype" id="1578290">bool</span>&nbsp;<span class="op" id="1578295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578298">gp</span>&nbsp;<span class="op" id="1578301">:=</span>&nbsp;<span class="ident" id="1578304">getg</span><span class="op" id="1578308">(</span><span class="op" id="1578309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578312">if</span>&nbsp;<span class="ident" id="1578315">gp</span>&nbsp;<span class="op" id="1578318">==</span>&nbsp;<span class="ident" id="1578321">gp</span><span class="op" id="1578323">.</span><span class="ident" id="1578324">m</span><span class="op" id="1578325">.</span><span class="ident" id="1578326">g0</span>&nbsp;<span class="op" id="1578329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578333">gothrow</span><span class="op" id="1578340">(</span><span class="string" id="1578341">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1578360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1578363">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578367">entersyscallblock</span><span class="op" id="1578384">(</span><span class="op" id="1578385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578388">ok</span>&nbsp;<span class="op" id="1578391">:=</span>&nbsp;<span class="ident" id="1578394">notetsleep_internal</span><span class="op" id="1578413">(</span><span class="ident" id="1578414">n</span><span class="op" id="1578415">,</span>&nbsp;<span class="ident" id="1578417">ns</span><span class="op" id="1578419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1578422">exitsyscall</span><span class="op" id="1578433">(</span><span class="op" id="1578434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1578437">return</span>&nbsp;<span class="ident" id="1578444">ok</span><br>
<span class="lineno">205</span><span class="op" id="1578447">}</span>
</div>
</body>
</html>
