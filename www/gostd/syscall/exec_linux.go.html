<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html" class="current">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2514898">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2514953">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2515007">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2515058">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2515075">package</span>&nbsp;<span class="ident" id="2515083">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2515092">import</span>&nbsp;<span class="op" id="2515099">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2515102">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2515111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2515114">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2515204">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2515231">type</span>&nbsp;<span class="ident" id="2515236">SysProcIDMap</span>&nbsp;<span class="keyword" id="2515249">struct</span>&nbsp;<span class="op" id="2515256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515259">ContainerID</span>&nbsp;<span class="builtintype" id="2515271">int</span>&nbsp;<span class="comment" id="2515275">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515293">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2515305">int</span>&nbsp;<span class="comment" id="2515309">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515322">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2515334">int</span>&nbsp;<span class="comment" id="2515338">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2515347">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2515350">type</span>&nbsp;<span class="ident" id="2515355">SysProcAttr</span>&nbsp;<span class="keyword" id="2515367">struct</span>&nbsp;<span class="op" id="2515374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515377">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2515389">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2515404">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515416">Credential</span>&nbsp;&nbsp;<span class="op" id="2515428">*</span><span class="ident" id="2515429">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2515443">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515459">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2515471">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2515486">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515506">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2515518">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2515533">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515553">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2515565">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2515580">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515631">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2515643">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2515658">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515733">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2515745">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2515760">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515802">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2515814">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2515829">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515865">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2515877">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2515892">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2515963">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2515975">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2515990">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2516029">UidMappings</span>&nbsp;<span class="op" id="2516041">[</span><span class="op" id="2516042">]</span><span class="ident" id="2516043">SysProcIDMap</span>&nbsp;<span class="comment" id="2516056">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2516098">GidMappings</span>&nbsp;<span class="op" id="2516110">[</span><span class="op" id="2516111">]</span><span class="ident" id="2516112">SysProcIDMap</span>&nbsp;<span class="comment" id="2516125">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2516167">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2516170">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2516205">func</span>&nbsp;<span class="ident" id="2516210">runtime_BeforeFork</span><span class="op" id="2516228">(</span><span class="op" id="2516229">)</span><br>
<span class="lineno"></span><span class="keyword" id="2516231">func</span>&nbsp;<span class="ident" id="2516236">runtime_AfterFork</span><span class="op" id="2516253">(</span><span class="op" id="2516254">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2516257">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2516329">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2516387">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2516454">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2516521">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2516589">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2516653">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2516714">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2516776">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2516817">func</span>&nbsp;<span class="ident" id="2516822">forkAndExecInChild</span><span class="op" id="2516840">(</span><span class="ident" id="2516841">argv0</span>&nbsp;<span class="op" id="2516847">*</span><span class="builtintype" id="2516848">byte</span><span class="op" id="2516852">,</span>&nbsp;<span class="ident" id="2516854">argv</span><span class="op" id="2516858">,</span>&nbsp;<span class="ident" id="2516860">envv</span>&nbsp;<span class="op" id="2516865">[</span><span class="op" id="2516866">]</span><span class="op" id="2516867">*</span><span class="builtintype" id="2516868">byte</span><span class="op" id="2516872">,</span>&nbsp;<span class="ident" id="2516874">chroot</span><span class="op" id="2516880">,</span>&nbsp;<span class="ident" id="2516882">dir</span>&nbsp;<span class="op" id="2516886">*</span><span class="builtintype" id="2516887">byte</span><span class="op" id="2516891">,</span>&nbsp;<span class="ident" id="2516893">attr</span>&nbsp;<span class="op" id="2516898">*</span><span class="ident" id="2516899">ProcAttr</span><span class="op" id="2516907">,</span>&nbsp;<span class="ident" id="2516909">sys</span>&nbsp;<span class="op" id="2516913">*</span><span class="ident" id="2516914">SysProcAttr</span><span class="op" id="2516925">,</span>&nbsp;<span class="ident" id="2516927">pipe</span>&nbsp;<span class="builtintype" id="2516932">int</span><span class="op" id="2516935">)</span>&nbsp;<span class="op" id="2516937">(</span><span class="ident" id="2516938">pid</span>&nbsp;<span class="builtintype" id="2516942">int</span><span class="op" id="2516945">,</span>&nbsp;<span class="ident" id="2516947">err</span>&nbsp;<span class="ident" id="2516951">Errno</span><span class="op" id="2516956">)</span>&nbsp;<span class="op" id="2516958">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2516961">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2517006">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2517061">var</span>&nbsp;<span class="op" id="2517065">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517069">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2517076">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517086">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2517093">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517101">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2517108">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517116">nextfd</span>&nbsp;<span class="builtintype" id="2517123">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517129">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2517136">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517142">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2517149">[</span><span class="num" id="2517150">2</span><span class="op" id="2517151">]</span><span class="builtintype" id="2517152">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2517157">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2517161">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2517216">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2517280">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517339">fd</span>&nbsp;<span class="op" id="2517342">:=</span>&nbsp;<span class="builtinfunc" id="2517345">make</span><span class="op" id="2517349">(</span><span class="op" id="2517350">[</span><span class="op" id="2517351">]</span><span class="builtintype" id="2517352">int</span><span class="op" id="2517355">,</span>&nbsp;<span class="builtinfunc" id="2517357">len</span><span class="op" id="2517360">(</span><span class="ident" id="2517361">attr</span><span class="op" id="2517365">.</span><span class="ident" id="2517366">Files</span><span class="op" id="2517371">)</span><span class="op" id="2517372">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517375">nextfd</span>&nbsp;<span class="op" id="2517382">=</span>&nbsp;<span class="builtinfunc" id="2517384">len</span><span class="op" id="2517387">(</span><span class="ident" id="2517388">attr</span><span class="op" id="2517392">.</span><span class="ident" id="2517393">Files</span><span class="op" id="2517398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2517401">for</span>&nbsp;<span class="ident" id="2517405">i</span><span class="op" id="2517406">,</span>&nbsp;<span class="ident" id="2517408">ufd</span>&nbsp;<span class="op" id="2517412">:=</span>&nbsp;<span class="keyword" id="2517415">range</span>&nbsp;<span class="ident" id="2517421">attr</span><span class="op" id="2517425">.</span><span class="ident" id="2517426">Files</span>&nbsp;<span class="op" id="2517432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2517436">if</span>&nbsp;<span class="ident" id="2517439">nextfd</span>&nbsp;<span class="op" id="2517446">&lt;</span>&nbsp;<span class="builtintype" id="2517448">int</span><span class="op" id="2517451">(</span><span class="ident" id="2517452">ufd</span><span class="op" id="2517455">)</span>&nbsp;<span class="op" id="2517457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517462">nextfd</span>&nbsp;<span class="op" id="2517469">=</span>&nbsp;<span class="builtintype" id="2517471">int</span><span class="op" id="2517474">(</span><span class="ident" id="2517475">ufd</span><span class="op" id="2517478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2517482">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517486">fd</span><span class="op" id="2517488">[</span><span class="ident" id="2517489">i</span><span class="op" id="2517490">]</span>&nbsp;<span class="op" id="2517492">=</span>&nbsp;<span class="builtintype" id="2517494">int</span><span class="op" id="2517497">(</span><span class="ident" id="2517498">ufd</span><span class="op" id="2517501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2517504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517507">nextfd</span><span class="op" id="2517513">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2517518">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2517582">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2517638">if</span>&nbsp;<span class="ident" id="2517641">sys</span><span class="op" id="2517644">.</span><span class="ident" id="2517645">UidMappings</span>&nbsp;<span class="op" id="2517657">!=</span>&nbsp;<span class="builtintype" id="2517660">nil</span>&nbsp;<span class="op" id="2517664">||</span>&nbsp;<span class="ident" id="2517667">sys</span><span class="op" id="2517670">.</span><span class="ident" id="2517671">GidMappings</span>&nbsp;<span class="op" id="2517683">!=</span>&nbsp;<span class="builtintype" id="2517686">nil</span>&nbsp;<span class="op" id="2517690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2517694">if</span>&nbsp;<span class="ident" id="2517697">err</span>&nbsp;<span class="op" id="2517701">:=</span>&nbsp;<span class="ident" id="2517704">forkExecPipe</span><span class="op" id="2517716">(</span><span class="ident" id="2517717">p</span><span class="op" id="2517718">[</span><span class="op" id="2517719">:</span><span class="op" id="2517720">]</span><span class="op" id="2517721">)</span><span class="op" id="2517722">;</span>&nbsp;<span class="ident" id="2517724">err</span>&nbsp;<span class="op" id="2517728">!=</span>&nbsp;<span class="builtintype" id="2517731">nil</span>&nbsp;<span class="op" id="2517735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2517740">return</span>&nbsp;<span class="num" id="2517747">0</span><span class="op" id="2517748">,</span>&nbsp;<span class="ident" id="2517750">err</span><span class="op" id="2517753">.</span><span class="op" id="2517754">(</span><span class="ident" id="2517755">Errno</span><span class="op" id="2517760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2517764">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2517767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2517771">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2517795">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517854">runtime_BeforeFork</span><span class="op" id="2517872">(</span><span class="op" id="2517873">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517876">r1</span><span class="op" id="2517878">,</span>&nbsp;<span class="ident" id="2517880">_</span><span class="op" id="2517881">,</span>&nbsp;<span class="ident" id="2517883">err1</span>&nbsp;<span class="op" id="2517888">=</span>&nbsp;<span class="ident" id="2517890">RawSyscall6</span><span class="op" id="2517901">(</span><span class="ident" id="2517902">SYS_CLONE</span><span class="op" id="2517911">,</span>&nbsp;<span class="builtintype" id="2517913">uintptr</span><span class="op" id="2517920">(</span><span class="ident" id="2517921">SIGCHLD</span><span class="op" id="2517928">)</span><span class="op" id="2517929">|</span><span class="ident" id="2517930">sys</span><span class="op" id="2517933">.</span><span class="ident" id="2517934">Cloneflags</span><span class="op" id="2517944">,</span>&nbsp;<span class="num" id="2517946">0</span><span class="op" id="2517947">,</span>&nbsp;<span class="num" id="2517949">0</span><span class="op" id="2517950">,</span>&nbsp;<span class="num" id="2517952">0</span><span class="op" id="2517953">,</span>&nbsp;<span class="num" id="2517955">0</span><span class="op" id="2517956">,</span>&nbsp;<span class="num" id="2517958">0</span><span class="op" id="2517959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2517962">if</span>&nbsp;<span class="ident" id="2517965">err1</span>&nbsp;<span class="op" id="2517970">!=</span>&nbsp;<span class="num" id="2517973">0</span>&nbsp;<span class="op" id="2517975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2517979">runtime_AfterFork</span><span class="op" id="2517996">(</span><span class="op" id="2517997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518001">return</span>&nbsp;<span class="num" id="2518008">0</span><span class="op" id="2518009">,</span>&nbsp;<span class="ident" id="2518011">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2518017">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518021">if</span>&nbsp;<span class="ident" id="2518024">r1</span>&nbsp;<span class="op" id="2518027">!=</span>&nbsp;<span class="num" id="2518030">0</span>&nbsp;<span class="op" id="2518032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2518036">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2518060">runtime_AfterFork</span><span class="op" id="2518077">(</span><span class="op" id="2518078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2518082">pid</span>&nbsp;<span class="op" id="2518086">=</span>&nbsp;<span class="builtintype" id="2518088">int</span><span class="op" id="2518091">(</span><span class="ident" id="2518092">r1</span><span class="op" id="2518094">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518099">if</span>&nbsp;<span class="ident" id="2518102">sys</span><span class="op" id="2518105">.</span><span class="ident" id="2518106">UidMappings</span>&nbsp;<span class="op" id="2518118">!=</span>&nbsp;<span class="builtintype" id="2518121">nil</span>&nbsp;<span class="op" id="2518125">||</span>&nbsp;<span class="ident" id="2518128">sys</span><span class="op" id="2518131">.</span><span class="ident" id="2518132">GidMappings</span>&nbsp;<span class="op" id="2518144">!=</span>&nbsp;<span class="builtintype" id="2518147">nil</span>&nbsp;<span class="op" id="2518151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2518156">Close</span><span class="op" id="2518161">(</span><span class="ident" id="2518162">p</span><span class="op" id="2518163">[</span><span class="num" id="2518164">0</span><span class="op" id="2518165">]</span><span class="op" id="2518166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2518171">err</span>&nbsp;<span class="op" id="2518175">:=</span>&nbsp;<span class="ident" id="2518178">writeUidGidMappings</span><span class="op" id="2518197">(</span><span class="ident" id="2518198">pid</span><span class="op" id="2518201">,</span>&nbsp;<span class="ident" id="2518203">sys</span><span class="op" id="2518206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518211">if</span>&nbsp;<span class="ident" id="2518214">err</span>&nbsp;<span class="op" id="2518218">!=</span>&nbsp;<span class="builtintype" id="2518221">nil</span>&nbsp;<span class="op" id="2518225">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2518231">err2</span>&nbsp;<span class="op" id="2518236">=</span>&nbsp;<span class="ident" id="2518238">err</span><span class="op" id="2518241">.</span><span class="op" id="2518242">(</span><span class="ident" id="2518243">Errno</span><span class="op" id="2518248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2518253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2518258">RawSyscall</span><span class="op" id="2518268">(</span><span class="ident" id="2518269">SYS_WRITE</span><span class="op" id="2518278">,</span>&nbsp;<span class="builtintype" id="2518280">uintptr</span><span class="op" id="2518287">(</span><span class="ident" id="2518288">p</span><span class="op" id="2518289">[</span><span class="num" id="2518290">1</span><span class="op" id="2518291">]</span><span class="op" id="2518292">)</span><span class="op" id="2518293">,</span>&nbsp;<span class="builtintype" id="2518295">uintptr</span><span class="op" id="2518302">(</span><span class="ident" id="2518303">unsafe</span><span class="op" id="2518309">.</span><span class="ident" id="2518310">Pointer</span><span class="op" id="2518317">(</span><span class="op" id="2518318">&amp;</span><span class="ident" id="2518319">err2</span><span class="op" id="2518323">)</span><span class="op" id="2518324">)</span><span class="op" id="2518325">,</span>&nbsp;<span class="ident" id="2518327">unsafe</span><span class="op" id="2518333">.</span><span class="ident" id="2518334">Sizeof</span><span class="op" id="2518340">(</span><span class="ident" id="2518341">err2</span><span class="op" id="2518345">)</span><span class="op" id="2518346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2518351">Close</span><span class="op" id="2518356">(</span><span class="ident" id="2518357">p</span><span class="op" id="2518358">[</span><span class="num" id="2518359">1</span><span class="op" id="2518360">]</span><span class="op" id="2518361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2518365">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518370">return</span>&nbsp;<span class="ident" id="2518377">pid</span><span class="op" id="2518380">,</span>&nbsp;<span class="num" id="2518382">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2518385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2518389">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2518424">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518478">if</span>&nbsp;<span class="ident" id="2518481">sys</span><span class="op" id="2518484">.</span><span class="ident" id="2518485">UidMappings</span>&nbsp;<span class="op" id="2518497">!=</span>&nbsp;<span class="builtintype" id="2518500">nil</span>&nbsp;<span class="op" id="2518504">||</span>&nbsp;<span class="ident" id="2518507">sys</span><span class="op" id="2518510">.</span><span class="ident" id="2518511">GidMappings</span>&nbsp;<span class="op" id="2518523">!=</span>&nbsp;<span class="builtintype" id="2518526">nil</span>&nbsp;<span class="op" id="2518530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518534">if</span>&nbsp;<span class="ident" id="2518537">_</span><span class="op" id="2518538">,</span>&nbsp;<span class="ident" id="2518540">_</span><span class="op" id="2518541">,</span>&nbsp;<span class="ident" id="2518543">err1</span>&nbsp;<span class="op" id="2518548">=</span>&nbsp;<span class="ident" id="2518550">RawSyscall</span><span class="op" id="2518560">(</span><span class="ident" id="2518561">SYS_CLOSE</span><span class="op" id="2518570">,</span>&nbsp;<span class="builtintype" id="2518572">uintptr</span><span class="op" id="2518579">(</span><span class="ident" id="2518580">p</span><span class="op" id="2518581">[</span><span class="num" id="2518582">1</span><span class="op" id="2518583">]</span><span class="op" id="2518584">)</span><span class="op" id="2518585">,</span>&nbsp;<span class="num" id="2518587">0</span><span class="op" id="2518588">,</span>&nbsp;<span class="num" id="2518590">0</span><span class="op" id="2518591">)</span><span class="op" id="2518592">;</span>&nbsp;<span class="ident" id="2518594">err1</span>&nbsp;<span class="op" id="2518599">!=</span>&nbsp;<span class="num" id="2518602">0</span>&nbsp;<span class="op" id="2518604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518609">goto</span>&nbsp;<span class="ident" id="2518614">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2518627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2518631">r1</span><span class="op" id="2518633">,</span>&nbsp;<span class="ident" id="2518635">_</span><span class="op" id="2518636">,</span>&nbsp;<span class="ident" id="2518638">err1</span>&nbsp;<span class="op" id="2518643">=</span>&nbsp;<span class="ident" id="2518645">RawSyscall</span><span class="op" id="2518655">(</span><span class="ident" id="2518656">SYS_READ</span><span class="op" id="2518664">,</span>&nbsp;<span class="builtintype" id="2518666">uintptr</span><span class="op" id="2518673">(</span><span class="ident" id="2518674">p</span><span class="op" id="2518675">[</span><span class="num" id="2518676">0</span><span class="op" id="2518677">]</span><span class="op" id="2518678">)</span><span class="op" id="2518679">,</span>&nbsp;<span class="builtintype" id="2518681">uintptr</span><span class="op" id="2518688">(</span><span class="ident" id="2518689">unsafe</span><span class="op" id="2518695">.</span><span class="ident" id="2518696">Pointer</span><span class="op" id="2518703">(</span><span class="op" id="2518704">&amp;</span><span class="ident" id="2518705">err2</span><span class="op" id="2518709">)</span><span class="op" id="2518710">)</span><span class="op" id="2518711">,</span>&nbsp;<span class="ident" id="2518713">unsafe</span><span class="op" id="2518719">.</span><span class="ident" id="2518720">Sizeof</span><span class="op" id="2518726">(</span><span class="ident" id="2518727">err2</span><span class="op" id="2518731">)</span><span class="op" id="2518732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518736">if</span>&nbsp;<span class="ident" id="2518739">err1</span>&nbsp;<span class="op" id="2518744">!=</span>&nbsp;<span class="num" id="2518747">0</span>&nbsp;<span class="op" id="2518749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518754">goto</span>&nbsp;<span class="ident" id="2518759">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2518772">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518776">if</span>&nbsp;<span class="ident" id="2518779">r1</span>&nbsp;<span class="op" id="2518782">!=</span>&nbsp;<span class="ident" id="2518785">unsafe</span><span class="op" id="2518791">.</span><span class="ident" id="2518792">Sizeof</span><span class="op" id="2518798">(</span><span class="ident" id="2518799">err2</span><span class="op" id="2518803">)</span>&nbsp;<span class="op" id="2518805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2518810">err1</span>&nbsp;<span class="op" id="2518815">=</span>&nbsp;<span class="ident" id="2518817">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518827">goto</span>&nbsp;<span class="ident" id="2518832">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2518845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518849">if</span>&nbsp;<span class="ident" id="2518852">err2</span>&nbsp;<span class="op" id="2518857">!=</span>&nbsp;<span class="num" id="2518860">0</span>&nbsp;<span class="op" id="2518862">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2518867">err1</span>&nbsp;<span class="op" id="2518872">=</span>&nbsp;<span class="ident" id="2518874">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518882">goto</span>&nbsp;<span class="ident" id="2518887">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2518900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2518903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2518907">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2518931">if</span>&nbsp;<span class="ident" id="2518934">sys</span><span class="op" id="2518937">.</span><span class="ident" id="2518938">Pdeathsig</span>&nbsp;<span class="op" id="2518948">!=</span>&nbsp;<span class="num" id="2518951">0</span>&nbsp;<span class="op" id="2518953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2518957">_</span><span class="op" id="2518958">,</span>&nbsp;<span class="ident" id="2518960">_</span><span class="op" id="2518961">,</span>&nbsp;<span class="ident" id="2518963">err1</span>&nbsp;<span class="op" id="2518968">=</span>&nbsp;<span class="ident" id="2518970">RawSyscall6</span><span class="op" id="2518981">(</span><span class="ident" id="2518982">SYS_PRCTL</span><span class="op" id="2518991">,</span>&nbsp;<span class="ident" id="2518993">PR_SET_PDEATHSIG</span><span class="op" id="2519009">,</span>&nbsp;<span class="builtintype" id="2519011">uintptr</span><span class="op" id="2519018">(</span><span class="ident" id="2519019">sys</span><span class="op" id="2519022">.</span><span class="ident" id="2519023">Pdeathsig</span><span class="op" id="2519032">)</span><span class="op" id="2519033">,</span>&nbsp;<span class="num" id="2519035">0</span><span class="op" id="2519036">,</span>&nbsp;<span class="num" id="2519038">0</span><span class="op" id="2519039">,</span>&nbsp;<span class="num" id="2519041">0</span><span class="op" id="2519042">,</span>&nbsp;<span class="num" id="2519044">0</span><span class="op" id="2519045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519049">if</span>&nbsp;<span class="ident" id="2519052">err1</span>&nbsp;<span class="op" id="2519057">!=</span>&nbsp;<span class="num" id="2519060">0</span>&nbsp;<span class="op" id="2519062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519067">goto</span>&nbsp;<span class="ident" id="2519072">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2519085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2519090">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2519153">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2519215">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2519235">r1</span><span class="op" id="2519237">,</span>&nbsp;<span class="ident" id="2519239">_</span><span class="op" id="2519240">,</span>&nbsp;<span class="ident" id="2519242">_</span>&nbsp;<span class="op" id="2519244">=</span>&nbsp;<span class="ident" id="2519246">RawSyscall</span><span class="op" id="2519256">(</span><span class="ident" id="2519257">SYS_GETPPID</span><span class="op" id="2519268">,</span>&nbsp;<span class="num" id="2519270">0</span><span class="op" id="2519271">,</span>&nbsp;<span class="num" id="2519273">0</span><span class="op" id="2519274">,</span>&nbsp;<span class="num" id="2519276">0</span><span class="op" id="2519277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519281">if</span>&nbsp;<span class="ident" id="2519284">r1</span>&nbsp;<span class="op" id="2519287">==</span>&nbsp;<span class="num" id="2519290">1</span>&nbsp;<span class="op" id="2519292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2519297">pid</span><span class="op" id="2519300">,</span>&nbsp;<span class="ident" id="2519302">_</span><span class="op" id="2519303">,</span>&nbsp;<span class="ident" id="2519305">_</span>&nbsp;<span class="op" id="2519307">:=</span>&nbsp;<span class="ident" id="2519310">RawSyscall</span><span class="op" id="2519320">(</span><span class="ident" id="2519321">SYS_GETPID</span><span class="op" id="2519331">,</span>&nbsp;<span class="num" id="2519333">0</span><span class="op" id="2519334">,</span>&nbsp;<span class="num" id="2519336">0</span><span class="op" id="2519337">,</span>&nbsp;<span class="num" id="2519339">0</span><span class="op" id="2519340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2519345">_</span><span class="op" id="2519346">,</span>&nbsp;<span class="ident" id="2519348">_</span><span class="op" id="2519349">,</span>&nbsp;<span class="ident" id="2519351">err1</span>&nbsp;<span class="op" id="2519356">:=</span>&nbsp;<span class="ident" id="2519359">RawSyscall</span><span class="op" id="2519369">(</span><span class="ident" id="2519370">SYS_KILL</span><span class="op" id="2519378">,</span>&nbsp;<span class="ident" id="2519380">pid</span><span class="op" id="2519383">,</span>&nbsp;<span class="builtintype" id="2519385">uintptr</span><span class="op" id="2519392">(</span><span class="ident" id="2519393">sys</span><span class="op" id="2519396">.</span><span class="ident" id="2519397">Pdeathsig</span><span class="op" id="2519406">)</span><span class="op" id="2519407">,</span>&nbsp;<span class="num" id="2519409">0</span><span class="op" id="2519410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519415">if</span>&nbsp;<span class="ident" id="2519418">err1</span>&nbsp;<span class="op" id="2519423">!=</span>&nbsp;<span class="num" id="2519426">0</span>&nbsp;<span class="op" id="2519428">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519434">goto</span>&nbsp;<span class="ident" id="2519439">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2519453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2519457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2519460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2519464">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519497">if</span>&nbsp;<span class="ident" id="2519500">sys</span><span class="op" id="2519503">.</span><span class="ident" id="2519504">Ptrace</span>&nbsp;<span class="op" id="2519511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2519515">_</span><span class="op" id="2519516">,</span>&nbsp;<span class="ident" id="2519518">_</span><span class="op" id="2519519">,</span>&nbsp;<span class="ident" id="2519521">err1</span>&nbsp;<span class="op" id="2519526">=</span>&nbsp;<span class="ident" id="2519528">RawSyscall</span><span class="op" id="2519538">(</span><span class="ident" id="2519539">SYS_PTRACE</span><span class="op" id="2519549">,</span>&nbsp;<span class="builtintype" id="2519551">uintptr</span><span class="op" id="2519558">(</span><span class="ident" id="2519559">PTRACE_TRACEME</span><span class="op" id="2519573">)</span><span class="op" id="2519574">,</span>&nbsp;<span class="num" id="2519576">0</span><span class="op" id="2519577">,</span>&nbsp;<span class="num" id="2519579">0</span><span class="op" id="2519580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519584">if</span>&nbsp;<span class="ident" id="2519587">err1</span>&nbsp;<span class="op" id="2519592">!=</span>&nbsp;<span class="num" id="2519595">0</span>&nbsp;<span class="op" id="2519597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519602">goto</span>&nbsp;<span class="ident" id="2519607">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2519620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2519623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2519627">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519642">if</span>&nbsp;<span class="ident" id="2519645">sys</span><span class="op" id="2519648">.</span><span class="ident" id="2519649">Setsid</span>&nbsp;<span class="op" id="2519656">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2519660">_</span><span class="op" id="2519661">,</span>&nbsp;<span class="ident" id="2519663">_</span><span class="op" id="2519664">,</span>&nbsp;<span class="ident" id="2519666">err1</span>&nbsp;<span class="op" id="2519671">=</span>&nbsp;<span class="ident" id="2519673">RawSyscall</span><span class="op" id="2519683">(</span><span class="ident" id="2519684">SYS_SETSID</span><span class="op" id="2519694">,</span>&nbsp;<span class="num" id="2519696">0</span><span class="op" id="2519697">,</span>&nbsp;<span class="num" id="2519699">0</span><span class="op" id="2519700">,</span>&nbsp;<span class="num" id="2519702">0</span><span class="op" id="2519703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519707">if</span>&nbsp;<span class="ident" id="2519710">err1</span>&nbsp;<span class="op" id="2519715">!=</span>&nbsp;<span class="num" id="2519718">0</span>&nbsp;<span class="op" id="2519720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519725">goto</span>&nbsp;<span class="ident" id="2519730">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2519743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2519746">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2519750">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519772">if</span>&nbsp;<span class="ident" id="2519775">sys</span><span class="op" id="2519778">.</span><span class="ident" id="2519779">Setpgid</span>&nbsp;<span class="op" id="2519787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2519791">_</span><span class="op" id="2519792">,</span>&nbsp;<span class="ident" id="2519794">_</span><span class="op" id="2519795">,</span>&nbsp;<span class="ident" id="2519797">err1</span>&nbsp;<span class="op" id="2519802">=</span>&nbsp;<span class="ident" id="2519804">RawSyscall</span><span class="op" id="2519814">(</span><span class="ident" id="2519815">SYS_SETPGID</span><span class="op" id="2519826">,</span>&nbsp;<span class="num" id="2519828">0</span><span class="op" id="2519829">,</span>&nbsp;<span class="num" id="2519831">0</span><span class="op" id="2519832">,</span>&nbsp;<span class="num" id="2519834">0</span><span class="op" id="2519835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519839">if</span>&nbsp;<span class="ident" id="2519842">err1</span>&nbsp;<span class="op" id="2519847">!=</span>&nbsp;<span class="num" id="2519850">0</span>&nbsp;<span class="op" id="2519852">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519857">goto</span>&nbsp;<span class="ident" id="2519862">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2519875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2519878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2519882">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519893">if</span>&nbsp;<span class="ident" id="2519896">chroot</span>&nbsp;<span class="op" id="2519903">!=</span>&nbsp;<span class="builtintype" id="2519906">nil</span>&nbsp;<span class="op" id="2519910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2519914">_</span><span class="op" id="2519915">,</span>&nbsp;<span class="ident" id="2519917">_</span><span class="op" id="2519918">,</span>&nbsp;<span class="ident" id="2519920">err1</span>&nbsp;<span class="op" id="2519925">=</span>&nbsp;<span class="ident" id="2519927">RawSyscall</span><span class="op" id="2519937">(</span><span class="ident" id="2519938">SYS_CHROOT</span><span class="op" id="2519948">,</span>&nbsp;<span class="builtintype" id="2519950">uintptr</span><span class="op" id="2519957">(</span><span class="ident" id="2519958">unsafe</span><span class="op" id="2519964">.</span><span class="ident" id="2519965">Pointer</span><span class="op" id="2519972">(</span><span class="ident" id="2519973">chroot</span><span class="op" id="2519979">)</span><span class="op" id="2519980">)</span><span class="op" id="2519981">,</span>&nbsp;<span class="num" id="2519983">0</span><span class="op" id="2519984">,</span>&nbsp;<span class="num" id="2519986">0</span><span class="op" id="2519987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2519991">if</span>&nbsp;<span class="ident" id="2519994">err1</span>&nbsp;<span class="op" id="2519999">!=</span>&nbsp;<span class="num" id="2520002">0</span>&nbsp;<span class="op" id="2520004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520009">goto</span>&nbsp;<span class="ident" id="2520014">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2520027">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2520030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2520034">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520054">if</span>&nbsp;<span class="ident" id="2520057">cred</span>&nbsp;<span class="op" id="2520062">:=</span>&nbsp;<span class="ident" id="2520065">sys</span><span class="op" id="2520068">.</span><span class="ident" id="2520069">Credential</span><span class="op" id="2520079">;</span>&nbsp;<span class="ident" id="2520081">cred</span>&nbsp;<span class="op" id="2520086">!=</span>&nbsp;<span class="builtintype" id="2520089">nil</span>&nbsp;<span class="op" id="2520093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2520097">ngroups</span>&nbsp;<span class="op" id="2520105">:=</span>&nbsp;<span class="builtintype" id="2520108">uintptr</span><span class="op" id="2520115">(</span><span class="builtinfunc" id="2520116">len</span><span class="op" id="2520119">(</span><span class="ident" id="2520120">cred</span><span class="op" id="2520124">.</span><span class="ident" id="2520125">Groups</span><span class="op" id="2520131">)</span><span class="op" id="2520132">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520136">var</span>&nbsp;<span class="ident" id="2520140">groups</span>&nbsp;<span class="ident" id="2520147">unsafe</span><span class="op" id="2520153">.</span><span class="ident" id="2520154">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520164">if</span>&nbsp;<span class="ident" id="2520167">ngroups</span>&nbsp;<span class="op" id="2520175">&gt;</span>&nbsp;<span class="num" id="2520177">0</span>&nbsp;<span class="op" id="2520179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2520184">groups</span>&nbsp;<span class="op" id="2520191">=</span>&nbsp;<span class="ident" id="2520193">unsafe</span><span class="op" id="2520199">.</span><span class="ident" id="2520200">Pointer</span><span class="op" id="2520207">(</span><span class="op" id="2520208">&amp;</span><span class="ident" id="2520209">cred</span><span class="op" id="2520213">.</span><span class="ident" id="2520214">Groups</span><span class="op" id="2520220">[</span><span class="num" id="2520221">0</span><span class="op" id="2520222">]</span><span class="op" id="2520223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2520227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2520231">_</span><span class="op" id="2520232">,</span>&nbsp;<span class="ident" id="2520234">_</span><span class="op" id="2520235">,</span>&nbsp;<span class="ident" id="2520237">err1</span>&nbsp;<span class="op" id="2520242">=</span>&nbsp;<span class="ident" id="2520244">RawSyscall</span><span class="op" id="2520254">(</span><span class="ident" id="2520255">SYS_SETGROUPS</span><span class="op" id="2520268">,</span>&nbsp;<span class="ident" id="2520270">ngroups</span><span class="op" id="2520277">,</span>&nbsp;<span class="builtintype" id="2520279">uintptr</span><span class="op" id="2520286">(</span><span class="ident" id="2520287">groups</span><span class="op" id="2520293">)</span><span class="op" id="2520294">,</span>&nbsp;<span class="num" id="2520296">0</span><span class="op" id="2520297">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520301">if</span>&nbsp;<span class="ident" id="2520304">err1</span>&nbsp;<span class="op" id="2520309">!=</span>&nbsp;<span class="num" id="2520312">0</span>&nbsp;<span class="op" id="2520314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520319">goto</span>&nbsp;<span class="ident" id="2520324">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2520337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2520341">_</span><span class="op" id="2520342">,</span>&nbsp;<span class="ident" id="2520344">_</span><span class="op" id="2520345">,</span>&nbsp;<span class="ident" id="2520347">err1</span>&nbsp;<span class="op" id="2520352">=</span>&nbsp;<span class="ident" id="2520354">RawSyscall</span><span class="op" id="2520364">(</span><span class="ident" id="2520365">SYS_SETGID</span><span class="op" id="2520375">,</span>&nbsp;<span class="builtintype" id="2520377">uintptr</span><span class="op" id="2520384">(</span><span class="ident" id="2520385">cred</span><span class="op" id="2520389">.</span><span class="ident" id="2520390">Gid</span><span class="op" id="2520393">)</span><span class="op" id="2520394">,</span>&nbsp;<span class="num" id="2520396">0</span><span class="op" id="2520397">,</span>&nbsp;<span class="num" id="2520399">0</span><span class="op" id="2520400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520404">if</span>&nbsp;<span class="ident" id="2520407">err1</span>&nbsp;<span class="op" id="2520412">!=</span>&nbsp;<span class="num" id="2520415">0</span>&nbsp;<span class="op" id="2520417">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520422">goto</span>&nbsp;<span class="ident" id="2520427">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2520440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2520444">_</span><span class="op" id="2520445">,</span>&nbsp;<span class="ident" id="2520447">_</span><span class="op" id="2520448">,</span>&nbsp;<span class="ident" id="2520450">err1</span>&nbsp;<span class="op" id="2520455">=</span>&nbsp;<span class="ident" id="2520457">RawSyscall</span><span class="op" id="2520467">(</span><span class="ident" id="2520468">SYS_SETUID</span><span class="op" id="2520478">,</span>&nbsp;<span class="builtintype" id="2520480">uintptr</span><span class="op" id="2520487">(</span><span class="ident" id="2520488">cred</span><span class="op" id="2520492">.</span><span class="ident" id="2520493">Uid</span><span class="op" id="2520496">)</span><span class="op" id="2520497">,</span>&nbsp;<span class="num" id="2520499">0</span><span class="op" id="2520500">,</span>&nbsp;<span class="num" id="2520502">0</span><span class="op" id="2520503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520507">if</span>&nbsp;<span class="ident" id="2520510">err1</span>&nbsp;<span class="op" id="2520515">!=</span>&nbsp;<span class="num" id="2520518">0</span>&nbsp;<span class="op" id="2520520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520525">goto</span>&nbsp;<span class="ident" id="2520530">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2520543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2520546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2520550">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520560">if</span>&nbsp;<span class="ident" id="2520563">dir</span>&nbsp;<span class="op" id="2520567">!=</span>&nbsp;<span class="builtintype" id="2520570">nil</span>&nbsp;<span class="op" id="2520574">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2520578">_</span><span class="op" id="2520579">,</span>&nbsp;<span class="ident" id="2520581">_</span><span class="op" id="2520582">,</span>&nbsp;<span class="ident" id="2520584">err1</span>&nbsp;<span class="op" id="2520589">=</span>&nbsp;<span class="ident" id="2520591">RawSyscall</span><span class="op" id="2520601">(</span><span class="ident" id="2520602">SYS_CHDIR</span><span class="op" id="2520611">,</span>&nbsp;<span class="builtintype" id="2520613">uintptr</span><span class="op" id="2520620">(</span><span class="ident" id="2520621">unsafe</span><span class="op" id="2520627">.</span><span class="ident" id="2520628">Pointer</span><span class="op" id="2520635">(</span><span class="ident" id="2520636">dir</span><span class="op" id="2520639">)</span><span class="op" id="2520640">)</span><span class="op" id="2520641">,</span>&nbsp;<span class="num" id="2520643">0</span><span class="op" id="2520644">,</span>&nbsp;<span class="num" id="2520646">0</span><span class="op" id="2520647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520651">if</span>&nbsp;<span class="ident" id="2520654">err1</span>&nbsp;<span class="op" id="2520659">!=</span>&nbsp;<span class="num" id="2520662">0</span>&nbsp;<span class="op" id="2520664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520669">goto</span>&nbsp;<span class="ident" id="2520674">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2520687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2520690">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2520694">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2520757">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520813">if</span>&nbsp;<span class="ident" id="2520816">pipe</span>&nbsp;<span class="op" id="2520821">&lt;</span>&nbsp;<span class="ident" id="2520823">nextfd</span>&nbsp;<span class="op" id="2520830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2520834">_</span><span class="op" id="2520835">,</span>&nbsp;<span class="ident" id="2520837">_</span><span class="op" id="2520838">,</span>&nbsp;<span class="ident" id="2520840">err1</span>&nbsp;<span class="op" id="2520845">=</span>&nbsp;<span class="ident" id="2520847">RawSyscall</span><span class="op" id="2520857">(</span><span class="ident" id="2520858">SYS_DUP2</span><span class="op" id="2520866">,</span>&nbsp;<span class="builtintype" id="2520868">uintptr</span><span class="op" id="2520875">(</span><span class="ident" id="2520876">pipe</span><span class="op" id="2520880">)</span><span class="op" id="2520881">,</span>&nbsp;<span class="builtintype" id="2520883">uintptr</span><span class="op" id="2520890">(</span><span class="ident" id="2520891">nextfd</span><span class="op" id="2520897">)</span><span class="op" id="2520898">,</span>&nbsp;<span class="num" id="2520900">0</span><span class="op" id="2520901">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520905">if</span>&nbsp;<span class="ident" id="2520908">err1</span>&nbsp;<span class="op" id="2520913">!=</span>&nbsp;<span class="num" id="2520916">0</span>&nbsp;<span class="op" id="2520918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2520923">goto</span>&nbsp;<span class="ident" id="2520928">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2520941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2520945">RawSyscall</span><span class="op" id="2520955">(</span><span class="ident" id="2520956">SYS_FCNTL</span><span class="op" id="2520965">,</span>&nbsp;<span class="builtintype" id="2520967">uintptr</span><span class="op" id="2520974">(</span><span class="ident" id="2520975">nextfd</span><span class="op" id="2520981">)</span><span class="op" id="2520982">,</span>&nbsp;<span class="ident" id="2520984">F_SETFD</span><span class="op" id="2520991">,</span>&nbsp;<span class="ident" id="2520993">FD_CLOEXEC</span><span class="op" id="2521003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2521007">pipe</span>&nbsp;<span class="op" id="2521012">=</span>&nbsp;<span class="ident" id="2521014">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2521023">nextfd</span><span class="op" id="2521029">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2521033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521036">for</span>&nbsp;<span class="ident" id="2521040">i</span>&nbsp;<span class="op" id="2521042">=</span>&nbsp;<span class="num" id="2521044">0</span><span class="op" id="2521045">;</span>&nbsp;<span class="ident" id="2521047">i</span>&nbsp;<span class="op" id="2521049">&lt;</span>&nbsp;<span class="builtinfunc" id="2521051">len</span><span class="op" id="2521054">(</span><span class="ident" id="2521055">fd</span><span class="op" id="2521057">)</span><span class="op" id="2521058">;</span>&nbsp;<span class="ident" id="2521060">i</span><span class="op" id="2521061">++</span>&nbsp;<span class="op" id="2521064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521068">if</span>&nbsp;<span class="ident" id="2521071">fd</span><span class="op" id="2521073">[</span><span class="ident" id="2521074">i</span><span class="op" id="2521075">]</span>&nbsp;<span class="op" id="2521077">&gt;=</span>&nbsp;<span class="num" id="2521080">0</span>&nbsp;<span class="op" id="2521082">&amp;&amp;</span>&nbsp;<span class="ident" id="2521085">fd</span><span class="op" id="2521087">[</span><span class="ident" id="2521088">i</span><span class="op" id="2521089">]</span>&nbsp;<span class="op" id="2521091">&lt;</span>&nbsp;<span class="builtintype" id="2521093">int</span><span class="op" id="2521096">(</span><span class="ident" id="2521097">i</span><span class="op" id="2521098">)</span>&nbsp;<span class="op" id="2521100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2521105">_</span><span class="op" id="2521106">,</span>&nbsp;<span class="ident" id="2521108">_</span><span class="op" id="2521109">,</span>&nbsp;<span class="ident" id="2521111">err1</span>&nbsp;<span class="op" id="2521116">=</span>&nbsp;<span class="ident" id="2521118">RawSyscall</span><span class="op" id="2521128">(</span><span class="ident" id="2521129">SYS_DUP2</span><span class="op" id="2521137">,</span>&nbsp;<span class="builtintype" id="2521139">uintptr</span><span class="op" id="2521146">(</span><span class="ident" id="2521147">fd</span><span class="op" id="2521149">[</span><span class="ident" id="2521150">i</span><span class="op" id="2521151">]</span><span class="op" id="2521152">)</span><span class="op" id="2521153">,</span>&nbsp;<span class="builtintype" id="2521155">uintptr</span><span class="op" id="2521162">(</span><span class="ident" id="2521163">nextfd</span><span class="op" id="2521169">)</span><span class="op" id="2521170">,</span>&nbsp;<span class="num" id="2521172">0</span><span class="op" id="2521173">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521178">if</span>&nbsp;<span class="ident" id="2521181">err1</span>&nbsp;<span class="op" id="2521186">!=</span>&nbsp;<span class="num" id="2521189">0</span>&nbsp;<span class="op" id="2521191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521197">goto</span>&nbsp;<span class="ident" id="2521202">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2521216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2521221">RawSyscall</span><span class="op" id="2521231">(</span><span class="ident" id="2521232">SYS_FCNTL</span><span class="op" id="2521241">,</span>&nbsp;<span class="builtintype" id="2521243">uintptr</span><span class="op" id="2521250">(</span><span class="ident" id="2521251">nextfd</span><span class="op" id="2521257">)</span><span class="op" id="2521258">,</span>&nbsp;<span class="ident" id="2521260">F_SETFD</span><span class="op" id="2521267">,</span>&nbsp;<span class="ident" id="2521269">FD_CLOEXEC</span><span class="op" id="2521279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2521284">fd</span><span class="op" id="2521286">[</span><span class="ident" id="2521287">i</span><span class="op" id="2521288">]</span>&nbsp;<span class="op" id="2521290">=</span>&nbsp;<span class="ident" id="2521292">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2521302">nextfd</span><span class="op" id="2521308">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521314">if</span>&nbsp;<span class="ident" id="2521317">nextfd</span>&nbsp;<span class="op" id="2521324">==</span>&nbsp;<span class="ident" id="2521327">pipe</span>&nbsp;<span class="op" id="2521332">{</span>&nbsp;<span class="comment" id="2521334">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2521361">nextfd</span><span class="op" id="2521367">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2521373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2521377">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2521380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2521384">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521419">for</span>&nbsp;<span class="ident" id="2521423">i</span>&nbsp;<span class="op" id="2521425">=</span>&nbsp;<span class="num" id="2521427">0</span><span class="op" id="2521428">;</span>&nbsp;<span class="ident" id="2521430">i</span>&nbsp;<span class="op" id="2521432">&lt;</span>&nbsp;<span class="builtinfunc" id="2521434">len</span><span class="op" id="2521437">(</span><span class="ident" id="2521438">fd</span><span class="op" id="2521440">)</span><span class="op" id="2521441">;</span>&nbsp;<span class="ident" id="2521443">i</span><span class="op" id="2521444">++</span>&nbsp;<span class="op" id="2521447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521451">if</span>&nbsp;<span class="ident" id="2521454">fd</span><span class="op" id="2521456">[</span><span class="ident" id="2521457">i</span><span class="op" id="2521458">]</span>&nbsp;<span class="op" id="2521460">==</span>&nbsp;<span class="op" id="2521463">-</span><span class="num" id="2521464">1</span>&nbsp;<span class="op" id="2521466">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2521471">RawSyscall</span><span class="op" id="2521481">(</span><span class="ident" id="2521482">SYS_CLOSE</span><span class="op" id="2521491">,</span>&nbsp;<span class="builtintype" id="2521493">uintptr</span><span class="op" id="2521500">(</span><span class="ident" id="2521501">i</span><span class="op" id="2521502">)</span><span class="op" id="2521503">,</span>&nbsp;<span class="num" id="2521505">0</span><span class="op" id="2521506">,</span>&nbsp;<span class="num" id="2521508">0</span><span class="op" id="2521509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521514">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2521525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521529">if</span>&nbsp;<span class="ident" id="2521532">fd</span><span class="op" id="2521534">[</span><span class="ident" id="2521535">i</span><span class="op" id="2521536">]</span>&nbsp;<span class="op" id="2521538">==</span>&nbsp;<span class="builtintype" id="2521541">int</span><span class="op" id="2521544">(</span><span class="ident" id="2521545">i</span><span class="op" id="2521546">)</span>&nbsp;<span class="op" id="2521548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2521553">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2521611">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2521648">_</span><span class="op" id="2521649">,</span>&nbsp;<span class="ident" id="2521651">_</span><span class="op" id="2521652">,</span>&nbsp;<span class="ident" id="2521654">err1</span>&nbsp;<span class="op" id="2521659">=</span>&nbsp;<span class="ident" id="2521661">RawSyscall</span><span class="op" id="2521671">(</span><span class="ident" id="2521672">SYS_FCNTL</span><span class="op" id="2521681">,</span>&nbsp;<span class="builtintype" id="2521683">uintptr</span><span class="op" id="2521690">(</span><span class="ident" id="2521691">fd</span><span class="op" id="2521693">[</span><span class="ident" id="2521694">i</span><span class="op" id="2521695">]</span><span class="op" id="2521696">)</span><span class="op" id="2521697">,</span>&nbsp;<span class="ident" id="2521699">F_SETFD</span><span class="op" id="2521706">,</span>&nbsp;<span class="num" id="2521708">0</span><span class="op" id="2521709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521714">if</span>&nbsp;<span class="ident" id="2521717">err1</span>&nbsp;<span class="op" id="2521722">!=</span>&nbsp;<span class="num" id="2521725">0</span>&nbsp;<span class="op" id="2521727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521733">goto</span>&nbsp;<span class="ident" id="2521738">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2521752">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521757">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2521768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2521772">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2521818">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2521854">_</span><span class="op" id="2521855">,</span>&nbsp;<span class="ident" id="2521857">_</span><span class="op" id="2521858">,</span>&nbsp;<span class="ident" id="2521860">err1</span>&nbsp;<span class="op" id="2521865">=</span>&nbsp;<span class="ident" id="2521867">RawSyscall</span><span class="op" id="2521877">(</span><span class="ident" id="2521878">SYS_DUP2</span><span class="op" id="2521886">,</span>&nbsp;<span class="builtintype" id="2521888">uintptr</span><span class="op" id="2521895">(</span><span class="ident" id="2521896">fd</span><span class="op" id="2521898">[</span><span class="ident" id="2521899">i</span><span class="op" id="2521900">]</span><span class="op" id="2521901">)</span><span class="op" id="2521902">,</span>&nbsp;<span class="builtintype" id="2521904">uintptr</span><span class="op" id="2521911">(</span><span class="ident" id="2521912">i</span><span class="op" id="2521913">)</span><span class="op" id="2521914">,</span>&nbsp;<span class="num" id="2521916">0</span><span class="op" id="2521917">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521921">if</span>&nbsp;<span class="ident" id="2521924">err1</span>&nbsp;<span class="op" id="2521929">!=</span>&nbsp;<span class="num" id="2521932">0</span>&nbsp;<span class="op" id="2521934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2521939">goto</span>&nbsp;<span class="ident" id="2521944">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2521957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2521960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2521964">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2522021">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2522083">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2522138">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2522169">for</span>&nbsp;<span class="ident" id="2522173">i</span>&nbsp;<span class="op" id="2522175">=</span>&nbsp;<span class="builtinfunc" id="2522177">len</span><span class="op" id="2522180">(</span><span class="ident" id="2522181">fd</span><span class="op" id="2522183">)</span><span class="op" id="2522184">;</span>&nbsp;<span class="ident" id="2522186">i</span>&nbsp;<span class="op" id="2522188">&lt;</span>&nbsp;<span class="num" id="2522190">3</span><span class="op" id="2522191">;</span>&nbsp;<span class="ident" id="2522193">i</span><span class="op" id="2522194">++</span>&nbsp;<span class="op" id="2522197">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2522201">RawSyscall</span><span class="op" id="2522211">(</span><span class="ident" id="2522212">SYS_CLOSE</span><span class="op" id="2522221">,</span>&nbsp;<span class="builtintype" id="2522223">uintptr</span><span class="op" id="2522230">(</span><span class="ident" id="2522231">i</span><span class="op" id="2522232">)</span><span class="op" id="2522233">,</span>&nbsp;<span class="num" id="2522235">0</span><span class="op" id="2522236">,</span>&nbsp;<span class="num" id="2522238">0</span><span class="op" id="2522239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2522242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2522246">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2522271">if</span>&nbsp;<span class="ident" id="2522274">sys</span><span class="op" id="2522277">.</span><span class="ident" id="2522278">Noctty</span>&nbsp;<span class="op" id="2522285">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2522289">_</span><span class="op" id="2522290">,</span>&nbsp;<span class="ident" id="2522292">_</span><span class="op" id="2522293">,</span>&nbsp;<span class="ident" id="2522295">err1</span>&nbsp;<span class="op" id="2522300">=</span>&nbsp;<span class="ident" id="2522302">RawSyscall</span><span class="op" id="2522312">(</span><span class="ident" id="2522313">SYS_IOCTL</span><span class="op" id="2522322">,</span>&nbsp;<span class="num" id="2522324">0</span><span class="op" id="2522325">,</span>&nbsp;<span class="builtintype" id="2522327">uintptr</span><span class="op" id="2522334">(</span><span class="ident" id="2522335">TIOCNOTTY</span><span class="op" id="2522344">)</span><span class="op" id="2522345">,</span>&nbsp;<span class="num" id="2522347">0</span><span class="op" id="2522348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2522352">if</span>&nbsp;<span class="ident" id="2522355">err1</span>&nbsp;<span class="op" id="2522360">!=</span>&nbsp;<span class="num" id="2522363">0</span>&nbsp;<span class="op" id="2522365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2522370">goto</span>&nbsp;<span class="ident" id="2522375">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2522388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2522391">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2522395">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2522431">if</span>&nbsp;<span class="ident" id="2522434">sys</span><span class="op" id="2522437">.</span><span class="ident" id="2522438">Setctty</span>&nbsp;<span class="op" id="2522446">&amp;&amp;</span>&nbsp;<span class="ident" id="2522449">sys</span><span class="op" id="2522452">.</span><span class="ident" id="2522453">Ctty</span>&nbsp;<span class="op" id="2522458">&gt;=</span>&nbsp;<span class="num" id="2522461">0</span>&nbsp;<span class="op" id="2522463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2522467">_</span><span class="op" id="2522468">,</span>&nbsp;<span class="ident" id="2522470">_</span><span class="op" id="2522471">,</span>&nbsp;<span class="ident" id="2522473">err1</span>&nbsp;<span class="op" id="2522478">=</span>&nbsp;<span class="ident" id="2522480">RawSyscall</span><span class="op" id="2522490">(</span><span class="ident" id="2522491">SYS_IOCTL</span><span class="op" id="2522500">,</span>&nbsp;<span class="builtintype" id="2522502">uintptr</span><span class="op" id="2522509">(</span><span class="ident" id="2522510">sys</span><span class="op" id="2522513">.</span><span class="ident" id="2522514">Ctty</span><span class="op" id="2522518">)</span><span class="op" id="2522519">,</span>&nbsp;<span class="builtintype" id="2522521">uintptr</span><span class="op" id="2522528">(</span><span class="ident" id="2522529">TIOCSCTTY</span><span class="op" id="2522538">)</span><span class="op" id="2522539">,</span>&nbsp;<span class="num" id="2522541">0</span><span class="op" id="2522542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2522546">if</span>&nbsp;<span class="ident" id="2522549">err1</span>&nbsp;<span class="op" id="2522554">!=</span>&nbsp;<span class="num" id="2522557">0</span>&nbsp;<span class="op" id="2522559">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2522564">goto</span>&nbsp;<span class="ident" id="2522569">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2522582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2522585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2522589">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2522607">_</span><span class="op" id="2522608">,</span>&nbsp;<span class="ident" id="2522610">_</span><span class="op" id="2522611">,</span>&nbsp;<span class="ident" id="2522613">err1</span>&nbsp;<span class="op" id="2522618">=</span>&nbsp;<span class="ident" id="2522620">RawSyscall</span><span class="op" id="2522630">(</span><span class="ident" id="2522631">SYS_EXECVE</span><span class="op" id="2522641">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2522645">uintptr</span><span class="op" id="2522652">(</span><span class="ident" id="2522653">unsafe</span><span class="op" id="2522659">.</span><span class="ident" id="2522660">Pointer</span><span class="op" id="2522667">(</span><span class="ident" id="2522668">argv0</span><span class="op" id="2522673">)</span><span class="op" id="2522674">)</span><span class="op" id="2522675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2522679">uintptr</span><span class="op" id="2522686">(</span><span class="ident" id="2522687">unsafe</span><span class="op" id="2522693">.</span><span class="ident" id="2522694">Pointer</span><span class="op" id="2522701">(</span><span class="op" id="2522702">&amp;</span><span class="ident" id="2522703">argv</span><span class="op" id="2522707">[</span><span class="num" id="2522708">0</span><span class="op" id="2522709">]</span><span class="op" id="2522710">)</span><span class="op" id="2522711">)</span><span class="op" id="2522712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2522716">uintptr</span><span class="op" id="2522723">(</span><span class="ident" id="2522724">unsafe</span><span class="op" id="2522730">.</span><span class="ident" id="2522731">Pointer</span><span class="op" id="2522738">(</span><span class="op" id="2522739">&amp;</span><span class="ident" id="2522740">envv</span><span class="op" id="2522744">[</span><span class="num" id="2522745">0</span><span class="op" id="2522746">]</span><span class="op" id="2522747">)</span><span class="op" id="2522748">)</span><span class="op" id="2522749">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2522752">childerror</span><span class="op" id="2522762">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2522765">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2522793">RawSyscall</span><span class="op" id="2522803">(</span><span class="ident" id="2522804">SYS_WRITE</span><span class="op" id="2522813">,</span>&nbsp;<span class="builtintype" id="2522815">uintptr</span><span class="op" id="2522822">(</span><span class="ident" id="2522823">pipe</span><span class="op" id="2522827">)</span><span class="op" id="2522828">,</span>&nbsp;<span class="builtintype" id="2522830">uintptr</span><span class="op" id="2522837">(</span><span class="ident" id="2522838">unsafe</span><span class="op" id="2522844">.</span><span class="ident" id="2522845">Pointer</span><span class="op" id="2522852">(</span><span class="op" id="2522853">&amp;</span><span class="ident" id="2522854">err1</span><span class="op" id="2522858">)</span><span class="op" id="2522859">)</span><span class="op" id="2522860">,</span>&nbsp;<span class="ident" id="2522862">unsafe</span><span class="op" id="2522868">.</span><span class="ident" id="2522869">Sizeof</span><span class="op" id="2522875">(</span><span class="ident" id="2522876">err1</span><span class="op" id="2522880">)</span><span class="op" id="2522881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2522884">for</span>&nbsp;<span class="op" id="2522888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2522892">RawSyscall</span><span class="op" id="2522902">(</span><span class="ident" id="2522903">SYS_EXIT</span><span class="op" id="2522911">,</span>&nbsp;<span class="num" id="2522913">253</span><span class="op" id="2522916">,</span>&nbsp;<span class="num" id="2522918">0</span><span class="op" id="2522919">,</span>&nbsp;<span class="num" id="2522921">0</span><span class="op" id="2522922">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2522925">}</span><br>
<span class="lineno"></span><span class="op" id="2522927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2522930">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2522997">func</span>&nbsp;<span class="ident" id="2523002">forkExecPipe</span><span class="op" id="2523014">(</span><span class="ident" id="2523015">p</span>&nbsp;<span class="op" id="2523017">[</span><span class="op" id="2523018">]</span><span class="builtintype" id="2523019">int</span><span class="op" id="2523022">)</span>&nbsp;<span class="op" id="2523024">(</span><span class="ident" id="2523025">err</span>&nbsp;<span class="builtintype" id="2523029">error</span><span class="op" id="2523034">)</span>&nbsp;<span class="op" id="2523036">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2523039">err</span>&nbsp;<span class="op" id="2523043">=</span>&nbsp;<span class="ident" id="2523045">Pipe2</span><span class="op" id="2523050">(</span><span class="ident" id="2523051">p</span><span class="op" id="2523052">,</span>&nbsp;<span class="ident" id="2523054">O_CLOEXEC</span><span class="op" id="2523063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2523066">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2523141">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523171">if</span>&nbsp;<span class="ident" id="2523174">err</span>&nbsp;<span class="op" id="2523178">==</span>&nbsp;<span class="ident" id="2523181">ENOSYS</span>&nbsp;<span class="op" id="2523188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523192">if</span>&nbsp;<span class="ident" id="2523195">err</span>&nbsp;<span class="op" id="2523199">=</span>&nbsp;<span class="ident" id="2523201">Pipe</span><span class="op" id="2523205">(</span><span class="ident" id="2523206">p</span><span class="op" id="2523207">)</span><span class="op" id="2523208">;</span>&nbsp;<span class="ident" id="2523210">err</span>&nbsp;<span class="op" id="2523214">!=</span>&nbsp;<span class="builtintype" id="2523217">nil</span>&nbsp;<span class="op" id="2523221">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523226">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2523235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523239">if</span>&nbsp;<span class="ident" id="2523242">_</span><span class="op" id="2523243">,</span>&nbsp;<span class="ident" id="2523245">err</span>&nbsp;<span class="op" id="2523249">=</span>&nbsp;<span class="ident" id="2523251">fcntl</span><span class="op" id="2523256">(</span><span class="ident" id="2523257">p</span><span class="op" id="2523258">[</span><span class="num" id="2523259">0</span><span class="op" id="2523260">]</span><span class="op" id="2523261">,</span>&nbsp;<span class="ident" id="2523263">F_SETFD</span><span class="op" id="2523270">,</span>&nbsp;<span class="ident" id="2523272">FD_CLOEXEC</span><span class="op" id="2523282">)</span><span class="op" id="2523283">;</span>&nbsp;<span class="ident" id="2523285">err</span>&nbsp;<span class="op" id="2523289">!=</span>&nbsp;<span class="builtintype" id="2523292">nil</span>&nbsp;<span class="op" id="2523296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523301">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2523310">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2523314">_</span><span class="op" id="2523315">,</span>&nbsp;<span class="ident" id="2523317">err</span>&nbsp;<span class="op" id="2523321">=</span>&nbsp;<span class="ident" id="2523323">fcntl</span><span class="op" id="2523328">(</span><span class="ident" id="2523329">p</span><span class="op" id="2523330">[</span><span class="num" id="2523331">1</span><span class="op" id="2523332">]</span><span class="op" id="2523333">,</span>&nbsp;<span class="ident" id="2523335">F_SETFD</span><span class="op" id="2523342">,</span>&nbsp;<span class="ident" id="2523344">FD_CLOEXEC</span><span class="op" id="2523354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2523357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523360">return</span><br>
<span class="lineno"></span><span class="op" id="2523367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2523370">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2523467">func</span>&nbsp;<span class="ident" id="2523472">writeIDMappings</span><span class="op" id="2523487">(</span><span class="ident" id="2523488">path</span>&nbsp;<span class="builtintype" id="2523493">string</span><span class="op" id="2523499">,</span>&nbsp;<span class="ident" id="2523501">idMap</span>&nbsp;<span class="op" id="2523507">[</span><span class="op" id="2523508">]</span><span class="ident" id="2523509">SysProcIDMap</span><span class="op" id="2523521">)</span>&nbsp;<span class="builtintype" id="2523523">error</span>&nbsp;<span class="op" id="2523529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2523532">fd</span><span class="op" id="2523534">,</span>&nbsp;<span class="ident" id="2523536">err</span>&nbsp;<span class="op" id="2523540">:=</span>&nbsp;<span class="ident" id="2523543">Open</span><span class="op" id="2523547">(</span><span class="ident" id="2523548">path</span><span class="op" id="2523552">,</span>&nbsp;<span class="ident" id="2523554">O_RDWR</span><span class="op" id="2523560">,</span>&nbsp;<span class="num" id="2523562">0</span><span class="op" id="2523563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523566">if</span>&nbsp;<span class="ident" id="2523569">err</span>&nbsp;<span class="op" id="2523573">!=</span>&nbsp;<span class="builtintype" id="2523576">nil</span>&nbsp;<span class="op" id="2523580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523584">return</span>&nbsp;<span class="ident" id="2523591">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2523596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2523600">data</span>&nbsp;<span class="op" id="2523605">:=</span>&nbsp;<span class="string" id="2523608">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523612">for</span>&nbsp;<span class="ident" id="2523616">_</span><span class="op" id="2523617">,</span>&nbsp;<span class="ident" id="2523619">im</span>&nbsp;<span class="op" id="2523622">:=</span>&nbsp;<span class="keyword" id="2523625">range</span>&nbsp;<span class="ident" id="2523631">idMap</span>&nbsp;<span class="op" id="2523637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2523641">data</span>&nbsp;<span class="op" id="2523646">=</span>&nbsp;<span class="ident" id="2523648">data</span>&nbsp;<span class="op" id="2523653">+</span>&nbsp;<span class="ident" id="2523655">itoa</span><span class="op" id="2523659">(</span><span class="ident" id="2523660">im</span><span class="op" id="2523662">.</span><span class="ident" id="2523663">ContainerID</span><span class="op" id="2523674">)</span>&nbsp;<span class="op" id="2523676">+</span>&nbsp;<span class="string" id="2523678">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2523682">+</span>&nbsp;<span class="ident" id="2523684">itoa</span><span class="op" id="2523688">(</span><span class="ident" id="2523689">im</span><span class="op" id="2523691">.</span><span class="ident" id="2523692">HostID</span><span class="op" id="2523698">)</span>&nbsp;<span class="op" id="2523700">+</span>&nbsp;<span class="string" id="2523702">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2523706">+</span>&nbsp;<span class="ident" id="2523708">itoa</span><span class="op" id="2523712">(</span><span class="ident" id="2523713">im</span><span class="op" id="2523715">.</span><span class="ident" id="2523716">Size</span><span class="op" id="2523720">)</span>&nbsp;<span class="op" id="2523722">+</span>&nbsp;<span class="string" id="2523724">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2523730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2523734">bytes</span><span class="op" id="2523739">,</span>&nbsp;<span class="ident" id="2523741">err</span>&nbsp;<span class="op" id="2523745">:=</span>&nbsp;<span class="ident" id="2523748">ByteSliceFromString</span><span class="op" id="2523767">(</span><span class="ident" id="2523768">data</span><span class="op" id="2523772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523775">if</span>&nbsp;<span class="ident" id="2523778">err</span>&nbsp;<span class="op" id="2523782">!=</span>&nbsp;<span class="builtintype" id="2523785">nil</span>&nbsp;<span class="op" id="2523789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2523793">Close</span><span class="op" id="2523798">(</span><span class="ident" id="2523799">fd</span><span class="op" id="2523801">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523805">return</span>&nbsp;<span class="ident" id="2523812">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2523817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523821">if</span>&nbsp;<span class="ident" id="2523824">_</span><span class="op" id="2523825">,</span>&nbsp;<span class="ident" id="2523827">err</span>&nbsp;<span class="op" id="2523831">:=</span>&nbsp;<span class="ident" id="2523834">Write</span><span class="op" id="2523839">(</span><span class="ident" id="2523840">fd</span><span class="op" id="2523842">,</span>&nbsp;<span class="ident" id="2523844">bytes</span><span class="op" id="2523849">)</span><span class="op" id="2523850">;</span>&nbsp;<span class="ident" id="2523852">err</span>&nbsp;<span class="op" id="2523856">!=</span>&nbsp;<span class="builtintype" id="2523859">nil</span>&nbsp;<span class="op" id="2523863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2523867">Close</span><span class="op" id="2523872">(</span><span class="ident" id="2523873">fd</span><span class="op" id="2523875">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523879">return</span>&nbsp;<span class="ident" id="2523886">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2523891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523895">if</span>&nbsp;<span class="ident" id="2523898">err</span>&nbsp;<span class="op" id="2523902">:=</span>&nbsp;<span class="ident" id="2523905">Close</span><span class="op" id="2523910">(</span><span class="ident" id="2523911">fd</span><span class="op" id="2523913">)</span><span class="op" id="2523914">;</span>&nbsp;<span class="ident" id="2523916">err</span>&nbsp;<span class="op" id="2523920">!=</span>&nbsp;<span class="builtintype" id="2523923">nil</span>&nbsp;<span class="op" id="2523927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523931">return</span>&nbsp;<span class="ident" id="2523938">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2523943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2523947">return</span>&nbsp;<span class="builtintype" id="2523954">nil</span><br>
<span class="lineno"></span><span class="op" id="2523958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2523961">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2524041">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2524100">func</span>&nbsp;<span class="ident" id="2524105">writeUidGidMappings</span><span class="op" id="2524124">(</span><span class="ident" id="2524125">pid</span>&nbsp;<span class="builtintype" id="2524129">int</span><span class="op" id="2524132">,</span>&nbsp;<span class="ident" id="2524134">sys</span>&nbsp;<span class="op" id="2524138">*</span><span class="ident" id="2524139">SysProcAttr</span><span class="op" id="2524150">)</span>&nbsp;<span class="builtintype" id="2524152">error</span>&nbsp;<span class="op" id="2524158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2524161">if</span>&nbsp;<span class="ident" id="2524164">sys</span><span class="op" id="2524167">.</span><span class="ident" id="2524168">UidMappings</span>&nbsp;<span class="op" id="2524180">!=</span>&nbsp;<span class="builtintype" id="2524183">nil</span>&nbsp;<span class="op" id="2524187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2524191">uidf</span>&nbsp;<span class="op" id="2524196">:=</span>&nbsp;<span class="string" id="2524199">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2524208">+</span>&nbsp;<span class="ident" id="2524210">itoa</span><span class="op" id="2524214">(</span><span class="ident" id="2524215">pid</span><span class="op" id="2524218">)</span>&nbsp;<span class="op" id="2524220">+</span>&nbsp;<span class="string" id="2524222">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2524235">if</span>&nbsp;<span class="ident" id="2524238">err</span>&nbsp;<span class="op" id="2524242">:=</span>&nbsp;<span class="ident" id="2524245">writeIDMappings</span><span class="op" id="2524260">(</span><span class="ident" id="2524261">uidf</span><span class="op" id="2524265">,</span>&nbsp;<span class="ident" id="2524267">sys</span><span class="op" id="2524270">.</span><span class="ident" id="2524271">UidMappings</span><span class="op" id="2524282">)</span><span class="op" id="2524283">;</span>&nbsp;<span class="ident" id="2524285">err</span>&nbsp;<span class="op" id="2524289">!=</span>&nbsp;<span class="builtintype" id="2524292">nil</span>&nbsp;<span class="op" id="2524296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2524301">return</span>&nbsp;<span class="ident" id="2524308">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2524314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2524317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2524321">if</span>&nbsp;<span class="ident" id="2524324">sys</span><span class="op" id="2524327">.</span><span class="ident" id="2524328">GidMappings</span>&nbsp;<span class="op" id="2524340">!=</span>&nbsp;<span class="builtintype" id="2524343">nil</span>&nbsp;<span class="op" id="2524347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2524351">gidf</span>&nbsp;<span class="op" id="2524356">:=</span>&nbsp;<span class="string" id="2524359">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2524368">+</span>&nbsp;<span class="ident" id="2524370">itoa</span><span class="op" id="2524374">(</span><span class="ident" id="2524375">pid</span><span class="op" id="2524378">)</span>&nbsp;<span class="op" id="2524380">+</span>&nbsp;<span class="string" id="2524382">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2524395">if</span>&nbsp;<span class="ident" id="2524398">err</span>&nbsp;<span class="op" id="2524402">:=</span>&nbsp;<span class="ident" id="2524405">writeIDMappings</span><span class="op" id="2524420">(</span><span class="ident" id="2524421">gidf</span><span class="op" id="2524425">,</span>&nbsp;<span class="ident" id="2524427">sys</span><span class="op" id="2524430">.</span><span class="ident" id="2524431">GidMappings</span><span class="op" id="2524442">)</span><span class="op" id="2524443">;</span>&nbsp;<span class="ident" id="2524445">err</span>&nbsp;<span class="op" id="2524449">!=</span>&nbsp;<span class="builtintype" id="2524452">nil</span>&nbsp;<span class="op" id="2524456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2524461">return</span>&nbsp;<span class="ident" id="2524468">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2524474">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2524477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2524481">return</span>&nbsp;<span class="builtintype" id="2524488">nil</span><br>
<span class="lineno"></span><span class="op" id="2524492">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
