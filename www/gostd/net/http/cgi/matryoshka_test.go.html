<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html" class="current">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8414640">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8414695">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8414749">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8414800">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="8414863">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="8414927">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8414984">package</span>&nbsp;<span class="ident" id="8414992">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="8414997">import</span>&nbsp;<span class="op" id="8415004">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415007">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415016">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415026">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415033">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415039">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415051">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415072">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415078">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415089">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415100">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8415107">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8415110">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="8415180">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="8415244">func</span>&nbsp;<span class="ident" id="8415249">TestHostingOurselves</span><span class="op" id="8415269">(</span><span class="ident" id="8415270">t</span>&nbsp;<span class="op" id="8415272">*</span><span class="ident" id="8415273">testing</span><span class="op" id="8415280">.</span><span class="ident" id="8415281">T</span><span class="op" id="8415282">)</span>&nbsp;<span class="op" id="8415284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8415287">if</span>&nbsp;<span class="ident" id="8415290">runtime</span><span class="op" id="8415297">.</span><span class="ident" id="8415298">GOOS</span>&nbsp;<span class="op" id="8415303">==</span>&nbsp;<span class="string" id="8415306">&#34;nacl&#34;</span>&nbsp;<span class="op" id="8415313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415317">t</span><span class="op" id="8415318">.</span><span class="ident" id="8415319">Skip</span><span class="op" id="8415323">(</span><span class="string" id="8415324">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="8415342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8415345">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415349">h</span>&nbsp;<span class="op" id="8415351">:=</span>&nbsp;<span class="op" id="8415354">&amp;</span><span class="ident" id="8415355">Handler</span><span class="op" id="8415362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415366">Path</span><span class="op" id="8415370">:</span>&nbsp;<span class="ident" id="8415372">os</span><span class="op" id="8415374">.</span><span class="ident" id="8415375">Args</span><span class="op" id="8415379">[</span><span class="num" id="8415380">0</span><span class="op" id="8415381">]</span><span class="op" id="8415382">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415386">Root</span><span class="op" id="8415390">:</span>&nbsp;<span class="string" id="8415392">&#34;/test.go&#34;</span><span class="op" id="8415402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415406">Args</span><span class="op" id="8415410">:</span>&nbsp;<span class="op" id="8415412">[</span><span class="op" id="8415413">]</span><span class="builtintype" id="8415414">string</span><span class="op" id="8415420">{</span><span class="string" id="8415421">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8415454">}</span><span class="op" id="8415455">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8415458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8415461">expectedMap</span>&nbsp;<span class="op" id="8415473">:=</span>&nbsp;<span class="keyword" id="8415476">map</span><span class="op" id="8415479">[</span><span class="builtintype" id="8415480">string</span><span class="op" id="8415486">]</span><span class="builtintype" id="8415487">string</span><span class="op" id="8415493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415497">&#34;test&#34;</span><span class="op" id="8415503">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415522">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="8415540">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415544">&#34;param-a&#34;</span><span class="op" id="8415553">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415569">&#34;b&#34;</span><span class="op" id="8415572">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415576">&#34;param-foo&#34;</span><span class="op" id="8415587">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415601">&#34;bar&#34;</span><span class="op" id="8415606">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415610">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="8415633">:</span>&nbsp;<span class="string" id="8415635">&#34;CGI/1.1&#34;</span><span class="op" id="8415644">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415648">&#34;env-HTTP_HOST&#34;</span><span class="op" id="8415663">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415673">&#34;example.com&#34;</span><span class="op" id="8415686">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415690">&#34;env-PATH_INFO&#34;</span><span class="op" id="8415705">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415715">&#34;&#34;</span><span class="op" id="8415717">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415721">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8415739">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415746">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="8415759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415763">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="8415780">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415788">&#34;1.2.3.4&#34;</span><span class="op" id="8415797">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415801">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="8415818">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415826">&#34;1.2.3.4&#34;</span><span class="op" id="8415835">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415839">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="8415859">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415864">&#34;GET&#34;</span><span class="op" id="8415869">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415873">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8415890">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415898">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="8415920">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415924">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8415945">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="8415949">os</span><span class="op" id="8415951">.</span><span class="ident" id="8415952">Args</span><span class="op" id="8415956">[</span><span class="num" id="8415957">0</span><span class="op" id="8415958">]</span><span class="op" id="8415959">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415963">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8415980">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8415988">&#34;/test.go&#34;</span><span class="op" id="8415998">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8416002">&#34;env-SERVER_NAME&#34;</span><span class="op" id="8416019">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8416027">&#34;example.com&#34;</span><span class="op" id="8416040">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8416044">&#34;env-SERVER_PORT&#34;</span><span class="op" id="8416061">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8416069">&#34;80&#34;</span><span class="op" id="8416073">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8416077">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="8416098">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8416102">&#34;go&#34;</span><span class="op" id="8416106">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416112">replay</span>&nbsp;<span class="op" id="8416119">:=</span>&nbsp;<span class="ident" id="8416122">runCgiTest</span><span class="op" id="8416132">(</span><span class="ident" id="8416133">t</span><span class="op" id="8416134">,</span>&nbsp;<span class="ident" id="8416136">h</span><span class="op" id="8416137">,</span>&nbsp;<span class="string" id="8416139">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8416197">,</span>&nbsp;<span class="ident" id="8416199">expectedMap</span><span class="op" id="8416210">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416214">if</span>&nbsp;<span class="ident" id="8416217">expected</span><span class="op" id="8416225">,</span>&nbsp;<span class="ident" id="8416227">got</span>&nbsp;<span class="op" id="8416231">:=</span>&nbsp;<span class="string" id="8416234">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="8416260">,</span>&nbsp;<span class="ident" id="8416262">replay</span><span class="op" id="8416268">.</span><span class="ident" id="8416269">Header</span><span class="op" id="8416275">(</span><span class="op" id="8416276">)</span><span class="op" id="8416277">.</span><span class="ident" id="8416278">Get</span><span class="op" id="8416281">(</span><span class="string" id="8416282">&#34;Content-Type&#34;</span><span class="op" id="8416296">)</span><span class="op" id="8416297">;</span>&nbsp;<span class="ident" id="8416299">got</span>&nbsp;<span class="op" id="8416303">!=</span>&nbsp;<span class="ident" id="8416306">expected</span>&nbsp;<span class="op" id="8416315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416319">t</span><span class="op" id="8416320">.</span><span class="ident" id="8416321">Errorf</span><span class="op" id="8416327">(</span><span class="string" id="8416328">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8416367">,</span>&nbsp;<span class="ident" id="8416369">got</span><span class="op" id="8416372">,</span>&nbsp;<span class="ident" id="8416374">expected</span><span class="op" id="8416382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416388">if</span>&nbsp;<span class="ident" id="8416391">expected</span><span class="op" id="8416399">,</span>&nbsp;<span class="ident" id="8416401">got</span>&nbsp;<span class="op" id="8416405">:=</span>&nbsp;<span class="string" id="8416408">&#34;X-Test-Value&#34;</span><span class="op" id="8416422">,</span>&nbsp;<span class="ident" id="8416424">replay</span><span class="op" id="8416430">.</span><span class="ident" id="8416431">Header</span><span class="op" id="8416437">(</span><span class="op" id="8416438">)</span><span class="op" id="8416439">.</span><span class="ident" id="8416440">Get</span><span class="op" id="8416443">(</span><span class="string" id="8416444">&#34;X-Test-Header&#34;</span><span class="op" id="8416459">)</span><span class="op" id="8416460">;</span>&nbsp;<span class="ident" id="8416462">got</span>&nbsp;<span class="op" id="8416466">!=</span>&nbsp;<span class="ident" id="8416469">expected</span>&nbsp;<span class="op" id="8416478">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416482">t</span><span class="op" id="8416483">.</span><span class="ident" id="8416484">Errorf</span><span class="op" id="8416490">(</span><span class="string" id="8416491">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8416531">,</span>&nbsp;<span class="ident" id="8416533">got</span><span class="op" id="8416536">,</span>&nbsp;<span class="ident" id="8416538">expected</span><span class="op" id="8416546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416549">}</span><br>
<span class="lineno"></span><span class="op" id="8416551">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8416554">type</span>&nbsp;<span class="ident" id="8416559">customWriterRecorder</span>&nbsp;<span class="keyword" id="8416580">struct</span>&nbsp;<span class="op" id="8416587">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416590">w</span>&nbsp;<span class="ident" id="8416592">io</span><span class="op" id="8416594">.</span><span class="ident" id="8416595">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416603">*</span><span class="ident" id="8416604">httptest</span><span class="op" id="8416612">.</span><span class="ident" id="8416613">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="8416630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8416633">func</span>&nbsp;<span class="op" id="8416638">(</span><span class="ident" id="8416639">r</span>&nbsp;<span class="op" id="8416641">*</span><span class="ident" id="8416642">customWriterRecorder</span><span class="op" id="8416662">)</span>&nbsp;<span class="ident" id="8416664">Write</span><span class="op" id="8416669">(</span><span class="ident" id="8416670">p</span>&nbsp;<span class="op" id="8416672">[</span><span class="op" id="8416673">]</span><span class="builtintype" id="8416674">byte</span><span class="op" id="8416678">)</span>&nbsp;<span class="op" id="8416680">(</span><span class="ident" id="8416681">n</span>&nbsp;<span class="builtintype" id="8416683">int</span><span class="op" id="8416686">,</span>&nbsp;<span class="ident" id="8416688">err</span>&nbsp;<span class="builtintype" id="8416692">error</span><span class="op" id="8416697">)</span>&nbsp;<span class="op" id="8416699">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416702">return</span>&nbsp;<span class="ident" id="8416709">r</span><span class="op" id="8416710">.</span><span class="ident" id="8416711">w</span><span class="op" id="8416712">.</span><span class="ident" id="8416713">Write</span><span class="op" id="8416718">(</span><span class="ident" id="8416719">p</span><span class="op" id="8416720">)</span><br>
<span class="lineno"></span><span class="op" id="8416722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8416725">type</span>&nbsp;<span class="ident" id="8416730">limitWriter</span>&nbsp;<span class="keyword" id="8416742">struct</span>&nbsp;<span class="op" id="8416749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416752">w</span>&nbsp;<span class="ident" id="8416754">io</span><span class="op" id="8416756">.</span><span class="ident" id="8416757">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416765">n</span>&nbsp;<span class="builtintype" id="8416767">int</span><br>
<span class="lineno"></span><span class="op" id="8416771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8416774">func</span>&nbsp;<span class="op" id="8416779">(</span><span class="ident" id="8416780">w</span>&nbsp;<span class="op" id="8416782">*</span><span class="ident" id="8416783">limitWriter</span><span class="op" id="8416794">)</span>&nbsp;<span class="ident" id="8416796">Write</span><span class="op" id="8416801">(</span><span class="ident" id="8416802">p</span>&nbsp;<span class="op" id="8416804">[</span><span class="op" id="8416805">]</span><span class="builtintype" id="8416806">byte</span><span class="op" id="8416810">)</span>&nbsp;<span class="op" id="8416812">(</span><span class="ident" id="8416813">n</span>&nbsp;<span class="builtintype" id="8416815">int</span><span class="op" id="8416818">,</span>&nbsp;<span class="ident" id="8416820">err</span>&nbsp;<span class="builtintype" id="8416824">error</span><span class="op" id="8416829">)</span>&nbsp;<span class="op" id="8416831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416834">if</span>&nbsp;<span class="builtinfunc" id="8416837">len</span><span class="op" id="8416840">(</span><span class="ident" id="8416841">p</span><span class="op" id="8416842">)</span>&nbsp;<span class="op" id="8416844">&gt;</span>&nbsp;<span class="ident" id="8416846">w</span><span class="op" id="8416847">.</span><span class="ident" id="8416848">n</span>&nbsp;<span class="op" id="8416850">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416854">p</span>&nbsp;<span class="op" id="8416856">=</span>&nbsp;<span class="ident" id="8416858">p</span><span class="op" id="8416859">[</span><span class="op" id="8416860">:</span><span class="ident" id="8416861">w</span><span class="op" id="8416862">.</span><span class="ident" id="8416863">n</span><span class="op" id="8416864">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416870">if</span>&nbsp;<span class="builtinfunc" id="8416873">len</span><span class="op" id="8416876">(</span><span class="ident" id="8416877">p</span><span class="op" id="8416878">)</span>&nbsp;<span class="op" id="8416880">&gt;</span>&nbsp;<span class="num" id="8416882">0</span>&nbsp;<span class="op" id="8416884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416888">n</span><span class="op" id="8416889">,</span>&nbsp;<span class="ident" id="8416891">err</span>&nbsp;<span class="op" id="8416895">=</span>&nbsp;<span class="ident" id="8416897">w</span><span class="op" id="8416898">.</span><span class="ident" id="8416899">w</span><span class="op" id="8416900">.</span><span class="ident" id="8416901">Write</span><span class="op" id="8416906">(</span><span class="ident" id="8416907">p</span><span class="op" id="8416908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416912">w</span><span class="op" id="8416913">.</span><span class="ident" id="8416914">n</span>&nbsp;<span class="op" id="8416916">-=</span>&nbsp;<span class="ident" id="8416919">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416925">if</span>&nbsp;<span class="ident" id="8416928">w</span><span class="op" id="8416929">.</span><span class="ident" id="8416930">n</span>&nbsp;<span class="op" id="8416932">==</span>&nbsp;<span class="num" id="8416935">0</span>&nbsp;<span class="op" id="8416937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8416941">err</span>&nbsp;<span class="op" id="8416945">=</span>&nbsp;<span class="ident" id="8416947">errors</span><span class="op" id="8416953">.</span><span class="ident" id="8416954">New</span><span class="op" id="8416957">(</span><span class="string" id="8416958">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="8416976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8416979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8416982">return</span><br>
<span class="lineno">90</span><span class="op" id="8416989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8416992">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="8417062">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="8417089">func</span>&nbsp;<span class="ident" id="8417094">TestKillChildAfterCopyError</span><span class="op" id="8417121">(</span><span class="ident" id="8417122">t</span>&nbsp;<span class="op" id="8417124">*</span><span class="ident" id="8417125">testing</span><span class="op" id="8417132">.</span><span class="ident" id="8417133">T</span><span class="op" id="8417134">)</span>&nbsp;<span class="op" id="8417136">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417139">if</span>&nbsp;<span class="ident" id="8417142">runtime</span><span class="op" id="8417149">.</span><span class="ident" id="8417150">GOOS</span>&nbsp;<span class="op" id="8417155">==</span>&nbsp;<span class="string" id="8417158">&#34;nacl&#34;</span>&nbsp;<span class="op" id="8417165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417169">t</span><span class="op" id="8417170">.</span><span class="ident" id="8417171">Skip</span><span class="op" id="8417175">(</span><span class="string" id="8417176">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="8417194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8417197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417201">defer</span>&nbsp;<span class="keyword" id="8417207">func</span><span class="op" id="8417211">(</span><span class="op" id="8417212">)</span>&nbsp;<span class="op" id="8417214">{</span>&nbsp;<span class="ident" id="8417216">testHookStartProcess</span>&nbsp;<span class="op" id="8417237">=</span>&nbsp;<span class="ident" id="8417239">nil</span>&nbsp;<span class="op" id="8417243">}</span><span class="op" id="8417244">(</span><span class="op" id="8417245">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417248">proc</span>&nbsp;<span class="op" id="8417253">:=</span>&nbsp;<span class="builtinfunc" id="8417256">make</span><span class="op" id="8417260">(</span><span class="keyword" id="8417261">chan</span>&nbsp;<span class="op" id="8417266">*</span><span class="ident" id="8417267">os</span><span class="op" id="8417269">.</span><span class="ident" id="8417270">Process</span><span class="op" id="8417277">,</span>&nbsp;<span class="num" id="8417279">1</span><span class="op" id="8417280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417283">testHookStartProcess</span>&nbsp;<span class="op" id="8417304">=</span>&nbsp;<span class="keyword" id="8417306">func</span><span class="op" id="8417310">(</span><span class="ident" id="8417311">p</span>&nbsp;<span class="op" id="8417313">*</span><span class="ident" id="8417314">os</span><span class="op" id="8417316">.</span><span class="ident" id="8417317">Process</span><span class="op" id="8417324">)</span>&nbsp;<span class="op" id="8417326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417330">proc</span>&nbsp;<span class="op" id="8417335">&lt;-</span>&nbsp;<span class="ident" id="8417338">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8417341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417345">h</span>&nbsp;<span class="op" id="8417347">:=</span>&nbsp;<span class="op" id="8417350">&amp;</span><span class="ident" id="8417351">Handler</span><span class="op" id="8417358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417362">Path</span><span class="op" id="8417366">:</span>&nbsp;<span class="ident" id="8417368">os</span><span class="op" id="8417370">.</span><span class="ident" id="8417371">Args</span><span class="op" id="8417375">[</span><span class="num" id="8417376">0</span><span class="op" id="8417377">]</span><span class="op" id="8417378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417382">Root</span><span class="op" id="8417386">:</span>&nbsp;<span class="string" id="8417388">&#34;/test.go&#34;</span><span class="op" id="8417398">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417402">Args</span><span class="op" id="8417406">:</span>&nbsp;<span class="op" id="8417408">[</span><span class="op" id="8417409">]</span><span class="builtintype" id="8417410">string</span><span class="op" id="8417416">{</span><span class="string" id="8417417">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8417450">}</span><span class="op" id="8417451">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8417454">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417457">req</span><span class="op" id="8417460">,</span>&nbsp;<span class="ident" id="8417462">_</span>&nbsp;<span class="op" id="8417464">:=</span>&nbsp;<span class="ident" id="8417467">http</span><span class="op" id="8417471">.</span><span class="ident" id="8417472">NewRequest</span><span class="op" id="8417482">(</span><span class="string" id="8417483">&#34;GET&#34;</span><span class="op" id="8417488">,</span>&nbsp;<span class="string" id="8417490">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="8417535">,</span>&nbsp;<span class="ident" id="8417537">nil</span><span class="op" id="8417540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417543">rec</span>&nbsp;<span class="op" id="8417547">:=</span>&nbsp;<span class="ident" id="8417550">httptest</span><span class="op" id="8417558">.</span><span class="ident" id="8417559">NewRecorder</span><span class="op" id="8417570">(</span><span class="op" id="8417571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417574">var</span>&nbsp;<span class="ident" id="8417578">out</span>&nbsp;<span class="ident" id="8417582">bytes</span><span class="op" id="8417587">.</span><span class="ident" id="8417588">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417596">const</span>&nbsp;<span class="ident" id="8417602">writeLen</span>&nbsp;<span class="op" id="8417611">=</span>&nbsp;<span class="num" id="8417613">50</span>&nbsp;<span class="op" id="8417616">&lt;&lt;</span>&nbsp;<span class="num" id="8417619">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417623">rw</span>&nbsp;<span class="op" id="8417626">:=</span>&nbsp;<span class="op" id="8417629">&amp;</span><span class="ident" id="8417630">customWriterRecorder</span><span class="op" id="8417650">{</span><span class="op" id="8417651">&amp;</span><span class="ident" id="8417652">limitWriter</span><span class="op" id="8417663">{</span><span class="op" id="8417664">&amp;</span><span class="ident" id="8417665">out</span><span class="op" id="8417668">,</span>&nbsp;<span class="ident" id="8417670">writeLen</span><span class="op" id="8417678">}</span><span class="op" id="8417679">,</span>&nbsp;<span class="ident" id="8417681">rec</span><span class="op" id="8417684">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417688">donec</span>&nbsp;<span class="op" id="8417694">:=</span>&nbsp;<span class="builtinfunc" id="8417697">make</span><span class="op" id="8417701">(</span><span class="keyword" id="8417702">chan</span>&nbsp;<span class="builtintype" id="8417707">bool</span><span class="op" id="8417711">,</span>&nbsp;<span class="num" id="8417713">1</span><span class="op" id="8417714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417717">go</span>&nbsp;<span class="keyword" id="8417720">func</span><span class="op" id="8417724">(</span><span class="op" id="8417725">)</span>&nbsp;<span class="op" id="8417727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417731">h</span><span class="op" id="8417732">.</span><span class="ident" id="8417733">ServeHTTP</span><span class="op" id="8417742">(</span><span class="ident" id="8417743">rw</span><span class="op" id="8417745">,</span>&nbsp;<span class="ident" id="8417747">req</span><span class="op" id="8417750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417754">donec</span>&nbsp;<span class="op" id="8417760">&lt;-</span>&nbsp;<span class="builtintype" id="8417763">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8417769">}</span><span class="op" id="8417770">(</span><span class="op" id="8417771">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417775">select</span>&nbsp;<span class="op" id="8417782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417785">case</span>&nbsp;<span class="op" id="8417790">&lt;-</span><span class="ident" id="8417792">donec</span><span class="op" id="8417797">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417801">if</span>&nbsp;<span class="ident" id="8417804">out</span><span class="op" id="8417807">.</span><span class="ident" id="8417808">Len</span><span class="op" id="8417811">(</span><span class="op" id="8417812">)</span>&nbsp;<span class="op" id="8417814">!=</span>&nbsp;<span class="ident" id="8417817">writeLen</span>&nbsp;<span class="op" id="8417826">||</span>&nbsp;<span class="ident" id="8417829">out</span><span class="op" id="8417832">.</span><span class="ident" id="8417833">Bytes</span><span class="op" id="8417838">(</span><span class="op" id="8417839">)</span><span class="op" id="8417840">[</span><span class="num" id="8417841">0</span><span class="op" id="8417842">]</span>&nbsp;<span class="op" id="8417844">!=</span>&nbsp;<span class="string" id="8417847">&#39;a&#39;</span>&nbsp;<span class="op" id="8417851">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417856">t</span><span class="op" id="8417857">.</span><span class="ident" id="8417858">Errorf</span><span class="op" id="8417864">(</span><span class="string" id="8417865">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="8417888">,</span>&nbsp;<span class="ident" id="8417890">out</span><span class="op" id="8417893">.</span><span class="ident" id="8417894">Bytes</span><span class="op" id="8417899">(</span><span class="op" id="8417900">)</span><span class="op" id="8417901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8417905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8417908">case</span>&nbsp;<span class="op" id="8417913">&lt;-</span><span class="ident" id="8417915">time</span><span class="op" id="8417919">.</span><span class="ident" id="8417920">After</span><span class="op" id="8417925">(</span><span class="num" id="8417926">5</span>&nbsp;<span class="op" id="8417928">*</span>&nbsp;<span class="ident" id="8417930">time</span><span class="op" id="8417934">.</span><span class="ident" id="8417935">Second</span><span class="op" id="8417941">)</span><span class="op" id="8417942">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8417946">t</span><span class="op" id="8417947">.</span><span class="ident" id="8417948">Errorf</span><span class="op" id="8417954">(</span><span class="string" id="8417955">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="8418015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8418019">select</span>&nbsp;<span class="op" id="8418026">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8418030">case</span>&nbsp;<span class="ident" id="8418035">p</span>&nbsp;<span class="op" id="8418037">:=</span>&nbsp;<span class="op" id="8418040">&lt;-</span><span class="ident" id="8418042">proc</span><span class="op" id="8418046">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418051">p</span><span class="op" id="8418052">.</span><span class="ident" id="8418053">Kill</span><span class="op" id="8418057">(</span><span class="op" id="8418058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418063">t</span><span class="op" id="8418064">.</span><span class="ident" id="8418065">Logf</span><span class="op" id="8418069">(</span><span class="string" id="8418070">&#34;killed&nbsp;process&#34;</span><span class="op" id="8418086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8418090">default</span><span class="op" id="8418097">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418102">t</span><span class="op" id="8418103">.</span><span class="ident" id="8418104">Logf</span><span class="op" id="8418108">(</span><span class="string" id="8418109">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="8418130">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8418134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8418137">}</span><br>
<span class="lineno"></span><span class="op" id="8418139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8418142">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="8418199">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="8418224">func</span>&nbsp;<span class="ident" id="8418229">TestChildOnlyHeaders</span><span class="op" id="8418249">(</span><span class="ident" id="8418250">t</span>&nbsp;<span class="op" id="8418252">*</span><span class="ident" id="8418253">testing</span><span class="op" id="8418260">.</span><span class="ident" id="8418261">T</span><span class="op" id="8418262">)</span>&nbsp;<span class="op" id="8418264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8418267">if</span>&nbsp;<span class="ident" id="8418270">runtime</span><span class="op" id="8418277">.</span><span class="ident" id="8418278">GOOS</span>&nbsp;<span class="op" id="8418283">==</span>&nbsp;<span class="string" id="8418286">&#34;nacl&#34;</span>&nbsp;<span class="op" id="8418293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418297">t</span><span class="op" id="8418298">.</span><span class="ident" id="8418299">Skip</span><span class="op" id="8418303">(</span><span class="string" id="8418304">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="8418322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8418325">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418329">h</span>&nbsp;<span class="op" id="8418331">:=</span>&nbsp;<span class="op" id="8418334">&amp;</span><span class="ident" id="8418335">Handler</span><span class="op" id="8418342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418346">Path</span><span class="op" id="8418350">:</span>&nbsp;<span class="ident" id="8418352">os</span><span class="op" id="8418354">.</span><span class="ident" id="8418355">Args</span><span class="op" id="8418359">[</span><span class="num" id="8418360">0</span><span class="op" id="8418361">]</span><span class="op" id="8418362">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418366">Root</span><span class="op" id="8418370">:</span>&nbsp;<span class="string" id="8418372">&#34;/test.go&#34;</span><span class="op" id="8418382">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418386">Args</span><span class="op" id="8418390">:</span>&nbsp;<span class="op" id="8418392">[</span><span class="op" id="8418393">]</span><span class="builtintype" id="8418394">string</span><span class="op" id="8418400">{</span><span class="string" id="8418401">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8418434">}</span><span class="op" id="8418435">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8418438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418441">expectedMap</span>&nbsp;<span class="op" id="8418453">:=</span>&nbsp;<span class="keyword" id="8418456">map</span><span class="op" id="8418459">[</span><span class="builtintype" id="8418460">string</span><span class="op" id="8418466">]</span><span class="builtintype" id="8418467">string</span><span class="op" id="8418473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8418477">&#34;_body&#34;</span><span class="op" id="8418484">:</span>&nbsp;<span class="string" id="8418486">&#34;&#34;</span><span class="op" id="8418488">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8418491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418494">replay</span>&nbsp;<span class="op" id="8418501">:=</span>&nbsp;<span class="ident" id="8418504">runCgiTest</span><span class="op" id="8418514">(</span><span class="ident" id="8418515">t</span><span class="op" id="8418516">,</span>&nbsp;<span class="ident" id="8418518">h</span><span class="op" id="8418519">,</span>&nbsp;<span class="string" id="8418521">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8418577">,</span>&nbsp;<span class="ident" id="8418579">expectedMap</span><span class="op" id="8418590">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8418593">if</span>&nbsp;<span class="ident" id="8418596">expected</span><span class="op" id="8418604">,</span>&nbsp;<span class="ident" id="8418606">got</span>&nbsp;<span class="op" id="8418610">:=</span>&nbsp;<span class="string" id="8418613">&#34;X-Test-Value&#34;</span><span class="op" id="8418627">,</span>&nbsp;<span class="ident" id="8418629">replay</span><span class="op" id="8418635">.</span><span class="ident" id="8418636">Header</span><span class="op" id="8418642">(</span><span class="op" id="8418643">)</span><span class="op" id="8418644">.</span><span class="ident" id="8418645">Get</span><span class="op" id="8418648">(</span><span class="string" id="8418649">&#34;X-Test-Header&#34;</span><span class="op" id="8418664">)</span><span class="op" id="8418665">;</span>&nbsp;<span class="ident" id="8418667">got</span>&nbsp;<span class="op" id="8418671">!=</span>&nbsp;<span class="ident" id="8418674">expected</span>&nbsp;<span class="op" id="8418683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8418687">t</span><span class="op" id="8418688">.</span><span class="ident" id="8418689">Errorf</span><span class="op" id="8418695">(</span><span class="string" id="8418696">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8418736">,</span>&nbsp;<span class="ident" id="8418738">got</span><span class="op" id="8418741">,</span>&nbsp;<span class="ident" id="8418743">expected</span><span class="op" id="8418751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8418754">}</span><br>
<span class="lineno"></span><span class="op" id="8418756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="8418759">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="8418784">func</span>&nbsp;<span class="ident" id="8418789">Test500WithNoHeaders</span><span class="op" id="8418809">(</span><span class="ident" id="8418810">t</span>&nbsp;<span class="op" id="8418812">*</span><span class="ident" id="8418813">testing</span><span class="op" id="8418820">.</span><span class="ident" id="8418821">T</span><span class="op" id="8418822">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8418828">{</span>&nbsp;<span class="ident" id="8418830">want500Test</span><span class="op" id="8418841">(</span><span class="ident" id="8418842">t</span><span class="op" id="8418843">,</span>&nbsp;<span class="string" id="8418845">&#34;/immediate-disconnect&#34;</span><span class="op" id="8418868">)</span>&nbsp;<span class="op" id="8418870">}</span><br>
<span class="lineno"></span><span class="keyword" id="8418872">func</span>&nbsp;<span class="ident" id="8418877">Test500WithNoContentType</span><span class="op" id="8418901">(</span><span class="ident" id="8418902">t</span>&nbsp;<span class="op" id="8418904">*</span><span class="ident" id="8418905">testing</span><span class="op" id="8418912">.</span><span class="ident" id="8418913">T</span><span class="op" id="8418914">)</span>&nbsp;<span class="op" id="8418916">{</span>&nbsp;<span class="ident" id="8418918">want500Test</span><span class="op" id="8418929">(</span><span class="ident" id="8418930">t</span><span class="op" id="8418931">,</span>&nbsp;<span class="string" id="8418933">&#34;/no-content-type&#34;</span><span class="op" id="8418951">)</span>&nbsp;<span class="op" id="8418953">}</span><br>
<span class="lineno"></span><span class="keyword" id="8418955">func</span>&nbsp;<span class="ident" id="8418960">Test500WithEmptyHeaders</span><span class="op" id="8418983">(</span><span class="ident" id="8418984">t</span>&nbsp;<span class="op" id="8418986">*</span><span class="ident" id="8418987">testing</span><span class="op" id="8418994">.</span><span class="ident" id="8418995">T</span><span class="op" id="8418996">)</span>&nbsp;&nbsp;<span class="op" id="8418999">{</span>&nbsp;<span class="ident" id="8419001">want500Test</span><span class="op" id="8419012">(</span><span class="ident" id="8419013">t</span><span class="op" id="8419014">,</span>&nbsp;<span class="string" id="8419016">&#34;/empty-headers&#34;</span><span class="op" id="8419032">)</span>&nbsp;<span class="op" id="8419034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="8419037">func</span>&nbsp;<span class="ident" id="8419042">want500Test</span><span class="op" id="8419053">(</span><span class="ident" id="8419054">t</span>&nbsp;<span class="op" id="8419056">*</span><span class="ident" id="8419057">testing</span><span class="op" id="8419064">.</span><span class="ident" id="8419065">T</span><span class="op" id="8419066">,</span>&nbsp;<span class="ident" id="8419068">path</span>&nbsp;<span class="builtintype" id="8419073">string</span><span class="op" id="8419079">)</span>&nbsp;<span class="op" id="8419081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419084">h</span>&nbsp;<span class="op" id="8419086">:=</span>&nbsp;<span class="op" id="8419089">&amp;</span><span class="ident" id="8419090">Handler</span><span class="op" id="8419097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419101">Path</span><span class="op" id="8419105">:</span>&nbsp;<span class="ident" id="8419107">os</span><span class="op" id="8419109">.</span><span class="ident" id="8419110">Args</span><span class="op" id="8419114">[</span><span class="num" id="8419115">0</span><span class="op" id="8419116">]</span><span class="op" id="8419117">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419121">Root</span><span class="op" id="8419125">:</span>&nbsp;<span class="string" id="8419127">&#34;/test.go&#34;</span><span class="op" id="8419137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419141">Args</span><span class="op" id="8419145">:</span>&nbsp;<span class="op" id="8419147">[</span><span class="op" id="8419148">]</span><span class="builtintype" id="8419149">string</span><span class="op" id="8419155">{</span><span class="string" id="8419156">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8419189">}</span><span class="op" id="8419190">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8419193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419196">expectedMap</span>&nbsp;<span class="op" id="8419208">:=</span>&nbsp;<span class="keyword" id="8419211">map</span><span class="op" id="8419214">[</span><span class="builtintype" id="8419215">string</span><span class="op" id="8419221">]</span><span class="builtintype" id="8419222">string</span><span class="op" id="8419228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8419232">&#34;_body&#34;</span><span class="op" id="8419239">:</span>&nbsp;<span class="string" id="8419241">&#34;&#34;</span><span class="op" id="8419243">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8419246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419249">replay</span>&nbsp;<span class="op" id="8419256">:=</span>&nbsp;<span class="ident" id="8419259">runCgiTest</span><span class="op" id="8419269">(</span><span class="ident" id="8419270">t</span><span class="op" id="8419271">,</span>&nbsp;<span class="ident" id="8419273">h</span><span class="op" id="8419274">,</span>&nbsp;<span class="string" id="8419276">&#34;GET&nbsp;&#34;</span><span class="op" id="8419282">+</span><span class="ident" id="8419283">path</span><span class="op" id="8419287">+</span><span class="string" id="8419288">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8419322">,</span>&nbsp;<span class="ident" id="8419324">expectedMap</span><span class="op" id="8419335">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8419338">if</span>&nbsp;<span class="ident" id="8419341">replay</span><span class="op" id="8419347">.</span><span class="ident" id="8419348">Code</span>&nbsp;<span class="op" id="8419353">!=</span>&nbsp;<span class="num" id="8419356">500</span>&nbsp;<span class="op" id="8419360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419364">t</span><span class="op" id="8419365">.</span><span class="ident" id="8419366">Errorf</span><span class="op" id="8419372">(</span><span class="string" id="8419373">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="8419396">,</span>&nbsp;<span class="ident" id="8419398">replay</span><span class="op" id="8419404">.</span><span class="ident" id="8419405">Code</span><span class="op" id="8419409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8419412">}</span><br>
<span class="lineno"></span><span class="op" id="8419414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="8419417">type</span>&nbsp;<span class="ident" id="8419422">neverEnding</span>&nbsp;<span class="builtintype" id="8419434">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8419440">func</span>&nbsp;<span class="op" id="8419445">(</span><span class="ident" id="8419446">b</span>&nbsp;<span class="ident" id="8419448">neverEnding</span><span class="op" id="8419459">)</span>&nbsp;<span class="ident" id="8419461">Read</span><span class="op" id="8419465">(</span><span class="ident" id="8419466">p</span>&nbsp;<span class="op" id="8419468">[</span><span class="op" id="8419469">]</span><span class="builtintype" id="8419470">byte</span><span class="op" id="8419474">)</span>&nbsp;<span class="op" id="8419476">(</span><span class="ident" id="8419477">n</span>&nbsp;<span class="builtintype" id="8419479">int</span><span class="op" id="8419482">,</span>&nbsp;<span class="ident" id="8419484">err</span>&nbsp;<span class="builtintype" id="8419488">error</span><span class="op" id="8419493">)</span>&nbsp;<span class="op" id="8419495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8419498">for</span>&nbsp;<span class="ident" id="8419502">i</span>&nbsp;<span class="op" id="8419504">:=</span>&nbsp;<span class="keyword" id="8419507">range</span>&nbsp;<span class="ident" id="8419513">p</span>&nbsp;<span class="op" id="8419515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419519">p</span><span class="op" id="8419520">[</span><span class="ident" id="8419521">i</span><span class="op" id="8419522">]</span>&nbsp;<span class="op" id="8419524">=</span>&nbsp;<span class="builtintype" id="8419526">byte</span><span class="op" id="8419530">(</span><span class="ident" id="8419531">b</span><span class="op" id="8419532">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8419535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8419538">return</span>&nbsp;<span class="builtinfunc" id="8419545">len</span><span class="op" id="8419548">(</span><span class="ident" id="8419549">p</span><span class="op" id="8419550">)</span><span class="op" id="8419551">,</span>&nbsp;<span class="ident" id="8419553">nil</span><br>
<span class="lineno"></span><span class="op" id="8419557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8419560">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="8419590">func</span>&nbsp;<span class="ident" id="8419595">TestBeChildCGIProcess</span><span class="op" id="8419616">(</span><span class="ident" id="8419617">t</span>&nbsp;<span class="op" id="8419619">*</span><span class="ident" id="8419620">testing</span><span class="op" id="8419627">.</span><span class="ident" id="8419628">T</span><span class="op" id="8419629">)</span>&nbsp;<span class="op" id="8419631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8419634">if</span>&nbsp;<span class="ident" id="8419637">os</span><span class="op" id="8419639">.</span><span class="ident" id="8419640">Getenv</span><span class="op" id="8419646">(</span><span class="string" id="8419647">&#34;REQUEST_METHOD&#34;</span><span class="op" id="8419663">)</span>&nbsp;<span class="op" id="8419665">==</span>&nbsp;<span class="string" id="8419668">&#34;&#34;</span>&nbsp;<span class="op" id="8419671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8419675">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8419721">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8419729">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8419732">switch</span>&nbsp;<span class="ident" id="8419739">os</span><span class="op" id="8419741">.</span><span class="ident" id="8419742">Getenv</span><span class="op" id="8419748">(</span><span class="string" id="8419749">&#34;REQUEST_URI&#34;</span><span class="op" id="8419762">)</span>&nbsp;<span class="op" id="8419764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8419767">case</span>&nbsp;<span class="string" id="8419772">&#34;/immediate-disconnect&#34;</span><span class="op" id="8419795">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419799">os</span><span class="op" id="8419801">.</span><span class="ident" id="8419802">Exit</span><span class="op" id="8419806">(</span><span class="num" id="8419807">0</span><span class="op" id="8419808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8419811">case</span>&nbsp;<span class="string" id="8419816">&#34;/no-content-type&#34;</span><span class="op" id="8419834">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419838">fmt</span><span class="op" id="8419841">.</span><span class="ident" id="8419842">Printf</span><span class="op" id="8419848">(</span><span class="string" id="8419849">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="8419879">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419883">os</span><span class="op" id="8419885">.</span><span class="ident" id="8419886">Exit</span><span class="op" id="8419890">(</span><span class="num" id="8419891">0</span><span class="op" id="8419892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8419895">case</span>&nbsp;<span class="string" id="8419900">&#34;/empty-headers&#34;</span><span class="op" id="8419916">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419920">fmt</span><span class="op" id="8419923">.</span><span class="ident" id="8419924">Printf</span><span class="op" id="8419930">(</span><span class="string" id="8419931">&#34;\nHello&#34;</span><span class="op" id="8419940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419944">os</span><span class="op" id="8419946">.</span><span class="ident" id="8419947">Exit</span><span class="op" id="8419951">(</span><span class="num" id="8419952">0</span><span class="op" id="8419953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8419956">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8419959">Serve</span><span class="op" id="8419964">(</span><span class="ident" id="8419965">http</span><span class="op" id="8419969">.</span><span class="ident" id="8419970">HandlerFunc</span><span class="op" id="8419981">(</span><span class="keyword" id="8419982">func</span><span class="op" id="8419986">(</span><span class="ident" id="8419987">rw</span>&nbsp;<span class="ident" id="8419990">http</span><span class="op" id="8419994">.</span><span class="ident" id="8419995">ResponseWriter</span><span class="op" id="8420009">,</span>&nbsp;<span class="ident" id="8420011">req</span>&nbsp;<span class="op" id="8420015">*</span><span class="ident" id="8420016">http</span><span class="op" id="8420020">.</span><span class="ident" id="8420021">Request</span><span class="op" id="8420028">)</span>&nbsp;<span class="op" id="8420030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8420034">rw</span><span class="op" id="8420036">.</span><span class="ident" id="8420037">Header</span><span class="op" id="8420043">(</span><span class="op" id="8420044">)</span><span class="op" id="8420045">.</span><span class="ident" id="8420046">Set</span><span class="op" id="8420049">(</span><span class="string" id="8420050">&#34;X-Test-Header&#34;</span><span class="op" id="8420065">,</span>&nbsp;<span class="string" id="8420067">&#34;X-Test-Value&#34;</span><span class="op" id="8420081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8420085">req</span><span class="op" id="8420088">.</span><span class="ident" id="8420089">ParseForm</span><span class="op" id="8420098">(</span><span class="op" id="8420099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8420103">if</span>&nbsp;<span class="ident" id="8420106">req</span><span class="op" id="8420109">.</span><span class="ident" id="8420110">FormValue</span><span class="op" id="8420119">(</span><span class="string" id="8420120">&#34;no-body&#34;</span><span class="op" id="8420129">)</span>&nbsp;<span class="op" id="8420131">==</span>&nbsp;<span class="string" id="8420134">&#34;1&#34;</span>&nbsp;<span class="op" id="8420138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8420143">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8420152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8420156">if</span>&nbsp;<span class="ident" id="8420159">req</span><span class="op" id="8420162">.</span><span class="ident" id="8420163">FormValue</span><span class="op" id="8420172">(</span><span class="string" id="8420173">&#34;write-forever&#34;</span><span class="op" id="8420188">)</span>&nbsp;<span class="op" id="8420190">==</span>&nbsp;<span class="string" id="8420193">&#34;1&#34;</span>&nbsp;<span class="op" id="8420197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8420202">io</span><span class="op" id="8420204">.</span><span class="ident" id="8420205">Copy</span><span class="op" id="8420209">(</span><span class="ident" id="8420210">rw</span><span class="op" id="8420212">,</span>&nbsp;<span class="ident" id="8420214">neverEnding</span><span class="op" id="8420225">(</span><span class="string" id="8420226">&#39;a&#39;</span><span class="op" id="8420229">)</span><span class="op" id="8420230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8420235">for</span>&nbsp;<span class="op" id="8420239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8420245">time</span><span class="op" id="8420249">.</span><span class="ident" id="8420250">Sleep</span><span class="op" id="8420255">(</span><span class="num" id="8420256">5</span>&nbsp;<span class="op" id="8420258">*</span>&nbsp;<span class="ident" id="8420260">time</span><span class="op" id="8420264">.</span><span class="ident" id="8420265">Second</span><span class="op" id="8420271">)</span>&nbsp;<span class="comment" id="8420273">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8420306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8420310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8420314">fmt</span><span class="op" id="8420317">.</span><span class="ident" id="8420318">Fprintf</span><span class="op" id="8420325">(</span><span class="ident" id="8420326">rw</span><span class="op" id="8420328">,</span>&nbsp;<span class="string" id="8420330">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="8420355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8420359">for</span>&nbsp;<span class="ident" id="8420363">k</span><span class="op" id="8420364">,</span>&nbsp;<span class="ident" id="8420366">vv</span>&nbsp;<span class="op" id="8420369">:=</span>&nbsp;<span class="keyword" id="8420372">range</span>&nbsp;<span class="ident" id="8420378">req</span><span class="op" id="8420381">.</span><span class="ident" id="8420382">Form</span>&nbsp;<span class="op" id="8420387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8420392">for</span>&nbsp;<span class="ident" id="8420396">_</span><span class="op" id="8420397">,</span>&nbsp;<span class="ident" id="8420399">v</span>&nbsp;<span class="op" id="8420401">:=</span>&nbsp;<span class="keyword" id="8420404">range</span>&nbsp;<span class="ident" id="8420410">vv</span>&nbsp;<span class="op" id="8420413">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8420419">fmt</span><span class="op" id="8420422">.</span><span class="ident" id="8420423">Fprintf</span><span class="op" id="8420430">(</span><span class="ident" id="8420431">rw</span><span class="op" id="8420433">,</span>&nbsp;<span class="string" id="8420435">&#34;param-%s=%s\n&#34;</span><span class="op" id="8420450">,</span>&nbsp;<span class="ident" id="8420452">k</span><span class="op" id="8420453">,</span>&nbsp;<span class="ident" id="8420455">v</span><span class="op" id="8420456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8420461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8420465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8420469">for</span>&nbsp;<span class="ident" id="8420473">_</span><span class="op" id="8420474">,</span>&nbsp;<span class="ident" id="8420476">kv</span>&nbsp;<span class="op" id="8420479">:=</span>&nbsp;<span class="keyword" id="8420482">range</span>&nbsp;<span class="ident" id="8420488">os</span><span class="op" id="8420490">.</span><span class="ident" id="8420491">Environ</span><span class="op" id="8420498">(</span><span class="op" id="8420499">)</span>&nbsp;<span class="op" id="8420501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8420506">fmt</span><span class="op" id="8420509">.</span><span class="ident" id="8420510">Fprintf</span><span class="op" id="8420517">(</span><span class="ident" id="8420518">rw</span><span class="op" id="8420520">,</span>&nbsp;<span class="string" id="8420522">&#34;env-%s\n&#34;</span><span class="op" id="8420532">,</span>&nbsp;<span class="ident" id="8420534">kv</span><span class="op" id="8420536">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8420540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8420543">}</span><span class="op" id="8420544">)</span><span class="op" id="8420545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8420548">os</span><span class="op" id="8420550">.</span><span class="ident" id="8420551">Exit</span><span class="op" id="8420555">(</span><span class="num" id="8420556">0</span><span class="op" id="8420557">)</span><br>
<span class="lineno"></span><span class="op" id="8420559">}</span>
</div>
</body>
</html>
