<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5002890">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5002945">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5002999">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5003050">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="5003095">//</span><br>
<span class="lineno"></span><span class="comment" id="5003098">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="5003165">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5003211">package</span>&nbsp;<span class="ident" id="5003219">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5003225">import</span>&nbsp;<span class="op" id="5003232">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003235">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003244">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003261">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003275">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003285">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003292">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003298">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003305">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003312">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003323">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003329">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003340">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5003348">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5003355">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5003358">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5003428">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="5003499">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="5003570">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5003638">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5003675">var</span>&nbsp;<span class="ident" id="5003679">DefaultTransport</span>&nbsp;<span class="ident" id="5003696">RoundTripper</span>&nbsp;<span class="op" id="5003709">=</span>&nbsp;<span class="op" id="5003711">&amp;</span><span class="ident" id="5003712">Transport</span><span class="op" id="5003721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003724">Proxy</span><span class="op" id="5003729">:</span>&nbsp;<span class="ident" id="5003731">ProxyFromEnvironment</span><span class="op" id="5003751">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003754">Dial</span><span class="op" id="5003758">:</span>&nbsp;<span class="op" id="5003760">(</span><span class="op" id="5003761">&amp;</span><span class="ident" id="5003762">net</span><span class="op" id="5003765">.</span><span class="ident" id="5003766">Dialer</span><span class="op" id="5003772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003776">Timeout</span><span class="op" id="5003783">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="5003787">30</span>&nbsp;<span class="op" id="5003790">*</span>&nbsp;<span class="ident" id="5003792">time</span><span class="op" id="5003796">.</span><span class="ident" id="5003797">Second</span><span class="op" id="5003803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003807">KeepAlive</span><span class="op" id="5003816">:</span>&nbsp;<span class="num" id="5003818">30</span>&nbsp;<span class="op" id="5003821">*</span>&nbsp;<span class="ident" id="5003823">time</span><span class="op" id="5003827">.</span><span class="ident" id="5003828">Second</span><span class="op" id="5003834">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5003837">}</span><span class="op" id="5003838">)</span><span class="op" id="5003839">.</span><span class="ident" id="5003840">Dial</span><span class="op" id="5003844">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5003847">TLSHandshakeTimeout</span><span class="op" id="5003866">:</span>&nbsp;<span class="num" id="5003868">10</span>&nbsp;<span class="op" id="5003871">*</span>&nbsp;<span class="ident" id="5003873">time</span><span class="op" id="5003877">.</span><span class="ident" id="5003878">Second</span><span class="op" id="5003884">,</span><br>
<span class="lineno">40</span><span class="op" id="5003886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5003889">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5003955">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="5003979">const</span>&nbsp;<span class="ident" id="5003985">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="5004012">=</span>&nbsp;<span class="num" id="5004014">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="5004017">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="5004087">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="5004155">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="5004214">type</span>&nbsp;<span class="ident" id="5004219">Transport</span>&nbsp;<span class="keyword" id="5004229">struct</span>&nbsp;<span class="op" id="5004236">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004239">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5004250">sync</span><span class="op" id="5004254">.</span><span class="ident" id="5004255">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004262">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5004273">bool</span>&nbsp;<span class="comment" id="5004278">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004325">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5004336">map</span><span class="op" id="5004339">[</span><span class="ident" id="5004340">connectMethodKey</span><span class="op" id="5004356">]</span><span class="op" id="5004357">[</span><span class="op" id="5004358">]</span><span class="op" id="5004359">*</span><span class="ident" id="5004360">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004373">idleConnCh</span>&nbsp;<span class="keyword" id="5004384">map</span><span class="op" id="5004387">[</span><span class="ident" id="5004388">connectMethodKey</span><span class="op" id="5004404">]</span><span class="keyword" id="5004405">chan</span>&nbsp;<span class="op" id="5004410">*</span><span class="ident" id="5004411">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004425">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5004437">sync</span><span class="op" id="5004441">.</span><span class="ident" id="5004442">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004449">reqCanceler</span>&nbsp;<span class="keyword" id="5004461">map</span><span class="op" id="5004464">[</span><span class="op" id="5004465">*</span><span class="ident" id="5004466">Request</span><span class="op" id="5004473">]</span><span class="keyword" id="5004474">func</span><span class="op" id="5004478">(</span><span class="op" id="5004479">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004483">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5004492">sync</span><span class="op" id="5004496">.</span><span class="ident" id="5004497">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004506">altProto</span>&nbsp;<span class="keyword" id="5004515">map</span><span class="op" id="5004518">[</span><span class="builtintype" id="5004519">string</span><span class="op" id="5004525">]</span><span class="ident" id="5004526">RoundTripper</span>&nbsp;<span class="comment" id="5004539">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5004585">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5004646">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5004704">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5004752">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004813">Proxy</span>&nbsp;<span class="keyword" id="5004819">func</span><span class="op" id="5004823">(</span><span class="op" id="5004824">*</span><span class="ident" id="5004825">Request</span><span class="op" id="5004832">)</span>&nbsp;<span class="op" id="5004834">(</span><span class="op" id="5004835">*</span><span class="ident" id="5004836">url</span><span class="op" id="5004839">.</span><span class="ident" id="5004840">URL</span><span class="op" id="5004843">,</span>&nbsp;<span class="builtintype" id="5004845">error</span><span class="op" id="5004850">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5004854">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5004916">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5004937">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5004975">Dial</span>&nbsp;<span class="keyword" id="5004980">func</span><span class="op" id="5004984">(</span><span class="ident" id="5004985">network</span><span class="op" id="5004992">,</span>&nbsp;<span class="ident" id="5004994">addr</span>&nbsp;<span class="builtintype" id="5004999">string</span><span class="op" id="5005005">)</span>&nbsp;<span class="op" id="5005007">(</span><span class="ident" id="5005008">net</span><span class="op" id="5005011">.</span><span class="ident" id="5005012">Conn</span><span class="op" id="5005016">,</span>&nbsp;<span class="builtintype" id="5005018">error</span><span class="op" id="5005023">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005027">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005088">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005140">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005144">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005202">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005206">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005265">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005326">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005390">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005418">DialTLS</span>&nbsp;<span class="keyword" id="5005426">func</span><span class="op" id="5005430">(</span><span class="ident" id="5005431">network</span><span class="op" id="5005438">,</span>&nbsp;<span class="ident" id="5005440">addr</span>&nbsp;<span class="builtintype" id="5005445">string</span><span class="op" id="5005451">)</span>&nbsp;<span class="op" id="5005453">(</span><span class="ident" id="5005454">net</span><span class="op" id="5005457">.</span><span class="ident" id="5005458">Conn</span><span class="op" id="5005462">,</span>&nbsp;<span class="builtintype" id="5005464">error</span><span class="op" id="5005469">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005473">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005537">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005596">TLSClientConfig</span>&nbsp;<span class="op" id="5005612">*</span><span class="ident" id="5005613">tls</span><span class="op" id="5005616">.</span><span class="ident" id="5005617">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005626">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005698">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005751">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="5005771">time</span><span class="op" id="5005775">.</span><span class="ident" id="5005776">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005787">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005854">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5005891">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="5005909">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005916">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5005977">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006036">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006093">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006154">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006214">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006269">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006323">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006341">DisableCompression</span>&nbsp;<span class="builtintype" id="5006360">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006367">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006431">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006476">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006516">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="5006536">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006542">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006606">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006667">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006726">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5006788">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="5006810">time</span><span class="op" id="5006814">.</span><span class="ident" id="5006815">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006826">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5006877">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="5006927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="5006930">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5006996">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="5007056">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="5007123">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="5007191">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="5007204">//</span><br>
<span class="lineno"></span><span class="comment" id="5007207">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5007267">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="5007329">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="5007387">//</span><br>
<span class="lineno">130</span><span class="comment" id="5007390">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5007460">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="5007529">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="5007556">//</span><br>
<span class="lineno"></span><span class="comment" id="5007559">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="5007629">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5007695">func</span>&nbsp;<span class="ident" id="5007700">ProxyFromEnvironment</span><span class="op" id="5007720">(</span><span class="ident" id="5007721">req</span>&nbsp;<span class="op" id="5007725">*</span><span class="ident" id="5007726">Request</span><span class="op" id="5007733">)</span>&nbsp;<span class="op" id="5007735">(</span><span class="op" id="5007736">*</span><span class="ident" id="5007737">url</span><span class="op" id="5007740">.</span><span class="ident" id="5007741">URL</span><span class="op" id="5007744">,</span>&nbsp;<span class="builtintype" id="5007746">error</span><span class="op" id="5007751">)</span>&nbsp;<span class="op" id="5007753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5007756">var</span>&nbsp;<span class="ident" id="5007760">proxy</span>&nbsp;<span class="builtintype" id="5007766">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5007774">if</span>&nbsp;<span class="ident" id="5007777">req</span><span class="op" id="5007780">.</span><span class="ident" id="5007781">URL</span><span class="op" id="5007784">.</span><span class="ident" id="5007785">Scheme</span>&nbsp;<span class="op" id="5007792">==</span>&nbsp;<span class="string" id="5007795">&#34;https&#34;</span>&nbsp;<span class="op" id="5007803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5007807">proxy</span>&nbsp;<span class="op" id="5007813">=</span>&nbsp;<span class="ident" id="5007815">httpsProxyEnv</span><span class="op" id="5007828">.</span><span class="ident" id="5007829">Get</span><span class="op" id="5007832">(</span><span class="op" id="5007833">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5007836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5007839">if</span>&nbsp;<span class="ident" id="5007842">proxy</span>&nbsp;<span class="op" id="5007848">==</span>&nbsp;<span class="string" id="5007851">&#34;&#34;</span>&nbsp;<span class="op" id="5007854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5007858">proxy</span>&nbsp;<span class="op" id="5007864">=</span>&nbsp;<span class="ident" id="5007866">httpProxyEnv</span><span class="op" id="5007878">.</span><span class="ident" id="5007879">Get</span><span class="op" id="5007882">(</span><span class="op" id="5007883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5007886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5007889">if</span>&nbsp;<span class="ident" id="5007892">proxy</span>&nbsp;<span class="op" id="5007898">==</span>&nbsp;<span class="string" id="5007901">&#34;&#34;</span>&nbsp;<span class="op" id="5007904">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5007908">return</span>&nbsp;<span class="ident" id="5007915">nil</span><span class="op" id="5007918">,</span>&nbsp;<span class="ident" id="5007920">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5007925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5007928">if</span>&nbsp;<span class="op" id="5007931">!</span><span class="ident" id="5007932">useProxy</span><span class="op" id="5007940">(</span><span class="ident" id="5007941">canonicalAddr</span><span class="op" id="5007954">(</span><span class="ident" id="5007955">req</span><span class="op" id="5007958">.</span><span class="ident" id="5007959">URL</span><span class="op" id="5007962">)</span><span class="op" id="5007963">)</span>&nbsp;<span class="op" id="5007965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5007969">return</span>&nbsp;<span class="ident" id="5007976">nil</span><span class="op" id="5007979">,</span>&nbsp;<span class="ident" id="5007981">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5007986">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5007989">proxyURL</span><span class="op" id="5007997">,</span>&nbsp;<span class="ident" id="5007999">err</span>&nbsp;<span class="op" id="5008003">:=</span>&nbsp;<span class="ident" id="5008006">url</span><span class="op" id="5008009">.</span><span class="ident" id="5008010">Parse</span><span class="op" id="5008015">(</span><span class="ident" id="5008016">proxy</span><span class="op" id="5008021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5008024">if</span>&nbsp;<span class="ident" id="5008027">err</span>&nbsp;<span class="op" id="5008031">!=</span>&nbsp;<span class="ident" id="5008034">nil</span>&nbsp;<span class="op" id="5008038">||</span>&nbsp;<span class="op" id="5008041">!</span><span class="ident" id="5008042">strings</span><span class="op" id="5008049">.</span><span class="ident" id="5008050">HasPrefix</span><span class="op" id="5008059">(</span><span class="ident" id="5008060">proxyURL</span><span class="op" id="5008068">.</span><span class="ident" id="5008069">Scheme</span><span class="op" id="5008075">,</span>&nbsp;<span class="string" id="5008077">&#34;http&#34;</span><span class="op" id="5008083">)</span>&nbsp;<span class="op" id="5008085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5008089">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5008146">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5008197">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5008247">if</span>&nbsp;<span class="ident" id="5008250">proxyURL</span><span class="op" id="5008258">,</span>&nbsp;<span class="ident" id="5008260">err</span>&nbsp;<span class="op" id="5008264">:=</span>&nbsp;<span class="ident" id="5008267">url</span><span class="op" id="5008270">.</span><span class="ident" id="5008271">Parse</span><span class="op" id="5008276">(</span><span class="string" id="5008277">&#34;http://&#34;</span>&nbsp;<span class="op" id="5008287">+</span>&nbsp;<span class="ident" id="5008289">proxy</span><span class="op" id="5008294">)</span><span class="op" id="5008295">;</span>&nbsp;<span class="ident" id="5008297">err</span>&nbsp;<span class="op" id="5008301">==</span>&nbsp;<span class="ident" id="5008304">nil</span>&nbsp;<span class="op" id="5008308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5008313">return</span>&nbsp;<span class="ident" id="5008320">proxyURL</span><span class="op" id="5008328">,</span>&nbsp;<span class="ident" id="5008330">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5008336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5008339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5008342">if</span>&nbsp;<span class="ident" id="5008345">err</span>&nbsp;<span class="op" id="5008349">!=</span>&nbsp;<span class="ident" id="5008352">nil</span>&nbsp;<span class="op" id="5008356">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5008360">return</span>&nbsp;<span class="ident" id="5008367">nil</span><span class="op" id="5008370">,</span>&nbsp;<span class="ident" id="5008372">fmt</span><span class="op" id="5008375">.</span><span class="ident" id="5008376">Errorf</span><span class="op" id="5008382">(</span><span class="string" id="5008383">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="5008413">,</span>&nbsp;<span class="ident" id="5008415">proxy</span><span class="op" id="5008420">,</span>&nbsp;<span class="ident" id="5008422">err</span><span class="op" id="5008425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5008428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5008431">return</span>&nbsp;<span class="ident" id="5008438">proxyURL</span><span class="op" id="5008446">,</span>&nbsp;<span class="ident" id="5008448">nil</span><br>
<span class="lineno"></span><span class="op" id="5008452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="5008455">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="5008517">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="5008554">func</span>&nbsp;<span class="ident" id="5008559">ProxyURL</span><span class="op" id="5008567">(</span><span class="ident" id="5008568">fixedURL</span>&nbsp;<span class="op" id="5008577">*</span><span class="ident" id="5008578">url</span><span class="op" id="5008581">.</span><span class="ident" id="5008582">URL</span><span class="op" id="5008585">)</span>&nbsp;<span class="keyword" id="5008587">func</span><span class="op" id="5008591">(</span><span class="op" id="5008592">*</span><span class="ident" id="5008593">Request</span><span class="op" id="5008600">)</span>&nbsp;<span class="op" id="5008602">(</span><span class="op" id="5008603">*</span><span class="ident" id="5008604">url</span><span class="op" id="5008607">.</span><span class="ident" id="5008608">URL</span><span class="op" id="5008611">,</span>&nbsp;<span class="builtintype" id="5008613">error</span><span class="op" id="5008618">)</span>&nbsp;<span class="op" id="5008620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5008623">return</span>&nbsp;<span class="keyword" id="5008630">func</span><span class="op" id="5008634">(</span><span class="op" id="5008635">*</span><span class="ident" id="5008636">Request</span><span class="op" id="5008643">)</span>&nbsp;<span class="op" id="5008645">(</span><span class="op" id="5008646">*</span><span class="ident" id="5008647">url</span><span class="op" id="5008650">.</span><span class="ident" id="5008651">URL</span><span class="op" id="5008654">,</span>&nbsp;<span class="builtintype" id="5008656">error</span><span class="op" id="5008661">)</span>&nbsp;<span class="op" id="5008663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5008667">return</span>&nbsp;<span class="ident" id="5008674">fixedURL</span><span class="op" id="5008682">,</span>&nbsp;<span class="ident" id="5008684">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5008689">}</span><br>
<span class="lineno"></span><span class="op" id="5008691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5008694">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="5008755">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="5008791">type</span>&nbsp;<span class="ident" id="5008796">transportRequest</span>&nbsp;<span class="keyword" id="5008813">struct</span>&nbsp;<span class="op" id="5008820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5008823">*</span><span class="ident" id="5008824">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5008839">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5008879">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5008888">Header</span>&nbsp;<span class="comment" id="5008895">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="5008929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="5008932">func</span>&nbsp;<span class="op" id="5008937">(</span><span class="ident" id="5008938">tr</span>&nbsp;<span class="op" id="5008941">*</span><span class="ident" id="5008942">transportRequest</span><span class="op" id="5008958">)</span>&nbsp;<span class="ident" id="5008960">extraHeaders</span><span class="op" id="5008972">(</span><span class="op" id="5008973">)</span>&nbsp;<span class="ident" id="5008975">Header</span>&nbsp;<span class="op" id="5008982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5008985">if</span>&nbsp;<span class="ident" id="5008988">tr</span><span class="op" id="5008990">.</span><span class="ident" id="5008991">extra</span>&nbsp;<span class="op" id="5008997">==</span>&nbsp;<span class="ident" id="5009000">nil</span>&nbsp;<span class="op" id="5009004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5009008">tr</span><span class="op" id="5009010">.</span><span class="ident" id="5009011">extra</span>&nbsp;<span class="op" id="5009017">=</span>&nbsp;<span class="builtinfunc" id="5009019">make</span><span class="op" id="5009023">(</span><span class="ident" id="5009024">Header</span><span class="op" id="5009030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5009033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009036">return</span>&nbsp;<span class="ident" id="5009043">tr</span><span class="op" id="5009045">.</span><span class="ident" id="5009046">extra</span><br>
<span class="lineno">185</span><span class="op" id="5009052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5009055">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="5009107">//</span><br>
<span class="lineno"></span><span class="comment" id="5009110">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="5009179">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5009234">func</span>&nbsp;<span class="op" id="5009239">(</span><span class="ident" id="5009240">t</span>&nbsp;<span class="op" id="5009242">*</span><span class="ident" id="5009243">Transport</span><span class="op" id="5009252">)</span>&nbsp;<span class="ident" id="5009254">RoundTrip</span><span class="op" id="5009263">(</span><span class="ident" id="5009264">req</span>&nbsp;<span class="op" id="5009268">*</span><span class="ident" id="5009269">Request</span><span class="op" id="5009276">)</span>&nbsp;<span class="op" id="5009278">(</span><span class="ident" id="5009279">resp</span>&nbsp;<span class="op" id="5009284">*</span><span class="ident" id="5009285">Response</span><span class="op" id="5009293">,</span>&nbsp;<span class="ident" id="5009295">err</span>&nbsp;<span class="builtintype" id="5009299">error</span><span class="op" id="5009304">)</span>&nbsp;<span class="op" id="5009306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009309">if</span>&nbsp;<span class="ident" id="5009312">req</span><span class="op" id="5009315">.</span><span class="ident" id="5009316">URL</span>&nbsp;<span class="op" id="5009320">==</span>&nbsp;<span class="ident" id="5009323">nil</span>&nbsp;<span class="op" id="5009327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5009331">req</span><span class="op" id="5009334">.</span><span class="ident" id="5009335">closeBody</span><span class="op" id="5009344">(</span><span class="op" id="5009345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009349">return</span>&nbsp;<span class="ident" id="5009356">nil</span><span class="op" id="5009359">,</span>&nbsp;<span class="ident" id="5009361">errors</span><span class="op" id="5009367">.</span><span class="ident" id="5009368">New</span><span class="op" id="5009371">(</span><span class="string" id="5009372">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="5009395">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5009398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009401">if</span>&nbsp;<span class="ident" id="5009404">req</span><span class="op" id="5009407">.</span><span class="ident" id="5009408">Header</span>&nbsp;<span class="op" id="5009415">==</span>&nbsp;<span class="ident" id="5009418">nil</span>&nbsp;<span class="op" id="5009422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5009426">req</span><span class="op" id="5009429">.</span><span class="ident" id="5009430">closeBody</span><span class="op" id="5009439">(</span><span class="op" id="5009440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009444">return</span>&nbsp;<span class="ident" id="5009451">nil</span><span class="op" id="5009454">,</span>&nbsp;<span class="ident" id="5009456">errors</span><span class="op" id="5009462">.</span><span class="ident" id="5009463">New</span><span class="op" id="5009466">(</span><span class="string" id="5009467">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="5009493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5009496">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009499">if</span>&nbsp;<span class="ident" id="5009502">req</span><span class="op" id="5009505">.</span><span class="ident" id="5009506">URL</span><span class="op" id="5009509">.</span><span class="ident" id="5009510">Scheme</span>&nbsp;<span class="op" id="5009517">!=</span>&nbsp;<span class="string" id="5009520">&#34;http&#34;</span>&nbsp;<span class="op" id="5009527">&amp;&amp;</span>&nbsp;<span class="ident" id="5009530">req</span><span class="op" id="5009533">.</span><span class="ident" id="5009534">URL</span><span class="op" id="5009537">.</span><span class="ident" id="5009538">Scheme</span>&nbsp;<span class="op" id="5009545">!=</span>&nbsp;<span class="string" id="5009548">&#34;https&#34;</span>&nbsp;<span class="op" id="5009556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5009560">t</span><span class="op" id="5009561">.</span><span class="ident" id="5009562">altMu</span><span class="op" id="5009567">.</span><span class="ident" id="5009568">RLock</span><span class="op" id="5009573">(</span><span class="op" id="5009574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009578">var</span>&nbsp;<span class="ident" id="5009582">rt</span>&nbsp;<span class="ident" id="5009585">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009600">if</span>&nbsp;<span class="ident" id="5009603">t</span><span class="op" id="5009604">.</span><span class="ident" id="5009605">altProto</span>&nbsp;<span class="op" id="5009614">!=</span>&nbsp;<span class="ident" id="5009617">nil</span>&nbsp;<span class="op" id="5009621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5009626">rt</span>&nbsp;<span class="op" id="5009629">=</span>&nbsp;<span class="ident" id="5009631">t</span><span class="op" id="5009632">.</span><span class="ident" id="5009633">altProto</span><span class="op" id="5009641">[</span><span class="ident" id="5009642">req</span><span class="op" id="5009645">.</span><span class="ident" id="5009646">URL</span><span class="op" id="5009649">.</span><span class="ident" id="5009650">Scheme</span><span class="op" id="5009656">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5009660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5009664">t</span><span class="op" id="5009665">.</span><span class="ident" id="5009666">altMu</span><span class="op" id="5009671">.</span><span class="ident" id="5009672">RUnlock</span><span class="op" id="5009679">(</span><span class="op" id="5009680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009684">if</span>&nbsp;<span class="ident" id="5009687">rt</span>&nbsp;<span class="op" id="5009690">==</span>&nbsp;<span class="ident" id="5009693">nil</span>&nbsp;<span class="op" id="5009697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5009702">req</span><span class="op" id="5009705">.</span><span class="ident" id="5009706">closeBody</span><span class="op" id="5009715">(</span><span class="op" id="5009716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009721">return</span>&nbsp;<span class="ident" id="5009728">nil</span><span class="op" id="5009731">,</span>&nbsp;<span class="op" id="5009733">&amp;</span><span class="ident" id="5009734">badStringError</span><span class="op" id="5009748">{</span><span class="string" id="5009749">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="5009778">,</span>&nbsp;<span class="ident" id="5009780">req</span><span class="op" id="5009783">.</span><span class="ident" id="5009784">URL</span><span class="op" id="5009787">.</span><span class="ident" id="5009788">Scheme</span><span class="op" id="5009794">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5009798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009802">return</span>&nbsp;<span class="ident" id="5009809">rt</span><span class="op" id="5009811">.</span><span class="ident" id="5009812">RoundTrip</span><span class="op" id="5009821">(</span><span class="ident" id="5009822">req</span><span class="op" id="5009825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5009828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009831">if</span>&nbsp;<span class="ident" id="5009834">req</span><span class="op" id="5009837">.</span><span class="ident" id="5009838">URL</span><span class="op" id="5009841">.</span><span class="ident" id="5009842">Host</span>&nbsp;<span class="op" id="5009847">==</span>&nbsp;<span class="string" id="5009850">&#34;&#34;</span>&nbsp;<span class="op" id="5009853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5009857">req</span><span class="op" id="5009860">.</span><span class="ident" id="5009861">closeBody</span><span class="op" id="5009870">(</span><span class="op" id="5009871">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5009875">return</span>&nbsp;<span class="ident" id="5009882">nil</span><span class="op" id="5009885">,</span>&nbsp;<span class="ident" id="5009887">errors</span><span class="op" id="5009893">.</span><span class="ident" id="5009894">New</span><span class="op" id="5009897">(</span><span class="string" id="5009898">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="5009928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5009931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5009934">treq</span>&nbsp;<span class="op" id="5009939">:=</span>&nbsp;<span class="op" id="5009942">&amp;</span><span class="ident" id="5009943">transportRequest</span><span class="op" id="5009959">{</span><span class="ident" id="5009960">Request</span><span class="op" id="5009967">:</span>&nbsp;<span class="ident" id="5009969">req</span><span class="op" id="5009972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5009975">cm</span><span class="op" id="5009977">,</span>&nbsp;<span class="ident" id="5009979">err</span>&nbsp;<span class="op" id="5009983">:=</span>&nbsp;<span class="ident" id="5009986">t</span><span class="op" id="5009987">.</span><span class="ident" id="5009988">connectMethodForRequest</span><span class="op" id="5010011">(</span><span class="ident" id="5010012">treq</span><span class="op" id="5010016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5010019">if</span>&nbsp;<span class="ident" id="5010022">err</span>&nbsp;<span class="op" id="5010026">!=</span>&nbsp;<span class="ident" id="5010029">nil</span>&nbsp;<span class="op" id="5010033">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010037">req</span><span class="op" id="5010040">.</span><span class="ident" id="5010041">closeBody</span><span class="op" id="5010050">(</span><span class="op" id="5010051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5010055">return</span>&nbsp;<span class="ident" id="5010062">nil</span><span class="op" id="5010065">,</span>&nbsp;<span class="ident" id="5010067">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5010072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5010076">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5010137">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5010201">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5010265">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010290">pconn</span><span class="op" id="5010295">,</span>&nbsp;<span class="ident" id="5010297">err</span>&nbsp;<span class="op" id="5010301">:=</span>&nbsp;<span class="ident" id="5010304">t</span><span class="op" id="5010305">.</span><span class="ident" id="5010306">getConn</span><span class="op" id="5010313">(</span><span class="ident" id="5010314">req</span><span class="op" id="5010317">,</span>&nbsp;<span class="ident" id="5010319">cm</span><span class="op" id="5010321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5010324">if</span>&nbsp;<span class="ident" id="5010327">err</span>&nbsp;<span class="op" id="5010331">!=</span>&nbsp;<span class="ident" id="5010334">nil</span>&nbsp;<span class="op" id="5010338">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010342">t</span><span class="op" id="5010343">.</span><span class="ident" id="5010344">setReqCanceler</span><span class="op" id="5010358">(</span><span class="ident" id="5010359">req</span><span class="op" id="5010362">,</span>&nbsp;<span class="ident" id="5010364">nil</span><span class="op" id="5010367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010371">req</span><span class="op" id="5010374">.</span><span class="ident" id="5010375">closeBody</span><span class="op" id="5010384">(</span><span class="op" id="5010385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5010389">return</span>&nbsp;<span class="ident" id="5010396">nil</span><span class="op" id="5010399">,</span>&nbsp;<span class="ident" id="5010401">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5010406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5010410">return</span>&nbsp;<span class="ident" id="5010417">pconn</span><span class="op" id="5010422">.</span><span class="ident" id="5010423">roundTrip</span><span class="op" id="5010432">(</span><span class="ident" id="5010433">treq</span><span class="op" id="5010437">)</span><br>
<span class="lineno"></span><span class="op" id="5010439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5010442">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="5010500">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="5010566">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="5010631">//</span><br>
<span class="lineno"></span><span class="comment" id="5010634">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="5010695">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5010756">func</span>&nbsp;<span class="op" id="5010761">(</span><span class="ident" id="5010762">t</span>&nbsp;<span class="op" id="5010764">*</span><span class="ident" id="5010765">Transport</span><span class="op" id="5010774">)</span>&nbsp;<span class="ident" id="5010776">RegisterProtocol</span><span class="op" id="5010792">(</span><span class="ident" id="5010793">scheme</span>&nbsp;<span class="builtintype" id="5010800">string</span><span class="op" id="5010806">,</span>&nbsp;<span class="ident" id="5010808">rt</span>&nbsp;<span class="ident" id="5010811">RoundTripper</span><span class="op" id="5010823">)</span>&nbsp;<span class="op" id="5010825">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5010828">if</span>&nbsp;<span class="ident" id="5010831">scheme</span>&nbsp;<span class="op" id="5010838">==</span>&nbsp;<span class="string" id="5010841">&#34;http&#34;</span>&nbsp;<span class="op" id="5010848">||</span>&nbsp;<span class="ident" id="5010851">scheme</span>&nbsp;<span class="op" id="5010858">==</span>&nbsp;<span class="string" id="5010861">&#34;https&#34;</span>&nbsp;<span class="op" id="5010869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5010873">panic</span><span class="op" id="5010878">(</span><span class="string" id="5010879">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="5010891">+</span>&nbsp;<span class="ident" id="5010893">scheme</span>&nbsp;<span class="op" id="5010900">+</span>&nbsp;<span class="string" id="5010902">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="5010923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5010926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010929">t</span><span class="op" id="5010930">.</span><span class="ident" id="5010931">altMu</span><span class="op" id="5010936">.</span><span class="ident" id="5010937">Lock</span><span class="op" id="5010941">(</span><span class="op" id="5010942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5010945">defer</span>&nbsp;<span class="ident" id="5010951">t</span><span class="op" id="5010952">.</span><span class="ident" id="5010953">altMu</span><span class="op" id="5010958">.</span><span class="ident" id="5010959">Unlock</span><span class="op" id="5010965">(</span><span class="op" id="5010966">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5010969">if</span>&nbsp;<span class="ident" id="5010972">t</span><span class="op" id="5010973">.</span><span class="ident" id="5010974">altProto</span>&nbsp;<span class="op" id="5010983">==</span>&nbsp;<span class="ident" id="5010986">nil</span>&nbsp;<span class="op" id="5010990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5010994">t</span><span class="op" id="5010995">.</span><span class="ident" id="5010996">altProto</span>&nbsp;<span class="op" id="5011005">=</span>&nbsp;<span class="builtinfunc" id="5011007">make</span><span class="op" id="5011011">(</span><span class="keyword" id="5011012">map</span><span class="op" id="5011015">[</span><span class="builtintype" id="5011016">string</span><span class="op" id="5011022">]</span><span class="ident" id="5011023">RoundTripper</span><span class="op" id="5011035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5011038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5011041">if</span>&nbsp;<span class="ident" id="5011044">_</span><span class="op" id="5011045">,</span>&nbsp;<span class="ident" id="5011047">exists</span>&nbsp;<span class="op" id="5011054">:=</span>&nbsp;<span class="ident" id="5011057">t</span><span class="op" id="5011058">.</span><span class="ident" id="5011059">altProto</span><span class="op" id="5011067">[</span><span class="ident" id="5011068">scheme</span><span class="op" id="5011074">]</span><span class="op" id="5011075">;</span>&nbsp;<span class="ident" id="5011077">exists</span>&nbsp;<span class="op" id="5011084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5011088">panic</span><span class="op" id="5011093">(</span><span class="string" id="5011094">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="5011106">+</span>&nbsp;<span class="ident" id="5011108">scheme</span>&nbsp;<span class="op" id="5011115">+</span>&nbsp;<span class="string" id="5011117">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="5011138">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5011141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011144">t</span><span class="op" id="5011145">.</span><span class="ident" id="5011146">altProto</span><span class="op" id="5011154">[</span><span class="ident" id="5011155">scheme</span><span class="op" id="5011161">]</span>&nbsp;<span class="op" id="5011163">=</span>&nbsp;<span class="ident" id="5011165">rt</span><br>
<span class="lineno"></span><span class="op" id="5011168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5011171">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="5011240">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5011304">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="5011377">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="5011388">func</span>&nbsp;<span class="op" id="5011393">(</span><span class="ident" id="5011394">t</span>&nbsp;<span class="op" id="5011396">*</span><span class="ident" id="5011397">Transport</span><span class="op" id="5011406">)</span>&nbsp;<span class="ident" id="5011408">CloseIdleConnections</span><span class="op" id="5011428">(</span><span class="op" id="5011429">)</span>&nbsp;<span class="op" id="5011431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011434">t</span><span class="op" id="5011435">.</span><span class="ident" id="5011436">idleMu</span><span class="op" id="5011442">.</span><span class="ident" id="5011443">Lock</span><span class="op" id="5011447">(</span><span class="op" id="5011448">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011451">m</span>&nbsp;<span class="op" id="5011453">:=</span>&nbsp;<span class="ident" id="5011456">t</span><span class="op" id="5011457">.</span><span class="ident" id="5011458">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011468">t</span><span class="op" id="5011469">.</span><span class="ident" id="5011470">idleConn</span>&nbsp;<span class="op" id="5011479">=</span>&nbsp;<span class="ident" id="5011481">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011486">t</span><span class="op" id="5011487">.</span><span class="ident" id="5011488">idleConnCh</span>&nbsp;<span class="op" id="5011499">=</span>&nbsp;<span class="ident" id="5011501">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011506">t</span><span class="op" id="5011507">.</span><span class="ident" id="5011508">wantIdle</span>&nbsp;<span class="op" id="5011517">=</span>&nbsp;<span class="builtintype" id="5011519">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011525">t</span><span class="op" id="5011526">.</span><span class="ident" id="5011527">idleMu</span><span class="op" id="5011533">.</span><span class="ident" id="5011534">Unlock</span><span class="op" id="5011540">(</span><span class="op" id="5011541">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5011544">for</span>&nbsp;<span class="ident" id="5011548">_</span><span class="op" id="5011549">,</span>&nbsp;<span class="ident" id="5011551">conns</span>&nbsp;<span class="op" id="5011557">:=</span>&nbsp;<span class="keyword" id="5011560">range</span>&nbsp;<span class="ident" id="5011566">m</span>&nbsp;<span class="op" id="5011568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5011572">for</span>&nbsp;<span class="ident" id="5011576">_</span><span class="op" id="5011577">,</span>&nbsp;<span class="ident" id="5011579">pconn</span>&nbsp;<span class="op" id="5011585">:=</span>&nbsp;<span class="keyword" id="5011588">range</span>&nbsp;<span class="ident" id="5011594">conns</span>&nbsp;<span class="op" id="5011600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011605">pconn</span><span class="op" id="5011610">.</span><span class="builtinfunc" id="5011611">close</span><span class="op" id="5011616">(</span><span class="op" id="5011617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5011621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5011624">}</span><br>
<span class="lineno">275</span><span class="op" id="5011626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5011629">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="5011690">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5011705">func</span>&nbsp;<span class="op" id="5011710">(</span><span class="ident" id="5011711">t</span>&nbsp;<span class="op" id="5011713">*</span><span class="ident" id="5011714">Transport</span><span class="op" id="5011723">)</span>&nbsp;<span class="ident" id="5011725">CancelRequest</span><span class="op" id="5011738">(</span><span class="ident" id="5011739">req</span>&nbsp;<span class="op" id="5011743">*</span><span class="ident" id="5011744">Request</span><span class="op" id="5011751">)</span>&nbsp;<span class="op" id="5011753">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011756">t</span><span class="op" id="5011757">.</span><span class="ident" id="5011758">reqMu</span><span class="op" id="5011763">.</span><span class="ident" id="5011764">Lock</span><span class="op" id="5011768">(</span><span class="op" id="5011769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011772">cancel</span>&nbsp;<span class="op" id="5011779">:=</span>&nbsp;<span class="ident" id="5011782">t</span><span class="op" id="5011783">.</span><span class="ident" id="5011784">reqCanceler</span><span class="op" id="5011795">[</span><span class="ident" id="5011796">req</span><span class="op" id="5011799">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011802">t</span><span class="op" id="5011803">.</span><span class="ident" id="5011804">reqMu</span><span class="op" id="5011809">.</span><span class="ident" id="5011810">Unlock</span><span class="op" id="5011816">(</span><span class="op" id="5011817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5011820">if</span>&nbsp;<span class="ident" id="5011823">cancel</span>&nbsp;<span class="op" id="5011830">!=</span>&nbsp;<span class="ident" id="5011833">nil</span>&nbsp;<span class="op" id="5011837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011841">cancel</span><span class="op" id="5011847">(</span><span class="op" id="5011848">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5011851">}</span><br>
<span class="lineno"></span><span class="op" id="5011853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5011856">//</span><br>
<span class="lineno"></span><span class="comment" id="5011859">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="5011902">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5011906">var</span>&nbsp;<span class="op" id="5011910">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011913">httpProxyEnv</span>&nbsp;<span class="op" id="5011926">=</span>&nbsp;<span class="op" id="5011928">&amp;</span><span class="ident" id="5011929">envOnce</span><span class="op" id="5011936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011940">names</span><span class="op" id="5011945">:</span>&nbsp;<span class="op" id="5011947">[</span><span class="op" id="5011948">]</span><span class="builtintype" id="5011949">string</span><span class="op" id="5011955">{</span><span class="string" id="5011956">&#34;HTTP_PROXY&#34;</span><span class="op" id="5011968">,</span>&nbsp;<span class="string" id="5011970">&#34;http_proxy&#34;</span><span class="op" id="5011982">}</span><span class="op" id="5011983">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5011986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5011989">httpsProxyEnv</span>&nbsp;<span class="op" id="5012003">=</span>&nbsp;<span class="op" id="5012005">&amp;</span><span class="ident" id="5012006">envOnce</span><span class="op" id="5012013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012017">names</span><span class="op" id="5012022">:</span>&nbsp;<span class="op" id="5012024">[</span><span class="op" id="5012025">]</span><span class="builtintype" id="5012026">string</span><span class="op" id="5012032">{</span><span class="string" id="5012033">&#34;HTTPS_PROXY&#34;</span><span class="op" id="5012046">,</span>&nbsp;<span class="string" id="5012048">&#34;https_proxy&#34;</span><span class="op" id="5012061">}</span><span class="op" id="5012062">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5012065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012068">noProxyEnv</span>&nbsp;<span class="op" id="5012079">=</span>&nbsp;<span class="op" id="5012081">&amp;</span><span class="ident" id="5012082">envOnce</span><span class="op" id="5012089">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012093">names</span><span class="op" id="5012098">:</span>&nbsp;<span class="op" id="5012100">[</span><span class="op" id="5012101">]</span><span class="builtintype" id="5012102">string</span><span class="op" id="5012108">{</span><span class="string" id="5012109">&#34;NO_PROXY&#34;</span><span class="op" id="5012119">,</span>&nbsp;<span class="string" id="5012121">&#34;no_proxy&#34;</span><span class="op" id="5012131">}</span><span class="op" id="5012132">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5012135">}</span><br>
<span class="lineno"></span><span class="op" id="5012137">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5012140">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="5012208">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="5012273">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="5012292">type</span>&nbsp;<span class="ident" id="5012297">envOnce</span>&nbsp;<span class="keyword" id="5012305">struct</span>&nbsp;<span class="op" id="5012312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012315">names</span>&nbsp;<span class="op" id="5012321">[</span><span class="op" id="5012322">]</span><span class="builtintype" id="5012323">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012331">once</span>&nbsp;&nbsp;<span class="ident" id="5012337">sync</span><span class="op" id="5012341">.</span><span class="ident" id="5012342">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012348">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5012354">string</span><br>
<span class="lineno"></span><span class="op" id="5012361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5012364">func</span>&nbsp;<span class="op" id="5012369">(</span><span class="ident" id="5012370">e</span>&nbsp;<span class="op" id="5012372">*</span><span class="ident" id="5012373">envOnce</span><span class="op" id="5012380">)</span>&nbsp;<span class="ident" id="5012382">Get</span><span class="op" id="5012385">(</span><span class="op" id="5012386">)</span>&nbsp;<span class="builtintype" id="5012388">string</span>&nbsp;<span class="op" id="5012395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012398">e</span><span class="op" id="5012399">.</span><span class="ident" id="5012400">once</span><span class="op" id="5012404">.</span><span class="ident" id="5012405">Do</span><span class="op" id="5012407">(</span><span class="ident" id="5012408">e</span><span class="op" id="5012409">.</span><span class="ident" id="5012410">init</span><span class="op" id="5012414">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5012417">return</span>&nbsp;<span class="ident" id="5012424">e</span><span class="op" id="5012425">.</span><span class="ident" id="5012426">val</span><br>
<span class="lineno"></span><span class="op" id="5012430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5012433">func</span>&nbsp;<span class="op" id="5012438">(</span><span class="ident" id="5012439">e</span>&nbsp;<span class="op" id="5012441">*</span><span class="ident" id="5012442">envOnce</span><span class="op" id="5012449">)</span>&nbsp;<span class="ident" id="5012451">init</span><span class="op" id="5012455">(</span><span class="op" id="5012456">)</span>&nbsp;<span class="op" id="5012458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5012461">for</span>&nbsp;<span class="ident" id="5012465">_</span><span class="op" id="5012466">,</span>&nbsp;<span class="ident" id="5012468">n</span>&nbsp;<span class="op" id="5012470">:=</span>&nbsp;<span class="keyword" id="5012473">range</span>&nbsp;<span class="ident" id="5012479">e</span><span class="op" id="5012480">.</span><span class="ident" id="5012481">names</span>&nbsp;<span class="op" id="5012487">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012491">e</span><span class="op" id="5012492">.</span><span class="ident" id="5012493">val</span>&nbsp;<span class="op" id="5012497">=</span>&nbsp;<span class="ident" id="5012499">os</span><span class="op" id="5012501">.</span><span class="ident" id="5012502">Getenv</span><span class="op" id="5012508">(</span><span class="ident" id="5012509">n</span><span class="op" id="5012510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5012514">if</span>&nbsp;<span class="ident" id="5012517">e</span><span class="op" id="5012518">.</span><span class="ident" id="5012519">val</span>&nbsp;<span class="op" id="5012523">!=</span>&nbsp;<span class="string" id="5012526">&#34;&#34;</span>&nbsp;<span class="op" id="5012529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5012534">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5012543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5012546">}</span><br>
<span class="lineno">325</span><span class="op" id="5012548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5012551">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="5012577">func</span>&nbsp;<span class="op" id="5012582">(</span><span class="ident" id="5012583">e</span>&nbsp;<span class="op" id="5012585">*</span><span class="ident" id="5012586">envOnce</span><span class="op" id="5012593">)</span>&nbsp;<span class="ident" id="5012595">reset</span><span class="op" id="5012600">(</span><span class="op" id="5012601">)</span>&nbsp;<span class="op" id="5012603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012606">e</span><span class="op" id="5012607">.</span><span class="ident" id="5012608">once</span>&nbsp;<span class="op" id="5012613">=</span>&nbsp;<span class="ident" id="5012615">sync</span><span class="op" id="5012619">.</span><span class="ident" id="5012620">Once</span><span class="op" id="5012624">{</span><span class="op" id="5012625">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012628">e</span><span class="op" id="5012629">.</span><span class="ident" id="5012630">val</span>&nbsp;<span class="op" id="5012634">=</span>&nbsp;<span class="string" id="5012636">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="5012639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5012642">func</span>&nbsp;<span class="op" id="5012647">(</span><span class="ident" id="5012648">t</span>&nbsp;<span class="op" id="5012650">*</span><span class="ident" id="5012651">Transport</span><span class="op" id="5012660">)</span>&nbsp;<span class="ident" id="5012662">connectMethodForRequest</span><span class="op" id="5012685">(</span><span class="ident" id="5012686">treq</span>&nbsp;<span class="op" id="5012691">*</span><span class="ident" id="5012692">transportRequest</span><span class="op" id="5012708">)</span>&nbsp;<span class="op" id="5012710">(</span><span class="ident" id="5012711">cm</span>&nbsp;<span class="ident" id="5012714">connectMethod</span><span class="op" id="5012727">,</span>&nbsp;<span class="ident" id="5012729">err</span>&nbsp;<span class="builtintype" id="5012733">error</span><span class="op" id="5012738">)</span>&nbsp;<span class="op" id="5012740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012743">cm</span><span class="op" id="5012745">.</span><span class="ident" id="5012746">targetScheme</span>&nbsp;<span class="op" id="5012759">=</span>&nbsp;<span class="ident" id="5012761">treq</span><span class="op" id="5012765">.</span><span class="ident" id="5012766">URL</span><span class="op" id="5012769">.</span><span class="ident" id="5012770">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012778">cm</span><span class="op" id="5012780">.</span><span class="ident" id="5012781">targetAddr</span>&nbsp;<span class="op" id="5012792">=</span>&nbsp;<span class="ident" id="5012794">canonicalAddr</span><span class="op" id="5012807">(</span><span class="ident" id="5012808">treq</span><span class="op" id="5012812">.</span><span class="ident" id="5012813">URL</span><span class="op" id="5012816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5012819">if</span>&nbsp;<span class="ident" id="5012822">t</span><span class="op" id="5012823">.</span><span class="ident" id="5012824">Proxy</span>&nbsp;<span class="op" id="5012830">!=</span>&nbsp;<span class="ident" id="5012833">nil</span>&nbsp;<span class="op" id="5012837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5012841">cm</span><span class="op" id="5012843">.</span><span class="ident" id="5012844">proxyURL</span><span class="op" id="5012852">,</span>&nbsp;<span class="ident" id="5012854">err</span>&nbsp;<span class="op" id="5012858">=</span>&nbsp;<span class="ident" id="5012860">t</span><span class="op" id="5012861">.</span><span class="ident" id="5012862">Proxy</span><span class="op" id="5012867">(</span><span class="ident" id="5012868">treq</span><span class="op" id="5012872">.</span><span class="ident" id="5012873">Request</span><span class="op" id="5012880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5012883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5012886">return</span>&nbsp;<span class="ident" id="5012893">cm</span><span class="op" id="5012895">,</span>&nbsp;<span class="ident" id="5012897">err</span><br>
<span class="lineno">340</span><span class="op" id="5012901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5012904">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="5012963">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="5012994">func</span>&nbsp;<span class="op" id="5012999">(</span><span class="ident" id="5013000">cm</span>&nbsp;<span class="op" id="5013003">*</span><span class="ident" id="5013004">connectMethod</span><span class="op" id="5013017">)</span>&nbsp;<span class="ident" id="5013019">proxyAuth</span><span class="op" id="5013028">(</span><span class="op" id="5013029">)</span>&nbsp;<span class="builtintype" id="5013031">string</span>&nbsp;<span class="op" id="5013038">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013041">if</span>&nbsp;<span class="ident" id="5013044">cm</span><span class="op" id="5013046">.</span><span class="ident" id="5013047">proxyURL</span>&nbsp;<span class="op" id="5013056">==</span>&nbsp;<span class="ident" id="5013059">nil</span>&nbsp;<span class="op" id="5013063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013067">return</span>&nbsp;<span class="string" id="5013074">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5013078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013081">if</span>&nbsp;<span class="ident" id="5013084">u</span>&nbsp;<span class="op" id="5013086">:=</span>&nbsp;<span class="ident" id="5013089">cm</span><span class="op" id="5013091">.</span><span class="ident" id="5013092">proxyURL</span><span class="op" id="5013100">.</span><span class="ident" id="5013101">User</span><span class="op" id="5013105">;</span>&nbsp;<span class="ident" id="5013107">u</span>&nbsp;<span class="op" id="5013109">!=</span>&nbsp;<span class="ident" id="5013112">nil</span>&nbsp;<span class="op" id="5013116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013120">username</span>&nbsp;<span class="op" id="5013129">:=</span>&nbsp;<span class="ident" id="5013132">u</span><span class="op" id="5013133">.</span><span class="ident" id="5013134">Username</span><span class="op" id="5013142">(</span><span class="op" id="5013143">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013147">password</span><span class="op" id="5013155">,</span>&nbsp;<span class="ident" id="5013157">_</span>&nbsp;<span class="op" id="5013159">:=</span>&nbsp;<span class="ident" id="5013162">u</span><span class="op" id="5013163">.</span><span class="ident" id="5013164">Password</span><span class="op" id="5013172">(</span><span class="op" id="5013173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013177">return</span>&nbsp;<span class="string" id="5013184">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="5013193">+</span>&nbsp;<span class="ident" id="5013195">basicAuth</span><span class="op" id="5013204">(</span><span class="ident" id="5013205">username</span><span class="op" id="5013213">,</span>&nbsp;<span class="ident" id="5013215">password</span><span class="op" id="5013223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5013226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013229">return</span>&nbsp;<span class="string" id="5013236">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="5013239">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="5013242">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="5013320">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5013338">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="5013406">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="5013424">func</span>&nbsp;<span class="op" id="5013429">(</span><span class="ident" id="5013430">t</span>&nbsp;<span class="op" id="5013432">*</span><span class="ident" id="5013433">Transport</span><span class="op" id="5013442">)</span>&nbsp;<span class="ident" id="5013444">putIdleConn</span><span class="op" id="5013455">(</span><span class="ident" id="5013456">pconn</span>&nbsp;<span class="op" id="5013462">*</span><span class="ident" id="5013463">persistConn</span><span class="op" id="5013474">)</span>&nbsp;<span class="builtintype" id="5013476">bool</span>&nbsp;<span class="op" id="5013481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013484">if</span>&nbsp;<span class="ident" id="5013487">t</span><span class="op" id="5013488">.</span><span class="ident" id="5013489">DisableKeepAlives</span>&nbsp;<span class="op" id="5013507">||</span>&nbsp;<span class="ident" id="5013510">t</span><span class="op" id="5013511">.</span><span class="ident" id="5013512">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="5013532">&lt;</span>&nbsp;<span class="num" id="5013534">0</span>&nbsp;<span class="op" id="5013536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013540">pconn</span><span class="op" id="5013545">.</span><span class="builtinfunc" id="5013546">close</span><span class="op" id="5013551">(</span><span class="op" id="5013552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013556">return</span>&nbsp;<span class="builtintype" id="5013563">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5013570">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013573">if</span>&nbsp;<span class="ident" id="5013576">pconn</span><span class="op" id="5013581">.</span><span class="ident" id="5013582">isBroken</span><span class="op" id="5013590">(</span><span class="op" id="5013591">)</span>&nbsp;<span class="op" id="5013593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013597">return</span>&nbsp;<span class="builtintype" id="5013604">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5013611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013614">key</span>&nbsp;<span class="op" id="5013618">:=</span>&nbsp;<span class="ident" id="5013621">pconn</span><span class="op" id="5013626">.</span><span class="ident" id="5013627">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013637">max</span>&nbsp;<span class="op" id="5013641">:=</span>&nbsp;<span class="ident" id="5013644">t</span><span class="op" id="5013645">.</span><span class="ident" id="5013646">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013667">if</span>&nbsp;<span class="ident" id="5013670">max</span>&nbsp;<span class="op" id="5013674">==</span>&nbsp;<span class="num" id="5013677">0</span>&nbsp;<span class="op" id="5013679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013683">max</span>&nbsp;<span class="op" id="5013687">=</span>&nbsp;<span class="ident" id="5013689">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5013717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013720">t</span><span class="op" id="5013721">.</span><span class="ident" id="5013722">idleMu</span><span class="op" id="5013728">.</span><span class="ident" id="5013729">Lock</span><span class="op" id="5013733">(</span><span class="op" id="5013734">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5013738">waitingDialer</span>&nbsp;<span class="op" id="5013752">:=</span>&nbsp;<span class="ident" id="5013755">t</span><span class="op" id="5013756">.</span><span class="ident" id="5013757">idleConnCh</span><span class="op" id="5013767">[</span><span class="ident" id="5013768">key</span><span class="op" id="5013771">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013774">select</span>&nbsp;<span class="op" id="5013781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5013784">case</span>&nbsp;<span class="ident" id="5013789">waitingDialer</span>&nbsp;<span class="op" id="5013803">&lt;-</span>&nbsp;<span class="ident" id="5013806">pconn</span><span class="op" id="5013811">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5013815">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5013868">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5013924">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5013970">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5014027">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014095">t</span><span class="op" id="5014096">.</span><span class="ident" id="5014097">idleMu</span><span class="op" id="5014103">.</span><span class="ident" id="5014104">Unlock</span><span class="op" id="5014110">(</span><span class="op" id="5014111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014115">return</span>&nbsp;<span class="builtintype" id="5014122">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014128">default</span><span class="op" id="5014135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014139">if</span>&nbsp;<span class="ident" id="5014142">waitingDialer</span>&nbsp;<span class="op" id="5014156">!=</span>&nbsp;<span class="ident" id="5014159">nil</span>&nbsp;<span class="op" id="5014163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5014168">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5014218">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5014266">delete</span><span class="op" id="5014272">(</span><span class="ident" id="5014273">t</span><span class="op" id="5014274">.</span><span class="ident" id="5014275">idleConnCh</span><span class="op" id="5014285">,</span>&nbsp;<span class="ident" id="5014287">key</span><span class="op" id="5014290">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014300">if</span>&nbsp;<span class="ident" id="5014303">t</span><span class="op" id="5014304">.</span><span class="ident" id="5014305">wantIdle</span>&nbsp;<span class="op" id="5014314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014318">t</span><span class="op" id="5014319">.</span><span class="ident" id="5014320">idleMu</span><span class="op" id="5014326">.</span><span class="ident" id="5014327">Unlock</span><span class="op" id="5014333">(</span><span class="op" id="5014334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014338">pconn</span><span class="op" id="5014343">.</span><span class="builtinfunc" id="5014344">close</span><span class="op" id="5014349">(</span><span class="op" id="5014350">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014354">return</span>&nbsp;<span class="builtintype" id="5014361">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014371">if</span>&nbsp;<span class="ident" id="5014374">t</span><span class="op" id="5014375">.</span><span class="ident" id="5014376">idleConn</span>&nbsp;<span class="op" id="5014385">==</span>&nbsp;<span class="ident" id="5014388">nil</span>&nbsp;<span class="op" id="5014392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014396">t</span><span class="op" id="5014397">.</span><span class="ident" id="5014398">idleConn</span>&nbsp;<span class="op" id="5014407">=</span>&nbsp;<span class="builtinfunc" id="5014409">make</span><span class="op" id="5014413">(</span><span class="keyword" id="5014414">map</span><span class="op" id="5014417">[</span><span class="ident" id="5014418">connectMethodKey</span><span class="op" id="5014434">]</span><span class="op" id="5014435">[</span><span class="op" id="5014436">]</span><span class="op" id="5014437">*</span><span class="ident" id="5014438">persistConn</span><span class="op" id="5014449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014452">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014455">if</span>&nbsp;<span class="builtinfunc" id="5014458">len</span><span class="op" id="5014461">(</span><span class="ident" id="5014462">t</span><span class="op" id="5014463">.</span><span class="ident" id="5014464">idleConn</span><span class="op" id="5014472">[</span><span class="ident" id="5014473">key</span><span class="op" id="5014476">]</span><span class="op" id="5014477">)</span>&nbsp;<span class="op" id="5014479">&gt;=</span>&nbsp;<span class="ident" id="5014482">max</span>&nbsp;<span class="op" id="5014486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014490">t</span><span class="op" id="5014491">.</span><span class="ident" id="5014492">idleMu</span><span class="op" id="5014498">.</span><span class="ident" id="5014499">Unlock</span><span class="op" id="5014505">(</span><span class="op" id="5014506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014510">pconn</span><span class="op" id="5014515">.</span><span class="builtinfunc" id="5014516">close</span><span class="op" id="5014521">(</span><span class="op" id="5014522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014526">return</span>&nbsp;<span class="builtintype" id="5014533">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014540">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014543">for</span>&nbsp;<span class="ident" id="5014547">_</span><span class="op" id="5014548">,</span>&nbsp;<span class="ident" id="5014550">exist</span>&nbsp;<span class="op" id="5014556">:=</span>&nbsp;<span class="keyword" id="5014559">range</span>&nbsp;<span class="ident" id="5014565">t</span><span class="op" id="5014566">.</span><span class="ident" id="5014567">idleConn</span><span class="op" id="5014575">[</span><span class="ident" id="5014576">key</span><span class="op" id="5014579">]</span>&nbsp;<span class="op" id="5014581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014585">if</span>&nbsp;<span class="ident" id="5014588">exist</span>&nbsp;<span class="op" id="5014594">==</span>&nbsp;<span class="ident" id="5014597">pconn</span>&nbsp;<span class="op" id="5014603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014608">log</span><span class="op" id="5014611">.</span><span class="ident" id="5014612">Fatalf</span><span class="op" id="5014618">(</span><span class="string" id="5014619">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="5014650">,</span>&nbsp;<span class="ident" id="5014652">pconn</span><span class="op" id="5014657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5014664">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014667">t</span><span class="op" id="5014668">.</span><span class="ident" id="5014669">idleConn</span><span class="op" id="5014677">[</span><span class="ident" id="5014678">key</span><span class="op" id="5014681">]</span>&nbsp;<span class="op" id="5014683">=</span>&nbsp;<span class="builtinfunc" id="5014685">append</span><span class="op" id="5014691">(</span><span class="ident" id="5014692">t</span><span class="op" id="5014693">.</span><span class="ident" id="5014694">idleConn</span><span class="op" id="5014702">[</span><span class="ident" id="5014703">key</span><span class="op" id="5014706">]</span><span class="op" id="5014707">,</span>&nbsp;<span class="ident" id="5014709">pconn</span><span class="op" id="5014714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5014717">t</span><span class="op" id="5014718">.</span><span class="ident" id="5014719">idleMu</span><span class="op" id="5014725">.</span><span class="ident" id="5014726">Unlock</span><span class="op" id="5014732">(</span><span class="op" id="5014733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5014736">return</span>&nbsp;<span class="builtintype" id="5014743">true</span><br>
<span class="lineno"></span><span class="op" id="5014748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="5014751">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="5014813">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="5014867">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5014935">func</span>&nbsp;<span class="op" id="5014940">(</span><span class="ident" id="5014941">t</span>&nbsp;<span class="op" id="5014943">*</span><span class="ident" id="5014944">Transport</span><span class="op" id="5014953">)</span>&nbsp;<span class="ident" id="5014955">getIdleConnCh</span><span class="op" id="5014968">(</span><span class="ident" id="5014969">cm</span>&nbsp;<span class="ident" id="5014972">connectMethod</span><span class="op" id="5014985">)</span>&nbsp;<span class="keyword" id="5014987">chan</span>&nbsp;<span class="op" id="5014992">*</span><span class="ident" id="5014993">persistConn</span>&nbsp;<span class="op" id="5015005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015008">if</span>&nbsp;<span class="ident" id="5015011">t</span><span class="op" id="5015012">.</span><span class="ident" id="5015013">DisableKeepAlives</span>&nbsp;<span class="op" id="5015031">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015035">return</span>&nbsp;<span class="ident" id="5015042">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015050">key</span>&nbsp;<span class="op" id="5015054">:=</span>&nbsp;<span class="ident" id="5015057">cm</span><span class="op" id="5015059">.</span><span class="ident" id="5015060">key</span><span class="op" id="5015063">(</span><span class="op" id="5015064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015067">t</span><span class="op" id="5015068">.</span><span class="ident" id="5015069">idleMu</span><span class="op" id="5015075">.</span><span class="ident" id="5015076">Lock</span><span class="op" id="5015080">(</span><span class="op" id="5015081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015084">defer</span>&nbsp;<span class="ident" id="5015090">t</span><span class="op" id="5015091">.</span><span class="ident" id="5015092">idleMu</span><span class="op" id="5015098">.</span><span class="ident" id="5015099">Unlock</span><span class="op" id="5015105">(</span><span class="op" id="5015106">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015109">t</span><span class="op" id="5015110">.</span><span class="ident" id="5015111">wantIdle</span>&nbsp;<span class="op" id="5015120">=</span>&nbsp;<span class="builtintype" id="5015122">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015129">if</span>&nbsp;<span class="ident" id="5015132">t</span><span class="op" id="5015133">.</span><span class="ident" id="5015134">idleConnCh</span>&nbsp;<span class="op" id="5015145">==</span>&nbsp;<span class="ident" id="5015148">nil</span>&nbsp;<span class="op" id="5015152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015156">t</span><span class="op" id="5015157">.</span><span class="ident" id="5015158">idleConnCh</span>&nbsp;<span class="op" id="5015169">=</span>&nbsp;<span class="builtinfunc" id="5015171">make</span><span class="op" id="5015175">(</span><span class="keyword" id="5015176">map</span><span class="op" id="5015179">[</span><span class="ident" id="5015180">connectMethodKey</span><span class="op" id="5015196">]</span><span class="keyword" id="5015197">chan</span>&nbsp;<span class="op" id="5015202">*</span><span class="ident" id="5015203">persistConn</span><span class="op" id="5015214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015220">ch</span><span class="op" id="5015222">,</span>&nbsp;<span class="ident" id="5015224">ok</span>&nbsp;<span class="op" id="5015227">:=</span>&nbsp;<span class="ident" id="5015230">t</span><span class="op" id="5015231">.</span><span class="ident" id="5015232">idleConnCh</span><span class="op" id="5015242">[</span><span class="ident" id="5015243">key</span><span class="op" id="5015246">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015249">if</span>&nbsp;<span class="op" id="5015252">!</span><span class="ident" id="5015253">ok</span>&nbsp;<span class="op" id="5015256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015260">ch</span>&nbsp;<span class="op" id="5015263">=</span>&nbsp;<span class="builtinfunc" id="5015265">make</span><span class="op" id="5015269">(</span><span class="keyword" id="5015270">chan</span>&nbsp;<span class="op" id="5015275">*</span><span class="ident" id="5015276">persistConn</span><span class="op" id="5015287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015291">t</span><span class="op" id="5015292">.</span><span class="ident" id="5015293">idleConnCh</span><span class="op" id="5015303">[</span><span class="ident" id="5015304">key</span><span class="op" id="5015307">]</span>&nbsp;<span class="op" id="5015309">=</span>&nbsp;<span class="ident" id="5015311">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015318">return</span>&nbsp;<span class="ident" id="5015325">ch</span><br>
<span class="lineno">435</span><span class="op" id="5015328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5015331">func</span>&nbsp;<span class="op" id="5015336">(</span><span class="ident" id="5015337">t</span>&nbsp;<span class="op" id="5015339">*</span><span class="ident" id="5015340">Transport</span><span class="op" id="5015349">)</span>&nbsp;<span class="ident" id="5015351">getIdleConn</span><span class="op" id="5015362">(</span><span class="ident" id="5015363">cm</span>&nbsp;<span class="ident" id="5015366">connectMethod</span><span class="op" id="5015379">)</span>&nbsp;<span class="op" id="5015381">(</span><span class="ident" id="5015382">pconn</span>&nbsp;<span class="op" id="5015388">*</span><span class="ident" id="5015389">persistConn</span><span class="op" id="5015400">)</span>&nbsp;<span class="op" id="5015402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015405">key</span>&nbsp;<span class="op" id="5015409">:=</span>&nbsp;<span class="ident" id="5015412">cm</span><span class="op" id="5015414">.</span><span class="ident" id="5015415">key</span><span class="op" id="5015418">(</span><span class="op" id="5015419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015422">t</span><span class="op" id="5015423">.</span><span class="ident" id="5015424">idleMu</span><span class="op" id="5015430">.</span><span class="ident" id="5015431">Lock</span><span class="op" id="5015435">(</span><span class="op" id="5015436">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015439">defer</span>&nbsp;<span class="ident" id="5015445">t</span><span class="op" id="5015446">.</span><span class="ident" id="5015447">idleMu</span><span class="op" id="5015453">.</span><span class="ident" id="5015454">Unlock</span><span class="op" id="5015460">(</span><span class="op" id="5015461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015464">if</span>&nbsp;<span class="ident" id="5015467">t</span><span class="op" id="5015468">.</span><span class="ident" id="5015469">idleConn</span>&nbsp;<span class="op" id="5015478">==</span>&nbsp;<span class="ident" id="5015481">nil</span>&nbsp;<span class="op" id="5015485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015489">return</span>&nbsp;<span class="ident" id="5015496">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015504">for</span>&nbsp;<span class="op" id="5015508">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015512">pconns</span><span class="op" id="5015518">,</span>&nbsp;<span class="ident" id="5015520">ok</span>&nbsp;<span class="op" id="5015523">:=</span>&nbsp;<span class="ident" id="5015526">t</span><span class="op" id="5015527">.</span><span class="ident" id="5015528">idleConn</span><span class="op" id="5015536">[</span><span class="ident" id="5015537">key</span><span class="op" id="5015540">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015544">if</span>&nbsp;<span class="op" id="5015547">!</span><span class="ident" id="5015548">ok</span>&nbsp;<span class="op" id="5015551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015556">return</span>&nbsp;<span class="ident" id="5015563">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015573">if</span>&nbsp;<span class="builtinfunc" id="5015576">len</span><span class="op" id="5015579">(</span><span class="ident" id="5015580">pconns</span><span class="op" id="5015586">)</span>&nbsp;<span class="op" id="5015588">==</span>&nbsp;<span class="num" id="5015591">1</span>&nbsp;<span class="op" id="5015593">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015598">pconn</span>&nbsp;<span class="op" id="5015604">=</span>&nbsp;<span class="ident" id="5015606">pconns</span><span class="op" id="5015612">[</span><span class="num" id="5015613">0</span><span class="op" id="5015614">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5015619">delete</span><span class="op" id="5015625">(</span><span class="ident" id="5015626">t</span><span class="op" id="5015627">.</span><span class="ident" id="5015628">idleConn</span><span class="op" id="5015636">,</span>&nbsp;<span class="ident" id="5015638">key</span><span class="op" id="5015641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015645">}</span>&nbsp;<span class="keyword" id="5015647">else</span>&nbsp;<span class="op" id="5015652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5015657">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5015702">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015721">pconn</span>&nbsp;<span class="op" id="5015727">=</span>&nbsp;<span class="ident" id="5015729">pconns</span><span class="op" id="5015735">[</span><span class="builtinfunc" id="5015736">len</span><span class="op" id="5015739">(</span><span class="ident" id="5015740">pconns</span><span class="op" id="5015746">)</span><span class="op" id="5015747">-</span><span class="num" id="5015748">1</span><span class="op" id="5015749">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015754">t</span><span class="op" id="5015755">.</span><span class="ident" id="5015756">idleConn</span><span class="op" id="5015764">[</span><span class="ident" id="5015765">key</span><span class="op" id="5015768">]</span>&nbsp;<span class="op" id="5015770">=</span>&nbsp;<span class="ident" id="5015772">pconns</span><span class="op" id="5015778">[</span><span class="op" id="5015779">:</span><span class="builtinfunc" id="5015780">len</span><span class="op" id="5015783">(</span><span class="ident" id="5015784">pconns</span><span class="op" id="5015790">)</span><span class="op" id="5015791">-</span><span class="num" id="5015792">1</span><span class="op" id="5015793">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015801">if</span>&nbsp;<span class="op" id="5015804">!</span><span class="ident" id="5015805">pconn</span><span class="op" id="5015810">.</span><span class="ident" id="5015811">isBroken</span><span class="op" id="5015819">(</span><span class="op" id="5015820">)</span>&nbsp;<span class="op" id="5015822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015827">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5015839">}</span><br>
<span class="lineno"></span><span class="op" id="5015841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5015844">func</span>&nbsp;<span class="op" id="5015849">(</span><span class="ident" id="5015850">t</span>&nbsp;<span class="op" id="5015852">*</span><span class="ident" id="5015853">Transport</span><span class="op" id="5015862">)</span>&nbsp;<span class="ident" id="5015864">setReqCanceler</span><span class="op" id="5015878">(</span><span class="ident" id="5015879">r</span>&nbsp;<span class="op" id="5015881">*</span><span class="ident" id="5015882">Request</span><span class="op" id="5015889">,</span>&nbsp;<span class="ident" id="5015891">fn</span>&nbsp;<span class="keyword" id="5015894">func</span><span class="op" id="5015898">(</span><span class="op" id="5015899">)</span><span class="op" id="5015900">)</span>&nbsp;<span class="op" id="5015902">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015905">t</span><span class="op" id="5015906">.</span><span class="ident" id="5015907">reqMu</span><span class="op" id="5015912">.</span><span class="ident" id="5015913">Lock</span><span class="op" id="5015917">(</span><span class="op" id="5015918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015921">defer</span>&nbsp;<span class="ident" id="5015927">t</span><span class="op" id="5015928">.</span><span class="ident" id="5015929">reqMu</span><span class="op" id="5015934">.</span><span class="ident" id="5015935">Unlock</span><span class="op" id="5015941">(</span><span class="op" id="5015942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5015945">if</span>&nbsp;<span class="ident" id="5015948">t</span><span class="op" id="5015949">.</span><span class="ident" id="5015950">reqCanceler</span>&nbsp;<span class="op" id="5015962">==</span>&nbsp;<span class="ident" id="5015965">nil</span>&nbsp;<span class="op" id="5015969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5015973">t</span><span class="op" id="5015974">.</span><span class="ident" id="5015975">reqCanceler</span>&nbsp;<span class="op" id="5015987">=</span>&nbsp;<span class="builtinfunc" id="5015989">make</span><span class="op" id="5015993">(</span><span class="keyword" id="5015994">map</span><span class="op" id="5015997">[</span><span class="op" id="5015998">*</span><span class="ident" id="5015999">Request</span><span class="op" id="5016006">]</span><span class="keyword" id="5016007">func</span><span class="op" id="5016011">(</span><span class="op" id="5016012">)</span><span class="op" id="5016013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5016016">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016019">if</span>&nbsp;<span class="ident" id="5016022">fn</span>&nbsp;<span class="op" id="5016025">!=</span>&nbsp;<span class="ident" id="5016028">nil</span>&nbsp;<span class="op" id="5016032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016036">t</span><span class="op" id="5016037">.</span><span class="ident" id="5016038">reqCanceler</span><span class="op" id="5016049">[</span><span class="ident" id="5016050">r</span><span class="op" id="5016051">]</span>&nbsp;<span class="op" id="5016053">=</span>&nbsp;<span class="ident" id="5016055">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5016059">}</span>&nbsp;<span class="keyword" id="5016061">else</span>&nbsp;<span class="op" id="5016066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5016070">delete</span><span class="op" id="5016076">(</span><span class="ident" id="5016077">t</span><span class="op" id="5016078">.</span><span class="ident" id="5016079">reqCanceler</span><span class="op" id="5016090">,</span>&nbsp;<span class="ident" id="5016092">r</span><span class="op" id="5016093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5016096">}</span><br>
<span class="lineno">475</span><span class="op" id="5016098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5016101">func</span>&nbsp;<span class="op" id="5016106">(</span><span class="ident" id="5016107">t</span>&nbsp;<span class="op" id="5016109">*</span><span class="ident" id="5016110">Transport</span><span class="op" id="5016119">)</span>&nbsp;<span class="ident" id="5016121">dial</span><span class="op" id="5016125">(</span><span class="ident" id="5016126">network</span><span class="op" id="5016133">,</span>&nbsp;<span class="ident" id="5016135">addr</span>&nbsp;<span class="builtintype" id="5016140">string</span><span class="op" id="5016146">)</span>&nbsp;<span class="op" id="5016148">(</span><span class="ident" id="5016149">c</span>&nbsp;<span class="ident" id="5016151">net</span><span class="op" id="5016154">.</span><span class="ident" id="5016155">Conn</span><span class="op" id="5016159">,</span>&nbsp;<span class="ident" id="5016161">err</span>&nbsp;<span class="builtintype" id="5016165">error</span><span class="op" id="5016170">)</span>&nbsp;<span class="op" id="5016172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016175">if</span>&nbsp;<span class="ident" id="5016178">t</span><span class="op" id="5016179">.</span><span class="ident" id="5016180">Dial</span>&nbsp;<span class="op" id="5016185">!=</span>&nbsp;<span class="ident" id="5016188">nil</span>&nbsp;<span class="op" id="5016192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016196">return</span>&nbsp;<span class="ident" id="5016203">t</span><span class="op" id="5016204">.</span><span class="ident" id="5016205">Dial</span><span class="op" id="5016209">(</span><span class="ident" id="5016210">network</span><span class="op" id="5016217">,</span>&nbsp;<span class="ident" id="5016219">addr</span><span class="op" id="5016223">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5016226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016229">return</span>&nbsp;<span class="ident" id="5016236">net</span><span class="op" id="5016239">.</span><span class="ident" id="5016240">Dial</span><span class="op" id="5016244">(</span><span class="ident" id="5016245">network</span><span class="op" id="5016252">,</span>&nbsp;<span class="ident" id="5016254">addr</span><span class="op" id="5016258">)</span><br>
<span class="lineno"></span><span class="op" id="5016260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5016263">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="5016281">var</span>&nbsp;<span class="ident" id="5016285">prePendingDial</span><span class="op" id="5016299">,</span>&nbsp;<span class="ident" id="5016301">postPendingDial</span>&nbsp;<span class="keyword" id="5016317">func</span><span class="op" id="5016321">(</span><span class="op" id="5016322">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5016325">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5016389">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="5016461">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="5016537">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="5016571">func</span>&nbsp;<span class="op" id="5016576">(</span><span class="ident" id="5016577">t</span>&nbsp;<span class="op" id="5016579">*</span><span class="ident" id="5016580">Transport</span><span class="op" id="5016589">)</span>&nbsp;<span class="ident" id="5016591">getConn</span><span class="op" id="5016598">(</span><span class="ident" id="5016599">req</span>&nbsp;<span class="op" id="5016603">*</span><span class="ident" id="5016604">Request</span><span class="op" id="5016611">,</span>&nbsp;<span class="ident" id="5016613">cm</span>&nbsp;<span class="ident" id="5016616">connectMethod</span><span class="op" id="5016629">)</span>&nbsp;<span class="op" id="5016631">(</span><span class="op" id="5016632">*</span><span class="ident" id="5016633">persistConn</span><span class="op" id="5016644">,</span>&nbsp;<span class="builtintype" id="5016646">error</span><span class="op" id="5016651">)</span>&nbsp;<span class="op" id="5016653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016656">if</span>&nbsp;<span class="ident" id="5016659">pc</span>&nbsp;<span class="op" id="5016662">:=</span>&nbsp;<span class="ident" id="5016665">t</span><span class="op" id="5016666">.</span><span class="ident" id="5016667">getIdleConn</span><span class="op" id="5016678">(</span><span class="ident" id="5016679">cm</span><span class="op" id="5016681">)</span><span class="op" id="5016682">;</span>&nbsp;<span class="ident" id="5016684">pc</span>&nbsp;<span class="op" id="5016687">!=</span>&nbsp;<span class="ident" id="5016690">nil</span>&nbsp;<span class="op" id="5016694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016698">return</span>&nbsp;<span class="ident" id="5016705">pc</span><span class="op" id="5016707">,</span>&nbsp;<span class="ident" id="5016709">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5016714">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016718">type</span>&nbsp;<span class="ident" id="5016723">dialRes</span>&nbsp;<span class="keyword" id="5016731">struct</span>&nbsp;<span class="op" id="5016738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016742">pc</span>&nbsp;&nbsp;<span class="op" id="5016746">*</span><span class="ident" id="5016747">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016761">err</span>&nbsp;<span class="builtintype" id="5016765">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5016772">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016775">dialc</span>&nbsp;<span class="op" id="5016781">:=</span>&nbsp;<span class="builtinfunc" id="5016784">make</span><span class="op" id="5016788">(</span><span class="keyword" id="5016789">chan</span>&nbsp;<span class="ident" id="5016794">dialRes</span><span class="op" id="5016801">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016805">handlePendingDial</span>&nbsp;<span class="op" id="5016823">:=</span>&nbsp;<span class="keyword" id="5016826">func</span><span class="op" id="5016830">(</span><span class="op" id="5016831">)</span>&nbsp;<span class="op" id="5016833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016837">if</span>&nbsp;<span class="ident" id="5016840">prePendingDial</span>&nbsp;<span class="op" id="5016855">!=</span>&nbsp;<span class="ident" id="5016858">nil</span>&nbsp;<span class="op" id="5016862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016867">prePendingDial</span><span class="op" id="5016881">(</span><span class="op" id="5016882">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5016886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016890">go</span>&nbsp;<span class="keyword" id="5016893">func</span><span class="op" id="5016897">(</span><span class="op" id="5016898">)</span>&nbsp;<span class="op" id="5016900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016905">if</span>&nbsp;<span class="ident" id="5016908">v</span>&nbsp;<span class="op" id="5016910">:=</span>&nbsp;<span class="op" id="5016913">&lt;-</span><span class="ident" id="5016915">dialc</span><span class="op" id="5016920">;</span>&nbsp;<span class="ident" id="5016922">v</span><span class="op" id="5016923">.</span><span class="ident" id="5016924">err</span>&nbsp;<span class="op" id="5016928">==</span>&nbsp;<span class="ident" id="5016931">nil</span>&nbsp;<span class="op" id="5016935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5016941">t</span><span class="op" id="5016942">.</span><span class="ident" id="5016943">putIdleConn</span><span class="op" id="5016954">(</span><span class="ident" id="5016955">v</span><span class="op" id="5016956">.</span><span class="ident" id="5016957">pc</span><span class="op" id="5016959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5016964">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5016969">if</span>&nbsp;<span class="ident" id="5016972">postPendingDial</span>&nbsp;<span class="op" id="5016988">!=</span>&nbsp;<span class="ident" id="5016991">nil</span>&nbsp;<span class="op" id="5016995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017001">postPendingDial</span><span class="op" id="5017016">(</span><span class="op" id="5017017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5017022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5017026">}</span><span class="op" id="5017027">(</span><span class="op" id="5017028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5017031">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017035">cancelc</span>&nbsp;<span class="op" id="5017043">:=</span>&nbsp;<span class="builtinfunc" id="5017046">make</span><span class="op" id="5017050">(</span><span class="keyword" id="5017051">chan</span>&nbsp;<span class="keyword" id="5017056">struct</span><span class="op" id="5017062">{</span><span class="op" id="5017063">}</span><span class="op" id="5017064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017067">t</span><span class="op" id="5017068">.</span><span class="ident" id="5017069">setReqCanceler</span><span class="op" id="5017083">(</span><span class="ident" id="5017084">req</span><span class="op" id="5017087">,</span>&nbsp;<span class="keyword" id="5017089">func</span><span class="op" id="5017093">(</span><span class="op" id="5017094">)</span>&nbsp;<span class="op" id="5017096">{</span>&nbsp;<span class="builtinfunc" id="5017098">close</span><span class="op" id="5017103">(</span><span class="ident" id="5017104">cancelc</span><span class="op" id="5017111">)</span>&nbsp;<span class="op" id="5017113">}</span><span class="op" id="5017114">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017118">go</span>&nbsp;<span class="keyword" id="5017121">func</span><span class="op" id="5017125">(</span><span class="op" id="5017126">)</span>&nbsp;<span class="op" id="5017128">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017132">pc</span><span class="op" id="5017134">,</span>&nbsp;<span class="ident" id="5017136">err</span>&nbsp;<span class="op" id="5017140">:=</span>&nbsp;<span class="ident" id="5017143">t</span><span class="op" id="5017144">.</span><span class="ident" id="5017145">dialConn</span><span class="op" id="5017153">(</span><span class="ident" id="5017154">cm</span><span class="op" id="5017156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017160">dialc</span>&nbsp;<span class="op" id="5017166">&lt;-</span>&nbsp;<span class="ident" id="5017169">dialRes</span><span class="op" id="5017176">{</span><span class="ident" id="5017177">pc</span><span class="op" id="5017179">,</span>&nbsp;<span class="ident" id="5017181">err</span><span class="op" id="5017184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5017187">}</span><span class="op" id="5017188">(</span><span class="op" id="5017189">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017193">idleConnCh</span>&nbsp;<span class="op" id="5017204">:=</span>&nbsp;<span class="ident" id="5017207">t</span><span class="op" id="5017208">.</span><span class="ident" id="5017209">getIdleConnCh</span><span class="op" id="5017222">(</span><span class="ident" id="5017223">cm</span><span class="op" id="5017225">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017228">select</span>&nbsp;<span class="op" id="5017235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017238">case</span>&nbsp;<span class="ident" id="5017243">v</span>&nbsp;<span class="op" id="5017245">:=</span>&nbsp;<span class="op" id="5017248">&lt;-</span><span class="ident" id="5017250">dialc</span><span class="op" id="5017255">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5017259">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017283">return</span>&nbsp;<span class="ident" id="5017290">v</span><span class="op" id="5017291">.</span><span class="ident" id="5017292">pc</span><span class="op" id="5017294">,</span>&nbsp;<span class="ident" id="5017296">v</span><span class="op" id="5017297">.</span><span class="ident" id="5017298">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017303">case</span>&nbsp;<span class="ident" id="5017308">pc</span>&nbsp;<span class="op" id="5017311">:=</span>&nbsp;<span class="op" id="5017314">&lt;-</span><span class="ident" id="5017316">idleConnCh</span><span class="op" id="5017326">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5017330">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5017383">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5017434">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5017473">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5017523">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017546">handlePendingDial</span><span class="op" id="5017563">(</span><span class="op" id="5017564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017568">return</span>&nbsp;<span class="ident" id="5017575">pc</span><span class="op" id="5017577">,</span>&nbsp;<span class="ident" id="5017579">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017584">case</span>&nbsp;<span class="op" id="5017589">&lt;-</span><span class="ident" id="5017591">cancelc</span><span class="op" id="5017598">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017602">handlePendingDial</span><span class="op" id="5017619">(</span><span class="op" id="5017620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5017624">return</span>&nbsp;<span class="ident" id="5017631">nil</span><span class="op" id="5017634">,</span>&nbsp;<span class="ident" id="5017636">errors</span><span class="op" id="5017642">.</span><span class="ident" id="5017643">New</span><span class="op" id="5017646">(</span><span class="string" id="5017647">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="5017704">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5017707">}</span><br>
<span class="lineno"></span><span class="op" id="5017709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5017712">func</span>&nbsp;<span class="op" id="5017717">(</span><span class="ident" id="5017718">t</span>&nbsp;<span class="op" id="5017720">*</span><span class="ident" id="5017721">Transport</span><span class="op" id="5017730">)</span>&nbsp;<span class="ident" id="5017732">dialConn</span><span class="op" id="5017740">(</span><span class="ident" id="5017741">cm</span>&nbsp;<span class="ident" id="5017744">connectMethod</span><span class="op" id="5017757">)</span>&nbsp;<span class="op" id="5017759">(</span><span class="op" id="5017760">*</span><span class="ident" id="5017761">persistConn</span><span class="op" id="5017772">,</span>&nbsp;<span class="builtintype" id="5017774">error</span><span class="op" id="5017779">)</span>&nbsp;<span class="op" id="5017781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017784">pconn</span>&nbsp;<span class="op" id="5017790">:=</span>&nbsp;<span class="op" id="5017793">&amp;</span><span class="ident" id="5017794">persistConn</span><span class="op" id="5017805">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017809">t</span><span class="op" id="5017810">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5017821">t</span><span class="op" id="5017822">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017826">cacheKey</span><span class="op" id="5017834">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5017838">cm</span><span class="op" id="5017840">.</span><span class="ident" id="5017841">key</span><span class="op" id="5017844">(</span><span class="op" id="5017845">)</span><span class="op" id="5017846">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017850">reqch</span><span class="op" id="5017855">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5017862">make</span><span class="op" id="5017866">(</span><span class="keyword" id="5017867">chan</span>&nbsp;<span class="ident" id="5017872">requestAndChan</span><span class="op" id="5017886">,</span>&nbsp;<span class="num" id="5017888">1</span><span class="op" id="5017889">)</span><span class="op" id="5017890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017894">writech</span><span class="op" id="5017901">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5017906">make</span><span class="op" id="5017910">(</span><span class="keyword" id="5017911">chan</span>&nbsp;<span class="ident" id="5017916">writeRequest</span><span class="op" id="5017928">,</span>&nbsp;<span class="num" id="5017930">1</span><span class="op" id="5017931">)</span><span class="op" id="5017932">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017936">closech</span><span class="op" id="5017943">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5017948">make</span><span class="op" id="5017952">(</span><span class="keyword" id="5017953">chan</span>&nbsp;<span class="keyword" id="5017958">struct</span><span class="op" id="5017964">{</span><span class="op" id="5017965">}</span><span class="op" id="5017966">)</span><span class="op" id="5017967">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5017971">writeErrCh</span><span class="op" id="5017981">:</span>&nbsp;<span class="builtinfunc" id="5017983">make</span><span class="op" id="5017987">(</span><span class="keyword" id="5017988">chan</span>&nbsp;<span class="builtintype" id="5017993">error</span><span class="op" id="5017998">,</span>&nbsp;<span class="num" id="5018000">1</span><span class="op" id="5018001">)</span><span class="op" id="5018002">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018008">tlsDial</span>&nbsp;<span class="op" id="5018016">:=</span>&nbsp;<span class="ident" id="5018019">t</span><span class="op" id="5018020">.</span><span class="ident" id="5018021">DialTLS</span>&nbsp;<span class="op" id="5018029">!=</span>&nbsp;<span class="ident" id="5018032">nil</span>&nbsp;<span class="op" id="5018036">&amp;&amp;</span>&nbsp;<span class="ident" id="5018039">cm</span><span class="op" id="5018041">.</span><span class="ident" id="5018042">targetScheme</span>&nbsp;<span class="op" id="5018055">==</span>&nbsp;<span class="string" id="5018058">&#34;https&#34;</span>&nbsp;<span class="op" id="5018066">&amp;&amp;</span>&nbsp;<span class="ident" id="5018069">cm</span><span class="op" id="5018071">.</span><span class="ident" id="5018072">proxyURL</span>&nbsp;<span class="op" id="5018081">==</span>&nbsp;<span class="ident" id="5018084">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018089">if</span>&nbsp;<span class="ident" id="5018092">tlsDial</span>&nbsp;<span class="op" id="5018100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018104">var</span>&nbsp;<span class="ident" id="5018108">err</span>&nbsp;<span class="builtintype" id="5018112">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018120">pconn</span><span class="op" id="5018125">.</span><span class="ident" id="5018126">conn</span><span class="op" id="5018130">,</span>&nbsp;<span class="ident" id="5018132">err</span>&nbsp;<span class="op" id="5018136">=</span>&nbsp;<span class="ident" id="5018138">t</span><span class="op" id="5018139">.</span><span class="ident" id="5018140">DialTLS</span><span class="op" id="5018147">(</span><span class="string" id="5018148">&#34;tcp&#34;</span><span class="op" id="5018153">,</span>&nbsp;<span class="ident" id="5018155">cm</span><span class="op" id="5018157">.</span><span class="ident" id="5018158">addr</span><span class="op" id="5018162">(</span><span class="op" id="5018163">)</span><span class="op" id="5018164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018168">if</span>&nbsp;<span class="ident" id="5018171">err</span>&nbsp;<span class="op" id="5018175">!=</span>&nbsp;<span class="ident" id="5018178">nil</span>&nbsp;<span class="op" id="5018182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018187">return</span>&nbsp;<span class="ident" id="5018194">nil</span><span class="op" id="5018197">,</span>&nbsp;<span class="ident" id="5018199">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018209">if</span>&nbsp;<span class="ident" id="5018212">tc</span><span class="op" id="5018214">,</span>&nbsp;<span class="ident" id="5018216">ok</span>&nbsp;<span class="op" id="5018219">:=</span>&nbsp;<span class="ident" id="5018222">pconn</span><span class="op" id="5018227">.</span><span class="ident" id="5018228">conn</span><span class="op" id="5018232">.</span><span class="op" id="5018233">(</span><span class="op" id="5018234">*</span><span class="ident" id="5018235">tls</span><span class="op" id="5018238">.</span><span class="ident" id="5018239">Conn</span><span class="op" id="5018243">)</span><span class="op" id="5018244">;</span>&nbsp;<span class="ident" id="5018246">ok</span>&nbsp;<span class="op" id="5018249">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018254">cs</span>&nbsp;<span class="op" id="5018257">:=</span>&nbsp;<span class="ident" id="5018260">tc</span><span class="op" id="5018262">.</span><span class="ident" id="5018263">ConnectionState</span><span class="op" id="5018278">(</span><span class="op" id="5018279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018284">pconn</span><span class="op" id="5018289">.</span><span class="ident" id="5018290">tlsState</span>&nbsp;<span class="op" id="5018299">=</span>&nbsp;<span class="op" id="5018301">&amp;</span><span class="ident" id="5018302">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018310">}</span>&nbsp;<span class="keyword" id="5018312">else</span>&nbsp;<span class="op" id="5018317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018321">conn</span><span class="op" id="5018325">,</span>&nbsp;<span class="ident" id="5018327">err</span>&nbsp;<span class="op" id="5018331">:=</span>&nbsp;<span class="ident" id="5018334">t</span><span class="op" id="5018335">.</span><span class="ident" id="5018336">dial</span><span class="op" id="5018340">(</span><span class="string" id="5018341">&#34;tcp&#34;</span><span class="op" id="5018346">,</span>&nbsp;<span class="ident" id="5018348">cm</span><span class="op" id="5018350">.</span><span class="ident" id="5018351">addr</span><span class="op" id="5018355">(</span><span class="op" id="5018356">)</span><span class="op" id="5018357">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018361">if</span>&nbsp;<span class="ident" id="5018364">err</span>&nbsp;<span class="op" id="5018368">!=</span>&nbsp;<span class="ident" id="5018371">nil</span>&nbsp;<span class="op" id="5018375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018380">if</span>&nbsp;<span class="ident" id="5018383">cm</span><span class="op" id="5018385">.</span><span class="ident" id="5018386">proxyURL</span>&nbsp;<span class="op" id="5018395">!=</span>&nbsp;<span class="ident" id="5018398">nil</span>&nbsp;<span class="op" id="5018402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018408">err</span>&nbsp;<span class="op" id="5018412">=</span>&nbsp;<span class="ident" id="5018414">fmt</span><span class="op" id="5018417">.</span><span class="ident" id="5018418">Errorf</span><span class="op" id="5018424">(</span><span class="string" id="5018425">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="5018465">,</span>&nbsp;<span class="ident" id="5018467">cm</span><span class="op" id="5018469">.</span><span class="ident" id="5018470">proxyURL</span><span class="op" id="5018478">,</span>&nbsp;<span class="ident" id="5018480">err</span><span class="op" id="5018483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018493">return</span>&nbsp;<span class="ident" id="5018500">nil</span><span class="op" id="5018503">,</span>&nbsp;<span class="ident" id="5018505">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018515">pconn</span><span class="op" id="5018520">.</span><span class="ident" id="5018521">conn</span>&nbsp;<span class="op" id="5018526">=</span>&nbsp;<span class="ident" id="5018528">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5018538">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018555">switch</span>&nbsp;<span class="op" id="5018562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018565">case</span>&nbsp;<span class="ident" id="5018570">cm</span><span class="op" id="5018572">.</span><span class="ident" id="5018573">proxyURL</span>&nbsp;<span class="op" id="5018582">==</span>&nbsp;<span class="ident" id="5018585">nil</span><span class="op" id="5018588">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5018592">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018627">case</span>&nbsp;<span class="ident" id="5018632">cm</span><span class="op" id="5018634">.</span><span class="ident" id="5018635">targetScheme</span>&nbsp;<span class="op" id="5018648">==</span>&nbsp;<span class="string" id="5018651">&#34;http&#34;</span><span class="op" id="5018657">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018661">pconn</span><span class="op" id="5018666">.</span><span class="ident" id="5018667">isProxy</span>&nbsp;<span class="op" id="5018675">=</span>&nbsp;<span class="builtintype" id="5018677">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018684">if</span>&nbsp;<span class="ident" id="5018687">pa</span>&nbsp;<span class="op" id="5018690">:=</span>&nbsp;<span class="ident" id="5018693">cm</span><span class="op" id="5018695">.</span><span class="ident" id="5018696">proxyAuth</span><span class="op" id="5018705">(</span><span class="op" id="5018706">)</span><span class="op" id="5018707">;</span>&nbsp;<span class="ident" id="5018709">pa</span>&nbsp;<span class="op" id="5018712">!=</span>&nbsp;<span class="string" id="5018715">&#34;&#34;</span>&nbsp;<span class="op" id="5018718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018723">pconn</span><span class="op" id="5018728">.</span><span class="ident" id="5018729">mutateHeaderFunc</span>&nbsp;<span class="op" id="5018746">=</span>&nbsp;<span class="keyword" id="5018748">func</span><span class="op" id="5018752">(</span><span class="ident" id="5018753">h</span>&nbsp;<span class="ident" id="5018755">Header</span><span class="op" id="5018761">)</span>&nbsp;<span class="op" id="5018763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018769">h</span><span class="op" id="5018770">.</span><span class="ident" id="5018771">Set</span><span class="op" id="5018774">(</span><span class="string" id="5018775">&#34;Proxy-Authorization&#34;</span><span class="op" id="5018796">,</span>&nbsp;<span class="ident" id="5018798">pa</span><span class="op" id="5018800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5018809">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5018812">case</span>&nbsp;<span class="ident" id="5018817">cm</span><span class="op" id="5018819">.</span><span class="ident" id="5018820">targetScheme</span>&nbsp;<span class="op" id="5018833">==</span>&nbsp;<span class="string" id="5018836">&#34;https&#34;</span><span class="op" id="5018843">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018847">conn</span>&nbsp;<span class="op" id="5018852">:=</span>&nbsp;<span class="ident" id="5018855">pconn</span><span class="op" id="5018860">.</span><span class="ident" id="5018861">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018868">connectReq</span>&nbsp;<span class="op" id="5018879">:=</span>&nbsp;<span class="op" id="5018882">&amp;</span><span class="ident" id="5018883">Request</span><span class="op" id="5018890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018895">Method</span><span class="op" id="5018901">:</span>&nbsp;<span class="string" id="5018903">&#34;CONNECT&#34;</span><span class="op" id="5018912">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018917">URL</span><span class="op" id="5018920">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5018925">&amp;</span><span class="ident" id="5018926">url</span><span class="op" id="5018929">.</span><span class="ident" id="5018930">URL</span><span class="op" id="5018933">{</span><span class="ident" id="5018934">Opaque</span><span class="op" id="5018940">:</span>&nbsp;<span class="ident" id="5018942">cm</span><span class="op" id="5018944">.</span><span class="ident" id="5018945">targetAddr</span><span class="op" id="5018955">}</span><span class="op" id="5018956">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018961">Host</span><span class="op" id="5018965">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5018969">cm</span><span class="op" id="5018971">.</span><span class="ident" id="5018972">targetAddr</span><span class="op" id="5018982">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5018987">Header</span><span class="op" id="5018993">:</span>&nbsp;<span class="builtinfunc" id="5018995">make</span><span class="op" id="5018999">(</span><span class="ident" id="5019000">Header</span><span class="op" id="5019006">)</span><span class="op" id="5019007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019015">if</span>&nbsp;<span class="ident" id="5019018">pa</span>&nbsp;<span class="op" id="5019021">:=</span>&nbsp;<span class="ident" id="5019024">cm</span><span class="op" id="5019026">.</span><span class="ident" id="5019027">proxyAuth</span><span class="op" id="5019036">(</span><span class="op" id="5019037">)</span><span class="op" id="5019038">;</span>&nbsp;<span class="ident" id="5019040">pa</span>&nbsp;<span class="op" id="5019043">!=</span>&nbsp;<span class="string" id="5019046">&#34;&#34;</span>&nbsp;<span class="op" id="5019049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019054">connectReq</span><span class="op" id="5019064">.</span><span class="ident" id="5019065">Header</span><span class="op" id="5019071">.</span><span class="ident" id="5019072">Set</span><span class="op" id="5019075">(</span><span class="string" id="5019076">&#34;Proxy-Authorization&#34;</span><span class="op" id="5019097">,</span>&nbsp;<span class="ident" id="5019099">pa</span><span class="op" id="5019101">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019109">connectReq</span><span class="op" id="5019119">.</span><span class="ident" id="5019120">Write</span><span class="op" id="5019125">(</span><span class="ident" id="5019126">conn</span><span class="op" id="5019130">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5019135">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5019155">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5019214">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019262">br</span>&nbsp;<span class="op" id="5019265">:=</span>&nbsp;<span class="ident" id="5019268">bufio</span><span class="op" id="5019273">.</span><span class="ident" id="5019274">NewReader</span><span class="op" id="5019283">(</span><span class="ident" id="5019284">conn</span><span class="op" id="5019288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019292">resp</span><span class="op" id="5019296">,</span>&nbsp;<span class="ident" id="5019298">err</span>&nbsp;<span class="op" id="5019302">:=</span>&nbsp;<span class="ident" id="5019305">ReadResponse</span><span class="op" id="5019317">(</span><span class="ident" id="5019318">br</span><span class="op" id="5019320">,</span>&nbsp;<span class="ident" id="5019322">connectReq</span><span class="op" id="5019332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019336">if</span>&nbsp;<span class="ident" id="5019339">err</span>&nbsp;<span class="op" id="5019343">!=</span>&nbsp;<span class="ident" id="5019346">nil</span>&nbsp;<span class="op" id="5019350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019355">conn</span><span class="op" id="5019359">.</span><span class="ident" id="5019360">Close</span><span class="op" id="5019365">(</span><span class="op" id="5019366">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019371">return</span>&nbsp;<span class="ident" id="5019378">nil</span><span class="op" id="5019381">,</span>&nbsp;<span class="ident" id="5019383">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019393">if</span>&nbsp;<span class="ident" id="5019396">resp</span><span class="op" id="5019400">.</span><span class="ident" id="5019401">StatusCode</span>&nbsp;<span class="op" id="5019412">!=</span>&nbsp;<span class="num" id="5019415">200</span>&nbsp;<span class="op" id="5019419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019424">f</span>&nbsp;<span class="op" id="5019426">:=</span>&nbsp;<span class="ident" id="5019429">strings</span><span class="op" id="5019436">.</span><span class="ident" id="5019437">SplitN</span><span class="op" id="5019443">(</span><span class="ident" id="5019444">resp</span><span class="op" id="5019448">.</span><span class="ident" id="5019449">Status</span><span class="op" id="5019455">,</span>&nbsp;<span class="string" id="5019457">&#34;&nbsp;&#34;</span><span class="op" id="5019460">,</span>&nbsp;<span class="num" id="5019462">2</span><span class="op" id="5019463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019468">conn</span><span class="op" id="5019472">.</span><span class="ident" id="5019473">Close</span><span class="op" id="5019478">(</span><span class="op" id="5019479">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019484">return</span>&nbsp;<span class="ident" id="5019491">nil</span><span class="op" id="5019494">,</span>&nbsp;<span class="ident" id="5019496">errors</span><span class="op" id="5019502">.</span><span class="ident" id="5019503">New</span><span class="op" id="5019506">(</span><span class="ident" id="5019507">f</span><span class="op" id="5019508">[</span><span class="num" id="5019509">1</span><span class="op" id="5019510">]</span><span class="op" id="5019511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019522">if</span>&nbsp;<span class="ident" id="5019525">cm</span><span class="op" id="5019527">.</span><span class="ident" id="5019528">targetScheme</span>&nbsp;<span class="op" id="5019541">==</span>&nbsp;<span class="string" id="5019544">&#34;https&#34;</span>&nbsp;<span class="op" id="5019552">&amp;&amp;</span>&nbsp;<span class="op" id="5019555">!</span><span class="ident" id="5019556">tlsDial</span>&nbsp;<span class="op" id="5019564">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5019568">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019634">cfg</span>&nbsp;<span class="op" id="5019638">:=</span>&nbsp;<span class="ident" id="5019641">t</span><span class="op" id="5019642">.</span><span class="ident" id="5019643">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019661">if</span>&nbsp;<span class="ident" id="5019664">cfg</span>&nbsp;<span class="op" id="5019668">==</span>&nbsp;<span class="ident" id="5019671">nil</span>&nbsp;<span class="op" id="5019675">||</span>&nbsp;<span class="ident" id="5019678">cfg</span><span class="op" id="5019681">.</span><span class="ident" id="5019682">ServerName</span>&nbsp;<span class="op" id="5019693">==</span>&nbsp;<span class="string" id="5019696">&#34;&#34;</span>&nbsp;<span class="op" id="5019699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019704">host</span>&nbsp;<span class="op" id="5019709">:=</span>&nbsp;<span class="ident" id="5019712">cm</span><span class="op" id="5019714">.</span><span class="ident" id="5019715">tlsHost</span><span class="op" id="5019722">(</span><span class="op" id="5019723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019728">if</span>&nbsp;<span class="ident" id="5019731">cfg</span>&nbsp;<span class="op" id="5019735">==</span>&nbsp;<span class="ident" id="5019738">nil</span>&nbsp;<span class="op" id="5019742">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019748">cfg</span>&nbsp;<span class="op" id="5019752">=</span>&nbsp;<span class="op" id="5019754">&amp;</span><span class="ident" id="5019755">tls</span><span class="op" id="5019758">.</span><span class="ident" id="5019759">Config</span><span class="op" id="5019765">{</span><span class="ident" id="5019766">ServerName</span><span class="op" id="5019776">:</span>&nbsp;<span class="ident" id="5019778">host</span><span class="op" id="5019782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019787">}</span>&nbsp;<span class="keyword" id="5019789">else</span>&nbsp;<span class="op" id="5019794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019800">clone</span>&nbsp;<span class="op" id="5019806">:=</span>&nbsp;<span class="op" id="5019809">*</span><span class="ident" id="5019810">cfg</span>&nbsp;<span class="comment" id="5019814">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019835">clone</span><span class="op" id="5019840">.</span><span class="ident" id="5019841">ServerName</span>&nbsp;<span class="op" id="5019852">=</span>&nbsp;<span class="ident" id="5019854">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019863">cfg</span>&nbsp;<span class="op" id="5019867">=</span>&nbsp;<span class="op" id="5019869">&amp;</span><span class="ident" id="5019870">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5019883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019887">plainConn</span>&nbsp;<span class="op" id="5019897">:=</span>&nbsp;<span class="ident" id="5019900">pconn</span><span class="op" id="5019905">.</span><span class="ident" id="5019906">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019913">tlsConn</span>&nbsp;<span class="op" id="5019921">:=</span>&nbsp;<span class="ident" id="5019924">tls</span><span class="op" id="5019927">.</span><span class="ident" id="5019928">Client</span><span class="op" id="5019934">(</span><span class="ident" id="5019935">plainConn</span><span class="op" id="5019944">,</span>&nbsp;<span class="ident" id="5019946">cfg</span><span class="op" id="5019949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5019953">errc</span>&nbsp;<span class="op" id="5019958">:=</span>&nbsp;<span class="builtinfunc" id="5019961">make</span><span class="op" id="5019965">(</span><span class="keyword" id="5019966">chan</span>&nbsp;<span class="builtintype" id="5019971">error</span><span class="op" id="5019976">,</span>&nbsp;<span class="num" id="5019978">2</span><span class="op" id="5019979">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5019983">var</span>&nbsp;<span class="ident" id="5019987">timer</span>&nbsp;<span class="op" id="5019993">*</span><span class="ident" id="5019994">time</span><span class="op" id="5019998">.</span><span class="ident" id="5019999">Timer</span>&nbsp;<span class="comment" id="5020005">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020038">if</span>&nbsp;<span class="ident" id="5020041">d</span>&nbsp;<span class="op" id="5020043">:=</span>&nbsp;<span class="ident" id="5020046">t</span><span class="op" id="5020047">.</span><span class="ident" id="5020048">TLSHandshakeTimeout</span><span class="op" id="5020067">;</span>&nbsp;<span class="ident" id="5020069">d</span>&nbsp;<span class="op" id="5020071">!=</span>&nbsp;<span class="num" id="5020074">0</span>&nbsp;<span class="op" id="5020076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020081">timer</span>&nbsp;<span class="op" id="5020087">=</span>&nbsp;<span class="ident" id="5020089">time</span><span class="op" id="5020093">.</span><span class="ident" id="5020094">AfterFunc</span><span class="op" id="5020103">(</span><span class="ident" id="5020104">d</span><span class="op" id="5020105">,</span>&nbsp;<span class="keyword" id="5020107">func</span><span class="op" id="5020111">(</span><span class="op" id="5020112">)</span>&nbsp;<span class="op" id="5020114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020120">errc</span>&nbsp;<span class="op" id="5020125">&lt;-</span>&nbsp;<span class="ident" id="5020128">tlsHandshakeTimeoutError</span><span class="op" id="5020152">{</span><span class="op" id="5020153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5020158">}</span><span class="op" id="5020159">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5020163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020167">go</span>&nbsp;<span class="keyword" id="5020170">func</span><span class="op" id="5020174">(</span><span class="op" id="5020175">)</span>&nbsp;<span class="op" id="5020177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020182">err</span>&nbsp;<span class="op" id="5020186">:=</span>&nbsp;<span class="ident" id="5020189">tlsConn</span><span class="op" id="5020196">.</span><span class="ident" id="5020197">Handshake</span><span class="op" id="5020206">(</span><span class="op" id="5020207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020212">if</span>&nbsp;<span class="ident" id="5020215">timer</span>&nbsp;<span class="op" id="5020221">!=</span>&nbsp;<span class="ident" id="5020224">nil</span>&nbsp;<span class="op" id="5020228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020234">timer</span><span class="op" id="5020239">.</span><span class="ident" id="5020240">Stop</span><span class="op" id="5020244">(</span><span class="op" id="5020245">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5020250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020255">errc</span>&nbsp;<span class="op" id="5020260">&lt;-</span>&nbsp;<span class="ident" id="5020263">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5020269">}</span><span class="op" id="5020270">(</span><span class="op" id="5020271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020275">if</span>&nbsp;<span class="ident" id="5020278">err</span>&nbsp;<span class="op" id="5020282">:=</span>&nbsp;<span class="op" id="5020285">&lt;-</span><span class="ident" id="5020287">errc</span><span class="op" id="5020291">;</span>&nbsp;<span class="ident" id="5020293">err</span>&nbsp;<span class="op" id="5020297">!=</span>&nbsp;<span class="ident" id="5020300">nil</span>&nbsp;<span class="op" id="5020304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020309">plainConn</span><span class="op" id="5020318">.</span><span class="ident" id="5020319">Close</span><span class="op" id="5020324">(</span><span class="op" id="5020325">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020330">return</span>&nbsp;<span class="ident" id="5020337">nil</span><span class="op" id="5020340">,</span>&nbsp;<span class="ident" id="5020342">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5020348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020352">if</span>&nbsp;<span class="op" id="5020355">!</span><span class="ident" id="5020356">cfg</span><span class="op" id="5020359">.</span><span class="ident" id="5020360">InsecureSkipVerify</span>&nbsp;<span class="op" id="5020379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020384">if</span>&nbsp;<span class="ident" id="5020387">err</span>&nbsp;<span class="op" id="5020391">:=</span>&nbsp;<span class="ident" id="5020394">tlsConn</span><span class="op" id="5020401">.</span><span class="ident" id="5020402">VerifyHostname</span><span class="op" id="5020416">(</span><span class="ident" id="5020417">cfg</span><span class="op" id="5020420">.</span><span class="ident" id="5020421">ServerName</span><span class="op" id="5020431">)</span><span class="op" id="5020432">;</span>&nbsp;<span class="ident" id="5020434">err</span>&nbsp;<span class="op" id="5020438">!=</span>&nbsp;<span class="ident" id="5020441">nil</span>&nbsp;<span class="op" id="5020445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020451">plainConn</span><span class="op" id="5020460">.</span><span class="ident" id="5020461">Close</span><span class="op" id="5020466">(</span><span class="op" id="5020467">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020473">return</span>&nbsp;<span class="ident" id="5020480">nil</span><span class="op" id="5020483">,</span>&nbsp;<span class="ident" id="5020485">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5020492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5020496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020500">cs</span>&nbsp;<span class="op" id="5020503">:=</span>&nbsp;<span class="ident" id="5020506">tlsConn</span><span class="op" id="5020513">.</span><span class="ident" id="5020514">ConnectionState</span><span class="op" id="5020529">(</span><span class="op" id="5020530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020534">pconn</span><span class="op" id="5020539">.</span><span class="ident" id="5020540">tlsState</span>&nbsp;<span class="op" id="5020549">=</span>&nbsp;<span class="op" id="5020551">&amp;</span><span class="ident" id="5020552">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020557">pconn</span><span class="op" id="5020562">.</span><span class="ident" id="5020563">conn</span>&nbsp;<span class="op" id="5020568">=</span>&nbsp;<span class="ident" id="5020570">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5020579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020583">pconn</span><span class="op" id="5020588">.</span><span class="ident" id="5020589">br</span>&nbsp;<span class="op" id="5020592">=</span>&nbsp;<span class="ident" id="5020594">bufio</span><span class="op" id="5020599">.</span><span class="ident" id="5020600">NewReader</span><span class="op" id="5020609">(</span><span class="ident" id="5020610">noteEOFReader</span><span class="op" id="5020623">{</span><span class="ident" id="5020624">pconn</span><span class="op" id="5020629">.</span><span class="ident" id="5020630">conn</span><span class="op" id="5020634">,</span>&nbsp;<span class="op" id="5020636">&amp;</span><span class="ident" id="5020637">pconn</span><span class="op" id="5020642">.</span><span class="ident" id="5020643">sawEOF</span><span class="op" id="5020649">}</span><span class="op" id="5020650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5020653">pconn</span><span class="op" id="5020658">.</span><span class="ident" id="5020659">bw</span>&nbsp;<span class="op" id="5020662">=</span>&nbsp;<span class="ident" id="5020664">bufio</span><span class="op" id="5020669">.</span><span class="ident" id="5020670">NewWriter</span><span class="op" id="5020679">(</span><span class="ident" id="5020680">pconn</span><span class="op" id="5020685">.</span><span class="ident" id="5020686">conn</span><span class="op" id="5020690">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020693">go</span>&nbsp;<span class="ident" id="5020696">pconn</span><span class="op" id="5020701">.</span><span class="ident" id="5020702">readLoop</span><span class="op" id="5020710">(</span><span class="op" id="5020711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020714">go</span>&nbsp;<span class="ident" id="5020717">pconn</span><span class="op" id="5020722">.</span><span class="ident" id="5020723">writeLoop</span><span class="op" id="5020732">(</span><span class="op" id="5020733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020736">return</span>&nbsp;<span class="ident" id="5020743">pconn</span><span class="op" id="5020748">,</span>&nbsp;<span class="ident" id="5020750">nil</span><br>
<span class="lineno"></span><span class="op" id="5020754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="5020757">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="5020822">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="5020885">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="5020941">func</span>&nbsp;<span class="ident" id="5020946">useProxy</span><span class="op" id="5020954">(</span><span class="ident" id="5020955">addr</span>&nbsp;<span class="builtintype" id="5020960">string</span><span class="op" id="5020966">)</span>&nbsp;<span class="builtintype" id="5020968">bool</span>&nbsp;<span class="op" id="5020973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020976">if</span>&nbsp;<span class="builtinfunc" id="5020979">len</span><span class="op" id="5020982">(</span><span class="ident" id="5020983">addr</span><span class="op" id="5020987">)</span>&nbsp;<span class="op" id="5020989">==</span>&nbsp;<span class="num" id="5020992">0</span>&nbsp;<span class="op" id="5020994">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5020998">return</span>&nbsp;<span class="builtintype" id="5021005">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021014">host</span><span class="op" id="5021018">,</span>&nbsp;<span class="ident" id="5021020">_</span><span class="op" id="5021021">,</span>&nbsp;<span class="ident" id="5021023">err</span>&nbsp;<span class="op" id="5021027">:=</span>&nbsp;<span class="ident" id="5021030">net</span><span class="op" id="5021033">.</span><span class="ident" id="5021034">SplitHostPort</span><span class="op" id="5021047">(</span><span class="ident" id="5021048">addr</span><span class="op" id="5021052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021055">if</span>&nbsp;<span class="ident" id="5021058">err</span>&nbsp;<span class="op" id="5021062">!=</span>&nbsp;<span class="ident" id="5021065">nil</span>&nbsp;<span class="op" id="5021069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021073">return</span>&nbsp;<span class="builtintype" id="5021080">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021090">if</span>&nbsp;<span class="ident" id="5021093">host</span>&nbsp;<span class="op" id="5021098">==</span>&nbsp;<span class="string" id="5021101">&#34;localhost&#34;</span>&nbsp;<span class="op" id="5021113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021117">return</span>&nbsp;<span class="builtintype" id="5021124">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021134">if</span>&nbsp;<span class="ident" id="5021137">ip</span>&nbsp;<span class="op" id="5021140">:=</span>&nbsp;<span class="ident" id="5021143">net</span><span class="op" id="5021146">.</span><span class="ident" id="5021147">ParseIP</span><span class="op" id="5021154">(</span><span class="ident" id="5021155">host</span><span class="op" id="5021159">)</span><span class="op" id="5021160">;</span>&nbsp;<span class="ident" id="5021162">ip</span>&nbsp;<span class="op" id="5021165">!=</span>&nbsp;<span class="ident" id="5021168">nil</span>&nbsp;<span class="op" id="5021172">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021176">if</span>&nbsp;<span class="ident" id="5021179">ip</span><span class="op" id="5021181">.</span><span class="ident" id="5021182">IsLoopback</span><span class="op" id="5021192">(</span><span class="op" id="5021193">)</span>&nbsp;<span class="op" id="5021195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021200">return</span>&nbsp;<span class="builtintype" id="5021207">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021222">no_proxy</span>&nbsp;<span class="op" id="5021231">:=</span>&nbsp;<span class="ident" id="5021234">noProxyEnv</span><span class="op" id="5021244">.</span><span class="ident" id="5021245">Get</span><span class="op" id="5021248">(</span><span class="op" id="5021249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021252">if</span>&nbsp;<span class="ident" id="5021255">no_proxy</span>&nbsp;<span class="op" id="5021264">==</span>&nbsp;<span class="string" id="5021267">&#34;*&#34;</span>&nbsp;<span class="op" id="5021271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021275">return</span>&nbsp;<span class="builtintype" id="5021282">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021293">addr</span>&nbsp;<span class="op" id="5021298">=</span>&nbsp;<span class="ident" id="5021300">strings</span><span class="op" id="5021307">.</span><span class="ident" id="5021308">ToLower</span><span class="op" id="5021315">(</span><span class="ident" id="5021316">strings</span><span class="op" id="5021323">.</span><span class="ident" id="5021324">TrimSpace</span><span class="op" id="5021333">(</span><span class="ident" id="5021334">addr</span><span class="op" id="5021338">)</span><span class="op" id="5021339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021342">if</span>&nbsp;<span class="ident" id="5021345">hasPort</span><span class="op" id="5021352">(</span><span class="ident" id="5021353">addr</span><span class="op" id="5021357">)</span>&nbsp;<span class="op" id="5021359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021363">addr</span>&nbsp;<span class="op" id="5021368">=</span>&nbsp;<span class="ident" id="5021370">addr</span><span class="op" id="5021374">[</span><span class="op" id="5021375">:</span><span class="ident" id="5021376">strings</span><span class="op" id="5021383">.</span><span class="ident" id="5021384">LastIndex</span><span class="op" id="5021393">(</span><span class="ident" id="5021394">addr</span><span class="op" id="5021398">,</span>&nbsp;<span class="string" id="5021400">&#34;:&#34;</span><span class="op" id="5021403">)</span><span class="op" id="5021404">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021411">for</span>&nbsp;<span class="ident" id="5021415">_</span><span class="op" id="5021416">,</span>&nbsp;<span class="ident" id="5021418">p</span>&nbsp;<span class="op" id="5021420">:=</span>&nbsp;<span class="keyword" id="5021423">range</span>&nbsp;<span class="ident" id="5021429">strings</span><span class="op" id="5021436">.</span><span class="ident" id="5021437">Split</span><span class="op" id="5021442">(</span><span class="ident" id="5021443">no_proxy</span><span class="op" id="5021451">,</span>&nbsp;<span class="string" id="5021453">&#34;,&#34;</span><span class="op" id="5021456">)</span>&nbsp;<span class="op" id="5021458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021462">p</span>&nbsp;<span class="op" id="5021464">=</span>&nbsp;<span class="ident" id="5021466">strings</span><span class="op" id="5021473">.</span><span class="ident" id="5021474">ToLower</span><span class="op" id="5021481">(</span><span class="ident" id="5021482">strings</span><span class="op" id="5021489">.</span><span class="ident" id="5021490">TrimSpace</span><span class="op" id="5021499">(</span><span class="ident" id="5021500">p</span><span class="op" id="5021501">)</span><span class="op" id="5021502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021506">if</span>&nbsp;<span class="builtinfunc" id="5021509">len</span><span class="op" id="5021512">(</span><span class="ident" id="5021513">p</span><span class="op" id="5021514">)</span>&nbsp;<span class="op" id="5021516">==</span>&nbsp;<span class="num" id="5021519">0</span>&nbsp;<span class="op" id="5021521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021526">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021537">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021541">if</span>&nbsp;<span class="ident" id="5021544">hasPort</span><span class="op" id="5021551">(</span><span class="ident" id="5021552">p</span><span class="op" id="5021553">)</span>&nbsp;<span class="op" id="5021555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5021560">p</span>&nbsp;<span class="op" id="5021562">=</span>&nbsp;<span class="ident" id="5021564">p</span><span class="op" id="5021565">[</span><span class="op" id="5021566">:</span><span class="ident" id="5021567">strings</span><span class="op" id="5021574">.</span><span class="ident" id="5021575">LastIndex</span><span class="op" id="5021584">(</span><span class="ident" id="5021585">p</span><span class="op" id="5021586">,</span>&nbsp;<span class="string" id="5021588">&#34;:&#34;</span><span class="op" id="5021591">)</span><span class="op" id="5021592">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021600">if</span>&nbsp;<span class="ident" id="5021603">addr</span>&nbsp;<span class="op" id="5021608">==</span>&nbsp;<span class="ident" id="5021611">p</span>&nbsp;<span class="op" id="5021613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021618">return</span>&nbsp;<span class="builtintype" id="5021625">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021637">if</span>&nbsp;<span class="ident" id="5021640">p</span><span class="op" id="5021641">[</span><span class="num" id="5021642">0</span><span class="op" id="5021643">]</span>&nbsp;<span class="op" id="5021645">==</span>&nbsp;<span class="string" id="5021648">&#39;.&#39;</span>&nbsp;<span class="op" id="5021652">&amp;&amp;</span>&nbsp;<span class="op" id="5021655">(</span><span class="ident" id="5021656">strings</span><span class="op" id="5021663">.</span><span class="ident" id="5021664">HasSuffix</span><span class="op" id="5021673">(</span><span class="ident" id="5021674">addr</span><span class="op" id="5021678">,</span>&nbsp;<span class="ident" id="5021680">p</span><span class="op" id="5021681">)</span>&nbsp;<span class="op" id="5021683">||</span>&nbsp;<span class="ident" id="5021686">addr</span>&nbsp;<span class="op" id="5021691">==</span>&nbsp;<span class="ident" id="5021694">p</span><span class="op" id="5021695">[</span><span class="num" id="5021696">1</span><span class="op" id="5021697">:</span><span class="op" id="5021698">]</span><span class="op" id="5021699">)</span>&nbsp;<span class="op" id="5021701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5021706">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021767">return</span>&nbsp;<span class="builtintype" id="5021774">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021782">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021786">if</span>&nbsp;<span class="ident" id="5021789">p</span><span class="op" id="5021790">[</span><span class="num" id="5021791">0</span><span class="op" id="5021792">]</span>&nbsp;<span class="op" id="5021794">!=</span>&nbsp;<span class="string" id="5021797">&#39;.&#39;</span>&nbsp;<span class="op" id="5021801">&amp;&amp;</span>&nbsp;<span class="ident" id="5021804">strings</span><span class="op" id="5021811">.</span><span class="ident" id="5021812">HasSuffix</span><span class="op" id="5021821">(</span><span class="ident" id="5021822">addr</span><span class="op" id="5021826">,</span>&nbsp;<span class="ident" id="5021828">p</span><span class="op" id="5021829">)</span>&nbsp;<span class="op" id="5021831">&amp;&amp;</span>&nbsp;<span class="ident" id="5021834">addr</span><span class="op" id="5021838">[</span><span class="builtinfunc" id="5021839">len</span><span class="op" id="5021842">(</span><span class="ident" id="5021843">addr</span><span class="op" id="5021847">)</span><span class="op" id="5021848">-</span><span class="builtinfunc" id="5021849">len</span><span class="op" id="5021852">(</span><span class="ident" id="5021853">p</span><span class="op" id="5021854">)</span><span class="op" id="5021855">-</span><span class="num" id="5021856">1</span><span class="op" id="5021857">]</span>&nbsp;<span class="op" id="5021859">==</span>&nbsp;<span class="string" id="5021862">&#39;.&#39;</span>&nbsp;<span class="op" id="5021866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5021871">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021918">return</span>&nbsp;<span class="builtintype" id="5021925">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5021936">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5021939">return</span>&nbsp;<span class="builtintype" id="5021946">true</span><br>
<span class="lineno"></span><span class="op" id="5021951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5021954">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="5022030">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="5022085">//</span><br>
<span class="lineno"></span><span class="comment" id="5022088">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="5022139">//</span><br>
<span class="lineno"></span><span class="comment" id="5022142">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="5022187">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="5022246">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="5022313">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="5022381">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="5022455">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5022533">//</span><br>
<span class="lineno">730</span><span class="comment" id="5022536">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="5022583">//</span><br>
<span class="lineno"></span><span class="keyword" id="5022586">type</span>&nbsp;<span class="ident" id="5022591">connectMethod</span>&nbsp;<span class="keyword" id="5022605">struct</span>&nbsp;<span class="op" id="5022612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5022615">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5022628">*</span><span class="ident" id="5022629">url</span><span class="op" id="5022632">.</span><span class="ident" id="5022633">URL</span>&nbsp;<span class="comment" id="5022637">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5022679">targetScheme</span>&nbsp;<span class="builtintype" id="5022692">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5022701">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5022723">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5022736">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5022745">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="5022809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5022812">func</span>&nbsp;<span class="op" id="5022817">(</span><span class="ident" id="5022818">cm</span>&nbsp;<span class="op" id="5022821">*</span><span class="ident" id="5022822">connectMethod</span><span class="op" id="5022835">)</span>&nbsp;<span class="ident" id="5022837">key</span><span class="op" id="5022840">(</span><span class="op" id="5022841">)</span>&nbsp;<span class="ident" id="5022843">connectMethodKey</span>&nbsp;<span class="op" id="5022860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5022863">proxyStr</span>&nbsp;<span class="op" id="5022872">:=</span>&nbsp;<span class="string" id="5022875">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5022879">targetAddr</span>&nbsp;<span class="op" id="5022890">:=</span>&nbsp;<span class="ident" id="5022893">cm</span><span class="op" id="5022895">.</span><span class="ident" id="5022896">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022908">if</span>&nbsp;<span class="ident" id="5022911">cm</span><span class="op" id="5022913">.</span><span class="ident" id="5022914">proxyURL</span>&nbsp;<span class="op" id="5022923">!=</span>&nbsp;<span class="ident" id="5022926">nil</span>&nbsp;<span class="op" id="5022930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5022934">proxyStr</span>&nbsp;<span class="op" id="5022943">=</span>&nbsp;<span class="ident" id="5022945">cm</span><span class="op" id="5022947">.</span><span class="ident" id="5022948">proxyURL</span><span class="op" id="5022956">.</span><span class="ident" id="5022957">String</span><span class="op" id="5022963">(</span><span class="op" id="5022964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5022968">if</span>&nbsp;<span class="ident" id="5022971">cm</span><span class="op" id="5022973">.</span><span class="ident" id="5022974">targetScheme</span>&nbsp;<span class="op" id="5022987">==</span>&nbsp;<span class="string" id="5022990">&#34;http&#34;</span>&nbsp;<span class="op" id="5022997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023002">targetAddr</span>&nbsp;<span class="op" id="5023013">=</span>&nbsp;<span class="string" id="5023015">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5023020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5023023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023026">return</span>&nbsp;<span class="ident" id="5023033">connectMethodKey</span><span class="op" id="5023049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023053">proxy</span><span class="op" id="5023058">:</span>&nbsp;&nbsp;<span class="ident" id="5023061">proxyStr</span><span class="op" id="5023069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023073">scheme</span><span class="op" id="5023079">:</span>&nbsp;<span class="ident" id="5023081">cm</span><span class="op" id="5023083">.</span><span class="ident" id="5023084">targetScheme</span><span class="op" id="5023096">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023100">addr</span><span class="op" id="5023104">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5023108">targetAddr</span><span class="op" id="5023118">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5023121">}</span><br>
<span class="lineno"></span><span class="op" id="5023123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5023126">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="5023201">func</span>&nbsp;<span class="op" id="5023206">(</span><span class="ident" id="5023207">cm</span>&nbsp;<span class="op" id="5023210">*</span><span class="ident" id="5023211">connectMethod</span><span class="op" id="5023224">)</span>&nbsp;<span class="ident" id="5023226">addr</span><span class="op" id="5023230">(</span><span class="op" id="5023231">)</span>&nbsp;<span class="builtintype" id="5023233">string</span>&nbsp;<span class="op" id="5023240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023243">if</span>&nbsp;<span class="ident" id="5023246">cm</span><span class="op" id="5023248">.</span><span class="ident" id="5023249">proxyURL</span>&nbsp;<span class="op" id="5023258">!=</span>&nbsp;<span class="ident" id="5023261">nil</span>&nbsp;<span class="op" id="5023265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023269">return</span>&nbsp;<span class="ident" id="5023276">canonicalAddr</span><span class="op" id="5023289">(</span><span class="ident" id="5023290">cm</span><span class="op" id="5023292">.</span><span class="ident" id="5023293">proxyURL</span><span class="op" id="5023301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5023304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023307">return</span>&nbsp;<span class="ident" id="5023314">cm</span><span class="op" id="5023316">.</span><span class="ident" id="5023317">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="5023328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5023331">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5023392">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="5023412">func</span>&nbsp;<span class="op" id="5023417">(</span><span class="ident" id="5023418">cm</span>&nbsp;<span class="op" id="5023421">*</span><span class="ident" id="5023422">connectMethod</span><span class="op" id="5023435">)</span>&nbsp;<span class="ident" id="5023437">tlsHost</span><span class="op" id="5023444">(</span><span class="op" id="5023445">)</span>&nbsp;<span class="builtintype" id="5023447">string</span>&nbsp;<span class="op" id="5023454">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023457">h</span>&nbsp;<span class="op" id="5023459">:=</span>&nbsp;<span class="ident" id="5023462">cm</span><span class="op" id="5023464">.</span><span class="ident" id="5023465">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023477">if</span>&nbsp;<span class="ident" id="5023480">hasPort</span><span class="op" id="5023487">(</span><span class="ident" id="5023488">h</span><span class="op" id="5023489">)</span>&nbsp;<span class="op" id="5023491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023495">h</span>&nbsp;<span class="op" id="5023497">=</span>&nbsp;<span class="ident" id="5023499">h</span><span class="op" id="5023500">[</span><span class="op" id="5023501">:</span><span class="ident" id="5023502">strings</span><span class="op" id="5023509">.</span><span class="ident" id="5023510">LastIndex</span><span class="op" id="5023519">(</span><span class="ident" id="5023520">h</span><span class="op" id="5023521">,</span>&nbsp;<span class="string" id="5023523">&#34;:&#34;</span><span class="op" id="5023526">)</span><span class="op" id="5023527">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5023530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023533">return</span>&nbsp;<span class="ident" id="5023540">h</span><br>
<span class="lineno">770</span><span class="op" id="5023542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5023545">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5023613">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5023684">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="5023694">type</span>&nbsp;<span class="ident" id="5023699">connectMethodKey</span>&nbsp;<span class="keyword" id="5023716">struct</span>&nbsp;<span class="op" id="5023723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5023726">proxy</span><span class="op" id="5023731">,</span>&nbsp;<span class="ident" id="5023733">scheme</span><span class="op" id="5023739">,</span>&nbsp;<span class="ident" id="5023741">addr</span>&nbsp;<span class="builtintype" id="5023746">string</span><br>
<span class="lineno"></span><span class="op" id="5023753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5023756">func</span>&nbsp;<span class="op" id="5023761">(</span><span class="ident" id="5023762">k</span>&nbsp;<span class="ident" id="5023764">connectMethodKey</span><span class="op" id="5023780">)</span>&nbsp;<span class="ident" id="5023782">String</span><span class="op" id="5023788">(</span><span class="op" id="5023789">)</span>&nbsp;<span class="builtintype" id="5023791">string</span>&nbsp;<span class="op" id="5023798">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5023801">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5023825">return</span>&nbsp;<span class="ident" id="5023832">fmt</span><span class="op" id="5023835">.</span><span class="ident" id="5023836">Sprintf</span><span class="op" id="5023843">(</span><span class="string" id="5023844">&#34;%s|%s|%s&#34;</span><span class="op" id="5023854">,</span>&nbsp;<span class="ident" id="5023856">k</span><span class="op" id="5023857">.</span><span class="ident" id="5023858">proxy</span><span class="op" id="5023863">,</span>&nbsp;<span class="ident" id="5023865">k</span><span class="op" id="5023866">.</span><span class="ident" id="5023867">scheme</span><span class="op" id="5023873">,</span>&nbsp;<span class="ident" id="5023875">k</span><span class="op" id="5023876">.</span><span class="ident" id="5023877">addr</span><span class="op" id="5023881">)</span><br>
<span class="lineno"></span><span class="op" id="5023883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5023886">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="5023946">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="5024003">type</span>&nbsp;<span class="ident" id="5024008">persistConn</span>&nbsp;<span class="keyword" id="5024020">struct</span>&nbsp;<span class="op" id="5024027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024030">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5024039">*</span><span class="ident" id="5024040">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024051">cacheKey</span>&nbsp;<span class="ident" id="5024060">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024078">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024087">net</span><span class="op" id="5024090">.</span><span class="ident" id="5024091">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024097">tlsState</span>&nbsp;<span class="op" id="5024106">*</span><span class="ident" id="5024107">tls</span><span class="op" id="5024110">.</span><span class="ident" id="5024111">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024128">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5024137">*</span><span class="ident" id="5024138">bufio</span><span class="op" id="5024143">.</span><span class="ident" id="5024144">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5024157">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024171">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5024180">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5024200">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024256">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5024265">*</span><span class="ident" id="5024266">bufio</span><span class="op" id="5024271">.</span><span class="ident" id="5024272">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5024285">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024297">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5024306">chan</span>&nbsp;<span class="ident" id="5024311">requestAndChan</span>&nbsp;<span class="comment" id="5024326">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024369">writech</span>&nbsp;&nbsp;<span class="keyword" id="5024378">chan</span>&nbsp;<span class="ident" id="5024383">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5024398">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024442">closech</span>&nbsp;&nbsp;<span class="keyword" id="5024451">chan</span>&nbsp;<span class="keyword" id="5024456">struct</span><span class="op" id="5024462">{</span><span class="op" id="5024463">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5024471">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024499">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="5024508">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5024514">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5024574">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5024636">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5024700">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024759">writeErrCh</span>&nbsp;<span class="keyword" id="5024770">chan</span>&nbsp;<span class="builtintype" id="5024775">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024783">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5024804">sync</span><span class="op" id="5024808">.</span><span class="ident" id="5024809">Mutex</span>&nbsp;<span class="comment" id="5024815">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024843">numExpectedResponses</span>&nbsp;<span class="builtintype" id="5024864">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024869">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5024890">bool</span>&nbsp;<span class="comment" id="5024895">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5024928">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5024949">bool</span>&nbsp;<span class="comment" id="5024954">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5025034">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5025091">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5025154">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025211">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="5025228">func</span><span class="op" id="5025232">(</span><span class="ident" id="5025233">Header</span><span class="op" id="5025239">)</span><br>
<span class="lineno"></span><span class="op" id="5025241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5025244">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="5025316">func</span>&nbsp;<span class="op" id="5025321">(</span><span class="ident" id="5025322">pc</span>&nbsp;<span class="op" id="5025325">*</span><span class="ident" id="5025326">persistConn</span><span class="op" id="5025337">)</span>&nbsp;<span class="ident" id="5025339">isBroken</span><span class="op" id="5025347">(</span><span class="op" id="5025348">)</span>&nbsp;<span class="builtintype" id="5025350">bool</span>&nbsp;<span class="op" id="5025355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025358">pc</span><span class="op" id="5025360">.</span><span class="ident" id="5025361">lk</span><span class="op" id="5025363">.</span><span class="ident" id="5025364">Lock</span><span class="op" id="5025368">(</span><span class="op" id="5025369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025372">b</span>&nbsp;<span class="op" id="5025374">:=</span>&nbsp;<span class="ident" id="5025377">pc</span><span class="op" id="5025379">.</span><span class="ident" id="5025380">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025388">pc</span><span class="op" id="5025390">.</span><span class="ident" id="5025391">lk</span><span class="op" id="5025393">.</span><span class="ident" id="5025394">Unlock</span><span class="op" id="5025400">(</span><span class="op" id="5025401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025404">return</span>&nbsp;<span class="ident" id="5025411">b</span><br>
<span class="lineno">820</span><span class="op" id="5025413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5025416">func</span>&nbsp;<span class="op" id="5025421">(</span><span class="ident" id="5025422">pc</span>&nbsp;<span class="op" id="5025425">*</span><span class="ident" id="5025426">persistConn</span><span class="op" id="5025437">)</span>&nbsp;<span class="ident" id="5025439">cancelRequest</span><span class="op" id="5025452">(</span><span class="op" id="5025453">)</span>&nbsp;<span class="op" id="5025455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025458">pc</span><span class="op" id="5025460">.</span><span class="ident" id="5025461">conn</span><span class="op" id="5025465">.</span><span class="ident" id="5025466">Close</span><span class="op" id="5025471">(</span><span class="op" id="5025472">)</span><br>
<span class="lineno"></span><span class="op" id="5025474">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="5025477">var</span>&nbsp;<span class="ident" id="5025481">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="5025502">func</span><span class="op" id="5025506">(</span><span class="builtintype" id="5025507">error</span><span class="op" id="5025512">)</span>&nbsp;<span class="builtintype" id="5025514">bool</span>&nbsp;<span class="comment" id="5025519">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5025545">func</span>&nbsp;<span class="ident" id="5025550">remoteSideClosed</span><span class="op" id="5025566">(</span><span class="ident" id="5025567">err</span>&nbsp;<span class="builtintype" id="5025571">error</span><span class="op" id="5025576">)</span>&nbsp;<span class="builtintype" id="5025578">bool</span>&nbsp;<span class="op" id="5025583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025586">if</span>&nbsp;<span class="ident" id="5025589">err</span>&nbsp;<span class="op" id="5025593">==</span>&nbsp;<span class="ident" id="5025596">io</span><span class="op" id="5025598">.</span><span class="ident" id="5025599">EOF</span>&nbsp;<span class="op" id="5025603">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025607">return</span>&nbsp;<span class="builtintype" id="5025614">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5025620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025623">if</span>&nbsp;<span class="ident" id="5025626">remoteSideClosedFunc</span>&nbsp;<span class="op" id="5025647">!=</span>&nbsp;<span class="ident" id="5025650">nil</span>&nbsp;<span class="op" id="5025654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025658">return</span>&nbsp;<span class="ident" id="5025665">remoteSideClosedFunc</span><span class="op" id="5025685">(</span><span class="ident" id="5025686">err</span><span class="op" id="5025689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5025692">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025695">return</span>&nbsp;<span class="builtintype" id="5025702">false</span><br>
<span class="lineno"></span><span class="op" id="5025708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5025711">func</span>&nbsp;<span class="op" id="5025716">(</span><span class="ident" id="5025717">pc</span>&nbsp;<span class="op" id="5025720">*</span><span class="ident" id="5025721">persistConn</span><span class="op" id="5025732">)</span>&nbsp;<span class="ident" id="5025734">readLoop</span><span class="op" id="5025742">(</span><span class="op" id="5025743">)</span>&nbsp;<span class="op" id="5025745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025748">alive</span>&nbsp;<span class="op" id="5025754">:=</span>&nbsp;<span class="builtintype" id="5025757">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025764">for</span>&nbsp;<span class="ident" id="5025768">alive</span>&nbsp;<span class="op" id="5025774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025778">pb</span><span class="op" id="5025780">,</span>&nbsp;<span class="ident" id="5025782">err</span>&nbsp;<span class="op" id="5025786">:=</span>&nbsp;<span class="ident" id="5025789">pc</span><span class="op" id="5025791">.</span><span class="ident" id="5025792">br</span><span class="op" id="5025794">.</span><span class="ident" id="5025795">Peek</span><span class="op" id="5025799">(</span><span class="num" id="5025800">1</span><span class="op" id="5025801">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025806">pc</span><span class="op" id="5025808">.</span><span class="ident" id="5025809">lk</span><span class="op" id="5025811">.</span><span class="ident" id="5025812">Lock</span><span class="op" id="5025816">(</span><span class="op" id="5025817">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025821">if</span>&nbsp;<span class="ident" id="5025824">pc</span><span class="op" id="5025826">.</span><span class="ident" id="5025827">numExpectedResponses</span>&nbsp;<span class="op" id="5025848">==</span>&nbsp;<span class="num" id="5025851">0</span>&nbsp;<span class="op" id="5025853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025858">if</span>&nbsp;<span class="op" id="5025861">!</span><span class="ident" id="5025862">pc</span><span class="op" id="5025864">.</span><span class="ident" id="5025865">closed</span>&nbsp;<span class="op" id="5025872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025878">pc</span><span class="op" id="5025880">.</span><span class="ident" id="5025881">closeLocked</span><span class="op" id="5025892">(</span><span class="op" id="5025893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5025899">if</span>&nbsp;<span class="builtinfunc" id="5025902">len</span><span class="op" id="5025905">(</span><span class="ident" id="5025906">pb</span><span class="op" id="5025908">)</span>&nbsp;<span class="op" id="5025910">&gt;</span>&nbsp;<span class="num" id="5025912">0</span>&nbsp;<span class="op" id="5025914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5025921">log</span><span class="op" id="5025924">.</span><span class="ident" id="5025925">Printf</span><span class="op" id="5025931">(</span><span class="string" id="5025932">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="5026009">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5026017">string</span><span class="op" id="5026023">(</span><span class="ident" id="5026024">pb</span><span class="op" id="5026026">)</span><span class="op" id="5026027">,</span>&nbsp;<span class="ident" id="5026029">err</span><span class="op" id="5026032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026048">pc</span><span class="op" id="5026050">.</span><span class="ident" id="5026051">lk</span><span class="op" id="5026053">.</span><span class="ident" id="5026054">Unlock</span><span class="op" id="5026060">(</span><span class="op" id="5026061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026066">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026079">pc</span><span class="op" id="5026081">.</span><span class="ident" id="5026082">lk</span><span class="op" id="5026084">.</span><span class="ident" id="5026085">Unlock</span><span class="op" id="5026091">(</span><span class="op" id="5026092">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026097">rc</span>&nbsp;<span class="op" id="5026100">:=</span>&nbsp;<span class="op" id="5026103">&lt;-</span><span class="ident" id="5026105">pc</span><span class="op" id="5026107">.</span><span class="ident" id="5026108">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026117">var</span>&nbsp;<span class="ident" id="5026121">resp</span>&nbsp;<span class="op" id="5026126">*</span><span class="ident" id="5026127">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026138">if</span>&nbsp;<span class="ident" id="5026141">err</span>&nbsp;<span class="op" id="5026145">==</span>&nbsp;<span class="ident" id="5026148">nil</span>&nbsp;<span class="op" id="5026152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026157">resp</span><span class="op" id="5026161">,</span>&nbsp;<span class="ident" id="5026163">err</span>&nbsp;<span class="op" id="5026167">=</span>&nbsp;<span class="ident" id="5026169">ReadResponse</span><span class="op" id="5026181">(</span><span class="ident" id="5026182">pc</span><span class="op" id="5026184">.</span><span class="ident" id="5026185">br</span><span class="op" id="5026187">,</span>&nbsp;<span class="ident" id="5026189">rc</span><span class="op" id="5026191">.</span><span class="ident" id="5026192">req</span><span class="op" id="5026195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026200">if</span>&nbsp;<span class="ident" id="5026203">err</span>&nbsp;<span class="op" id="5026207">==</span>&nbsp;<span class="ident" id="5026210">nil</span>&nbsp;<span class="op" id="5026214">&amp;&amp;</span>&nbsp;<span class="ident" id="5026217">resp</span><span class="op" id="5026221">.</span><span class="ident" id="5026222">StatusCode</span>&nbsp;<span class="op" id="5026233">==</span>&nbsp;<span class="num" id="5026236">100</span>&nbsp;<span class="op" id="5026240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5026246">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5026284">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5026345">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5026405">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5026471">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026519">resp</span><span class="op" id="5026523">,</span>&nbsp;<span class="ident" id="5026525">err</span>&nbsp;<span class="op" id="5026529">=</span>&nbsp;<span class="ident" id="5026531">ReadResponse</span><span class="op" id="5026543">(</span><span class="ident" id="5026544">pc</span><span class="op" id="5026546">.</span><span class="ident" id="5026547">br</span><span class="op" id="5026549">,</span>&nbsp;<span class="ident" id="5026551">rc</span><span class="op" id="5026553">.</span><span class="ident" id="5026554">req</span><span class="op" id="5026557">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026571">if</span>&nbsp;<span class="ident" id="5026574">resp</span>&nbsp;<span class="op" id="5026579">!=</span>&nbsp;<span class="ident" id="5026582">nil</span>&nbsp;<span class="op" id="5026586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026591">resp</span><span class="op" id="5026595">.</span><span class="ident" id="5026596">TLS</span>&nbsp;<span class="op" id="5026600">=</span>&nbsp;<span class="ident" id="5026602">pc</span><span class="op" id="5026604">.</span><span class="ident" id="5026605">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026621">hasBody</span>&nbsp;<span class="op" id="5026629">:=</span>&nbsp;<span class="ident" id="5026632">resp</span>&nbsp;<span class="op" id="5026637">!=</span>&nbsp;<span class="ident" id="5026640">nil</span>&nbsp;<span class="op" id="5026644">&amp;&amp;</span>&nbsp;<span class="ident" id="5026647">rc</span><span class="op" id="5026649">.</span><span class="ident" id="5026650">req</span><span class="op" id="5026653">.</span><span class="ident" id="5026654">Method</span>&nbsp;<span class="op" id="5026661">!=</span>&nbsp;<span class="string" id="5026664">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="5026671">&amp;&amp;</span>&nbsp;<span class="ident" id="5026674">resp</span><span class="op" id="5026678">.</span><span class="ident" id="5026679">ContentLength</span>&nbsp;<span class="op" id="5026693">!=</span>&nbsp;<span class="num" id="5026696">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026701">if</span>&nbsp;<span class="ident" id="5026704">err</span>&nbsp;<span class="op" id="5026708">!=</span>&nbsp;<span class="ident" id="5026711">nil</span>&nbsp;<span class="op" id="5026715">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026720">pc</span><span class="op" id="5026722">.</span><span class="builtinfunc" id="5026723">close</span><span class="op" id="5026728">(</span><span class="op" id="5026729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026733">}</span>&nbsp;<span class="keyword" id="5026735">else</span>&nbsp;<span class="op" id="5026740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5026745">if</span>&nbsp;<span class="ident" id="5026748">rc</span><span class="op" id="5026750">.</span><span class="ident" id="5026751">addedGzip</span>&nbsp;<span class="op" id="5026761">&amp;&amp;</span>&nbsp;<span class="ident" id="5026764">hasBody</span>&nbsp;<span class="op" id="5026772">&amp;&amp;</span>&nbsp;<span class="ident" id="5026775">resp</span><span class="op" id="5026779">.</span><span class="ident" id="5026780">Header</span><span class="op" id="5026786">.</span><span class="ident" id="5026787">Get</span><span class="op" id="5026790">(</span><span class="string" id="5026791">&#34;Content-Encoding&#34;</span><span class="op" id="5026809">)</span>&nbsp;<span class="op" id="5026811">==</span>&nbsp;<span class="string" id="5026814">&#34;gzip&#34;</span>&nbsp;<span class="op" id="5026821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026827">resp</span><span class="op" id="5026831">.</span><span class="ident" id="5026832">Header</span><span class="op" id="5026838">.</span><span class="ident" id="5026839">Del</span><span class="op" id="5026842">(</span><span class="string" id="5026843">&#34;Content-Encoding&#34;</span><span class="op" id="5026861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026867">resp</span><span class="op" id="5026871">.</span><span class="ident" id="5026872">Header</span><span class="op" id="5026878">.</span><span class="ident" id="5026879">Del</span><span class="op" id="5026882">(</span><span class="string" id="5026883">&#34;Content-Length&#34;</span><span class="op" id="5026899">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026905">resp</span><span class="op" id="5026909">.</span><span class="ident" id="5026910">ContentLength</span>&nbsp;<span class="op" id="5026924">=</span>&nbsp;<span class="op" id="5026926">-</span><span class="num" id="5026927">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026933">resp</span><span class="op" id="5026937">.</span><span class="ident" id="5026938">Body</span>&nbsp;<span class="op" id="5026943">=</span>&nbsp;<span class="op" id="5026945">&amp;</span><span class="ident" id="5026946">gzipReader</span><span class="op" id="5026956">{</span><span class="ident" id="5026957">body</span><span class="op" id="5026961">:</span>&nbsp;<span class="ident" id="5026963">resp</span><span class="op" id="5026967">.</span><span class="ident" id="5026968">Body</span><span class="op" id="5026972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5026977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5026982">resp</span><span class="op" id="5026986">.</span><span class="ident" id="5026987">Body</span>&nbsp;<span class="op" id="5026992">=</span>&nbsp;<span class="op" id="5026994">&amp;</span><span class="ident" id="5026995">bodyEOFSignal</span><span class="op" id="5027008">{</span><span class="ident" id="5027009">body</span><span class="op" id="5027013">:</span>&nbsp;<span class="ident" id="5027015">resp</span><span class="op" id="5027019">.</span><span class="ident" id="5027020">Body</span><span class="op" id="5027024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027028">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027033">if</span>&nbsp;<span class="ident" id="5027036">err</span>&nbsp;<span class="op" id="5027040">!=</span>&nbsp;<span class="ident" id="5027043">nil</span>&nbsp;<span class="op" id="5027047">||</span>&nbsp;<span class="ident" id="5027050">resp</span><span class="op" id="5027054">.</span><span class="ident" id="5027055">Close</span>&nbsp;<span class="op" id="5027061">||</span>&nbsp;<span class="ident" id="5027064">rc</span><span class="op" id="5027066">.</span><span class="ident" id="5027067">req</span><span class="op" id="5027070">.</span><span class="ident" id="5027071">Close</span>&nbsp;<span class="op" id="5027077">||</span>&nbsp;<span class="ident" id="5027080">resp</span><span class="op" id="5027084">.</span><span class="ident" id="5027085">StatusCode</span>&nbsp;<span class="op" id="5027096">&lt;=</span>&nbsp;<span class="num" id="5027099">199</span>&nbsp;<span class="op" id="5027103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5027108">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5027177">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5027237">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027284">alive</span>&nbsp;<span class="op" id="5027290">=</span>&nbsp;<span class="builtintype" id="5027292">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027305">var</span>&nbsp;<span class="ident" id="5027309">waitForBodyRead</span>&nbsp;<span class="keyword" id="5027325">chan</span>&nbsp;<span class="builtintype" id="5027330">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027337">if</span>&nbsp;<span class="ident" id="5027340">hasBody</span>&nbsp;<span class="op" id="5027348">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027353">waitForBodyRead</span>&nbsp;<span class="op" id="5027369">=</span>&nbsp;<span class="builtinfunc" id="5027371">make</span><span class="op" id="5027375">(</span><span class="keyword" id="5027376">chan</span>&nbsp;<span class="builtintype" id="5027381">bool</span><span class="op" id="5027385">,</span>&nbsp;<span class="num" id="5027387">2</span><span class="op" id="5027388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027393">resp</span><span class="op" id="5027397">.</span><span class="ident" id="5027398">Body</span><span class="op" id="5027402">.</span><span class="op" id="5027403">(</span><span class="op" id="5027404">*</span><span class="ident" id="5027405">bodyEOFSignal</span><span class="op" id="5027418">)</span><span class="op" id="5027419">.</span><span class="ident" id="5027420">earlyCloseFn</span>&nbsp;<span class="op" id="5027433">=</span>&nbsp;<span class="keyword" id="5027435">func</span><span class="op" id="5027439">(</span><span class="op" id="5027440">)</span>&nbsp;<span class="builtintype" id="5027442">error</span>&nbsp;<span class="op" id="5027448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5027454">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5027494">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5027533">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027547">waitForBodyRead</span>&nbsp;<span class="op" id="5027563">&lt;-</span>&nbsp;<span class="builtintype" id="5027566">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027576">return</span>&nbsp;<span class="ident" id="5027583">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027595">resp</span><span class="op" id="5027599">.</span><span class="ident" id="5027600">Body</span><span class="op" id="5027604">.</span><span class="op" id="5027605">(</span><span class="op" id="5027606">*</span><span class="ident" id="5027607">bodyEOFSignal</span><span class="op" id="5027620">)</span><span class="op" id="5027621">.</span><span class="ident" id="5027622">fn</span>&nbsp;<span class="op" id="5027625">=</span>&nbsp;<span class="keyword" id="5027627">func</span><span class="op" id="5027631">(</span><span class="ident" id="5027632">err</span>&nbsp;<span class="builtintype" id="5027636">error</span><span class="op" id="5027641">)</span>&nbsp;<span class="op" id="5027643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027649">waitForBodyRead</span>&nbsp;<span class="op" id="5027665">&lt;-</span>&nbsp;<span class="ident" id="5027668">alive</span>&nbsp;<span class="op" id="5027674">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027682">err</span>&nbsp;<span class="op" id="5027686">==</span>&nbsp;<span class="ident" id="5027689">nil</span>&nbsp;<span class="op" id="5027693">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027701">!</span><span class="ident" id="5027702">pc</span><span class="op" id="5027704">.</span><span class="ident" id="5027705">sawEOF</span>&nbsp;<span class="op" id="5027712">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027720">pc</span><span class="op" id="5027722">.</span><span class="ident" id="5027723">wroteRequest</span><span class="op" id="5027735">(</span><span class="op" id="5027736">)</span>&nbsp;<span class="op" id="5027738">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027746">pc</span><span class="op" id="5027748">.</span><span class="ident" id="5027749">t</span><span class="op" id="5027750">.</span><span class="ident" id="5027751">putIdleConn</span><span class="op" id="5027762">(</span><span class="ident" id="5027763">pc</span><span class="op" id="5027765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027770">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5027779">if</span>&nbsp;<span class="ident" id="5027782">alive</span>&nbsp;<span class="op" id="5027788">&amp;&amp;</span>&nbsp;<span class="op" id="5027791">!</span><span class="ident" id="5027792">hasBody</span>&nbsp;<span class="op" id="5027800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027805">alive</span>&nbsp;<span class="op" id="5027811">=</span>&nbsp;<span class="op" id="5027813">!</span><span class="ident" id="5027814">pc</span><span class="op" id="5027816">.</span><span class="ident" id="5027817">sawEOF</span>&nbsp;<span class="op" id="5027824">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027831">pc</span><span class="op" id="5027833">.</span><span class="ident" id="5027834">wroteRequest</span><span class="op" id="5027846">(</span><span class="op" id="5027847">)</span>&nbsp;<span class="op" id="5027849">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027856">pc</span><span class="op" id="5027858">.</span><span class="ident" id="5027859">t</span><span class="op" id="5027860">.</span><span class="ident" id="5027861">putIdleConn</span><span class="op" id="5027872">(</span><span class="ident" id="5027873">pc</span><span class="op" id="5027875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5027879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5027884">rc</span><span class="op" id="5027886">.</span><span class="ident" id="5027887">ch</span>&nbsp;<span class="op" id="5027890">&lt;-</span>&nbsp;<span class="ident" id="5027893">responseAndError</span><span class="op" id="5027909">{</span><span class="ident" id="5027910">resp</span><span class="op" id="5027914">,</span>&nbsp;<span class="ident" id="5027916">err</span><span class="op" id="5027919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5027924">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5027991">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028052">if</span>&nbsp;<span class="ident" id="5028055">waitForBodyRead</span>&nbsp;<span class="op" id="5028071">!=</span>&nbsp;<span class="ident" id="5028074">nil</span>&nbsp;<span class="op" id="5028078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028083">select</span>&nbsp;<span class="op" id="5028090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028095">case</span>&nbsp;<span class="ident" id="5028100">alive</span>&nbsp;<span class="op" id="5028106">=</span>&nbsp;<span class="op" id="5028108">&lt;-</span><span class="ident" id="5028110">waitForBodyRead</span><span class="op" id="5028125">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028130">case</span>&nbsp;<span class="op" id="5028135">&lt;-</span><span class="ident" id="5028137">pc</span><span class="op" id="5028139">.</span><span class="ident" id="5028140">closech</span><span class="op" id="5028147">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028153">alive</span>&nbsp;<span class="op" id="5028159">=</span>&nbsp;<span class="builtintype" id="5028161">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028179">pc</span><span class="op" id="5028181">.</span><span class="ident" id="5028182">t</span><span class="op" id="5028183">.</span><span class="ident" id="5028184">setReqCanceler</span><span class="op" id="5028198">(</span><span class="ident" id="5028199">rc</span><span class="op" id="5028201">.</span><span class="ident" id="5028202">req</span><span class="op" id="5028205">,</span>&nbsp;<span class="ident" id="5028207">nil</span><span class="op" id="5028210">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028215">if</span>&nbsp;<span class="op" id="5028218">!</span><span class="ident" id="5028219">alive</span>&nbsp;<span class="op" id="5028225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028230">pc</span><span class="op" id="5028232">.</span><span class="builtinfunc" id="5028233">close</span><span class="op" id="5028238">(</span><span class="op" id="5028239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028243">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028246">}</span><br>
<span class="lineno"></span><span class="op" id="5028248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5028251">func</span>&nbsp;<span class="op" id="5028256">(</span><span class="ident" id="5028257">pc</span>&nbsp;<span class="op" id="5028260">*</span><span class="ident" id="5028261">persistConn</span><span class="op" id="5028272">)</span>&nbsp;<span class="ident" id="5028274">writeLoop</span><span class="op" id="5028283">(</span><span class="op" id="5028284">)</span>&nbsp;<span class="op" id="5028286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028289">for</span>&nbsp;<span class="op" id="5028293">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028297">select</span>&nbsp;<span class="op" id="5028304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028308">case</span>&nbsp;<span class="ident" id="5028313">wr</span>&nbsp;<span class="op" id="5028316">:=</span>&nbsp;<span class="op" id="5028319">&lt;-</span><span class="ident" id="5028321">pc</span><span class="op" id="5028323">.</span><span class="ident" id="5028324">writech</span><span class="op" id="5028331">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028336">if</span>&nbsp;<span class="ident" id="5028339">pc</span><span class="op" id="5028341">.</span><span class="ident" id="5028342">isBroken</span><span class="op" id="5028350">(</span><span class="op" id="5028351">)</span>&nbsp;<span class="op" id="5028353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028359">wr</span><span class="op" id="5028361">.</span><span class="ident" id="5028362">ch</span>&nbsp;<span class="op" id="5028365">&lt;-</span>&nbsp;<span class="ident" id="5028368">errors</span><span class="op" id="5028374">.</span><span class="ident" id="5028375">New</span><span class="op" id="5028378">(</span><span class="string" id="5028379">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="5028432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028438">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028455">err</span>&nbsp;<span class="op" id="5028459">:=</span>&nbsp;<span class="ident" id="5028462">wr</span><span class="op" id="5028464">.</span><span class="ident" id="5028465">req</span><span class="op" id="5028468">.</span><span class="ident" id="5028469">Request</span><span class="op" id="5028476">.</span><span class="ident" id="5028477">write</span><span class="op" id="5028482">(</span><span class="ident" id="5028483">pc</span><span class="op" id="5028485">.</span><span class="ident" id="5028486">bw</span><span class="op" id="5028488">,</span>&nbsp;<span class="ident" id="5028490">pc</span><span class="op" id="5028492">.</span><span class="ident" id="5028493">isProxy</span><span class="op" id="5028500">,</span>&nbsp;<span class="ident" id="5028502">wr</span><span class="op" id="5028504">.</span><span class="ident" id="5028505">req</span><span class="op" id="5028508">.</span><span class="ident" id="5028509">extra</span><span class="op" id="5028514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028519">if</span>&nbsp;<span class="ident" id="5028522">err</span>&nbsp;<span class="op" id="5028526">==</span>&nbsp;<span class="ident" id="5028529">nil</span>&nbsp;<span class="op" id="5028533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028539">err</span>&nbsp;<span class="op" id="5028543">=</span>&nbsp;<span class="ident" id="5028545">pc</span><span class="op" id="5028547">.</span><span class="ident" id="5028548">bw</span><span class="op" id="5028550">.</span><span class="ident" id="5028551">Flush</span><span class="op" id="5028556">(</span><span class="op" id="5028557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028562">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028567">if</span>&nbsp;<span class="ident" id="5028570">err</span>&nbsp;<span class="op" id="5028574">!=</span>&nbsp;<span class="ident" id="5028577">nil</span>&nbsp;<span class="op" id="5028581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028587">pc</span><span class="op" id="5028589">.</span><span class="ident" id="5028590">markBroken</span><span class="op" id="5028600">(</span><span class="op" id="5028601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028607">wr</span><span class="op" id="5028609">.</span><span class="ident" id="5028610">req</span><span class="op" id="5028613">.</span><span class="ident" id="5028614">Request</span><span class="op" id="5028621">.</span><span class="ident" id="5028622">closeBody</span><span class="op" id="5028631">(</span><span class="op" id="5028632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028642">pc</span><span class="op" id="5028644">.</span><span class="ident" id="5028645">writeErrCh</span>&nbsp;<span class="op" id="5028656">&lt;-</span>&nbsp;<span class="ident" id="5028659">err</span>&nbsp;<span class="comment" id="5028663">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5028712">wr</span><span class="op" id="5028714">.</span><span class="ident" id="5028715">ch</span>&nbsp;<span class="op" id="5028718">&lt;-</span>&nbsp;<span class="ident" id="5028721">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5028733">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028764">case</span>&nbsp;<span class="op" id="5028769">&lt;-</span><span class="ident" id="5028771">pc</span><span class="op" id="5028773">.</span><span class="ident" id="5028774">closech</span><span class="op" id="5028781">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028786">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5028798">}</span><br>
<span class="lineno">965</span><span class="op" id="5028800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5028803">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="5028884">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="5028939">func</span>&nbsp;<span class="op" id="5028944">(</span><span class="ident" id="5028945">pc</span>&nbsp;<span class="op" id="5028948">*</span><span class="ident" id="5028949">persistConn</span><span class="op" id="5028960">)</span>&nbsp;<span class="ident" id="5028962">wroteRequest</span><span class="op" id="5028974">(</span><span class="op" id="5028975">)</span>&nbsp;<span class="builtintype" id="5028977">bool</span>&nbsp;<span class="op" id="5028982">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028985">select</span>&nbsp;<span class="op" id="5028992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5028995">case</span>&nbsp;<span class="ident" id="5029000">err</span>&nbsp;<span class="op" id="5029004">:=</span>&nbsp;<span class="op" id="5029007">&lt;-</span><span class="ident" id="5029009">pc</span><span class="op" id="5029011">.</span><span class="ident" id="5029012">writeErrCh</span><span class="op" id="5029022">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029026">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029092">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029121">return</span>&nbsp;<span class="ident" id="5029128">err</span>&nbsp;<span class="op" id="5029132">==</span>&nbsp;<span class="ident" id="5029135">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029140">default</span><span class="op" id="5029147">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029151">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029214">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029277">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029344">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029399">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029404">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029468">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029533">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029597">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029661">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029692">select</span>&nbsp;<span class="op" id="5029699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029703">case</span>&nbsp;<span class="ident" id="5029708">err</span>&nbsp;<span class="op" id="5029712">:=</span>&nbsp;<span class="op" id="5029715">&lt;-</span><span class="ident" id="5029717">pc</span><span class="op" id="5029719">.</span><span class="ident" id="5029720">writeErrCh</span><span class="op" id="5029730">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029735">return</span>&nbsp;<span class="ident" id="5029742">err</span>&nbsp;<span class="op" id="5029746">==</span>&nbsp;<span class="ident" id="5029749">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029755">case</span>&nbsp;<span class="op" id="5029760">&lt;-</span><span class="ident" id="5029762">time</span><span class="op" id="5029766">.</span><span class="ident" id="5029767">After</span><span class="op" id="5029772">(</span><span class="num" id="5029773">50</span>&nbsp;<span class="op" id="5029776">*</span>&nbsp;<span class="ident" id="5029778">time</span><span class="op" id="5029782">.</span><span class="ident" id="5029783">Millisecond</span><span class="op" id="5029794">)</span><span class="op" id="5029795">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5029800">return</span>&nbsp;<span class="builtintype" id="5029807">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5029818">}</span><br>
<span class="lineno"></span><span class="op" id="5029820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="5029823">type</span>&nbsp;<span class="ident" id="5029828">responseAndError</span>&nbsp;<span class="keyword" id="5029845">struct</span>&nbsp;<span class="op" id="5029852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029855">res</span>&nbsp;<span class="op" id="5029859">*</span><span class="ident" id="5029860">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029870">err</span>&nbsp;<span class="builtintype" id="5029874">error</span><br>
<span class="lineno"></span><span class="op" id="5029880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="5029883">type</span>&nbsp;<span class="ident" id="5029888">requestAndChan</span>&nbsp;<span class="keyword" id="5029903">struct</span>&nbsp;<span class="op" id="5029910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029913">req</span>&nbsp;<span class="op" id="5029917">*</span><span class="ident" id="5029918">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5029927">ch</span>&nbsp;&nbsp;<span class="keyword" id="5029931">chan</span>&nbsp;<span class="ident" id="5029936">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5029955">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5030016">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5030073">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030111">addedGzip</span>&nbsp;<span class="builtintype" id="5030121">bool</span><br>
<span class="lineno"></span><span class="op" id="5030126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="5030129">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5030190">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="5030254">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5030320">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="5030330">type</span>&nbsp;<span class="ident" id="5030335">writeRequest</span>&nbsp;<span class="keyword" id="5030348">struct</span>&nbsp;<span class="op" id="5030355">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030358">req</span>&nbsp;<span class="op" id="5030362">*</span><span class="ident" id="5030363">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030381">ch</span>&nbsp;&nbsp;<span class="keyword" id="5030385">chan</span><span class="op" id="5030389">&lt;-</span>&nbsp;<span class="builtintype" id="5030392">error</span><br>
<span class="lineno"></span><span class="op" id="5030398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5030401">type</span>&nbsp;<span class="ident" id="5030406">httpError</span>&nbsp;<span class="keyword" id="5030416">struct</span>&nbsp;<span class="op" id="5030423">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030426">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5030434">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030442">timeout</span>&nbsp;<span class="builtintype" id="5030450">bool</span><br>
<span class="lineno"></span><span class="op" id="5030455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5030458">func</span>&nbsp;<span class="op" id="5030463">(</span><span class="ident" id="5030464">e</span>&nbsp;<span class="op" id="5030466">*</span><span class="ident" id="5030467">httpError</span><span class="op" id="5030476">)</span>&nbsp;<span class="ident" id="5030478">Error</span><span class="op" id="5030483">(</span><span class="op" id="5030484">)</span>&nbsp;<span class="builtintype" id="5030486">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5030495">{</span>&nbsp;<span class="keyword" id="5030497">return</span>&nbsp;<span class="ident" id="5030504">e</span><span class="op" id="5030505">.</span><span class="ident" id="5030506">err</span>&nbsp;<span class="op" id="5030510">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="5030512">func</span>&nbsp;<span class="op" id="5030517">(</span><span class="ident" id="5030518">e</span>&nbsp;<span class="op" id="5030520">*</span><span class="ident" id="5030521">httpError</span><span class="op" id="5030530">)</span>&nbsp;<span class="ident" id="5030532">Timeout</span><span class="op" id="5030539">(</span><span class="op" id="5030540">)</span>&nbsp;<span class="builtintype" id="5030542">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5030549">{</span>&nbsp;<span class="keyword" id="5030551">return</span>&nbsp;<span class="ident" id="5030558">e</span><span class="op" id="5030559">.</span><span class="ident" id="5030560">timeout</span>&nbsp;<span class="op" id="5030568">}</span><br>
<span class="lineno"></span><span class="keyword" id="5030570">func</span>&nbsp;<span class="op" id="5030575">(</span><span class="ident" id="5030576">e</span>&nbsp;<span class="op" id="5030578">*</span><span class="ident" id="5030579">httpError</span><span class="op" id="5030588">)</span>&nbsp;<span class="ident" id="5030590">Temporary</span><span class="op" id="5030599">(</span><span class="op" id="5030600">)</span>&nbsp;<span class="builtintype" id="5030602">bool</span>&nbsp;<span class="op" id="5030607">{</span>&nbsp;<span class="keyword" id="5030609">return</span>&nbsp;<span class="builtintype" id="5030616">true</span>&nbsp;<span class="op" id="5030621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5030624">var</span>&nbsp;<span class="ident" id="5030628">errTimeout</span>&nbsp;<span class="builtintype" id="5030639">error</span>&nbsp;<span class="op" id="5030645">=</span>&nbsp;<span class="op" id="5030647">&amp;</span><span class="ident" id="5030648">httpError</span><span class="op" id="5030657">{</span><span class="ident" id="5030658">err</span><span class="op" id="5030661">:</span>&nbsp;<span class="string" id="5030663">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="5030708">,</span>&nbsp;<span class="ident" id="5030710">timeout</span><span class="op" id="5030717">:</span>&nbsp;<span class="builtintype" id="5030719">true</span><span class="op" id="5030723">}</span><br>
<span class="lineno"></span><span class="keyword" id="5030725">var</span>&nbsp;<span class="ident" id="5030729">errClosed</span>&nbsp;<span class="builtintype" id="5030739">error</span>&nbsp;<span class="op" id="5030745">=</span>&nbsp;<span class="op" id="5030747">&amp;</span><span class="ident" id="5030748">httpError</span><span class="op" id="5030757">{</span><span class="ident" id="5030758">err</span><span class="op" id="5030761">:</span>&nbsp;<span class="string" id="5030763">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="5030820">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="5030823">func</span>&nbsp;<span class="op" id="5030828">(</span><span class="ident" id="5030829">pc</span>&nbsp;<span class="op" id="5030832">*</span><span class="ident" id="5030833">persistConn</span><span class="op" id="5030844">)</span>&nbsp;<span class="ident" id="5030846">roundTrip</span><span class="op" id="5030855">(</span><span class="ident" id="5030856">req</span>&nbsp;<span class="op" id="5030860">*</span><span class="ident" id="5030861">transportRequest</span><span class="op" id="5030877">)</span>&nbsp;<span class="op" id="5030879">(</span><span class="ident" id="5030880">resp</span>&nbsp;<span class="op" id="5030885">*</span><span class="ident" id="5030886">Response</span><span class="op" id="5030894">,</span>&nbsp;<span class="ident" id="5030896">err</span>&nbsp;<span class="builtintype" id="5030900">error</span><span class="op" id="5030905">)</span>&nbsp;<span class="op" id="5030907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030910">pc</span><span class="op" id="5030912">.</span><span class="ident" id="5030913">t</span><span class="op" id="5030914">.</span><span class="ident" id="5030915">setReqCanceler</span><span class="op" id="5030929">(</span><span class="ident" id="5030930">req</span><span class="op" id="5030933">.</span><span class="ident" id="5030934">Request</span><span class="op" id="5030941">,</span>&nbsp;<span class="ident" id="5030943">pc</span><span class="op" id="5030945">.</span><span class="ident" id="5030946">cancelRequest</span><span class="op" id="5030959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030962">pc</span><span class="op" id="5030964">.</span><span class="ident" id="5030965">lk</span><span class="op" id="5030967">.</span><span class="ident" id="5030968">Lock</span><span class="op" id="5030972">(</span><span class="op" id="5030973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5030976">pc</span><span class="op" id="5030978">.</span><span class="ident" id="5030979">numExpectedResponses</span><span class="op" id="5030999">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031003">headerFn</span>&nbsp;<span class="op" id="5031012">:=</span>&nbsp;<span class="ident" id="5031015">pc</span><span class="op" id="5031017">.</span><span class="ident" id="5031018">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031036">pc</span><span class="op" id="5031038">.</span><span class="ident" id="5031039">lk</span><span class="op" id="5031041">.</span><span class="ident" id="5031042">Unlock</span><span class="op" id="5031048">(</span><span class="op" id="5031049">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031053">if</span>&nbsp;<span class="ident" id="5031056">headerFn</span>&nbsp;<span class="op" id="5031065">!=</span>&nbsp;<span class="ident" id="5031068">nil</span>&nbsp;<span class="op" id="5031072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031076">headerFn</span><span class="op" id="5031084">(</span><span class="ident" id="5031085">req</span><span class="op" id="5031088">.</span><span class="ident" id="5031089">extraHeaders</span><span class="op" id="5031101">(</span><span class="op" id="5031102">)</span><span class="op" id="5031103">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5031106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031110">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031174">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031228">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031285">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031303">requestedGzip</span>&nbsp;<span class="op" id="5031317">:=</span>&nbsp;<span class="builtintype" id="5031320">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5031327">if</span>&nbsp;<span class="op" id="5031330">!</span><span class="ident" id="5031331">pc</span><span class="op" id="5031333">.</span><span class="ident" id="5031334">t</span><span class="op" id="5031335">.</span><span class="ident" id="5031336">DisableCompression</span>&nbsp;<span class="op" id="5031355">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031360">req</span><span class="op" id="5031363">.</span><span class="ident" id="5031364">Header</span><span class="op" id="5031370">.</span><span class="ident" id="5031371">Get</span><span class="op" id="5031374">(</span><span class="string" id="5031375">&#34;Accept-Encoding&#34;</span><span class="op" id="5031392">)</span>&nbsp;<span class="op" id="5031394">==</span>&nbsp;<span class="string" id="5031397">&#34;&#34;</span>&nbsp;<span class="op" id="5031400">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031405">req</span><span class="op" id="5031408">.</span><span class="ident" id="5031409">Header</span><span class="op" id="5031415">.</span><span class="ident" id="5031416">Get</span><span class="op" id="5031419">(</span><span class="string" id="5031420">&#34;Range&#34;</span><span class="op" id="5031427">)</span>&nbsp;<span class="op" id="5031429">==</span>&nbsp;<span class="string" id="5031432">&#34;&#34;</span>&nbsp;<span class="op" id="5031435">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031440">req</span><span class="op" id="5031443">.</span><span class="ident" id="5031444">Method</span>&nbsp;<span class="op" id="5031451">!=</span>&nbsp;<span class="string" id="5031454">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="5031461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031465">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031527">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031569">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031624">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031629">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031685">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031713">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031759">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031795">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031800">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031864">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5031930">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031976">requestedGzip</span>&nbsp;<span class="op" id="5031990">=</span>&nbsp;<span class="builtintype" id="5031992">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5031999">req</span><span class="op" id="5032002">.</span><span class="ident" id="5032003">extraHeaders</span><span class="op" id="5032015">(</span><span class="op" id="5032016">)</span><span class="op" id="5032017">.</span><span class="ident" id="5032018">Set</span><span class="op" id="5032021">(</span><span class="string" id="5032022">&#34;Accept-Encoding&#34;</span><span class="op" id="5032039">,</span>&nbsp;<span class="string" id="5032041">&#34;gzip&#34;</span><span class="op" id="5032047">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5032050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032054">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032118">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032182">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032200">writeErrCh</span>&nbsp;<span class="op" id="5032211">:=</span>&nbsp;<span class="builtinfunc" id="5032214">make</span><span class="op" id="5032218">(</span><span class="keyword" id="5032219">chan</span>&nbsp;<span class="builtintype" id="5032224">error</span><span class="op" id="5032229">,</span>&nbsp;<span class="num" id="5032231">1</span><span class="op" id="5032232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032235">pc</span><span class="op" id="5032237">.</span><span class="ident" id="5032238">writech</span>&nbsp;<span class="op" id="5032246">&lt;-</span>&nbsp;<span class="ident" id="5032249">writeRequest</span><span class="op" id="5032261">{</span><span class="ident" id="5032262">req</span><span class="op" id="5032265">,</span>&nbsp;<span class="ident" id="5032267">writeErrCh</span><span class="op" id="5032277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032281">resc</span>&nbsp;<span class="op" id="5032286">:=</span>&nbsp;<span class="builtinfunc" id="5032289">make</span><span class="op" id="5032293">(</span><span class="keyword" id="5032294">chan</span>&nbsp;<span class="ident" id="5032299">responseAndError</span><span class="op" id="5032315">,</span>&nbsp;<span class="num" id="5032317">1</span><span class="op" id="5032318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032321">pc</span><span class="op" id="5032323">.</span><span class="ident" id="5032324">reqch</span>&nbsp;<span class="op" id="5032330">&lt;-</span>&nbsp;<span class="ident" id="5032333">requestAndChan</span><span class="op" id="5032347">{</span><span class="ident" id="5032348">req</span><span class="op" id="5032351">.</span><span class="ident" id="5032352">Request</span><span class="op" id="5032359">,</span>&nbsp;<span class="ident" id="5032361">resc</span><span class="op" id="5032365">,</span>&nbsp;<span class="ident" id="5032367">requestedGzip</span><span class="op" id="5032380">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032384">var</span>&nbsp;<span class="ident" id="5032388">re</span>&nbsp;<span class="ident" id="5032391">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032409">var</span>&nbsp;<span class="ident" id="5032413">pconnDeadCh</span>&nbsp;<span class="op" id="5032425">=</span>&nbsp;<span class="ident" id="5032427">pc</span><span class="op" id="5032429">.</span><span class="ident" id="5032430">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032439">var</span>&nbsp;<span class="ident" id="5032443">failTicker</span>&nbsp;<span class="op" id="5032454">&lt;-</span><span class="keyword" id="5032456">chan</span>&nbsp;<span class="ident" id="5032461">time</span><span class="op" id="5032465">.</span><span class="ident" id="5032466">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032472">var</span>&nbsp;<span class="ident" id="5032476">respHeaderTimer</span>&nbsp;<span class="op" id="5032492">&lt;-</span><span class="keyword" id="5032494">chan</span>&nbsp;<span class="ident" id="5032499">time</span><span class="op" id="5032503">.</span><span class="ident" id="5032504">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="5032509">WaitResponse</span><span class="op" id="5032521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032524">for</span>&nbsp;<span class="op" id="5032528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032532">select</span>&nbsp;<span class="op" id="5032539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032543">case</span>&nbsp;<span class="ident" id="5032548">err</span>&nbsp;<span class="op" id="5032552">:=</span>&nbsp;<span class="op" id="5032555">&lt;-</span><span class="ident" id="5032557">writeErrCh</span><span class="op" id="5032567">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032572">if</span>&nbsp;<span class="ident" id="5032575">err</span>&nbsp;<span class="op" id="5032579">!=</span>&nbsp;<span class="ident" id="5032582">nil</span>&nbsp;<span class="op" id="5032586">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032592">re</span>&nbsp;<span class="op" id="5032595">=</span>&nbsp;<span class="ident" id="5032597">responseAndError</span><span class="op" id="5032613">{</span><span class="ident" id="5032614">nil</span><span class="op" id="5032617">,</span>&nbsp;<span class="ident" id="5032619">err</span><span class="op" id="5032622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032628">pc</span><span class="op" id="5032630">.</span><span class="builtinfunc" id="5032631">close</span><span class="op" id="5032636">(</span><span class="op" id="5032637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032643">break</span>&nbsp;<span class="ident" id="5032649">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5032665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032670">if</span>&nbsp;<span class="ident" id="5032673">d</span>&nbsp;<span class="op" id="5032675">:=</span>&nbsp;<span class="ident" id="5032678">pc</span><span class="op" id="5032680">.</span><span class="ident" id="5032681">t</span><span class="op" id="5032682">.</span><span class="ident" id="5032683">ResponseHeaderTimeout</span><span class="op" id="5032704">;</span>&nbsp;<span class="ident" id="5032706">d</span>&nbsp;<span class="op" id="5032708">&gt;</span>&nbsp;<span class="num" id="5032710">0</span>&nbsp;<span class="op" id="5032712">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5032718">respHeaderTimer</span>&nbsp;<span class="op" id="5032734">=</span>&nbsp;<span class="ident" id="5032736">time</span><span class="op" id="5032740">.</span><span class="ident" id="5032741">After</span><span class="op" id="5032746">(</span><span class="ident" id="5032747">d</span><span class="op" id="5032748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5032753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5032757">case</span>&nbsp;<span class="op" id="5032762">&lt;-</span><span class="ident" id="5032764">pconnDeadCh</span><span class="op" id="5032775">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032780">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032833">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032893">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5032950">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033004">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033063">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033121">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033178">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033212">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033218">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033283">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5033339">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033382">pconnDeadCh</span>&nbsp;<span class="op" id="5033394">=</span>&nbsp;<span class="ident" id="5033396">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5033430">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033451">failTicker</span>&nbsp;<span class="op" id="5033462">=</span>&nbsp;<span class="ident" id="5033464">time</span><span class="op" id="5033468">.</span><span class="ident" id="5033469">After</span><span class="op" id="5033474">(</span><span class="num" id="5033475">100</span>&nbsp;<span class="op" id="5033479">*</span>&nbsp;<span class="ident" id="5033481">time</span><span class="op" id="5033485">.</span><span class="ident" id="5033486">Millisecond</span><span class="op" id="5033497">)</span>&nbsp;<span class="comment" id="5033499">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033536">case</span>&nbsp;<span class="op" id="5033541">&lt;-</span><span class="ident" id="5033543">failTicker</span><span class="op" id="5033553">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033558">re</span>&nbsp;<span class="op" id="5033561">=</span>&nbsp;<span class="ident" id="5033563">responseAndError</span><span class="op" id="5033579">{</span><span class="ident" id="5033580">err</span><span class="op" id="5033583">:</span>&nbsp;<span class="ident" id="5033585">errClosed</span><span class="op" id="5033594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033599">break</span>&nbsp;<span class="ident" id="5033605">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033620">case</span>&nbsp;<span class="op" id="5033625">&lt;-</span><span class="ident" id="5033627">respHeaderTimer</span><span class="op" id="5033642">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033647">pc</span><span class="op" id="5033649">.</span><span class="builtinfunc" id="5033650">close</span><span class="op" id="5033655">(</span><span class="op" id="5033656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033661">re</span>&nbsp;<span class="op" id="5033664">=</span>&nbsp;<span class="ident" id="5033666">responseAndError</span><span class="op" id="5033682">{</span><span class="ident" id="5033683">err</span><span class="op" id="5033686">:</span>&nbsp;<span class="ident" id="5033688">errTimeout</span><span class="op" id="5033698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033703">break</span>&nbsp;<span class="ident" id="5033709">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033724">case</span>&nbsp;<span class="ident" id="5033729">re</span>&nbsp;<span class="op" id="5033732">=</span>&nbsp;<span class="op" id="5033734">&lt;-</span><span class="ident" id="5033736">resc</span><span class="op" id="5033740">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033745">break</span>&nbsp;<span class="ident" id="5033751">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033773">pc</span><span class="op" id="5033775">.</span><span class="ident" id="5033776">lk</span><span class="op" id="5033778">.</span><span class="ident" id="5033779">Lock</span><span class="op" id="5033783">(</span><span class="op" id="5033784">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033787">pc</span><span class="op" id="5033789">.</span><span class="ident" id="5033790">numExpectedResponses</span><span class="op" id="5033810">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033814">pc</span><span class="op" id="5033816">.</span><span class="ident" id="5033817">lk</span><span class="op" id="5033819">.</span><span class="ident" id="5033820">Unlock</span><span class="op" id="5033826">(</span><span class="op" id="5033827">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033831">if</span>&nbsp;<span class="ident" id="5033834">re</span><span class="op" id="5033836">.</span><span class="ident" id="5033837">err</span>&nbsp;<span class="op" id="5033841">!=</span>&nbsp;<span class="ident" id="5033844">nil</span>&nbsp;<span class="op" id="5033848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5033852">pc</span><span class="op" id="5033854">.</span><span class="ident" id="5033855">t</span><span class="op" id="5033856">.</span><span class="ident" id="5033857">setReqCanceler</span><span class="op" id="5033871">(</span><span class="ident" id="5033872">req</span><span class="op" id="5033875">.</span><span class="ident" id="5033876">Request</span><span class="op" id="5033883">,</span>&nbsp;<span class="ident" id="5033885">nil</span><span class="op" id="5033888">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5033891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5033894">return</span>&nbsp;<span class="ident" id="5033901">re</span><span class="op" id="5033903">.</span><span class="ident" id="5033904">res</span><span class="op" id="5033907">,</span>&nbsp;<span class="ident" id="5033909">re</span><span class="op" id="5033911">.</span><span class="ident" id="5033912">err</span><br>
<span class="lineno"></span><span class="op" id="5033916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5033919">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="5033984">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="5034049">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="5034099">func</span>&nbsp;<span class="op" id="5034104">(</span><span class="ident" id="5034105">pc</span>&nbsp;<span class="op" id="5034108">*</span><span class="ident" id="5034109">persistConn</span><span class="op" id="5034120">)</span>&nbsp;<span class="ident" id="5034122">markBroken</span><span class="op" id="5034132">(</span><span class="op" id="5034133">)</span>&nbsp;<span class="op" id="5034135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034138">pc</span><span class="op" id="5034140">.</span><span class="ident" id="5034141">lk</span><span class="op" id="5034143">.</span><span class="ident" id="5034144">Lock</span><span class="op" id="5034148">(</span><span class="op" id="5034149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034152">defer</span>&nbsp;<span class="ident" id="5034158">pc</span><span class="op" id="5034160">.</span><span class="ident" id="5034161">lk</span><span class="op" id="5034163">.</span><span class="ident" id="5034164">Unlock</span><span class="op" id="5034170">(</span><span class="op" id="5034171">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034174">pc</span><span class="op" id="5034176">.</span><span class="ident" id="5034177">broken</span>&nbsp;<span class="op" id="5034184">=</span>&nbsp;<span class="builtintype" id="5034186">true</span><br>
<span class="lineno"></span><span class="op" id="5034191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5034194">func</span>&nbsp;<span class="op" id="5034199">(</span><span class="ident" id="5034200">pc</span>&nbsp;<span class="op" id="5034203">*</span><span class="ident" id="5034204">persistConn</span><span class="op" id="5034215">)</span>&nbsp;<span class="builtinfunc" id="5034217">close</span><span class="op" id="5034222">(</span><span class="op" id="5034223">)</span>&nbsp;<span class="op" id="5034225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034228">pc</span><span class="op" id="5034230">.</span><span class="ident" id="5034231">lk</span><span class="op" id="5034233">.</span><span class="ident" id="5034234">Lock</span><span class="op" id="5034238">(</span><span class="op" id="5034239">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034242">defer</span>&nbsp;<span class="ident" id="5034248">pc</span><span class="op" id="5034250">.</span><span class="ident" id="5034251">lk</span><span class="op" id="5034253">.</span><span class="ident" id="5034254">Unlock</span><span class="op" id="5034260">(</span><span class="op" id="5034261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034264">pc</span><span class="op" id="5034266">.</span><span class="ident" id="5034267">closeLocked</span><span class="op" id="5034278">(</span><span class="op" id="5034279">)</span><br>
<span class="lineno"></span><span class="op" id="5034281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5034284">func</span>&nbsp;<span class="op" id="5034289">(</span><span class="ident" id="5034290">pc</span>&nbsp;<span class="op" id="5034293">*</span><span class="ident" id="5034294">persistConn</span><span class="op" id="5034305">)</span>&nbsp;<span class="ident" id="5034307">closeLocked</span><span class="op" id="5034318">(</span><span class="op" id="5034319">)</span>&nbsp;<span class="op" id="5034321">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034324">pc</span><span class="op" id="5034326">.</span><span class="ident" id="5034327">broken</span>&nbsp;<span class="op" id="5034334">=</span>&nbsp;<span class="builtintype" id="5034336">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034342">if</span>&nbsp;<span class="op" id="5034345">!</span><span class="ident" id="5034346">pc</span><span class="op" id="5034348">.</span><span class="ident" id="5034349">closed</span>&nbsp;<span class="op" id="5034356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034360">pc</span><span class="op" id="5034362">.</span><span class="ident" id="5034363">conn</span><span class="op" id="5034367">.</span><span class="ident" id="5034368">Close</span><span class="op" id="5034373">(</span><span class="op" id="5034374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034378">pc</span><span class="op" id="5034380">.</span><span class="ident" id="5034381">closed</span>&nbsp;<span class="op" id="5034388">=</span>&nbsp;<span class="builtintype" id="5034390">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5034397">close</span><span class="op" id="5034402">(</span><span class="ident" id="5034403">pc</span><span class="op" id="5034405">.</span><span class="ident" id="5034406">closech</span><span class="op" id="5034413">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5034416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034419">pc</span><span class="op" id="5034421">.</span><span class="ident" id="5034422">mutateHeaderFunc</span>&nbsp;<span class="op" id="5034439">=</span>&nbsp;<span class="ident" id="5034441">nil</span><br>
<span class="lineno"></span><span class="op" id="5034445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5034448">var</span>&nbsp;<span class="ident" id="5034452">portMap</span>&nbsp;<span class="op" id="5034460">=</span>&nbsp;<span class="keyword" id="5034462">map</span><span class="op" id="5034465">[</span><span class="builtintype" id="5034466">string</span><span class="op" id="5034472">]</span><span class="builtintype" id="5034473">string</span><span class="op" id="5034479">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5034482">&#34;http&#34;</span><span class="op" id="5034488">:</span>&nbsp;&nbsp;<span class="string" id="5034491">&#34;80&#34;</span><span class="op" id="5034495">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5034498">&#34;https&#34;</span><span class="op" id="5034505">:</span>&nbsp;<span class="string" id="5034507">&#34;443&#34;</span><span class="op" id="5034512">,</span><br>
<span class="lineno"></span><span class="op" id="5034514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5034517">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="5034584">func</span>&nbsp;<span class="ident" id="5034589">canonicalAddr</span><span class="op" id="5034602">(</span><span class="ident" id="5034603">url</span>&nbsp;<span class="op" id="5034607">*</span><span class="ident" id="5034608">url</span><span class="op" id="5034611">.</span><span class="ident" id="5034612">URL</span><span class="op" id="5034615">)</span>&nbsp;<span class="builtintype" id="5034617">string</span>&nbsp;<span class="op" id="5034624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5034627">addr</span>&nbsp;<span class="op" id="5034632">:=</span>&nbsp;<span class="ident" id="5034635">url</span><span class="op" id="5034638">.</span><span class="ident" id="5034639">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034645">if</span>&nbsp;<span class="op" id="5034648">!</span><span class="ident" id="5034649">hasPort</span><span class="op" id="5034656">(</span><span class="ident" id="5034657">addr</span><span class="op" id="5034661">)</span>&nbsp;<span class="op" id="5034663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034667">return</span>&nbsp;<span class="ident" id="5034674">addr</span>&nbsp;<span class="op" id="5034679">+</span>&nbsp;<span class="string" id="5034681">&#34;:&#34;</span>&nbsp;<span class="op" id="5034685">+</span>&nbsp;<span class="ident" id="5034687">portMap</span><span class="op" id="5034694">[</span><span class="ident" id="5034695">url</span><span class="op" id="5034698">.</span><span class="ident" id="5034699">Scheme</span><span class="op" id="5034705">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5034708">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5034711">return</span>&nbsp;<span class="ident" id="5034718">addr</span><br>
<span class="lineno"></span><span class="op" id="5034723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5034726">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="5034795">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="5034864">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="5034930">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="5034995">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="5035043">type</span>&nbsp;<span class="ident" id="5035048">bodyEOFSignal</span>&nbsp;<span class="keyword" id="5035062">struct</span>&nbsp;<span class="op" id="5035069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035072">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5035085">io</span><span class="op" id="5035087">.</span><span class="ident" id="5035088">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035100">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5035113">sync</span><span class="op" id="5035117">.</span><span class="ident" id="5035118">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5035126">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035156">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5035169">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5035182">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035216">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5035229">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5035242">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035264">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5035277">func</span><span class="op" id="5035281">(</span><span class="builtintype" id="5035282">error</span><span class="op" id="5035287">)</span>&nbsp;&nbsp;<span class="comment" id="5035290">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035327">earlyCloseFn</span>&nbsp;<span class="keyword" id="5035340">func</span><span class="op" id="5035344">(</span><span class="op" id="5035345">)</span>&nbsp;<span class="builtintype" id="5035347">error</span>&nbsp;<span class="comment" id="5035353">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="5035404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5035407">func</span>&nbsp;<span class="op" id="5035412">(</span><span class="ident" id="5035413">es</span>&nbsp;<span class="op" id="5035416">*</span><span class="ident" id="5035417">bodyEOFSignal</span><span class="op" id="5035430">)</span>&nbsp;<span class="ident" id="5035432">Read</span><span class="op" id="5035436">(</span><span class="ident" id="5035437">p</span>&nbsp;<span class="op" id="5035439">[</span><span class="op" id="5035440">]</span><span class="builtintype" id="5035441">byte</span><span class="op" id="5035445">)</span>&nbsp;<span class="op" id="5035447">(</span><span class="ident" id="5035448">n</span>&nbsp;<span class="builtintype" id="5035450">int</span><span class="op" id="5035453">,</span>&nbsp;<span class="ident" id="5035455">err</span>&nbsp;<span class="builtintype" id="5035459">error</span><span class="op" id="5035464">)</span>&nbsp;<span class="op" id="5035466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035469">es</span><span class="op" id="5035471">.</span><span class="ident" id="5035472">mu</span><span class="op" id="5035474">.</span><span class="ident" id="5035475">Lock</span><span class="op" id="5035479">(</span><span class="op" id="5035480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035483">closed</span><span class="op" id="5035489">,</span>&nbsp;<span class="ident" id="5035491">rerr</span>&nbsp;<span class="op" id="5035496">:=</span>&nbsp;<span class="ident" id="5035499">es</span><span class="op" id="5035501">.</span><span class="ident" id="5035502">closed</span><span class="op" id="5035508">,</span>&nbsp;<span class="ident" id="5035510">es</span><span class="op" id="5035512">.</span><span class="ident" id="5035513">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035519">es</span><span class="op" id="5035521">.</span><span class="ident" id="5035522">mu</span><span class="op" id="5035524">.</span><span class="ident" id="5035525">Unlock</span><span class="op" id="5035531">(</span><span class="op" id="5035532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035535">if</span>&nbsp;<span class="ident" id="5035538">closed</span>&nbsp;<span class="op" id="5035545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035549">return</span>&nbsp;<span class="num" id="5035556">0</span><span class="op" id="5035557">,</span>&nbsp;<span class="ident" id="5035559">errors</span><span class="op" id="5035565">.</span><span class="ident" id="5035566">New</span><span class="op" id="5035569">(</span><span class="string" id="5035570">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="5035606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5035609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035612">if</span>&nbsp;<span class="ident" id="5035615">rerr</span>&nbsp;<span class="op" id="5035620">!=</span>&nbsp;<span class="ident" id="5035623">nil</span>&nbsp;<span class="op" id="5035627">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035631">return</span>&nbsp;<span class="num" id="5035638">0</span><span class="op" id="5035639">,</span>&nbsp;<span class="ident" id="5035641">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5035647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035651">n</span><span class="op" id="5035652">,</span>&nbsp;<span class="ident" id="5035654">err</span>&nbsp;<span class="op" id="5035658">=</span>&nbsp;<span class="ident" id="5035660">es</span><span class="op" id="5035662">.</span><span class="ident" id="5035663">body</span><span class="op" id="5035667">.</span><span class="ident" id="5035668">Read</span><span class="op" id="5035672">(</span><span class="ident" id="5035673">p</span><span class="op" id="5035674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035677">if</span>&nbsp;<span class="ident" id="5035680">err</span>&nbsp;<span class="op" id="5035684">!=</span>&nbsp;<span class="ident" id="5035687">nil</span>&nbsp;<span class="op" id="5035691">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035695">es</span><span class="op" id="5035697">.</span><span class="ident" id="5035698">mu</span><span class="op" id="5035700">.</span><span class="ident" id="5035701">Lock</span><span class="op" id="5035705">(</span><span class="op" id="5035706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035710">defer</span>&nbsp;<span class="ident" id="5035716">es</span><span class="op" id="5035718">.</span><span class="ident" id="5035719">mu</span><span class="op" id="5035721">.</span><span class="ident" id="5035722">Unlock</span><span class="op" id="5035728">(</span><span class="op" id="5035729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035733">if</span>&nbsp;<span class="ident" id="5035736">es</span><span class="op" id="5035738">.</span><span class="ident" id="5035739">rerr</span>&nbsp;<span class="op" id="5035744">==</span>&nbsp;<span class="ident" id="5035747">nil</span>&nbsp;<span class="op" id="5035751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035756">es</span><span class="op" id="5035758">.</span><span class="ident" id="5035759">rerr</span>&nbsp;<span class="op" id="5035764">=</span>&nbsp;<span class="ident" id="5035766">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5035772">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035776">es</span><span class="op" id="5035778">.</span><span class="ident" id="5035779">condfn</span><span class="op" id="5035785">(</span><span class="ident" id="5035786">err</span><span class="op" id="5035789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5035792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035795">return</span><br>
<span class="lineno"></span><span class="op" id="5035802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="5035805">func</span>&nbsp;<span class="op" id="5035810">(</span><span class="ident" id="5035811">es</span>&nbsp;<span class="op" id="5035814">*</span><span class="ident" id="5035815">bodyEOFSignal</span><span class="op" id="5035828">)</span>&nbsp;<span class="ident" id="5035830">Close</span><span class="op" id="5035835">(</span><span class="op" id="5035836">)</span>&nbsp;<span class="builtintype" id="5035838">error</span>&nbsp;<span class="op" id="5035844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035847">es</span><span class="op" id="5035849">.</span><span class="ident" id="5035850">mu</span><span class="op" id="5035852">.</span><span class="ident" id="5035853">Lock</span><span class="op" id="5035857">(</span><span class="op" id="5035858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035861">defer</span>&nbsp;<span class="ident" id="5035867">es</span><span class="op" id="5035869">.</span><span class="ident" id="5035870">mu</span><span class="op" id="5035872">.</span><span class="ident" id="5035873">Unlock</span><span class="op" id="5035879">(</span><span class="op" id="5035880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035883">if</span>&nbsp;<span class="ident" id="5035886">es</span><span class="op" id="5035888">.</span><span class="ident" id="5035889">closed</span>&nbsp;<span class="op" id="5035896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035900">return</span>&nbsp;<span class="ident" id="5035907">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5035912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5035915">es</span><span class="op" id="5035917">.</span><span class="ident" id="5035918">closed</span>&nbsp;<span class="op" id="5035925">=</span>&nbsp;<span class="builtintype" id="5035927">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035933">if</span>&nbsp;<span class="ident" id="5035936">es</span><span class="op" id="5035938">.</span><span class="ident" id="5035939">earlyCloseFn</span>&nbsp;<span class="op" id="5035952">!=</span>&nbsp;<span class="ident" id="5035955">nil</span>&nbsp;<span class="op" id="5035959">&amp;&amp;</span>&nbsp;<span class="ident" id="5035962">es</span><span class="op" id="5035964">.</span><span class="ident" id="5035965">rerr</span>&nbsp;<span class="op" id="5035970">!=</span>&nbsp;<span class="ident" id="5035973">io</span><span class="op" id="5035975">.</span><span class="ident" id="5035976">EOF</span>&nbsp;<span class="op" id="5035980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5035984">return</span>&nbsp;<span class="ident" id="5035991">es</span><span class="op" id="5035993">.</span><span class="ident" id="5035994">earlyCloseFn</span><span class="op" id="5036006">(</span><span class="op" id="5036007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036010">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036013">err</span>&nbsp;<span class="op" id="5036017">:=</span>&nbsp;<span class="ident" id="5036020">es</span><span class="op" id="5036022">.</span><span class="ident" id="5036023">body</span><span class="op" id="5036027">.</span><span class="ident" id="5036028">Close</span><span class="op" id="5036033">(</span><span class="op" id="5036034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036037">es</span><span class="op" id="5036039">.</span><span class="ident" id="5036040">condfn</span><span class="op" id="5036046">(</span><span class="ident" id="5036047">err</span><span class="op" id="5036050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036053">return</span>&nbsp;<span class="ident" id="5036060">err</span><br>
<span class="lineno"></span><span class="op" id="5036064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="5036067">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="5036094">func</span>&nbsp;<span class="op" id="5036099">(</span><span class="ident" id="5036100">es</span>&nbsp;<span class="op" id="5036103">*</span><span class="ident" id="5036104">bodyEOFSignal</span><span class="op" id="5036117">)</span>&nbsp;<span class="ident" id="5036119">condfn</span><span class="op" id="5036125">(</span><span class="ident" id="5036126">err</span>&nbsp;<span class="builtintype" id="5036130">error</span><span class="op" id="5036135">)</span>&nbsp;<span class="op" id="5036137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036140">if</span>&nbsp;<span class="ident" id="5036143">es</span><span class="op" id="5036145">.</span><span class="ident" id="5036146">fn</span>&nbsp;<span class="op" id="5036149">==</span>&nbsp;<span class="ident" id="5036152">nil</span>&nbsp;<span class="op" id="5036156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036160">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036168">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036171">if</span>&nbsp;<span class="ident" id="5036174">err</span>&nbsp;<span class="op" id="5036178">==</span>&nbsp;<span class="ident" id="5036181">io</span><span class="op" id="5036183">.</span><span class="ident" id="5036184">EOF</span>&nbsp;<span class="op" id="5036188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036192">err</span>&nbsp;<span class="op" id="5036196">=</span>&nbsp;<span class="ident" id="5036198">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036206">es</span><span class="op" id="5036208">.</span><span class="ident" id="5036209">fn</span><span class="op" id="5036211">(</span><span class="ident" id="5036212">err</span><span class="op" id="5036215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036218">es</span><span class="op" id="5036220">.</span><span class="ident" id="5036221">fn</span>&nbsp;<span class="op" id="5036224">=</span>&nbsp;<span class="ident" id="5036226">nil</span><br>
<span class="lineno">1230</span><span class="op" id="5036230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5036233">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="5036286">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="5036335">type</span>&nbsp;<span class="ident" id="5036340">gzipReader</span>&nbsp;<span class="keyword" id="5036351">struct</span>&nbsp;<span class="op" id="5036358">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036361">body</span>&nbsp;<span class="ident" id="5036366">io</span><span class="op" id="5036368">.</span><span class="ident" id="5036369">ReadCloser</span>&nbsp;<span class="comment" id="5036380">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036409">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5036414">io</span><span class="op" id="5036416">.</span><span class="ident" id="5036417">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5036428">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="5036462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5036465">func</span>&nbsp;<span class="op" id="5036470">(</span><span class="ident" id="5036471">gz</span>&nbsp;<span class="op" id="5036474">*</span><span class="ident" id="5036475">gzipReader</span><span class="op" id="5036485">)</span>&nbsp;<span class="ident" id="5036487">Read</span><span class="op" id="5036491">(</span><span class="ident" id="5036492">p</span>&nbsp;<span class="op" id="5036494">[</span><span class="op" id="5036495">]</span><span class="builtintype" id="5036496">byte</span><span class="op" id="5036500">)</span>&nbsp;<span class="op" id="5036502">(</span><span class="ident" id="5036503">n</span>&nbsp;<span class="builtintype" id="5036505">int</span><span class="op" id="5036508">,</span>&nbsp;<span class="ident" id="5036510">err</span>&nbsp;<span class="builtintype" id="5036514">error</span><span class="op" id="5036519">)</span>&nbsp;<span class="op" id="5036521">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036524">if</span>&nbsp;<span class="ident" id="5036527">gz</span><span class="op" id="5036529">.</span><span class="ident" id="5036530">zr</span>&nbsp;<span class="op" id="5036533">==</span>&nbsp;<span class="ident" id="5036536">nil</span>&nbsp;<span class="op" id="5036540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036544">gz</span><span class="op" id="5036546">.</span><span class="ident" id="5036547">zr</span><span class="op" id="5036549">,</span>&nbsp;<span class="ident" id="5036551">err</span>&nbsp;<span class="op" id="5036555">=</span>&nbsp;<span class="ident" id="5036557">gzip</span><span class="op" id="5036561">.</span><span class="ident" id="5036562">NewReader</span><span class="op" id="5036571">(</span><span class="ident" id="5036572">gz</span><span class="op" id="5036574">.</span><span class="ident" id="5036575">body</span><span class="op" id="5036579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036583">if</span>&nbsp;<span class="ident" id="5036586">err</span>&nbsp;<span class="op" id="5036590">!=</span>&nbsp;<span class="ident" id="5036593">nil</span>&nbsp;<span class="op" id="5036597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036602">return</span>&nbsp;<span class="num" id="5036609">0</span><span class="op" id="5036610">,</span>&nbsp;<span class="ident" id="5036612">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036618">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5036621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036624">return</span>&nbsp;<span class="ident" id="5036631">gz</span><span class="op" id="5036633">.</span><span class="ident" id="5036634">zr</span><span class="op" id="5036636">.</span><span class="ident" id="5036637">Read</span><span class="op" id="5036641">(</span><span class="ident" id="5036642">p</span><span class="op" id="5036643">)</span><br>
<span class="lineno"></span><span class="op" id="5036645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5036648">func</span>&nbsp;<span class="op" id="5036653">(</span><span class="ident" id="5036654">gz</span>&nbsp;<span class="op" id="5036657">*</span><span class="ident" id="5036658">gzipReader</span><span class="op" id="5036668">)</span>&nbsp;<span class="ident" id="5036670">Close</span><span class="op" id="5036675">(</span><span class="op" id="5036676">)</span>&nbsp;<span class="builtintype" id="5036678">error</span>&nbsp;<span class="op" id="5036684">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5036687">return</span>&nbsp;<span class="ident" id="5036694">gz</span><span class="op" id="5036696">.</span><span class="ident" id="5036697">body</span><span class="op" id="5036701">.</span><span class="ident" id="5036702">Close</span><span class="op" id="5036707">(</span><span class="op" id="5036708">)</span><br>
<span class="lineno"></span><span class="op" id="5036710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5036713">type</span>&nbsp;<span class="ident" id="5036718">readerAndCloser</span>&nbsp;<span class="keyword" id="5036734">struct</span>&nbsp;<span class="op" id="5036741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036744">io</span><span class="op" id="5036746">.</span><span class="ident" id="5036747">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5036755">io</span><span class="op" id="5036757">.</span><span class="ident" id="5036758">Closer</span><br>
<span class="lineno"></span><span class="op" id="5036765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5036768">type</span>&nbsp;<span class="ident" id="5036773">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="5036798">struct</span><span class="op" id="5036804">{</span><span class="op" id="5036805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="5036808">func</span>&nbsp;<span class="op" id="5036813">(</span><span class="ident" id="5036814">tlsHandshakeTimeoutError</span><span class="op" id="5036838">)</span>&nbsp;<span class="ident" id="5036840">Timeout</span><span class="op" id="5036847">(</span><span class="op" id="5036848">)</span>&nbsp;<span class="builtintype" id="5036850">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5036857">{</span>&nbsp;<span class="keyword" id="5036859">return</span>&nbsp;<span class="builtintype" id="5036866">true</span>&nbsp;<span class="op" id="5036871">}</span><br>
<span class="lineno"></span><span class="keyword" id="5036873">func</span>&nbsp;<span class="op" id="5036878">(</span><span class="ident" id="5036879">tlsHandshakeTimeoutError</span><span class="op" id="5036903">)</span>&nbsp;<span class="ident" id="5036905">Temporary</span><span class="op" id="5036914">(</span><span class="op" id="5036915">)</span>&nbsp;<span class="builtintype" id="5036917">bool</span>&nbsp;<span class="op" id="5036922">{</span>&nbsp;<span class="keyword" id="5036924">return</span>&nbsp;<span class="builtintype" id="5036931">true</span>&nbsp;<span class="op" id="5036936">}</span><br>
<span class="lineno"></span><span class="keyword" id="5036938">func</span>&nbsp;<span class="op" id="5036943">(</span><span class="ident" id="5036944">tlsHandshakeTimeoutError</span><span class="op" id="5036968">)</span>&nbsp;<span class="ident" id="5036970">Error</span><span class="op" id="5036975">(</span><span class="op" id="5036976">)</span>&nbsp;<span class="builtintype" id="5036978">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5036987">{</span>&nbsp;<span class="keyword" id="5036989">return</span>&nbsp;<span class="string" id="5036996">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="5037030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5037033">type</span>&nbsp;<span class="ident" id="5037038">noteEOFReader</span>&nbsp;<span class="keyword" id="5037052">struct</span>&nbsp;<span class="op" id="5037059">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037062">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5037069">io</span><span class="op" id="5037071">.</span><span class="ident" id="5037072">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037080">sawEOF</span>&nbsp;<span class="op" id="5037087">*</span><span class="builtintype" id="5037088">bool</span><br>
<span class="lineno"></span><span class="op" id="5037093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5037096">func</span>&nbsp;<span class="op" id="5037101">(</span><span class="ident" id="5037102">nr</span>&nbsp;<span class="ident" id="5037105">noteEOFReader</span><span class="op" id="5037118">)</span>&nbsp;<span class="ident" id="5037120">Read</span><span class="op" id="5037124">(</span><span class="ident" id="5037125">p</span>&nbsp;<span class="op" id="5037127">[</span><span class="op" id="5037128">]</span><span class="builtintype" id="5037129">byte</span><span class="op" id="5037133">)</span>&nbsp;<span class="op" id="5037135">(</span><span class="ident" id="5037136">n</span>&nbsp;<span class="builtintype" id="5037138">int</span><span class="op" id="5037141">,</span>&nbsp;<span class="ident" id="5037143">err</span>&nbsp;<span class="builtintype" id="5037147">error</span><span class="op" id="5037152">)</span>&nbsp;<span class="op" id="5037154">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5037157">n</span><span class="op" id="5037158">,</span>&nbsp;<span class="ident" id="5037160">err</span>&nbsp;<span class="op" id="5037164">=</span>&nbsp;<span class="ident" id="5037166">nr</span><span class="op" id="5037168">.</span><span class="ident" id="5037169">r</span><span class="op" id="5037170">.</span><span class="ident" id="5037171">Read</span><span class="op" id="5037175">(</span><span class="ident" id="5037176">p</span><span class="op" id="5037177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037180">if</span>&nbsp;<span class="ident" id="5037183">err</span>&nbsp;<span class="op" id="5037187">==</span>&nbsp;<span class="ident" id="5037190">io</span><span class="op" id="5037192">.</span><span class="ident" id="5037193">EOF</span>&nbsp;<span class="op" id="5037197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5037201">*</span><span class="ident" id="5037202">nr</span><span class="op" id="5037204">.</span><span class="ident" id="5037205">sawEOF</span>&nbsp;<span class="op" id="5037212">=</span>&nbsp;<span class="builtintype" id="5037214">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5037220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5037223">return</span><br>
<span class="lineno">1275</span><span class="op" id="5037230">}</span>
</div>
</body>
</html>
