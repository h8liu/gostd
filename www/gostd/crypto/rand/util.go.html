<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3568652">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3568708">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3568762">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3568813">package</span>&nbsp;<span class="ident" id="3568821">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3568827">import</span>&nbsp;<span class="op" id="3568834">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3568837">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3568847">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3568853">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op" id="3568864">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3568867">//&nbsp;smallPrimes&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;small,&nbsp;prime&nbsp;numbers&nbsp;that&nbsp;allows&nbsp;us&nbsp;to&nbsp;rapidly</span><br>
<span class="lineno"></span><span class="comment" id="3568942">//&nbsp;exclude&nbsp;some&nbsp;fraction&nbsp;of&nbsp;composite&nbsp;candidates&nbsp;when&nbsp;searching&nbsp;for&nbsp;a&nbsp;random</span><br>
<span class="lineno">15</span><span class="comment" id="3569019">//&nbsp;prime.&nbsp;This&nbsp;list&nbsp;is&nbsp;truncated&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;smallPrimesProduct&nbsp;exceeds</span><br>
<span class="lineno"></span><span class="comment" id="3569098">//&nbsp;a&nbsp;uint64.&nbsp;It&nbsp;does&nbsp;not&nbsp;include&nbsp;two&nbsp;because&nbsp;we&nbsp;ensure&nbsp;that&nbsp;the&nbsp;candidates&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3569177">//&nbsp;odd&nbsp;by&nbsp;construction.</span><br>
<span class="lineno"></span><span class="keyword" id="3569201">var</span>&nbsp;<span class="ident" id="3569205">smallPrimes</span>&nbsp;<span class="op" id="3569217">=</span>&nbsp;<span class="op" id="3569219">[</span><span class="op" id="3569220">]</span><span class="builtintype" id="3569221">uint8</span><span class="op" id="3569226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3569229">3</span><span class="op" id="3569230">,</span>&nbsp;<span class="num" id="3569232">5</span><span class="op" id="3569233">,</span>&nbsp;<span class="num" id="3569235">7</span><span class="op" id="3569236">,</span>&nbsp;<span class="num" id="3569238">11</span><span class="op" id="3569240">,</span>&nbsp;<span class="num" id="3569242">13</span><span class="op" id="3569244">,</span>&nbsp;<span class="num" id="3569246">17</span><span class="op" id="3569248">,</span>&nbsp;<span class="num" id="3569250">19</span><span class="op" id="3569252">,</span>&nbsp;<span class="num" id="3569254">23</span><span class="op" id="3569256">,</span>&nbsp;<span class="num" id="3569258">29</span><span class="op" id="3569260">,</span>&nbsp;<span class="num" id="3569262">31</span><span class="op" id="3569264">,</span>&nbsp;<span class="num" id="3569266">37</span><span class="op" id="3569268">,</span>&nbsp;<span class="num" id="3569270">41</span><span class="op" id="3569272">,</span>&nbsp;<span class="num" id="3569274">43</span><span class="op" id="3569276">,</span>&nbsp;<span class="num" id="3569278">47</span><span class="op" id="3569280">,</span>&nbsp;<span class="num" id="3569282">53</span><span class="op" id="3569284">,</span><br>
<span class="lineno">20</span><span class="op" id="3569286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3569289">//&nbsp;smallPrimesProduct&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;the&nbsp;values&nbsp;in&nbsp;smallPrimes&nbsp;and&nbsp;allows&nbsp;us</span><br>
<span class="lineno"></span><span class="comment" id="3569369">//&nbsp;to&nbsp;reduce&nbsp;a&nbsp;candidate&nbsp;prime&nbsp;by&nbsp;this&nbsp;number&nbsp;and&nbsp;then&nbsp;determine&nbsp;whether&nbsp;it&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3569447">//&nbsp;coprime&nbsp;to&nbsp;all&nbsp;the&nbsp;elements&nbsp;of&nbsp;smallPrimes&nbsp;without&nbsp;further&nbsp;big.Int</span><br>
<span class="lineno">25</span><span class="comment" id="3569517">//&nbsp;operations.</span><br>
<span class="lineno"></span><span class="keyword" id="3569532">var</span>&nbsp;<span class="ident" id="3569536">smallPrimesProduct</span>&nbsp;<span class="op" id="3569555">=</span>&nbsp;<span class="builtinfunc" id="3569557">new</span><span class="op" id="3569560">(</span><span class="ident" id="3569561">big</span><span class="op" id="3569564">.</span><span class="ident" id="3569565">Int</span><span class="op" id="3569568">)</span><span class="op" id="3569569">.</span><span class="ident" id="3569570">SetUint64</span><span class="op" id="3569579">(</span><span class="num" id="3569580">16294579238595022365</span><span class="op" id="3569600">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3569603">//&nbsp;Prime&nbsp;returns&nbsp;a&nbsp;number,&nbsp;p,&nbsp;of&nbsp;the&nbsp;given&nbsp;size,&nbsp;such&nbsp;that&nbsp;p&nbsp;is&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment" id="3569673">//&nbsp;with&nbsp;high&nbsp;probability.</span><br>
<span class="lineno">30</span><span class="comment" id="3569699">//&nbsp;Prime&nbsp;will&nbsp;return&nbsp;error&nbsp;for&nbsp;any&nbsp;error&nbsp;returned&nbsp;by&nbsp;rand.Read&nbsp;or&nbsp;if&nbsp;bits&nbsp;&lt;&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="3569778">func</span>&nbsp;<span class="ident" id="3569783">Prime</span><span class="op" id="3569788">(</span><span class="ident" id="3569789">rand</span>&nbsp;<span class="ident" id="3569794">io</span><span class="op" id="3569796">.</span><span class="ident" id="3569797">Reader</span><span class="op" id="3569803">,</span>&nbsp;<span class="ident" id="3569805">bits</span>&nbsp;<span class="builtintype" id="3569810">int</span><span class="op" id="3569813">)</span>&nbsp;<span class="op" id="3569815">(</span><span class="ident" id="3569816">p</span>&nbsp;<span class="op" id="3569818">*</span><span class="ident" id="3569819">big</span><span class="op" id="3569822">.</span><span class="ident" id="3569823">Int</span><span class="op" id="3569826">,</span>&nbsp;<span class="ident" id="3569828">err</span>&nbsp;<span class="builtintype" id="3569832">error</span><span class="op" id="3569837">)</span>&nbsp;<span class="op" id="3569839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3569842">if</span>&nbsp;<span class="ident" id="3569845">bits</span>&nbsp;<span class="op" id="3569850">&lt;</span>&nbsp;<span class="num" id="3569852">2</span>&nbsp;<span class="op" id="3569854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3569858">err</span>&nbsp;<span class="op" id="3569862">=</span>&nbsp;<span class="ident" id="3569864">errors</span><span class="op" id="3569870">.</span><span class="ident" id="3569871">New</span><span class="op" id="3569874">(</span><span class="string" id="3569875">&#34;crypto/rand:&nbsp;prime&nbsp;size&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;2-bit&#34;</span><span class="op" id="3569923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3569927">return</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3569935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3569939">b</span>&nbsp;<span class="op" id="3569941">:=</span>&nbsp;<span class="builtintype" id="3569944">uint</span><span class="op" id="3569948">(</span><span class="ident" id="3569949">bits</span>&nbsp;<span class="op" id="3569954">%</span>&nbsp;<span class="num" id="3569956">8</span><span class="op" id="3569957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3569960">if</span>&nbsp;<span class="ident" id="3569963">b</span>&nbsp;<span class="op" id="3569965">==</span>&nbsp;<span class="num" id="3569968">0</span>&nbsp;<span class="op" id="3569970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3569974">b</span>&nbsp;<span class="op" id="3569976">=</span>&nbsp;<span class="num" id="3569978">8</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3569981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3569985">bytes</span>&nbsp;<span class="op" id="3569991">:=</span>&nbsp;<span class="builtinfunc" id="3569994">make</span><span class="op" id="3569998">(</span><span class="op" id="3569999">[</span><span class="op" id="3570000">]</span><span class="builtintype" id="3570001">byte</span><span class="op" id="3570005">,</span>&nbsp;<span class="op" id="3570007">(</span><span class="ident" id="3570008">bits</span><span class="op" id="3570012">+</span><span class="num" id="3570013">7</span><span class="op" id="3570014">)</span><span class="op" id="3570015">/</span><span class="num" id="3570016">8</span><span class="op" id="3570017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570020">p</span>&nbsp;<span class="op" id="3570022">=</span>&nbsp;<span class="builtinfunc" id="3570024">new</span><span class="op" id="3570027">(</span><span class="ident" id="3570028">big</span><span class="op" id="3570031">.</span><span class="ident" id="3570032">Int</span><span class="op" id="3570035">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570039">bigMod</span>&nbsp;<span class="op" id="3570046">:=</span>&nbsp;<span class="builtinfunc" id="3570049">new</span><span class="op" id="3570052">(</span><span class="ident" id="3570053">big</span><span class="op" id="3570056">.</span><span class="ident" id="3570057">Int</span><span class="op" id="3570060">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570064">for</span>&nbsp;<span class="op" id="3570068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570072">_</span><span class="op" id="3570073">,</span>&nbsp;<span class="ident" id="3570075">err</span>&nbsp;<span class="op" id="3570079">=</span>&nbsp;<span class="ident" id="3570081">io</span><span class="op" id="3570083">.</span><span class="ident" id="3570084">ReadFull</span><span class="op" id="3570092">(</span><span class="ident" id="3570093">rand</span><span class="op" id="3570097">,</span>&nbsp;<span class="ident" id="3570099">bytes</span><span class="op" id="3570104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570108">if</span>&nbsp;<span class="ident" id="3570111">err</span>&nbsp;<span class="op" id="3570115">!=</span>&nbsp;<span class="ident" id="3570118">nil</span>&nbsp;<span class="op" id="3570122">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570127">return</span>&nbsp;<span class="ident" id="3570134">nil</span><span class="op" id="3570137">,</span>&nbsp;<span class="ident" id="3570139">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570150">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;candidate&nbsp;has&nbsp;a&nbsp;size&nbsp;&lt;=&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570231">bytes</span><span class="op" id="3570236">[</span><span class="num" id="3570237">0</span><span class="op" id="3570238">]</span>&nbsp;<span class="op" id="3570240">&amp;=</span>&nbsp;<span class="builtintype" id="3570243">uint8</span><span class="op" id="3570248">(</span><span class="builtintype" id="3570249">int</span><span class="op" id="3570252">(</span><span class="num" id="3570253">1</span><span class="op" id="3570254">&lt;&lt;</span><span class="ident" id="3570256">b</span><span class="op" id="3570257">)</span>&nbsp;<span class="op" id="3570259">-</span>&nbsp;<span class="num" id="3570261">1</span><span class="op" id="3570262">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570266">//&nbsp;Don&#39;t&nbsp;let&nbsp;the&nbsp;value&nbsp;be&nbsp;too&nbsp;small,&nbsp;i.e,&nbsp;set&nbsp;the&nbsp;most&nbsp;significant&nbsp;two&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570345">//&nbsp;Setting&nbsp;the&nbsp;top&nbsp;two&nbsp;bits,&nbsp;rather&nbsp;than&nbsp;just&nbsp;the&nbsp;top&nbsp;bit,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570406">//&nbsp;means&nbsp;that&nbsp;when&nbsp;two&nbsp;of&nbsp;these&nbsp;values&nbsp;are&nbsp;multiplied&nbsp;together,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570472">//&nbsp;the&nbsp;result&nbsp;isn&#39;t&nbsp;ever&nbsp;one&nbsp;bit&nbsp;short.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570514">if</span>&nbsp;<span class="ident" id="3570517">b</span>&nbsp;<span class="op" id="3570519">&gt;=</span>&nbsp;<span class="num" id="3570522">2</span>&nbsp;<span class="op" id="3570524">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570529">bytes</span><span class="op" id="3570534">[</span><span class="num" id="3570535">0</span><span class="op" id="3570536">]</span>&nbsp;<span class="op" id="3570538">|=</span>&nbsp;<span class="num" id="3570541">3</span>&nbsp;<span class="op" id="3570543">&lt;&lt;</span>&nbsp;<span class="op" id="3570546">(</span><span class="ident" id="3570547">b</span>&nbsp;<span class="op" id="3570549">-</span>&nbsp;<span class="num" id="3570551">2</span><span class="op" id="3570552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570556">}</span>&nbsp;<span class="keyword" id="3570558">else</span>&nbsp;<span class="op" id="3570563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570568">//&nbsp;Here&nbsp;b==1,&nbsp;because&nbsp;b&nbsp;cannot&nbsp;be&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570611">bytes</span><span class="op" id="3570616">[</span><span class="num" id="3570617">0</span><span class="op" id="3570618">]</span>&nbsp;<span class="op" id="3570620">|=</span>&nbsp;<span class="num" id="3570623">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3570628">if</span>&nbsp;<span class="builtinfunc" id="3570631">len</span><span class="op" id="3570634">(</span><span class="ident" id="3570635">bytes</span><span class="op" id="3570640">)</span>&nbsp;<span class="op" id="3570642">&gt;</span>&nbsp;<span class="num" id="3570644">1</span>&nbsp;<span class="op" id="3570646">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570652">bytes</span><span class="op" id="3570657">[</span><span class="num" id="3570658">1</span><span class="op" id="3570659">]</span>&nbsp;<span class="op" id="3570661">|=</span>&nbsp;<span class="num" id="3570664">0x80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3570676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570680">//&nbsp;Make&nbsp;the&nbsp;value&nbsp;odd&nbsp;since&nbsp;an&nbsp;even&nbsp;number&nbsp;this&nbsp;large&nbsp;certainly&nbsp;isn&#39;t&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570759">bytes</span><span class="op" id="3570764">[</span><span class="builtinfunc" id="3570765">len</span><span class="op" id="3570768">(</span><span class="ident" id="3570769">bytes</span><span class="op" id="3570774">)</span><span class="op" id="3570775">-</span><span class="num" id="3570776">1</span><span class="op" id="3570777">]</span>&nbsp;<span class="op" id="3570779">|=</span>&nbsp;<span class="num" id="3570782">1</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3570787">p</span><span class="op" id="3570788">.</span><span class="ident" id="3570789">SetBytes</span><span class="op" id="3570797">(</span><span class="ident" id="3570798">bytes</span><span class="op" id="3570803">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570808">//&nbsp;Calculate&nbsp;the&nbsp;value&nbsp;mod&nbsp;the&nbsp;product&nbsp;of&nbsp;smallPrimes.&nbsp;&nbsp;If&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570874">//&nbsp;a&nbsp;multiple&nbsp;of&nbsp;any&nbsp;of&nbsp;these&nbsp;primes&nbsp;we&nbsp;add&nbsp;two&nbsp;until&nbsp;it&nbsp;isn&#39;t.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3570940">//&nbsp;The&nbsp;probability&nbsp;of&nbsp;overflowing&nbsp;is&nbsp;minimal&nbsp;and&nbsp;can&nbsp;be&nbsp;ignored</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571006">//&nbsp;because&nbsp;we&nbsp;still&nbsp;perform&nbsp;Miller-Rabin&nbsp;tests&nbsp;on&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571070">bigMod</span><span class="op" id="3571076">.</span><span class="ident" id="3571077">Mod</span><span class="op" id="3571080">(</span><span class="ident" id="3571081">p</span><span class="op" id="3571082">,</span>&nbsp;<span class="ident" id="3571084">smallPrimesProduct</span><span class="op" id="3571102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571106">mod</span>&nbsp;<span class="op" id="3571110">:=</span>&nbsp;<span class="ident" id="3571113">bigMod</span><span class="op" id="3571119">.</span><span class="ident" id="3571120">Uint64</span><span class="op" id="3571126">(</span><span class="op" id="3571127">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571131">NextDelta</span><span class="op" id="3571140">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571144">for</span>&nbsp;<span class="ident" id="3571148">delta</span>&nbsp;<span class="op" id="3571154">:=</span>&nbsp;<span class="ident" id="3571157">uint64</span><span class="op" id="3571163">(</span><span class="num" id="3571164">0</span><span class="op" id="3571165">)</span><span class="op" id="3571166">;</span>&nbsp;<span class="ident" id="3571168">delta</span>&nbsp;<span class="op" id="3571174">&lt;</span>&nbsp;<span class="num" id="3571176">1</span><span class="op" id="3571177">&lt;&lt;</span><span class="num" id="3571179">20</span><span class="op" id="3571181">;</span>&nbsp;<span class="ident" id="3571183">delta</span>&nbsp;<span class="op" id="3571189">+=</span>&nbsp;<span class="num" id="3571192">2</span>&nbsp;<span class="op" id="3571194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571199">m</span>&nbsp;<span class="op" id="3571201">:=</span>&nbsp;<span class="ident" id="3571204">mod</span>&nbsp;<span class="op" id="3571208">+</span>&nbsp;<span class="ident" id="3571210">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571219">for</span>&nbsp;<span class="ident" id="3571223">_</span><span class="op" id="3571224">,</span>&nbsp;<span class="ident" id="3571226">prime</span>&nbsp;<span class="op" id="3571232">:=</span>&nbsp;<span class="keyword" id="3571235">range</span>&nbsp;<span class="ident" id="3571241">smallPrimes</span>&nbsp;<span class="op" id="3571253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571259">if</span>&nbsp;<span class="ident" id="3571262">m</span><span class="op" id="3571263">%</span><span class="ident" id="3571264">uint64</span><span class="op" id="3571270">(</span><span class="ident" id="3571271">prime</span><span class="op" id="3571276">)</span>&nbsp;<span class="op" id="3571278">==</span>&nbsp;<span class="num" id="3571281">0</span>&nbsp;<span class="op" id="3571283">&amp;&amp;</span>&nbsp;<span class="op" id="3571286">(</span><span class="ident" id="3571287">bits</span>&nbsp;<span class="op" id="3571292">&gt;</span>&nbsp;<span class="num" id="3571294">6</span>&nbsp;<span class="op" id="3571296">||</span>&nbsp;<span class="ident" id="3571299">m</span>&nbsp;<span class="op" id="3571301">!=</span>&nbsp;<span class="ident" id="3571304">uint64</span><span class="op" id="3571310">(</span><span class="ident" id="3571311">prime</span><span class="op" id="3571316">)</span><span class="op" id="3571317">)</span>&nbsp;<span class="op" id="3571319">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571326">continue</span>&nbsp;<span class="ident" id="3571335">NextDelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571360">if</span>&nbsp;<span class="ident" id="3571363">delta</span>&nbsp;<span class="op" id="3571369">&gt;</span>&nbsp;<span class="num" id="3571371">0</span>&nbsp;<span class="op" id="3571373">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571379">bigMod</span><span class="op" id="3571385">.</span><span class="ident" id="3571386">SetUint64</span><span class="op" id="3571395">(</span><span class="ident" id="3571396">delta</span><span class="op" id="3571401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571407">p</span><span class="op" id="3571408">.</span><span class="ident" id="3571409">Add</span><span class="op" id="3571412">(</span><span class="ident" id="3571413">p</span><span class="op" id="3571414">,</span>&nbsp;<span class="ident" id="3571416">bigMod</span><span class="op" id="3571422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571432">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571440">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571445">//&nbsp;There&nbsp;is&nbsp;a&nbsp;tiny&nbsp;possibility&nbsp;that,&nbsp;by&nbsp;adding&nbsp;delta,&nbsp;we&nbsp;caused</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571511">//&nbsp;the&nbsp;number&nbsp;to&nbsp;be&nbsp;one&nbsp;bit&nbsp;too&nbsp;long.&nbsp;Thus&nbsp;we&nbsp;check&nbsp;BitLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571572">//&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571583">if</span>&nbsp;<span class="ident" id="3571586">p</span><span class="op" id="3571587">.</span><span class="ident" id="3571588">ProbablyPrime</span><span class="op" id="3571601">(</span><span class="num" id="3571602">20</span><span class="op" id="3571604">)</span>&nbsp;<span class="op" id="3571606">&amp;&amp;</span>&nbsp;<span class="ident" id="3571609">p</span><span class="op" id="3571610">.</span><span class="ident" id="3571611">BitLen</span><span class="op" id="3571617">(</span><span class="op" id="3571618">)</span>&nbsp;<span class="op" id="3571620">==</span>&nbsp;<span class="ident" id="3571623">bits</span>&nbsp;<span class="op" id="3571628">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571633">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571645">}</span><br>
<span class="lineno"></span><span class="op" id="3571647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="3571650">//&nbsp;Int&nbsp;returns&nbsp;a&nbsp;uniform&nbsp;random&nbsp;value&nbsp;in&nbsp;[0,&nbsp;max).&nbsp;It&nbsp;panics&nbsp;if&nbsp;max&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3571724">func</span>&nbsp;<span class="ident" id="3571729">Int</span><span class="op" id="3571732">(</span><span class="ident" id="3571733">rand</span>&nbsp;<span class="ident" id="3571738">io</span><span class="op" id="3571740">.</span><span class="ident" id="3571741">Reader</span><span class="op" id="3571747">,</span>&nbsp;<span class="ident" id="3571749">max</span>&nbsp;<span class="op" id="3571753">*</span><span class="ident" id="3571754">big</span><span class="op" id="3571757">.</span><span class="ident" id="3571758">Int</span><span class="op" id="3571761">)</span>&nbsp;<span class="op" id="3571763">(</span><span class="ident" id="3571764">n</span>&nbsp;<span class="op" id="3571766">*</span><span class="ident" id="3571767">big</span><span class="op" id="3571770">.</span><span class="ident" id="3571771">Int</span><span class="op" id="3571774">,</span>&nbsp;<span class="ident" id="3571776">err</span>&nbsp;<span class="builtintype" id="3571780">error</span><span class="op" id="3571785">)</span>&nbsp;<span class="op" id="3571787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571790">if</span>&nbsp;<span class="ident" id="3571793">max</span><span class="op" id="3571796">.</span><span class="ident" id="3571797">Sign</span><span class="op" id="3571801">(</span><span class="op" id="3571802">)</span>&nbsp;<span class="op" id="3571804">&lt;=</span>&nbsp;<span class="num" id="3571807">0</span>&nbsp;<span class="op" id="3571809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3571813">panic</span><span class="op" id="3571818">(</span><span class="string" id="3571819">&#34;crypto/rand:&nbsp;argument&nbsp;to&nbsp;Int&nbsp;is&nbsp;&lt;=&nbsp;0&#34;</span><span class="op" id="3571857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3571860">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571863">k</span>&nbsp;<span class="op" id="3571865">:=</span>&nbsp;<span class="op" id="3571868">(</span><span class="ident" id="3571869">max</span><span class="op" id="3571872">.</span><span class="ident" id="3571873">BitLen</span><span class="op" id="3571879">(</span><span class="op" id="3571880">)</span>&nbsp;<span class="op" id="3571882">+</span>&nbsp;<span class="num" id="3571884">7</span><span class="op" id="3571885">)</span>&nbsp;<span class="op" id="3571887">/</span>&nbsp;<span class="num" id="3571889">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3571893">//&nbsp;b&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;the&nbsp;most&nbsp;significant&nbsp;byte&nbsp;of&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3571958">b</span>&nbsp;<span class="op" id="3571960">:=</span>&nbsp;<span class="builtintype" id="3571963">uint</span><span class="op" id="3571967">(</span><span class="ident" id="3571968">max</span><span class="op" id="3571971">.</span><span class="ident" id="3571972">BitLen</span><span class="op" id="3571978">(</span><span class="op" id="3571979">)</span>&nbsp;<span class="op" id="3571981">%</span>&nbsp;<span class="num" id="3571983">8</span><span class="op" id="3571984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3571987">if</span>&nbsp;<span class="ident" id="3571990">b</span>&nbsp;<span class="op" id="3571992">==</span>&nbsp;<span class="num" id="3571995">0</span>&nbsp;<span class="op" id="3571997">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3572001">b</span>&nbsp;<span class="op" id="3572003">=</span>&nbsp;<span class="num" id="3572005">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3572008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3572012">bytes</span>&nbsp;<span class="op" id="3572018">:=</span>&nbsp;<span class="builtinfunc" id="3572021">make</span><span class="op" id="3572025">(</span><span class="op" id="3572026">[</span><span class="op" id="3572027">]</span><span class="builtintype" id="3572028">byte</span><span class="op" id="3572032">,</span>&nbsp;<span class="ident" id="3572034">k</span><span class="op" id="3572035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3572038">n</span>&nbsp;<span class="op" id="3572040">=</span>&nbsp;<span class="builtinfunc" id="3572042">new</span><span class="op" id="3572045">(</span><span class="ident" id="3572046">big</span><span class="op" id="3572049">.</span><span class="ident" id="3572050">Int</span><span class="op" id="3572053">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3572057">for</span>&nbsp;<span class="op" id="3572061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3572065">_</span><span class="op" id="3572066">,</span>&nbsp;<span class="ident" id="3572068">err</span>&nbsp;<span class="op" id="3572072">=</span>&nbsp;<span class="ident" id="3572074">io</span><span class="op" id="3572076">.</span><span class="ident" id="3572077">ReadFull</span><span class="op" id="3572085">(</span><span class="ident" id="3572086">rand</span><span class="op" id="3572090">,</span>&nbsp;<span class="ident" id="3572092">bytes</span><span class="op" id="3572097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3572101">if</span>&nbsp;<span class="ident" id="3572104">err</span>&nbsp;<span class="op" id="3572108">!=</span>&nbsp;<span class="ident" id="3572111">nil</span>&nbsp;<span class="op" id="3572115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3572120">return</span>&nbsp;<span class="ident" id="3572127">nil</span><span class="op" id="3572130">,</span>&nbsp;<span class="ident" id="3572132">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3572138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3572143">//&nbsp;Clear&nbsp;bits&nbsp;in&nbsp;the&nbsp;first&nbsp;byte&nbsp;to&nbsp;increase&nbsp;the&nbsp;probability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3572205">//&nbsp;that&nbsp;the&nbsp;candidate&nbsp;is&nbsp;&lt;&nbsp;max.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3572239">bytes</span><span class="op" id="3572244">[</span><span class="num" id="3572245">0</span><span class="op" id="3572246">]</span>&nbsp;<span class="op" id="3572248">&amp;=</span>&nbsp;<span class="builtintype" id="3572251">uint8</span><span class="op" id="3572256">(</span><span class="builtintype" id="3572257">int</span><span class="op" id="3572260">(</span><span class="num" id="3572261">1</span><span class="op" id="3572262">&lt;&lt;</span><span class="ident" id="3572264">b</span><span class="op" id="3572265">)</span>&nbsp;<span class="op" id="3572267">-</span>&nbsp;<span class="num" id="3572269">1</span><span class="op" id="3572270">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3572275">n</span><span class="op" id="3572276">.</span><span class="ident" id="3572277">SetBytes</span><span class="op" id="3572285">(</span><span class="ident" id="3572286">bytes</span><span class="op" id="3572291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3572295">if</span>&nbsp;<span class="ident" id="3572298">n</span><span class="op" id="3572299">.</span><span class="ident" id="3572300">Cmp</span><span class="op" id="3572303">(</span><span class="ident" id="3572304">max</span><span class="op" id="3572307">)</span>&nbsp;<span class="op" id="3572309">&lt;</span>&nbsp;<span class="num" id="3572311">0</span>&nbsp;<span class="op" id="3572313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3572318">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3572327">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3572330">}</span><br>
<span class="lineno"></span><span class="op" id="3572332">}</span>
</div>
</body>
</html>
