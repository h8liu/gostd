<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6035577">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6035632">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6035686">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6035737">package</span>&nbsp;<span class="ident" id="6035745">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6035751">import</span>&nbsp;<span class="op" id="6035758">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6035761">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6035766">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="6035769">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="6035847">const</span>&nbsp;<span class="ident" id="6035853">maxCodeLength</span>&nbsp;<span class="op" id="6035867">=</span>&nbsp;<span class="num" id="6035869">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6035873">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="6035948">const</span>&nbsp;<span class="ident" id="6035954">maxNCodes</span>&nbsp;<span class="op" id="6035964">=</span>&nbsp;<span class="num" id="6035966">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6035971">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="6036040">const</span>&nbsp;<span class="ident" id="6036046">lutSize</span>&nbsp;<span class="op" id="6036054">=</span>&nbsp;<span class="num" id="6036056">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6036059">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="6036116">type</span>&nbsp;<span class="ident" id="6036121">huffman</span>&nbsp;<span class="keyword" id="6036129">struct</span>&nbsp;<span class="op" id="6036136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036139">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036186">nCodes</span>&nbsp;<span class="builtintype" id="6036193">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036200">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036274">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036346">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036419">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036437">lut</span>&nbsp;<span class="op" id="6036441">[</span><span class="num" id="6036442">1</span>&nbsp;<span class="op" id="6036444">&lt;&lt;</span>&nbsp;<span class="ident" id="6036447">lutSize</span><span class="op" id="6036454">]</span><span class="builtintype" id="6036455">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036463">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036522">vals</span>&nbsp;<span class="op" id="6036527">[</span><span class="ident" id="6036528">maxNCodes</span><span class="op" id="6036537">]</span><span class="builtintype" id="6036538">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036545">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036616">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036642">minCodes</span>&nbsp;<span class="op" id="6036651">[</span><span class="ident" id="6036652">maxCodeLength</span><span class="op" id="6036665">]</span><span class="builtintype" id="6036666">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036673">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036744">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036770">maxCodes</span>&nbsp;<span class="op" id="6036779">[</span><span class="ident" id="6036780">maxCodeLength</span><span class="op" id="6036793">]</span><span class="builtintype" id="6036794">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036801">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036859">valsIndices</span>&nbsp;<span class="op" id="6036871">[</span><span class="ident" id="6036872">maxCodeLength</span><span class="op" id="6036885">]</span><span class="builtintype" id="6036886">int32</span><br>
<span class="lineno"></span><span class="op" id="6036892">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="6036895">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="6036971">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6036988">var</span>&nbsp;<span class="ident" id="6036992">errShortHuffmanData</span>&nbsp;<span class="op" id="6037012">=</span>&nbsp;<span class="ident" id="6037014">FormatError</span><span class="op" id="6037025">(</span><span class="string" id="6037026">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="6037046">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6037049">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6037127">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="6037204">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="6037279">func</span>&nbsp;<span class="op" id="6037284">(</span><span class="ident" id="6037285">d</span>&nbsp;<span class="op" id="6037287">*</span><span class="ident" id="6037288">decoder</span><span class="op" id="6037295">)</span>&nbsp;<span class="ident" id="6037297">ensureNBits</span><span class="op" id="6037308">(</span><span class="ident" id="6037309">n</span>&nbsp;<span class="builtintype" id="6037311">int32</span><span class="op" id="6037316">)</span>&nbsp;<span class="builtintype" id="6037318">error</span>&nbsp;<span class="op" id="6037324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037327">for</span>&nbsp;<span class="op" id="6037331">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037335">c</span><span class="op" id="6037336">,</span>&nbsp;<span class="ident" id="6037338">err</span>&nbsp;<span class="op" id="6037342">:=</span>&nbsp;<span class="ident" id="6037345">d</span><span class="op" id="6037346">.</span><span class="ident" id="6037347">readByteStuffedByte</span><span class="op" id="6037366">(</span><span class="op" id="6037367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037371">if</span>&nbsp;<span class="ident" id="6037374">err</span>&nbsp;<span class="op" id="6037378">!=</span>&nbsp;<span class="ident" id="6037381">nil</span>&nbsp;<span class="op" id="6037385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037390">if</span>&nbsp;<span class="ident" id="6037393">err</span>&nbsp;<span class="op" id="6037397">==</span>&nbsp;<span class="ident" id="6037400">io</span><span class="op" id="6037402">.</span><span class="ident" id="6037403">EOF</span>&nbsp;<span class="op" id="6037407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037413">return</span>&nbsp;<span class="ident" id="6037420">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037443">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037448">return</span>&nbsp;<span class="ident" id="6037455">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037465">d</span><span class="op" id="6037466">.</span><span class="ident" id="6037467">bits</span><span class="op" id="6037471">.</span><span class="ident" id="6037472">a</span>&nbsp;<span class="op" id="6037474">=</span>&nbsp;<span class="ident" id="6037476">d</span><span class="op" id="6037477">.</span><span class="ident" id="6037478">bits</span><span class="op" id="6037482">.</span><span class="ident" id="6037483">a</span><span class="op" id="6037484">&lt;&lt;</span><span class="num" id="6037486">8</span>&nbsp;<span class="op" id="6037488">|</span>&nbsp;<span class="builtintype" id="6037490">uint32</span><span class="op" id="6037496">(</span><span class="ident" id="6037497">c</span><span class="op" id="6037498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037502">d</span><span class="op" id="6037503">.</span><span class="ident" id="6037504">bits</span><span class="op" id="6037508">.</span><span class="ident" id="6037509">n</span>&nbsp;<span class="op" id="6037511">+=</span>&nbsp;<span class="num" id="6037514">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037518">if</span>&nbsp;<span class="ident" id="6037521">d</span><span class="op" id="6037522">.</span><span class="ident" id="6037523">bits</span><span class="op" id="6037527">.</span><span class="ident" id="6037528">m</span>&nbsp;<span class="op" id="6037530">==</span>&nbsp;<span class="num" id="6037533">0</span>&nbsp;<span class="op" id="6037535">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037540">d</span><span class="op" id="6037541">.</span><span class="ident" id="6037542">bits</span><span class="op" id="6037546">.</span><span class="ident" id="6037547">m</span>&nbsp;<span class="op" id="6037549">=</span>&nbsp;<span class="num" id="6037551">1</span>&nbsp;<span class="op" id="6037553">&lt;&lt;</span>&nbsp;<span class="num" id="6037556">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037560">}</span>&nbsp;<span class="keyword" id="6037562">else</span>&nbsp;<span class="op" id="6037567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037572">d</span><span class="op" id="6037573">.</span><span class="ident" id="6037574">bits</span><span class="op" id="6037578">.</span><span class="ident" id="6037579">m</span>&nbsp;<span class="op" id="6037581">&lt;&lt;=</span>&nbsp;<span class="num" id="6037585">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037593">if</span>&nbsp;<span class="ident" id="6037596">d</span><span class="op" id="6037597">.</span><span class="ident" id="6037598">bits</span><span class="op" id="6037602">.</span><span class="ident" id="6037603">n</span>&nbsp;<span class="op" id="6037605">&gt;=</span>&nbsp;<span class="ident" id="6037608">n</span>&nbsp;<span class="op" id="6037610">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037615">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037629">return</span>&nbsp;<span class="ident" id="6037636">nil</span><br>
<span class="lineno"></span><span class="op" id="6037640">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="6037643">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="6037723">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="6037735">func</span>&nbsp;<span class="op" id="6037740">(</span><span class="ident" id="6037741">d</span>&nbsp;<span class="op" id="6037743">*</span><span class="ident" id="6037744">decoder</span><span class="op" id="6037751">)</span>&nbsp;<span class="ident" id="6037753">receiveExtend</span><span class="op" id="6037766">(</span><span class="ident" id="6037767">t</span>&nbsp;<span class="builtintype" id="6037769">uint8</span><span class="op" id="6037774">)</span>&nbsp;<span class="op" id="6037776">(</span><span class="builtintype" id="6037777">int32</span><span class="op" id="6037782">,</span>&nbsp;<span class="builtintype" id="6037784">error</span><span class="op" id="6037789">)</span>&nbsp;<span class="op" id="6037791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037794">if</span>&nbsp;<span class="ident" id="6037797">d</span><span class="op" id="6037798">.</span><span class="ident" id="6037799">bits</span><span class="op" id="6037803">.</span><span class="ident" id="6037804">n</span>&nbsp;<span class="op" id="6037806">&lt;</span>&nbsp;<span class="builtintype" id="6037808">int32</span><span class="op" id="6037813">(</span><span class="ident" id="6037814">t</span><span class="op" id="6037815">)</span>&nbsp;<span class="op" id="6037817">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037821">if</span>&nbsp;<span class="ident" id="6037824">err</span>&nbsp;<span class="op" id="6037828">:=</span>&nbsp;<span class="ident" id="6037831">d</span><span class="op" id="6037832">.</span><span class="ident" id="6037833">ensureNBits</span><span class="op" id="6037844">(</span><span class="builtintype" id="6037845">int32</span><span class="op" id="6037850">(</span><span class="ident" id="6037851">t</span><span class="op" id="6037852">)</span><span class="op" id="6037853">)</span><span class="op" id="6037854">;</span>&nbsp;<span class="ident" id="6037856">err</span>&nbsp;<span class="op" id="6037860">!=</span>&nbsp;<span class="ident" id="6037863">nil</span>&nbsp;<span class="op" id="6037867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037872">return</span>&nbsp;<span class="num" id="6037879">0</span><span class="op" id="6037880">,</span>&nbsp;<span class="ident" id="6037882">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037894">d</span><span class="op" id="6037895">.</span><span class="ident" id="6037896">bits</span><span class="op" id="6037900">.</span><span class="ident" id="6037901">n</span>&nbsp;<span class="op" id="6037903">-=</span>&nbsp;<span class="builtintype" id="6037906">int32</span><span class="op" id="6037911">(</span><span class="ident" id="6037912">t</span><span class="op" id="6037913">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037916">d</span><span class="op" id="6037917">.</span><span class="ident" id="6037918">bits</span><span class="op" id="6037922">.</span><span class="ident" id="6037923">m</span>&nbsp;<span class="op" id="6037925">&gt;&gt;=</span>&nbsp;<span class="ident" id="6037929">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037932">s</span>&nbsp;<span class="op" id="6037934">:=</span>&nbsp;<span class="builtintype" id="6037937">int32</span><span class="op" id="6037942">(</span><span class="num" id="6037943">1</span><span class="op" id="6037944">)</span>&nbsp;<span class="op" id="6037946">&lt;&lt;</span>&nbsp;<span class="ident" id="6037949">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037952">x</span>&nbsp;<span class="op" id="6037954">:=</span>&nbsp;<span class="builtintype" id="6037957">int32</span><span class="op" id="6037962">(</span><span class="ident" id="6037963">d</span><span class="op" id="6037964">.</span><span class="ident" id="6037965">bits</span><span class="op" id="6037969">.</span><span class="ident" id="6037970">a</span><span class="op" id="6037971">&gt;&gt;</span><span class="builtintype" id="6037973">uint8</span><span class="op" id="6037978">(</span><span class="ident" id="6037979">d</span><span class="op" id="6037980">.</span><span class="ident" id="6037981">bits</span><span class="op" id="6037985">.</span><span class="ident" id="6037986">n</span><span class="op" id="6037987">)</span><span class="op" id="6037988">)</span>&nbsp;<span class="op" id="6037990">&amp;</span>&nbsp;<span class="op" id="6037992">(</span><span class="ident" id="6037993">s</span>&nbsp;<span class="op" id="6037995">-</span>&nbsp;<span class="num" id="6037997">1</span><span class="op" id="6037998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038001">if</span>&nbsp;<span class="ident" id="6038004">x</span>&nbsp;<span class="op" id="6038006">&lt;</span>&nbsp;<span class="ident" id="6038008">s</span><span class="op" id="6038009">&gt;&gt;</span><span class="num" id="6038011">1</span>&nbsp;<span class="op" id="6038013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038017">x</span>&nbsp;<span class="op" id="6038019">+=</span>&nbsp;<span class="op" id="6038022">(</span><span class="op" id="6038023">(</span><span class="op" id="6038024">-</span><span class="num" id="6038025">1</span><span class="op" id="6038026">)</span>&nbsp;<span class="op" id="6038028">&lt;&lt;</span>&nbsp;<span class="ident" id="6038031">t</span><span class="op" id="6038032">)</span>&nbsp;<span class="op" id="6038034">+</span>&nbsp;<span class="num" id="6038036">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038042">return</span>&nbsp;<span class="ident" id="6038049">x</span><span class="op" id="6038050">,</span>&nbsp;<span class="ident" id="6038052">nil</span><br>
<span class="lineno"></span><span class="op" id="6038056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6038059">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="6038140">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="6038199">func</span>&nbsp;<span class="op" id="6038204">(</span><span class="ident" id="6038205">d</span>&nbsp;<span class="op" id="6038207">*</span><span class="ident" id="6038208">decoder</span><span class="op" id="6038215">)</span>&nbsp;<span class="ident" id="6038217">processDHT</span><span class="op" id="6038227">(</span><span class="ident" id="6038228">n</span>&nbsp;<span class="builtintype" id="6038230">int</span><span class="op" id="6038233">)</span>&nbsp;<span class="builtintype" id="6038235">error</span>&nbsp;<span class="op" id="6038241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038244">for</span>&nbsp;<span class="ident" id="6038248">n</span>&nbsp;<span class="op" id="6038250">&gt;</span>&nbsp;<span class="num" id="6038252">0</span>&nbsp;<span class="op" id="6038254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038258">if</span>&nbsp;<span class="ident" id="6038261">n</span>&nbsp;<span class="op" id="6038263">&lt;</span>&nbsp;<span class="num" id="6038265">17</span>&nbsp;<span class="op" id="6038268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038273">return</span>&nbsp;<span class="ident" id="6038280">FormatError</span><span class="op" id="6038291">(</span><span class="string" id="6038292">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6038314">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038322">if</span>&nbsp;<span class="ident" id="6038325">err</span>&nbsp;<span class="op" id="6038329">:=</span>&nbsp;<span class="ident" id="6038332">d</span><span class="op" id="6038333">.</span><span class="ident" id="6038334">readFull</span><span class="op" id="6038342">(</span><span class="ident" id="6038343">d</span><span class="op" id="6038344">.</span><span class="ident" id="6038345">tmp</span><span class="op" id="6038348">[</span><span class="op" id="6038349">:</span><span class="num" id="6038350">17</span><span class="op" id="6038352">]</span><span class="op" id="6038353">)</span><span class="op" id="6038354">;</span>&nbsp;<span class="ident" id="6038356">err</span>&nbsp;<span class="op" id="6038360">!=</span>&nbsp;<span class="ident" id="6038363">nil</span>&nbsp;<span class="op" id="6038367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038372">return</span>&nbsp;<span class="ident" id="6038379">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038389">tc</span>&nbsp;<span class="op" id="6038392">:=</span>&nbsp;<span class="ident" id="6038395">d</span><span class="op" id="6038396">.</span><span class="ident" id="6038397">tmp</span><span class="op" id="6038400">[</span><span class="num" id="6038401">0</span><span class="op" id="6038402">]</span>&nbsp;<span class="op" id="6038404">&gt;&gt;</span>&nbsp;<span class="num" id="6038407">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038411">if</span>&nbsp;<span class="ident" id="6038414">tc</span>&nbsp;<span class="op" id="6038417">&gt;</span>&nbsp;<span class="ident" id="6038419">maxTc</span>&nbsp;<span class="op" id="6038425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038430">return</span>&nbsp;<span class="ident" id="6038437">FormatError</span><span class="op" id="6038448">(</span><span class="string" id="6038449">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="6038463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038471">th</span>&nbsp;<span class="op" id="6038474">:=</span>&nbsp;<span class="ident" id="6038477">d</span><span class="op" id="6038478">.</span><span class="ident" id="6038479">tmp</span><span class="op" id="6038482">[</span><span class="num" id="6038483">0</span><span class="op" id="6038484">]</span>&nbsp;<span class="op" id="6038486">&amp;</span>&nbsp;<span class="num" id="6038488">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038495">if</span>&nbsp;<span class="ident" id="6038498">th</span>&nbsp;<span class="op" id="6038501">&gt;</span>&nbsp;<span class="ident" id="6038503">maxTh</span>&nbsp;<span class="op" id="6038509">||</span>&nbsp;<span class="op" id="6038512">!</span><span class="ident" id="6038513">d</span><span class="op" id="6038514">.</span><span class="ident" id="6038515">progressive</span>&nbsp;<span class="op" id="6038527">&amp;&amp;</span>&nbsp;<span class="ident" id="6038530">th</span>&nbsp;<span class="op" id="6038533">&gt;</span>&nbsp;<span class="num" id="6038535">1</span>&nbsp;<span class="op" id="6038537">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038542">return</span>&nbsp;<span class="ident" id="6038549">FormatError</span><span class="op" id="6038560">(</span><span class="string" id="6038561">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="6038575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038583">h</span>&nbsp;<span class="op" id="6038585">:=</span>&nbsp;<span class="op" id="6038588">&amp;</span><span class="ident" id="6038589">d</span><span class="op" id="6038590">.</span><span class="ident" id="6038591">huff</span><span class="op" id="6038595">[</span><span class="ident" id="6038596">tc</span><span class="op" id="6038598">]</span><span class="op" id="6038599">[</span><span class="ident" id="6038600">th</span><span class="op" id="6038602">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6038607">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6038658">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6038716">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038760">h</span><span class="op" id="6038761">.</span><span class="ident" id="6038762">nCodes</span>&nbsp;<span class="op" id="6038769">=</span>&nbsp;<span class="num" id="6038771">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038775">var</span>&nbsp;<span class="ident" id="6038779">nCodes</span>&nbsp;<span class="op" id="6038786">[</span><span class="ident" id="6038787">maxCodeLength</span><span class="op" id="6038800">]</span><span class="builtintype" id="6038801">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038809">for</span>&nbsp;<span class="ident" id="6038813">i</span>&nbsp;<span class="op" id="6038815">:=</span>&nbsp;<span class="keyword" id="6038818">range</span>&nbsp;<span class="ident" id="6038824">nCodes</span>&nbsp;<span class="op" id="6038831">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038836">nCodes</span><span class="op" id="6038842">[</span><span class="ident" id="6038843">i</span><span class="op" id="6038844">]</span>&nbsp;<span class="op" id="6038846">=</span>&nbsp;<span class="builtintype" id="6038848">int32</span><span class="op" id="6038853">(</span><span class="ident" id="6038854">d</span><span class="op" id="6038855">.</span><span class="ident" id="6038856">tmp</span><span class="op" id="6038859">[</span><span class="ident" id="6038860">i</span><span class="op" id="6038861">+</span><span class="num" id="6038862">1</span><span class="op" id="6038863">]</span><span class="op" id="6038864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038869">h</span><span class="op" id="6038870">.</span><span class="ident" id="6038871">nCodes</span>&nbsp;<span class="op" id="6038878">+=</span>&nbsp;<span class="ident" id="6038881">nCodes</span><span class="op" id="6038887">[</span><span class="ident" id="6038888">i</span><span class="op" id="6038889">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038897">if</span>&nbsp;<span class="ident" id="6038900">h</span><span class="op" id="6038901">.</span><span class="ident" id="6038902">nCodes</span>&nbsp;<span class="op" id="6038909">==</span>&nbsp;<span class="num" id="6038912">0</span>&nbsp;<span class="op" id="6038914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038919">return</span>&nbsp;<span class="ident" id="6038926">FormatError</span><span class="op" id="6038937">(</span><span class="string" id="6038938">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="6038969">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038977">if</span>&nbsp;<span class="ident" id="6038980">h</span><span class="op" id="6038981">.</span><span class="ident" id="6038982">nCodes</span>&nbsp;<span class="op" id="6038989">&gt;</span>&nbsp;<span class="ident" id="6038991">maxNCodes</span>&nbsp;<span class="op" id="6039001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039006">return</span>&nbsp;<span class="ident" id="6039013">FormatError</span><span class="op" id="6039024">(</span><span class="string" id="6039025">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="6039061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039069">n</span>&nbsp;<span class="op" id="6039071">-=</span>&nbsp;<span class="builtintype" id="6039074">int</span><span class="op" id="6039077">(</span><span class="ident" id="6039078">h</span><span class="op" id="6039079">.</span><span class="ident" id="6039080">nCodes</span><span class="op" id="6039086">)</span>&nbsp;<span class="op" id="6039088">+</span>&nbsp;<span class="num" id="6039090">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039095">if</span>&nbsp;<span class="ident" id="6039098">n</span>&nbsp;<span class="op" id="6039100">&lt;</span>&nbsp;<span class="num" id="6039102">0</span>&nbsp;<span class="op" id="6039104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039109">return</span>&nbsp;<span class="ident" id="6039116">FormatError</span><span class="op" id="6039127">(</span><span class="string" id="6039128">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6039150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039158">if</span>&nbsp;<span class="ident" id="6039161">err</span>&nbsp;<span class="op" id="6039165">:=</span>&nbsp;<span class="ident" id="6039168">d</span><span class="op" id="6039169">.</span><span class="ident" id="6039170">readFull</span><span class="op" id="6039178">(</span><span class="ident" id="6039179">h</span><span class="op" id="6039180">.</span><span class="ident" id="6039181">vals</span><span class="op" id="6039185">[</span><span class="op" id="6039186">:</span><span class="ident" id="6039187">h</span><span class="op" id="6039188">.</span><span class="ident" id="6039189">nCodes</span><span class="op" id="6039195">]</span><span class="op" id="6039196">)</span><span class="op" id="6039197">;</span>&nbsp;<span class="ident" id="6039199">err</span>&nbsp;<span class="op" id="6039203">!=</span>&nbsp;<span class="ident" id="6039206">nil</span>&nbsp;<span class="op" id="6039210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039215">return</span>&nbsp;<span class="ident" id="6039222">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039233">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039264">for</span>&nbsp;<span class="ident" id="6039268">i</span>&nbsp;<span class="op" id="6039270">:=</span>&nbsp;<span class="keyword" id="6039273">range</span>&nbsp;<span class="ident" id="6039279">h</span><span class="op" id="6039280">.</span><span class="ident" id="6039281">lut</span>&nbsp;<span class="op" id="6039285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039290">h</span><span class="op" id="6039291">.</span><span class="ident" id="6039292">lut</span><span class="op" id="6039295">[</span><span class="ident" id="6039296">i</span><span class="op" id="6039297">]</span>&nbsp;<span class="op" id="6039299">=</span>&nbsp;<span class="num" id="6039301">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039309">var</span>&nbsp;<span class="ident" id="6039313">x</span><span class="op" id="6039314">,</span>&nbsp;<span class="ident" id="6039316">code</span>&nbsp;<span class="builtintype" id="6039321">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039330">for</span>&nbsp;<span class="ident" id="6039334">i</span>&nbsp;<span class="op" id="6039336">:=</span>&nbsp;<span class="builtintype" id="6039339">uint32</span><span class="op" id="6039345">(</span><span class="num" id="6039346">0</span><span class="op" id="6039347">)</span><span class="op" id="6039348">;</span>&nbsp;<span class="ident" id="6039350">i</span>&nbsp;<span class="op" id="6039352">&lt;</span>&nbsp;<span class="ident" id="6039354">lutSize</span><span class="op" id="6039361">;</span>&nbsp;<span class="ident" id="6039363">i</span><span class="op" id="6039364">++</span>&nbsp;<span class="op" id="6039367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039372">code</span>&nbsp;<span class="op" id="6039377">&lt;&lt;=</span>&nbsp;<span class="num" id="6039381">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039386">for</span>&nbsp;<span class="ident" id="6039390">j</span>&nbsp;<span class="op" id="6039392">:=</span>&nbsp;<span class="builtintype" id="6039395">int32</span><span class="op" id="6039400">(</span><span class="num" id="6039401">0</span><span class="op" id="6039402">)</span><span class="op" id="6039403">;</span>&nbsp;<span class="ident" id="6039405">j</span>&nbsp;<span class="op" id="6039407">&lt;</span>&nbsp;<span class="ident" id="6039409">nCodes</span><span class="op" id="6039415">[</span><span class="ident" id="6039416">i</span><span class="op" id="6039417">]</span><span class="op" id="6039418">;</span>&nbsp;<span class="ident" id="6039420">j</span><span class="op" id="6039421">++</span>&nbsp;<span class="op" id="6039424">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039430">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039488">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039544">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039594">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039652">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039701">base</span>&nbsp;<span class="op" id="6039706">:=</span>&nbsp;<span class="builtintype" id="6039709">uint8</span><span class="op" id="6039714">(</span><span class="ident" id="6039715">code</span>&nbsp;<span class="op" id="6039720">&lt;&lt;</span>&nbsp;<span class="op" id="6039723">(</span><span class="num" id="6039724">7</span>&nbsp;<span class="op" id="6039726">-</span>&nbsp;<span class="ident" id="6039728">i</span><span class="op" id="6039729">)</span><span class="op" id="6039730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039736">lutValue</span>&nbsp;<span class="op" id="6039745">:=</span>&nbsp;<span class="builtintype" id="6039748">uint16</span><span class="op" id="6039754">(</span><span class="ident" id="6039755">h</span><span class="op" id="6039756">.</span><span class="ident" id="6039757">vals</span><span class="op" id="6039761">[</span><span class="ident" id="6039762">x</span><span class="op" id="6039763">]</span><span class="op" id="6039764">)</span><span class="op" id="6039765">&lt;&lt;</span><span class="num" id="6039767">8</span>&nbsp;<span class="op" id="6039769">|</span>&nbsp;<span class="builtintype" id="6039771">uint16</span><span class="op" id="6039777">(</span><span class="num" id="6039778">2</span><span class="op" id="6039779">+</span><span class="ident" id="6039780">i</span><span class="op" id="6039781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039787">for</span>&nbsp;<span class="ident" id="6039791">k</span>&nbsp;<span class="op" id="6039793">:=</span>&nbsp;<span class="builtintype" id="6039796">uint8</span><span class="op" id="6039801">(</span><span class="num" id="6039802">0</span><span class="op" id="6039803">)</span><span class="op" id="6039804">;</span>&nbsp;<span class="ident" id="6039806">k</span>&nbsp;<span class="op" id="6039808">&lt;</span>&nbsp;<span class="num" id="6039810">1</span><span class="op" id="6039811">&lt;&lt;</span><span class="op" id="6039813">(</span><span class="num" id="6039814">7</span><span class="op" id="6039815">-</span><span class="ident" id="6039816">i</span><span class="op" id="6039817">)</span><span class="op" id="6039818">;</span>&nbsp;<span class="ident" id="6039820">k</span><span class="op" id="6039821">++</span>&nbsp;<span class="op" id="6039824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039831">h</span><span class="op" id="6039832">.</span><span class="ident" id="6039833">lut</span><span class="op" id="6039836">[</span><span class="ident" id="6039837">base</span><span class="op" id="6039841">|</span><span class="ident" id="6039842">k</span><span class="op" id="6039843">]</span>&nbsp;<span class="op" id="6039845">=</span>&nbsp;<span class="ident" id="6039847">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039860">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039866">code</span><span class="op" id="6039870">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039877">x</span><span class="op" id="6039878">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6039893">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039942">var</span>&nbsp;<span class="ident" id="6039946">c</span><span class="op" id="6039947">,</span>&nbsp;<span class="ident" id="6039949">index</span>&nbsp;<span class="builtintype" id="6039955">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039963">for</span>&nbsp;<span class="ident" id="6039967">i</span><span class="op" id="6039968">,</span>&nbsp;<span class="ident" id="6039970">n</span>&nbsp;<span class="op" id="6039972">:=</span>&nbsp;<span class="keyword" id="6039975">range</span>&nbsp;<span class="ident" id="6039981">nCodes</span>&nbsp;<span class="op" id="6039988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039993">if</span>&nbsp;<span class="ident" id="6039996">n</span>&nbsp;<span class="op" id="6039998">==</span>&nbsp;<span class="num" id="6040001">0</span>&nbsp;<span class="op" id="6040003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040009">h</span><span class="op" id="6040010">.</span><span class="ident" id="6040011">minCodes</span><span class="op" id="6040019">[</span><span class="ident" id="6040020">i</span><span class="op" id="6040021">]</span>&nbsp;<span class="op" id="6040023">=</span>&nbsp;<span class="op" id="6040025">-</span><span class="num" id="6040026">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040032">h</span><span class="op" id="6040033">.</span><span class="ident" id="6040034">maxCodes</span><span class="op" id="6040042">[</span><span class="ident" id="6040043">i</span><span class="op" id="6040044">]</span>&nbsp;<span class="op" id="6040046">=</span>&nbsp;<span class="op" id="6040048">-</span><span class="num" id="6040049">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040055">h</span><span class="op" id="6040056">.</span><span class="ident" id="6040057">valsIndices</span><span class="op" id="6040068">[</span><span class="ident" id="6040069">i</span><span class="op" id="6040070">]</span>&nbsp;<span class="op" id="6040072">=</span>&nbsp;<span class="op" id="6040074">-</span><span class="num" id="6040075">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040080">}</span>&nbsp;<span class="keyword" id="6040082">else</span>&nbsp;<span class="op" id="6040087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040093">h</span><span class="op" id="6040094">.</span><span class="ident" id="6040095">minCodes</span><span class="op" id="6040103">[</span><span class="ident" id="6040104">i</span><span class="op" id="6040105">]</span>&nbsp;<span class="op" id="6040107">=</span>&nbsp;<span class="ident" id="6040109">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040115">h</span><span class="op" id="6040116">.</span><span class="ident" id="6040117">maxCodes</span><span class="op" id="6040125">[</span><span class="ident" id="6040126">i</span><span class="op" id="6040127">]</span>&nbsp;<span class="op" id="6040129">=</span>&nbsp;<span class="ident" id="6040131">c</span>&nbsp;<span class="op" id="6040133">+</span>&nbsp;<span class="ident" id="6040135">n</span>&nbsp;<span class="op" id="6040137">-</span>&nbsp;<span class="num" id="6040139">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040145">h</span><span class="op" id="6040146">.</span><span class="ident" id="6040147">valsIndices</span><span class="op" id="6040158">[</span><span class="ident" id="6040159">i</span><span class="op" id="6040160">]</span>&nbsp;<span class="op" id="6040162">=</span>&nbsp;<span class="ident" id="6040164">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040174">c</span>&nbsp;<span class="op" id="6040176">+=</span>&nbsp;<span class="ident" id="6040179">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040185">index</span>&nbsp;<span class="op" id="6040191">+=</span>&nbsp;<span class="ident" id="6040194">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040204">c</span>&nbsp;<span class="op" id="6040206">&lt;&lt;=</span>&nbsp;<span class="num" id="6040210">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040220">return</span>&nbsp;<span class="ident" id="6040227">nil</span><br>
<span class="lineno"></span><span class="op" id="6040231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="6040234">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="6040309">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="6040336">func</span>&nbsp;<span class="op" id="6040341">(</span><span class="ident" id="6040342">d</span>&nbsp;<span class="op" id="6040344">*</span><span class="ident" id="6040345">decoder</span><span class="op" id="6040352">)</span>&nbsp;<span class="ident" id="6040354">decodeHuffman</span><span class="op" id="6040367">(</span><span class="ident" id="6040368">h</span>&nbsp;<span class="op" id="6040370">*</span><span class="ident" id="6040371">huffman</span><span class="op" id="6040378">)</span>&nbsp;<span class="op" id="6040380">(</span><span class="builtintype" id="6040381">uint8</span><span class="op" id="6040386">,</span>&nbsp;<span class="builtintype" id="6040388">error</span><span class="op" id="6040393">)</span>&nbsp;<span class="op" id="6040395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040398">if</span>&nbsp;<span class="ident" id="6040401">h</span><span class="op" id="6040402">.</span><span class="ident" id="6040403">nCodes</span>&nbsp;<span class="op" id="6040410">==</span>&nbsp;<span class="num" id="6040413">0</span>&nbsp;<span class="op" id="6040415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040419">return</span>&nbsp;<span class="num" id="6040426">0</span><span class="op" id="6040427">,</span>&nbsp;<span class="ident" id="6040429">FormatError</span><span class="op" id="6040440">(</span><span class="string" id="6040441">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="6040470">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040477">if</span>&nbsp;<span class="ident" id="6040480">d</span><span class="op" id="6040481">.</span><span class="ident" id="6040482">bits</span><span class="op" id="6040486">.</span><span class="ident" id="6040487">n</span>&nbsp;<span class="op" id="6040489">&lt;</span>&nbsp;<span class="num" id="6040491">8</span>&nbsp;<span class="op" id="6040493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040497">if</span>&nbsp;<span class="ident" id="6040500">err</span>&nbsp;<span class="op" id="6040504">:=</span>&nbsp;<span class="ident" id="6040507">d</span><span class="op" id="6040508">.</span><span class="ident" id="6040509">ensureNBits</span><span class="op" id="6040520">(</span><span class="num" id="6040521">8</span><span class="op" id="6040522">)</span><span class="op" id="6040523">;</span>&nbsp;<span class="ident" id="6040525">err</span>&nbsp;<span class="op" id="6040529">!=</span>&nbsp;<span class="ident" id="6040532">nil</span>&nbsp;<span class="op" id="6040536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040541">if</span>&nbsp;<span class="ident" id="6040544">err</span>&nbsp;<span class="op" id="6040548">!=</span>&nbsp;<span class="ident" id="6040551">errMissingFF00</span>&nbsp;<span class="op" id="6040566">&amp;&amp;</span>&nbsp;<span class="ident" id="6040569">err</span>&nbsp;<span class="op" id="6040573">!=</span>&nbsp;<span class="ident" id="6040576">errShortHuffmanData</span>&nbsp;<span class="op" id="6040596">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040602">return</span>&nbsp;<span class="num" id="6040609">0</span><span class="op" id="6040610">,</span>&nbsp;<span class="ident" id="6040612">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6040624">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6040696">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6040767">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040830">d</span><span class="op" id="6040831">.</span><span class="ident" id="6040832">unreadByteStuffedByte</span><span class="op" id="6040853">(</span><span class="op" id="6040854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040859">goto</span>&nbsp;<span class="ident" id="6040864">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6040878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6040881">if</span>&nbsp;<span class="ident" id="6040884">v</span>&nbsp;<span class="op" id="6040886">:=</span>&nbsp;<span class="ident" id="6040889">h</span><span class="op" id="6040890">.</span><span class="ident" id="6040891">lut</span><span class="op" id="6040894">[</span><span class="op" id="6040895">(</span><span class="ident" id="6040896">d</span><span class="op" id="6040897">.</span><span class="ident" id="6040898">bits</span><span class="op" id="6040902">.</span><span class="ident" id="6040903">a</span><span class="op" id="6040904">&gt;&gt;</span><span class="builtintype" id="6040906">uint32</span><span class="op" id="6040912">(</span><span class="ident" id="6040913">d</span><span class="op" id="6040914">.</span><span class="ident" id="6040915">bits</span><span class="op" id="6040919">.</span><span class="ident" id="6040920">n</span><span class="op" id="6040921">-</span><span class="ident" id="6040922">lutSize</span><span class="op" id="6040929">)</span><span class="op" id="6040930">)</span><span class="op" id="6040931">&amp;</span><span class="num" id="6040932">0xff</span><span class="op" id="6040936">]</span><span class="op" id="6040937">;</span>&nbsp;<span class="ident" id="6040939">v</span>&nbsp;<span class="op" id="6040941">!=</span>&nbsp;<span class="num" id="6040944">0</span>&nbsp;<span class="op" id="6040946">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040950">n</span>&nbsp;<span class="op" id="6040952">:=</span>&nbsp;<span class="op" id="6040955">(</span><span class="ident" id="6040956">v</span>&nbsp;<span class="op" id="6040958">&amp;</span>&nbsp;<span class="num" id="6040960">0xff</span><span class="op" id="6040964">)</span>&nbsp;<span class="op" id="6040966">-</span>&nbsp;<span class="num" id="6040968">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040972">d</span><span class="op" id="6040973">.</span><span class="ident" id="6040974">bits</span><span class="op" id="6040978">.</span><span class="ident" id="6040979">n</span>&nbsp;<span class="op" id="6040981">-=</span>&nbsp;<span class="builtintype" id="6040984">int32</span><span class="op" id="6040989">(</span><span class="ident" id="6040990">n</span><span class="op" id="6040991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040995">d</span><span class="op" id="6040996">.</span><span class="ident" id="6040997">bits</span><span class="op" id="6041001">.</span><span class="ident" id="6041002">m</span>&nbsp;<span class="op" id="6041004">&gt;&gt;=</span>&nbsp;<span class="ident" id="6041008">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041012">return</span>&nbsp;<span class="builtintype" id="6041019">uint8</span><span class="op" id="6041024">(</span><span class="ident" id="6041025">v</span>&nbsp;<span class="op" id="6041027">&gt;&gt;</span>&nbsp;<span class="num" id="6041030">8</span><span class="op" id="6041031">)</span><span class="op" id="6041032">,</span>&nbsp;<span class="ident" id="6041034">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041039">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="6041042">slowPath</span><span class="op" id="6041050">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041053">for</span>&nbsp;<span class="ident" id="6041057">i</span><span class="op" id="6041058">,</span>&nbsp;<span class="ident" id="6041060">code</span>&nbsp;<span class="op" id="6041065">:=</span>&nbsp;<span class="num" id="6041068">0</span><span class="op" id="6041069">,</span>&nbsp;<span class="builtintype" id="6041071">int32</span><span class="op" id="6041076">(</span><span class="num" id="6041077">0</span><span class="op" id="6041078">)</span><span class="op" id="6041079">;</span>&nbsp;<span class="ident" id="6041081">i</span>&nbsp;<span class="op" id="6041083">&lt;</span>&nbsp;<span class="ident" id="6041085">maxCodeLength</span><span class="op" id="6041098">;</span>&nbsp;<span class="ident" id="6041100">i</span><span class="op" id="6041101">++</span>&nbsp;<span class="op" id="6041104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041108">if</span>&nbsp;<span class="ident" id="6041111">d</span><span class="op" id="6041112">.</span><span class="ident" id="6041113">bits</span><span class="op" id="6041117">.</span><span class="ident" id="6041118">n</span>&nbsp;<span class="op" id="6041120">==</span>&nbsp;<span class="num" id="6041123">0</span>&nbsp;<span class="op" id="6041125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041130">if</span>&nbsp;<span class="ident" id="6041133">err</span>&nbsp;<span class="op" id="6041137">:=</span>&nbsp;<span class="ident" id="6041140">d</span><span class="op" id="6041141">.</span><span class="ident" id="6041142">ensureNBits</span><span class="op" id="6041153">(</span><span class="num" id="6041154">1</span><span class="op" id="6041155">)</span><span class="op" id="6041156">;</span>&nbsp;<span class="ident" id="6041158">err</span>&nbsp;<span class="op" id="6041162">!=</span>&nbsp;<span class="ident" id="6041165">nil</span>&nbsp;<span class="op" id="6041169">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041175">return</span>&nbsp;<span class="num" id="6041182">0</span><span class="op" id="6041183">,</span>&nbsp;<span class="ident" id="6041185">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041200">if</span>&nbsp;<span class="ident" id="6041203">d</span><span class="op" id="6041204">.</span><span class="ident" id="6041205">bits</span><span class="op" id="6041209">.</span><span class="ident" id="6041210">a</span><span class="op" id="6041211">&amp;</span><span class="ident" id="6041212">d</span><span class="op" id="6041213">.</span><span class="ident" id="6041214">bits</span><span class="op" id="6041218">.</span><span class="ident" id="6041219">m</span>&nbsp;<span class="op" id="6041221">!=</span>&nbsp;<span class="num" id="6041224">0</span>&nbsp;<span class="op" id="6041226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041231">code</span>&nbsp;<span class="op" id="6041236">|=</span>&nbsp;<span class="num" id="6041239">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041247">d</span><span class="op" id="6041248">.</span><span class="ident" id="6041249">bits</span><span class="op" id="6041253">.</span><span class="ident" id="6041254">n</span><span class="op" id="6041255">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041260">d</span><span class="op" id="6041261">.</span><span class="ident" id="6041262">bits</span><span class="op" id="6041266">.</span><span class="ident" id="6041267">m</span>&nbsp;<span class="op" id="6041269">&gt;&gt;=</span>&nbsp;<span class="num" id="6041273">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041277">if</span>&nbsp;<span class="ident" id="6041280">code</span>&nbsp;<span class="op" id="6041285">&lt;=</span>&nbsp;<span class="ident" id="6041288">h</span><span class="op" id="6041289">.</span><span class="ident" id="6041290">maxCodes</span><span class="op" id="6041298">[</span><span class="ident" id="6041299">i</span><span class="op" id="6041300">]</span>&nbsp;<span class="op" id="6041302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041307">return</span>&nbsp;<span class="ident" id="6041314">h</span><span class="op" id="6041315">.</span><span class="ident" id="6041316">vals</span><span class="op" id="6041320">[</span><span class="ident" id="6041321">h</span><span class="op" id="6041322">.</span><span class="ident" id="6041323">valsIndices</span><span class="op" id="6041334">[</span><span class="ident" id="6041335">i</span><span class="op" id="6041336">]</span><span class="op" id="6041337">+</span><span class="ident" id="6041338">code</span><span class="op" id="6041342">-</span><span class="ident" id="6041343">h</span><span class="op" id="6041344">.</span><span class="ident" id="6041345">minCodes</span><span class="op" id="6041353">[</span><span class="ident" id="6041354">i</span><span class="op" id="6041355">]</span><span class="op" id="6041356">]</span><span class="op" id="6041357">,</span>&nbsp;<span class="ident" id="6041359">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041369">code</span>&nbsp;<span class="op" id="6041374">&lt;&lt;=</span>&nbsp;<span class="num" id="6041378">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041384">return</span>&nbsp;<span class="num" id="6041391">0</span><span class="op" id="6041392">,</span>&nbsp;<span class="ident" id="6041394">FormatError</span><span class="op" id="6041405">(</span><span class="string" id="6041406">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="6041424">)</span><br>
<span class="lineno"></span><span class="op" id="6041426">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="6041429">func</span>&nbsp;<span class="op" id="6041434">(</span><span class="ident" id="6041435">d</span>&nbsp;<span class="op" id="6041437">*</span><span class="ident" id="6041438">decoder</span><span class="op" id="6041445">)</span>&nbsp;<span class="ident" id="6041447">decodeBit</span><span class="op" id="6041456">(</span><span class="op" id="6041457">)</span>&nbsp;<span class="op" id="6041459">(</span><span class="builtintype" id="6041460">bool</span><span class="op" id="6041464">,</span>&nbsp;<span class="builtintype" id="6041466">error</span><span class="op" id="6041471">)</span>&nbsp;<span class="op" id="6041473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041476">if</span>&nbsp;<span class="ident" id="6041479">d</span><span class="op" id="6041480">.</span><span class="ident" id="6041481">bits</span><span class="op" id="6041485">.</span><span class="ident" id="6041486">n</span>&nbsp;<span class="op" id="6041488">==</span>&nbsp;<span class="num" id="6041491">0</span>&nbsp;<span class="op" id="6041493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041497">if</span>&nbsp;<span class="ident" id="6041500">err</span>&nbsp;<span class="op" id="6041504">:=</span>&nbsp;<span class="ident" id="6041507">d</span><span class="op" id="6041508">.</span><span class="ident" id="6041509">ensureNBits</span><span class="op" id="6041520">(</span><span class="num" id="6041521">1</span><span class="op" id="6041522">)</span><span class="op" id="6041523">;</span>&nbsp;<span class="ident" id="6041525">err</span>&nbsp;<span class="op" id="6041529">!=</span>&nbsp;<span class="ident" id="6041532">nil</span>&nbsp;<span class="op" id="6041536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041541">return</span>&nbsp;<span class="builtintype" id="6041548">false</span><span class="op" id="6041553">,</span>&nbsp;<span class="ident" id="6041555">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041567">ret</span>&nbsp;<span class="op" id="6041571">:=</span>&nbsp;<span class="ident" id="6041574">d</span><span class="op" id="6041575">.</span><span class="ident" id="6041576">bits</span><span class="op" id="6041580">.</span><span class="ident" id="6041581">a</span><span class="op" id="6041582">&amp;</span><span class="ident" id="6041583">d</span><span class="op" id="6041584">.</span><span class="ident" id="6041585">bits</span><span class="op" id="6041589">.</span><span class="ident" id="6041590">m</span>&nbsp;<span class="op" id="6041592">!=</span>&nbsp;<span class="num" id="6041595">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041598">d</span><span class="op" id="6041599">.</span><span class="ident" id="6041600">bits</span><span class="op" id="6041604">.</span><span class="ident" id="6041605">n</span><span class="op" id="6041606">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041610">d</span><span class="op" id="6041611">.</span><span class="ident" id="6041612">bits</span><span class="op" id="6041616">.</span><span class="ident" id="6041617">m</span>&nbsp;<span class="op" id="6041619">&gt;&gt;=</span>&nbsp;<span class="num" id="6041623">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041626">return</span>&nbsp;<span class="ident" id="6041633">ret</span><span class="op" id="6041636">,</span>&nbsp;<span class="ident" id="6041638">nil</span><br>
<span class="lineno"></span><span class="op" id="6041642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6041645">func</span>&nbsp;<span class="op" id="6041650">(</span><span class="ident" id="6041651">d</span>&nbsp;<span class="op" id="6041653">*</span><span class="ident" id="6041654">decoder</span><span class="op" id="6041661">)</span>&nbsp;<span class="ident" id="6041663">decodeBits</span><span class="op" id="6041673">(</span><span class="ident" id="6041674">n</span>&nbsp;<span class="builtintype" id="6041676">int32</span><span class="op" id="6041681">)</span>&nbsp;<span class="op" id="6041683">(</span><span class="builtintype" id="6041684">uint32</span><span class="op" id="6041690">,</span>&nbsp;<span class="builtintype" id="6041692">error</span><span class="op" id="6041697">)</span>&nbsp;<span class="op" id="6041699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041702">if</span>&nbsp;<span class="ident" id="6041705">d</span><span class="op" id="6041706">.</span><span class="ident" id="6041707">bits</span><span class="op" id="6041711">.</span><span class="ident" id="6041712">n</span>&nbsp;<span class="op" id="6041714">&lt;</span>&nbsp;<span class="ident" id="6041716">n</span>&nbsp;<span class="op" id="6041718">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041722">if</span>&nbsp;<span class="ident" id="6041725">err</span>&nbsp;<span class="op" id="6041729">:=</span>&nbsp;<span class="ident" id="6041732">d</span><span class="op" id="6041733">.</span><span class="ident" id="6041734">ensureNBits</span><span class="op" id="6041745">(</span><span class="ident" id="6041746">n</span><span class="op" id="6041747">)</span><span class="op" id="6041748">;</span>&nbsp;<span class="ident" id="6041750">err</span>&nbsp;<span class="op" id="6041754">!=</span>&nbsp;<span class="ident" id="6041757">nil</span>&nbsp;<span class="op" id="6041761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041766">return</span>&nbsp;<span class="num" id="6041773">0</span><span class="op" id="6041774">,</span>&nbsp;<span class="ident" id="6041776">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041788">ret</span>&nbsp;<span class="op" id="6041792">:=</span>&nbsp;<span class="ident" id="6041795">d</span><span class="op" id="6041796">.</span><span class="ident" id="6041797">bits</span><span class="op" id="6041801">.</span><span class="ident" id="6041802">a</span>&nbsp;<span class="op" id="6041804">&gt;&gt;</span>&nbsp;<span class="builtintype" id="6041807">uint32</span><span class="op" id="6041813">(</span><span class="ident" id="6041814">d</span><span class="op" id="6041815">.</span><span class="ident" id="6041816">bits</span><span class="op" id="6041820">.</span><span class="ident" id="6041821">n</span><span class="op" id="6041822">-</span><span class="ident" id="6041823">n</span><span class="op" id="6041824">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041827">ret</span>&nbsp;<span class="op" id="6041831">&amp;=</span>&nbsp;<span class="op" id="6041834">(</span><span class="num" id="6041835">1</span>&nbsp;<span class="op" id="6041837">&lt;&lt;</span>&nbsp;<span class="builtintype" id="6041840">uint32</span><span class="op" id="6041846">(</span><span class="ident" id="6041847">n</span><span class="op" id="6041848">)</span><span class="op" id="6041849">)</span>&nbsp;<span class="op" id="6041851">-</span>&nbsp;<span class="num" id="6041853">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041856">d</span><span class="op" id="6041857">.</span><span class="ident" id="6041858">bits</span><span class="op" id="6041862">.</span><span class="ident" id="6041863">n</span>&nbsp;<span class="op" id="6041865">-=</span>&nbsp;<span class="ident" id="6041868">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041871">d</span><span class="op" id="6041872">.</span><span class="ident" id="6041873">bits</span><span class="op" id="6041877">.</span><span class="ident" id="6041878">m</span>&nbsp;<span class="op" id="6041880">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="6041884">uint32</span><span class="op" id="6041890">(</span><span class="ident" id="6041891">n</span><span class="op" id="6041892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041895">return</span>&nbsp;<span class="ident" id="6041902">ret</span><span class="op" id="6041905">,</span>&nbsp;<span class="ident" id="6041907">nil</span><br>
<span class="lineno"></span><span class="op" id="6041911">}</span>
</div>
</body>
</html>
