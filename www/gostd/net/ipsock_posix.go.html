<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3677600">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3677656">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3677710">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3677761">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3677839">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3677886">package</span>&nbsp;<span class="ident" id="3677894">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3677899">import</span>&nbsp;<span class="op" id="3677906">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3677909">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3677920">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3677927">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3677930">func</span>&nbsp;<span class="ident" id="3677935">probeIPv4Stack</span><span class="op" id="3677949">(</span><span class="op" id="3677950">)</span>&nbsp;<span class="builtintype" id="3677952">bool</span>&nbsp;<span class="op" id="3677957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677960">s</span><span class="op" id="3677961">,</span>&nbsp;<span class="ident" id="3677963">err</span>&nbsp;<span class="op" id="3677967">:=</span>&nbsp;<span class="ident" id="3677970">syscall</span><span class="op" id="3677977">.</span><span class="ident" id="3677978">Socket</span><span class="op" id="3677984">(</span><span class="ident" id="3677985">syscall</span><span class="op" id="3677992">.</span><span class="ident" id="3677993">AF_INET</span><span class="op" id="3678000">,</span>&nbsp;<span class="ident" id="3678002">syscall</span><span class="op" id="3678009">.</span><span class="ident" id="3678010">SOCK_STREAM</span><span class="op" id="3678021">,</span>&nbsp;<span class="ident" id="3678023">syscall</span><span class="op" id="3678030">.</span><span class="ident" id="3678031">IPPROTO_TCP</span><span class="op" id="3678042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678045">switch</span>&nbsp;<span class="ident" id="3678052">err</span>&nbsp;<span class="op" id="3678056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678059">case</span>&nbsp;<span class="ident" id="3678064">syscall</span><span class="op" id="3678071">.</span><span class="ident" id="3678072">EAFNOSUPPORT</span><span class="op" id="3678084">,</span>&nbsp;<span class="ident" id="3678086">syscall</span><span class="op" id="3678093">.</span><span class="ident" id="3678094">EPROTONOSUPPORT</span><span class="op" id="3678109">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678113">return</span>&nbsp;<span class="builtintype" id="3678120">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678127">case</span>&nbsp;<span class="ident" id="3678132">nil</span><span class="op" id="3678135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678139">closesocket</span><span class="op" id="3678150">(</span><span class="ident" id="3678151">s</span><span class="op" id="3678152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3678155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678158">return</span>&nbsp;<span class="builtintype" id="3678165">true</span><br>
<span class="lineno">25</span><span class="op" id="3678170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3678173">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="3678232">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="3678295">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="3678361">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="3678422">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="3678485">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3678540">//</span><br>
<span class="lineno"></span><span class="comment" id="3678543">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="3678610">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="3678674">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3678728">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3678793">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="3678859">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="3678920">func</span>&nbsp;<span class="ident" id="3678925">probeIPv6Stack</span><span class="op" id="3678939">(</span><span class="op" id="3678940">)</span>&nbsp;<span class="op" id="3678942">(</span><span class="ident" id="3678943">supportsIPv6</span><span class="op" id="3678955">,</span>&nbsp;<span class="ident" id="3678957">supportsIPv4map</span>&nbsp;<span class="builtintype" id="3678973">bool</span><span class="op" id="3678977">)</span>&nbsp;<span class="op" id="3678979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678982">var</span>&nbsp;<span class="ident" id="3678986">probes</span>&nbsp;<span class="op" id="3678993">=</span>&nbsp;<span class="op" id="3678995">[</span><span class="op" id="3678996">]</span><span class="keyword" id="3678997">struct</span>&nbsp;<span class="op" id="3679004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679008">laddr</span>&nbsp;<span class="ident" id="3679014">TCPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679024">value</span>&nbsp;<span class="builtintype" id="3679030">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679036">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3679042">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679048">}</span><span class="op" id="3679049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3679053">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679088">{</span><span class="ident" id="3679089">laddr</span><span class="op" id="3679094">:</span>&nbsp;<span class="ident" id="3679096">TCPAddr</span><span class="op" id="3679103">{</span><span class="ident" id="3679104">IP</span><span class="op" id="3679106">:</span>&nbsp;<span class="ident" id="3679108">ParseIP</span><span class="op" id="3679115">(</span><span class="string" id="3679116">&#34;::1&#34;</span><span class="op" id="3679121">)</span><span class="op" id="3679122">}</span><span class="op" id="3679123">,</span>&nbsp;<span class="ident" id="3679125">value</span><span class="op" id="3679130">:</span>&nbsp;<span class="num" id="3679132">1</span><span class="op" id="3679133">}</span><span class="op" id="3679134">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3679138">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679193">{</span><span class="ident" id="3679194">laddr</span><span class="op" id="3679199">:</span>&nbsp;<span class="ident" id="3679201">TCPAddr</span><span class="op" id="3679208">{</span><span class="ident" id="3679209">IP</span><span class="op" id="3679211">:</span>&nbsp;<span class="ident" id="3679213">IPv4</span><span class="op" id="3679217">(</span><span class="num" id="3679218">127</span><span class="op" id="3679221">,</span>&nbsp;<span class="num" id="3679223">0</span><span class="op" id="3679224">,</span>&nbsp;<span class="num" id="3679226">0</span><span class="op" id="3679227">,</span>&nbsp;<span class="num" id="3679229">1</span><span class="op" id="3679230">)</span><span class="op" id="3679231">}</span><span class="op" id="3679232">,</span>&nbsp;<span class="ident" id="3679234">value</span><span class="op" id="3679239">:</span>&nbsp;<span class="num" id="3679241">0</span><span class="op" id="3679242">}</span><span class="op" id="3679243">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679250">for</span>&nbsp;<span class="ident" id="3679254">i</span>&nbsp;<span class="op" id="3679256">:=</span>&nbsp;<span class="keyword" id="3679259">range</span>&nbsp;<span class="ident" id="3679265">probes</span>&nbsp;<span class="op" id="3679272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679276">s</span><span class="op" id="3679277">,</span>&nbsp;<span class="ident" id="3679279">err</span>&nbsp;<span class="op" id="3679283">:=</span>&nbsp;<span class="ident" id="3679286">syscall</span><span class="op" id="3679293">.</span><span class="ident" id="3679294">Socket</span><span class="op" id="3679300">(</span><span class="ident" id="3679301">syscall</span><span class="op" id="3679308">.</span><span class="ident" id="3679309">AF_INET6</span><span class="op" id="3679317">,</span>&nbsp;<span class="ident" id="3679319">syscall</span><span class="op" id="3679326">.</span><span class="ident" id="3679327">SOCK_STREAM</span><span class="op" id="3679338">,</span>&nbsp;<span class="ident" id="3679340">syscall</span><span class="op" id="3679347">.</span><span class="ident" id="3679348">IPPROTO_TCP</span><span class="op" id="3679359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679363">if</span>&nbsp;<span class="ident" id="3679366">err</span>&nbsp;<span class="op" id="3679370">!=</span>&nbsp;<span class="ident" id="3679373">nil</span>&nbsp;<span class="op" id="3679377">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679382">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679397">defer</span>&nbsp;<span class="ident" id="3679403">closesocket</span><span class="op" id="3679414">(</span><span class="ident" id="3679415">s</span><span class="op" id="3679416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679420">syscall</span><span class="op" id="3679427">.</span><span class="ident" id="3679428">SetsockoptInt</span><span class="op" id="3679441">(</span><span class="ident" id="3679442">s</span><span class="op" id="3679443">,</span>&nbsp;<span class="ident" id="3679445">syscall</span><span class="op" id="3679452">.</span><span class="ident" id="3679453">IPPROTO_IPV6</span><span class="op" id="3679465">,</span>&nbsp;<span class="ident" id="3679467">syscall</span><span class="op" id="3679474">.</span><span class="ident" id="3679475">IPV6_V6ONLY</span><span class="op" id="3679486">,</span>&nbsp;<span class="ident" id="3679488">probes</span><span class="op" id="3679494">[</span><span class="ident" id="3679495">i</span><span class="op" id="3679496">]</span><span class="op" id="3679497">.</span><span class="ident" id="3679498">value</span><span class="op" id="3679503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679507">sa</span><span class="op" id="3679509">,</span>&nbsp;<span class="ident" id="3679511">err</span>&nbsp;<span class="op" id="3679515">:=</span>&nbsp;<span class="ident" id="3679518">probes</span><span class="op" id="3679524">[</span><span class="ident" id="3679525">i</span><span class="op" id="3679526">]</span><span class="op" id="3679527">.</span><span class="ident" id="3679528">laddr</span><span class="op" id="3679533">.</span><span class="ident" id="3679534">sockaddr</span><span class="op" id="3679542">(</span><span class="ident" id="3679543">syscall</span><span class="op" id="3679550">.</span><span class="ident" id="3679551">AF_INET6</span><span class="op" id="3679559">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679563">if</span>&nbsp;<span class="ident" id="3679566">err</span>&nbsp;<span class="op" id="3679570">!=</span>&nbsp;<span class="ident" id="3679573">nil</span>&nbsp;<span class="op" id="3679577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679582">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679597">if</span>&nbsp;<span class="ident" id="3679600">err</span>&nbsp;<span class="op" id="3679604">:=</span>&nbsp;<span class="ident" id="3679607">syscall</span><span class="op" id="3679614">.</span><span class="ident" id="3679615">Bind</span><span class="op" id="3679619">(</span><span class="ident" id="3679620">s</span><span class="op" id="3679621">,</span>&nbsp;<span class="ident" id="3679623">sa</span><span class="op" id="3679625">)</span><span class="op" id="3679626">;</span>&nbsp;<span class="ident" id="3679628">err</span>&nbsp;<span class="op" id="3679632">!=</span>&nbsp;<span class="ident" id="3679635">nil</span>&nbsp;<span class="op" id="3679639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679644">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679659">probes</span><span class="op" id="3679665">[</span><span class="ident" id="3679666">i</span><span class="op" id="3679667">]</span><span class="op" id="3679668">.</span><span class="ident" id="3679669">ok</span>&nbsp;<span class="op" id="3679672">=</span>&nbsp;<span class="builtintype" id="3679674">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679684">return</span>&nbsp;<span class="ident" id="3679691">probes</span><span class="op" id="3679697">[</span><span class="num" id="3679698">0</span><span class="op" id="3679699">]</span><span class="op" id="3679700">.</span><span class="ident" id="3679701">ok</span><span class="op" id="3679703">,</span>&nbsp;<span class="ident" id="3679705">probes</span><span class="op" id="3679711">[</span><span class="num" id="3679712">1</span><span class="op" id="3679713">]</span><span class="op" id="3679714">.</span><span class="ident" id="3679715">ok</span><br>
<span class="lineno">70</span><span class="op" id="3679718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3679721">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3679785">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="3679847">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="3679911">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3679973">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="3680039">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="3680103">//</span><br>
<span class="lineno"></span><span class="comment" id="3680106">//&nbsp;&nbsp;&nbsp;&nbsp1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="3680143">//&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="3680203">//&nbsp;&nbsp;&nbsp;&nbspcapabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3680262">//&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="3680318">//&nbsp;&nbsp;&nbsp;&nbspsocket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="3680377">//&nbsp;&nbsp;&nbsp;&nbspwildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="3680428">//</span><br>
<span class="lineno"></span><span class="comment" id="3680431">//&nbsp;&nbsp;&nbsp;&nbsp2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3680479">//&nbsp;&nbsp;&nbsp;&nbspSame&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3680493">//</span><br>
<span class="lineno"></span><span class="comment" id="3680496">//&nbsp;&nbsp;&nbsp;&nbsp3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="3680541">//&nbsp;&nbsp;&nbsp;&nbspAlmost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="3680600">//&nbsp;&nbsp;&nbsp;&nbsplisten&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3680658">//&nbsp;&nbsp;&nbsp;&nbspthe&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="3680718">//&nbsp;&nbsp;&nbsp;&nbspmapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="3680741">//</span><br>
<span class="lineno">95</span><span class="comment" id="3680744">//&nbsp;&nbsp;&nbsp;&nbsp4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3680799">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3680852">//</span><br>
<span class="lineno"></span><span class="comment" id="3680855">//&nbsp;&nbsp;&nbsp;&nbsp5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3680907">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="3680968">//&nbsp;&nbsp;&nbsp;&nbsplisten.</span><br>
<span class="lineno"></span><span class="comment" id="3680979">//</span><br>
<span class="lineno"></span><span class="comment" id="3680982">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="3681050">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="3681117">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="3681151">//</span><br>
<span class="lineno"></span><span class="comment" id="3681154">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="3681222">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="3681283">func</span>&nbsp;<span class="ident" id="3681288">favoriteAddrFamily</span><span class="op" id="3681306">(</span><span class="ident" id="3681307">net</span>&nbsp;<span class="builtintype" id="3681311">string</span><span class="op" id="3681317">,</span>&nbsp;<span class="ident" id="3681319">laddr</span><span class="op" id="3681324">,</span>&nbsp;<span class="ident" id="3681326">raddr</span>&nbsp;<span class="ident" id="3681332">sockaddr</span><span class="op" id="3681340">,</span>&nbsp;<span class="ident" id="3681342">mode</span>&nbsp;<span class="builtintype" id="3681347">string</span><span class="op" id="3681353">)</span>&nbsp;<span class="op" id="3681355">(</span><span class="ident" id="3681356">family</span>&nbsp;<span class="builtintype" id="3681363">int</span><span class="op" id="3681366">,</span>&nbsp;<span class="ident" id="3681368">ipv6only</span>&nbsp;<span class="builtintype" id="3681377">bool</span><span class="op" id="3681381">)</span>&nbsp;<span class="op" id="3681383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681386">switch</span>&nbsp;<span class="ident" id="3681393">net</span><span class="op" id="3681396">[</span><span class="builtinfunc" id="3681397">len</span><span class="op" id="3681400">(</span><span class="ident" id="3681401">net</span><span class="op" id="3681404">)</span><span class="op" id="3681405">-</span><span class="num" id="3681406">1</span><span class="op" id="3681407">]</span>&nbsp;<span class="op" id="3681409">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681412">case</span>&nbsp;<span class="string" id="3681417">&#39;4&#39;</span><span class="op" id="3681420">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681424">return</span>&nbsp;<span class="ident" id="3681431">syscall</span><span class="op" id="3681438">.</span><span class="ident" id="3681439">AF_INET</span><span class="op" id="3681446">,</span>&nbsp;<span class="builtintype" id="3681448">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681455">case</span>&nbsp;<span class="string" id="3681460">&#39;6&#39;</span><span class="op" id="3681463">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681467">return</span>&nbsp;<span class="ident" id="3681474">syscall</span><span class="op" id="3681481">.</span><span class="ident" id="3681482">AF_INET6</span><span class="op" id="3681490">,</span>&nbsp;<span class="builtintype" id="3681492">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681498">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681502">if</span>&nbsp;<span class="ident" id="3681505">mode</span>&nbsp;<span class="op" id="3681510">==</span>&nbsp;<span class="string" id="3681513">&#34;listen&#34;</span>&nbsp;<span class="op" id="3681522">&amp;&amp;</span>&nbsp;<span class="op" id="3681525">(</span><span class="ident" id="3681526">laddr</span>&nbsp;<span class="op" id="3681532">==</span>&nbsp;<span class="ident" id="3681535">nil</span>&nbsp;<span class="op" id="3681539">||</span>&nbsp;<span class="ident" id="3681542">laddr</span><span class="op" id="3681547">.</span><span class="ident" id="3681548">isWildcard</span><span class="op" id="3681558">(</span><span class="op" id="3681559">)</span><span class="op" id="3681560">)</span>&nbsp;<span class="op" id="3681562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681566">if</span>&nbsp;<span class="ident" id="3681569">supportsIPv4map</span>&nbsp;<span class="op" id="3681585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681590">return</span>&nbsp;<span class="ident" id="3681597">syscall</span><span class="op" id="3681604">.</span><span class="ident" id="3681605">AF_INET6</span><span class="op" id="3681613">,</span>&nbsp;<span class="builtintype" id="3681615">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681623">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681627">if</span>&nbsp;<span class="ident" id="3681630">laddr</span>&nbsp;<span class="op" id="3681636">==</span>&nbsp;<span class="ident" id="3681639">nil</span>&nbsp;<span class="op" id="3681643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681648">return</span>&nbsp;<span class="ident" id="3681655">syscall</span><span class="op" id="3681662">.</span><span class="ident" id="3681663">AF_INET</span><span class="op" id="3681670">,</span>&nbsp;<span class="builtintype" id="3681672">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681684">return</span>&nbsp;<span class="ident" id="3681691">laddr</span><span class="op" id="3681696">.</span><span class="ident" id="3681697">family</span><span class="op" id="3681703">(</span><span class="op" id="3681704">)</span><span class="op" id="3681705">,</span>&nbsp;<span class="builtintype" id="3681707">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681714">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681718">if</span>&nbsp;<span class="op" id="3681721">(</span><span class="ident" id="3681722">laddr</span>&nbsp;<span class="op" id="3681728">==</span>&nbsp;<span class="ident" id="3681731">nil</span>&nbsp;<span class="op" id="3681735">||</span>&nbsp;<span class="ident" id="3681738">laddr</span><span class="op" id="3681743">.</span><span class="ident" id="3681744">family</span><span class="op" id="3681750">(</span><span class="op" id="3681751">)</span>&nbsp;<span class="op" id="3681753">==</span>&nbsp;<span class="ident" id="3681756">syscall</span><span class="op" id="3681763">.</span><span class="ident" id="3681764">AF_INET</span><span class="op" id="3681771">)</span>&nbsp;<span class="op" id="3681773">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681778">(</span><span class="ident" id="3681779">raddr</span>&nbsp;<span class="op" id="3681785">==</span>&nbsp;<span class="ident" id="3681788">nil</span>&nbsp;<span class="op" id="3681792">||</span>&nbsp;<span class="ident" id="3681795">raddr</span><span class="op" id="3681800">.</span><span class="ident" id="3681801">family</span><span class="op" id="3681807">(</span><span class="op" id="3681808">)</span>&nbsp;<span class="op" id="3681810">==</span>&nbsp;<span class="ident" id="3681813">syscall</span><span class="op" id="3681820">.</span><span class="ident" id="3681821">AF_INET</span><span class="op" id="3681828">)</span>&nbsp;<span class="op" id="3681830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681834">return</span>&nbsp;<span class="ident" id="3681841">syscall</span><span class="op" id="3681848">.</span><span class="ident" id="3681849">AF_INET</span><span class="op" id="3681856">,</span>&nbsp;<span class="builtintype" id="3681858">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681865">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681868">return</span>&nbsp;<span class="ident" id="3681875">syscall</span><span class="op" id="3681882">.</span><span class="ident" id="3681883">AF_INET6</span><span class="op" id="3681891">,</span>&nbsp;<span class="builtintype" id="3681893">false</span><br>
<span class="lineno"></span><span class="op" id="3681899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3681902">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="3681938">func</span>&nbsp;<span class="ident" id="3681943">internetSocket</span><span class="op" id="3681957">(</span><span class="ident" id="3681958">net</span>&nbsp;<span class="builtintype" id="3681962">string</span><span class="op" id="3681968">,</span>&nbsp;<span class="ident" id="3681970">laddr</span><span class="op" id="3681975">,</span>&nbsp;<span class="ident" id="3681977">raddr</span>&nbsp;<span class="ident" id="3681983">sockaddr</span><span class="op" id="3681991">,</span>&nbsp;<span class="ident" id="3681993">deadline</span>&nbsp;<span class="ident" id="3682002">time</span><span class="op" id="3682006">.</span><span class="ident" id="3682007">Time</span><span class="op" id="3682011">,</span>&nbsp;<span class="ident" id="3682013">sotype</span><span class="op" id="3682019">,</span>&nbsp;<span class="ident" id="3682021">proto</span>&nbsp;<span class="builtintype" id="3682027">int</span><span class="op" id="3682030">,</span>&nbsp;<span class="ident" id="3682032">mode</span>&nbsp;<span class="builtintype" id="3682037">string</span><span class="op" id="3682043">)</span>&nbsp;<span class="op" id="3682045">(</span><span class="ident" id="3682046">fd</span>&nbsp;<span class="op" id="3682049">*</span><span class="ident" id="3682050">netFD</span><span class="op" id="3682055">,</span>&nbsp;<span class="ident" id="3682057">err</span>&nbsp;<span class="builtintype" id="3682061">error</span><span class="op" id="3682066">)</span>&nbsp;<span class="op" id="3682068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682071">family</span><span class="op" id="3682077">,</span>&nbsp;<span class="ident" id="3682079">ipv6only</span>&nbsp;<span class="op" id="3682088">:=</span>&nbsp;<span class="ident" id="3682091">favoriteAddrFamily</span><span class="op" id="3682109">(</span><span class="ident" id="3682110">net</span><span class="op" id="3682113">,</span>&nbsp;<span class="ident" id="3682115">laddr</span><span class="op" id="3682120">,</span>&nbsp;<span class="ident" id="3682122">raddr</span><span class="op" id="3682127">,</span>&nbsp;<span class="ident" id="3682129">mode</span><span class="op" id="3682133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682136">return</span>&nbsp;<span class="ident" id="3682143">socket</span><span class="op" id="3682149">(</span><span class="ident" id="3682150">net</span><span class="op" id="3682153">,</span>&nbsp;<span class="ident" id="3682155">family</span><span class="op" id="3682161">,</span>&nbsp;<span class="ident" id="3682163">sotype</span><span class="op" id="3682169">,</span>&nbsp;<span class="ident" id="3682171">proto</span><span class="op" id="3682176">,</span>&nbsp;<span class="ident" id="3682178">ipv6only</span><span class="op" id="3682186">,</span>&nbsp;<span class="ident" id="3682188">laddr</span><span class="op" id="3682193">,</span>&nbsp;<span class="ident" id="3682195">raddr</span><span class="op" id="3682200">,</span>&nbsp;<span class="ident" id="3682202">deadline</span><span class="op" id="3682210">)</span><br>
<span class="lineno"></span><span class="op" id="3682212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3682215">func</span>&nbsp;<span class="ident" id="3682220">ipToSockaddr</span><span class="op" id="3682232">(</span><span class="ident" id="3682233">family</span>&nbsp;<span class="builtintype" id="3682240">int</span><span class="op" id="3682243">,</span>&nbsp;<span class="ident" id="3682245">ip</span>&nbsp;<span class="ident" id="3682248">IP</span><span class="op" id="3682250">,</span>&nbsp;<span class="ident" id="3682252">port</span>&nbsp;<span class="builtintype" id="3682257">int</span><span class="op" id="3682260">,</span>&nbsp;<span class="ident" id="3682262">zone</span>&nbsp;<span class="builtintype" id="3682267">string</span><span class="op" id="3682273">)</span>&nbsp;<span class="op" id="3682275">(</span><span class="ident" id="3682276">syscall</span><span class="op" id="3682283">.</span><span class="ident" id="3682284">Sockaddr</span><span class="op" id="3682292">,</span>&nbsp;<span class="builtintype" id="3682294">error</span><span class="op" id="3682299">)</span>&nbsp;<span class="op" id="3682301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682304">switch</span>&nbsp;<span class="ident" id="3682311">family</span>&nbsp;<span class="op" id="3682318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682321">case</span>&nbsp;<span class="ident" id="3682326">syscall</span><span class="op" id="3682333">.</span><span class="ident" id="3682334">AF_INET</span><span class="op" id="3682341">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682345">if</span>&nbsp;<span class="builtinfunc" id="3682348">len</span><span class="op" id="3682351">(</span><span class="ident" id="3682352">ip</span><span class="op" id="3682354">)</span>&nbsp;<span class="op" id="3682356">==</span>&nbsp;<span class="num" id="3682359">0</span>&nbsp;<span class="op" id="3682361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682366">ip</span>&nbsp;<span class="op" id="3682369">=</span>&nbsp;<span class="ident" id="3682371">IPv4zero</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682386">if</span>&nbsp;<span class="ident" id="3682389">ip</span>&nbsp;<span class="op" id="3682392">=</span>&nbsp;<span class="ident" id="3682394">ip</span><span class="op" id="3682396">.</span><span class="ident" id="3682397">To4</span><span class="op" id="3682400">(</span><span class="op" id="3682401">)</span><span class="op" id="3682402">;</span>&nbsp;<span class="ident" id="3682404">ip</span>&nbsp;<span class="op" id="3682407">==</span>&nbsp;<span class="ident" id="3682410">nil</span>&nbsp;<span class="op" id="3682414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682419">return</span>&nbsp;<span class="ident" id="3682426">nil</span><span class="op" id="3682429">,</span>&nbsp;<span class="ident" id="3682431">InvalidAddrError</span><span class="op" id="3682447">(</span><span class="string" id="3682448">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="3682466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682474">sa</span>&nbsp;<span class="op" id="3682477">:=</span>&nbsp;<span class="builtinfunc" id="3682480">new</span><span class="op" id="3682483">(</span><span class="ident" id="3682484">syscall</span><span class="op" id="3682491">.</span><span class="ident" id="3682492">SockaddrInet4</span><span class="op" id="3682505">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682509">for</span>&nbsp;<span class="ident" id="3682513">i</span>&nbsp;<span class="op" id="3682515">:=</span>&nbsp;<span class="num" id="3682518">0</span><span class="op" id="3682519">;</span>&nbsp;<span class="ident" id="3682521">i</span>&nbsp;<span class="op" id="3682523">&lt;</span>&nbsp;<span class="ident" id="3682525">IPv4len</span><span class="op" id="3682532">;</span>&nbsp;<span class="ident" id="3682534">i</span><span class="op" id="3682535">++</span>&nbsp;<span class="op" id="3682538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682543">sa</span><span class="op" id="3682545">.</span><span class="ident" id="3682546">Addr</span><span class="op" id="3682550">[</span><span class="ident" id="3682551">i</span><span class="op" id="3682552">]</span>&nbsp;<span class="op" id="3682554">=</span>&nbsp;<span class="ident" id="3682556">ip</span><span class="op" id="3682558">[</span><span class="ident" id="3682559">i</span><span class="op" id="3682560">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682568">sa</span><span class="op" id="3682570">.</span><span class="ident" id="3682571">Port</span>&nbsp;<span class="op" id="3682576">=</span>&nbsp;<span class="ident" id="3682578">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682585">return</span>&nbsp;<span class="ident" id="3682592">sa</span><span class="op" id="3682594">,</span>&nbsp;<span class="ident" id="3682596">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682601">case</span>&nbsp;<span class="ident" id="3682606">syscall</span><span class="op" id="3682613">.</span><span class="ident" id="3682614">AF_INET6</span><span class="op" id="3682622">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682626">if</span>&nbsp;<span class="builtinfunc" id="3682629">len</span><span class="op" id="3682632">(</span><span class="ident" id="3682633">ip</span><span class="op" id="3682635">)</span>&nbsp;<span class="op" id="3682637">==</span>&nbsp;<span class="num" id="3682640">0</span>&nbsp;<span class="op" id="3682642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682647">ip</span>&nbsp;<span class="op" id="3682650">=</span>&nbsp;<span class="ident" id="3682652">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3682667">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3682742">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3682813">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682884">if</span>&nbsp;<span class="ident" id="3682887">ip</span><span class="op" id="3682889">.</span><span class="ident" id="3682890">Equal</span><span class="op" id="3682895">(</span><span class="ident" id="3682896">IPv4zero</span><span class="op" id="3682904">)</span>&nbsp;<span class="op" id="3682906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682911">ip</span>&nbsp;<span class="op" id="3682914">=</span>&nbsp;<span class="ident" id="3682916">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682927">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682931">if</span>&nbsp;<span class="ident" id="3682934">ip</span>&nbsp;<span class="op" id="3682937">=</span>&nbsp;<span class="ident" id="3682939">ip</span><span class="op" id="3682941">.</span><span class="ident" id="3682942">To16</span><span class="op" id="3682946">(</span><span class="op" id="3682947">)</span><span class="op" id="3682948">;</span>&nbsp;<span class="ident" id="3682950">ip</span>&nbsp;<span class="op" id="3682953">==</span>&nbsp;<span class="ident" id="3682956">nil</span>&nbsp;<span class="op" id="3682960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682965">return</span>&nbsp;<span class="ident" id="3682972">nil</span><span class="op" id="3682975">,</span>&nbsp;<span class="ident" id="3682977">InvalidAddrError</span><span class="op" id="3682993">(</span><span class="string" id="3682994">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="3683012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3683016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683020">sa</span>&nbsp;<span class="op" id="3683023">:=</span>&nbsp;<span class="builtinfunc" id="3683026">new</span><span class="op" id="3683029">(</span><span class="ident" id="3683030">syscall</span><span class="op" id="3683037">.</span><span class="ident" id="3683038">SockaddrInet6</span><span class="op" id="3683051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683055">for</span>&nbsp;<span class="ident" id="3683059">i</span>&nbsp;<span class="op" id="3683061">:=</span>&nbsp;<span class="num" id="3683064">0</span><span class="op" id="3683065">;</span>&nbsp;<span class="ident" id="3683067">i</span>&nbsp;<span class="op" id="3683069">&lt;</span>&nbsp;<span class="ident" id="3683071">IPv6len</span><span class="op" id="3683078">;</span>&nbsp;<span class="ident" id="3683080">i</span><span class="op" id="3683081">++</span>&nbsp;<span class="op" id="3683084">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683089">sa</span><span class="op" id="3683091">.</span><span class="ident" id="3683092">Addr</span><span class="op" id="3683096">[</span><span class="ident" id="3683097">i</span><span class="op" id="3683098">]</span>&nbsp;<span class="op" id="3683100">=</span>&nbsp;<span class="ident" id="3683102">ip</span><span class="op" id="3683104">[</span><span class="ident" id="3683105">i</span><span class="op" id="3683106">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3683110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683114">sa</span><span class="op" id="3683116">.</span><span class="ident" id="3683117">Port</span>&nbsp;<span class="op" id="3683122">=</span>&nbsp;<span class="ident" id="3683124">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683131">sa</span><span class="op" id="3683133">.</span><span class="ident" id="3683134">ZoneId</span>&nbsp;<span class="op" id="3683141">=</span>&nbsp;<span class="builtintype" id="3683143">uint32</span><span class="op" id="3683149">(</span><span class="ident" id="3683150">zoneToInt</span><span class="op" id="3683159">(</span><span class="ident" id="3683160">zone</span><span class="op" id="3683164">)</span><span class="op" id="3683165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683169">return</span>&nbsp;<span class="ident" id="3683176">sa</span><span class="op" id="3683178">,</span>&nbsp;<span class="ident" id="3683180">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3683185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683188">return</span>&nbsp;<span class="ident" id="3683195">nil</span><span class="op" id="3683198">,</span>&nbsp;<span class="ident" id="3683200">InvalidAddrError</span><span class="op" id="3683216">(</span><span class="string" id="3683217">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="3683243">)</span><br>
<span class="lineno"></span><span class="op" id="3683245">}</span>
</div>
</body>
</html>
