<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7538967">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7539022">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7539076">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7539127">package</span>&nbsp;<span class="ident" id="7539135">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7539146">import</span>&nbsp;<span class="op" id="7539153">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7539156">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7539165">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7539178">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7539189">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7539199">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7539202">func</span>&nbsp;<span class="ident" id="7539207">TestWriter</span><span class="op" id="7539217">(</span><span class="ident" id="7539218">t</span>&nbsp;<span class="op" id="7539220">*</span><span class="ident" id="7539221">testing</span><span class="op" id="7539228">.</span><span class="ident" id="7539229">T</span><span class="op" id="7539230">)</span>&nbsp;<span class="op" id="7539232">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539235">fileContents</span>&nbsp;<span class="op" id="7539248">:=</span>&nbsp;<span class="op" id="7539251">[</span><span class="op" id="7539252">]</span><span class="builtintype" id="7539253">byte</span><span class="op" id="7539257">(</span><span class="string" id="7539258">&#34;my&nbsp;file&nbsp;contents&#34;</span><span class="op" id="7539276">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539280">var</span>&nbsp;<span class="ident" id="7539284">b</span>&nbsp;<span class="ident" id="7539286">bytes</span><span class="op" id="7539291">.</span><span class="ident" id="7539292">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539300">w</span>&nbsp;<span class="op" id="7539302">:=</span>&nbsp;<span class="ident" id="7539305">NewWriter</span><span class="op" id="7539314">(</span><span class="op" id="7539315">&amp;</span><span class="ident" id="7539316">b</span><span class="op" id="7539317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539320">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539324">part</span><span class="op" id="7539328">,</span>&nbsp;<span class="ident" id="7539330">err</span>&nbsp;<span class="op" id="7539334">:=</span>&nbsp;<span class="ident" id="7539337">w</span><span class="op" id="7539338">.</span><span class="ident" id="7539339">CreateFormFile</span><span class="op" id="7539353">(</span><span class="string" id="7539354">&#34;myfile&#34;</span><span class="op" id="7539362">,</span>&nbsp;<span class="string" id="7539364">&#34;my-file.txt&#34;</span><span class="op" id="7539377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539381">if</span>&nbsp;<span class="ident" id="7539384">err</span>&nbsp;<span class="op" id="7539388">!=</span>&nbsp;<span class="ident" id="7539391">nil</span>&nbsp;<span class="op" id="7539395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539400">t</span><span class="op" id="7539401">.</span><span class="ident" id="7539402">Fatalf</span><span class="op" id="7539408">(</span><span class="string" id="7539409">&#34;CreateFormFile:&nbsp;%v&#34;</span><span class="op" id="7539429">,</span>&nbsp;<span class="ident" id="7539431">err</span><span class="op" id="7539434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539442">part</span><span class="op" id="7539446">.</span><span class="ident" id="7539447">Write</span><span class="op" id="7539452">(</span><span class="ident" id="7539453">fileContents</span><span class="op" id="7539465">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539469">err</span>&nbsp;<span class="op" id="7539473">=</span>&nbsp;<span class="ident" id="7539475">w</span><span class="op" id="7539476">.</span><span class="ident" id="7539477">WriteField</span><span class="op" id="7539487">(</span><span class="string" id="7539488">&#34;key&#34;</span><span class="op" id="7539493">,</span>&nbsp;<span class="string" id="7539495">&#34;val&#34;</span><span class="op" id="7539500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539504">if</span>&nbsp;<span class="ident" id="7539507">err</span>&nbsp;<span class="op" id="7539511">!=</span>&nbsp;<span class="ident" id="7539514">nil</span>&nbsp;<span class="op" id="7539518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539523">t</span><span class="op" id="7539524">.</span><span class="ident" id="7539525">Fatalf</span><span class="op" id="7539531">(</span><span class="string" id="7539532">&#34;WriteField:&nbsp;%v&#34;</span><span class="op" id="7539548">,</span>&nbsp;<span class="ident" id="7539550">err</span><span class="op" id="7539553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539561">part</span><span class="op" id="7539565">.</span><span class="ident" id="7539566">Write</span><span class="op" id="7539571">(</span><span class="op" id="7539572">[</span><span class="op" id="7539573">]</span><span class="builtintype" id="7539574">byte</span><span class="op" id="7539578">(</span><span class="string" id="7539579">&#34;val&#34;</span><span class="op" id="7539584">)</span><span class="op" id="7539585">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539589">err</span>&nbsp;<span class="op" id="7539593">=</span>&nbsp;<span class="ident" id="7539595">w</span><span class="op" id="7539596">.</span><span class="ident" id="7539597">Close</span><span class="op" id="7539602">(</span><span class="op" id="7539603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539607">if</span>&nbsp;<span class="ident" id="7539610">err</span>&nbsp;<span class="op" id="7539614">!=</span>&nbsp;<span class="ident" id="7539617">nil</span>&nbsp;<span class="op" id="7539621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539626">t</span><span class="op" id="7539627">.</span><span class="ident" id="7539628">Fatalf</span><span class="op" id="7539634">(</span><span class="string" id="7539635">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="7539646">,</span>&nbsp;<span class="ident" id="7539648">err</span><span class="op" id="7539651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539659">s</span>&nbsp;<span class="op" id="7539661">:=</span>&nbsp;<span class="ident" id="7539664">b</span><span class="op" id="7539665">.</span><span class="ident" id="7539666">String</span><span class="op" id="7539672">(</span><span class="op" id="7539673">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539677">if</span>&nbsp;<span class="builtinfunc" id="7539680">len</span><span class="op" id="7539683">(</span><span class="ident" id="7539684">s</span><span class="op" id="7539685">)</span>&nbsp;<span class="op" id="7539687">==</span>&nbsp;<span class="num" id="7539690">0</span>&nbsp;<span class="op" id="7539692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539697">t</span><span class="op" id="7539698">.</span><span class="ident" id="7539699">Fatal</span><span class="op" id="7539704">(</span><span class="string" id="7539705">&#34;String:&nbsp;unexpected&nbsp;empty&nbsp;result&#34;</span><span class="op" id="7539738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539746">if</span>&nbsp;<span class="ident" id="7539749">s</span><span class="op" id="7539750">[</span><span class="num" id="7539751">0</span><span class="op" id="7539752">]</span>&nbsp;<span class="op" id="7539754">==</span>&nbsp;<span class="string" id="7539757">&#39;\r&#39;</span>&nbsp;<span class="op" id="7539762">||</span>&nbsp;<span class="ident" id="7539765">s</span><span class="op" id="7539766">[</span><span class="num" id="7539767">0</span><span class="op" id="7539768">]</span>&nbsp;<span class="op" id="7539770">==</span>&nbsp;<span class="string" id="7539773">&#39;\n&#39;</span>&nbsp;<span class="op" id="7539778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539783">t</span><span class="op" id="7539784">.</span><span class="ident" id="7539785">Fatal</span><span class="op" id="7539790">(</span><span class="string" id="7539791">&#34;String:&nbsp;unexpected&nbsp;newline&#34;</span><span class="op" id="7539819">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539830">r</span>&nbsp;<span class="op" id="7539832">:=</span>&nbsp;<span class="ident" id="7539835">NewReader</span><span class="op" id="7539844">(</span><span class="op" id="7539845">&amp;</span><span class="ident" id="7539846">b</span><span class="op" id="7539847">,</span>&nbsp;<span class="ident" id="7539849">w</span><span class="op" id="7539850">.</span><span class="ident" id="7539851">Boundary</span><span class="op" id="7539859">(</span><span class="op" id="7539860">)</span><span class="op" id="7539861">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539865">part</span><span class="op" id="7539869">,</span>&nbsp;<span class="ident" id="7539871">err</span>&nbsp;<span class="op" id="7539875">:=</span>&nbsp;<span class="ident" id="7539878">r</span><span class="op" id="7539879">.</span><span class="ident" id="7539880">NextPart</span><span class="op" id="7539888">(</span><span class="op" id="7539889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539892">if</span>&nbsp;<span class="ident" id="7539895">err</span>&nbsp;<span class="op" id="7539899">!=</span>&nbsp;<span class="ident" id="7539902">nil</span>&nbsp;<span class="op" id="7539906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539910">t</span><span class="op" id="7539911">.</span><span class="ident" id="7539912">Fatalf</span><span class="op" id="7539918">(</span><span class="string" id="7539919">&#34;part&nbsp;1:&nbsp;%v&#34;</span><span class="op" id="7539931">,</span>&nbsp;<span class="ident" id="7539933">err</span><span class="op" id="7539936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539942">if</span>&nbsp;<span class="ident" id="7539945">g</span><span class="op" id="7539946">,</span>&nbsp;<span class="ident" id="7539948">e</span>&nbsp;<span class="op" id="7539950">:=</span>&nbsp;<span class="ident" id="7539953">part</span><span class="op" id="7539957">.</span><span class="ident" id="7539958">FormName</span><span class="op" id="7539966">(</span><span class="op" id="7539967">)</span><span class="op" id="7539968">,</span>&nbsp;<span class="string" id="7539970">&#34;myfile&#34;</span><span class="op" id="7539978">;</span>&nbsp;<span class="ident" id="7539980">g</span>&nbsp;<span class="op" id="7539982">!=</span>&nbsp;<span class="ident" id="7539985">e</span>&nbsp;<span class="op" id="7539987">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539991">t</span><span class="op" id="7539992">.</span><span class="ident" id="7539993">Errorf</span><span class="op" id="7539999">(</span><span class="string" id="7540000">&#34;part&nbsp;1:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7540035">,</span>&nbsp;<span class="ident" id="7540037">e</span><span class="op" id="7540038">,</span>&nbsp;<span class="ident" id="7540040">g</span><span class="op" id="7540041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540047">slurp</span><span class="op" id="7540052">,</span>&nbsp;<span class="ident" id="7540054">err</span>&nbsp;<span class="op" id="7540058">:=</span>&nbsp;<span class="ident" id="7540061">ioutil</span><span class="op" id="7540067">.</span><span class="ident" id="7540068">ReadAll</span><span class="op" id="7540075">(</span><span class="ident" id="7540076">part</span><span class="op" id="7540080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540083">if</span>&nbsp;<span class="ident" id="7540086">err</span>&nbsp;<span class="op" id="7540090">!=</span>&nbsp;<span class="ident" id="7540093">nil</span>&nbsp;<span class="op" id="7540097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540101">t</span><span class="op" id="7540102">.</span><span class="ident" id="7540103">Fatalf</span><span class="op" id="7540109">(</span><span class="string" id="7540110">&#34;part&nbsp;1:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="7540131">,</span>&nbsp;<span class="ident" id="7540133">err</span><span class="op" id="7540136">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540142">if</span>&nbsp;<span class="ident" id="7540145">e</span><span class="op" id="7540146">,</span>&nbsp;<span class="ident" id="7540148">g</span>&nbsp;<span class="op" id="7540150">:=</span>&nbsp;<span class="builtintype" id="7540153">string</span><span class="op" id="7540159">(</span><span class="ident" id="7540160">fileContents</span><span class="op" id="7540172">)</span><span class="op" id="7540173">,</span>&nbsp;<span class="builtintype" id="7540175">string</span><span class="op" id="7540181">(</span><span class="ident" id="7540182">slurp</span><span class="op" id="7540187">)</span><span class="op" id="7540188">;</span>&nbsp;<span class="ident" id="7540190">e</span>&nbsp;<span class="op" id="7540192">!=</span>&nbsp;<span class="ident" id="7540195">g</span>&nbsp;<span class="op" id="7540197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540201">t</span><span class="op" id="7540202">.</span><span class="ident" id="7540203">Errorf</span><span class="op" id="7540209">(</span><span class="string" id="7540210">&#34;part&nbsp;1:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7540244">,</span>&nbsp;<span class="ident" id="7540246">e</span><span class="op" id="7540247">,</span>&nbsp;<span class="ident" id="7540249">g</span><span class="op" id="7540250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540257">part</span><span class="op" id="7540261">,</span>&nbsp;<span class="ident" id="7540263">err</span>&nbsp;<span class="op" id="7540267">=</span>&nbsp;<span class="ident" id="7540269">r</span><span class="op" id="7540270">.</span><span class="ident" id="7540271">NextPart</span><span class="op" id="7540279">(</span><span class="op" id="7540280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540283">if</span>&nbsp;<span class="ident" id="7540286">err</span>&nbsp;<span class="op" id="7540290">!=</span>&nbsp;<span class="ident" id="7540293">nil</span>&nbsp;<span class="op" id="7540297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540301">t</span><span class="op" id="7540302">.</span><span class="ident" id="7540303">Fatalf</span><span class="op" id="7540309">(</span><span class="string" id="7540310">&#34;part&nbsp;2:&nbsp;%v&#34;</span><span class="op" id="7540322">,</span>&nbsp;<span class="ident" id="7540324">err</span><span class="op" id="7540327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540333">if</span>&nbsp;<span class="ident" id="7540336">g</span><span class="op" id="7540337">,</span>&nbsp;<span class="ident" id="7540339">e</span>&nbsp;<span class="op" id="7540341">:=</span>&nbsp;<span class="ident" id="7540344">part</span><span class="op" id="7540348">.</span><span class="ident" id="7540349">FormName</span><span class="op" id="7540357">(</span><span class="op" id="7540358">)</span><span class="op" id="7540359">,</span>&nbsp;<span class="string" id="7540361">&#34;key&#34;</span><span class="op" id="7540366">;</span>&nbsp;<span class="ident" id="7540368">g</span>&nbsp;<span class="op" id="7540370">!=</span>&nbsp;<span class="ident" id="7540373">e</span>&nbsp;<span class="op" id="7540375">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540379">t</span><span class="op" id="7540380">.</span><span class="ident" id="7540381">Errorf</span><span class="op" id="7540387">(</span><span class="string" id="7540388">&#34;part&nbsp;2:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7540423">,</span>&nbsp;<span class="ident" id="7540425">e</span><span class="op" id="7540426">,</span>&nbsp;<span class="ident" id="7540428">g</span><span class="op" id="7540429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540435">slurp</span><span class="op" id="7540440">,</span>&nbsp;<span class="ident" id="7540442">err</span>&nbsp;<span class="op" id="7540446">=</span>&nbsp;<span class="ident" id="7540448">ioutil</span><span class="op" id="7540454">.</span><span class="ident" id="7540455">ReadAll</span><span class="op" id="7540462">(</span><span class="ident" id="7540463">part</span><span class="op" id="7540467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540470">if</span>&nbsp;<span class="ident" id="7540473">err</span>&nbsp;<span class="op" id="7540477">!=</span>&nbsp;<span class="ident" id="7540480">nil</span>&nbsp;<span class="op" id="7540484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540488">t</span><span class="op" id="7540489">.</span><span class="ident" id="7540490">Fatalf</span><span class="op" id="7540496">(</span><span class="string" id="7540497">&#34;part&nbsp;2:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="7540518">,</span>&nbsp;<span class="ident" id="7540520">err</span><span class="op" id="7540523">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540529">if</span>&nbsp;<span class="ident" id="7540532">e</span><span class="op" id="7540533">,</span>&nbsp;<span class="ident" id="7540535">g</span>&nbsp;<span class="op" id="7540537">:=</span>&nbsp;<span class="string" id="7540540">&#34;val&#34;</span><span class="op" id="7540545">,</span>&nbsp;<span class="builtintype" id="7540547">string</span><span class="op" id="7540553">(</span><span class="ident" id="7540554">slurp</span><span class="op" id="7540559">)</span><span class="op" id="7540560">;</span>&nbsp;<span class="ident" id="7540562">e</span>&nbsp;<span class="op" id="7540564">!=</span>&nbsp;<span class="ident" id="7540567">g</span>&nbsp;<span class="op" id="7540569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540573">t</span><span class="op" id="7540574">.</span><span class="ident" id="7540575">Errorf</span><span class="op" id="7540581">(</span><span class="string" id="7540582">&#34;part&nbsp;2:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7540616">,</span>&nbsp;<span class="ident" id="7540618">e</span><span class="op" id="7540619">,</span>&nbsp;<span class="ident" id="7540621">g</span><span class="op" id="7540622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540629">part</span><span class="op" id="7540633">,</span>&nbsp;<span class="ident" id="7540635">err</span>&nbsp;<span class="op" id="7540639">=</span>&nbsp;<span class="ident" id="7540641">r</span><span class="op" id="7540642">.</span><span class="ident" id="7540643">NextPart</span><span class="op" id="7540651">(</span><span class="op" id="7540652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540655">if</span>&nbsp;<span class="ident" id="7540658">part</span>&nbsp;<span class="op" id="7540663">!=</span>&nbsp;<span class="ident" id="7540666">nil</span>&nbsp;<span class="op" id="7540670">||</span>&nbsp;<span class="ident" id="7540673">err</span>&nbsp;<span class="op" id="7540677">==</span>&nbsp;<span class="ident" id="7540680">nil</span>&nbsp;<span class="op" id="7540684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540688">t</span><span class="op" id="7540689">.</span><span class="ident" id="7540690">Fatalf</span><span class="op" id="7540696">(</span><span class="string" id="7540697">&#34;expected&nbsp;end&nbsp;of&nbsp;parts;&nbsp;got&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7540732">,</span>&nbsp;<span class="ident" id="7540734">part</span><span class="op" id="7540738">,</span>&nbsp;<span class="ident" id="7540740">err</span><span class="op" id="7540743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540746">}</span><br>
<span class="lineno"></span><span class="op" id="7540748">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="7540751">func</span>&nbsp;<span class="ident" id="7540756">TestWriterSetBoundary</span><span class="op" id="7540777">(</span><span class="ident" id="7540778">t</span>&nbsp;<span class="op" id="7540780">*</span><span class="ident" id="7540781">testing</span><span class="op" id="7540788">.</span><span class="ident" id="7540789">T</span><span class="op" id="7540790">)</span>&nbsp;<span class="op" id="7540792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540795">var</span>&nbsp;<span class="ident" id="7540799">b</span>&nbsp;<span class="ident" id="7540801">bytes</span><span class="op" id="7540806">.</span><span class="ident" id="7540807">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540815">w</span>&nbsp;<span class="op" id="7540817">:=</span>&nbsp;<span class="ident" id="7540820">NewWriter</span><span class="op" id="7540829">(</span><span class="op" id="7540830">&amp;</span><span class="ident" id="7540831">b</span><span class="op" id="7540832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540835">tests</span>&nbsp;<span class="op" id="7540841">:=</span>&nbsp;<span class="op" id="7540844">[</span><span class="op" id="7540845">]</span><span class="keyword" id="7540846">struct</span>&nbsp;<span class="op" id="7540853">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540857">b</span>&nbsp;&nbsp;<span class="builtintype" id="7540860">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540869">ok</span>&nbsp;<span class="builtintype" id="7540872">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540878">}</span><span class="op" id="7540879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540883">{</span><span class="string" id="7540884">&#34;abc&#34;</span><span class="op" id="7540889">,</span>&nbsp;<span class="builtintype" id="7540891">true</span><span class="op" id="7540895">}</span><span class="op" id="7540896">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540900">{</span><span class="string" id="7540901">&#34;&#34;</span><span class="op" id="7540903">,</span>&nbsp;<span class="builtintype" id="7540905">false</span><span class="op" id="7540910">}</span><span class="op" id="7540911">,</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540915">{</span><span class="string" id="7540916">&#34;ungültig&#34;</span><span class="op" id="7540927">,</span>&nbsp;<span class="builtintype" id="7540929">false</span><span class="op" id="7540934">}</span><span class="op" id="7540935">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540939">{</span><span class="string" id="7540940">&#34;!&#34;</span><span class="op" id="7540943">,</span>&nbsp;<span class="builtintype" id="7540945">false</span><span class="op" id="7540950">}</span><span class="op" id="7540951">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540955">{</span><span class="ident" id="7540956">strings</span><span class="op" id="7540963">.</span><span class="ident" id="7540964">Repeat</span><span class="op" id="7540970">(</span><span class="string" id="7540971">&#34;x&#34;</span><span class="op" id="7540974">,</span>&nbsp;<span class="num" id="7540976">69</span><span class="op" id="7540978">)</span><span class="op" id="7540979">,</span>&nbsp;<span class="builtintype" id="7540981">true</span><span class="op" id="7540985">}</span><span class="op" id="7540986">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540990">{</span><span class="ident" id="7540991">strings</span><span class="op" id="7540998">.</span><span class="ident" id="7540999">Repeat</span><span class="op" id="7541005">(</span><span class="string" id="7541006">&#34;x&#34;</span><span class="op" id="7541009">,</span>&nbsp;<span class="num" id="7541011">70</span><span class="op" id="7541013">)</span><span class="op" id="7541014">,</span>&nbsp;<span class="builtintype" id="7541016">false</span><span class="op" id="7541021">}</span><span class="op" id="7541022">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541026">{</span><span class="string" id="7541027">&#34;bad!ascii!&#34;</span><span class="op" id="7541039">,</span>&nbsp;<span class="builtintype" id="7541041">false</span><span class="op" id="7541046">}</span><span class="op" id="7541047">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541051">{</span><span class="string" id="7541052">&#34;my-separator&#34;</span><span class="op" id="7541066">,</span>&nbsp;<span class="builtintype" id="7541068">true</span><span class="op" id="7541072">}</span><span class="op" id="7541073">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7541079">for</span>&nbsp;<span class="ident" id="7541083">i</span><span class="op" id="7541084">,</span>&nbsp;<span class="ident" id="7541086">tt</span>&nbsp;<span class="op" id="7541089">:=</span>&nbsp;<span class="keyword" id="7541092">range</span>&nbsp;<span class="ident" id="7541098">tests</span>&nbsp;<span class="op" id="7541104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541108">err</span>&nbsp;<span class="op" id="7541112">:=</span>&nbsp;<span class="ident" id="7541115">w</span><span class="op" id="7541116">.</span><span class="ident" id="7541117">SetBoundary</span><span class="op" id="7541128">(</span><span class="ident" id="7541129">tt</span><span class="op" id="7541131">.</span><span class="ident" id="7541132">b</span><span class="op" id="7541133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541137">got</span>&nbsp;<span class="op" id="7541141">:=</span>&nbsp;<span class="ident" id="7541144">err</span>&nbsp;<span class="op" id="7541148">==</span>&nbsp;<span class="ident" id="7541151">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7541157">if</span>&nbsp;<span class="ident" id="7541160">got</span>&nbsp;<span class="op" id="7541164">!=</span>&nbsp;<span class="ident" id="7541167">tt</span><span class="op" id="7541169">.</span><span class="ident" id="7541170">ok</span>&nbsp;<span class="op" id="7541173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541178">t</span><span class="op" id="7541179">.</span><span class="ident" id="7541180">Errorf</span><span class="op" id="7541186">(</span><span class="string" id="7541187">&#34;%d.&nbsp;boundary&nbsp;%q&nbsp;=&nbsp;%v&nbsp;(%v);&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7541223">,</span>&nbsp;<span class="ident" id="7541225">i</span><span class="op" id="7541226">,</span>&nbsp;<span class="ident" id="7541228">tt</span><span class="op" id="7541230">.</span><span class="ident" id="7541231">b</span><span class="op" id="7541232">,</span>&nbsp;<span class="ident" id="7541234">got</span><span class="op" id="7541237">,</span>&nbsp;<span class="ident" id="7541239">err</span><span class="op" id="7541242">,</span>&nbsp;<span class="ident" id="7541244">tt</span><span class="op" id="7541246">.</span><span class="ident" id="7541247">ok</span><span class="op" id="7541249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541253">}</span>&nbsp;<span class="keyword" id="7541255">else</span>&nbsp;<span class="keyword" id="7541260">if</span>&nbsp;<span class="ident" id="7541263">tt</span><span class="op" id="7541265">.</span><span class="ident" id="7541266">ok</span>&nbsp;<span class="op" id="7541269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541274">got</span>&nbsp;<span class="op" id="7541278">:=</span>&nbsp;<span class="ident" id="7541281">w</span><span class="op" id="7541282">.</span><span class="ident" id="7541283">Boundary</span><span class="op" id="7541291">(</span><span class="op" id="7541292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7541297">if</span>&nbsp;<span class="ident" id="7541300">got</span>&nbsp;<span class="op" id="7541304">!=</span>&nbsp;<span class="ident" id="7541307">tt</span><span class="op" id="7541309">.</span><span class="ident" id="7541310">b</span>&nbsp;<span class="op" id="7541312">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541318">t</span><span class="op" id="7541319">.</span><span class="ident" id="7541320">Errorf</span><span class="op" id="7541326">(</span><span class="string" id="7541327">&#34;boundary&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7541351">,</span>&nbsp;<span class="ident" id="7541353">got</span><span class="op" id="7541356">,</span>&nbsp;<span class="ident" id="7541358">tt</span><span class="op" id="7541360">.</span><span class="ident" id="7541361">b</span><span class="op" id="7541362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541377">w</span><span class="op" id="7541378">.</span><span class="ident" id="7541379">Close</span><span class="op" id="7541384">(</span><span class="op" id="7541385">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7541388">if</span>&nbsp;<span class="ident" id="7541391">got</span>&nbsp;<span class="op" id="7541395">:=</span>&nbsp;<span class="ident" id="7541398">b</span><span class="op" id="7541399">.</span><span class="ident" id="7541400">String</span><span class="op" id="7541406">(</span><span class="op" id="7541407">)</span><span class="op" id="7541408">;</span>&nbsp;<span class="op" id="7541410">!</span><span class="ident" id="7541411">strings</span><span class="op" id="7541418">.</span><span class="ident" id="7541419">Contains</span><span class="op" id="7541427">(</span><span class="ident" id="7541428">got</span><span class="op" id="7541431">,</span>&nbsp;<span class="string" id="7541433">&#34;\r\n--my-separator--\r\n&#34;</span><span class="op" id="7541459">)</span>&nbsp;<span class="op" id="7541461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541465">t</span><span class="op" id="7541466">.</span><span class="ident" id="7541467">Errorf</span><span class="op" id="7541473">(</span><span class="string" id="7541474">&#34;expected&nbsp;my-separator&nbsp;in&nbsp;output.&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="7541516">,</span>&nbsp;<span class="ident" id="7541518">got</span><span class="op" id="7541521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541524">}</span><br>
<span class="lineno"></span><span class="op" id="7541526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7541529">func</span>&nbsp;<span class="ident" id="7541534">TestWriterBoundaryGoroutines</span><span class="op" id="7541562">(</span><span class="ident" id="7541563">t</span>&nbsp;<span class="op" id="7541565">*</span><span class="ident" id="7541566">testing</span><span class="op" id="7541573">.</span><span class="ident" id="7541574">T</span><span class="op" id="7541575">)</span>&nbsp;<span class="op" id="7541577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7541580">//&nbsp;Verify&nbsp;there&#39;s&nbsp;no&nbsp;data&nbsp;race&nbsp;accessing&nbsp;any&nbsp;lazy&nbsp;boundary&nbsp;if&nbsp;it&#39;s&nbsp;used&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7541656">//&nbsp;different&nbsp;goroutines.&nbsp;This&nbsp;was&nbsp;previously&nbsp;broken&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7541712">//&nbsp;https://codereview.appspot.com/95760043/&nbsp;and&nbsp;reverted&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7541773">//&nbsp;https://codereview.appspot.com/117600043/</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541819">w</span>&nbsp;<span class="op" id="7541821">:=</span>&nbsp;<span class="ident" id="7541824">NewWriter</span><span class="op" id="7541833">(</span><span class="ident" id="7541834">ioutil</span><span class="op" id="7541840">.</span><span class="ident" id="7541841">Discard</span><span class="op" id="7541848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541851">done</span>&nbsp;<span class="op" id="7541856">:=</span>&nbsp;<span class="builtinfunc" id="7541859">make</span><span class="op" id="7541863">(</span><span class="keyword" id="7541864">chan</span>&nbsp;<span class="builtintype" id="7541869">int</span><span class="op" id="7541872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7541875">go</span>&nbsp;<span class="keyword" id="7541878">func</span><span class="op" id="7541882">(</span><span class="op" id="7541883">)</span>&nbsp;<span class="op" id="7541885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541889">w</span><span class="op" id="7541890">.</span><span class="ident" id="7541891">CreateFormField</span><span class="op" id="7541906">(</span><span class="string" id="7541907">&#34;foo&#34;</span><span class="op" id="7541912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541916">done</span>&nbsp;<span class="op" id="7541921">&lt;-</span>&nbsp;<span class="num" id="7541924">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541927">}</span><span class="op" id="7541928">(</span><span class="op" id="7541929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541932">w</span><span class="op" id="7541933">.</span><span class="ident" id="7541934">Boundary</span><span class="op" id="7541942">(</span><span class="op" id="7541943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541946">&lt;-</span><span class="ident" id="7541948">done</span><br>
<span class="lineno"></span><span class="op" id="7541953">}</span>
</div>
</body>
</html>
