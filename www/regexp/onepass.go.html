<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5171022">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5171078">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5171132">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5171183">package</span>&nbsp;<span class="ident" id="5171191">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5171199">import</span>&nbsp;<span class="op" id="5171206">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5171209">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5171218">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5171235">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5171243">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="5171253">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5171256">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="5171288">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="5171354">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5171426">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="5171480">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5171528">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5171596">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="5171664">type</span>&nbsp;<span class="ident" id="5171669">onePassProg</span>&nbsp;<span class="keyword" id="5171681">struct</span>&nbsp;<span class="op" id="5171688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171691">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5171698">[</span><span class="op" id="5171699">]</span><span class="ident" id="5171700">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171713">Start</span>&nbsp;&nbsp;<span class="builtintype" id="5171720">int</span>&nbsp;<span class="comment" id="5171724">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171755">NumCap</span>&nbsp;<span class="builtintype" id="5171762">int</span>&nbsp;<span class="comment" id="5171766">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="5171803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5171806">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5171889">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="5171955">type</span>&nbsp;<span class="ident" id="5171960">onePassInst</span>&nbsp;<span class="keyword" id="5171972">struct</span>&nbsp;<span class="op" id="5171979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171982">syntax</span><span class="op" id="5171988">.</span><span class="ident" id="5171989">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5171995">Next</span>&nbsp;<span class="op" id="5172000">[</span><span class="op" id="5172001">]</span><span class="builtintype" id="5172002">uint32</span><br>
<span class="lineno"></span><span class="op" id="5172009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5172012">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5172079">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="5172138">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5172207">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="5172268">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="5172286">func</span>&nbsp;<span class="ident" id="5172291">onePassPrefix</span><span class="op" id="5172304">(</span><span class="ident" id="5172305">p</span>&nbsp;<span class="op" id="5172307">*</span><span class="ident" id="5172308">syntax</span><span class="op" id="5172314">.</span><span class="ident" id="5172315">Prog</span><span class="op" id="5172319">)</span>&nbsp;<span class="op" id="5172321">(</span><span class="ident" id="5172322">prefix</span>&nbsp;<span class="builtintype" id="5172329">string</span><span class="op" id="5172335">,</span>&nbsp;<span class="ident" id="5172337">complete</span>&nbsp;<span class="builtintype" id="5172346">bool</span><span class="op" id="5172350">,</span>&nbsp;<span class="ident" id="5172352">pc</span>&nbsp;<span class="builtintype" id="5172355">uint32</span><span class="op" id="5172361">)</span>&nbsp;<span class="op" id="5172363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172366">i</span>&nbsp;<span class="op" id="5172368">:=</span>&nbsp;<span class="op" id="5172371">&amp;</span><span class="ident" id="5172372">p</span><span class="op" id="5172373">.</span><span class="ident" id="5172374">Inst</span><span class="op" id="5172378">[</span><span class="ident" id="5172379">p</span><span class="op" id="5172380">.</span><span class="ident" id="5172381">Start</span><span class="op" id="5172386">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172389">if</span>&nbsp;<span class="ident" id="5172392">i</span><span class="op" id="5172393">.</span><span class="ident" id="5172394">Op</span>&nbsp;<span class="op" id="5172397">!=</span>&nbsp;<span class="ident" id="5172400">syntax</span><span class="op" id="5172406">.</span><span class="ident" id="5172407">InstEmptyWidth</span>&nbsp;<span class="op" id="5172422">||</span>&nbsp;<span class="op" id="5172425">(</span><span class="ident" id="5172426">syntax</span><span class="op" id="5172432">.</span><span class="ident" id="5172433">EmptyOp</span><span class="op" id="5172440">(</span><span class="ident" id="5172441">i</span><span class="op" id="5172442">.</span><span class="ident" id="5172443">Arg</span><span class="op" id="5172446">)</span><span class="op" id="5172447">)</span><span class="op" id="5172448">&amp;</span><span class="ident" id="5172449">syntax</span><span class="op" id="5172455">.</span><span class="ident" id="5172456">EmptyBeginText</span>&nbsp;<span class="op" id="5172471">==</span>&nbsp;<span class="num" id="5172474">0</span>&nbsp;<span class="op" id="5172476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172480">return</span>&nbsp;<span class="string" id="5172487">&#34;&#34;</span><span class="op" id="5172489">,</span>&nbsp;<span class="ident" id="5172491">i</span><span class="op" id="5172492">.</span><span class="ident" id="5172493">Op</span>&nbsp;<span class="op" id="5172496">==</span>&nbsp;<span class="ident" id="5172499">syntax</span><span class="op" id="5172505">.</span><span class="ident" id="5172506">InstMatch</span><span class="op" id="5172515">,</span>&nbsp;<span class="builtintype" id="5172517">uint32</span><span class="op" id="5172523">(</span><span class="ident" id="5172524">p</span><span class="op" id="5172525">.</span><span class="ident" id="5172526">Start</span><span class="op" id="5172531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5172534">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172537">pc</span>&nbsp;<span class="op" id="5172540">=</span>&nbsp;<span class="ident" id="5172542">i</span><span class="op" id="5172543">.</span><span class="ident" id="5172544">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172549">i</span>&nbsp;<span class="op" id="5172551">=</span>&nbsp;<span class="op" id="5172553">&amp;</span><span class="ident" id="5172554">p</span><span class="op" id="5172555">.</span><span class="ident" id="5172556">Inst</span><span class="op" id="5172560">[</span><span class="ident" id="5172561">pc</span><span class="op" id="5172563">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172566">for</span>&nbsp;<span class="ident" id="5172570">i</span><span class="op" id="5172571">.</span><span class="ident" id="5172572">Op</span>&nbsp;<span class="op" id="5172575">==</span>&nbsp;<span class="ident" id="5172578">syntax</span><span class="op" id="5172584">.</span><span class="ident" id="5172585">InstNop</span>&nbsp;<span class="op" id="5172593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172597">pc</span>&nbsp;<span class="op" id="5172600">=</span>&nbsp;<span class="ident" id="5172602">i</span><span class="op" id="5172603">.</span><span class="ident" id="5172604">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172610">i</span>&nbsp;<span class="op" id="5172612">=</span>&nbsp;<span class="op" id="5172614">&amp;</span><span class="ident" id="5172615">p</span><span class="op" id="5172616">.</span><span class="ident" id="5172617">Inst</span><span class="op" id="5172621">[</span><span class="ident" id="5172622">pc</span><span class="op" id="5172624">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5172627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5172630">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172681">if</span>&nbsp;<span class="ident" id="5172684">iop</span><span class="op" id="5172687">(</span><span class="ident" id="5172688">i</span><span class="op" id="5172689">)</span>&nbsp;<span class="op" id="5172691">!=</span>&nbsp;<span class="ident" id="5172694">syntax</span><span class="op" id="5172700">.</span><span class="ident" id="5172701">InstRune</span>&nbsp;<span class="op" id="5172710">||</span>&nbsp;<span class="builtinfunc" id="5172713">len</span><span class="op" id="5172716">(</span><span class="ident" id="5172717">i</span><span class="op" id="5172718">.</span><span class="ident" id="5172719">Rune</span><span class="op" id="5172723">)</span>&nbsp;<span class="op" id="5172725">!=</span>&nbsp;<span class="num" id="5172728">1</span>&nbsp;<span class="op" id="5172730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172734">return</span>&nbsp;<span class="string" id="5172741">&#34;&#34;</span><span class="op" id="5172743">,</span>&nbsp;<span class="ident" id="5172745">i</span><span class="op" id="5172746">.</span><span class="ident" id="5172747">Op</span>&nbsp;<span class="op" id="5172750">==</span>&nbsp;<span class="ident" id="5172753">syntax</span><span class="op" id="5172759">.</span><span class="ident" id="5172760">InstMatch</span><span class="op" id="5172769">,</span>&nbsp;<span class="builtintype" id="5172771">uint32</span><span class="op" id="5172777">(</span><span class="ident" id="5172778">p</span><span class="op" id="5172779">.</span><span class="ident" id="5172780">Start</span><span class="op" id="5172785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5172788">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5172792">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172828">var</span>&nbsp;<span class="ident" id="5172832">buf</span>&nbsp;<span class="ident" id="5172836">bytes</span><span class="op" id="5172841">.</span><span class="ident" id="5172842">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5172850">for</span>&nbsp;<span class="ident" id="5172854">iop</span><span class="op" id="5172857">(</span><span class="ident" id="5172858">i</span><span class="op" id="5172859">)</span>&nbsp;<span class="op" id="5172861">==</span>&nbsp;<span class="ident" id="5172864">syntax</span><span class="op" id="5172870">.</span><span class="ident" id="5172871">InstRune</span>&nbsp;<span class="op" id="5172880">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5172883">len</span><span class="op" id="5172886">(</span><span class="ident" id="5172887">i</span><span class="op" id="5172888">.</span><span class="ident" id="5172889">Rune</span><span class="op" id="5172893">)</span>&nbsp;<span class="op" id="5172895">==</span>&nbsp;<span class="num" id="5172898">1</span>&nbsp;<span class="op" id="5172900">&amp;&amp;</span>&nbsp;<span class="ident" id="5172903">syntax</span><span class="op" id="5172909">.</span><span class="ident" id="5172910">Flags</span><span class="op" id="5172915">(</span><span class="ident" id="5172916">i</span><span class="op" id="5172917">.</span><span class="ident" id="5172918">Arg</span><span class="op" id="5172921">)</span><span class="op" id="5172922">&amp;</span><span class="ident" id="5172923">syntax</span><span class="op" id="5172929">.</span><span class="ident" id="5172930">FoldCase</span>&nbsp;<span class="op" id="5172939">==</span>&nbsp;<span class="num" id="5172942">0</span>&nbsp;<span class="op" id="5172944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172948">buf</span><span class="op" id="5172951">.</span><span class="ident" id="5172952">WriteRune</span><span class="op" id="5172961">(</span><span class="ident" id="5172962">i</span><span class="op" id="5172963">.</span><span class="ident" id="5172964">Rune</span><span class="op" id="5172968">[</span><span class="num" id="5172969">0</span><span class="op" id="5172970">]</span><span class="op" id="5172971">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5172975">pc</span><span class="op" id="5172977">,</span>&nbsp;<span class="ident" id="5172979">i</span>&nbsp;<span class="op" id="5172981">=</span>&nbsp;<span class="ident" id="5172983">i</span><span class="op" id="5172984">.</span><span class="ident" id="5172985">Out</span><span class="op" id="5172988">,</span>&nbsp;<span class="op" id="5172990">&amp;</span><span class="ident" id="5172991">p</span><span class="op" id="5172992">.</span><span class="ident" id="5172993">Inst</span><span class="op" id="5172997">[</span><span class="ident" id="5172998">i</span><span class="op" id="5172999">.</span><span class="ident" id="5173000">Out</span><span class="op" id="5173003">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5173006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173009">return</span>&nbsp;<span class="ident" id="5173016">buf</span><span class="op" id="5173019">.</span><span class="ident" id="5173020">String</span><span class="op" id="5173026">(</span><span class="op" id="5173027">)</span><span class="op" id="5173028">,</span>&nbsp;<span class="ident" id="5173030">i</span><span class="op" id="5173031">.</span><span class="ident" id="5173032">Op</span>&nbsp;<span class="op" id="5173035">==</span>&nbsp;<span class="ident" id="5173038">syntax</span><span class="op" id="5173044">.</span><span class="ident" id="5173045">InstEmptyWidth</span>&nbsp;<span class="op" id="5173060">&amp;&amp;</span>&nbsp;<span class="op" id="5173063">(</span><span class="ident" id="5173064">syntax</span><span class="op" id="5173070">.</span><span class="ident" id="5173071">EmptyOp</span><span class="op" id="5173078">(</span><span class="ident" id="5173079">i</span><span class="op" id="5173080">.</span><span class="ident" id="5173081">Arg</span><span class="op" id="5173084">)</span><span class="op" id="5173085">)</span><span class="op" id="5173086">&amp;</span><span class="ident" id="5173087">syntax</span><span class="op" id="5173093">.</span><span class="ident" id="5173094">EmptyBeginText</span>&nbsp;<span class="op" id="5173109">!=</span>&nbsp;<span class="num" id="5173112">0</span><span class="op" id="5173113">,</span>&nbsp;<span class="ident" id="5173115">pc</span><br>
<span class="lineno"></span><span class="op" id="5173118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5173121">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5173213">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="5173310">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5173404">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="5173489">func</span>&nbsp;<span class="ident" id="5173494">onePassNext</span><span class="op" id="5173505">(</span><span class="ident" id="5173506">i</span>&nbsp;<span class="op" id="5173508">*</span><span class="ident" id="5173509">onePassInst</span><span class="op" id="5173520">,</span>&nbsp;<span class="ident" id="5173522">r</span>&nbsp;<span class="builtintype" id="5173524">rune</span><span class="op" id="5173528">)</span>&nbsp;<span class="builtintype" id="5173530">uint32</span>&nbsp;<span class="op" id="5173537">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173540">next</span>&nbsp;<span class="op" id="5173545">:=</span>&nbsp;<span class="ident" id="5173548">i</span><span class="op" id="5173549">.</span><span class="ident" id="5173550">MatchRunePos</span><span class="op" id="5173562">(</span><span class="ident" id="5173563">r</span><span class="op" id="5173564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173567">if</span>&nbsp;<span class="ident" id="5173570">next</span>&nbsp;<span class="op" id="5173575">&gt;=</span>&nbsp;<span class="num" id="5173578">0</span>&nbsp;<span class="op" id="5173580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173584">return</span>&nbsp;<span class="ident" id="5173591">i</span><span class="op" id="5173592">.</span><span class="ident" id="5173593">Next</span><span class="op" id="5173597">[</span><span class="ident" id="5173598">next</span><span class="op" id="5173602">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5173605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173608">if</span>&nbsp;<span class="ident" id="5173611">i</span><span class="op" id="5173612">.</span><span class="ident" id="5173613">Op</span>&nbsp;<span class="op" id="5173616">==</span>&nbsp;<span class="ident" id="5173619">syntax</span><span class="op" id="5173625">.</span><span class="ident" id="5173626">InstAltMatch</span>&nbsp;<span class="op" id="5173639">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173643">return</span>&nbsp;<span class="ident" id="5173650">i</span><span class="op" id="5173651">.</span><span class="ident" id="5173652">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5173657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173660">return</span>&nbsp;<span class="num" id="5173667">0</span><br>
<span class="lineno"></span><span class="op" id="5173669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5173672">func</span>&nbsp;<span class="ident" id="5173677">iop</span><span class="op" id="5173680">(</span><span class="ident" id="5173681">i</span>&nbsp;<span class="op" id="5173683">*</span><span class="ident" id="5173684">syntax</span><span class="op" id="5173690">.</span><span class="ident" id="5173691">Inst</span><span class="op" id="5173695">)</span>&nbsp;<span class="ident" id="5173697">syntax</span><span class="op" id="5173703">.</span><span class="ident" id="5173704">InstOp</span>&nbsp;<span class="op" id="5173711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173714">op</span>&nbsp;<span class="op" id="5173717">:=</span>&nbsp;<span class="ident" id="5173720">i</span><span class="op" id="5173721">.</span><span class="ident" id="5173722">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173726">switch</span>&nbsp;<span class="ident" id="5173733">op</span>&nbsp;<span class="op" id="5173736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173739">case</span>&nbsp;<span class="ident" id="5173744">syntax</span><span class="op" id="5173750">.</span><span class="ident" id="5173751">InstRune1</span><span class="op" id="5173760">,</span>&nbsp;<span class="ident" id="5173762">syntax</span><span class="op" id="5173768">.</span><span class="ident" id="5173769">InstRuneAny</span><span class="op" id="5173780">,</span>&nbsp;<span class="ident" id="5173782">syntax</span><span class="op" id="5173788">.</span><span class="ident" id="5173789">InstRuneAnyNotNL</span><span class="op" id="5173805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173809">op</span>&nbsp;<span class="op" id="5173812">=</span>&nbsp;<span class="ident" id="5173814">syntax</span><span class="op" id="5173820">.</span><span class="ident" id="5173821">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5173831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5173834">return</span>&nbsp;<span class="ident" id="5173841">op</span><br>
<span class="lineno"></span><span class="op" id="5173844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5173847">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="5173905">type</span>&nbsp;<span class="ident" id="5173910">queueOnePass</span>&nbsp;<span class="keyword" id="5173923">struct</span>&nbsp;<span class="op" id="5173930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173933">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173949">[</span><span class="op" id="5173950">]</span><span class="builtintype" id="5173951">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173959">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173975">[</span><span class="op" id="5173976">]</span><span class="builtintype" id="5173977">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5173985">size</span><span class="op" id="5173989">,</span>&nbsp;<span class="ident" id="5173991">nextIndex</span>&nbsp;<span class="builtintype" id="5174001">uint32</span><br>
<span class="lineno"></span><span class="op" id="5174008">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="5174011">func</span>&nbsp;<span class="op" id="5174016">(</span><span class="ident" id="5174017">q</span>&nbsp;<span class="op" id="5174019">*</span><span class="ident" id="5174020">queueOnePass</span><span class="op" id="5174032">)</span>&nbsp;<span class="ident" id="5174034">empty</span><span class="op" id="5174039">(</span><span class="op" id="5174040">)</span>&nbsp;<span class="builtintype" id="5174042">bool</span>&nbsp;<span class="op" id="5174047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174050">return</span>&nbsp;<span class="ident" id="5174057">q</span><span class="op" id="5174058">.</span><span class="ident" id="5174059">nextIndex</span>&nbsp;<span class="op" id="5174069">&gt;=</span>&nbsp;<span class="ident" id="5174072">q</span><span class="op" id="5174073">.</span><span class="ident" id="5174074">size</span><br>
<span class="lineno"></span><span class="op" id="5174079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5174082">func</span>&nbsp;<span class="op" id="5174087">(</span><span class="ident" id="5174088">q</span>&nbsp;<span class="op" id="5174090">*</span><span class="ident" id="5174091">queueOnePass</span><span class="op" id="5174103">)</span>&nbsp;<span class="ident" id="5174105">next</span><span class="op" id="5174109">(</span><span class="op" id="5174110">)</span>&nbsp;<span class="op" id="5174112">(</span><span class="ident" id="5174113">n</span>&nbsp;<span class="builtintype" id="5174115">uint32</span><span class="op" id="5174121">)</span>&nbsp;<span class="op" id="5174123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174126">n</span>&nbsp;<span class="op" id="5174128">=</span>&nbsp;<span class="ident" id="5174130">q</span><span class="op" id="5174131">.</span><span class="ident" id="5174132">dense</span><span class="op" id="5174137">[</span><span class="ident" id="5174138">q</span><span class="op" id="5174139">.</span><span class="ident" id="5174140">nextIndex</span><span class="op" id="5174149">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174152">q</span><span class="op" id="5174153">.</span><span class="ident" id="5174154">nextIndex</span><span class="op" id="5174163">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174167">return</span><br>
<span class="lineno"></span><span class="op" id="5174174">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="5174177">func</span>&nbsp;<span class="op" id="5174182">(</span><span class="ident" id="5174183">q</span>&nbsp;<span class="op" id="5174185">*</span><span class="ident" id="5174186">queueOnePass</span><span class="op" id="5174198">)</span>&nbsp;<span class="ident" id="5174200">clear</span><span class="op" id="5174205">(</span><span class="op" id="5174206">)</span>&nbsp;<span class="op" id="5174208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174211">q</span><span class="op" id="5174212">.</span><span class="ident" id="5174213">size</span>&nbsp;<span class="op" id="5174218">=</span>&nbsp;<span class="num" id="5174220">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174223">q</span><span class="op" id="5174224">.</span><span class="ident" id="5174225">nextIndex</span>&nbsp;<span class="op" id="5174235">=</span>&nbsp;<span class="num" id="5174237">0</span><br>
<span class="lineno"></span><span class="op" id="5174239">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5174242">func</span>&nbsp;<span class="op" id="5174247">(</span><span class="ident" id="5174248">q</span>&nbsp;<span class="op" id="5174250">*</span><span class="ident" id="5174251">queueOnePass</span><span class="op" id="5174263">)</span>&nbsp;<span class="ident" id="5174265">reset</span><span class="op" id="5174270">(</span><span class="op" id="5174271">)</span>&nbsp;<span class="op" id="5174273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174276">q</span><span class="op" id="5174277">.</span><span class="ident" id="5174278">nextIndex</span>&nbsp;<span class="op" id="5174288">=</span>&nbsp;<span class="num" id="5174290">0</span><br>
<span class="lineno"></span><span class="op" id="5174292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="5174295">func</span>&nbsp;<span class="op" id="5174300">(</span><span class="ident" id="5174301">q</span>&nbsp;<span class="op" id="5174303">*</span><span class="ident" id="5174304">queueOnePass</span><span class="op" id="5174316">)</span>&nbsp;<span class="ident" id="5174318">contains</span><span class="op" id="5174326">(</span><span class="ident" id="5174327">u</span>&nbsp;<span class="builtintype" id="5174329">uint32</span><span class="op" id="5174335">)</span>&nbsp;<span class="builtintype" id="5174337">bool</span>&nbsp;<span class="op" id="5174342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174345">if</span>&nbsp;<span class="ident" id="5174348">u</span>&nbsp;<span class="op" id="5174350">&gt;=</span>&nbsp;<span class="builtintype" id="5174353">uint32</span><span class="op" id="5174359">(</span><span class="builtinfunc" id="5174360">len</span><span class="op" id="5174363">(</span><span class="ident" id="5174364">q</span><span class="op" id="5174365">.</span><span class="ident" id="5174366">sparse</span><span class="op" id="5174372">)</span><span class="op" id="5174373">)</span>&nbsp;<span class="op" id="5174375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174379">return</span>&nbsp;<span class="ident" id="5174386">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174396">return</span>&nbsp;<span class="ident" id="5174403">q</span><span class="op" id="5174404">.</span><span class="ident" id="5174405">sparse</span><span class="op" id="5174411">[</span><span class="ident" id="5174412">u</span><span class="op" id="5174413">]</span>&nbsp;<span class="op" id="5174415">&lt;</span>&nbsp;<span class="ident" id="5174417">q</span><span class="op" id="5174418">.</span><span class="ident" id="5174419">size</span>&nbsp;<span class="op" id="5174424">&amp;&amp;</span>&nbsp;<span class="ident" id="5174427">q</span><span class="op" id="5174428">.</span><span class="ident" id="5174429">dense</span><span class="op" id="5174434">[</span><span class="ident" id="5174435">q</span><span class="op" id="5174436">.</span><span class="ident" id="5174437">sparse</span><span class="op" id="5174443">[</span><span class="ident" id="5174444">u</span><span class="op" id="5174445">]</span><span class="op" id="5174446">]</span>&nbsp;<span class="op" id="5174448">==</span>&nbsp;<span class="ident" id="5174451">u</span><br>
<span class="lineno">120</span><span class="op" id="5174453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5174456">func</span>&nbsp;<span class="op" id="5174461">(</span><span class="ident" id="5174462">q</span>&nbsp;<span class="op" id="5174464">*</span><span class="ident" id="5174465">queueOnePass</span><span class="op" id="5174477">)</span>&nbsp;<span class="ident" id="5174479">insert</span><span class="op" id="5174485">(</span><span class="ident" id="5174486">u</span>&nbsp;<span class="builtintype" id="5174488">uint32</span><span class="op" id="5174494">)</span>&nbsp;<span class="op" id="5174496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174499">if</span>&nbsp;<span class="op" id="5174502">!</span><span class="ident" id="5174503">q</span><span class="op" id="5174504">.</span><span class="ident" id="5174505">contains</span><span class="op" id="5174513">(</span><span class="ident" id="5174514">u</span><span class="op" id="5174515">)</span>&nbsp;<span class="op" id="5174517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174521">q</span><span class="op" id="5174522">.</span><span class="ident" id="5174523">insertNew</span><span class="op" id="5174532">(</span><span class="ident" id="5174533">u</span><span class="op" id="5174534">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174537">}</span><br>
<span class="lineno"></span><span class="op" id="5174539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5174542">func</span>&nbsp;<span class="op" id="5174547">(</span><span class="ident" id="5174548">q</span>&nbsp;<span class="op" id="5174550">*</span><span class="ident" id="5174551">queueOnePass</span><span class="op" id="5174563">)</span>&nbsp;<span class="ident" id="5174565">insertNew</span><span class="op" id="5174574">(</span><span class="ident" id="5174575">u</span>&nbsp;<span class="builtintype" id="5174577">uint32</span><span class="op" id="5174583">)</span>&nbsp;<span class="op" id="5174585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174588">if</span>&nbsp;<span class="ident" id="5174591">u</span>&nbsp;<span class="op" id="5174593">&gt;=</span>&nbsp;<span class="builtintype" id="5174596">uint32</span><span class="op" id="5174602">(</span><span class="builtinfunc" id="5174603">len</span><span class="op" id="5174606">(</span><span class="ident" id="5174607">q</span><span class="op" id="5174608">.</span><span class="ident" id="5174609">sparse</span><span class="op" id="5174615">)</span><span class="op" id="5174616">)</span>&nbsp;<span class="op" id="5174618">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174622">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174633">q</span><span class="op" id="5174634">.</span><span class="ident" id="5174635">sparse</span><span class="op" id="5174641">[</span><span class="ident" id="5174642">u</span><span class="op" id="5174643">]</span>&nbsp;<span class="op" id="5174645">=</span>&nbsp;<span class="ident" id="5174647">q</span><span class="op" id="5174648">.</span><span class="ident" id="5174649">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174655">q</span><span class="op" id="5174656">.</span><span class="ident" id="5174657">dense</span><span class="op" id="5174662">[</span><span class="ident" id="5174663">q</span><span class="op" id="5174664">.</span><span class="ident" id="5174665">size</span><span class="op" id="5174669">]</span>&nbsp;<span class="op" id="5174671">=</span>&nbsp;<span class="ident" id="5174673">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174676">q</span><span class="op" id="5174677">.</span><span class="ident" id="5174678">size</span><span class="op" id="5174682">++</span><br>
<span class="lineno">135</span><span class="op" id="5174685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5174688">func</span>&nbsp;<span class="ident" id="5174693">newQueue</span><span class="op" id="5174701">(</span><span class="ident" id="5174702">size</span>&nbsp;<span class="builtintype" id="5174707">int</span><span class="op" id="5174710">)</span>&nbsp;<span class="op" id="5174712">(</span><span class="ident" id="5174713">q</span>&nbsp;<span class="op" id="5174715">*</span><span class="ident" id="5174716">queueOnePass</span><span class="op" id="5174728">)</span>&nbsp;<span class="op" id="5174730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5174733">return</span>&nbsp;<span class="op" id="5174740">&amp;</span><span class="ident" id="5174741">queueOnePass</span><span class="op" id="5174753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174757">sparse</span><span class="op" id="5174763">:</span>&nbsp;<span class="builtinfunc" id="5174765">make</span><span class="op" id="5174769">(</span><span class="op" id="5174770">[</span><span class="op" id="5174771">]</span><span class="builtintype" id="5174772">uint32</span><span class="op" id="5174778">,</span>&nbsp;<span class="ident" id="5174780">size</span><span class="op" id="5174784">)</span><span class="op" id="5174785">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5174789">dense</span><span class="op" id="5174794">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5174797">make</span><span class="op" id="5174801">(</span><span class="op" id="5174802">[</span><span class="op" id="5174803">]</span><span class="builtintype" id="5174804">uint32</span><span class="op" id="5174810">,</span>&nbsp;<span class="ident" id="5174812">size</span><span class="op" id="5174816">)</span><span class="op" id="5174817">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5174820">}</span><br>
<span class="lineno"></span><span class="op" id="5174822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5174825">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="5174911">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="5174995">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5175080">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5175145">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="5175231">const</span>&nbsp;<span class="ident" id="5175237">mergeFailed</span>&nbsp;<span class="op" id="5175249">=</span>&nbsp;<span class="builtintype" id="5175251">uint32</span><span class="op" id="5175257">(</span><span class="num" id="5175258">0xffffffff</span><span class="op" id="5175268">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="5175271">var</span>&nbsp;<span class="op" id="5175275">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175278">noRune</span>&nbsp;<span class="op" id="5175285">=</span>&nbsp;<span class="op" id="5175287">[</span><span class="op" id="5175288">]</span><span class="builtintype" id="5175289">rune</span><span class="op" id="5175293">{</span><span class="op" id="5175294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175297">noNext</span>&nbsp;<span class="op" id="5175304">=</span>&nbsp;<span class="op" id="5175306">[</span><span class="op" id="5175307">]</span><span class="builtintype" id="5175308">uint32</span><span class="op" id="5175314">{</span><span class="ident" id="5175315">mergeFailed</span><span class="op" id="5175326">}</span><br>
<span class="lineno"></span><span class="op" id="5175328">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="5175331">func</span>&nbsp;<span class="ident" id="5175336">mergeRuneSets</span><span class="op" id="5175349">(</span><span class="ident" id="5175350">leftRunes</span><span class="op" id="5175359">,</span>&nbsp;<span class="ident" id="5175361">rightRunes</span>&nbsp;<span class="op" id="5175372">*</span><span class="op" id="5175373">[</span><span class="op" id="5175374">]</span><span class="builtintype" id="5175375">rune</span><span class="op" id="5175379">,</span>&nbsp;<span class="ident" id="5175381">leftPC</span><span class="op" id="5175387">,</span>&nbsp;<span class="ident" id="5175389">rightPC</span>&nbsp;<span class="builtintype" id="5175397">uint32</span><span class="op" id="5175403">)</span>&nbsp;<span class="op" id="5175405">(</span><span class="op" id="5175406">[</span><span class="op" id="5175407">]</span><span class="builtintype" id="5175408">rune</span><span class="op" id="5175412">,</span>&nbsp;<span class="op" id="5175414">[</span><span class="op" id="5175415">]</span><span class="builtintype" id="5175416">uint32</span><span class="op" id="5175422">)</span>&nbsp;<span class="op" id="5175424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175427">leftLen</span>&nbsp;<span class="op" id="5175435">:=</span>&nbsp;<span class="builtinfunc" id="5175438">len</span><span class="op" id="5175441">(</span><span class="op" id="5175442">*</span><span class="ident" id="5175443">leftRunes</span><span class="op" id="5175452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175455">rightLen</span>&nbsp;<span class="op" id="5175464">:=</span>&nbsp;<span class="builtinfunc" id="5175467">len</span><span class="op" id="5175470">(</span><span class="op" id="5175471">*</span><span class="ident" id="5175472">rightRunes</span><span class="op" id="5175482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175485">if</span>&nbsp;<span class="ident" id="5175488">leftLen</span><span class="op" id="5175495">&amp;</span><span class="num" id="5175496">0x1</span>&nbsp;<span class="op" id="5175500">!=</span>&nbsp;<span class="num" id="5175503">0</span>&nbsp;<span class="op" id="5175505">||</span>&nbsp;<span class="ident" id="5175508">rightLen</span><span class="op" id="5175516">&amp;</span><span class="num" id="5175517">0x1</span>&nbsp;<span class="op" id="5175521">!=</span>&nbsp;<span class="num" id="5175524">0</span>&nbsp;<span class="op" id="5175526">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5175530">panic</span><span class="op" id="5175535">(</span><span class="string" id="5175536">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="5175569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175575">var</span>&nbsp;<span class="op" id="5175579">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175583">lx</span><span class="op" id="5175585">,</span>&nbsp;<span class="ident" id="5175587">rx</span>&nbsp;<span class="builtintype" id="5175590">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175595">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175598">merged</span>&nbsp;<span class="op" id="5175605">:=</span>&nbsp;<span class="builtinfunc" id="5175608">make</span><span class="op" id="5175612">(</span><span class="op" id="5175613">[</span><span class="op" id="5175614">]</span><span class="builtintype" id="5175615">rune</span><span class="op" id="5175619">,</span>&nbsp;<span class="num" id="5175621">0</span><span class="op" id="5175622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175625">next</span>&nbsp;<span class="op" id="5175630">:=</span>&nbsp;<span class="builtinfunc" id="5175633">make</span><span class="op" id="5175637">(</span><span class="op" id="5175638">[</span><span class="op" id="5175639">]</span><span class="builtintype" id="5175640">uint32</span><span class="op" id="5175646">,</span>&nbsp;<span class="num" id="5175648">0</span><span class="op" id="5175649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175652">ok</span>&nbsp;<span class="op" id="5175655">:=</span>&nbsp;<span class="ident" id="5175658">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175664">defer</span>&nbsp;<span class="keyword" id="5175670">func</span><span class="op" id="5175674">(</span><span class="op" id="5175675">)</span>&nbsp;<span class="op" id="5175677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175681">if</span>&nbsp;<span class="op" id="5175684">!</span><span class="ident" id="5175685">ok</span>&nbsp;<span class="op" id="5175688">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175693">merged</span>&nbsp;<span class="op" id="5175700">=</span>&nbsp;<span class="ident" id="5175702">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175709">next</span>&nbsp;<span class="op" id="5175714">=</span>&nbsp;<span class="ident" id="5175716">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175725">}</span><span class="op" id="5175726">(</span><span class="op" id="5175727">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175731">ix</span>&nbsp;<span class="op" id="5175734">:=</span>&nbsp;<span class="op" id="5175737">-</span><span class="num" id="5175738">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175741">extend</span>&nbsp;<span class="op" id="5175748">:=</span>&nbsp;<span class="keyword" id="5175751">func</span><span class="op" id="5175755">(</span><span class="ident" id="5175756">newLow</span>&nbsp;<span class="op" id="5175763">*</span><span class="builtintype" id="5175764">int</span><span class="op" id="5175767">,</span>&nbsp;<span class="ident" id="5175769">newArray</span>&nbsp;<span class="op" id="5175778">*</span><span class="op" id="5175779">[</span><span class="op" id="5175780">]</span><span class="builtintype" id="5175781">rune</span><span class="op" id="5175785">,</span>&nbsp;<span class="ident" id="5175787">pc</span>&nbsp;<span class="builtintype" id="5175790">uint32</span><span class="op" id="5175796">)</span>&nbsp;<span class="builtintype" id="5175798">bool</span>&nbsp;<span class="op" id="5175803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175807">if</span>&nbsp;<span class="ident" id="5175810">ix</span>&nbsp;<span class="op" id="5175813">&gt;</span>&nbsp;<span class="num" id="5175815">0</span>&nbsp;<span class="op" id="5175817">&amp;&amp;</span>&nbsp;<span class="op" id="5175820">(</span><span class="op" id="5175821">*</span><span class="ident" id="5175822">newArray</span><span class="op" id="5175830">)</span><span class="op" id="5175831">[</span><span class="op" id="5175832">*</span><span class="ident" id="5175833">newLow</span><span class="op" id="5175839">]</span>&nbsp;<span class="op" id="5175841">&lt;=</span>&nbsp;<span class="ident" id="5175844">merged</span><span class="op" id="5175850">[</span><span class="ident" id="5175851">ix</span><span class="op" id="5175853">]</span>&nbsp;<span class="op" id="5175855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5175860">return</span>&nbsp;<span class="ident" id="5175867">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175875">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175879">merged</span>&nbsp;<span class="op" id="5175886">=</span>&nbsp;<span class="builtinfunc" id="5175888">append</span><span class="op" id="5175894">(</span><span class="ident" id="5175895">merged</span><span class="op" id="5175901">,</span>&nbsp;<span class="op" id="5175903">(</span><span class="op" id="5175904">*</span><span class="ident" id="5175905">newArray</span><span class="op" id="5175913">)</span><span class="op" id="5175914">[</span><span class="op" id="5175915">*</span><span class="ident" id="5175916">newLow</span><span class="op" id="5175922">]</span><span class="op" id="5175923">,</span>&nbsp;<span class="op" id="5175925">(</span><span class="op" id="5175926">*</span><span class="ident" id="5175927">newArray</span><span class="op" id="5175935">)</span><span class="op" id="5175936">[</span><span class="op" id="5175937">*</span><span class="ident" id="5175938">newLow</span><span class="op" id="5175944">+</span><span class="num" id="5175945">1</span><span class="op" id="5175946">]</span><span class="op" id="5175947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5175951">*</span><span class="ident" id="5175952">newLow</span>&nbsp;<span class="op" id="5175959">+=</span>&nbsp;<span class="num" id="5175962">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175966">ix</span>&nbsp;<span class="op" id="5175969">+=</span>&nbsp;<span class="num" id="5175972">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5175976">next</span>&nbsp;<span class="op" id="5175981">=</span>&nbsp;<span class="builtinfunc" id="5175983">append</span><span class="op" id="5175989">(</span><span class="ident" id="5175990">next</span><span class="op" id="5175994">,</span>&nbsp;<span class="ident" id="5175996">pc</span><span class="op" id="5175998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176002">return</span>&nbsp;<span class="ident" id="5176009">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176019">for</span>&nbsp;<span class="ident" id="5176023">lx</span>&nbsp;<span class="op" id="5176026">&lt;</span>&nbsp;<span class="ident" id="5176028">leftLen</span>&nbsp;<span class="op" id="5176036">||</span>&nbsp;<span class="ident" id="5176039">rx</span>&nbsp;<span class="op" id="5176042">&lt;</span>&nbsp;<span class="ident" id="5176044">rightLen</span>&nbsp;<span class="op" id="5176053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176057">switch</span>&nbsp;<span class="op" id="5176064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176068">case</span>&nbsp;<span class="ident" id="5176073">rx</span>&nbsp;<span class="op" id="5176076">&gt;=</span>&nbsp;<span class="ident" id="5176079">rightLen</span><span class="op" id="5176087">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176092">ok</span>&nbsp;<span class="op" id="5176095">=</span>&nbsp;<span class="ident" id="5176097">extend</span><span class="op" id="5176103">(</span><span class="op" id="5176104">&amp;</span><span class="ident" id="5176105">lx</span><span class="op" id="5176107">,</span>&nbsp;<span class="ident" id="5176109">leftRunes</span><span class="op" id="5176118">,</span>&nbsp;<span class="ident" id="5176120">leftPC</span><span class="op" id="5176126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176130">case</span>&nbsp;<span class="ident" id="5176135">lx</span>&nbsp;<span class="op" id="5176138">&gt;=</span>&nbsp;<span class="ident" id="5176141">leftLen</span><span class="op" id="5176148">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176153">ok</span>&nbsp;<span class="op" id="5176156">=</span>&nbsp;<span class="ident" id="5176158">extend</span><span class="op" id="5176164">(</span><span class="op" id="5176165">&amp;</span><span class="ident" id="5176166">rx</span><span class="op" id="5176168">,</span>&nbsp;<span class="ident" id="5176170">rightRunes</span><span class="op" id="5176180">,</span>&nbsp;<span class="ident" id="5176182">rightPC</span><span class="op" id="5176189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176193">case</span>&nbsp;<span class="op" id="5176198">(</span><span class="op" id="5176199">*</span><span class="ident" id="5176200">rightRunes</span><span class="op" id="5176210">)</span><span class="op" id="5176211">[</span><span class="ident" id="5176212">rx</span><span class="op" id="5176214">]</span>&nbsp;<span class="op" id="5176216">&lt;</span>&nbsp;<span class="op" id="5176218">(</span><span class="op" id="5176219">*</span><span class="ident" id="5176220">leftRunes</span><span class="op" id="5176229">)</span><span class="op" id="5176230">[</span><span class="ident" id="5176231">lx</span><span class="op" id="5176233">]</span><span class="op" id="5176234">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176239">ok</span>&nbsp;<span class="op" id="5176242">=</span>&nbsp;<span class="ident" id="5176244">extend</span><span class="op" id="5176250">(</span><span class="op" id="5176251">&amp;</span><span class="ident" id="5176252">rx</span><span class="op" id="5176254">,</span>&nbsp;<span class="ident" id="5176256">rightRunes</span><span class="op" id="5176266">,</span>&nbsp;<span class="ident" id="5176268">rightPC</span><span class="op" id="5176275">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176279">default</span><span class="op" id="5176286">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176291">ok</span>&nbsp;<span class="op" id="5176294">=</span>&nbsp;<span class="ident" id="5176296">extend</span><span class="op" id="5176302">(</span><span class="op" id="5176303">&amp;</span><span class="ident" id="5176304">lx</span><span class="op" id="5176306">,</span>&nbsp;<span class="ident" id="5176308">leftRunes</span><span class="op" id="5176317">,</span>&nbsp;<span class="ident" id="5176319">leftPC</span><span class="op" id="5176325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176333">if</span>&nbsp;<span class="op" id="5176336">!</span><span class="ident" id="5176337">ok</span>&nbsp;<span class="op" id="5176340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176345">return</span>&nbsp;<span class="ident" id="5176352">noRune</span><span class="op" id="5176358">,</span>&nbsp;<span class="ident" id="5176360">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176375">return</span>&nbsp;<span class="ident" id="5176382">merged</span><span class="op" id="5176388">,</span>&nbsp;<span class="ident" id="5176390">next</span><br>
<span class="lineno"></span><span class="op" id="5176395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="5176398">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="5176482">func</span>&nbsp;<span class="ident" id="5176487">cleanupOnePass</span><span class="op" id="5176501">(</span><span class="ident" id="5176502">prog</span>&nbsp;<span class="op" id="5176507">*</span><span class="ident" id="5176508">onePassProg</span><span class="op" id="5176519">,</span>&nbsp;<span class="ident" id="5176521">original</span>&nbsp;<span class="op" id="5176530">*</span><span class="ident" id="5176531">syntax</span><span class="op" id="5176537">.</span><span class="ident" id="5176538">Prog</span><span class="op" id="5176542">)</span>&nbsp;<span class="op" id="5176544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176547">for</span>&nbsp;<span class="ident" id="5176551">ix</span><span class="op" id="5176553">,</span>&nbsp;<span class="ident" id="5176555">instOriginal</span>&nbsp;<span class="op" id="5176568">:=</span>&nbsp;<span class="keyword" id="5176571">range</span>&nbsp;<span class="ident" id="5176577">original</span><span class="op" id="5176585">.</span><span class="ident" id="5176586">Inst</span>&nbsp;<span class="op" id="5176591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176595">switch</span>&nbsp;<span class="ident" id="5176602">instOriginal</span><span class="op" id="5176614">.</span><span class="ident" id="5176615">Op</span>&nbsp;<span class="op" id="5176618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176622">case</span>&nbsp;<span class="ident" id="5176627">syntax</span><span class="op" id="5176633">.</span><span class="ident" id="5176634">InstAlt</span><span class="op" id="5176641">,</span>&nbsp;<span class="ident" id="5176643">syntax</span><span class="op" id="5176649">.</span><span class="ident" id="5176650">InstAltMatch</span><span class="op" id="5176662">,</span>&nbsp;<span class="ident" id="5176664">syntax</span><span class="op" id="5176670">.</span><span class="ident" id="5176671">InstRune</span><span class="op" id="5176679">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176683">case</span>&nbsp;<span class="ident" id="5176688">syntax</span><span class="op" id="5176694">.</span><span class="ident" id="5176695">InstCapture</span><span class="op" id="5176706">,</span>&nbsp;<span class="ident" id="5176708">syntax</span><span class="op" id="5176714">.</span><span class="ident" id="5176715">InstEmptyWidth</span><span class="op" id="5176729">,</span>&nbsp;<span class="ident" id="5176731">syntax</span><span class="op" id="5176737">.</span><span class="ident" id="5176738">InstNop</span><span class="op" id="5176745">,</span>&nbsp;<span class="ident" id="5176747">syntax</span><span class="op" id="5176753">.</span><span class="ident" id="5176754">InstMatch</span><span class="op" id="5176763">,</span>&nbsp;<span class="ident" id="5176765">syntax</span><span class="op" id="5176771">.</span><span class="ident" id="5176772">InstFail</span><span class="op" id="5176780">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176785">prog</span><span class="op" id="5176789">.</span><span class="ident" id="5176790">Inst</span><span class="op" id="5176794">[</span><span class="ident" id="5176795">ix</span><span class="op" id="5176797">]</span><span class="op" id="5176798">.</span><span class="ident" id="5176799">Next</span>&nbsp;<span class="op" id="5176804">=</span>&nbsp;<span class="ident" id="5176806">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5176812">case</span>&nbsp;<span class="ident" id="5176817">syntax</span><span class="op" id="5176823">.</span><span class="ident" id="5176824">InstRune1</span><span class="op" id="5176833">,</span>&nbsp;<span class="ident" id="5176835">syntax</span><span class="op" id="5176841">.</span><span class="ident" id="5176842">InstRuneAny</span><span class="op" id="5176853">,</span>&nbsp;<span class="ident" id="5176855">syntax</span><span class="op" id="5176861">.</span><span class="ident" id="5176862">InstRuneAnyNotNL</span><span class="op" id="5176878">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176883">prog</span><span class="op" id="5176887">.</span><span class="ident" id="5176888">Inst</span><span class="op" id="5176892">[</span><span class="ident" id="5176893">ix</span><span class="op" id="5176895">]</span><span class="op" id="5176896">.</span><span class="ident" id="5176897">Next</span>&nbsp;<span class="op" id="5176902">=</span>&nbsp;<span class="ident" id="5176904">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5176911">prog</span><span class="op" id="5176915">.</span><span class="ident" id="5176916">Inst</span><span class="op" id="5176920">[</span><span class="ident" id="5176921">ix</span><span class="op" id="5176923">]</span>&nbsp;<span class="op" id="5176925">=</span>&nbsp;<span class="ident" id="5176927">onePassInst</span><span class="op" id="5176938">{</span><span class="ident" id="5176939">Inst</span><span class="op" id="5176943">:</span>&nbsp;<span class="ident" id="5176945">instOriginal</span><span class="op" id="5176957">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5176964">}</span><br>
<span class="lineno"></span><span class="op" id="5176966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5176969">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="5177046">func</span>&nbsp;<span class="ident" id="5177051">onePassCopy</span><span class="op" id="5177062">(</span><span class="ident" id="5177063">prog</span>&nbsp;<span class="op" id="5177068">*</span><span class="ident" id="5177069">syntax</span><span class="op" id="5177075">.</span><span class="ident" id="5177076">Prog</span><span class="op" id="5177080">)</span>&nbsp;<span class="op" id="5177082">*</span><span class="ident" id="5177083">onePassProg</span>&nbsp;<span class="op" id="5177095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177098">p</span>&nbsp;<span class="op" id="5177100">:=</span>&nbsp;<span class="op" id="5177103">&amp;</span><span class="ident" id="5177104">onePassProg</span><span class="op" id="5177115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177119">Start</span><span class="op" id="5177124">:</span>&nbsp;&nbsp;<span class="ident" id="5177127">prog</span><span class="op" id="5177131">.</span><span class="ident" id="5177132">Start</span><span class="op" id="5177137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177141">NumCap</span><span class="op" id="5177147">:</span>&nbsp;<span class="ident" id="5177149">prog</span><span class="op" id="5177153">.</span><span class="ident" id="5177154">NumCap</span><span class="op" id="5177160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177163">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177166">for</span>&nbsp;<span class="ident" id="5177170">_</span><span class="op" id="5177171">,</span>&nbsp;<span class="ident" id="5177173">inst</span>&nbsp;<span class="op" id="5177178">:=</span>&nbsp;<span class="keyword" id="5177181">range</span>&nbsp;<span class="ident" id="5177187">prog</span><span class="op" id="5177191">.</span><span class="ident" id="5177192">Inst</span>&nbsp;<span class="op" id="5177197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177201">p</span><span class="op" id="5177202">.</span><span class="ident" id="5177203">Inst</span>&nbsp;<span class="op" id="5177208">=</span>&nbsp;<span class="builtinfunc" id="5177210">append</span><span class="op" id="5177216">(</span><span class="ident" id="5177217">p</span><span class="op" id="5177218">.</span><span class="ident" id="5177219">Inst</span><span class="op" id="5177223">,</span>&nbsp;<span class="ident" id="5177225">onePassInst</span><span class="op" id="5177236">{</span><span class="ident" id="5177237">Inst</span><span class="op" id="5177241">:</span>&nbsp;<span class="ident" id="5177243">inst</span><span class="op" id="5177247">}</span><span class="op" id="5177248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5177251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177255">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177330">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177406">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177442">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177473">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177504">for</span>&nbsp;<span class="ident" id="5177508">pc</span>&nbsp;<span class="op" id="5177511">:=</span>&nbsp;<span class="keyword" id="5177514">range</span>&nbsp;<span class="ident" id="5177520">p</span><span class="op" id="5177521">.</span><span class="ident" id="5177522">Inst</span>&nbsp;<span class="op" id="5177527">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177531">switch</span>&nbsp;<span class="ident" id="5177538">p</span><span class="op" id="5177539">.</span><span class="ident" id="5177540">Inst</span><span class="op" id="5177544">[</span><span class="ident" id="5177545">pc</span><span class="op" id="5177547">]</span><span class="op" id="5177548">.</span><span class="ident" id="5177549">Op</span>&nbsp;<span class="op" id="5177552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177556">default</span><span class="op" id="5177563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177568">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177579">case</span>&nbsp;<span class="ident" id="5177584">syntax</span><span class="op" id="5177590">.</span><span class="ident" id="5177591">InstAlt</span><span class="op" id="5177598">,</span>&nbsp;<span class="ident" id="5177600">syntax</span><span class="op" id="5177606">.</span><span class="ident" id="5177607">InstAltMatch</span><span class="op" id="5177619">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177624">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177642">p_A_Other</span>&nbsp;<span class="op" id="5177652">:=</span>&nbsp;<span class="op" id="5177655">&amp;</span><span class="ident" id="5177656">p</span><span class="op" id="5177657">.</span><span class="ident" id="5177658">Inst</span><span class="op" id="5177662">[</span><span class="ident" id="5177663">pc</span><span class="op" id="5177665">]</span><span class="op" id="5177666">.</span><span class="ident" id="5177667">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177674">p_A_Alt</span>&nbsp;<span class="op" id="5177682">:=</span>&nbsp;<span class="op" id="5177685">&amp;</span><span class="ident" id="5177686">p</span><span class="op" id="5177687">.</span><span class="ident" id="5177688">Inst</span><span class="op" id="5177692">[</span><span class="ident" id="5177693">pc</span><span class="op" id="5177695">]</span><span class="op" id="5177696">.</span><span class="ident" id="5177697">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5177704">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177744">instAlt</span>&nbsp;<span class="op" id="5177752">:=</span>&nbsp;<span class="ident" id="5177755">p</span><span class="op" id="5177756">.</span><span class="ident" id="5177757">Inst</span><span class="op" id="5177761">[</span><span class="op" id="5177762">*</span><span class="ident" id="5177763">p_A_Alt</span><span class="op" id="5177770">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177775">if</span>&nbsp;<span class="op" id="5177778">!</span><span class="op" id="5177779">(</span><span class="ident" id="5177780">instAlt</span><span class="op" id="5177787">.</span><span class="ident" id="5177788">Op</span>&nbsp;<span class="op" id="5177791">==</span>&nbsp;<span class="ident" id="5177794">syntax</span><span class="op" id="5177800">.</span><span class="ident" id="5177801">InstAlt</span>&nbsp;<span class="op" id="5177809">||</span>&nbsp;<span class="ident" id="5177812">instAlt</span><span class="op" id="5177819">.</span><span class="ident" id="5177820">Op</span>&nbsp;<span class="op" id="5177823">==</span>&nbsp;<span class="ident" id="5177826">syntax</span><span class="op" id="5177832">.</span><span class="ident" id="5177833">InstAltMatch</span><span class="op" id="5177845">)</span>&nbsp;<span class="op" id="5177847">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177853">p_A_Alt</span><span class="op" id="5177860">,</span>&nbsp;<span class="ident" id="5177862">p_A_Other</span>&nbsp;<span class="op" id="5177872">=</span>&nbsp;<span class="ident" id="5177874">p_A_Other</span><span class="op" id="5177883">,</span>&nbsp;<span class="ident" id="5177885">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5177897">instAlt</span>&nbsp;<span class="op" id="5177905">=</span>&nbsp;<span class="ident" id="5177907">p</span><span class="op" id="5177908">.</span><span class="ident" id="5177909">Inst</span><span class="op" id="5177913">[</span><span class="op" id="5177914">*</span><span class="ident" id="5177915">p_A_Alt</span><span class="op" id="5177922">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5177928">if</span>&nbsp;<span class="op" id="5177931">!</span><span class="op" id="5177932">(</span><span class="ident" id="5177933">instAlt</span><span class="op" id="5177940">.</span><span class="ident" id="5177941">Op</span>&nbsp;<span class="op" id="5177944">==</span>&nbsp;<span class="ident" id="5177947">syntax</span><span class="op" id="5177953">.</span><span class="ident" id="5177954">InstAlt</span>&nbsp;<span class="op" id="5177962">||</span>&nbsp;<span class="ident" id="5177965">instAlt</span><span class="op" id="5177972">.</span><span class="ident" id="5177973">Op</span>&nbsp;<span class="op" id="5177976">==</span>&nbsp;<span class="ident" id="5177979">syntax</span><span class="op" id="5177985">.</span><span class="ident" id="5177986">InstAltMatch</span><span class="op" id="5177998">)</span>&nbsp;<span class="op" id="5178000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178007">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178020">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178030">instOther</span>&nbsp;<span class="op" id="5178040">:=</span>&nbsp;<span class="ident" id="5178043">p</span><span class="op" id="5178044">.</span><span class="ident" id="5178045">Inst</span><span class="op" id="5178049">[</span><span class="op" id="5178050">*</span><span class="ident" id="5178051">p_A_Other</span><span class="op" id="5178060">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178065">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178127">if</span>&nbsp;<span class="ident" id="5178130">instOther</span><span class="op" id="5178139">.</span><span class="ident" id="5178140">Op</span>&nbsp;<span class="op" id="5178143">==</span>&nbsp;<span class="ident" id="5178146">syntax</span><span class="op" id="5178152">.</span><span class="ident" id="5178153">InstAlt</span>&nbsp;<span class="op" id="5178161">||</span>&nbsp;<span class="ident" id="5178164">instOther</span><span class="op" id="5178173">.</span><span class="ident" id="5178174">Op</span>&nbsp;<span class="op" id="5178177">==</span>&nbsp;<span class="ident" id="5178180">syntax</span><span class="op" id="5178186">.</span><span class="ident" id="5178187">InstAltMatch</span>&nbsp;<span class="op" id="5178200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178206">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178229">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178246">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178281">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178314">p_B_Alt</span>&nbsp;<span class="op" id="5178322">:=</span>&nbsp;<span class="op" id="5178325">&amp;</span><span class="ident" id="5178326">p</span><span class="op" id="5178327">.</span><span class="ident" id="5178328">Inst</span><span class="op" id="5178332">[</span><span class="op" id="5178333">*</span><span class="ident" id="5178334">p_A_Alt</span><span class="op" id="5178341">]</span><span class="op" id="5178342">.</span><span class="ident" id="5178343">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178350">p_B_Other</span>&nbsp;<span class="op" id="5178360">:=</span>&nbsp;<span class="op" id="5178363">&amp;</span><span class="ident" id="5178364">p</span><span class="op" id="5178365">.</span><span class="ident" id="5178366">Inst</span><span class="op" id="5178370">[</span><span class="op" id="5178371">*</span><span class="ident" id="5178372">p_A_Alt</span><span class="op" id="5178379">]</span><span class="op" id="5178380">.</span><span class="ident" id="5178381">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178388">patch</span>&nbsp;<span class="op" id="5178394">:=</span>&nbsp;<span class="ident" id="5178397">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178406">if</span>&nbsp;<span class="ident" id="5178409">instAlt</span><span class="op" id="5178416">.</span><span class="ident" id="5178417">Out</span>&nbsp;<span class="op" id="5178421">==</span>&nbsp;<span class="builtintype" id="5178424">uint32</span><span class="op" id="5178430">(</span><span class="ident" id="5178431">pc</span><span class="op" id="5178433">)</span>&nbsp;<span class="op" id="5178435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178441">patch</span>&nbsp;<span class="op" id="5178447">=</span>&nbsp;<span class="ident" id="5178449">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178457">}</span>&nbsp;<span class="keyword" id="5178459">else</span>&nbsp;<span class="keyword" id="5178464">if</span>&nbsp;<span class="ident" id="5178467">instAlt</span><span class="op" id="5178474">.</span><span class="ident" id="5178475">Arg</span>&nbsp;<span class="op" id="5178479">==</span>&nbsp;<span class="builtintype" id="5178482">uint32</span><span class="op" id="5178488">(</span><span class="ident" id="5178489">pc</span><span class="op" id="5178491">)</span>&nbsp;<span class="op" id="5178493">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178499">patch</span>&nbsp;<span class="op" id="5178505">=</span>&nbsp;<span class="ident" id="5178507">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5178516">p_B_Alt</span><span class="op" id="5178523">,</span>&nbsp;<span class="ident" id="5178525">p_B_Other</span>&nbsp;<span class="op" id="5178535">=</span>&nbsp;<span class="ident" id="5178537">p_B_Other</span><span class="op" id="5178546">,</span>&nbsp;<span class="ident" id="5178548">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178564">if</span>&nbsp;<span class="ident" id="5178567">patch</span>&nbsp;<span class="op" id="5178573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178579">*</span><span class="ident" id="5178580">p_B_Alt</span>&nbsp;<span class="op" id="5178588">=</span>&nbsp;<span class="op" id="5178590">*</span><span class="ident" id="5178591">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178610">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5178650">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178683">if</span>&nbsp;<span class="op" id="5178686">*</span><span class="ident" id="5178687">p_A_Other</span>&nbsp;<span class="op" id="5178697">==</span>&nbsp;<span class="op" id="5178700">*</span><span class="ident" id="5178701">p_B_Alt</span>&nbsp;<span class="op" id="5178709">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178715">*</span><span class="ident" id="5178716">p_A_Alt</span>&nbsp;<span class="op" id="5178724">=</span>&nbsp;<span class="op" id="5178726">*</span><span class="ident" id="5178727">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5178747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5178750">return</span>&nbsp;<span class="ident" id="5178757">p</span><br>
<span class="lineno">280</span><span class="op" id="5178759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5178762">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="5178827">type</span>&nbsp;<span class="ident" id="5178832">runeSlice</span>&nbsp;<span class="op" id="5178842">[</span><span class="op" id="5178843">]</span><span class="builtintype" id="5178844">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5178850">func</span>&nbsp;<span class="op" id="5178855">(</span><span class="ident" id="5178856">p</span>&nbsp;<span class="ident" id="5178858">runeSlice</span><span class="op" id="5178867">)</span>&nbsp;<span class="ident" id="5178869">Len</span><span class="op" id="5178872">(</span><span class="op" id="5178873">)</span>&nbsp;<span class="builtintype" id="5178875">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5178889">{</span>&nbsp;<span class="keyword" id="5178891">return</span>&nbsp;<span class="builtinfunc" id="5178898">len</span><span class="op" id="5178901">(</span><span class="ident" id="5178902">p</span><span class="op" id="5178903">)</span>&nbsp;<span class="op" id="5178905">}</span><br>
<span class="lineno"></span><span class="keyword" id="5178907">func</span>&nbsp;<span class="op" id="5178912">(</span><span class="ident" id="5178913">p</span>&nbsp;<span class="ident" id="5178915">runeSlice</span><span class="op" id="5178924">)</span>&nbsp;<span class="ident" id="5178926">Less</span><span class="op" id="5178930">(</span><span class="ident" id="5178931">i</span><span class="op" id="5178932">,</span>&nbsp;<span class="ident" id="5178934">j</span>&nbsp;<span class="builtintype" id="5178936">int</span><span class="op" id="5178939">)</span>&nbsp;<span class="builtintype" id="5178941">bool</span>&nbsp;<span class="op" id="5178946">{</span>&nbsp;<span class="keyword" id="5178948">return</span>&nbsp;<span class="ident" id="5178955">p</span><span class="op" id="5178956">[</span><span class="ident" id="5178957">i</span><span class="op" id="5178958">]</span>&nbsp;<span class="op" id="5178960">&lt;</span>&nbsp;<span class="ident" id="5178962">p</span><span class="op" id="5178963">[</span><span class="ident" id="5178964">j</span><span class="op" id="5178965">]</span>&nbsp;<span class="op" id="5178967">}</span><br>
<span class="lineno"></span><span class="keyword" id="5178969">func</span>&nbsp;<span class="op" id="5178974">(</span><span class="ident" id="5178975">p</span>&nbsp;<span class="ident" id="5178977">runeSlice</span><span class="op" id="5178986">)</span>&nbsp;<span class="ident" id="5178988">Swap</span><span class="op" id="5178992">(</span><span class="ident" id="5178993">i</span><span class="op" id="5178994">,</span>&nbsp;<span class="ident" id="5178996">j</span>&nbsp;<span class="builtintype" id="5178998">int</span><span class="op" id="5179001">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5179008">{</span>&nbsp;<span class="ident" id="5179010">p</span><span class="op" id="5179011">[</span><span class="ident" id="5179012">i</span><span class="op" id="5179013">]</span><span class="op" id="5179014">,</span>&nbsp;<span class="ident" id="5179016">p</span><span class="op" id="5179017">[</span><span class="ident" id="5179018">j</span><span class="op" id="5179019">]</span>&nbsp;<span class="op" id="5179021">=</span>&nbsp;<span class="ident" id="5179023">p</span><span class="op" id="5179024">[</span><span class="ident" id="5179025">j</span><span class="op" id="5179026">]</span><span class="op" id="5179027">,</span>&nbsp;<span class="ident" id="5179029">p</span><span class="op" id="5179030">[</span><span class="ident" id="5179031">i</span><span class="op" id="5179032">]</span>&nbsp;<span class="op" id="5179034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5179037">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="5179070">func</span>&nbsp;<span class="op" id="5179075">(</span><span class="ident" id="5179076">p</span>&nbsp;<span class="ident" id="5179078">runeSlice</span><span class="op" id="5179087">)</span>&nbsp;<span class="ident" id="5179089">Sort</span><span class="op" id="5179093">(</span><span class="op" id="5179094">)</span>&nbsp;<span class="op" id="5179096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179099">sort</span><span class="op" id="5179103">.</span><span class="ident" id="5179104">Sort</span><span class="op" id="5179108">(</span><span class="ident" id="5179109">p</span><span class="op" id="5179110">)</span><br>
<span class="lineno"></span><span class="op" id="5179112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5179115">var</span>&nbsp;<span class="ident" id="5179119">anyRuneNotNL</span>&nbsp;<span class="op" id="5179132">=</span>&nbsp;<span class="op" id="5179134">[</span><span class="op" id="5179135">]</span><span class="builtintype" id="5179136">rune</span><span class="op" id="5179140">{</span><span class="num" id="5179141">0</span><span class="op" id="5179142">,</span>&nbsp;<span class="string" id="5179144">&#39;\n&#39;</span>&nbsp;<span class="op" id="5179149">-</span>&nbsp;<span class="num" id="5179151">1</span><span class="op" id="5179152">,</span>&nbsp;<span class="string" id="5179154">&#39;\n&#39;</span>&nbsp;<span class="op" id="5179159">+</span>&nbsp;<span class="num" id="5179161">1</span><span class="op" id="5179162">,</span>&nbsp;<span class="ident" id="5179164">unicode</span><span class="op" id="5179171">.</span><span class="ident" id="5179172">MaxRune</span><span class="op" id="5179179">}</span><br>
<span class="lineno">295</span><span class="keyword" id="5179181">var</span>&nbsp;<span class="ident" id="5179185">anyRune</span>&nbsp;<span class="op" id="5179193">=</span>&nbsp;<span class="op" id="5179195">[</span><span class="op" id="5179196">]</span><span class="builtintype" id="5179197">rune</span><span class="op" id="5179201">{</span><span class="num" id="5179202">0</span><span class="op" id="5179203">,</span>&nbsp;<span class="ident" id="5179205">unicode</span><span class="op" id="5179212">.</span><span class="ident" id="5179213">MaxRune</span><span class="op" id="5179220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5179223">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="5179305">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="5179386">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="5179466">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="5179541">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="5179569">func</span>&nbsp;<span class="ident" id="5179574">makeOnePass</span><span class="op" id="5179585">(</span><span class="ident" id="5179586">p</span>&nbsp;<span class="op" id="5179588">*</span><span class="ident" id="5179589">onePassProg</span><span class="op" id="5179600">)</span>&nbsp;<span class="op" id="5179602">*</span><span class="ident" id="5179603">onePassProg</span>&nbsp;<span class="op" id="5179615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5179618">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179708">if</span>&nbsp;<span class="builtinfunc" id="5179711">len</span><span class="op" id="5179714">(</span><span class="ident" id="5179715">p</span><span class="op" id="5179716">.</span><span class="ident" id="5179717">Inst</span><span class="op" id="5179721">)</span>&nbsp;<span class="op" id="5179723">&gt;=</span>&nbsp;<span class="num" id="5179726">1000</span>&nbsp;<span class="op" id="5179731">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179735">return</span>&nbsp;<span class="ident" id="5179742">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5179758">var</span>&nbsp;<span class="op" id="5179762">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179766">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5179779">=</span>&nbsp;<span class="ident" id="5179781">newQueue</span><span class="op" id="5179789">(</span><span class="builtinfunc" id="5179790">len</span><span class="op" id="5179793">(</span><span class="ident" id="5179794">p</span><span class="op" id="5179795">.</span><span class="ident" id="5179796">Inst</span><span class="op" id="5179800">)</span><span class="op" id="5179801">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179805">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5179818">=</span>&nbsp;<span class="ident" id="5179820">newQueue</span><span class="op" id="5179828">(</span><span class="builtinfunc" id="5179829">len</span><span class="op" id="5179832">(</span><span class="ident" id="5179833">p</span><span class="op" id="5179834">.</span><span class="ident" id="5179835">Inst</span><span class="op" id="5179839">)</span><span class="op" id="5179840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179844">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179857">func</span><span class="op" id="5179861">(</span><span class="builtintype" id="5179862">uint32</span><span class="op" id="5179868">,</span>&nbsp;<span class="op" id="5179870">*</span><span class="ident" id="5179871">queueOnePass</span><span class="op" id="5179883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179887">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179900">func</span><span class="op" id="5179904">(</span><span class="builtintype" id="5179905">uint32</span><span class="op" id="5179911">,</span>&nbsp;<span class="keyword" id="5179913">map</span><span class="op" id="5179916">[</span><span class="builtintype" id="5179917">uint32</span><span class="op" id="5179923">]</span><span class="builtintype" id="5179924">bool</span><span class="op" id="5179928">)</span>&nbsp;<span class="builtintype" id="5179930">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179937">onePassRunes</span>&nbsp;<span class="op" id="5179950">=</span>&nbsp;<span class="builtinfunc" id="5179952">make</span><span class="op" id="5179956">(</span><span class="op" id="5179957">[</span><span class="op" id="5179958">]</span><span class="op" id="5179959">[</span><span class="op" id="5179960">]</span><span class="builtintype" id="5179961">rune</span><span class="op" id="5179965">,</span>&nbsp;<span class="builtinfunc" id="5179967">len</span><span class="op" id="5179970">(</span><span class="ident" id="5179971">p</span><span class="op" id="5179972">.</span><span class="ident" id="5179973">Inst</span><span class="op" id="5179977">)</span><span class="op" id="5179978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5179981">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5179984">build</span>&nbsp;<span class="op" id="5179990">=</span>&nbsp;<span class="keyword" id="5179992">func</span><span class="op" id="5179996">(</span><span class="ident" id="5179997">pc</span>&nbsp;<span class="builtintype" id="5180000">uint32</span><span class="op" id="5180006">,</span>&nbsp;<span class="ident" id="5180008">q</span>&nbsp;<span class="op" id="5180010">*</span><span class="ident" id="5180011">queueOnePass</span><span class="op" id="5180023">)</span>&nbsp;<span class="op" id="5180025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180029">if</span>&nbsp;<span class="ident" id="5180032">q</span><span class="op" id="5180033">.</span><span class="ident" id="5180034">contains</span><span class="op" id="5180042">(</span><span class="ident" id="5180043">pc</span><span class="op" id="5180045">)</span>&nbsp;<span class="op" id="5180047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180052">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180065">inst</span>&nbsp;<span class="op" id="5180070">:=</span>&nbsp;<span class="ident" id="5180073">p</span><span class="op" id="5180074">.</span><span class="ident" id="5180075">Inst</span><span class="op" id="5180079">[</span><span class="ident" id="5180080">pc</span><span class="op" id="5180082">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180086">switch</span>&nbsp;<span class="ident" id="5180093">inst</span><span class="op" id="5180097">.</span><span class="ident" id="5180098">Op</span>&nbsp;<span class="op" id="5180101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180105">case</span>&nbsp;<span class="ident" id="5180110">syntax</span><span class="op" id="5180116">.</span><span class="ident" id="5180117">InstAlt</span><span class="op" id="5180124">,</span>&nbsp;<span class="ident" id="5180126">syntax</span><span class="op" id="5180132">.</span><span class="ident" id="5180133">InstAltMatch</span><span class="op" id="5180145">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180150">q</span><span class="op" id="5180151">.</span><span class="ident" id="5180152">insert</span><span class="op" id="5180158">(</span><span class="ident" id="5180159">inst</span><span class="op" id="5180163">.</span><span class="ident" id="5180164">Out</span><span class="op" id="5180167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180172">build</span><span class="op" id="5180177">(</span><span class="ident" id="5180178">inst</span><span class="op" id="5180182">.</span><span class="ident" id="5180183">Out</span><span class="op" id="5180186">,</span>&nbsp;<span class="ident" id="5180188">q</span><span class="op" id="5180189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180194">q</span><span class="op" id="5180195">.</span><span class="ident" id="5180196">insert</span><span class="op" id="5180202">(</span><span class="ident" id="5180203">inst</span><span class="op" id="5180207">.</span><span class="ident" id="5180208">Arg</span><span class="op" id="5180211">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180215">case</span>&nbsp;<span class="ident" id="5180220">syntax</span><span class="op" id="5180226">.</span><span class="ident" id="5180227">InstMatch</span><span class="op" id="5180236">,</span>&nbsp;<span class="ident" id="5180238">syntax</span><span class="op" id="5180244">.</span><span class="ident" id="5180245">InstFail</span><span class="op" id="5180253">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180257">default</span><span class="op" id="5180264">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180269">q</span><span class="op" id="5180270">.</span><span class="ident" id="5180271">insert</span><span class="op" id="5180277">(</span><span class="ident" id="5180278">inst</span><span class="op" id="5180282">.</span><span class="ident" id="5180283">Out</span><span class="op" id="5180286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180293">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5180297">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5180377">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180410">check</span>&nbsp;<span class="op" id="5180416">=</span>&nbsp;<span class="keyword" id="5180418">func</span><span class="op" id="5180422">(</span><span class="ident" id="5180423">pc</span>&nbsp;<span class="builtintype" id="5180426">uint32</span><span class="op" id="5180432">,</span>&nbsp;<span class="ident" id="5180434">m</span>&nbsp;<span class="keyword" id="5180436">map</span><span class="op" id="5180439">[</span><span class="builtintype" id="5180440">uint32</span><span class="op" id="5180446">]</span><span class="builtintype" id="5180447">bool</span><span class="op" id="5180451">)</span>&nbsp;<span class="op" id="5180453">(</span><span class="ident" id="5180454">ok</span>&nbsp;<span class="builtintype" id="5180457">bool</span><span class="op" id="5180461">)</span>&nbsp;<span class="op" id="5180463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180467">ok</span>&nbsp;<span class="op" id="5180470">=</span>&nbsp;<span class="ident" id="5180472">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180479">inst</span>&nbsp;<span class="op" id="5180484">:=</span>&nbsp;<span class="op" id="5180487">&amp;</span><span class="ident" id="5180488">p</span><span class="op" id="5180489">.</span><span class="ident" id="5180490">Inst</span><span class="op" id="5180494">[</span><span class="ident" id="5180495">pc</span><span class="op" id="5180497">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180501">if</span>&nbsp;<span class="ident" id="5180504">visitQueue</span><span class="op" id="5180514">.</span><span class="ident" id="5180515">contains</span><span class="op" id="5180523">(</span><span class="ident" id="5180524">pc</span><span class="op" id="5180526">)</span>&nbsp;<span class="op" id="5180528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180533">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180546">visitQueue</span><span class="op" id="5180556">.</span><span class="ident" id="5180557">insert</span><span class="op" id="5180563">(</span><span class="ident" id="5180564">pc</span><span class="op" id="5180566">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180570">switch</span>&nbsp;<span class="ident" id="5180577">inst</span><span class="op" id="5180581">.</span><span class="ident" id="5180582">Op</span>&nbsp;<span class="op" id="5180585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180589">case</span>&nbsp;<span class="ident" id="5180594">syntax</span><span class="op" id="5180600">.</span><span class="ident" id="5180601">InstAlt</span><span class="op" id="5180608">,</span>&nbsp;<span class="ident" id="5180610">syntax</span><span class="op" id="5180616">.</span><span class="ident" id="5180617">InstAltMatch</span><span class="op" id="5180629">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180634">ok</span>&nbsp;<span class="op" id="5180637">=</span>&nbsp;<span class="ident" id="5180639">check</span><span class="op" id="5180644">(</span><span class="ident" id="5180645">inst</span><span class="op" id="5180649">.</span><span class="ident" id="5180650">Out</span><span class="op" id="5180653">,</span>&nbsp;<span class="ident" id="5180655">m</span><span class="op" id="5180656">)</span>&nbsp;<span class="op" id="5180658">&amp;&amp;</span>&nbsp;<span class="ident" id="5180661">check</span><span class="op" id="5180666">(</span><span class="ident" id="5180667">inst</span><span class="op" id="5180671">.</span><span class="ident" id="5180672">Arg</span><span class="op" id="5180675">,</span>&nbsp;<span class="ident" id="5180677">m</span><span class="op" id="5180678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5180683">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180723">matchOut</span>&nbsp;<span class="op" id="5180732">:=</span>&nbsp;<span class="ident" id="5180735">m</span><span class="op" id="5180736">[</span><span class="ident" id="5180737">inst</span><span class="op" id="5180741">.</span><span class="ident" id="5180742">Out</span><span class="op" id="5180745">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180750">matchArg</span>&nbsp;<span class="op" id="5180759">:=</span>&nbsp;<span class="ident" id="5180762">m</span><span class="op" id="5180763">[</span><span class="ident" id="5180764">inst</span><span class="op" id="5180768">.</span><span class="ident" id="5180769">Arg</span><span class="op" id="5180772">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180777">if</span>&nbsp;<span class="ident" id="5180780">matchOut</span>&nbsp;<span class="op" id="5180789">&amp;&amp;</span>&nbsp;<span class="ident" id="5180792">matchArg</span>&nbsp;<span class="op" id="5180801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180807">ok</span>&nbsp;<span class="op" id="5180810">=</span>&nbsp;<span class="ident" id="5180812">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180822">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180831">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5180836">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180874">if</span>&nbsp;<span class="ident" id="5180877">matchArg</span>&nbsp;<span class="op" id="5180886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180892">inst</span><span class="op" id="5180896">.</span><span class="ident" id="5180897">Out</span><span class="op" id="5180900">,</span>&nbsp;<span class="ident" id="5180902">inst</span><span class="op" id="5180906">.</span><span class="ident" id="5180907">Arg</span>&nbsp;<span class="op" id="5180911">=</span>&nbsp;<span class="ident" id="5180913">inst</span><span class="op" id="5180917">.</span><span class="ident" id="5180918">Arg</span><span class="op" id="5180921">,</span>&nbsp;<span class="ident" id="5180923">inst</span><span class="op" id="5180927">.</span><span class="ident" id="5180928">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5180936">matchOut</span><span class="op" id="5180944">,</span>&nbsp;<span class="ident" id="5180946">matchArg</span>&nbsp;<span class="op" id="5180955">=</span>&nbsp;<span class="ident" id="5180957">matchArg</span><span class="op" id="5180965">,</span>&nbsp;<span class="ident" id="5180967">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5180979">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5180984">if</span>&nbsp;<span class="ident" id="5180987">matchOut</span>&nbsp;<span class="op" id="5180996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181002">m</span><span class="op" id="5181003">[</span><span class="ident" id="5181004">pc</span><span class="op" id="5181006">]</span>&nbsp;<span class="op" id="5181008">=</span>&nbsp;<span class="ident" id="5181010">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181019">inst</span><span class="op" id="5181023">.</span><span class="ident" id="5181024">Op</span>&nbsp;<span class="op" id="5181027">=</span>&nbsp;<span class="ident" id="5181029">syntax</span><span class="op" id="5181035">.</span><span class="ident" id="5181036">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5181058">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181120">onePassRunes</span><span class="op" id="5181132">[</span><span class="ident" id="5181133">pc</span><span class="op" id="5181135">]</span><span class="op" id="5181136">,</span>&nbsp;<span class="ident" id="5181138">inst</span><span class="op" id="5181142">.</span><span class="ident" id="5181143">Next</span>&nbsp;<span class="op" id="5181148">=</span>&nbsp;<span class="ident" id="5181150">mergeRuneSets</span><span class="op" id="5181163">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181169">&amp;</span><span class="ident" id="5181170">onePassRunes</span><span class="op" id="5181182">[</span><span class="ident" id="5181183">inst</span><span class="op" id="5181187">.</span><span class="ident" id="5181188">Out</span><span class="op" id="5181191">]</span><span class="op" id="5181192">,</span>&nbsp;<span class="op" id="5181194">&amp;</span><span class="ident" id="5181195">onePassRunes</span><span class="op" id="5181207">[</span><span class="ident" id="5181208">inst</span><span class="op" id="5181212">.</span><span class="ident" id="5181213">Arg</span><span class="op" id="5181216">]</span><span class="op" id="5181217">,</span>&nbsp;<span class="ident" id="5181219">inst</span><span class="op" id="5181223">.</span><span class="ident" id="5181224">Out</span><span class="op" id="5181227">,</span>&nbsp;<span class="ident" id="5181229">inst</span><span class="op" id="5181233">.</span><span class="ident" id="5181234">Arg</span><span class="op" id="5181237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181242">if</span>&nbsp;<span class="builtinfunc" id="5181245">len</span><span class="op" id="5181248">(</span><span class="ident" id="5181249">inst</span><span class="op" id="5181253">.</span><span class="ident" id="5181254">Next</span><span class="op" id="5181258">)</span>&nbsp;<span class="op" id="5181260">&gt;</span>&nbsp;<span class="num" id="5181262">0</span>&nbsp;<span class="op" id="5181264">&amp;&amp;</span>&nbsp;<span class="ident" id="5181267">inst</span><span class="op" id="5181271">.</span><span class="ident" id="5181272">Next</span><span class="op" id="5181276">[</span><span class="num" id="5181277">0</span><span class="op" id="5181278">]</span>&nbsp;<span class="op" id="5181280">==</span>&nbsp;<span class="ident" id="5181283">mergeFailed</span>&nbsp;<span class="op" id="5181295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181301">ok</span>&nbsp;<span class="op" id="5181304">=</span>&nbsp;<span class="ident" id="5181306">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181316">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181329">case</span>&nbsp;<span class="ident" id="5181334">syntax</span><span class="op" id="5181340">.</span><span class="ident" id="5181341">InstCapture</span><span class="op" id="5181352">,</span>&nbsp;<span class="ident" id="5181354">syntax</span><span class="op" id="5181360">.</span><span class="ident" id="5181361">InstNop</span><span class="op" id="5181368">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181373">ok</span>&nbsp;<span class="op" id="5181376">=</span>&nbsp;<span class="ident" id="5181378">check</span><span class="op" id="5181383">(</span><span class="ident" id="5181384">inst</span><span class="op" id="5181388">.</span><span class="ident" id="5181389">Out</span><span class="op" id="5181392">,</span>&nbsp;<span class="ident" id="5181394">m</span><span class="op" id="5181395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181400">m</span><span class="op" id="5181401">[</span><span class="ident" id="5181402">pc</span><span class="op" id="5181404">]</span>&nbsp;<span class="op" id="5181406">=</span>&nbsp;<span class="ident" id="5181408">m</span><span class="op" id="5181409">[</span><span class="ident" id="5181410">inst</span><span class="op" id="5181414">.</span><span class="ident" id="5181415">Out</span><span class="op" id="5181418">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5181423">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181476">onePassRunes</span><span class="op" id="5181488">[</span><span class="ident" id="5181489">pc</span><span class="op" id="5181491">]</span>&nbsp;<span class="op" id="5181493">=</span>&nbsp;<span class="builtinfunc" id="5181495">append</span><span class="op" id="5181501">(</span><span class="op" id="5181502">[</span><span class="op" id="5181503">]</span><span class="builtintype" id="5181504">rune</span><span class="op" id="5181508">{</span><span class="op" id="5181509">}</span><span class="op" id="5181510">,</span>&nbsp;<span class="ident" id="5181512">onePassRunes</span><span class="op" id="5181524">[</span><span class="ident" id="5181525">inst</span><span class="op" id="5181529">.</span><span class="ident" id="5181530">Out</span><span class="op" id="5181533">]</span><span class="op" id="5181534">...</span><span class="op" id="5181537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181542">inst</span><span class="op" id="5181546">.</span><span class="ident" id="5181547">Next</span>&nbsp;<span class="op" id="5181552">=</span>&nbsp;<span class="op" id="5181554">[</span><span class="op" id="5181555">]</span><span class="builtintype" id="5181556">uint32</span><span class="op" id="5181562">{</span><span class="op" id="5181563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181568">for</span>&nbsp;<span class="ident" id="5181572">i</span>&nbsp;<span class="op" id="5181574">:=</span>&nbsp;<span class="builtinfunc" id="5181577">len</span><span class="op" id="5181580">(</span><span class="ident" id="5181581">onePassRunes</span><span class="op" id="5181593">[</span><span class="ident" id="5181594">pc</span><span class="op" id="5181596">]</span><span class="op" id="5181597">)</span>&nbsp;<span class="op" id="5181599">/</span>&nbsp;<span class="num" id="5181601">2</span><span class="op" id="5181602">;</span>&nbsp;<span class="ident" id="5181604">i</span>&nbsp;<span class="op" id="5181606">&gt;=</span>&nbsp;<span class="num" id="5181609">0</span><span class="op" id="5181610">;</span>&nbsp;<span class="ident" id="5181612">i</span><span class="op" id="5181613">--</span>&nbsp;<span class="op" id="5181616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181622">inst</span><span class="op" id="5181626">.</span><span class="ident" id="5181627">Next</span>&nbsp;<span class="op" id="5181632">=</span>&nbsp;<span class="builtinfunc" id="5181634">append</span><span class="op" id="5181640">(</span><span class="ident" id="5181641">inst</span><span class="op" id="5181645">.</span><span class="ident" id="5181646">Next</span><span class="op" id="5181650">,</span>&nbsp;<span class="ident" id="5181652">inst</span><span class="op" id="5181656">.</span><span class="ident" id="5181657">Out</span><span class="op" id="5181660">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181669">case</span>&nbsp;<span class="ident" id="5181674">syntax</span><span class="op" id="5181680">.</span><span class="ident" id="5181681">InstEmptyWidth</span><span class="op" id="5181695">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181700">ok</span>&nbsp;<span class="op" id="5181703">=</span>&nbsp;<span class="ident" id="5181705">check</span><span class="op" id="5181710">(</span><span class="ident" id="5181711">inst</span><span class="op" id="5181715">.</span><span class="ident" id="5181716">Out</span><span class="op" id="5181719">,</span>&nbsp;<span class="ident" id="5181721">m</span><span class="op" id="5181722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181727">m</span><span class="op" id="5181728">[</span><span class="ident" id="5181729">pc</span><span class="op" id="5181731">]</span>&nbsp;<span class="op" id="5181733">=</span>&nbsp;<span class="ident" id="5181735">m</span><span class="op" id="5181736">[</span><span class="ident" id="5181737">inst</span><span class="op" id="5181741">.</span><span class="ident" id="5181742">Out</span><span class="op" id="5181745">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181750">onePassRunes</span><span class="op" id="5181762">[</span><span class="ident" id="5181763">pc</span><span class="op" id="5181765">]</span>&nbsp;<span class="op" id="5181767">=</span>&nbsp;<span class="builtinfunc" id="5181769">append</span><span class="op" id="5181775">(</span><span class="op" id="5181776">[</span><span class="op" id="5181777">]</span><span class="builtintype" id="5181778">rune</span><span class="op" id="5181782">{</span><span class="op" id="5181783">}</span><span class="op" id="5181784">,</span>&nbsp;<span class="ident" id="5181786">onePassRunes</span><span class="op" id="5181798">[</span><span class="ident" id="5181799">inst</span><span class="op" id="5181803">.</span><span class="ident" id="5181804">Out</span><span class="op" id="5181807">]</span><span class="op" id="5181808">...</span><span class="op" id="5181811">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181816">inst</span><span class="op" id="5181820">.</span><span class="ident" id="5181821">Next</span>&nbsp;<span class="op" id="5181826">=</span>&nbsp;<span class="op" id="5181828">[</span><span class="op" id="5181829">]</span><span class="builtintype" id="5181830">uint32</span><span class="op" id="5181836">{</span><span class="op" id="5181837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181842">for</span>&nbsp;<span class="ident" id="5181846">i</span>&nbsp;<span class="op" id="5181848">:=</span>&nbsp;<span class="builtinfunc" id="5181851">len</span><span class="op" id="5181854">(</span><span class="ident" id="5181855">onePassRunes</span><span class="op" id="5181867">[</span><span class="ident" id="5181868">pc</span><span class="op" id="5181870">]</span><span class="op" id="5181871">)</span>&nbsp;<span class="op" id="5181873">/</span>&nbsp;<span class="num" id="5181875">2</span><span class="op" id="5181876">;</span>&nbsp;<span class="ident" id="5181878">i</span>&nbsp;<span class="op" id="5181880">&gt;=</span>&nbsp;<span class="num" id="5181883">0</span><span class="op" id="5181884">;</span>&nbsp;<span class="ident" id="5181886">i</span><span class="op" id="5181887">--</span>&nbsp;<span class="op" id="5181890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181896">inst</span><span class="op" id="5181900">.</span><span class="ident" id="5181901">Next</span>&nbsp;<span class="op" id="5181906">=</span>&nbsp;<span class="builtinfunc" id="5181908">append</span><span class="op" id="5181914">(</span><span class="ident" id="5181915">inst</span><span class="op" id="5181919">.</span><span class="ident" id="5181920">Next</span><span class="op" id="5181924">,</span>&nbsp;<span class="ident" id="5181926">inst</span><span class="op" id="5181930">.</span><span class="ident" id="5181931">Out</span><span class="op" id="5181934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5181939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5181943">case</span>&nbsp;<span class="ident" id="5181948">syntax</span><span class="op" id="5181954">.</span><span class="ident" id="5181955">InstMatch</span><span class="op" id="5181964">,</span>&nbsp;<span class="ident" id="5181966">syntax</span><span class="op" id="5181972">.</span><span class="ident" id="5181973">InstFail</span><span class="op" id="5181981">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5181986">m</span><span class="op" id="5181987">[</span><span class="ident" id="5181988">pc</span><span class="op" id="5181990">]</span>&nbsp;<span class="op" id="5181992">=</span>&nbsp;<span class="ident" id="5181994">inst</span><span class="op" id="5181998">.</span><span class="ident" id="5181999">Op</span>&nbsp;<span class="op" id="5182002">==</span>&nbsp;<span class="ident" id="5182005">syntax</span><span class="op" id="5182011">.</span><span class="ident" id="5182012">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182025">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182033">case</span>&nbsp;<span class="ident" id="5182038">syntax</span><span class="op" id="5182044">.</span><span class="ident" id="5182045">InstRune</span><span class="op" id="5182053">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182058">ok</span>&nbsp;<span class="op" id="5182061">=</span>&nbsp;<span class="ident" id="5182063">check</span><span class="op" id="5182068">(</span><span class="ident" id="5182069">inst</span><span class="op" id="5182073">.</span><span class="ident" id="5182074">Out</span><span class="op" id="5182077">,</span>&nbsp;<span class="ident" id="5182079">m</span><span class="op" id="5182080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182085">m</span><span class="op" id="5182086">[</span><span class="ident" id="5182087">pc</span><span class="op" id="5182089">]</span>&nbsp;<span class="op" id="5182091">=</span>&nbsp;<span class="ident" id="5182093">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182102">if</span>&nbsp;<span class="builtinfunc" id="5182105">len</span><span class="op" id="5182108">(</span><span class="ident" id="5182109">inst</span><span class="op" id="5182113">.</span><span class="ident" id="5182114">Next</span><span class="op" id="5182118">)</span>&nbsp;<span class="op" id="5182120">&gt;</span>&nbsp;<span class="num" id="5182122">0</span>&nbsp;<span class="op" id="5182124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182130">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182144">if</span>&nbsp;<span class="builtinfunc" id="5182147">len</span><span class="op" id="5182150">(</span><span class="ident" id="5182151">inst</span><span class="op" id="5182155">.</span><span class="ident" id="5182156">Rune</span><span class="op" id="5182160">)</span>&nbsp;<span class="op" id="5182162">==</span>&nbsp;<span class="num" id="5182165">0</span>&nbsp;<span class="op" id="5182167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182173">onePassRunes</span><span class="op" id="5182185">[</span><span class="ident" id="5182186">pc</span><span class="op" id="5182188">]</span>&nbsp;<span class="op" id="5182190">=</span>&nbsp;<span class="op" id="5182192">[</span><span class="op" id="5182193">]</span><span class="builtintype" id="5182194">rune</span><span class="op" id="5182198">{</span><span class="op" id="5182199">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182205">inst</span><span class="op" id="5182209">.</span><span class="ident" id="5182210">Next</span>&nbsp;<span class="op" id="5182215">=</span>&nbsp;<span class="op" id="5182217">[</span><span class="op" id="5182218">]</span><span class="builtintype" id="5182219">uint32</span><span class="op" id="5182225">{</span><span class="ident" id="5182226">inst</span><span class="op" id="5182230">.</span><span class="ident" id="5182231">Out</span><span class="op" id="5182234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182240">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182254">runes</span>&nbsp;<span class="op" id="5182260">:=</span>&nbsp;<span class="builtinfunc" id="5182263">make</span><span class="op" id="5182267">(</span><span class="op" id="5182268">[</span><span class="op" id="5182269">]</span><span class="builtintype" id="5182270">rune</span><span class="op" id="5182274">,</span>&nbsp;<span class="num" id="5182276">0</span><span class="op" id="5182277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182282">if</span>&nbsp;<span class="builtinfunc" id="5182285">len</span><span class="op" id="5182288">(</span><span class="ident" id="5182289">inst</span><span class="op" id="5182293">.</span><span class="ident" id="5182294">Rune</span><span class="op" id="5182298">)</span>&nbsp;<span class="op" id="5182300">==</span>&nbsp;<span class="num" id="5182303">1</span>&nbsp;<span class="op" id="5182305">&amp;&amp;</span>&nbsp;<span class="ident" id="5182308">syntax</span><span class="op" id="5182314">.</span><span class="ident" id="5182315">Flags</span><span class="op" id="5182320">(</span><span class="ident" id="5182321">inst</span><span class="op" id="5182325">.</span><span class="ident" id="5182326">Arg</span><span class="op" id="5182329">)</span><span class="op" id="5182330">&amp;</span><span class="ident" id="5182331">syntax</span><span class="op" id="5182337">.</span><span class="ident" id="5182338">FoldCase</span>&nbsp;<span class="op" id="5182347">!=</span>&nbsp;<span class="num" id="5182350">0</span>&nbsp;<span class="op" id="5182352">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182358">r0</span>&nbsp;<span class="op" id="5182361">:=</span>&nbsp;<span class="ident" id="5182364">inst</span><span class="op" id="5182368">.</span><span class="ident" id="5182369">Rune</span><span class="op" id="5182373">[</span><span class="num" id="5182374">0</span><span class="op" id="5182375">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182381">runes</span>&nbsp;<span class="op" id="5182387">=</span>&nbsp;<span class="builtinfunc" id="5182389">append</span><span class="op" id="5182395">(</span><span class="ident" id="5182396">runes</span><span class="op" id="5182401">,</span>&nbsp;<span class="ident" id="5182403">r0</span><span class="op" id="5182405">,</span>&nbsp;<span class="ident" id="5182407">r0</span><span class="op" id="5182409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182415">for</span>&nbsp;<span class="ident" id="5182419">r1</span>&nbsp;<span class="op" id="5182422">:=</span>&nbsp;<span class="ident" id="5182425">unicode</span><span class="op" id="5182432">.</span><span class="ident" id="5182433">SimpleFold</span><span class="op" id="5182443">(</span><span class="ident" id="5182444">r0</span><span class="op" id="5182446">)</span><span class="op" id="5182447">;</span>&nbsp;<span class="ident" id="5182449">r1</span>&nbsp;<span class="op" id="5182452">!=</span>&nbsp;<span class="ident" id="5182455">r0</span><span class="op" id="5182457">;</span>&nbsp;<span class="ident" id="5182459">r1</span>&nbsp;<span class="op" id="5182462">=</span>&nbsp;<span class="ident" id="5182464">unicode</span><span class="op" id="5182471">.</span><span class="ident" id="5182472">SimpleFold</span><span class="op" id="5182482">(</span><span class="ident" id="5182483">r1</span><span class="op" id="5182485">)</span>&nbsp;<span class="op" id="5182487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182494">runes</span>&nbsp;<span class="op" id="5182500">=</span>&nbsp;<span class="builtinfunc" id="5182502">append</span><span class="op" id="5182508">(</span><span class="ident" id="5182509">runes</span><span class="op" id="5182514">,</span>&nbsp;<span class="ident" id="5182516">r1</span><span class="op" id="5182518">,</span>&nbsp;<span class="ident" id="5182520">r1</span><span class="op" id="5182522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182528">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182534">sort</span><span class="op" id="5182538">.</span><span class="ident" id="5182539">Sort</span><span class="op" id="5182543">(</span><span class="ident" id="5182544">runeSlice</span><span class="op" id="5182553">(</span><span class="ident" id="5182554">runes</span><span class="op" id="5182559">)</span><span class="op" id="5182560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182565">}</span>&nbsp;<span class="keyword" id="5182567">else</span>&nbsp;<span class="op" id="5182572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182578">runes</span>&nbsp;<span class="op" id="5182584">=</span>&nbsp;<span class="builtinfunc" id="5182586">append</span><span class="op" id="5182592">(</span><span class="ident" id="5182593">runes</span><span class="op" id="5182598">,</span>&nbsp;<span class="ident" id="5182600">inst</span><span class="op" id="5182604">.</span><span class="ident" id="5182605">Rune</span><span class="op" id="5182609">...</span><span class="op" id="5182612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182622">onePassRunes</span><span class="op" id="5182634">[</span><span class="ident" id="5182635">pc</span><span class="op" id="5182637">]</span>&nbsp;<span class="op" id="5182639">=</span>&nbsp;<span class="ident" id="5182641">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182650">inst</span><span class="op" id="5182654">.</span><span class="ident" id="5182655">Next</span>&nbsp;<span class="op" id="5182660">=</span>&nbsp;<span class="op" id="5182662">[</span><span class="op" id="5182663">]</span><span class="builtintype" id="5182664">uint32</span><span class="op" id="5182670">{</span><span class="op" id="5182671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182676">for</span>&nbsp;<span class="ident" id="5182680">i</span>&nbsp;<span class="op" id="5182682">:=</span>&nbsp;<span class="builtinfunc" id="5182685">len</span><span class="op" id="5182688">(</span><span class="ident" id="5182689">onePassRunes</span><span class="op" id="5182701">[</span><span class="ident" id="5182702">pc</span><span class="op" id="5182704">]</span><span class="op" id="5182705">)</span>&nbsp;<span class="op" id="5182707">/</span>&nbsp;<span class="num" id="5182709">2</span><span class="op" id="5182710">;</span>&nbsp;<span class="ident" id="5182712">i</span>&nbsp;<span class="op" id="5182714">&gt;=</span>&nbsp;<span class="num" id="5182717">0</span><span class="op" id="5182718">;</span>&nbsp;<span class="ident" id="5182720">i</span><span class="op" id="5182721">--</span>&nbsp;<span class="op" id="5182724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182730">inst</span><span class="op" id="5182734">.</span><span class="ident" id="5182735">Next</span>&nbsp;<span class="op" id="5182740">=</span>&nbsp;<span class="builtinfunc" id="5182742">append</span><span class="op" id="5182748">(</span><span class="ident" id="5182749">inst</span><span class="op" id="5182753">.</span><span class="ident" id="5182754">Next</span><span class="op" id="5182758">,</span>&nbsp;<span class="ident" id="5182760">inst</span><span class="op" id="5182764">.</span><span class="ident" id="5182765">Out</span><span class="op" id="5182768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182778">inst</span><span class="op" id="5182782">.</span><span class="ident" id="5182783">Op</span>&nbsp;<span class="op" id="5182786">=</span>&nbsp;<span class="ident" id="5182788">syntax</span><span class="op" id="5182794">.</span><span class="ident" id="5182795">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182806">case</span>&nbsp;<span class="ident" id="5182811">syntax</span><span class="op" id="5182817">.</span><span class="ident" id="5182818">InstRune1</span><span class="op" id="5182827">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182832">ok</span>&nbsp;<span class="op" id="5182835">=</span>&nbsp;<span class="ident" id="5182837">check</span><span class="op" id="5182842">(</span><span class="ident" id="5182843">inst</span><span class="op" id="5182847">.</span><span class="ident" id="5182848">Out</span><span class="op" id="5182851">,</span>&nbsp;<span class="ident" id="5182853">m</span><span class="op" id="5182854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182859">m</span><span class="op" id="5182860">[</span><span class="ident" id="5182861">pc</span><span class="op" id="5182863">]</span>&nbsp;<span class="op" id="5182865">=</span>&nbsp;<span class="ident" id="5182867">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182876">if</span>&nbsp;<span class="builtinfunc" id="5182879">len</span><span class="op" id="5182882">(</span><span class="ident" id="5182883">inst</span><span class="op" id="5182887">.</span><span class="ident" id="5182888">Next</span><span class="op" id="5182892">)</span>&nbsp;<span class="op" id="5182894">&gt;</span>&nbsp;<span class="num" id="5182896">0</span>&nbsp;<span class="op" id="5182898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182904">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5182913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5182918">runes</span>&nbsp;<span class="op" id="5182924">:=</span>&nbsp;<span class="op" id="5182927">[</span><span class="op" id="5182928">]</span><span class="builtintype" id="5182929">rune</span><span class="op" id="5182933">{</span><span class="op" id="5182934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5182939">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5182970">if</span>&nbsp;<span class="ident" id="5182973">syntax</span><span class="op" id="5182979">.</span><span class="ident" id="5182980">Flags</span><span class="op" id="5182985">(</span><span class="ident" id="5182986">inst</span><span class="op" id="5182990">.</span><span class="ident" id="5182991">Arg</span><span class="op" id="5182994">)</span><span class="op" id="5182995">&amp;</span><span class="ident" id="5182996">syntax</span><span class="op" id="5183002">.</span><span class="ident" id="5183003">FoldCase</span>&nbsp;<span class="op" id="5183012">!=</span>&nbsp;<span class="num" id="5183015">0</span>&nbsp;<span class="op" id="5183017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183023">r0</span>&nbsp;<span class="op" id="5183026">:=</span>&nbsp;<span class="ident" id="5183029">inst</span><span class="op" id="5183033">.</span><span class="ident" id="5183034">Rune</span><span class="op" id="5183038">[</span><span class="num" id="5183039">0</span><span class="op" id="5183040">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183046">runes</span>&nbsp;<span class="op" id="5183052">=</span>&nbsp;<span class="builtinfunc" id="5183054">append</span><span class="op" id="5183060">(</span><span class="ident" id="5183061">runes</span><span class="op" id="5183066">,</span>&nbsp;<span class="ident" id="5183068">r0</span><span class="op" id="5183070">,</span>&nbsp;<span class="ident" id="5183072">r0</span><span class="op" id="5183074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183080">for</span>&nbsp;<span class="ident" id="5183084">r1</span>&nbsp;<span class="op" id="5183087">:=</span>&nbsp;<span class="ident" id="5183090">unicode</span><span class="op" id="5183097">.</span><span class="ident" id="5183098">SimpleFold</span><span class="op" id="5183108">(</span><span class="ident" id="5183109">r0</span><span class="op" id="5183111">)</span><span class="op" id="5183112">;</span>&nbsp;<span class="ident" id="5183114">r1</span>&nbsp;<span class="op" id="5183117">!=</span>&nbsp;<span class="ident" id="5183120">r0</span><span class="op" id="5183122">;</span>&nbsp;<span class="ident" id="5183124">r1</span>&nbsp;<span class="op" id="5183127">=</span>&nbsp;<span class="ident" id="5183129">unicode</span><span class="op" id="5183136">.</span><span class="ident" id="5183137">SimpleFold</span><span class="op" id="5183147">(</span><span class="ident" id="5183148">r1</span><span class="op" id="5183150">)</span>&nbsp;<span class="op" id="5183152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183159">runes</span>&nbsp;<span class="op" id="5183165">=</span>&nbsp;<span class="builtinfunc" id="5183167">append</span><span class="op" id="5183173">(</span><span class="ident" id="5183174">runes</span><span class="op" id="5183179">,</span>&nbsp;<span class="ident" id="5183181">r1</span><span class="op" id="5183183">,</span>&nbsp;<span class="ident" id="5183185">r1</span><span class="op" id="5183187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183199">sort</span><span class="op" id="5183203">.</span><span class="ident" id="5183204">Sort</span><span class="op" id="5183208">(</span><span class="ident" id="5183209">runeSlice</span><span class="op" id="5183218">(</span><span class="ident" id="5183219">runes</span><span class="op" id="5183224">)</span><span class="op" id="5183225">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183230">}</span>&nbsp;<span class="keyword" id="5183232">else</span>&nbsp;<span class="op" id="5183237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183243">runes</span>&nbsp;<span class="op" id="5183249">=</span>&nbsp;<span class="builtinfunc" id="5183251">append</span><span class="op" id="5183257">(</span><span class="ident" id="5183258">runes</span><span class="op" id="5183263">,</span>&nbsp;<span class="ident" id="5183265">inst</span><span class="op" id="5183269">.</span><span class="ident" id="5183270">Rune</span><span class="op" id="5183274">[</span><span class="num" id="5183275">0</span><span class="op" id="5183276">]</span><span class="op" id="5183277">,</span>&nbsp;<span class="ident" id="5183279">inst</span><span class="op" id="5183283">.</span><span class="ident" id="5183284">Rune</span><span class="op" id="5183288">[</span><span class="num" id="5183289">0</span><span class="op" id="5183290">]</span><span class="op" id="5183291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183301">onePassRunes</span><span class="op" id="5183313">[</span><span class="ident" id="5183314">pc</span><span class="op" id="5183316">]</span>&nbsp;<span class="op" id="5183318">=</span>&nbsp;<span class="ident" id="5183320">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183329">inst</span><span class="op" id="5183333">.</span><span class="ident" id="5183334">Next</span>&nbsp;<span class="op" id="5183339">=</span>&nbsp;<span class="op" id="5183341">[</span><span class="op" id="5183342">]</span><span class="builtintype" id="5183343">uint32</span><span class="op" id="5183349">{</span><span class="op" id="5183350">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183355">for</span>&nbsp;<span class="ident" id="5183359">i</span>&nbsp;<span class="op" id="5183361">:=</span>&nbsp;<span class="builtinfunc" id="5183364">len</span><span class="op" id="5183367">(</span><span class="ident" id="5183368">onePassRunes</span><span class="op" id="5183380">[</span><span class="ident" id="5183381">pc</span><span class="op" id="5183383">]</span><span class="op" id="5183384">)</span>&nbsp;<span class="op" id="5183386">/</span>&nbsp;<span class="num" id="5183388">2</span><span class="op" id="5183389">;</span>&nbsp;<span class="ident" id="5183391">i</span>&nbsp;<span class="op" id="5183393">&gt;=</span>&nbsp;<span class="num" id="5183396">0</span><span class="op" id="5183397">;</span>&nbsp;<span class="ident" id="5183399">i</span><span class="op" id="5183400">--</span>&nbsp;<span class="op" id="5183403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183409">inst</span><span class="op" id="5183413">.</span><span class="ident" id="5183414">Next</span>&nbsp;<span class="op" id="5183419">=</span>&nbsp;<span class="builtinfunc" id="5183421">append</span><span class="op" id="5183427">(</span><span class="ident" id="5183428">inst</span><span class="op" id="5183432">.</span><span class="ident" id="5183433">Next</span><span class="op" id="5183437">,</span>&nbsp;<span class="ident" id="5183439">inst</span><span class="op" id="5183443">.</span><span class="ident" id="5183444">Out</span><span class="op" id="5183447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183457">inst</span><span class="op" id="5183461">.</span><span class="ident" id="5183462">Op</span>&nbsp;<span class="op" id="5183465">=</span>&nbsp;<span class="ident" id="5183467">syntax</span><span class="op" id="5183473">.</span><span class="ident" id="5183474">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183485">case</span>&nbsp;<span class="ident" id="5183490">syntax</span><span class="op" id="5183496">.</span><span class="ident" id="5183497">InstRuneAny</span><span class="op" id="5183508">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183513">ok</span>&nbsp;<span class="op" id="5183516">=</span>&nbsp;<span class="ident" id="5183518">check</span><span class="op" id="5183523">(</span><span class="ident" id="5183524">inst</span><span class="op" id="5183528">.</span><span class="ident" id="5183529">Out</span><span class="op" id="5183532">,</span>&nbsp;<span class="ident" id="5183534">m</span><span class="op" id="5183535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183540">m</span><span class="op" id="5183541">[</span><span class="ident" id="5183542">pc</span><span class="op" id="5183544">]</span>&nbsp;<span class="op" id="5183546">=</span>&nbsp;<span class="ident" id="5183548">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183557">if</span>&nbsp;<span class="builtinfunc" id="5183560">len</span><span class="op" id="5183563">(</span><span class="ident" id="5183564">inst</span><span class="op" id="5183568">.</span><span class="ident" id="5183569">Next</span><span class="op" id="5183573">)</span>&nbsp;<span class="op" id="5183575">&gt;</span>&nbsp;<span class="num" id="5183577">0</span>&nbsp;<span class="op" id="5183579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183585">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183594">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183599">onePassRunes</span><span class="op" id="5183611">[</span><span class="ident" id="5183612">pc</span><span class="op" id="5183614">]</span>&nbsp;<span class="op" id="5183616">=</span>&nbsp;<span class="builtinfunc" id="5183618">append</span><span class="op" id="5183624">(</span><span class="op" id="5183625">[</span><span class="op" id="5183626">]</span><span class="builtintype" id="5183627">rune</span><span class="op" id="5183631">{</span><span class="op" id="5183632">}</span><span class="op" id="5183633">,</span>&nbsp;<span class="ident" id="5183635">anyRune</span><span class="op" id="5183642">...</span><span class="op" id="5183645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183650">inst</span><span class="op" id="5183654">.</span><span class="ident" id="5183655">Next</span>&nbsp;<span class="op" id="5183660">=</span>&nbsp;<span class="op" id="5183662">[</span><span class="op" id="5183663">]</span><span class="builtintype" id="5183664">uint32</span><span class="op" id="5183670">{</span><span class="ident" id="5183671">inst</span><span class="op" id="5183675">.</span><span class="ident" id="5183676">Out</span><span class="op" id="5183679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183683">case</span>&nbsp;<span class="ident" id="5183688">syntax</span><span class="op" id="5183694">.</span><span class="ident" id="5183695">InstRuneAnyNotNL</span><span class="op" id="5183711">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183716">ok</span>&nbsp;<span class="op" id="5183719">=</span>&nbsp;<span class="ident" id="5183721">check</span><span class="op" id="5183726">(</span><span class="ident" id="5183727">inst</span><span class="op" id="5183731">.</span><span class="ident" id="5183732">Out</span><span class="op" id="5183735">,</span>&nbsp;<span class="ident" id="5183737">m</span><span class="op" id="5183738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183743">m</span><span class="op" id="5183744">[</span><span class="ident" id="5183745">pc</span><span class="op" id="5183747">]</span>&nbsp;<span class="op" id="5183749">=</span>&nbsp;<span class="ident" id="5183751">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183760">if</span>&nbsp;<span class="builtinfunc" id="5183763">len</span><span class="op" id="5183766">(</span><span class="ident" id="5183767">inst</span><span class="op" id="5183771">.</span><span class="ident" id="5183772">Next</span><span class="op" id="5183776">)</span>&nbsp;<span class="op" id="5183778">&gt;</span>&nbsp;<span class="num" id="5183780">0</span>&nbsp;<span class="op" id="5183782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183788">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183802">onePassRunes</span><span class="op" id="5183814">[</span><span class="ident" id="5183815">pc</span><span class="op" id="5183817">]</span>&nbsp;<span class="op" id="5183819">=</span>&nbsp;<span class="builtinfunc" id="5183821">append</span><span class="op" id="5183827">(</span><span class="op" id="5183828">[</span><span class="op" id="5183829">]</span><span class="builtintype" id="5183830">rune</span><span class="op" id="5183834">{</span><span class="op" id="5183835">}</span><span class="op" id="5183836">,</span>&nbsp;<span class="ident" id="5183838">anyRuneNotNL</span><span class="op" id="5183850">...</span><span class="op" id="5183853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183858">inst</span><span class="op" id="5183862">.</span><span class="ident" id="5183863">Next</span>&nbsp;<span class="op" id="5183868">=</span>&nbsp;<span class="op" id="5183870">[</span><span class="op" id="5183871">]</span><span class="builtintype" id="5183872">uint32</span><span class="op" id="5183878">{</span><span class="op" id="5183879">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183884">for</span>&nbsp;<span class="ident" id="5183888">i</span>&nbsp;<span class="op" id="5183890">:=</span>&nbsp;<span class="builtinfunc" id="5183893">len</span><span class="op" id="5183896">(</span><span class="ident" id="5183897">onePassRunes</span><span class="op" id="5183909">[</span><span class="ident" id="5183910">pc</span><span class="op" id="5183912">]</span><span class="op" id="5183913">)</span>&nbsp;<span class="op" id="5183915">/</span>&nbsp;<span class="num" id="5183917">2</span><span class="op" id="5183918">;</span>&nbsp;<span class="ident" id="5183920">i</span>&nbsp;<span class="op" id="5183922">&gt;=</span>&nbsp;<span class="num" id="5183925">0</span><span class="op" id="5183926">;</span>&nbsp;<span class="ident" id="5183928">i</span><span class="op" id="5183929">--</span>&nbsp;<span class="op" id="5183932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5183938">inst</span><span class="op" id="5183942">.</span><span class="ident" id="5183943">Next</span>&nbsp;<span class="op" id="5183948">=</span>&nbsp;<span class="builtinfunc" id="5183950">append</span><span class="op" id="5183956">(</span><span class="ident" id="5183957">inst</span><span class="op" id="5183961">.</span><span class="ident" id="5183962">Next</span><span class="op" id="5183966">,</span>&nbsp;<span class="ident" id="5183968">inst</span><span class="op" id="5183972">.</span><span class="ident" id="5183973">Out</span><span class="op" id="5183976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5183989">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5183997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184001">instQueue</span><span class="op" id="5184010">.</span><span class="ident" id="5184011">clear</span><span class="op" id="5184016">(</span><span class="op" id="5184017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184020">instQueue</span><span class="op" id="5184029">.</span><span class="ident" id="5184030">insert</span><span class="op" id="5184036">(</span><span class="builtintype" id="5184037">uint32</span><span class="op" id="5184043">(</span><span class="ident" id="5184044">p</span><span class="op" id="5184045">.</span><span class="ident" id="5184046">Start</span><span class="op" id="5184051">)</span><span class="op" id="5184052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184055">m</span>&nbsp;<span class="op" id="5184057">:=</span>&nbsp;<span class="builtinfunc" id="5184060">make</span><span class="op" id="5184064">(</span><span class="keyword" id="5184065">map</span><span class="op" id="5184068">[</span><span class="builtintype" id="5184069">uint32</span><span class="op" id="5184075">]</span><span class="builtintype" id="5184076">bool</span><span class="op" id="5184080">,</span>&nbsp;<span class="builtinfunc" id="5184082">len</span><span class="op" id="5184085">(</span><span class="ident" id="5184086">p</span><span class="op" id="5184087">.</span><span class="ident" id="5184088">Inst</span><span class="op" id="5184092">)</span><span class="op" id="5184093">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184096">for</span>&nbsp;<span class="op" id="5184100">!</span><span class="ident" id="5184101">instQueue</span><span class="op" id="5184110">.</span><span class="ident" id="5184111">empty</span><span class="op" id="5184116">(</span><span class="op" id="5184117">)</span>&nbsp;<span class="op" id="5184119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184123">pc</span>&nbsp;<span class="op" id="5184126">:=</span>&nbsp;<span class="ident" id="5184129">instQueue</span><span class="op" id="5184138">.</span><span class="ident" id="5184139">next</span><span class="op" id="5184143">(</span><span class="op" id="5184144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184148">inst</span>&nbsp;<span class="op" id="5184153">:=</span>&nbsp;<span class="ident" id="5184156">p</span><span class="op" id="5184157">.</span><span class="ident" id="5184158">Inst</span><span class="op" id="5184162">[</span><span class="ident" id="5184163">pc</span><span class="op" id="5184165">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184169">visitQueue</span><span class="op" id="5184179">.</span><span class="ident" id="5184180">clear</span><span class="op" id="5184185">(</span><span class="op" id="5184186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184190">if</span>&nbsp;<span class="op" id="5184193">!</span><span class="ident" id="5184194">check</span><span class="op" id="5184199">(</span><span class="builtintype" id="5184200">uint32</span><span class="op" id="5184206">(</span><span class="ident" id="5184207">pc</span><span class="op" id="5184209">)</span><span class="op" id="5184210">,</span>&nbsp;<span class="ident" id="5184212">m</span><span class="op" id="5184213">)</span>&nbsp;<span class="op" id="5184215">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184220">p</span>&nbsp;<span class="op" id="5184222">=</span>&nbsp;<span class="ident" id="5184224">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184238">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184250">switch</span>&nbsp;<span class="ident" id="5184257">inst</span><span class="op" id="5184261">.</span><span class="ident" id="5184262">Op</span>&nbsp;<span class="op" id="5184265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184269">case</span>&nbsp;<span class="ident" id="5184274">syntax</span><span class="op" id="5184280">.</span><span class="ident" id="5184281">InstAlt</span><span class="op" id="5184288">,</span>&nbsp;<span class="ident" id="5184290">syntax</span><span class="op" id="5184296">.</span><span class="ident" id="5184297">InstAltMatch</span><span class="op" id="5184309">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184314">instQueue</span><span class="op" id="5184323">.</span><span class="ident" id="5184324">insert</span><span class="op" id="5184330">(</span><span class="ident" id="5184331">inst</span><span class="op" id="5184335">.</span><span class="ident" id="5184336">Out</span><span class="op" id="5184339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184344">instQueue</span><span class="op" id="5184353">.</span><span class="ident" id="5184354">insert</span><span class="op" id="5184360">(</span><span class="ident" id="5184361">inst</span><span class="op" id="5184365">.</span><span class="ident" id="5184366">Arg</span><span class="op" id="5184369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184373">case</span>&nbsp;<span class="ident" id="5184378">syntax</span><span class="op" id="5184384">.</span><span class="ident" id="5184385">InstCapture</span><span class="op" id="5184396">,</span>&nbsp;<span class="ident" id="5184398">syntax</span><span class="op" id="5184404">.</span><span class="ident" id="5184405">InstEmptyWidth</span><span class="op" id="5184419">,</span>&nbsp;<span class="ident" id="5184421">syntax</span><span class="op" id="5184427">.</span><span class="ident" id="5184428">InstNop</span><span class="op" id="5184435">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184440">instQueue</span><span class="op" id="5184449">.</span><span class="ident" id="5184450">insert</span><span class="op" id="5184456">(</span><span class="ident" id="5184457">inst</span><span class="op" id="5184461">.</span><span class="ident" id="5184462">Out</span><span class="op" id="5184465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184469">case</span>&nbsp;<span class="ident" id="5184474">syntax</span><span class="op" id="5184480">.</span><span class="ident" id="5184481">InstMatch</span><span class="op" id="5184490">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184494">case</span>&nbsp;<span class="ident" id="5184499">syntax</span><span class="op" id="5184505">.</span><span class="ident" id="5184506">InstFail</span><span class="op" id="5184514">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184518">case</span>&nbsp;<span class="ident" id="5184523">syntax</span><span class="op" id="5184529">.</span><span class="ident" id="5184530">InstRune</span><span class="op" id="5184538">,</span>&nbsp;<span class="ident" id="5184540">syntax</span><span class="op" id="5184546">.</span><span class="ident" id="5184547">InstRune1</span><span class="op" id="5184556">,</span>&nbsp;<span class="ident" id="5184558">syntax</span><span class="op" id="5184564">.</span><span class="ident" id="5184565">InstRuneAny</span><span class="op" id="5184576">,</span>&nbsp;<span class="ident" id="5184578">syntax</span><span class="op" id="5184584">.</span><span class="ident" id="5184585">InstRuneAnyNotNL</span><span class="op" id="5184601">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184605">default</span><span class="op" id="5184612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184619">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184622">if</span>&nbsp;<span class="ident" id="5184625">p</span>&nbsp;<span class="op" id="5184627">!=</span>&nbsp;<span class="ident" id="5184630">notOnePass</span>&nbsp;<span class="op" id="5184641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184645">for</span>&nbsp;<span class="ident" id="5184649">i</span>&nbsp;<span class="op" id="5184651">:=</span>&nbsp;<span class="keyword" id="5184654">range</span>&nbsp;<span class="ident" id="5184660">p</span><span class="op" id="5184661">.</span><span class="ident" id="5184662">Inst</span>&nbsp;<span class="op" id="5184667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184672">p</span><span class="op" id="5184673">.</span><span class="ident" id="5184674">Inst</span><span class="op" id="5184678">[</span><span class="ident" id="5184679">i</span><span class="op" id="5184680">]</span><span class="op" id="5184681">.</span><span class="ident" id="5184682">Rune</span>&nbsp;<span class="op" id="5184687">=</span>&nbsp;<span class="ident" id="5184689">onePassRunes</span><span class="op" id="5184701">[</span><span class="ident" id="5184702">i</span><span class="op" id="5184703">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5184710">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184713">return</span>&nbsp;<span class="ident" id="5184720">p</span><br>
<span class="lineno"></span><span class="op" id="5184722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5184725">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="5184793">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="5184830">func</span>&nbsp;<span class="ident" id="5184835">walk</span><span class="op" id="5184839">(</span><span class="ident" id="5184840">prog</span>&nbsp;<span class="op" id="5184845">*</span><span class="ident" id="5184846">syntax</span><span class="op" id="5184852">.</span><span class="ident" id="5184853">Prog</span><span class="op" id="5184857">,</span>&nbsp;<span class="ident" id="5184859">funcs</span>&nbsp;<span class="op" id="5184865">...</span><span class="keyword" id="5184868">func</span><span class="op" id="5184872">(</span><span class="ident" id="5184873">ip</span><span class="op" id="5184875">,</span>&nbsp;<span class="ident" id="5184877">next</span>&nbsp;<span class="builtintype" id="5184882">uint32</span><span class="op" id="5184888">)</span><span class="op" id="5184889">)</span>&nbsp;<span class="op" id="5184891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184894">var</span>&nbsp;<span class="ident" id="5184898">walk1</span>&nbsp;<span class="keyword" id="5184904">func</span><span class="op" id="5184908">(</span><span class="builtintype" id="5184909">uint32</span><span class="op" id="5184915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184918">progQueue</span>&nbsp;<span class="op" id="5184928">:=</span>&nbsp;<span class="ident" id="5184931">newQueue</span><span class="op" id="5184939">(</span><span class="builtinfunc" id="5184940">len</span><span class="op" id="5184943">(</span><span class="ident" id="5184944">prog</span><span class="op" id="5184948">.</span><span class="ident" id="5184949">Inst</span><span class="op" id="5184953">)</span><span class="op" id="5184954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5184957">walk1</span>&nbsp;<span class="op" id="5184963">=</span>&nbsp;<span class="keyword" id="5184965">func</span><span class="op" id="5184969">(</span><span class="ident" id="5184970">ip</span>&nbsp;<span class="builtintype" id="5184973">uint32</span><span class="op" id="5184979">)</span>&nbsp;<span class="op" id="5184981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5184985">if</span>&nbsp;<span class="ident" id="5184988">progQueue</span><span class="op" id="5184997">.</span><span class="ident" id="5184998">contains</span><span class="op" id="5185006">(</span><span class="ident" id="5185007">ip</span><span class="op" id="5185009">)</span>&nbsp;<span class="op" id="5185011">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185016">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185029">progQueue</span><span class="op" id="5185038">.</span><span class="ident" id="5185039">insert</span><span class="op" id="5185045">(</span><span class="ident" id="5185046">ip</span><span class="op" id="5185048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185052">inst</span>&nbsp;<span class="op" id="5185057">:=</span>&nbsp;<span class="ident" id="5185060">prog</span><span class="op" id="5185064">.</span><span class="ident" id="5185065">Inst</span><span class="op" id="5185069">[</span><span class="ident" id="5185070">ip</span><span class="op" id="5185072">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185076">switch</span>&nbsp;<span class="ident" id="5185083">inst</span><span class="op" id="5185087">.</span><span class="ident" id="5185088">Op</span>&nbsp;<span class="op" id="5185091">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185095">case</span>&nbsp;<span class="ident" id="5185100">syntax</span><span class="op" id="5185106">.</span><span class="ident" id="5185107">InstAlt</span><span class="op" id="5185114">,</span>&nbsp;<span class="ident" id="5185116">syntax</span><span class="op" id="5185122">.</span><span class="ident" id="5185123">InstAltMatch</span><span class="op" id="5185135">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185140">for</span>&nbsp;<span class="ident" id="5185144">_</span><span class="op" id="5185145">,</span>&nbsp;<span class="ident" id="5185147">f</span>&nbsp;<span class="op" id="5185149">:=</span>&nbsp;<span class="keyword" id="5185152">range</span>&nbsp;<span class="ident" id="5185158">funcs</span>&nbsp;<span class="op" id="5185164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185170">f</span><span class="op" id="5185171">(</span><span class="ident" id="5185172">ip</span><span class="op" id="5185174">,</span>&nbsp;<span class="ident" id="5185176">inst</span><span class="op" id="5185180">.</span><span class="ident" id="5185181">Out</span><span class="op" id="5185184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185190">f</span><span class="op" id="5185191">(</span><span class="ident" id="5185192">ip</span><span class="op" id="5185194">,</span>&nbsp;<span class="ident" id="5185196">inst</span><span class="op" id="5185200">.</span><span class="ident" id="5185201">Arg</span><span class="op" id="5185204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185209">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185214">walk1</span><span class="op" id="5185219">(</span><span class="ident" id="5185220">inst</span><span class="op" id="5185224">.</span><span class="ident" id="5185225">Out</span><span class="op" id="5185228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185233">walk1</span><span class="op" id="5185238">(</span><span class="ident" id="5185239">inst</span><span class="op" id="5185243">.</span><span class="ident" id="5185244">Arg</span><span class="op" id="5185247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185251">default</span><span class="op" id="5185258">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185263">for</span>&nbsp;<span class="ident" id="5185267">_</span><span class="op" id="5185268">,</span>&nbsp;<span class="ident" id="5185270">f</span>&nbsp;<span class="op" id="5185272">:=</span>&nbsp;<span class="keyword" id="5185275">range</span>&nbsp;<span class="ident" id="5185281">funcs</span>&nbsp;<span class="op" id="5185287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185293">f</span><span class="op" id="5185294">(</span><span class="ident" id="5185295">ip</span><span class="op" id="5185297">,</span>&nbsp;<span class="ident" id="5185299">inst</span><span class="op" id="5185303">.</span><span class="ident" id="5185304">Out</span><span class="op" id="5185307">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185317">walk1</span><span class="op" id="5185322">(</span><span class="ident" id="5185323">inst</span><span class="op" id="5185327">.</span><span class="ident" id="5185328">Out</span><span class="op" id="5185331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185341">walk1</span><span class="op" id="5185346">(</span><span class="builtintype" id="5185347">uint32</span><span class="op" id="5185353">(</span><span class="ident" id="5185354">prog</span><span class="op" id="5185358">.</span><span class="ident" id="5185359">Start</span><span class="op" id="5185364">)</span><span class="op" id="5185365">)</span><br>
<span class="lineno">520</span><span class="op" id="5185367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5185370">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="5185439">func</span>&nbsp;<span class="ident" id="5185444">find</span><span class="op" id="5185448">(</span><span class="ident" id="5185449">prog</span>&nbsp;<span class="op" id="5185454">*</span><span class="ident" id="5185455">syntax</span><span class="op" id="5185461">.</span><span class="ident" id="5185462">Prog</span><span class="op" id="5185466">,</span>&nbsp;<span class="ident" id="5185468">f</span>&nbsp;<span class="keyword" id="5185470">func</span><span class="op" id="5185474">(</span><span class="op" id="5185475">*</span><span class="ident" id="5185476">syntax</span><span class="op" id="5185482">.</span><span class="ident" id="5185483">Prog</span><span class="op" id="5185487">,</span>&nbsp;<span class="builtintype" id="5185489">int</span><span class="op" id="5185492">)</span>&nbsp;<span class="builtintype" id="5185494">bool</span><span class="op" id="5185498">)</span>&nbsp;<span class="op" id="5185500">(</span><span class="ident" id="5185501">matches</span>&nbsp;<span class="op" id="5185509">[</span><span class="op" id="5185510">]</span><span class="builtintype" id="5185511">uint32</span><span class="op" id="5185517">)</span>&nbsp;<span class="op" id="5185519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185522">matches</span>&nbsp;<span class="op" id="5185530">=</span>&nbsp;<span class="op" id="5185532">[</span><span class="op" id="5185533">]</span><span class="builtintype" id="5185534">uint32</span><span class="op" id="5185540">{</span><span class="op" id="5185541">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185545">for</span>&nbsp;<span class="ident" id="5185549">ip</span>&nbsp;<span class="op" id="5185552">:=</span>&nbsp;<span class="keyword" id="5185555">range</span>&nbsp;<span class="ident" id="5185561">prog</span><span class="op" id="5185565">.</span><span class="ident" id="5185566">Inst</span>&nbsp;<span class="op" id="5185571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185575">if</span>&nbsp;<span class="ident" id="5185578">f</span><span class="op" id="5185579">(</span><span class="ident" id="5185580">prog</span><span class="op" id="5185584">,</span>&nbsp;<span class="ident" id="5185586">ip</span><span class="op" id="5185588">)</span>&nbsp;<span class="op" id="5185590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5185595">matches</span>&nbsp;<span class="op" id="5185603">=</span>&nbsp;<span class="builtinfunc" id="5185605">append</span><span class="op" id="5185611">(</span><span class="ident" id="5185612">matches</span><span class="op" id="5185619">,</span>&nbsp;<span class="builtintype" id="5185621">uint32</span><span class="op" id="5185627">(</span><span class="ident" id="5185628">ip</span><span class="op" id="5185630">)</span><span class="op" id="5185631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185635">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5185638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5185641">return</span><br>
<span class="lineno"></span><span class="op" id="5185648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5185651">var</span>&nbsp;<span class="ident" id="5185655">notOnePass</span>&nbsp;<span class="op" id="5185666">*</span><span class="ident" id="5185667">onePassProg</span>&nbsp;<span class="op" id="5185679">=</span>&nbsp;<span class="ident" id="5185681">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="5185686">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="5185783">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5185867">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="5185953">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="5186039">func</span>&nbsp;<span class="ident" id="5186044">compileOnePass</span><span class="op" id="5186058">(</span><span class="ident" id="5186059">prog</span>&nbsp;<span class="op" id="5186064">*</span><span class="ident" id="5186065">syntax</span><span class="op" id="5186071">.</span><span class="ident" id="5186072">Prog</span><span class="op" id="5186076">)</span>&nbsp;<span class="op" id="5186078">(</span><span class="ident" id="5186079">p</span>&nbsp;<span class="op" id="5186081">*</span><span class="ident" id="5186082">onePassProg</span><span class="op" id="5186093">)</span>&nbsp;<span class="op" id="5186095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186098">if</span>&nbsp;<span class="ident" id="5186101">prog</span><span class="op" id="5186105">.</span><span class="ident" id="5186106">Start</span>&nbsp;<span class="op" id="5186112">==</span>&nbsp;<span class="num" id="5186115">0</span>&nbsp;<span class="op" id="5186117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186121">return</span>&nbsp;<span class="ident" id="5186128">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5186140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5186143">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186174">if</span>&nbsp;<span class="ident" id="5186177">prog</span><span class="op" id="5186181">.</span><span class="ident" id="5186182">Inst</span><span class="op" id="5186186">[</span><span class="ident" id="5186187">prog</span><span class="op" id="5186191">.</span><span class="ident" id="5186192">Start</span><span class="op" id="5186197">]</span><span class="op" id="5186198">.</span><span class="ident" id="5186199">Op</span>&nbsp;<span class="op" id="5186202">!=</span>&nbsp;<span class="ident" id="5186205">syntax</span><span class="op" id="5186211">.</span><span class="ident" id="5186212">InstEmptyWidth</span>&nbsp;<span class="op" id="5186227">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186232">syntax</span><span class="op" id="5186238">.</span><span class="ident" id="5186239">EmptyOp</span><span class="op" id="5186246">(</span><span class="ident" id="5186247">prog</span><span class="op" id="5186251">.</span><span class="ident" id="5186252">Inst</span><span class="op" id="5186256">[</span><span class="ident" id="5186257">prog</span><span class="op" id="5186261">.</span><span class="ident" id="5186262">Start</span><span class="op" id="5186267">]</span><span class="op" id="5186268">.</span><span class="ident" id="5186269">Arg</span><span class="op" id="5186272">)</span><span class="op" id="5186273">&amp;</span><span class="ident" id="5186274">syntax</span><span class="op" id="5186280">.</span><span class="ident" id="5186281">EmptyBeginText</span>&nbsp;<span class="op" id="5186296">!=</span>&nbsp;<span class="ident" id="5186299">syntax</span><span class="op" id="5186305">.</span><span class="ident" id="5186306">EmptyBeginText</span>&nbsp;<span class="op" id="5186321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186325">return</span>&nbsp;<span class="ident" id="5186332">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5186344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5186347">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186411">for</span>&nbsp;<span class="ident" id="5186415">_</span><span class="op" id="5186416">,</span>&nbsp;<span class="ident" id="5186418">inst</span>&nbsp;<span class="op" id="5186423">:=</span>&nbsp;<span class="keyword" id="5186426">range</span>&nbsp;<span class="ident" id="5186432">prog</span><span class="op" id="5186436">.</span><span class="ident" id="5186437">Inst</span>&nbsp;<span class="op" id="5186442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5186446">opOut</span>&nbsp;<span class="op" id="5186452">:=</span>&nbsp;<span class="ident" id="5186455">prog</span><span class="op" id="5186459">.</span><span class="ident" id="5186460">Inst</span><span class="op" id="5186464">[</span><span class="ident" id="5186465">inst</span><span class="op" id="5186469">.</span><span class="ident" id="5186470">Out</span><span class="op" id="5186473">]</span><span class="op" id="5186474">.</span><span class="ident" id="5186475">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186480">switch</span>&nbsp;<span class="ident" id="5186487">inst</span><span class="op" id="5186491">.</span><span class="ident" id="5186492">Op</span>&nbsp;<span class="op" id="5186495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186499">default</span><span class="op" id="5186506">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186511">if</span>&nbsp;<span class="ident" id="5186514">opOut</span>&nbsp;<span class="op" id="5186520">==</span>&nbsp;<span class="ident" id="5186523">syntax</span><span class="op" id="5186529">.</span><span class="ident" id="5186530">InstMatch</span>&nbsp;<span class="op" id="5186540">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186546">return</span>&nbsp;<span class="ident" id="5186553">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5186567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186571">case</span>&nbsp;<span class="ident" id="5186576">syntax</span><span class="op" id="5186582">.</span><span class="ident" id="5186583">InstAlt</span><span class="op" id="5186590">,</span>&nbsp;<span class="ident" id="5186592">syntax</span><span class="op" id="5186598">.</span><span class="ident" id="5186599">InstAltMatch</span><span class="op" id="5186611">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186616">if</span>&nbsp;<span class="ident" id="5186619">opOut</span>&nbsp;<span class="op" id="5186625">==</span>&nbsp;<span class="ident" id="5186628">syntax</span><span class="op" id="5186634">.</span><span class="ident" id="5186635">InstMatch</span>&nbsp;<span class="op" id="5186645">||</span>&nbsp;<span class="ident" id="5186648">prog</span><span class="op" id="5186652">.</span><span class="ident" id="5186653">Inst</span><span class="op" id="5186657">[</span><span class="ident" id="5186658">inst</span><span class="op" id="5186662">.</span><span class="ident" id="5186663">Arg</span><span class="op" id="5186666">]</span><span class="op" id="5186667">.</span><span class="ident" id="5186668">Op</span>&nbsp;<span class="op" id="5186671">==</span>&nbsp;<span class="ident" id="5186674">syntax</span><span class="op" id="5186680">.</span><span class="ident" id="5186681">InstMatch</span>&nbsp;<span class="op" id="5186691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186697">return</span>&nbsp;<span class="ident" id="5186704">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5186718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186722">case</span>&nbsp;<span class="ident" id="5186727">syntax</span><span class="op" id="5186733">.</span><span class="ident" id="5186734">InstEmptyWidth</span><span class="op" id="5186748">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186753">if</span>&nbsp;<span class="ident" id="5186756">opOut</span>&nbsp;<span class="op" id="5186762">==</span>&nbsp;<span class="ident" id="5186765">syntax</span><span class="op" id="5186771">.</span><span class="ident" id="5186772">InstMatch</span>&nbsp;<span class="op" id="5186782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186788">if</span>&nbsp;<span class="ident" id="5186791">syntax</span><span class="op" id="5186797">.</span><span class="ident" id="5186798">EmptyOp</span><span class="op" id="5186805">(</span><span class="ident" id="5186806">inst</span><span class="op" id="5186810">.</span><span class="ident" id="5186811">Arg</span><span class="op" id="5186814">)</span><span class="op" id="5186815">&amp;</span><span class="ident" id="5186816">syntax</span><span class="op" id="5186822">.</span><span class="ident" id="5186823">EmptyEndText</span>&nbsp;<span class="op" id="5186836">==</span>&nbsp;<span class="ident" id="5186839">syntax</span><span class="op" id="5186845">.</span><span class="ident" id="5186846">EmptyEndText</span>&nbsp;<span class="op" id="5186859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186866">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5186879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5186885">return</span>&nbsp;<span class="ident" id="5186892">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5186906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5186910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5186913">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5186916">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5186975">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5187045">p</span>&nbsp;<span class="op" id="5187047">=</span>&nbsp;<span class="ident" id="5187049">onePassCopy</span><span class="op" id="5187060">(</span><span class="ident" id="5187061">prog</span><span class="op" id="5187065">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5187069">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5187132">p</span>&nbsp;<span class="op" id="5187134">=</span>&nbsp;<span class="ident" id="5187136">makeOnePass</span><span class="op" id="5187147">(</span><span class="ident" id="5187148">p</span><span class="op" id="5187149">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5187153">if</span>&nbsp;<span class="ident" id="5187156">p</span>&nbsp;<span class="op" id="5187158">!=</span>&nbsp;<span class="ident" id="5187161">notOnePass</span>&nbsp;<span class="op" id="5187172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5187176">cleanupOnePass</span><span class="op" id="5187190">(</span><span class="ident" id="5187191">p</span><span class="op" id="5187192">,</span>&nbsp;<span class="ident" id="5187194">prog</span><span class="op" id="5187198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5187201">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5187204">return</span>&nbsp;<span class="ident" id="5187211">p</span><br>
<span class="lineno"></span><span class="op" id="5187213">}</span>
</div>
</body>
</html>
