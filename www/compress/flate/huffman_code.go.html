<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sort&#34;</span><br>
<span class="lineno">10</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">huffmanEncoder</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codeBits</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">uint16</span><br>
<span class="lineno">15</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">literalNode</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">literal</span>&nbsp;<span class="builtintype">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">freq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int32</span><br>
<span class="lineno">20</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;levelInfo&nbsp;describes&nbsp;the&nbsp;state&nbsp;of&nbsp;the&nbsp;constructed&nbsp;tree&nbsp;for&nbsp;a&nbsp;given&nbsp;depth.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">levelInfo</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Our&nbsp;level.&nbsp;&nbsp;for&nbsp;better&nbsp;printing</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">level</span>&nbsp;<span class="builtintype">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;frequency&nbsp;of&nbsp;the&nbsp;last&nbsp;node&nbsp;at&nbsp;this&nbsp;level</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lastFreq</span>&nbsp;<span class="builtintype">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;frequency&nbsp;of&nbsp;the&nbsp;next&nbsp;character&nbsp;to&nbsp;add&nbsp;to&nbsp;this&nbsp;level</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nextCharFreq</span>&nbsp;<span class="builtintype">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;frequency&nbsp;of&nbsp;the&nbsp;next&nbsp;pair&nbsp;(from&nbsp;level&nbsp;below)&nbsp;to&nbsp;add&nbsp;to&nbsp;this&nbsp;level.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Only&nbsp;valid&nbsp;if&nbsp;the&nbsp;&#34;needed&#34;&nbsp;value&nbsp;of&nbsp;the&nbsp;next&nbsp;lower&nbsp;level&nbsp;is&nbsp;0.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nextPairFreq</span>&nbsp;<span class="builtintype">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;number&nbsp;of&nbsp;chains&nbsp;remaining&nbsp;to&nbsp;generate&nbsp;for&nbsp;this&nbsp;level&nbsp;before&nbsp;moving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;up&nbsp;to&nbsp;the&nbsp;next&nbsp;level</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">needed</span>&nbsp;<span class="builtintype">int32</span><br>
<span class="lineno">40</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">maxNode</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">literalNode</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">literalNode</span><span class="op">{</span><span class="ident">math</span><span class="op">.</span><span class="ident">MaxUint16</span><span class="op">,</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxInt32</span><span class="op">}</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newHuffmanEncoder</span><span class="op">(</span><span class="ident">size</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">huffmanEncoder</span><span class="op">{</span><span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint8</span><span class="op">,</span>&nbsp;<span class="ident">size</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint16</span><span class="op">,</span>&nbsp;<span class="ident">size</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Generates&nbsp;a&nbsp;HuffmanCode&nbsp;corresponding&nbsp;to&nbsp;the&nbsp;fixed&nbsp;literal&nbsp;table</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">generateFixedLiteralEncoding</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newHuffmanEncoder</span><span class="op">(</span><span class="ident">maxLit</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codeBits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">h</span><span class="op">.</span><span class="ident">codeBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">h</span><span class="op">.</span><span class="ident">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="builtintype">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">maxLit</span><span class="op">;</span>&nbsp;<span class="ident">ch</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">bits</span>&nbsp;<span class="builtintype">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="builtintype">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">144</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;size&nbsp;8,&nbsp;000110000&nbsp;&nbsp;..&nbsp;10111111</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">48</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">256</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;size&nbsp;9,&nbsp;110010000&nbsp;..&nbsp;111111111</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">400</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">144</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">280</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;size&nbsp;7,&nbsp;0000000&nbsp;..&nbsp;0010111</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;size&nbsp;8,&nbsp;11000000&nbsp;..&nbsp;11000111</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">192</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">280</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">size</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codeBits</span><span class="op">[</span><span class="ident">ch</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span><span class="op">[</span><span class="ident">ch</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reverseBits</span><span class="op">(</span><span class="ident">bits</span><span class="op">,</span>&nbsp;<span class="ident">size</span><span class="op">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">h</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">generateFixedOffsetEncoding</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newHuffmanEncoder</span><span class="op">(</span><span class="num">30</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codeBits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">h</span><span class="op">.</span><span class="ident">codeBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">h</span><span class="op">.</span><span class="ident">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint16</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">30</span><span class="op">;</span>&nbsp;<span class="ident">ch</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">codeBits</span><span class="op">[</span><span class="ident">ch</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">5</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span><span class="op">[</span><span class="ident">ch</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reverseBits</span><span class="op">(</span><span class="ident">ch</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">h</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword">var</span>&nbsp;<span class="ident">fixedLiteralEncoding</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">generateFixedLiteralEncoding</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">fixedOffsetEncoding</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">generateFixedOffsetEncoding</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">h</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span><span class="op">)</span>&nbsp;<span class="ident">bitLength</span><span class="op">(</span><span class="ident">freq</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><span class="op">)</span>&nbsp;<span class="ident">int64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">total</span>&nbsp;<span class="ident">int64</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">freq</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">total</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">int64</span><span class="op">(</span><span class="ident">h</span><span class="op">.</span><span class="ident">codeBits</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">total</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">maxBitsLimit</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">16</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment">//&nbsp;Return&nbsp;the&nbsp;number&nbsp;of&nbsp;literals&nbsp;assigned&nbsp;to&nbsp;each&nbsp;bit&nbsp;size&nbsp;in&nbsp;the&nbsp;Huffman&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;method&nbsp;is&nbsp;only&nbsp;called&nbsp;when&nbsp;list.length&nbsp;&gt;=&nbsp;3</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;cases&nbsp;of&nbsp;0,&nbsp;1,&nbsp;and&nbsp;2&nbsp;literals&nbsp;are&nbsp;handled&nbsp;by&nbsp;special&nbsp;case&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">115</span><span class="comment">//&nbsp;list&nbsp;&nbsp;An&nbsp;array&nbsp;of&nbsp;the&nbsp;literals&nbsp;with&nbsp;non-zero&nbsp;frequencies</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;their&nbsp;associated&nbsp;frequencies.&nbsp;&nbsp;The&nbsp;array&nbsp;is&nbsp;in&nbsp;order&nbsp;of&nbsp;increasing</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;frequency,&nbsp;and&nbsp;has&nbsp;as&nbsp;its&nbsp;last&nbsp;element&nbsp;a&nbsp;special&nbsp;element&nbsp;with&nbsp;frequency</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MaxInt32</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;maxBits&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;bits&nbsp;that&nbsp;should&nbsp;be&nbsp;used&nbsp;to&nbsp;encode&nbsp;any&nbsp;literal.</span><br>
<span class="lineno">120</span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Must&nbsp;be&nbsp;less&nbsp;than&nbsp;16.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;return&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;An&nbsp;integer&nbsp;array&nbsp;in&nbsp;which&nbsp;array[i]&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;literals</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;should&nbsp;be&nbsp;encoded&nbsp;in&nbsp;i&nbsp;bits.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">h</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span><span class="op">)</span>&nbsp;<span class="ident">bitCounts</span><span class="op">(</span><span class="ident">list</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">literalNode</span><span class="op">,</span>&nbsp;<span class="ident">maxBits</span>&nbsp;<span class="builtintype">int32</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">maxBits</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">maxBitsLimit</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;flate:&nbsp;maxBits&nbsp;too&nbsp;large&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">list</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">list</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">list</span><span class="op">[</span><span class="num">0</span>&nbsp;<span class="op">:</span>&nbsp;<span class="ident">n</span><span class="op">+</span><span class="num">1</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">list</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">maxNode</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;tree&nbsp;can&#39;t&nbsp;have&nbsp;greater&nbsp;depth&nbsp;than&nbsp;n&nbsp;-&nbsp;1,&nbsp;no&nbsp;matter&nbsp;what.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;saves&nbsp;a&nbsp;little&nbsp;bit&nbsp;of&nbsp;work&nbsp;in&nbsp;some&nbsp;small&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">maxBits</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">n</span><span class="op">-</span><span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">maxBits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Create&nbsp;information&nbsp;about&nbsp;each&nbsp;of&nbsp;the&nbsp;levels.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;A&nbsp;bogus&nbsp;&#34;Level&nbsp;0&#34;&nbsp;whose&nbsp;sole&nbsp;purpose&nbsp;is&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;level1.prev.needed==0.&nbsp;&nbsp;This&nbsp;makes&nbsp;level1.nextPairFreq</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;be&nbsp;a&nbsp;legitimate&nbsp;value&nbsp;that&nbsp;never&nbsp;gets&nbsp;chosen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">levels</span>&nbsp;<span class="op">[</span><span class="ident">maxBitsLimit</span><span class="op">]</span><span class="ident">levelInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;leafCounts[i]&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;literals&nbsp;at&nbsp;the&nbsp;left</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;of&nbsp;ancestors&nbsp;of&nbsp;the&nbsp;rightmost&nbsp;node&nbsp;at&nbsp;level&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;leafCounts[i][j]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;literals&nbsp;at&nbsp;the&nbsp;left</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;of&nbsp;the&nbsp;level&nbsp;j&nbsp;ancestor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">leafCounts</span>&nbsp;<span class="op">[</span><span class="ident">maxBitsLimit</span><span class="op">]</span><span class="op">[</span><span class="ident">maxBitsLimit</span><span class="op">]</span><span class="builtintype">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">level</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int32</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">level</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">maxBits</span><span class="op">;</span>&nbsp;<span class="ident">level</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;every&nbsp;level,&nbsp;the&nbsp;first&nbsp;two&nbsp;items&nbsp;are&nbsp;the&nbsp;first&nbsp;two&nbsp;characters.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;initialize&nbsp;the&nbsp;levels&nbsp;as&nbsp;if&nbsp;we&nbsp;had&nbsp;already&nbsp;figured&nbsp;this&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">levels</span><span class="op">[</span><span class="ident">level</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">levelInfo</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">level</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">level</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lastFreq</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">list</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="ident">freq</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nextCharFreq</span><span class="op">:</span>&nbsp;<span class="ident">list</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><span class="op">.</span><span class="ident">freq</span><span class="op">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nextPairFreq</span><span class="op">:</span>&nbsp;<span class="ident">list</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="ident">freq</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">list</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="ident">freq</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">leafCounts</span><span class="op">[</span><span class="ident">level</span><span class="op">]</span><span class="op">[</span><span class="ident">level</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">level</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">levels</span><span class="op">[</span><span class="ident">level</span><span class="op">]</span><span class="op">.</span><span class="ident">nextPairFreq</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxInt32</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;need&nbsp;a&nbsp;total&nbsp;of&nbsp;2*n&nbsp;-&nbsp;2&nbsp;items&nbsp;at&nbsp;top&nbsp;level&nbsp;and&nbsp;have&nbsp;already&nbsp;generated&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">levels</span><span class="op">[</span><span class="ident">maxBits</span><span class="op">]</span><span class="op">.</span><span class="ident">needed</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span><span class="op">*</span><span class="ident">n</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">4</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">level</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">maxBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">levels</span><span class="op">[</span><span class="ident">level</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">nextPairFreq</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxInt32</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">nextCharFreq</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxInt32</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;both&nbsp;leafs&nbsp;and&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;End&nbsp;all&nbsp;calculations&nbsp;for&nbsp;this&nbsp;level.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;To&nbsp;make&nbsp;sure&nbsp;we&nbsp;never&nbsp;come&nbsp;back&nbsp;to&nbsp;this&nbsp;level&nbsp;or&nbsp;any&nbsp;lower&nbsp;level,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;set&nbsp;nextPairFreq&nbsp;impossibly&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">needed</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">levels</span><span class="op">[</span><span class="ident">level</span><span class="op">+</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="ident">nextPairFreq</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">level</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prevFreq</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">lastFreq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">nextCharFreq</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">nextPairFreq</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;next&nbsp;item&nbsp;on&nbsp;this&nbsp;row&nbsp;is&nbsp;a&nbsp;leaf&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">leafCounts</span><span class="op">[</span><span class="ident">level</span><span class="op">]</span><span class="op">[</span><span class="ident">level</span><span class="op">]</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">lastFreq</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">nextCharFreq</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Lower&nbsp;leafCounts&nbsp;are&nbsp;the&nbsp;same&nbsp;of&nbsp;the&nbsp;previous&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">leafCounts</span><span class="op">[</span><span class="ident">level</span><span class="op">]</span><span class="op">[</span><span class="ident">level</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">nextCharFreq</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">list</span><span class="op">[</span><span class="ident">n</span><span class="op">]</span><span class="op">.</span><span class="ident">freq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;next&nbsp;item&nbsp;on&nbsp;this&nbsp;row&nbsp;is&nbsp;a&nbsp;pair&nbsp;from&nbsp;the&nbsp;previous&nbsp;row.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;nextPairFreq&nbsp;isn&#39;t&nbsp;valid&nbsp;until&nbsp;we&nbsp;generate&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;more&nbsp;values&nbsp;in&nbsp;the&nbsp;level&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="ident">lastFreq</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">nextPairFreq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Take&nbsp;leaf&nbsp;counts&nbsp;from&nbsp;the&nbsp;lower&nbsp;level,&nbsp;except&nbsp;counts[level]&nbsp;remains&nbsp;the&nbsp;same.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">leafCounts</span><span class="op">[</span><span class="ident">level</span><span class="op">]</span><span class="op">[</span><span class="op">:</span><span class="ident">level</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">leafCounts</span><span class="op">[</span><span class="ident">level</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">[</span><span class="op">:</span><span class="ident">level</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">levels</span><span class="op">[</span><span class="ident">l</span><span class="op">.</span><span class="ident">level</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="ident">needed</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">needed</span><span class="op">--</span><span class="op">;</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">needed</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&#39;ve&nbsp;done&nbsp;everything&nbsp;we&nbsp;need&nbsp;to&nbsp;do&nbsp;for&nbsp;this&nbsp;level.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Continue&nbsp;calculating&nbsp;one&nbsp;level&nbsp;up.&nbsp;&nbsp;Fill&nbsp;in&nbsp;nextPairFreq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;of&nbsp;that&nbsp;level&nbsp;with&nbsp;the&nbsp;sum&nbsp;of&nbsp;the&nbsp;two&nbsp;nodes&nbsp;we&#39;ve&nbsp;just&nbsp;calculated&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;this&nbsp;level.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">level</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">maxBits</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;All&nbsp;done!</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">levels</span><span class="op">[</span><span class="ident">l</span><span class="op">.</span><span class="ident">level</span><span class="op">+</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="ident">nextPairFreq</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">prevFreq</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">lastFreq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">level</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;we&nbsp;stole&nbsp;from&nbsp;below,&nbsp;move&nbsp;down&nbsp;temporarily&nbsp;to&nbsp;replenish&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">levels</span><span class="op">[</span><span class="ident">level</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><span class="op">.</span><span class="ident">needed</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">level</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Somethings&nbsp;is&nbsp;wrong&nbsp;if&nbsp;at&nbsp;the&nbsp;end,&nbsp;the&nbsp;top&nbsp;level&nbsp;is&nbsp;null&nbsp;or&nbsp;hasn&#39;t&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;all&nbsp;of&nbsp;the&nbsp;leaves.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">leafCounts</span><span class="op">[</span><span class="ident">maxBits</span><span class="op">]</span><span class="op">[</span><span class="ident">maxBits</span><span class="op">]</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;leafCounts[maxBits][maxBits]&nbsp;!=&nbsp;n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bitCount</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><span class="op">,</span>&nbsp;<span class="ident">maxBits</span><span class="op">+</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">counts</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">leafCounts</span><span class="op">[</span><span class="ident">maxBits</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">level</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">maxBits</span><span class="op">;</span>&nbsp;<span class="ident">level</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">level</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;chain.leafCount&nbsp;gives&nbsp;the&nbsp;number&nbsp;of&nbsp;literals&nbsp;requiring&nbsp;at&nbsp;least&nbsp;&#34;bits&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;bits&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bitCount</span><span class="op">[</span><span class="ident">bits</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">counts</span><span class="op">[</span><span class="ident">level</span><span class="op">]</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">counts</span><span class="op">[</span><span class="ident">level</span><span class="op">-</span><span class="num">1</span><span class="op">]</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">bitCount</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span><span class="comment">//&nbsp;Look&nbsp;at&nbsp;the&nbsp;leaves&nbsp;and&nbsp;assign&nbsp;them&nbsp;a&nbsp;bit&nbsp;count&nbsp;and&nbsp;an&nbsp;encoding&nbsp;as&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;in&nbsp;RFC&nbsp;1951&nbsp;3.2.2</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">h</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span><span class="op">)</span>&nbsp;<span class="ident">assignEncodingAndSize</span><span class="op">(</span><span class="ident">bitCount</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><span class="op">,</span>&nbsp;<span class="ident">list</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">literalNode</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint16</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">bits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">bitCount</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">bits</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;literals&nbsp;list[len(list)-bits]&nbsp;..&nbsp;list[len(list)-bits]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;are&nbsp;encoded&nbsp;using&nbsp;&#34;bits&#34;&nbsp;bits,&nbsp;and&nbsp;get&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;code,&nbsp;code&nbsp;+&nbsp;1,&nbsp;....&nbsp;&nbsp;The&nbsp;code&nbsp;values&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;assigned&nbsp;in&nbsp;literal&nbsp;order&nbsp;(not&nbsp;frequency&nbsp;order).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">chunk</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">list</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">list</span><span class="op">)</span><span class="op">-</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">bits</span><span class="op">)</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sortByLiteral</span><span class="op">(</span><span class="ident">chunk</span><span class="op">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">node</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">chunk</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">codeBits</span><span class="op">[</span><span class="ident">node</span><span class="op">.</span><span class="ident">literal</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">code</span><span class="op">[</span><span class="ident">node</span><span class="op">.</span><span class="ident">literal</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reverseBits</span><span class="op">(</span><span class="ident">code</span><span class="op">,</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">list</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">list</span><span class="op">[</span><span class="num">0</span>&nbsp;<span class="op">:</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">list</span><span class="op">)</span><span class="op">-</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">bits</span><span class="op">)</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Update&nbsp;this&nbsp;Huffman&nbsp;Code&nbsp;object&nbsp;to&nbsp;be&nbsp;the&nbsp;minimum&nbsp;code&nbsp;for&nbsp;the&nbsp;specified&nbsp;frequency&nbsp;count.</span><br>
<span class="lineno">260</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;freq&nbsp;&nbsp;An&nbsp;array&nbsp;of&nbsp;frequencies,&nbsp;in&nbsp;which&nbsp;frequency[i]&nbsp;gives&nbsp;the&nbsp;frequency&nbsp;of&nbsp;literal&nbsp;i.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;maxBits&nbsp;&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;any&nbsp;literal.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">h</span>&nbsp;<span class="op">*</span><span class="ident">huffmanEncoder</span><span class="op">)</span>&nbsp;<span class="ident">generate</span><span class="op">(</span><span class="ident">freq</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><span class="op">,</span>&nbsp;<span class="ident">maxBits</span>&nbsp;<span class="builtintype">int32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">list</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">literalNode</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">freq</span><span class="op">)</span><span class="op">+</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Number&nbsp;of&nbsp;non-zero&nbsp;literals</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Set&nbsp;list&nbsp;to&nbsp;be&nbsp;the&nbsp;set&nbsp;of&nbsp;all&nbsp;non-zero&nbsp;literals&nbsp;and&nbsp;their&nbsp;frequencies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">freq</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">list</span><span class="op">[</span><span class="ident">count</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">literalNode</span><span class="op">{</span><span class="builtintype">uint16</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">count</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">codeBits</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;freq[]&nbsp;is&nbsp;shorter&nbsp;than&nbsp;codeBits[],&nbsp;fill&nbsp;rest&nbsp;of&nbsp;codeBits[]&nbsp;with&nbsp;zeros</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">codeBits</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">h</span><span class="op">.</span><span class="ident">codeBits</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">freq</span><span class="op">)</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">list</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">list</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">count</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">count</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Handle&nbsp;the&nbsp;small&nbsp;cases&nbsp;here,&nbsp;because&nbsp;they&nbsp;are&nbsp;awkward&nbsp;for&nbsp;the&nbsp;general&nbsp;case&nbsp;code.&nbsp;&nbsp;With</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;two&nbsp;or&nbsp;fewer&nbsp;literals,&nbsp;everything&nbsp;has&nbsp;bit&nbsp;length&nbsp;1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">node</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">list</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;list&#34;&nbsp;is&nbsp;in&nbsp;order&nbsp;of&nbsp;increasing&nbsp;literal&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">codeBits</span><span class="op">[</span><span class="ident">node</span><span class="op">.</span><span class="ident">literal</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">code</span><span class="op">[</span><span class="ident">node</span><span class="op">.</span><span class="ident">literal</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint16</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sortByFreq</span><span class="op">(</span><span class="ident">list</span><span class="op">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Get&nbsp;the&nbsp;number&nbsp;of&nbsp;literals&nbsp;for&nbsp;each&nbsp;bit&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bitCount</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">h</span><span class="op">.</span><span class="ident">bitCounts</span><span class="op">(</span><span class="ident">list</span><span class="op">,</span>&nbsp;<span class="ident">maxBits</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;And&nbsp;do&nbsp;the&nbsp;assignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">h</span><span class="op">.</span><span class="ident">assignEncodingAndSize</span><span class="op">(</span><span class="ident">bitCount</span><span class="op">,</span>&nbsp;<span class="ident">list</span><span class="op">)</span><br>
<span class="lineno">295</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">literalNodeSorter</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">literalNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">less</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno">300</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="ident">literalNodeSorter</span><span class="op">)</span>&nbsp;<span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">.</span><span class="ident">a</span><span class="op">)</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="ident">literalNodeSorter</span><span class="op">)</span>&nbsp;<span class="ident">Less</span><span class="op">(</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">less</span><span class="op">(</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">j</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="ident">literalNodeSorter</span><span class="op">)</span>&nbsp;<span class="ident">Swap</span><span class="op">(</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">a</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">a</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">a</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">a</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword">func</span>&nbsp;<span class="ident">sortByFreq</span><span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">literalNode</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">literalNodeSorter</span><span class="op">{</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">a</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">freq</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">a</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span><span class="op">.</span><span class="ident">freq</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">a</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">literal</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">a</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span><span class="op">.</span><span class="ident">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">a</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">freq</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">a</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span><span class="op">.</span><span class="ident">freq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sort</span><span class="op">.</span><span class="ident">Sort</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="keyword">func</span>&nbsp;<span class="ident">sortByLiteral</span><span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">literalNode</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">literalNodeSorter</span><span class="op">{</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">a</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">literal</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">a</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span><span class="op">.</span><span class="ident">literal</span>&nbsp;<span class="op">}</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sort</span><span class="op">.</span><span class="ident">Sort</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
