<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;MakeFunc&nbsp;implementation.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">reflect</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;makeFuncImpl&nbsp;is&nbsp;the&nbsp;closure&nbsp;value&nbsp;implementing&nbsp;the&nbsp;function</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;returned&nbsp;by&nbsp;MakeFunc.</span><br>
<span class="lineno">15</span><span class="keyword">type</span>&nbsp;<span class="ident">makeFuncImpl</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span>&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stack</span>&nbsp;<span class="op">*</span><span class="ident">bitVector</span>&nbsp;<span class="comment">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">funcType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">Value</span><br>
<span class="lineno">20</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;MakeFunc&nbsp;returns&nbsp;a&nbsp;new&nbsp;function&nbsp;of&nbsp;the&nbsp;given&nbsp;Type</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;that&nbsp;wraps&nbsp;the&nbsp;function&nbsp;fn.&nbsp;When&nbsp;called,&nbsp;that&nbsp;new&nbsp;function</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;does&nbsp;the&nbsp;following:</span><br>
<span class="lineno">25</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;converts&nbsp;its&nbsp;arguments&nbsp;to&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;runs&nbsp;results&nbsp;:=&nbsp;fn(args).</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;returns&nbsp;the&nbsp;results&nbsp;as&nbsp;a&nbsp;slice&nbsp;of&nbsp;Values,&nbsp;one&nbsp;per&nbsp;formal&nbsp;result.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">30</span><span class="comment">//&nbsp;The&nbsp;implementation&nbsp;fn&nbsp;can&nbsp;assume&nbsp;that&nbsp;the&nbsp;argument&nbsp;Value&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;has&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;arguments&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;typ&nbsp;describes&nbsp;a&nbsp;variadic&nbsp;function,&nbsp;the&nbsp;final&nbsp;Value&nbsp;is&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;a&nbsp;slice&nbsp;representing&nbsp;the&nbsp;variadic&nbsp;arguments,&nbsp;as&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;body&nbsp;of&nbsp;a&nbsp;variadic&nbsp;function.&nbsp;The&nbsp;result&nbsp;Value&nbsp;slice&nbsp;returned&nbsp;by&nbsp;fn</span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;must&nbsp;have&nbsp;the&nbsp;number&nbsp;and&nbsp;type&nbsp;of&nbsp;results&nbsp;given&nbsp;by&nbsp;typ.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;Value.Call&nbsp;method&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;invoke&nbsp;a&nbsp;typed&nbsp;function</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values;&nbsp;in&nbsp;contrast,&nbsp;MakeFunc&nbsp;allows&nbsp;the&nbsp;caller&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;a&nbsp;typed&nbsp;function&nbsp;in&nbsp;terms&nbsp;of&nbsp;Values.</span><br>
<span class="lineno">40</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;Examples&nbsp;section&nbsp;of&nbsp;the&nbsp;documentation&nbsp;includes&nbsp;an&nbsp;illustration</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;how&nbsp;to&nbsp;use&nbsp;MakeFunc&nbsp;to&nbsp;build&nbsp;a&nbsp;swap&nbsp;function&nbsp;for&nbsp;different&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">MakeFunc</span><span class="op">(</span><span class="ident">typ</span>&nbsp;<span class="ident">Type</span><span class="op">,</span>&nbsp;<span class="ident">fn</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">args</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">results</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">Value</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="ident">Value</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">Func</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;reflect:&nbsp;call&nbsp;of&nbsp;MakeFunc&nbsp;with&nbsp;non-Func&nbsp;type&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">common</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ftyp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">funcType</span><span class="op">)</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="ident">t</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dummy</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">makeFuncStub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">*</span><span class="op">*</span><span class="op">(</span><span class="op">*</span><span class="op">*</span><span class="builtintype">uintptr</span><span class="op">)</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">dummy</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;makeFuncImpl&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">stack</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">funcLayout</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">impl</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">makeFuncImpl</span><span class="op">{</span><span class="ident">code</span><span class="op">:</span>&nbsp;<span class="ident">code</span><span class="op">,</span>&nbsp;<span class="ident">stack</span><span class="op">:</span>&nbsp;<span class="ident">stack</span><span class="op">,</span>&nbsp;<span class="ident">typ</span><span class="op">:</span>&nbsp;<span class="ident">ftyp</span><span class="op">,</span>&nbsp;<span class="ident">fn</span><span class="op">:</span>&nbsp;<span class="ident">fn</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">Value</span><span class="op">{</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="ident">impl</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">flag</span><span class="op">(</span><span class="ident">Func</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;makeFuncStub&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;MakeFunc.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*callReflectFunc</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callReflect(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno">70</span><span class="comment">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">makeFuncStub</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">methodValue</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stack</span>&nbsp;&nbsp;<span class="op">*</span><span class="ident">bitVector</span>&nbsp;<span class="comment">//&nbsp;stack&nbsp;bitmap&nbsp;for&nbsp;args&nbsp;-&nbsp;offset&nbsp;known&nbsp;to&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">method</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident">Value</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment">//&nbsp;makeMethodValue&nbsp;converts&nbsp;v&nbsp;from&nbsp;the&nbsp;rcvr+method&nbsp;index&nbsp;representation</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;a&nbsp;method&nbsp;value&nbsp;to&nbsp;an&nbsp;actual&nbsp;method&nbsp;func&nbsp;value,&nbsp;which&nbsp;is</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;basically&nbsp;the&nbsp;receiver&nbsp;value&nbsp;with&nbsp;a&nbsp;special&nbsp;bit&nbsp;set,&nbsp;into&nbsp;a&nbsp;true</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;func&nbsp;value&nbsp;-&nbsp;a&nbsp;value&nbsp;holding&nbsp;an&nbsp;actual&nbsp;func.&nbsp;The&nbsp;output&nbsp;is</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;input&nbsp;as&nbsp;far&nbsp;as&nbsp;the&nbsp;user&nbsp;of&nbsp;package</span><br>
<span class="lineno">85</span><span class="comment">//&nbsp;reflect&nbsp;can&nbsp;tell,&nbsp;but&nbsp;the&nbsp;true&nbsp;func&nbsp;representation&nbsp;can&nbsp;be&nbsp;handled</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;by&nbsp;code&nbsp;like&nbsp;Convert&nbsp;and&nbsp;Interface&nbsp;and&nbsp;Assign.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">makeMethodValue</span><span class="op">(</span><span class="ident">op</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="ident">Value</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">flag</span><span class="op">&amp;</span><span class="ident">flagMethod</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;reflect:&nbsp;internal&nbsp;error:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;makeMethodValue&#34;</span><span class="op">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Ignoring&nbsp;the&nbsp;flagMethod&nbsp;bit,&nbsp;v&nbsp;describes&nbsp;the&nbsp;receiver,&nbsp;not&nbsp;the&nbsp;method&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fl</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">flag</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="op">(</span><span class="ident">flagRO</span>&nbsp;<span class="op">|</span>&nbsp;<span class="ident">flagAddr</span>&nbsp;<span class="op">|</span>&nbsp;<span class="ident">flagIndir</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fl</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="ident">flag</span><span class="op">(</span><span class="ident">v</span><span class="op">.</span><span class="ident">typ</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rcvr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Value</span><span class="op">{</span><span class="ident">v</span><span class="op">.</span><span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">ptr</span><span class="op">,</span>&nbsp;<span class="ident">fl</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;v.Type&nbsp;returns&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">funcType</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">rtype</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Indirect&nbsp;Go&nbsp;func&nbsp;value&nbsp;(dummy)&nbsp;to&nbsp;obtain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;actual&nbsp;code&nbsp;address.&nbsp;(A&nbsp;Go&nbsp;func&nbsp;value&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;to&nbsp;a&nbsp;C&nbsp;function&nbsp;pointer.&nbsp;http://golang.org/s/go11func.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dummy</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">methodValueCall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">code</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">*</span><span class="op">*</span><span class="op">(</span><span class="op">*</span><span class="op">*</span><span class="builtintype">uintptr</span><span class="op">)</span><span class="op">(</span><span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">dummy</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;methodValue&nbsp;contains&nbsp;a&nbsp;stack&nbsp;map&nbsp;for&nbsp;use&nbsp;by&nbsp;the&nbsp;runtime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">stack</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">funcLayout</span><span class="op">(</span><span class="ident">funcType</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fv</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">methodValue</span><span class="op">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fn</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">code</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">stack</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">stack</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">method</span><span class="op">:</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">v</span><span class="op">.</span><span class="ident">flag</span><span class="op">)</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="ident">flagMethodShift</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rcvr</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;<span class="ident">rcvr</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Cause&nbsp;panic&nbsp;if&nbsp;method&nbsp;is&nbsp;not&nbsp;appropriate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;panic&nbsp;would&nbsp;still&nbsp;happen&nbsp;during&nbsp;the&nbsp;call&nbsp;if&nbsp;we&nbsp;omit&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;but&nbsp;we&nbsp;want&nbsp;Interface()&nbsp;and&nbsp;other&nbsp;operations&nbsp;to&nbsp;fail&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">methodReceiver</span><span class="op">(</span><span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">fv</span><span class="op">.</span><span class="ident">rcvr</span><span class="op">,</span>&nbsp;<span class="ident">fv</span><span class="op">.</span><span class="ident">method</span><span class="op">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">Value</span><span class="op">{</span><span class="ident">funcType</span><span class="op">,</span>&nbsp;<span class="ident">unsafe</span><span class="op">.</span><span class="ident">Pointer</span><span class="op">(</span><span class="ident">fv</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">flag</span><span class="op">&amp;</span><span class="ident">flagRO</span>&nbsp;<span class="op">|</span>&nbsp;<span class="ident">flag</span><span class="op">(</span><span class="ident">Func</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;methodValueCall&nbsp;is&nbsp;an&nbsp;assembly&nbsp;function&nbsp;that&nbsp;is&nbsp;the&nbsp;code&nbsp;half&nbsp;of</span><br>
<span class="lineno">125</span><span class="comment">//&nbsp;the&nbsp;function&nbsp;returned&nbsp;from&nbsp;makeMethodValue.&nbsp;It&nbsp;expects&nbsp;a&nbsp;*methodValue</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;as&nbsp;its&nbsp;context&nbsp;register,&nbsp;and&nbsp;its&nbsp;job&nbsp;is&nbsp;to&nbsp;invoke&nbsp;callMethod(ctxt,&nbsp;frame)</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;where&nbsp;ctxt&nbsp;is&nbsp;the&nbsp;context&nbsp;register&nbsp;and&nbsp;frame&nbsp;is&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;word&nbsp;in&nbsp;the&nbsp;passed-in&nbsp;argument&nbsp;frame.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">methodValueCall</span><span class="op">(</span><span class="op">)</span>
</div>
</body>
</html>
