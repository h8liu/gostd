<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5632516">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5632571">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5632625">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5632676">package</span>&nbsp;<span class="ident" id="5632684">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5632689">import</span>&nbsp;<span class="op" id="5632696">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5632699">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5632708">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5632718">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5632725">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5632730">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5632733">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="5632778">type</span>&nbsp;<span class="ident" id="5632783">writer</span>&nbsp;<span class="keyword" id="5632790">interface</span>&nbsp;<span class="op" id="5632800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632803">io</span><span class="op" id="5632805">.</span><span class="ident" id="5632806">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632818">Flush</span><span class="op" id="5632823">(</span><span class="op" id="5632824">)</span>&nbsp;<span class="builtintype" id="5632826">error</span><br>
<span class="lineno"></span><span class="op" id="5632832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5632835">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5632912">type</span>&nbsp;<span class="ident" id="5632917">errWriteCloser</span>&nbsp;<span class="keyword" id="5632932">struct</span>&nbsp;<span class="op" id="5632939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5632942">err</span>&nbsp;<span class="builtintype" id="5632946">error</span><br>
<span class="lineno"></span><span class="op" id="5632952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5632955">func</span>&nbsp;<span class="op" id="5632960">(</span><span class="ident" id="5632961">e</span>&nbsp;<span class="op" id="5632963">*</span><span class="ident" id="5632964">errWriteCloser</span><span class="op" id="5632978">)</span>&nbsp;<span class="ident" id="5632980">Write</span><span class="op" id="5632985">(</span><span class="op" id="5632986">[</span><span class="op" id="5632987">]</span><span class="builtintype" id="5632988">byte</span><span class="op" id="5632992">)</span>&nbsp;<span class="op" id="5632994">(</span><span class="builtintype" id="5632995">int</span><span class="op" id="5632998">,</span>&nbsp;<span class="builtintype" id="5633000">error</span><span class="op" id="5633005">)</span>&nbsp;<span class="op" id="5633007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5633010">return</span>&nbsp;<span class="num" id="5633017">0</span><span class="op" id="5633018">,</span>&nbsp;<span class="ident" id="5633020">e</span><span class="op" id="5633021">.</span><span class="ident" id="5633022">err</span><br>
<span class="lineno"></span><span class="op" id="5633026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5633029">func</span>&nbsp;<span class="op" id="5633034">(</span><span class="ident" id="5633035">e</span>&nbsp;<span class="op" id="5633037">*</span><span class="ident" id="5633038">errWriteCloser</span><span class="op" id="5633052">)</span>&nbsp;<span class="ident" id="5633054">Close</span><span class="op" id="5633059">(</span><span class="op" id="5633060">)</span>&nbsp;<span class="builtintype" id="5633062">error</span>&nbsp;<span class="op" id="5633068">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5633071">return</span>&nbsp;<span class="ident" id="5633078">e</span><span class="op" id="5633079">.</span><span class="ident" id="5633080">err</span><br>
<span class="lineno"></span><span class="op" id="5633084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5633087">const</span>&nbsp;<span class="op" id="5633093">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633096">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633168">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633209">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5633221">=</span>&nbsp;<span class="num" id="5633223">1</span><span class="op" id="5633224">&lt;&lt;</span><span class="num" id="5633226">12</span>&nbsp;<span class="op" id="5633229">-</span>&nbsp;<span class="num" id="5633231">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633234">invalidCode</span>&nbsp;<span class="op" id="5633246">=</span>&nbsp;<span class="num" id="5633248">1</span><span class="op" id="5633249">&lt;&lt;</span><span class="num" id="5633251">32</span>&nbsp;<span class="op" id="5633254">-</span>&nbsp;<span class="num" id="5633256">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633259">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633336">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633415">tableSize</span>&nbsp;<span class="op" id="5633425">=</span>&nbsp;<span class="num" id="5633427">4</span>&nbsp;<span class="op" id="5633429">*</span>&nbsp;<span class="num" id="5633431">1</span>&nbsp;<span class="op" id="5633433">&lt;&lt;</span>&nbsp;<span class="num" id="5633436">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633440">tableMask</span>&nbsp;<span class="op" id="5633450">=</span>&nbsp;<span class="ident" id="5633452">tableSize</span>&nbsp;<span class="op" id="5633462">-</span>&nbsp;<span class="num" id="5633464">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633467">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633538">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633601">invalidEntry</span>&nbsp;<span class="op" id="5633614">=</span>&nbsp;<span class="num" id="5633616">0</span><br>
<span class="lineno">45</span><span class="op" id="5633618">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5633621">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="5633651">type</span>&nbsp;<span class="ident" id="5633656">encoder</span>&nbsp;<span class="keyword" id="5633664">struct</span>&nbsp;<span class="op" id="5633671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633674">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633732">w</span>&nbsp;<span class="ident" id="5633734">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633742">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633800">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633849">order</span>&nbsp;<span class="ident" id="5633855">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633862">write</span>&nbsp;<span class="keyword" id="5633868">func</span><span class="op" id="5633872">(</span><span class="op" id="5633873">*</span><span class="ident" id="5633874">encoder</span><span class="op" id="5633881">,</span>&nbsp;<span class="builtintype" id="5633883">uint32</span><span class="op" id="5633889">)</span>&nbsp;<span class="builtintype" id="5633891">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633898">bits</span>&nbsp;&nbsp;<span class="builtintype" id="5633904">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633912">nBits</span>&nbsp;<span class="builtintype" id="5633918">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633924">width</span>&nbsp;<span class="builtintype" id="5633930">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5633936">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5633988">litWidth</span>&nbsp;<span class="builtintype" id="5633997">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634003">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634057">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634120">hi</span><span class="op" id="5634122">,</span>&nbsp;<span class="ident" id="5634124">overflow</span>&nbsp;<span class="builtintype" id="5634133">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634141">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634215">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634279">savedCode</span>&nbsp;<span class="builtintype" id="5634289">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634297">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634372">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634426">err</span>&nbsp;<span class="builtintype" id="5634430">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634437">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634511">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634584">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5634655">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634689">table</span>&nbsp;<span class="op" id="5634695">[</span><span class="ident" id="5634696">tableSize</span><span class="op" id="5634705">]</span><span class="builtintype" id="5634706">uint32</span><br>
<span class="lineno"></span><span class="op" id="5634713">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="5634716">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5634787">func</span>&nbsp;<span class="op" id="5634792">(</span><span class="ident" id="5634793">e</span>&nbsp;<span class="op" id="5634795">*</span><span class="ident" id="5634796">encoder</span><span class="op" id="5634803">)</span>&nbsp;<span class="ident" id="5634805">writeLSB</span><span class="op" id="5634813">(</span><span class="ident" id="5634814">c</span>&nbsp;<span class="builtintype" id="5634816">uint32</span><span class="op" id="5634822">)</span>&nbsp;<span class="builtintype" id="5634824">error</span>&nbsp;<span class="op" id="5634830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634833">e</span><span class="op" id="5634834">.</span><span class="ident" id="5634835">bits</span>&nbsp;<span class="op" id="5634840">|=</span>&nbsp;<span class="ident" id="5634843">c</span>&nbsp;<span class="op" id="5634845">&lt;&lt;</span>&nbsp;<span class="ident" id="5634848">e</span><span class="op" id="5634849">.</span><span class="ident" id="5634850">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634857">e</span><span class="op" id="5634858">.</span><span class="ident" id="5634859">nBits</span>&nbsp;<span class="op" id="5634865">+=</span>&nbsp;<span class="ident" id="5634868">e</span><span class="op" id="5634869">.</span><span class="ident" id="5634870">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5634877">for</span>&nbsp;<span class="ident" id="5634881">e</span><span class="op" id="5634882">.</span><span class="ident" id="5634883">nBits</span>&nbsp;<span class="op" id="5634889">&gt;=</span>&nbsp;<span class="num" id="5634892">8</span>&nbsp;<span class="op" id="5634894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5634898">if</span>&nbsp;<span class="ident" id="5634901">err</span>&nbsp;<span class="op" id="5634905">:=</span>&nbsp;<span class="ident" id="5634908">e</span><span class="op" id="5634909">.</span><span class="ident" id="5634910">w</span><span class="op" id="5634911">.</span><span class="ident" id="5634912">WriteByte</span><span class="op" id="5634921">(</span><span class="builtintype" id="5634922">uint8</span><span class="op" id="5634927">(</span><span class="ident" id="5634928">e</span><span class="op" id="5634929">.</span><span class="ident" id="5634930">bits</span><span class="op" id="5634934">)</span><span class="op" id="5634935">)</span><span class="op" id="5634936">;</span>&nbsp;<span class="ident" id="5634938">err</span>&nbsp;<span class="op" id="5634942">!=</span>&nbsp;<span class="ident" id="5634945">nil</span>&nbsp;<span class="op" id="5634949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5634954">return</span>&nbsp;<span class="ident" id="5634961">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5634967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634971">e</span><span class="op" id="5634972">.</span><span class="ident" id="5634973">bits</span>&nbsp;<span class="op" id="5634978">&gt;&gt;=</span>&nbsp;<span class="num" id="5634982">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5634986">e</span><span class="op" id="5634987">.</span><span class="ident" id="5634988">nBits</span>&nbsp;<span class="op" id="5634994">-=</span>&nbsp;<span class="num" id="5634997">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5635000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635003">return</span>&nbsp;<span class="ident" id="5635010">nil</span><br>
<span class="lineno"></span><span class="op" id="5635014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5635017">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5635087">func</span>&nbsp;<span class="op" id="5635092">(</span><span class="ident" id="5635093">e</span>&nbsp;<span class="op" id="5635095">*</span><span class="ident" id="5635096">encoder</span><span class="op" id="5635103">)</span>&nbsp;<span class="ident" id="5635105">writeMSB</span><span class="op" id="5635113">(</span><span class="ident" id="5635114">c</span>&nbsp;<span class="builtintype" id="5635116">uint32</span><span class="op" id="5635122">)</span>&nbsp;<span class="builtintype" id="5635124">error</span>&nbsp;<span class="op" id="5635130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635133">e</span><span class="op" id="5635134">.</span><span class="ident" id="5635135">bits</span>&nbsp;<span class="op" id="5635140">|=</span>&nbsp;<span class="ident" id="5635143">c</span>&nbsp;<span class="op" id="5635145">&lt;&lt;</span>&nbsp;<span class="op" id="5635148">(</span><span class="num" id="5635149">32</span>&nbsp;<span class="op" id="5635152">-</span>&nbsp;<span class="ident" id="5635154">e</span><span class="op" id="5635155">.</span><span class="ident" id="5635156">width</span>&nbsp;<span class="op" id="5635162">-</span>&nbsp;<span class="ident" id="5635164">e</span><span class="op" id="5635165">.</span><span class="ident" id="5635166">nBits</span><span class="op" id="5635171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635174">e</span><span class="op" id="5635175">.</span><span class="ident" id="5635176">nBits</span>&nbsp;<span class="op" id="5635182">+=</span>&nbsp;<span class="ident" id="5635185">e</span><span class="op" id="5635186">.</span><span class="ident" id="5635187">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635194">for</span>&nbsp;<span class="ident" id="5635198">e</span><span class="op" id="5635199">.</span><span class="ident" id="5635200">nBits</span>&nbsp;<span class="op" id="5635206">&gt;=</span>&nbsp;<span class="num" id="5635209">8</span>&nbsp;<span class="op" id="5635211">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635215">if</span>&nbsp;<span class="ident" id="5635218">err</span>&nbsp;<span class="op" id="5635222">:=</span>&nbsp;<span class="ident" id="5635225">e</span><span class="op" id="5635226">.</span><span class="ident" id="5635227">w</span><span class="op" id="5635228">.</span><span class="ident" id="5635229">WriteByte</span><span class="op" id="5635238">(</span><span class="builtintype" id="5635239">uint8</span><span class="op" id="5635244">(</span><span class="ident" id="5635245">e</span><span class="op" id="5635246">.</span><span class="ident" id="5635247">bits</span>&nbsp;<span class="op" id="5635252">&gt;&gt;</span>&nbsp;<span class="num" id="5635255">24</span><span class="op" id="5635257">)</span><span class="op" id="5635258">)</span><span class="op" id="5635259">;</span>&nbsp;<span class="ident" id="5635261">err</span>&nbsp;<span class="op" id="5635265">!=</span>&nbsp;<span class="ident" id="5635268">nil</span>&nbsp;<span class="op" id="5635272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635277">return</span>&nbsp;<span class="ident" id="5635284">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5635290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635294">e</span><span class="op" id="5635295">.</span><span class="ident" id="5635296">bits</span>&nbsp;<span class="op" id="5635301">&lt;&lt;=</span>&nbsp;<span class="num" id="5635305">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635309">e</span><span class="op" id="5635310">.</span><span class="ident" id="5635311">nBits</span>&nbsp;<span class="op" id="5635317">-=</span>&nbsp;<span class="num" id="5635320">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5635323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635326">return</span>&nbsp;<span class="ident" id="5635333">nil</span><br>
<span class="lineno"></span><span class="op" id="5635337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5635340">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="5635418">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="5635477">var</span>&nbsp;<span class="ident" id="5635481">errOutOfCodes</span>&nbsp;<span class="op" id="5635495">=</span>&nbsp;<span class="ident" id="5635497">errors</span><span class="op" id="5635503">.</span><span class="ident" id="5635504">New</span><span class="op" id="5635507">(</span><span class="string" id="5635508">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="5635527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5635530">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5635603">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="5635677">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="5635721">func</span>&nbsp;<span class="op" id="5635726">(</span><span class="ident" id="5635727">e</span>&nbsp;<span class="op" id="5635729">*</span><span class="ident" id="5635730">encoder</span><span class="op" id="5635737">)</span>&nbsp;<span class="ident" id="5635739">incHi</span><span class="op" id="5635744">(</span><span class="op" id="5635745">)</span>&nbsp;<span class="builtintype" id="5635747">error</span>&nbsp;<span class="op" id="5635753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635756">e</span><span class="op" id="5635757">.</span><span class="ident" id="5635758">hi</span><span class="op" id="5635760">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635764">if</span>&nbsp;<span class="ident" id="5635767">e</span><span class="op" id="5635768">.</span><span class="ident" id="5635769">hi</span>&nbsp;<span class="op" id="5635772">==</span>&nbsp;<span class="ident" id="5635775">e</span><span class="op" id="5635776">.</span><span class="ident" id="5635777">overflow</span>&nbsp;<span class="op" id="5635786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635790">e</span><span class="op" id="5635791">.</span><span class="ident" id="5635792">width</span><span class="op" id="5635797">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635802">e</span><span class="op" id="5635803">.</span><span class="ident" id="5635804">overflow</span>&nbsp;<span class="op" id="5635813">&lt;&lt;=</span>&nbsp;<span class="num" id="5635817">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5635820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635823">if</span>&nbsp;<span class="ident" id="5635826">e</span><span class="op" id="5635827">.</span><span class="ident" id="5635828">hi</span>&nbsp;<span class="op" id="5635831">==</span>&nbsp;<span class="ident" id="5635834">maxCode</span>&nbsp;<span class="op" id="5635842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635846">clear</span>&nbsp;<span class="op" id="5635852">:=</span>&nbsp;<span class="builtintype" id="5635855">uint32</span><span class="op" id="5635861">(</span><span class="num" id="5635862">1</span><span class="op" id="5635863">)</span>&nbsp;<span class="op" id="5635865">&lt;&lt;</span>&nbsp;<span class="ident" id="5635868">e</span><span class="op" id="5635869">.</span><span class="ident" id="5635870">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635881">if</span>&nbsp;<span class="ident" id="5635884">err</span>&nbsp;<span class="op" id="5635888">:=</span>&nbsp;<span class="ident" id="5635891">e</span><span class="op" id="5635892">.</span><span class="ident" id="5635893">write</span><span class="op" id="5635898">(</span><span class="ident" id="5635899">e</span><span class="op" id="5635900">,</span>&nbsp;<span class="ident" id="5635902">clear</span><span class="op" id="5635907">)</span><span class="op" id="5635908">;</span>&nbsp;<span class="ident" id="5635910">err</span>&nbsp;<span class="op" id="5635914">!=</span>&nbsp;<span class="ident" id="5635917">nil</span>&nbsp;<span class="op" id="5635921">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5635926">return</span>&nbsp;<span class="ident" id="5635933">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5635939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635943">e</span><span class="op" id="5635944">.</span><span class="ident" id="5635945">width</span>&nbsp;<span class="op" id="5635951">=</span>&nbsp;<span class="builtintype" id="5635953">uint</span><span class="op" id="5635957">(</span><span class="ident" id="5635958">e</span><span class="op" id="5635959">.</span><span class="ident" id="5635960">litWidth</span><span class="op" id="5635968">)</span>&nbsp;<span class="op" id="5635970">+</span>&nbsp;<span class="num" id="5635972">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635976">e</span><span class="op" id="5635977">.</span><span class="ident" id="5635978">hi</span>&nbsp;<span class="op" id="5635981">=</span>&nbsp;<span class="ident" id="5635983">clear</span>&nbsp;<span class="op" id="5635989">+</span>&nbsp;<span class="num" id="5635991">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5635995">e</span><span class="op" id="5635996">.</span><span class="ident" id="5635997">overflow</span>&nbsp;<span class="op" id="5636006">=</span>&nbsp;<span class="ident" id="5636008">clear</span>&nbsp;<span class="op" id="5636014">&lt;&lt;</span>&nbsp;<span class="num" id="5636017">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636021">for</span>&nbsp;<span class="ident" id="5636025">i</span>&nbsp;<span class="op" id="5636027">:=</span>&nbsp;<span class="keyword" id="5636030">range</span>&nbsp;<span class="ident" id="5636036">e</span><span class="op" id="5636037">.</span><span class="ident" id="5636038">table</span>&nbsp;<span class="op" id="5636044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636049">e</span><span class="op" id="5636050">.</span><span class="ident" id="5636051">table</span><span class="op" id="5636056">[</span><span class="ident" id="5636057">i</span><span class="op" id="5636058">]</span>&nbsp;<span class="op" id="5636060">=</span>&nbsp;<span class="ident" id="5636062">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5636077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636081">return</span>&nbsp;<span class="ident" id="5636088">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5636103">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636106">return</span>&nbsp;<span class="ident" id="5636113">nil</span><br>
<span class="lineno"></span><span class="op" id="5636117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5636120">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5636195">func</span>&nbsp;<span class="op" id="5636200">(</span><span class="ident" id="5636201">e</span>&nbsp;<span class="op" id="5636203">*</span><span class="ident" id="5636204">encoder</span><span class="op" id="5636211">)</span>&nbsp;<span class="ident" id="5636213">Write</span><span class="op" id="5636218">(</span><span class="ident" id="5636219">p</span>&nbsp;<span class="op" id="5636221">[</span><span class="op" id="5636222">]</span><span class="builtintype" id="5636223">byte</span><span class="op" id="5636227">)</span>&nbsp;<span class="op" id="5636229">(</span><span class="ident" id="5636230">n</span>&nbsp;<span class="builtintype" id="5636232">int</span><span class="op" id="5636235">,</span>&nbsp;<span class="ident" id="5636237">err</span>&nbsp;<span class="builtintype" id="5636241">error</span><span class="op" id="5636246">)</span>&nbsp;<span class="op" id="5636248">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636251">if</span>&nbsp;<span class="ident" id="5636254">e</span><span class="op" id="5636255">.</span><span class="ident" id="5636256">err</span>&nbsp;<span class="op" id="5636260">!=</span>&nbsp;<span class="ident" id="5636263">nil</span>&nbsp;<span class="op" id="5636267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636271">return</span>&nbsp;<span class="num" id="5636278">0</span><span class="op" id="5636279">,</span>&nbsp;<span class="ident" id="5636281">e</span><span class="op" id="5636282">.</span><span class="ident" id="5636283">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5636288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636291">if</span>&nbsp;<span class="builtinfunc" id="5636294">len</span><span class="op" id="5636297">(</span><span class="ident" id="5636298">p</span><span class="op" id="5636299">)</span>&nbsp;<span class="op" id="5636301">==</span>&nbsp;<span class="num" id="5636304">0</span>&nbsp;<span class="op" id="5636306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636310">return</span>&nbsp;<span class="num" id="5636317">0</span><span class="op" id="5636318">,</span>&nbsp;<span class="ident" id="5636320">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5636325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636328">n</span>&nbsp;<span class="op" id="5636330">=</span>&nbsp;<span class="builtinfunc" id="5636332">len</span><span class="op" id="5636335">(</span><span class="ident" id="5636336">p</span><span class="op" id="5636337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636340">litMask</span>&nbsp;<span class="op" id="5636348">:=</span>&nbsp;<span class="builtintype" id="5636351">uint32</span><span class="op" id="5636357">(</span><span class="num" id="5636358">1</span><span class="op" id="5636359">&lt;&lt;</span><span class="ident" id="5636361">e</span><span class="op" id="5636362">.</span><span class="ident" id="5636363">litWidth</span>&nbsp;<span class="op" id="5636372">-</span>&nbsp;<span class="num" id="5636374">1</span><span class="op" id="5636375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636378">code</span>&nbsp;<span class="op" id="5636383">:=</span>&nbsp;<span class="ident" id="5636386">e</span><span class="op" id="5636387">.</span><span class="ident" id="5636388">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636399">if</span>&nbsp;<span class="ident" id="5636402">code</span>&nbsp;<span class="op" id="5636407">==</span>&nbsp;<span class="ident" id="5636410">invalidCode</span>&nbsp;<span class="op" id="5636422">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5636426">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636477">code</span><span class="op" id="5636481">,</span>&nbsp;<span class="ident" id="5636483">p</span>&nbsp;<span class="op" id="5636485">=</span>&nbsp;<span class="builtintype" id="5636487">uint32</span><span class="op" id="5636493">(</span><span class="ident" id="5636494">p</span><span class="op" id="5636495">[</span><span class="num" id="5636496">0</span><span class="op" id="5636497">]</span><span class="op" id="5636498">)</span><span class="op" id="5636499">&amp;</span><span class="ident" id="5636500">litMask</span><span class="op" id="5636507">,</span>&nbsp;<span class="ident" id="5636509">p</span><span class="op" id="5636510">[</span><span class="num" id="5636511">1</span><span class="op" id="5636512">:</span><span class="op" id="5636513">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5636516">}</span><br>
<span class="lineno"></span><span class="ident" id="5636518">loop</span><span class="op" id="5636522">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636525">for</span>&nbsp;<span class="ident" id="5636529">_</span><span class="op" id="5636530">,</span>&nbsp;<span class="ident" id="5636532">x</span>&nbsp;<span class="op" id="5636534">:=</span>&nbsp;<span class="keyword" id="5636537">range</span>&nbsp;<span class="ident" id="5636543">p</span>&nbsp;<span class="op" id="5636545">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636549">literal</span>&nbsp;<span class="op" id="5636557">:=</span>&nbsp;<span class="builtintype" id="5636560">uint32</span><span class="op" id="5636566">(</span><span class="ident" id="5636567">x</span><span class="op" id="5636568">)</span>&nbsp;<span class="op" id="5636570">&amp;</span>&nbsp;<span class="ident" id="5636572">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636582">key</span>&nbsp;<span class="op" id="5636586">:=</span>&nbsp;<span class="ident" id="5636589">code</span><span class="op" id="5636593">&lt;&lt;</span><span class="num" id="5636595">8</span>&nbsp;<span class="op" id="5636597">|</span>&nbsp;<span class="ident" id="5636599">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5636609">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5636682">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636715">hash</span>&nbsp;<span class="op" id="5636720">:=</span>&nbsp;<span class="op" id="5636723">(</span><span class="ident" id="5636724">key</span><span class="op" id="5636727">&gt;&gt;</span><span class="num" id="5636729">12</span>&nbsp;<span class="op" id="5636732">^</span>&nbsp;<span class="ident" id="5636734">key</span><span class="op" id="5636737">)</span>&nbsp;<span class="op" id="5636739">&amp;</span>&nbsp;<span class="ident" id="5636741">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636753">for</span>&nbsp;<span class="ident" id="5636757">h</span><span class="op" id="5636758">,</span>&nbsp;<span class="ident" id="5636760">t</span>&nbsp;<span class="op" id="5636762">:=</span>&nbsp;<span class="ident" id="5636765">hash</span><span class="op" id="5636769">,</span>&nbsp;<span class="ident" id="5636771">e</span><span class="op" id="5636772">.</span><span class="ident" id="5636773">table</span><span class="op" id="5636778">[</span><span class="ident" id="5636779">hash</span><span class="op" id="5636783">]</span><span class="op" id="5636784">;</span>&nbsp;<span class="ident" id="5636786">t</span>&nbsp;<span class="op" id="5636788">!=</span>&nbsp;<span class="ident" id="5636791">invalidEntry</span><span class="op" id="5636803">;</span>&nbsp;<span class="op" id="5636805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636810">if</span>&nbsp;<span class="ident" id="5636813">key</span>&nbsp;<span class="op" id="5636817">==</span>&nbsp;<span class="ident" id="5636820">t</span><span class="op" id="5636821">&gt;&gt;</span><span class="num" id="5636823">12</span>&nbsp;<span class="op" id="5636826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636832">code</span>&nbsp;<span class="op" id="5636837">=</span>&nbsp;<span class="ident" id="5636839">t</span>&nbsp;<span class="op" id="5636841">&amp;</span>&nbsp;<span class="ident" id="5636843">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5636855">continue</span>&nbsp;<span class="ident" id="5636864">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5636872">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636877">h</span>&nbsp;<span class="op" id="5636879">=</span>&nbsp;<span class="op" id="5636881">(</span><span class="ident" id="5636882">h</span>&nbsp;<span class="op" id="5636884">+</span>&nbsp;<span class="num" id="5636886">1</span><span class="op" id="5636887">)</span>&nbsp;<span class="op" id="5636889">&amp;</span>&nbsp;<span class="ident" id="5636891">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5636904">t</span>&nbsp;<span class="op" id="5636906">=</span>&nbsp;<span class="ident" id="5636908">e</span><span class="op" id="5636909">.</span><span class="ident" id="5636910">table</span><span class="op" id="5636915">[</span><span class="ident" id="5636916">h</span><span class="op" id="5636917">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5636921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5636925">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5636998">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637026">if</span>&nbsp;<span class="ident" id="5637029">e</span><span class="op" id="5637030">.</span><span class="ident" id="5637031">err</span>&nbsp;<span class="op" id="5637035">=</span>&nbsp;<span class="ident" id="5637037">e</span><span class="op" id="5637038">.</span><span class="ident" id="5637039">write</span><span class="op" id="5637044">(</span><span class="ident" id="5637045">e</span><span class="op" id="5637046">,</span>&nbsp;<span class="ident" id="5637048">code</span><span class="op" id="5637052">)</span><span class="op" id="5637053">;</span>&nbsp;<span class="ident" id="5637055">e</span><span class="op" id="5637056">.</span><span class="ident" id="5637057">err</span>&nbsp;<span class="op" id="5637061">!=</span>&nbsp;<span class="ident" id="5637064">nil</span>&nbsp;<span class="op" id="5637068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637073">return</span>&nbsp;<span class="num" id="5637080">0</span><span class="op" id="5637081">,</span>&nbsp;<span class="ident" id="5637083">e</span><span class="op" id="5637084">.</span><span class="ident" id="5637085">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5637091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637095">code</span>&nbsp;<span class="op" id="5637100">=</span>&nbsp;<span class="ident" id="5637102">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5637112">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5637186">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637259">if</span>&nbsp;<span class="ident" id="5637262">err1</span>&nbsp;<span class="op" id="5637267">:=</span>&nbsp;<span class="ident" id="5637270">e</span><span class="op" id="5637271">.</span><span class="ident" id="5637272">incHi</span><span class="op" id="5637277">(</span><span class="op" id="5637278">)</span><span class="op" id="5637279">;</span>&nbsp;<span class="ident" id="5637281">err1</span>&nbsp;<span class="op" id="5637286">!=</span>&nbsp;<span class="ident" id="5637289">nil</span>&nbsp;<span class="op" id="5637293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637298">if</span>&nbsp;<span class="ident" id="5637301">err1</span>&nbsp;<span class="op" id="5637306">==</span>&nbsp;<span class="ident" id="5637309">errOutOfCodes</span>&nbsp;<span class="op" id="5637323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637329">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5637341">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637346">e</span><span class="op" id="5637347">.</span><span class="ident" id="5637348">err</span>&nbsp;<span class="op" id="5637352">=</span>&nbsp;<span class="ident" id="5637354">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637362">return</span>&nbsp;<span class="num" id="5637369">0</span><span class="op" id="5637370">,</span>&nbsp;<span class="ident" id="5637372">e</span><span class="op" id="5637373">.</span><span class="ident" id="5637374">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5637380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5637384">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637457">for</span>&nbsp;<span class="op" id="5637461">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637466">if</span>&nbsp;<span class="ident" id="5637469">e</span><span class="op" id="5637470">.</span><span class="ident" id="5637471">table</span><span class="op" id="5637476">[</span><span class="ident" id="5637477">hash</span><span class="op" id="5637481">]</span>&nbsp;<span class="op" id="5637483">==</span>&nbsp;<span class="ident" id="5637486">invalidEntry</span>&nbsp;<span class="op" id="5637499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637505">e</span><span class="op" id="5637506">.</span><span class="ident" id="5637507">table</span><span class="op" id="5637512">[</span><span class="ident" id="5637513">hash</span><span class="op" id="5637517">]</span>&nbsp;<span class="op" id="5637519">=</span>&nbsp;<span class="op" id="5637521">(</span><span class="ident" id="5637522">key</span>&nbsp;<span class="op" id="5637526">&lt;&lt;</span>&nbsp;<span class="num" id="5637529">12</span><span class="op" id="5637531">)</span>&nbsp;<span class="op" id="5637533">|</span>&nbsp;<span class="ident" id="5637535">e</span><span class="op" id="5637536">.</span><span class="ident" id="5637537">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637544">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5637553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637558">hash</span>&nbsp;<span class="op" id="5637563">=</span>&nbsp;<span class="op" id="5637565">(</span><span class="ident" id="5637566">hash</span>&nbsp;<span class="op" id="5637571">+</span>&nbsp;<span class="num" id="5637573">1</span><span class="op" id="5637574">)</span>&nbsp;<span class="op" id="5637576">&amp;</span>&nbsp;<span class="ident" id="5637578">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5637590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5637593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637596">e</span><span class="op" id="5637597">.</span><span class="ident" id="5637598">savedCode</span>&nbsp;<span class="op" id="5637608">=</span>&nbsp;<span class="ident" id="5637610">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637616">return</span>&nbsp;<span class="ident" id="5637623">n</span><span class="op" id="5637624">,</span>&nbsp;<span class="ident" id="5637626">nil</span><br>
<span class="lineno"></span><span class="op" id="5637630">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5637633">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5637712">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5637744">func</span>&nbsp;<span class="op" id="5637749">(</span><span class="ident" id="5637750">e</span>&nbsp;<span class="op" id="5637752">*</span><span class="ident" id="5637753">encoder</span><span class="op" id="5637760">)</span>&nbsp;<span class="ident" id="5637762">Close</span><span class="op" id="5637767">(</span><span class="op" id="5637768">)</span>&nbsp;<span class="builtintype" id="5637770">error</span>&nbsp;<span class="op" id="5637776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637779">if</span>&nbsp;<span class="ident" id="5637782">e</span><span class="op" id="5637783">.</span><span class="ident" id="5637784">err</span>&nbsp;<span class="op" id="5637788">!=</span>&nbsp;<span class="ident" id="5637791">nil</span>&nbsp;<span class="op" id="5637795">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637799">if</span>&nbsp;<span class="ident" id="5637802">e</span><span class="op" id="5637803">.</span><span class="ident" id="5637804">err</span>&nbsp;<span class="op" id="5637808">==</span>&nbsp;<span class="ident" id="5637811">errClosed</span>&nbsp;<span class="op" id="5637821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637826">return</span>&nbsp;<span class="ident" id="5637833">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5637839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637843">return</span>&nbsp;<span class="ident" id="5637850">e</span><span class="op" id="5637851">.</span><span class="ident" id="5637852">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5637857">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5637860">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5637913">e</span><span class="op" id="5637914">.</span><span class="ident" id="5637915">err</span>&nbsp;<span class="op" id="5637919">=</span>&nbsp;<span class="ident" id="5637921">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5637932">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5637966">if</span>&nbsp;<span class="ident" id="5637969">e</span><span class="op" id="5637970">.</span><span class="ident" id="5637971">savedCode</span>&nbsp;<span class="op" id="5637981">!=</span>&nbsp;<span class="ident" id="5637984">invalidCode</span>&nbsp;<span class="op" id="5637996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638000">if</span>&nbsp;<span class="ident" id="5638003">err</span>&nbsp;<span class="op" id="5638007">:=</span>&nbsp;<span class="ident" id="5638010">e</span><span class="op" id="5638011">.</span><span class="ident" id="5638012">write</span><span class="op" id="5638017">(</span><span class="ident" id="5638018">e</span><span class="op" id="5638019">,</span>&nbsp;<span class="ident" id="5638021">e</span><span class="op" id="5638022">.</span><span class="ident" id="5638023">savedCode</span><span class="op" id="5638032">)</span><span class="op" id="5638033">;</span>&nbsp;<span class="ident" id="5638035">err</span>&nbsp;<span class="op" id="5638039">!=</span>&nbsp;<span class="ident" id="5638042">nil</span>&nbsp;<span class="op" id="5638046">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638051">return</span>&nbsp;<span class="ident" id="5638058">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5638064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638068">if</span>&nbsp;<span class="ident" id="5638071">err</span>&nbsp;<span class="op" id="5638075">:=</span>&nbsp;<span class="ident" id="5638078">e</span><span class="op" id="5638079">.</span><span class="ident" id="5638080">incHi</span><span class="op" id="5638085">(</span><span class="op" id="5638086">)</span><span class="op" id="5638087">;</span>&nbsp;<span class="ident" id="5638089">err</span>&nbsp;<span class="op" id="5638093">!=</span>&nbsp;<span class="ident" id="5638096">nil</span>&nbsp;<span class="op" id="5638100">&amp;&amp;</span>&nbsp;<span class="ident" id="5638103">err</span>&nbsp;<span class="op" id="5638107">!=</span>&nbsp;<span class="ident" id="5638110">errOutOfCodes</span>&nbsp;<span class="op" id="5638124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638129">return</span>&nbsp;<span class="ident" id="5638136">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5638142">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5638145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5638148">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638172">eof</span>&nbsp;<span class="op" id="5638176">:=</span>&nbsp;<span class="builtintype" id="5638179">uint32</span><span class="op" id="5638185">(</span><span class="num" id="5638186">1</span><span class="op" id="5638187">)</span><span class="op" id="5638188">&lt;&lt;</span><span class="ident" id="5638190">e</span><span class="op" id="5638191">.</span><span class="ident" id="5638192">litWidth</span>&nbsp;<span class="op" id="5638201">+</span>&nbsp;<span class="num" id="5638203">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638206">if</span>&nbsp;<span class="ident" id="5638209">err</span>&nbsp;<span class="op" id="5638213">:=</span>&nbsp;<span class="ident" id="5638216">e</span><span class="op" id="5638217">.</span><span class="ident" id="5638218">write</span><span class="op" id="5638223">(</span><span class="ident" id="5638224">e</span><span class="op" id="5638225">,</span>&nbsp;<span class="ident" id="5638227">eof</span><span class="op" id="5638230">)</span><span class="op" id="5638231">;</span>&nbsp;<span class="ident" id="5638233">err</span>&nbsp;<span class="op" id="5638237">!=</span>&nbsp;<span class="ident" id="5638240">nil</span>&nbsp;<span class="op" id="5638244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638248">return</span>&nbsp;<span class="ident" id="5638255">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5638260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5638263">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638289">if</span>&nbsp;<span class="ident" id="5638292">e</span><span class="op" id="5638293">.</span><span class="ident" id="5638294">nBits</span>&nbsp;<span class="op" id="5638300">&gt;</span>&nbsp;<span class="num" id="5638302">0</span>&nbsp;<span class="op" id="5638304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638308">if</span>&nbsp;<span class="ident" id="5638311">e</span><span class="op" id="5638312">.</span><span class="ident" id="5638313">order</span>&nbsp;<span class="op" id="5638319">==</span>&nbsp;<span class="ident" id="5638322">MSB</span>&nbsp;<span class="op" id="5638326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638331">e</span><span class="op" id="5638332">.</span><span class="ident" id="5638333">bits</span>&nbsp;<span class="op" id="5638338">&gt;&gt;=</span>&nbsp;<span class="num" id="5638342">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5638347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638351">if</span>&nbsp;<span class="ident" id="5638354">err</span>&nbsp;<span class="op" id="5638358">:=</span>&nbsp;<span class="ident" id="5638361">e</span><span class="op" id="5638362">.</span><span class="ident" id="5638363">w</span><span class="op" id="5638364">.</span><span class="ident" id="5638365">WriteByte</span><span class="op" id="5638374">(</span><span class="builtintype" id="5638375">uint8</span><span class="op" id="5638380">(</span><span class="ident" id="5638381">e</span><span class="op" id="5638382">.</span><span class="ident" id="5638383">bits</span><span class="op" id="5638387">)</span><span class="op" id="5638388">)</span><span class="op" id="5638389">;</span>&nbsp;<span class="ident" id="5638391">err</span>&nbsp;<span class="op" id="5638395">!=</span>&nbsp;<span class="ident" id="5638398">nil</span>&nbsp;<span class="op" id="5638402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638407">return</span>&nbsp;<span class="ident" id="5638414">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5638420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5638423">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638426">return</span>&nbsp;<span class="ident" id="5638433">e</span><span class="op" id="5638434">.</span><span class="ident" id="5638435">w</span><span class="op" id="5638436">.</span><span class="ident" id="5638437">Flush</span><span class="op" id="5638442">(</span><span class="op" id="5638443">)</span><br>
<span class="lineno"></span><span class="op" id="5638445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5638448">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="5638491">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="5638565">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5638640">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="5638661">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5638734">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="5638769">func</span>&nbsp;<span class="ident" id="5638774">NewWriter</span><span class="op" id="5638783">(</span><span class="ident" id="5638784">w</span>&nbsp;<span class="ident" id="5638786">io</span><span class="op" id="5638788">.</span><span class="ident" id="5638789">Writer</span><span class="op" id="5638795">,</span>&nbsp;<span class="ident" id="5638797">order</span>&nbsp;<span class="ident" id="5638803">Order</span><span class="op" id="5638808">,</span>&nbsp;<span class="ident" id="5638810">litWidth</span>&nbsp;<span class="builtintype" id="5638819">int</span><span class="op" id="5638822">)</span>&nbsp;<span class="ident" id="5638824">io</span><span class="op" id="5638826">.</span><span class="ident" id="5638827">WriteCloser</span>&nbsp;<span class="op" id="5638839">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638842">var</span>&nbsp;<span class="ident" id="5638846">write</span>&nbsp;<span class="keyword" id="5638852">func</span><span class="op" id="5638856">(</span><span class="op" id="5638857">*</span><span class="ident" id="5638858">encoder</span><span class="op" id="5638865">,</span>&nbsp;<span class="builtintype" id="5638867">uint32</span><span class="op" id="5638873">)</span>&nbsp;<span class="builtintype" id="5638875">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638882">switch</span>&nbsp;<span class="ident" id="5638889">order</span>&nbsp;<span class="op" id="5638895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638898">case</span>&nbsp;<span class="ident" id="5638903">LSB</span><span class="op" id="5638906">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638910">write</span>&nbsp;<span class="op" id="5638916">=</span>&nbsp;<span class="op" id="5638918">(</span><span class="op" id="5638919">*</span><span class="ident" id="5638920">encoder</span><span class="op" id="5638927">)</span><span class="op" id="5638928">.</span><span class="ident" id="5638929">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638939">case</span>&nbsp;<span class="ident" id="5638944">MSB</span><span class="op" id="5638947">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5638951">write</span>&nbsp;<span class="op" id="5638957">=</span>&nbsp;<span class="op" id="5638959">(</span><span class="op" id="5638960">*</span><span class="ident" id="5638961">encoder</span><span class="op" id="5638968">)</span><span class="op" id="5638969">.</span><span class="ident" id="5638970">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638980">default</span><span class="op" id="5638987">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5638991">return</span>&nbsp;<span class="op" id="5638998">&amp;</span><span class="ident" id="5638999">errWriteCloser</span><span class="op" id="5639013">{</span><span class="ident" id="5639014">errors</span><span class="op" id="5639020">.</span><span class="ident" id="5639021">New</span><span class="op" id="5639024">(</span><span class="string" id="5639025">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="5639045">)</span><span class="op" id="5639046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5639049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639052">if</span>&nbsp;<span class="ident" id="5639055">litWidth</span>&nbsp;<span class="op" id="5639064">&lt;</span>&nbsp;<span class="num" id="5639066">2</span>&nbsp;<span class="op" id="5639068">||</span>&nbsp;<span class="num" id="5639071">8</span>&nbsp;<span class="op" id="5639073">&lt;</span>&nbsp;<span class="ident" id="5639075">litWidth</span>&nbsp;<span class="op" id="5639084">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639088">return</span>&nbsp;<span class="op" id="5639095">&amp;</span><span class="ident" id="5639096">errWriteCloser</span><span class="op" id="5639110">{</span><span class="ident" id="5639111">fmt</span><span class="op" id="5639114">.</span><span class="ident" id="5639115">Errorf</span><span class="op" id="5639121">(</span><span class="string" id="5639122">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5639153">,</span>&nbsp;<span class="ident" id="5639155">litWidth</span><span class="op" id="5639163">)</span><span class="op" id="5639164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5639167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639170">bw</span><span class="op" id="5639172">,</span>&nbsp;<span class="ident" id="5639174">ok</span>&nbsp;<span class="op" id="5639177">:=</span>&nbsp;<span class="ident" id="5639180">w</span><span class="op" id="5639181">.</span><span class="op" id="5639182">(</span><span class="ident" id="5639183">writer</span><span class="op" id="5639189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639192">if</span>&nbsp;<span class="op" id="5639195">!</span><span class="ident" id="5639196">ok</span>&nbsp;<span class="op" id="5639199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639203">bw</span>&nbsp;<span class="op" id="5639206">=</span>&nbsp;<span class="ident" id="5639208">bufio</span><span class="op" id="5639213">.</span><span class="ident" id="5639214">NewWriter</span><span class="op" id="5639223">(</span><span class="ident" id="5639224">w</span><span class="op" id="5639225">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5639228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639231">lw</span>&nbsp;<span class="op" id="5639234">:=</span>&nbsp;<span class="builtintype" id="5639237">uint</span><span class="op" id="5639241">(</span><span class="ident" id="5639242">litWidth</span><span class="op" id="5639250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5639253">return</span>&nbsp;<span class="op" id="5639260">&amp;</span><span class="ident" id="5639261">encoder</span><span class="op" id="5639268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639272">w</span><span class="op" id="5639273">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639283">bw</span><span class="op" id="5639285">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639289">order</span><span class="op" id="5639294">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639300">order</span><span class="op" id="5639305">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639309">write</span><span class="op" id="5639314">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5639320">write</span><span class="op" id="5639325">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639329">width</span><span class="op" id="5639334">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5639340">1</span>&nbsp;<span class="op" id="5639342">+</span>&nbsp;<span class="ident" id="5639344">lw</span><span class="op" id="5639346">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639350">litWidth</span><span class="op" id="5639358">:</span>&nbsp;&nbsp;<span class="ident" id="5639361">lw</span><span class="op" id="5639363">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639367">hi</span><span class="op" id="5639369">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5639378">1</span><span class="op" id="5639379">&lt;&lt;</span><span class="ident" id="5639381">lw</span>&nbsp;<span class="op" id="5639384">+</span>&nbsp;<span class="num" id="5639386">1</span><span class="op" id="5639387">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639391">overflow</span><span class="op" id="5639399">:</span>&nbsp;&nbsp;<span class="num" id="5639402">1</span>&nbsp;<span class="op" id="5639404">&lt;&lt;</span>&nbsp;<span class="op" id="5639407">(</span><span class="ident" id="5639408">lw</span>&nbsp;<span class="op" id="5639411">+</span>&nbsp;<span class="num" id="5639413">1</span><span class="op" id="5639414">)</span><span class="op" id="5639415">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5639419">savedCode</span><span class="op" id="5639428">:</span>&nbsp;<span class="ident" id="5639430">invalidCode</span><span class="op" id="5639441">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5639444">}</span><br>
<span class="lineno"></span><span class="op" id="5639446">}</span>
</div>
</body>
</html>
