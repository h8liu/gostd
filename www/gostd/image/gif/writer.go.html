<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/gif</h2>
<ul>
<li><a href="/gostd/image/gif/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/gif/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/gif/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/gif/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6300461">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6300516">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6300570">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6300621">package</span>&nbsp;<span class="ident" id="6300629">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6300634">import</span>&nbsp;<span class="op" id="6300641">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6300644">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6300653">&#34;compress/lzw&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6300669">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6300679">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6300688">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6300703">&#34;image/color/palette&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6300726">&#34;image/draw&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6300740">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6300745">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6300748">//&nbsp;Graphic&nbsp;control&nbsp;extension&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="6300785">const</span>&nbsp;<span class="op" id="6300791">(</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300794">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6300806">=</span>&nbsp;<span class="num" id="6300808">0xF9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300814">gcBlockSize</span>&nbsp;<span class="op" id="6300826">=</span>&nbsp;<span class="num" id="6300828">0x04</span><br>
<span class="lineno"></span><span class="op" id="6300833">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6300836">var</span>&nbsp;<span class="ident" id="6300840">log2Lookup</span>&nbsp;<span class="op" id="6300851">=</span>&nbsp;<span class="op" id="6300853">[</span><span class="num" id="6300854">8</span><span class="op" id="6300855">]</span><span class="builtintype" id="6300856">int</span><span class="op" id="6300859">{</span><span class="num" id="6300860">2</span><span class="op" id="6300861">,</span>&nbsp;<span class="num" id="6300863">4</span><span class="op" id="6300864">,</span>&nbsp;<span class="num" id="6300866">8</span><span class="op" id="6300867">,</span>&nbsp;<span class="num" id="6300869">16</span><span class="op" id="6300871">,</span>&nbsp;<span class="num" id="6300873">32</span><span class="op" id="6300875">,</span>&nbsp;<span class="num" id="6300877">64</span><span class="op" id="6300879">,</span>&nbsp;<span class="num" id="6300881">128</span><span class="op" id="6300884">,</span>&nbsp;<span class="num" id="6300886">256</span><span class="op" id="6300889">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6300892">func</span>&nbsp;<span class="ident" id="6300897">log2</span><span class="op" id="6300901">(</span><span class="ident" id="6300902">x</span>&nbsp;<span class="builtintype" id="6300904">int</span><span class="op" id="6300907">)</span>&nbsp;<span class="builtintype" id="6300909">int</span>&nbsp;<span class="op" id="6300913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300916">for</span>&nbsp;<span class="ident" id="6300920">i</span><span class="op" id="6300921">,</span>&nbsp;<span class="ident" id="6300923">v</span>&nbsp;<span class="op" id="6300925">:=</span>&nbsp;<span class="keyword" id="6300928">range</span>&nbsp;<span class="ident" id="6300934">log2Lookup</span>&nbsp;<span class="op" id="6300945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300949">if</span>&nbsp;<span class="ident" id="6300952">x</span>&nbsp;<span class="op" id="6300954">&lt;=</span>&nbsp;<span class="ident" id="6300957">v</span>&nbsp;<span class="op" id="6300959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300964">return</span>&nbsp;<span class="ident" id="6300971">i</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6300975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6300978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300981">return</span>&nbsp;<span class="op" id="6300988">-</span><span class="num" id="6300989">1</span><br>
<span class="lineno"></span><span class="op" id="6300991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="6300994">//&nbsp;Little-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="6301012">func</span>&nbsp;<span class="ident" id="6301017">writeUint16</span><span class="op" id="6301028">(</span><span class="ident" id="6301029">b</span>&nbsp;<span class="op" id="6301031">[</span><span class="op" id="6301032">]</span><span class="builtintype" id="6301033">uint8</span><span class="op" id="6301038">,</span>&nbsp;<span class="ident" id="6301040">u</span>&nbsp;<span class="builtintype" id="6301042">uint16</span><span class="op" id="6301048">)</span>&nbsp;<span class="op" id="6301050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301053">b</span><span class="op" id="6301054">[</span><span class="num" id="6301055">0</span><span class="op" id="6301056">]</span>&nbsp;<span class="op" id="6301058">=</span>&nbsp;<span class="builtintype" id="6301060">uint8</span><span class="op" id="6301065">(</span><span class="ident" id="6301066">u</span><span class="op" id="6301067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301070">b</span><span class="op" id="6301071">[</span><span class="num" id="6301072">1</span><span class="op" id="6301073">]</span>&nbsp;<span class="op" id="6301075">=</span>&nbsp;<span class="builtintype" id="6301077">uint8</span><span class="op" id="6301082">(</span><span class="ident" id="6301083">u</span>&nbsp;<span class="op" id="6301085">&gt;&gt;</span>&nbsp;<span class="num" id="6301088">8</span><span class="op" id="6301089">)</span><br>
<span class="lineno"></span><span class="op" id="6301091">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="6301094">//&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6301126">type</span>&nbsp;<span class="ident" id="6301131">writer</span>&nbsp;<span class="keyword" id="6301138">interface</span>&nbsp;<span class="op" id="6301148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301151">Flush</span><span class="op" id="6301156">(</span><span class="op" id="6301157">)</span>&nbsp;<span class="builtintype" id="6301159">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301166">io</span><span class="op" id="6301168">.</span><span class="ident" id="6301169">Writer</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301177">io</span><span class="op" id="6301179">.</span><span class="ident" id="6301180">ByteWriter</span><br>
<span class="lineno"></span><span class="op" id="6301191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6301194">//&nbsp;encoder&nbsp;encodes&nbsp;an&nbsp;image&nbsp;to&nbsp;the&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6301241">type</span>&nbsp;<span class="ident" id="6301246">encoder</span>&nbsp;<span class="keyword" id="6301254">struct</span>&nbsp;<span class="op" id="6301261">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6301264">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;to&nbsp;write&nbsp;to.&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6301339">//&nbsp;writing.&nbsp;All&nbsp;attempted&nbsp;writes&nbsp;after&nbsp;the&nbsp;first&nbsp;error&nbsp;become&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301410">w</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6301414">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301422">err</span>&nbsp;<span class="builtintype" id="6301426">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6301433">//&nbsp;g&nbsp;is&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;data&nbsp;that&nbsp;is&nbsp;being&nbsp;encoded.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301489">g</span>&nbsp;<span class="op" id="6301491">*</span><span class="ident" id="6301492">GIF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6301497">//&nbsp;buf&nbsp;is&nbsp;a&nbsp;scratch&nbsp;buffer.&nbsp;It&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;write&nbsp;the&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301581">buf</span>&nbsp;<span class="op" id="6301585">[</span><span class="num" id="6301586">1024</span><span class="op" id="6301590">]</span><span class="builtintype" id="6301591">byte</span><br>
<span class="lineno"></span><span class="op" id="6301596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6301599">//&nbsp;blockWriter&nbsp;writes&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="6301666">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6301732">//&nbsp;writer&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;encoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6301796">//&nbsp;blocking.</span><br>
<span class="lineno"></span><span class="keyword" id="6301809">type</span>&nbsp;<span class="ident" id="6301814">blockWriter</span>&nbsp;<span class="keyword" id="6301826">struct</span>&nbsp;<span class="op" id="6301833">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301836">e</span>&nbsp;<span class="op" id="6301838">*</span><span class="ident" id="6301839">encoder</span><br>
<span class="lineno"></span><span class="op" id="6301847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6301850">func</span>&nbsp;<span class="op" id="6301855">(</span><span class="ident" id="6301856">b</span>&nbsp;<span class="ident" id="6301858">blockWriter</span><span class="op" id="6301869">)</span>&nbsp;<span class="ident" id="6301871">Write</span><span class="op" id="6301876">(</span><span class="ident" id="6301877">data</span>&nbsp;<span class="op" id="6301882">[</span><span class="op" id="6301883">]</span><span class="builtintype" id="6301884">byte</span><span class="op" id="6301888">)</span>&nbsp;<span class="op" id="6301890">(</span><span class="builtintype" id="6301891">int</span><span class="op" id="6301894">,</span>&nbsp;<span class="builtintype" id="6301896">error</span><span class="op" id="6301901">)</span>&nbsp;<span class="op" id="6301903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301906">if</span>&nbsp;<span class="ident" id="6301909">b</span><span class="op" id="6301910">.</span><span class="ident" id="6301911">e</span><span class="op" id="6301912">.</span><span class="ident" id="6301913">err</span>&nbsp;<span class="op" id="6301917">!=</span>&nbsp;<span class="ident" id="6301920">nil</span>&nbsp;<span class="op" id="6301924">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301928">return</span>&nbsp;<span class="num" id="6301935">0</span><span class="op" id="6301936">,</span>&nbsp;<span class="ident" id="6301938">b</span><span class="op" id="6301939">.</span><span class="ident" id="6301940">e</span><span class="op" id="6301941">.</span><span class="ident" id="6301942">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301950">if</span>&nbsp;<span class="builtinfunc" id="6301953">len</span><span class="op" id="6301956">(</span><span class="ident" id="6301957">data</span><span class="op" id="6301961">)</span>&nbsp;<span class="op" id="6301963">==</span>&nbsp;<span class="num" id="6301966">0</span>&nbsp;<span class="op" id="6301968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301972">return</span>&nbsp;<span class="num" id="6301979">0</span><span class="op" id="6301980">,</span>&nbsp;<span class="ident" id="6301982">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301987">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301990">total</span>&nbsp;<span class="op" id="6301996">:=</span>&nbsp;<span class="num" id="6301999">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302002">for</span>&nbsp;<span class="ident" id="6302006">total</span>&nbsp;<span class="op" id="6302012">&lt;</span>&nbsp;<span class="builtinfunc" id="6302014">len</span><span class="op" id="6302017">(</span><span class="ident" id="6302018">data</span><span class="op" id="6302022">)</span>&nbsp;<span class="op" id="6302024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302028">n</span>&nbsp;<span class="op" id="6302030">:=</span>&nbsp;<span class="builtinfunc" id="6302033">copy</span><span class="op" id="6302037">(</span><span class="ident" id="6302038">b</span><span class="op" id="6302039">.</span><span class="ident" id="6302040">e</span><span class="op" id="6302041">.</span><span class="ident" id="6302042">buf</span><span class="op" id="6302045">[</span><span class="num" id="6302046">1</span><span class="op" id="6302047">:</span><span class="num" id="6302048">256</span><span class="op" id="6302051">]</span><span class="op" id="6302052">,</span>&nbsp;<span class="ident" id="6302054">data</span><span class="op" id="6302058">[</span><span class="ident" id="6302059">total</span><span class="op" id="6302064">:</span><span class="op" id="6302065">]</span><span class="op" id="6302066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302070">total</span>&nbsp;<span class="op" id="6302076">+=</span>&nbsp;<span class="ident" id="6302079">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302083">b</span><span class="op" id="6302084">.</span><span class="ident" id="6302085">e</span><span class="op" id="6302086">.</span><span class="ident" id="6302087">buf</span><span class="op" id="6302090">[</span><span class="num" id="6302091">0</span><span class="op" id="6302092">]</span>&nbsp;<span class="op" id="6302094">=</span>&nbsp;<span class="builtintype" id="6302096">uint8</span><span class="op" id="6302101">(</span><span class="ident" id="6302102">n</span><span class="op" id="6302103">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302108">n</span><span class="op" id="6302109">,</span>&nbsp;<span class="ident" id="6302111">b</span><span class="op" id="6302112">.</span><span class="ident" id="6302113">e</span><span class="op" id="6302114">.</span><span class="ident" id="6302115">err</span>&nbsp;<span class="op" id="6302119">=</span>&nbsp;<span class="ident" id="6302121">b</span><span class="op" id="6302122">.</span><span class="ident" id="6302123">e</span><span class="op" id="6302124">.</span><span class="ident" id="6302125">w</span><span class="op" id="6302126">.</span><span class="ident" id="6302127">Write</span><span class="op" id="6302132">(</span><span class="ident" id="6302133">b</span><span class="op" id="6302134">.</span><span class="ident" id="6302135">e</span><span class="op" id="6302136">.</span><span class="ident" id="6302137">buf</span><span class="op" id="6302140">[</span><span class="op" id="6302141">:</span><span class="ident" id="6302142">n</span><span class="op" id="6302143">+</span><span class="num" id="6302144">1</span><span class="op" id="6302145">]</span><span class="op" id="6302146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302150">if</span>&nbsp;<span class="ident" id="6302153">b</span><span class="op" id="6302154">.</span><span class="ident" id="6302155">e</span><span class="op" id="6302156">.</span><span class="ident" id="6302157">err</span>&nbsp;<span class="op" id="6302161">!=</span>&nbsp;<span class="ident" id="6302164">nil</span>&nbsp;<span class="op" id="6302168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302173">return</span>&nbsp;<span class="num" id="6302180">0</span><span class="op" id="6302181">,</span>&nbsp;<span class="ident" id="6302183">b</span><span class="op" id="6302184">.</span><span class="ident" id="6302185">e</span><span class="op" id="6302186">.</span><span class="ident" id="6302187">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302193">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302199">return</span>&nbsp;<span class="ident" id="6302206">total</span><span class="op" id="6302211">,</span>&nbsp;<span class="ident" id="6302213">b</span><span class="op" id="6302214">.</span><span class="ident" id="6302215">e</span><span class="op" id="6302216">.</span><span class="ident" id="6302217">err</span><br>
<span class="lineno"></span><span class="op" id="6302221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6302224">func</span>&nbsp;<span class="op" id="6302229">(</span><span class="ident" id="6302230">e</span>&nbsp;<span class="op" id="6302232">*</span><span class="ident" id="6302233">encoder</span><span class="op" id="6302240">)</span>&nbsp;<span class="ident" id="6302242">flush</span><span class="op" id="6302247">(</span><span class="op" id="6302248">)</span>&nbsp;<span class="op" id="6302250">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302253">if</span>&nbsp;<span class="ident" id="6302256">e</span><span class="op" id="6302257">.</span><span class="ident" id="6302258">err</span>&nbsp;<span class="op" id="6302262">!=</span>&nbsp;<span class="ident" id="6302265">nil</span>&nbsp;<span class="op" id="6302269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302273">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302284">e</span><span class="op" id="6302285">.</span><span class="ident" id="6302286">err</span>&nbsp;<span class="op" id="6302290">=</span>&nbsp;<span class="ident" id="6302292">e</span><span class="op" id="6302293">.</span><span class="ident" id="6302294">w</span><span class="op" id="6302295">.</span><span class="ident" id="6302296">Flush</span><span class="op" id="6302301">(</span><span class="op" id="6302302">)</span><br>
<span class="lineno"></span><span class="op" id="6302304">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="6302307">func</span>&nbsp;<span class="op" id="6302312">(</span><span class="ident" id="6302313">e</span>&nbsp;<span class="op" id="6302315">*</span><span class="ident" id="6302316">encoder</span><span class="op" id="6302323">)</span>&nbsp;<span class="ident" id="6302325">write</span><span class="op" id="6302330">(</span><span class="ident" id="6302331">p</span>&nbsp;<span class="op" id="6302333">[</span><span class="op" id="6302334">]</span><span class="builtintype" id="6302335">byte</span><span class="op" id="6302339">)</span>&nbsp;<span class="op" id="6302341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302344">if</span>&nbsp;<span class="ident" id="6302347">e</span><span class="op" id="6302348">.</span><span class="ident" id="6302349">err</span>&nbsp;<span class="op" id="6302353">!=</span>&nbsp;<span class="ident" id="6302356">nil</span>&nbsp;<span class="op" id="6302360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302364">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302372">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302375">_</span><span class="op" id="6302376">,</span>&nbsp;<span class="ident" id="6302378">e</span><span class="op" id="6302379">.</span><span class="ident" id="6302380">err</span>&nbsp;<span class="op" id="6302384">=</span>&nbsp;<span class="ident" id="6302386">e</span><span class="op" id="6302387">.</span><span class="ident" id="6302388">w</span><span class="op" id="6302389">.</span><span class="ident" id="6302390">Write</span><span class="op" id="6302395">(</span><span class="ident" id="6302396">p</span><span class="op" id="6302397">)</span><br>
<span class="lineno"></span><span class="op" id="6302399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6302402">func</span>&nbsp;<span class="op" id="6302407">(</span><span class="ident" id="6302408">e</span>&nbsp;<span class="op" id="6302410">*</span><span class="ident" id="6302411">encoder</span><span class="op" id="6302418">)</span>&nbsp;<span class="ident" id="6302420">writeByte</span><span class="op" id="6302429">(</span><span class="ident" id="6302430">b</span>&nbsp;<span class="builtintype" id="6302432">byte</span><span class="op" id="6302436">)</span>&nbsp;<span class="op" id="6302438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302441">if</span>&nbsp;<span class="ident" id="6302444">e</span><span class="op" id="6302445">.</span><span class="ident" id="6302446">err</span>&nbsp;<span class="op" id="6302450">!=</span>&nbsp;<span class="ident" id="6302453">nil</span>&nbsp;<span class="op" id="6302457">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302461">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302472">e</span><span class="op" id="6302473">.</span><span class="ident" id="6302474">err</span>&nbsp;<span class="op" id="6302478">=</span>&nbsp;<span class="ident" id="6302480">e</span><span class="op" id="6302481">.</span><span class="ident" id="6302482">w</span><span class="op" id="6302483">.</span><span class="ident" id="6302484">WriteByte</span><span class="op" id="6302493">(</span><span class="ident" id="6302494">b</span><span class="op" id="6302495">)</span><br>
<span class="lineno"></span><span class="op" id="6302497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="6302500">func</span>&nbsp;<span class="op" id="6302505">(</span><span class="ident" id="6302506">e</span>&nbsp;<span class="op" id="6302508">*</span><span class="ident" id="6302509">encoder</span><span class="op" id="6302516">)</span>&nbsp;<span class="ident" id="6302518">writeHeader</span><span class="op" id="6302529">(</span><span class="op" id="6302530">)</span>&nbsp;<span class="op" id="6302532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302535">if</span>&nbsp;<span class="ident" id="6302538">e</span><span class="op" id="6302539">.</span><span class="ident" id="6302540">err</span>&nbsp;<span class="op" id="6302544">!=</span>&nbsp;<span class="ident" id="6302547">nil</span>&nbsp;<span class="op" id="6302551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302555">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302566">_</span><span class="op" id="6302567">,</span>&nbsp;<span class="ident" id="6302569">e</span><span class="op" id="6302570">.</span><span class="ident" id="6302571">err</span>&nbsp;<span class="op" id="6302575">=</span>&nbsp;<span class="ident" id="6302577">io</span><span class="op" id="6302579">.</span><span class="ident" id="6302580">WriteString</span><span class="op" id="6302591">(</span><span class="ident" id="6302592">e</span><span class="op" id="6302593">.</span><span class="ident" id="6302594">w</span><span class="op" id="6302595">,</span>&nbsp;<span class="string" id="6302597">&#34;GIF89a&#34;</span><span class="op" id="6302605">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302608">if</span>&nbsp;<span class="ident" id="6302611">e</span><span class="op" id="6302612">.</span><span class="ident" id="6302613">err</span>&nbsp;<span class="op" id="6302617">!=</span>&nbsp;<span class="ident" id="6302620">nil</span>&nbsp;<span class="op" id="6302624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302628">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302640">pm</span>&nbsp;<span class="op" id="6302643">:=</span>&nbsp;<span class="ident" id="6302646">e</span><span class="op" id="6302647">.</span><span class="ident" id="6302648">g</span><span class="op" id="6302649">.</span><span class="ident" id="6302650">Image</span><span class="op" id="6302655">[</span><span class="num" id="6302656">0</span><span class="op" id="6302657">]</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6302660">//&nbsp;Logical&nbsp;screen&nbsp;width&nbsp;and&nbsp;height.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302697">writeUint16</span><span class="op" id="6302708">(</span><span class="ident" id="6302709">e</span><span class="op" id="6302710">.</span><span class="ident" id="6302711">buf</span><span class="op" id="6302714">[</span><span class="num" id="6302715">0</span><span class="op" id="6302716">:</span><span class="num" id="6302717">2</span><span class="op" id="6302718">]</span><span class="op" id="6302719">,</span>&nbsp;<span class="builtintype" id="6302721">uint16</span><span class="op" id="6302727">(</span><span class="ident" id="6302728">pm</span><span class="op" id="6302730">.</span><span class="ident" id="6302731">Bounds</span><span class="op" id="6302737">(</span><span class="op" id="6302738">)</span><span class="op" id="6302739">.</span><span class="ident" id="6302740">Dx</span><span class="op" id="6302742">(</span><span class="op" id="6302743">)</span><span class="op" id="6302744">)</span><span class="op" id="6302745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302748">writeUint16</span><span class="op" id="6302759">(</span><span class="ident" id="6302760">e</span><span class="op" id="6302761">.</span><span class="ident" id="6302762">buf</span><span class="op" id="6302765">[</span><span class="num" id="6302766">2</span><span class="op" id="6302767">:</span><span class="num" id="6302768">4</span><span class="op" id="6302769">]</span><span class="op" id="6302770">,</span>&nbsp;<span class="builtintype" id="6302772">uint16</span><span class="op" id="6302778">(</span><span class="ident" id="6302779">pm</span><span class="op" id="6302781">.</span><span class="ident" id="6302782">Bounds</span><span class="op" id="6302788">(</span><span class="op" id="6302789">)</span><span class="op" id="6302790">.</span><span class="ident" id="6302791">Dy</span><span class="op" id="6302793">(</span><span class="op" id="6302794">)</span><span class="op" id="6302795">)</span><span class="op" id="6302796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302799">e</span><span class="op" id="6302800">.</span><span class="ident" id="6302801">write</span><span class="op" id="6302806">(</span><span class="ident" id="6302807">e</span><span class="op" id="6302808">.</span><span class="ident" id="6302809">buf</span><span class="op" id="6302812">[</span><span class="op" id="6302813">:</span><span class="num" id="6302814">4</span><span class="op" id="6302815">]</span><span class="op" id="6302816">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6302820">//&nbsp;All&nbsp;frames&nbsp;have&nbsp;a&nbsp;local&nbsp;color&nbsp;table,&nbsp;so&nbsp;a&nbsp;global&nbsp;color&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6302885">//&nbsp;is&nbsp;not&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302904">e</span><span class="op" id="6302905">.</span><span class="ident" id="6302906">buf</span><span class="op" id="6302909">[</span><span class="num" id="6302910">0</span><span class="op" id="6302911">]</span>&nbsp;<span class="op" id="6302913">=</span>&nbsp;<span class="num" id="6302915">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302921">e</span><span class="op" id="6302922">.</span><span class="ident" id="6302923">buf</span><span class="op" id="6302926">[</span><span class="num" id="6302927">1</span><span class="op" id="6302928">]</span>&nbsp;<span class="op" id="6302930">=</span>&nbsp;<span class="num" id="6302932">0x00</span>&nbsp;<span class="comment" id="6302937">//&nbsp;Background&nbsp;Color&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302965">e</span><span class="op" id="6302966">.</span><span class="ident" id="6302967">buf</span><span class="op" id="6302970">[</span><span class="num" id="6302971">2</span><span class="op" id="6302972">]</span>&nbsp;<span class="op" id="6302974">=</span>&nbsp;<span class="num" id="6302976">0x00</span>&nbsp;<span class="comment" id="6302981">//&nbsp;Pixel&nbsp;Aspect&nbsp;Ratio.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303005">e</span><span class="op" id="6303006">.</span><span class="ident" id="6303007">write</span><span class="op" id="6303012">(</span><span class="ident" id="6303013">e</span><span class="op" id="6303014">.</span><span class="ident" id="6303015">buf</span><span class="op" id="6303018">[</span><span class="op" id="6303019">:</span><span class="num" id="6303020">3</span><span class="op" id="6303021">]</span><span class="op" id="6303022">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303026">//&nbsp;Add&nbsp;animation&nbsp;info&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6303063">if</span>&nbsp;<span class="builtinfunc" id="6303066">len</span><span class="op" id="6303069">(</span><span class="ident" id="6303070">e</span><span class="op" id="6303071">.</span><span class="ident" id="6303072">g</span><span class="op" id="6303073">.</span><span class="ident" id="6303074">Image</span><span class="op" id="6303079">)</span>&nbsp;<span class="op" id="6303081">&gt;</span>&nbsp;<span class="num" id="6303083">1</span>&nbsp;<span class="op" id="6303085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303089">e</span><span class="op" id="6303090">.</span><span class="ident" id="6303091">buf</span><span class="op" id="6303094">[</span><span class="num" id="6303095">0</span><span class="op" id="6303096">]</span>&nbsp;<span class="op" id="6303098">=</span>&nbsp;<span class="num" id="6303100">0x21</span>&nbsp;<span class="comment" id="6303105">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303132">e</span><span class="op" id="6303133">.</span><span class="ident" id="6303134">buf</span><span class="op" id="6303137">[</span><span class="num" id="6303138">1</span><span class="op" id="6303139">]</span>&nbsp;<span class="op" id="6303141">=</span>&nbsp;<span class="num" id="6303143">0xff</span>&nbsp;<span class="comment" id="6303148">//&nbsp;Application&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303172">e</span><span class="op" id="6303173">.</span><span class="ident" id="6303174">buf</span><span class="op" id="6303177">[</span><span class="num" id="6303178">2</span><span class="op" id="6303179">]</span>&nbsp;<span class="op" id="6303181">=</span>&nbsp;<span class="num" id="6303183">0x0b</span>&nbsp;<span class="comment" id="6303188">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303205">e</span><span class="op" id="6303206">.</span><span class="ident" id="6303207">write</span><span class="op" id="6303212">(</span><span class="ident" id="6303213">e</span><span class="op" id="6303214">.</span><span class="ident" id="6303215">buf</span><span class="op" id="6303218">[</span><span class="op" id="6303219">:</span><span class="num" id="6303220">3</span><span class="op" id="6303221">]</span><span class="op" id="6303222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303226">_</span><span class="op" id="6303227">,</span>&nbsp;<span class="ident" id="6303229">e</span><span class="op" id="6303230">.</span><span class="ident" id="6303231">err</span>&nbsp;<span class="op" id="6303235">=</span>&nbsp;<span class="ident" id="6303237">io</span><span class="op" id="6303239">.</span><span class="ident" id="6303240">WriteString</span><span class="op" id="6303251">(</span><span class="ident" id="6303252">e</span><span class="op" id="6303253">.</span><span class="ident" id="6303254">w</span><span class="op" id="6303255">,</span>&nbsp;<span class="string" id="6303257">&#34;NETSCAPE2.0&#34;</span><span class="op" id="6303270">)</span>&nbsp;<span class="comment" id="6303272">//&nbsp;Application&nbsp;Identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6303301">if</span>&nbsp;<span class="ident" id="6303304">e</span><span class="op" id="6303305">.</span><span class="ident" id="6303306">err</span>&nbsp;<span class="op" id="6303310">!=</span>&nbsp;<span class="ident" id="6303313">nil</span>&nbsp;<span class="op" id="6303317">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6303322">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6303331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303335">e</span><span class="op" id="6303336">.</span><span class="ident" id="6303337">buf</span><span class="op" id="6303340">[</span><span class="num" id="6303341">0</span><span class="op" id="6303342">]</span>&nbsp;<span class="op" id="6303344">=</span>&nbsp;<span class="num" id="6303346">0x03</span>&nbsp;<span class="comment" id="6303351">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303368">e</span><span class="op" id="6303369">.</span><span class="ident" id="6303370">buf</span><span class="op" id="6303373">[</span><span class="num" id="6303374">1</span><span class="op" id="6303375">]</span>&nbsp;<span class="op" id="6303377">=</span>&nbsp;<span class="num" id="6303379">0x01</span>&nbsp;<span class="comment" id="6303384">//&nbsp;Sub-block&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303406">writeUint16</span><span class="op" id="6303417">(</span><span class="ident" id="6303418">e</span><span class="op" id="6303419">.</span><span class="ident" id="6303420">buf</span><span class="op" id="6303423">[</span><span class="num" id="6303424">2</span><span class="op" id="6303425">:</span><span class="num" id="6303426">4</span><span class="op" id="6303427">]</span><span class="op" id="6303428">,</span>&nbsp;<span class="builtintype" id="6303430">uint16</span><span class="op" id="6303436">(</span><span class="ident" id="6303437">e</span><span class="op" id="6303438">.</span><span class="ident" id="6303439">g</span><span class="op" id="6303440">.</span><span class="ident" id="6303441">LoopCount</span><span class="op" id="6303450">)</span><span class="op" id="6303451">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303455">e</span><span class="op" id="6303456">.</span><span class="ident" id="6303457">buf</span><span class="op" id="6303460">[</span><span class="num" id="6303461">4</span><span class="op" id="6303462">]</span>&nbsp;<span class="op" id="6303464">=</span>&nbsp;<span class="num" id="6303466">0x00</span>&nbsp;<span class="comment" id="6303471">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303494">e</span><span class="op" id="6303495">.</span><span class="ident" id="6303496">write</span><span class="op" id="6303501">(</span><span class="ident" id="6303502">e</span><span class="op" id="6303503">.</span><span class="ident" id="6303504">buf</span><span class="op" id="6303507">[</span><span class="op" id="6303508">:</span><span class="num" id="6303509">5</span><span class="op" id="6303510">]</span><span class="op" id="6303511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6303514">}</span><br>
<span class="lineno"></span><span class="op" id="6303516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="keyword" id="6303519">func</span>&nbsp;<span class="op" id="6303524">(</span><span class="ident" id="6303525">e</span>&nbsp;<span class="op" id="6303527">*</span><span class="ident" id="6303528">encoder</span><span class="op" id="6303535">)</span>&nbsp;<span class="ident" id="6303537">writeColorTable</span><span class="op" id="6303552">(</span><span class="ident" id="6303553">p</span>&nbsp;<span class="ident" id="6303555">color</span><span class="op" id="6303560">.</span><span class="ident" id="6303561">Palette</span><span class="op" id="6303568">,</span>&nbsp;<span class="ident" id="6303570">size</span>&nbsp;<span class="builtintype" id="6303575">int</span><span class="op" id="6303578">)</span>&nbsp;<span class="op" id="6303580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6303583">if</span>&nbsp;<span class="ident" id="6303586">e</span><span class="op" id="6303587">.</span><span class="ident" id="6303588">err</span>&nbsp;<span class="op" id="6303592">!=</span>&nbsp;<span class="ident" id="6303595">nil</span>&nbsp;<span class="op" id="6303599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6303603">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6303611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6303615">for</span>&nbsp;<span class="ident" id="6303619">i</span>&nbsp;<span class="op" id="6303621">:=</span>&nbsp;<span class="num" id="6303624">0</span><span class="op" id="6303625">;</span>&nbsp;<span class="ident" id="6303627">i</span>&nbsp;<span class="op" id="6303629">&lt;</span>&nbsp;<span class="ident" id="6303631">log2Lookup</span><span class="op" id="6303641">[</span><span class="ident" id="6303642">size</span><span class="op" id="6303646">]</span><span class="op" id="6303647">;</span>&nbsp;<span class="ident" id="6303649">i</span><span class="op" id="6303650">++</span>&nbsp;<span class="op" id="6303653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6303657">if</span>&nbsp;<span class="ident" id="6303660">i</span>&nbsp;<span class="op" id="6303662">&lt;</span>&nbsp;<span class="builtinfunc" id="6303664">len</span><span class="op" id="6303667">(</span><span class="ident" id="6303668">p</span><span class="op" id="6303669">)</span>&nbsp;<span class="op" id="6303671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303676">r</span><span class="op" id="6303677">,</span>&nbsp;<span class="ident" id="6303679">g</span><span class="op" id="6303680">,</span>&nbsp;<span class="ident" id="6303682">b</span><span class="op" id="6303683">,</span>&nbsp;<span class="ident" id="6303685">_</span>&nbsp;<span class="op" id="6303687">:=</span>&nbsp;<span class="ident" id="6303690">p</span><span class="op" id="6303691">[</span><span class="ident" id="6303692">i</span><span class="op" id="6303693">]</span><span class="op" id="6303694">.</span><span class="ident" id="6303695">RGBA</span><span class="op" id="6303699">(</span><span class="op" id="6303700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303705">e</span><span class="op" id="6303706">.</span><span class="ident" id="6303707">buf</span><span class="op" id="6303710">[</span><span class="num" id="6303711">3</span><span class="op" id="6303712">*</span><span class="ident" id="6303713">i</span><span class="op" id="6303714">+</span><span class="num" id="6303715">0</span><span class="op" id="6303716">]</span>&nbsp;<span class="op" id="6303718">=</span>&nbsp;<span class="builtintype" id="6303720">uint8</span><span class="op" id="6303725">(</span><span class="ident" id="6303726">r</span>&nbsp;<span class="op" id="6303728">&gt;&gt;</span>&nbsp;<span class="num" id="6303731">8</span><span class="op" id="6303732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303737">e</span><span class="op" id="6303738">.</span><span class="ident" id="6303739">buf</span><span class="op" id="6303742">[</span><span class="num" id="6303743">3</span><span class="op" id="6303744">*</span><span class="ident" id="6303745">i</span><span class="op" id="6303746">+</span><span class="num" id="6303747">1</span><span class="op" id="6303748">]</span>&nbsp;<span class="op" id="6303750">=</span>&nbsp;<span class="builtintype" id="6303752">uint8</span><span class="op" id="6303757">(</span><span class="ident" id="6303758">g</span>&nbsp;<span class="op" id="6303760">&gt;&gt;</span>&nbsp;<span class="num" id="6303763">8</span><span class="op" id="6303764">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303769">e</span><span class="op" id="6303770">.</span><span class="ident" id="6303771">buf</span><span class="op" id="6303774">[</span><span class="num" id="6303775">3</span><span class="op" id="6303776">*</span><span class="ident" id="6303777">i</span><span class="op" id="6303778">+</span><span class="num" id="6303779">2</span><span class="op" id="6303780">]</span>&nbsp;<span class="op" id="6303782">=</span>&nbsp;<span class="builtintype" id="6303784">uint8</span><span class="op" id="6303789">(</span><span class="ident" id="6303790">b</span>&nbsp;<span class="op" id="6303792">&gt;&gt;</span>&nbsp;<span class="num" id="6303795">8</span><span class="op" id="6303796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6303800">}</span>&nbsp;<span class="keyword" id="6303802">else</span>&nbsp;<span class="op" id="6303807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6303812">//&nbsp;Pad&nbsp;with&nbsp;black.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303834">e</span><span class="op" id="6303835">.</span><span class="ident" id="6303836">buf</span><span class="op" id="6303839">[</span><span class="num" id="6303840">3</span><span class="op" id="6303841">*</span><span class="ident" id="6303842">i</span><span class="op" id="6303843">+</span><span class="num" id="6303844">0</span><span class="op" id="6303845">]</span>&nbsp;<span class="op" id="6303847">=</span>&nbsp;<span class="num" id="6303849">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303857">e</span><span class="op" id="6303858">.</span><span class="ident" id="6303859">buf</span><span class="op" id="6303862">[</span><span class="num" id="6303863">3</span><span class="op" id="6303864">*</span><span class="ident" id="6303865">i</span><span class="op" id="6303866">+</span><span class="num" id="6303867">1</span><span class="op" id="6303868">]</span>&nbsp;<span class="op" id="6303870">=</span>&nbsp;<span class="num" id="6303872">0x00</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303880">e</span><span class="op" id="6303881">.</span><span class="ident" id="6303882">buf</span><span class="op" id="6303885">[</span><span class="num" id="6303886">3</span><span class="op" id="6303887">*</span><span class="ident" id="6303888">i</span><span class="op" id="6303889">+</span><span class="num" id="6303890">2</span><span class="op" id="6303891">]</span>&nbsp;<span class="op" id="6303893">=</span>&nbsp;<span class="num" id="6303895">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6303902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6303905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303908">e</span><span class="op" id="6303909">.</span><span class="ident" id="6303910">write</span><span class="op" id="6303915">(</span><span class="ident" id="6303916">e</span><span class="op" id="6303917">.</span><span class="ident" id="6303918">buf</span><span class="op" id="6303921">[</span><span class="op" id="6303922">:</span><span class="num" id="6303923">3</span><span class="op" id="6303924">*</span><span class="ident" id="6303925">log2Lookup</span><span class="op" id="6303935">[</span><span class="ident" id="6303936">size</span><span class="op" id="6303940">]</span><span class="op" id="6303941">]</span><span class="op" id="6303942">)</span><br>
<span class="lineno"></span><span class="op" id="6303944">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="6303947">func</span>&nbsp;<span class="op" id="6303952">(</span><span class="ident" id="6303953">e</span>&nbsp;<span class="op" id="6303955">*</span><span class="ident" id="6303956">encoder</span><span class="op" id="6303963">)</span>&nbsp;<span class="ident" id="6303965">writeImageBlock</span><span class="op" id="6303980">(</span><span class="ident" id="6303981">pm</span>&nbsp;<span class="op" id="6303984">*</span><span class="ident" id="6303985">image</span><span class="op" id="6303990">.</span><span class="ident" id="6303991">Paletted</span><span class="op" id="6303999">,</span>&nbsp;<span class="ident" id="6304001">delay</span>&nbsp;<span class="builtintype" id="6304007">int</span><span class="op" id="6304010">)</span>&nbsp;<span class="op" id="6304012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304015">if</span>&nbsp;<span class="ident" id="6304018">e</span><span class="op" id="6304019">.</span><span class="ident" id="6304020">err</span>&nbsp;<span class="op" id="6304024">!=</span>&nbsp;<span class="ident" id="6304027">nil</span>&nbsp;<span class="op" id="6304031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304035">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304043">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304047">if</span>&nbsp;<span class="builtinfunc" id="6304050">len</span><span class="op" id="6304053">(</span><span class="ident" id="6304054">pm</span><span class="op" id="6304056">.</span><span class="ident" id="6304057">Palette</span><span class="op" id="6304064">)</span>&nbsp;<span class="op" id="6304066">==</span>&nbsp;<span class="num" id="6304069">0</span>&nbsp;<span class="op" id="6304071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304075">e</span><span class="op" id="6304076">.</span><span class="ident" id="6304077">err</span>&nbsp;<span class="op" id="6304081">=</span>&nbsp;<span class="ident" id="6304083">errors</span><span class="op" id="6304089">.</span><span class="ident" id="6304090">New</span><span class="op" id="6304093">(</span><span class="string" id="6304094">&#34;gif:&nbsp;cannot&nbsp;encode&nbsp;image&nbsp;block&nbsp;with&nbsp;empty&nbsp;palette&#34;</span><span class="op" id="6304145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304149">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304157">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304161">b</span>&nbsp;<span class="op" id="6304163">:=</span>&nbsp;<span class="ident" id="6304166">pm</span><span class="op" id="6304168">.</span><span class="ident" id="6304169">Bounds</span><span class="op" id="6304175">(</span><span class="op" id="6304176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304179">if</span>&nbsp;<span class="ident" id="6304182">b</span><span class="op" id="6304183">.</span><span class="ident" id="6304184">Dx</span><span class="op" id="6304186">(</span><span class="op" id="6304187">)</span>&nbsp;<span class="op" id="6304189">&gt;=</span>&nbsp;<span class="num" id="6304192">1</span><span class="op" id="6304193">&lt;&lt;</span><span class="num" id="6304195">16</span>&nbsp;<span class="op" id="6304198">||</span>&nbsp;<span class="ident" id="6304201">b</span><span class="op" id="6304202">.</span><span class="ident" id="6304203">Dy</span><span class="op" id="6304205">(</span><span class="op" id="6304206">)</span>&nbsp;<span class="op" id="6304208">&gt;=</span>&nbsp;<span class="num" id="6304211">1</span><span class="op" id="6304212">&lt;&lt;</span><span class="num" id="6304214">16</span>&nbsp;<span class="op" id="6304217">||</span>&nbsp;<span class="ident" id="6304220">b</span><span class="op" id="6304221">.</span><span class="ident" id="6304222">Min</span><span class="op" id="6304225">.</span><span class="ident" id="6304226">X</span>&nbsp;<span class="op" id="6304228">&lt;</span>&nbsp;<span class="num" id="6304230">0</span>&nbsp;<span class="op" id="6304232">||</span>&nbsp;<span class="ident" id="6304235">b</span><span class="op" id="6304236">.</span><span class="ident" id="6304237">Min</span><span class="op" id="6304240">.</span><span class="ident" id="6304241">X</span>&nbsp;<span class="op" id="6304243">&gt;=</span>&nbsp;<span class="num" id="6304246">1</span><span class="op" id="6304247">&lt;&lt;</span><span class="num" id="6304249">16</span>&nbsp;<span class="op" id="6304252">||</span>&nbsp;<span class="ident" id="6304255">b</span><span class="op" id="6304256">.</span><span class="ident" id="6304257">Min</span><span class="op" id="6304260">.</span><span class="ident" id="6304261">Y</span>&nbsp;<span class="op" id="6304263">&lt;</span>&nbsp;<span class="num" id="6304265">0</span>&nbsp;<span class="op" id="6304267">||</span>&nbsp;<span class="ident" id="6304270">b</span><span class="op" id="6304271">.</span><span class="ident" id="6304272">Min</span><span class="op" id="6304275">.</span><span class="ident" id="6304276">Y</span>&nbsp;<span class="op" id="6304278">&gt;=</span>&nbsp;<span class="num" id="6304281">1</span><span class="op" id="6304282">&lt;&lt;</span><span class="num" id="6304284">16</span>&nbsp;<span class="op" id="6304287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304291">e</span><span class="op" id="6304292">.</span><span class="ident" id="6304293">err</span>&nbsp;<span class="op" id="6304297">=</span>&nbsp;<span class="ident" id="6304299">errors</span><span class="op" id="6304305">.</span><span class="ident" id="6304306">New</span><span class="op" id="6304309">(</span><span class="string" id="6304310">&#34;gif:&nbsp;image&nbsp;block&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6304351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304355">return</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304367">transparentIndex</span>&nbsp;<span class="op" id="6304384">:=</span>&nbsp;<span class="op" id="6304387">-</span><span class="num" id="6304388">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304391">for</span>&nbsp;<span class="ident" id="6304395">i</span><span class="op" id="6304396">,</span>&nbsp;<span class="ident" id="6304398">c</span>&nbsp;<span class="op" id="6304400">:=</span>&nbsp;<span class="keyword" id="6304403">range</span>&nbsp;<span class="ident" id="6304409">pm</span><span class="op" id="6304411">.</span><span class="ident" id="6304412">Palette</span>&nbsp;<span class="op" id="6304420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304424">if</span>&nbsp;<span class="ident" id="6304427">_</span><span class="op" id="6304428">,</span>&nbsp;<span class="ident" id="6304430">_</span><span class="op" id="6304431">,</span>&nbsp;<span class="ident" id="6304433">_</span><span class="op" id="6304434">,</span>&nbsp;<span class="ident" id="6304436">a</span>&nbsp;<span class="op" id="6304438">:=</span>&nbsp;<span class="ident" id="6304441">c</span><span class="op" id="6304442">.</span><span class="ident" id="6304443">RGBA</span><span class="op" id="6304447">(</span><span class="op" id="6304448">)</span><span class="op" id="6304449">;</span>&nbsp;<span class="ident" id="6304451">a</span>&nbsp;<span class="op" id="6304453">==</span>&nbsp;<span class="num" id="6304456">0</span>&nbsp;<span class="op" id="6304458">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304463">transparentIndex</span>&nbsp;<span class="op" id="6304480">=</span>&nbsp;<span class="ident" id="6304482">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304487">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304502">if</span>&nbsp;<span class="ident" id="6304505">delay</span>&nbsp;<span class="op" id="6304511">&gt;</span>&nbsp;<span class="num" id="6304513">0</span>&nbsp;<span class="op" id="6304515">||</span>&nbsp;<span class="ident" id="6304518">transparentIndex</span>&nbsp;<span class="op" id="6304535">!=</span>&nbsp;<span class="op" id="6304538">-</span><span class="num" id="6304539">1</span>&nbsp;<span class="op" id="6304541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304545">e</span><span class="op" id="6304546">.</span><span class="ident" id="6304547">buf</span><span class="op" id="6304550">[</span><span class="num" id="6304551">0</span><span class="op" id="6304552">]</span>&nbsp;<span class="op" id="6304554">=</span>&nbsp;<span class="ident" id="6304556">sExtension</span>&nbsp;&nbsp;<span class="comment" id="6304568">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304595">e</span><span class="op" id="6304596">.</span><span class="ident" id="6304597">buf</span><span class="op" id="6304600">[</span><span class="num" id="6304601">1</span><span class="op" id="6304602">]</span>&nbsp;<span class="op" id="6304604">=</span>&nbsp;<span class="ident" id="6304606">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6304618">//&nbsp;Graphic&nbsp;Control&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304646">e</span><span class="op" id="6304647">.</span><span class="ident" id="6304648">buf</span><span class="op" id="6304651">[</span><span class="num" id="6304652">2</span><span class="op" id="6304653">]</span>&nbsp;<span class="op" id="6304655">=</span>&nbsp;<span class="ident" id="6304657">gcBlockSize</span>&nbsp;<span class="comment" id="6304669">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304686">if</span>&nbsp;<span class="ident" id="6304689">transparentIndex</span>&nbsp;<span class="op" id="6304706">!=</span>&nbsp;<span class="op" id="6304709">-</span><span class="num" id="6304710">1</span>&nbsp;<span class="op" id="6304712">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304717">e</span><span class="op" id="6304718">.</span><span class="ident" id="6304719">buf</span><span class="op" id="6304722">[</span><span class="num" id="6304723">3</span><span class="op" id="6304724">]</span>&nbsp;<span class="op" id="6304726">=</span>&nbsp;<span class="num" id="6304728">0x01</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304735">}</span>&nbsp;<span class="keyword" id="6304737">else</span>&nbsp;<span class="op" id="6304742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304747">e</span><span class="op" id="6304748">.</span><span class="ident" id="6304749">buf</span><span class="op" id="6304752">[</span><span class="num" id="6304753">3</span><span class="op" id="6304754">]</span>&nbsp;<span class="op" id="6304756">=</span>&nbsp;<span class="num" id="6304758">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304769">writeUint16</span><span class="op" id="6304780">(</span><span class="ident" id="6304781">e</span><span class="op" id="6304782">.</span><span class="ident" id="6304783">buf</span><span class="op" id="6304786">[</span><span class="num" id="6304787">4</span><span class="op" id="6304788">:</span><span class="num" id="6304789">6</span><span class="op" id="6304790">]</span><span class="op" id="6304791">,</span>&nbsp;<span class="builtintype" id="6304793">uint16</span><span class="op" id="6304799">(</span><span class="ident" id="6304800">delay</span><span class="op" id="6304805">)</span><span class="op" id="6304806">)</span>&nbsp;<span class="comment" id="6304808">//&nbsp;Delay&nbsp;Time&nbsp;(1/100ths&nbsp;of&nbsp;a&nbsp;second)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6304848">//&nbsp;Transparent&nbsp;color&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6304878">if</span>&nbsp;<span class="ident" id="6304881">transparentIndex</span>&nbsp;<span class="op" id="6304898">!=</span>&nbsp;<span class="op" id="6304901">-</span><span class="num" id="6304902">1</span>&nbsp;<span class="op" id="6304904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304909">e</span><span class="op" id="6304910">.</span><span class="ident" id="6304911">buf</span><span class="op" id="6304914">[</span><span class="num" id="6304915">6</span><span class="op" id="6304916">]</span>&nbsp;<span class="op" id="6304918">=</span>&nbsp;<span class="builtintype" id="6304920">uint8</span><span class="op" id="6304925">(</span><span class="ident" id="6304926">transparentIndex</span><span class="op" id="6304942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304946">}</span>&nbsp;<span class="keyword" id="6304948">else</span>&nbsp;<span class="op" id="6304953">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304958">e</span><span class="op" id="6304959">.</span><span class="ident" id="6304960">buf</span><span class="op" id="6304963">[</span><span class="num" id="6304964">6</span><span class="op" id="6304965">]</span>&nbsp;<span class="op" id="6304967">=</span>&nbsp;<span class="num" id="6304969">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6304976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6304980">e</span><span class="op" id="6304981">.</span><span class="ident" id="6304982">buf</span><span class="op" id="6304985">[</span><span class="num" id="6304986">7</span><span class="op" id="6304987">]</span>&nbsp;<span class="op" id="6304989">=</span>&nbsp;<span class="num" id="6304991">0x00</span>&nbsp;<span class="comment" id="6304996">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305019">e</span><span class="op" id="6305020">.</span><span class="ident" id="6305021">write</span><span class="op" id="6305026">(</span><span class="ident" id="6305027">e</span><span class="op" id="6305028">.</span><span class="ident" id="6305029">buf</span><span class="op" id="6305032">[</span><span class="op" id="6305033">:</span><span class="num" id="6305034">8</span><span class="op" id="6305035">]</span><span class="op" id="6305036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305039">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305042">e</span><span class="op" id="6305043">.</span><span class="ident" id="6305044">buf</span><span class="op" id="6305047">[</span><span class="num" id="6305048">0</span><span class="op" id="6305049">]</span>&nbsp;<span class="op" id="6305051">=</span>&nbsp;<span class="ident" id="6305053">sImageDescriptor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305071">writeUint16</span><span class="op" id="6305082">(</span><span class="ident" id="6305083">e</span><span class="op" id="6305084">.</span><span class="ident" id="6305085">buf</span><span class="op" id="6305088">[</span><span class="num" id="6305089">1</span><span class="op" id="6305090">:</span><span class="num" id="6305091">3</span><span class="op" id="6305092">]</span><span class="op" id="6305093">,</span>&nbsp;<span class="builtintype" id="6305095">uint16</span><span class="op" id="6305101">(</span><span class="ident" id="6305102">b</span><span class="op" id="6305103">.</span><span class="ident" id="6305104">Min</span><span class="op" id="6305107">.</span><span class="ident" id="6305108">X</span><span class="op" id="6305109">)</span><span class="op" id="6305110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305113">writeUint16</span><span class="op" id="6305124">(</span><span class="ident" id="6305125">e</span><span class="op" id="6305126">.</span><span class="ident" id="6305127">buf</span><span class="op" id="6305130">[</span><span class="num" id="6305131">3</span><span class="op" id="6305132">:</span><span class="num" id="6305133">5</span><span class="op" id="6305134">]</span><span class="op" id="6305135">,</span>&nbsp;<span class="builtintype" id="6305137">uint16</span><span class="op" id="6305143">(</span><span class="ident" id="6305144">b</span><span class="op" id="6305145">.</span><span class="ident" id="6305146">Min</span><span class="op" id="6305149">.</span><span class="ident" id="6305150">Y</span><span class="op" id="6305151">)</span><span class="op" id="6305152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305155">writeUint16</span><span class="op" id="6305166">(</span><span class="ident" id="6305167">e</span><span class="op" id="6305168">.</span><span class="ident" id="6305169">buf</span><span class="op" id="6305172">[</span><span class="num" id="6305173">5</span><span class="op" id="6305174">:</span><span class="num" id="6305175">7</span><span class="op" id="6305176">]</span><span class="op" id="6305177">,</span>&nbsp;<span class="builtintype" id="6305179">uint16</span><span class="op" id="6305185">(</span><span class="ident" id="6305186">b</span><span class="op" id="6305187">.</span><span class="ident" id="6305188">Dx</span><span class="op" id="6305190">(</span><span class="op" id="6305191">)</span><span class="op" id="6305192">)</span><span class="op" id="6305193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305196">writeUint16</span><span class="op" id="6305207">(</span><span class="ident" id="6305208">e</span><span class="op" id="6305209">.</span><span class="ident" id="6305210">buf</span><span class="op" id="6305213">[</span><span class="num" id="6305214">7</span><span class="op" id="6305215">:</span><span class="num" id="6305216">9</span><span class="op" id="6305217">]</span><span class="op" id="6305218">,</span>&nbsp;<span class="builtintype" id="6305220">uint16</span><span class="op" id="6305226">(</span><span class="ident" id="6305227">b</span><span class="op" id="6305228">.</span><span class="ident" id="6305229">Dy</span><span class="op" id="6305231">(</span><span class="op" id="6305232">)</span><span class="op" id="6305233">)</span><span class="op" id="6305234">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305237">e</span><span class="op" id="6305238">.</span><span class="ident" id="6305239">write</span><span class="op" id="6305244">(</span><span class="ident" id="6305245">e</span><span class="op" id="6305246">.</span><span class="ident" id="6305247">buf</span><span class="op" id="6305250">[</span><span class="op" id="6305251">:</span><span class="num" id="6305252">9</span><span class="op" id="6305253">]</span><span class="op" id="6305254">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305258">paddedSize</span>&nbsp;<span class="op" id="6305269">:=</span>&nbsp;<span class="ident" id="6305272">log2</span><span class="op" id="6305276">(</span><span class="builtinfunc" id="6305277">len</span><span class="op" id="6305280">(</span><span class="ident" id="6305281">pm</span><span class="op" id="6305283">.</span><span class="ident" id="6305284">Palette</span><span class="op" id="6305291">)</span><span class="op" id="6305292">)</span>&nbsp;<span class="comment" id="6305294">//&nbsp;Size&nbsp;of&nbsp;Local&nbsp;Color&nbsp;Table:&nbsp;2^(1+n).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6305334">//&nbsp;Interlacing&nbsp;is&nbsp;not&nbsp;supported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305368">e</span><span class="op" id="6305369">.</span><span class="ident" id="6305370">writeByte</span><span class="op" id="6305379">(</span><span class="num" id="6305380">0x80</span>&nbsp;<span class="op" id="6305385">|</span>&nbsp;<span class="builtintype" id="6305387">uint8</span><span class="op" id="6305392">(</span><span class="ident" id="6305393">paddedSize</span><span class="op" id="6305403">)</span><span class="op" id="6305404">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6305408">//&nbsp;Local&nbsp;Color&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305431">e</span><span class="op" id="6305432">.</span><span class="ident" id="6305433">writeColorTable</span><span class="op" id="6305448">(</span><span class="ident" id="6305449">pm</span><span class="op" id="6305451">.</span><span class="ident" id="6305452">Palette</span><span class="op" id="6305459">,</span>&nbsp;<span class="ident" id="6305461">paddedSize</span><span class="op" id="6305471">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305475">litWidth</span>&nbsp;<span class="op" id="6305484">:=</span>&nbsp;<span class="ident" id="6305487">paddedSize</span>&nbsp;<span class="op" id="6305498">+</span>&nbsp;<span class="num" id="6305500">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305503">if</span>&nbsp;<span class="ident" id="6305506">litWidth</span>&nbsp;<span class="op" id="6305515">&lt;</span>&nbsp;<span class="num" id="6305517">2</span>&nbsp;<span class="op" id="6305519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305523">litWidth</span>&nbsp;<span class="op" id="6305532">=</span>&nbsp;<span class="num" id="6305534">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305540">e</span><span class="op" id="6305541">.</span><span class="ident" id="6305542">writeByte</span><span class="op" id="6305551">(</span><span class="builtintype" id="6305552">uint8</span><span class="op" id="6305557">(</span><span class="ident" id="6305558">litWidth</span><span class="op" id="6305566">)</span><span class="op" id="6305567">)</span>&nbsp;<span class="comment" id="6305569">//&nbsp;LZW&nbsp;Minimum&nbsp;Code&nbsp;Size.</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305597">lzww</span>&nbsp;<span class="op" id="6305602">:=</span>&nbsp;<span class="ident" id="6305605">lzw</span><span class="op" id="6305608">.</span><span class="ident" id="6305609">NewWriter</span><span class="op" id="6305618">(</span><span class="ident" id="6305619">blockWriter</span><span class="op" id="6305630">{</span><span class="ident" id="6305631">e</span><span class="op" id="6305632">:</span>&nbsp;<span class="ident" id="6305634">e</span><span class="op" id="6305635">}</span><span class="op" id="6305636">,</span>&nbsp;<span class="ident" id="6305638">lzw</span><span class="op" id="6305641">.</span><span class="ident" id="6305642">LSB</span><span class="op" id="6305645">,</span>&nbsp;<span class="ident" id="6305647">litWidth</span><span class="op" id="6305655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305658">if</span>&nbsp;<span class="ident" id="6305661">dx</span>&nbsp;<span class="op" id="6305664">:=</span>&nbsp;<span class="ident" id="6305667">b</span><span class="op" id="6305668">.</span><span class="ident" id="6305669">Dx</span><span class="op" id="6305671">(</span><span class="op" id="6305672">)</span><span class="op" id="6305673">;</span>&nbsp;<span class="ident" id="6305675">dx</span>&nbsp;<span class="op" id="6305678">==</span>&nbsp;<span class="ident" id="6305681">pm</span><span class="op" id="6305683">.</span><span class="ident" id="6305684">Stride</span>&nbsp;<span class="op" id="6305691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305695">_</span><span class="op" id="6305696">,</span>&nbsp;<span class="ident" id="6305698">e</span><span class="op" id="6305699">.</span><span class="ident" id="6305700">err</span>&nbsp;<span class="op" id="6305704">=</span>&nbsp;<span class="ident" id="6305706">lzww</span><span class="op" id="6305710">.</span><span class="ident" id="6305711">Write</span><span class="op" id="6305716">(</span><span class="ident" id="6305717">pm</span><span class="op" id="6305719">.</span><span class="ident" id="6305720">Pix</span><span class="op" id="6305723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305727">if</span>&nbsp;<span class="ident" id="6305730">e</span><span class="op" id="6305731">.</span><span class="ident" id="6305732">err</span>&nbsp;<span class="op" id="6305736">!=</span>&nbsp;<span class="ident" id="6305739">nil</span>&nbsp;<span class="op" id="6305743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305748">lzww</span><span class="op" id="6305752">.</span><span class="ident" id="6305753">Close</span><span class="op" id="6305758">(</span><span class="op" id="6305759">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305764">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305776">}</span>&nbsp;<span class="keyword" id="6305778">else</span>&nbsp;<span class="op" id="6305783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305787">for</span>&nbsp;<span class="ident" id="6305791">i</span><span class="op" id="6305792">,</span>&nbsp;<span class="ident" id="6305794">y</span>&nbsp;<span class="op" id="6305796">:=</span>&nbsp;<span class="num" id="6305799">0</span><span class="op" id="6305800">,</span>&nbsp;<span class="ident" id="6305802">b</span><span class="op" id="6305803">.</span><span class="ident" id="6305804">Min</span><span class="op" id="6305807">.</span><span class="ident" id="6305808">Y</span><span class="op" id="6305809">;</span>&nbsp;<span class="ident" id="6305811">y</span>&nbsp;<span class="op" id="6305813">&lt;</span>&nbsp;<span class="ident" id="6305815">b</span><span class="op" id="6305816">.</span><span class="ident" id="6305817">Max</span><span class="op" id="6305820">.</span><span class="ident" id="6305821">Y</span><span class="op" id="6305822">;</span>&nbsp;<span class="ident" id="6305824">i</span><span class="op" id="6305825">,</span>&nbsp;<span class="ident" id="6305827">y</span>&nbsp;<span class="op" id="6305829">=</span>&nbsp;<span class="ident" id="6305831">i</span><span class="op" id="6305832">+</span><span class="ident" id="6305833">pm</span><span class="op" id="6305835">.</span><span class="ident" id="6305836">Stride</span><span class="op" id="6305842">,</span>&nbsp;<span class="ident" id="6305844">y</span><span class="op" id="6305845">+</span><span class="num" id="6305846">1</span>&nbsp;<span class="op" id="6305848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305853">_</span><span class="op" id="6305854">,</span>&nbsp;<span class="ident" id="6305856">e</span><span class="op" id="6305857">.</span><span class="ident" id="6305858">err</span>&nbsp;<span class="op" id="6305862">=</span>&nbsp;<span class="ident" id="6305864">lzww</span><span class="op" id="6305868">.</span><span class="ident" id="6305869">Write</span><span class="op" id="6305874">(</span><span class="ident" id="6305875">pm</span><span class="op" id="6305877">.</span><span class="ident" id="6305878">Pix</span><span class="op" id="6305881">[</span><span class="ident" id="6305882">i</span>&nbsp;<span class="op" id="6305884">:</span>&nbsp;<span class="ident" id="6305886">i</span><span class="op" id="6305887">+</span><span class="ident" id="6305888">dx</span><span class="op" id="6305890">]</span><span class="op" id="6305891">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305896">if</span>&nbsp;<span class="ident" id="6305899">e</span><span class="op" id="6305900">.</span><span class="ident" id="6305901">err</span>&nbsp;<span class="op" id="6305905">!=</span>&nbsp;<span class="ident" id="6305908">nil</span>&nbsp;<span class="op" id="6305912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305918">lzww</span><span class="op" id="6305922">.</span><span class="ident" id="6305923">Close</span><span class="op" id="6305928">(</span><span class="op" id="6305929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305935">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305949">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305955">lzww</span><span class="op" id="6305959">.</span><span class="ident" id="6305960">Close</span><span class="op" id="6305965">(</span><span class="op" id="6305966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305969">e</span><span class="op" id="6305970">.</span><span class="ident" id="6305971">writeByte</span><span class="op" id="6305980">(</span><span class="num" id="6305981">0x00</span><span class="op" id="6305985">)</span>&nbsp;<span class="comment" id="6305987">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span><span class="op" id="6306008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="6306011">//&nbsp;Options&nbsp;are&nbsp;the&nbsp;encoding&nbsp;parameters.</span><br>
<span class="lineno"></span><span class="keyword" id="6306051">type</span>&nbsp;<span class="ident" id="6306056">Options</span>&nbsp;<span class="keyword" id="6306064">struct</span>&nbsp;<span class="op" id="6306071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6306074">//&nbsp;NumColors&nbsp;is&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;colors&nbsp;used&nbsp;in&nbsp;the&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6306139">//&nbsp;It&nbsp;ranges&nbsp;from&nbsp;1&nbsp;to&nbsp;256.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306168">NumColors</span>&nbsp;<span class="builtintype" id="6306178">int</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6306184">//&nbsp;Quantizer&nbsp;is&nbsp;used&nbsp;to&nbsp;produce&nbsp;a&nbsp;palette&nbsp;with&nbsp;size&nbsp;NumColors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6306248">//&nbsp;palette.Plan9&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Quantizer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306303">Quantizer</span>&nbsp;<span class="ident" id="6306313">draw</span><span class="op" id="6306317">.</span><span class="ident" id="6306318">Quantizer</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6306330">//&nbsp;Drawer&nbsp;is&nbsp;used&nbsp;to&nbsp;convert&nbsp;the&nbsp;source&nbsp;image&nbsp;to&nbsp;the&nbsp;desired&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6306401">//&nbsp;draw.FloydSteinberg&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Drawer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306459">Drawer</span>&nbsp;<span class="ident" id="6306466">draw</span><span class="op" id="6306470">.</span><span class="ident" id="6306471">Drawer</span><br>
<span class="lineno"></span><span class="op" id="6306478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6306481">//&nbsp;EncodeAll&nbsp;writes&nbsp;the&nbsp;images&nbsp;in&nbsp;g&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6306545">//&nbsp;given&nbsp;loop&nbsp;count&nbsp;and&nbsp;delay&nbsp;between&nbsp;frames.</span><br>
<span class="lineno"></span><span class="keyword" id="6306591">func</span>&nbsp;<span class="ident" id="6306596">EncodeAll</span><span class="op" id="6306605">(</span><span class="ident" id="6306606">w</span>&nbsp;<span class="ident" id="6306608">io</span><span class="op" id="6306610">.</span><span class="ident" id="6306611">Writer</span><span class="op" id="6306617">,</span>&nbsp;<span class="ident" id="6306619">g</span>&nbsp;<span class="op" id="6306621">*</span><span class="ident" id="6306622">GIF</span><span class="op" id="6306625">)</span>&nbsp;<span class="builtintype" id="6306627">error</span>&nbsp;<span class="op" id="6306633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306636">if</span>&nbsp;<span class="builtinfunc" id="6306639">len</span><span class="op" id="6306642">(</span><span class="ident" id="6306643">g</span><span class="op" id="6306644">.</span><span class="ident" id="6306645">Image</span><span class="op" id="6306650">)</span>&nbsp;<span class="op" id="6306652">==</span>&nbsp;<span class="num" id="6306655">0</span>&nbsp;<span class="op" id="6306657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306661">return</span>&nbsp;<span class="ident" id="6306668">errors</span><span class="op" id="6306674">.</span><span class="ident" id="6306675">New</span><span class="op" id="6306678">(</span><span class="string" id="6306679">&#34;gif:&nbsp;must&nbsp;provide&nbsp;at&nbsp;least&nbsp;one&nbsp;image&#34;</span><span class="op" id="6306717">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306724">if</span>&nbsp;<span class="builtinfunc" id="6306727">len</span><span class="op" id="6306730">(</span><span class="ident" id="6306731">g</span><span class="op" id="6306732">.</span><span class="ident" id="6306733">Image</span><span class="op" id="6306738">)</span>&nbsp;<span class="op" id="6306740">!=</span>&nbsp;<span class="builtinfunc" id="6306743">len</span><span class="op" id="6306746">(</span><span class="ident" id="6306747">g</span><span class="op" id="6306748">.</span><span class="ident" id="6306749">Delay</span><span class="op" id="6306754">)</span>&nbsp;<span class="op" id="6306756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306760">return</span>&nbsp;<span class="ident" id="6306767">errors</span><span class="op" id="6306773">.</span><span class="ident" id="6306774">New</span><span class="op" id="6306777">(</span><span class="string" id="6306778">&#34;gif:&nbsp;mismatched&nbsp;image&nbsp;and&nbsp;delay&nbsp;lengths&#34;</span><span class="op" id="6306819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306822">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306825">if</span>&nbsp;<span class="ident" id="6306828">g</span><span class="op" id="6306829">.</span><span class="ident" id="6306830">LoopCount</span>&nbsp;<span class="op" id="6306840">&lt;</span>&nbsp;<span class="num" id="6306842">0</span>&nbsp;<span class="op" id="6306844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306848">g</span><span class="op" id="6306849">.</span><span class="ident" id="6306850">LoopCount</span>&nbsp;<span class="op" id="6306860">=</span>&nbsp;<span class="num" id="6306862">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306869">e</span>&nbsp;<span class="op" id="6306871">:=</span>&nbsp;<span class="ident" id="6306874">encoder</span><span class="op" id="6306881">{</span><span class="ident" id="6306882">g</span><span class="op" id="6306883">:</span>&nbsp;<span class="ident" id="6306885">g</span><span class="op" id="6306886">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306889">if</span>&nbsp;<span class="ident" id="6306892">ww</span><span class="op" id="6306894">,</span>&nbsp;<span class="ident" id="6306896">ok</span>&nbsp;<span class="op" id="6306899">:=</span>&nbsp;<span class="ident" id="6306902">w</span><span class="op" id="6306903">.</span><span class="op" id="6306904">(</span><span class="ident" id="6306905">writer</span><span class="op" id="6306911">)</span><span class="op" id="6306912">;</span>&nbsp;<span class="ident" id="6306914">ok</span>&nbsp;<span class="op" id="6306917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306921">e</span><span class="op" id="6306922">.</span><span class="ident" id="6306923">w</span>&nbsp;<span class="op" id="6306925">=</span>&nbsp;<span class="ident" id="6306927">ww</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306931">}</span>&nbsp;<span class="keyword" id="6306933">else</span>&nbsp;<span class="op" id="6306938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306942">e</span><span class="op" id="6306943">.</span><span class="ident" id="6306944">w</span>&nbsp;<span class="op" id="6306946">=</span>&nbsp;<span class="ident" id="6306948">bufio</span><span class="op" id="6306953">.</span><span class="ident" id="6306954">NewWriter</span><span class="op" id="6306963">(</span><span class="ident" id="6306964">w</span><span class="op" id="6306965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306968">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306972">e</span><span class="op" id="6306973">.</span><span class="ident" id="6306974">writeHeader</span><span class="op" id="6306985">(</span><span class="op" id="6306986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306989">for</span>&nbsp;<span class="ident" id="6306993">i</span><span class="op" id="6306994">,</span>&nbsp;<span class="ident" id="6306996">pm</span>&nbsp;<span class="op" id="6306999">:=</span>&nbsp;<span class="keyword" id="6307002">range</span>&nbsp;<span class="ident" id="6307008">g</span><span class="op" id="6307009">.</span><span class="ident" id="6307010">Image</span>&nbsp;<span class="op" id="6307016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307020">e</span><span class="op" id="6307021">.</span><span class="ident" id="6307022">writeImageBlock</span><span class="op" id="6307037">(</span><span class="ident" id="6307038">pm</span><span class="op" id="6307040">,</span>&nbsp;<span class="ident" id="6307042">g</span><span class="op" id="6307043">.</span><span class="ident" id="6307044">Delay</span><span class="op" id="6307049">[</span><span class="ident" id="6307050">i</span><span class="op" id="6307051">]</span><span class="op" id="6307052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307055">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307058">e</span><span class="op" id="6307059">.</span><span class="ident" id="6307060">writeByte</span><span class="op" id="6307069">(</span><span class="ident" id="6307070">sTrailer</span><span class="op" id="6307078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307081">e</span><span class="op" id="6307082">.</span><span class="ident" id="6307083">flush</span><span class="op" id="6307088">(</span><span class="op" id="6307089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307092">return</span>&nbsp;<span class="ident" id="6307099">e</span><span class="op" id="6307100">.</span><span class="ident" id="6307101">err</span><br>
<span class="lineno"></span><span class="op" id="6307105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="6307108">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6307157">func</span>&nbsp;<span class="ident" id="6307162">Encode</span><span class="op" id="6307168">(</span><span class="ident" id="6307169">w</span>&nbsp;<span class="ident" id="6307171">io</span><span class="op" id="6307173">.</span><span class="ident" id="6307174">Writer</span><span class="op" id="6307180">,</span>&nbsp;<span class="ident" id="6307182">m</span>&nbsp;<span class="ident" id="6307184">image</span><span class="op" id="6307189">.</span><span class="ident" id="6307190">Image</span><span class="op" id="6307195">,</span>&nbsp;<span class="ident" id="6307197">o</span>&nbsp;<span class="op" id="6307199">*</span><span class="ident" id="6307200">Options</span><span class="op" id="6307207">)</span>&nbsp;<span class="builtintype" id="6307209">error</span>&nbsp;<span class="op" id="6307215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6307218">//&nbsp;Check&nbsp;for&nbsp;bounds&nbsp;and&nbsp;size&nbsp;restrictions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307262">b</span>&nbsp;<span class="op" id="6307264">:=</span>&nbsp;<span class="ident" id="6307267">m</span><span class="op" id="6307268">.</span><span class="ident" id="6307269">Bounds</span><span class="op" id="6307275">(</span><span class="op" id="6307276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307279">if</span>&nbsp;<span class="ident" id="6307282">b</span><span class="op" id="6307283">.</span><span class="ident" id="6307284">Dx</span><span class="op" id="6307286">(</span><span class="op" id="6307287">)</span>&nbsp;<span class="op" id="6307289">&gt;=</span>&nbsp;<span class="num" id="6307292">1</span><span class="op" id="6307293">&lt;&lt;</span><span class="num" id="6307295">16</span>&nbsp;<span class="op" id="6307298">||</span>&nbsp;<span class="ident" id="6307301">b</span><span class="op" id="6307302">.</span><span class="ident" id="6307303">Dy</span><span class="op" id="6307305">(</span><span class="op" id="6307306">)</span>&nbsp;<span class="op" id="6307308">&gt;=</span>&nbsp;<span class="num" id="6307311">1</span><span class="op" id="6307312">&lt;&lt;</span><span class="num" id="6307314">16</span>&nbsp;<span class="op" id="6307317">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307321">return</span>&nbsp;<span class="ident" id="6307328">errors</span><span class="op" id="6307334">.</span><span class="ident" id="6307335">New</span><span class="op" id="6307338">(</span><span class="string" id="6307339">&#34;gif:&nbsp;image&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6307374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307381">opts</span>&nbsp;<span class="op" id="6307386">:=</span>&nbsp;<span class="ident" id="6307389">Options</span><span class="op" id="6307396">{</span><span class="op" id="6307397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307400">if</span>&nbsp;<span class="ident" id="6307403">o</span>&nbsp;<span class="op" id="6307405">!=</span>&nbsp;<span class="ident" id="6307408">nil</span>&nbsp;<span class="op" id="6307412">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307416">opts</span>&nbsp;<span class="op" id="6307421">=</span>&nbsp;<span class="op" id="6307423">*</span><span class="ident" id="6307424">o</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307430">if</span>&nbsp;<span class="ident" id="6307433">opts</span><span class="op" id="6307437">.</span><span class="ident" id="6307438">NumColors</span>&nbsp;<span class="op" id="6307448">&lt;</span>&nbsp;<span class="num" id="6307450">1</span>&nbsp;<span class="op" id="6307452">||</span>&nbsp;<span class="num" id="6307455">256</span>&nbsp;<span class="op" id="6307459">&lt;</span>&nbsp;<span class="ident" id="6307461">opts</span><span class="op" id="6307465">.</span><span class="ident" id="6307466">NumColors</span>&nbsp;<span class="op" id="6307476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307480">opts</span><span class="op" id="6307484">.</span><span class="ident" id="6307485">NumColors</span>&nbsp;<span class="op" id="6307495">=</span>&nbsp;<span class="num" id="6307497">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307502">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307505">if</span>&nbsp;<span class="ident" id="6307508">opts</span><span class="op" id="6307512">.</span><span class="ident" id="6307513">Drawer</span>&nbsp;<span class="op" id="6307520">==</span>&nbsp;<span class="ident" id="6307523">nil</span>&nbsp;<span class="op" id="6307527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307531">opts</span><span class="op" id="6307535">.</span><span class="ident" id="6307536">Drawer</span>&nbsp;<span class="op" id="6307543">=</span>&nbsp;<span class="ident" id="6307545">draw</span><span class="op" id="6307549">.</span><span class="ident" id="6307550">FloydSteinberg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307570">pm</span><span class="op" id="6307572">,</span>&nbsp;<span class="ident" id="6307574">ok</span>&nbsp;<span class="op" id="6307577">:=</span>&nbsp;<span class="ident" id="6307580">m</span><span class="op" id="6307581">.</span><span class="op" id="6307582">(</span><span class="op" id="6307583">*</span><span class="ident" id="6307584">image</span><span class="op" id="6307589">.</span><span class="ident" id="6307590">Paletted</span><span class="op" id="6307598">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307601">if</span>&nbsp;<span class="op" id="6307604">!</span><span class="ident" id="6307605">ok</span>&nbsp;<span class="op" id="6307608">||</span>&nbsp;<span class="builtinfunc" id="6307611">len</span><span class="op" id="6307614">(</span><span class="ident" id="6307615">pm</span><span class="op" id="6307617">.</span><span class="ident" id="6307618">Palette</span><span class="op" id="6307625">)</span>&nbsp;<span class="op" id="6307627">&gt;</span>&nbsp;<span class="ident" id="6307629">opts</span><span class="op" id="6307633">.</span><span class="ident" id="6307634">NumColors</span>&nbsp;<span class="op" id="6307644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6307648">//&nbsp;TODO:&nbsp;Pick&nbsp;a&nbsp;better&nbsp;sub-sample&nbsp;of&nbsp;the&nbsp;Plan&nbsp;9&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307707">pm</span>&nbsp;<span class="op" id="6307710">=</span>&nbsp;<span class="ident" id="6307712">image</span><span class="op" id="6307717">.</span><span class="ident" id="6307718">NewPaletted</span><span class="op" id="6307729">(</span><span class="ident" id="6307730">b</span><span class="op" id="6307731">,</span>&nbsp;<span class="ident" id="6307733">palette</span><span class="op" id="6307740">.</span><span class="ident" id="6307741">Plan9</span><span class="op" id="6307746">[</span><span class="op" id="6307747">:</span><span class="ident" id="6307748">opts</span><span class="op" id="6307752">.</span><span class="ident" id="6307753">NumColors</span><span class="op" id="6307762">]</span><span class="op" id="6307763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307767">if</span>&nbsp;<span class="ident" id="6307770">opts</span><span class="op" id="6307774">.</span><span class="ident" id="6307775">Quantizer</span>&nbsp;<span class="op" id="6307785">!=</span>&nbsp;<span class="ident" id="6307788">nil</span>&nbsp;<span class="op" id="6307792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307797">pm</span><span class="op" id="6307799">.</span><span class="ident" id="6307800">Palette</span>&nbsp;<span class="op" id="6307808">=</span>&nbsp;<span class="ident" id="6307810">opts</span><span class="op" id="6307814">.</span><span class="ident" id="6307815">Quantizer</span><span class="op" id="6307824">.</span><span class="ident" id="6307825">Quantize</span><span class="op" id="6307833">(</span><span class="builtinfunc" id="6307834">make</span><span class="op" id="6307838">(</span><span class="ident" id="6307839">color</span><span class="op" id="6307844">.</span><span class="ident" id="6307845">Palette</span><span class="op" id="6307852">,</span>&nbsp;<span class="num" id="6307854">0</span><span class="op" id="6307855">,</span>&nbsp;<span class="ident" id="6307857">opts</span><span class="op" id="6307861">.</span><span class="ident" id="6307862">NumColors</span><span class="op" id="6307871">)</span><span class="op" id="6307872">,</span>&nbsp;<span class="ident" id="6307874">m</span><span class="op" id="6307875">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307883">opts</span><span class="op" id="6307887">.</span><span class="ident" id="6307888">Drawer</span><span class="op" id="6307894">.</span><span class="ident" id="6307895">Draw</span><span class="op" id="6307899">(</span><span class="ident" id="6307900">pm</span><span class="op" id="6307902">,</span>&nbsp;<span class="ident" id="6307904">b</span><span class="op" id="6307905">,</span>&nbsp;<span class="ident" id="6307907">m</span><span class="op" id="6307908">,</span>&nbsp;<span class="ident" id="6307910">image</span><span class="op" id="6307915">.</span><span class="ident" id="6307916">ZP</span><span class="op" id="6307918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307925">return</span>&nbsp;<span class="ident" id="6307932">EncodeAll</span><span class="op" id="6307941">(</span><span class="ident" id="6307942">w</span><span class="op" id="6307943">,</span>&nbsp;<span class="op" id="6307945">&amp;</span><span class="ident" id="6307946">GIF</span><span class="op" id="6307949">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307953">Image</span><span class="op" id="6307958">:</span>&nbsp;<span class="op" id="6307960">[</span><span class="op" id="6307961">]</span><span class="op" id="6307962">*</span><span class="ident" id="6307963">image</span><span class="op" id="6307968">.</span><span class="ident" id="6307969">Paletted</span><span class="op" id="6307977">{</span><span class="ident" id="6307978">pm</span><span class="op" id="6307980">}</span><span class="op" id="6307981">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307985">Delay</span><span class="op" id="6307990">:</span>&nbsp;<span class="op" id="6307992">[</span><span class="op" id="6307993">]</span><span class="builtintype" id="6307994">int</span><span class="op" id="6307997">{</span><span class="num" id="6307998">0</span><span class="op" id="6307999">}</span><span class="op" id="6308000">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6308003">}</span><span class="op" id="6308004">)</span><br>
<span class="lineno"></span><span class="op" id="6308006">}</span>
</div>
</body>
</html>
