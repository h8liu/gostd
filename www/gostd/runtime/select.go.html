<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1607529">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1607584">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1607638">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1607689">package</span>&nbsp;<span class="ident" id="1607697">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1607706">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;select&nbsp;statements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1607773">import</span>&nbsp;<span class="string" id="1607780">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1607790">const</span>&nbsp;<span class="op" id="1607796">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607799">debugSelect</span>&nbsp;<span class="op" id="1607811">=</span>&nbsp;<span class="builtintype" id="1607813">false</span><br>
<span class="lineno"></span><span class="op" id="1607819">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1607822">var</span>&nbsp;<span class="op" id="1607826">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607829">chansendpc</span>&nbsp;<span class="op" id="1607840">=</span>&nbsp;<span class="ident" id="1607842">funcPC</span><span class="op" id="1607848">(</span><span class="ident" id="1607849">chansend</span><span class="op" id="1607857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607860">chanrecvpc</span>&nbsp;<span class="op" id="1607871">=</span>&nbsp;<span class="ident" id="1607873">funcPC</span><span class="op" id="1607879">(</span><span class="ident" id="1607880">chanrecv</span><span class="op" id="1607888">)</span><br>
<span class="lineno"></span><span class="op" id="1607890">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1607893">func</span>&nbsp;<span class="ident" id="1607898">selectsize</span><span class="op" id="1607908">(</span><span class="ident" id="1607909">size</span>&nbsp;<span class="builtintype" id="1607914">uintptr</span><span class="op" id="1607921">)</span>&nbsp;<span class="builtintype" id="1607923">uintptr</span>&nbsp;<span class="op" id="1607931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1607934">selsize</span>&nbsp;<span class="op" id="1607942">:=</span>&nbsp;<span class="ident" id="1607945">unsafe</span><span class="op" id="1607951">.</span><span class="ident" id="1607952">Sizeof</span><span class="op" id="1607958">(</span><span class="ident" id="1607959">_select</span><span class="op" id="1607966">{</span><span class="op" id="1607967">}</span><span class="op" id="1607968">)</span>&nbsp;<span class="op" id="1607970">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1607974">(</span><span class="ident" id="1607975">size</span><span class="op" id="1607979">-</span><span class="num" id="1607980">1</span><span class="op" id="1607981">)</span><span class="op" id="1607982">*</span><span class="ident" id="1607983">unsafe</span><span class="op" id="1607989">.</span><span class="ident" id="1607990">Sizeof</span><span class="op" id="1607996">(</span><span class="ident" id="1607997">_select</span><span class="op" id="1608004">{</span><span class="op" id="1608005">}</span><span class="op" id="1608006">.</span><span class="ident" id="1608007">scase</span><span class="op" id="1608012">[</span><span class="num" id="1608013">0</span><span class="op" id="1608014">]</span><span class="op" id="1608015">)</span>&nbsp;<span class="op" id="1608017">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608021">size</span><span class="op" id="1608025">*</span><span class="ident" id="1608026">unsafe</span><span class="op" id="1608032">.</span><span class="ident" id="1608033">Sizeof</span><span class="op" id="1608039">(</span><span class="op" id="1608040">*</span><span class="ident" id="1608041">_select</span><span class="op" id="1608048">{</span><span class="op" id="1608049">}</span><span class="op" id="1608050">.</span><span class="ident" id="1608051">lockorder</span><span class="op" id="1608060">)</span>&nbsp;<span class="op" id="1608062">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608066">size</span><span class="op" id="1608070">*</span><span class="ident" id="1608071">unsafe</span><span class="op" id="1608077">.</span><span class="ident" id="1608078">Sizeof</span><span class="op" id="1608084">(</span><span class="op" id="1608085">*</span><span class="ident" id="1608086">_select</span><span class="op" id="1608093">{</span><span class="op" id="1608094">}</span><span class="op" id="1608095">.</span><span class="ident" id="1608096">pollorder</span><span class="op" id="1608105">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1608108">return</span>&nbsp;<span class="ident" id="1608115">round</span><span class="op" id="1608120">(</span><span class="ident" id="1608121">selsize</span><span class="op" id="1608128">,</span>&nbsp;<span class="ident" id="1608130">_Int64Align</span><span class="op" id="1608141">)</span><br>
<span class="lineno"></span><span class="op" id="1608143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1608146">func</span>&nbsp;<span class="ident" id="1608151">newselect</span><span class="op" id="1608160">(</span><span class="ident" id="1608161">sel</span>&nbsp;<span class="op" id="1608165">*</span><span class="ident" id="1608166">_select</span><span class="op" id="1608173">,</span>&nbsp;<span class="ident" id="1608175">selsize</span>&nbsp;<span class="ident" id="1608183">int64</span><span class="op" id="1608188">,</span>&nbsp;<span class="ident" id="1608190">size</span>&nbsp;<span class="builtintype" id="1608195">int32</span><span class="op" id="1608200">)</span>&nbsp;<span class="op" id="1608202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1608205">if</span>&nbsp;<span class="ident" id="1608208">selsize</span>&nbsp;<span class="op" id="1608216">!=</span>&nbsp;<span class="ident" id="1608219">int64</span><span class="op" id="1608224">(</span><span class="ident" id="1608225">selectsize</span><span class="op" id="1608235">(</span><span class="builtintype" id="1608236">uintptr</span><span class="op" id="1608243">(</span><span class="ident" id="1608244">size</span><span class="op" id="1608248">)</span><span class="op" id="1608249">)</span><span class="op" id="1608250">)</span>&nbsp;<span class="op" id="1608252">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1608256">print</span><span class="op" id="1608261">(</span><span class="string" id="1608262">&#34;runtime:&nbsp;bad&nbsp;select&nbsp;size&nbsp;&#34;</span><span class="op" id="1608289">,</span>&nbsp;<span class="ident" id="1608291">selsize</span><span class="op" id="1608298">,</span>&nbsp;<span class="string" id="1608300">&#34;,&nbsp;want&nbsp;&#34;</span><span class="op" id="1608309">,</span>&nbsp;<span class="ident" id="1608311">selectsize</span><span class="op" id="1608321">(</span><span class="builtintype" id="1608322">uintptr</span><span class="op" id="1608329">(</span><span class="ident" id="1608330">size</span><span class="op" id="1608334">)</span><span class="op" id="1608335">)</span><span class="op" id="1608336">,</span>&nbsp;<span class="string" id="1608338">&#34;\n&#34;</span><span class="op" id="1608342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608346">gothrow</span><span class="op" id="1608353">(</span><span class="string" id="1608354">&#34;bad&nbsp;select&nbsp;size&#34;</span><span class="op" id="1608371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1608374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608377">sel</span><span class="op" id="1608380">.</span><span class="ident" id="1608381">tcase</span>&nbsp;<span class="op" id="1608387">=</span>&nbsp;<span class="builtintype" id="1608389">uint16</span><span class="op" id="1608395">(</span><span class="ident" id="1608396">size</span><span class="op" id="1608400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608403">sel</span><span class="op" id="1608406">.</span><span class="ident" id="1608407">ncase</span>&nbsp;<span class="op" id="1608413">=</span>&nbsp;<span class="num" id="1608415">0</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608418">sel</span><span class="op" id="1608421">.</span><span class="ident" id="1608422">lockorder</span>&nbsp;<span class="op" id="1608432">=</span>&nbsp;<span class="op" id="1608434">(</span><span class="op" id="1608435">*</span><span class="op" id="1608436">*</span><span class="ident" id="1608437">hchan</span><span class="op" id="1608442">)</span><span class="op" id="1608443">(</span><span class="ident" id="1608444">add</span><span class="op" id="1608447">(</span><span class="ident" id="1608448">unsafe</span><span class="op" id="1608454">.</span><span class="ident" id="1608455">Pointer</span><span class="op" id="1608462">(</span><span class="op" id="1608463">&amp;</span><span class="ident" id="1608464">sel</span><span class="op" id="1608467">.</span><span class="ident" id="1608468">scase</span><span class="op" id="1608473">)</span><span class="op" id="1608474">,</span>&nbsp;<span class="builtintype" id="1608476">uintptr</span><span class="op" id="1608483">(</span><span class="ident" id="1608484">size</span><span class="op" id="1608488">)</span><span class="op" id="1608489">*</span><span class="ident" id="1608490">unsafe</span><span class="op" id="1608496">.</span><span class="ident" id="1608497">Sizeof</span><span class="op" id="1608503">(</span><span class="ident" id="1608504">_select</span><span class="op" id="1608511">{</span><span class="op" id="1608512">}</span><span class="op" id="1608513">.</span><span class="ident" id="1608514">scase</span><span class="op" id="1608519">[</span><span class="num" id="1608520">0</span><span class="op" id="1608521">]</span><span class="op" id="1608522">)</span><span class="op" id="1608523">)</span><span class="op" id="1608524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608527">sel</span><span class="op" id="1608530">.</span><span class="ident" id="1608531">pollorder</span>&nbsp;<span class="op" id="1608541">=</span>&nbsp;<span class="op" id="1608543">(</span><span class="op" id="1608544">*</span><span class="builtintype" id="1608545">uint16</span><span class="op" id="1608551">)</span><span class="op" id="1608552">(</span><span class="ident" id="1608553">add</span><span class="op" id="1608556">(</span><span class="ident" id="1608557">unsafe</span><span class="op" id="1608563">.</span><span class="ident" id="1608564">Pointer</span><span class="op" id="1608571">(</span><span class="ident" id="1608572">sel</span><span class="op" id="1608575">.</span><span class="ident" id="1608576">lockorder</span><span class="op" id="1608585">)</span><span class="op" id="1608586">,</span>&nbsp;<span class="builtintype" id="1608588">uintptr</span><span class="op" id="1608595">(</span><span class="ident" id="1608596">size</span><span class="op" id="1608600">)</span><span class="op" id="1608601">*</span><span class="ident" id="1608602">unsafe</span><span class="op" id="1608608">.</span><span class="ident" id="1608609">Sizeof</span><span class="op" id="1608615">(</span><span class="op" id="1608616">*</span><span class="ident" id="1608617">_select</span><span class="op" id="1608624">{</span><span class="op" id="1608625">}</span><span class="op" id="1608626">.</span><span class="ident" id="1608627">lockorder</span><span class="op" id="1608636">)</span><span class="op" id="1608637">)</span><span class="op" id="1608638">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1608642">if</span>&nbsp;<span class="ident" id="1608645">debugSelect</span>&nbsp;<span class="op" id="1608657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1608661">print</span><span class="op" id="1608666">(</span><span class="string" id="1608667">&#34;newselect&nbsp;s=&#34;</span><span class="op" id="1608681">,</span>&nbsp;<span class="ident" id="1608683">sel</span><span class="op" id="1608686">,</span>&nbsp;<span class="string" id="1608688">&#34;&nbsp;size=&#34;</span><span class="op" id="1608696">,</span>&nbsp;<span class="ident" id="1608698">size</span><span class="op" id="1608702">,</span>&nbsp;<span class="string" id="1608704">&#34;\n&#34;</span><span class="op" id="1608708">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1608711">}</span><br>
<span class="lineno"></span><span class="op" id="1608713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1608716">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1608729">func</span>&nbsp;<span class="ident" id="1608734">selectsend</span><span class="op" id="1608744">(</span><span class="ident" id="1608745">sel</span>&nbsp;<span class="op" id="1608749">*</span><span class="ident" id="1608750">_select</span><span class="op" id="1608757">,</span>&nbsp;<span class="ident" id="1608759">c</span>&nbsp;<span class="op" id="1608761">*</span><span class="ident" id="1608762">hchan</span><span class="op" id="1608767">,</span>&nbsp;<span class="ident" id="1608769">elem</span>&nbsp;<span class="ident" id="1608774">unsafe</span><span class="op" id="1608780">.</span><span class="ident" id="1608781">Pointer</span><span class="op" id="1608788">)</span>&nbsp;<span class="op" id="1608790">(</span><span class="ident" id="1608791">selected</span>&nbsp;<span class="builtintype" id="1608800">bool</span><span class="op" id="1608804">)</span>&nbsp;<span class="op" id="1608806">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1608809">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1608838">if</span>&nbsp;<span class="ident" id="1608841">c</span>&nbsp;<span class="op" id="1608843">!=</span>&nbsp;<span class="ident" id="1608846">nil</span>&nbsp;<span class="op" id="1608850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1608854">selectsendImpl</span><span class="op" id="1608868">(</span><span class="ident" id="1608869">sel</span><span class="op" id="1608872">,</span>&nbsp;<span class="ident" id="1608874">c</span><span class="op" id="1608875">,</span>&nbsp;<span class="ident" id="1608877">getcallerpc</span><span class="op" id="1608888">(</span><span class="ident" id="1608889">unsafe</span><span class="op" id="1608895">.</span><span class="ident" id="1608896">Pointer</span><span class="op" id="1608903">(</span><span class="op" id="1608904">&amp;</span><span class="ident" id="1608905">sel</span><span class="op" id="1608908">)</span><span class="op" id="1608909">)</span><span class="op" id="1608910">,</span>&nbsp;<span class="ident" id="1608912">elem</span><span class="op" id="1608916">,</span>&nbsp;<span class="builtintype" id="1608918">uintptr</span><span class="op" id="1608925">(</span><span class="ident" id="1608926">unsafe</span><span class="op" id="1608932">.</span><span class="ident" id="1608933">Pointer</span><span class="op" id="1608940">(</span><span class="op" id="1608941">&amp;</span><span class="ident" id="1608942">selected</span><span class="op" id="1608950">)</span><span class="op" id="1608951">)</span><span class="op" id="1608952">-</span><span class="builtintype" id="1608953">uintptr</span><span class="op" id="1608960">(</span><span class="ident" id="1608961">unsafe</span><span class="op" id="1608967">.</span><span class="ident" id="1608968">Pointer</span><span class="op" id="1608975">(</span><span class="op" id="1608976">&amp;</span><span class="ident" id="1608977">sel</span><span class="op" id="1608980">)</span><span class="op" id="1608981">)</span><span class="op" id="1608982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1608985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1608988">return</span><br>
<span class="lineno">50</span><span class="op" id="1608995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1608998">//&nbsp;cut&nbsp;in&nbsp;half&nbsp;to&nbsp;give&nbsp;stack&nbsp;a&nbsp;chance&nbsp;to&nbsp;split</span><br>
<span class="lineno"></span><span class="keyword" id="1609045">func</span>&nbsp;<span class="ident" id="1609050">selectsendImpl</span><span class="op" id="1609064">(</span><span class="ident" id="1609065">sel</span>&nbsp;<span class="op" id="1609069">*</span><span class="ident" id="1609070">_select</span><span class="op" id="1609077">,</span>&nbsp;<span class="ident" id="1609079">c</span>&nbsp;<span class="op" id="1609081">*</span><span class="ident" id="1609082">hchan</span><span class="op" id="1609087">,</span>&nbsp;<span class="ident" id="1609089">pc</span>&nbsp;<span class="builtintype" id="1609092">uintptr</span><span class="op" id="1609099">,</span>&nbsp;<span class="ident" id="1609101">elem</span>&nbsp;<span class="ident" id="1609106">unsafe</span><span class="op" id="1609112">.</span><span class="ident" id="1609113">Pointer</span><span class="op" id="1609120">,</span>&nbsp;<span class="ident" id="1609122">so</span>&nbsp;<span class="builtintype" id="1609125">uintptr</span><span class="op" id="1609132">)</span>&nbsp;<span class="op" id="1609134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609137">i</span>&nbsp;<span class="op" id="1609139">:=</span>&nbsp;<span class="ident" id="1609142">sel</span><span class="op" id="1609145">.</span><span class="ident" id="1609146">ncase</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609153">if</span>&nbsp;<span class="ident" id="1609156">i</span>&nbsp;<span class="op" id="1609158">&gt;=</span>&nbsp;<span class="ident" id="1609161">sel</span><span class="op" id="1609164">.</span><span class="ident" id="1609165">tcase</span>&nbsp;<span class="op" id="1609171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609175">gothrow</span><span class="op" id="1609182">(</span><span class="string" id="1609183">&#34;selectsend:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1609211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609217">sel</span><span class="op" id="1609220">.</span><span class="ident" id="1609221">ncase</span>&nbsp;<span class="op" id="1609227">=</span>&nbsp;<span class="ident" id="1609229">i</span>&nbsp;<span class="op" id="1609231">+</span>&nbsp;<span class="num" id="1609233">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609236">cas</span>&nbsp;<span class="op" id="1609240">:=</span>&nbsp;<span class="op" id="1609243">(</span><span class="op" id="1609244">*</span><span class="ident" id="1609245">scase</span><span class="op" id="1609250">)</span><span class="op" id="1609251">(</span><span class="ident" id="1609252">add</span><span class="op" id="1609255">(</span><span class="ident" id="1609256">unsafe</span><span class="op" id="1609262">.</span><span class="ident" id="1609263">Pointer</span><span class="op" id="1609270">(</span><span class="op" id="1609271">&amp;</span><span class="ident" id="1609272">sel</span><span class="op" id="1609275">.</span><span class="ident" id="1609276">scase</span><span class="op" id="1609281">)</span><span class="op" id="1609282">,</span>&nbsp;<span class="builtintype" id="1609284">uintptr</span><span class="op" id="1609291">(</span><span class="ident" id="1609292">i</span><span class="op" id="1609293">)</span><span class="op" id="1609294">*</span><span class="ident" id="1609295">unsafe</span><span class="op" id="1609301">.</span><span class="ident" id="1609302">Sizeof</span><span class="op" id="1609308">(</span><span class="ident" id="1609309">sel</span><span class="op" id="1609312">.</span><span class="ident" id="1609313">scase</span><span class="op" id="1609318">[</span><span class="num" id="1609319">0</span><span class="op" id="1609320">]</span><span class="op" id="1609321">)</span><span class="op" id="1609322">)</span><span class="op" id="1609323">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609327">cas</span><span class="op" id="1609330">.</span><span class="ident" id="1609331">pc</span>&nbsp;<span class="op" id="1609334">=</span>&nbsp;<span class="ident" id="1609336">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609340">cas</span><span class="op" id="1609343">.</span><span class="ident" id="1609344">_chan</span>&nbsp;<span class="op" id="1609350">=</span>&nbsp;<span class="ident" id="1609352">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609355">cas</span><span class="op" id="1609358">.</span><span class="ident" id="1609359">so</span>&nbsp;<span class="op" id="1609362">=</span>&nbsp;<span class="builtintype" id="1609364">uint16</span><span class="op" id="1609370">(</span><span class="ident" id="1609371">so</span><span class="op" id="1609373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609376">cas</span><span class="op" id="1609379">.</span><span class="ident" id="1609380">kind</span>&nbsp;<span class="op" id="1609385">=</span>&nbsp;<span class="ident" id="1609387">_CaseSend</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609398">cas</span><span class="op" id="1609401">.</span><span class="ident" id="1609402">elem</span>&nbsp;<span class="op" id="1609407">=</span>&nbsp;<span class="ident" id="1609409">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609416">if</span>&nbsp;<span class="ident" id="1609419">debugSelect</span>&nbsp;<span class="op" id="1609431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1609435">print</span><span class="op" id="1609440">(</span><span class="string" id="1609441">&#34;selectsend&nbsp;s=&#34;</span><span class="op" id="1609456">,</span>&nbsp;<span class="ident" id="1609458">sel</span><span class="op" id="1609461">,</span>&nbsp;<span class="string" id="1609463">&#34;&nbsp;pc=&#34;</span><span class="op" id="1609469">,</span>&nbsp;<span class="ident" id="1609471">hex</span><span class="op" id="1609474">(</span><span class="ident" id="1609475">cas</span><span class="op" id="1609478">.</span><span class="ident" id="1609479">pc</span><span class="op" id="1609481">)</span><span class="op" id="1609482">,</span>&nbsp;<span class="string" id="1609484">&#34;&nbsp;chan=&#34;</span><span class="op" id="1609492">,</span>&nbsp;<span class="ident" id="1609494">cas</span><span class="op" id="1609497">.</span><span class="ident" id="1609498">_chan</span><span class="op" id="1609503">,</span>&nbsp;<span class="string" id="1609505">&#34;&nbsp;so=&#34;</span><span class="op" id="1609511">,</span>&nbsp;<span class="ident" id="1609513">cas</span><span class="op" id="1609516">.</span><span class="ident" id="1609517">so</span><span class="op" id="1609519">,</span>&nbsp;<span class="string" id="1609521">&#34;\n&#34;</span><span class="op" id="1609525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609528">}</span><br>
<span class="lineno">70</span><span class="op" id="1609530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1609533">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1609546">func</span>&nbsp;<span class="ident" id="1609551">selectrecv</span><span class="op" id="1609561">(</span><span class="ident" id="1609562">sel</span>&nbsp;<span class="op" id="1609566">*</span><span class="ident" id="1609567">_select</span><span class="op" id="1609574">,</span>&nbsp;<span class="ident" id="1609576">c</span>&nbsp;<span class="op" id="1609578">*</span><span class="ident" id="1609579">hchan</span><span class="op" id="1609584">,</span>&nbsp;<span class="ident" id="1609586">elem</span>&nbsp;<span class="ident" id="1609591">unsafe</span><span class="op" id="1609597">.</span><span class="ident" id="1609598">Pointer</span><span class="op" id="1609605">)</span>&nbsp;<span class="op" id="1609607">(</span><span class="ident" id="1609608">selected</span>&nbsp;<span class="builtintype" id="1609617">bool</span><span class="op" id="1609621">)</span>&nbsp;<span class="op" id="1609623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609626">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609655">if</span>&nbsp;<span class="ident" id="1609658">c</span>&nbsp;<span class="op" id="1609660">!=</span>&nbsp;<span class="ident" id="1609663">nil</span>&nbsp;<span class="op" id="1609667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609671">selectrecvImpl</span><span class="op" id="1609685">(</span><span class="ident" id="1609686">sel</span><span class="op" id="1609689">,</span>&nbsp;<span class="ident" id="1609691">c</span><span class="op" id="1609692">,</span>&nbsp;<span class="ident" id="1609694">getcallerpc</span><span class="op" id="1609705">(</span><span class="ident" id="1609706">unsafe</span><span class="op" id="1609712">.</span><span class="ident" id="1609713">Pointer</span><span class="op" id="1609720">(</span><span class="op" id="1609721">&amp;</span><span class="ident" id="1609722">sel</span><span class="op" id="1609725">)</span><span class="op" id="1609726">)</span><span class="op" id="1609727">,</span>&nbsp;<span class="ident" id="1609729">elem</span><span class="op" id="1609733">,</span>&nbsp;<span class="ident" id="1609735">nil</span><span class="op" id="1609738">,</span>&nbsp;<span class="builtintype" id="1609740">uintptr</span><span class="op" id="1609747">(</span><span class="ident" id="1609748">unsafe</span><span class="op" id="1609754">.</span><span class="ident" id="1609755">Pointer</span><span class="op" id="1609762">(</span><span class="op" id="1609763">&amp;</span><span class="ident" id="1609764">selected</span><span class="op" id="1609772">)</span><span class="op" id="1609773">)</span><span class="op" id="1609774">-</span><span class="builtintype" id="1609775">uintptr</span><span class="op" id="1609782">(</span><span class="ident" id="1609783">unsafe</span><span class="op" id="1609789">.</span><span class="ident" id="1609790">Pointer</span><span class="op" id="1609797">(</span><span class="op" id="1609798">&amp;</span><span class="ident" id="1609799">sel</span><span class="op" id="1609802">)</span><span class="op" id="1609803">)</span><span class="op" id="1609804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1609807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609810">return</span><br>
<span class="lineno"></span><span class="op" id="1609817">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="1609820">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1609833">func</span>&nbsp;<span class="ident" id="1609838">selectrecv2</span><span class="op" id="1609849">(</span><span class="ident" id="1609850">sel</span>&nbsp;<span class="op" id="1609854">*</span><span class="ident" id="1609855">_select</span><span class="op" id="1609862">,</span>&nbsp;<span class="ident" id="1609864">c</span>&nbsp;<span class="op" id="1609866">*</span><span class="ident" id="1609867">hchan</span><span class="op" id="1609872">,</span>&nbsp;<span class="ident" id="1609874">elem</span>&nbsp;<span class="ident" id="1609879">unsafe</span><span class="op" id="1609885">.</span><span class="ident" id="1609886">Pointer</span><span class="op" id="1609893">,</span>&nbsp;<span class="ident" id="1609895">received</span>&nbsp;<span class="op" id="1609904">*</span><span class="builtintype" id="1609905">bool</span><span class="op" id="1609909">)</span>&nbsp;<span class="op" id="1609911">(</span><span class="ident" id="1609912">selected</span>&nbsp;<span class="builtintype" id="1609921">bool</span><span class="op" id="1609925">)</span>&nbsp;<span class="op" id="1609927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1609930">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1609959">if</span>&nbsp;<span class="ident" id="1609962">c</span>&nbsp;<span class="op" id="1609964">!=</span>&nbsp;<span class="ident" id="1609967">nil</span>&nbsp;<span class="op" id="1609971">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1609975">selectrecvImpl</span><span class="op" id="1609989">(</span><span class="ident" id="1609990">sel</span><span class="op" id="1609993">,</span>&nbsp;<span class="ident" id="1609995">c</span><span class="op" id="1609996">,</span>&nbsp;<span class="ident" id="1609998">getcallerpc</span><span class="op" id="1610009">(</span><span class="ident" id="1610010">unsafe</span><span class="op" id="1610016">.</span><span class="ident" id="1610017">Pointer</span><span class="op" id="1610024">(</span><span class="op" id="1610025">&amp;</span><span class="ident" id="1610026">sel</span><span class="op" id="1610029">)</span><span class="op" id="1610030">)</span><span class="op" id="1610031">,</span>&nbsp;<span class="ident" id="1610033">elem</span><span class="op" id="1610037">,</span>&nbsp;<span class="ident" id="1610039">received</span><span class="op" id="1610047">,</span>&nbsp;<span class="builtintype" id="1610049">uintptr</span><span class="op" id="1610056">(</span><span class="ident" id="1610057">unsafe</span><span class="op" id="1610063">.</span><span class="ident" id="1610064">Pointer</span><span class="op" id="1610071">(</span><span class="op" id="1610072">&amp;</span><span class="ident" id="1610073">selected</span><span class="op" id="1610081">)</span><span class="op" id="1610082">)</span><span class="op" id="1610083">-</span><span class="builtintype" id="1610084">uintptr</span><span class="op" id="1610091">(</span><span class="ident" id="1610092">unsafe</span><span class="op" id="1610098">.</span><span class="ident" id="1610099">Pointer</span><span class="op" id="1610106">(</span><span class="op" id="1610107">&amp;</span><span class="ident" id="1610108">sel</span><span class="op" id="1610111">)</span><span class="op" id="1610112">)</span><span class="op" id="1610113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610119">return</span><br>
<span class="lineno"></span><span class="op" id="1610126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1610129">func</span>&nbsp;<span class="ident" id="1610134">selectrecvImpl</span><span class="op" id="1610148">(</span><span class="ident" id="1610149">sel</span>&nbsp;<span class="op" id="1610153">*</span><span class="ident" id="1610154">_select</span><span class="op" id="1610161">,</span>&nbsp;<span class="ident" id="1610163">c</span>&nbsp;<span class="op" id="1610165">*</span><span class="ident" id="1610166">hchan</span><span class="op" id="1610171">,</span>&nbsp;<span class="ident" id="1610173">pc</span>&nbsp;<span class="builtintype" id="1610176">uintptr</span><span class="op" id="1610183">,</span>&nbsp;<span class="ident" id="1610185">elem</span>&nbsp;<span class="ident" id="1610190">unsafe</span><span class="op" id="1610196">.</span><span class="ident" id="1610197">Pointer</span><span class="op" id="1610204">,</span>&nbsp;<span class="ident" id="1610206">received</span>&nbsp;<span class="op" id="1610215">*</span><span class="builtintype" id="1610216">bool</span><span class="op" id="1610220">,</span>&nbsp;<span class="ident" id="1610222">so</span>&nbsp;<span class="builtintype" id="1610225">uintptr</span><span class="op" id="1610232">)</span>&nbsp;<span class="op" id="1610234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610237">i</span>&nbsp;<span class="op" id="1610239">:=</span>&nbsp;<span class="ident" id="1610242">sel</span><span class="op" id="1610245">.</span><span class="ident" id="1610246">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610253">if</span>&nbsp;<span class="ident" id="1610256">i</span>&nbsp;<span class="op" id="1610258">&gt;=</span>&nbsp;<span class="ident" id="1610261">sel</span><span class="op" id="1610264">.</span><span class="ident" id="1610265">tcase</span>&nbsp;<span class="op" id="1610271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610275">gothrow</span><span class="op" id="1610282">(</span><span class="string" id="1610283">&#34;selectrecv:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1610311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610314">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610317">sel</span><span class="op" id="1610320">.</span><span class="ident" id="1610321">ncase</span>&nbsp;<span class="op" id="1610327">=</span>&nbsp;<span class="ident" id="1610329">i</span>&nbsp;<span class="op" id="1610331">+</span>&nbsp;<span class="num" id="1610333">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610336">cas</span>&nbsp;<span class="op" id="1610340">:=</span>&nbsp;<span class="op" id="1610343">(</span><span class="op" id="1610344">*</span><span class="ident" id="1610345">scase</span><span class="op" id="1610350">)</span><span class="op" id="1610351">(</span><span class="ident" id="1610352">add</span><span class="op" id="1610355">(</span><span class="ident" id="1610356">unsafe</span><span class="op" id="1610362">.</span><span class="ident" id="1610363">Pointer</span><span class="op" id="1610370">(</span><span class="op" id="1610371">&amp;</span><span class="ident" id="1610372">sel</span><span class="op" id="1610375">.</span><span class="ident" id="1610376">scase</span><span class="op" id="1610381">)</span><span class="op" id="1610382">,</span>&nbsp;<span class="builtintype" id="1610384">uintptr</span><span class="op" id="1610391">(</span><span class="ident" id="1610392">i</span><span class="op" id="1610393">)</span><span class="op" id="1610394">*</span><span class="ident" id="1610395">unsafe</span><span class="op" id="1610401">.</span><span class="ident" id="1610402">Sizeof</span><span class="op" id="1610408">(</span><span class="ident" id="1610409">sel</span><span class="op" id="1610412">.</span><span class="ident" id="1610413">scase</span><span class="op" id="1610418">[</span><span class="num" id="1610419">0</span><span class="op" id="1610420">]</span><span class="op" id="1610421">)</span><span class="op" id="1610422">)</span><span class="op" id="1610423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610426">cas</span><span class="op" id="1610429">.</span><span class="ident" id="1610430">pc</span>&nbsp;<span class="op" id="1610433">=</span>&nbsp;<span class="ident" id="1610435">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610439">cas</span><span class="op" id="1610442">.</span><span class="ident" id="1610443">_chan</span>&nbsp;<span class="op" id="1610449">=</span>&nbsp;<span class="ident" id="1610451">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610454">cas</span><span class="op" id="1610457">.</span><span class="ident" id="1610458">so</span>&nbsp;<span class="op" id="1610461">=</span>&nbsp;<span class="builtintype" id="1610463">uint16</span><span class="op" id="1610469">(</span><span class="ident" id="1610470">so</span><span class="op" id="1610472">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610475">cas</span><span class="op" id="1610478">.</span><span class="ident" id="1610479">kind</span>&nbsp;<span class="op" id="1610484">=</span>&nbsp;<span class="ident" id="1610486">_CaseRecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610497">cas</span><span class="op" id="1610500">.</span><span class="ident" id="1610501">elem</span>&nbsp;<span class="op" id="1610506">=</span>&nbsp;<span class="ident" id="1610508">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610514">cas</span><span class="op" id="1610517">.</span><span class="ident" id="1610518">receivedp</span>&nbsp;<span class="op" id="1610528">=</span>&nbsp;<span class="ident" id="1610530">received</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610541">if</span>&nbsp;<span class="ident" id="1610544">debugSelect</span>&nbsp;<span class="op" id="1610556">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1610560">print</span><span class="op" id="1610565">(</span><span class="string" id="1610566">&#34;selectrecv&nbsp;s=&#34;</span><span class="op" id="1610581">,</span>&nbsp;<span class="ident" id="1610583">sel</span><span class="op" id="1610586">,</span>&nbsp;<span class="string" id="1610588">&#34;&nbsp;pc=&#34;</span><span class="op" id="1610594">,</span>&nbsp;<span class="ident" id="1610596">hex</span><span class="op" id="1610599">(</span><span class="ident" id="1610600">cas</span><span class="op" id="1610603">.</span><span class="ident" id="1610604">pc</span><span class="op" id="1610606">)</span><span class="op" id="1610607">,</span>&nbsp;<span class="string" id="1610609">&#34;&nbsp;chan=&#34;</span><span class="op" id="1610617">,</span>&nbsp;<span class="ident" id="1610619">cas</span><span class="op" id="1610622">.</span><span class="ident" id="1610623">_chan</span><span class="op" id="1610628">,</span>&nbsp;<span class="string" id="1610630">&#34;&nbsp;so=&#34;</span><span class="op" id="1610636">,</span>&nbsp;<span class="ident" id="1610638">cas</span><span class="op" id="1610641">.</span><span class="ident" id="1610642">so</span><span class="op" id="1610644">,</span>&nbsp;<span class="string" id="1610646">&#34;\n&#34;</span><span class="op" id="1610650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1610653">}</span><br>
<span class="lineno"></span><span class="op" id="1610655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1610658">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1610671">func</span>&nbsp;<span class="ident" id="1610676">selectdefault</span><span class="op" id="1610689">(</span><span class="ident" id="1610690">sel</span>&nbsp;<span class="op" id="1610694">*</span><span class="ident" id="1610695">_select</span><span class="op" id="1610702">)</span>&nbsp;<span class="op" id="1610704">(</span><span class="ident" id="1610705">selected</span>&nbsp;<span class="builtintype" id="1610714">bool</span><span class="op" id="1610718">)</span>&nbsp;<span class="op" id="1610720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610723">selectdefaultImpl</span><span class="op" id="1610740">(</span><span class="ident" id="1610741">sel</span><span class="op" id="1610744">,</span>&nbsp;<span class="ident" id="1610746">getcallerpc</span><span class="op" id="1610757">(</span><span class="ident" id="1610758">unsafe</span><span class="op" id="1610764">.</span><span class="ident" id="1610765">Pointer</span><span class="op" id="1610772">(</span><span class="op" id="1610773">&amp;</span><span class="ident" id="1610774">sel</span><span class="op" id="1610777">)</span><span class="op" id="1610778">)</span><span class="op" id="1610779">,</span>&nbsp;<span class="builtintype" id="1610781">uintptr</span><span class="op" id="1610788">(</span><span class="ident" id="1610789">unsafe</span><span class="op" id="1610795">.</span><span class="ident" id="1610796">Pointer</span><span class="op" id="1610803">(</span><span class="op" id="1610804">&amp;</span><span class="ident" id="1610805">selected</span><span class="op" id="1610813">)</span><span class="op" id="1610814">)</span><span class="op" id="1610815">-</span><span class="builtintype" id="1610816">uintptr</span><span class="op" id="1610823">(</span><span class="ident" id="1610824">unsafe</span><span class="op" id="1610830">.</span><span class="ident" id="1610831">Pointer</span><span class="op" id="1610838">(</span><span class="op" id="1610839">&amp;</span><span class="ident" id="1610840">sel</span><span class="op" id="1610843">)</span><span class="op" id="1610844">)</span><span class="op" id="1610845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610848">return</span><br>
<span class="lineno"></span><span class="op" id="1610855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="1610858">func</span>&nbsp;<span class="ident" id="1610863">selectdefaultImpl</span><span class="op" id="1610880">(</span><span class="ident" id="1610881">sel</span>&nbsp;<span class="op" id="1610885">*</span><span class="ident" id="1610886">_select</span><span class="op" id="1610893">,</span>&nbsp;<span class="ident" id="1610895">callerpc</span>&nbsp;<span class="builtintype" id="1610904">uintptr</span><span class="op" id="1610911">,</span>&nbsp;<span class="ident" id="1610913">so</span>&nbsp;<span class="builtintype" id="1610916">uintptr</span><span class="op" id="1610923">)</span>&nbsp;<span class="op" id="1610925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610928">i</span>&nbsp;<span class="op" id="1610930">:=</span>&nbsp;<span class="ident" id="1610933">sel</span><span class="op" id="1610936">.</span><span class="ident" id="1610937">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1610944">if</span>&nbsp;<span class="ident" id="1610947">i</span>&nbsp;<span class="op" id="1610949">&gt;=</span>&nbsp;<span class="ident" id="1610952">sel</span><span class="op" id="1610955">.</span><span class="ident" id="1610956">tcase</span>&nbsp;<span class="op" id="1610962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1610966">gothrow</span><span class="op" id="1610973">(</span><span class="string" id="1610974">&#34;selectdefault:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1611005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611008">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611011">sel</span><span class="op" id="1611014">.</span><span class="ident" id="1611015">ncase</span>&nbsp;<span class="op" id="1611021">=</span>&nbsp;<span class="ident" id="1611023">i</span>&nbsp;<span class="op" id="1611025">+</span>&nbsp;<span class="num" id="1611027">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611030">cas</span>&nbsp;<span class="op" id="1611034">:=</span>&nbsp;<span class="op" id="1611037">(</span><span class="op" id="1611038">*</span><span class="ident" id="1611039">scase</span><span class="op" id="1611044">)</span><span class="op" id="1611045">(</span><span class="ident" id="1611046">add</span><span class="op" id="1611049">(</span><span class="ident" id="1611050">unsafe</span><span class="op" id="1611056">.</span><span class="ident" id="1611057">Pointer</span><span class="op" id="1611064">(</span><span class="op" id="1611065">&amp;</span><span class="ident" id="1611066">sel</span><span class="op" id="1611069">.</span><span class="ident" id="1611070">scase</span><span class="op" id="1611075">)</span><span class="op" id="1611076">,</span>&nbsp;<span class="builtintype" id="1611078">uintptr</span><span class="op" id="1611085">(</span><span class="ident" id="1611086">i</span><span class="op" id="1611087">)</span><span class="op" id="1611088">*</span><span class="ident" id="1611089">unsafe</span><span class="op" id="1611095">.</span><span class="ident" id="1611096">Sizeof</span><span class="op" id="1611102">(</span><span class="ident" id="1611103">sel</span><span class="op" id="1611106">.</span><span class="ident" id="1611107">scase</span><span class="op" id="1611112">[</span><span class="num" id="1611113">0</span><span class="op" id="1611114">]</span><span class="op" id="1611115">)</span><span class="op" id="1611116">)</span><span class="op" id="1611117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611120">cas</span><span class="op" id="1611123">.</span><span class="ident" id="1611124">pc</span>&nbsp;<span class="op" id="1611127">=</span>&nbsp;<span class="ident" id="1611129">callerpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611139">cas</span><span class="op" id="1611142">.</span><span class="ident" id="1611143">_chan</span>&nbsp;<span class="op" id="1611149">=</span>&nbsp;<span class="ident" id="1611151">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611156">cas</span><span class="op" id="1611159">.</span><span class="ident" id="1611160">so</span>&nbsp;<span class="op" id="1611163">=</span>&nbsp;<span class="builtintype" id="1611165">uint16</span><span class="op" id="1611171">(</span><span class="ident" id="1611172">so</span><span class="op" id="1611174">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611177">cas</span><span class="op" id="1611180">.</span><span class="ident" id="1611181">kind</span>&nbsp;<span class="op" id="1611186">=</span>&nbsp;<span class="ident" id="1611188">_CaseDefault</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611203">if</span>&nbsp;<span class="ident" id="1611206">debugSelect</span>&nbsp;<span class="op" id="1611218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1611222">print</span><span class="op" id="1611227">(</span><span class="string" id="1611228">&#34;selectdefault&nbsp;s=&#34;</span><span class="op" id="1611246">,</span>&nbsp;<span class="ident" id="1611248">sel</span><span class="op" id="1611251">,</span>&nbsp;<span class="string" id="1611253">&#34;&nbsp;pc=&#34;</span><span class="op" id="1611259">,</span>&nbsp;<span class="ident" id="1611261">hex</span><span class="op" id="1611264">(</span><span class="ident" id="1611265">cas</span><span class="op" id="1611268">.</span><span class="ident" id="1611269">pc</span><span class="op" id="1611271">)</span><span class="op" id="1611272">,</span>&nbsp;<span class="string" id="1611274">&#34;&nbsp;so=&#34;</span><span class="op" id="1611280">,</span>&nbsp;<span class="ident" id="1611282">cas</span><span class="op" id="1611285">.</span><span class="ident" id="1611286">so</span><span class="op" id="1611288">,</span>&nbsp;<span class="string" id="1611290">&#34;\n&#34;</span><span class="op" id="1611294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611297">}</span><br>
<span class="lineno">130</span><span class="op" id="1611299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1611302">func</span>&nbsp;<span class="ident" id="1611307">sellock</span><span class="op" id="1611314">(</span><span class="ident" id="1611315">sel</span>&nbsp;<span class="op" id="1611319">*</span><span class="ident" id="1611320">_select</span><span class="op" id="1611327">)</span>&nbsp;<span class="op" id="1611329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611332">lockslice</span>&nbsp;<span class="op" id="1611342">:=</span>&nbsp;<span class="ident" id="1611345">sliceStruct</span><span class="op" id="1611356">{</span><span class="ident" id="1611357">unsafe</span><span class="op" id="1611363">.</span><span class="ident" id="1611364">Pointer</span><span class="op" id="1611371">(</span><span class="ident" id="1611372">sel</span><span class="op" id="1611375">.</span><span class="ident" id="1611376">lockorder</span><span class="op" id="1611385">)</span><span class="op" id="1611386">,</span>&nbsp;<span class="builtintype" id="1611388">int</span><span class="op" id="1611391">(</span><span class="ident" id="1611392">sel</span><span class="op" id="1611395">.</span><span class="ident" id="1611396">ncase</span><span class="op" id="1611401">)</span><span class="op" id="1611402">,</span>&nbsp;<span class="builtintype" id="1611404">int</span><span class="op" id="1611407">(</span><span class="ident" id="1611408">sel</span><span class="op" id="1611411">.</span><span class="ident" id="1611412">ncase</span><span class="op" id="1611417">)</span><span class="op" id="1611418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611421">lockorder</span>&nbsp;<span class="op" id="1611431">:=</span>&nbsp;<span class="op" id="1611434">*</span><span class="op" id="1611435">(</span><span class="op" id="1611436">*</span><span class="op" id="1611437">[</span><span class="op" id="1611438">]</span><span class="op" id="1611439">*</span><span class="ident" id="1611440">hchan</span><span class="op" id="1611445">)</span><span class="op" id="1611446">(</span><span class="ident" id="1611447">unsafe</span><span class="op" id="1611453">.</span><span class="ident" id="1611454">Pointer</span><span class="op" id="1611461">(</span><span class="op" id="1611462">&amp;</span><span class="ident" id="1611463">lockslice</span><span class="op" id="1611472">)</span><span class="op" id="1611473">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611476">var</span>&nbsp;<span class="ident" id="1611480">c</span>&nbsp;<span class="op" id="1611482">*</span><span class="ident" id="1611483">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611490">for</span>&nbsp;<span class="ident" id="1611494">_</span><span class="op" id="1611495">,</span>&nbsp;<span class="ident" id="1611497">c0</span>&nbsp;<span class="op" id="1611500">:=</span>&nbsp;<span class="keyword" id="1611503">range</span>&nbsp;<span class="ident" id="1611509">lockorder</span>&nbsp;<span class="op" id="1611519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1611523">if</span>&nbsp;<span class="ident" id="1611526">c0</span>&nbsp;<span class="op" id="1611529">!=</span>&nbsp;<span class="ident" id="1611532">nil</span>&nbsp;<span class="op" id="1611536">&amp;&amp;</span>&nbsp;<span class="ident" id="1611539">c0</span>&nbsp;<span class="op" id="1611542">!=</span>&nbsp;<span class="ident" id="1611545">c</span>&nbsp;<span class="op" id="1611547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611552">c</span>&nbsp;<span class="op" id="1611554">=</span>&nbsp;<span class="ident" id="1611556">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1611562">lock</span><span class="op" id="1611566">(</span><span class="op" id="1611567">&amp;</span><span class="ident" id="1611568">c</span><span class="op" id="1611569">.</span><span class="ident" id="1611570">lock</span><span class="op" id="1611574">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1611581">}</span><br>
<span class="lineno"></span><span class="op" id="1611583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1611586">func</span>&nbsp;<span class="ident" id="1611591">selunlock</span><span class="op" id="1611600">(</span><span class="ident" id="1611601">sel</span>&nbsp;<span class="op" id="1611605">*</span><span class="ident" id="1611606">_select</span><span class="op" id="1611613">)</span>&nbsp;<span class="op" id="1611615">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611618">//&nbsp;We&nbsp;must&nbsp;be&nbsp;very&nbsp;careful&nbsp;here&nbsp;to&nbsp;not&nbsp;touch&nbsp;sel&nbsp;after&nbsp;we&nbsp;have&nbsp;unlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611691">//&nbsp;the&nbsp;last&nbsp;lock,&nbsp;because&nbsp;sel&nbsp;can&nbsp;be&nbsp;freed&nbsp;right&nbsp;after&nbsp;the&nbsp;last&nbsp;unlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611764">//&nbsp;Consider&nbsp;the&nbsp;following&nbsp;situation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611802">//&nbsp;First&nbsp;M&nbsp;calls&nbsp;runtime·park()&nbsp;in&nbsp;runtime·selectgo()&nbsp;passing&nbsp;the&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611876">//&nbsp;Once&nbsp;runtime·park()&nbsp;has&nbsp;unlocked&nbsp;the&nbsp;last&nbsp;lock,&nbsp;another&nbsp;M&nbsp;makes</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1611945">//&nbsp;the&nbsp;G&nbsp;that&nbsp;calls&nbsp;select&nbsp;runnable&nbsp;again&nbsp;and&nbsp;schedules&nbsp;it&nbsp;for&nbsp;execution.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1612020">//&nbsp;When&nbsp;the&nbsp;G&nbsp;runs&nbsp;on&nbsp;another&nbsp;M,&nbsp;it&nbsp;locks&nbsp;all&nbsp;the&nbsp;locks&nbsp;and&nbsp;frees&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1612092">//&nbsp;Now&nbsp;if&nbsp;the&nbsp;first&nbsp;M&nbsp;touches&nbsp;sel,&nbsp;it&nbsp;will&nbsp;access&nbsp;freed&nbsp;memory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612157">n</span>&nbsp;<span class="op" id="1612159">:=</span>&nbsp;<span class="builtintype" id="1612162">int</span><span class="op" id="1612165">(</span><span class="ident" id="1612166">sel</span><span class="op" id="1612169">.</span><span class="ident" id="1612170">ncase</span><span class="op" id="1612175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612178">r</span>&nbsp;<span class="op" id="1612180">:=</span>&nbsp;<span class="num" id="1612183">0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612186">lockslice</span>&nbsp;<span class="op" id="1612196">:=</span>&nbsp;<span class="ident" id="1612199">sliceStruct</span><span class="op" id="1612210">{</span><span class="ident" id="1612211">unsafe</span><span class="op" id="1612217">.</span><span class="ident" id="1612218">Pointer</span><span class="op" id="1612225">(</span><span class="ident" id="1612226">sel</span><span class="op" id="1612229">.</span><span class="ident" id="1612230">lockorder</span><span class="op" id="1612239">)</span><span class="op" id="1612240">,</span>&nbsp;<span class="ident" id="1612242">n</span><span class="op" id="1612243">,</span>&nbsp;<span class="ident" id="1612245">n</span><span class="op" id="1612246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612249">lockorder</span>&nbsp;<span class="op" id="1612259">:=</span>&nbsp;<span class="op" id="1612262">*</span><span class="op" id="1612263">(</span><span class="op" id="1612264">*</span><span class="op" id="1612265">[</span><span class="op" id="1612266">]</span><span class="op" id="1612267">*</span><span class="ident" id="1612268">hchan</span><span class="op" id="1612273">)</span><span class="op" id="1612274">(</span><span class="ident" id="1612275">unsafe</span><span class="op" id="1612281">.</span><span class="ident" id="1612282">Pointer</span><span class="op" id="1612289">(</span><span class="op" id="1612290">&amp;</span><span class="ident" id="1612291">lockslice</span><span class="op" id="1612300">)</span><span class="op" id="1612301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1612304">//&nbsp;skip&nbsp;the&nbsp;default&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612330">if</span>&nbsp;<span class="ident" id="1612333">n</span>&nbsp;<span class="op" id="1612335">&gt;</span>&nbsp;<span class="num" id="1612337">0</span>&nbsp;<span class="op" id="1612339">&amp;&amp;</span>&nbsp;<span class="ident" id="1612342">lockorder</span><span class="op" id="1612351">[</span><span class="num" id="1612352">0</span><span class="op" id="1612353">]</span>&nbsp;<span class="op" id="1612355">==</span>&nbsp;<span class="ident" id="1612358">nil</span>&nbsp;<span class="op" id="1612362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612366">r</span>&nbsp;<span class="op" id="1612368">=</span>&nbsp;<span class="num" id="1612370">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612376">for</span>&nbsp;<span class="ident" id="1612380">i</span>&nbsp;<span class="op" id="1612382">:=</span>&nbsp;<span class="ident" id="1612385">n</span>&nbsp;<span class="op" id="1612387">-</span>&nbsp;<span class="num" id="1612389">1</span><span class="op" id="1612390">;</span>&nbsp;<span class="ident" id="1612392">i</span>&nbsp;<span class="op" id="1612394">&gt;=</span>&nbsp;<span class="ident" id="1612397">r</span><span class="op" id="1612398">;</span>&nbsp;<span class="ident" id="1612400">i</span><span class="op" id="1612401">--</span>&nbsp;<span class="op" id="1612404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612408">c</span>&nbsp;<span class="op" id="1612410">:=</span>&nbsp;<span class="ident" id="1612413">lockorder</span><span class="op" id="1612422">[</span><span class="ident" id="1612423">i</span><span class="op" id="1612424">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612428">if</span>&nbsp;<span class="ident" id="1612431">i</span>&nbsp;<span class="op" id="1612433">&gt;</span>&nbsp;<span class="num" id="1612435">0</span>&nbsp;<span class="op" id="1612437">&amp;&amp;</span>&nbsp;<span class="ident" id="1612440">c</span>&nbsp;<span class="op" id="1612442">==</span>&nbsp;<span class="ident" id="1612445">lockorder</span><span class="op" id="1612454">[</span><span class="ident" id="1612455">i</span><span class="op" id="1612456">-</span><span class="num" id="1612457">1</span><span class="op" id="1612458">]</span>&nbsp;<span class="op" id="1612460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612465">continue</span>&nbsp;<span class="comment" id="1612474">//&nbsp;will&nbsp;unlock&nbsp;it&nbsp;on&nbsp;the&nbsp;next&nbsp;iteration</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612520">unlock</span><span class="op" id="1612526">(</span><span class="op" id="1612527">&amp;</span><span class="ident" id="1612528">c</span><span class="op" id="1612529">.</span><span class="ident" id="1612530">lock</span><span class="op" id="1612534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612537">}</span><br>
<span class="lineno"></span><span class="op" id="1612539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="1612542">func</span>&nbsp;<span class="ident" id="1612547">selparkcommit</span><span class="op" id="1612560">(</span><span class="ident" id="1612561">gp</span>&nbsp;<span class="op" id="1612564">*</span><span class="ident" id="1612565">g</span><span class="op" id="1612566">,</span>&nbsp;<span class="ident" id="1612568">sel</span>&nbsp;<span class="op" id="1612572">*</span><span class="ident" id="1612573">_select</span><span class="op" id="1612580">)</span>&nbsp;<span class="builtintype" id="1612582">bool</span>&nbsp;<span class="op" id="1612587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612590">selunlock</span><span class="op" id="1612599">(</span><span class="ident" id="1612600">sel</span><span class="op" id="1612603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1612606">return</span>&nbsp;<span class="builtintype" id="1612613">true</span><br>
<span class="lineno"></span><span class="op" id="1612618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="1612621">func</span>&nbsp;<span class="ident" id="1612626">block</span><span class="op" id="1612631">(</span><span class="op" id="1612632">)</span>&nbsp;<span class="op" id="1612634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612637">gopark</span><span class="op" id="1612643">(</span><span class="ident" id="1612644">nil</span><span class="op" id="1612647">,</span>&nbsp;<span class="ident" id="1612649">nil</span><span class="op" id="1612652">,</span>&nbsp;<span class="string" id="1612654">&#34;select&nbsp;(no&nbsp;cases)&#34;</span><span class="op" id="1612673">)</span>&nbsp;<span class="comment" id="1612675">//&nbsp;forever</span><br>
<span class="lineno"></span><span class="op" id="1612686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612689">//&nbsp;overwrites&nbsp;return&nbsp;pc&nbsp;on&nbsp;stack&nbsp;to&nbsp;signal&nbsp;which&nbsp;case&nbsp;of&nbsp;the&nbsp;select</span><br>
<span class="lineno">180</span><span class="comment" id="1612757">//&nbsp;to&nbsp;run,&nbsp;so&nbsp;cannot&nbsp;appear&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1612814">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1612827">func</span>&nbsp;<span class="ident" id="1612832">selectgo</span><span class="op" id="1612840">(</span><span class="ident" id="1612841">sel</span>&nbsp;<span class="op" id="1612845">*</span><span class="ident" id="1612846">_select</span><span class="op" id="1612853">)</span>&nbsp;<span class="op" id="1612855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612858">pc</span><span class="op" id="1612860">,</span>&nbsp;<span class="ident" id="1612862">offset</span>&nbsp;<span class="op" id="1612869">:=</span>&nbsp;<span class="ident" id="1612872">selectgoImpl</span><span class="op" id="1612884">(</span><span class="ident" id="1612885">sel</span><span class="op" id="1612888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1612891">*</span><span class="op" id="1612892">(</span><span class="op" id="1612893">*</span><span class="builtintype" id="1612894">bool</span><span class="op" id="1612898">)</span><span class="op" id="1612899">(</span><span class="ident" id="1612900">add</span><span class="op" id="1612903">(</span><span class="ident" id="1612904">unsafe</span><span class="op" id="1612910">.</span><span class="ident" id="1612911">Pointer</span><span class="op" id="1612918">(</span><span class="op" id="1612919">&amp;</span><span class="ident" id="1612920">sel</span><span class="op" id="1612923">)</span><span class="op" id="1612924">,</span>&nbsp;<span class="builtintype" id="1612926">uintptr</span><span class="op" id="1612933">(</span><span class="ident" id="1612934">offset</span><span class="op" id="1612940">)</span><span class="op" id="1612941">)</span><span class="op" id="1612942">)</span>&nbsp;<span class="op" id="1612944">=</span>&nbsp;<span class="builtintype" id="1612946">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1612952">setcallerpc</span><span class="op" id="1612963">(</span><span class="ident" id="1612964">unsafe</span><span class="op" id="1612970">.</span><span class="ident" id="1612971">Pointer</span><span class="op" id="1612978">(</span><span class="op" id="1612979">&amp;</span><span class="ident" id="1612980">sel</span><span class="op" id="1612983">)</span><span class="op" id="1612984">,</span>&nbsp;<span class="ident" id="1612986">pc</span><span class="op" id="1612988">)</span><br>
<span class="lineno"></span><span class="op" id="1612990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1612993">//&nbsp;selectgoImpl&nbsp;returns&nbsp;scase.pc&nbsp;and&nbsp;scase.so&nbsp;for&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span><span class="comment" id="1613054">//&nbsp;case&nbsp;which&nbsp;fired.</span><br>
<span class="lineno">190</span><span class="keyword" id="1613075">func</span>&nbsp;<span class="ident" id="1613080">selectgoImpl</span><span class="op" id="1613092">(</span><span class="ident" id="1613093">sel</span>&nbsp;<span class="op" id="1613097">*</span><span class="ident" id="1613098">_select</span><span class="op" id="1613105">)</span>&nbsp;<span class="op" id="1613107">(</span><span class="builtintype" id="1613108">uintptr</span><span class="op" id="1613115">,</span>&nbsp;<span class="builtintype" id="1613117">uint16</span><span class="op" id="1613123">)</span>&nbsp;<span class="op" id="1613125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613128">if</span>&nbsp;<span class="ident" id="1613131">debugSelect</span>&nbsp;<span class="op" id="1613143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1613147">print</span><span class="op" id="1613152">(</span><span class="string" id="1613153">&#34;select:&nbsp;sel=&#34;</span><span class="op" id="1613167">,</span>&nbsp;<span class="ident" id="1613169">sel</span><span class="op" id="1613172">,</span>&nbsp;<span class="string" id="1613174">&#34;\n&#34;</span><span class="op" id="1613178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613185">scaseslice</span>&nbsp;<span class="op" id="1613196">:=</span>&nbsp;<span class="ident" id="1613199">sliceStruct</span><span class="op" id="1613210">{</span><span class="ident" id="1613211">unsafe</span><span class="op" id="1613217">.</span><span class="ident" id="1613218">Pointer</span><span class="op" id="1613225">(</span><span class="op" id="1613226">&amp;</span><span class="ident" id="1613227">sel</span><span class="op" id="1613230">.</span><span class="ident" id="1613231">scase</span><span class="op" id="1613236">)</span><span class="op" id="1613237">,</span>&nbsp;<span class="builtintype" id="1613239">int</span><span class="op" id="1613242">(</span><span class="ident" id="1613243">sel</span><span class="op" id="1613246">.</span><span class="ident" id="1613247">ncase</span><span class="op" id="1613252">)</span><span class="op" id="1613253">,</span>&nbsp;<span class="builtintype" id="1613255">int</span><span class="op" id="1613258">(</span><span class="ident" id="1613259">sel</span><span class="op" id="1613262">.</span><span class="ident" id="1613263">ncase</span><span class="op" id="1613268">)</span><span class="op" id="1613269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613272">scases</span>&nbsp;<span class="op" id="1613279">:=</span>&nbsp;<span class="op" id="1613282">*</span><span class="op" id="1613283">(</span><span class="op" id="1613284">*</span><span class="op" id="1613285">[</span><span class="op" id="1613286">]</span><span class="ident" id="1613287">scase</span><span class="op" id="1613292">)</span><span class="op" id="1613293">(</span><span class="ident" id="1613294">unsafe</span><span class="op" id="1613300">.</span><span class="ident" id="1613301">Pointer</span><span class="op" id="1613308">(</span><span class="op" id="1613309">&amp;</span><span class="ident" id="1613310">scaseslice</span><span class="op" id="1613320">)</span><span class="op" id="1613321">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613325">var</span>&nbsp;<span class="ident" id="1613329">t0</span>&nbsp;<span class="ident" id="1613332">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613339">if</span>&nbsp;<span class="ident" id="1613342">blockprofilerate</span>&nbsp;<span class="op" id="1613359">&gt;</span>&nbsp;<span class="num" id="1613361">0</span>&nbsp;<span class="op" id="1613363">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613367">t0</span>&nbsp;<span class="op" id="1613370">=</span>&nbsp;<span class="ident" id="1613372">cputicks</span><span class="op" id="1613380">(</span><span class="op" id="1613381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1613385">for</span>&nbsp;<span class="ident" id="1613389">i</span>&nbsp;<span class="op" id="1613391">:=</span>&nbsp;<span class="num" id="1613394">0</span><span class="op" id="1613395">;</span>&nbsp;<span class="ident" id="1613397">i</span>&nbsp;<span class="op" id="1613399">&lt;</span>&nbsp;<span class="builtintype" id="1613401">int</span><span class="op" id="1613404">(</span><span class="ident" id="1613405">sel</span><span class="op" id="1613408">.</span><span class="ident" id="1613409">ncase</span><span class="op" id="1613414">)</span><span class="op" id="1613415">;</span>&nbsp;<span class="ident" id="1613417">i</span><span class="op" id="1613418">++</span>&nbsp;<span class="op" id="1613421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613426">scases</span><span class="op" id="1613432">[</span><span class="ident" id="1613433">i</span><span class="op" id="1613434">]</span><span class="op" id="1613435">.</span><span class="ident" id="1613436">releasetime</span>&nbsp;<span class="op" id="1613448">=</span>&nbsp;<span class="op" id="1613450">-</span><span class="num" id="1613451">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1613458">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613462">//&nbsp;The&nbsp;compiler&nbsp;rewrites&nbsp;selects&nbsp;that&nbsp;statically&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613517">//&nbsp;only&nbsp;0&nbsp;or&nbsp;1&nbsp;cases&nbsp;plus&nbsp;default&nbsp;into&nbsp;simpler&nbsp;constructs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613577">//&nbsp;The&nbsp;only&nbsp;way&nbsp;we&nbsp;can&nbsp;end&nbsp;up&nbsp;with&nbsp;such&nbsp;small&nbsp;sel.ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613634">//&nbsp;values&nbsp;here&nbsp;is&nbsp;for&nbsp;a&nbsp;larger&nbsp;select&nbsp;in&nbsp;which&nbsp;most&nbsp;channels</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613696">//&nbsp;have&nbsp;been&nbsp;nilled&nbsp;out.&nbsp;&nbsp;The&nbsp;general&nbsp;code&nbsp;handles&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613754">//&nbsp;cases&nbsp;correctly,&nbsp;and&nbsp;they&nbsp;are&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613814">//&nbsp;optimizing&nbsp;(and&nbsp;needing&nbsp;to&nbsp;test).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1613853">//&nbsp;generate&nbsp;permuted&nbsp;order</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613881">pollslice</span>&nbsp;<span class="op" id="1613891">:=</span>&nbsp;<span class="ident" id="1613894">sliceStruct</span><span class="op" id="1613905">{</span><span class="ident" id="1613906">unsafe</span><span class="op" id="1613912">.</span><span class="ident" id="1613913">Pointer</span><span class="op" id="1613920">(</span><span class="ident" id="1613921">sel</span><span class="op" id="1613924">.</span><span class="ident" id="1613925">pollorder</span><span class="op" id="1613934">)</span><span class="op" id="1613935">,</span>&nbsp;<span class="builtintype" id="1613937">int</span><span class="op" id="1613940">(</span><span class="ident" id="1613941">sel</span><span class="op" id="1613944">.</span><span class="ident" id="1613945">ncase</span><span class="op" id="1613950">)</span><span class="op" id="1613951">,</span>&nbsp;<span class="builtintype" id="1613953">int</span><span class="op" id="1613956">(</span><span class="ident" id="1613957">sel</span><span class="op" id="1613960">.</span><span class="ident" id="1613961">ncase</span><span class="op" id="1613966">)</span><span class="op" id="1613967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1613970">pollorder</span>&nbsp;<span class="op" id="1613980">:=</span>&nbsp;<span class="op" id="1613983">*</span><span class="op" id="1613984">(</span><span class="op" id="1613985">*</span><span class="op" id="1613986">[</span><span class="op" id="1613987">]</span><span class="builtintype" id="1613988">uint16</span><span class="op" id="1613994">)</span><span class="op" id="1613995">(</span><span class="ident" id="1613996">unsafe</span><span class="op" id="1614002">.</span><span class="ident" id="1614003">Pointer</span><span class="op" id="1614010">(</span><span class="op" id="1614011">&amp;</span><span class="ident" id="1614012">pollslice</span><span class="op" id="1614021">)</span><span class="op" id="1614022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614025">for</span>&nbsp;<span class="ident" id="1614029">i</span>&nbsp;<span class="op" id="1614031">:=</span>&nbsp;<span class="num" id="1614034">0</span><span class="op" id="1614035">;</span>&nbsp;<span class="ident" id="1614037">i</span>&nbsp;<span class="op" id="1614039">&lt;</span>&nbsp;<span class="builtintype" id="1614041">int</span><span class="op" id="1614044">(</span><span class="ident" id="1614045">sel</span><span class="op" id="1614048">.</span><span class="ident" id="1614049">ncase</span><span class="op" id="1614054">)</span><span class="op" id="1614055">;</span>&nbsp;<span class="ident" id="1614057">i</span><span class="op" id="1614058">++</span>&nbsp;<span class="op" id="1614061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614065">pollorder</span><span class="op" id="1614074">[</span><span class="ident" id="1614075">i</span><span class="op" id="1614076">]</span>&nbsp;<span class="op" id="1614078">=</span>&nbsp;<span class="builtintype" id="1614080">uint16</span><span class="op" id="1614086">(</span><span class="ident" id="1614087">i</span><span class="op" id="1614088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614091">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614094">for</span>&nbsp;<span class="ident" id="1614098">i</span>&nbsp;<span class="op" id="1614100">:=</span>&nbsp;<span class="num" id="1614103">1</span><span class="op" id="1614104">;</span>&nbsp;<span class="ident" id="1614106">i</span>&nbsp;<span class="op" id="1614108">&lt;</span>&nbsp;<span class="builtintype" id="1614110">int</span><span class="op" id="1614113">(</span><span class="ident" id="1614114">sel</span><span class="op" id="1614117">.</span><span class="ident" id="1614118">ncase</span><span class="op" id="1614123">)</span><span class="op" id="1614124">;</span>&nbsp;<span class="ident" id="1614126">i</span><span class="op" id="1614127">++</span>&nbsp;<span class="op" id="1614130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614134">o</span>&nbsp;<span class="op" id="1614136">:=</span>&nbsp;<span class="ident" id="1614139">pollorder</span><span class="op" id="1614148">[</span><span class="ident" id="1614149">i</span><span class="op" id="1614150">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614154">j</span>&nbsp;<span class="op" id="1614156">:=</span>&nbsp;<span class="builtintype" id="1614159">int</span><span class="op" id="1614162">(</span><span class="ident" id="1614163">fastrand1</span><span class="op" id="1614172">(</span><span class="op" id="1614173">)</span><span class="op" id="1614174">)</span>&nbsp;<span class="op" id="1614176">%</span>&nbsp;<span class="op" id="1614178">(</span><span class="ident" id="1614179">i</span>&nbsp;<span class="op" id="1614181">+</span>&nbsp;<span class="num" id="1614183">1</span><span class="op" id="1614184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614188">pollorder</span><span class="op" id="1614197">[</span><span class="ident" id="1614198">i</span><span class="op" id="1614199">]</span>&nbsp;<span class="op" id="1614201">=</span>&nbsp;<span class="ident" id="1614203">pollorder</span><span class="op" id="1614212">[</span><span class="ident" id="1614213">j</span><span class="op" id="1614214">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614218">pollorder</span><span class="op" id="1614227">[</span><span class="ident" id="1614228">j</span><span class="op" id="1614229">]</span>&nbsp;<span class="op" id="1614231">=</span>&nbsp;<span class="ident" id="1614233">o</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1614240">//&nbsp;sort&nbsp;the&nbsp;cases&nbsp;by&nbsp;Hchan&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;locking&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1614302">//&nbsp;simple&nbsp;heap&nbsp;sort,&nbsp;to&nbsp;guarantee&nbsp;n&nbsp;log&nbsp;n&nbsp;time&nbsp;and&nbsp;constant&nbsp;stack&nbsp;footprint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614380">lockslice</span>&nbsp;<span class="op" id="1614390">:=</span>&nbsp;<span class="ident" id="1614393">sliceStruct</span><span class="op" id="1614404">{</span><span class="ident" id="1614405">unsafe</span><span class="op" id="1614411">.</span><span class="ident" id="1614412">Pointer</span><span class="op" id="1614419">(</span><span class="ident" id="1614420">sel</span><span class="op" id="1614423">.</span><span class="ident" id="1614424">lockorder</span><span class="op" id="1614433">)</span><span class="op" id="1614434">,</span>&nbsp;<span class="builtintype" id="1614436">int</span><span class="op" id="1614439">(</span><span class="ident" id="1614440">sel</span><span class="op" id="1614443">.</span><span class="ident" id="1614444">ncase</span><span class="op" id="1614449">)</span><span class="op" id="1614450">,</span>&nbsp;<span class="builtintype" id="1614452">int</span><span class="op" id="1614455">(</span><span class="ident" id="1614456">sel</span><span class="op" id="1614459">.</span><span class="ident" id="1614460">ncase</span><span class="op" id="1614465">)</span><span class="op" id="1614466">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614469">lockorder</span>&nbsp;<span class="op" id="1614479">:=</span>&nbsp;<span class="op" id="1614482">*</span><span class="op" id="1614483">(</span><span class="op" id="1614484">*</span><span class="op" id="1614485">[</span><span class="op" id="1614486">]</span><span class="op" id="1614487">*</span><span class="ident" id="1614488">hchan</span><span class="op" id="1614493">)</span><span class="op" id="1614494">(</span><span class="ident" id="1614495">unsafe</span><span class="op" id="1614501">.</span><span class="ident" id="1614502">Pointer</span><span class="op" id="1614509">(</span><span class="op" id="1614510">&amp;</span><span class="ident" id="1614511">lockslice</span><span class="op" id="1614520">)</span><span class="op" id="1614521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614524">for</span>&nbsp;<span class="ident" id="1614528">i</span>&nbsp;<span class="op" id="1614530">:=</span>&nbsp;<span class="num" id="1614533">0</span><span class="op" id="1614534">;</span>&nbsp;<span class="ident" id="1614536">i</span>&nbsp;<span class="op" id="1614538">&lt;</span>&nbsp;<span class="builtintype" id="1614540">int</span><span class="op" id="1614543">(</span><span class="ident" id="1614544">sel</span><span class="op" id="1614547">.</span><span class="ident" id="1614548">ncase</span><span class="op" id="1614553">)</span><span class="op" id="1614554">;</span>&nbsp;<span class="ident" id="1614556">i</span><span class="op" id="1614557">++</span>&nbsp;<span class="op" id="1614560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614564">j</span>&nbsp;<span class="op" id="1614566">:=</span>&nbsp;<span class="ident" id="1614569">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614573">c</span>&nbsp;<span class="op" id="1614575">:=</span>&nbsp;<span class="ident" id="1614578">scases</span><span class="op" id="1614584">[</span><span class="ident" id="1614585">j</span><span class="op" id="1614586">]</span><span class="op" id="1614587">.</span><span class="ident" id="1614588">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614596">for</span>&nbsp;<span class="ident" id="1614600">j</span>&nbsp;<span class="op" id="1614602">&gt;</span>&nbsp;<span class="num" id="1614604">0</span>&nbsp;<span class="op" id="1614606">&amp;&amp;</span>&nbsp;<span class="ident" id="1614609">lockorder</span><span class="op" id="1614618">[</span><span class="op" id="1614619">(</span><span class="ident" id="1614620">j</span><span class="op" id="1614621">-</span><span class="num" id="1614622">1</span><span class="op" id="1614623">)</span><span class="op" id="1614624">/</span><span class="num" id="1614625">2</span><span class="op" id="1614626">]</span><span class="op" id="1614627">.</span><span class="ident" id="1614628">sortkey</span><span class="op" id="1614635">(</span><span class="op" id="1614636">)</span>&nbsp;<span class="op" id="1614638">&lt;</span>&nbsp;<span class="ident" id="1614640">c</span><span class="op" id="1614641">.</span><span class="ident" id="1614642">sortkey</span><span class="op" id="1614649">(</span><span class="op" id="1614650">)</span>&nbsp;<span class="op" id="1614652">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614657">k</span>&nbsp;<span class="op" id="1614659">:=</span>&nbsp;<span class="op" id="1614662">(</span><span class="ident" id="1614663">j</span>&nbsp;<span class="op" id="1614665">-</span>&nbsp;<span class="num" id="1614667">1</span><span class="op" id="1614668">)</span>&nbsp;<span class="op" id="1614670">/</span>&nbsp;<span class="num" id="1614672">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614677">lockorder</span><span class="op" id="1614686">[</span><span class="ident" id="1614687">j</span><span class="op" id="1614688">]</span>&nbsp;<span class="op" id="1614690">=</span>&nbsp;<span class="ident" id="1614692">lockorder</span><span class="op" id="1614701">[</span><span class="ident" id="1614702">k</span><span class="op" id="1614703">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614708">j</span>&nbsp;<span class="op" id="1614710">=</span>&nbsp;<span class="ident" id="1614712">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614720">lockorder</span><span class="op" id="1614729">[</span><span class="ident" id="1614730">j</span><span class="op" id="1614731">]</span>&nbsp;<span class="op" id="1614733">=</span>&nbsp;<span class="ident" id="1614735">c</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614741">for</span>&nbsp;<span class="ident" id="1614745">i</span>&nbsp;<span class="op" id="1614747">:=</span>&nbsp;<span class="builtintype" id="1614750">int</span><span class="op" id="1614753">(</span><span class="ident" id="1614754">sel</span><span class="op" id="1614757">.</span><span class="ident" id="1614758">ncase</span><span class="op" id="1614763">)</span>&nbsp;<span class="op" id="1614765">-</span>&nbsp;<span class="num" id="1614767">1</span><span class="op" id="1614768">;</span>&nbsp;<span class="ident" id="1614770">i</span>&nbsp;<span class="op" id="1614772">&gt;=</span>&nbsp;<span class="num" id="1614775">0</span><span class="op" id="1614776">;</span>&nbsp;<span class="ident" id="1614778">i</span><span class="op" id="1614779">--</span>&nbsp;<span class="op" id="1614782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614786">c</span>&nbsp;<span class="op" id="1614788">:=</span>&nbsp;<span class="ident" id="1614791">lockorder</span><span class="op" id="1614800">[</span><span class="ident" id="1614801">i</span><span class="op" id="1614802">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614806">lockorder</span><span class="op" id="1614815">[</span><span class="ident" id="1614816">i</span><span class="op" id="1614817">]</span>&nbsp;<span class="op" id="1614819">=</span>&nbsp;<span class="ident" id="1614821">lockorder</span><span class="op" id="1614830">[</span><span class="num" id="1614831">0</span><span class="op" id="1614832">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614836">j</span>&nbsp;<span class="op" id="1614838">:=</span>&nbsp;<span class="num" id="1614841">0</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614845">for</span>&nbsp;<span class="op" id="1614849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614854">k</span>&nbsp;<span class="op" id="1614856">:=</span>&nbsp;<span class="ident" id="1614859">j</span><span class="op" id="1614860">*</span><span class="num" id="1614861">2</span>&nbsp;<span class="op" id="1614863">+</span>&nbsp;<span class="num" id="1614865">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614870">if</span>&nbsp;<span class="ident" id="1614873">k</span>&nbsp;<span class="op" id="1614875">&gt;=</span>&nbsp;<span class="ident" id="1614878">i</span>&nbsp;<span class="op" id="1614880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614886">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614895">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614900">if</span>&nbsp;<span class="ident" id="1614903">k</span><span class="op" id="1614904">+</span><span class="num" id="1614905">1</span>&nbsp;<span class="op" id="1614907">&lt;</span>&nbsp;<span class="ident" id="1614909">i</span>&nbsp;<span class="op" id="1614911">&amp;&amp;</span>&nbsp;<span class="ident" id="1614914">lockorder</span><span class="op" id="1614923">[</span><span class="ident" id="1614924">k</span><span class="op" id="1614925">]</span><span class="op" id="1614926">.</span><span class="ident" id="1614927">sortkey</span><span class="op" id="1614934">(</span><span class="op" id="1614935">)</span>&nbsp;<span class="op" id="1614937">&lt;</span>&nbsp;<span class="ident" id="1614939">lockorder</span><span class="op" id="1614948">[</span><span class="ident" id="1614949">k</span><span class="op" id="1614950">+</span><span class="num" id="1614951">1</span><span class="op" id="1614952">]</span><span class="op" id="1614953">.</span><span class="ident" id="1614954">sortkey</span><span class="op" id="1614961">(</span><span class="op" id="1614962">)</span>&nbsp;<span class="op" id="1614964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1614970">k</span><span class="op" id="1614971">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1614977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1614982">if</span>&nbsp;<span class="ident" id="1614985">c</span><span class="op" id="1614986">.</span><span class="ident" id="1614987">sortkey</span><span class="op" id="1614994">(</span><span class="op" id="1614995">)</span>&nbsp;<span class="op" id="1614997">&lt;</span>&nbsp;<span class="ident" id="1614999">lockorder</span><span class="op" id="1615008">[</span><span class="ident" id="1615009">k</span><span class="op" id="1615010">]</span><span class="op" id="1615011">.</span><span class="ident" id="1615012">sortkey</span><span class="op" id="1615019">(</span><span class="op" id="1615020">)</span>&nbsp;<span class="op" id="1615022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615028">lockorder</span><span class="op" id="1615037">[</span><span class="ident" id="1615038">j</span><span class="op" id="1615039">]</span>&nbsp;<span class="op" id="1615041">=</span>&nbsp;<span class="ident" id="1615043">lockorder</span><span class="op" id="1615052">[</span><span class="ident" id="1615053">k</span><span class="op" id="1615054">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615060">j</span>&nbsp;<span class="op" id="1615062">=</span>&nbsp;<span class="ident" id="1615064">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615070">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615087">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615095">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615099">lockorder</span><span class="op" id="1615108">[</span><span class="ident" id="1615109">j</span><span class="op" id="1615110">]</span>&nbsp;<span class="op" id="1615112">=</span>&nbsp;<span class="ident" id="1615114">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615120">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfor&nbsp;i&nbsp;:=&nbsp;0;&nbsp;i+1&nbsp;&lt;&nbsp;int(sel.ncase);&nbsp;i++&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;lockorder[i].sortkey()&nbsp;&gt;&nbsp;lockorder[i+1].sortkey()&nbsp;{<br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspprint(&#34;i=&#34;,&nbsp;i,&nbsp;&#34;&nbsp;x=&#34;,&nbsp;lockorder[i],&nbsp;&#34;&nbsp;y=&#34;,&nbsp;lockorder[i+1],&nbsp;&#34;\n&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgothrow(&#34;select:&nbsp;broken&nbsp;sort&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*/</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615342">//&nbsp;lock&nbsp;all&nbsp;the&nbsp;channels&nbsp;involved&nbsp;in&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615391">sellock</span><span class="op" id="1615398">(</span><span class="ident" id="1615399">sel</span><span class="op" id="1615402">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615406">var</span>&nbsp;<span class="op" id="1615410">(</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615414">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1615421">*</span><span class="ident" id="1615422">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615426">done</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1615433">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615442">sg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1615449">*</span><span class="ident" id="1615450">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615458">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1615465">*</span><span class="ident" id="1615466">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615474">k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1615481">*</span><span class="ident" id="1615482">scase</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615490">sglist</span>&nbsp;<span class="op" id="1615497">*</span><span class="ident" id="1615498">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615506">sgnext</span>&nbsp;<span class="op" id="1615513">*</span><span class="ident" id="1615514">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615521">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1615524">loop</span><span class="op" id="1615528">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1615531">//&nbsp;pass&nbsp;1&nbsp;-&nbsp;look&nbsp;for&nbsp;something&nbsp;already&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615579">var</span>&nbsp;<span class="ident" id="1615583">dfl</span>&nbsp;<span class="op" id="1615587">*</span><span class="ident" id="1615588">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615595">var</span>&nbsp;<span class="ident" id="1615599">cas</span>&nbsp;<span class="op" id="1615603">*</span><span class="ident" id="1615604">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615611">for</span>&nbsp;<span class="ident" id="1615615">i</span>&nbsp;<span class="op" id="1615617">:=</span>&nbsp;<span class="num" id="1615620">0</span><span class="op" id="1615621">;</span>&nbsp;<span class="ident" id="1615623">i</span>&nbsp;<span class="op" id="1615625">&lt;</span>&nbsp;<span class="builtintype" id="1615627">int</span><span class="op" id="1615630">(</span><span class="ident" id="1615631">sel</span><span class="op" id="1615634">.</span><span class="ident" id="1615635">ncase</span><span class="op" id="1615640">)</span><span class="op" id="1615641">;</span>&nbsp;<span class="ident" id="1615643">i</span><span class="op" id="1615644">++</span>&nbsp;<span class="op" id="1615647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615651">cas</span>&nbsp;<span class="op" id="1615655">=</span>&nbsp;<span class="op" id="1615657">&amp;</span><span class="ident" id="1615658">scases</span><span class="op" id="1615664">[</span><span class="ident" id="1615665">pollorder</span><span class="op" id="1615674">[</span><span class="ident" id="1615675">i</span><span class="op" id="1615676">]</span><span class="op" id="1615677">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615681">c</span>&nbsp;<span class="op" id="1615683">=</span>&nbsp;<span class="ident" id="1615685">cas</span><span class="op" id="1615688">.</span><span class="ident" id="1615689">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615698">switch</span>&nbsp;<span class="ident" id="1615705">cas</span><span class="op" id="1615708">.</span><span class="ident" id="1615709">kind</span>&nbsp;<span class="op" id="1615714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615718">case</span>&nbsp;<span class="ident" id="1615723">_CaseRecv</span><span class="op" id="1615732">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615737">if</span>&nbsp;<span class="ident" id="1615740">c</span><span class="op" id="1615741">.</span><span class="ident" id="1615742">dataqsiz</span>&nbsp;<span class="op" id="1615751">&gt;</span>&nbsp;<span class="num" id="1615753">0</span>&nbsp;<span class="op" id="1615755">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615761">if</span>&nbsp;<span class="ident" id="1615764">c</span><span class="op" id="1615765">.</span><span class="ident" id="1615766">qcount</span>&nbsp;<span class="op" id="1615773">&gt;</span>&nbsp;<span class="num" id="1615775">0</span>&nbsp;<span class="op" id="1615777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615784">goto</span>&nbsp;<span class="ident" id="1615789">asyncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615808">}</span>&nbsp;<span class="keyword" id="1615810">else</span>&nbsp;<span class="op" id="1615815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615821">sg</span>&nbsp;<span class="op" id="1615824">=</span>&nbsp;<span class="ident" id="1615826">c</span><span class="op" id="1615827">.</span><span class="ident" id="1615828">sendq</span><span class="op" id="1615833">.</span><span class="ident" id="1615834">dequeue</span><span class="op" id="1615841">(</span><span class="op" id="1615842">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615848">if</span>&nbsp;<span class="ident" id="1615851">sg</span>&nbsp;<span class="op" id="1615854">!=</span>&nbsp;<span class="ident" id="1615857">nil</span>&nbsp;<span class="op" id="1615861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615868">goto</span>&nbsp;<span class="ident" id="1615873">syncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615896">if</span>&nbsp;<span class="ident" id="1615899">c</span><span class="op" id="1615900">.</span><span class="ident" id="1615901">closed</span>&nbsp;<span class="op" id="1615908">!=</span>&nbsp;<span class="num" id="1615911">0</span>&nbsp;<span class="op" id="1615913">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615919">goto</span>&nbsp;<span class="ident" id="1615924">rclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1615934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615939">case</span>&nbsp;<span class="ident" id="1615944">_CaseSend</span><span class="op" id="1615953">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1615958">if</span>&nbsp;<span class="ident" id="1615961">raceenabled</span>&nbsp;<span class="op" id="1615973">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1615979">racereadpc</span><span class="op" id="1615989">(</span><span class="ident" id="1615990">unsafe</span><span class="op" id="1615996">.</span><span class="ident" id="1615997">Pointer</span><span class="op" id="1616004">(</span><span class="ident" id="1616005">c</span><span class="op" id="1616006">)</span><span class="op" id="1616007">,</span>&nbsp;<span class="ident" id="1616009">cas</span><span class="op" id="1616012">.</span><span class="ident" id="1616013">pc</span><span class="op" id="1616015">,</span>&nbsp;<span class="ident" id="1616017">chansendpc</span><span class="op" id="1616027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616037">if</span>&nbsp;<span class="ident" id="1616040">c</span><span class="op" id="1616041">.</span><span class="ident" id="1616042">closed</span>&nbsp;<span class="op" id="1616049">!=</span>&nbsp;<span class="num" id="1616052">0</span>&nbsp;<span class="op" id="1616054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616060">goto</span>&nbsp;<span class="ident" id="1616065">sclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616075">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616080">if</span>&nbsp;<span class="ident" id="1616083">c</span><span class="op" id="1616084">.</span><span class="ident" id="1616085">dataqsiz</span>&nbsp;<span class="op" id="1616094">&gt;</span>&nbsp;<span class="num" id="1616096">0</span>&nbsp;<span class="op" id="1616098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616104">if</span>&nbsp;<span class="ident" id="1616107">c</span><span class="op" id="1616108">.</span><span class="ident" id="1616109">qcount</span>&nbsp;<span class="op" id="1616116">&lt;</span>&nbsp;<span class="ident" id="1616118">c</span><span class="op" id="1616119">.</span><span class="ident" id="1616120">dataqsiz</span>&nbsp;<span class="op" id="1616129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616136">goto</span>&nbsp;<span class="ident" id="1616141">asyncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616160">}</span>&nbsp;<span class="keyword" id="1616162">else</span>&nbsp;<span class="op" id="1616167">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616173">sg</span>&nbsp;<span class="op" id="1616176">=</span>&nbsp;<span class="ident" id="1616178">c</span><span class="op" id="1616179">.</span><span class="ident" id="1616180">recvq</span><span class="op" id="1616185">.</span><span class="ident" id="1616186">dequeue</span><span class="op" id="1616193">(</span><span class="op" id="1616194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616200">if</span>&nbsp;<span class="ident" id="1616203">sg</span>&nbsp;<span class="op" id="1616206">!=</span>&nbsp;<span class="ident" id="1616209">nil</span>&nbsp;<span class="op" id="1616213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616220">goto</span>&nbsp;<span class="ident" id="1616225">syncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616243">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616248">case</span>&nbsp;<span class="ident" id="1616253">_CaseDefault</span><span class="op" id="1616265">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616270">dfl</span>&nbsp;<span class="op" id="1616274">=</span>&nbsp;<span class="ident" id="1616276">cas</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616285">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616289">if</span>&nbsp;<span class="ident" id="1616292">dfl</span>&nbsp;<span class="op" id="1616296">!=</span>&nbsp;<span class="ident" id="1616299">nil</span>&nbsp;<span class="op" id="1616303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616307">selunlock</span><span class="op" id="1616316">(</span><span class="ident" id="1616317">sel</span><span class="op" id="1616320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616324">cas</span>&nbsp;<span class="op" id="1616328">=</span>&nbsp;<span class="ident" id="1616330">dfl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616336">goto</span>&nbsp;<span class="ident" id="1616341">retc</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616351">//&nbsp;pass&nbsp;2&nbsp;-&nbsp;enqueue&nbsp;on&nbsp;all&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616385">gp</span>&nbsp;<span class="op" id="1616388">=</span>&nbsp;<span class="ident" id="1616390">getg</span><span class="op" id="1616394">(</span><span class="op" id="1616395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616398">done</span>&nbsp;<span class="op" id="1616403">=</span>&nbsp;<span class="num" id="1616405">0</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616408">for</span>&nbsp;<span class="ident" id="1616412">i</span>&nbsp;<span class="op" id="1616414">:=</span>&nbsp;<span class="num" id="1616417">0</span><span class="op" id="1616418">;</span>&nbsp;<span class="ident" id="1616420">i</span>&nbsp;<span class="op" id="1616422">&lt;</span>&nbsp;<span class="builtintype" id="1616424">int</span><span class="op" id="1616427">(</span><span class="ident" id="1616428">sel</span><span class="op" id="1616431">.</span><span class="ident" id="1616432">ncase</span><span class="op" id="1616437">)</span><span class="op" id="1616438">;</span>&nbsp;<span class="ident" id="1616440">i</span><span class="op" id="1616441">++</span>&nbsp;<span class="op" id="1616444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616448">cas</span>&nbsp;<span class="op" id="1616452">=</span>&nbsp;<span class="op" id="1616454">&amp;</span><span class="ident" id="1616455">scases</span><span class="op" id="1616461">[</span><span class="ident" id="1616462">pollorder</span><span class="op" id="1616471">[</span><span class="ident" id="1616472">i</span><span class="op" id="1616473">]</span><span class="op" id="1616474">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616478">c</span>&nbsp;<span class="op" id="1616480">=</span>&nbsp;<span class="ident" id="1616482">cas</span><span class="op" id="1616485">.</span><span class="ident" id="1616486">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616494">sg</span>&nbsp;<span class="op" id="1616497">:=</span>&nbsp;<span class="ident" id="1616500">acquireSudog</span><span class="op" id="1616512">(</span><span class="op" id="1616513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616517">sg</span><span class="op" id="1616519">.</span><span class="ident" id="1616520">g</span>&nbsp;<span class="op" id="1616522">=</span>&nbsp;<span class="ident" id="1616524">gp</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616529">//&nbsp;Note:&nbsp;selectdone&nbsp;is&nbsp;adjusted&nbsp;for&nbsp;stack&nbsp;copies&nbsp;in&nbsp;stack.c:adjustsudogs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616604">sg</span><span class="op" id="1616606">.</span><span class="ident" id="1616607">selectdone</span>&nbsp;<span class="op" id="1616618">=</span>&nbsp;<span class="op" id="1616620">(</span><span class="op" id="1616621">*</span><span class="builtintype" id="1616622">uint32</span><span class="op" id="1616628">)</span><span class="op" id="1616629">(</span><span class="ident" id="1616630">noescape</span><span class="op" id="1616638">(</span><span class="ident" id="1616639">unsafe</span><span class="op" id="1616645">.</span><span class="ident" id="1616646">Pointer</span><span class="op" id="1616653">(</span><span class="op" id="1616654">&amp;</span><span class="ident" id="1616655">done</span><span class="op" id="1616659">)</span><span class="op" id="1616660">)</span><span class="op" id="1616661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616665">sg</span><span class="op" id="1616667">.</span><span class="ident" id="1616668">elem</span>&nbsp;<span class="op" id="1616673">=</span>&nbsp;<span class="ident" id="1616675">cas</span><span class="op" id="1616678">.</span><span class="ident" id="1616679">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616686">sg</span><span class="op" id="1616688">.</span><span class="ident" id="1616689">releasetime</span>&nbsp;<span class="op" id="1616701">=</span>&nbsp;<span class="num" id="1616703">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616707">if</span>&nbsp;<span class="ident" id="1616710">t0</span>&nbsp;<span class="op" id="1616713">!=</span>&nbsp;<span class="num" id="1616716">0</span>&nbsp;<span class="op" id="1616718">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616723">sg</span><span class="op" id="1616725">.</span><span class="ident" id="1616726">releasetime</span>&nbsp;<span class="op" id="1616738">=</span>&nbsp;<span class="op" id="1616740">-</span><span class="num" id="1616741">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616749">sg</span><span class="op" id="1616751">.</span><span class="ident" id="1616752">waitlink</span>&nbsp;<span class="op" id="1616761">=</span>&nbsp;<span class="ident" id="1616763">gp</span><span class="op" id="1616765">.</span><span class="ident" id="1616766">waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616776">gp</span><span class="op" id="1616778">.</span><span class="ident" id="1616779">waiting</span>&nbsp;<span class="op" id="1616787">=</span>&nbsp;<span class="ident" id="1616789">sg</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616795">switch</span>&nbsp;<span class="ident" id="1616802">cas</span><span class="op" id="1616805">.</span><span class="ident" id="1616806">kind</span>&nbsp;<span class="op" id="1616811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616815">case</span>&nbsp;<span class="ident" id="1616820">_CaseRecv</span><span class="op" id="1616829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616834">c</span><span class="op" id="1616835">.</span><span class="ident" id="1616836">recvq</span><span class="op" id="1616841">.</span><span class="ident" id="1616842">enqueue</span><span class="op" id="1616849">(</span><span class="ident" id="1616850">sg</span><span class="op" id="1616852">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1616857">case</span>&nbsp;<span class="ident" id="1616862">_CaseSend</span><span class="op" id="1616871">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616876">c</span><span class="op" id="1616877">.</span><span class="ident" id="1616878">sendq</span><span class="op" id="1616883">.</span><span class="ident" id="1616884">enqueue</span><span class="op" id="1616891">(</span><span class="ident" id="1616892">sg</span><span class="op" id="1616894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1616901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1616905">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;wake&nbsp;us&nbsp;up</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616940">gp</span><span class="op" id="1616942">.</span><span class="ident" id="1616943">param</span>&nbsp;<span class="op" id="1616949">=</span>&nbsp;<span class="ident" id="1616951">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1616956">gopark</span><span class="op" id="1616962">(</span><span class="ident" id="1616963">unsafe</span><span class="op" id="1616969">.</span><span class="ident" id="1616970">Pointer</span><span class="op" id="1616977">(</span><span class="ident" id="1616978">funcPC</span><span class="op" id="1616984">(</span><span class="ident" id="1616985">selparkcommit</span><span class="op" id="1616998">)</span><span class="op" id="1616999">)</span><span class="op" id="1617000">,</span>&nbsp;<span class="ident" id="1617002">unsafe</span><span class="op" id="1617008">.</span><span class="ident" id="1617009">Pointer</span><span class="op" id="1617016">(</span><span class="ident" id="1617017">sel</span><span class="op" id="1617020">)</span><span class="op" id="1617021">,</span>&nbsp;<span class="string" id="1617023">&#34;select&#34;</span><span class="op" id="1617031">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617035">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617058">sellock</span><span class="op" id="1617065">(</span><span class="ident" id="1617066">sel</span><span class="op" id="1617069">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617072">sg</span>&nbsp;<span class="op" id="1617075">=</span>&nbsp;<span class="op" id="1617077">(</span><span class="op" id="1617078">*</span><span class="ident" id="1617079">sudog</span><span class="op" id="1617084">)</span><span class="op" id="1617085">(</span><span class="ident" id="1617086">gp</span><span class="op" id="1617088">.</span><span class="ident" id="1617089">param</span><span class="op" id="1617094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617097">gp</span><span class="op" id="1617099">.</span><span class="ident" id="1617100">param</span>&nbsp;<span class="op" id="1617106">=</span>&nbsp;<span class="ident" id="1617108">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617114">//&nbsp;pass&nbsp;3&nbsp;-&nbsp;dequeue&nbsp;from&nbsp;unsuccessful&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617159">//&nbsp;otherwise&nbsp;they&nbsp;stack&nbsp;up&nbsp;on&nbsp;quiet&nbsp;channels</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617205">//&nbsp;record&nbsp;the&nbsp;successful&nbsp;case,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617245">//&nbsp;We&nbsp;singly-linked&nbsp;up&nbsp;the&nbsp;SudoGs&nbsp;in&nbsp;case&nbsp;order,&nbsp;so&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617303">//&nbsp;iterating&nbsp;through&nbsp;the&nbsp;linked&nbsp;list&nbsp;they&nbsp;are&nbsp;in&nbsp;reverse&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617368">cas</span>&nbsp;<span class="op" id="1617372">=</span>&nbsp;<span class="ident" id="1617374">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617379">sglist</span>&nbsp;<span class="op" id="1617386">=</span>&nbsp;<span class="ident" id="1617388">gp</span><span class="op" id="1617390">.</span><span class="ident" id="1617391">waiting</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617400">//&nbsp;Clear&nbsp;all&nbsp;selectdone&nbsp;and&nbsp;elem&nbsp;before&nbsp;unlinking&nbsp;from&nbsp;gp.waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617468">//&nbsp;They&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;being&nbsp;put&nbsp;back&nbsp;into&nbsp;the&nbsp;sudog&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617537">//&nbsp;Clear&nbsp;before&nbsp;unlinking,&nbsp;because&nbsp;if&nbsp;a&nbsp;stack&nbsp;copy&nbsp;happens&nbsp;after&nbsp;the&nbsp;unlink,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617615">//&nbsp;they&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;they&nbsp;will&nbsp;be&nbsp;left&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;stack,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617690">//&nbsp;which&nbsp;creates&nbsp;dangling&nbsp;pointers,&nbsp;which&nbsp;may&nbsp;be&nbsp;detected&nbsp;by&nbsp;the</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1617756">//&nbsp;garbage&nbsp;collector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617779">for</span>&nbsp;<span class="ident" id="1617783">sg1</span>&nbsp;<span class="op" id="1617787">:=</span>&nbsp;<span class="ident" id="1617790">gp</span><span class="op" id="1617792">.</span><span class="ident" id="1617793">waiting</span><span class="op" id="1617800">;</span>&nbsp;<span class="ident" id="1617802">sg1</span>&nbsp;<span class="op" id="1617806">!=</span>&nbsp;<span class="ident" id="1617809">nil</span><span class="op" id="1617812">;</span>&nbsp;<span class="ident" id="1617814">sg1</span>&nbsp;<span class="op" id="1617818">=</span>&nbsp;<span class="ident" id="1617820">sg1</span><span class="op" id="1617823">.</span><span class="ident" id="1617824">waitlink</span>&nbsp;<span class="op" id="1617833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617837">sg1</span><span class="op" id="1617840">.</span><span class="ident" id="1617841">selectdone</span>&nbsp;<span class="op" id="1617852">=</span>&nbsp;<span class="ident" id="1617854">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617860">sg1</span><span class="op" id="1617863">.</span><span class="ident" id="1617864">elem</span>&nbsp;<span class="op" id="1617869">=</span>&nbsp;<span class="ident" id="1617871">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1617876">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617879">gp</span><span class="op" id="1617881">.</span><span class="ident" id="1617882">waiting</span>&nbsp;<span class="op" id="1617890">=</span>&nbsp;<span class="ident" id="1617892">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617897">for</span>&nbsp;<span class="ident" id="1617901">i</span>&nbsp;<span class="op" id="1617903">:=</span>&nbsp;<span class="builtintype" id="1617906">int</span><span class="op" id="1617909">(</span><span class="ident" id="1617910">sel</span><span class="op" id="1617913">.</span><span class="ident" id="1617914">ncase</span><span class="op" id="1617919">)</span>&nbsp;<span class="op" id="1617921">-</span>&nbsp;<span class="num" id="1617923">1</span><span class="op" id="1617924">;</span>&nbsp;<span class="ident" id="1617926">i</span>&nbsp;<span class="op" id="1617928">&gt;=</span>&nbsp;<span class="num" id="1617931">0</span><span class="op" id="1617932">;</span>&nbsp;<span class="ident" id="1617934">i</span><span class="op" id="1617935">--</span>&nbsp;<span class="op" id="1617938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1617942">k</span>&nbsp;<span class="op" id="1617944">=</span>&nbsp;<span class="op" id="1617946">&amp;</span><span class="ident" id="1617947">scases</span><span class="op" id="1617953">[</span><span class="ident" id="1617954">pollorder</span><span class="op" id="1617963">[</span><span class="ident" id="1617964">i</span><span class="op" id="1617965">]</span><span class="op" id="1617966">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1617970">if</span>&nbsp;<span class="ident" id="1617973">sglist</span><span class="op" id="1617979">.</span><span class="ident" id="1617980">releasetime</span>&nbsp;<span class="op" id="1617992">&gt;</span>&nbsp;<span class="num" id="1617994">0</span>&nbsp;<span class="op" id="1617996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618001">k</span><span class="op" id="1618002">.</span><span class="ident" id="1618003">releasetime</span>&nbsp;<span class="op" id="1618015">=</span>&nbsp;<span class="ident" id="1618017">sglist</span><span class="op" id="1618023">.</span><span class="ident" id="1618024">releasetime</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618042">if</span>&nbsp;<span class="ident" id="1618045">sg</span>&nbsp;<span class="op" id="1618048">==</span>&nbsp;<span class="ident" id="1618051">sglist</span>&nbsp;<span class="op" id="1618058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618063">cas</span>&nbsp;<span class="op" id="1618067">=</span>&nbsp;<span class="ident" id="1618069">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618073">}</span>&nbsp;<span class="keyword" id="1618075">else</span>&nbsp;<span class="op" id="1618080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618085">c</span>&nbsp;<span class="op" id="1618087">=</span>&nbsp;<span class="ident" id="1618089">k</span><span class="op" id="1618090">.</span><span class="ident" id="1618091">_chan</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618100">if</span>&nbsp;<span class="ident" id="1618103">k</span><span class="op" id="1618104">.</span><span class="ident" id="1618105">kind</span>&nbsp;<span class="op" id="1618110">==</span>&nbsp;<span class="ident" id="1618113">_CaseSend</span>&nbsp;<span class="op" id="1618123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618129">c</span><span class="op" id="1618130">.</span><span class="ident" id="1618131">sendq</span><span class="op" id="1618136">.</span><span class="ident" id="1618137">dequeueSudoG</span><span class="op" id="1618149">(</span><span class="ident" id="1618150">sglist</span><span class="op" id="1618156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618161">}</span>&nbsp;<span class="keyword" id="1618163">else</span>&nbsp;<span class="op" id="1618168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618174">c</span><span class="op" id="1618175">.</span><span class="ident" id="1618176">recvq</span><span class="op" id="1618181">.</span><span class="ident" id="1618182">dequeueSudoG</span><span class="op" id="1618194">(</span><span class="ident" id="1618195">sglist</span><span class="op" id="1618201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618206">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618214">sgnext</span>&nbsp;<span class="op" id="1618221">=</span>&nbsp;<span class="ident" id="1618223">sglist</span><span class="op" id="1618229">.</span><span class="ident" id="1618230">waitlink</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618241">sglist</span><span class="op" id="1618247">.</span><span class="ident" id="1618248">waitlink</span>&nbsp;<span class="op" id="1618257">=</span>&nbsp;<span class="ident" id="1618259">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618265">releaseSudog</span><span class="op" id="1618277">(</span><span class="ident" id="1618278">sglist</span><span class="op" id="1618284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618288">sglist</span>&nbsp;<span class="op" id="1618295">=</span>&nbsp;<span class="ident" id="1618297">sgnext</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618309">if</span>&nbsp;<span class="ident" id="1618312">cas</span>&nbsp;<span class="op" id="1618316">==</span>&nbsp;<span class="ident" id="1618319">nil</span>&nbsp;<span class="op" id="1618323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618327">goto</span>&nbsp;<span class="ident" id="1618332">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618338">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618342">c</span>&nbsp;<span class="op" id="1618344">=</span>&nbsp;<span class="ident" id="1618346">cas</span><span class="op" id="1618349">.</span><span class="ident" id="1618350">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618358">if</span>&nbsp;<span class="ident" id="1618361">c</span><span class="op" id="1618362">.</span><span class="ident" id="1618363">dataqsiz</span>&nbsp;<span class="op" id="1618372">&gt;</span>&nbsp;<span class="num" id="1618374">0</span>&nbsp;<span class="op" id="1618376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618380">gothrow</span><span class="op" id="1618387">(</span><span class="string" id="1618388">&#34;selectgo:&nbsp;shouldn&#39;t&nbsp;happen&#34;</span><span class="op" id="1618416">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618423">if</span>&nbsp;<span class="ident" id="1618426">debugSelect</span>&nbsp;<span class="op" id="1618438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1618442">print</span><span class="op" id="1618447">(</span><span class="string" id="1618448">&#34;wait-return:&nbsp;sel=&#34;</span><span class="op" id="1618467">,</span>&nbsp;<span class="ident" id="1618469">sel</span><span class="op" id="1618472">,</span>&nbsp;<span class="string" id="1618474">&#34;&nbsp;c=&#34;</span><span class="op" id="1618479">,</span>&nbsp;<span class="ident" id="1618481">c</span><span class="op" id="1618482">,</span>&nbsp;<span class="string" id="1618484">&#34;&nbsp;cas=&#34;</span><span class="op" id="1618491">,</span>&nbsp;<span class="ident" id="1618493">cas</span><span class="op" id="1618496">,</span>&nbsp;<span class="string" id="1618498">&#34;&nbsp;kind=&#34;</span><span class="op" id="1618506">,</span>&nbsp;<span class="ident" id="1618508">cas</span><span class="op" id="1618511">.</span><span class="ident" id="1618512">kind</span><span class="op" id="1618516">,</span>&nbsp;<span class="string" id="1618518">&#34;\n&#34;</span><span class="op" id="1618522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618525">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618529">if</span>&nbsp;<span class="ident" id="1618532">cas</span><span class="op" id="1618535">.</span><span class="ident" id="1618536">kind</span>&nbsp;<span class="op" id="1618541">==</span>&nbsp;<span class="ident" id="1618544">_CaseRecv</span>&nbsp;<span class="op" id="1618554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618558">if</span>&nbsp;<span class="ident" id="1618561">cas</span><span class="op" id="1618564">.</span><span class="ident" id="1618565">receivedp</span>&nbsp;<span class="op" id="1618575">!=</span>&nbsp;<span class="ident" id="1618578">nil</span>&nbsp;<span class="op" id="1618582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618587">*</span><span class="ident" id="1618588">cas</span><span class="op" id="1618591">.</span><span class="ident" id="1618592">receivedp</span>&nbsp;<span class="op" id="1618602">=</span>&nbsp;<span class="builtintype" id="1618604">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618611">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618618">if</span>&nbsp;<span class="ident" id="1618621">raceenabled</span>&nbsp;<span class="op" id="1618633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618637">if</span>&nbsp;<span class="ident" id="1618640">cas</span><span class="op" id="1618643">.</span><span class="ident" id="1618644">kind</span>&nbsp;<span class="op" id="1618649">==</span>&nbsp;<span class="ident" id="1618652">_CaseRecv</span>&nbsp;<span class="op" id="1618662">&amp;&amp;</span>&nbsp;<span class="ident" id="1618665">cas</span><span class="op" id="1618668">.</span><span class="ident" id="1618669">elem</span>&nbsp;<span class="op" id="1618674">!=</span>&nbsp;<span class="ident" id="1618677">nil</span>&nbsp;<span class="op" id="1618681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618686">raceWriteObjectPC</span><span class="op" id="1618703">(</span><span class="ident" id="1618704">c</span><span class="op" id="1618705">.</span><span class="ident" id="1618706">elemtype</span><span class="op" id="1618714">,</span>&nbsp;<span class="ident" id="1618716">cas</span><span class="op" id="1618719">.</span><span class="ident" id="1618720">elem</span><span class="op" id="1618724">,</span>&nbsp;<span class="ident" id="1618726">cas</span><span class="op" id="1618729">.</span><span class="ident" id="1618730">pc</span><span class="op" id="1618732">,</span>&nbsp;<span class="ident" id="1618734">chanrecvpc</span><span class="op" id="1618744">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618748">}</span>&nbsp;<span class="keyword" id="1618750">else</span>&nbsp;<span class="keyword" id="1618755">if</span>&nbsp;<span class="ident" id="1618758">cas</span><span class="op" id="1618761">.</span><span class="ident" id="1618762">kind</span>&nbsp;<span class="op" id="1618767">==</span>&nbsp;<span class="ident" id="1618770">_CaseSend</span>&nbsp;<span class="op" id="1618780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618785">raceReadObjectPC</span><span class="op" id="1618801">(</span><span class="ident" id="1618802">c</span><span class="op" id="1618803">.</span><span class="ident" id="1618804">elemtype</span><span class="op" id="1618812">,</span>&nbsp;<span class="ident" id="1618814">cas</span><span class="op" id="1618817">.</span><span class="ident" id="1618818">elem</span><span class="op" id="1618822">,</span>&nbsp;<span class="ident" id="1618824">cas</span><span class="op" id="1618827">.</span><span class="ident" id="1618828">pc</span><span class="op" id="1618830">,</span>&nbsp;<span class="ident" id="1618832">chansendpc</span><span class="op" id="1618842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1618849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618853">selunlock</span><span class="op" id="1618862">(</span><span class="ident" id="1618863">sel</span><span class="op" id="1618866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618869">goto</span>&nbsp;<span class="ident" id="1618874">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1618880">asyncrecv</span><span class="op" id="1618889">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618892">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;buffer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618920">if</span>&nbsp;<span class="ident" id="1618923">raceenabled</span>&nbsp;<span class="op" id="1618935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1618939">if</span>&nbsp;<span class="ident" id="1618942">cas</span><span class="op" id="1618945">.</span><span class="ident" id="1618946">elem</span>&nbsp;<span class="op" id="1618951">!=</span>&nbsp;<span class="ident" id="1618954">nil</span>&nbsp;<span class="op" id="1618958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618963">raceWriteObjectPC</span><span class="op" id="1618980">(</span><span class="ident" id="1618981">c</span><span class="op" id="1618982">.</span><span class="ident" id="1618983">elemtype</span><span class="op" id="1618991">,</span>&nbsp;<span class="ident" id="1618993">cas</span><span class="op" id="1618996">.</span><span class="ident" id="1618997">elem</span><span class="op" id="1619001">,</span>&nbsp;<span class="ident" id="1619003">cas</span><span class="op" id="1619006">.</span><span class="ident" id="1619007">pc</span><span class="op" id="1619009">,</span>&nbsp;<span class="ident" id="1619011">chanrecvpc</span><span class="op" id="1619021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619029">raceacquire</span><span class="op" id="1619040">(</span><span class="ident" id="1619041">chanbuf</span><span class="op" id="1619048">(</span><span class="ident" id="1619049">c</span><span class="op" id="1619050">,</span>&nbsp;<span class="ident" id="1619052">c</span><span class="op" id="1619053">.</span><span class="ident" id="1619054">recvx</span><span class="op" id="1619059">)</span><span class="op" id="1619060">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619064">racerelease</span><span class="op" id="1619075">(</span><span class="ident" id="1619076">chanbuf</span><span class="op" id="1619083">(</span><span class="ident" id="1619084">c</span><span class="op" id="1619085">,</span>&nbsp;<span class="ident" id="1619087">c</span><span class="op" id="1619088">.</span><span class="ident" id="1619089">recvx</span><span class="op" id="1619094">)</span><span class="op" id="1619095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619101">if</span>&nbsp;<span class="ident" id="1619104">cas</span><span class="op" id="1619107">.</span><span class="ident" id="1619108">receivedp</span>&nbsp;<span class="op" id="1619118">!=</span>&nbsp;<span class="ident" id="1619121">nil</span>&nbsp;<span class="op" id="1619125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619129">*</span><span class="ident" id="1619130">cas</span><span class="op" id="1619133">.</span><span class="ident" id="1619134">receivedp</span>&nbsp;<span class="op" id="1619144">=</span>&nbsp;<span class="builtintype" id="1619146">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619152">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619155">if</span>&nbsp;<span class="ident" id="1619158">cas</span><span class="op" id="1619161">.</span><span class="ident" id="1619162">elem</span>&nbsp;<span class="op" id="1619167">!=</span>&nbsp;<span class="ident" id="1619170">nil</span>&nbsp;<span class="op" id="1619174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619178">memmove</span><span class="op" id="1619185">(</span><span class="ident" id="1619186">cas</span><span class="op" id="1619189">.</span><span class="ident" id="1619190">elem</span><span class="op" id="1619194">,</span>&nbsp;<span class="ident" id="1619196">chanbuf</span><span class="op" id="1619203">(</span><span class="ident" id="1619204">c</span><span class="op" id="1619205">,</span>&nbsp;<span class="ident" id="1619207">c</span><span class="op" id="1619208">.</span><span class="ident" id="1619209">recvx</span><span class="op" id="1619214">)</span><span class="op" id="1619215">,</span>&nbsp;<span class="builtintype" id="1619217">uintptr</span><span class="op" id="1619224">(</span><span class="ident" id="1619225">c</span><span class="op" id="1619226">.</span><span class="ident" id="1619227">elemsize</span><span class="op" id="1619235">)</span><span class="op" id="1619236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619242">memclr</span><span class="op" id="1619248">(</span><span class="ident" id="1619249">chanbuf</span><span class="op" id="1619256">(</span><span class="ident" id="1619257">c</span><span class="op" id="1619258">,</span>&nbsp;<span class="ident" id="1619260">c</span><span class="op" id="1619261">.</span><span class="ident" id="1619262">recvx</span><span class="op" id="1619267">)</span><span class="op" id="1619268">,</span>&nbsp;<span class="builtintype" id="1619270">uintptr</span><span class="op" id="1619277">(</span><span class="ident" id="1619278">c</span><span class="op" id="1619279">.</span><span class="ident" id="1619280">elemsize</span><span class="op" id="1619288">)</span><span class="op" id="1619289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619292">c</span><span class="op" id="1619293">.</span><span class="ident" id="1619294">recvx</span><span class="op" id="1619299">++</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619303">if</span>&nbsp;<span class="ident" id="1619306">c</span><span class="op" id="1619307">.</span><span class="ident" id="1619308">recvx</span>&nbsp;<span class="op" id="1619314">==</span>&nbsp;<span class="ident" id="1619317">c</span><span class="op" id="1619318">.</span><span class="ident" id="1619319">dataqsiz</span>&nbsp;<span class="op" id="1619328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619332">c</span><span class="op" id="1619333">.</span><span class="ident" id="1619334">recvx</span>&nbsp;<span class="op" id="1619340">=</span>&nbsp;<span class="num" id="1619342">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619348">c</span><span class="op" id="1619349">.</span><span class="ident" id="1619350">qcount</span><span class="op" id="1619356">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619360">sg</span>&nbsp;<span class="op" id="1619363">=</span>&nbsp;<span class="ident" id="1619365">c</span><span class="op" id="1619366">.</span><span class="ident" id="1619367">sendq</span><span class="op" id="1619372">.</span><span class="ident" id="1619373">dequeue</span><span class="op" id="1619380">(</span><span class="op" id="1619381">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619384">if</span>&nbsp;<span class="ident" id="1619387">sg</span>&nbsp;<span class="op" id="1619390">!=</span>&nbsp;<span class="ident" id="1619393">nil</span>&nbsp;<span class="op" id="1619397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619401">gp</span>&nbsp;<span class="op" id="1619404">=</span>&nbsp;<span class="ident" id="1619406">sg</span><span class="op" id="1619408">.</span><span class="ident" id="1619409">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619413">selunlock</span><span class="op" id="1619422">(</span><span class="ident" id="1619423">sel</span><span class="op" id="1619426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619430">if</span>&nbsp;<span class="ident" id="1619433">sg</span><span class="op" id="1619435">.</span><span class="ident" id="1619436">releasetime</span>&nbsp;<span class="op" id="1619448">!=</span>&nbsp;<span class="num" id="1619451">0</span>&nbsp;<span class="op" id="1619453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619458">sg</span><span class="op" id="1619460">.</span><span class="ident" id="1619461">releasetime</span>&nbsp;<span class="op" id="1619473">=</span>&nbsp;<span class="ident" id="1619475">cputicks</span><span class="op" id="1619483">(</span><span class="op" id="1619484">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619492">goready</span><span class="op" id="1619499">(</span><span class="ident" id="1619500">gp</span><span class="op" id="1619502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619505">}</span>&nbsp;<span class="keyword" id="1619507">else</span>&nbsp;<span class="op" id="1619512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619516">selunlock</span><span class="op" id="1619525">(</span><span class="ident" id="1619526">sel</span><span class="op" id="1619529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619532">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619535">goto</span>&nbsp;<span class="ident" id="1619540">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1619546">asyncsend</span><span class="op" id="1619555">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619558">//&nbsp;can&nbsp;send&nbsp;to&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619581">if</span>&nbsp;<span class="ident" id="1619584">raceenabled</span>&nbsp;<span class="op" id="1619596">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619600">raceacquire</span><span class="op" id="1619611">(</span><span class="ident" id="1619612">chanbuf</span><span class="op" id="1619619">(</span><span class="ident" id="1619620">c</span><span class="op" id="1619621">,</span>&nbsp;<span class="ident" id="1619623">c</span><span class="op" id="1619624">.</span><span class="ident" id="1619625">sendx</span><span class="op" id="1619630">)</span><span class="op" id="1619631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619635">racerelease</span><span class="op" id="1619646">(</span><span class="ident" id="1619647">chanbuf</span><span class="op" id="1619654">(</span><span class="ident" id="1619655">c</span><span class="op" id="1619656">,</span>&nbsp;<span class="ident" id="1619658">c</span><span class="op" id="1619659">.</span><span class="ident" id="1619660">sendx</span><span class="op" id="1619665">)</span><span class="op" id="1619666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619670">raceReadObjectPC</span><span class="op" id="1619686">(</span><span class="ident" id="1619687">c</span><span class="op" id="1619688">.</span><span class="ident" id="1619689">elemtype</span><span class="op" id="1619697">,</span>&nbsp;<span class="ident" id="1619699">cas</span><span class="op" id="1619702">.</span><span class="ident" id="1619703">elem</span><span class="op" id="1619707">,</span>&nbsp;<span class="ident" id="1619709">cas</span><span class="op" id="1619712">.</span><span class="ident" id="1619713">pc</span><span class="op" id="1619715">,</span>&nbsp;<span class="ident" id="1619717">chansendpc</span><span class="op" id="1619727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619733">memmove</span><span class="op" id="1619740">(</span><span class="ident" id="1619741">chanbuf</span><span class="op" id="1619748">(</span><span class="ident" id="1619749">c</span><span class="op" id="1619750">,</span>&nbsp;<span class="ident" id="1619752">c</span><span class="op" id="1619753">.</span><span class="ident" id="1619754">sendx</span><span class="op" id="1619759">)</span><span class="op" id="1619760">,</span>&nbsp;<span class="ident" id="1619762">cas</span><span class="op" id="1619765">.</span><span class="ident" id="1619766">elem</span><span class="op" id="1619770">,</span>&nbsp;<span class="builtintype" id="1619772">uintptr</span><span class="op" id="1619779">(</span><span class="ident" id="1619780">c</span><span class="op" id="1619781">.</span><span class="ident" id="1619782">elemsize</span><span class="op" id="1619790">)</span><span class="op" id="1619791">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619794">c</span><span class="op" id="1619795">.</span><span class="ident" id="1619796">sendx</span><span class="op" id="1619801">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619805">if</span>&nbsp;<span class="ident" id="1619808">c</span><span class="op" id="1619809">.</span><span class="ident" id="1619810">sendx</span>&nbsp;<span class="op" id="1619816">==</span>&nbsp;<span class="ident" id="1619819">c</span><span class="op" id="1619820">.</span><span class="ident" id="1619821">dataqsiz</span>&nbsp;<span class="op" id="1619830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619834">c</span><span class="op" id="1619835">.</span><span class="ident" id="1619836">sendx</span>&nbsp;<span class="op" id="1619842">=</span>&nbsp;<span class="num" id="1619844">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619850">c</span><span class="op" id="1619851">.</span><span class="ident" id="1619852">qcount</span><span class="op" id="1619858">++</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619862">sg</span>&nbsp;<span class="op" id="1619865">=</span>&nbsp;<span class="ident" id="1619867">c</span><span class="op" id="1619868">.</span><span class="ident" id="1619869">recvq</span><span class="op" id="1619874">.</span><span class="ident" id="1619875">dequeue</span><span class="op" id="1619882">(</span><span class="op" id="1619883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619886">if</span>&nbsp;<span class="ident" id="1619889">sg</span>&nbsp;<span class="op" id="1619892">!=</span>&nbsp;<span class="ident" id="1619895">nil</span>&nbsp;<span class="op" id="1619899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619903">gp</span>&nbsp;<span class="op" id="1619906">=</span>&nbsp;<span class="ident" id="1619908">sg</span><span class="op" id="1619910">.</span><span class="ident" id="1619911">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619915">selunlock</span><span class="op" id="1619924">(</span><span class="ident" id="1619925">sel</span><span class="op" id="1619928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619932">if</span>&nbsp;<span class="ident" id="1619935">sg</span><span class="op" id="1619937">.</span><span class="ident" id="1619938">releasetime</span>&nbsp;<span class="op" id="1619950">!=</span>&nbsp;<span class="num" id="1619953">0</span>&nbsp;<span class="op" id="1619955">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619960">sg</span><span class="op" id="1619962">.</span><span class="ident" id="1619963">releasetime</span>&nbsp;<span class="op" id="1619975">=</span>&nbsp;<span class="ident" id="1619977">cputicks</span><span class="op" id="1619985">(</span><span class="op" id="1619986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619994">goready</span><span class="op" id="1620001">(</span><span class="ident" id="1620002">gp</span><span class="op" id="1620004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620007">}</span>&nbsp;<span class="keyword" id="1620009">else</span>&nbsp;<span class="op" id="1620014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620018">selunlock</span><span class="op" id="1620027">(</span><span class="ident" id="1620028">sel</span><span class="op" id="1620031">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620037">goto</span>&nbsp;<span class="ident" id="1620042">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1620048">syncrecv</span><span class="op" id="1620056">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620059">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;sleeping&nbsp;sender&nbsp;(sg)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620101">if</span>&nbsp;<span class="ident" id="1620104">raceenabled</span>&nbsp;<span class="op" id="1620116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620120">if</span>&nbsp;<span class="ident" id="1620123">cas</span><span class="op" id="1620126">.</span><span class="ident" id="1620127">elem</span>&nbsp;<span class="op" id="1620132">!=</span>&nbsp;<span class="ident" id="1620135">nil</span>&nbsp;<span class="op" id="1620139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620144">raceWriteObjectPC</span><span class="op" id="1620161">(</span><span class="ident" id="1620162">c</span><span class="op" id="1620163">.</span><span class="ident" id="1620164">elemtype</span><span class="op" id="1620172">,</span>&nbsp;<span class="ident" id="1620174">cas</span><span class="op" id="1620177">.</span><span class="ident" id="1620178">elem</span><span class="op" id="1620182">,</span>&nbsp;<span class="ident" id="1620184">cas</span><span class="op" id="1620187">.</span><span class="ident" id="1620188">pc</span><span class="op" id="1620190">,</span>&nbsp;<span class="ident" id="1620192">chanrecvpc</span><span class="op" id="1620202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620210">racesync</span><span class="op" id="1620218">(</span><span class="ident" id="1620219">c</span><span class="op" id="1620220">,</span>&nbsp;<span class="ident" id="1620222">sg</span><span class="op" id="1620224">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620230">selunlock</span><span class="op" id="1620239">(</span><span class="ident" id="1620240">sel</span><span class="op" id="1620243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620246">if</span>&nbsp;<span class="ident" id="1620249">debugSelect</span>&nbsp;<span class="op" id="1620261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1620265">print</span><span class="op" id="1620270">(</span><span class="string" id="1620271">&#34;syncrecv:&nbsp;sel=&#34;</span><span class="op" id="1620287">,</span>&nbsp;<span class="ident" id="1620289">sel</span><span class="op" id="1620292">,</span>&nbsp;<span class="string" id="1620294">&#34;&nbsp;c=&#34;</span><span class="op" id="1620299">,</span>&nbsp;<span class="ident" id="1620301">c</span><span class="op" id="1620302">,</span>&nbsp;<span class="string" id="1620304">&#34;\n&#34;</span><span class="op" id="1620308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620311">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620314">if</span>&nbsp;<span class="ident" id="1620317">cas</span><span class="op" id="1620320">.</span><span class="ident" id="1620321">receivedp</span>&nbsp;<span class="op" id="1620331">!=</span>&nbsp;<span class="ident" id="1620334">nil</span>&nbsp;<span class="op" id="1620338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620342">*</span><span class="ident" id="1620343">cas</span><span class="op" id="1620346">.</span><span class="ident" id="1620347">receivedp</span>&nbsp;<span class="op" id="1620357">=</span>&nbsp;<span class="builtintype" id="1620359">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620368">if</span>&nbsp;<span class="ident" id="1620371">cas</span><span class="op" id="1620374">.</span><span class="ident" id="1620375">elem</span>&nbsp;<span class="op" id="1620380">!=</span>&nbsp;<span class="ident" id="1620383">nil</span>&nbsp;<span class="op" id="1620387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620391">memmove</span><span class="op" id="1620398">(</span><span class="ident" id="1620399">cas</span><span class="op" id="1620402">.</span><span class="ident" id="1620403">elem</span><span class="op" id="1620407">,</span>&nbsp;<span class="ident" id="1620409">sg</span><span class="op" id="1620411">.</span><span class="ident" id="1620412">elem</span><span class="op" id="1620416">,</span>&nbsp;<span class="builtintype" id="1620418">uintptr</span><span class="op" id="1620425">(</span><span class="ident" id="1620426">c</span><span class="op" id="1620427">.</span><span class="ident" id="1620428">elemsize</span><span class="op" id="1620436">)</span><span class="op" id="1620437">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620443">sg</span><span class="op" id="1620445">.</span><span class="ident" id="1620446">elem</span>&nbsp;<span class="op" id="1620451">=</span>&nbsp;<span class="ident" id="1620453">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620458">gp</span>&nbsp;<span class="op" id="1620461">=</span>&nbsp;<span class="ident" id="1620463">sg</span><span class="op" id="1620465">.</span><span class="ident" id="1620466">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620469">gp</span><span class="op" id="1620471">.</span><span class="ident" id="1620472">param</span>&nbsp;<span class="op" id="1620478">=</span>&nbsp;<span class="ident" id="1620480">unsafe</span><span class="op" id="1620486">.</span><span class="ident" id="1620487">Pointer</span><span class="op" id="1620494">(</span><span class="ident" id="1620495">sg</span><span class="op" id="1620497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620500">if</span>&nbsp;<span class="ident" id="1620503">sg</span><span class="op" id="1620505">.</span><span class="ident" id="1620506">releasetime</span>&nbsp;<span class="op" id="1620518">!=</span>&nbsp;<span class="num" id="1620521">0</span>&nbsp;<span class="op" id="1620523">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620527">sg</span><span class="op" id="1620529">.</span><span class="ident" id="1620530">releasetime</span>&nbsp;<span class="op" id="1620542">=</span>&nbsp;<span class="ident" id="1620544">cputicks</span><span class="op" id="1620552">(</span><span class="op" id="1620553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620559">goready</span><span class="op" id="1620566">(</span><span class="ident" id="1620567">gp</span><span class="op" id="1620569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620572">goto</span>&nbsp;<span class="ident" id="1620577">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="ident" id="1620583">rclose</span><span class="op" id="1620589">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620592">//&nbsp;read&nbsp;at&nbsp;end&nbsp;of&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620626">selunlock</span><span class="op" id="1620635">(</span><span class="ident" id="1620636">sel</span><span class="op" id="1620639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620642">if</span>&nbsp;<span class="ident" id="1620645">cas</span><span class="op" id="1620648">.</span><span class="ident" id="1620649">receivedp</span>&nbsp;<span class="op" id="1620659">!=</span>&nbsp;<span class="ident" id="1620662">nil</span>&nbsp;<span class="op" id="1620666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620670">*</span><span class="ident" id="1620671">cas</span><span class="op" id="1620674">.</span><span class="ident" id="1620675">receivedp</span>&nbsp;<span class="op" id="1620685">=</span>&nbsp;<span class="builtintype" id="1620687">false</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620697">if</span>&nbsp;<span class="ident" id="1620700">cas</span><span class="op" id="1620703">.</span><span class="ident" id="1620704">elem</span>&nbsp;<span class="op" id="1620709">!=</span>&nbsp;<span class="ident" id="1620712">nil</span>&nbsp;<span class="op" id="1620716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620720">memclr</span><span class="op" id="1620726">(</span><span class="ident" id="1620727">cas</span><span class="op" id="1620730">.</span><span class="ident" id="1620731">elem</span><span class="op" id="1620735">,</span>&nbsp;<span class="builtintype" id="1620737">uintptr</span><span class="op" id="1620744">(</span><span class="ident" id="1620745">c</span><span class="op" id="1620746">.</span><span class="ident" id="1620747">elemsize</span><span class="op" id="1620755">)</span><span class="op" id="1620756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620762">if</span>&nbsp;<span class="ident" id="1620765">raceenabled</span>&nbsp;<span class="op" id="1620777">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620781">raceacquire</span><span class="op" id="1620792">(</span><span class="ident" id="1620793">unsafe</span><span class="op" id="1620799">.</span><span class="ident" id="1620800">Pointer</span><span class="op" id="1620807">(</span><span class="ident" id="1620808">c</span><span class="op" id="1620809">)</span><span class="op" id="1620810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620816">goto</span>&nbsp;<span class="ident" id="1620821">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1620827">syncsend</span><span class="op" id="1620835">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620838">//&nbsp;can&nbsp;send&nbsp;to&nbsp;sleeping&nbsp;receiver&nbsp;(sg)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620877">if</span>&nbsp;<span class="ident" id="1620880">raceenabled</span>&nbsp;<span class="op" id="1620892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620896">raceReadObjectPC</span><span class="op" id="1620912">(</span><span class="ident" id="1620913">c</span><span class="op" id="1620914">.</span><span class="ident" id="1620915">elemtype</span><span class="op" id="1620923">,</span>&nbsp;<span class="ident" id="1620925">cas</span><span class="op" id="1620928">.</span><span class="ident" id="1620929">elem</span><span class="op" id="1620933">,</span>&nbsp;<span class="ident" id="1620935">cas</span><span class="op" id="1620938">.</span><span class="ident" id="1620939">pc</span><span class="op" id="1620941">,</span>&nbsp;<span class="ident" id="1620943">chansendpc</span><span class="op" id="1620953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620957">racesync</span><span class="op" id="1620965">(</span><span class="ident" id="1620966">c</span><span class="op" id="1620967">,</span>&nbsp;<span class="ident" id="1620969">sg</span><span class="op" id="1620971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620974">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620977">selunlock</span><span class="op" id="1620986">(</span><span class="ident" id="1620987">sel</span><span class="op" id="1620990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620993">if</span>&nbsp;<span class="ident" id="1620996">debugSelect</span>&nbsp;<span class="op" id="1621008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1621012">print</span><span class="op" id="1621017">(</span><span class="string" id="1621018">&#34;syncsend:&nbsp;sel=&#34;</span><span class="op" id="1621034">,</span>&nbsp;<span class="ident" id="1621036">sel</span><span class="op" id="1621039">,</span>&nbsp;<span class="string" id="1621041">&#34;&nbsp;c=&#34;</span><span class="op" id="1621046">,</span>&nbsp;<span class="ident" id="1621048">c</span><span class="op" id="1621049">,</span>&nbsp;<span class="string" id="1621051">&#34;\n&#34;</span><span class="op" id="1621055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621061">if</span>&nbsp;<span class="ident" id="1621064">sg</span><span class="op" id="1621066">.</span><span class="ident" id="1621067">elem</span>&nbsp;<span class="op" id="1621072">!=</span>&nbsp;<span class="ident" id="1621075">nil</span>&nbsp;<span class="op" id="1621079">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621083">memmove</span><span class="op" id="1621090">(</span><span class="ident" id="1621091">sg</span><span class="op" id="1621093">.</span><span class="ident" id="1621094">elem</span><span class="op" id="1621098">,</span>&nbsp;<span class="ident" id="1621100">cas</span><span class="op" id="1621103">.</span><span class="ident" id="1621104">elem</span><span class="op" id="1621108">,</span>&nbsp;<span class="builtintype" id="1621110">uintptr</span><span class="op" id="1621117">(</span><span class="ident" id="1621118">c</span><span class="op" id="1621119">.</span><span class="ident" id="1621120">elemsize</span><span class="op" id="1621128">)</span><span class="op" id="1621129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621135">sg</span><span class="op" id="1621137">.</span><span class="ident" id="1621138">elem</span>&nbsp;<span class="op" id="1621143">=</span>&nbsp;<span class="ident" id="1621145">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621150">gp</span>&nbsp;<span class="op" id="1621153">=</span>&nbsp;<span class="ident" id="1621155">sg</span><span class="op" id="1621157">.</span><span class="ident" id="1621158">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621161">gp</span><span class="op" id="1621163">.</span><span class="ident" id="1621164">param</span>&nbsp;<span class="op" id="1621170">=</span>&nbsp;<span class="ident" id="1621172">unsafe</span><span class="op" id="1621178">.</span><span class="ident" id="1621179">Pointer</span><span class="op" id="1621186">(</span><span class="ident" id="1621187">sg</span><span class="op" id="1621189">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621192">if</span>&nbsp;<span class="ident" id="1621195">sg</span><span class="op" id="1621197">.</span><span class="ident" id="1621198">releasetime</span>&nbsp;<span class="op" id="1621210">!=</span>&nbsp;<span class="num" id="1621213">0</span>&nbsp;<span class="op" id="1621215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621219">sg</span><span class="op" id="1621221">.</span><span class="ident" id="1621222">releasetime</span>&nbsp;<span class="op" id="1621234">=</span>&nbsp;<span class="ident" id="1621236">cputicks</span><span class="op" id="1621244">(</span><span class="op" id="1621245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621251">goready</span><span class="op" id="1621258">(</span><span class="ident" id="1621259">gp</span><span class="op" id="1621261">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span><span class="ident" id="1621264">retc</span><span class="op" id="1621268">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621271">if</span>&nbsp;<span class="ident" id="1621274">cas</span><span class="op" id="1621277">.</span><span class="ident" id="1621278">releasetime</span>&nbsp;<span class="op" id="1621290">&gt;</span>&nbsp;<span class="num" id="1621292">0</span>&nbsp;<span class="op" id="1621294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621298">blockevent</span><span class="op" id="1621308">(</span><span class="ident" id="1621309">cas</span><span class="op" id="1621312">.</span><span class="ident" id="1621313">releasetime</span><span class="op" id="1621324">-</span><span class="ident" id="1621325">t0</span><span class="op" id="1621327">,</span>&nbsp;<span class="num" id="1621329">2</span><span class="op" id="1621330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621336">return</span>&nbsp;<span class="ident" id="1621343">cas</span><span class="op" id="1621346">.</span><span class="ident" id="1621347">pc</span><span class="op" id="1621349">,</span>&nbsp;<span class="ident" id="1621351">cas</span><span class="op" id="1621354">.</span><span class="ident" id="1621355">so</span><br>
<span class="lineno">570</span><br>
<span class="lineno"></span><span class="ident" id="1621359">sclose</span><span class="op" id="1621365">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1621368">//&nbsp;send&nbsp;on&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621395">selunlock</span><span class="op" id="1621404">(</span><span class="ident" id="1621405">sel</span><span class="op" id="1621408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1621411">panic</span><span class="op" id="1621416">(</span><span class="string" id="1621417">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1621441">)</span><br>
<span class="lineno">575</span><span class="op" id="1621443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1621446">func</span>&nbsp;<span class="op" id="1621451">(</span><span class="ident" id="1621452">c</span>&nbsp;<span class="op" id="1621454">*</span><span class="ident" id="1621455">hchan</span><span class="op" id="1621460">)</span>&nbsp;<span class="ident" id="1621462">sortkey</span><span class="op" id="1621469">(</span><span class="op" id="1621470">)</span>&nbsp;<span class="builtintype" id="1621472">uintptr</span>&nbsp;<span class="op" id="1621480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1621483">//&nbsp;TODO(khr):&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;moving&nbsp;garbage&nbsp;collector,&nbsp;we&#39;ll&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1621551">//&nbsp;change&nbsp;this&nbsp;function.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621577">return</span>&nbsp;<span class="builtintype" id="1621584">uintptr</span><span class="op" id="1621591">(</span><span class="ident" id="1621592">unsafe</span><span class="op" id="1621598">.</span><span class="ident" id="1621599">Pointer</span><span class="op" id="1621606">(</span><span class="ident" id="1621607">c</span><span class="op" id="1621608">)</span><span class="op" id="1621609">)</span><br>
<span class="lineno"></span><span class="op" id="1621611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1621614">//&nbsp;A&nbsp;runtimeSelect&nbsp;is&nbsp;a&nbsp;single&nbsp;case&nbsp;passed&nbsp;to&nbsp;rselect.</span><br>
<span class="lineno"></span><span class="comment" id="1621669">//&nbsp;This&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/runtimeSelect</span><br>
<span class="lineno">585</span><span class="keyword" id="1621723">type</span>&nbsp;<span class="ident" id="1621728">runtimeSelect</span>&nbsp;<span class="keyword" id="1621742">struct</span>&nbsp;<span class="op" id="1621749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621752">dir</span>&nbsp;<span class="ident" id="1621756">selectDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621767">typ</span>&nbsp;<span class="ident" id="1621771">unsafe</span><span class="op" id="1621777">.</span><span class="ident" id="1621778">Pointer</span>&nbsp;<span class="comment" id="1621786">//&nbsp;channel&nbsp;type&nbsp;(not&nbsp;used&nbsp;here)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621819">ch</span>&nbsp;&nbsp;<span class="op" id="1621823">*</span><span class="ident" id="1621824">hchan</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1621838">//&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621850">val</span>&nbsp;<span class="ident" id="1621854">unsafe</span><span class="op" id="1621860">.</span><span class="ident" id="1621861">Pointer</span>&nbsp;<span class="comment" id="1621869">//&nbsp;ptr&nbsp;to&nbsp;data&nbsp;(SendDir)&nbsp;or&nbsp;ptr&nbsp;to&nbsp;receive&nbsp;buffer&nbsp;(RecvDir)</span><br>
<span class="lineno">590</span><span class="op" id="1621929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1621932">//&nbsp;These&nbsp;values&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/SelectDir.</span><br>
<span class="lineno"></span><span class="keyword" id="1621991">type</span>&nbsp;<span class="ident" id="1621996">selectDir</span>&nbsp;<span class="builtintype" id="1622006">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="keyword" id="1622011">const</span>&nbsp;<span class="op" id="1622017">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622020">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1622034">selectDir</span>&nbsp;<span class="op" id="1622044">=</span>&nbsp;<span class="ident" id="1622046">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622052">selectSend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1622076">//&nbsp;case&nbsp;Chan&nbsp;&lt;-&nbsp;Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622098">selectRecv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1622122">//&nbsp;case&nbsp;&lt;-Chan:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622139">selectDefault</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1622163">//&nbsp;default</span><br>
<span class="lineno">600</span><span class="op" id="1622174">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1622177">func</span>&nbsp;<span class="ident" id="1622182">reflect_rselect</span><span class="op" id="1622197">(</span><span class="ident" id="1622198">cases</span>&nbsp;<span class="op" id="1622204">[</span><span class="op" id="1622205">]</span><span class="ident" id="1622206">runtimeSelect</span><span class="op" id="1622219">)</span>&nbsp;<span class="op" id="1622221">(</span><span class="ident" id="1622222">chosen</span>&nbsp;<span class="builtintype" id="1622229">int</span><span class="op" id="1622232">,</span>&nbsp;<span class="ident" id="1622234">recvOK</span>&nbsp;<span class="builtintype" id="1622241">bool</span><span class="op" id="1622245">)</span>&nbsp;<span class="op" id="1622247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622250">//&nbsp;flagNoScan&nbsp;is&nbsp;safe&nbsp;here,&nbsp;because&nbsp;all&nbsp;objects&nbsp;are&nbsp;also&nbsp;referenced&nbsp;from&nbsp;cases.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622331">size</span>&nbsp;<span class="op" id="1622336">:=</span>&nbsp;<span class="ident" id="1622339">selectsize</span><span class="op" id="1622349">(</span><span class="builtintype" id="1622350">uintptr</span><span class="op" id="1622357">(</span><span class="builtinfunc" id="1622358">len</span><span class="op" id="1622361">(</span><span class="ident" id="1622362">cases</span><span class="op" id="1622367">)</span><span class="op" id="1622368">)</span><span class="op" id="1622369">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622372">sel</span>&nbsp;<span class="op" id="1622376">:=</span>&nbsp;<span class="op" id="1622379">(</span><span class="op" id="1622380">*</span><span class="ident" id="1622381">_select</span><span class="op" id="1622388">)</span><span class="op" id="1622389">(</span><span class="ident" id="1622390">mallocgc</span><span class="op" id="1622398">(</span><span class="ident" id="1622399">size</span><span class="op" id="1622403">,</span>&nbsp;<span class="ident" id="1622405">nil</span><span class="op" id="1622408">,</span>&nbsp;<span class="ident" id="1622410">flagNoScan</span><span class="op" id="1622420">)</span><span class="op" id="1622421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622424">newselect</span><span class="op" id="1622433">(</span><span class="ident" id="1622434">sel</span><span class="op" id="1622437">,</span>&nbsp;<span class="ident" id="1622439">int64</span><span class="op" id="1622444">(</span><span class="ident" id="1622445">size</span><span class="op" id="1622449">)</span><span class="op" id="1622450">,</span>&nbsp;<span class="builtintype" id="1622452">int32</span><span class="op" id="1622457">(</span><span class="builtinfunc" id="1622458">len</span><span class="op" id="1622461">(</span><span class="ident" id="1622462">cases</span><span class="op" id="1622467">)</span><span class="op" id="1622468">)</span><span class="op" id="1622469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622472">r</span>&nbsp;<span class="op" id="1622474">:=</span>&nbsp;<span class="builtinfunc" id="1622477">new</span><span class="op" id="1622480">(</span><span class="builtintype" id="1622481">bool</span><span class="op" id="1622485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622488">for</span>&nbsp;<span class="ident" id="1622492">i</span>&nbsp;<span class="op" id="1622494">:=</span>&nbsp;<span class="keyword" id="1622497">range</span>&nbsp;<span class="ident" id="1622503">cases</span>&nbsp;<span class="op" id="1622509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622513">rc</span>&nbsp;<span class="op" id="1622516">:=</span>&nbsp;<span class="op" id="1622519">&amp;</span><span class="ident" id="1622520">cases</span><span class="op" id="1622525">[</span><span class="ident" id="1622526">i</span><span class="op" id="1622527">]</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622531">switch</span>&nbsp;<span class="ident" id="1622538">rc</span><span class="op" id="1622540">.</span><span class="ident" id="1622541">dir</span>&nbsp;<span class="op" id="1622545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622549">case</span>&nbsp;<span class="ident" id="1622554">selectDefault</span><span class="op" id="1622567">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622572">selectdefaultImpl</span><span class="op" id="1622589">(</span><span class="ident" id="1622590">sel</span><span class="op" id="1622593">,</span>&nbsp;<span class="builtintype" id="1622595">uintptr</span><span class="op" id="1622602">(</span><span class="ident" id="1622603">i</span><span class="op" id="1622604">)</span><span class="op" id="1622605">,</span>&nbsp;<span class="num" id="1622607">0</span><span class="op" id="1622608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622612">case</span>&nbsp;<span class="ident" id="1622617">selectSend</span><span class="op" id="1622627">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622632">if</span>&nbsp;<span class="ident" id="1622635">rc</span><span class="op" id="1622637">.</span><span class="ident" id="1622638">ch</span>&nbsp;<span class="op" id="1622641">==</span>&nbsp;<span class="ident" id="1622644">nil</span>&nbsp;<span class="op" id="1622648">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622654">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622668">selectsendImpl</span><span class="op" id="1622682">(</span><span class="ident" id="1622683">sel</span><span class="op" id="1622686">,</span>&nbsp;<span class="ident" id="1622688">rc</span><span class="op" id="1622690">.</span><span class="ident" id="1622691">ch</span><span class="op" id="1622693">,</span>&nbsp;<span class="builtintype" id="1622695">uintptr</span><span class="op" id="1622702">(</span><span class="ident" id="1622703">i</span><span class="op" id="1622704">)</span><span class="op" id="1622705">,</span>&nbsp;<span class="ident" id="1622707">rc</span><span class="op" id="1622709">.</span><span class="ident" id="1622710">val</span><span class="op" id="1622713">,</span>&nbsp;<span class="num" id="1622715">0</span><span class="op" id="1622716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622720">case</span>&nbsp;<span class="ident" id="1622725">selectRecv</span><span class="op" id="1622735">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622740">if</span>&nbsp;<span class="ident" id="1622743">rc</span><span class="op" id="1622745">.</span><span class="ident" id="1622746">ch</span>&nbsp;<span class="op" id="1622749">==</span>&nbsp;<span class="ident" id="1622752">nil</span>&nbsp;<span class="op" id="1622756">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622762">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622776">selectrecvImpl</span><span class="op" id="1622790">(</span><span class="ident" id="1622791">sel</span><span class="op" id="1622794">,</span>&nbsp;<span class="ident" id="1622796">rc</span><span class="op" id="1622798">.</span><span class="ident" id="1622799">ch</span><span class="op" id="1622801">,</span>&nbsp;<span class="builtintype" id="1622803">uintptr</span><span class="op" id="1622810">(</span><span class="ident" id="1622811">i</span><span class="op" id="1622812">)</span><span class="op" id="1622813">,</span>&nbsp;<span class="ident" id="1622815">rc</span><span class="op" id="1622817">.</span><span class="ident" id="1622818">val</span><span class="op" id="1622821">,</span>&nbsp;<span class="ident" id="1622823">r</span><span class="op" id="1622824">,</span>&nbsp;<span class="num" id="1622826">0</span><span class="op" id="1622827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622834">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622838">pc</span><span class="op" id="1622840">,</span>&nbsp;<span class="ident" id="1622842">_</span>&nbsp;<span class="op" id="1622844">:=</span>&nbsp;<span class="ident" id="1622847">selectgoImpl</span><span class="op" id="1622859">(</span><span class="ident" id="1622860">sel</span><span class="op" id="1622863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622866">chosen</span>&nbsp;<span class="op" id="1622873">=</span>&nbsp;<span class="builtintype" id="1622875">int</span><span class="op" id="1622878">(</span><span class="ident" id="1622879">pc</span><span class="op" id="1622881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622884">recvOK</span>&nbsp;<span class="op" id="1622891">=</span>&nbsp;<span class="op" id="1622893">*</span><span class="ident" id="1622894">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622897">return</span><br>
<span class="lineno">630</span><span class="op" id="1622904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1622907">func</span>&nbsp;<span class="op" id="1622912">(</span><span class="ident" id="1622913">q</span>&nbsp;<span class="op" id="1622915">*</span><span class="ident" id="1622916">waitq</span><span class="op" id="1622921">)</span>&nbsp;<span class="ident" id="1622923">dequeueSudoG</span><span class="op" id="1622935">(</span><span class="ident" id="1622936">s</span>&nbsp;<span class="op" id="1622938">*</span><span class="ident" id="1622939">sudog</span><span class="op" id="1622944">)</span>&nbsp;<span class="op" id="1622946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622949">var</span>&nbsp;<span class="ident" id="1622953">prevsgp</span>&nbsp;<span class="op" id="1622961">*</span><span class="ident" id="1622962">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622969">l</span>&nbsp;<span class="op" id="1622971">:=</span>&nbsp;<span class="op" id="1622974">&amp;</span><span class="ident" id="1622975">q</span><span class="op" id="1622976">.</span><span class="ident" id="1622977">first</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622984">for</span>&nbsp;<span class="op" id="1622988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622992">sgp</span>&nbsp;<span class="op" id="1622996">:=</span>&nbsp;<span class="op" id="1622999">*</span><span class="ident" id="1623000">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623004">if</span>&nbsp;<span class="ident" id="1623007">sgp</span>&nbsp;<span class="op" id="1623011">==</span>&nbsp;<span class="ident" id="1623014">nil</span>&nbsp;<span class="op" id="1623018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623023">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623032">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623036">if</span>&nbsp;<span class="ident" id="1623039">sgp</span>&nbsp;<span class="op" id="1623043">==</span>&nbsp;<span class="ident" id="1623046">s</span>&nbsp;<span class="op" id="1623048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623053">*</span><span class="ident" id="1623054">l</span>&nbsp;<span class="op" id="1623056">=</span>&nbsp;<span class="ident" id="1623058">sgp</span><span class="op" id="1623061">.</span><span class="ident" id="1623062">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623070">if</span>&nbsp;<span class="ident" id="1623073">q</span><span class="op" id="1623074">.</span><span class="ident" id="1623075">last</span>&nbsp;<span class="op" id="1623080">==</span>&nbsp;<span class="ident" id="1623083">sgp</span>&nbsp;<span class="op" id="1623087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623093">q</span><span class="op" id="1623094">.</span><span class="ident" id="1623095">last</span>&nbsp;<span class="op" id="1623100">=</span>&nbsp;<span class="ident" id="1623102">prevsgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623113">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623118">s</span><span class="op" id="1623119">.</span><span class="ident" id="1623120">next</span>&nbsp;<span class="op" id="1623125">=</span>&nbsp;<span class="ident" id="1623127">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623134">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623147">l</span>&nbsp;<span class="op" id="1623149">=</span>&nbsp;<span class="op" id="1623151">&amp;</span><span class="ident" id="1623152">sgp</span><span class="op" id="1623155">.</span><span class="ident" id="1623156">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623163">prevsgp</span>&nbsp;<span class="op" id="1623171">=</span>&nbsp;<span class="ident" id="1623173">sgp</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623178">}</span><br>
<span class="lineno"></span><span class="op" id="1623180">}</span>
</div>
</body>
</html>
