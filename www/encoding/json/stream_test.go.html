<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8648785">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8648841">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8648895">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8648946">package</span>&nbsp;<span class="ident" id="8648954">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8648960">import</span>&nbsp;<span class="op" id="8648967">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648970">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648979">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648992">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8648999">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8649010">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8649021">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="8649031">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="8649034">//&nbsp;Test&nbsp;values&nbsp;for&nbsp;the&nbsp;stream&nbsp;test.</span><br>
<span class="lineno"></span><span class="comment" id="8649070">//&nbsp;One&nbsp;of&nbsp;each&nbsp;JSON&nbsp;kind.</span><br>
<span class="lineno"></span><span class="keyword" id="8649096">var</span>&nbsp;<span class="ident" id="8649100">streamTest</span>&nbsp;<span class="op" id="8649111">=</span>&nbsp;<span class="op" id="8649113">[</span><span class="op" id="8649114">]</span><span class="keyword" id="8649115">interface</span><span class="op" id="8649124">{</span><span class="op" id="8649125">}</span><span class="op" id="8649126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="8649129">0.1</span><span class="op" id="8649132">,</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8649135">&#34;hello&#34;</span><span class="op" id="8649142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649145">nil</span><span class="op" id="8649148">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649151">true</span><span class="op" id="8649155">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649158">false</span><span class="op" id="8649163">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649166">[</span><span class="op" id="8649167">]</span><span class="keyword" id="8649168">interface</span><span class="op" id="8649177">{</span><span class="op" id="8649178">}</span><span class="op" id="8649179">{</span><span class="string" id="8649180">&#34;a&#34;</span><span class="op" id="8649183">,</span>&nbsp;<span class="string" id="8649185">&#34;b&#34;</span><span class="op" id="8649188">,</span>&nbsp;<span class="string" id="8649190">&#34;c&#34;</span><span class="op" id="8649193">}</span><span class="op" id="8649194">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649197">map</span><span class="op" id="8649200">[</span><span class="builtintype" id="8649201">string</span><span class="op" id="8649207">]</span><span class="keyword" id="8649208">interface</span><span class="op" id="8649217">{</span><span class="op" id="8649218">}</span><span class="op" id="8649219">{</span><span class="string" id="8649220">&#34;K&#34;</span><span class="op" id="8649225">:</span>&nbsp;<span class="string" id="8649227">&#34;Kelvin&#34;</span><span class="op" id="8649235">,</span>&nbsp;<span class="string" id="8649237">&#34;ß&#34;</span><span class="op" id="8649241">:</span>&nbsp;<span class="string" id="8649243">&#34;long&nbsp;s&#34;</span><span class="op" id="8649251">}</span><span class="op" id="8649252">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="8649255">3.14</span><span class="op" id="8649259">,</span>&nbsp;<span class="comment" id="8649261">//&nbsp;another&nbsp;value&nbsp;to&nbsp;make&nbsp;sure&nbsp;something&nbsp;can&nbsp;follow&nbsp;map</span><br>
<span class="lineno"></span><span class="op" id="8649316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8649319">var</span>&nbsp;<span class="ident" id="8649323">streamEncoded</span>&nbsp;<span class="op" id="8649337">=</span>&nbsp;<span class="string" id="8649339">`0.1<br>
<span class="lineno">30</span>&#34;hello&#34;<br>
<span class="lineno"></span>null<br>
<span class="lineno"></span>true<br>
<span class="lineno"></span>false<br>
<span class="lineno"></span>[&#34;a&#34;,&#34;b&#34;,&#34;c&#34;]<br>
<span class="lineno">35</span>{&#34;ß&#34;:&#34;long&nbsp;s&#34;,&#34;K&#34;:&#34;Kelvin&#34;}<br>
<span class="lineno"></span>3.14<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8649421">func</span>&nbsp;<span class="ident" id="8649426">TestEncoder</span><span class="op" id="8649437">(</span><span class="ident" id="8649438">t</span>&nbsp;<span class="op" id="8649440">*</span><span class="ident" id="8649441">testing</span><span class="op" id="8649448">.</span><span class="ident" id="8649449">T</span><span class="op" id="8649450">)</span>&nbsp;<span class="op" id="8649452">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649455">for</span>&nbsp;<span class="ident" id="8649459">i</span>&nbsp;<span class="op" id="8649461">:=</span>&nbsp;<span class="num" id="8649464">0</span><span class="op" id="8649465">;</span>&nbsp;<span class="ident" id="8649467">i</span>&nbsp;<span class="op" id="8649469">&lt;=</span>&nbsp;<span class="builtinfunc" id="8649472">len</span><span class="op" id="8649475">(</span><span class="ident" id="8649476">streamTest</span><span class="op" id="8649486">)</span><span class="op" id="8649487">;</span>&nbsp;<span class="ident" id="8649489">i</span><span class="op" id="8649490">++</span>&nbsp;<span class="op" id="8649493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649497">var</span>&nbsp;<span class="ident" id="8649501">buf</span>&nbsp;<span class="ident" id="8649505">bytes</span><span class="op" id="8649510">.</span><span class="ident" id="8649511">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649520">enc</span>&nbsp;<span class="op" id="8649524">:=</span>&nbsp;<span class="ident" id="8649527">NewEncoder</span><span class="op" id="8649537">(</span><span class="op" id="8649538">&amp;</span><span class="ident" id="8649539">buf</span><span class="op" id="8649542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649546">for</span>&nbsp;<span class="ident" id="8649550">j</span><span class="op" id="8649551">,</span>&nbsp;<span class="ident" id="8649553">v</span>&nbsp;<span class="op" id="8649555">:=</span>&nbsp;<span class="keyword" id="8649558">range</span>&nbsp;<span class="ident" id="8649564">streamTest</span><span class="op" id="8649574">[</span><span class="num" id="8649575">0</span><span class="op" id="8649576">:</span><span class="ident" id="8649577">i</span><span class="op" id="8649578">]</span>&nbsp;<span class="op" id="8649580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649585">if</span>&nbsp;<span class="ident" id="8649588">err</span>&nbsp;<span class="op" id="8649592">:=</span>&nbsp;<span class="ident" id="8649595">enc</span><span class="op" id="8649598">.</span><span class="ident" id="8649599">Encode</span><span class="op" id="8649605">(</span><span class="ident" id="8649606">v</span><span class="op" id="8649607">)</span><span class="op" id="8649608">;</span>&nbsp;<span class="ident" id="8649610">err</span>&nbsp;<span class="op" id="8649614">!=</span>&nbsp;<span class="ident" id="8649617">nil</span>&nbsp;<span class="op" id="8649621">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649627">t</span><span class="op" id="8649628">.</span><span class="ident" id="8649629">Fatalf</span><span class="op" id="8649635">(</span><span class="string" id="8649636">&#34;encode&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="8649652">,</span>&nbsp;<span class="ident" id="8649654">j</span><span class="op" id="8649655">,</span>&nbsp;<span class="ident" id="8649657">err</span><span class="op" id="8649660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649673">if</span>&nbsp;<span class="ident" id="8649676">have</span><span class="op" id="8649680">,</span>&nbsp;<span class="ident" id="8649682">want</span>&nbsp;<span class="op" id="8649687">:=</span>&nbsp;<span class="ident" id="8649690">buf</span><span class="op" id="8649693">.</span><span class="ident" id="8649694">String</span><span class="op" id="8649700">(</span><span class="op" id="8649701">)</span><span class="op" id="8649702">,</span>&nbsp;<span class="ident" id="8649704">nlines</span><span class="op" id="8649710">(</span><span class="ident" id="8649711">streamEncoded</span><span class="op" id="8649724">,</span>&nbsp;<span class="ident" id="8649726">i</span><span class="op" id="8649727">)</span><span class="op" id="8649728">;</span>&nbsp;<span class="ident" id="8649730">have</span>&nbsp;<span class="op" id="8649735">!=</span>&nbsp;<span class="ident" id="8649738">want</span>&nbsp;<span class="op" id="8649743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649748">t</span><span class="op" id="8649749">.</span><span class="ident" id="8649750">Errorf</span><span class="op" id="8649756">(</span><span class="string" id="8649757">&#34;encoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="8649786">,</span>&nbsp;<span class="ident" id="8649788">i</span><span class="op" id="8649789">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8649794">diff</span><span class="op" id="8649798">(</span><span class="ident" id="8649799">t</span><span class="op" id="8649800">,</span>&nbsp;<span class="op" id="8649802">[</span><span class="op" id="8649803">]</span><span class="builtintype" id="8649804">byte</span><span class="op" id="8649808">(</span><span class="ident" id="8649809">have</span><span class="op" id="8649813">)</span><span class="op" id="8649814">,</span>&nbsp;<span class="op" id="8649816">[</span><span class="op" id="8649817">]</span><span class="builtintype" id="8649818">byte</span><span class="op" id="8649822">(</span><span class="ident" id="8649823">want</span><span class="op" id="8649827">)</span><span class="op" id="8649828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649833">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8649844">}</span><br>
<span class="lineno"></span><span class="op" id="8649846">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="8649849">func</span>&nbsp;<span class="ident" id="8649854">TestDecoder</span><span class="op" id="8649865">(</span><span class="ident" id="8649866">t</span>&nbsp;<span class="op" id="8649868">*</span><span class="ident" id="8649869">testing</span><span class="op" id="8649876">.</span><span class="ident" id="8649877">T</span><span class="op" id="8649878">)</span>&nbsp;<span class="op" id="8649880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8649883">for</span>&nbsp;<span class="ident" id="8649887">i</span>&nbsp;<span class="op" id="8649889">:=</span>&nbsp;<span class="num" id="8649892">0</span><span class="op" id="8649893">;</span>&nbsp;<span class="ident" id="8649895">i</span>&nbsp;<span class="op" id="8649897">&lt;=</span>&nbsp;<span class="builtinfunc" id="8649900">len</span><span class="op" id="8649903">(</span><span class="ident" id="8649904">streamTest</span><span class="op" id="8649914">)</span><span class="op" id="8649915">;</span>&nbsp;<span class="ident" id="8649917">i</span><span class="op" id="8649918">++</span>&nbsp;<span class="op" id="8649921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8649925">//&nbsp;Use&nbsp;stream&nbsp;without&nbsp;newlines&nbsp;as&nbsp;input,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8649968">//&nbsp;just&nbsp;to&nbsp;stress&nbsp;the&nbsp;decoder&nbsp;even&nbsp;more.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8650011">//&nbsp;Our&nbsp;test&nbsp;input&nbsp;does&nbsp;not&nbsp;include&nbsp;back-to-back&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8650070">//&nbsp;Otherwise&nbsp;stripping&nbsp;the&nbsp;newlines&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8650114">//&nbsp;merge&nbsp;two&nbsp;adjacent&nbsp;JSON&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650151">var</span>&nbsp;<span class="ident" id="8650155">buf</span>&nbsp;<span class="ident" id="8650159">bytes</span><span class="op" id="8650164">.</span><span class="ident" id="8650165">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650174">for</span>&nbsp;<span class="ident" id="8650178">_</span><span class="op" id="8650179">,</span>&nbsp;<span class="ident" id="8650181">c</span>&nbsp;<span class="op" id="8650183">:=</span>&nbsp;<span class="keyword" id="8650186">range</span>&nbsp;<span class="ident" id="8650192">nlines</span><span class="op" id="8650198">(</span><span class="ident" id="8650199">streamEncoded</span><span class="op" id="8650212">,</span>&nbsp;<span class="ident" id="8650214">i</span><span class="op" id="8650215">)</span>&nbsp;<span class="op" id="8650217">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650222">if</span>&nbsp;<span class="ident" id="8650225">c</span>&nbsp;<span class="op" id="8650227">!=</span>&nbsp;<span class="string" id="8650230">&#39;\n&#39;</span>&nbsp;<span class="op" id="8650235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650241">buf</span><span class="op" id="8650244">.</span><span class="ident" id="8650245">WriteRune</span><span class="op" id="8650254">(</span><span class="ident" id="8650255">c</span><span class="op" id="8650256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650269">out</span>&nbsp;<span class="op" id="8650273">:=</span>&nbsp;<span class="builtinfunc" id="8650276">make</span><span class="op" id="8650280">(</span><span class="op" id="8650281">[</span><span class="op" id="8650282">]</span><span class="keyword" id="8650283">interface</span><span class="op" id="8650292">{</span><span class="op" id="8650293">}</span><span class="op" id="8650294">,</span>&nbsp;<span class="ident" id="8650296">i</span><span class="op" id="8650297">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650301">dec</span>&nbsp;<span class="op" id="8650305">:=</span>&nbsp;<span class="ident" id="8650308">NewDecoder</span><span class="op" id="8650318">(</span><span class="op" id="8650319">&amp;</span><span class="ident" id="8650320">buf</span><span class="op" id="8650323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650327">for</span>&nbsp;<span class="ident" id="8650331">j</span>&nbsp;<span class="op" id="8650333">:=</span>&nbsp;<span class="keyword" id="8650336">range</span>&nbsp;<span class="ident" id="8650342">out</span>&nbsp;<span class="op" id="8650346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650351">if</span>&nbsp;<span class="ident" id="8650354">err</span>&nbsp;<span class="op" id="8650358">:=</span>&nbsp;<span class="ident" id="8650361">dec</span><span class="op" id="8650364">.</span><span class="ident" id="8650365">Decode</span><span class="op" id="8650371">(</span><span class="op" id="8650372">&amp;</span><span class="ident" id="8650373">out</span><span class="op" id="8650376">[</span><span class="ident" id="8650377">j</span><span class="op" id="8650378">]</span><span class="op" id="8650379">)</span><span class="op" id="8650380">;</span>&nbsp;<span class="ident" id="8650382">err</span>&nbsp;<span class="op" id="8650386">!=</span>&nbsp;<span class="ident" id="8650389">nil</span>&nbsp;<span class="op" id="8650393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650399">t</span><span class="op" id="8650400">.</span><span class="ident" id="8650401">Fatalf</span><span class="op" id="8650407">(</span><span class="string" id="8650408">&#34;decode&nbsp;#%d/%d:&nbsp;%v&#34;</span><span class="op" id="8650427">,</span>&nbsp;<span class="ident" id="8650429">j</span><span class="op" id="8650430">,</span>&nbsp;<span class="ident" id="8650432">i</span><span class="op" id="8650433">,</span>&nbsp;<span class="ident" id="8650435">err</span><span class="op" id="8650438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650443">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650451">if</span>&nbsp;<span class="op" id="8650454">!</span><span class="ident" id="8650455">reflect</span><span class="op" id="8650462">.</span><span class="ident" id="8650463">DeepEqual</span><span class="op" id="8650472">(</span><span class="ident" id="8650473">out</span><span class="op" id="8650476">,</span>&nbsp;<span class="ident" id="8650478">streamTest</span><span class="op" id="8650488">[</span><span class="num" id="8650489">0</span><span class="op" id="8650490">:</span><span class="ident" id="8650491">i</span><span class="op" id="8650492">]</span><span class="op" id="8650493">)</span>&nbsp;<span class="op" id="8650495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650500">t</span><span class="op" id="8650501">.</span><span class="ident" id="8650502">Errorf</span><span class="op" id="8650508">(</span><span class="string" id="8650509">&#34;decoding&nbsp;%d&nbsp;items:&nbsp;mismatch&#34;</span><span class="op" id="8650538">,</span>&nbsp;<span class="ident" id="8650540">i</span><span class="op" id="8650541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650546">for</span>&nbsp;<span class="ident" id="8650550">j</span>&nbsp;<span class="op" id="8650552">:=</span>&nbsp;<span class="keyword" id="8650555">range</span>&nbsp;<span class="ident" id="8650561">out</span>&nbsp;<span class="op" id="8650565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650571">if</span>&nbsp;<span class="op" id="8650574">!</span><span class="ident" id="8650575">reflect</span><span class="op" id="8650582">.</span><span class="ident" id="8650583">DeepEqual</span><span class="op" id="8650592">(</span><span class="ident" id="8650593">out</span><span class="op" id="8650596">[</span><span class="ident" id="8650597">j</span><span class="op" id="8650598">]</span><span class="op" id="8650599">,</span>&nbsp;<span class="ident" id="8650601">streamTest</span><span class="op" id="8650611">[</span><span class="ident" id="8650612">j</span><span class="op" id="8650613">]</span><span class="op" id="8650614">)</span>&nbsp;<span class="op" id="8650616">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650623">t</span><span class="op" id="8650624">.</span><span class="ident" id="8650625">Errorf</span><span class="op" id="8650631">(</span><span class="string" id="8650632">&#34;#%d:&nbsp;have&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8650654">,</span>&nbsp;<span class="ident" id="8650656">j</span><span class="op" id="8650657">,</span>&nbsp;<span class="ident" id="8650659">out</span><span class="op" id="8650662">[</span><span class="ident" id="8650663">j</span><span class="op" id="8650664">]</span><span class="op" id="8650665">,</span>&nbsp;<span class="ident" id="8650667">streamTest</span><span class="op" id="8650677">[</span><span class="ident" id="8650678">j</span><span class="op" id="8650679">]</span><span class="op" id="8650680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650696">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650704">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650707">}</span><br>
<span class="lineno"></span><span class="op" id="8650709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8650712">func</span>&nbsp;<span class="ident" id="8650717">TestDecoderBuffered</span><span class="op" id="8650736">(</span><span class="ident" id="8650737">t</span>&nbsp;<span class="op" id="8650739">*</span><span class="ident" id="8650740">testing</span><span class="op" id="8650747">.</span><span class="ident" id="8650748">T</span><span class="op" id="8650749">)</span>&nbsp;<span class="op" id="8650751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650754">r</span>&nbsp;<span class="op" id="8650756">:=</span>&nbsp;<span class="ident" id="8650759">strings</span><span class="op" id="8650766">.</span><span class="ident" id="8650767">NewReader</span><span class="op" id="8650776">(</span><span class="string" id="8650777">`{&#34;Name&#34;:&nbsp;&#34;Gopher&#34;}&nbsp;extra&nbsp;`</span><span class="op" id="8650804">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650807">var</span>&nbsp;<span class="ident" id="8650811">m</span>&nbsp;<span class="keyword" id="8650813">struct</span>&nbsp;<span class="op" id="8650820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650824">Name</span>&nbsp;<span class="builtintype" id="8650829">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650840">d</span>&nbsp;<span class="op" id="8650842">:=</span>&nbsp;<span class="ident" id="8650845">NewDecoder</span><span class="op" id="8650855">(</span><span class="ident" id="8650856">r</span><span class="op" id="8650857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650860">err</span>&nbsp;<span class="op" id="8650864">:=</span>&nbsp;<span class="ident" id="8650867">d</span><span class="op" id="8650868">.</span><span class="ident" id="8650869">Decode</span><span class="op" id="8650875">(</span><span class="op" id="8650876">&amp;</span><span class="ident" id="8650877">m</span><span class="op" id="8650878">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650881">if</span>&nbsp;<span class="ident" id="8650884">err</span>&nbsp;<span class="op" id="8650888">!=</span>&nbsp;<span class="ident" id="8650891">nil</span>&nbsp;<span class="op" id="8650895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650899">t</span><span class="op" id="8650900">.</span><span class="ident" id="8650901">Fatal</span><span class="op" id="8650906">(</span><span class="ident" id="8650907">err</span><span class="op" id="8650910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8650916">if</span>&nbsp;<span class="ident" id="8650919">m</span><span class="op" id="8650920">.</span><span class="ident" id="8650921">Name</span>&nbsp;<span class="op" id="8650926">!=</span>&nbsp;<span class="string" id="8650929">&#34;Gopher&#34;</span>&nbsp;<span class="op" id="8650938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650942">t</span><span class="op" id="8650943">.</span><span class="ident" id="8650944">Errorf</span><span class="op" id="8650950">(</span><span class="string" id="8650951">&#34;Name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;Gopher&#34;</span><span class="op" id="8650975">,</span>&nbsp;<span class="ident" id="8650977">m</span><span class="op" id="8650978">.</span><span class="ident" id="8650979">Name</span><span class="op" id="8650983">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8650986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8650989">rest</span><span class="op" id="8650993">,</span>&nbsp;<span class="ident" id="8650995">err</span>&nbsp;<span class="op" id="8650999">:=</span>&nbsp;<span class="ident" id="8651002">ioutil</span><span class="op" id="8651008">.</span><span class="ident" id="8651009">ReadAll</span><span class="op" id="8651016">(</span><span class="ident" id="8651017">d</span><span class="op" id="8651018">.</span><span class="ident" id="8651019">Buffered</span><span class="op" id="8651027">(</span><span class="op" id="8651028">)</span><span class="op" id="8651029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651032">if</span>&nbsp;<span class="ident" id="8651035">err</span>&nbsp;<span class="op" id="8651039">!=</span>&nbsp;<span class="ident" id="8651042">nil</span>&nbsp;<span class="op" id="8651046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651050">t</span><span class="op" id="8651051">.</span><span class="ident" id="8651052">Fatal</span><span class="op" id="8651057">(</span><span class="ident" id="8651058">err</span><span class="op" id="8651061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651064">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651067">if</span>&nbsp;<span class="ident" id="8651070">g</span><span class="op" id="8651071">,</span>&nbsp;<span class="ident" id="8651073">w</span>&nbsp;<span class="op" id="8651075">:=</span>&nbsp;<span class="builtintype" id="8651078">string</span><span class="op" id="8651084">(</span><span class="ident" id="8651085">rest</span><span class="op" id="8651089">)</span><span class="op" id="8651090">,</span>&nbsp;<span class="string" id="8651092">&#34;&nbsp;extra&nbsp;&#34;</span><span class="op" id="8651101">;</span>&nbsp;<span class="ident" id="8651103">g</span>&nbsp;<span class="op" id="8651105">!=</span>&nbsp;<span class="ident" id="8651108">w</span>&nbsp;<span class="op" id="8651110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651114">t</span><span class="op" id="8651115">.</span><span class="ident" id="8651116">Errorf</span><span class="op" id="8651122">(</span><span class="string" id="8651123">&#34;Remaining&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8651148">,</span>&nbsp;<span class="ident" id="8651150">g</span><span class="op" id="8651151">,</span>&nbsp;<span class="ident" id="8651153">w</span><span class="op" id="8651154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651157">}</span><br>
<span class="lineno"></span><span class="op" id="8651159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="8651162">func</span>&nbsp;<span class="ident" id="8651167">nlines</span><span class="op" id="8651173">(</span><span class="ident" id="8651174">s</span>&nbsp;<span class="builtintype" id="8651176">string</span><span class="op" id="8651182">,</span>&nbsp;<span class="ident" id="8651184">n</span>&nbsp;<span class="builtintype" id="8651186">int</span><span class="op" id="8651189">)</span>&nbsp;<span class="builtintype" id="8651191">string</span>&nbsp;<span class="op" id="8651198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651201">if</span>&nbsp;<span class="ident" id="8651204">n</span>&nbsp;<span class="op" id="8651206">&lt;=</span>&nbsp;<span class="num" id="8651209">0</span>&nbsp;<span class="op" id="8651211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651215">return</span>&nbsp;<span class="string" id="8651222">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651229">for</span>&nbsp;<span class="ident" id="8651233">i</span><span class="op" id="8651234">,</span>&nbsp;<span class="ident" id="8651236">c</span>&nbsp;<span class="op" id="8651238">:=</span>&nbsp;<span class="keyword" id="8651241">range</span>&nbsp;<span class="ident" id="8651247">s</span>&nbsp;<span class="op" id="8651249">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651253">if</span>&nbsp;<span class="ident" id="8651256">c</span>&nbsp;<span class="op" id="8651258">==</span>&nbsp;<span class="string" id="8651261">&#39;\n&#39;</span>&nbsp;<span class="op" id="8651266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651271">if</span>&nbsp;<span class="ident" id="8651274">n</span><span class="op" id="8651275">--</span><span class="op" id="8651277">;</span>&nbsp;<span class="ident" id="8651279">n</span>&nbsp;<span class="op" id="8651281">==</span>&nbsp;<span class="num" id="8651284">0</span>&nbsp;<span class="op" id="8651286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651292">return</span>&nbsp;<span class="ident" id="8651299">s</span><span class="op" id="8651300">[</span><span class="num" id="8651301">0</span>&nbsp;<span class="op" id="8651303">:</span>&nbsp;<span class="ident" id="8651305">i</span><span class="op" id="8651306">+</span><span class="num" id="8651307">1</span><span class="op" id="8651308">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651317">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651323">return</span>&nbsp;<span class="ident" id="8651330">s</span><br>
<span class="lineno"></span><span class="op" id="8651332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8651335">func</span>&nbsp;<span class="ident" id="8651340">TestRawMessage</span><span class="op" id="8651354">(</span><span class="ident" id="8651355">t</span>&nbsp;<span class="op" id="8651357">*</span><span class="ident" id="8651358">testing</span><span class="op" id="8651365">.</span><span class="ident" id="8651366">T</span><span class="op" id="8651367">)</span>&nbsp;<span class="op" id="8651369">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8651372">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651424">var</span>&nbsp;<span class="ident" id="8651428">data</span>&nbsp;<span class="keyword" id="8651433">struct</span>&nbsp;<span class="op" id="8651440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651444">X</span>&nbsp;&nbsp;<span class="builtintype" id="8651447">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651457">Id</span>&nbsp;<span class="op" id="8651460">*</span><span class="ident" id="8651461">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651474">Y</span>&nbsp;&nbsp;<span class="builtintype" id="8651477">float32</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651489">const</span>&nbsp;<span class="ident" id="8651495">raw</span>&nbsp;<span class="op" id="8651499">=</span>&nbsp;<span class="string" id="8651501">`[&#34;\u0056&#34;,null]`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651520">const</span>&nbsp;<span class="ident" id="8651526">msg</span>&nbsp;<span class="op" id="8651530">=</span>&nbsp;<span class="string" id="8651532">`{&#34;X&#34;:0.1,&#34;Id&#34;:[&#34;\u0056&#34;,null],&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651574">err</span>&nbsp;<span class="op" id="8651578">:=</span>&nbsp;<span class="ident" id="8651581">Unmarshal</span><span class="op" id="8651590">(</span><span class="op" id="8651591">[</span><span class="op" id="8651592">]</span><span class="builtintype" id="8651593">byte</span><span class="op" id="8651597">(</span><span class="ident" id="8651598">msg</span><span class="op" id="8651601">)</span><span class="op" id="8651602">,</span>&nbsp;<span class="op" id="8651604">&amp;</span><span class="ident" id="8651605">data</span><span class="op" id="8651609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651612">if</span>&nbsp;<span class="ident" id="8651615">err</span>&nbsp;<span class="op" id="8651619">!=</span>&nbsp;<span class="ident" id="8651622">nil</span>&nbsp;<span class="op" id="8651626">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651630">t</span><span class="op" id="8651631">.</span><span class="ident" id="8651632">Fatalf</span><span class="op" id="8651638">(</span><span class="string" id="8651639">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="8651654">,</span>&nbsp;<span class="ident" id="8651656">err</span><span class="op" id="8651659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651665">if</span>&nbsp;<span class="builtintype" id="8651668">string</span><span class="op" id="8651674">(</span><span class="op" id="8651675">[</span><span class="op" id="8651676">]</span><span class="builtintype" id="8651677">byte</span><span class="op" id="8651681">(</span><span class="op" id="8651682">*</span><span class="ident" id="8651683">data</span><span class="op" id="8651687">.</span><span class="ident" id="8651688">Id</span><span class="op" id="8651690">)</span><span class="op" id="8651691">)</span>&nbsp;<span class="op" id="8651693">!=</span>&nbsp;<span class="ident" id="8651696">raw</span>&nbsp;<span class="op" id="8651700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651704">t</span><span class="op" id="8651705">.</span><span class="ident" id="8651706">Fatalf</span><span class="op" id="8651712">(</span><span class="string" id="8651713">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8651746">,</span>&nbsp;<span class="op" id="8651748">[</span><span class="op" id="8651749">]</span><span class="builtintype" id="8651750">byte</span><span class="op" id="8651754">(</span><span class="op" id="8651755">*</span><span class="ident" id="8651756">data</span><span class="op" id="8651760">.</span><span class="ident" id="8651761">Id</span><span class="op" id="8651763">)</span><span class="op" id="8651764">,</span>&nbsp;<span class="ident" id="8651766">raw</span><span class="op" id="8651769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651772">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651775">b</span><span class="op" id="8651776">,</span>&nbsp;<span class="ident" id="8651778">err</span>&nbsp;<span class="op" id="8651782">:=</span>&nbsp;<span class="ident" id="8651785">Marshal</span><span class="op" id="8651792">(</span><span class="op" id="8651793">&amp;</span><span class="ident" id="8651794">data</span><span class="op" id="8651798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651801">if</span>&nbsp;<span class="ident" id="8651804">err</span>&nbsp;<span class="op" id="8651808">!=</span>&nbsp;<span class="ident" id="8651811">nil</span>&nbsp;<span class="op" id="8651815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651819">t</span><span class="op" id="8651820">.</span><span class="ident" id="8651821">Fatalf</span><span class="op" id="8651827">(</span><span class="string" id="8651828">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="8651841">,</span>&nbsp;<span class="ident" id="8651843">err</span><span class="op" id="8651846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8651852">if</span>&nbsp;<span class="builtintype" id="8651855">string</span><span class="op" id="8651861">(</span><span class="ident" id="8651862">b</span><span class="op" id="8651863">)</span>&nbsp;<span class="op" id="8651865">!=</span>&nbsp;<span class="ident" id="8651868">msg</span>&nbsp;<span class="op" id="8651872">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8651876">t</span><span class="op" id="8651877">.</span><span class="ident" id="8651878">Fatalf</span><span class="op" id="8651884">(</span><span class="string" id="8651885">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8651913">,</span>&nbsp;<span class="ident" id="8651915">b</span><span class="op" id="8651916">,</span>&nbsp;<span class="ident" id="8651918">msg</span><span class="op" id="8651921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8651924">}</span><br>
<span class="lineno"></span><span class="op" id="8651926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8651929">func</span>&nbsp;<span class="ident" id="8651934">TestNullRawMessage</span><span class="op" id="8651952">(</span><span class="ident" id="8651953">t</span>&nbsp;<span class="op" id="8651955">*</span><span class="ident" id="8651956">testing</span><span class="op" id="8651963">.</span><span class="ident" id="8651964">T</span><span class="op" id="8651965">)</span>&nbsp;<span class="op" id="8651967">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8651970">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;not&nbsp;need&nbsp;the&nbsp;*&nbsp;in&nbsp;*RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652022">var</span>&nbsp;<span class="ident" id="8652026">data</span>&nbsp;<span class="keyword" id="8652031">struct</span>&nbsp;<span class="op" id="8652038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652042">X</span>&nbsp;&nbsp;<span class="builtintype" id="8652045">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652055">Id</span>&nbsp;<span class="op" id="8652058">*</span><span class="ident" id="8652059">RawMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652072">Y</span>&nbsp;&nbsp;<span class="builtintype" id="8652075">float32</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8652084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652087">data</span><span class="op" id="8652091">.</span><span class="ident" id="8652092">Id</span>&nbsp;<span class="op" id="8652095">=</span>&nbsp;<span class="builtinfunc" id="8652097">new</span><span class="op" id="8652100">(</span><span class="ident" id="8652101">RawMessage</span><span class="op" id="8652111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652114">const</span>&nbsp;<span class="ident" id="8652120">msg</span>&nbsp;<span class="op" id="8652124">=</span>&nbsp;<span class="string" id="8652126">`{&#34;X&#34;:0.1,&#34;Id&#34;:null,&#34;Y&#34;:0.2}`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652157">err</span>&nbsp;<span class="op" id="8652161">:=</span>&nbsp;<span class="ident" id="8652164">Unmarshal</span><span class="op" id="8652173">(</span><span class="op" id="8652174">[</span><span class="op" id="8652175">]</span><span class="builtintype" id="8652176">byte</span><span class="op" id="8652180">(</span><span class="ident" id="8652181">msg</span><span class="op" id="8652184">)</span><span class="op" id="8652185">,</span>&nbsp;<span class="op" id="8652187">&amp;</span><span class="ident" id="8652188">data</span><span class="op" id="8652192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652195">if</span>&nbsp;<span class="ident" id="8652198">err</span>&nbsp;<span class="op" id="8652202">!=</span>&nbsp;<span class="ident" id="8652205">nil</span>&nbsp;<span class="op" id="8652209">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652213">t</span><span class="op" id="8652214">.</span><span class="ident" id="8652215">Fatalf</span><span class="op" id="8652221">(</span><span class="string" id="8652222">&#34;Unmarshal:&nbsp;%v&#34;</span><span class="op" id="8652237">,</span>&nbsp;<span class="ident" id="8652239">err</span><span class="op" id="8652242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8652245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652248">if</span>&nbsp;<span class="ident" id="8652251">data</span><span class="op" id="8652255">.</span><span class="ident" id="8652256">Id</span>&nbsp;<span class="op" id="8652259">!=</span>&nbsp;<span class="ident" id="8652262">nil</span>&nbsp;<span class="op" id="8652266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652270">t</span><span class="op" id="8652271">.</span><span class="ident" id="8652272">Fatalf</span><span class="op" id="8652278">(</span><span class="string" id="8652279">&#34;Raw&nbsp;mismatch:&nbsp;have&nbsp;non-nil,&nbsp;want&nbsp;nil&#34;</span><span class="op" id="8652317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8652320">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652323">b</span><span class="op" id="8652324">,</span>&nbsp;<span class="ident" id="8652326">err</span>&nbsp;<span class="op" id="8652330">:=</span>&nbsp;<span class="ident" id="8652333">Marshal</span><span class="op" id="8652340">(</span><span class="op" id="8652341">&amp;</span><span class="ident" id="8652342">data</span><span class="op" id="8652346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652349">if</span>&nbsp;<span class="ident" id="8652352">err</span>&nbsp;<span class="op" id="8652356">!=</span>&nbsp;<span class="ident" id="8652359">nil</span>&nbsp;<span class="op" id="8652363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652367">t</span><span class="op" id="8652368">.</span><span class="ident" id="8652369">Fatalf</span><span class="op" id="8652375">(</span><span class="string" id="8652376">&#34;Marshal:&nbsp;%v&#34;</span><span class="op" id="8652389">,</span>&nbsp;<span class="ident" id="8652391">err</span><span class="op" id="8652394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8652397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652400">if</span>&nbsp;<span class="builtintype" id="8652403">string</span><span class="op" id="8652409">(</span><span class="ident" id="8652410">b</span><span class="op" id="8652411">)</span>&nbsp;<span class="op" id="8652413">!=</span>&nbsp;<span class="ident" id="8652416">msg</span>&nbsp;<span class="op" id="8652420">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652424">t</span><span class="op" id="8652425">.</span><span class="ident" id="8652426">Fatalf</span><span class="op" id="8652432">(</span><span class="string" id="8652433">&#34;Marshal:&nbsp;have&nbsp;%#q&nbsp;want&nbsp;%#q&#34;</span><span class="op" id="8652461">,</span>&nbsp;<span class="ident" id="8652463">b</span><span class="op" id="8652464">,</span>&nbsp;<span class="ident" id="8652466">msg</span><span class="op" id="8652469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8652472">}</span><br>
<span class="lineno"></span><span class="op" id="8652474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8652477">var</span>&nbsp;<span class="ident" id="8652481">blockingTests</span>&nbsp;<span class="op" id="8652495">=</span>&nbsp;<span class="op" id="8652497">[</span><span class="op" id="8652498">]</span><span class="builtintype" id="8652499">string</span><span class="op" id="8652505">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8652508">`{&#34;x&#34;:&nbsp;1}`</span><span class="op" id="8652518">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8652521">`[1,&nbsp;2,&nbsp;3]`</span><span class="op" id="8652532">,</span><br>
<span class="lineno"></span><span class="op" id="8652534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8652537">func</span>&nbsp;<span class="ident" id="8652542">TestBlocking</span><span class="op" id="8652554">(</span><span class="ident" id="8652555">t</span>&nbsp;<span class="op" id="8652557">*</span><span class="ident" id="8652558">testing</span><span class="op" id="8652565">.</span><span class="ident" id="8652566">T</span><span class="op" id="8652567">)</span>&nbsp;<span class="op" id="8652569">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652572">for</span>&nbsp;<span class="ident" id="8652576">_</span><span class="op" id="8652577">,</span>&nbsp;<span class="ident" id="8652579">enc</span>&nbsp;<span class="op" id="8652583">:=</span>&nbsp;<span class="keyword" id="8652586">range</span>&nbsp;<span class="ident" id="8652592">blockingTests</span>&nbsp;<span class="op" id="8652606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652610">r</span><span class="op" id="8652611">,</span>&nbsp;<span class="ident" id="8652613">w</span>&nbsp;<span class="op" id="8652615">:=</span>&nbsp;<span class="ident" id="8652618">net</span><span class="op" id="8652621">.</span><span class="ident" id="8652622">Pipe</span><span class="op" id="8652626">(</span><span class="op" id="8652627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652631">go</span>&nbsp;<span class="ident" id="8652634">w</span><span class="op" id="8652635">.</span><span class="ident" id="8652636">Write</span><span class="op" id="8652641">(</span><span class="op" id="8652642">[</span><span class="op" id="8652643">]</span><span class="builtintype" id="8652644">byte</span><span class="op" id="8652648">(</span><span class="ident" id="8652649">enc</span><span class="op" id="8652652">)</span><span class="op" id="8652653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652657">var</span>&nbsp;<span class="ident" id="8652661">val</span>&nbsp;<span class="keyword" id="8652665">interface</span><span class="op" id="8652674">{</span><span class="op" id="8652675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8652680">//&nbsp;If&nbsp;Decode&nbsp;reads&nbsp;beyond&nbsp;what&nbsp;w.Write&nbsp;writes&nbsp;above,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8652735">//&nbsp;it&nbsp;will&nbsp;block,&nbsp;and&nbsp;the&nbsp;test&nbsp;will&nbsp;deadlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652783">if</span>&nbsp;<span class="ident" id="8652786">err</span>&nbsp;<span class="op" id="8652790">:=</span>&nbsp;<span class="ident" id="8652793">NewDecoder</span><span class="op" id="8652803">(</span><span class="ident" id="8652804">r</span><span class="op" id="8652805">)</span><span class="op" id="8652806">.</span><span class="ident" id="8652807">Decode</span><span class="op" id="8652813">(</span><span class="op" id="8652814">&amp;</span><span class="ident" id="8652815">val</span><span class="op" id="8652818">)</span><span class="op" id="8652819">;</span>&nbsp;<span class="ident" id="8652821">err</span>&nbsp;<span class="op" id="8652825">!=</span>&nbsp;<span class="ident" id="8652828">nil</span>&nbsp;<span class="op" id="8652832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652837">t</span><span class="op" id="8652838">.</span><span class="ident" id="8652839">Errorf</span><span class="op" id="8652845">(</span><span class="string" id="8652846">&#34;decoding&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="8652863">,</span>&nbsp;<span class="ident" id="8652865">enc</span><span class="op" id="8652868">,</span>&nbsp;<span class="ident" id="8652870">err</span><span class="op" id="8652873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8652877">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652881">r</span><span class="op" id="8652882">.</span><span class="ident" id="8652883">Close</span><span class="op" id="8652888">(</span><span class="op" id="8652889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652893">w</span><span class="op" id="8652894">.</span><span class="ident" id="8652895">Close</span><span class="op" id="8652900">(</span><span class="op" id="8652901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8652904">}</span><br>
<span class="lineno"></span><span class="op" id="8652906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="8652909">func</span>&nbsp;<span class="ident" id="8652914">BenchmarkEncoderEncode</span><span class="op" id="8652936">(</span><span class="ident" id="8652937">b</span>&nbsp;<span class="op" id="8652939">*</span><span class="ident" id="8652940">testing</span><span class="op" id="8652947">.</span><span class="ident" id="8652948">B</span><span class="op" id="8652949">)</span>&nbsp;<span class="op" id="8652951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652954">b</span><span class="op" id="8652955">.</span><span class="ident" id="8652956">ReportAllocs</span><span class="op" id="8652968">(</span><span class="op" id="8652969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8652972">type</span>&nbsp;<span class="ident" id="8652977">T</span>&nbsp;<span class="keyword" id="8652979">struct</span>&nbsp;<span class="op" id="8652986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8652990">X</span><span class="op" id="8652991">,</span>&nbsp;<span class="ident" id="8652993">Y</span>&nbsp;<span class="builtintype" id="8652995">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8653003">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653006">v</span>&nbsp;<span class="op" id="8653008">:=</span>&nbsp;<span class="op" id="8653011">&amp;</span><span class="ident" id="8653012">T</span><span class="op" id="8653013">{</span><span class="string" id="8653014">&#34;foo&#34;</span><span class="op" id="8653019">,</span>&nbsp;<span class="string" id="8653021">&#34;bar&#34;</span><span class="op" id="8653026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653029">for</span>&nbsp;<span class="ident" id="8653033">i</span>&nbsp;<span class="op" id="8653035">:=</span>&nbsp;<span class="num" id="8653038">0</span><span class="op" id="8653039">;</span>&nbsp;<span class="ident" id="8653041">i</span>&nbsp;<span class="op" id="8653043">&lt;</span>&nbsp;<span class="ident" id="8653045">b</span><span class="op" id="8653046">.</span><span class="ident" id="8653047">N</span><span class="op" id="8653048">;</span>&nbsp;<span class="ident" id="8653050">i</span><span class="op" id="8653051">++</span>&nbsp;<span class="op" id="8653054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8653058">if</span>&nbsp;<span class="ident" id="8653061">err</span>&nbsp;<span class="op" id="8653065">:=</span>&nbsp;<span class="ident" id="8653068">NewEncoder</span><span class="op" id="8653078">(</span><span class="ident" id="8653079">ioutil</span><span class="op" id="8653085">.</span><span class="ident" id="8653086">Discard</span><span class="op" id="8653093">)</span><span class="op" id="8653094">.</span><span class="ident" id="8653095">Encode</span><span class="op" id="8653101">(</span><span class="ident" id="8653102">v</span><span class="op" id="8653103">)</span><span class="op" id="8653104">;</span>&nbsp;<span class="ident" id="8653106">err</span>&nbsp;<span class="op" id="8653110">!=</span>&nbsp;<span class="ident" id="8653113">nil</span>&nbsp;<span class="op" id="8653117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8653122">b</span><span class="op" id="8653123">.</span><span class="ident" id="8653124">Fatal</span><span class="op" id="8653129">(</span><span class="ident" id="8653130">err</span><span class="op" id="8653133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8653137">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8653140">}</span><br>
<span class="lineno"></span><span class="op" id="8653142">}</span>
</div>
</body>
</html>
