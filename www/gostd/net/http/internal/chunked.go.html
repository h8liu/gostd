<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html" class="current">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4331149">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4331204">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4331258">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4331309">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4331371">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4331438">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="4331460">package</span>&nbsp;<span class="ident" id="4331468">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4331478">import</span>&nbsp;<span class="op" id="4331485">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4331488">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4331497">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4331506">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4331516">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4331523">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4331528">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4331531">const</span>&nbsp;<span class="ident" id="4331537">maxLineLength</span>&nbsp;<span class="op" id="4331551">=</span>&nbsp;<span class="num" id="4331553">4096</span>&nbsp;<span class="comment" id="4331558">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4331594">var</span>&nbsp;<span class="ident" id="4331598">ErrLineTooLong</span>&nbsp;<span class="op" id="4331613">=</span>&nbsp;<span class="ident" id="4331615">errors</span><span class="op" id="4331621">.</span><span class="ident" id="4331622">New</span><span class="op" id="4331625">(</span><span class="string" id="4331626">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="4331648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4331651">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4331736">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="4331789">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="4331864">//</span><br>
<span class="lineno"></span><span class="comment" id="4331867">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4331942">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="4332006">func</span>&nbsp;<span class="ident" id="4332011">NewChunkedReader</span><span class="op" id="4332027">(</span><span class="ident" id="4332028">r</span>&nbsp;<span class="ident" id="4332030">io</span><span class="op" id="4332032">.</span><span class="ident" id="4332033">Reader</span><span class="op" id="4332039">)</span>&nbsp;<span class="ident" id="4332041">io</span><span class="op" id="4332043">.</span><span class="ident" id="4332044">Reader</span>&nbsp;<span class="op" id="4332051">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332054">br</span><span class="op" id="4332056">,</span>&nbsp;<span class="ident" id="4332058">ok</span>&nbsp;<span class="op" id="4332061">:=</span>&nbsp;<span class="ident" id="4332064">r</span><span class="op" id="4332065">.</span><span class="op" id="4332066">(</span><span class="op" id="4332067">*</span><span class="ident" id="4332068">bufio</span><span class="op" id="4332073">.</span><span class="ident" id="4332074">Reader</span><span class="op" id="4332080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332083">if</span>&nbsp;<span class="op" id="4332086">!</span><span class="ident" id="4332087">ok</span>&nbsp;<span class="op" id="4332090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332094">br</span>&nbsp;<span class="op" id="4332097">=</span>&nbsp;<span class="ident" id="4332099">bufio</span><span class="op" id="4332104">.</span><span class="ident" id="4332105">NewReader</span><span class="op" id="4332114">(</span><span class="ident" id="4332115">r</span><span class="op" id="4332116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332122">return</span>&nbsp;<span class="op" id="4332129">&amp;</span><span class="ident" id="4332130">chunkedReader</span><span class="op" id="4332143">{</span><span class="ident" id="4332144">r</span><span class="op" id="4332145">:</span>&nbsp;<span class="ident" id="4332147">br</span><span class="op" id="4332149">}</span><br>
<span class="lineno">35</span><span class="op" id="4332151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4332154">type</span>&nbsp;<span class="ident" id="4332159">chunkedReader</span>&nbsp;<span class="keyword" id="4332173">struct</span>&nbsp;<span class="op" id="4332180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332183">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4332187">*</span><span class="ident" id="4332188">bufio</span><span class="op" id="4332193">.</span><span class="ident" id="4332194">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332202">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4332206">uint64</span>&nbsp;<span class="comment" id="4332213">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332239">err</span>&nbsp;<span class="builtintype" id="4332243">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332250">buf</span>&nbsp;<span class="op" id="4332254">[</span><span class="num" id="4332255">2</span><span class="op" id="4332256">]</span><span class="builtintype" id="4332257">byte</span><br>
<span class="lineno"></span><span class="op" id="4332262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4332265">func</span>&nbsp;<span class="op" id="4332270">(</span><span class="ident" id="4332271">cr</span>&nbsp;<span class="op" id="4332274">*</span><span class="ident" id="4332275">chunkedReader</span><span class="op" id="4332288">)</span>&nbsp;<span class="ident" id="4332290">beginChunk</span><span class="op" id="4332300">(</span><span class="op" id="4332301">)</span>&nbsp;<span class="op" id="4332303">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4332306">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332326">var</span>&nbsp;<span class="ident" id="4332330">line</span>&nbsp;<span class="op" id="4332335">[</span><span class="op" id="4332336">]</span><span class="builtintype" id="4332337">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332343">line</span><span class="op" id="4332347">,</span>&nbsp;<span class="ident" id="4332349">cr</span><span class="op" id="4332351">.</span><span class="ident" id="4332352">err</span>&nbsp;<span class="op" id="4332356">=</span>&nbsp;<span class="ident" id="4332358">readLine</span><span class="op" id="4332366">(</span><span class="ident" id="4332367">cr</span><span class="op" id="4332369">.</span><span class="ident" id="4332370">r</span><span class="op" id="4332371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332374">if</span>&nbsp;<span class="ident" id="4332377">cr</span><span class="op" id="4332379">.</span><span class="ident" id="4332380">err</span>&nbsp;<span class="op" id="4332384">!=</span>&nbsp;<span class="ident" id="4332387">nil</span>&nbsp;<span class="op" id="4332391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332395">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332406">cr</span><span class="op" id="4332408">.</span><span class="ident" id="4332409">n</span><span class="op" id="4332410">,</span>&nbsp;<span class="ident" id="4332412">cr</span><span class="op" id="4332414">.</span><span class="ident" id="4332415">err</span>&nbsp;<span class="op" id="4332419">=</span>&nbsp;<span class="ident" id="4332421">parseHexUint</span><span class="op" id="4332433">(</span><span class="ident" id="4332434">line</span><span class="op" id="4332438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332441">if</span>&nbsp;<span class="ident" id="4332444">cr</span><span class="op" id="4332446">.</span><span class="ident" id="4332447">err</span>&nbsp;<span class="op" id="4332451">!=</span>&nbsp;<span class="ident" id="4332454">nil</span>&nbsp;<span class="op" id="4332458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332462">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332470">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332473">if</span>&nbsp;<span class="ident" id="4332476">cr</span><span class="op" id="4332478">.</span><span class="ident" id="4332479">n</span>&nbsp;<span class="op" id="4332481">==</span>&nbsp;<span class="num" id="4332484">0</span>&nbsp;<span class="op" id="4332486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332490">cr</span><span class="op" id="4332492">.</span><span class="ident" id="4332493">err</span>&nbsp;<span class="op" id="4332497">=</span>&nbsp;<span class="ident" id="4332499">io</span><span class="op" id="4332501">.</span><span class="ident" id="4332502">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332507">}</span><br>
<span class="lineno"></span><span class="op" id="4332509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4332512">func</span>&nbsp;<span class="op" id="4332517">(</span><span class="ident" id="4332518">cr</span>&nbsp;<span class="op" id="4332521">*</span><span class="ident" id="4332522">chunkedReader</span><span class="op" id="4332535">)</span>&nbsp;<span class="ident" id="4332537">chunkHeaderAvailable</span><span class="op" id="4332557">(</span><span class="op" id="4332558">)</span>&nbsp;<span class="builtintype" id="4332560">bool</span>&nbsp;<span class="op" id="4332565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332568">n</span>&nbsp;<span class="op" id="4332570">:=</span>&nbsp;<span class="ident" id="4332573">cr</span><span class="op" id="4332575">.</span><span class="ident" id="4332576">r</span><span class="op" id="4332577">.</span><span class="ident" id="4332578">Buffered</span><span class="op" id="4332586">(</span><span class="op" id="4332587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332590">if</span>&nbsp;<span class="ident" id="4332593">n</span>&nbsp;<span class="op" id="4332595">&gt;</span>&nbsp;<span class="num" id="4332597">0</span>&nbsp;<span class="op" id="4332599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332603">peek</span><span class="op" id="4332607">,</span>&nbsp;<span class="ident" id="4332609">_</span>&nbsp;<span class="op" id="4332611">:=</span>&nbsp;<span class="ident" id="4332614">cr</span><span class="op" id="4332616">.</span><span class="ident" id="4332617">r</span><span class="op" id="4332618">.</span><span class="ident" id="4332619">Peek</span><span class="op" id="4332623">(</span><span class="ident" id="4332624">n</span><span class="op" id="4332625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332629">return</span>&nbsp;<span class="ident" id="4332636">bytes</span><span class="op" id="4332641">.</span><span class="ident" id="4332642">IndexByte</span><span class="op" id="4332651">(</span><span class="ident" id="4332652">peek</span><span class="op" id="4332656">,</span>&nbsp;<span class="string" id="4332658">&#39;\n&#39;</span><span class="op" id="4332662">)</span>&nbsp;<span class="op" id="4332664">&gt;=</span>&nbsp;<span class="num" id="4332667">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332673">return</span>&nbsp;<span class="builtintype" id="4332680">false</span><br>
<span class="lineno"></span><span class="op" id="4332686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4332689">func</span>&nbsp;<span class="op" id="4332694">(</span><span class="ident" id="4332695">cr</span>&nbsp;<span class="op" id="4332698">*</span><span class="ident" id="4332699">chunkedReader</span><span class="op" id="4332712">)</span>&nbsp;<span class="ident" id="4332714">Read</span><span class="op" id="4332718">(</span><span class="ident" id="4332719">b</span>&nbsp;<span class="op" id="4332721">[</span><span class="op" id="4332722">]</span><span class="builtintype" id="4332723">uint8</span><span class="op" id="4332728">)</span>&nbsp;<span class="op" id="4332730">(</span><span class="ident" id="4332731">n</span>&nbsp;<span class="builtintype" id="4332733">int</span><span class="op" id="4332736">,</span>&nbsp;<span class="ident" id="4332738">err</span>&nbsp;<span class="builtintype" id="4332742">error</span><span class="op" id="4332747">)</span>&nbsp;<span class="op" id="4332749">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332752">for</span>&nbsp;<span class="ident" id="4332756">cr</span><span class="op" id="4332758">.</span><span class="ident" id="4332759">err</span>&nbsp;<span class="op" id="4332763">==</span>&nbsp;<span class="ident" id="4332766">nil</span>&nbsp;<span class="op" id="4332770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332774">if</span>&nbsp;<span class="ident" id="4332777">cr</span><span class="op" id="4332779">.</span><span class="ident" id="4332780">n</span>&nbsp;<span class="op" id="4332782">==</span>&nbsp;<span class="num" id="4332785">0</span>&nbsp;<span class="op" id="4332787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332792">if</span>&nbsp;<span class="ident" id="4332795">n</span>&nbsp;<span class="op" id="4332797">&gt;</span>&nbsp;<span class="num" id="4332799">0</span>&nbsp;<span class="op" id="4332801">&amp;&amp;</span>&nbsp;<span class="op" id="4332804">!</span><span class="ident" id="4332805">cr</span><span class="op" id="4332807">.</span><span class="ident" id="4332808">chunkHeaderAvailable</span><span class="op" id="4332828">(</span><span class="op" id="4332829">)</span>&nbsp;<span class="op" id="4332831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4332837">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4332887">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332922">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4332936">cr</span><span class="op" id="4332938">.</span><span class="ident" id="4332939">beginChunk</span><span class="op" id="4332949">(</span><span class="op" id="4332950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332955">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332966">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332970">if</span>&nbsp;<span class="builtinfunc" id="4332973">len</span><span class="op" id="4332976">(</span><span class="ident" id="4332977">b</span><span class="op" id="4332978">)</span>&nbsp;<span class="op" id="4332980">==</span>&nbsp;<span class="num" id="4332983">0</span>&nbsp;<span class="op" id="4332985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4332990">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4332998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333002">rbuf</span>&nbsp;<span class="op" id="4333007">:=</span>&nbsp;<span class="ident" id="4333010">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333014">if</span>&nbsp;<span class="ident" id="4333017">uint64</span><span class="op" id="4333023">(</span><span class="builtinfunc" id="4333024">len</span><span class="op" id="4333027">(</span><span class="ident" id="4333028">rbuf</span><span class="op" id="4333032">)</span><span class="op" id="4333033">)</span>&nbsp;<span class="op" id="4333035">&gt;</span>&nbsp;<span class="ident" id="4333037">cr</span><span class="op" id="4333039">.</span><span class="ident" id="4333040">n</span>&nbsp;<span class="op" id="4333042">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333047">rbuf</span>&nbsp;<span class="op" id="4333052">=</span>&nbsp;<span class="ident" id="4333054">rbuf</span><span class="op" id="4333058">[</span><span class="op" id="4333059">:</span><span class="ident" id="4333060">cr</span><span class="op" id="4333062">.</span><span class="ident" id="4333063">n</span><span class="op" id="4333064">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333072">var</span>&nbsp;<span class="ident" id="4333076">n0</span>&nbsp;<span class="builtintype" id="4333079">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333085">n0</span><span class="op" id="4333087">,</span>&nbsp;<span class="ident" id="4333089">cr</span><span class="op" id="4333091">.</span><span class="ident" id="4333092">err</span>&nbsp;<span class="op" id="4333096">=</span>&nbsp;<span class="ident" id="4333098">cr</span><span class="op" id="4333100">.</span><span class="ident" id="4333101">r</span><span class="op" id="4333102">.</span><span class="ident" id="4333103">Read</span><span class="op" id="4333107">(</span><span class="ident" id="4333108">rbuf</span><span class="op" id="4333112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333116">n</span>&nbsp;<span class="op" id="4333118">+=</span>&nbsp;<span class="ident" id="4333121">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333126">b</span>&nbsp;<span class="op" id="4333128">=</span>&nbsp;<span class="ident" id="4333130">b</span><span class="op" id="4333131">[</span><span class="ident" id="4333132">n0</span><span class="op" id="4333134">:</span><span class="op" id="4333135">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333139">cr</span><span class="op" id="4333141">.</span><span class="ident" id="4333142">n</span>&nbsp;<span class="op" id="4333144">-=</span>&nbsp;<span class="ident" id="4333147">uint64</span><span class="op" id="4333153">(</span><span class="ident" id="4333154">n0</span><span class="op" id="4333156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4333160">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4333215">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333253">if</span>&nbsp;<span class="ident" id="4333256">cr</span><span class="op" id="4333258">.</span><span class="ident" id="4333259">n</span>&nbsp;<span class="op" id="4333261">==</span>&nbsp;<span class="num" id="4333264">0</span>&nbsp;<span class="op" id="4333266">&amp;&amp;</span>&nbsp;<span class="ident" id="4333269">cr</span><span class="op" id="4333271">.</span><span class="ident" id="4333272">err</span>&nbsp;<span class="op" id="4333276">==</span>&nbsp;<span class="ident" id="4333279">nil</span>&nbsp;<span class="op" id="4333283">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333288">if</span>&nbsp;<span class="ident" id="4333291">_</span><span class="op" id="4333292">,</span>&nbsp;<span class="ident" id="4333294">cr</span><span class="op" id="4333296">.</span><span class="ident" id="4333297">err</span>&nbsp;<span class="op" id="4333301">=</span>&nbsp;<span class="ident" id="4333303">io</span><span class="op" id="4333305">.</span><span class="ident" id="4333306">ReadFull</span><span class="op" id="4333314">(</span><span class="ident" id="4333315">cr</span><span class="op" id="4333317">.</span><span class="ident" id="4333318">r</span><span class="op" id="4333319">,</span>&nbsp;<span class="ident" id="4333321">cr</span><span class="op" id="4333323">.</span><span class="ident" id="4333324">buf</span><span class="op" id="4333327">[</span><span class="op" id="4333328">:</span><span class="num" id="4333329">2</span><span class="op" id="4333330">]</span><span class="op" id="4333331">)</span><span class="op" id="4333332">;</span>&nbsp;<span class="ident" id="4333334">cr</span><span class="op" id="4333336">.</span><span class="ident" id="4333337">err</span>&nbsp;<span class="op" id="4333341">==</span>&nbsp;<span class="ident" id="4333344">nil</span>&nbsp;<span class="op" id="4333348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333354">if</span>&nbsp;<span class="ident" id="4333357">cr</span><span class="op" id="4333359">.</span><span class="ident" id="4333360">buf</span><span class="op" id="4333363">[</span><span class="num" id="4333364">0</span><span class="op" id="4333365">]</span>&nbsp;<span class="op" id="4333367">!=</span>&nbsp;<span class="string" id="4333370">&#39;\r&#39;</span>&nbsp;<span class="op" id="4333375">||</span>&nbsp;<span class="ident" id="4333378">cr</span><span class="op" id="4333380">.</span><span class="ident" id="4333381">buf</span><span class="op" id="4333384">[</span><span class="num" id="4333385">1</span><span class="op" id="4333386">]</span>&nbsp;<span class="op" id="4333388">!=</span>&nbsp;<span class="string" id="4333391">&#39;\n&#39;</span>&nbsp;<span class="op" id="4333396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333403">cr</span><span class="op" id="4333405">.</span><span class="ident" id="4333406">err</span>&nbsp;<span class="op" id="4333410">=</span>&nbsp;<span class="ident" id="4333412">errors</span><span class="op" id="4333418">.</span><span class="ident" id="4333419">New</span><span class="op" id="4333422">(</span><span class="string" id="4333423">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="4333451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333462">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333472">return</span>&nbsp;<span class="ident" id="4333479">n</span><span class="op" id="4333480">,</span>&nbsp;<span class="ident" id="4333482">cr</span><span class="op" id="4333484">.</span><span class="ident" id="4333485">err</span><br>
<span class="lineno"></span><span class="op" id="4333489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4333492">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4333535">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="4333581">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4333633">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4333697">func</span>&nbsp;<span class="ident" id="4333702">readLine</span><span class="op" id="4333710">(</span><span class="ident" id="4333711">b</span>&nbsp;<span class="op" id="4333713">*</span><span class="ident" id="4333714">bufio</span><span class="op" id="4333719">.</span><span class="ident" id="4333720">Reader</span><span class="op" id="4333726">)</span>&nbsp;<span class="op" id="4333728">(</span><span class="ident" id="4333729">p</span>&nbsp;<span class="op" id="4333731">[</span><span class="op" id="4333732">]</span><span class="builtintype" id="4333733">byte</span><span class="op" id="4333737">,</span>&nbsp;<span class="ident" id="4333739">err</span>&nbsp;<span class="builtintype" id="4333743">error</span><span class="op" id="4333748">)</span>&nbsp;<span class="op" id="4333750">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333753">if</span>&nbsp;<span class="ident" id="4333756">p</span><span class="op" id="4333757">,</span>&nbsp;<span class="ident" id="4333759">err</span>&nbsp;<span class="op" id="4333763">=</span>&nbsp;<span class="ident" id="4333765">b</span><span class="op" id="4333766">.</span><span class="ident" id="4333767">ReadSlice</span><span class="op" id="4333776">(</span><span class="string" id="4333777">&#39;\n&#39;</span><span class="op" id="4333781">)</span><span class="op" id="4333782">;</span>&nbsp;<span class="ident" id="4333784">err</span>&nbsp;<span class="op" id="4333788">!=</span>&nbsp;<span class="ident" id="4333791">nil</span>&nbsp;<span class="op" id="4333795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4333799">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4333839">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4333900">if</span>&nbsp;<span class="ident" id="4333903">err</span>&nbsp;<span class="op" id="4333907">==</span>&nbsp;<span class="ident" id="4333910">io</span><span class="op" id="4333912">.</span><span class="ident" id="4333913">EOF</span>&nbsp;<span class="op" id="4333917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333922">err</span>&nbsp;<span class="op" id="4333926">=</span>&nbsp;<span class="ident" id="4333928">io</span><span class="op" id="4333930">.</span><span class="ident" id="4333931">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4333950">}</span>&nbsp;<span class="keyword" id="4333952">else</span>&nbsp;<span class="keyword" id="4333957">if</span>&nbsp;<span class="ident" id="4333960">err</span>&nbsp;<span class="op" id="4333964">==</span>&nbsp;<span class="ident" id="4333967">bufio</span><span class="op" id="4333972">.</span><span class="ident" id="4333973">ErrBufferFull</span>&nbsp;<span class="op" id="4333987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4333992">err</span>&nbsp;<span class="op" id="4333996">=</span>&nbsp;<span class="ident" id="4333998">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4334019">return</span>&nbsp;<span class="ident" id="4334026">nil</span><span class="op" id="4334029">,</span>&nbsp;<span class="ident" id="4334031">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334036">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4334039">if</span>&nbsp;<span class="builtinfunc" id="4334042">len</span><span class="op" id="4334045">(</span><span class="ident" id="4334046">p</span><span class="op" id="4334047">)</span>&nbsp;<span class="op" id="4334049">&gt;=</span>&nbsp;<span class="ident" id="4334052">maxLineLength</span>&nbsp;<span class="op" id="4334066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4334070">return</span>&nbsp;<span class="ident" id="4334077">nil</span><span class="op" id="4334080">,</span>&nbsp;<span class="ident" id="4334082">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4334101">return</span>&nbsp;<span class="ident" id="4334108">trimTrailingWhitespace</span><span class="op" id="4334130">(</span><span class="ident" id="4334131">p</span><span class="op" id="4334132">)</span><span class="op" id="4334133">,</span>&nbsp;<span class="ident" id="4334135">nil</span><br>
<span class="lineno"></span><span class="op" id="4334139">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4334142">func</span>&nbsp;<span class="ident" id="4334147">trimTrailingWhitespace</span><span class="op" id="4334169">(</span><span class="ident" id="4334170">b</span>&nbsp;<span class="op" id="4334172">[</span><span class="op" id="4334173">]</span><span class="builtintype" id="4334174">byte</span><span class="op" id="4334178">)</span>&nbsp;<span class="op" id="4334180">[</span><span class="op" id="4334181">]</span><span class="builtintype" id="4334182">byte</span>&nbsp;<span class="op" id="4334187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4334190">for</span>&nbsp;<span class="builtinfunc" id="4334194">len</span><span class="op" id="4334197">(</span><span class="ident" id="4334198">b</span><span class="op" id="4334199">)</span>&nbsp;<span class="op" id="4334201">&gt;</span>&nbsp;<span class="num" id="4334203">0</span>&nbsp;<span class="op" id="4334205">&amp;&amp;</span>&nbsp;<span class="ident" id="4334208">isASCIISpace</span><span class="op" id="4334220">(</span><span class="ident" id="4334221">b</span><span class="op" id="4334222">[</span><span class="builtinfunc" id="4334223">len</span><span class="op" id="4334226">(</span><span class="ident" id="4334227">b</span><span class="op" id="4334228">)</span><span class="op" id="4334229">-</span><span class="num" id="4334230">1</span><span class="op" id="4334231">]</span><span class="op" id="4334232">)</span>&nbsp;<span class="op" id="4334234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4334238">b</span>&nbsp;<span class="op" id="4334240">=</span>&nbsp;<span class="ident" id="4334242">b</span><span class="op" id="4334243">[</span><span class="op" id="4334244">:</span><span class="builtinfunc" id="4334245">len</span><span class="op" id="4334248">(</span><span class="ident" id="4334249">b</span><span class="op" id="4334250">)</span><span class="op" id="4334251">-</span><span class="num" id="4334252">1</span><span class="op" id="4334253">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4334256">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4334259">return</span>&nbsp;<span class="ident" id="4334266">b</span><br>
<span class="lineno"></span><span class="op" id="4334268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4334271">func</span>&nbsp;<span class="ident" id="4334276">isASCIISpace</span><span class="op" id="4334288">(</span><span class="ident" id="4334289">b</span>&nbsp;<span class="builtintype" id="4334291">byte</span><span class="op" id="4334295">)</span>&nbsp;<span class="builtintype" id="4334297">bool</span>&nbsp;<span class="op" id="4334302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4334305">return</span>&nbsp;<span class="ident" id="4334312">b</span>&nbsp;<span class="op" id="4334314">==</span>&nbsp;<span class="string" id="4334317">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4334321">||</span>&nbsp;<span class="ident" id="4334324">b</span>&nbsp;<span class="op" id="4334326">==</span>&nbsp;<span class="string" id="4334329">&#39;\t&#39;</span>&nbsp;<span class="op" id="4334334">||</span>&nbsp;<span class="ident" id="4334337">b</span>&nbsp;<span class="op" id="4334339">==</span>&nbsp;<span class="string" id="4334342">&#39;\n&#39;</span>&nbsp;<span class="op" id="4334347">||</span>&nbsp;<span class="ident" id="4334350">b</span>&nbsp;<span class="op" id="4334352">==</span>&nbsp;<span class="string" id="4334355">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="4334360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4334363">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="4334444">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="4334525">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="4334593">//</span><br>
<span class="lineno"></span><span class="comment" id="4334596">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="4334663">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4334726">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4334792">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="4334861">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="4334897">func</span>&nbsp;<span class="ident" id="4334902">NewChunkedWriter</span><span class="op" id="4334918">(</span><span class="ident" id="4334919">w</span>&nbsp;<span class="ident" id="4334921">io</span><span class="op" id="4334923">.</span><span class="ident" id="4334924">Writer</span><span class="op" id="4334930">)</span>&nbsp;<span class="ident" id="4334932">io</span><span class="op" id="4334934">.</span><span class="ident" id="4334935">WriteCloser</span>&nbsp;<span class="op" id="4334947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4334950">return</span>&nbsp;<span class="op" id="4334957">&amp;</span><span class="ident" id="4334958">chunkedWriter</span><span class="op" id="4334971">{</span><span class="ident" id="4334972">w</span><span class="op" id="4334973">}</span><br>
<span class="lineno"></span><span class="op" id="4334975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4334978">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="4335053">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4335115">type</span>&nbsp;<span class="ident" id="4335120">chunkedWriter</span>&nbsp;<span class="keyword" id="4335134">struct</span>&nbsp;<span class="op" id="4335141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4335144">Wire</span>&nbsp;<span class="ident" id="4335149">io</span><span class="op" id="4335151">.</span><span class="ident" id="4335152">Writer</span><br>
<span class="lineno"></span><span class="op" id="4335159">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4335162">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="4335214">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4335293">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="4335356">func</span>&nbsp;<span class="op" id="4335361">(</span><span class="ident" id="4335362">cw</span>&nbsp;<span class="op" id="4335365">*</span><span class="ident" id="4335366">chunkedWriter</span><span class="op" id="4335379">)</span>&nbsp;<span class="ident" id="4335381">Write</span><span class="op" id="4335386">(</span><span class="ident" id="4335387">data</span>&nbsp;<span class="op" id="4335392">[</span><span class="op" id="4335393">]</span><span class="builtintype" id="4335394">byte</span><span class="op" id="4335398">)</span>&nbsp;<span class="op" id="4335400">(</span><span class="ident" id="4335401">n</span>&nbsp;<span class="builtintype" id="4335403">int</span><span class="op" id="4335406">,</span>&nbsp;<span class="ident" id="4335408">err</span>&nbsp;<span class="builtintype" id="4335412">error</span><span class="op" id="4335417">)</span>&nbsp;<span class="op" id="4335419">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4335423">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335493">if</span>&nbsp;<span class="builtinfunc" id="4335496">len</span><span class="op" id="4335499">(</span><span class="ident" id="4335500">data</span><span class="op" id="4335504">)</span>&nbsp;<span class="op" id="4335506">==</span>&nbsp;<span class="num" id="4335509">0</span>&nbsp;<span class="op" id="4335511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335515">return</span>&nbsp;<span class="num" id="4335522">0</span><span class="op" id="4335523">,</span>&nbsp;<span class="ident" id="4335525">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4335530">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335534">if</span>&nbsp;<span class="ident" id="4335537">_</span><span class="op" id="4335538">,</span>&nbsp;<span class="ident" id="4335540">err</span>&nbsp;<span class="op" id="4335544">=</span>&nbsp;<span class="ident" id="4335546">fmt</span><span class="op" id="4335549">.</span><span class="ident" id="4335550">Fprintf</span><span class="op" id="4335557">(</span><span class="ident" id="4335558">cw</span><span class="op" id="4335560">.</span><span class="ident" id="4335561">Wire</span><span class="op" id="4335565">,</span>&nbsp;<span class="string" id="4335567">&#34;%x\r\n&#34;</span><span class="op" id="4335575">,</span>&nbsp;<span class="builtinfunc" id="4335577">len</span><span class="op" id="4335580">(</span><span class="ident" id="4335581">data</span><span class="op" id="4335585">)</span><span class="op" id="4335586">)</span><span class="op" id="4335587">;</span>&nbsp;<span class="ident" id="4335589">err</span>&nbsp;<span class="op" id="4335593">!=</span>&nbsp;<span class="ident" id="4335596">nil</span>&nbsp;<span class="op" id="4335600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335604">return</span>&nbsp;<span class="num" id="4335611">0</span><span class="op" id="4335612">,</span>&nbsp;<span class="ident" id="4335614">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4335619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335622">if</span>&nbsp;<span class="ident" id="4335625">n</span><span class="op" id="4335626">,</span>&nbsp;<span class="ident" id="4335628">err</span>&nbsp;<span class="op" id="4335632">=</span>&nbsp;<span class="ident" id="4335634">cw</span><span class="op" id="4335636">.</span><span class="ident" id="4335637">Wire</span><span class="op" id="4335641">.</span><span class="ident" id="4335642">Write</span><span class="op" id="4335647">(</span><span class="ident" id="4335648">data</span><span class="op" id="4335652">)</span><span class="op" id="4335653">;</span>&nbsp;<span class="ident" id="4335655">err</span>&nbsp;<span class="op" id="4335659">!=</span>&nbsp;<span class="ident" id="4335662">nil</span>&nbsp;<span class="op" id="4335666">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335670">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4335678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335681">if</span>&nbsp;<span class="ident" id="4335684">n</span>&nbsp;<span class="op" id="4335686">!=</span>&nbsp;<span class="builtinfunc" id="4335689">len</span><span class="op" id="4335692">(</span><span class="ident" id="4335693">data</span><span class="op" id="4335697">)</span>&nbsp;<span class="op" id="4335699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4335703">err</span>&nbsp;<span class="op" id="4335707">=</span>&nbsp;<span class="ident" id="4335709">io</span><span class="op" id="4335711">.</span><span class="ident" id="4335712">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335728">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4335736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4335739">_</span><span class="op" id="4335740">,</span>&nbsp;<span class="ident" id="4335742">err</span>&nbsp;<span class="op" id="4335746">=</span>&nbsp;<span class="ident" id="4335748">io</span><span class="op" id="4335750">.</span><span class="ident" id="4335751">WriteString</span><span class="op" id="4335762">(</span><span class="ident" id="4335763">cw</span><span class="op" id="4335765">.</span><span class="ident" id="4335766">Wire</span><span class="op" id="4335770">,</span>&nbsp;<span class="string" id="4335772">&#34;\r\n&#34;</span><span class="op" id="4335778">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335782">return</span><br>
<span class="lineno"></span><span class="op" id="4335789">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="4335792">func</span>&nbsp;<span class="op" id="4335797">(</span><span class="ident" id="4335798">cw</span>&nbsp;<span class="op" id="4335801">*</span><span class="ident" id="4335802">chunkedWriter</span><span class="op" id="4335815">)</span>&nbsp;<span class="ident" id="4335817">Close</span><span class="op" id="4335822">(</span><span class="op" id="4335823">)</span>&nbsp;<span class="builtintype" id="4335825">error</span>&nbsp;<span class="op" id="4335831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4335834">_</span><span class="op" id="4335835">,</span>&nbsp;<span class="ident" id="4335837">err</span>&nbsp;<span class="op" id="4335841">:=</span>&nbsp;<span class="ident" id="4335844">io</span><span class="op" id="4335846">.</span><span class="ident" id="4335847">WriteString</span><span class="op" id="4335858">(</span><span class="ident" id="4335859">cw</span><span class="op" id="4335861">.</span><span class="ident" id="4335862">Wire</span><span class="op" id="4335866">,</span>&nbsp;<span class="string" id="4335868">&#34;0\r\n&#34;</span><span class="op" id="4335875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335878">return</span>&nbsp;<span class="ident" id="4335885">err</span><br>
<span class="lineno"></span><span class="op" id="4335889">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="4335892">func</span>&nbsp;<span class="ident" id="4335897">parseHexUint</span><span class="op" id="4335909">(</span><span class="ident" id="4335910">v</span>&nbsp;<span class="op" id="4335912">[</span><span class="op" id="4335913">]</span><span class="builtintype" id="4335914">byte</span><span class="op" id="4335918">)</span>&nbsp;<span class="op" id="4335920">(</span><span class="ident" id="4335921">n</span>&nbsp;<span class="ident" id="4335923">uint64</span><span class="op" id="4335929">,</span>&nbsp;<span class="ident" id="4335931">err</span>&nbsp;<span class="builtintype" id="4335935">error</span><span class="op" id="4335940">)</span>&nbsp;<span class="op" id="4335942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335945">for</span>&nbsp;<span class="ident" id="4335949">_</span><span class="op" id="4335950">,</span>&nbsp;<span class="ident" id="4335952">b</span>&nbsp;<span class="op" id="4335954">:=</span>&nbsp;<span class="keyword" id="4335957">range</span>&nbsp;<span class="ident" id="4335963">v</span>&nbsp;<span class="op" id="4335965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4335969">n</span>&nbsp;<span class="op" id="4335971">&lt;&lt;=</span>&nbsp;<span class="num" id="4335975">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335979">switch</span>&nbsp;<span class="op" id="4335986">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4335990">case</span>&nbsp;<span class="string" id="4335995">&#39;0&#39;</span>&nbsp;<span class="op" id="4335999">&lt;=</span>&nbsp;<span class="ident" id="4336002">b</span>&nbsp;<span class="op" id="4336004">&amp;&amp;</span>&nbsp;<span class="ident" id="4336007">b</span>&nbsp;<span class="op" id="4336009">&lt;=</span>&nbsp;<span class="string" id="4336012">&#39;9&#39;</span><span class="op" id="4336015">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4336020">b</span>&nbsp;<span class="op" id="4336022">=</span>&nbsp;<span class="ident" id="4336024">b</span>&nbsp;<span class="op" id="4336026">-</span>&nbsp;<span class="string" id="4336028">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4336034">case</span>&nbsp;<span class="string" id="4336039">&#39;a&#39;</span>&nbsp;<span class="op" id="4336043">&lt;=</span>&nbsp;<span class="ident" id="4336046">b</span>&nbsp;<span class="op" id="4336048">&amp;&amp;</span>&nbsp;<span class="ident" id="4336051">b</span>&nbsp;<span class="op" id="4336053">&lt;=</span>&nbsp;<span class="string" id="4336056">&#39;f&#39;</span><span class="op" id="4336059">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4336064">b</span>&nbsp;<span class="op" id="4336066">=</span>&nbsp;<span class="ident" id="4336068">b</span>&nbsp;<span class="op" id="4336070">-</span>&nbsp;<span class="string" id="4336072">&#39;a&#39;</span>&nbsp;<span class="op" id="4336076">+</span>&nbsp;<span class="num" id="4336078">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4336083">case</span>&nbsp;<span class="string" id="4336088">&#39;A&#39;</span>&nbsp;<span class="op" id="4336092">&lt;=</span>&nbsp;<span class="ident" id="4336095">b</span>&nbsp;<span class="op" id="4336097">&amp;&amp;</span>&nbsp;<span class="ident" id="4336100">b</span>&nbsp;<span class="op" id="4336102">&lt;=</span>&nbsp;<span class="string" id="4336105">&#39;F&#39;</span><span class="op" id="4336108">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4336113">b</span>&nbsp;<span class="op" id="4336115">=</span>&nbsp;<span class="ident" id="4336117">b</span>&nbsp;<span class="op" id="4336119">-</span>&nbsp;<span class="string" id="4336121">&#39;A&#39;</span>&nbsp;<span class="op" id="4336125">+</span>&nbsp;<span class="num" id="4336127">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4336132">default</span><span class="op" id="4336139">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4336144">return</span>&nbsp;<span class="num" id="4336151">0</span><span class="op" id="4336152">,</span>&nbsp;<span class="ident" id="4336154">errors</span><span class="op" id="4336160">.</span><span class="ident" id="4336161">New</span><span class="op" id="4336164">(</span><span class="string" id="4336165">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="4336195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4336199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4336203">n</span>&nbsp;<span class="op" id="4336205">|=</span>&nbsp;<span class="ident" id="4336208">uint64</span><span class="op" id="4336214">(</span><span class="ident" id="4336215">b</span><span class="op" id="4336216">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4336219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4336222">return</span><br>
<span class="lineno"></span><span class="op" id="4336229">}</span>
</div>
</body>
</html>
