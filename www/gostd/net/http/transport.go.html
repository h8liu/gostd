<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html" class="current">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3640567">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3640622">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3640676">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3640727">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="3640772">//</span><br>
<span class="lineno"></span><span class="comment" id="3640775">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="3640842">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3640888">package</span>&nbsp;<span class="ident" id="3640896">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3640902">import</span>&nbsp;<span class="op" id="3640909">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3640912">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3640921">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3640938">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3640952">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3640962">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3640969">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3640975">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3640982">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3640989">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3641000">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3641006">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3641017">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3641025">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3641032">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3641035">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3641105">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="3641176">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="3641247">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3641315">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="3641352">var</span>&nbsp;<span class="ident" id="3641356">DefaultTransport</span>&nbsp;<span class="ident" id="3641373">RoundTripper</span>&nbsp;<span class="op" id="3641386">=</span>&nbsp;<span class="op" id="3641388">&amp;</span><span class="ident" id="3641389">Transport</span><span class="op" id="3641398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641401">Proxy</span><span class="op" id="3641406">:</span>&nbsp;<span class="ident" id="3641408">ProxyFromEnvironment</span><span class="op" id="3641428">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641431">Dial</span><span class="op" id="3641435">:</span>&nbsp;<span class="op" id="3641437">(</span><span class="op" id="3641438">&amp;</span><span class="ident" id="3641439">net</span><span class="op" id="3641442">.</span><span class="ident" id="3641443">Dialer</span><span class="op" id="3641449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641453">Timeout</span><span class="op" id="3641460">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="3641464">30</span>&nbsp;<span class="op" id="3641467">*</span>&nbsp;<span class="ident" id="3641469">time</span><span class="op" id="3641473">.</span><span class="ident" id="3641474">Second</span><span class="op" id="3641480">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641484">KeepAlive</span><span class="op" id="3641493">:</span>&nbsp;<span class="num" id="3641495">30</span>&nbsp;<span class="op" id="3641498">*</span>&nbsp;<span class="ident" id="3641500">time</span><span class="op" id="3641504">.</span><span class="ident" id="3641505">Second</span><span class="op" id="3641511">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3641514">}</span><span class="op" id="3641515">)</span><span class="op" id="3641516">.</span><span class="ident" id="3641517">Dial</span><span class="op" id="3641521">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641524">TLSHandshakeTimeout</span><span class="op" id="3641543">:</span>&nbsp;<span class="num" id="3641545">10</span>&nbsp;<span class="op" id="3641548">*</span>&nbsp;<span class="ident" id="3641550">time</span><span class="op" id="3641554">.</span><span class="ident" id="3641555">Second</span><span class="op" id="3641561">,</span><br>
<span class="lineno">40</span><span class="op" id="3641563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3641566">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3641632">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="3641656">const</span>&nbsp;<span class="ident" id="3641662">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3641689">=</span>&nbsp;<span class="num" id="3641691">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3641694">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="3641764">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="3641832">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="3641891">type</span>&nbsp;<span class="ident" id="3641896">Transport</span>&nbsp;<span class="keyword" id="3641906">struct</span>&nbsp;<span class="op" id="3641913">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641916">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641927">sync</span><span class="op" id="3641931">.</span><span class="ident" id="3641932">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3641939">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3641950">bool</span>&nbsp;<span class="comment" id="3641955">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642002">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="3642013">map</span><span class="op" id="3642016">[</span><span class="ident" id="3642017">connectMethodKey</span><span class="op" id="3642033">]</span><span class="op" id="3642034">[</span><span class="op" id="3642035">]</span><span class="op" id="3642036">*</span><span class="ident" id="3642037">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642050">idleConnCh</span>&nbsp;<span class="keyword" id="3642061">map</span><span class="op" id="3642064">[</span><span class="ident" id="3642065">connectMethodKey</span><span class="op" id="3642081">]</span><span class="keyword" id="3642082">chan</span>&nbsp;<span class="op" id="3642087">*</span><span class="ident" id="3642088">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642102">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642114">sync</span><span class="op" id="3642118">.</span><span class="ident" id="3642119">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642126">reqCanceler</span>&nbsp;<span class="keyword" id="3642138">map</span><span class="op" id="3642141">[</span><span class="op" id="3642142">*</span><span class="ident" id="3642143">Request</span><span class="op" id="3642150">]</span><span class="keyword" id="3642151">func</span><span class="op" id="3642155">(</span><span class="op" id="3642156">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642160">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642169">sync</span><span class="op" id="3642173">.</span><span class="ident" id="3642174">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642183">altProto</span>&nbsp;<span class="keyword" id="3642192">map</span><span class="op" id="3642195">[</span><span class="builtintype" id="3642196">string</span><span class="op" id="3642202">]</span><span class="ident" id="3642203">RoundTripper</span>&nbsp;<span class="comment" id="3642216">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642262">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642323">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642381">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642429">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642490">Proxy</span>&nbsp;<span class="keyword" id="3642496">func</span><span class="op" id="3642500">(</span><span class="op" id="3642501">*</span><span class="ident" id="3642502">Request</span><span class="op" id="3642509">)</span>&nbsp;<span class="op" id="3642511">(</span><span class="op" id="3642512">*</span><span class="ident" id="3642513">url</span><span class="op" id="3642516">.</span><span class="ident" id="3642517">URL</span><span class="op" id="3642520">,</span>&nbsp;<span class="builtintype" id="3642522">error</span><span class="op" id="3642527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642531">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642593">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642614">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3642652">Dial</span>&nbsp;<span class="keyword" id="3642657">func</span><span class="op" id="3642661">(</span><span class="ident" id="3642662">network</span><span class="op" id="3642669">,</span>&nbsp;<span class="ident" id="3642671">addr</span>&nbsp;<span class="builtintype" id="3642676">string</span><span class="op" id="3642682">)</span>&nbsp;<span class="op" id="3642684">(</span><span class="ident" id="3642685">net</span><span class="op" id="3642688">.</span><span class="ident" id="3642689">Conn</span><span class="op" id="3642693">,</span>&nbsp;<span class="builtintype" id="3642695">error</span><span class="op" id="3642700">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642704">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642765">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642817">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642821">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642879">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642883">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3642942">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643003">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643067">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643095">DialTLS</span>&nbsp;<span class="keyword" id="3643103">func</span><span class="op" id="3643107">(</span><span class="ident" id="3643108">network</span><span class="op" id="3643115">,</span>&nbsp;<span class="ident" id="3643117">addr</span>&nbsp;<span class="builtintype" id="3643122">string</span><span class="op" id="3643128">)</span>&nbsp;<span class="op" id="3643130">(</span><span class="ident" id="3643131">net</span><span class="op" id="3643134">.</span><span class="ident" id="3643135">Conn</span><span class="op" id="3643139">,</span>&nbsp;<span class="builtintype" id="3643141">error</span><span class="op" id="3643146">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643150">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643214">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643273">TLSClientConfig</span>&nbsp;<span class="op" id="3643289">*</span><span class="ident" id="3643290">tls</span><span class="op" id="3643293">.</span><span class="ident" id="3643294">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643303">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643375">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643428">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="3643448">time</span><span class="op" id="3643452">.</span><span class="ident" id="3643453">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643464">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643531">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3643568">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="3643586">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643593">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643654">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643713">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643770">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643831">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643891">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3643946">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644000">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644018">DisableCompression</span>&nbsp;<span class="builtintype" id="3644037">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644044">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644108">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644153">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644193">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="3644213">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644219">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644283">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644344">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644403">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3644465">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="3644487">time</span><span class="op" id="3644491">.</span><span class="ident" id="3644492">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644503">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3644554">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="3644604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="3644607">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3644673">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="3644733">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="3644800">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="3644868">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="3644881">//</span><br>
<span class="lineno"></span><span class="comment" id="3644884">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3644944">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="3645006">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="3645064">//</span><br>
<span class="lineno">130</span><span class="comment" id="3645067">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3645137">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3645206">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="3645233">//</span><br>
<span class="lineno"></span><span class="comment" id="3645236">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="3645306">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3645372">func</span>&nbsp;<span class="ident" id="3645377">ProxyFromEnvironment</span><span class="op" id="3645397">(</span><span class="ident" id="3645398">req</span>&nbsp;<span class="op" id="3645402">*</span><span class="ident" id="3645403">Request</span><span class="op" id="3645410">)</span>&nbsp;<span class="op" id="3645412">(</span><span class="op" id="3645413">*</span><span class="ident" id="3645414">url</span><span class="op" id="3645417">.</span><span class="ident" id="3645418">URL</span><span class="op" id="3645421">,</span>&nbsp;<span class="builtintype" id="3645423">error</span><span class="op" id="3645428">)</span>&nbsp;<span class="op" id="3645430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645433">var</span>&nbsp;<span class="ident" id="3645437">proxy</span>&nbsp;<span class="builtintype" id="3645443">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645451">if</span>&nbsp;<span class="ident" id="3645454">req</span><span class="op" id="3645457">.</span><span class="ident" id="3645458">URL</span><span class="op" id="3645461">.</span><span class="ident" id="3645462">Scheme</span>&nbsp;<span class="op" id="3645469">==</span>&nbsp;<span class="string" id="3645472">&#34;https&#34;</span>&nbsp;<span class="op" id="3645480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645484">proxy</span>&nbsp;<span class="op" id="3645490">=</span>&nbsp;<span class="ident" id="3645492">httpsProxyEnv</span><span class="op" id="3645505">.</span><span class="ident" id="3645506">Get</span><span class="op" id="3645509">(</span><span class="op" id="3645510">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645516">if</span>&nbsp;<span class="ident" id="3645519">proxy</span>&nbsp;<span class="op" id="3645525">==</span>&nbsp;<span class="string" id="3645528">&#34;&#34;</span>&nbsp;<span class="op" id="3645531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645535">proxy</span>&nbsp;<span class="op" id="3645541">=</span>&nbsp;<span class="ident" id="3645543">httpProxyEnv</span><span class="op" id="3645555">.</span><span class="ident" id="3645556">Get</span><span class="op" id="3645559">(</span><span class="op" id="3645560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645566">if</span>&nbsp;<span class="ident" id="3645569">proxy</span>&nbsp;<span class="op" id="3645575">==</span>&nbsp;<span class="string" id="3645578">&#34;&#34;</span>&nbsp;<span class="op" id="3645581">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645585">return</span>&nbsp;<span class="builtintype" id="3645592">nil</span><span class="op" id="3645595">,</span>&nbsp;<span class="builtintype" id="3645597">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645605">if</span>&nbsp;<span class="op" id="3645608">!</span><span class="ident" id="3645609">useProxy</span><span class="op" id="3645617">(</span><span class="ident" id="3645618">canonicalAddr</span><span class="op" id="3645631">(</span><span class="ident" id="3645632">req</span><span class="op" id="3645635">.</span><span class="ident" id="3645636">URL</span><span class="op" id="3645639">)</span><span class="op" id="3645640">)</span>&nbsp;<span class="op" id="3645642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645646">return</span>&nbsp;<span class="builtintype" id="3645653">nil</span><span class="op" id="3645656">,</span>&nbsp;<span class="builtintype" id="3645658">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3645663">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3645666">proxyURL</span><span class="op" id="3645674">,</span>&nbsp;<span class="ident" id="3645676">err</span>&nbsp;<span class="op" id="3645680">:=</span>&nbsp;<span class="ident" id="3645683">url</span><span class="op" id="3645686">.</span><span class="ident" id="3645687">Parse</span><span class="op" id="3645692">(</span><span class="ident" id="3645693">proxy</span><span class="op" id="3645698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645701">if</span>&nbsp;<span class="ident" id="3645704">err</span>&nbsp;<span class="op" id="3645708">!=</span>&nbsp;<span class="builtintype" id="3645711">nil</span>&nbsp;<span class="op" id="3645715">||</span>&nbsp;<span class="op" id="3645718">!</span><span class="ident" id="3645719">strings</span><span class="op" id="3645726">.</span><span class="ident" id="3645727">HasPrefix</span><span class="op" id="3645736">(</span><span class="ident" id="3645737">proxyURL</span><span class="op" id="3645745">.</span><span class="ident" id="3645746">Scheme</span><span class="op" id="3645752">,</span>&nbsp;<span class="string" id="3645754">&#34;http&#34;</span><span class="op" id="3645760">)</span>&nbsp;<span class="op" id="3645762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3645766">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3645823">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3645874">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645924">if</span>&nbsp;<span class="ident" id="3645927">proxyURL</span><span class="op" id="3645935">,</span>&nbsp;<span class="ident" id="3645937">err</span>&nbsp;<span class="op" id="3645941">:=</span>&nbsp;<span class="ident" id="3645944">url</span><span class="op" id="3645947">.</span><span class="ident" id="3645948">Parse</span><span class="op" id="3645953">(</span><span class="string" id="3645954">&#34;http://&#34;</span>&nbsp;<span class="op" id="3645964">+</span>&nbsp;<span class="ident" id="3645966">proxy</span><span class="op" id="3645971">)</span><span class="op" id="3645972">;</span>&nbsp;<span class="ident" id="3645974">err</span>&nbsp;<span class="op" id="3645978">==</span>&nbsp;<span class="builtintype" id="3645981">nil</span>&nbsp;<span class="op" id="3645985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3645990">return</span>&nbsp;<span class="ident" id="3645997">proxyURL</span><span class="op" id="3646005">,</span>&nbsp;<span class="builtintype" id="3646007">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3646013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3646016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646019">if</span>&nbsp;<span class="ident" id="3646022">err</span>&nbsp;<span class="op" id="3646026">!=</span>&nbsp;<span class="builtintype" id="3646029">nil</span>&nbsp;<span class="op" id="3646033">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646037">return</span>&nbsp;<span class="builtintype" id="3646044">nil</span><span class="op" id="3646047">,</span>&nbsp;<span class="ident" id="3646049">fmt</span><span class="op" id="3646052">.</span><span class="ident" id="3646053">Errorf</span><span class="op" id="3646059">(</span><span class="string" id="3646060">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="3646090">,</span>&nbsp;<span class="ident" id="3646092">proxy</span><span class="op" id="3646097">,</span>&nbsp;<span class="ident" id="3646099">err</span><span class="op" id="3646102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3646105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646108">return</span>&nbsp;<span class="ident" id="3646115">proxyURL</span><span class="op" id="3646123">,</span>&nbsp;<span class="builtintype" id="3646125">nil</span><br>
<span class="lineno"></span><span class="op" id="3646129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3646132">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="3646194">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3646231">func</span>&nbsp;<span class="ident" id="3646236">ProxyURL</span><span class="op" id="3646244">(</span><span class="ident" id="3646245">fixedURL</span>&nbsp;<span class="op" id="3646254">*</span><span class="ident" id="3646255">url</span><span class="op" id="3646258">.</span><span class="ident" id="3646259">URL</span><span class="op" id="3646262">)</span>&nbsp;<span class="keyword" id="3646264">func</span><span class="op" id="3646268">(</span><span class="op" id="3646269">*</span><span class="ident" id="3646270">Request</span><span class="op" id="3646277">)</span>&nbsp;<span class="op" id="3646279">(</span><span class="op" id="3646280">*</span><span class="ident" id="3646281">url</span><span class="op" id="3646284">.</span><span class="ident" id="3646285">URL</span><span class="op" id="3646288">,</span>&nbsp;<span class="builtintype" id="3646290">error</span><span class="op" id="3646295">)</span>&nbsp;<span class="op" id="3646297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646300">return</span>&nbsp;<span class="keyword" id="3646307">func</span><span class="op" id="3646311">(</span><span class="op" id="3646312">*</span><span class="ident" id="3646313">Request</span><span class="op" id="3646320">)</span>&nbsp;<span class="op" id="3646322">(</span><span class="op" id="3646323">*</span><span class="ident" id="3646324">url</span><span class="op" id="3646327">.</span><span class="ident" id="3646328">URL</span><span class="op" id="3646331">,</span>&nbsp;<span class="builtintype" id="3646333">error</span><span class="op" id="3646338">)</span>&nbsp;<span class="op" id="3646340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646344">return</span>&nbsp;<span class="ident" id="3646351">fixedURL</span><span class="op" id="3646359">,</span>&nbsp;<span class="builtintype" id="3646361">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3646366">}</span><br>
<span class="lineno"></span><span class="op" id="3646368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3646371">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="3646432">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="3646468">type</span>&nbsp;<span class="ident" id="3646473">transportRequest</span>&nbsp;<span class="keyword" id="3646490">struct</span>&nbsp;<span class="op" id="3646497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3646500">*</span><span class="ident" id="3646501">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3646516">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3646556">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3646565">Header</span>&nbsp;<span class="comment" id="3646572">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3646606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="3646609">func</span>&nbsp;<span class="op" id="3646614">(</span><span class="ident" id="3646615">tr</span>&nbsp;<span class="op" id="3646618">*</span><span class="ident" id="3646619">transportRequest</span><span class="op" id="3646635">)</span>&nbsp;<span class="ident" id="3646637">extraHeaders</span><span class="op" id="3646649">(</span><span class="op" id="3646650">)</span>&nbsp;<span class="ident" id="3646652">Header</span>&nbsp;<span class="op" id="3646659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646662">if</span>&nbsp;<span class="ident" id="3646665">tr</span><span class="op" id="3646667">.</span><span class="ident" id="3646668">extra</span>&nbsp;<span class="op" id="3646674">==</span>&nbsp;<span class="builtintype" id="3646677">nil</span>&nbsp;<span class="op" id="3646681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3646685">tr</span><span class="op" id="3646687">.</span><span class="ident" id="3646688">extra</span>&nbsp;<span class="op" id="3646694">=</span>&nbsp;<span class="builtinfunc" id="3646696">make</span><span class="op" id="3646700">(</span><span class="ident" id="3646701">Header</span><span class="op" id="3646707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3646710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646713">return</span>&nbsp;<span class="ident" id="3646720">tr</span><span class="op" id="3646722">.</span><span class="ident" id="3646723">extra</span><br>
<span class="lineno">185</span><span class="op" id="3646729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3646732">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="3646784">//</span><br>
<span class="lineno"></span><span class="comment" id="3646787">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="3646856">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3646911">func</span>&nbsp;<span class="op" id="3646916">(</span><span class="ident" id="3646917">t</span>&nbsp;<span class="op" id="3646919">*</span><span class="ident" id="3646920">Transport</span><span class="op" id="3646929">)</span>&nbsp;<span class="ident" id="3646931">RoundTrip</span><span class="op" id="3646940">(</span><span class="ident" id="3646941">req</span>&nbsp;<span class="op" id="3646945">*</span><span class="ident" id="3646946">Request</span><span class="op" id="3646953">)</span>&nbsp;<span class="op" id="3646955">(</span><span class="ident" id="3646956">resp</span>&nbsp;<span class="op" id="3646961">*</span><span class="ident" id="3646962">Response</span><span class="op" id="3646970">,</span>&nbsp;<span class="ident" id="3646972">err</span>&nbsp;<span class="builtintype" id="3646976">error</span><span class="op" id="3646981">)</span>&nbsp;<span class="op" id="3646983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3646986">if</span>&nbsp;<span class="ident" id="3646989">req</span><span class="op" id="3646992">.</span><span class="ident" id="3646993">URL</span>&nbsp;<span class="op" id="3646997">==</span>&nbsp;<span class="builtintype" id="3647000">nil</span>&nbsp;<span class="op" id="3647004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647008">req</span><span class="op" id="3647011">.</span><span class="ident" id="3647012">closeBody</span><span class="op" id="3647021">(</span><span class="op" id="3647022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647026">return</span>&nbsp;<span class="builtintype" id="3647033">nil</span><span class="op" id="3647036">,</span>&nbsp;<span class="ident" id="3647038">errors</span><span class="op" id="3647044">.</span><span class="ident" id="3647045">New</span><span class="op" id="3647048">(</span><span class="string" id="3647049">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="3647072">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3647075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647078">if</span>&nbsp;<span class="ident" id="3647081">req</span><span class="op" id="3647084">.</span><span class="ident" id="3647085">Header</span>&nbsp;<span class="op" id="3647092">==</span>&nbsp;<span class="builtintype" id="3647095">nil</span>&nbsp;<span class="op" id="3647099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647103">req</span><span class="op" id="3647106">.</span><span class="ident" id="3647107">closeBody</span><span class="op" id="3647116">(</span><span class="op" id="3647117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647121">return</span>&nbsp;<span class="builtintype" id="3647128">nil</span><span class="op" id="3647131">,</span>&nbsp;<span class="ident" id="3647133">errors</span><span class="op" id="3647139">.</span><span class="ident" id="3647140">New</span><span class="op" id="3647143">(</span><span class="string" id="3647144">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="3647170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3647173">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647176">if</span>&nbsp;<span class="ident" id="3647179">req</span><span class="op" id="3647182">.</span><span class="ident" id="3647183">URL</span><span class="op" id="3647186">.</span><span class="ident" id="3647187">Scheme</span>&nbsp;<span class="op" id="3647194">!=</span>&nbsp;<span class="string" id="3647197">&#34;http&#34;</span>&nbsp;<span class="op" id="3647204">&amp;&amp;</span>&nbsp;<span class="ident" id="3647207">req</span><span class="op" id="3647210">.</span><span class="ident" id="3647211">URL</span><span class="op" id="3647214">.</span><span class="ident" id="3647215">Scheme</span>&nbsp;<span class="op" id="3647222">!=</span>&nbsp;<span class="string" id="3647225">&#34;https&#34;</span>&nbsp;<span class="op" id="3647233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647237">t</span><span class="op" id="3647238">.</span><span class="ident" id="3647239">altMu</span><span class="op" id="3647244">.</span><span class="ident" id="3647245">RLock</span><span class="op" id="3647250">(</span><span class="op" id="3647251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647255">var</span>&nbsp;<span class="ident" id="3647259">rt</span>&nbsp;<span class="ident" id="3647262">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647277">if</span>&nbsp;<span class="ident" id="3647280">t</span><span class="op" id="3647281">.</span><span class="ident" id="3647282">altProto</span>&nbsp;<span class="op" id="3647291">!=</span>&nbsp;<span class="builtintype" id="3647294">nil</span>&nbsp;<span class="op" id="3647298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647303">rt</span>&nbsp;<span class="op" id="3647306">=</span>&nbsp;<span class="ident" id="3647308">t</span><span class="op" id="3647309">.</span><span class="ident" id="3647310">altProto</span><span class="op" id="3647318">[</span><span class="ident" id="3647319">req</span><span class="op" id="3647322">.</span><span class="ident" id="3647323">URL</span><span class="op" id="3647326">.</span><span class="ident" id="3647327">Scheme</span><span class="op" id="3647333">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3647337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647341">t</span><span class="op" id="3647342">.</span><span class="ident" id="3647343">altMu</span><span class="op" id="3647348">.</span><span class="ident" id="3647349">RUnlock</span><span class="op" id="3647356">(</span><span class="op" id="3647357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647361">if</span>&nbsp;<span class="ident" id="3647364">rt</span>&nbsp;<span class="op" id="3647367">==</span>&nbsp;<span class="builtintype" id="3647370">nil</span>&nbsp;<span class="op" id="3647374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647379">req</span><span class="op" id="3647382">.</span><span class="ident" id="3647383">closeBody</span><span class="op" id="3647392">(</span><span class="op" id="3647393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647398">return</span>&nbsp;<span class="builtintype" id="3647405">nil</span><span class="op" id="3647408">,</span>&nbsp;<span class="op" id="3647410">&amp;</span><span class="ident" id="3647411">badStringError</span><span class="op" id="3647425">{</span><span class="string" id="3647426">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="3647455">,</span>&nbsp;<span class="ident" id="3647457">req</span><span class="op" id="3647460">.</span><span class="ident" id="3647461">URL</span><span class="op" id="3647464">.</span><span class="ident" id="3647465">Scheme</span><span class="op" id="3647471">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3647475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647479">return</span>&nbsp;<span class="ident" id="3647486">rt</span><span class="op" id="3647488">.</span><span class="ident" id="3647489">RoundTrip</span><span class="op" id="3647498">(</span><span class="ident" id="3647499">req</span><span class="op" id="3647502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3647505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647508">if</span>&nbsp;<span class="ident" id="3647511">req</span><span class="op" id="3647514">.</span><span class="ident" id="3647515">URL</span><span class="op" id="3647518">.</span><span class="ident" id="3647519">Host</span>&nbsp;<span class="op" id="3647524">==</span>&nbsp;<span class="string" id="3647527">&#34;&#34;</span>&nbsp;<span class="op" id="3647530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647534">req</span><span class="op" id="3647537">.</span><span class="ident" id="3647538">closeBody</span><span class="op" id="3647547">(</span><span class="op" id="3647548">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647552">return</span>&nbsp;<span class="builtintype" id="3647559">nil</span><span class="op" id="3647562">,</span>&nbsp;<span class="ident" id="3647564">errors</span><span class="op" id="3647570">.</span><span class="ident" id="3647571">New</span><span class="op" id="3647574">(</span><span class="string" id="3647575">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="3647605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3647608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647611">treq</span>&nbsp;<span class="op" id="3647616">:=</span>&nbsp;<span class="op" id="3647619">&amp;</span><span class="ident" id="3647620">transportRequest</span><span class="op" id="3647636">{</span><span class="ident" id="3647637">Request</span><span class="op" id="3647644">:</span>&nbsp;<span class="ident" id="3647646">req</span><span class="op" id="3647649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647652">cm</span><span class="op" id="3647654">,</span>&nbsp;<span class="ident" id="3647656">err</span>&nbsp;<span class="op" id="3647660">:=</span>&nbsp;<span class="ident" id="3647663">t</span><span class="op" id="3647664">.</span><span class="ident" id="3647665">connectMethodForRequest</span><span class="op" id="3647688">(</span><span class="ident" id="3647689">treq</span><span class="op" id="3647693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647696">if</span>&nbsp;<span class="ident" id="3647699">err</span>&nbsp;<span class="op" id="3647703">!=</span>&nbsp;<span class="builtintype" id="3647706">nil</span>&nbsp;<span class="op" id="3647710">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647714">req</span><span class="op" id="3647717">.</span><span class="ident" id="3647718">closeBody</span><span class="op" id="3647727">(</span><span class="op" id="3647728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3647732">return</span>&nbsp;<span class="builtintype" id="3647739">nil</span><span class="op" id="3647742">,</span>&nbsp;<span class="ident" id="3647744">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3647749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3647753">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3647814">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3647878">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3647942">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3647967">pconn</span><span class="op" id="3647972">,</span>&nbsp;<span class="ident" id="3647974">err</span>&nbsp;<span class="op" id="3647978">:=</span>&nbsp;<span class="ident" id="3647981">t</span><span class="op" id="3647982">.</span><span class="ident" id="3647983">getConn</span><span class="op" id="3647990">(</span><span class="ident" id="3647991">req</span><span class="op" id="3647994">,</span>&nbsp;<span class="ident" id="3647996">cm</span><span class="op" id="3647998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648001">if</span>&nbsp;<span class="ident" id="3648004">err</span>&nbsp;<span class="op" id="3648008">!=</span>&nbsp;<span class="builtintype" id="3648011">nil</span>&nbsp;<span class="op" id="3648015">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3648019">t</span><span class="op" id="3648020">.</span><span class="ident" id="3648021">setReqCanceler</span><span class="op" id="3648035">(</span><span class="ident" id="3648036">req</span><span class="op" id="3648039">,</span>&nbsp;<span class="builtintype" id="3648041">nil</span><span class="op" id="3648044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3648048">req</span><span class="op" id="3648051">.</span><span class="ident" id="3648052">closeBody</span><span class="op" id="3648061">(</span><span class="op" id="3648062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648066">return</span>&nbsp;<span class="builtintype" id="3648073">nil</span><span class="op" id="3648076">,</span>&nbsp;<span class="ident" id="3648078">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3648083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648087">return</span>&nbsp;<span class="ident" id="3648094">pconn</span><span class="op" id="3648099">.</span><span class="ident" id="3648100">roundTrip</span><span class="op" id="3648109">(</span><span class="ident" id="3648110">treq</span><span class="op" id="3648114">)</span><br>
<span class="lineno"></span><span class="op" id="3648116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3648119">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="3648177">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="3648243">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="3648308">//</span><br>
<span class="lineno"></span><span class="comment" id="3648311">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="3648372">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3648433">func</span>&nbsp;<span class="op" id="3648438">(</span><span class="ident" id="3648439">t</span>&nbsp;<span class="op" id="3648441">*</span><span class="ident" id="3648442">Transport</span><span class="op" id="3648451">)</span>&nbsp;<span class="ident" id="3648453">RegisterProtocol</span><span class="op" id="3648469">(</span><span class="ident" id="3648470">scheme</span>&nbsp;<span class="builtintype" id="3648477">string</span><span class="op" id="3648483">,</span>&nbsp;<span class="ident" id="3648485">rt</span>&nbsp;<span class="ident" id="3648488">RoundTripper</span><span class="op" id="3648500">)</span>&nbsp;<span class="op" id="3648502">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648505">if</span>&nbsp;<span class="ident" id="3648508">scheme</span>&nbsp;<span class="op" id="3648515">==</span>&nbsp;<span class="string" id="3648518">&#34;http&#34;</span>&nbsp;<span class="op" id="3648525">||</span>&nbsp;<span class="ident" id="3648528">scheme</span>&nbsp;<span class="op" id="3648535">==</span>&nbsp;<span class="string" id="3648538">&#34;https&#34;</span>&nbsp;<span class="op" id="3648546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3648550">panic</span><span class="op" id="3648555">(</span><span class="string" id="3648556">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3648568">+</span>&nbsp;<span class="ident" id="3648570">scheme</span>&nbsp;<span class="op" id="3648577">+</span>&nbsp;<span class="string" id="3648579">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3648600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3648603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3648606">t</span><span class="op" id="3648607">.</span><span class="ident" id="3648608">altMu</span><span class="op" id="3648613">.</span><span class="ident" id="3648614">Lock</span><span class="op" id="3648618">(</span><span class="op" id="3648619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648622">defer</span>&nbsp;<span class="ident" id="3648628">t</span><span class="op" id="3648629">.</span><span class="ident" id="3648630">altMu</span><span class="op" id="3648635">.</span><span class="ident" id="3648636">Unlock</span><span class="op" id="3648642">(</span><span class="op" id="3648643">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648646">if</span>&nbsp;<span class="ident" id="3648649">t</span><span class="op" id="3648650">.</span><span class="ident" id="3648651">altProto</span>&nbsp;<span class="op" id="3648660">==</span>&nbsp;<span class="builtintype" id="3648663">nil</span>&nbsp;<span class="op" id="3648667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3648671">t</span><span class="op" id="3648672">.</span><span class="ident" id="3648673">altProto</span>&nbsp;<span class="op" id="3648682">=</span>&nbsp;<span class="builtinfunc" id="3648684">make</span><span class="op" id="3648688">(</span><span class="keyword" id="3648689">map</span><span class="op" id="3648692">[</span><span class="builtintype" id="3648693">string</span><span class="op" id="3648699">]</span><span class="ident" id="3648700">RoundTripper</span><span class="op" id="3648712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3648715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3648718">if</span>&nbsp;<span class="ident" id="3648721">_</span><span class="op" id="3648722">,</span>&nbsp;<span class="ident" id="3648724">exists</span>&nbsp;<span class="op" id="3648731">:=</span>&nbsp;<span class="ident" id="3648734">t</span><span class="op" id="3648735">.</span><span class="ident" id="3648736">altProto</span><span class="op" id="3648744">[</span><span class="ident" id="3648745">scheme</span><span class="op" id="3648751">]</span><span class="op" id="3648752">;</span>&nbsp;<span class="ident" id="3648754">exists</span>&nbsp;<span class="op" id="3648761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3648765">panic</span><span class="op" id="3648770">(</span><span class="string" id="3648771">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3648783">+</span>&nbsp;<span class="ident" id="3648785">scheme</span>&nbsp;<span class="op" id="3648792">+</span>&nbsp;<span class="string" id="3648794">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3648815">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3648818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3648821">t</span><span class="op" id="3648822">.</span><span class="ident" id="3648823">altProto</span><span class="op" id="3648831">[</span><span class="ident" id="3648832">scheme</span><span class="op" id="3648838">]</span>&nbsp;<span class="op" id="3648840">=</span>&nbsp;<span class="ident" id="3648842">rt</span><br>
<span class="lineno"></span><span class="op" id="3648845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3648848">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="3648917">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3648981">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="3649054">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3649065">func</span>&nbsp;<span class="op" id="3649070">(</span><span class="ident" id="3649071">t</span>&nbsp;<span class="op" id="3649073">*</span><span class="ident" id="3649074">Transport</span><span class="op" id="3649083">)</span>&nbsp;<span class="ident" id="3649085">CloseIdleConnections</span><span class="op" id="3649105">(</span><span class="op" id="3649106">)</span>&nbsp;<span class="op" id="3649108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649111">t</span><span class="op" id="3649112">.</span><span class="ident" id="3649113">idleMu</span><span class="op" id="3649119">.</span><span class="ident" id="3649120">Lock</span><span class="op" id="3649124">(</span><span class="op" id="3649125">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649128">m</span>&nbsp;<span class="op" id="3649130">:=</span>&nbsp;<span class="ident" id="3649133">t</span><span class="op" id="3649134">.</span><span class="ident" id="3649135">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649145">t</span><span class="op" id="3649146">.</span><span class="ident" id="3649147">idleConn</span>&nbsp;<span class="op" id="3649156">=</span>&nbsp;<span class="builtintype" id="3649158">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649163">t</span><span class="op" id="3649164">.</span><span class="ident" id="3649165">idleConnCh</span>&nbsp;<span class="op" id="3649176">=</span>&nbsp;<span class="builtintype" id="3649178">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649183">t</span><span class="op" id="3649184">.</span><span class="ident" id="3649185">wantIdle</span>&nbsp;<span class="op" id="3649194">=</span>&nbsp;<span class="builtintype" id="3649196">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649202">t</span><span class="op" id="3649203">.</span><span class="ident" id="3649204">idleMu</span><span class="op" id="3649210">.</span><span class="ident" id="3649211">Unlock</span><span class="op" id="3649217">(</span><span class="op" id="3649218">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649221">for</span>&nbsp;<span class="ident" id="3649225">_</span><span class="op" id="3649226">,</span>&nbsp;<span class="ident" id="3649228">conns</span>&nbsp;<span class="op" id="3649234">:=</span>&nbsp;<span class="keyword" id="3649237">range</span>&nbsp;<span class="ident" id="3649243">m</span>&nbsp;<span class="op" id="3649245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649249">for</span>&nbsp;<span class="ident" id="3649253">_</span><span class="op" id="3649254">,</span>&nbsp;<span class="ident" id="3649256">pconn</span>&nbsp;<span class="op" id="3649262">:=</span>&nbsp;<span class="keyword" id="3649265">range</span>&nbsp;<span class="ident" id="3649271">conns</span>&nbsp;<span class="op" id="3649277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649282">pconn</span><span class="op" id="3649287">.</span><span class="builtinfunc" id="3649288">close</span><span class="op" id="3649293">(</span><span class="op" id="3649294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649301">}</span><br>
<span class="lineno">275</span><span class="op" id="3649303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3649306">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3649367">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3649382">func</span>&nbsp;<span class="op" id="3649387">(</span><span class="ident" id="3649388">t</span>&nbsp;<span class="op" id="3649390">*</span><span class="ident" id="3649391">Transport</span><span class="op" id="3649400">)</span>&nbsp;<span class="ident" id="3649402">CancelRequest</span><span class="op" id="3649415">(</span><span class="ident" id="3649416">req</span>&nbsp;<span class="op" id="3649420">*</span><span class="ident" id="3649421">Request</span><span class="op" id="3649428">)</span>&nbsp;<span class="op" id="3649430">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649433">t</span><span class="op" id="3649434">.</span><span class="ident" id="3649435">reqMu</span><span class="op" id="3649440">.</span><span class="ident" id="3649441">Lock</span><span class="op" id="3649445">(</span><span class="op" id="3649446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649449">cancel</span>&nbsp;<span class="op" id="3649456">:=</span>&nbsp;<span class="ident" id="3649459">t</span><span class="op" id="3649460">.</span><span class="ident" id="3649461">reqCanceler</span><span class="op" id="3649472">[</span><span class="ident" id="3649473">req</span><span class="op" id="3649476">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649479">t</span><span class="op" id="3649480">.</span><span class="ident" id="3649481">reqMu</span><span class="op" id="3649486">.</span><span class="ident" id="3649487">Unlock</span><span class="op" id="3649493">(</span><span class="op" id="3649494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3649497">if</span>&nbsp;<span class="ident" id="3649500">cancel</span>&nbsp;<span class="op" id="3649507">!=</span>&nbsp;<span class="builtintype" id="3649510">nil</span>&nbsp;<span class="op" id="3649514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649518">cancel</span><span class="op" id="3649524">(</span><span class="op" id="3649525">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649528">}</span><br>
<span class="lineno"></span><span class="op" id="3649530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3649533">//</span><br>
<span class="lineno"></span><span class="comment" id="3649536">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="3649579">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3649583">var</span>&nbsp;<span class="op" id="3649587">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649590">httpProxyEnv</span>&nbsp;<span class="op" id="3649603">=</span>&nbsp;<span class="op" id="3649605">&amp;</span><span class="ident" id="3649606">envOnce</span><span class="op" id="3649613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649617">names</span><span class="op" id="3649622">:</span>&nbsp;<span class="op" id="3649624">[</span><span class="op" id="3649625">]</span><span class="builtintype" id="3649626">string</span><span class="op" id="3649632">{</span><span class="string" id="3649633">&#34;HTTP_PROXY&#34;</span><span class="op" id="3649645">,</span>&nbsp;<span class="string" id="3649647">&#34;http_proxy&#34;</span><span class="op" id="3649659">}</span><span class="op" id="3649660">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649666">httpsProxyEnv</span>&nbsp;<span class="op" id="3649680">=</span>&nbsp;<span class="op" id="3649682">&amp;</span><span class="ident" id="3649683">envOnce</span><span class="op" id="3649690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649694">names</span><span class="op" id="3649699">:</span>&nbsp;<span class="op" id="3649701">[</span><span class="op" id="3649702">]</span><span class="builtintype" id="3649703">string</span><span class="op" id="3649709">{</span><span class="string" id="3649710">&#34;HTTPS_PROXY&#34;</span><span class="op" id="3649723">,</span>&nbsp;<span class="string" id="3649725">&#34;https_proxy&#34;</span><span class="op" id="3649738">}</span><span class="op" id="3649739">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649745">noProxyEnv</span>&nbsp;<span class="op" id="3649756">=</span>&nbsp;<span class="op" id="3649758">&amp;</span><span class="ident" id="3649759">envOnce</span><span class="op" id="3649766">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649770">names</span><span class="op" id="3649775">:</span>&nbsp;<span class="op" id="3649777">[</span><span class="op" id="3649778">]</span><span class="builtintype" id="3649779">string</span><span class="op" id="3649785">{</span><span class="string" id="3649786">&#34;NO_PROXY&#34;</span><span class="op" id="3649796">,</span>&nbsp;<span class="string" id="3649798">&#34;no_proxy&#34;</span><span class="op" id="3649808">}</span><span class="op" id="3649809">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3649812">}</span><br>
<span class="lineno"></span><span class="op" id="3649814">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3649817">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="3649885">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="3649950">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="3649969">type</span>&nbsp;<span class="ident" id="3649974">envOnce</span>&nbsp;<span class="keyword" id="3649982">struct</span>&nbsp;<span class="op" id="3649989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3649992">names</span>&nbsp;<span class="op" id="3649998">[</span><span class="op" id="3649999">]</span><span class="builtintype" id="3650000">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650008">once</span>&nbsp;&nbsp;<span class="ident" id="3650014">sync</span><span class="op" id="3650018">.</span><span class="ident" id="3650019">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650025">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3650031">string</span><br>
<span class="lineno"></span><span class="op" id="3650038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3650041">func</span>&nbsp;<span class="op" id="3650046">(</span><span class="ident" id="3650047">e</span>&nbsp;<span class="op" id="3650049">*</span><span class="ident" id="3650050">envOnce</span><span class="op" id="3650057">)</span>&nbsp;<span class="ident" id="3650059">Get</span><span class="op" id="3650062">(</span><span class="op" id="3650063">)</span>&nbsp;<span class="builtintype" id="3650065">string</span>&nbsp;<span class="op" id="3650072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650075">e</span><span class="op" id="3650076">.</span><span class="ident" id="3650077">once</span><span class="op" id="3650081">.</span><span class="ident" id="3650082">Do</span><span class="op" id="3650084">(</span><span class="ident" id="3650085">e</span><span class="op" id="3650086">.</span><span class="ident" id="3650087">init</span><span class="op" id="3650091">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650094">return</span>&nbsp;<span class="ident" id="3650101">e</span><span class="op" id="3650102">.</span><span class="ident" id="3650103">val</span><br>
<span class="lineno"></span><span class="op" id="3650107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3650110">func</span>&nbsp;<span class="op" id="3650115">(</span><span class="ident" id="3650116">e</span>&nbsp;<span class="op" id="3650118">*</span><span class="ident" id="3650119">envOnce</span><span class="op" id="3650126">)</span>&nbsp;<span class="ident" id="3650128">init</span><span class="op" id="3650132">(</span><span class="op" id="3650133">)</span>&nbsp;<span class="op" id="3650135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650138">for</span>&nbsp;<span class="ident" id="3650142">_</span><span class="op" id="3650143">,</span>&nbsp;<span class="ident" id="3650145">n</span>&nbsp;<span class="op" id="3650147">:=</span>&nbsp;<span class="keyword" id="3650150">range</span>&nbsp;<span class="ident" id="3650156">e</span><span class="op" id="3650157">.</span><span class="ident" id="3650158">names</span>&nbsp;<span class="op" id="3650164">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650168">e</span><span class="op" id="3650169">.</span><span class="ident" id="3650170">val</span>&nbsp;<span class="op" id="3650174">=</span>&nbsp;<span class="ident" id="3650176">os</span><span class="op" id="3650178">.</span><span class="ident" id="3650179">Getenv</span><span class="op" id="3650185">(</span><span class="ident" id="3650186">n</span><span class="op" id="3650187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650191">if</span>&nbsp;<span class="ident" id="3650194">e</span><span class="op" id="3650195">.</span><span class="ident" id="3650196">val</span>&nbsp;<span class="op" id="3650200">!=</span>&nbsp;<span class="string" id="3650203">&#34;&#34;</span>&nbsp;<span class="op" id="3650206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650211">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3650220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3650223">}</span><br>
<span class="lineno">325</span><span class="op" id="3650225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3650228">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="3650254">func</span>&nbsp;<span class="op" id="3650259">(</span><span class="ident" id="3650260">e</span>&nbsp;<span class="op" id="3650262">*</span><span class="ident" id="3650263">envOnce</span><span class="op" id="3650270">)</span>&nbsp;<span class="ident" id="3650272">reset</span><span class="op" id="3650277">(</span><span class="op" id="3650278">)</span>&nbsp;<span class="op" id="3650280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650283">e</span><span class="op" id="3650284">.</span><span class="ident" id="3650285">once</span>&nbsp;<span class="op" id="3650290">=</span>&nbsp;<span class="ident" id="3650292">sync</span><span class="op" id="3650296">.</span><span class="ident" id="3650297">Once</span><span class="op" id="3650301">{</span><span class="op" id="3650302">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650305">e</span><span class="op" id="3650306">.</span><span class="ident" id="3650307">val</span>&nbsp;<span class="op" id="3650311">=</span>&nbsp;<span class="string" id="3650313">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3650316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3650319">func</span>&nbsp;<span class="op" id="3650324">(</span><span class="ident" id="3650325">t</span>&nbsp;<span class="op" id="3650327">*</span><span class="ident" id="3650328">Transport</span><span class="op" id="3650337">)</span>&nbsp;<span class="ident" id="3650339">connectMethodForRequest</span><span class="op" id="3650362">(</span><span class="ident" id="3650363">treq</span>&nbsp;<span class="op" id="3650368">*</span><span class="ident" id="3650369">transportRequest</span><span class="op" id="3650385">)</span>&nbsp;<span class="op" id="3650387">(</span><span class="ident" id="3650388">cm</span>&nbsp;<span class="ident" id="3650391">connectMethod</span><span class="op" id="3650404">,</span>&nbsp;<span class="ident" id="3650406">err</span>&nbsp;<span class="builtintype" id="3650410">error</span><span class="op" id="3650415">)</span>&nbsp;<span class="op" id="3650417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650420">cm</span><span class="op" id="3650422">.</span><span class="ident" id="3650423">targetScheme</span>&nbsp;<span class="op" id="3650436">=</span>&nbsp;<span class="ident" id="3650438">treq</span><span class="op" id="3650442">.</span><span class="ident" id="3650443">URL</span><span class="op" id="3650446">.</span><span class="ident" id="3650447">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650455">cm</span><span class="op" id="3650457">.</span><span class="ident" id="3650458">targetAddr</span>&nbsp;<span class="op" id="3650469">=</span>&nbsp;<span class="ident" id="3650471">canonicalAddr</span><span class="op" id="3650484">(</span><span class="ident" id="3650485">treq</span><span class="op" id="3650489">.</span><span class="ident" id="3650490">URL</span><span class="op" id="3650493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650496">if</span>&nbsp;<span class="ident" id="3650499">t</span><span class="op" id="3650500">.</span><span class="ident" id="3650501">Proxy</span>&nbsp;<span class="op" id="3650507">!=</span>&nbsp;<span class="builtintype" id="3650510">nil</span>&nbsp;<span class="op" id="3650514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650518">cm</span><span class="op" id="3650520">.</span><span class="ident" id="3650521">proxyURL</span><span class="op" id="3650529">,</span>&nbsp;<span class="ident" id="3650531">err</span>&nbsp;<span class="op" id="3650535">=</span>&nbsp;<span class="ident" id="3650537">t</span><span class="op" id="3650538">.</span><span class="ident" id="3650539">Proxy</span><span class="op" id="3650544">(</span><span class="ident" id="3650545">treq</span><span class="op" id="3650549">.</span><span class="ident" id="3650550">Request</span><span class="op" id="3650557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3650560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650563">return</span>&nbsp;<span class="ident" id="3650570">cm</span><span class="op" id="3650572">,</span>&nbsp;<span class="ident" id="3650574">err</span><br>
<span class="lineno">340</span><span class="op" id="3650578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3650581">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="3650640">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="3650671">func</span>&nbsp;<span class="op" id="3650676">(</span><span class="ident" id="3650677">cm</span>&nbsp;<span class="op" id="3650680">*</span><span class="ident" id="3650681">connectMethod</span><span class="op" id="3650694">)</span>&nbsp;<span class="ident" id="3650696">proxyAuth</span><span class="op" id="3650705">(</span><span class="op" id="3650706">)</span>&nbsp;<span class="builtintype" id="3650708">string</span>&nbsp;<span class="op" id="3650715">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650718">if</span>&nbsp;<span class="ident" id="3650721">cm</span><span class="op" id="3650723">.</span><span class="ident" id="3650724">proxyURL</span>&nbsp;<span class="op" id="3650733">==</span>&nbsp;<span class="builtintype" id="3650736">nil</span>&nbsp;<span class="op" id="3650740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650744">return</span>&nbsp;<span class="string" id="3650751">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3650755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650758">if</span>&nbsp;<span class="ident" id="3650761">u</span>&nbsp;<span class="op" id="3650763">:=</span>&nbsp;<span class="ident" id="3650766">cm</span><span class="op" id="3650768">.</span><span class="ident" id="3650769">proxyURL</span><span class="op" id="3650777">.</span><span class="ident" id="3650778">User</span><span class="op" id="3650782">;</span>&nbsp;<span class="ident" id="3650784">u</span>&nbsp;<span class="op" id="3650786">!=</span>&nbsp;<span class="builtintype" id="3650789">nil</span>&nbsp;<span class="op" id="3650793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650797">username</span>&nbsp;<span class="op" id="3650806">:=</span>&nbsp;<span class="ident" id="3650809">u</span><span class="op" id="3650810">.</span><span class="ident" id="3650811">Username</span><span class="op" id="3650819">(</span><span class="op" id="3650820">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3650824">password</span><span class="op" id="3650832">,</span>&nbsp;<span class="ident" id="3650834">_</span>&nbsp;<span class="op" id="3650836">:=</span>&nbsp;<span class="ident" id="3650839">u</span><span class="op" id="3650840">.</span><span class="ident" id="3650841">Password</span><span class="op" id="3650849">(</span><span class="op" id="3650850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650854">return</span>&nbsp;<span class="string" id="3650861">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="3650870">+</span>&nbsp;<span class="ident" id="3650872">basicAuth</span><span class="op" id="3650881">(</span><span class="ident" id="3650882">username</span><span class="op" id="3650890">,</span>&nbsp;<span class="ident" id="3650892">password</span><span class="op" id="3650900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3650903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3650906">return</span>&nbsp;<span class="string" id="3650913">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3650916">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="3650919">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="3650997">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3651015">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="3651083">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="3651101">func</span>&nbsp;<span class="op" id="3651106">(</span><span class="ident" id="3651107">t</span>&nbsp;<span class="op" id="3651109">*</span><span class="ident" id="3651110">Transport</span><span class="op" id="3651119">)</span>&nbsp;<span class="ident" id="3651121">putIdleConn</span><span class="op" id="3651132">(</span><span class="ident" id="3651133">pconn</span>&nbsp;<span class="op" id="3651139">*</span><span class="ident" id="3651140">persistConn</span><span class="op" id="3651151">)</span>&nbsp;<span class="builtintype" id="3651153">bool</span>&nbsp;<span class="op" id="3651158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651161">if</span>&nbsp;<span class="ident" id="3651164">t</span><span class="op" id="3651165">.</span><span class="ident" id="3651166">DisableKeepAlives</span>&nbsp;<span class="op" id="3651184">||</span>&nbsp;<span class="ident" id="3651187">t</span><span class="op" id="3651188">.</span><span class="ident" id="3651189">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3651209">&lt;</span>&nbsp;<span class="num" id="3651211">0</span>&nbsp;<span class="op" id="3651213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651217">pconn</span><span class="op" id="3651222">.</span><span class="builtinfunc" id="3651223">close</span><span class="op" id="3651228">(</span><span class="op" id="3651229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651233">return</span>&nbsp;<span class="builtintype" id="3651240">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3651247">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651250">if</span>&nbsp;<span class="ident" id="3651253">pconn</span><span class="op" id="3651258">.</span><span class="ident" id="3651259">isBroken</span><span class="op" id="3651267">(</span><span class="op" id="3651268">)</span>&nbsp;<span class="op" id="3651270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651274">return</span>&nbsp;<span class="builtintype" id="3651281">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3651288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651291">key</span>&nbsp;<span class="op" id="3651295">:=</span>&nbsp;<span class="ident" id="3651298">pconn</span><span class="op" id="3651303">.</span><span class="ident" id="3651304">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651314">max</span>&nbsp;<span class="op" id="3651318">:=</span>&nbsp;<span class="ident" id="3651321">t</span><span class="op" id="3651322">.</span><span class="ident" id="3651323">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651344">if</span>&nbsp;<span class="ident" id="3651347">max</span>&nbsp;<span class="op" id="3651351">==</span>&nbsp;<span class="num" id="3651354">0</span>&nbsp;<span class="op" id="3651356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651360">max</span>&nbsp;<span class="op" id="3651364">=</span>&nbsp;<span class="ident" id="3651366">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3651394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651397">t</span><span class="op" id="3651398">.</span><span class="ident" id="3651399">idleMu</span><span class="op" id="3651405">.</span><span class="ident" id="3651406">Lock</span><span class="op" id="3651410">(</span><span class="op" id="3651411">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651415">waitingDialer</span>&nbsp;<span class="op" id="3651429">:=</span>&nbsp;<span class="ident" id="3651432">t</span><span class="op" id="3651433">.</span><span class="ident" id="3651434">idleConnCh</span><span class="op" id="3651444">[</span><span class="ident" id="3651445">key</span><span class="op" id="3651448">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651451">select</span>&nbsp;<span class="op" id="3651458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651461">case</span>&nbsp;<span class="ident" id="3651466">waitingDialer</span>&nbsp;<span class="op" id="3651480">&lt;-</span>&nbsp;<span class="ident" id="3651483">pconn</span><span class="op" id="3651488">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3651492">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3651545">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3651601">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3651647">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3651704">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651772">t</span><span class="op" id="3651773">.</span><span class="ident" id="3651774">idleMu</span><span class="op" id="3651780">.</span><span class="ident" id="3651781">Unlock</span><span class="op" id="3651787">(</span><span class="op" id="3651788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651792">return</span>&nbsp;<span class="builtintype" id="3651799">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651805">default</span><span class="op" id="3651812">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651816">if</span>&nbsp;<span class="ident" id="3651819">waitingDialer</span>&nbsp;<span class="op" id="3651833">!=</span>&nbsp;<span class="builtintype" id="3651836">nil</span>&nbsp;<span class="op" id="3651840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3651845">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3651895">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3651943">delete</span><span class="op" id="3651949">(</span><span class="ident" id="3651950">t</span><span class="op" id="3651951">.</span><span class="ident" id="3651952">idleConnCh</span><span class="op" id="3651962">,</span>&nbsp;<span class="ident" id="3651964">key</span><span class="op" id="3651967">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3651971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3651974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3651977">if</span>&nbsp;<span class="ident" id="3651980">t</span><span class="op" id="3651981">.</span><span class="ident" id="3651982">wantIdle</span>&nbsp;<span class="op" id="3651991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3651995">t</span><span class="op" id="3651996">.</span><span class="ident" id="3651997">idleMu</span><span class="op" id="3652003">.</span><span class="ident" id="3652004">Unlock</span><span class="op" id="3652010">(</span><span class="op" id="3652011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652015">pconn</span><span class="op" id="3652020">.</span><span class="builtinfunc" id="3652021">close</span><span class="op" id="3652026">(</span><span class="op" id="3652027">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652031">return</span>&nbsp;<span class="builtintype" id="3652038">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652048">if</span>&nbsp;<span class="ident" id="3652051">t</span><span class="op" id="3652052">.</span><span class="ident" id="3652053">idleConn</span>&nbsp;<span class="op" id="3652062">==</span>&nbsp;<span class="builtintype" id="3652065">nil</span>&nbsp;<span class="op" id="3652069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652073">t</span><span class="op" id="3652074">.</span><span class="ident" id="3652075">idleConn</span>&nbsp;<span class="op" id="3652084">=</span>&nbsp;<span class="builtinfunc" id="3652086">make</span><span class="op" id="3652090">(</span><span class="keyword" id="3652091">map</span><span class="op" id="3652094">[</span><span class="ident" id="3652095">connectMethodKey</span><span class="op" id="3652111">]</span><span class="op" id="3652112">[</span><span class="op" id="3652113">]</span><span class="op" id="3652114">*</span><span class="ident" id="3652115">persistConn</span><span class="op" id="3652126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652129">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652132">if</span>&nbsp;<span class="builtinfunc" id="3652135">len</span><span class="op" id="3652138">(</span><span class="ident" id="3652139">t</span><span class="op" id="3652140">.</span><span class="ident" id="3652141">idleConn</span><span class="op" id="3652149">[</span><span class="ident" id="3652150">key</span><span class="op" id="3652153">]</span><span class="op" id="3652154">)</span>&nbsp;<span class="op" id="3652156">&gt;=</span>&nbsp;<span class="ident" id="3652159">max</span>&nbsp;<span class="op" id="3652163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652167">t</span><span class="op" id="3652168">.</span><span class="ident" id="3652169">idleMu</span><span class="op" id="3652175">.</span><span class="ident" id="3652176">Unlock</span><span class="op" id="3652182">(</span><span class="op" id="3652183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652187">pconn</span><span class="op" id="3652192">.</span><span class="builtinfunc" id="3652193">close</span><span class="op" id="3652198">(</span><span class="op" id="3652199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652203">return</span>&nbsp;<span class="builtintype" id="3652210">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652217">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652220">for</span>&nbsp;<span class="ident" id="3652224">_</span><span class="op" id="3652225">,</span>&nbsp;<span class="ident" id="3652227">exist</span>&nbsp;<span class="op" id="3652233">:=</span>&nbsp;<span class="keyword" id="3652236">range</span>&nbsp;<span class="ident" id="3652242">t</span><span class="op" id="3652243">.</span><span class="ident" id="3652244">idleConn</span><span class="op" id="3652252">[</span><span class="ident" id="3652253">key</span><span class="op" id="3652256">]</span>&nbsp;<span class="op" id="3652258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652262">if</span>&nbsp;<span class="ident" id="3652265">exist</span>&nbsp;<span class="op" id="3652271">==</span>&nbsp;<span class="ident" id="3652274">pconn</span>&nbsp;<span class="op" id="3652280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652285">log</span><span class="op" id="3652288">.</span><span class="ident" id="3652289">Fatalf</span><span class="op" id="3652295">(</span><span class="string" id="3652296">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="3652327">,</span>&nbsp;<span class="ident" id="3652329">pconn</span><span class="op" id="3652334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652341">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652344">t</span><span class="op" id="3652345">.</span><span class="ident" id="3652346">idleConn</span><span class="op" id="3652354">[</span><span class="ident" id="3652355">key</span><span class="op" id="3652358">]</span>&nbsp;<span class="op" id="3652360">=</span>&nbsp;<span class="builtinfunc" id="3652362">append</span><span class="op" id="3652368">(</span><span class="ident" id="3652369">t</span><span class="op" id="3652370">.</span><span class="ident" id="3652371">idleConn</span><span class="op" id="3652379">[</span><span class="ident" id="3652380">key</span><span class="op" id="3652383">]</span><span class="op" id="3652384">,</span>&nbsp;<span class="ident" id="3652386">pconn</span><span class="op" id="3652391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652394">t</span><span class="op" id="3652395">.</span><span class="ident" id="3652396">idleMu</span><span class="op" id="3652402">.</span><span class="ident" id="3652403">Unlock</span><span class="op" id="3652409">(</span><span class="op" id="3652410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652413">return</span>&nbsp;<span class="builtintype" id="3652420">true</span><br>
<span class="lineno"></span><span class="op" id="3652425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3652428">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="3652490">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="3652544">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3652612">func</span>&nbsp;<span class="op" id="3652617">(</span><span class="ident" id="3652618">t</span>&nbsp;<span class="op" id="3652620">*</span><span class="ident" id="3652621">Transport</span><span class="op" id="3652630">)</span>&nbsp;<span class="ident" id="3652632">getIdleConnCh</span><span class="op" id="3652645">(</span><span class="ident" id="3652646">cm</span>&nbsp;<span class="ident" id="3652649">connectMethod</span><span class="op" id="3652662">)</span>&nbsp;<span class="keyword" id="3652664">chan</span>&nbsp;<span class="op" id="3652669">*</span><span class="ident" id="3652670">persistConn</span>&nbsp;<span class="op" id="3652682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652685">if</span>&nbsp;<span class="ident" id="3652688">t</span><span class="op" id="3652689">.</span><span class="ident" id="3652690">DisableKeepAlives</span>&nbsp;<span class="op" id="3652708">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652712">return</span>&nbsp;<span class="builtintype" id="3652719">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652727">key</span>&nbsp;<span class="op" id="3652731">:=</span>&nbsp;<span class="ident" id="3652734">cm</span><span class="op" id="3652736">.</span><span class="ident" id="3652737">key</span><span class="op" id="3652740">(</span><span class="op" id="3652741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652744">t</span><span class="op" id="3652745">.</span><span class="ident" id="3652746">idleMu</span><span class="op" id="3652752">.</span><span class="ident" id="3652753">Lock</span><span class="op" id="3652757">(</span><span class="op" id="3652758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652761">defer</span>&nbsp;<span class="ident" id="3652767">t</span><span class="op" id="3652768">.</span><span class="ident" id="3652769">idleMu</span><span class="op" id="3652775">.</span><span class="ident" id="3652776">Unlock</span><span class="op" id="3652782">(</span><span class="op" id="3652783">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652786">t</span><span class="op" id="3652787">.</span><span class="ident" id="3652788">wantIdle</span>&nbsp;<span class="op" id="3652797">=</span>&nbsp;<span class="builtintype" id="3652799">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652806">if</span>&nbsp;<span class="ident" id="3652809">t</span><span class="op" id="3652810">.</span><span class="ident" id="3652811">idleConnCh</span>&nbsp;<span class="op" id="3652822">==</span>&nbsp;<span class="builtintype" id="3652825">nil</span>&nbsp;<span class="op" id="3652829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652833">t</span><span class="op" id="3652834">.</span><span class="ident" id="3652835">idleConnCh</span>&nbsp;<span class="op" id="3652846">=</span>&nbsp;<span class="builtinfunc" id="3652848">make</span><span class="op" id="3652852">(</span><span class="keyword" id="3652853">map</span><span class="op" id="3652856">[</span><span class="ident" id="3652857">connectMethodKey</span><span class="op" id="3652873">]</span><span class="keyword" id="3652874">chan</span>&nbsp;<span class="op" id="3652879">*</span><span class="ident" id="3652880">persistConn</span><span class="op" id="3652891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652897">ch</span><span class="op" id="3652899">,</span>&nbsp;<span class="ident" id="3652901">ok</span>&nbsp;<span class="op" id="3652904">:=</span>&nbsp;<span class="ident" id="3652907">t</span><span class="op" id="3652908">.</span><span class="ident" id="3652909">idleConnCh</span><span class="op" id="3652919">[</span><span class="ident" id="3652920">key</span><span class="op" id="3652923">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652926">if</span>&nbsp;<span class="op" id="3652929">!</span><span class="ident" id="3652930">ok</span>&nbsp;<span class="op" id="3652933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652937">ch</span>&nbsp;<span class="op" id="3652940">=</span>&nbsp;<span class="builtinfunc" id="3652942">make</span><span class="op" id="3652946">(</span><span class="keyword" id="3652947">chan</span>&nbsp;<span class="op" id="3652952">*</span><span class="ident" id="3652953">persistConn</span><span class="op" id="3652964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3652968">t</span><span class="op" id="3652969">.</span><span class="ident" id="3652970">idleConnCh</span><span class="op" id="3652980">[</span><span class="ident" id="3652981">key</span><span class="op" id="3652984">]</span>&nbsp;<span class="op" id="3652986">=</span>&nbsp;<span class="ident" id="3652988">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3652992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3652995">return</span>&nbsp;<span class="ident" id="3653002">ch</span><br>
<span class="lineno">435</span><span class="op" id="3653005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3653008">func</span>&nbsp;<span class="op" id="3653013">(</span><span class="ident" id="3653014">t</span>&nbsp;<span class="op" id="3653016">*</span><span class="ident" id="3653017">Transport</span><span class="op" id="3653026">)</span>&nbsp;<span class="ident" id="3653028">getIdleConn</span><span class="op" id="3653039">(</span><span class="ident" id="3653040">cm</span>&nbsp;<span class="ident" id="3653043">connectMethod</span><span class="op" id="3653056">)</span>&nbsp;<span class="op" id="3653058">(</span><span class="ident" id="3653059">pconn</span>&nbsp;<span class="op" id="3653065">*</span><span class="ident" id="3653066">persistConn</span><span class="op" id="3653077">)</span>&nbsp;<span class="op" id="3653079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3653082">key</span>&nbsp;<span class="op" id="3653086">:=</span>&nbsp;<span class="ident" id="3653089">cm</span><span class="op" id="3653091">.</span><span class="ident" id="3653092">key</span><span class="op" id="3653095">(</span><span class="op" id="3653096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3653099">t</span><span class="op" id="3653100">.</span><span class="ident" id="3653101">idleMu</span><span class="op" id="3653107">.</span><span class="ident" id="3653108">Lock</span><span class="op" id="3653112">(</span><span class="op" id="3653113">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653116">defer</span>&nbsp;<span class="ident" id="3653122">t</span><span class="op" id="3653123">.</span><span class="ident" id="3653124">idleMu</span><span class="op" id="3653130">.</span><span class="ident" id="3653131">Unlock</span><span class="op" id="3653137">(</span><span class="op" id="3653138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653141">if</span>&nbsp;<span class="ident" id="3653144">t</span><span class="op" id="3653145">.</span><span class="ident" id="3653146">idleConn</span>&nbsp;<span class="op" id="3653155">==</span>&nbsp;<span class="builtintype" id="3653158">nil</span>&nbsp;<span class="op" id="3653162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653166">return</span>&nbsp;<span class="builtintype" id="3653173">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3653178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653181">for</span>&nbsp;<span class="op" id="3653185">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3653189">pconns</span><span class="op" id="3653195">,</span>&nbsp;<span class="ident" id="3653197">ok</span>&nbsp;<span class="op" id="3653200">:=</span>&nbsp;<span class="ident" id="3653203">t</span><span class="op" id="3653204">.</span><span class="ident" id="3653205">idleConn</span><span class="op" id="3653213">[</span><span class="ident" id="3653214">key</span><span class="op" id="3653217">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653221">if</span>&nbsp;<span class="op" id="3653224">!</span><span class="ident" id="3653225">ok</span>&nbsp;<span class="op" id="3653228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653233">return</span>&nbsp;<span class="builtintype" id="3653240">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3653246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653250">if</span>&nbsp;<span class="builtinfunc" id="3653253">len</span><span class="op" id="3653256">(</span><span class="ident" id="3653257">pconns</span><span class="op" id="3653263">)</span>&nbsp;<span class="op" id="3653265">==</span>&nbsp;<span class="num" id="3653268">1</span>&nbsp;<span class="op" id="3653270">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3653275">pconn</span>&nbsp;<span class="op" id="3653281">=</span>&nbsp;<span class="ident" id="3653283">pconns</span><span class="op" id="3653289">[</span><span class="num" id="3653290">0</span><span class="op" id="3653291">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3653296">delete</span><span class="op" id="3653302">(</span><span class="ident" id="3653303">t</span><span class="op" id="3653304">.</span><span class="ident" id="3653305">idleConn</span><span class="op" id="3653313">,</span>&nbsp;<span class="ident" id="3653315">key</span><span class="op" id="3653318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3653322">}</span>&nbsp;<span class="keyword" id="3653324">else</span>&nbsp;<span class="op" id="3653329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3653334">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3653379">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3653398">pconn</span>&nbsp;<span class="op" id="3653404">=</span>&nbsp;<span class="ident" id="3653406">pconns</span><span class="op" id="3653412">[</span><span class="builtinfunc" id="3653413">len</span><span class="op" id="3653416">(</span><span class="ident" id="3653417">pconns</span><span class="op" id="3653423">)</span><span class="op" id="3653424">-</span><span class="num" id="3653425">1</span><span class="op" id="3653426">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3653431">t</span><span class="op" id="3653432">.</span><span class="ident" id="3653433">idleConn</span><span class="op" id="3653441">[</span><span class="ident" id="3653442">key</span><span class="op" id="3653445">]</span>&nbsp;<span class="op" id="3653447">=</span>&nbsp;<span class="ident" id="3653449">pconns</span><span class="op" id="3653455">[</span><span class="op" id="3653456">:</span><span class="builtinfunc" id="3653457">len</span><span class="op" id="3653460">(</span><span class="ident" id="3653461">pconns</span><span class="op" id="3653467">)</span><span class="op" id="3653468">-</span><span class="num" id="3653469">1</span><span class="op" id="3653470">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3653474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653478">if</span>&nbsp;<span class="op" id="3653481">!</span><span class="ident" id="3653482">pconn</span><span class="op" id="3653487">.</span><span class="ident" id="3653488">isBroken</span><span class="op" id="3653496">(</span><span class="op" id="3653497">)</span>&nbsp;<span class="op" id="3653499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653504">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3653513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3653516">}</span><br>
<span class="lineno"></span><span class="op" id="3653518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3653521">func</span>&nbsp;<span class="op" id="3653526">(</span><span class="ident" id="3653527">t</span>&nbsp;<span class="op" id="3653529">*</span><span class="ident" id="3653530">Transport</span><span class="op" id="3653539">)</span>&nbsp;<span class="ident" id="3653541">setReqCanceler</span><span class="op" id="3653555">(</span><span class="ident" id="3653556">r</span>&nbsp;<span class="op" id="3653558">*</span><span class="ident" id="3653559">Request</span><span class="op" id="3653566">,</span>&nbsp;<span class="ident" id="3653568">fn</span>&nbsp;<span class="keyword" id="3653571">func</span><span class="op" id="3653575">(</span><span class="op" id="3653576">)</span><span class="op" id="3653577">)</span>&nbsp;<span class="op" id="3653579">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3653582">t</span><span class="op" id="3653583">.</span><span class="ident" id="3653584">reqMu</span><span class="op" id="3653589">.</span><span class="ident" id="3653590">Lock</span><span class="op" id="3653594">(</span><span class="op" id="3653595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653598">defer</span>&nbsp;<span class="ident" id="3653604">t</span><span class="op" id="3653605">.</span><span class="ident" id="3653606">reqMu</span><span class="op" id="3653611">.</span><span class="ident" id="3653612">Unlock</span><span class="op" id="3653618">(</span><span class="op" id="3653619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653622">if</span>&nbsp;<span class="ident" id="3653625">t</span><span class="op" id="3653626">.</span><span class="ident" id="3653627">reqCanceler</span>&nbsp;<span class="op" id="3653639">==</span>&nbsp;<span class="builtintype" id="3653642">nil</span>&nbsp;<span class="op" id="3653646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3653650">t</span><span class="op" id="3653651">.</span><span class="ident" id="3653652">reqCanceler</span>&nbsp;<span class="op" id="3653664">=</span>&nbsp;<span class="builtinfunc" id="3653666">make</span><span class="op" id="3653670">(</span><span class="keyword" id="3653671">map</span><span class="op" id="3653674">[</span><span class="op" id="3653675">*</span><span class="ident" id="3653676">Request</span><span class="op" id="3653683">]</span><span class="keyword" id="3653684">func</span><span class="op" id="3653688">(</span><span class="op" id="3653689">)</span><span class="op" id="3653690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3653693">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653696">if</span>&nbsp;<span class="ident" id="3653699">fn</span>&nbsp;<span class="op" id="3653702">!=</span>&nbsp;<span class="builtintype" id="3653705">nil</span>&nbsp;<span class="op" id="3653709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3653713">t</span><span class="op" id="3653714">.</span><span class="ident" id="3653715">reqCanceler</span><span class="op" id="3653726">[</span><span class="ident" id="3653727">r</span><span class="op" id="3653728">]</span>&nbsp;<span class="op" id="3653730">=</span>&nbsp;<span class="ident" id="3653732">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3653736">}</span>&nbsp;<span class="keyword" id="3653738">else</span>&nbsp;<span class="op" id="3653743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3653747">delete</span><span class="op" id="3653753">(</span><span class="ident" id="3653754">t</span><span class="op" id="3653755">.</span><span class="ident" id="3653756">reqCanceler</span><span class="op" id="3653767">,</span>&nbsp;<span class="ident" id="3653769">r</span><span class="op" id="3653770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3653773">}</span><br>
<span class="lineno">475</span><span class="op" id="3653775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3653778">func</span>&nbsp;<span class="op" id="3653783">(</span><span class="ident" id="3653784">t</span>&nbsp;<span class="op" id="3653786">*</span><span class="ident" id="3653787">Transport</span><span class="op" id="3653796">)</span>&nbsp;<span class="ident" id="3653798">dial</span><span class="op" id="3653802">(</span><span class="ident" id="3653803">network</span><span class="op" id="3653810">,</span>&nbsp;<span class="ident" id="3653812">addr</span>&nbsp;<span class="builtintype" id="3653817">string</span><span class="op" id="3653823">)</span>&nbsp;<span class="op" id="3653825">(</span><span class="ident" id="3653826">c</span>&nbsp;<span class="ident" id="3653828">net</span><span class="op" id="3653831">.</span><span class="ident" id="3653832">Conn</span><span class="op" id="3653836">,</span>&nbsp;<span class="ident" id="3653838">err</span>&nbsp;<span class="builtintype" id="3653842">error</span><span class="op" id="3653847">)</span>&nbsp;<span class="op" id="3653849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653852">if</span>&nbsp;<span class="ident" id="3653855">t</span><span class="op" id="3653856">.</span><span class="ident" id="3653857">Dial</span>&nbsp;<span class="op" id="3653862">!=</span>&nbsp;<span class="builtintype" id="3653865">nil</span>&nbsp;<span class="op" id="3653869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653873">return</span>&nbsp;<span class="ident" id="3653880">t</span><span class="op" id="3653881">.</span><span class="ident" id="3653882">Dial</span><span class="op" id="3653886">(</span><span class="ident" id="3653887">network</span><span class="op" id="3653894">,</span>&nbsp;<span class="ident" id="3653896">addr</span><span class="op" id="3653900">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3653903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3653906">return</span>&nbsp;<span class="ident" id="3653913">net</span><span class="op" id="3653916">.</span><span class="ident" id="3653917">Dial</span><span class="op" id="3653921">(</span><span class="ident" id="3653922">network</span><span class="op" id="3653929">,</span>&nbsp;<span class="ident" id="3653931">addr</span><span class="op" id="3653935">)</span><br>
<span class="lineno"></span><span class="op" id="3653937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3653940">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="3653958">var</span>&nbsp;<span class="ident" id="3653962">prePendingDial</span><span class="op" id="3653976">,</span>&nbsp;<span class="ident" id="3653978">postPendingDial</span>&nbsp;<span class="keyword" id="3653994">func</span><span class="op" id="3653998">(</span><span class="op" id="3653999">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3654002">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3654066">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="3654138">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="3654214">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="3654248">func</span>&nbsp;<span class="op" id="3654253">(</span><span class="ident" id="3654254">t</span>&nbsp;<span class="op" id="3654256">*</span><span class="ident" id="3654257">Transport</span><span class="op" id="3654266">)</span>&nbsp;<span class="ident" id="3654268">getConn</span><span class="op" id="3654275">(</span><span class="ident" id="3654276">req</span>&nbsp;<span class="op" id="3654280">*</span><span class="ident" id="3654281">Request</span><span class="op" id="3654288">,</span>&nbsp;<span class="ident" id="3654290">cm</span>&nbsp;<span class="ident" id="3654293">connectMethod</span><span class="op" id="3654306">)</span>&nbsp;<span class="op" id="3654308">(</span><span class="op" id="3654309">*</span><span class="ident" id="3654310">persistConn</span><span class="op" id="3654321">,</span>&nbsp;<span class="builtintype" id="3654323">error</span><span class="op" id="3654328">)</span>&nbsp;<span class="op" id="3654330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654333">if</span>&nbsp;<span class="ident" id="3654336">pc</span>&nbsp;<span class="op" id="3654339">:=</span>&nbsp;<span class="ident" id="3654342">t</span><span class="op" id="3654343">.</span><span class="ident" id="3654344">getIdleConn</span><span class="op" id="3654355">(</span><span class="ident" id="3654356">cm</span><span class="op" id="3654358">)</span><span class="op" id="3654359">;</span>&nbsp;<span class="ident" id="3654361">pc</span>&nbsp;<span class="op" id="3654364">!=</span>&nbsp;<span class="builtintype" id="3654367">nil</span>&nbsp;<span class="op" id="3654371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654375">return</span>&nbsp;<span class="ident" id="3654382">pc</span><span class="op" id="3654384">,</span>&nbsp;<span class="builtintype" id="3654386">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3654391">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654395">type</span>&nbsp;<span class="ident" id="3654400">dialRes</span>&nbsp;<span class="keyword" id="3654408">struct</span>&nbsp;<span class="op" id="3654415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654419">pc</span>&nbsp;&nbsp;<span class="op" id="3654423">*</span><span class="ident" id="3654424">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654438">err</span>&nbsp;<span class="builtintype" id="3654442">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3654449">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654452">dialc</span>&nbsp;<span class="op" id="3654458">:=</span>&nbsp;<span class="builtinfunc" id="3654461">make</span><span class="op" id="3654465">(</span><span class="keyword" id="3654466">chan</span>&nbsp;<span class="ident" id="3654471">dialRes</span><span class="op" id="3654478">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654482">handlePendingDial</span>&nbsp;<span class="op" id="3654500">:=</span>&nbsp;<span class="keyword" id="3654503">func</span><span class="op" id="3654507">(</span><span class="op" id="3654508">)</span>&nbsp;<span class="op" id="3654510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654514">if</span>&nbsp;<span class="ident" id="3654517">prePendingDial</span>&nbsp;<span class="op" id="3654532">!=</span>&nbsp;<span class="builtintype" id="3654535">nil</span>&nbsp;<span class="op" id="3654539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654544">prePendingDial</span><span class="op" id="3654558">(</span><span class="op" id="3654559">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3654563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654567">go</span>&nbsp;<span class="keyword" id="3654570">func</span><span class="op" id="3654574">(</span><span class="op" id="3654575">)</span>&nbsp;<span class="op" id="3654577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654582">if</span>&nbsp;<span class="ident" id="3654585">v</span>&nbsp;<span class="op" id="3654587">:=</span>&nbsp;<span class="op" id="3654590">&lt;-</span><span class="ident" id="3654592">dialc</span><span class="op" id="3654597">;</span>&nbsp;<span class="ident" id="3654599">v</span><span class="op" id="3654600">.</span><span class="ident" id="3654601">err</span>&nbsp;<span class="op" id="3654605">==</span>&nbsp;<span class="builtintype" id="3654608">nil</span>&nbsp;<span class="op" id="3654612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654618">t</span><span class="op" id="3654619">.</span><span class="ident" id="3654620">putIdleConn</span><span class="op" id="3654631">(</span><span class="ident" id="3654632">v</span><span class="op" id="3654633">.</span><span class="ident" id="3654634">pc</span><span class="op" id="3654636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3654641">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654646">if</span>&nbsp;<span class="ident" id="3654649">postPendingDial</span>&nbsp;<span class="op" id="3654665">!=</span>&nbsp;<span class="builtintype" id="3654668">nil</span>&nbsp;<span class="op" id="3654672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654678">postPendingDial</span><span class="op" id="3654693">(</span><span class="op" id="3654694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3654699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3654703">}</span><span class="op" id="3654704">(</span><span class="op" id="3654705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3654708">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654712">cancelc</span>&nbsp;<span class="op" id="3654720">:=</span>&nbsp;<span class="builtinfunc" id="3654723">make</span><span class="op" id="3654727">(</span><span class="keyword" id="3654728">chan</span>&nbsp;<span class="keyword" id="3654733">struct</span><span class="op" id="3654739">{</span><span class="op" id="3654740">}</span><span class="op" id="3654741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654744">t</span><span class="op" id="3654745">.</span><span class="ident" id="3654746">setReqCanceler</span><span class="op" id="3654760">(</span><span class="ident" id="3654761">req</span><span class="op" id="3654764">,</span>&nbsp;<span class="keyword" id="3654766">func</span><span class="op" id="3654770">(</span><span class="op" id="3654771">)</span>&nbsp;<span class="op" id="3654773">{</span>&nbsp;<span class="builtinfunc" id="3654775">close</span><span class="op" id="3654780">(</span><span class="ident" id="3654781">cancelc</span><span class="op" id="3654788">)</span>&nbsp;<span class="op" id="3654790">}</span><span class="op" id="3654791">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654795">go</span>&nbsp;<span class="keyword" id="3654798">func</span><span class="op" id="3654802">(</span><span class="op" id="3654803">)</span>&nbsp;<span class="op" id="3654805">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654809">pc</span><span class="op" id="3654811">,</span>&nbsp;<span class="ident" id="3654813">err</span>&nbsp;<span class="op" id="3654817">:=</span>&nbsp;<span class="ident" id="3654820">t</span><span class="op" id="3654821">.</span><span class="ident" id="3654822">dialConn</span><span class="op" id="3654830">(</span><span class="ident" id="3654831">cm</span><span class="op" id="3654833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654837">dialc</span>&nbsp;<span class="op" id="3654843">&lt;-</span>&nbsp;<span class="ident" id="3654846">dialRes</span><span class="op" id="3654853">{</span><span class="ident" id="3654854">pc</span><span class="op" id="3654856">,</span>&nbsp;<span class="ident" id="3654858">err</span><span class="op" id="3654861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3654864">}</span><span class="op" id="3654865">(</span><span class="op" id="3654866">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3654870">idleConnCh</span>&nbsp;<span class="op" id="3654881">:=</span>&nbsp;<span class="ident" id="3654884">t</span><span class="op" id="3654885">.</span><span class="ident" id="3654886">getIdleConnCh</span><span class="op" id="3654899">(</span><span class="ident" id="3654900">cm</span><span class="op" id="3654902">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654905">select</span>&nbsp;<span class="op" id="3654912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654915">case</span>&nbsp;<span class="ident" id="3654920">v</span>&nbsp;<span class="op" id="3654922">:=</span>&nbsp;<span class="op" id="3654925">&lt;-</span><span class="ident" id="3654927">dialc</span><span class="op" id="3654932">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3654936">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654960">return</span>&nbsp;<span class="ident" id="3654967">v</span><span class="op" id="3654968">.</span><span class="ident" id="3654969">pc</span><span class="op" id="3654971">,</span>&nbsp;<span class="ident" id="3654973">v</span><span class="op" id="3654974">.</span><span class="ident" id="3654975">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3654980">case</span>&nbsp;<span class="ident" id="3654985">pc</span>&nbsp;<span class="op" id="3654988">:=</span>&nbsp;<span class="op" id="3654991">&lt;-</span><span class="ident" id="3654993">idleConnCh</span><span class="op" id="3655003">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3655007">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3655060">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3655111">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3655150">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3655200">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655223">handlePendingDial</span><span class="op" id="3655240">(</span><span class="op" id="3655241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3655245">return</span>&nbsp;<span class="ident" id="3655252">pc</span><span class="op" id="3655254">,</span>&nbsp;<span class="builtintype" id="3655256">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3655261">case</span>&nbsp;<span class="op" id="3655266">&lt;-</span><span class="ident" id="3655268">cancelc</span><span class="op" id="3655275">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655279">handlePendingDial</span><span class="op" id="3655296">(</span><span class="op" id="3655297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3655301">return</span>&nbsp;<span class="builtintype" id="3655308">nil</span><span class="op" id="3655311">,</span>&nbsp;<span class="ident" id="3655313">errors</span><span class="op" id="3655319">.</span><span class="ident" id="3655320">New</span><span class="op" id="3655323">(</span><span class="string" id="3655324">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="3655381">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3655384">}</span><br>
<span class="lineno"></span><span class="op" id="3655386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3655389">func</span>&nbsp;<span class="op" id="3655394">(</span><span class="ident" id="3655395">t</span>&nbsp;<span class="op" id="3655397">*</span><span class="ident" id="3655398">Transport</span><span class="op" id="3655407">)</span>&nbsp;<span class="ident" id="3655409">dialConn</span><span class="op" id="3655417">(</span><span class="ident" id="3655418">cm</span>&nbsp;<span class="ident" id="3655421">connectMethod</span><span class="op" id="3655434">)</span>&nbsp;<span class="op" id="3655436">(</span><span class="op" id="3655437">*</span><span class="ident" id="3655438">persistConn</span><span class="op" id="3655449">,</span>&nbsp;<span class="builtintype" id="3655451">error</span><span class="op" id="3655456">)</span>&nbsp;<span class="op" id="3655458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655461">pconn</span>&nbsp;<span class="op" id="3655467">:=</span>&nbsp;<span class="op" id="3655470">&amp;</span><span class="ident" id="3655471">persistConn</span><span class="op" id="3655482">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655486">t</span><span class="op" id="3655487">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655498">t</span><span class="op" id="3655499">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655503">cacheKey</span><span class="op" id="3655511">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3655515">cm</span><span class="op" id="3655517">.</span><span class="ident" id="3655518">key</span><span class="op" id="3655521">(</span><span class="op" id="3655522">)</span><span class="op" id="3655523">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655527">reqch</span><span class="op" id="3655532">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3655539">make</span><span class="op" id="3655543">(</span><span class="keyword" id="3655544">chan</span>&nbsp;<span class="ident" id="3655549">requestAndChan</span><span class="op" id="3655563">,</span>&nbsp;<span class="num" id="3655565">1</span><span class="op" id="3655566">)</span><span class="op" id="3655567">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655571">writech</span><span class="op" id="3655578">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3655583">make</span><span class="op" id="3655587">(</span><span class="keyword" id="3655588">chan</span>&nbsp;<span class="ident" id="3655593">writeRequest</span><span class="op" id="3655605">,</span>&nbsp;<span class="num" id="3655607">1</span><span class="op" id="3655608">)</span><span class="op" id="3655609">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655613">closech</span><span class="op" id="3655620">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3655625">make</span><span class="op" id="3655629">(</span><span class="keyword" id="3655630">chan</span>&nbsp;<span class="keyword" id="3655635">struct</span><span class="op" id="3655641">{</span><span class="op" id="3655642">}</span><span class="op" id="3655643">)</span><span class="op" id="3655644">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655648">writeErrCh</span><span class="op" id="3655658">:</span>&nbsp;<span class="builtinfunc" id="3655660">make</span><span class="op" id="3655664">(</span><span class="keyword" id="3655665">chan</span>&nbsp;<span class="builtintype" id="3655670">error</span><span class="op" id="3655675">,</span>&nbsp;<span class="num" id="3655677">1</span><span class="op" id="3655678">)</span><span class="op" id="3655679">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3655682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655685">tlsDial</span>&nbsp;<span class="op" id="3655693">:=</span>&nbsp;<span class="ident" id="3655696">t</span><span class="op" id="3655697">.</span><span class="ident" id="3655698">DialTLS</span>&nbsp;<span class="op" id="3655706">!=</span>&nbsp;<span class="builtintype" id="3655709">nil</span>&nbsp;<span class="op" id="3655713">&amp;&amp;</span>&nbsp;<span class="ident" id="3655716">cm</span><span class="op" id="3655718">.</span><span class="ident" id="3655719">targetScheme</span>&nbsp;<span class="op" id="3655732">==</span>&nbsp;<span class="string" id="3655735">&#34;https&#34;</span>&nbsp;<span class="op" id="3655743">&amp;&amp;</span>&nbsp;<span class="ident" id="3655746">cm</span><span class="op" id="3655748">.</span><span class="ident" id="3655749">proxyURL</span>&nbsp;<span class="op" id="3655758">==</span>&nbsp;<span class="builtintype" id="3655761">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3655766">if</span>&nbsp;<span class="ident" id="3655769">tlsDial</span>&nbsp;<span class="op" id="3655777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3655781">var</span>&nbsp;<span class="ident" id="3655785">err</span>&nbsp;<span class="builtintype" id="3655789">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655797">pconn</span><span class="op" id="3655802">.</span><span class="ident" id="3655803">conn</span><span class="op" id="3655807">,</span>&nbsp;<span class="ident" id="3655809">err</span>&nbsp;<span class="op" id="3655813">=</span>&nbsp;<span class="ident" id="3655815">t</span><span class="op" id="3655816">.</span><span class="ident" id="3655817">DialTLS</span><span class="op" id="3655824">(</span><span class="string" id="3655825">&#34;tcp&#34;</span><span class="op" id="3655830">,</span>&nbsp;<span class="ident" id="3655832">cm</span><span class="op" id="3655834">.</span><span class="ident" id="3655835">addr</span><span class="op" id="3655839">(</span><span class="op" id="3655840">)</span><span class="op" id="3655841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3655845">if</span>&nbsp;<span class="ident" id="3655848">err</span>&nbsp;<span class="op" id="3655852">!=</span>&nbsp;<span class="builtintype" id="3655855">nil</span>&nbsp;<span class="op" id="3655859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3655864">return</span>&nbsp;<span class="builtintype" id="3655871">nil</span><span class="op" id="3655874">,</span>&nbsp;<span class="ident" id="3655876">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3655882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3655886">if</span>&nbsp;<span class="ident" id="3655889">tc</span><span class="op" id="3655891">,</span>&nbsp;<span class="ident" id="3655893">ok</span>&nbsp;<span class="op" id="3655896">:=</span>&nbsp;<span class="ident" id="3655899">pconn</span><span class="op" id="3655904">.</span><span class="ident" id="3655905">conn</span><span class="op" id="3655909">.</span><span class="op" id="3655910">(</span><span class="op" id="3655911">*</span><span class="ident" id="3655912">tls</span><span class="op" id="3655915">.</span><span class="ident" id="3655916">Conn</span><span class="op" id="3655920">)</span><span class="op" id="3655921">;</span>&nbsp;<span class="ident" id="3655923">ok</span>&nbsp;<span class="op" id="3655926">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655931">cs</span>&nbsp;<span class="op" id="3655934">:=</span>&nbsp;<span class="ident" id="3655937">tc</span><span class="op" id="3655939">.</span><span class="ident" id="3655940">ConnectionState</span><span class="op" id="3655955">(</span><span class="op" id="3655956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655961">pconn</span><span class="op" id="3655966">.</span><span class="ident" id="3655967">tlsState</span>&nbsp;<span class="op" id="3655976">=</span>&nbsp;<span class="op" id="3655978">&amp;</span><span class="ident" id="3655979">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3655984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3655987">}</span>&nbsp;<span class="keyword" id="3655989">else</span>&nbsp;<span class="op" id="3655994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3655998">conn</span><span class="op" id="3656002">,</span>&nbsp;<span class="ident" id="3656004">err</span>&nbsp;<span class="op" id="3656008">:=</span>&nbsp;<span class="ident" id="3656011">t</span><span class="op" id="3656012">.</span><span class="ident" id="3656013">dial</span><span class="op" id="3656017">(</span><span class="string" id="3656018">&#34;tcp&#34;</span><span class="op" id="3656023">,</span>&nbsp;<span class="ident" id="3656025">cm</span><span class="op" id="3656027">.</span><span class="ident" id="3656028">addr</span><span class="op" id="3656032">(</span><span class="op" id="3656033">)</span><span class="op" id="3656034">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3656038">if</span>&nbsp;<span class="ident" id="3656041">err</span>&nbsp;<span class="op" id="3656045">!=</span>&nbsp;<span class="builtintype" id="3656048">nil</span>&nbsp;<span class="op" id="3656052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3656057">if</span>&nbsp;<span class="ident" id="3656060">cm</span><span class="op" id="3656062">.</span><span class="ident" id="3656063">proxyURL</span>&nbsp;<span class="op" id="3656072">!=</span>&nbsp;<span class="builtintype" id="3656075">nil</span>&nbsp;<span class="op" id="3656079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656085">err</span>&nbsp;<span class="op" id="3656089">=</span>&nbsp;<span class="ident" id="3656091">fmt</span><span class="op" id="3656094">.</span><span class="ident" id="3656095">Errorf</span><span class="op" id="3656101">(</span><span class="string" id="3656102">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3656142">,</span>&nbsp;<span class="ident" id="3656144">cm</span><span class="op" id="3656146">.</span><span class="ident" id="3656147">proxyURL</span><span class="op" id="3656155">,</span>&nbsp;<span class="ident" id="3656157">err</span><span class="op" id="3656160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3656165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3656170">return</span>&nbsp;<span class="builtintype" id="3656177">nil</span><span class="op" id="3656180">,</span>&nbsp;<span class="ident" id="3656182">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3656188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656192">pconn</span><span class="op" id="3656197">.</span><span class="ident" id="3656198">conn</span>&nbsp;<span class="op" id="3656203">=</span>&nbsp;<span class="ident" id="3656205">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3656211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3656215">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3656232">switch</span>&nbsp;<span class="op" id="3656239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3656242">case</span>&nbsp;<span class="ident" id="3656247">cm</span><span class="op" id="3656249">.</span><span class="ident" id="3656250">proxyURL</span>&nbsp;<span class="op" id="3656259">==</span>&nbsp;<span class="builtintype" id="3656262">nil</span><span class="op" id="3656265">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3656269">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3656304">case</span>&nbsp;<span class="ident" id="3656309">cm</span><span class="op" id="3656311">.</span><span class="ident" id="3656312">targetScheme</span>&nbsp;<span class="op" id="3656325">==</span>&nbsp;<span class="string" id="3656328">&#34;http&#34;</span><span class="op" id="3656334">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656338">pconn</span><span class="op" id="3656343">.</span><span class="ident" id="3656344">isProxy</span>&nbsp;<span class="op" id="3656352">=</span>&nbsp;<span class="builtintype" id="3656354">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3656361">if</span>&nbsp;<span class="ident" id="3656364">pa</span>&nbsp;<span class="op" id="3656367">:=</span>&nbsp;<span class="ident" id="3656370">cm</span><span class="op" id="3656372">.</span><span class="ident" id="3656373">proxyAuth</span><span class="op" id="3656382">(</span><span class="op" id="3656383">)</span><span class="op" id="3656384">;</span>&nbsp;<span class="ident" id="3656386">pa</span>&nbsp;<span class="op" id="3656389">!=</span>&nbsp;<span class="string" id="3656392">&#34;&#34;</span>&nbsp;<span class="op" id="3656395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656400">pconn</span><span class="op" id="3656405">.</span><span class="ident" id="3656406">mutateHeaderFunc</span>&nbsp;<span class="op" id="3656423">=</span>&nbsp;<span class="keyword" id="3656425">func</span><span class="op" id="3656429">(</span><span class="ident" id="3656430">h</span>&nbsp;<span class="ident" id="3656432">Header</span><span class="op" id="3656438">)</span>&nbsp;<span class="op" id="3656440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656446">h</span><span class="op" id="3656447">.</span><span class="ident" id="3656448">Set</span><span class="op" id="3656451">(</span><span class="string" id="3656452">&#34;Proxy-Authorization&#34;</span><span class="op" id="3656473">,</span>&nbsp;<span class="ident" id="3656475">pa</span><span class="op" id="3656477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3656482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3656486">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3656489">case</span>&nbsp;<span class="ident" id="3656494">cm</span><span class="op" id="3656496">.</span><span class="ident" id="3656497">targetScheme</span>&nbsp;<span class="op" id="3656510">==</span>&nbsp;<span class="string" id="3656513">&#34;https&#34;</span><span class="op" id="3656520">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656524">conn</span>&nbsp;<span class="op" id="3656529">:=</span>&nbsp;<span class="ident" id="3656532">pconn</span><span class="op" id="3656537">.</span><span class="ident" id="3656538">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656545">connectReq</span>&nbsp;<span class="op" id="3656556">:=</span>&nbsp;<span class="op" id="3656559">&amp;</span><span class="ident" id="3656560">Request</span><span class="op" id="3656567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656572">Method</span><span class="op" id="3656578">:</span>&nbsp;<span class="string" id="3656580">&#34;CONNECT&#34;</span><span class="op" id="3656589">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656594">URL</span><span class="op" id="3656597">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3656602">&amp;</span><span class="ident" id="3656603">url</span><span class="op" id="3656606">.</span><span class="ident" id="3656607">URL</span><span class="op" id="3656610">{</span><span class="ident" id="3656611">Opaque</span><span class="op" id="3656617">:</span>&nbsp;<span class="ident" id="3656619">cm</span><span class="op" id="3656621">.</span><span class="ident" id="3656622">targetAddr</span><span class="op" id="3656632">}</span><span class="op" id="3656633">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656638">Host</span><span class="op" id="3656642">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3656646">cm</span><span class="op" id="3656648">.</span><span class="ident" id="3656649">targetAddr</span><span class="op" id="3656659">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656664">Header</span><span class="op" id="3656670">:</span>&nbsp;<span class="builtinfunc" id="3656672">make</span><span class="op" id="3656676">(</span><span class="ident" id="3656677">Header</span><span class="op" id="3656683">)</span><span class="op" id="3656684">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3656688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3656692">if</span>&nbsp;<span class="ident" id="3656695">pa</span>&nbsp;<span class="op" id="3656698">:=</span>&nbsp;<span class="ident" id="3656701">cm</span><span class="op" id="3656703">.</span><span class="ident" id="3656704">proxyAuth</span><span class="op" id="3656713">(</span><span class="op" id="3656714">)</span><span class="op" id="3656715">;</span>&nbsp;<span class="ident" id="3656717">pa</span>&nbsp;<span class="op" id="3656720">!=</span>&nbsp;<span class="string" id="3656723">&#34;&#34;</span>&nbsp;<span class="op" id="3656726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656731">connectReq</span><span class="op" id="3656741">.</span><span class="ident" id="3656742">Header</span><span class="op" id="3656748">.</span><span class="ident" id="3656749">Set</span><span class="op" id="3656752">(</span><span class="string" id="3656753">&#34;Proxy-Authorization&#34;</span><span class="op" id="3656774">,</span>&nbsp;<span class="ident" id="3656776">pa</span><span class="op" id="3656778">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3656782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656786">connectReq</span><span class="op" id="3656796">.</span><span class="ident" id="3656797">Write</span><span class="op" id="3656802">(</span><span class="ident" id="3656803">conn</span><span class="op" id="3656807">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3656812">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3656832">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3656891">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656939">br</span>&nbsp;<span class="op" id="3656942">:=</span>&nbsp;<span class="ident" id="3656945">bufio</span><span class="op" id="3656950">.</span><span class="ident" id="3656951">NewReader</span><span class="op" id="3656960">(</span><span class="ident" id="3656961">conn</span><span class="op" id="3656965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3656969">resp</span><span class="op" id="3656973">,</span>&nbsp;<span class="ident" id="3656975">err</span>&nbsp;<span class="op" id="3656979">:=</span>&nbsp;<span class="ident" id="3656982">ReadResponse</span><span class="op" id="3656994">(</span><span class="ident" id="3656995">br</span><span class="op" id="3656997">,</span>&nbsp;<span class="ident" id="3656999">connectReq</span><span class="op" id="3657009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657013">if</span>&nbsp;<span class="ident" id="3657016">err</span>&nbsp;<span class="op" id="3657020">!=</span>&nbsp;<span class="builtintype" id="3657023">nil</span>&nbsp;<span class="op" id="3657027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657032">conn</span><span class="op" id="3657036">.</span><span class="ident" id="3657037">Close</span><span class="op" id="3657042">(</span><span class="op" id="3657043">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657048">return</span>&nbsp;<span class="builtintype" id="3657055">nil</span><span class="op" id="3657058">,</span>&nbsp;<span class="ident" id="3657060">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3657066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657070">if</span>&nbsp;<span class="ident" id="3657073">resp</span><span class="op" id="3657077">.</span><span class="ident" id="3657078">StatusCode</span>&nbsp;<span class="op" id="3657089">!=</span>&nbsp;<span class="num" id="3657092">200</span>&nbsp;<span class="op" id="3657096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657101">f</span>&nbsp;<span class="op" id="3657103">:=</span>&nbsp;<span class="ident" id="3657106">strings</span><span class="op" id="3657113">.</span><span class="ident" id="3657114">SplitN</span><span class="op" id="3657120">(</span><span class="ident" id="3657121">resp</span><span class="op" id="3657125">.</span><span class="ident" id="3657126">Status</span><span class="op" id="3657132">,</span>&nbsp;<span class="string" id="3657134">&#34;&nbsp;&#34;</span><span class="op" id="3657137">,</span>&nbsp;<span class="num" id="3657139">2</span><span class="op" id="3657140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657145">conn</span><span class="op" id="3657149">.</span><span class="ident" id="3657150">Close</span><span class="op" id="3657155">(</span><span class="op" id="3657156">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657161">return</span>&nbsp;<span class="builtintype" id="3657168">nil</span><span class="op" id="3657171">,</span>&nbsp;<span class="ident" id="3657173">errors</span><span class="op" id="3657179">.</span><span class="ident" id="3657180">New</span><span class="op" id="3657183">(</span><span class="ident" id="3657184">f</span><span class="op" id="3657185">[</span><span class="num" id="3657186">1</span><span class="op" id="3657187">]</span><span class="op" id="3657188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3657192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3657195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657199">if</span>&nbsp;<span class="ident" id="3657202">cm</span><span class="op" id="3657204">.</span><span class="ident" id="3657205">targetScheme</span>&nbsp;<span class="op" id="3657218">==</span>&nbsp;<span class="string" id="3657221">&#34;https&#34;</span>&nbsp;<span class="op" id="3657229">&amp;&amp;</span>&nbsp;<span class="op" id="3657232">!</span><span class="ident" id="3657233">tlsDial</span>&nbsp;<span class="op" id="3657241">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3657245">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657311">cfg</span>&nbsp;<span class="op" id="3657315">:=</span>&nbsp;<span class="ident" id="3657318">t</span><span class="op" id="3657319">.</span><span class="ident" id="3657320">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657338">if</span>&nbsp;<span class="ident" id="3657341">cfg</span>&nbsp;<span class="op" id="3657345">==</span>&nbsp;<span class="builtintype" id="3657348">nil</span>&nbsp;<span class="op" id="3657352">||</span>&nbsp;<span class="ident" id="3657355">cfg</span><span class="op" id="3657358">.</span><span class="ident" id="3657359">ServerName</span>&nbsp;<span class="op" id="3657370">==</span>&nbsp;<span class="string" id="3657373">&#34;&#34;</span>&nbsp;<span class="op" id="3657376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657381">host</span>&nbsp;<span class="op" id="3657386">:=</span>&nbsp;<span class="ident" id="3657389">cm</span><span class="op" id="3657391">.</span><span class="ident" id="3657392">tlsHost</span><span class="op" id="3657399">(</span><span class="op" id="3657400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657405">if</span>&nbsp;<span class="ident" id="3657408">cfg</span>&nbsp;<span class="op" id="3657412">==</span>&nbsp;<span class="builtintype" id="3657415">nil</span>&nbsp;<span class="op" id="3657419">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657425">cfg</span>&nbsp;<span class="op" id="3657429">=</span>&nbsp;<span class="op" id="3657431">&amp;</span><span class="ident" id="3657432">tls</span><span class="op" id="3657435">.</span><span class="ident" id="3657436">Config</span><span class="op" id="3657442">{</span><span class="ident" id="3657443">ServerName</span><span class="op" id="3657453">:</span>&nbsp;<span class="ident" id="3657455">host</span><span class="op" id="3657459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3657464">}</span>&nbsp;<span class="keyword" id="3657466">else</span>&nbsp;<span class="op" id="3657471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657477">clone</span>&nbsp;<span class="op" id="3657483">:=</span>&nbsp;<span class="op" id="3657486">*</span><span class="ident" id="3657487">cfg</span>&nbsp;<span class="comment" id="3657491">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657512">clone</span><span class="op" id="3657517">.</span><span class="ident" id="3657518">ServerName</span>&nbsp;<span class="op" id="3657529">=</span>&nbsp;<span class="ident" id="3657531">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657540">cfg</span>&nbsp;<span class="op" id="3657544">=</span>&nbsp;<span class="op" id="3657546">&amp;</span><span class="ident" id="3657547">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3657556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3657560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657564">plainConn</span>&nbsp;<span class="op" id="3657574">:=</span>&nbsp;<span class="ident" id="3657577">pconn</span><span class="op" id="3657582">.</span><span class="ident" id="3657583">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657590">tlsConn</span>&nbsp;<span class="op" id="3657598">:=</span>&nbsp;<span class="ident" id="3657601">tls</span><span class="op" id="3657604">.</span><span class="ident" id="3657605">Client</span><span class="op" id="3657611">(</span><span class="ident" id="3657612">plainConn</span><span class="op" id="3657621">,</span>&nbsp;<span class="ident" id="3657623">cfg</span><span class="op" id="3657626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657630">errc</span>&nbsp;<span class="op" id="3657635">:=</span>&nbsp;<span class="builtinfunc" id="3657638">make</span><span class="op" id="3657642">(</span><span class="keyword" id="3657643">chan</span>&nbsp;<span class="builtintype" id="3657648">error</span><span class="op" id="3657653">,</span>&nbsp;<span class="num" id="3657655">2</span><span class="op" id="3657656">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657660">var</span>&nbsp;<span class="ident" id="3657664">timer</span>&nbsp;<span class="op" id="3657670">*</span><span class="ident" id="3657671">time</span><span class="op" id="3657675">.</span><span class="ident" id="3657676">Timer</span>&nbsp;<span class="comment" id="3657682">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657715">if</span>&nbsp;<span class="ident" id="3657718">d</span>&nbsp;<span class="op" id="3657720">:=</span>&nbsp;<span class="ident" id="3657723">t</span><span class="op" id="3657724">.</span><span class="ident" id="3657725">TLSHandshakeTimeout</span><span class="op" id="3657744">;</span>&nbsp;<span class="ident" id="3657746">d</span>&nbsp;<span class="op" id="3657748">!=</span>&nbsp;<span class="num" id="3657751">0</span>&nbsp;<span class="op" id="3657753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657758">timer</span>&nbsp;<span class="op" id="3657764">=</span>&nbsp;<span class="ident" id="3657766">time</span><span class="op" id="3657770">.</span><span class="ident" id="3657771">AfterFunc</span><span class="op" id="3657780">(</span><span class="ident" id="3657781">d</span><span class="op" id="3657782">,</span>&nbsp;<span class="keyword" id="3657784">func</span><span class="op" id="3657788">(</span><span class="op" id="3657789">)</span>&nbsp;<span class="op" id="3657791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657797">errc</span>&nbsp;<span class="op" id="3657802">&lt;-</span>&nbsp;<span class="ident" id="3657805">tlsHandshakeTimeoutError</span><span class="op" id="3657829">{</span><span class="op" id="3657830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3657835">}</span><span class="op" id="3657836">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3657840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657844">go</span>&nbsp;<span class="keyword" id="3657847">func</span><span class="op" id="3657851">(</span><span class="op" id="3657852">)</span>&nbsp;<span class="op" id="3657854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657859">err</span>&nbsp;<span class="op" id="3657863">:=</span>&nbsp;<span class="ident" id="3657866">tlsConn</span><span class="op" id="3657873">.</span><span class="ident" id="3657874">Handshake</span><span class="op" id="3657883">(</span><span class="op" id="3657884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657889">if</span>&nbsp;<span class="ident" id="3657892">timer</span>&nbsp;<span class="op" id="3657898">!=</span>&nbsp;<span class="builtintype" id="3657901">nil</span>&nbsp;<span class="op" id="3657905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657911">timer</span><span class="op" id="3657916">.</span><span class="ident" id="3657917">Stop</span><span class="op" id="3657921">(</span><span class="op" id="3657922">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3657927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657932">errc</span>&nbsp;<span class="op" id="3657937">&lt;-</span>&nbsp;<span class="ident" id="3657940">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3657946">}</span><span class="op" id="3657947">(</span><span class="op" id="3657948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3657952">if</span>&nbsp;<span class="ident" id="3657955">err</span>&nbsp;<span class="op" id="3657959">:=</span>&nbsp;<span class="op" id="3657962">&lt;-</span><span class="ident" id="3657964">errc</span><span class="op" id="3657968">;</span>&nbsp;<span class="ident" id="3657970">err</span>&nbsp;<span class="op" id="3657974">!=</span>&nbsp;<span class="builtintype" id="3657977">nil</span>&nbsp;<span class="op" id="3657981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3657986">plainConn</span><span class="op" id="3657995">.</span><span class="ident" id="3657996">Close</span><span class="op" id="3658001">(</span><span class="op" id="3658002">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658007">return</span>&nbsp;<span class="builtintype" id="3658014">nil</span><span class="op" id="3658017">,</span>&nbsp;<span class="ident" id="3658019">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3658025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658029">if</span>&nbsp;<span class="op" id="3658032">!</span><span class="ident" id="3658033">cfg</span><span class="op" id="3658036">.</span><span class="ident" id="3658037">InsecureSkipVerify</span>&nbsp;<span class="op" id="3658056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658061">if</span>&nbsp;<span class="ident" id="3658064">err</span>&nbsp;<span class="op" id="3658068">:=</span>&nbsp;<span class="ident" id="3658071">tlsConn</span><span class="op" id="3658078">.</span><span class="ident" id="3658079">VerifyHostname</span><span class="op" id="3658093">(</span><span class="ident" id="3658094">cfg</span><span class="op" id="3658097">.</span><span class="ident" id="3658098">ServerName</span><span class="op" id="3658108">)</span><span class="op" id="3658109">;</span>&nbsp;<span class="ident" id="3658111">err</span>&nbsp;<span class="op" id="3658115">!=</span>&nbsp;<span class="builtintype" id="3658118">nil</span>&nbsp;<span class="op" id="3658122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3658128">plainConn</span><span class="op" id="3658137">.</span><span class="ident" id="3658138">Close</span><span class="op" id="3658143">(</span><span class="op" id="3658144">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658150">return</span>&nbsp;<span class="builtintype" id="3658157">nil</span><span class="op" id="3658160">,</span>&nbsp;<span class="ident" id="3658162">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3658169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3658173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3658177">cs</span>&nbsp;<span class="op" id="3658180">:=</span>&nbsp;<span class="ident" id="3658183">tlsConn</span><span class="op" id="3658190">.</span><span class="ident" id="3658191">ConnectionState</span><span class="op" id="3658206">(</span><span class="op" id="3658207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3658211">pconn</span><span class="op" id="3658216">.</span><span class="ident" id="3658217">tlsState</span>&nbsp;<span class="op" id="3658226">=</span>&nbsp;<span class="op" id="3658228">&amp;</span><span class="ident" id="3658229">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3658234">pconn</span><span class="op" id="3658239">.</span><span class="ident" id="3658240">conn</span>&nbsp;<span class="op" id="3658245">=</span>&nbsp;<span class="ident" id="3658247">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3658256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3658260">pconn</span><span class="op" id="3658265">.</span><span class="ident" id="3658266">br</span>&nbsp;<span class="op" id="3658269">=</span>&nbsp;<span class="ident" id="3658271">bufio</span><span class="op" id="3658276">.</span><span class="ident" id="3658277">NewReader</span><span class="op" id="3658286">(</span><span class="ident" id="3658287">noteEOFReader</span><span class="op" id="3658300">{</span><span class="ident" id="3658301">pconn</span><span class="op" id="3658306">.</span><span class="ident" id="3658307">conn</span><span class="op" id="3658311">,</span>&nbsp;<span class="op" id="3658313">&amp;</span><span class="ident" id="3658314">pconn</span><span class="op" id="3658319">.</span><span class="ident" id="3658320">sawEOF</span><span class="op" id="3658326">}</span><span class="op" id="3658327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3658330">pconn</span><span class="op" id="3658335">.</span><span class="ident" id="3658336">bw</span>&nbsp;<span class="op" id="3658339">=</span>&nbsp;<span class="ident" id="3658341">bufio</span><span class="op" id="3658346">.</span><span class="ident" id="3658347">NewWriter</span><span class="op" id="3658356">(</span><span class="ident" id="3658357">pconn</span><span class="op" id="3658362">.</span><span class="ident" id="3658363">conn</span><span class="op" id="3658367">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658370">go</span>&nbsp;<span class="ident" id="3658373">pconn</span><span class="op" id="3658378">.</span><span class="ident" id="3658379">readLoop</span><span class="op" id="3658387">(</span><span class="op" id="3658388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658391">go</span>&nbsp;<span class="ident" id="3658394">pconn</span><span class="op" id="3658399">.</span><span class="ident" id="3658400">writeLoop</span><span class="op" id="3658409">(</span><span class="op" id="3658410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658413">return</span>&nbsp;<span class="ident" id="3658420">pconn</span><span class="op" id="3658425">,</span>&nbsp;<span class="builtintype" id="3658427">nil</span><br>
<span class="lineno"></span><span class="op" id="3658431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="3658434">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3658499">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="3658562">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="3658618">func</span>&nbsp;<span class="ident" id="3658623">useProxy</span><span class="op" id="3658631">(</span><span class="ident" id="3658632">addr</span>&nbsp;<span class="builtintype" id="3658637">string</span><span class="op" id="3658643">)</span>&nbsp;<span class="builtintype" id="3658645">bool</span>&nbsp;<span class="op" id="3658650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658653">if</span>&nbsp;<span class="builtinfunc" id="3658656">len</span><span class="op" id="3658659">(</span><span class="ident" id="3658660">addr</span><span class="op" id="3658664">)</span>&nbsp;<span class="op" id="3658666">==</span>&nbsp;<span class="num" id="3658669">0</span>&nbsp;<span class="op" id="3658671">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658675">return</span>&nbsp;<span class="builtintype" id="3658682">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3658688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3658691">host</span><span class="op" id="3658695">,</span>&nbsp;<span class="ident" id="3658697">_</span><span class="op" id="3658698">,</span>&nbsp;<span class="ident" id="3658700">err</span>&nbsp;<span class="op" id="3658704">:=</span>&nbsp;<span class="ident" id="3658707">net</span><span class="op" id="3658710">.</span><span class="ident" id="3658711">SplitHostPort</span><span class="op" id="3658724">(</span><span class="ident" id="3658725">addr</span><span class="op" id="3658729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658732">if</span>&nbsp;<span class="ident" id="3658735">err</span>&nbsp;<span class="op" id="3658739">!=</span>&nbsp;<span class="builtintype" id="3658742">nil</span>&nbsp;<span class="op" id="3658746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658750">return</span>&nbsp;<span class="builtintype" id="3658757">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3658764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658767">if</span>&nbsp;<span class="ident" id="3658770">host</span>&nbsp;<span class="op" id="3658775">==</span>&nbsp;<span class="string" id="3658778">&#34;localhost&#34;</span>&nbsp;<span class="op" id="3658790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658794">return</span>&nbsp;<span class="builtintype" id="3658801">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3658808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658811">if</span>&nbsp;<span class="ident" id="3658814">ip</span>&nbsp;<span class="op" id="3658817">:=</span>&nbsp;<span class="ident" id="3658820">net</span><span class="op" id="3658823">.</span><span class="ident" id="3658824">ParseIP</span><span class="op" id="3658831">(</span><span class="ident" id="3658832">host</span><span class="op" id="3658836">)</span><span class="op" id="3658837">;</span>&nbsp;<span class="ident" id="3658839">ip</span>&nbsp;<span class="op" id="3658842">!=</span>&nbsp;<span class="builtintype" id="3658845">nil</span>&nbsp;<span class="op" id="3658849">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658853">if</span>&nbsp;<span class="ident" id="3658856">ip</span><span class="op" id="3658858">.</span><span class="ident" id="3658859">IsLoopback</span><span class="op" id="3658869">(</span><span class="op" id="3658870">)</span>&nbsp;<span class="op" id="3658872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658877">return</span>&nbsp;<span class="builtintype" id="3658884">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3658892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3658895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3658899">no_proxy</span>&nbsp;<span class="op" id="3658908">:=</span>&nbsp;<span class="ident" id="3658911">noProxyEnv</span><span class="op" id="3658921">.</span><span class="ident" id="3658922">Get</span><span class="op" id="3658925">(</span><span class="op" id="3658926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658929">if</span>&nbsp;<span class="ident" id="3658932">no_proxy</span>&nbsp;<span class="op" id="3658941">==</span>&nbsp;<span class="string" id="3658944">&#34;*&#34;</span>&nbsp;<span class="op" id="3658948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3658952">return</span>&nbsp;<span class="builtintype" id="3658959">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3658966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3658970">addr</span>&nbsp;<span class="op" id="3658975">=</span>&nbsp;<span class="ident" id="3658977">strings</span><span class="op" id="3658984">.</span><span class="ident" id="3658985">ToLower</span><span class="op" id="3658992">(</span><span class="ident" id="3658993">strings</span><span class="op" id="3659000">.</span><span class="ident" id="3659001">TrimSpace</span><span class="op" id="3659010">(</span><span class="ident" id="3659011">addr</span><span class="op" id="3659015">)</span><span class="op" id="3659016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659019">if</span>&nbsp;<span class="ident" id="3659022">hasPort</span><span class="op" id="3659029">(</span><span class="ident" id="3659030">addr</span><span class="op" id="3659034">)</span>&nbsp;<span class="op" id="3659036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3659040">addr</span>&nbsp;<span class="op" id="3659045">=</span>&nbsp;<span class="ident" id="3659047">addr</span><span class="op" id="3659051">[</span><span class="op" id="3659052">:</span><span class="ident" id="3659053">strings</span><span class="op" id="3659060">.</span><span class="ident" id="3659061">LastIndex</span><span class="op" id="3659070">(</span><span class="ident" id="3659071">addr</span><span class="op" id="3659075">,</span>&nbsp;<span class="string" id="3659077">&#34;:&#34;</span><span class="op" id="3659080">)</span><span class="op" id="3659081">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3659084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659088">for</span>&nbsp;<span class="ident" id="3659092">_</span><span class="op" id="3659093">,</span>&nbsp;<span class="ident" id="3659095">p</span>&nbsp;<span class="op" id="3659097">:=</span>&nbsp;<span class="keyword" id="3659100">range</span>&nbsp;<span class="ident" id="3659106">strings</span><span class="op" id="3659113">.</span><span class="ident" id="3659114">Split</span><span class="op" id="3659119">(</span><span class="ident" id="3659120">no_proxy</span><span class="op" id="3659128">,</span>&nbsp;<span class="string" id="3659130">&#34;,&#34;</span><span class="op" id="3659133">)</span>&nbsp;<span class="op" id="3659135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3659139">p</span>&nbsp;<span class="op" id="3659141">=</span>&nbsp;<span class="ident" id="3659143">strings</span><span class="op" id="3659150">.</span><span class="ident" id="3659151">ToLower</span><span class="op" id="3659158">(</span><span class="ident" id="3659159">strings</span><span class="op" id="3659166">.</span><span class="ident" id="3659167">TrimSpace</span><span class="op" id="3659176">(</span><span class="ident" id="3659177">p</span><span class="op" id="3659178">)</span><span class="op" id="3659179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659183">if</span>&nbsp;<span class="builtinfunc" id="3659186">len</span><span class="op" id="3659189">(</span><span class="ident" id="3659190">p</span><span class="op" id="3659191">)</span>&nbsp;<span class="op" id="3659193">==</span>&nbsp;<span class="num" id="3659196">0</span>&nbsp;<span class="op" id="3659198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659203">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3659214">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659218">if</span>&nbsp;<span class="ident" id="3659221">hasPort</span><span class="op" id="3659228">(</span><span class="ident" id="3659229">p</span><span class="op" id="3659230">)</span>&nbsp;<span class="op" id="3659232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3659237">p</span>&nbsp;<span class="op" id="3659239">=</span>&nbsp;<span class="ident" id="3659241">p</span><span class="op" id="3659242">[</span><span class="op" id="3659243">:</span><span class="ident" id="3659244">strings</span><span class="op" id="3659251">.</span><span class="ident" id="3659252">LastIndex</span><span class="op" id="3659261">(</span><span class="ident" id="3659262">p</span><span class="op" id="3659263">,</span>&nbsp;<span class="string" id="3659265">&#34;:&#34;</span><span class="op" id="3659268">)</span><span class="op" id="3659269">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3659273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659277">if</span>&nbsp;<span class="ident" id="3659280">addr</span>&nbsp;<span class="op" id="3659285">==</span>&nbsp;<span class="ident" id="3659288">p</span>&nbsp;<span class="op" id="3659290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659295">return</span>&nbsp;<span class="builtintype" id="3659302">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3659310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659314">if</span>&nbsp;<span class="ident" id="3659317">p</span><span class="op" id="3659318">[</span><span class="num" id="3659319">0</span><span class="op" id="3659320">]</span>&nbsp;<span class="op" id="3659322">==</span>&nbsp;<span class="string" id="3659325">&#39;.&#39;</span>&nbsp;<span class="op" id="3659329">&amp;&amp;</span>&nbsp;<span class="op" id="3659332">(</span><span class="ident" id="3659333">strings</span><span class="op" id="3659340">.</span><span class="ident" id="3659341">HasSuffix</span><span class="op" id="3659350">(</span><span class="ident" id="3659351">addr</span><span class="op" id="3659355">,</span>&nbsp;<span class="ident" id="3659357">p</span><span class="op" id="3659358">)</span>&nbsp;<span class="op" id="3659360">||</span>&nbsp;<span class="ident" id="3659363">addr</span>&nbsp;<span class="op" id="3659368">==</span>&nbsp;<span class="ident" id="3659371">p</span><span class="op" id="3659372">[</span><span class="num" id="3659373">1</span><span class="op" id="3659374">:</span><span class="op" id="3659375">]</span><span class="op" id="3659376">)</span>&nbsp;<span class="op" id="3659378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3659383">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659444">return</span>&nbsp;<span class="builtintype" id="3659451">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3659459">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659463">if</span>&nbsp;<span class="ident" id="3659466">p</span><span class="op" id="3659467">[</span><span class="num" id="3659468">0</span><span class="op" id="3659469">]</span>&nbsp;<span class="op" id="3659471">!=</span>&nbsp;<span class="string" id="3659474">&#39;.&#39;</span>&nbsp;<span class="op" id="3659478">&amp;&amp;</span>&nbsp;<span class="ident" id="3659481">strings</span><span class="op" id="3659488">.</span><span class="ident" id="3659489">HasSuffix</span><span class="op" id="3659498">(</span><span class="ident" id="3659499">addr</span><span class="op" id="3659503">,</span>&nbsp;<span class="ident" id="3659505">p</span><span class="op" id="3659506">)</span>&nbsp;<span class="op" id="3659508">&amp;&amp;</span>&nbsp;<span class="ident" id="3659511">addr</span><span class="op" id="3659515">[</span><span class="builtinfunc" id="3659516">len</span><span class="op" id="3659519">(</span><span class="ident" id="3659520">addr</span><span class="op" id="3659524">)</span><span class="op" id="3659525">-</span><span class="builtinfunc" id="3659526">len</span><span class="op" id="3659529">(</span><span class="ident" id="3659530">p</span><span class="op" id="3659531">)</span><span class="op" id="3659532">-</span><span class="num" id="3659533">1</span><span class="op" id="3659534">]</span>&nbsp;<span class="op" id="3659536">==</span>&nbsp;<span class="string" id="3659539">&#39;.&#39;</span>&nbsp;<span class="op" id="3659543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3659548">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659595">return</span>&nbsp;<span class="builtintype" id="3659602">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3659610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3659613">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3659616">return</span>&nbsp;<span class="builtintype" id="3659623">true</span><br>
<span class="lineno"></span><span class="op" id="3659628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3659631">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="3659707">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="3659762">//</span><br>
<span class="lineno"></span><span class="comment" id="3659765">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="3659816">//</span><br>
<span class="lineno"></span><span class="comment" id="3659819">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="3659864">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="3659923">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3659990">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3660058">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="3660132">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3660210">//</span><br>
<span class="lineno">730</span><span class="comment" id="3660213">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="3660260">//</span><br>
<span class="lineno"></span><span class="keyword" id="3660263">type</span>&nbsp;<span class="ident" id="3660268">connectMethod</span>&nbsp;<span class="keyword" id="3660282">struct</span>&nbsp;<span class="op" id="3660289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3660292">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3660305">*</span><span class="ident" id="3660306">url</span><span class="op" id="3660309">.</span><span class="ident" id="3660310">URL</span>&nbsp;<span class="comment" id="3660314">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3660356">targetScheme</span>&nbsp;<span class="builtintype" id="3660369">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3660378">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3660400">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3660413">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3660422">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="3660486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3660489">func</span>&nbsp;<span class="op" id="3660494">(</span><span class="ident" id="3660495">cm</span>&nbsp;<span class="op" id="3660498">*</span><span class="ident" id="3660499">connectMethod</span><span class="op" id="3660512">)</span>&nbsp;<span class="ident" id="3660514">key</span><span class="op" id="3660517">(</span><span class="op" id="3660518">)</span>&nbsp;<span class="ident" id="3660520">connectMethodKey</span>&nbsp;<span class="op" id="3660537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3660540">proxyStr</span>&nbsp;<span class="op" id="3660549">:=</span>&nbsp;<span class="string" id="3660552">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3660556">targetAddr</span>&nbsp;<span class="op" id="3660567">:=</span>&nbsp;<span class="ident" id="3660570">cm</span><span class="op" id="3660572">.</span><span class="ident" id="3660573">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3660585">if</span>&nbsp;<span class="ident" id="3660588">cm</span><span class="op" id="3660590">.</span><span class="ident" id="3660591">proxyURL</span>&nbsp;<span class="op" id="3660600">!=</span>&nbsp;<span class="builtintype" id="3660603">nil</span>&nbsp;<span class="op" id="3660607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3660611">proxyStr</span>&nbsp;<span class="op" id="3660620">=</span>&nbsp;<span class="ident" id="3660622">cm</span><span class="op" id="3660624">.</span><span class="ident" id="3660625">proxyURL</span><span class="op" id="3660633">.</span><span class="ident" id="3660634">String</span><span class="op" id="3660640">(</span><span class="op" id="3660641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3660645">if</span>&nbsp;<span class="ident" id="3660648">cm</span><span class="op" id="3660650">.</span><span class="ident" id="3660651">targetScheme</span>&nbsp;<span class="op" id="3660664">==</span>&nbsp;<span class="string" id="3660667">&#34;http&#34;</span>&nbsp;<span class="op" id="3660674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3660679">targetAddr</span>&nbsp;<span class="op" id="3660690">=</span>&nbsp;<span class="string" id="3660692">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3660697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3660700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3660703">return</span>&nbsp;<span class="ident" id="3660710">connectMethodKey</span><span class="op" id="3660726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3660730">proxy</span><span class="op" id="3660735">:</span>&nbsp;&nbsp;<span class="ident" id="3660738">proxyStr</span><span class="op" id="3660746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3660750">scheme</span><span class="op" id="3660756">:</span>&nbsp;<span class="ident" id="3660758">cm</span><span class="op" id="3660760">.</span><span class="ident" id="3660761">targetScheme</span><span class="op" id="3660773">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3660777">addr</span><span class="op" id="3660781">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3660785">targetAddr</span><span class="op" id="3660795">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3660798">}</span><br>
<span class="lineno"></span><span class="op" id="3660800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3660803">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="3660878">func</span>&nbsp;<span class="op" id="3660883">(</span><span class="ident" id="3660884">cm</span>&nbsp;<span class="op" id="3660887">*</span><span class="ident" id="3660888">connectMethod</span><span class="op" id="3660901">)</span>&nbsp;<span class="ident" id="3660903">addr</span><span class="op" id="3660907">(</span><span class="op" id="3660908">)</span>&nbsp;<span class="builtintype" id="3660910">string</span>&nbsp;<span class="op" id="3660917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3660920">if</span>&nbsp;<span class="ident" id="3660923">cm</span><span class="op" id="3660925">.</span><span class="ident" id="3660926">proxyURL</span>&nbsp;<span class="op" id="3660935">!=</span>&nbsp;<span class="builtintype" id="3660938">nil</span>&nbsp;<span class="op" id="3660942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3660946">return</span>&nbsp;<span class="ident" id="3660953">canonicalAddr</span><span class="op" id="3660966">(</span><span class="ident" id="3660967">cm</span><span class="op" id="3660969">.</span><span class="ident" id="3660970">proxyURL</span><span class="op" id="3660978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3660981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3660984">return</span>&nbsp;<span class="ident" id="3660991">cm</span><span class="op" id="3660993">.</span><span class="ident" id="3660994">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="3661005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3661008">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3661069">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3661089">func</span>&nbsp;<span class="op" id="3661094">(</span><span class="ident" id="3661095">cm</span>&nbsp;<span class="op" id="3661098">*</span><span class="ident" id="3661099">connectMethod</span><span class="op" id="3661112">)</span>&nbsp;<span class="ident" id="3661114">tlsHost</span><span class="op" id="3661121">(</span><span class="op" id="3661122">)</span>&nbsp;<span class="builtintype" id="3661124">string</span>&nbsp;<span class="op" id="3661131">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661134">h</span>&nbsp;<span class="op" id="3661136">:=</span>&nbsp;<span class="ident" id="3661139">cm</span><span class="op" id="3661141">.</span><span class="ident" id="3661142">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3661154">if</span>&nbsp;<span class="ident" id="3661157">hasPort</span><span class="op" id="3661164">(</span><span class="ident" id="3661165">h</span><span class="op" id="3661166">)</span>&nbsp;<span class="op" id="3661168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661172">h</span>&nbsp;<span class="op" id="3661174">=</span>&nbsp;<span class="ident" id="3661176">h</span><span class="op" id="3661177">[</span><span class="op" id="3661178">:</span><span class="ident" id="3661179">strings</span><span class="op" id="3661186">.</span><span class="ident" id="3661187">LastIndex</span><span class="op" id="3661196">(</span><span class="ident" id="3661197">h</span><span class="op" id="3661198">,</span>&nbsp;<span class="string" id="3661200">&#34;:&#34;</span><span class="op" id="3661203">)</span><span class="op" id="3661204">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3661207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3661210">return</span>&nbsp;<span class="ident" id="3661217">h</span><br>
<span class="lineno">770</span><span class="op" id="3661219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3661222">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3661290">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3661361">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="3661371">type</span>&nbsp;<span class="ident" id="3661376">connectMethodKey</span>&nbsp;<span class="keyword" id="3661393">struct</span>&nbsp;<span class="op" id="3661400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661403">proxy</span><span class="op" id="3661408">,</span>&nbsp;<span class="ident" id="3661410">scheme</span><span class="op" id="3661416">,</span>&nbsp;<span class="ident" id="3661418">addr</span>&nbsp;<span class="builtintype" id="3661423">string</span><br>
<span class="lineno"></span><span class="op" id="3661430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3661433">func</span>&nbsp;<span class="op" id="3661438">(</span><span class="ident" id="3661439">k</span>&nbsp;<span class="ident" id="3661441">connectMethodKey</span><span class="op" id="3661457">)</span>&nbsp;<span class="ident" id="3661459">String</span><span class="op" id="3661465">(</span><span class="op" id="3661466">)</span>&nbsp;<span class="builtintype" id="3661468">string</span>&nbsp;<span class="op" id="3661475">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3661478">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3661502">return</span>&nbsp;<span class="ident" id="3661509">fmt</span><span class="op" id="3661512">.</span><span class="ident" id="3661513">Sprintf</span><span class="op" id="3661520">(</span><span class="string" id="3661521">&#34;%s|%s|%s&#34;</span><span class="op" id="3661531">,</span>&nbsp;<span class="ident" id="3661533">k</span><span class="op" id="3661534">.</span><span class="ident" id="3661535">proxy</span><span class="op" id="3661540">,</span>&nbsp;<span class="ident" id="3661542">k</span><span class="op" id="3661543">.</span><span class="ident" id="3661544">scheme</span><span class="op" id="3661550">,</span>&nbsp;<span class="ident" id="3661552">k</span><span class="op" id="3661553">.</span><span class="ident" id="3661554">addr</span><span class="op" id="3661558">)</span><br>
<span class="lineno"></span><span class="op" id="3661560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3661563">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="3661623">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="3661680">type</span>&nbsp;<span class="ident" id="3661685">persistConn</span>&nbsp;<span class="keyword" id="3661697">struct</span>&nbsp;<span class="op" id="3661704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661707">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3661716">*</span><span class="ident" id="3661717">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661728">cacheKey</span>&nbsp;<span class="ident" id="3661737">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661755">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661764">net</span><span class="op" id="3661767">.</span><span class="ident" id="3661768">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661774">tlsState</span>&nbsp;<span class="op" id="3661783">*</span><span class="ident" id="3661784">tls</span><span class="op" id="3661787">.</span><span class="ident" id="3661788">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661805">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3661814">*</span><span class="ident" id="3661815">bufio</span><span class="op" id="3661820">.</span><span class="ident" id="3661821">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3661834">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661848">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3661857">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3661877">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661933">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3661942">*</span><span class="ident" id="3661943">bufio</span><span class="op" id="3661948">.</span><span class="ident" id="3661949">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3661962">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3661974">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3661983">chan</span>&nbsp;<span class="ident" id="3661988">requestAndChan</span>&nbsp;<span class="comment" id="3662003">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3662046">writech</span>&nbsp;&nbsp;<span class="keyword" id="3662055">chan</span>&nbsp;<span class="ident" id="3662060">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3662075">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3662119">closech</span>&nbsp;&nbsp;<span class="keyword" id="3662128">chan</span>&nbsp;<span class="keyword" id="3662133">struct</span><span class="op" id="3662139">{</span><span class="op" id="3662140">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3662148">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3662176">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="3662185">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3662191">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3662251">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3662313">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3662377">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3662436">writeErrCh</span>&nbsp;<span class="keyword" id="3662447">chan</span>&nbsp;<span class="builtintype" id="3662452">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3662460">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3662481">sync</span><span class="op" id="3662485">.</span><span class="ident" id="3662486">Mutex</span>&nbsp;<span class="comment" id="3662492">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3662520">numExpectedResponses</span>&nbsp;<span class="builtintype" id="3662541">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3662546">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3662567">bool</span>&nbsp;<span class="comment" id="3662572">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3662605">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3662626">bool</span>&nbsp;<span class="comment" id="3662631">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3662711">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3662768">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3662831">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3662888">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="3662905">func</span><span class="op" id="3662909">(</span><span class="ident" id="3662910">Header</span><span class="op" id="3662916">)</span><br>
<span class="lineno"></span><span class="op" id="3662918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3662921">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="3662993">func</span>&nbsp;<span class="op" id="3662998">(</span><span class="ident" id="3662999">pc</span>&nbsp;<span class="op" id="3663002">*</span><span class="ident" id="3663003">persistConn</span><span class="op" id="3663014">)</span>&nbsp;<span class="ident" id="3663016">isBroken</span><span class="op" id="3663024">(</span><span class="op" id="3663025">)</span>&nbsp;<span class="builtintype" id="3663027">bool</span>&nbsp;<span class="op" id="3663032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663035">pc</span><span class="op" id="3663037">.</span><span class="ident" id="3663038">lk</span><span class="op" id="3663040">.</span><span class="ident" id="3663041">Lock</span><span class="op" id="3663045">(</span><span class="op" id="3663046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663049">b</span>&nbsp;<span class="op" id="3663051">:=</span>&nbsp;<span class="ident" id="3663054">pc</span><span class="op" id="3663056">.</span><span class="ident" id="3663057">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663065">pc</span><span class="op" id="3663067">.</span><span class="ident" id="3663068">lk</span><span class="op" id="3663070">.</span><span class="ident" id="3663071">Unlock</span><span class="op" id="3663077">(</span><span class="op" id="3663078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663081">return</span>&nbsp;<span class="ident" id="3663088">b</span><br>
<span class="lineno">820</span><span class="op" id="3663090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3663093">func</span>&nbsp;<span class="op" id="3663098">(</span><span class="ident" id="3663099">pc</span>&nbsp;<span class="op" id="3663102">*</span><span class="ident" id="3663103">persistConn</span><span class="op" id="3663114">)</span>&nbsp;<span class="ident" id="3663116">cancelRequest</span><span class="op" id="3663129">(</span><span class="op" id="3663130">)</span>&nbsp;<span class="op" id="3663132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663135">pc</span><span class="op" id="3663137">.</span><span class="ident" id="3663138">conn</span><span class="op" id="3663142">.</span><span class="ident" id="3663143">Close</span><span class="op" id="3663148">(</span><span class="op" id="3663149">)</span><br>
<span class="lineno"></span><span class="op" id="3663151">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="3663154">var</span>&nbsp;<span class="ident" id="3663158">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="3663179">func</span><span class="op" id="3663183">(</span><span class="builtintype" id="3663184">error</span><span class="op" id="3663189">)</span>&nbsp;<span class="builtintype" id="3663191">bool</span>&nbsp;<span class="comment" id="3663196">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3663222">func</span>&nbsp;<span class="ident" id="3663227">remoteSideClosed</span><span class="op" id="3663243">(</span><span class="ident" id="3663244">err</span>&nbsp;<span class="builtintype" id="3663248">error</span><span class="op" id="3663253">)</span>&nbsp;<span class="builtintype" id="3663255">bool</span>&nbsp;<span class="op" id="3663260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663263">if</span>&nbsp;<span class="ident" id="3663266">err</span>&nbsp;<span class="op" id="3663270">==</span>&nbsp;<span class="ident" id="3663273">io</span><span class="op" id="3663275">.</span><span class="ident" id="3663276">EOF</span>&nbsp;<span class="op" id="3663280">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663284">return</span>&nbsp;<span class="builtintype" id="3663291">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3663297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663300">if</span>&nbsp;<span class="ident" id="3663303">remoteSideClosedFunc</span>&nbsp;<span class="op" id="3663324">!=</span>&nbsp;<span class="builtintype" id="3663327">nil</span>&nbsp;<span class="op" id="3663331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663335">return</span>&nbsp;<span class="ident" id="3663342">remoteSideClosedFunc</span><span class="op" id="3663362">(</span><span class="ident" id="3663363">err</span><span class="op" id="3663366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3663369">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663372">return</span>&nbsp;<span class="builtintype" id="3663379">false</span><br>
<span class="lineno"></span><span class="op" id="3663385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3663388">func</span>&nbsp;<span class="op" id="3663393">(</span><span class="ident" id="3663394">pc</span>&nbsp;<span class="op" id="3663397">*</span><span class="ident" id="3663398">persistConn</span><span class="op" id="3663409">)</span>&nbsp;<span class="ident" id="3663411">readLoop</span><span class="op" id="3663419">(</span><span class="op" id="3663420">)</span>&nbsp;<span class="op" id="3663422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663425">alive</span>&nbsp;<span class="op" id="3663431">:=</span>&nbsp;<span class="builtintype" id="3663434">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663441">for</span>&nbsp;<span class="ident" id="3663445">alive</span>&nbsp;<span class="op" id="3663451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663455">pb</span><span class="op" id="3663457">,</span>&nbsp;<span class="ident" id="3663459">err</span>&nbsp;<span class="op" id="3663463">:=</span>&nbsp;<span class="ident" id="3663466">pc</span><span class="op" id="3663468">.</span><span class="ident" id="3663469">br</span><span class="op" id="3663471">.</span><span class="ident" id="3663472">Peek</span><span class="op" id="3663476">(</span><span class="num" id="3663477">1</span><span class="op" id="3663478">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663483">pc</span><span class="op" id="3663485">.</span><span class="ident" id="3663486">lk</span><span class="op" id="3663488">.</span><span class="ident" id="3663489">Lock</span><span class="op" id="3663493">(</span><span class="op" id="3663494">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663498">if</span>&nbsp;<span class="ident" id="3663501">pc</span><span class="op" id="3663503">.</span><span class="ident" id="3663504">numExpectedResponses</span>&nbsp;<span class="op" id="3663525">==</span>&nbsp;<span class="num" id="3663528">0</span>&nbsp;<span class="op" id="3663530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663535">if</span>&nbsp;<span class="op" id="3663538">!</span><span class="ident" id="3663539">pc</span><span class="op" id="3663541">.</span><span class="ident" id="3663542">closed</span>&nbsp;<span class="op" id="3663549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663555">pc</span><span class="op" id="3663557">.</span><span class="ident" id="3663558">closeLocked</span><span class="op" id="3663569">(</span><span class="op" id="3663570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663576">if</span>&nbsp;<span class="builtinfunc" id="3663579">len</span><span class="op" id="3663582">(</span><span class="ident" id="3663583">pb</span><span class="op" id="3663585">)</span>&nbsp;<span class="op" id="3663587">&gt;</span>&nbsp;<span class="num" id="3663589">0</span>&nbsp;<span class="op" id="3663591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663598">log</span><span class="op" id="3663601">.</span><span class="ident" id="3663602">Printf</span><span class="op" id="3663608">(</span><span class="string" id="3663609">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="3663686">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3663694">string</span><span class="op" id="3663700">(</span><span class="ident" id="3663701">pb</span><span class="op" id="3663703">)</span><span class="op" id="3663704">,</span>&nbsp;<span class="ident" id="3663706">err</span><span class="op" id="3663709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3663715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3663720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663725">pc</span><span class="op" id="3663727">.</span><span class="ident" id="3663728">lk</span><span class="op" id="3663730">.</span><span class="ident" id="3663731">Unlock</span><span class="op" id="3663737">(</span><span class="op" id="3663738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663743">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3663752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663756">pc</span><span class="op" id="3663758">.</span><span class="ident" id="3663759">lk</span><span class="op" id="3663761">.</span><span class="ident" id="3663762">Unlock</span><span class="op" id="3663768">(</span><span class="op" id="3663769">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663774">rc</span>&nbsp;<span class="op" id="3663777">:=</span>&nbsp;<span class="op" id="3663780">&lt;-</span><span class="ident" id="3663782">pc</span><span class="op" id="3663784">.</span><span class="ident" id="3663785">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663794">var</span>&nbsp;<span class="ident" id="3663798">resp</span>&nbsp;<span class="op" id="3663803">*</span><span class="ident" id="3663804">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663815">if</span>&nbsp;<span class="ident" id="3663818">err</span>&nbsp;<span class="op" id="3663822">==</span>&nbsp;<span class="builtintype" id="3663825">nil</span>&nbsp;<span class="op" id="3663829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663834">resp</span><span class="op" id="3663838">,</span>&nbsp;<span class="ident" id="3663840">err</span>&nbsp;<span class="op" id="3663844">=</span>&nbsp;<span class="ident" id="3663846">ReadResponse</span><span class="op" id="3663858">(</span><span class="ident" id="3663859">pc</span><span class="op" id="3663861">.</span><span class="ident" id="3663862">br</span><span class="op" id="3663864">,</span>&nbsp;<span class="ident" id="3663866">rc</span><span class="op" id="3663868">.</span><span class="ident" id="3663869">req</span><span class="op" id="3663872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663877">if</span>&nbsp;<span class="ident" id="3663880">err</span>&nbsp;<span class="op" id="3663884">==</span>&nbsp;<span class="builtintype" id="3663887">nil</span>&nbsp;<span class="op" id="3663891">&amp;&amp;</span>&nbsp;<span class="ident" id="3663894">resp</span><span class="op" id="3663898">.</span><span class="ident" id="3663899">StatusCode</span>&nbsp;<span class="op" id="3663910">==</span>&nbsp;<span class="num" id="3663913">100</span>&nbsp;<span class="op" id="3663917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3663923">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3663961">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3664022">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3664082">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3664148">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3664196">resp</span><span class="op" id="3664200">,</span>&nbsp;<span class="ident" id="3664202">err</span>&nbsp;<span class="op" id="3664206">=</span>&nbsp;<span class="ident" id="3664208">ReadResponse</span><span class="op" id="3664220">(</span><span class="ident" id="3664221">pc</span><span class="op" id="3664223">.</span><span class="ident" id="3664224">br</span><span class="op" id="3664226">,</span>&nbsp;<span class="ident" id="3664228">rc</span><span class="op" id="3664230">.</span><span class="ident" id="3664231">req</span><span class="op" id="3664234">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3664239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3664243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3664248">if</span>&nbsp;<span class="ident" id="3664251">resp</span>&nbsp;<span class="op" id="3664256">!=</span>&nbsp;<span class="builtintype" id="3664259">nil</span>&nbsp;<span class="op" id="3664263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3664268">resp</span><span class="op" id="3664272">.</span><span class="ident" id="3664273">TLS</span>&nbsp;<span class="op" id="3664277">=</span>&nbsp;<span class="ident" id="3664279">pc</span><span class="op" id="3664281">.</span><span class="ident" id="3664282">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3664293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3664298">hasBody</span>&nbsp;<span class="op" id="3664306">:=</span>&nbsp;<span class="ident" id="3664309">resp</span>&nbsp;<span class="op" id="3664314">!=</span>&nbsp;<span class="builtintype" id="3664317">nil</span>&nbsp;<span class="op" id="3664321">&amp;&amp;</span>&nbsp;<span class="ident" id="3664324">rc</span><span class="op" id="3664326">.</span><span class="ident" id="3664327">req</span><span class="op" id="3664330">.</span><span class="ident" id="3664331">Method</span>&nbsp;<span class="op" id="3664338">!=</span>&nbsp;<span class="string" id="3664341">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3664348">&amp;&amp;</span>&nbsp;<span class="ident" id="3664351">resp</span><span class="op" id="3664355">.</span><span class="ident" id="3664356">ContentLength</span>&nbsp;<span class="op" id="3664370">!=</span>&nbsp;<span class="num" id="3664373">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3664378">if</span>&nbsp;<span class="ident" id="3664381">err</span>&nbsp;<span class="op" id="3664385">!=</span>&nbsp;<span class="builtintype" id="3664388">nil</span>&nbsp;<span class="op" id="3664392">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3664397">pc</span><span class="op" id="3664399">.</span><span class="builtinfunc" id="3664400">close</span><span class="op" id="3664405">(</span><span class="op" id="3664406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3664410">}</span>&nbsp;<span class="keyword" id="3664412">else</span>&nbsp;<span class="op" id="3664417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3664422">if</span>&nbsp;<span class="ident" id="3664425">rc</span><span class="op" id="3664427">.</span><span class="ident" id="3664428">addedGzip</span>&nbsp;<span class="op" id="3664438">&amp;&amp;</span>&nbsp;<span class="ident" id="3664441">hasBody</span>&nbsp;<span class="op" id="3664449">&amp;&amp;</span>&nbsp;<span class="ident" id="3664452">resp</span><span class="op" id="3664456">.</span><span class="ident" id="3664457">Header</span><span class="op" id="3664463">.</span><span class="ident" id="3664464">Get</span><span class="op" id="3664467">(</span><span class="string" id="3664468">&#34;Content-Encoding&#34;</span><span class="op" id="3664486">)</span>&nbsp;<span class="op" id="3664488">==</span>&nbsp;<span class="string" id="3664491">&#34;gzip&#34;</span>&nbsp;<span class="op" id="3664498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3664504">resp</span><span class="op" id="3664508">.</span><span class="ident" id="3664509">Header</span><span class="op" id="3664515">.</span><span class="ident" id="3664516">Del</span><span class="op" id="3664519">(</span><span class="string" id="3664520">&#34;Content-Encoding&#34;</span><span class="op" id="3664538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3664544">resp</span><span class="op" id="3664548">.</span><span class="ident" id="3664549">Header</span><span class="op" id="3664555">.</span><span class="ident" id="3664556">Del</span><span class="op" id="3664559">(</span><span class="string" id="3664560">&#34;Content-Length&#34;</span><span class="op" id="3664576">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3664582">resp</span><span class="op" id="3664586">.</span><span class="ident" id="3664587">ContentLength</span>&nbsp;<span class="op" id="3664601">=</span>&nbsp;<span class="op" id="3664603">-</span><span class="num" id="3664604">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3664610">resp</span><span class="op" id="3664614">.</span><span class="ident" id="3664615">Body</span>&nbsp;<span class="op" id="3664620">=</span>&nbsp;<span class="op" id="3664622">&amp;</span><span class="ident" id="3664623">gzipReader</span><span class="op" id="3664633">{</span><span class="ident" id="3664634">body</span><span class="op" id="3664638">:</span>&nbsp;<span class="ident" id="3664640">resp</span><span class="op" id="3664644">.</span><span class="ident" id="3664645">Body</span><span class="op" id="3664649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3664654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3664659">resp</span><span class="op" id="3664663">.</span><span class="ident" id="3664664">Body</span>&nbsp;<span class="op" id="3664669">=</span>&nbsp;<span class="op" id="3664671">&amp;</span><span class="ident" id="3664672">bodyEOFSignal</span><span class="op" id="3664685">{</span><span class="ident" id="3664686">body</span><span class="op" id="3664690">:</span>&nbsp;<span class="ident" id="3664692">resp</span><span class="op" id="3664696">.</span><span class="ident" id="3664697">Body</span><span class="op" id="3664701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3664705">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3664710">if</span>&nbsp;<span class="ident" id="3664713">err</span>&nbsp;<span class="op" id="3664717">!=</span>&nbsp;<span class="builtintype" id="3664720">nil</span>&nbsp;<span class="op" id="3664724">||</span>&nbsp;<span class="ident" id="3664727">resp</span><span class="op" id="3664731">.</span><span class="ident" id="3664732">Close</span>&nbsp;<span class="op" id="3664738">||</span>&nbsp;<span class="ident" id="3664741">rc</span><span class="op" id="3664743">.</span><span class="ident" id="3664744">req</span><span class="op" id="3664747">.</span><span class="ident" id="3664748">Close</span>&nbsp;<span class="op" id="3664754">||</span>&nbsp;<span class="ident" id="3664757">resp</span><span class="op" id="3664761">.</span><span class="ident" id="3664762">StatusCode</span>&nbsp;<span class="op" id="3664773">&lt;=</span>&nbsp;<span class="num" id="3664776">199</span>&nbsp;<span class="op" id="3664780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3664785">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3664854">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3664914">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3664961">alive</span>&nbsp;<span class="op" id="3664967">=</span>&nbsp;<span class="builtintype" id="3664969">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3664977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3664982">var</span>&nbsp;<span class="ident" id="3664986">waitForBodyRead</span>&nbsp;<span class="keyword" id="3665002">chan</span>&nbsp;<span class="builtintype" id="3665007">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3665014">if</span>&nbsp;<span class="ident" id="3665017">hasBody</span>&nbsp;<span class="op" id="3665025">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665030">waitForBodyRead</span>&nbsp;<span class="op" id="3665046">=</span>&nbsp;<span class="builtinfunc" id="3665048">make</span><span class="op" id="3665052">(</span><span class="keyword" id="3665053">chan</span>&nbsp;<span class="builtintype" id="3665058">bool</span><span class="op" id="3665062">,</span>&nbsp;<span class="num" id="3665064">2</span><span class="op" id="3665065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665070">resp</span><span class="op" id="3665074">.</span><span class="ident" id="3665075">Body</span><span class="op" id="3665079">.</span><span class="op" id="3665080">(</span><span class="op" id="3665081">*</span><span class="ident" id="3665082">bodyEOFSignal</span><span class="op" id="3665095">)</span><span class="op" id="3665096">.</span><span class="ident" id="3665097">earlyCloseFn</span>&nbsp;<span class="op" id="3665110">=</span>&nbsp;<span class="keyword" id="3665112">func</span><span class="op" id="3665116">(</span><span class="op" id="3665117">)</span>&nbsp;<span class="builtintype" id="3665119">error</span>&nbsp;<span class="op" id="3665125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665131">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665171">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665210">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665224">waitForBodyRead</span>&nbsp;<span class="op" id="3665240">&lt;-</span>&nbsp;<span class="builtintype" id="3665243">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3665253">return</span>&nbsp;<span class="builtintype" id="3665260">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3665267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665272">resp</span><span class="op" id="3665276">.</span><span class="ident" id="3665277">Body</span><span class="op" id="3665281">.</span><span class="op" id="3665282">(</span><span class="op" id="3665283">*</span><span class="ident" id="3665284">bodyEOFSignal</span><span class="op" id="3665297">)</span><span class="op" id="3665298">.</span><span class="ident" id="3665299">fn</span>&nbsp;<span class="op" id="3665302">=</span>&nbsp;<span class="keyword" id="3665304">func</span><span class="op" id="3665308">(</span><span class="ident" id="3665309">err</span>&nbsp;<span class="builtintype" id="3665313">error</span><span class="op" id="3665318">)</span>&nbsp;<span class="op" id="3665320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665326">waitForBodyRead</span>&nbsp;<span class="op" id="3665342">&lt;-</span>&nbsp;<span class="ident" id="3665345">alive</span>&nbsp;<span class="op" id="3665351">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665359">err</span>&nbsp;<span class="op" id="3665363">==</span>&nbsp;<span class="builtintype" id="3665366">nil</span>&nbsp;<span class="op" id="3665370">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3665378">!</span><span class="ident" id="3665379">pc</span><span class="op" id="3665381">.</span><span class="ident" id="3665382">sawEOF</span>&nbsp;<span class="op" id="3665389">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665397">pc</span><span class="op" id="3665399">.</span><span class="ident" id="3665400">wroteRequest</span><span class="op" id="3665412">(</span><span class="op" id="3665413">)</span>&nbsp;<span class="op" id="3665415">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665423">pc</span><span class="op" id="3665425">.</span><span class="ident" id="3665426">t</span><span class="op" id="3665427">.</span><span class="ident" id="3665428">putIdleConn</span><span class="op" id="3665439">(</span><span class="ident" id="3665440">pc</span><span class="op" id="3665442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3665447">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3665451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3665456">if</span>&nbsp;<span class="ident" id="3665459">alive</span>&nbsp;<span class="op" id="3665465">&amp;&amp;</span>&nbsp;<span class="op" id="3665468">!</span><span class="ident" id="3665469">hasBody</span>&nbsp;<span class="op" id="3665477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665482">alive</span>&nbsp;<span class="op" id="3665488">=</span>&nbsp;<span class="op" id="3665490">!</span><span class="ident" id="3665491">pc</span><span class="op" id="3665493">.</span><span class="ident" id="3665494">sawEOF</span>&nbsp;<span class="op" id="3665501">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665508">pc</span><span class="op" id="3665510">.</span><span class="ident" id="3665511">wroteRequest</span><span class="op" id="3665523">(</span><span class="op" id="3665524">)</span>&nbsp;<span class="op" id="3665526">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665533">pc</span><span class="op" id="3665535">.</span><span class="ident" id="3665536">t</span><span class="op" id="3665537">.</span><span class="ident" id="3665538">putIdleConn</span><span class="op" id="3665549">(</span><span class="ident" id="3665550">pc</span><span class="op" id="3665552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3665556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665561">rc</span><span class="op" id="3665563">.</span><span class="ident" id="3665564">ch</span>&nbsp;<span class="op" id="3665567">&lt;-</span>&nbsp;<span class="ident" id="3665570">responseAndError</span><span class="op" id="3665586">{</span><span class="ident" id="3665587">resp</span><span class="op" id="3665591">,</span>&nbsp;<span class="ident" id="3665593">err</span><span class="op" id="3665596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665601">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665668">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3665729">if</span>&nbsp;<span class="ident" id="3665732">waitForBodyRead</span>&nbsp;<span class="op" id="3665748">!=</span>&nbsp;<span class="builtintype" id="3665751">nil</span>&nbsp;<span class="op" id="3665755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3665760">select</span>&nbsp;<span class="op" id="3665767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3665772">case</span>&nbsp;<span class="ident" id="3665777">alive</span>&nbsp;<span class="op" id="3665783">=</span>&nbsp;<span class="op" id="3665785">&lt;-</span><span class="ident" id="3665787">waitForBodyRead</span><span class="op" id="3665802">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3665807">case</span>&nbsp;<span class="op" id="3665812">&lt;-</span><span class="ident" id="3665814">pc</span><span class="op" id="3665816">.</span><span class="ident" id="3665817">closech</span><span class="op" id="3665824">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665830">alive</span>&nbsp;<span class="op" id="3665836">=</span>&nbsp;<span class="builtintype" id="3665838">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3665847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3665851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665856">pc</span><span class="op" id="3665858">.</span><span class="ident" id="3665859">t</span><span class="op" id="3665860">.</span><span class="ident" id="3665861">setReqCanceler</span><span class="op" id="3665875">(</span><span class="ident" id="3665876">rc</span><span class="op" id="3665878">.</span><span class="ident" id="3665879">req</span><span class="op" id="3665882">,</span>&nbsp;<span class="builtintype" id="3665884">nil</span><span class="op" id="3665887">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3665892">if</span>&nbsp;<span class="op" id="3665895">!</span><span class="ident" id="3665896">alive</span>&nbsp;<span class="op" id="3665902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665907">pc</span><span class="op" id="3665909">.</span><span class="builtinfunc" id="3665910">close</span><span class="op" id="3665915">(</span><span class="op" id="3665916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3665920">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3665923">}</span><br>
<span class="lineno"></span><span class="op" id="3665925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3665928">func</span>&nbsp;<span class="op" id="3665933">(</span><span class="ident" id="3665934">pc</span>&nbsp;<span class="op" id="3665937">*</span><span class="ident" id="3665938">persistConn</span><span class="op" id="3665949">)</span>&nbsp;<span class="ident" id="3665951">writeLoop</span><span class="op" id="3665960">(</span><span class="op" id="3665961">)</span>&nbsp;<span class="op" id="3665963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3665966">for</span>&nbsp;<span class="op" id="3665970">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3665974">select</span>&nbsp;<span class="op" id="3665981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3665985">case</span>&nbsp;<span class="ident" id="3665990">wr</span>&nbsp;<span class="op" id="3665993">:=</span>&nbsp;<span class="op" id="3665996">&lt;-</span><span class="ident" id="3665998">pc</span><span class="op" id="3666000">.</span><span class="ident" id="3666001">writech</span><span class="op" id="3666008">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666013">if</span>&nbsp;<span class="ident" id="3666016">pc</span><span class="op" id="3666018">.</span><span class="ident" id="3666019">isBroken</span><span class="op" id="3666027">(</span><span class="op" id="3666028">)</span>&nbsp;<span class="op" id="3666030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666036">wr</span><span class="op" id="3666038">.</span><span class="ident" id="3666039">ch</span>&nbsp;<span class="op" id="3666042">&lt;-</span>&nbsp;<span class="ident" id="3666045">errors</span><span class="op" id="3666051">.</span><span class="ident" id="3666052">New</span><span class="op" id="3666055">(</span><span class="string" id="3666056">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="3666109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666115">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3666127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666132">err</span>&nbsp;<span class="op" id="3666136">:=</span>&nbsp;<span class="ident" id="3666139">wr</span><span class="op" id="3666141">.</span><span class="ident" id="3666142">req</span><span class="op" id="3666145">.</span><span class="ident" id="3666146">Request</span><span class="op" id="3666153">.</span><span class="ident" id="3666154">write</span><span class="op" id="3666159">(</span><span class="ident" id="3666160">pc</span><span class="op" id="3666162">.</span><span class="ident" id="3666163">bw</span><span class="op" id="3666165">,</span>&nbsp;<span class="ident" id="3666167">pc</span><span class="op" id="3666169">.</span><span class="ident" id="3666170">isProxy</span><span class="op" id="3666177">,</span>&nbsp;<span class="ident" id="3666179">wr</span><span class="op" id="3666181">.</span><span class="ident" id="3666182">req</span><span class="op" id="3666185">.</span><span class="ident" id="3666186">extra</span><span class="op" id="3666191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666196">if</span>&nbsp;<span class="ident" id="3666199">err</span>&nbsp;<span class="op" id="3666203">==</span>&nbsp;<span class="builtintype" id="3666206">nil</span>&nbsp;<span class="op" id="3666210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666216">err</span>&nbsp;<span class="op" id="3666220">=</span>&nbsp;<span class="ident" id="3666222">pc</span><span class="op" id="3666224">.</span><span class="ident" id="3666225">bw</span><span class="op" id="3666227">.</span><span class="ident" id="3666228">Flush</span><span class="op" id="3666233">(</span><span class="op" id="3666234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3666239">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666244">if</span>&nbsp;<span class="ident" id="3666247">err</span>&nbsp;<span class="op" id="3666251">!=</span>&nbsp;<span class="builtintype" id="3666254">nil</span>&nbsp;<span class="op" id="3666258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666264">pc</span><span class="op" id="3666266">.</span><span class="ident" id="3666267">markBroken</span><span class="op" id="3666277">(</span><span class="op" id="3666278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666284">wr</span><span class="op" id="3666286">.</span><span class="ident" id="3666287">req</span><span class="op" id="3666290">.</span><span class="ident" id="3666291">Request</span><span class="op" id="3666298">.</span><span class="ident" id="3666299">closeBody</span><span class="op" id="3666308">(</span><span class="op" id="3666309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3666314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666319">pc</span><span class="op" id="3666321">.</span><span class="ident" id="3666322">writeErrCh</span>&nbsp;<span class="op" id="3666333">&lt;-</span>&nbsp;<span class="ident" id="3666336">err</span>&nbsp;<span class="comment" id="3666340">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666389">wr</span><span class="op" id="3666391">.</span><span class="ident" id="3666392">ch</span>&nbsp;<span class="op" id="3666395">&lt;-</span>&nbsp;<span class="ident" id="3666398">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3666410">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666441">case</span>&nbsp;<span class="op" id="3666446">&lt;-</span><span class="ident" id="3666448">pc</span><span class="op" id="3666450">.</span><span class="ident" id="3666451">closech</span><span class="op" id="3666458">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666463">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3666472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3666475">}</span><br>
<span class="lineno">965</span><span class="op" id="3666477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3666480">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="3666561">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="3666616">func</span>&nbsp;<span class="op" id="3666621">(</span><span class="ident" id="3666622">pc</span>&nbsp;<span class="op" id="3666625">*</span><span class="ident" id="3666626">persistConn</span><span class="op" id="3666637">)</span>&nbsp;<span class="ident" id="3666639">wroteRequest</span><span class="op" id="3666651">(</span><span class="op" id="3666652">)</span>&nbsp;<span class="builtintype" id="3666654">bool</span>&nbsp;<span class="op" id="3666659">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666662">select</span>&nbsp;<span class="op" id="3666669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666672">case</span>&nbsp;<span class="ident" id="3666677">err</span>&nbsp;<span class="op" id="3666681">:=</span>&nbsp;<span class="op" id="3666684">&lt;-</span><span class="ident" id="3666686">pc</span><span class="op" id="3666688">.</span><span class="ident" id="3666689">writeErrCh</span><span class="op" id="3666699">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3666703">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3666769">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666798">return</span>&nbsp;<span class="ident" id="3666805">err</span>&nbsp;<span class="op" id="3666809">==</span>&nbsp;<span class="builtintype" id="3666812">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666817">default</span><span class="op" id="3666824">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3666828">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3666891">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3666954">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3667021">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3667076">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3667081">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3667145">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3667210">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3667274">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3667338">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667369">select</span>&nbsp;<span class="op" id="3667376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667380">case</span>&nbsp;<span class="ident" id="3667385">err</span>&nbsp;<span class="op" id="3667389">:=</span>&nbsp;<span class="op" id="3667392">&lt;-</span><span class="ident" id="3667394">pc</span><span class="op" id="3667396">.</span><span class="ident" id="3667397">writeErrCh</span><span class="op" id="3667407">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667412">return</span>&nbsp;<span class="ident" id="3667419">err</span>&nbsp;<span class="op" id="3667423">==</span>&nbsp;<span class="builtintype" id="3667426">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667432">case</span>&nbsp;<span class="op" id="3667437">&lt;-</span><span class="ident" id="3667439">time</span><span class="op" id="3667443">.</span><span class="ident" id="3667444">After</span><span class="op" id="3667449">(</span><span class="num" id="3667450">50</span>&nbsp;<span class="op" id="3667453">*</span>&nbsp;<span class="ident" id="3667455">time</span><span class="op" id="3667459">.</span><span class="ident" id="3667460">Millisecond</span><span class="op" id="3667471">)</span><span class="op" id="3667472">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667477">return</span>&nbsp;<span class="builtintype" id="3667484">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3667492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3667495">}</span><br>
<span class="lineno"></span><span class="op" id="3667497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="3667500">type</span>&nbsp;<span class="ident" id="3667505">responseAndError</span>&nbsp;<span class="keyword" id="3667522">struct</span>&nbsp;<span class="op" id="3667529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667532">res</span>&nbsp;<span class="op" id="3667536">*</span><span class="ident" id="3667537">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667547">err</span>&nbsp;<span class="builtintype" id="3667551">error</span><br>
<span class="lineno"></span><span class="op" id="3667557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="3667560">type</span>&nbsp;<span class="ident" id="3667565">requestAndChan</span>&nbsp;<span class="keyword" id="3667580">struct</span>&nbsp;<span class="op" id="3667587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667590">req</span>&nbsp;<span class="op" id="3667594">*</span><span class="ident" id="3667595">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667604">ch</span>&nbsp;&nbsp;<span class="keyword" id="3667608">chan</span>&nbsp;<span class="ident" id="3667613">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3667632">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3667693">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3667750">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667788">addedGzip</span>&nbsp;<span class="builtintype" id="3667798">bool</span><br>
<span class="lineno"></span><span class="op" id="3667803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="3667806">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3667867">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="3667931">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3667997">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3668007">type</span>&nbsp;<span class="ident" id="3668012">writeRequest</span>&nbsp;<span class="keyword" id="3668025">struct</span>&nbsp;<span class="op" id="3668032">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668035">req</span>&nbsp;<span class="op" id="3668039">*</span><span class="ident" id="3668040">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668058">ch</span>&nbsp;&nbsp;<span class="keyword" id="3668062">chan</span><span class="op" id="3668066">&lt;-</span>&nbsp;<span class="builtintype" id="3668069">error</span><br>
<span class="lineno"></span><span class="op" id="3668075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3668078">type</span>&nbsp;<span class="ident" id="3668083">httpError</span>&nbsp;<span class="keyword" id="3668093">struct</span>&nbsp;<span class="op" id="3668100">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668103">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3668111">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668119">timeout</span>&nbsp;<span class="builtintype" id="3668127">bool</span><br>
<span class="lineno"></span><span class="op" id="3668132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3668135">func</span>&nbsp;<span class="op" id="3668140">(</span><span class="ident" id="3668141">e</span>&nbsp;<span class="op" id="3668143">*</span><span class="ident" id="3668144">httpError</span><span class="op" id="3668153">)</span>&nbsp;<span class="ident" id="3668155">Error</span><span class="op" id="3668160">(</span><span class="op" id="3668161">)</span>&nbsp;<span class="builtintype" id="3668163">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3668172">{</span>&nbsp;<span class="keyword" id="3668174">return</span>&nbsp;<span class="ident" id="3668181">e</span><span class="op" id="3668182">.</span><span class="ident" id="3668183">err</span>&nbsp;<span class="op" id="3668187">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="3668189">func</span>&nbsp;<span class="op" id="3668194">(</span><span class="ident" id="3668195">e</span>&nbsp;<span class="op" id="3668197">*</span><span class="ident" id="3668198">httpError</span><span class="op" id="3668207">)</span>&nbsp;<span class="ident" id="3668209">Timeout</span><span class="op" id="3668216">(</span><span class="op" id="3668217">)</span>&nbsp;<span class="builtintype" id="3668219">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3668226">{</span>&nbsp;<span class="keyword" id="3668228">return</span>&nbsp;<span class="ident" id="3668235">e</span><span class="op" id="3668236">.</span><span class="ident" id="3668237">timeout</span>&nbsp;<span class="op" id="3668245">}</span><br>
<span class="lineno"></span><span class="keyword" id="3668247">func</span>&nbsp;<span class="op" id="3668252">(</span><span class="ident" id="3668253">e</span>&nbsp;<span class="op" id="3668255">*</span><span class="ident" id="3668256">httpError</span><span class="op" id="3668265">)</span>&nbsp;<span class="ident" id="3668267">Temporary</span><span class="op" id="3668276">(</span><span class="op" id="3668277">)</span>&nbsp;<span class="builtintype" id="3668279">bool</span>&nbsp;<span class="op" id="3668284">{</span>&nbsp;<span class="keyword" id="3668286">return</span>&nbsp;<span class="builtintype" id="3668293">true</span>&nbsp;<span class="op" id="3668298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3668301">var</span>&nbsp;<span class="ident" id="3668305">errTimeout</span>&nbsp;<span class="builtintype" id="3668316">error</span>&nbsp;<span class="op" id="3668322">=</span>&nbsp;<span class="op" id="3668324">&amp;</span><span class="ident" id="3668325">httpError</span><span class="op" id="3668334">{</span><span class="ident" id="3668335">err</span><span class="op" id="3668338">:</span>&nbsp;<span class="string" id="3668340">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="3668385">,</span>&nbsp;<span class="ident" id="3668387">timeout</span><span class="op" id="3668394">:</span>&nbsp;<span class="builtintype" id="3668396">true</span><span class="op" id="3668400">}</span><br>
<span class="lineno"></span><span class="keyword" id="3668402">var</span>&nbsp;<span class="ident" id="3668406">errClosed</span>&nbsp;<span class="builtintype" id="3668416">error</span>&nbsp;<span class="op" id="3668422">=</span>&nbsp;<span class="op" id="3668424">&amp;</span><span class="ident" id="3668425">httpError</span><span class="op" id="3668434">{</span><span class="ident" id="3668435">err</span><span class="op" id="3668438">:</span>&nbsp;<span class="string" id="3668440">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="3668497">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="3668500">func</span>&nbsp;<span class="op" id="3668505">(</span><span class="ident" id="3668506">pc</span>&nbsp;<span class="op" id="3668509">*</span><span class="ident" id="3668510">persistConn</span><span class="op" id="3668521">)</span>&nbsp;<span class="ident" id="3668523">roundTrip</span><span class="op" id="3668532">(</span><span class="ident" id="3668533">req</span>&nbsp;<span class="op" id="3668537">*</span><span class="ident" id="3668538">transportRequest</span><span class="op" id="3668554">)</span>&nbsp;<span class="op" id="3668556">(</span><span class="ident" id="3668557">resp</span>&nbsp;<span class="op" id="3668562">*</span><span class="ident" id="3668563">Response</span><span class="op" id="3668571">,</span>&nbsp;<span class="ident" id="3668573">err</span>&nbsp;<span class="builtintype" id="3668577">error</span><span class="op" id="3668582">)</span>&nbsp;<span class="op" id="3668584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668587">pc</span><span class="op" id="3668589">.</span><span class="ident" id="3668590">t</span><span class="op" id="3668591">.</span><span class="ident" id="3668592">setReqCanceler</span><span class="op" id="3668606">(</span><span class="ident" id="3668607">req</span><span class="op" id="3668610">.</span><span class="ident" id="3668611">Request</span><span class="op" id="3668618">,</span>&nbsp;<span class="ident" id="3668620">pc</span><span class="op" id="3668622">.</span><span class="ident" id="3668623">cancelRequest</span><span class="op" id="3668636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668639">pc</span><span class="op" id="3668641">.</span><span class="ident" id="3668642">lk</span><span class="op" id="3668644">.</span><span class="ident" id="3668645">Lock</span><span class="op" id="3668649">(</span><span class="op" id="3668650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668653">pc</span><span class="op" id="3668655">.</span><span class="ident" id="3668656">numExpectedResponses</span><span class="op" id="3668676">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668680">headerFn</span>&nbsp;<span class="op" id="3668689">:=</span>&nbsp;<span class="ident" id="3668692">pc</span><span class="op" id="3668694">.</span><span class="ident" id="3668695">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668713">pc</span><span class="op" id="3668715">.</span><span class="ident" id="3668716">lk</span><span class="op" id="3668718">.</span><span class="ident" id="3668719">Unlock</span><span class="op" id="3668725">(</span><span class="op" id="3668726">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3668730">if</span>&nbsp;<span class="ident" id="3668733">headerFn</span>&nbsp;<span class="op" id="3668742">!=</span>&nbsp;<span class="builtintype" id="3668745">nil</span>&nbsp;<span class="op" id="3668749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668753">headerFn</span><span class="op" id="3668761">(</span><span class="ident" id="3668762">req</span><span class="op" id="3668765">.</span><span class="ident" id="3668766">extraHeaders</span><span class="op" id="3668778">(</span><span class="op" id="3668779">)</span><span class="op" id="3668780">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3668783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668787">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668851">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668905">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668962">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668980">requestedGzip</span>&nbsp;<span class="op" id="3668994">:=</span>&nbsp;<span class="builtintype" id="3668997">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3669004">if</span>&nbsp;<span class="op" id="3669007">!</span><span class="ident" id="3669008">pc</span><span class="op" id="3669010">.</span><span class="ident" id="3669011">t</span><span class="op" id="3669012">.</span><span class="ident" id="3669013">DisableCompression</span>&nbsp;<span class="op" id="3669032">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669037">req</span><span class="op" id="3669040">.</span><span class="ident" id="3669041">Header</span><span class="op" id="3669047">.</span><span class="ident" id="3669048">Get</span><span class="op" id="3669051">(</span><span class="string" id="3669052">&#34;Accept-Encoding&#34;</span><span class="op" id="3669069">)</span>&nbsp;<span class="op" id="3669071">==</span>&nbsp;<span class="string" id="3669074">&#34;&#34;</span>&nbsp;<span class="op" id="3669077">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669082">req</span><span class="op" id="3669085">.</span><span class="ident" id="3669086">Header</span><span class="op" id="3669092">.</span><span class="ident" id="3669093">Get</span><span class="op" id="3669096">(</span><span class="string" id="3669097">&#34;Range&#34;</span><span class="op" id="3669104">)</span>&nbsp;<span class="op" id="3669106">==</span>&nbsp;<span class="string" id="3669109">&#34;&#34;</span>&nbsp;<span class="op" id="3669112">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669117">req</span><span class="op" id="3669120">.</span><span class="ident" id="3669121">Method</span>&nbsp;<span class="op" id="3669128">!=</span>&nbsp;<span class="string" id="3669131">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3669138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669142">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669204">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669246">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669301">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669306">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669362">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669390">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669436">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669472">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669477">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669541">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669607">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669653">requestedGzip</span>&nbsp;<span class="op" id="3669667">=</span>&nbsp;<span class="builtintype" id="3669669">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669676">req</span><span class="op" id="3669679">.</span><span class="ident" id="3669680">extraHeaders</span><span class="op" id="3669692">(</span><span class="op" id="3669693">)</span><span class="op" id="3669694">.</span><span class="ident" id="3669695">Set</span><span class="op" id="3669698">(</span><span class="string" id="3669699">&#34;Accept-Encoding&#34;</span><span class="op" id="3669716">,</span>&nbsp;<span class="string" id="3669718">&#34;gzip&#34;</span><span class="op" id="3669724">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3669727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669731">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669795">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669859">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669877">writeErrCh</span>&nbsp;<span class="op" id="3669888">:=</span>&nbsp;<span class="builtinfunc" id="3669891">make</span><span class="op" id="3669895">(</span><span class="keyword" id="3669896">chan</span>&nbsp;<span class="builtintype" id="3669901">error</span><span class="op" id="3669906">,</span>&nbsp;<span class="num" id="3669908">1</span><span class="op" id="3669909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669912">pc</span><span class="op" id="3669914">.</span><span class="ident" id="3669915">writech</span>&nbsp;<span class="op" id="3669923">&lt;-</span>&nbsp;<span class="ident" id="3669926">writeRequest</span><span class="op" id="3669938">{</span><span class="ident" id="3669939">req</span><span class="op" id="3669942">,</span>&nbsp;<span class="ident" id="3669944">writeErrCh</span><span class="op" id="3669954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669958">resc</span>&nbsp;<span class="op" id="3669963">:=</span>&nbsp;<span class="builtinfunc" id="3669966">make</span><span class="op" id="3669970">(</span><span class="keyword" id="3669971">chan</span>&nbsp;<span class="ident" id="3669976">responseAndError</span><span class="op" id="3669992">,</span>&nbsp;<span class="num" id="3669994">1</span><span class="op" id="3669995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669998">pc</span><span class="op" id="3670000">.</span><span class="ident" id="3670001">reqch</span>&nbsp;<span class="op" id="3670007">&lt;-</span>&nbsp;<span class="ident" id="3670010">requestAndChan</span><span class="op" id="3670024">{</span><span class="ident" id="3670025">req</span><span class="op" id="3670028">.</span><span class="ident" id="3670029">Request</span><span class="op" id="3670036">,</span>&nbsp;<span class="ident" id="3670038">resc</span><span class="op" id="3670042">,</span>&nbsp;<span class="ident" id="3670044">requestedGzip</span><span class="op" id="3670057">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670061">var</span>&nbsp;<span class="ident" id="3670065">re</span>&nbsp;<span class="ident" id="3670068">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670086">var</span>&nbsp;<span class="ident" id="3670090">pconnDeadCh</span>&nbsp;<span class="op" id="3670102">=</span>&nbsp;<span class="ident" id="3670104">pc</span><span class="op" id="3670106">.</span><span class="ident" id="3670107">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670116">var</span>&nbsp;<span class="ident" id="3670120">failTicker</span>&nbsp;<span class="op" id="3670131">&lt;-</span><span class="keyword" id="3670133">chan</span>&nbsp;<span class="ident" id="3670138">time</span><span class="op" id="3670142">.</span><span class="ident" id="3670143">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670149">var</span>&nbsp;<span class="ident" id="3670153">respHeaderTimer</span>&nbsp;<span class="op" id="3670169">&lt;-</span><span class="keyword" id="3670171">chan</span>&nbsp;<span class="ident" id="3670176">time</span><span class="op" id="3670180">.</span><span class="ident" id="3670181">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="3670186">WaitResponse</span><span class="op" id="3670198">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670201">for</span>&nbsp;<span class="op" id="3670205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670209">select</span>&nbsp;<span class="op" id="3670216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670220">case</span>&nbsp;<span class="ident" id="3670225">err</span>&nbsp;<span class="op" id="3670229">:=</span>&nbsp;<span class="op" id="3670232">&lt;-</span><span class="ident" id="3670234">writeErrCh</span><span class="op" id="3670244">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670249">if</span>&nbsp;<span class="ident" id="3670252">err</span>&nbsp;<span class="op" id="3670256">!=</span>&nbsp;<span class="builtintype" id="3670259">nil</span>&nbsp;<span class="op" id="3670263">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670269">re</span>&nbsp;<span class="op" id="3670272">=</span>&nbsp;<span class="ident" id="3670274">responseAndError</span><span class="op" id="3670290">{</span><span class="builtintype" id="3670291">nil</span><span class="op" id="3670294">,</span>&nbsp;<span class="ident" id="3670296">err</span><span class="op" id="3670299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670305">pc</span><span class="op" id="3670307">.</span><span class="builtinfunc" id="3670308">close</span><span class="op" id="3670313">(</span><span class="op" id="3670314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670320">break</span>&nbsp;<span class="ident" id="3670326">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3670342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670347">if</span>&nbsp;<span class="ident" id="3670350">d</span>&nbsp;<span class="op" id="3670352">:=</span>&nbsp;<span class="ident" id="3670355">pc</span><span class="op" id="3670357">.</span><span class="ident" id="3670358">t</span><span class="op" id="3670359">.</span><span class="ident" id="3670360">ResponseHeaderTimeout</span><span class="op" id="3670381">;</span>&nbsp;<span class="ident" id="3670383">d</span>&nbsp;<span class="op" id="3670385">&gt;</span>&nbsp;<span class="num" id="3670387">0</span>&nbsp;<span class="op" id="3670389">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670395">respHeaderTimer</span>&nbsp;<span class="op" id="3670411">=</span>&nbsp;<span class="ident" id="3670413">time</span><span class="op" id="3670417">.</span><span class="ident" id="3670418">After</span><span class="op" id="3670423">(</span><span class="ident" id="3670424">d</span><span class="op" id="3670425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3670430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670434">case</span>&nbsp;<span class="op" id="3670439">&lt;-</span><span class="ident" id="3670441">pconnDeadCh</span><span class="op" id="3670452">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670457">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670510">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670570">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670627">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670681">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670740">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670798">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670855">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670889">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670895">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670960">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671016">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671059">pconnDeadCh</span>&nbsp;<span class="op" id="3671071">=</span>&nbsp;<span class="builtintype" id="3671073">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671107">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671128">failTicker</span>&nbsp;<span class="op" id="3671139">=</span>&nbsp;<span class="ident" id="3671141">time</span><span class="op" id="3671145">.</span><span class="ident" id="3671146">After</span><span class="op" id="3671151">(</span><span class="num" id="3671152">100</span>&nbsp;<span class="op" id="3671156">*</span>&nbsp;<span class="ident" id="3671158">time</span><span class="op" id="3671162">.</span><span class="ident" id="3671163">Millisecond</span><span class="op" id="3671174">)</span>&nbsp;<span class="comment" id="3671176">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671213">case</span>&nbsp;<span class="op" id="3671218">&lt;-</span><span class="ident" id="3671220">failTicker</span><span class="op" id="3671230">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671235">re</span>&nbsp;<span class="op" id="3671238">=</span>&nbsp;<span class="ident" id="3671240">responseAndError</span><span class="op" id="3671256">{</span><span class="ident" id="3671257">err</span><span class="op" id="3671260">:</span>&nbsp;<span class="ident" id="3671262">errClosed</span><span class="op" id="3671271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671276">break</span>&nbsp;<span class="ident" id="3671282">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671297">case</span>&nbsp;<span class="op" id="3671302">&lt;-</span><span class="ident" id="3671304">respHeaderTimer</span><span class="op" id="3671319">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671324">pc</span><span class="op" id="3671326">.</span><span class="builtinfunc" id="3671327">close</span><span class="op" id="3671332">(</span><span class="op" id="3671333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671338">re</span>&nbsp;<span class="op" id="3671341">=</span>&nbsp;<span class="ident" id="3671343">responseAndError</span><span class="op" id="3671359">{</span><span class="ident" id="3671360">err</span><span class="op" id="3671363">:</span>&nbsp;<span class="ident" id="3671365">errTimeout</span><span class="op" id="3671375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671380">break</span>&nbsp;<span class="ident" id="3671386">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671401">case</span>&nbsp;<span class="ident" id="3671406">re</span>&nbsp;<span class="op" id="3671409">=</span>&nbsp;<span class="op" id="3671411">&lt;-</span><span class="ident" id="3671413">resc</span><span class="op" id="3671417">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671422">break</span>&nbsp;<span class="ident" id="3671428">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3671443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3671446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671450">pc</span><span class="op" id="3671452">.</span><span class="ident" id="3671453">lk</span><span class="op" id="3671455">.</span><span class="ident" id="3671456">Lock</span><span class="op" id="3671460">(</span><span class="op" id="3671461">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671464">pc</span><span class="op" id="3671466">.</span><span class="ident" id="3671467">numExpectedResponses</span><span class="op" id="3671487">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671491">pc</span><span class="op" id="3671493">.</span><span class="ident" id="3671494">lk</span><span class="op" id="3671496">.</span><span class="ident" id="3671497">Unlock</span><span class="op" id="3671503">(</span><span class="op" id="3671504">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671508">if</span>&nbsp;<span class="ident" id="3671511">re</span><span class="op" id="3671513">.</span><span class="ident" id="3671514">err</span>&nbsp;<span class="op" id="3671518">!=</span>&nbsp;<span class="builtintype" id="3671521">nil</span>&nbsp;<span class="op" id="3671525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671529">pc</span><span class="op" id="3671531">.</span><span class="ident" id="3671532">t</span><span class="op" id="3671533">.</span><span class="ident" id="3671534">setReqCanceler</span><span class="op" id="3671548">(</span><span class="ident" id="3671549">req</span><span class="op" id="3671552">.</span><span class="ident" id="3671553">Request</span><span class="op" id="3671560">,</span>&nbsp;<span class="builtintype" id="3671562">nil</span><span class="op" id="3671565">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3671568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671571">return</span>&nbsp;<span class="ident" id="3671578">re</span><span class="op" id="3671580">.</span><span class="ident" id="3671581">res</span><span class="op" id="3671584">,</span>&nbsp;<span class="ident" id="3671586">re</span><span class="op" id="3671588">.</span><span class="ident" id="3671589">err</span><br>
<span class="lineno"></span><span class="op" id="3671593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3671596">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="3671661">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="3671726">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="3671776">func</span>&nbsp;<span class="op" id="3671781">(</span><span class="ident" id="3671782">pc</span>&nbsp;<span class="op" id="3671785">*</span><span class="ident" id="3671786">persistConn</span><span class="op" id="3671797">)</span>&nbsp;<span class="ident" id="3671799">markBroken</span><span class="op" id="3671809">(</span><span class="op" id="3671810">)</span>&nbsp;<span class="op" id="3671812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671815">pc</span><span class="op" id="3671817">.</span><span class="ident" id="3671818">lk</span><span class="op" id="3671820">.</span><span class="ident" id="3671821">Lock</span><span class="op" id="3671825">(</span><span class="op" id="3671826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671829">defer</span>&nbsp;<span class="ident" id="3671835">pc</span><span class="op" id="3671837">.</span><span class="ident" id="3671838">lk</span><span class="op" id="3671840">.</span><span class="ident" id="3671841">Unlock</span><span class="op" id="3671847">(</span><span class="op" id="3671848">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671851">pc</span><span class="op" id="3671853">.</span><span class="ident" id="3671854">broken</span>&nbsp;<span class="op" id="3671861">=</span>&nbsp;<span class="builtintype" id="3671863">true</span><br>
<span class="lineno"></span><span class="op" id="3671868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3671871">func</span>&nbsp;<span class="op" id="3671876">(</span><span class="ident" id="3671877">pc</span>&nbsp;<span class="op" id="3671880">*</span><span class="ident" id="3671881">persistConn</span><span class="op" id="3671892">)</span>&nbsp;<span class="builtinfunc" id="3671894">close</span><span class="op" id="3671899">(</span><span class="op" id="3671900">)</span>&nbsp;<span class="op" id="3671902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671905">pc</span><span class="op" id="3671907">.</span><span class="ident" id="3671908">lk</span><span class="op" id="3671910">.</span><span class="ident" id="3671911">Lock</span><span class="op" id="3671915">(</span><span class="op" id="3671916">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671919">defer</span>&nbsp;<span class="ident" id="3671925">pc</span><span class="op" id="3671927">.</span><span class="ident" id="3671928">lk</span><span class="op" id="3671930">.</span><span class="ident" id="3671931">Unlock</span><span class="op" id="3671937">(</span><span class="op" id="3671938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671941">pc</span><span class="op" id="3671943">.</span><span class="ident" id="3671944">closeLocked</span><span class="op" id="3671955">(</span><span class="op" id="3671956">)</span><br>
<span class="lineno"></span><span class="op" id="3671958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3671961">func</span>&nbsp;<span class="op" id="3671966">(</span><span class="ident" id="3671967">pc</span>&nbsp;<span class="op" id="3671970">*</span><span class="ident" id="3671971">persistConn</span><span class="op" id="3671982">)</span>&nbsp;<span class="ident" id="3671984">closeLocked</span><span class="op" id="3671995">(</span><span class="op" id="3671996">)</span>&nbsp;<span class="op" id="3671998">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672001">pc</span><span class="op" id="3672003">.</span><span class="ident" id="3672004">broken</span>&nbsp;<span class="op" id="3672011">=</span>&nbsp;<span class="builtintype" id="3672013">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672019">if</span>&nbsp;<span class="op" id="3672022">!</span><span class="ident" id="3672023">pc</span><span class="op" id="3672025">.</span><span class="ident" id="3672026">closed</span>&nbsp;<span class="op" id="3672033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672037">pc</span><span class="op" id="3672039">.</span><span class="ident" id="3672040">conn</span><span class="op" id="3672044">.</span><span class="ident" id="3672045">Close</span><span class="op" id="3672050">(</span><span class="op" id="3672051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672055">pc</span><span class="op" id="3672057">.</span><span class="ident" id="3672058">closed</span>&nbsp;<span class="op" id="3672065">=</span>&nbsp;<span class="builtintype" id="3672067">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3672074">close</span><span class="op" id="3672079">(</span><span class="ident" id="3672080">pc</span><span class="op" id="3672082">.</span><span class="ident" id="3672083">closech</span><span class="op" id="3672090">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3672093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672096">pc</span><span class="op" id="3672098">.</span><span class="ident" id="3672099">mutateHeaderFunc</span>&nbsp;<span class="op" id="3672116">=</span>&nbsp;<span class="builtintype" id="3672118">nil</span><br>
<span class="lineno"></span><span class="op" id="3672122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3672125">var</span>&nbsp;<span class="ident" id="3672129">portMap</span>&nbsp;<span class="op" id="3672137">=</span>&nbsp;<span class="keyword" id="3672139">map</span><span class="op" id="3672142">[</span><span class="builtintype" id="3672143">string</span><span class="op" id="3672149">]</span><span class="builtintype" id="3672150">string</span><span class="op" id="3672156">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3672159">&#34;http&#34;</span><span class="op" id="3672165">:</span>&nbsp;&nbsp;<span class="string" id="3672168">&#34;80&#34;</span><span class="op" id="3672172">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3672175">&#34;https&#34;</span><span class="op" id="3672182">:</span>&nbsp;<span class="string" id="3672184">&#34;443&#34;</span><span class="op" id="3672189">,</span><br>
<span class="lineno"></span><span class="op" id="3672191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3672194">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="3672261">func</span>&nbsp;<span class="ident" id="3672266">canonicalAddr</span><span class="op" id="3672279">(</span><span class="ident" id="3672280">url</span>&nbsp;<span class="op" id="3672284">*</span><span class="ident" id="3672285">url</span><span class="op" id="3672288">.</span><span class="ident" id="3672289">URL</span><span class="op" id="3672292">)</span>&nbsp;<span class="builtintype" id="3672294">string</span>&nbsp;<span class="op" id="3672301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672304">addr</span>&nbsp;<span class="op" id="3672309">:=</span>&nbsp;<span class="ident" id="3672312">url</span><span class="op" id="3672315">.</span><span class="ident" id="3672316">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672322">if</span>&nbsp;<span class="op" id="3672325">!</span><span class="ident" id="3672326">hasPort</span><span class="op" id="3672333">(</span><span class="ident" id="3672334">addr</span><span class="op" id="3672338">)</span>&nbsp;<span class="op" id="3672340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672344">return</span>&nbsp;<span class="ident" id="3672351">addr</span>&nbsp;<span class="op" id="3672356">+</span>&nbsp;<span class="string" id="3672358">&#34;:&#34;</span>&nbsp;<span class="op" id="3672362">+</span>&nbsp;<span class="ident" id="3672364">portMap</span><span class="op" id="3672371">[</span><span class="ident" id="3672372">url</span><span class="op" id="3672375">.</span><span class="ident" id="3672376">Scheme</span><span class="op" id="3672382">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3672385">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672388">return</span>&nbsp;<span class="ident" id="3672395">addr</span><br>
<span class="lineno"></span><span class="op" id="3672400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3672403">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="3672472">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="3672541">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="3672607">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3672672">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3672720">type</span>&nbsp;<span class="ident" id="3672725">bodyEOFSignal</span>&nbsp;<span class="keyword" id="3672739">struct</span>&nbsp;<span class="op" id="3672746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672749">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672762">io</span><span class="op" id="3672764">.</span><span class="ident" id="3672765">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672777">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672790">sync</span><span class="op" id="3672794">.</span><span class="ident" id="3672795">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3672803">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672833">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3672846">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3672859">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672893">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3672906">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3672919">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672941">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672954">func</span><span class="op" id="3672958">(</span><span class="builtintype" id="3672959">error</span><span class="op" id="3672964">)</span>&nbsp;&nbsp;<span class="comment" id="3672967">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673004">earlyCloseFn</span>&nbsp;<span class="keyword" id="3673017">func</span><span class="op" id="3673021">(</span><span class="op" id="3673022">)</span>&nbsp;<span class="builtintype" id="3673024">error</span>&nbsp;<span class="comment" id="3673030">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="3673081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3673084">func</span>&nbsp;<span class="op" id="3673089">(</span><span class="ident" id="3673090">es</span>&nbsp;<span class="op" id="3673093">*</span><span class="ident" id="3673094">bodyEOFSignal</span><span class="op" id="3673107">)</span>&nbsp;<span class="ident" id="3673109">Read</span><span class="op" id="3673113">(</span><span class="ident" id="3673114">p</span>&nbsp;<span class="op" id="3673116">[</span><span class="op" id="3673117">]</span><span class="builtintype" id="3673118">byte</span><span class="op" id="3673122">)</span>&nbsp;<span class="op" id="3673124">(</span><span class="ident" id="3673125">n</span>&nbsp;<span class="builtintype" id="3673127">int</span><span class="op" id="3673130">,</span>&nbsp;<span class="ident" id="3673132">err</span>&nbsp;<span class="builtintype" id="3673136">error</span><span class="op" id="3673141">)</span>&nbsp;<span class="op" id="3673143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673146">es</span><span class="op" id="3673148">.</span><span class="ident" id="3673149">mu</span><span class="op" id="3673151">.</span><span class="ident" id="3673152">Lock</span><span class="op" id="3673156">(</span><span class="op" id="3673157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673160">closed</span><span class="op" id="3673166">,</span>&nbsp;<span class="ident" id="3673168">rerr</span>&nbsp;<span class="op" id="3673173">:=</span>&nbsp;<span class="ident" id="3673176">es</span><span class="op" id="3673178">.</span><span class="ident" id="3673179">closed</span><span class="op" id="3673185">,</span>&nbsp;<span class="ident" id="3673187">es</span><span class="op" id="3673189">.</span><span class="ident" id="3673190">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673196">es</span><span class="op" id="3673198">.</span><span class="ident" id="3673199">mu</span><span class="op" id="3673201">.</span><span class="ident" id="3673202">Unlock</span><span class="op" id="3673208">(</span><span class="op" id="3673209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673212">if</span>&nbsp;<span class="ident" id="3673215">closed</span>&nbsp;<span class="op" id="3673222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673226">return</span>&nbsp;<span class="num" id="3673233">0</span><span class="op" id="3673234">,</span>&nbsp;<span class="ident" id="3673236">errors</span><span class="op" id="3673242">.</span><span class="ident" id="3673243">New</span><span class="op" id="3673246">(</span><span class="string" id="3673247">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="3673283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3673286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673289">if</span>&nbsp;<span class="ident" id="3673292">rerr</span>&nbsp;<span class="op" id="3673297">!=</span>&nbsp;<span class="builtintype" id="3673300">nil</span>&nbsp;<span class="op" id="3673304">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673308">return</span>&nbsp;<span class="num" id="3673315">0</span><span class="op" id="3673316">,</span>&nbsp;<span class="ident" id="3673318">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3673324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673328">n</span><span class="op" id="3673329">,</span>&nbsp;<span class="ident" id="3673331">err</span>&nbsp;<span class="op" id="3673335">=</span>&nbsp;<span class="ident" id="3673337">es</span><span class="op" id="3673339">.</span><span class="ident" id="3673340">body</span><span class="op" id="3673344">.</span><span class="ident" id="3673345">Read</span><span class="op" id="3673349">(</span><span class="ident" id="3673350">p</span><span class="op" id="3673351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673354">if</span>&nbsp;<span class="ident" id="3673357">err</span>&nbsp;<span class="op" id="3673361">!=</span>&nbsp;<span class="builtintype" id="3673364">nil</span>&nbsp;<span class="op" id="3673368">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673372">es</span><span class="op" id="3673374">.</span><span class="ident" id="3673375">mu</span><span class="op" id="3673377">.</span><span class="ident" id="3673378">Lock</span><span class="op" id="3673382">(</span><span class="op" id="3673383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673387">defer</span>&nbsp;<span class="ident" id="3673393">es</span><span class="op" id="3673395">.</span><span class="ident" id="3673396">mu</span><span class="op" id="3673398">.</span><span class="ident" id="3673399">Unlock</span><span class="op" id="3673405">(</span><span class="op" id="3673406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673410">if</span>&nbsp;<span class="ident" id="3673413">es</span><span class="op" id="3673415">.</span><span class="ident" id="3673416">rerr</span>&nbsp;<span class="op" id="3673421">==</span>&nbsp;<span class="builtintype" id="3673424">nil</span>&nbsp;<span class="op" id="3673428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673433">es</span><span class="op" id="3673435">.</span><span class="ident" id="3673436">rerr</span>&nbsp;<span class="op" id="3673441">=</span>&nbsp;<span class="ident" id="3673443">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3673449">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673453">es</span><span class="op" id="3673455">.</span><span class="ident" id="3673456">condfn</span><span class="op" id="3673462">(</span><span class="ident" id="3673463">err</span><span class="op" id="3673466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3673469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673472">return</span><br>
<span class="lineno"></span><span class="op" id="3673479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="3673482">func</span>&nbsp;<span class="op" id="3673487">(</span><span class="ident" id="3673488">es</span>&nbsp;<span class="op" id="3673491">*</span><span class="ident" id="3673492">bodyEOFSignal</span><span class="op" id="3673505">)</span>&nbsp;<span class="ident" id="3673507">Close</span><span class="op" id="3673512">(</span><span class="op" id="3673513">)</span>&nbsp;<span class="builtintype" id="3673515">error</span>&nbsp;<span class="op" id="3673521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673524">es</span><span class="op" id="3673526">.</span><span class="ident" id="3673527">mu</span><span class="op" id="3673529">.</span><span class="ident" id="3673530">Lock</span><span class="op" id="3673534">(</span><span class="op" id="3673535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673538">defer</span>&nbsp;<span class="ident" id="3673544">es</span><span class="op" id="3673546">.</span><span class="ident" id="3673547">mu</span><span class="op" id="3673549">.</span><span class="ident" id="3673550">Unlock</span><span class="op" id="3673556">(</span><span class="op" id="3673557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673560">if</span>&nbsp;<span class="ident" id="3673563">es</span><span class="op" id="3673565">.</span><span class="ident" id="3673566">closed</span>&nbsp;<span class="op" id="3673573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673577">return</span>&nbsp;<span class="builtintype" id="3673584">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3673589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673592">es</span><span class="op" id="3673594">.</span><span class="ident" id="3673595">closed</span>&nbsp;<span class="op" id="3673602">=</span>&nbsp;<span class="builtintype" id="3673604">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673610">if</span>&nbsp;<span class="ident" id="3673613">es</span><span class="op" id="3673615">.</span><span class="ident" id="3673616">earlyCloseFn</span>&nbsp;<span class="op" id="3673629">!=</span>&nbsp;<span class="builtintype" id="3673632">nil</span>&nbsp;<span class="op" id="3673636">&amp;&amp;</span>&nbsp;<span class="ident" id="3673639">es</span><span class="op" id="3673641">.</span><span class="ident" id="3673642">rerr</span>&nbsp;<span class="op" id="3673647">!=</span>&nbsp;<span class="ident" id="3673650">io</span><span class="op" id="3673652">.</span><span class="ident" id="3673653">EOF</span>&nbsp;<span class="op" id="3673657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673661">return</span>&nbsp;<span class="ident" id="3673668">es</span><span class="op" id="3673670">.</span><span class="ident" id="3673671">earlyCloseFn</span><span class="op" id="3673683">(</span><span class="op" id="3673684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3673687">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673690">err</span>&nbsp;<span class="op" id="3673694">:=</span>&nbsp;<span class="ident" id="3673697">es</span><span class="op" id="3673699">.</span><span class="ident" id="3673700">body</span><span class="op" id="3673704">.</span><span class="ident" id="3673705">Close</span><span class="op" id="3673710">(</span><span class="op" id="3673711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673714">es</span><span class="op" id="3673716">.</span><span class="ident" id="3673717">condfn</span><span class="op" id="3673723">(</span><span class="ident" id="3673724">err</span><span class="op" id="3673727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673730">return</span>&nbsp;<span class="ident" id="3673737">err</span><br>
<span class="lineno"></span><span class="op" id="3673741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="3673744">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3673771">func</span>&nbsp;<span class="op" id="3673776">(</span><span class="ident" id="3673777">es</span>&nbsp;<span class="op" id="3673780">*</span><span class="ident" id="3673781">bodyEOFSignal</span><span class="op" id="3673794">)</span>&nbsp;<span class="ident" id="3673796">condfn</span><span class="op" id="3673802">(</span><span class="ident" id="3673803">err</span>&nbsp;<span class="builtintype" id="3673807">error</span><span class="op" id="3673812">)</span>&nbsp;<span class="op" id="3673814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673817">if</span>&nbsp;<span class="ident" id="3673820">es</span><span class="op" id="3673822">.</span><span class="ident" id="3673823">fn</span>&nbsp;<span class="op" id="3673826">==</span>&nbsp;<span class="builtintype" id="3673829">nil</span>&nbsp;<span class="op" id="3673833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673837">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3673845">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673848">if</span>&nbsp;<span class="ident" id="3673851">err</span>&nbsp;<span class="op" id="3673855">==</span>&nbsp;<span class="ident" id="3673858">io</span><span class="op" id="3673860">.</span><span class="ident" id="3673861">EOF</span>&nbsp;<span class="op" id="3673865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673869">err</span>&nbsp;<span class="op" id="3673873">=</span>&nbsp;<span class="builtintype" id="3673875">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3673880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673883">es</span><span class="op" id="3673885">.</span><span class="ident" id="3673886">fn</span><span class="op" id="3673888">(</span><span class="ident" id="3673889">err</span><span class="op" id="3673892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673895">es</span><span class="op" id="3673897">.</span><span class="ident" id="3673898">fn</span>&nbsp;<span class="op" id="3673901">=</span>&nbsp;<span class="builtintype" id="3673903">nil</span><br>
<span class="lineno">1230</span><span class="op" id="3673907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3673910">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="3673963">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="3674012">type</span>&nbsp;<span class="ident" id="3674017">gzipReader</span>&nbsp;<span class="keyword" id="3674028">struct</span>&nbsp;<span class="op" id="3674035">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674038">body</span>&nbsp;<span class="ident" id="3674043">io</span><span class="op" id="3674045">.</span><span class="ident" id="3674046">ReadCloser</span>&nbsp;<span class="comment" id="3674057">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674086">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3674091">io</span><span class="op" id="3674093">.</span><span class="ident" id="3674094">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3674105">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="3674139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3674142">func</span>&nbsp;<span class="op" id="3674147">(</span><span class="ident" id="3674148">gz</span>&nbsp;<span class="op" id="3674151">*</span><span class="ident" id="3674152">gzipReader</span><span class="op" id="3674162">)</span>&nbsp;<span class="ident" id="3674164">Read</span><span class="op" id="3674168">(</span><span class="ident" id="3674169">p</span>&nbsp;<span class="op" id="3674171">[</span><span class="op" id="3674172">]</span><span class="builtintype" id="3674173">byte</span><span class="op" id="3674177">)</span>&nbsp;<span class="op" id="3674179">(</span><span class="ident" id="3674180">n</span>&nbsp;<span class="builtintype" id="3674182">int</span><span class="op" id="3674185">,</span>&nbsp;<span class="ident" id="3674187">err</span>&nbsp;<span class="builtintype" id="3674191">error</span><span class="op" id="3674196">)</span>&nbsp;<span class="op" id="3674198">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674201">if</span>&nbsp;<span class="ident" id="3674204">gz</span><span class="op" id="3674206">.</span><span class="ident" id="3674207">zr</span>&nbsp;<span class="op" id="3674210">==</span>&nbsp;<span class="builtintype" id="3674213">nil</span>&nbsp;<span class="op" id="3674217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674221">gz</span><span class="op" id="3674223">.</span><span class="ident" id="3674224">zr</span><span class="op" id="3674226">,</span>&nbsp;<span class="ident" id="3674228">err</span>&nbsp;<span class="op" id="3674232">=</span>&nbsp;<span class="ident" id="3674234">gzip</span><span class="op" id="3674238">.</span><span class="ident" id="3674239">NewReader</span><span class="op" id="3674248">(</span><span class="ident" id="3674249">gz</span><span class="op" id="3674251">.</span><span class="ident" id="3674252">body</span><span class="op" id="3674256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674260">if</span>&nbsp;<span class="ident" id="3674263">err</span>&nbsp;<span class="op" id="3674267">!=</span>&nbsp;<span class="builtintype" id="3674270">nil</span>&nbsp;<span class="op" id="3674274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674279">return</span>&nbsp;<span class="num" id="3674286">0</span><span class="op" id="3674287">,</span>&nbsp;<span class="ident" id="3674289">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3674295">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3674298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674301">return</span>&nbsp;<span class="ident" id="3674308">gz</span><span class="op" id="3674310">.</span><span class="ident" id="3674311">zr</span><span class="op" id="3674313">.</span><span class="ident" id="3674314">Read</span><span class="op" id="3674318">(</span><span class="ident" id="3674319">p</span><span class="op" id="3674320">)</span><br>
<span class="lineno"></span><span class="op" id="3674322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3674325">func</span>&nbsp;<span class="op" id="3674330">(</span><span class="ident" id="3674331">gz</span>&nbsp;<span class="op" id="3674334">*</span><span class="ident" id="3674335">gzipReader</span><span class="op" id="3674345">)</span>&nbsp;<span class="ident" id="3674347">Close</span><span class="op" id="3674352">(</span><span class="op" id="3674353">)</span>&nbsp;<span class="builtintype" id="3674355">error</span>&nbsp;<span class="op" id="3674361">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674364">return</span>&nbsp;<span class="ident" id="3674371">gz</span><span class="op" id="3674373">.</span><span class="ident" id="3674374">body</span><span class="op" id="3674378">.</span><span class="ident" id="3674379">Close</span><span class="op" id="3674384">(</span><span class="op" id="3674385">)</span><br>
<span class="lineno"></span><span class="op" id="3674387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3674390">type</span>&nbsp;<span class="ident" id="3674395">readerAndCloser</span>&nbsp;<span class="keyword" id="3674411">struct</span>&nbsp;<span class="op" id="3674418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674421">io</span><span class="op" id="3674423">.</span><span class="ident" id="3674424">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674432">io</span><span class="op" id="3674434">.</span><span class="ident" id="3674435">Closer</span><br>
<span class="lineno"></span><span class="op" id="3674442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3674445">type</span>&nbsp;<span class="ident" id="3674450">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="3674475">struct</span><span class="op" id="3674481">{</span><span class="op" id="3674482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="3674485">func</span>&nbsp;<span class="op" id="3674490">(</span><span class="ident" id="3674491">tlsHandshakeTimeoutError</span><span class="op" id="3674515">)</span>&nbsp;<span class="ident" id="3674517">Timeout</span><span class="op" id="3674524">(</span><span class="op" id="3674525">)</span>&nbsp;<span class="builtintype" id="3674527">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3674534">{</span>&nbsp;<span class="keyword" id="3674536">return</span>&nbsp;<span class="builtintype" id="3674543">true</span>&nbsp;<span class="op" id="3674548">}</span><br>
<span class="lineno"></span><span class="keyword" id="3674550">func</span>&nbsp;<span class="op" id="3674555">(</span><span class="ident" id="3674556">tlsHandshakeTimeoutError</span><span class="op" id="3674580">)</span>&nbsp;<span class="ident" id="3674582">Temporary</span><span class="op" id="3674591">(</span><span class="op" id="3674592">)</span>&nbsp;<span class="builtintype" id="3674594">bool</span>&nbsp;<span class="op" id="3674599">{</span>&nbsp;<span class="keyword" id="3674601">return</span>&nbsp;<span class="builtintype" id="3674608">true</span>&nbsp;<span class="op" id="3674613">}</span><br>
<span class="lineno"></span><span class="keyword" id="3674615">func</span>&nbsp;<span class="op" id="3674620">(</span><span class="ident" id="3674621">tlsHandshakeTimeoutError</span><span class="op" id="3674645">)</span>&nbsp;<span class="ident" id="3674647">Error</span><span class="op" id="3674652">(</span><span class="op" id="3674653">)</span>&nbsp;<span class="builtintype" id="3674655">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3674664">{</span>&nbsp;<span class="keyword" id="3674666">return</span>&nbsp;<span class="string" id="3674673">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="3674707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3674710">type</span>&nbsp;<span class="ident" id="3674715">noteEOFReader</span>&nbsp;<span class="keyword" id="3674729">struct</span>&nbsp;<span class="op" id="3674736">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674739">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674746">io</span><span class="op" id="3674748">.</span><span class="ident" id="3674749">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674757">sawEOF</span>&nbsp;<span class="op" id="3674764">*</span><span class="builtintype" id="3674765">bool</span><br>
<span class="lineno"></span><span class="op" id="3674770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3674773">func</span>&nbsp;<span class="op" id="3674778">(</span><span class="ident" id="3674779">nr</span>&nbsp;<span class="ident" id="3674782">noteEOFReader</span><span class="op" id="3674795">)</span>&nbsp;<span class="ident" id="3674797">Read</span><span class="op" id="3674801">(</span><span class="ident" id="3674802">p</span>&nbsp;<span class="op" id="3674804">[</span><span class="op" id="3674805">]</span><span class="builtintype" id="3674806">byte</span><span class="op" id="3674810">)</span>&nbsp;<span class="op" id="3674812">(</span><span class="ident" id="3674813">n</span>&nbsp;<span class="builtintype" id="3674815">int</span><span class="op" id="3674818">,</span>&nbsp;<span class="ident" id="3674820">err</span>&nbsp;<span class="builtintype" id="3674824">error</span><span class="op" id="3674829">)</span>&nbsp;<span class="op" id="3674831">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674834">n</span><span class="op" id="3674835">,</span>&nbsp;<span class="ident" id="3674837">err</span>&nbsp;<span class="op" id="3674841">=</span>&nbsp;<span class="ident" id="3674843">nr</span><span class="op" id="3674845">.</span><span class="ident" id="3674846">r</span><span class="op" id="3674847">.</span><span class="ident" id="3674848">Read</span><span class="op" id="3674852">(</span><span class="ident" id="3674853">p</span><span class="op" id="3674854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674857">if</span>&nbsp;<span class="ident" id="3674860">err</span>&nbsp;<span class="op" id="3674864">==</span>&nbsp;<span class="ident" id="3674867">io</span><span class="op" id="3674869">.</span><span class="ident" id="3674870">EOF</span>&nbsp;<span class="op" id="3674874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3674878">*</span><span class="ident" id="3674879">nr</span><span class="op" id="3674881">.</span><span class="ident" id="3674882">sawEOF</span>&nbsp;<span class="op" id="3674889">=</span>&nbsp;<span class="builtintype" id="3674891">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3674897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674900">return</span><br>
<span class="lineno">1275</span><span class="op" id="3674907">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
