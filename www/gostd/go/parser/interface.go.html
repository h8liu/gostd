<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/parser</h2>
<ul>
<li><a href="/gostd/go/parser/error_test.go.html">error_test.go</a></li>
<li><a href="/gostd/go/parser/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/parser/interface.go.html">interface.go</a></li>
<li><a href="/gostd/go/parser/parser.go.html">parser.go</a></li>
<li><a href="/gostd/go/parser/parser_test.go.html">parser_test.go</a></li>
<li><a href="/gostd/go/parser/performance_test.go.html">performance_test.go</a></li>
<li><a href="/gostd/go/parser/short_test.go.html">short_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5657568">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5657623">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5657677">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5657728">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;exported&nbsp;entry&nbsp;points&nbsp;for&nbsp;invoking&nbsp;the&nbsp;parser.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5657802">package</span>&nbsp;<span class="ident" id="5657810">parser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5657818">import</span>&nbsp;<span class="op" id="5657825">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5657828">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5657837">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5657847">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5657857">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5657869">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5657875">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5657888">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5657894">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5657911">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5657921">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="5657924">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;readSource&nbsp;converts&nbsp;src&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;possible;</span><br>
<span class="lineno"></span><span class="comment" id="5657991">//&nbsp;otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error.&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;readSource&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5658059">//&nbsp;the&nbsp;result&nbsp;of&nbsp;reading&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="5658116">//</span><br>
<span class="lineno">25</span><span class="keyword" id="5658119">func</span>&nbsp;<span class="ident" id="5658124">readSource</span><span class="op" id="5658134">(</span><span class="ident" id="5658135">filename</span>&nbsp;<span class="builtintype" id="5658144">string</span><span class="op" id="5658150">,</span>&nbsp;<span class="ident" id="5658152">src</span>&nbsp;<span class="keyword" id="5658156">interface</span><span class="op" id="5658165">{</span><span class="op" id="5658166">}</span><span class="op" id="5658167">)</span>&nbsp;<span class="op" id="5658169">(</span><span class="op" id="5658170">[</span><span class="op" id="5658171">]</span><span class="builtintype" id="5658172">byte</span><span class="op" id="5658176">,</span>&nbsp;<span class="builtintype" id="5658178">error</span><span class="op" id="5658183">)</span>&nbsp;<span class="op" id="5658185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658188">if</span>&nbsp;<span class="ident" id="5658191">src</span>&nbsp;<span class="op" id="5658195">!=</span>&nbsp;<span class="ident" id="5658198">nil</span>&nbsp;<span class="op" id="5658202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658206">switch</span>&nbsp;<span class="ident" id="5658213">s</span>&nbsp;<span class="op" id="5658215">:=</span>&nbsp;<span class="ident" id="5658218">src</span><span class="op" id="5658221">.</span><span class="op" id="5658222">(</span><span class="keyword" id="5658223">type</span><span class="op" id="5658227">)</span>&nbsp;<span class="op" id="5658229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658233">case</span>&nbsp;<span class="builtintype" id="5658238">string</span><span class="op" id="5658244">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658249">return</span>&nbsp;<span class="op" id="5658256">[</span><span class="op" id="5658257">]</span><span class="builtintype" id="5658258">byte</span><span class="op" id="5658262">(</span><span class="ident" id="5658263">s</span><span class="op" id="5658264">)</span><span class="op" id="5658265">,</span>&nbsp;<span class="ident" id="5658267">nil</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658273">case</span>&nbsp;<span class="op" id="5658278">[</span><span class="op" id="5658279">]</span><span class="builtintype" id="5658280">byte</span><span class="op" id="5658284">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658289">return</span>&nbsp;<span class="ident" id="5658296">s</span><span class="op" id="5658297">,</span>&nbsp;<span class="ident" id="5658299">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658305">case</span>&nbsp;<span class="op" id="5658310">*</span><span class="ident" id="5658311">bytes</span><span class="op" id="5658316">.</span><span class="ident" id="5658317">Buffer</span><span class="op" id="5658323">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5658328">//&nbsp;is&nbsp;io.Reader,&nbsp;but&nbsp;src&nbsp;is&nbsp;already&nbsp;available&nbsp;in&nbsp;[]byte&nbsp;form</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658392">if</span>&nbsp;<span class="ident" id="5658395">s</span>&nbsp;<span class="op" id="5658397">!=</span>&nbsp;<span class="ident" id="5658400">nil</span>&nbsp;<span class="op" id="5658404">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658410">return</span>&nbsp;<span class="ident" id="5658417">s</span><span class="op" id="5658418">.</span><span class="ident" id="5658419">Bytes</span><span class="op" id="5658424">(</span><span class="op" id="5658425">)</span><span class="op" id="5658426">,</span>&nbsp;<span class="ident" id="5658428">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5658435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658439">case</span>&nbsp;<span class="ident" id="5658444">io</span><span class="op" id="5658446">.</span><span class="ident" id="5658447">Reader</span><span class="op" id="5658453">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658458">var</span>&nbsp;<span class="ident" id="5658462">buf</span>&nbsp;<span class="ident" id="5658466">bytes</span><span class="op" id="5658471">.</span><span class="ident" id="5658472">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658482">if</span>&nbsp;<span class="ident" id="5658485">_</span><span class="op" id="5658486">,</span>&nbsp;<span class="ident" id="5658488">err</span>&nbsp;<span class="op" id="5658492">:=</span>&nbsp;<span class="ident" id="5658495">io</span><span class="op" id="5658497">.</span><span class="ident" id="5658498">Copy</span><span class="op" id="5658502">(</span><span class="op" id="5658503">&amp;</span><span class="ident" id="5658504">buf</span><span class="op" id="5658507">,</span>&nbsp;<span class="ident" id="5658509">s</span><span class="op" id="5658510">)</span><span class="op" id="5658511">;</span>&nbsp;<span class="ident" id="5658513">err</span>&nbsp;<span class="op" id="5658517">!=</span>&nbsp;<span class="ident" id="5658520">nil</span>&nbsp;<span class="op" id="5658524">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658530">return</span>&nbsp;<span class="ident" id="5658537">nil</span><span class="op" id="5658540">,</span>&nbsp;<span class="ident" id="5658542">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5658549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658554">return</span>&nbsp;<span class="ident" id="5658561">buf</span><span class="op" id="5658564">.</span><span class="ident" id="5658565">Bytes</span><span class="op" id="5658570">(</span><span class="op" id="5658571">)</span><span class="op" id="5658572">,</span>&nbsp;<span class="ident" id="5658574">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5658580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658584">return</span>&nbsp;<span class="ident" id="5658591">nil</span><span class="op" id="5658594">,</span>&nbsp;<span class="ident" id="5658596">errors</span><span class="op" id="5658602">.</span><span class="ident" id="5658603">New</span><span class="op" id="5658606">(</span><span class="string" id="5658607">&#34;invalid&nbsp;source&#34;</span><span class="op" id="5658623">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5658626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5658629">return</span>&nbsp;<span class="ident" id="5658636">ioutil</span><span class="op" id="5658642">.</span><span class="ident" id="5658643">ReadFile</span><span class="op" id="5658651">(</span><span class="ident" id="5658652">filename</span><span class="op" id="5658660">)</span><br>
<span class="lineno"></span><span class="op" id="5658662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5658665">//&nbsp;A&nbsp;Mode&nbsp;value&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;flags&nbsp;(or&nbsp;0).</span><br>
<span class="lineno">50</span><span class="comment" id="5658707">//&nbsp;They&nbsp;control&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;code&nbsp;parsed&nbsp;and&nbsp;other&nbsp;optional</span><br>
<span class="lineno"></span><span class="comment" id="5658775">//&nbsp;parser&nbsp;functionality.</span><br>
<span class="lineno"></span><span class="comment" id="5658800">//</span><br>
<span class="lineno"></span><span class="keyword" id="5658803">type</span>&nbsp;<span class="ident" id="5658808">Mode</span>&nbsp;<span class="builtintype" id="5658813">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="5658819">const</span>&nbsp;<span class="op" id="5658825">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5658828">PackageClauseOnly</span>&nbsp;<span class="ident" id="5658846">Mode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5658863">=</span>&nbsp;<span class="num" id="5658865">1</span>&nbsp;<span class="op" id="5658867">&lt;&lt;</span>&nbsp;<span class="ident" id="5658870">iota</span>&nbsp;<span class="comment" id="5658875">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;package&nbsp;clause</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5658913">ImportsOnly</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5658960">//&nbsp;stop&nbsp;parsing&nbsp;after&nbsp;import&nbsp;declarations</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5659003">ParseComments</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659050">//&nbsp;parse&nbsp;comments&nbsp;and&nbsp;add&nbsp;them&nbsp;to&nbsp;AST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5659089">Trace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659136">//&nbsp;print&nbsp;a&nbsp;trace&nbsp;of&nbsp;parsed&nbsp;productions</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5659176">DeclarationErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659223">//&nbsp;report&nbsp;declaration&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5659253">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659300">//&nbsp;same&nbsp;as&nbsp;AllErrors,&nbsp;for&nbsp;backward-compatibility</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5659350">AllErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5659368">=</span>&nbsp;<span class="ident" id="5659370">SpuriousErrors</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5659397">//&nbsp;report&nbsp;all&nbsp;errors&nbsp;(not&nbsp;just&nbsp;the&nbsp;first&nbsp;10&nbsp;on&nbsp;different&nbsp;lines)</span><br>
<span class="lineno"></span><span class="op" id="5659461">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5659464">//&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;code&nbsp;of&nbsp;a&nbsp;single&nbsp;Go&nbsp;source&nbsp;file&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="5659539">//&nbsp;the&nbsp;corresponding&nbsp;ast.File&nbsp;node.&nbsp;The&nbsp;source&nbsp;code&nbsp;may&nbsp;be&nbsp;provided&nbsp;via</span><br>
<span class="lineno"></span><span class="comment" id="5659611">//&nbsp;the&nbsp;filename&nbsp;of&nbsp;the&nbsp;source&nbsp;file,&nbsp;or&nbsp;via&nbsp;the&nbsp;src&nbsp;parameter.</span><br>
<span class="lineno"></span><span class="comment" id="5659673">//</span><br>
<span class="lineno"></span><span class="comment" id="5659676">//&nbsp;If&nbsp;src&nbsp;!=&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;source&nbsp;from&nbsp;src&nbsp;and&nbsp;the&nbsp;filename&nbsp;is</span><br>
<span class="lineno">70</span><span class="comment" id="5659751">//&nbsp;only&nbsp;used&nbsp;when&nbsp;recording&nbsp;position&nbsp;information.&nbsp;The&nbsp;type&nbsp;of&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="5659826">//&nbsp;for&nbsp;the&nbsp;src&nbsp;parameter&nbsp;must&nbsp;be&nbsp;string,&nbsp;[]byte,&nbsp;or&nbsp;io.Reader.</span><br>
<span class="lineno"></span><span class="comment" id="5659889">//&nbsp;If&nbsp;src&nbsp;==&nbsp;nil,&nbsp;ParseFile&nbsp;parses&nbsp;the&nbsp;file&nbsp;specified&nbsp;by&nbsp;filename.</span><br>
<span class="lineno"></span><span class="comment" id="5659956">//</span><br>
<span class="lineno"></span><span class="comment" id="5659959">//&nbsp;The&nbsp;mode&nbsp;parameter&nbsp;controls&nbsp;the&nbsp;amount&nbsp;of&nbsp;source&nbsp;text&nbsp;parsed&nbsp;and&nbsp;other</span><br>
<span class="lineno">75</span><span class="comment" id="5660033">//&nbsp;optional&nbsp;parser&nbsp;functionality.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5660107">//&nbsp;file&nbsp;set&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="5660125">//</span><br>
<span class="lineno"></span><span class="comment" id="5660128">//&nbsp;If&nbsp;the&nbsp;source&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;the&nbsp;returned&nbsp;AST&nbsp;is&nbsp;nil&nbsp;and&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5660201">//&nbsp;indicates&nbsp;the&nbsp;specific&nbsp;failure.&nbsp;If&nbsp;the&nbsp;source&nbsp;was&nbsp;read&nbsp;but&nbsp;syntax</span><br>
<span class="lineno">80</span><span class="comment" id="5660270">//&nbsp;errors&nbsp;were&nbsp;found,&nbsp;the&nbsp;result&nbsp;is&nbsp;a&nbsp;partial&nbsp;AST&nbsp;(with&nbsp;ast.Bad*&nbsp;nodes</span><br>
<span class="lineno"></span><span class="comment" id="5660341">//&nbsp;representing&nbsp;the&nbsp;fragments&nbsp;of&nbsp;erroneous&nbsp;source&nbsp;code).&nbsp;Multiple&nbsp;errors</span><br>
<span class="lineno"></span><span class="comment" id="5660414">//&nbsp;are&nbsp;returned&nbsp;via&nbsp;a&nbsp;scanner.ErrorList&nbsp;which&nbsp;is&nbsp;sorted&nbsp;by&nbsp;file&nbsp;position.</span><br>
<span class="lineno"></span><span class="comment" id="5660488">//</span><br>
<span class="lineno"></span><span class="keyword" id="5660491">func</span>&nbsp;<span class="ident" id="5660496">ParseFile</span><span class="op" id="5660505">(</span><span class="ident" id="5660506">fset</span>&nbsp;<span class="op" id="5660511">*</span><span class="ident" id="5660512">token</span><span class="op" id="5660517">.</span><span class="ident" id="5660518">FileSet</span><span class="op" id="5660525">,</span>&nbsp;<span class="ident" id="5660527">filename</span>&nbsp;<span class="builtintype" id="5660536">string</span><span class="op" id="5660542">,</span>&nbsp;<span class="ident" id="5660544">src</span>&nbsp;<span class="keyword" id="5660548">interface</span><span class="op" id="5660557">{</span><span class="op" id="5660558">}</span><span class="op" id="5660559">,</span>&nbsp;<span class="ident" id="5660561">mode</span>&nbsp;<span class="ident" id="5660566">Mode</span><span class="op" id="5660570">)</span>&nbsp;<span class="op" id="5660572">(</span><span class="ident" id="5660573">f</span>&nbsp;<span class="op" id="5660575">*</span><span class="ident" id="5660576">ast</span><span class="op" id="5660579">.</span><span class="ident" id="5660580">File</span><span class="op" id="5660584">,</span>&nbsp;<span class="ident" id="5660586">err</span>&nbsp;<span class="builtintype" id="5660590">error</span><span class="op" id="5660595">)</span>&nbsp;<span class="op" id="5660597">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5660600">//&nbsp;get&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5660615">text</span><span class="op" id="5660619">,</span>&nbsp;<span class="ident" id="5660621">err</span>&nbsp;<span class="op" id="5660625">:=</span>&nbsp;<span class="ident" id="5660628">readSource</span><span class="op" id="5660638">(</span><span class="ident" id="5660639">filename</span><span class="op" id="5660647">,</span>&nbsp;<span class="ident" id="5660649">src</span><span class="op" id="5660652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5660655">if</span>&nbsp;<span class="ident" id="5660658">err</span>&nbsp;<span class="op" id="5660662">!=</span>&nbsp;<span class="ident" id="5660665">nil</span>&nbsp;<span class="op" id="5660669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5660673">return</span>&nbsp;<span class="ident" id="5660680">nil</span><span class="op" id="5660683">,</span>&nbsp;<span class="ident" id="5660685">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5660690">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5660694">var</span>&nbsp;<span class="ident" id="5660698">p</span>&nbsp;<span class="ident" id="5660700">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5660708">defer</span>&nbsp;<span class="keyword" id="5660714">func</span><span class="op" id="5660718">(</span><span class="op" id="5660719">)</span>&nbsp;<span class="op" id="5660721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5660725">if</span>&nbsp;<span class="ident" id="5660728">e</span>&nbsp;<span class="op" id="5660730">:=</span>&nbsp;<span class="builtinfunc" id="5660733">recover</span><span class="op" id="5660740">(</span><span class="op" id="5660741">)</span><span class="op" id="5660742">;</span>&nbsp;<span class="ident" id="5660744">e</span>&nbsp;<span class="op" id="5660746">!=</span>&nbsp;<span class="ident" id="5660749">nil</span>&nbsp;<span class="op" id="5660753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5660758">_</span>&nbsp;<span class="op" id="5660760">=</span>&nbsp;<span class="ident" id="5660762">e</span><span class="op" id="5660763">.</span><span class="op" id="5660764">(</span><span class="ident" id="5660765">bailout</span><span class="op" id="5660772">)</span>&nbsp;<span class="comment" id="5660774">//&nbsp;re-panics&nbsp;if&nbsp;it&#39;s&nbsp;not&nbsp;a&nbsp;bailout</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5660811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5660816">//&nbsp;set&nbsp;result&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5660839">if</span>&nbsp;<span class="ident" id="5660842">f</span>&nbsp;<span class="op" id="5660844">==</span>&nbsp;<span class="ident" id="5660847">nil</span>&nbsp;<span class="op" id="5660851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5660856">//&nbsp;source&nbsp;is&nbsp;not&nbsp;a&nbsp;valid&nbsp;Go&nbsp;source&nbsp;file&nbsp;-&nbsp;satisfy</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5660909">//&nbsp;ParseFile&nbsp;API&nbsp;and&nbsp;return&nbsp;a&nbsp;valid&nbsp;(but)&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5660960">//&nbsp;*ast.File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5660976">f</span>&nbsp;<span class="op" id="5660978">=</span>&nbsp;<span class="op" id="5660980">&amp;</span><span class="ident" id="5660981">ast</span><span class="op" id="5660984">.</span><span class="ident" id="5660985">File</span><span class="op" id="5660989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5660995">Name</span><span class="op" id="5660999">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5661002">new</span><span class="op" id="5661005">(</span><span class="ident" id="5661006">ast</span><span class="op" id="5661009">.</span><span class="ident" id="5661010">Ident</span><span class="op" id="5661015">)</span><span class="op" id="5661016">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661022">Scope</span><span class="op" id="5661027">:</span>&nbsp;<span class="ident" id="5661029">ast</span><span class="op" id="5661032">.</span><span class="ident" id="5661033">NewScope</span><span class="op" id="5661041">(</span><span class="ident" id="5661042">nil</span><span class="op" id="5661045">)</span><span class="op" id="5661046">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5661051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5661055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661060">p</span><span class="op" id="5661061">.</span><span class="ident" id="5661062">errors</span><span class="op" id="5661068">.</span><span class="ident" id="5661069">Sort</span><span class="op" id="5661073">(</span><span class="op" id="5661074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661078">err</span>&nbsp;<span class="op" id="5661082">=</span>&nbsp;<span class="ident" id="5661084">p</span><span class="op" id="5661085">.</span><span class="ident" id="5661086">errors</span><span class="op" id="5661092">.</span><span class="ident" id="5661093">Err</span><span class="op" id="5661096">(</span><span class="op" id="5661097">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5661100">}</span><span class="op" id="5661101">(</span><span class="op" id="5661102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5661106">//&nbsp;parse&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661123">p</span><span class="op" id="5661124">.</span><span class="ident" id="5661125">init</span><span class="op" id="5661129">(</span><span class="ident" id="5661130">fset</span><span class="op" id="5661134">,</span>&nbsp;<span class="ident" id="5661136">filename</span><span class="op" id="5661144">,</span>&nbsp;<span class="ident" id="5661146">text</span><span class="op" id="5661150">,</span>&nbsp;<span class="ident" id="5661152">mode</span><span class="op" id="5661156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661159">f</span>&nbsp;<span class="op" id="5661161">=</span>&nbsp;<span class="ident" id="5661163">p</span><span class="op" id="5661164">.</span><span class="ident" id="5661165">parseFile</span><span class="op" id="5661174">(</span><span class="op" id="5661175">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5661179">return</span><br>
<span class="lineno"></span><span class="op" id="5661186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5661189">//&nbsp;ParseDir&nbsp;calls&nbsp;ParseFile&nbsp;for&nbsp;all&nbsp;files&nbsp;with&nbsp;names&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;&nbsp;in&nbsp;the</span><br>
<span class="lineno">120</span><span class="comment" id="5661265">//&nbsp;directory&nbsp;specified&nbsp;by&nbsp;path&nbsp;and&nbsp;returns&nbsp;a&nbsp;map&nbsp;of&nbsp;package&nbsp;name&nbsp;-&gt;&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5661341">//&nbsp;AST&nbsp;with&nbsp;all&nbsp;the&nbsp;packages&nbsp;found.</span><br>
<span class="lineno"></span><span class="comment" id="5661377">//</span><br>
<span class="lineno"></span><span class="comment" id="5661380">//&nbsp;If&nbsp;filter&nbsp;!=&nbsp;nil,&nbsp;only&nbsp;the&nbsp;files&nbsp;with&nbsp;os.FileInfo&nbsp;entries&nbsp;passing&nbsp;through</span><br>
<span class="lineno"></span><span class="comment" id="5661457">//&nbsp;the&nbsp;filter&nbsp;(and&nbsp;ending&nbsp;in&nbsp;&#34;.go&#34;)&nbsp;are&nbsp;considered.&nbsp;The&nbsp;mode&nbsp;bits&nbsp;are&nbsp;passed</span><br>
<span class="lineno">125</span><span class="comment" id="5661534">//&nbsp;to&nbsp;ParseFile&nbsp;unchanged.&nbsp;Position&nbsp;information&nbsp;is&nbsp;recorded&nbsp;in&nbsp;fset.</span><br>
<span class="lineno"></span><span class="comment" id="5661603">//</span><br>
<span class="lineno"></span><span class="comment" id="5661606">//&nbsp;If&nbsp;the&nbsp;directory&nbsp;couldn&#39;t&nbsp;be&nbsp;read,&nbsp;a&nbsp;nil&nbsp;map&nbsp;and&nbsp;the&nbsp;respective&nbsp;error&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5661683">//&nbsp;returned.&nbsp;If&nbsp;a&nbsp;parse&nbsp;error&nbsp;occurred,&nbsp;a&nbsp;non-nil&nbsp;but&nbsp;incomplete&nbsp;map&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5661760">//&nbsp;first&nbsp;error&nbsp;encountered&nbsp;are&nbsp;returned.</span><br>
<span class="lineno">130</span><span class="comment" id="5661801">//</span><br>
<span class="lineno"></span><span class="keyword" id="5661804">func</span>&nbsp;<span class="ident" id="5661809">ParseDir</span><span class="op" id="5661817">(</span><span class="ident" id="5661818">fset</span>&nbsp;<span class="op" id="5661823">*</span><span class="ident" id="5661824">token</span><span class="op" id="5661829">.</span><span class="ident" id="5661830">FileSet</span><span class="op" id="5661837">,</span>&nbsp;<span class="ident" id="5661839">path</span>&nbsp;<span class="builtintype" id="5661844">string</span><span class="op" id="5661850">,</span>&nbsp;<span class="ident" id="5661852">filter</span>&nbsp;<span class="keyword" id="5661859">func</span><span class="op" id="5661863">(</span><span class="ident" id="5661864">os</span><span class="op" id="5661866">.</span><span class="ident" id="5661867">FileInfo</span><span class="op" id="5661875">)</span>&nbsp;<span class="builtintype" id="5661877">bool</span><span class="op" id="5661881">,</span>&nbsp;<span class="ident" id="5661883">mode</span>&nbsp;<span class="ident" id="5661888">Mode</span><span class="op" id="5661892">)</span>&nbsp;<span class="op" id="5661894">(</span><span class="ident" id="5661895">pkgs</span>&nbsp;<span class="keyword" id="5661900">map</span><span class="op" id="5661903">[</span><span class="builtintype" id="5661904">string</span><span class="op" id="5661910">]</span><span class="op" id="5661911">*</span><span class="ident" id="5661912">ast</span><span class="op" id="5661915">.</span><span class="ident" id="5661916">Package</span><span class="op" id="5661923">,</span>&nbsp;<span class="ident" id="5661925">first</span>&nbsp;<span class="builtintype" id="5661931">error</span><span class="op" id="5661936">)</span>&nbsp;<span class="op" id="5661938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5661941">fd</span><span class="op" id="5661943">,</span>&nbsp;<span class="ident" id="5661945">err</span>&nbsp;<span class="op" id="5661949">:=</span>&nbsp;<span class="ident" id="5661952">os</span><span class="op" id="5661954">.</span><span class="ident" id="5661955">Open</span><span class="op" id="5661959">(</span><span class="ident" id="5661960">path</span><span class="op" id="5661964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5661967">if</span>&nbsp;<span class="ident" id="5661970">err</span>&nbsp;<span class="op" id="5661974">!=</span>&nbsp;<span class="ident" id="5661977">nil</span>&nbsp;<span class="op" id="5661981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5661985">return</span>&nbsp;<span class="ident" id="5661992">nil</span><span class="op" id="5661995">,</span>&nbsp;<span class="ident" id="5661997">err</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5662002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5662005">defer</span>&nbsp;<span class="ident" id="5662011">fd</span><span class="op" id="5662013">.</span><span class="ident" id="5662014">Close</span><span class="op" id="5662019">(</span><span class="op" id="5662020">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662024">list</span><span class="op" id="5662028">,</span>&nbsp;<span class="ident" id="5662030">err</span>&nbsp;<span class="op" id="5662034">:=</span>&nbsp;<span class="ident" id="5662037">fd</span><span class="op" id="5662039">.</span><span class="ident" id="5662040">Readdir</span><span class="op" id="5662047">(</span><span class="op" id="5662048">-</span><span class="num" id="5662049">1</span><span class="op" id="5662050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5662053">if</span>&nbsp;<span class="ident" id="5662056">err</span>&nbsp;<span class="op" id="5662060">!=</span>&nbsp;<span class="ident" id="5662063">nil</span>&nbsp;<span class="op" id="5662067">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5662071">return</span>&nbsp;<span class="ident" id="5662078">nil</span><span class="op" id="5662081">,</span>&nbsp;<span class="ident" id="5662083">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5662088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662092">pkgs</span>&nbsp;<span class="op" id="5662097">=</span>&nbsp;<span class="builtinfunc" id="5662099">make</span><span class="op" id="5662103">(</span><span class="keyword" id="5662104">map</span><span class="op" id="5662107">[</span><span class="builtintype" id="5662108">string</span><span class="op" id="5662114">]</span><span class="op" id="5662115">*</span><span class="ident" id="5662116">ast</span><span class="op" id="5662119">.</span><span class="ident" id="5662120">Package</span><span class="op" id="5662127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5662130">for</span>&nbsp;<span class="ident" id="5662134">_</span><span class="op" id="5662135">,</span>&nbsp;<span class="ident" id="5662137">d</span>&nbsp;<span class="op" id="5662139">:=</span>&nbsp;<span class="keyword" id="5662142">range</span>&nbsp;<span class="ident" id="5662148">list</span>&nbsp;<span class="op" id="5662153">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5662157">if</span>&nbsp;<span class="ident" id="5662160">strings</span><span class="op" id="5662167">.</span><span class="ident" id="5662168">HasSuffix</span><span class="op" id="5662177">(</span><span class="ident" id="5662178">d</span><span class="op" id="5662179">.</span><span class="ident" id="5662180">Name</span><span class="op" id="5662184">(</span><span class="op" id="5662185">)</span><span class="op" id="5662186">,</span>&nbsp;<span class="string" id="5662188">&#34;.go&#34;</span><span class="op" id="5662193">)</span>&nbsp;<span class="op" id="5662195">&amp;&amp;</span>&nbsp;<span class="op" id="5662198">(</span><span class="ident" id="5662199">filter</span>&nbsp;<span class="op" id="5662206">==</span>&nbsp;<span class="ident" id="5662209">nil</span>&nbsp;<span class="op" id="5662213">||</span>&nbsp;<span class="ident" id="5662216">filter</span><span class="op" id="5662222">(</span><span class="ident" id="5662223">d</span><span class="op" id="5662224">)</span><span class="op" id="5662225">)</span>&nbsp;<span class="op" id="5662227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662232">filename</span>&nbsp;<span class="op" id="5662241">:=</span>&nbsp;<span class="ident" id="5662244">filepath</span><span class="op" id="5662252">.</span><span class="ident" id="5662253">Join</span><span class="op" id="5662257">(</span><span class="ident" id="5662258">path</span><span class="op" id="5662262">,</span>&nbsp;<span class="ident" id="5662264">d</span><span class="op" id="5662265">.</span><span class="ident" id="5662266">Name</span><span class="op" id="5662270">(</span><span class="op" id="5662271">)</span><span class="op" id="5662272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5662277">if</span>&nbsp;<span class="ident" id="5662280">src</span><span class="op" id="5662283">,</span>&nbsp;<span class="ident" id="5662285">err</span>&nbsp;<span class="op" id="5662289">:=</span>&nbsp;<span class="ident" id="5662292">ParseFile</span><span class="op" id="5662301">(</span><span class="ident" id="5662302">fset</span><span class="op" id="5662306">,</span>&nbsp;<span class="ident" id="5662308">filename</span><span class="op" id="5662316">,</span>&nbsp;<span class="ident" id="5662318">nil</span><span class="op" id="5662321">,</span>&nbsp;<span class="ident" id="5662323">mode</span><span class="op" id="5662327">)</span><span class="op" id="5662328">;</span>&nbsp;<span class="ident" id="5662330">err</span>&nbsp;<span class="op" id="5662334">==</span>&nbsp;<span class="ident" id="5662337">nil</span>&nbsp;<span class="op" id="5662341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662347">name</span>&nbsp;<span class="op" id="5662352">:=</span>&nbsp;<span class="ident" id="5662355">src</span><span class="op" id="5662358">.</span><span class="ident" id="5662359">Name</span><span class="op" id="5662363">.</span><span class="ident" id="5662364">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662373">pkg</span><span class="op" id="5662376">,</span>&nbsp;<span class="ident" id="5662378">found</span>&nbsp;<span class="op" id="5662384">:=</span>&nbsp;<span class="ident" id="5662387">pkgs</span><span class="op" id="5662391">[</span><span class="ident" id="5662392">name</span><span class="op" id="5662396">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5662402">if</span>&nbsp;<span class="op" id="5662405">!</span><span class="ident" id="5662406">found</span>&nbsp;<span class="op" id="5662412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662419">pkg</span>&nbsp;<span class="op" id="5662423">=</span>&nbsp;<span class="op" id="5662425">&amp;</span><span class="ident" id="5662426">ast</span><span class="op" id="5662429">.</span><span class="ident" id="5662430">Package</span><span class="op" id="5662437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662445">Name</span><span class="op" id="5662449">:</span>&nbsp;&nbsp;<span class="ident" id="5662452">name</span><span class="op" id="5662456">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662464">Files</span><span class="op" id="5662469">:</span>&nbsp;<span class="builtinfunc" id="5662471">make</span><span class="op" id="5662475">(</span><span class="keyword" id="5662476">map</span><span class="op" id="5662479">[</span><span class="builtintype" id="5662480">string</span><span class="op" id="5662486">]</span><span class="op" id="5662487">*</span><span class="ident" id="5662488">ast</span><span class="op" id="5662491">.</span><span class="ident" id="5662492">File</span><span class="op" id="5662496">)</span><span class="op" id="5662497">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5662504">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662511">pkgs</span><span class="op" id="5662515">[</span><span class="ident" id="5662516">name</span><span class="op" id="5662520">]</span>&nbsp;<span class="op" id="5662522">=</span>&nbsp;<span class="ident" id="5662524">pkg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5662532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662538">pkg</span><span class="op" id="5662541">.</span><span class="ident" id="5662542">Files</span><span class="op" id="5662547">[</span><span class="ident" id="5662548">filename</span><span class="op" id="5662556">]</span>&nbsp;<span class="op" id="5662558">=</span>&nbsp;<span class="ident" id="5662560">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5662567">}</span>&nbsp;<span class="keyword" id="5662569">else</span>&nbsp;<span class="keyword" id="5662574">if</span>&nbsp;<span class="ident" id="5662577">first</span>&nbsp;<span class="op" id="5662583">==</span>&nbsp;<span class="ident" id="5662586">nil</span>&nbsp;<span class="op" id="5662590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662596">first</span>&nbsp;<span class="op" id="5662602">=</span>&nbsp;<span class="ident" id="5662604">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5662611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5662615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5662618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5662622">return</span><br>
<span class="lineno">165</span><span class="op" id="5662629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5662632">//&nbsp;ParseExpr&nbsp;is&nbsp;a&nbsp;convenience&nbsp;function&nbsp;for&nbsp;obtaining&nbsp;the&nbsp;AST&nbsp;of&nbsp;an&nbsp;expression&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="5662713">//&nbsp;The&nbsp;position&nbsp;information&nbsp;recorded&nbsp;in&nbsp;the&nbsp;AST&nbsp;is&nbsp;undefined.&nbsp;The&nbsp;filename&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="5662793">//&nbsp;in&nbsp;error&nbsp;messages&nbsp;is&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno">170</span><span class="comment" id="5662835">//</span><br>
<span class="lineno"></span><span class="keyword" id="5662838">func</span>&nbsp;<span class="ident" id="5662843">ParseExpr</span><span class="op" id="5662852">(</span><span class="ident" id="5662853">x</span>&nbsp;<span class="builtintype" id="5662855">string</span><span class="op" id="5662861">)</span>&nbsp;<span class="op" id="5662863">(</span><span class="ident" id="5662864">ast</span><span class="op" id="5662867">.</span><span class="ident" id="5662868">Expr</span><span class="op" id="5662872">,</span>&nbsp;<span class="builtintype" id="5662874">error</span><span class="op" id="5662879">)</span>&nbsp;<span class="op" id="5662881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5662884">var</span>&nbsp;<span class="ident" id="5662888">p</span>&nbsp;<span class="ident" id="5662890">parser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5662898">p</span><span class="op" id="5662899">.</span><span class="ident" id="5662900">init</span><span class="op" id="5662904">(</span><span class="ident" id="5662905">token</span><span class="op" id="5662910">.</span><span class="ident" id="5662911">NewFileSet</span><span class="op" id="5662921">(</span><span class="op" id="5662922">)</span><span class="op" id="5662923">,</span>&nbsp;<span class="string" id="5662925">&#34;&#34;</span><span class="op" id="5662927">,</span>&nbsp;<span class="op" id="5662929">[</span><span class="op" id="5662930">]</span><span class="builtintype" id="5662931">byte</span><span class="op" id="5662935">(</span><span class="ident" id="5662936">x</span><span class="op" id="5662937">)</span><span class="op" id="5662938">,</span>&nbsp;<span class="num" id="5662940">0</span><span class="op" id="5662941">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5662945">//&nbsp;Set&nbsp;up&nbsp;pkg-level&nbsp;scopes&nbsp;to&nbsp;avoid&nbsp;nil-pointer&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5663002">//&nbsp;This&nbsp;is&nbsp;not&nbsp;needed&nbsp;for&nbsp;a&nbsp;correct&nbsp;expression&nbsp;x&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5663059">//&nbsp;parser&nbsp;will&nbsp;be&nbsp;ok&nbsp;with&nbsp;a&nbsp;nil&nbsp;topScope,&nbsp;but&nbsp;be&nbsp;cautious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5663118">//&nbsp;in&nbsp;case&nbsp;of&nbsp;an&nbsp;erroneous&nbsp;x.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663149">p</span><span class="op" id="5663150">.</span><span class="ident" id="5663151">openScope</span><span class="op" id="5663160">(</span><span class="op" id="5663161">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663164">p</span><span class="op" id="5663165">.</span><span class="ident" id="5663166">pkgScope</span>&nbsp;<span class="op" id="5663175">=</span>&nbsp;<span class="ident" id="5663177">p</span><span class="op" id="5663178">.</span><span class="ident" id="5663179">topScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663189">e</span>&nbsp;<span class="op" id="5663191">:=</span>&nbsp;<span class="ident" id="5663194">p</span><span class="op" id="5663195">.</span><span class="ident" id="5663196">parseRhsOrType</span><span class="op" id="5663210">(</span><span class="op" id="5663211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663214">p</span><span class="op" id="5663215">.</span><span class="ident" id="5663216">closeScope</span><span class="op" id="5663226">(</span><span class="op" id="5663227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663230">assert</span><span class="op" id="5663236">(</span><span class="ident" id="5663237">p</span><span class="op" id="5663238">.</span><span class="ident" id="5663239">topScope</span>&nbsp;<span class="op" id="5663248">==</span>&nbsp;<span class="ident" id="5663251">nil</span><span class="op" id="5663254">,</span>&nbsp;<span class="string" id="5663256">&#34;unbalanced&nbsp;scopes&#34;</span><span class="op" id="5663275">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5663279">//&nbsp;If&nbsp;a&nbsp;semicolon&nbsp;was&nbsp;inserted,&nbsp;consume&nbsp;it;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5663324">//&nbsp;report&nbsp;an&nbsp;error&nbsp;if&nbsp;there&#39;s&nbsp;more&nbsp;tokens.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5663368">if</span>&nbsp;<span class="ident" id="5663371">p</span><span class="op" id="5663372">.</span><span class="ident" id="5663373">tok</span>&nbsp;<span class="op" id="5663377">==</span>&nbsp;<span class="ident" id="5663380">token</span><span class="op" id="5663385">.</span><span class="ident" id="5663386">SEMICOLON</span>&nbsp;<span class="op" id="5663396">&amp;&amp;</span>&nbsp;<span class="ident" id="5663399">p</span><span class="op" id="5663400">.</span><span class="ident" id="5663401">lit</span>&nbsp;<span class="op" id="5663405">==</span>&nbsp;<span class="string" id="5663408">&#34;\n&#34;</span>&nbsp;<span class="op" id="5663413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663417">p</span><span class="op" id="5663418">.</span><span class="ident" id="5663419">next</span><span class="op" id="5663423">(</span><span class="op" id="5663424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5663427">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663430">p</span><span class="op" id="5663431">.</span><span class="ident" id="5663432">expect</span><span class="op" id="5663438">(</span><span class="ident" id="5663439">token</span><span class="op" id="5663444">.</span><span class="ident" id="5663445">EOF</span><span class="op" id="5663448">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5663452">if</span>&nbsp;<span class="ident" id="5663455">p</span><span class="op" id="5663456">.</span><span class="ident" id="5663457">errors</span><span class="op" id="5663463">.</span><span class="ident" id="5663464">Len</span><span class="op" id="5663467">(</span><span class="op" id="5663468">)</span>&nbsp;<span class="op" id="5663470">&gt;</span>&nbsp;<span class="num" id="5663472">0</span>&nbsp;<span class="op" id="5663474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5663478">p</span><span class="op" id="5663479">.</span><span class="ident" id="5663480">errors</span><span class="op" id="5663486">.</span><span class="ident" id="5663487">Sort</span><span class="op" id="5663491">(</span><span class="op" id="5663492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5663496">return</span>&nbsp;<span class="ident" id="5663503">nil</span><span class="op" id="5663506">,</span>&nbsp;<span class="ident" id="5663508">p</span><span class="op" id="5663509">.</span><span class="ident" id="5663510">errors</span><span class="op" id="5663516">.</span><span class="ident" id="5663517">Err</span><span class="op" id="5663520">(</span><span class="op" id="5663521">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5663524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5663528">return</span>&nbsp;<span class="ident" id="5663535">e</span><span class="op" id="5663536">,</span>&nbsp;<span class="ident" id="5663538">nil</span><br>
<span class="lineno"></span><span class="op" id="5663542">}</span>
</div>
</body>
</html>
