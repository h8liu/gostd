<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html" class="current">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1437241">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1437296">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1437350">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1437401">package</span>&nbsp;<span class="ident" id="1437409">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1437415">import</span>&nbsp;<span class="op" id="1437422">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1437425">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1437440">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1437449">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1437452">//&nbsp;Cond&nbsp;implements&nbsp;a&nbsp;condition&nbsp;variable,&nbsp;a&nbsp;rendezvous&nbsp;point</span><br>
<span class="lineno"></span><span class="comment" id="1437512">//&nbsp;for&nbsp;goroutines&nbsp;waiting&nbsp;for&nbsp;or&nbsp;announcing&nbsp;the&nbsp;occurrence</span><br>
<span class="lineno"></span><span class="comment" id="1437571">//&nbsp;of&nbsp;an&nbsp;event.</span><br>
<span class="lineno">15</span><span class="comment" id="1437587">//</span><br>
<span class="lineno"></span><span class="comment" id="1437590">//&nbsp;Each&nbsp;Cond&nbsp;has&nbsp;an&nbsp;associated&nbsp;Locker&nbsp;L&nbsp;(often&nbsp;a&nbsp;*Mutex&nbsp;or&nbsp;*RWMutex),</span><br>
<span class="lineno"></span><span class="comment" id="1437660">//&nbsp;which&nbsp;must&nbsp;be&nbsp;held&nbsp;when&nbsp;changing&nbsp;the&nbsp;condition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1437714">//&nbsp;when&nbsp;calling&nbsp;the&nbsp;Wait&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="1437747">//</span><br>
<span class="lineno">20</span><span class="comment" id="1437750">//&nbsp;A&nbsp;Cond&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures.</span><br>
<span class="lineno"></span><span class="comment" id="1437804">//&nbsp;A&nbsp;Cond&nbsp;must&nbsp;not&nbsp;be&nbsp;copied&nbsp;after&nbsp;first&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="1437850">type</span>&nbsp;<span class="ident" id="1437855">Cond</span>&nbsp;<span class="keyword" id="1437860">struct</span>&nbsp;<span class="op" id="1437867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1437870">//&nbsp;L&nbsp;is&nbsp;held&nbsp;while&nbsp;observing&nbsp;or&nbsp;changing&nbsp;the&nbsp;condition</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437926">L</span>&nbsp;<span class="ident" id="1437928">Locker</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437937">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1437945">syncSema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437955">waiters</span>&nbsp;<span class="builtintype" id="1437963">uint32</span>&nbsp;<span class="comment" id="1437970">//&nbsp;number&nbsp;of&nbsp;waiters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1437992">checker</span>&nbsp;<span class="ident" id="1438000">copyChecker</span><br>
<span class="lineno"></span><span class="op" id="1438012">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="1438015">//&nbsp;NewCond&nbsp;returns&nbsp;a&nbsp;new&nbsp;Cond&nbsp;with&nbsp;Locker&nbsp;l.</span><br>
<span class="lineno"></span><span class="keyword" id="1438060">func</span>&nbsp;<span class="ident" id="1438065">NewCond</span><span class="op" id="1438072">(</span><span class="ident" id="1438073">l</span>&nbsp;<span class="ident" id="1438075">Locker</span><span class="op" id="1438081">)</span>&nbsp;<span class="op" id="1438083">*</span><span class="ident" id="1438084">Cond</span>&nbsp;<span class="op" id="1438089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438092">return</span>&nbsp;<span class="op" id="1438099">&amp;</span><span class="ident" id="1438100">Cond</span><span class="op" id="1438104">{</span><span class="ident" id="1438105">L</span><span class="op" id="1438106">:</span>&nbsp;<span class="ident" id="1438108">l</span><span class="op" id="1438109">}</span><br>
<span class="lineno"></span><span class="op" id="1438111">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1438114">//&nbsp;Wait&nbsp;atomically&nbsp;unlocks&nbsp;c.L&nbsp;and&nbsp;suspends&nbsp;execution</span><br>
<span class="lineno"></span><span class="comment" id="1438168">//&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine.&nbsp;&nbsp;After&nbsp;later&nbsp;resuming&nbsp;execution,</span><br>
<span class="lineno"></span><span class="comment" id="1438230">//&nbsp;Wait&nbsp;locks&nbsp;c.L&nbsp;before&nbsp;returning.&nbsp;&nbsp;Unlike&nbsp;in&nbsp;other&nbsp;systems,</span><br>
<span class="lineno"></span><span class="comment" id="1438292">//&nbsp;Wait&nbsp;cannot&nbsp;return&nbsp;unless&nbsp;awoken&nbsp;by&nbsp;Broadcast&nbsp;or&nbsp;Signal.</span><br>
<span class="lineno">40</span><span class="comment" id="1438352">//</span><br>
<span class="lineno"></span><span class="comment" id="1438355">//&nbsp;Because&nbsp;c.L&nbsp;is&nbsp;not&nbsp;locked&nbsp;when&nbsp;Wait&nbsp;first&nbsp;resumes,&nbsp;the&nbsp;caller</span><br>
<span class="lineno"></span><span class="comment" id="1438420">//&nbsp;typically&nbsp;cannot&nbsp;assume&nbsp;that&nbsp;the&nbsp;condition&nbsp;is&nbsp;true&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="1438479">//&nbsp;Wait&nbsp;returns.&nbsp;&nbsp;Instead,&nbsp;the&nbsp;caller&nbsp;should&nbsp;Wait&nbsp;in&nbsp;a&nbsp;loop:</span><br>
<span class="lineno"></span><span class="comment" id="1438540">//</span><br>
<span class="lineno">45</span><span class="comment" id="1438543">//&nbsp;&nbsp;&nbsp;&nbsp;c.L.Lock()</span><br>
<span class="lineno"></span><span class="comment" id="1438560">//&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;!condition()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1438585">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.Wait()</span><br>
<span class="lineno"></span><span class="comment" id="1438604">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1438612">//&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;make&nbsp;use&nbsp;of&nbsp;condition&nbsp;...</span><br>
<span class="lineno">50</span><span class="comment" id="1438648">//&nbsp;&nbsp;&nbsp;&nbsp;c.L.Unlock()</span><br>
<span class="lineno"></span><span class="comment" id="1438667">//</span><br>
<span class="lineno"></span><span class="keyword" id="1438670">func</span>&nbsp;<span class="op" id="1438675">(</span><span class="ident" id="1438676">c</span>&nbsp;<span class="op" id="1438678">*</span><span class="ident" id="1438679">Cond</span><span class="op" id="1438683">)</span>&nbsp;<span class="ident" id="1438685">Wait</span><span class="op" id="1438689">(</span><span class="op" id="1438690">)</span>&nbsp;<span class="op" id="1438692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438695">c</span><span class="op" id="1438696">.</span><span class="ident" id="1438697">checker</span><span class="op" id="1438704">.</span><span class="ident" id="1438705">check</span><span class="op" id="1438710">(</span><span class="op" id="1438711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438714">if</span>&nbsp;<span class="ident" id="1438717">raceenabled</span>&nbsp;<span class="op" id="1438729">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438733">raceDisable</span><span class="op" id="1438744">(</span><span class="op" id="1438745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438751">atomic</span><span class="op" id="1438757">.</span><span class="ident" id="1438758">AddUint32</span><span class="op" id="1438767">(</span><span class="op" id="1438768">&amp;</span><span class="ident" id="1438769">c</span><span class="op" id="1438770">.</span><span class="ident" id="1438771">waiters</span><span class="op" id="1438778">,</span>&nbsp;<span class="num" id="1438780">1</span><span class="op" id="1438781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1438784">if</span>&nbsp;<span class="ident" id="1438787">raceenabled</span>&nbsp;<span class="op" id="1438799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438803">raceEnable</span><span class="op" id="1438813">(</span><span class="op" id="1438814">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1438817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438820">c</span><span class="op" id="1438821">.</span><span class="ident" id="1438822">L</span><span class="op" id="1438823">.</span><span class="ident" id="1438824">Unlock</span><span class="op" id="1438830">(</span><span class="op" id="1438831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438834">runtime_Syncsemacquire</span><span class="op" id="1438856">(</span><span class="op" id="1438857">&amp;</span><span class="ident" id="1438858">c</span><span class="op" id="1438859">.</span><span class="ident" id="1438860">sema</span><span class="op" id="1438864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1438867">c</span><span class="op" id="1438868">.</span><span class="ident" id="1438869">L</span><span class="op" id="1438870">.</span><span class="ident" id="1438871">Lock</span><span class="op" id="1438875">(</span><span class="op" id="1438876">)</span><br>
<span class="lineno"></span><span class="op" id="1438878">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="1438881">//&nbsp;Signal&nbsp;wakes&nbsp;one&nbsp;goroutine&nbsp;waiting&nbsp;on&nbsp;c,&nbsp;if&nbsp;there&nbsp;is&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="1438942">//</span><br>
<span class="lineno"></span><span class="comment" id="1438945">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;but&nbsp;not&nbsp;required&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;hold&nbsp;c.L</span><br>
<span class="lineno"></span><span class="comment" id="1439006">//&nbsp;during&nbsp;the&nbsp;call.</span><br>
<span class="lineno">70</span><span class="keyword" id="1439026">func</span>&nbsp;<span class="op" id="1439031">(</span><span class="ident" id="1439032">c</span>&nbsp;<span class="op" id="1439034">*</span><span class="ident" id="1439035">Cond</span><span class="op" id="1439039">)</span>&nbsp;<span class="ident" id="1439041">Signal</span><span class="op" id="1439047">(</span><span class="op" id="1439048">)</span>&nbsp;<span class="op" id="1439050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439053">c</span><span class="op" id="1439054">.</span><span class="ident" id="1439055">signalImpl</span><span class="op" id="1439065">(</span><span class="builtintype" id="1439066">false</span><span class="op" id="1439071">)</span><br>
<span class="lineno"></span><span class="op" id="1439073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1439076">//&nbsp;Broadcast&nbsp;wakes&nbsp;all&nbsp;goroutines&nbsp;waiting&nbsp;on&nbsp;c.</span><br>
<span class="lineno">75</span><span class="comment" id="1439124">//</span><br>
<span class="lineno"></span><span class="comment" id="1439127">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;but&nbsp;not&nbsp;required&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;hold&nbsp;c.L</span><br>
<span class="lineno"></span><span class="comment" id="1439188">//&nbsp;during&nbsp;the&nbsp;call.</span><br>
<span class="lineno"></span><span class="keyword" id="1439208">func</span>&nbsp;<span class="op" id="1439213">(</span><span class="ident" id="1439214">c</span>&nbsp;<span class="op" id="1439216">*</span><span class="ident" id="1439217">Cond</span><span class="op" id="1439221">)</span>&nbsp;<span class="ident" id="1439223">Broadcast</span><span class="op" id="1439232">(</span><span class="op" id="1439233">)</span>&nbsp;<span class="op" id="1439235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439238">c</span><span class="op" id="1439239">.</span><span class="ident" id="1439240">signalImpl</span><span class="op" id="1439250">(</span><span class="builtintype" id="1439251">true</span><span class="op" id="1439255">)</span><br>
<span class="lineno">80</span><span class="op" id="1439257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1439260">func</span>&nbsp;<span class="op" id="1439265">(</span><span class="ident" id="1439266">c</span>&nbsp;<span class="op" id="1439268">*</span><span class="ident" id="1439269">Cond</span><span class="op" id="1439273">)</span>&nbsp;<span class="ident" id="1439275">signalImpl</span><span class="op" id="1439285">(</span><span class="ident" id="1439286">all</span>&nbsp;<span class="builtintype" id="1439290">bool</span><span class="op" id="1439294">)</span>&nbsp;<span class="op" id="1439296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439299">c</span><span class="op" id="1439300">.</span><span class="ident" id="1439301">checker</span><span class="op" id="1439308">.</span><span class="ident" id="1439309">check</span><span class="op" id="1439314">(</span><span class="op" id="1439315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439318">if</span>&nbsp;<span class="ident" id="1439321">raceenabled</span>&nbsp;<span class="op" id="1439333">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439337">raceDisable</span><span class="op" id="1439348">(</span><span class="op" id="1439349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439355">for</span>&nbsp;<span class="op" id="1439359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439363">old</span>&nbsp;<span class="op" id="1439367">:=</span>&nbsp;<span class="ident" id="1439370">atomic</span><span class="op" id="1439376">.</span><span class="ident" id="1439377">LoadUint32</span><span class="op" id="1439387">(</span><span class="op" id="1439388">&amp;</span><span class="ident" id="1439389">c</span><span class="op" id="1439390">.</span><span class="ident" id="1439391">waiters</span><span class="op" id="1439398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439402">if</span>&nbsp;<span class="ident" id="1439405">old</span>&nbsp;<span class="op" id="1439409">==</span>&nbsp;<span class="num" id="1439412">0</span>&nbsp;<span class="op" id="1439414">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439419">if</span>&nbsp;<span class="ident" id="1439422">raceenabled</span>&nbsp;<span class="op" id="1439434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439440">raceEnable</span><span class="op" id="1439450">(</span><span class="op" id="1439451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439461">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439470">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1439474">new</span>&nbsp;<span class="op" id="1439478">:=</span>&nbsp;<span class="ident" id="1439481">old</span>&nbsp;<span class="op" id="1439485">-</span>&nbsp;<span class="num" id="1439487">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439491">if</span>&nbsp;<span class="ident" id="1439494">all</span>&nbsp;<span class="op" id="1439498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1439503">new</span>&nbsp;<span class="op" id="1439507">=</span>&nbsp;<span class="num" id="1439509">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439517">if</span>&nbsp;<span class="ident" id="1439520">atomic</span><span class="op" id="1439526">.</span><span class="ident" id="1439527">CompareAndSwapUint32</span><span class="op" id="1439547">(</span><span class="op" id="1439548">&amp;</span><span class="ident" id="1439549">c</span><span class="op" id="1439550">.</span><span class="ident" id="1439551">waiters</span><span class="op" id="1439558">,</span>&nbsp;<span class="ident" id="1439560">old</span><span class="op" id="1439563">,</span>&nbsp;<span class="builtinfunc" id="1439565">new</span><span class="op" id="1439568">)</span>&nbsp;<span class="op" id="1439570">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439575">if</span>&nbsp;<span class="ident" id="1439578">raceenabled</span>&nbsp;<span class="op" id="1439590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439596">raceEnable</span><span class="op" id="1439606">(</span><span class="op" id="1439607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1439617">runtime_Syncsemrelease</span><span class="op" id="1439639">(</span><span class="op" id="1439640">&amp;</span><span class="ident" id="1439641">c</span><span class="op" id="1439642">.</span><span class="ident" id="1439643">sema</span><span class="op" id="1439647">,</span>&nbsp;<span class="ident" id="1439649">old</span><span class="op" id="1439652">-</span><span class="builtinfunc" id="1439653">new</span><span class="op" id="1439656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439661">return</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439673">}</span><br>
<span class="lineno"></span><span class="op" id="1439675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1439678">//&nbsp;copyChecker&nbsp;holds&nbsp;back&nbsp;pointer&nbsp;to&nbsp;itself&nbsp;to&nbsp;detect&nbsp;object&nbsp;copying.</span><br>
<span class="lineno">110</span><span class="keyword" id="1439748">type</span>&nbsp;<span class="ident" id="1439753">copyChecker</span>&nbsp;<span class="builtintype" id="1439765">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1439774">func</span>&nbsp;<span class="op" id="1439779">(</span><span class="ident" id="1439780">c</span>&nbsp;<span class="op" id="1439782">*</span><span class="ident" id="1439783">copyChecker</span><span class="op" id="1439794">)</span>&nbsp;<span class="ident" id="1439796">check</span><span class="op" id="1439801">(</span><span class="op" id="1439802">)</span>&nbsp;<span class="op" id="1439804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1439807">if</span>&nbsp;<span class="builtintype" id="1439810">uintptr</span><span class="op" id="1439817">(</span><span class="op" id="1439818">*</span><span class="ident" id="1439819">c</span><span class="op" id="1439820">)</span>&nbsp;<span class="op" id="1439822">!=</span>&nbsp;<span class="builtintype" id="1439825">uintptr</span><span class="op" id="1439832">(</span><span class="ident" id="1439833">unsafe</span><span class="op" id="1439839">.</span><span class="ident" id="1439840">Pointer</span><span class="op" id="1439847">(</span><span class="ident" id="1439848">c</span><span class="op" id="1439849">)</span><span class="op" id="1439850">)</span>&nbsp;<span class="op" id="1439852">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1439857">!</span><span class="ident" id="1439858">atomic</span><span class="op" id="1439864">.</span><span class="ident" id="1439865">CompareAndSwapUintptr</span><span class="op" id="1439886">(</span><span class="op" id="1439887">(</span><span class="op" id="1439888">*</span><span class="builtintype" id="1439889">uintptr</span><span class="op" id="1439896">)</span><span class="op" id="1439897">(</span><span class="ident" id="1439898">c</span><span class="op" id="1439899">)</span><span class="op" id="1439900">,</span>&nbsp;<span class="num" id="1439902">0</span><span class="op" id="1439903">,</span>&nbsp;<span class="builtintype" id="1439905">uintptr</span><span class="op" id="1439912">(</span><span class="ident" id="1439913">unsafe</span><span class="op" id="1439919">.</span><span class="ident" id="1439920">Pointer</span><span class="op" id="1439927">(</span><span class="ident" id="1439928">c</span><span class="op" id="1439929">)</span><span class="op" id="1439930">)</span><span class="op" id="1439931">)</span>&nbsp;<span class="op" id="1439933">&amp;&amp;</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="1439938">uintptr</span><span class="op" id="1439945">(</span><span class="op" id="1439946">*</span><span class="ident" id="1439947">c</span><span class="op" id="1439948">)</span>&nbsp;<span class="op" id="1439950">!=</span>&nbsp;<span class="builtintype" id="1439953">uintptr</span><span class="op" id="1439960">(</span><span class="ident" id="1439961">unsafe</span><span class="op" id="1439967">.</span><span class="ident" id="1439968">Pointer</span><span class="op" id="1439975">(</span><span class="ident" id="1439976">c</span><span class="op" id="1439977">)</span><span class="op" id="1439978">)</span>&nbsp;<span class="op" id="1439980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1439984">panic</span><span class="op" id="1439989">(</span><span class="string" id="1439990">&#34;sync.Cond&nbsp;is&nbsp;copied&#34;</span><span class="op" id="1440011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1440014">}</span><br>
<span class="lineno"></span><span class="op" id="1440016">}</span>
</div>
</body>
</html>
