<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1629368">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1629423">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1629477">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1629528">package</span>&nbsp;<span class="ident" id="1629536">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1629542">import</span>&nbsp;<span class="op" id="1629549">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1629552">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1629567">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1629576">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1629579">//&nbsp;A&nbsp;WaitGroup&nbsp;waits&nbsp;for&nbsp;a&nbsp;collection&nbsp;of&nbsp;goroutines&nbsp;to&nbsp;finish.</span><br>
<span class="lineno"></span><span class="comment" id="1629642">//&nbsp;The&nbsp;main&nbsp;goroutine&nbsp;calls&nbsp;Add&nbsp;to&nbsp;set&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1629695">//&nbsp;goroutines&nbsp;to&nbsp;wait&nbsp;for.&nbsp;&nbsp;Then&nbsp;each&nbsp;of&nbsp;the&nbsp;goroutines</span><br>
<span class="lineno">15</span><span class="comment" id="1629751">//&nbsp;runs&nbsp;and&nbsp;calls&nbsp;Done&nbsp;when&nbsp;finished.&nbsp;&nbsp;At&nbsp;the&nbsp;same&nbsp;time,</span><br>
<span class="lineno"></span><span class="comment" id="1629808">//&nbsp;Wait&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;block&nbsp;until&nbsp;all&nbsp;goroutines&nbsp;have&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="1629873">type</span>&nbsp;<span class="ident" id="1629878">WaitGroup</span>&nbsp;<span class="keyword" id="1629888">struct</span>&nbsp;<span class="op" id="1629895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629898">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1629906">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629913">counter</span>&nbsp;<span class="builtintype" id="1629921">int32</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629928">waiters</span>&nbsp;<span class="builtintype" id="1629936">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629943">sema</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1629951">*</span><span class="builtintype" id="1629952">uint32</span><br>
<span class="lineno"></span><span class="op" id="1629959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1629962">//&nbsp;WaitGroup&nbsp;creates&nbsp;a&nbsp;new&nbsp;semaphore&nbsp;each&nbsp;time&nbsp;the&nbsp;old&nbsp;semaphore</span><br>
<span class="lineno">25</span><span class="comment" id="1630027">//&nbsp;is&nbsp;released.&nbsp;This&nbsp;is&nbsp;to&nbsp;avoid&nbsp;the&nbsp;following&nbsp;race:</span><br>
<span class="lineno"></span><span class="comment" id="1630080">//</span><br>
<span class="lineno"></span><span class="comment" id="1630083">//&nbsp;G1:&nbsp;Add(1)</span><br>
<span class="lineno"></span><span class="comment" id="1630097">//&nbsp;G1:&nbsp;go&nbsp;G2()</span><br>
<span class="lineno"></span><span class="comment" id="1630112">//&nbsp;G1:&nbsp;Wait()&nbsp;//&nbsp;Context&nbsp;switch&nbsp;after&nbsp;Unlock()&nbsp;and&nbsp;before&nbsp;Semacquire().</span><br>
<span class="lineno">30</span><span class="comment" id="1630184">//&nbsp;G2:&nbsp;Done()&nbsp;//&nbsp;Release&nbsp;semaphore:&nbsp;sema&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.&nbsp;G1&nbsp;doesn&#39;t&nbsp;run&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="1630265">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;Finds&nbsp;counter&nbsp;==&nbsp;0,&nbsp;waiters&nbsp;==&nbsp;0,&nbsp;doesn&#39;t&nbsp;block.</span><br>
<span class="lineno"></span><span class="comment" id="1630331">//&nbsp;G3:&nbsp;Add(1)&nbsp;//&nbsp;Makes&nbsp;counter&nbsp;==&nbsp;1,&nbsp;waiters&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1630382">//&nbsp;G3:&nbsp;go&nbsp;G4()</span><br>
<span class="lineno"></span><span class="comment" id="1630397">//&nbsp;G3:&nbsp;Wait()&nbsp;//&nbsp;G1&nbsp;still&nbsp;hasn&#39;t&nbsp;run,&nbsp;G3&nbsp;finds&nbsp;sema&nbsp;==&nbsp;1,&nbsp;unblocked!&nbsp;Bug.</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="1630472">//&nbsp;Add&nbsp;adds&nbsp;delta,&nbsp;which&nbsp;may&nbsp;be&nbsp;negative,&nbsp;to&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="comment" id="1630540">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;becomes&nbsp;zero,&nbsp;all&nbsp;goroutines&nbsp;blocked&nbsp;on&nbsp;Wait&nbsp;are&nbsp;released.</span><br>
<span class="lineno"></span><span class="comment" id="1630617">//&nbsp;If&nbsp;the&nbsp;counter&nbsp;goes&nbsp;negative,&nbsp;Add&nbsp;panics.</span><br>
<span class="lineno"></span><span class="comment" id="1630662">//</span><br>
<span class="lineno">40</span><span class="comment" id="1630665">//&nbsp;Note&nbsp;that&nbsp;calls&nbsp;with&nbsp;a&nbsp;positive&nbsp;delta&nbsp;that&nbsp;occur&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="1630742">//&nbsp;must&nbsp;happen&nbsp;before&nbsp;a&nbsp;Wait.&nbsp;Calls&nbsp;with&nbsp;a&nbsp;negative&nbsp;delta,&nbsp;or&nbsp;calls&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1630817">//&nbsp;positive&nbsp;delta&nbsp;that&nbsp;start&nbsp;when&nbsp;the&nbsp;counter&nbsp;is&nbsp;greater&nbsp;than&nbsp;zero,&nbsp;may&nbsp;happen</span><br>
<span class="lineno"></span><span class="comment" id="1630896">//&nbsp;at&nbsp;any&nbsp;time.</span><br>
<span class="lineno"></span><span class="comment" id="1630912">//&nbsp;Typically&nbsp;this&nbsp;means&nbsp;the&nbsp;calls&nbsp;to&nbsp;Add&nbsp;should&nbsp;execute&nbsp;before&nbsp;the&nbsp;statement</span><br>
<span class="lineno">45</span><span class="comment" id="1630989">//&nbsp;creating&nbsp;the&nbsp;goroutine&nbsp;or&nbsp;other&nbsp;event&nbsp;to&nbsp;be&nbsp;waited&nbsp;for.</span><br>
<span class="lineno"></span><span class="comment" id="1631048">//&nbsp;See&nbsp;the&nbsp;WaitGroup&nbsp;example.</span><br>
<span class="lineno"></span><span class="keyword" id="1631078">func</span>&nbsp;<span class="op" id="1631083">(</span><span class="ident" id="1631084">wg</span>&nbsp;<span class="op" id="1631087">*</span><span class="ident" id="1631088">WaitGroup</span><span class="op" id="1631097">)</span>&nbsp;<span class="ident" id="1631099">Add</span><span class="op" id="1631102">(</span><span class="ident" id="1631103">delta</span>&nbsp;<span class="builtintype" id="1631109">int</span><span class="op" id="1631112">)</span>&nbsp;<span class="op" id="1631114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631117">if</span>&nbsp;<span class="ident" id="1631120">raceenabled</span>&nbsp;<span class="op" id="1631132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631136">_</span>&nbsp;<span class="op" id="1631138">=</span>&nbsp;<span class="ident" id="1631140">wg</span><span class="op" id="1631142">.</span><span class="ident" id="1631143">m</span><span class="op" id="1631144">.</span><span class="ident" id="1631145">state</span>&nbsp;<span class="comment" id="1631151">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631180">if</span>&nbsp;<span class="ident" id="1631183">delta</span>&nbsp;<span class="op" id="1631189">&lt;</span>&nbsp;<span class="num" id="1631191">0</span>&nbsp;<span class="op" id="1631193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1631198">//&nbsp;Synchronize&nbsp;decrements&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631238">raceReleaseMerge</span><span class="op" id="1631254">(</span><span class="ident" id="1631255">unsafe</span><span class="op" id="1631261">.</span><span class="ident" id="1631262">Pointer</span><span class="op" id="1631269">(</span><span class="ident" id="1631270">wg</span><span class="op" id="1631272">)</span><span class="op" id="1631273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631281">raceDisable</span><span class="op" id="1631292">(</span><span class="op" id="1631293">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631297">defer</span>&nbsp;<span class="ident" id="1631303">raceEnable</span><span class="op" id="1631313">(</span><span class="op" id="1631314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631320">v</span>&nbsp;<span class="op" id="1631322">:=</span>&nbsp;<span class="ident" id="1631325">atomic</span><span class="op" id="1631331">.</span><span class="ident" id="1631332">AddInt32</span><span class="op" id="1631340">(</span><span class="op" id="1631341">&amp;</span><span class="ident" id="1631342">wg</span><span class="op" id="1631344">.</span><span class="ident" id="1631345">counter</span><span class="op" id="1631352">,</span>&nbsp;<span class="builtintype" id="1631354">int32</span><span class="op" id="1631359">(</span><span class="ident" id="1631360">delta</span><span class="op" id="1631365">)</span><span class="op" id="1631366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631369">if</span>&nbsp;<span class="ident" id="1631372">raceenabled</span>&nbsp;<span class="op" id="1631384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631388">if</span>&nbsp;<span class="ident" id="1631391">delta</span>&nbsp;<span class="op" id="1631397">&gt;</span>&nbsp;<span class="num" id="1631399">0</span>&nbsp;<span class="op" id="1631401">&amp;&amp;</span>&nbsp;<span class="ident" id="1631404">v</span>&nbsp;<span class="op" id="1631406">==</span>&nbsp;<span class="builtintype" id="1631409">int32</span><span class="op" id="1631414">(</span><span class="ident" id="1631415">delta</span><span class="op" id="1631420">)</span>&nbsp;<span class="op" id="1631422">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1631427">//&nbsp;The&nbsp;first&nbsp;increment&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;Wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1631485">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;as&nbsp;a&nbsp;read,&nbsp;because&nbsp;there&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1631542">//&nbsp;several&nbsp;concurrent&nbsp;wg.counter&nbsp;transitions&nbsp;from&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631598">raceRead</span><span class="op" id="1631606">(</span><span class="ident" id="1631607">unsafe</span><span class="op" id="1631613">.</span><span class="ident" id="1631614">Pointer</span><span class="op" id="1631621">(</span><span class="op" id="1631622">&amp;</span><span class="ident" id="1631623">wg</span><span class="op" id="1631625">.</span><span class="ident" id="1631626">sema</span><span class="op" id="1631630">)</span><span class="op" id="1631631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631635">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631641">if</span>&nbsp;<span class="ident" id="1631644">v</span>&nbsp;<span class="op" id="1631646">&lt;</span>&nbsp;<span class="num" id="1631648">0</span>&nbsp;<span class="op" id="1631650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1631654">panic</span><span class="op" id="1631659">(</span><span class="string" id="1631660">&#34;sync:&nbsp;negative&nbsp;WaitGroup&nbsp;counter&#34;</span><span class="op" id="1631694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631700">if</span>&nbsp;<span class="ident" id="1631703">v</span>&nbsp;<span class="op" id="1631705">&gt;</span>&nbsp;<span class="num" id="1631707">0</span>&nbsp;<span class="op" id="1631709">||</span>&nbsp;<span class="ident" id="1631712">atomic</span><span class="op" id="1631718">.</span><span class="ident" id="1631719">LoadInt32</span><span class="op" id="1631728">(</span><span class="op" id="1631729">&amp;</span><span class="ident" id="1631730">wg</span><span class="op" id="1631732">.</span><span class="ident" id="1631733">waiters</span><span class="op" id="1631740">)</span>&nbsp;<span class="op" id="1631742">==</span>&nbsp;<span class="num" id="1631745">0</span>&nbsp;<span class="op" id="1631747">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631751">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631762">wg</span><span class="op" id="1631764">.</span><span class="ident" id="1631765">m</span><span class="op" id="1631766">.</span><span class="ident" id="1631767">Lock</span><span class="op" id="1631771">(</span><span class="op" id="1631772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631775">if</span>&nbsp;<span class="ident" id="1631778">atomic</span><span class="op" id="1631784">.</span><span class="ident" id="1631785">LoadInt32</span><span class="op" id="1631794">(</span><span class="op" id="1631795">&amp;</span><span class="ident" id="1631796">wg</span><span class="op" id="1631798">.</span><span class="ident" id="1631799">counter</span><span class="op" id="1631806">)</span>&nbsp;<span class="op" id="1631808">==</span>&nbsp;<span class="num" id="1631811">0</span>&nbsp;<span class="op" id="1631813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631817">for</span>&nbsp;<span class="ident" id="1631821">i</span>&nbsp;<span class="op" id="1631823">:=</span>&nbsp;<span class="builtintype" id="1631826">int32</span><span class="op" id="1631831">(</span><span class="num" id="1631832">0</span><span class="op" id="1631833">)</span><span class="op" id="1631834">;</span>&nbsp;<span class="ident" id="1631836">i</span>&nbsp;<span class="op" id="1631838">&lt;</span>&nbsp;<span class="ident" id="1631840">wg</span><span class="op" id="1631842">.</span><span class="ident" id="1631843">waiters</span><span class="op" id="1631850">;</span>&nbsp;<span class="ident" id="1631852">i</span><span class="op" id="1631853">++</span>&nbsp;<span class="op" id="1631856">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631861">runtime_Semrelease</span><span class="op" id="1631879">(</span><span class="ident" id="1631880">wg</span><span class="op" id="1631882">.</span><span class="ident" id="1631883">sema</span><span class="op" id="1631887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631895">wg</span><span class="op" id="1631897">.</span><span class="ident" id="1631898">waiters</span>&nbsp;<span class="op" id="1631906">=</span>&nbsp;<span class="num" id="1631908">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631912">wg</span><span class="op" id="1631914">.</span><span class="ident" id="1631915">sema</span>&nbsp;<span class="op" id="1631920">=</span>&nbsp;<span class="ident" id="1631922">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631927">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631930">wg</span><span class="op" id="1631932">.</span><span class="ident" id="1631933">m</span><span class="op" id="1631934">.</span><span class="ident" id="1631935">Unlock</span><span class="op" id="1631941">(</span><span class="op" id="1631942">)</span><br>
<span class="lineno"></span><span class="op" id="1631944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1631947">//&nbsp;Done&nbsp;decrements&nbsp;the&nbsp;WaitGroup&nbsp;counter.</span><br>
<span class="lineno"></span><span class="keyword" id="1631989">func</span>&nbsp;<span class="op" id="1631994">(</span><span class="ident" id="1631995">wg</span>&nbsp;<span class="op" id="1631998">*</span><span class="ident" id="1631999">WaitGroup</span><span class="op" id="1632008">)</span>&nbsp;<span class="ident" id="1632010">Done</span><span class="op" id="1632014">(</span><span class="op" id="1632015">)</span>&nbsp;<span class="op" id="1632017">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632020">wg</span><span class="op" id="1632022">.</span><span class="ident" id="1632023">Add</span><span class="op" id="1632026">(</span><span class="op" id="1632027">-</span><span class="num" id="1632028">1</span><span class="op" id="1632029">)</span><br>
<span class="lineno"></span><span class="op" id="1632031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1632034">//&nbsp;Wait&nbsp;blocks&nbsp;until&nbsp;the&nbsp;WaitGroup&nbsp;counter&nbsp;is&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="1632086">func</span>&nbsp;<span class="op" id="1632091">(</span><span class="ident" id="1632092">wg</span>&nbsp;<span class="op" id="1632095">*</span><span class="ident" id="1632096">WaitGroup</span><span class="op" id="1632105">)</span>&nbsp;<span class="ident" id="1632107">Wait</span><span class="op" id="1632111">(</span><span class="op" id="1632112">)</span>&nbsp;<span class="op" id="1632114">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632117">if</span>&nbsp;<span class="ident" id="1632120">raceenabled</span>&nbsp;<span class="op" id="1632132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632136">_</span>&nbsp;<span class="op" id="1632138">=</span>&nbsp;<span class="ident" id="1632140">wg</span><span class="op" id="1632142">.</span><span class="ident" id="1632143">m</span><span class="op" id="1632144">.</span><span class="ident" id="1632145">state</span>&nbsp;<span class="comment" id="1632151">//&nbsp;trigger&nbsp;nil&nbsp;deref&nbsp;early</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632180">raceDisable</span><span class="op" id="1632191">(</span><span class="op" id="1632192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632198">if</span>&nbsp;<span class="ident" id="1632201">atomic</span><span class="op" id="1632207">.</span><span class="ident" id="1632208">LoadInt32</span><span class="op" id="1632217">(</span><span class="op" id="1632218">&amp;</span><span class="ident" id="1632219">wg</span><span class="op" id="1632221">.</span><span class="ident" id="1632222">counter</span><span class="op" id="1632229">)</span>&nbsp;<span class="op" id="1632231">==</span>&nbsp;<span class="num" id="1632234">0</span>&nbsp;<span class="op" id="1632236">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632240">if</span>&nbsp;<span class="ident" id="1632243">raceenabled</span>&nbsp;<span class="op" id="1632255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632260">raceEnable</span><span class="op" id="1632270">(</span><span class="op" id="1632271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632276">raceAcquire</span><span class="op" id="1632287">(</span><span class="ident" id="1632288">unsafe</span><span class="op" id="1632294">.</span><span class="ident" id="1632295">Pointer</span><span class="op" id="1632302">(</span><span class="ident" id="1632303">wg</span><span class="op" id="1632305">)</span><span class="op" id="1632306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632314">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632325">wg</span><span class="op" id="1632327">.</span><span class="ident" id="1632328">m</span><span class="op" id="1632329">.</span><span class="ident" id="1632330">Lock</span><span class="op" id="1632334">(</span><span class="op" id="1632335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632338">w</span>&nbsp;<span class="op" id="1632340">:=</span>&nbsp;<span class="ident" id="1632343">atomic</span><span class="op" id="1632349">.</span><span class="ident" id="1632350">AddInt32</span><span class="op" id="1632358">(</span><span class="op" id="1632359">&amp;</span><span class="ident" id="1632360">wg</span><span class="op" id="1632362">.</span><span class="ident" id="1632363">waiters</span><span class="op" id="1632370">,</span>&nbsp;<span class="num" id="1632372">1</span><span class="op" id="1632373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632376">//&nbsp;This&nbsp;code&nbsp;is&nbsp;racing&nbsp;with&nbsp;the&nbsp;unlocked&nbsp;path&nbsp;in&nbsp;Add&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632437">//&nbsp;The&nbsp;code&nbsp;above&nbsp;modifies&nbsp;counter&nbsp;and&nbsp;then&nbsp;reads&nbsp;waiters.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632497">//&nbsp;We&nbsp;must&nbsp;modify&nbsp;waiters&nbsp;and&nbsp;then&nbsp;read&nbsp;counter&nbsp;(the&nbsp;opposite&nbsp;order)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632567">//&nbsp;to&nbsp;avoid&nbsp;missing&nbsp;an&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632596">if</span>&nbsp;<span class="ident" id="1632599">atomic</span><span class="op" id="1632605">.</span><span class="ident" id="1632606">LoadInt32</span><span class="op" id="1632615">(</span><span class="op" id="1632616">&amp;</span><span class="ident" id="1632617">wg</span><span class="op" id="1632619">.</span><span class="ident" id="1632620">counter</span><span class="op" id="1632627">)</span>&nbsp;<span class="op" id="1632629">==</span>&nbsp;<span class="num" id="1632632">0</span>&nbsp;<span class="op" id="1632634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632638">atomic</span><span class="op" id="1632644">.</span><span class="ident" id="1632645">AddInt32</span><span class="op" id="1632653">(</span><span class="op" id="1632654">&amp;</span><span class="ident" id="1632655">wg</span><span class="op" id="1632657">.</span><span class="ident" id="1632658">waiters</span><span class="op" id="1632665">,</span>&nbsp;<span class="op" id="1632667">-</span><span class="num" id="1632668">1</span><span class="op" id="1632669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632673">if</span>&nbsp;<span class="ident" id="1632676">raceenabled</span>&nbsp;<span class="op" id="1632688">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632693">raceEnable</span><span class="op" id="1632703">(</span><span class="op" id="1632704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632709">raceAcquire</span><span class="op" id="1632720">(</span><span class="ident" id="1632721">unsafe</span><span class="op" id="1632727">.</span><span class="ident" id="1632728">Pointer</span><span class="op" id="1632735">(</span><span class="ident" id="1632736">wg</span><span class="op" id="1632738">)</span><span class="op" id="1632739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632744">raceDisable</span><span class="op" id="1632755">(</span><span class="op" id="1632756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632764">wg</span><span class="op" id="1632766">.</span><span class="ident" id="1632767">m</span><span class="op" id="1632768">.</span><span class="ident" id="1632769">Unlock</span><span class="op" id="1632775">(</span><span class="op" id="1632776">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632780">if</span>&nbsp;<span class="ident" id="1632783">raceenabled</span>&nbsp;<span class="op" id="1632795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632800">raceEnable</span><span class="op" id="1632810">(</span><span class="op" id="1632811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632819">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632827">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632830">if</span>&nbsp;<span class="ident" id="1632833">raceenabled</span>&nbsp;<span class="op" id="1632845">&amp;&amp;</span>&nbsp;<span class="ident" id="1632848">w</span>&nbsp;<span class="op" id="1632850">==</span>&nbsp;<span class="num" id="1632853">1</span>&nbsp;<span class="op" id="1632855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632859">//&nbsp;Wait&nbsp;must&nbsp;be&nbsp;synchronized&nbsp;with&nbsp;the&nbsp;first&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632910">//&nbsp;Need&nbsp;to&nbsp;model&nbsp;this&nbsp;is&nbsp;as&nbsp;a&nbsp;write&nbsp;to&nbsp;race&nbsp;with&nbsp;the&nbsp;read&nbsp;in&nbsp;Add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632978">//&nbsp;As&nbsp;a&nbsp;consequence,&nbsp;can&nbsp;do&nbsp;the&nbsp;write&nbsp;only&nbsp;for&nbsp;the&nbsp;first&nbsp;waiter,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633045">//&nbsp;otherwise&nbsp;concurrent&nbsp;Waits&nbsp;will&nbsp;race&nbsp;with&nbsp;each&nbsp;other.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633104">raceWrite</span><span class="op" id="1633113">(</span><span class="ident" id="1633114">unsafe</span><span class="op" id="1633120">.</span><span class="ident" id="1633121">Pointer</span><span class="op" id="1633128">(</span><span class="op" id="1633129">&amp;</span><span class="ident" id="1633130">wg</span><span class="op" id="1633132">.</span><span class="ident" id="1633133">sema</span><span class="op" id="1633137">)</span><span class="op" id="1633138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633144">if</span>&nbsp;<span class="ident" id="1633147">wg</span><span class="op" id="1633149">.</span><span class="ident" id="1633150">sema</span>&nbsp;<span class="op" id="1633155">==</span>&nbsp;<span class="ident" id="1633158">nil</span>&nbsp;<span class="op" id="1633162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633166">wg</span><span class="op" id="1633168">.</span><span class="ident" id="1633169">sema</span>&nbsp;<span class="op" id="1633174">=</span>&nbsp;<span class="builtinfunc" id="1633176">new</span><span class="op" id="1633179">(</span><span class="builtintype" id="1633180">uint32</span><span class="op" id="1633186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633189">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633192">s</span>&nbsp;<span class="op" id="1633194">:=</span>&nbsp;<span class="ident" id="1633197">wg</span><span class="op" id="1633199">.</span><span class="ident" id="1633200">sema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633206">wg</span><span class="op" id="1633208">.</span><span class="ident" id="1633209">m</span><span class="op" id="1633210">.</span><span class="ident" id="1633211">Unlock</span><span class="op" id="1633217">(</span><span class="op" id="1633218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633221">runtime_Semacquire</span><span class="op" id="1633239">(</span><span class="ident" id="1633240">s</span><span class="op" id="1633241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633244">if</span>&nbsp;<span class="ident" id="1633247">raceenabled</span>&nbsp;<span class="op" id="1633259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633263">raceEnable</span><span class="op" id="1633273">(</span><span class="op" id="1633274">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633278">raceAcquire</span><span class="op" id="1633289">(</span><span class="ident" id="1633290">unsafe</span><span class="op" id="1633296">.</span><span class="ident" id="1633297">Pointer</span><span class="op" id="1633304">(</span><span class="ident" id="1633305">wg</span><span class="op" id="1633307">)</span><span class="op" id="1633308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633311">}</span><br>
<span class="lineno"></span><span class="op" id="1633313">}</span>
</div>
</body>
</html>
