<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3838703">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3838758">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3838812">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3838863">//&nbsp;CFB&nbsp;(Cipher&nbsp;Feedback)&nbsp;Mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3838895">package</span>&nbsp;<span class="ident" id="3838903">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3838911">type</span>&nbsp;<span class="ident" id="3838916">cfb</span>&nbsp;<span class="keyword" id="3838920">struct</span>&nbsp;<span class="op" id="3838927">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838930">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838938">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838945">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3838953">[</span><span class="op" id="3838954">]</span><span class="builtintype" id="3838955">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838961">out</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3838969">[</span><span class="op" id="3838970">]</span><span class="builtintype" id="3838971">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838977">outUsed</span>&nbsp;<span class="builtintype" id="3838985">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838991">decrypt</span>&nbsp;<span class="builtintype" id="3838999">bool</span><br>
<span class="lineno"></span><span class="op" id="3839004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3839007">func</span>&nbsp;<span class="op" id="3839012">(</span><span class="ident" id="3839013">x</span>&nbsp;<span class="op" id="3839015">*</span><span class="ident" id="3839016">cfb</span><span class="op" id="3839019">)</span>&nbsp;<span class="ident" id="3839021">XORKeyStream</span><span class="op" id="3839033">(</span><span class="ident" id="3839034">dst</span><span class="op" id="3839037">,</span>&nbsp;<span class="ident" id="3839039">src</span>&nbsp;<span class="op" id="3839043">[</span><span class="op" id="3839044">]</span><span class="builtintype" id="3839045">byte</span><span class="op" id="3839049">)</span>&nbsp;<span class="op" id="3839051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839054">for</span>&nbsp;<span class="builtinfunc" id="3839058">len</span><span class="op" id="3839061">(</span><span class="ident" id="3839062">src</span><span class="op" id="3839065">)</span>&nbsp;<span class="op" id="3839067">&gt;</span>&nbsp;<span class="num" id="3839069">0</span>&nbsp;<span class="op" id="3839071">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839075">if</span>&nbsp;<span class="ident" id="3839078">x</span><span class="op" id="3839079">.</span><span class="ident" id="3839080">outUsed</span>&nbsp;<span class="op" id="3839088">==</span>&nbsp;<span class="builtinfunc" id="3839091">len</span><span class="op" id="3839094">(</span><span class="ident" id="3839095">x</span><span class="op" id="3839096">.</span><span class="ident" id="3839097">out</span><span class="op" id="3839100">)</span>&nbsp;<span class="op" id="3839102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839107">x</span><span class="op" id="3839108">.</span><span class="ident" id="3839109">b</span><span class="op" id="3839110">.</span><span class="ident" id="3839111">Encrypt</span><span class="op" id="3839118">(</span><span class="ident" id="3839119">x</span><span class="op" id="3839120">.</span><span class="ident" id="3839121">out</span><span class="op" id="3839124">,</span>&nbsp;<span class="ident" id="3839126">x</span><span class="op" id="3839127">.</span><span class="ident" id="3839128">next</span><span class="op" id="3839132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839137">x</span><span class="op" id="3839138">.</span><span class="ident" id="3839139">outUsed</span>&nbsp;<span class="op" id="3839147">=</span>&nbsp;<span class="num" id="3839149">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839153">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839158">if</span>&nbsp;<span class="ident" id="3839161">x</span><span class="op" id="3839162">.</span><span class="ident" id="3839163">decrypt</span>&nbsp;<span class="op" id="3839171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3839176">//&nbsp;We&nbsp;can&nbsp;precompute&nbsp;a&nbsp;larger&nbsp;segment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3839224">//&nbsp;keystream&nbsp;on&nbsp;decryption.&nbsp;This&nbsp;will&nbsp;allow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3839271">//&nbsp;larger&nbsp;batches&nbsp;for&nbsp;xor,&nbsp;and&nbsp;we&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3839318">//&nbsp;able&nbsp;to&nbsp;match&nbsp;CTR/OFB&nbsp;performance.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3839359">copy</span><span class="op" id="3839363">(</span><span class="ident" id="3839364">x</span><span class="op" id="3839365">.</span><span class="ident" id="3839366">next</span><span class="op" id="3839370">[</span><span class="ident" id="3839371">x</span><span class="op" id="3839372">.</span><span class="ident" id="3839373">outUsed</span><span class="op" id="3839380">:</span><span class="op" id="3839381">]</span><span class="op" id="3839382">,</span>&nbsp;<span class="ident" id="3839384">src</span><span class="op" id="3839387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839395">n</span>&nbsp;<span class="op" id="3839397">:=</span>&nbsp;<span class="ident" id="3839400">xorBytes</span><span class="op" id="3839408">(</span><span class="ident" id="3839409">dst</span><span class="op" id="3839412">,</span>&nbsp;<span class="ident" id="3839414">src</span><span class="op" id="3839417">,</span>&nbsp;<span class="ident" id="3839419">x</span><span class="op" id="3839420">.</span><span class="ident" id="3839421">out</span><span class="op" id="3839424">[</span><span class="ident" id="3839425">x</span><span class="op" id="3839426">.</span><span class="ident" id="3839427">outUsed</span><span class="op" id="3839434">:</span><span class="op" id="3839435">]</span><span class="op" id="3839436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839440">if</span>&nbsp;<span class="op" id="3839443">!</span><span class="ident" id="3839444">x</span><span class="op" id="3839445">.</span><span class="ident" id="3839446">decrypt</span>&nbsp;<span class="op" id="3839454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3839459">copy</span><span class="op" id="3839463">(</span><span class="ident" id="3839464">x</span><span class="op" id="3839465">.</span><span class="ident" id="3839466">next</span><span class="op" id="3839470">[</span><span class="ident" id="3839471">x</span><span class="op" id="3839472">.</span><span class="ident" id="3839473">outUsed</span><span class="op" id="3839480">:</span><span class="op" id="3839481">]</span><span class="op" id="3839482">,</span>&nbsp;<span class="ident" id="3839484">dst</span><span class="op" id="3839487">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839495">dst</span>&nbsp;<span class="op" id="3839499">=</span>&nbsp;<span class="ident" id="3839501">dst</span><span class="op" id="3839504">[</span><span class="ident" id="3839505">n</span><span class="op" id="3839506">:</span><span class="op" id="3839507">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839511">src</span>&nbsp;<span class="op" id="3839515">=</span>&nbsp;<span class="ident" id="3839517">src</span><span class="op" id="3839520">[</span><span class="ident" id="3839521">n</span><span class="op" id="3839522">:</span><span class="op" id="3839523">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839527">x</span><span class="op" id="3839528">.</span><span class="ident" id="3839529">outUsed</span>&nbsp;<span class="op" id="3839537">+=</span>&nbsp;<span class="ident" id="3839540">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839543">}</span><br>
<span class="lineno">40</span><span class="op" id="3839545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3839548">//&nbsp;NewCFBEncrypter&nbsp;returns&nbsp;a&nbsp;Stream&nbsp;which&nbsp;encrypts&nbsp;with&nbsp;cipher&nbsp;feedback&nbsp;mode,</span><br>
<span class="lineno"></span><span class="comment" id="3839626">//&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;length&nbsp;as&nbsp;the&nbsp;Block&#39;s&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3839704">//&nbsp;size.</span><br>
<span class="lineno">45</span><span class="keyword" id="3839713">func</span>&nbsp;<span class="ident" id="3839718">NewCFBEncrypter</span><span class="op" id="3839733">(</span><span class="ident" id="3839734">block</span>&nbsp;<span class="ident" id="3839740">Block</span><span class="op" id="3839745">,</span>&nbsp;<span class="ident" id="3839747">iv</span>&nbsp;<span class="op" id="3839750">[</span><span class="op" id="3839751">]</span><span class="builtintype" id="3839752">byte</span><span class="op" id="3839756">)</span>&nbsp;<span class="ident" id="3839758">Stream</span>&nbsp;<span class="op" id="3839765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839768">return</span>&nbsp;<span class="ident" id="3839775">newCFB</span><span class="op" id="3839781">(</span><span class="ident" id="3839782">block</span><span class="op" id="3839787">,</span>&nbsp;<span class="ident" id="3839789">iv</span><span class="op" id="3839791">,</span>&nbsp;<span class="ident" id="3839793">false</span><span class="op" id="3839798">)</span><br>
<span class="lineno"></span><span class="op" id="3839800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3839803">//&nbsp;NewCFBDecrypter&nbsp;returns&nbsp;a&nbsp;Stream&nbsp;which&nbsp;decrypts&nbsp;with&nbsp;cipher&nbsp;feedback&nbsp;mode,</span><br>
<span class="lineno">50</span><span class="comment" id="3839881">//&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;length&nbsp;as&nbsp;the&nbsp;Block&#39;s&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3839959">//&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="3839968">func</span>&nbsp;<span class="ident" id="3839973">NewCFBDecrypter</span><span class="op" id="3839988">(</span><span class="ident" id="3839989">block</span>&nbsp;<span class="ident" id="3839995">Block</span><span class="op" id="3840000">,</span>&nbsp;<span class="ident" id="3840002">iv</span>&nbsp;<span class="op" id="3840005">[</span><span class="op" id="3840006">]</span><span class="builtintype" id="3840007">byte</span><span class="op" id="3840011">)</span>&nbsp;<span class="ident" id="3840013">Stream</span>&nbsp;<span class="op" id="3840020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840023">return</span>&nbsp;<span class="ident" id="3840030">newCFB</span><span class="op" id="3840036">(</span><span class="ident" id="3840037">block</span><span class="op" id="3840042">,</span>&nbsp;<span class="ident" id="3840044">iv</span><span class="op" id="3840046">,</span>&nbsp;<span class="ident" id="3840048">true</span><span class="op" id="3840052">)</span><br>
<span class="lineno"></span><span class="op" id="3840054">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="3840057">func</span>&nbsp;<span class="ident" id="3840062">newCFB</span><span class="op" id="3840068">(</span><span class="ident" id="3840069">block</span>&nbsp;<span class="ident" id="3840075">Block</span><span class="op" id="3840080">,</span>&nbsp;<span class="ident" id="3840082">iv</span>&nbsp;<span class="op" id="3840085">[</span><span class="op" id="3840086">]</span><span class="builtintype" id="3840087">byte</span><span class="op" id="3840091">,</span>&nbsp;<span class="ident" id="3840093">decrypt</span>&nbsp;<span class="builtintype" id="3840101">bool</span><span class="op" id="3840105">)</span>&nbsp;<span class="ident" id="3840107">Stream</span>&nbsp;<span class="op" id="3840114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840117">blockSize</span>&nbsp;<span class="op" id="3840127">:=</span>&nbsp;<span class="ident" id="3840130">block</span><span class="op" id="3840135">.</span><span class="ident" id="3840136">BlockSize</span><span class="op" id="3840145">(</span><span class="op" id="3840146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840149">if</span>&nbsp;<span class="builtinfunc" id="3840152">len</span><span class="op" id="3840155">(</span><span class="ident" id="3840156">iv</span><span class="op" id="3840158">)</span>&nbsp;<span class="op" id="3840160">!=</span>&nbsp;<span class="ident" id="3840163">blockSize</span>&nbsp;<span class="op" id="3840173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3840177">//&nbsp;stack&nbsp;trace&nbsp;will&nbsp;indicate&nbsp;whether&nbsp;it&nbsp;was&nbsp;de&nbsp;or&nbsp;encryption</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3840240">panic</span><span class="op" id="3840245">(</span><span class="string" id="3840246">&#34;cipher.newCFB:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3840294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840300">x</span>&nbsp;<span class="op" id="3840302">:=</span>&nbsp;<span class="op" id="3840305">&amp;</span><span class="ident" id="3840306">cfb</span><span class="op" id="3840309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840313">b</span><span class="op" id="3840314">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3840322">block</span><span class="op" id="3840327">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840331">out</span><span class="op" id="3840334">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3840340">make</span><span class="op" id="3840344">(</span><span class="op" id="3840345">[</span><span class="op" id="3840346">]</span><span class="builtintype" id="3840347">byte</span><span class="op" id="3840351">,</span>&nbsp;<span class="ident" id="3840353">blockSize</span><span class="op" id="3840362">)</span><span class="op" id="3840363">,</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840367">next</span><span class="op" id="3840371">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3840376">make</span><span class="op" id="3840380">(</span><span class="op" id="3840381">[</span><span class="op" id="3840382">]</span><span class="builtintype" id="3840383">byte</span><span class="op" id="3840387">,</span>&nbsp;<span class="ident" id="3840389">blockSize</span><span class="op" id="3840398">)</span><span class="op" id="3840399">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840403">outUsed</span><span class="op" id="3840410">:</span>&nbsp;<span class="ident" id="3840412">blockSize</span><span class="op" id="3840421">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840425">decrypt</span><span class="op" id="3840432">:</span>&nbsp;<span class="ident" id="3840434">decrypt</span><span class="op" id="3840441">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3840447">copy</span><span class="op" id="3840451">(</span><span class="ident" id="3840452">x</span><span class="op" id="3840453">.</span><span class="ident" id="3840454">next</span><span class="op" id="3840458">,</span>&nbsp;<span class="ident" id="3840460">iv</span><span class="op" id="3840462">)</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840466">return</span>&nbsp;<span class="ident" id="3840473">x</span><br>
<span class="lineno"></span><span class="op" id="3840475">}</span>
</div>
</body>
</html>
