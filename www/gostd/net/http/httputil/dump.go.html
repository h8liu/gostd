<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html" class="current">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6020045">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6020100">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6020154">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6020205">package</span>&nbsp;<span class="ident" id="6020213">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6020223">import</span>&nbsp;<span class="op" id="6020230">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6020233">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6020242">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6020251">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6020261">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6020268">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6020274">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6020287">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6020294">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6020306">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6020317">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6020328">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6020335">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="6020338">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="6020411">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="6020490">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6020567">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="6020586">func</span>&nbsp;<span class="ident" id="6020591">drainBody</span><span class="op" id="6020600">(</span><span class="ident" id="6020601">b</span>&nbsp;<span class="ident" id="6020603">io</span><span class="op" id="6020605">.</span><span class="ident" id="6020606">ReadCloser</span><span class="op" id="6020616">)</span>&nbsp;<span class="op" id="6020618">(</span><span class="ident" id="6020619">r1</span><span class="op" id="6020621">,</span>&nbsp;<span class="ident" id="6020623">r2</span>&nbsp;<span class="ident" id="6020626">io</span><span class="op" id="6020628">.</span><span class="ident" id="6020629">ReadCloser</span><span class="op" id="6020639">,</span>&nbsp;<span class="ident" id="6020641">err</span>&nbsp;<span class="builtintype" id="6020645">error</span><span class="op" id="6020650">)</span>&nbsp;<span class="op" id="6020652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020655">var</span>&nbsp;<span class="ident" id="6020659">buf</span>&nbsp;<span class="ident" id="6020663">bytes</span><span class="op" id="6020668">.</span><span class="ident" id="6020669">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020677">if</span>&nbsp;<span class="ident" id="6020680">_</span><span class="op" id="6020681">,</span>&nbsp;<span class="ident" id="6020683">err</span>&nbsp;<span class="op" id="6020687">=</span>&nbsp;<span class="ident" id="6020689">buf</span><span class="op" id="6020692">.</span><span class="ident" id="6020693">ReadFrom</span><span class="op" id="6020701">(</span><span class="ident" id="6020702">b</span><span class="op" id="6020703">)</span><span class="op" id="6020704">;</span>&nbsp;<span class="ident" id="6020706">err</span>&nbsp;<span class="op" id="6020710">!=</span>&nbsp;<span class="ident" id="6020713">nil</span>&nbsp;<span class="op" id="6020717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020721">return</span>&nbsp;<span class="ident" id="6020728">nil</span><span class="op" id="6020731">,</span>&nbsp;<span class="ident" id="6020733">nil</span><span class="op" id="6020736">,</span>&nbsp;<span class="ident" id="6020738">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6020743">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020746">if</span>&nbsp;<span class="ident" id="6020749">err</span>&nbsp;<span class="op" id="6020753">=</span>&nbsp;<span class="ident" id="6020755">b</span><span class="op" id="6020756">.</span><span class="ident" id="6020757">Close</span><span class="op" id="6020762">(</span><span class="op" id="6020763">)</span><span class="op" id="6020764">;</span>&nbsp;<span class="ident" id="6020766">err</span>&nbsp;<span class="op" id="6020770">!=</span>&nbsp;<span class="ident" id="6020773">nil</span>&nbsp;<span class="op" id="6020777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020781">return</span>&nbsp;<span class="ident" id="6020788">nil</span><span class="op" id="6020791">,</span>&nbsp;<span class="ident" id="6020793">nil</span><span class="op" id="6020796">,</span>&nbsp;<span class="ident" id="6020798">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6020803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6020806">return</span>&nbsp;<span class="ident" id="6020813">ioutil</span><span class="op" id="6020819">.</span><span class="ident" id="6020820">NopCloser</span><span class="op" id="6020829">(</span><span class="op" id="6020830">&amp;</span><span class="ident" id="6020831">buf</span><span class="op" id="6020834">)</span><span class="op" id="6020835">,</span>&nbsp;<span class="ident" id="6020837">ioutil</span><span class="op" id="6020843">.</span><span class="ident" id="6020844">NopCloser</span><span class="op" id="6020853">(</span><span class="ident" id="6020854">bytes</span><span class="op" id="6020859">.</span><span class="ident" id="6020860">NewReader</span><span class="op" id="6020869">(</span><span class="ident" id="6020870">buf</span><span class="op" id="6020873">.</span><span class="ident" id="6020874">Bytes</span><span class="op" id="6020879">(</span><span class="op" id="6020880">)</span><span class="op" id="6020881">)</span><span class="op" id="6020882">)</span><span class="op" id="6020883">,</span>&nbsp;<span class="ident" id="6020885">nil</span><br>
<span class="lineno"></span><span class="op" id="6020889">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="6020892">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="6020963">type</span>&nbsp;<span class="ident" id="6020968">dumpConn</span>&nbsp;<span class="keyword" id="6020977">struct</span>&nbsp;<span class="op" id="6020984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6020987">io</span><span class="op" id="6020989">.</span><span class="ident" id="6020990">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6020998">io</span><span class="op" id="6021000">.</span><span class="ident" id="6021001">Reader</span><br>
<span class="lineno">40</span><span class="op" id="6021008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6021011">func</span>&nbsp;<span class="op" id="6021016">(</span><span class="ident" id="6021017">c</span>&nbsp;<span class="op" id="6021019">*</span><span class="ident" id="6021020">dumpConn</span><span class="op" id="6021028">)</span>&nbsp;<span class="ident" id="6021030">Close</span><span class="op" id="6021035">(</span><span class="op" id="6021036">)</span>&nbsp;<span class="builtintype" id="6021038">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6021066">{</span>&nbsp;<span class="keyword" id="6021068">return</span>&nbsp;<span class="ident" id="6021075">nil</span>&nbsp;<span class="op" id="6021079">}</span><br>
<span class="lineno"></span><span class="keyword" id="6021081">func</span>&nbsp;<span class="op" id="6021086">(</span><span class="ident" id="6021087">c</span>&nbsp;<span class="op" id="6021089">*</span><span class="ident" id="6021090">dumpConn</span><span class="op" id="6021098">)</span>&nbsp;<span class="ident" id="6021100">LocalAddr</span><span class="op" id="6021109">(</span><span class="op" id="6021110">)</span>&nbsp;<span class="ident" id="6021112">net</span><span class="op" id="6021115">.</span><span class="ident" id="6021116">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6021136">{</span>&nbsp;<span class="keyword" id="6021138">return</span>&nbsp;<span class="ident" id="6021145">nil</span>&nbsp;<span class="op" id="6021149">}</span><br>
<span class="lineno"></span><span class="keyword" id="6021151">func</span>&nbsp;<span class="op" id="6021156">(</span><span class="ident" id="6021157">c</span>&nbsp;<span class="op" id="6021159">*</span><span class="ident" id="6021160">dumpConn</span><span class="op" id="6021168">)</span>&nbsp;<span class="ident" id="6021170">RemoteAddr</span><span class="op" id="6021180">(</span><span class="op" id="6021181">)</span>&nbsp;<span class="ident" id="6021183">net</span><span class="op" id="6021186">.</span><span class="ident" id="6021187">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6021206">{</span>&nbsp;<span class="keyword" id="6021208">return</span>&nbsp;<span class="ident" id="6021215">nil</span>&nbsp;<span class="op" id="6021219">}</span><br>
<span class="lineno">45</span><span class="keyword" id="6021221">func</span>&nbsp;<span class="op" id="6021226">(</span><span class="ident" id="6021227">c</span>&nbsp;<span class="op" id="6021229">*</span><span class="ident" id="6021230">dumpConn</span><span class="op" id="6021238">)</span>&nbsp;<span class="ident" id="6021240">SetDeadline</span><span class="op" id="6021251">(</span><span class="ident" id="6021252">t</span>&nbsp;<span class="ident" id="6021254">time</span><span class="op" id="6021258">.</span><span class="ident" id="6021259">Time</span><span class="op" id="6021263">)</span>&nbsp;<span class="builtintype" id="6021265">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6021276">{</span>&nbsp;<span class="keyword" id="6021278">return</span>&nbsp;<span class="ident" id="6021285">nil</span>&nbsp;<span class="op" id="6021289">}</span><br>
<span class="lineno"></span><span class="keyword" id="6021291">func</span>&nbsp;<span class="op" id="6021296">(</span><span class="ident" id="6021297">c</span>&nbsp;<span class="op" id="6021299">*</span><span class="ident" id="6021300">dumpConn</span><span class="op" id="6021308">)</span>&nbsp;<span class="ident" id="6021310">SetReadDeadline</span><span class="op" id="6021325">(</span><span class="ident" id="6021326">t</span>&nbsp;<span class="ident" id="6021328">time</span><span class="op" id="6021332">.</span><span class="ident" id="6021333">Time</span><span class="op" id="6021337">)</span>&nbsp;<span class="builtintype" id="6021339">error</span>&nbsp;&nbsp;<span class="op" id="6021346">{</span>&nbsp;<span class="keyword" id="6021348">return</span>&nbsp;<span class="ident" id="6021355">nil</span>&nbsp;<span class="op" id="6021359">}</span><br>
<span class="lineno"></span><span class="keyword" id="6021361">func</span>&nbsp;<span class="op" id="6021366">(</span><span class="ident" id="6021367">c</span>&nbsp;<span class="op" id="6021369">*</span><span class="ident" id="6021370">dumpConn</span><span class="op" id="6021378">)</span>&nbsp;<span class="ident" id="6021380">SetWriteDeadline</span><span class="op" id="6021396">(</span><span class="ident" id="6021397">t</span>&nbsp;<span class="ident" id="6021399">time</span><span class="op" id="6021403">.</span><span class="ident" id="6021404">Time</span><span class="op" id="6021408">)</span>&nbsp;<span class="builtintype" id="6021410">error</span>&nbsp;<span class="op" id="6021416">{</span>&nbsp;<span class="keyword" id="6021418">return</span>&nbsp;<span class="ident" id="6021425">nil</span>&nbsp;<span class="op" id="6021429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6021432">type</span>&nbsp;<span class="ident" id="6021437">neverEnding</span>&nbsp;<span class="builtintype" id="6021449">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6021455">func</span>&nbsp;<span class="op" id="6021460">(</span><span class="ident" id="6021461">b</span>&nbsp;<span class="ident" id="6021463">neverEnding</span><span class="op" id="6021474">)</span>&nbsp;<span class="ident" id="6021476">Read</span><span class="op" id="6021480">(</span><span class="ident" id="6021481">p</span>&nbsp;<span class="op" id="6021483">[</span><span class="op" id="6021484">]</span><span class="builtintype" id="6021485">byte</span><span class="op" id="6021489">)</span>&nbsp;<span class="op" id="6021491">(</span><span class="ident" id="6021492">n</span>&nbsp;<span class="builtintype" id="6021494">int</span><span class="op" id="6021497">,</span>&nbsp;<span class="ident" id="6021499">err</span>&nbsp;<span class="builtintype" id="6021503">error</span><span class="op" id="6021508">)</span>&nbsp;<span class="op" id="6021510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6021513">for</span>&nbsp;<span class="ident" id="6021517">i</span>&nbsp;<span class="op" id="6021519">:=</span>&nbsp;<span class="keyword" id="6021522">range</span>&nbsp;<span class="ident" id="6021528">p</span>&nbsp;<span class="op" id="6021530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021534">p</span><span class="op" id="6021535">[</span><span class="ident" id="6021536">i</span><span class="op" id="6021537">]</span>&nbsp;<span class="op" id="6021539">=</span>&nbsp;<span class="builtintype" id="6021541">byte</span><span class="op" id="6021545">(</span><span class="ident" id="6021546">b</span><span class="op" id="6021547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6021550">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6021553">return</span>&nbsp;<span class="builtinfunc" id="6021560">len</span><span class="op" id="6021563">(</span><span class="ident" id="6021564">p</span><span class="op" id="6021565">)</span><span class="op" id="6021566">,</span>&nbsp;<span class="ident" id="6021568">nil</span><br>
<span class="lineno"></span><span class="op" id="6021572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6021575">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="6021626">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="6021676">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="6021699">func</span>&nbsp;<span class="ident" id="6021704">DumpRequestOut</span><span class="op" id="6021718">(</span><span class="ident" id="6021719">req</span>&nbsp;<span class="op" id="6021723">*</span><span class="ident" id="6021724">http</span><span class="op" id="6021728">.</span><span class="ident" id="6021729">Request</span><span class="op" id="6021736">,</span>&nbsp;<span class="ident" id="6021738">body</span>&nbsp;<span class="builtintype" id="6021743">bool</span><span class="op" id="6021747">)</span>&nbsp;<span class="op" id="6021749">(</span><span class="op" id="6021750">[</span><span class="op" id="6021751">]</span><span class="builtintype" id="6021752">byte</span><span class="op" id="6021756">,</span>&nbsp;<span class="builtintype" id="6021758">error</span><span class="op" id="6021763">)</span>&nbsp;<span class="op" id="6021765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021768">save</span>&nbsp;<span class="op" id="6021773">:=</span>&nbsp;<span class="ident" id="6021776">req</span><span class="op" id="6021779">.</span><span class="ident" id="6021780">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021786">dummyBody</span>&nbsp;<span class="op" id="6021796">:=</span>&nbsp;<span class="builtintype" id="6021799">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6021806">if</span>&nbsp;<span class="op" id="6021809">!</span><span class="ident" id="6021810">body</span>&nbsp;<span class="op" id="6021815">||</span>&nbsp;<span class="ident" id="6021818">req</span><span class="op" id="6021821">.</span><span class="ident" id="6021822">Body</span>&nbsp;<span class="op" id="6021827">==</span>&nbsp;<span class="ident" id="6021830">nil</span>&nbsp;<span class="op" id="6021834">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021838">req</span><span class="op" id="6021841">.</span><span class="ident" id="6021842">Body</span>&nbsp;<span class="op" id="6021847">=</span>&nbsp;<span class="ident" id="6021849">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6021855">if</span>&nbsp;<span class="ident" id="6021858">req</span><span class="op" id="6021861">.</span><span class="ident" id="6021862">ContentLength</span>&nbsp;<span class="op" id="6021876">!=</span>&nbsp;<span class="num" id="6021879">0</span>&nbsp;<span class="op" id="6021881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021886">req</span><span class="op" id="6021889">.</span><span class="ident" id="6021890">Body</span>&nbsp;<span class="op" id="6021895">=</span>&nbsp;<span class="ident" id="6021897">ioutil</span><span class="op" id="6021903">.</span><span class="ident" id="6021904">NopCloser</span><span class="op" id="6021913">(</span><span class="ident" id="6021914">io</span><span class="op" id="6021916">.</span><span class="ident" id="6021917">LimitReader</span><span class="op" id="6021928">(</span><span class="ident" id="6021929">neverEnding</span><span class="op" id="6021940">(</span><span class="string" id="6021941">&#39;x&#39;</span><span class="op" id="6021944">)</span><span class="op" id="6021945">,</span>&nbsp;<span class="ident" id="6021947">req</span><span class="op" id="6021950">.</span><span class="ident" id="6021951">ContentLength</span><span class="op" id="6021964">)</span><span class="op" id="6021965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6021970">dummyBody</span>&nbsp;<span class="op" id="6021980">=</span>&nbsp;<span class="builtintype" id="6021982">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6021989">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6021992">}</span>&nbsp;<span class="keyword" id="6021994">else</span>&nbsp;<span class="op" id="6021999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022003">var</span>&nbsp;<span class="ident" id="6022007">err</span>&nbsp;<span class="builtintype" id="6022011">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022019">save</span><span class="op" id="6022023">,</span>&nbsp;<span class="ident" id="6022025">req</span><span class="op" id="6022028">.</span><span class="ident" id="6022029">Body</span><span class="op" id="6022033">,</span>&nbsp;<span class="ident" id="6022035">err</span>&nbsp;<span class="op" id="6022039">=</span>&nbsp;<span class="ident" id="6022041">drainBody</span><span class="op" id="6022050">(</span><span class="ident" id="6022051">req</span><span class="op" id="6022054">.</span><span class="ident" id="6022055">Body</span><span class="op" id="6022059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022063">if</span>&nbsp;<span class="ident" id="6022066">err</span>&nbsp;<span class="op" id="6022070">!=</span>&nbsp;<span class="ident" id="6022073">nil</span>&nbsp;<span class="op" id="6022077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022082">return</span>&nbsp;<span class="ident" id="6022089">nil</span><span class="op" id="6022092">,</span>&nbsp;<span class="ident" id="6022094">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6022100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6022103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022107">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022177">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022238">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022301">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022362">reqSend</span>&nbsp;<span class="op" id="6022370">:=</span>&nbsp;<span class="ident" id="6022373">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022378">if</span>&nbsp;<span class="ident" id="6022381">req</span><span class="op" id="6022384">.</span><span class="ident" id="6022385">URL</span><span class="op" id="6022388">.</span><span class="ident" id="6022389">Scheme</span>&nbsp;<span class="op" id="6022396">==</span>&nbsp;<span class="string" id="6022399">&#34;https&#34;</span>&nbsp;<span class="op" id="6022407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022411">reqSend</span>&nbsp;<span class="op" id="6022419">=</span>&nbsp;<span class="builtinfunc" id="6022421">new</span><span class="op" id="6022424">(</span><span class="ident" id="6022425">http</span><span class="op" id="6022429">.</span><span class="ident" id="6022430">Request</span><span class="op" id="6022437">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6022441">*</span><span class="ident" id="6022442">reqSend</span>&nbsp;<span class="op" id="6022450">=</span>&nbsp;<span class="op" id="6022452">*</span><span class="ident" id="6022453">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022459">reqSend</span><span class="op" id="6022466">.</span><span class="ident" id="6022467">URL</span>&nbsp;<span class="op" id="6022471">=</span>&nbsp;<span class="builtinfunc" id="6022473">new</span><span class="op" id="6022476">(</span><span class="ident" id="6022477">url</span><span class="op" id="6022480">.</span><span class="ident" id="6022481">URL</span><span class="op" id="6022484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6022488">*</span><span class="ident" id="6022489">reqSend</span><span class="op" id="6022496">.</span><span class="ident" id="6022497">URL</span>&nbsp;<span class="op" id="6022501">=</span>&nbsp;<span class="op" id="6022503">*</span><span class="ident" id="6022504">req</span><span class="op" id="6022507">.</span><span class="ident" id="6022508">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022514">reqSend</span><span class="op" id="6022521">.</span><span class="ident" id="6022522">URL</span><span class="op" id="6022525">.</span><span class="ident" id="6022526">Scheme</span>&nbsp;<span class="op" id="6022533">=</span>&nbsp;<span class="string" id="6022535">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6022543">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022547">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022610">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022670">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022728">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022789">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022816">var</span>&nbsp;<span class="ident" id="6022820">buf</span>&nbsp;<span class="ident" id="6022824">bytes</span><span class="op" id="6022829">.</span><span class="ident" id="6022830">Buffer</span>&nbsp;<span class="comment" id="6022837">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022860">pr</span><span class="op" id="6022862">,</span>&nbsp;<span class="ident" id="6022864">pw</span>&nbsp;<span class="op" id="6022867">:=</span>&nbsp;<span class="ident" id="6022870">io</span><span class="op" id="6022872">.</span><span class="ident" id="6022873">Pipe</span><span class="op" id="6022877">(</span><span class="op" id="6022878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022881">defer</span>&nbsp;<span class="ident" id="6022887">pr</span><span class="op" id="6022889">.</span><span class="ident" id="6022890">Close</span><span class="op" id="6022895">(</span><span class="op" id="6022896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6022899">defer</span>&nbsp;<span class="ident" id="6022905">pw</span><span class="op" id="6022907">.</span><span class="ident" id="6022908">Close</span><span class="op" id="6022913">(</span><span class="op" id="6022914">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6022917">dr</span>&nbsp;<span class="op" id="6022920">:=</span>&nbsp;<span class="op" id="6022923">&amp;</span><span class="ident" id="6022924">delegateReader</span><span class="op" id="6022938">{</span><span class="ident" id="6022939">c</span><span class="op" id="6022940">:</span>&nbsp;<span class="builtinfunc" id="6022942">make</span><span class="op" id="6022946">(</span><span class="keyword" id="6022947">chan</span>&nbsp;<span class="ident" id="6022952">io</span><span class="op" id="6022954">.</span><span class="ident" id="6022955">Reader</span><span class="op" id="6022961">)</span><span class="op" id="6022962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6022965">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023029">go</span>&nbsp;<span class="keyword" id="6023032">func</span><span class="op" id="6023036">(</span><span class="op" id="6023037">)</span>&nbsp;<span class="op" id="6023039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023043">req</span><span class="op" id="6023046">,</span>&nbsp;<span class="ident" id="6023048">err</span>&nbsp;<span class="op" id="6023052">:=</span>&nbsp;<span class="ident" id="6023055">http</span><span class="op" id="6023059">.</span><span class="ident" id="6023060">ReadRequest</span><span class="op" id="6023071">(</span><span class="ident" id="6023072">bufio</span><span class="op" id="6023077">.</span><span class="ident" id="6023078">NewReader</span><span class="op" id="6023087">(</span><span class="ident" id="6023088">pr</span><span class="op" id="6023090">)</span><span class="op" id="6023091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023095">if</span>&nbsp;<span class="ident" id="6023098">err</span>&nbsp;<span class="op" id="6023102">==</span>&nbsp;<span class="ident" id="6023105">nil</span>&nbsp;<span class="op" id="6023109">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023114">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023159">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023191">io</span><span class="op" id="6023193">.</span><span class="ident" id="6023194">Copy</span><span class="op" id="6023198">(</span><span class="ident" id="6023199">ioutil</span><span class="op" id="6023205">.</span><span class="ident" id="6023206">Discard</span><span class="op" id="6023213">,</span>&nbsp;<span class="ident" id="6023215">req</span><span class="op" id="6023218">.</span><span class="ident" id="6023219">Body</span><span class="op" id="6023223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023228">req</span><span class="op" id="6023231">.</span><span class="ident" id="6023232">Body</span><span class="op" id="6023236">.</span><span class="ident" id="6023237">Close</span><span class="op" id="6023242">(</span><span class="op" id="6023243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023247">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023251">dr</span><span class="op" id="6023253">.</span><span class="ident" id="6023254">c</span>&nbsp;<span class="op" id="6023256">&lt;-</span>&nbsp;<span class="ident" id="6023259">strings</span><span class="op" id="6023266">.</span><span class="ident" id="6023267">NewReader</span><span class="op" id="6023276">(</span><span class="string" id="6023277">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="6023310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023313">}</span><span class="op" id="6023314">(</span><span class="op" id="6023315">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023319">t</span>&nbsp;<span class="op" id="6023321">:=</span>&nbsp;<span class="op" id="6023324">&amp;</span><span class="ident" id="6023325">http</span><span class="op" id="6023329">.</span><span class="ident" id="6023330">Transport</span><span class="op" id="6023339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023343">DisableKeepAlives</span><span class="op" id="6023360">:</span>&nbsp;<span class="builtintype" id="6023362">true</span><span class="op" id="6023366">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023370">Dial</span><span class="op" id="6023374">:</span>&nbsp;<span class="keyword" id="6023376">func</span><span class="op" id="6023380">(</span><span class="ident" id="6023381">net</span><span class="op" id="6023384">,</span>&nbsp;<span class="ident" id="6023386">addr</span>&nbsp;<span class="builtintype" id="6023391">string</span><span class="op" id="6023397">)</span>&nbsp;<span class="op" id="6023399">(</span><span class="ident" id="6023400">net</span><span class="op" id="6023403">.</span><span class="ident" id="6023404">Conn</span><span class="op" id="6023408">,</span>&nbsp;<span class="builtintype" id="6023410">error</span><span class="op" id="6023415">)</span>&nbsp;<span class="op" id="6023417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023422">return</span>&nbsp;<span class="op" id="6023429">&amp;</span><span class="ident" id="6023430">dumpConn</span><span class="op" id="6023438">{</span><span class="ident" id="6023439">io</span><span class="op" id="6023441">.</span><span class="ident" id="6023442">MultiWriter</span><span class="op" id="6023453">(</span><span class="op" id="6023454">&amp;</span><span class="ident" id="6023455">buf</span><span class="op" id="6023458">,</span>&nbsp;<span class="ident" id="6023460">pw</span><span class="op" id="6023462">)</span><span class="op" id="6023463">,</span>&nbsp;<span class="ident" id="6023465">dr</span><span class="op" id="6023467">}</span><span class="op" id="6023468">,</span>&nbsp;<span class="ident" id="6023470">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023476">}</span><span class="op" id="6023477">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023484">_</span><span class="op" id="6023485">,</span>&nbsp;<span class="ident" id="6023487">err</span>&nbsp;<span class="op" id="6023491">:=</span>&nbsp;<span class="ident" id="6023494">t</span><span class="op" id="6023495">.</span><span class="ident" id="6023496">RoundTrip</span><span class="op" id="6023505">(</span><span class="ident" id="6023506">reqSend</span><span class="op" id="6023513">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023517">req</span><span class="op" id="6023520">.</span><span class="ident" id="6023521">Body</span>&nbsp;<span class="op" id="6023526">=</span>&nbsp;<span class="ident" id="6023528">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023534">if</span>&nbsp;<span class="ident" id="6023537">err</span>&nbsp;<span class="op" id="6023541">!=</span>&nbsp;<span class="ident" id="6023544">nil</span>&nbsp;<span class="op" id="6023548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023552">return</span>&nbsp;<span class="ident" id="6023559">nil</span><span class="op" id="6023562">,</span>&nbsp;<span class="ident" id="6023564">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023572">dump</span>&nbsp;<span class="op" id="6023577">:=</span>&nbsp;<span class="ident" id="6023580">buf</span><span class="op" id="6023583">.</span><span class="ident" id="6023584">Bytes</span><span class="op" id="6023589">(</span><span class="op" id="6023590">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023594">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023644">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023708">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023771">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6023833">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023879">if</span>&nbsp;<span class="ident" id="6023882">dummyBody</span>&nbsp;<span class="op" id="6023892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023896">if</span>&nbsp;<span class="ident" id="6023899">i</span>&nbsp;<span class="op" id="6023901">:=</span>&nbsp;<span class="ident" id="6023904">bytes</span><span class="op" id="6023909">.</span><span class="ident" id="6023910">Index</span><span class="op" id="6023915">(</span><span class="ident" id="6023916">dump</span><span class="op" id="6023920">,</span>&nbsp;<span class="op" id="6023922">[</span><span class="op" id="6023923">]</span><span class="builtintype" id="6023924">byte</span><span class="op" id="6023928">(</span><span class="string" id="6023929">&#34;\r\n\r\n&#34;</span><span class="op" id="6023939">)</span><span class="op" id="6023940">)</span><span class="op" id="6023941">;</span>&nbsp;<span class="ident" id="6023943">i</span>&nbsp;<span class="op" id="6023945">&gt;=</span>&nbsp;<span class="num" id="6023948">0</span>&nbsp;<span class="op" id="6023950">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6023955">dump</span>&nbsp;<span class="op" id="6023960">=</span>&nbsp;<span class="ident" id="6023962">dump</span><span class="op" id="6023966">[</span><span class="op" id="6023967">:</span><span class="ident" id="6023968">i</span><span class="op" id="6023969">+</span><span class="num" id="6023970">4</span><span class="op" id="6023971">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6023978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6023981">return</span>&nbsp;<span class="ident" id="6023988">dump</span><span class="op" id="6023992">,</span>&nbsp;<span class="ident" id="6023994">nil</span><br>
<span class="lineno"></span><span class="op" id="6023998">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="6024001">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="6024065">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="6024098">type</span>&nbsp;<span class="ident" id="6024103">delegateReader</span>&nbsp;<span class="keyword" id="6024118">struct</span>&nbsp;<span class="op" id="6024125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024128">c</span>&nbsp;<span class="keyword" id="6024130">chan</span>&nbsp;<span class="ident" id="6024135">io</span><span class="op" id="6024137">.</span><span class="ident" id="6024138">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024146">r</span>&nbsp;<span class="ident" id="6024148">io</span><span class="op" id="6024150">.</span><span class="ident" id="6024151">Reader</span>&nbsp;<span class="comment" id="6024158">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="6024187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6024190">func</span>&nbsp;<span class="op" id="6024195">(</span><span class="ident" id="6024196">r</span>&nbsp;<span class="op" id="6024198">*</span><span class="ident" id="6024199">delegateReader</span><span class="op" id="6024213">)</span>&nbsp;<span class="ident" id="6024215">Read</span><span class="op" id="6024219">(</span><span class="ident" id="6024220">p</span>&nbsp;<span class="op" id="6024222">[</span><span class="op" id="6024223">]</span><span class="builtintype" id="6024224">byte</span><span class="op" id="6024228">)</span>&nbsp;<span class="op" id="6024230">(</span><span class="builtintype" id="6024231">int</span><span class="op" id="6024234">,</span>&nbsp;<span class="builtintype" id="6024236">error</span><span class="op" id="6024241">)</span>&nbsp;<span class="op" id="6024243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024246">if</span>&nbsp;<span class="ident" id="6024249">r</span><span class="op" id="6024250">.</span><span class="ident" id="6024251">r</span>&nbsp;<span class="op" id="6024253">==</span>&nbsp;<span class="ident" id="6024256">nil</span>&nbsp;<span class="op" id="6024260">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6024264">r</span><span class="op" id="6024265">.</span><span class="ident" id="6024266">r</span>&nbsp;<span class="op" id="6024268">=</span>&nbsp;<span class="op" id="6024270">&lt;-</span><span class="ident" id="6024272">r</span><span class="op" id="6024273">.</span><span class="ident" id="6024274">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6024277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024280">return</span>&nbsp;<span class="ident" id="6024287">r</span><span class="op" id="6024288">.</span><span class="ident" id="6024289">r</span><span class="op" id="6024290">.</span><span class="ident" id="6024291">Read</span><span class="op" id="6024295">(</span><span class="ident" id="6024296">p</span><span class="op" id="6024297">)</span><br>
<span class="lineno"></span><span class="op" id="6024299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="6024302">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="6024346">func</span>&nbsp;<span class="ident" id="6024351">valueOrDefault</span><span class="op" id="6024365">(</span><span class="ident" id="6024366">value</span><span class="op" id="6024371">,</span>&nbsp;<span class="ident" id="6024373">def</span>&nbsp;<span class="builtintype" id="6024377">string</span><span class="op" id="6024383">)</span>&nbsp;<span class="builtintype" id="6024385">string</span>&nbsp;<span class="op" id="6024392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024395">if</span>&nbsp;<span class="ident" id="6024398">value</span>&nbsp;<span class="op" id="6024404">!=</span>&nbsp;<span class="string" id="6024407">&#34;&#34;</span>&nbsp;<span class="op" id="6024410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024414">return</span>&nbsp;<span class="ident" id="6024421">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6024428">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024431">return</span>&nbsp;<span class="ident" id="6024438">def</span><br>
<span class="lineno"></span><span class="op" id="6024442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6024445">var</span>&nbsp;<span class="ident" id="6024449">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="6024475">=</span>&nbsp;<span class="keyword" id="6024477">map</span><span class="op" id="6024480">[</span><span class="builtintype" id="6024481">string</span><span class="op" id="6024487">]</span><span class="builtintype" id="6024488">bool</span><span class="op" id="6024492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6024495">&#34;Host&#34;</span><span class="op" id="6024501">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6024516">true</span><span class="op" id="6024520">,</span>&nbsp;<span class="comment" id="6024522">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6024551">&#34;Content-Length&#34;</span><span class="op" id="6024567">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6024572">true</span><span class="op" id="6024576">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6024579">&#34;Transfer-Encoding&#34;</span><span class="op" id="6024598">:</span>&nbsp;<span class="builtintype" id="6024600">true</span><span class="op" id="6024604">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6024607">&#34;Trailer&#34;</span><span class="op" id="6024616">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6024628">true</span><span class="op" id="6024632">,</span><br>
<span class="lineno"></span><span class="op" id="6024634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="6024637">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6024706">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="6024777">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="6024793">func</span>&nbsp;<span class="ident" id="6024798">dumpAsReceived</span><span class="op" id="6024812">(</span><span class="ident" id="6024813">req</span>&nbsp;<span class="op" id="6024817">*</span><span class="ident" id="6024818">http</span><span class="op" id="6024822">.</span><span class="ident" id="6024823">Request</span><span class="op" id="6024830">,</span>&nbsp;<span class="ident" id="6024832">w</span>&nbsp;<span class="ident" id="6024834">io</span><span class="op" id="6024836">.</span><span class="ident" id="6024837">Writer</span><span class="op" id="6024843">)</span>&nbsp;<span class="builtintype" id="6024845">error</span>&nbsp;<span class="op" id="6024851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6024854">return</span>&nbsp;<span class="ident" id="6024861">nil</span><br>
<span class="lineno">175</span><span class="op" id="6024865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6024868">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="6024935">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="6024992">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="6025048">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6025105">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="6025157">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="6025222">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="6025242">func</span>&nbsp;<span class="ident" id="6025247">DumpRequest</span><span class="op" id="6025258">(</span><span class="ident" id="6025259">req</span>&nbsp;<span class="op" id="6025263">*</span><span class="ident" id="6025264">http</span><span class="op" id="6025268">.</span><span class="ident" id="6025269">Request</span><span class="op" id="6025276">,</span>&nbsp;<span class="ident" id="6025278">body</span>&nbsp;<span class="builtintype" id="6025283">bool</span><span class="op" id="6025287">)</span>&nbsp;<span class="op" id="6025289">(</span><span class="ident" id="6025290">dump</span>&nbsp;<span class="op" id="6025295">[</span><span class="op" id="6025296">]</span><span class="builtintype" id="6025297">byte</span><span class="op" id="6025301">,</span>&nbsp;<span class="ident" id="6025303">err</span>&nbsp;<span class="builtintype" id="6025307">error</span><span class="op" id="6025312">)</span>&nbsp;<span class="op" id="6025314">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025317">save</span>&nbsp;<span class="op" id="6025322">:=</span>&nbsp;<span class="ident" id="6025325">req</span><span class="op" id="6025328">.</span><span class="ident" id="6025329">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025335">if</span>&nbsp;<span class="op" id="6025338">!</span><span class="ident" id="6025339">body</span>&nbsp;<span class="op" id="6025344">||</span>&nbsp;<span class="ident" id="6025347">req</span><span class="op" id="6025350">.</span><span class="ident" id="6025351">Body</span>&nbsp;<span class="op" id="6025356">==</span>&nbsp;<span class="ident" id="6025359">nil</span>&nbsp;<span class="op" id="6025363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025367">req</span><span class="op" id="6025370">.</span><span class="ident" id="6025371">Body</span>&nbsp;<span class="op" id="6025376">=</span>&nbsp;<span class="ident" id="6025378">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6025383">}</span>&nbsp;<span class="keyword" id="6025385">else</span>&nbsp;<span class="op" id="6025390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025394">save</span><span class="op" id="6025398">,</span>&nbsp;<span class="ident" id="6025400">req</span><span class="op" id="6025403">.</span><span class="ident" id="6025404">Body</span><span class="op" id="6025408">,</span>&nbsp;<span class="ident" id="6025410">err</span>&nbsp;<span class="op" id="6025414">=</span>&nbsp;<span class="ident" id="6025416">drainBody</span><span class="op" id="6025425">(</span><span class="ident" id="6025426">req</span><span class="op" id="6025429">.</span><span class="ident" id="6025430">Body</span><span class="op" id="6025434">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025438">if</span>&nbsp;<span class="ident" id="6025441">err</span>&nbsp;<span class="op" id="6025445">!=</span>&nbsp;<span class="ident" id="6025448">nil</span>&nbsp;<span class="op" id="6025452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025457">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6025466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6025469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025473">var</span>&nbsp;<span class="ident" id="6025477">b</span>&nbsp;<span class="ident" id="6025479">bytes</span><span class="op" id="6025484">.</span><span class="ident" id="6025485">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025494">fmt</span><span class="op" id="6025497">.</span><span class="ident" id="6025498">Fprintf</span><span class="op" id="6025505">(</span><span class="op" id="6025506">&amp;</span><span class="ident" id="6025507">b</span><span class="op" id="6025508">,</span>&nbsp;<span class="string" id="6025510">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="6025532">,</span>&nbsp;<span class="ident" id="6025534">valueOrDefault</span><span class="op" id="6025548">(</span><span class="ident" id="6025549">req</span><span class="op" id="6025552">.</span><span class="ident" id="6025553">Method</span><span class="op" id="6025559">,</span>&nbsp;<span class="string" id="6025561">&#34;GET&#34;</span><span class="op" id="6025566">)</span><span class="op" id="6025567">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025571">req</span><span class="op" id="6025574">.</span><span class="ident" id="6025575">URL</span><span class="op" id="6025578">.</span><span class="ident" id="6025579">RequestURI</span><span class="op" id="6025589">(</span><span class="op" id="6025590">)</span><span class="op" id="6025591">,</span>&nbsp;<span class="ident" id="6025593">req</span><span class="op" id="6025596">.</span><span class="ident" id="6025597">ProtoMajor</span><span class="op" id="6025607">,</span>&nbsp;<span class="ident" id="6025609">req</span><span class="op" id="6025612">.</span><span class="ident" id="6025613">ProtoMinor</span><span class="op" id="6025623">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025627">host</span>&nbsp;<span class="op" id="6025632">:=</span>&nbsp;<span class="ident" id="6025635">req</span><span class="op" id="6025638">.</span><span class="ident" id="6025639">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025645">if</span>&nbsp;<span class="ident" id="6025648">host</span>&nbsp;<span class="op" id="6025653">==</span>&nbsp;<span class="string" id="6025656">&#34;&#34;</span>&nbsp;<span class="op" id="6025659">&amp;&amp;</span>&nbsp;<span class="ident" id="6025662">req</span><span class="op" id="6025665">.</span><span class="ident" id="6025666">URL</span>&nbsp;<span class="op" id="6025670">!=</span>&nbsp;<span class="ident" id="6025673">nil</span>&nbsp;<span class="op" id="6025677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025681">host</span>&nbsp;<span class="op" id="6025686">=</span>&nbsp;<span class="ident" id="6025688">req</span><span class="op" id="6025691">.</span><span class="ident" id="6025692">URL</span><span class="op" id="6025695">.</span><span class="ident" id="6025696">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6025702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025705">if</span>&nbsp;<span class="ident" id="6025708">host</span>&nbsp;<span class="op" id="6025713">!=</span>&nbsp;<span class="string" id="6025716">&#34;&#34;</span>&nbsp;<span class="op" id="6025719">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025723">fmt</span><span class="op" id="6025726">.</span><span class="ident" id="6025727">Fprintf</span><span class="op" id="6025734">(</span><span class="op" id="6025735">&amp;</span><span class="ident" id="6025736">b</span><span class="op" id="6025737">,</span>&nbsp;<span class="string" id="6025739">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="6025753">,</span>&nbsp;<span class="ident" id="6025755">host</span><span class="op" id="6025759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6025762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025766">chunked</span>&nbsp;<span class="op" id="6025774">:=</span>&nbsp;<span class="builtinfunc" id="6025777">len</span><span class="op" id="6025780">(</span><span class="ident" id="6025781">req</span><span class="op" id="6025784">.</span><span class="ident" id="6025785">TransferEncoding</span><span class="op" id="6025801">)</span>&nbsp;<span class="op" id="6025803">&gt;</span>&nbsp;<span class="num" id="6025805">0</span>&nbsp;<span class="op" id="6025807">&amp;&amp;</span>&nbsp;<span class="ident" id="6025810">req</span><span class="op" id="6025813">.</span><span class="ident" id="6025814">TransferEncoding</span><span class="op" id="6025830">[</span><span class="num" id="6025831">0</span><span class="op" id="6025832">]</span>&nbsp;<span class="op" id="6025834">==</span>&nbsp;<span class="string" id="6025837">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025848">if</span>&nbsp;<span class="builtinfunc" id="6025851">len</span><span class="op" id="6025854">(</span><span class="ident" id="6025855">req</span><span class="op" id="6025858">.</span><span class="ident" id="6025859">TransferEncoding</span><span class="op" id="6025875">)</span>&nbsp;<span class="op" id="6025877">&gt;</span>&nbsp;<span class="num" id="6025879">0</span>&nbsp;<span class="op" id="6025881">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025885">fmt</span><span class="op" id="6025888">.</span><span class="ident" id="6025889">Fprintf</span><span class="op" id="6025896">(</span><span class="op" id="6025897">&amp;</span><span class="ident" id="6025898">b</span><span class="op" id="6025899">,</span>&nbsp;<span class="string" id="6025901">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="6025928">,</span>&nbsp;<span class="ident" id="6025930">strings</span><span class="op" id="6025937">.</span><span class="ident" id="6025938">Join</span><span class="op" id="6025942">(</span><span class="ident" id="6025943">req</span><span class="op" id="6025946">.</span><span class="ident" id="6025947">TransferEncoding</span><span class="op" id="6025963">,</span>&nbsp;<span class="string" id="6025965">&#34;,&#34;</span><span class="op" id="6025968">)</span><span class="op" id="6025969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6025972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6025975">if</span>&nbsp;<span class="ident" id="6025978">req</span><span class="op" id="6025981">.</span><span class="ident" id="6025982">Close</span>&nbsp;<span class="op" id="6025988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6025992">fmt</span><span class="op" id="6025995">.</span><span class="ident" id="6025996">Fprintf</span><span class="op" id="6026003">(</span><span class="op" id="6026004">&amp;</span><span class="ident" id="6026005">b</span><span class="op" id="6026006">,</span>&nbsp;<span class="string" id="6026008">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="6026031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6026034">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026038">err</span>&nbsp;<span class="op" id="6026042">=</span>&nbsp;<span class="ident" id="6026044">req</span><span class="op" id="6026047">.</span><span class="ident" id="6026048">Header</span><span class="op" id="6026054">.</span><span class="ident" id="6026055">WriteSubset</span><span class="op" id="6026066">(</span><span class="op" id="6026067">&amp;</span><span class="ident" id="6026068">b</span><span class="op" id="6026069">,</span>&nbsp;<span class="ident" id="6026071">reqWriteExcludeHeaderDump</span><span class="op" id="6026096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026099">if</span>&nbsp;<span class="ident" id="6026102">err</span>&nbsp;<span class="op" id="6026106">!=</span>&nbsp;<span class="ident" id="6026109">nil</span>&nbsp;<span class="op" id="6026113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026117">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6026125">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026129">io</span><span class="op" id="6026131">.</span><span class="ident" id="6026132">WriteString</span><span class="op" id="6026143">(</span><span class="op" id="6026144">&amp;</span><span class="ident" id="6026145">b</span><span class="op" id="6026146">,</span>&nbsp;<span class="string" id="6026148">&#34;\r\n&#34;</span><span class="op" id="6026154">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026158">if</span>&nbsp;<span class="ident" id="6026161">req</span><span class="op" id="6026164">.</span><span class="ident" id="6026165">Body</span>&nbsp;<span class="op" id="6026170">!=</span>&nbsp;<span class="ident" id="6026173">nil</span>&nbsp;<span class="op" id="6026177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026181">var</span>&nbsp;<span class="ident" id="6026185">dest</span>&nbsp;<span class="ident" id="6026190">io</span><span class="op" id="6026192">.</span><span class="ident" id="6026193">Writer</span>&nbsp;<span class="op" id="6026200">=</span>&nbsp;<span class="op" id="6026202">&amp;</span><span class="ident" id="6026203">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026207">if</span>&nbsp;<span class="ident" id="6026210">chunked</span>&nbsp;<span class="op" id="6026218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026223">dest</span>&nbsp;<span class="op" id="6026228">=</span>&nbsp;<span class="ident" id="6026230">NewChunkedWriter</span><span class="op" id="6026246">(</span><span class="ident" id="6026247">dest</span><span class="op" id="6026251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6026255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026259">_</span><span class="op" id="6026260">,</span>&nbsp;<span class="ident" id="6026262">err</span>&nbsp;<span class="op" id="6026266">=</span>&nbsp;<span class="ident" id="6026268">io</span><span class="op" id="6026270">.</span><span class="ident" id="6026271">Copy</span><span class="op" id="6026275">(</span><span class="ident" id="6026276">dest</span><span class="op" id="6026280">,</span>&nbsp;<span class="ident" id="6026282">req</span><span class="op" id="6026285">.</span><span class="ident" id="6026286">Body</span><span class="op" id="6026290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026294">if</span>&nbsp;<span class="ident" id="6026297">chunked</span>&nbsp;<span class="op" id="6026305">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026310">dest</span><span class="op" id="6026314">.</span><span class="op" id="6026315">(</span><span class="ident" id="6026316">io</span><span class="op" id="6026318">.</span><span class="ident" id="6026319">Closer</span><span class="op" id="6026325">)</span><span class="op" id="6026326">.</span><span class="ident" id="6026327">Close</span><span class="op" id="6026332">(</span><span class="op" id="6026333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026338">io</span><span class="op" id="6026340">.</span><span class="ident" id="6026341">WriteString</span><span class="op" id="6026352">(</span><span class="op" id="6026353">&amp;</span><span class="ident" id="6026354">b</span><span class="op" id="6026355">,</span>&nbsp;<span class="string" id="6026357">&#34;\r\n&#34;</span><span class="op" id="6026363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6026367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6026370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026374">req</span><span class="op" id="6026377">.</span><span class="ident" id="6026378">Body</span>&nbsp;<span class="op" id="6026383">=</span>&nbsp;<span class="ident" id="6026385">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026391">if</span>&nbsp;<span class="ident" id="6026394">err</span>&nbsp;<span class="op" id="6026398">!=</span>&nbsp;<span class="ident" id="6026401">nil</span>&nbsp;<span class="op" id="6026405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026409">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6026417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6026420">dump</span>&nbsp;<span class="op" id="6026425">=</span>&nbsp;<span class="ident" id="6026427">b</span><span class="op" id="6026428">.</span><span class="ident" id="6026429">Bytes</span><span class="op" id="6026434">(</span><span class="op" id="6026435">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6026438">return</span><br>
<span class="lineno"></span><span class="op" id="6026445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6026448">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="6026530">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="6026572">var</span>&nbsp;<span class="ident" id="6026576">errNoBody</span>&nbsp;<span class="op" id="6026586">=</span>&nbsp;<span class="ident" id="6026588">errors</span><span class="op" id="6026594">.</span><span class="ident" id="6026595">New</span><span class="op" id="6026598">(</span><span class="string" id="6026599">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="6026621">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6026624">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6026695">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6026764">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="6026831">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="6026863">type</span>&nbsp;<span class="ident" id="6026868">failureToReadBody</span>&nbsp;<span class="keyword" id="6026886">struct</span><span class="op" id="6026892">{</span><span class="op" id="6026893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6026896">func</span>&nbsp;<span class="op" id="6026901">(</span><span class="ident" id="6026902">failureToReadBody</span><span class="op" id="6026919">)</span>&nbsp;<span class="ident" id="6026921">Read</span><span class="op" id="6026925">(</span><span class="op" id="6026926">[</span><span class="op" id="6026927">]</span><span class="builtintype" id="6026928">byte</span><span class="op" id="6026932">)</span>&nbsp;<span class="op" id="6026934">(</span><span class="builtintype" id="6026935">int</span><span class="op" id="6026938">,</span>&nbsp;<span class="builtintype" id="6026940">error</span><span class="op" id="6026945">)</span>&nbsp;<span class="op" id="6026947">{</span>&nbsp;<span class="keyword" id="6026949">return</span>&nbsp;<span class="num" id="6026956">0</span><span class="op" id="6026957">,</span>&nbsp;<span class="ident" id="6026959">errNoBody</span>&nbsp;<span class="op" id="6026969">}</span><br>
<span class="lineno"></span><span class="keyword" id="6026971">func</span>&nbsp;<span class="op" id="6026976">(</span><span class="ident" id="6026977">failureToReadBody</span><span class="op" id="6026994">)</span>&nbsp;<span class="ident" id="6026996">Close</span><span class="op" id="6027001">(</span><span class="op" id="6027002">)</span>&nbsp;<span class="builtintype" id="6027004">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6027022">{</span>&nbsp;<span class="keyword" id="6027024">return</span>&nbsp;<span class="ident" id="6027031">nil</span>&nbsp;<span class="op" id="6027035">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6027038">var</span>&nbsp;<span class="ident" id="6027042">emptyBody</span>&nbsp;<span class="op" id="6027052">=</span>&nbsp;<span class="ident" id="6027054">ioutil</span><span class="op" id="6027060">.</span><span class="ident" id="6027061">NopCloser</span><span class="op" id="6027070">(</span><span class="ident" id="6027071">strings</span><span class="op" id="6027078">.</span><span class="ident" id="6027079">NewReader</span><span class="op" id="6027088">(</span><span class="string" id="6027089">&#34;&#34;</span><span class="op" id="6027091">)</span><span class="op" id="6027092">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6027095">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6027153">func</span>&nbsp;<span class="ident" id="6027158">DumpResponse</span><span class="op" id="6027170">(</span><span class="ident" id="6027171">resp</span>&nbsp;<span class="op" id="6027176">*</span><span class="ident" id="6027177">http</span><span class="op" id="6027181">.</span><span class="ident" id="6027182">Response</span><span class="op" id="6027190">,</span>&nbsp;<span class="ident" id="6027192">body</span>&nbsp;<span class="builtintype" id="6027197">bool</span><span class="op" id="6027201">)</span>&nbsp;<span class="op" id="6027203">(</span><span class="ident" id="6027204">dump</span>&nbsp;<span class="op" id="6027209">[</span><span class="op" id="6027210">]</span><span class="builtintype" id="6027211">byte</span><span class="op" id="6027215">,</span>&nbsp;<span class="ident" id="6027217">err</span>&nbsp;<span class="builtintype" id="6027221">error</span><span class="op" id="6027226">)</span>&nbsp;<span class="op" id="6027228">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027231">var</span>&nbsp;<span class="ident" id="6027235">b</span>&nbsp;<span class="ident" id="6027237">bytes</span><span class="op" id="6027242">.</span><span class="ident" id="6027243">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027251">save</span>&nbsp;<span class="op" id="6027256">:=</span>&nbsp;<span class="ident" id="6027259">resp</span><span class="op" id="6027263">.</span><span class="ident" id="6027264">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027270">savecl</span>&nbsp;<span class="op" id="6027277">:=</span>&nbsp;<span class="ident" id="6027280">resp</span><span class="op" id="6027284">.</span><span class="ident" id="6027285">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027301">if</span>&nbsp;<span class="op" id="6027304">!</span><span class="ident" id="6027305">body</span>&nbsp;<span class="op" id="6027310">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027314">resp</span><span class="op" id="6027318">.</span><span class="ident" id="6027319">Body</span>&nbsp;<span class="op" id="6027324">=</span>&nbsp;<span class="ident" id="6027326">failureToReadBody</span><span class="op" id="6027343">{</span><span class="op" id="6027344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6027347">}</span>&nbsp;<span class="keyword" id="6027349">else</span>&nbsp;<span class="keyword" id="6027354">if</span>&nbsp;<span class="ident" id="6027357">resp</span><span class="op" id="6027361">.</span><span class="ident" id="6027362">Body</span>&nbsp;<span class="op" id="6027367">==</span>&nbsp;<span class="ident" id="6027370">nil</span>&nbsp;<span class="op" id="6027374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027378">resp</span><span class="op" id="6027382">.</span><span class="ident" id="6027383">Body</span>&nbsp;<span class="op" id="6027388">=</span>&nbsp;<span class="ident" id="6027390">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6027401">}</span>&nbsp;<span class="keyword" id="6027403">else</span>&nbsp;<span class="op" id="6027408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027412">save</span><span class="op" id="6027416">,</span>&nbsp;<span class="ident" id="6027418">resp</span><span class="op" id="6027422">.</span><span class="ident" id="6027423">Body</span><span class="op" id="6027427">,</span>&nbsp;<span class="ident" id="6027429">err</span>&nbsp;<span class="op" id="6027433">=</span>&nbsp;<span class="ident" id="6027435">drainBody</span><span class="op" id="6027444">(</span><span class="ident" id="6027445">resp</span><span class="op" id="6027449">.</span><span class="ident" id="6027450">Body</span><span class="op" id="6027454">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027458">if</span>&nbsp;<span class="ident" id="6027461">err</span>&nbsp;<span class="op" id="6027465">!=</span>&nbsp;<span class="ident" id="6027468">nil</span>&nbsp;<span class="op" id="6027472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027477">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6027486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6027489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027492">err</span>&nbsp;<span class="op" id="6027496">=</span>&nbsp;<span class="ident" id="6027498">resp</span><span class="op" id="6027502">.</span><span class="ident" id="6027503">Write</span><span class="op" id="6027508">(</span><span class="op" id="6027509">&amp;</span><span class="ident" id="6027510">b</span><span class="op" id="6027511">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027514">if</span>&nbsp;<span class="ident" id="6027517">err</span>&nbsp;<span class="op" id="6027521">==</span>&nbsp;<span class="ident" id="6027524">errNoBody</span>&nbsp;<span class="op" id="6027534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027538">err</span>&nbsp;<span class="op" id="6027542">=</span>&nbsp;<span class="ident" id="6027544">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6027549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027552">resp</span><span class="op" id="6027556">.</span><span class="ident" id="6027557">Body</span>&nbsp;<span class="op" id="6027562">=</span>&nbsp;<span class="ident" id="6027564">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6027570">resp</span><span class="op" id="6027574">.</span><span class="ident" id="6027575">ContentLength</span>&nbsp;<span class="op" id="6027589">=</span>&nbsp;<span class="ident" id="6027591">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027599">if</span>&nbsp;<span class="ident" id="6027602">err</span>&nbsp;<span class="op" id="6027606">!=</span>&nbsp;<span class="ident" id="6027609">nil</span>&nbsp;<span class="op" id="6027613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027617">return</span>&nbsp;<span class="ident" id="6027624">nil</span><span class="op" id="6027627">,</span>&nbsp;<span class="ident" id="6027629">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6027634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6027637">return</span>&nbsp;<span class="ident" id="6027644">b</span><span class="op" id="6027645">.</span><span class="ident" id="6027646">Bytes</span><span class="op" id="6027651">(</span><span class="op" id="6027652">)</span><span class="op" id="6027653">,</span>&nbsp;<span class="ident" id="6027655">nil</span><br>
<span class="lineno"></span><span class="op" id="6027659">}</span>
</div>
</body>
</html>
