<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html" class="current">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1454920">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1454976">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1455030">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1455081">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1455099">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1455150">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1455197">//</span><br>
<span class="lineno"></span><span class="comment" id="1455200">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1455266">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1455337">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1455406">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1455445">//</span><br>
<span class="lineno"></span><span class="comment" id="1455448">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1455522">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1455594">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1455663">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1455735">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1455802">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1455878">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1455950">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1456024">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1456102">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1456180">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1456260">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1456331">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1456409">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1456482">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1456504">//</span><br>
<span class="lineno">30</span><span class="comment" id="1456507">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1456579">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1456660">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1456737">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1456807">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1456880">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1456956">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1457030">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1457111">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1457195">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1457277">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1457316">//</span><br>
<span class="lineno"></span><span class="comment" id="1457319">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1457380">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1457458">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1457524">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1457597">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1457671">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1457744">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1457820">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1457885">package</span>&nbsp;<span class="ident" id="1457893">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1457902">import</span>&nbsp;<span class="string" id="1457909">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1457919">const</span>&nbsp;<span class="op" id="1457925">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457928">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457944">=</span>&nbsp;<span class="num" id="1457946">1</span>&nbsp;<span class="op" id="1457948">&lt;&lt;</span>&nbsp;<span class="num" id="1457951">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457955">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457971">=</span>&nbsp;<span class="num" id="1457973">1</span>&nbsp;<span class="op" id="1457975">&lt;&lt;</span>&nbsp;<span class="num" id="1457978">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1457982">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1457998">=</span>&nbsp;<span class="num" id="1458000">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458003">maxCPUProfStack</span>&nbsp;<span class="op" id="1458019">=</span>&nbsp;<span class="num" id="1458021">64</span><br>
<span class="lineno">60</span><span class="op" id="1458024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1458027">type</span>&nbsp;<span class="ident" id="1458032">cpuprofEntry</span>&nbsp;<span class="keyword" id="1458045">struct</span>&nbsp;<span class="op" id="1458052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458055">count</span>&nbsp;<span class="builtintype" id="1458061">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458070">depth</span>&nbsp;<span class="builtintype" id="1458076">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458085">stack</span>&nbsp;<span class="op" id="1458091">[</span><span class="ident" id="1458092">maxCPUProfStack</span><span class="op" id="1458107">]</span><span class="builtintype" id="1458108">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1458116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1458119">type</span>&nbsp;<span class="ident" id="1458124">cpuProfile</span>&nbsp;<span class="keyword" id="1458135">struct</span>&nbsp;<span class="op" id="1458142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458145">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1458152">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458160">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458180">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1458187">note</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458195">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458220">count</span>&nbsp;&nbsp;<span class="builtintype" id="1458227">uintptr</span>&nbsp;<span class="comment" id="1458235">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458250">evicts</span>&nbsp;<span class="builtintype" id="1458257">uintptr</span>&nbsp;<span class="comment" id="1458265">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458284">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1458291">uintptr</span>&nbsp;<span class="comment" id="1458299">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458338">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458370">hash</span>&nbsp;<span class="op" id="1458375">[</span><span class="ident" id="1458376">numBuckets</span><span class="op" id="1458386">]</span><span class="keyword" id="1458387">struct</span>&nbsp;<span class="op" id="1458394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458398">entry</span>&nbsp;<span class="op" id="1458404">[</span><span class="ident" id="1458405">assoc</span><span class="op" id="1458410">]</span><span class="ident" id="1458411">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458429">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458466">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458516">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458566">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458574">[</span><span class="num" id="1458575">2</span><span class="op" id="1458576">]</span><span class="op" id="1458577">[</span><span class="ident" id="1458578">logSize</span>&nbsp;<span class="op" id="1458586">/</span>&nbsp;<span class="num" id="1458588">2</span><span class="op" id="1458589">]</span><span class="builtintype" id="1458590">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458599">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1458607">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458616">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1458624">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458631">handoff</span>&nbsp;<span class="builtintype" id="1458639">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458648">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458666">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1458717">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458757">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1458766">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458774">wholding</span>&nbsp;<span class="builtintype" id="1458783">bool</span>&nbsp;<span class="comment" id="1458788">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458829">flushing</span>&nbsp;<span class="builtintype" id="1458838">bool</span>&nbsp;<span class="comment" id="1458843">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458885">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1458894">bool</span>&nbsp;<span class="comment" id="1458899">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1458947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1458950">var</span>&nbsp;<span class="op" id="1458954">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458957">cpuprofLock</span>&nbsp;<span class="ident" id="1458969">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1458976">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458988">*</span><span class="ident" id="1458989">cpuProfile</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459002">eod</span>&nbsp;<span class="op" id="1459006">=</span>&nbsp;<span class="op" id="1459008">[</span><span class="num" id="1459009">3</span><span class="op" id="1459010">]</span><span class="builtintype" id="1459011">uintptr</span><span class="op" id="1459018">{</span><span class="num" id="1459019">0</span><span class="op" id="1459020">,</span>&nbsp;<span class="num" id="1459022">1</span><span class="op" id="1459023">,</span>&nbsp;<span class="num" id="1459025">0</span><span class="op" id="1459026">}</span><br>
<span class="lineno"></span><span class="op" id="1459028">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1459031">func</span>&nbsp;<span class="ident" id="1459036">setcpuprofilerate_m</span><span class="op" id="1459055">(</span><span class="op" id="1459056">)</span>&nbsp;<span class="comment" id="1459058">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1459069">func</span>&nbsp;<span class="ident" id="1459074">setcpuprofilerate</span><span class="op" id="1459091">(</span><span class="ident" id="1459092">hz</span>&nbsp;<span class="builtintype" id="1459095">int32</span><span class="op" id="1459100">)</span>&nbsp;<span class="op" id="1459102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459105">g</span>&nbsp;<span class="op" id="1459107">:=</span>&nbsp;<span class="ident" id="1459110">getg</span><span class="op" id="1459114">(</span><span class="op" id="1459115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459118">g</span><span class="op" id="1459119">.</span><span class="ident" id="1459120">m</span><span class="op" id="1459121">.</span><span class="ident" id="1459122">scalararg</span><span class="op" id="1459131">[</span><span class="num" id="1459132">0</span><span class="op" id="1459133">]</span>&nbsp;<span class="op" id="1459135">=</span>&nbsp;<span class="builtintype" id="1459137">uintptr</span><span class="op" id="1459144">(</span><span class="ident" id="1459145">hz</span><span class="op" id="1459147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459150">onM</span><span class="op" id="1459153">(</span><span class="ident" id="1459154">setcpuprofilerate_m</span><span class="op" id="1459173">)</span><br>
<span class="lineno">110</span><span class="op" id="1459175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1459178">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1459234">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1459292">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1459331">func</span>&nbsp;<span class="ident" id="1459336">lostProfileData</span><span class="op" id="1459351">(</span><span class="op" id="1459352">)</span>&nbsp;<span class="op" id="1459354">{</span><span class="op" id="1459355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1459358">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1459433">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1459487">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1459570">//</span><br>
<span class="lineno"></span><span class="comment" id="1459573">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1459629">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1459695">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1459726">func</span>&nbsp;<span class="ident" id="1459731">SetCPUProfileRate</span><span class="op" id="1459748">(</span><span class="ident" id="1459749">hz</span>&nbsp;<span class="builtintype" id="1459752">int</span><span class="op" id="1459755">)</span>&nbsp;<span class="op" id="1459757">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1459760">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459798">if</span>&nbsp;<span class="ident" id="1459801">hz</span>&nbsp;<span class="op" id="1459804">&lt;</span>&nbsp;<span class="num" id="1459806">0</span>&nbsp;<span class="op" id="1459808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459812">hz</span>&nbsp;<span class="op" id="1459815">=</span>&nbsp;<span class="num" id="1459817">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459823">if</span>&nbsp;<span class="ident" id="1459826">hz</span>&nbsp;<span class="op" id="1459829">&gt;</span>&nbsp;<span class="num" id="1459831">1000000</span>&nbsp;<span class="op" id="1459839">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459843">hz</span>&nbsp;<span class="op" id="1459846">=</span>&nbsp;<span class="num" id="1459848">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459861">lock</span><span class="op" id="1459865">(</span><span class="op" id="1459866">&amp;</span><span class="ident" id="1459867">cpuprofLock</span><span class="op" id="1459878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459881">if</span>&nbsp;<span class="ident" id="1459884">hz</span>&nbsp;<span class="op" id="1459887">&gt;</span>&nbsp;<span class="num" id="1459889">0</span>&nbsp;<span class="op" id="1459891">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1459895">if</span>&nbsp;<span class="ident" id="1459898">cpuprof</span>&nbsp;<span class="op" id="1459906">==</span>&nbsp;<span class="ident" id="1459909">nil</span>&nbsp;<span class="op" id="1459913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1459918">cpuprof</span>&nbsp;<span class="op" id="1459926">=</span>&nbsp;<span class="op" id="1459928">(</span><span class="op" id="1459929">*</span><span class="ident" id="1459930">cpuProfile</span><span class="op" id="1459940">)</span><span class="op" id="1459941">(</span><span class="ident" id="1459942">sysAlloc</span><span class="op" id="1459950">(</span><span class="ident" id="1459951">unsafe</span><span class="op" id="1459957">.</span><span class="ident" id="1459958">Sizeof</span><span class="op" id="1459964">(</span><span class="ident" id="1459965">cpuProfile</span><span class="op" id="1459975">{</span><span class="op" id="1459976">}</span><span class="op" id="1459977">)</span><span class="op" id="1459978">,</span>&nbsp;<span class="op" id="1459980">&amp;</span><span class="ident" id="1459981">memstats</span><span class="op" id="1459989">.</span><span class="ident" id="1459990">other_sys</span><span class="op" id="1459999">)</span><span class="op" id="1460000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460005">if</span>&nbsp;<span class="ident" id="1460008">cpuprof</span>&nbsp;<span class="op" id="1460016">==</span>&nbsp;<span class="ident" id="1460019">nil</span>&nbsp;<span class="op" id="1460023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1460029">print</span><span class="op" id="1460034">(</span><span class="string" id="1460035">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1460084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460090">unlock</span><span class="op" id="1460096">(</span><span class="op" id="1460097">&amp;</span><span class="ident" id="1460098">cpuprofLock</span><span class="op" id="1460109">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460115">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460133">if</span>&nbsp;<span class="ident" id="1460136">cpuprof</span><span class="op" id="1460143">.</span><span class="ident" id="1460144">on</span>&nbsp;<span class="op" id="1460147">||</span>&nbsp;<span class="ident" id="1460150">cpuprof</span><span class="op" id="1460157">.</span><span class="ident" id="1460158">handoff</span>&nbsp;<span class="op" id="1460166">!=</span>&nbsp;<span class="num" id="1460169">0</span>&nbsp;<span class="op" id="1460171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1460176">print</span><span class="op" id="1460181">(</span><span class="string" id="1460182">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1460259">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460264">unlock</span><span class="op" id="1460270">(</span><span class="op" id="1460271">&amp;</span><span class="ident" id="1460272">cpuprofLock</span><span class="op" id="1460283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1460288">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460302">cpuprof</span><span class="op" id="1460309">.</span><span class="ident" id="1460310">on</span>&nbsp;<span class="op" id="1460313">=</span>&nbsp;<span class="builtintype" id="1460315">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460322">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460355">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460445">p</span>&nbsp;<span class="op" id="1460447">:=</span>&nbsp;<span class="op" id="1460450">&amp;</span><span class="ident" id="1460451">cpuprof</span><span class="op" id="1460458">.</span><span class="ident" id="1460459">log</span><span class="op" id="1460462">[</span><span class="num" id="1460463">0</span><span class="op" id="1460464">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460468">p</span><span class="op" id="1460469">[</span><span class="num" id="1460470">0</span><span class="op" id="1460471">]</span>&nbsp;<span class="op" id="1460473">=</span>&nbsp;<span class="num" id="1460475">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460493">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460515">p</span><span class="op" id="1460516">[</span><span class="num" id="1460517">1</span><span class="op" id="1460518">]</span>&nbsp;<span class="op" id="1460520">=</span>&nbsp;<span class="num" id="1460522">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460540">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460562">p</span><span class="op" id="1460563">[</span><span class="num" id="1460564">2</span><span class="op" id="1460565">]</span>&nbsp;<span class="op" id="1460567">=</span>&nbsp;<span class="num" id="1460569">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460587">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460607">p</span><span class="op" id="1460608">[</span><span class="num" id="1460609">3</span><span class="op" id="1460610">]</span>&nbsp;<span class="op" id="1460612">=</span>&nbsp;<span class="builtintype" id="1460614">uintptr</span><span class="op" id="1460621">(</span><span class="num" id="1460622">1e6</span>&nbsp;<span class="op" id="1460626">/</span>&nbsp;<span class="ident" id="1460628">hz</span><span class="op" id="1460630">)</span>&nbsp;<span class="comment" id="1460632">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460659">p</span><span class="op" id="1460660">[</span><span class="num" id="1460661">4</span><span class="op" id="1460662">]</span>&nbsp;<span class="op" id="1460664">=</span>&nbsp;<span class="num" id="1460666">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460670">cpuprof</span><span class="op" id="1460677">.</span><span class="ident" id="1460678">nlog</span>&nbsp;<span class="op" id="1460683">=</span>&nbsp;<span class="num" id="1460685">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460689">cpuprof</span><span class="op" id="1460696">.</span><span class="ident" id="1460697">toggle</span>&nbsp;<span class="op" id="1460704">=</span>&nbsp;<span class="num" id="1460706">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460710">cpuprof</span><span class="op" id="1460717">.</span><span class="ident" id="1460718">wholding</span>&nbsp;<span class="op" id="1460727">=</span>&nbsp;<span class="builtintype" id="1460729">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460737">cpuprof</span><span class="op" id="1460744">.</span><span class="ident" id="1460745">wtoggle</span>&nbsp;<span class="op" id="1460753">=</span>&nbsp;<span class="num" id="1460755">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460759">cpuprof</span><span class="op" id="1460766">.</span><span class="ident" id="1460767">flushing</span>&nbsp;<span class="op" id="1460776">=</span>&nbsp;<span class="builtintype" id="1460778">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460786">cpuprof</span><span class="op" id="1460793">.</span><span class="ident" id="1460794">eodSent</span>&nbsp;<span class="op" id="1460802">=</span>&nbsp;<span class="builtintype" id="1460804">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460812">noteclear</span><span class="op" id="1460821">(</span><span class="op" id="1460822">&amp;</span><span class="ident" id="1460823">cpuprof</span><span class="op" id="1460830">.</span><span class="ident" id="1460831">wait</span><span class="op" id="1460835">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460840">setcpuprofilerate</span><span class="op" id="1460857">(</span><span class="builtintype" id="1460858">int32</span><span class="op" id="1460863">(</span><span class="ident" id="1460864">hz</span><span class="op" id="1460866">)</span><span class="op" id="1460867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1460870">}</span>&nbsp;<span class="keyword" id="1460872">else</span>&nbsp;<span class="keyword" id="1460877">if</span>&nbsp;<span class="ident" id="1460880">cpuprof</span>&nbsp;<span class="op" id="1460888">!=</span>&nbsp;<span class="ident" id="1460891">nil</span>&nbsp;<span class="op" id="1460895">&amp;&amp;</span>&nbsp;<span class="ident" id="1460898">cpuprof</span><span class="op" id="1460905">.</span><span class="ident" id="1460906">on</span>&nbsp;<span class="op" id="1460909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460913">setcpuprofilerate</span><span class="op" id="1460930">(</span><span class="num" id="1460931">0</span><span class="op" id="1460932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460936">cpuprof</span><span class="op" id="1460943">.</span><span class="ident" id="1460944">on</span>&nbsp;<span class="op" id="1460947">=</span>&nbsp;<span class="builtintype" id="1460949">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460958">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461031">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461090">for</span>&nbsp;<span class="op" id="1461094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461099">n</span>&nbsp;<span class="op" id="1461101">:=</span>&nbsp;<span class="ident" id="1461104">cpuprof</span><span class="op" id="1461111">.</span><span class="ident" id="1461112">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461123">if</span>&nbsp;<span class="ident" id="1461126">n</span><span class="op" id="1461127">&amp;</span><span class="num" id="1461128">0x80000000</span>&nbsp;<span class="op" id="1461139">!=</span>&nbsp;<span class="num" id="1461142">0</span>&nbsp;<span class="op" id="1461144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1461150">print</span><span class="op" id="1461155">(</span><span class="string" id="1461156">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1461193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461203">if</span>&nbsp;<span class="ident" id="1461206">cas</span><span class="op" id="1461209">(</span><span class="op" id="1461210">&amp;</span><span class="ident" id="1461211">cpuprof</span><span class="op" id="1461218">.</span><span class="ident" id="1461219">handoff</span><span class="op" id="1461226">,</span>&nbsp;<span class="ident" id="1461228">n</span><span class="op" id="1461229">,</span>&nbsp;<span class="ident" id="1461231">n</span><span class="op" id="1461232">|</span><span class="num" id="1461233">0x80000000</span><span class="op" id="1461243">)</span>&nbsp;<span class="op" id="1461245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461251">if</span>&nbsp;<span class="ident" id="1461254">n</span>&nbsp;<span class="op" id="1461256">==</span>&nbsp;<span class="num" id="1461259">0</span>&nbsp;<span class="op" id="1461261">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461268">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461338">notewakeup</span><span class="op" id="1461348">(</span><span class="op" id="1461349">&amp;</span><span class="ident" id="1461350">cpuprof</span><span class="op" id="1461357">.</span><span class="ident" id="1461358">wait</span><span class="op" id="1461362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461374">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461383">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461393">unlock</span><span class="op" id="1461399">(</span><span class="op" id="1461400">&amp;</span><span class="ident" id="1461401">cpuprofLock</span><span class="op" id="1461412">)</span><br>
<span class="lineno"></span><span class="op" id="1461414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1461417">func</span>&nbsp;<span class="ident" id="1461422">cpuproftick</span><span class="op" id="1461433">(</span><span class="ident" id="1461434">pc</span>&nbsp;<span class="op" id="1461437">*</span><span class="builtintype" id="1461438">uintptr</span><span class="op" id="1461445">,</span>&nbsp;<span class="ident" id="1461447">n</span>&nbsp;<span class="builtintype" id="1461449">int32</span><span class="op" id="1461454">)</span>&nbsp;<span class="op" id="1461456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461459">if</span>&nbsp;<span class="ident" id="1461462">n</span>&nbsp;<span class="op" id="1461464">&gt;</span>&nbsp;<span class="ident" id="1461466">maxCPUProfStack</span>&nbsp;<span class="op" id="1461482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461486">n</span>&nbsp;<span class="op" id="1461488">=</span>&nbsp;<span class="ident" id="1461490">maxCPUProfStack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461510">s</span>&nbsp;<span class="op" id="1461512">:=</span>&nbsp;<span class="op" id="1461515">(</span><span class="op" id="1461516">*</span><span class="op" id="1461517">[</span><span class="ident" id="1461518">maxCPUProfStack</span><span class="op" id="1461533">]</span><span class="builtintype" id="1461534">uintptr</span><span class="op" id="1461541">)</span><span class="op" id="1461542">(</span><span class="ident" id="1461543">unsafe</span><span class="op" id="1461549">.</span><span class="ident" id="1461550">Pointer</span><span class="op" id="1461557">(</span><span class="ident" id="1461558">pc</span><span class="op" id="1461560">)</span><span class="op" id="1461561">)</span><span class="op" id="1461562">[</span><span class="op" id="1461563">:</span><span class="ident" id="1461564">n</span><span class="op" id="1461565">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461568">cpuprof</span><span class="op" id="1461575">.</span><span class="ident" id="1461576">add</span><span class="op" id="1461579">(</span><span class="ident" id="1461580">s</span><span class="op" id="1461581">)</span><br>
<span class="lineno"></span><span class="op" id="1461583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1461586">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1461630">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1461698">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1461759">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1461829">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1461872">func</span>&nbsp;<span class="op" id="1461877">(</span><span class="ident" id="1461878">p</span>&nbsp;<span class="op" id="1461880">*</span><span class="ident" id="1461881">cpuProfile</span><span class="op" id="1461891">)</span>&nbsp;<span class="ident" id="1461893">add</span><span class="op" id="1461896">(</span><span class="ident" id="1461897">pc</span>&nbsp;<span class="op" id="1461900">[</span><span class="op" id="1461901">]</span><span class="builtintype" id="1461902">uintptr</span><span class="op" id="1461909">)</span>&nbsp;<span class="op" id="1461911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461914">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461932">h</span>&nbsp;<span class="op" id="1461934">:=</span>&nbsp;<span class="builtintype" id="1461937">uintptr</span><span class="op" id="1461944">(</span><span class="num" id="1461945">0</span><span class="op" id="1461946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1461949">for</span>&nbsp;<span class="ident" id="1461953">_</span><span class="op" id="1461954">,</span>&nbsp;<span class="ident" id="1461956">x</span>&nbsp;<span class="op" id="1461958">:=</span>&nbsp;<span class="keyword" id="1461961">range</span>&nbsp;<span class="ident" id="1461967">pc</span>&nbsp;<span class="op" id="1461970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461974">h</span>&nbsp;<span class="op" id="1461976">=</span>&nbsp;<span class="ident" id="1461978">h</span><span class="op" id="1461979">&lt;&lt;</span><span class="num" id="1461981">8</span>&nbsp;<span class="op" id="1461983">|</span>&nbsp;<span class="op" id="1461985">(</span><span class="ident" id="1461986">h</span>&nbsp;<span class="op" id="1461988">&gt;&gt;</span>&nbsp;<span class="op" id="1461991">(</span><span class="num" id="1461992">8</span>&nbsp;<span class="op" id="1461994">*</span>&nbsp;<span class="op" id="1461996">(</span><span class="ident" id="1461997">unsafe</span><span class="op" id="1462003">.</span><span class="ident" id="1462004">Sizeof</span><span class="op" id="1462010">(</span><span class="ident" id="1462011">h</span><span class="op" id="1462012">)</span>&nbsp;<span class="op" id="1462014">-</span>&nbsp;<span class="num" id="1462016">1</span><span class="op" id="1462017">)</span><span class="op" id="1462018">)</span><span class="op" id="1462019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462023">h</span>&nbsp;<span class="op" id="1462025">+=</span>&nbsp;<span class="ident" id="1462028">x</span><span class="op" id="1462029">*</span><span class="num" id="1462030">31</span>&nbsp;<span class="op" id="1462033">+</span>&nbsp;<span class="ident" id="1462035">x</span><span class="op" id="1462036">*</span><span class="num" id="1462037">7</span>&nbsp;<span class="op" id="1462039">+</span>&nbsp;<span class="ident" id="1462041">x</span><span class="op" id="1462042">*</span><span class="num" id="1462043">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462046">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462049">p</span><span class="op" id="1462050">.</span><span class="ident" id="1462051">count</span><span class="op" id="1462056">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1462061">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462113">b</span>&nbsp;<span class="op" id="1462115">:=</span>&nbsp;<span class="op" id="1462118">&amp;</span><span class="ident" id="1462119">p</span><span class="op" id="1462120">.</span><span class="ident" id="1462121">hash</span><span class="op" id="1462125">[</span><span class="ident" id="1462126">h</span><span class="op" id="1462127">%</span><span class="ident" id="1462128">numBuckets</span><span class="op" id="1462138">]</span><br>
<span class="lineno"></span><span class="ident" id="1462140">Assoc</span><span class="op" id="1462145">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462148">for</span>&nbsp;<span class="ident" id="1462152">i</span>&nbsp;<span class="op" id="1462154">:=</span>&nbsp;<span class="keyword" id="1462157">range</span>&nbsp;<span class="ident" id="1462163">b</span><span class="op" id="1462164">.</span><span class="ident" id="1462165">entry</span>&nbsp;<span class="op" id="1462171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462175">e</span>&nbsp;<span class="op" id="1462177">:=</span>&nbsp;<span class="op" id="1462180">&amp;</span><span class="ident" id="1462181">b</span><span class="op" id="1462182">.</span><span class="ident" id="1462183">entry</span><span class="op" id="1462188">[</span><span class="ident" id="1462189">i</span><span class="op" id="1462190">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462194">if</span>&nbsp;<span class="ident" id="1462197">e</span><span class="op" id="1462198">.</span><span class="ident" id="1462199">depth</span>&nbsp;<span class="op" id="1462205">!=</span>&nbsp;<span class="builtintype" id="1462208">uintptr</span><span class="op" id="1462215">(</span><span class="builtinfunc" id="1462216">len</span><span class="op" id="1462219">(</span><span class="ident" id="1462220">pc</span><span class="op" id="1462222">)</span><span class="op" id="1462223">)</span>&nbsp;<span class="op" id="1462225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462230">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462241">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462245">for</span>&nbsp;<span class="ident" id="1462249">j</span>&nbsp;<span class="op" id="1462251">:=</span>&nbsp;<span class="keyword" id="1462254">range</span>&nbsp;<span class="ident" id="1462260">pc</span>&nbsp;<span class="op" id="1462263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462268">if</span>&nbsp;<span class="ident" id="1462271">e</span><span class="op" id="1462272">.</span><span class="ident" id="1462273">stack</span><span class="op" id="1462278">[</span><span class="ident" id="1462279">j</span><span class="op" id="1462280">]</span>&nbsp;<span class="op" id="1462282">!=</span>&nbsp;<span class="ident" id="1462285">pc</span><span class="op" id="1462287">[</span><span class="ident" id="1462288">j</span><span class="op" id="1462289">]</span>&nbsp;<span class="op" id="1462291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462297">continue</span>&nbsp;<span class="ident" id="1462306">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462319">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462323">e</span><span class="op" id="1462324">.</span><span class="ident" id="1462325">count</span><span class="op" id="1462330">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462335">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1462347">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462384">var</span>&nbsp;<span class="ident" id="1462388">e</span>&nbsp;<span class="op" id="1462390">*</span><span class="ident" id="1462391">cpuprofEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462405">for</span>&nbsp;<span class="ident" id="1462409">i</span>&nbsp;<span class="op" id="1462411">:=</span>&nbsp;<span class="keyword" id="1462414">range</span>&nbsp;<span class="ident" id="1462420">b</span><span class="op" id="1462421">.</span><span class="ident" id="1462422">entry</span>&nbsp;<span class="op" id="1462428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462432">if</span>&nbsp;<span class="ident" id="1462435">e</span>&nbsp;<span class="op" id="1462437">==</span>&nbsp;<span class="ident" id="1462440">nil</span>&nbsp;<span class="op" id="1462444">||</span>&nbsp;<span class="ident" id="1462447">b</span><span class="op" id="1462448">.</span><span class="ident" id="1462449">entry</span><span class="op" id="1462454">[</span><span class="ident" id="1462455">i</span><span class="op" id="1462456">]</span><span class="op" id="1462457">.</span><span class="ident" id="1462458">count</span>&nbsp;<span class="op" id="1462464">&lt;</span>&nbsp;<span class="ident" id="1462466">e</span><span class="op" id="1462467">.</span><span class="ident" id="1462468">count</span>&nbsp;<span class="op" id="1462474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462479">e</span>&nbsp;<span class="op" id="1462481">=</span>&nbsp;<span class="op" id="1462483">&amp;</span><span class="ident" id="1462484">b</span><span class="op" id="1462485">.</span><span class="ident" id="1462486">entry</span><span class="op" id="1462491">[</span><span class="ident" id="1462492">i</span><span class="op" id="1462493">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462497">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462503">if</span>&nbsp;<span class="ident" id="1462506">e</span><span class="op" id="1462507">.</span><span class="ident" id="1462508">count</span>&nbsp;<span class="op" id="1462514">&gt;</span>&nbsp;<span class="num" id="1462516">0</span>&nbsp;<span class="op" id="1462518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462522">if</span>&nbsp;<span class="op" id="1462525">!</span><span class="ident" id="1462526">p</span><span class="op" id="1462527">.</span><span class="ident" id="1462528">evict</span><span class="op" id="1462533">(</span><span class="ident" id="1462534">e</span><span class="op" id="1462535">)</span>&nbsp;<span class="op" id="1462537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1462542">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462591">p</span><span class="op" id="1462592">.</span><span class="ident" id="1462593">lost</span><span class="op" id="1462597">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1462603">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462616">p</span><span class="op" id="1462617">.</span><span class="ident" id="1462618">evicts</span><span class="op" id="1462624">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1462628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1462632">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462667">e</span><span class="op" id="1462668">.</span><span class="ident" id="1462669">depth</span>&nbsp;<span class="op" id="1462675">=</span>&nbsp;<span class="builtintype" id="1462677">uintptr</span><span class="op" id="1462684">(</span><span class="builtinfunc" id="1462685">len</span><span class="op" id="1462688">(</span><span class="ident" id="1462689">pc</span><span class="op" id="1462691">)</span><span class="op" id="1462692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1462695">e</span><span class="op" id="1462696">.</span><span class="ident" id="1462697">count</span>&nbsp;<span class="op" id="1462703">=</span>&nbsp;<span class="num" id="1462705">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1462708">copy</span><span class="op" id="1462712">(</span><span class="ident" id="1462713">e</span><span class="op" id="1462714">.</span><span class="ident" id="1462715">stack</span><span class="op" id="1462720">[</span><span class="op" id="1462721">:</span><span class="op" id="1462722">]</span><span class="op" id="1462723">,</span>&nbsp;<span class="ident" id="1462725">pc</span><span class="op" id="1462727">)</span><br>
<span class="lineno"></span><span class="op" id="1462729">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1462732">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1462793">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1462854">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1462917">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1462976">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1463034">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1463075">func</span>&nbsp;<span class="op" id="1463080">(</span><span class="ident" id="1463081">p</span>&nbsp;<span class="op" id="1463083">*</span><span class="ident" id="1463084">cpuProfile</span><span class="op" id="1463094">)</span>&nbsp;<span class="ident" id="1463096">evict</span><span class="op" id="1463101">(</span><span class="ident" id="1463102">e</span>&nbsp;<span class="op" id="1463104">*</span><span class="ident" id="1463105">cpuprofEntry</span><span class="op" id="1463117">)</span>&nbsp;<span class="builtintype" id="1463119">bool</span>&nbsp;<span class="op" id="1463124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463127">d</span>&nbsp;<span class="op" id="1463129">:=</span>&nbsp;<span class="ident" id="1463132">e</span><span class="op" id="1463133">.</span><span class="ident" id="1463134">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463141">nslot</span>&nbsp;<span class="op" id="1463147">:=</span>&nbsp;<span class="ident" id="1463150">d</span>&nbsp;<span class="op" id="1463152">+</span>&nbsp;<span class="num" id="1463154">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463157">log</span>&nbsp;<span class="op" id="1463161">:=</span>&nbsp;<span class="op" id="1463164">&amp;</span><span class="ident" id="1463165">p</span><span class="op" id="1463166">.</span><span class="ident" id="1463167">log</span><span class="op" id="1463170">[</span><span class="ident" id="1463171">p</span><span class="op" id="1463172">.</span><span class="ident" id="1463173">toggle</span><span class="op" id="1463179">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463182">if</span>&nbsp;<span class="ident" id="1463185">p</span><span class="op" id="1463186">.</span><span class="ident" id="1463187">nlog</span><span class="op" id="1463191">+</span><span class="ident" id="1463192">nslot</span>&nbsp;<span class="op" id="1463198">&gt;</span>&nbsp;<span class="builtintype" id="1463200">uintptr</span><span class="op" id="1463207">(</span><span class="builtinfunc" id="1463208">len</span><span class="op" id="1463211">(</span><span class="ident" id="1463212">p</span><span class="op" id="1463213">.</span><span class="ident" id="1463214">log</span><span class="op" id="1463217">[</span><span class="num" id="1463218">0</span><span class="op" id="1463219">]</span><span class="op" id="1463220">)</span><span class="op" id="1463221">)</span>&nbsp;<span class="op" id="1463223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463227">if</span>&nbsp;<span class="op" id="1463230">!</span><span class="ident" id="1463231">p</span><span class="op" id="1463232">.</span><span class="ident" id="1463233">flushlog</span><span class="op" id="1463241">(</span><span class="op" id="1463242">)</span>&nbsp;<span class="op" id="1463244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463249">return</span>&nbsp;<span class="builtintype" id="1463256">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463264">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463268">log</span>&nbsp;<span class="op" id="1463272">=</span>&nbsp;<span class="op" id="1463274">&amp;</span><span class="ident" id="1463275">p</span><span class="op" id="1463276">.</span><span class="ident" id="1463277">log</span><span class="op" id="1463280">[</span><span class="ident" id="1463281">p</span><span class="op" id="1463282">.</span><span class="ident" id="1463283">toggle</span><span class="op" id="1463289">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463296">q</span>&nbsp;<span class="op" id="1463298">:=</span>&nbsp;<span class="ident" id="1463301">p</span><span class="op" id="1463302">.</span><span class="ident" id="1463303">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463309">log</span><span class="op" id="1463312">[</span><span class="ident" id="1463313">q</span><span class="op" id="1463314">]</span>&nbsp;<span class="op" id="1463316">=</span>&nbsp;<span class="ident" id="1463318">e</span><span class="op" id="1463319">.</span><span class="ident" id="1463320">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463327">q</span><span class="op" id="1463328">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463332">log</span><span class="op" id="1463335">[</span><span class="ident" id="1463336">q</span><span class="op" id="1463337">]</span>&nbsp;<span class="op" id="1463339">=</span>&nbsp;<span class="ident" id="1463341">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463344">q</span><span class="op" id="1463345">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1463349">copy</span><span class="op" id="1463353">(</span><span class="ident" id="1463354">log</span><span class="op" id="1463357">[</span><span class="ident" id="1463358">q</span><span class="op" id="1463359">:</span><span class="op" id="1463360">]</span><span class="op" id="1463361">,</span>&nbsp;<span class="ident" id="1463363">e</span><span class="op" id="1463364">.</span><span class="ident" id="1463365">stack</span><span class="op" id="1463370">[</span><span class="op" id="1463371">:</span><span class="ident" id="1463372">d</span><span class="op" id="1463373">]</span><span class="op" id="1463374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463377">q</span>&nbsp;<span class="op" id="1463379">+=</span>&nbsp;<span class="ident" id="1463382">d</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463385">p</span><span class="op" id="1463386">.</span><span class="ident" id="1463387">nlog</span>&nbsp;<span class="op" id="1463392">=</span>&nbsp;<span class="ident" id="1463394">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463397">e</span><span class="op" id="1463398">.</span><span class="ident" id="1463399">count</span>&nbsp;<span class="op" id="1463405">=</span>&nbsp;<span class="num" id="1463407">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463410">return</span>&nbsp;<span class="builtintype" id="1463417">true</span><br>
<span class="lineno"></span><span class="op" id="1463422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1463425">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1463497">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1463580">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1463652">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1463731">func</span>&nbsp;<span class="op" id="1463736">(</span><span class="ident" id="1463737">p</span>&nbsp;<span class="op" id="1463739">*</span><span class="ident" id="1463740">cpuProfile</span><span class="op" id="1463750">)</span>&nbsp;<span class="ident" id="1463752">flushlog</span><span class="op" id="1463760">(</span><span class="op" id="1463761">)</span>&nbsp;<span class="builtintype" id="1463763">bool</span>&nbsp;<span class="op" id="1463768">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463771">if</span>&nbsp;<span class="op" id="1463774">!</span><span class="ident" id="1463775">cas</span><span class="op" id="1463778">(</span><span class="op" id="1463779">&amp;</span><span class="ident" id="1463780">p</span><span class="op" id="1463781">.</span><span class="ident" id="1463782">handoff</span><span class="op" id="1463789">,</span>&nbsp;<span class="num" id="1463791">0</span><span class="op" id="1463792">,</span>&nbsp;<span class="builtintype" id="1463794">uint32</span><span class="op" id="1463800">(</span><span class="ident" id="1463801">p</span><span class="op" id="1463802">.</span><span class="ident" id="1463803">nlog</span><span class="op" id="1463807">)</span><span class="op" id="1463808">)</span>&nbsp;<span class="op" id="1463810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463814">return</span>&nbsp;<span class="builtintype" id="1463821">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1463828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463831">notewakeup</span><span class="op" id="1463841">(</span><span class="op" id="1463842">&amp;</span><span class="ident" id="1463843">p</span><span class="op" id="1463844">.</span><span class="ident" id="1463845">wait</span><span class="op" id="1463849">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463853">p</span><span class="op" id="1463854">.</span><span class="ident" id="1463855">toggle</span>&nbsp;<span class="op" id="1463862">=</span>&nbsp;<span class="num" id="1463864">1</span>&nbsp;<span class="op" id="1463866">-</span>&nbsp;<span class="ident" id="1463868">p</span><span class="op" id="1463869">.</span><span class="ident" id="1463870">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463878">log</span>&nbsp;<span class="op" id="1463882">:=</span>&nbsp;<span class="op" id="1463885">&amp;</span><span class="ident" id="1463886">p</span><span class="op" id="1463887">.</span><span class="ident" id="1463888">log</span><span class="op" id="1463891">[</span><span class="ident" id="1463892">p</span><span class="op" id="1463893">.</span><span class="ident" id="1463894">toggle</span><span class="op" id="1463900">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463903">q</span>&nbsp;<span class="op" id="1463905">:=</span>&nbsp;<span class="builtintype" id="1463908">uintptr</span><span class="op" id="1463915">(</span><span class="num" id="1463916">0</span><span class="op" id="1463917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1463920">if</span>&nbsp;<span class="ident" id="1463923">p</span><span class="op" id="1463924">.</span><span class="ident" id="1463925">lost</span>&nbsp;<span class="op" id="1463930">&gt;</span>&nbsp;<span class="num" id="1463932">0</span>&nbsp;<span class="op" id="1463934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463938">lostPC</span>&nbsp;<span class="op" id="1463945">:=</span>&nbsp;<span class="ident" id="1463948">funcPC</span><span class="op" id="1463954">(</span><span class="ident" id="1463955">lostProfileData</span><span class="op" id="1463970">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463974">log</span><span class="op" id="1463977">[</span><span class="num" id="1463978">0</span><span class="op" id="1463979">]</span>&nbsp;<span class="op" id="1463981">=</span>&nbsp;<span class="ident" id="1463983">p</span><span class="op" id="1463984">.</span><span class="ident" id="1463985">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1463992">log</span><span class="op" id="1463995">[</span><span class="num" id="1463996">1</span><span class="op" id="1463997">]</span>&nbsp;<span class="op" id="1463999">=</span>&nbsp;<span class="num" id="1464001">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464005">log</span><span class="op" id="1464008">[</span><span class="num" id="1464009">2</span><span class="op" id="1464010">]</span>&nbsp;<span class="op" id="1464012">=</span>&nbsp;<span class="ident" id="1464014">lostPC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464023">q</span>&nbsp;<span class="op" id="1464025">=</span>&nbsp;<span class="num" id="1464027">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464031">p</span><span class="op" id="1464032">.</span><span class="ident" id="1464033">lost</span>&nbsp;<span class="op" id="1464038">=</span>&nbsp;<span class="num" id="1464040">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464046">p</span><span class="op" id="1464047">.</span><span class="ident" id="1464048">nlog</span>&nbsp;<span class="op" id="1464053">=</span>&nbsp;<span class="ident" id="1464055">q</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464058">return</span>&nbsp;<span class="builtintype" id="1464065">true</span><br>
<span class="lineno"></span><span class="op" id="1464070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1464073">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1464146">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1464219">func</span>&nbsp;<span class="op" id="1464224">(</span><span class="ident" id="1464225">p</span>&nbsp;<span class="op" id="1464227">*</span><span class="ident" id="1464228">cpuProfile</span><span class="op" id="1464238">)</span>&nbsp;<span class="ident" id="1464240">getprofile</span><span class="op" id="1464250">(</span><span class="op" id="1464251">)</span>&nbsp;<span class="op" id="1464253">[</span><span class="op" id="1464254">]</span><span class="builtintype" id="1464255">byte</span>&nbsp;<span class="op" id="1464260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464263">if</span>&nbsp;<span class="ident" id="1464266">p</span>&nbsp;<span class="op" id="1464268">==</span>&nbsp;<span class="ident" id="1464271">nil</span>&nbsp;<span class="op" id="1464275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464279">return</span>&nbsp;<span class="ident" id="1464286">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464295">if</span>&nbsp;<span class="ident" id="1464298">p</span><span class="op" id="1464299">.</span><span class="ident" id="1464300">wholding</span>&nbsp;<span class="op" id="1464309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1464313">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1464364">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464426">for</span>&nbsp;<span class="op" id="1464430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464435">n</span>&nbsp;<span class="op" id="1464437">:=</span>&nbsp;<span class="ident" id="1464440">p</span><span class="op" id="1464441">.</span><span class="ident" id="1464442">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464453">if</span>&nbsp;<span class="ident" id="1464456">n</span>&nbsp;<span class="op" id="1464458">==</span>&nbsp;<span class="num" id="1464461">0</span>&nbsp;<span class="op" id="1464463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1464469">print</span><span class="op" id="1464474">(</span><span class="string" id="1464475">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1464526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464532">return</span>&nbsp;<span class="ident" id="1464539">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464551">if</span>&nbsp;<span class="ident" id="1464554">n</span><span class="op" id="1464555">&amp;</span><span class="num" id="1464556">0x80000000</span>&nbsp;<span class="op" id="1464567">!=</span>&nbsp;<span class="num" id="1464570">0</span>&nbsp;<span class="op" id="1464572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464578">p</span><span class="op" id="1464579">.</span><span class="ident" id="1464580">wtoggle</span>&nbsp;<span class="op" id="1464588">=</span>&nbsp;<span class="num" id="1464590">1</span>&nbsp;<span class="op" id="1464592">-</span>&nbsp;<span class="ident" id="1464594">p</span><span class="op" id="1464595">.</span><span class="ident" id="1464596">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464608">p</span><span class="op" id="1464609">.</span><span class="ident" id="1464610">wholding</span>&nbsp;<span class="op" id="1464619">=</span>&nbsp;<span class="builtintype" id="1464621">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464631">p</span><span class="op" id="1464632">.</span><span class="ident" id="1464633">flushing</span>&nbsp;<span class="op" id="1464642">=</span>&nbsp;<span class="builtintype" id="1464644">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464653">goto</span>&nbsp;<span class="ident" id="1464658">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464672">if</span>&nbsp;<span class="ident" id="1464675">cas</span><span class="op" id="1464678">(</span><span class="op" id="1464679">&amp;</span><span class="ident" id="1464680">p</span><span class="op" id="1464681">.</span><span class="ident" id="1464682">handoff</span><span class="op" id="1464689">,</span>&nbsp;<span class="ident" id="1464691">n</span><span class="op" id="1464692">,</span>&nbsp;<span class="num" id="1464694">0</span><span class="op" id="1464695">)</span>&nbsp;<span class="op" id="1464697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464703">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464712">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464720">p</span><span class="op" id="1464721">.</span><span class="ident" id="1464722">wtoggle</span>&nbsp;<span class="op" id="1464730">=</span>&nbsp;<span class="num" id="1464732">1</span>&nbsp;<span class="op" id="1464734">-</span>&nbsp;<span class="ident" id="1464736">p</span><span class="op" id="1464737">.</span><span class="ident" id="1464738">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464748">p</span><span class="op" id="1464749">.</span><span class="ident" id="1464750">wholding</span>&nbsp;<span class="op" id="1464759">=</span>&nbsp;<span class="builtintype" id="1464761">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464772">if</span>&nbsp;<span class="ident" id="1464775">p</span><span class="op" id="1464776">.</span><span class="ident" id="1464777">flushing</span>&nbsp;<span class="op" id="1464786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464790">goto</span>&nbsp;<span class="ident" id="1464795">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464806">if</span>&nbsp;<span class="op" id="1464809">!</span><span class="ident" id="1464810">p</span><span class="op" id="1464811">.</span><span class="ident" id="1464812">on</span>&nbsp;<span class="op" id="1464815">&amp;&amp;</span>&nbsp;<span class="ident" id="1464818">p</span><span class="op" id="1464819">.</span><span class="ident" id="1464820">handoff</span>&nbsp;<span class="op" id="1464828">==</span>&nbsp;<span class="num" id="1464831">0</span>&nbsp;<span class="op" id="1464833">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464837">return</span>&nbsp;<span class="ident" id="1464844">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1464849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1464853">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464875">notetsleepg</span><span class="op" id="1464886">(</span><span class="op" id="1464887">&amp;</span><span class="ident" id="1464888">p</span><span class="op" id="1464889">.</span><span class="ident" id="1464890">wait</span><span class="op" id="1464894">,</span>&nbsp;<span class="op" id="1464896">-</span><span class="num" id="1464897">1</span><span class="op" id="1464898">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1464901">noteclear</span><span class="op" id="1464910">(</span><span class="op" id="1464911">&amp;</span><span class="ident" id="1464912">p</span><span class="op" id="1464913">.</span><span class="ident" id="1464914">wait</span><span class="op" id="1464918">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464922">switch</span>&nbsp;<span class="ident" id="1464929">n</span>&nbsp;<span class="op" id="1464931">:=</span>&nbsp;<span class="ident" id="1464934">p</span><span class="op" id="1464935">.</span><span class="ident" id="1464936">handoff</span><span class="op" id="1464943">;</span>&nbsp;<span class="op" id="1464945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1464948">case</span>&nbsp;<span class="ident" id="1464953">n</span>&nbsp;<span class="op" id="1464955">==</span>&nbsp;<span class="num" id="1464958">0</span><span class="op" id="1464959">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1464963">print</span><span class="op" id="1464968">(</span><span class="string" id="1464969">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1465017">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465021">return</span>&nbsp;<span class="ident" id="1465028">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465033">case</span>&nbsp;<span class="ident" id="1465038">n</span>&nbsp;<span class="op" id="1465040">==</span>&nbsp;<span class="num" id="1465043">0x80000000</span><span class="op" id="1465053">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465057">p</span><span class="op" id="1465058">.</span><span class="ident" id="1465059">flushing</span>&nbsp;<span class="op" id="1465068">=</span>&nbsp;<span class="builtintype" id="1465070">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465077">goto</span>&nbsp;<span class="ident" id="1465082">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465089">default</span><span class="op" id="1465096">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465100">n</span>&nbsp;<span class="op" id="1465102">&amp;^=</span>&nbsp;<span class="num" id="1465106">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465120">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465151">p</span><span class="op" id="1465152">.</span><span class="ident" id="1465153">wholding</span>&nbsp;<span class="op" id="1465162">=</span>&nbsp;<span class="builtintype" id="1465164">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465172">return</span>&nbsp;<span class="ident" id="1465179">uintptrBytes</span><span class="op" id="1465191">(</span><span class="ident" id="1465192">p</span><span class="op" id="1465193">.</span><span class="ident" id="1465194">log</span><span class="op" id="1465197">[</span><span class="ident" id="1465198">p</span><span class="op" id="1465199">.</span><span class="ident" id="1465200">wtoggle</span><span class="op" id="1465207">]</span><span class="op" id="1465208">[</span><span class="op" id="1465209">:</span><span class="ident" id="1465210">n</span><span class="op" id="1465211">]</span><span class="op" id="1465212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465219">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465238">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465290">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465355">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1465407">Flush</span><span class="op" id="1465412">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465415">for</span>&nbsp;<span class="ident" id="1465419">i</span>&nbsp;<span class="op" id="1465421">:=</span>&nbsp;<span class="keyword" id="1465424">range</span>&nbsp;<span class="ident" id="1465430">p</span><span class="op" id="1465431">.</span><span class="ident" id="1465432">hash</span>&nbsp;<span class="op" id="1465437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465441">b</span>&nbsp;<span class="op" id="1465443">:=</span>&nbsp;<span class="op" id="1465446">&amp;</span><span class="ident" id="1465447">p</span><span class="op" id="1465448">.</span><span class="ident" id="1465449">hash</span><span class="op" id="1465453">[</span><span class="ident" id="1465454">i</span><span class="op" id="1465455">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465459">for</span>&nbsp;<span class="ident" id="1465463">j</span>&nbsp;<span class="op" id="1465465">:=</span>&nbsp;<span class="keyword" id="1465468">range</span>&nbsp;<span class="ident" id="1465474">b</span><span class="op" id="1465475">.</span><span class="ident" id="1465476">entry</span>&nbsp;<span class="op" id="1465482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465487">e</span>&nbsp;<span class="op" id="1465489">:=</span>&nbsp;<span class="op" id="1465492">&amp;</span><span class="ident" id="1465493">b</span><span class="op" id="1465494">.</span><span class="ident" id="1465495">entry</span><span class="op" id="1465500">[</span><span class="ident" id="1465501">j</span><span class="op" id="1465502">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465507">if</span>&nbsp;<span class="ident" id="1465510">e</span><span class="op" id="1465511">.</span><span class="ident" id="1465512">count</span>&nbsp;<span class="op" id="1465518">&gt;</span>&nbsp;<span class="num" id="1465520">0</span>&nbsp;<span class="op" id="1465522">&amp;&amp;</span>&nbsp;<span class="op" id="1465525">!</span><span class="ident" id="1465526">p</span><span class="op" id="1465527">.</span><span class="ident" id="1465528">evict</span><span class="op" id="1465533">(</span><span class="ident" id="1465534">e</span><span class="op" id="1465535">)</span>&nbsp;<span class="op" id="1465537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465543">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465608">break</span>&nbsp;<span class="ident" id="1465614">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465634">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465663">if</span>&nbsp;<span class="ident" id="1465666">p</span><span class="op" id="1465667">.</span><span class="ident" id="1465668">nlog</span>&nbsp;<span class="op" id="1465673">&gt;</span>&nbsp;<span class="num" id="1465675">0</span>&nbsp;<span class="op" id="1465677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465681">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465733">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465781">n</span>&nbsp;<span class="op" id="1465783">:=</span>&nbsp;<span class="ident" id="1465786">p</span><span class="op" id="1465787">.</span><span class="ident" id="1465788">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1465795">p</span><span class="op" id="1465796">.</span><span class="ident" id="1465797">nlog</span>&nbsp;<span class="op" id="1465802">=</span>&nbsp;<span class="num" id="1465804">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465808">return</span>&nbsp;<span class="ident" id="1465815">uintptrBytes</span><span class="op" id="1465827">(</span><span class="ident" id="1465828">p</span><span class="op" id="1465829">.</span><span class="ident" id="1465830">log</span><span class="op" id="1465833">[</span><span class="ident" id="1465834">p</span><span class="op" id="1465835">.</span><span class="ident" id="1465836">toggle</span><span class="op" id="1465842">]</span><span class="op" id="1465843">[</span><span class="op" id="1465844">:</span><span class="ident" id="1465845">n</span><span class="op" id="1465846">]</span><span class="op" id="1465847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1465850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465854">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1465917">if</span>&nbsp;<span class="op" id="1465920">!</span><span class="ident" id="1465921">p</span><span class="op" id="1465922">.</span><span class="ident" id="1465923">eodSent</span>&nbsp;<span class="op" id="1465931">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1465935">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466001">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466066">p</span><span class="op" id="1466067">.</span><span class="ident" id="1466068">eodSent</span>&nbsp;<span class="op" id="1466076">=</span>&nbsp;<span class="builtintype" id="1466078">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466085">return</span>&nbsp;<span class="ident" id="1466092">uintptrBytes</span><span class="op" id="1466104">(</span><span class="ident" id="1466105">eod</span><span class="op" id="1466108">[</span><span class="op" id="1466109">:</span><span class="op" id="1466110">]</span><span class="op" id="1466111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466114">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1466118">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466162">p</span><span class="op" id="1466163">.</span><span class="ident" id="1466164">flushing</span>&nbsp;<span class="op" id="1466173">=</span>&nbsp;<span class="builtintype" id="1466175">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466182">if</span>&nbsp;<span class="op" id="1466185">!</span><span class="ident" id="1466186">cas</span><span class="op" id="1466189">(</span><span class="op" id="1466190">&amp;</span><span class="ident" id="1466191">p</span><span class="op" id="1466192">.</span><span class="ident" id="1466193">handoff</span><span class="op" id="1466200">,</span>&nbsp;<span class="ident" id="1466202">p</span><span class="op" id="1466203">.</span><span class="ident" id="1466204">handoff</span><span class="op" id="1466211">,</span>&nbsp;<span class="num" id="1466213">0</span><span class="op" id="1466214">)</span>&nbsp;<span class="op" id="1466216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1466220">print</span><span class="op" id="1466225">(</span><span class="string" id="1466226">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1466274">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1466277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466280">return</span>&nbsp;<span class="ident" id="1466287">nil</span><br>
<span class="lineno"></span><span class="op" id="1466291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1466294">func</span>&nbsp;<span class="ident" id="1466299">uintptrBytes</span><span class="op" id="1466311">(</span><span class="ident" id="1466312">p</span>&nbsp;<span class="op" id="1466314">[</span><span class="op" id="1466315">]</span><span class="builtintype" id="1466316">uintptr</span><span class="op" id="1466323">)</span>&nbsp;<span class="op" id="1466325">(</span><span class="ident" id="1466326">ret</span>&nbsp;<span class="op" id="1466330">[</span><span class="op" id="1466331">]</span><span class="builtintype" id="1466332">byte</span><span class="op" id="1466336">)</span>&nbsp;<span class="op" id="1466338">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466341">pp</span>&nbsp;<span class="op" id="1466344">:=</span>&nbsp;<span class="op" id="1466347">(</span><span class="op" id="1466348">*</span><span class="ident" id="1466349">sliceStruct</span><span class="op" id="1466360">)</span><span class="op" id="1466361">(</span><span class="ident" id="1466362">unsafe</span><span class="op" id="1466368">.</span><span class="ident" id="1466369">Pointer</span><span class="op" id="1466376">(</span><span class="op" id="1466377">&amp;</span><span class="ident" id="1466378">p</span><span class="op" id="1466379">)</span><span class="op" id="1466380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466383">rp</span>&nbsp;<span class="op" id="1466386">:=</span>&nbsp;<span class="op" id="1466389">(</span><span class="op" id="1466390">*</span><span class="ident" id="1466391">sliceStruct</span><span class="op" id="1466402">)</span><span class="op" id="1466403">(</span><span class="ident" id="1466404">unsafe</span><span class="op" id="1466410">.</span><span class="ident" id="1466411">Pointer</span><span class="op" id="1466418">(</span><span class="op" id="1466419">&amp;</span><span class="ident" id="1466420">ret</span><span class="op" id="1466423">)</span><span class="op" id="1466424">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466428">rp</span><span class="op" id="1466430">.</span><span class="ident" id="1466431">array</span>&nbsp;<span class="op" id="1466437">=</span>&nbsp;<span class="ident" id="1466439">pp</span><span class="op" id="1466441">.</span><span class="ident" id="1466442">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466449">rp</span><span class="op" id="1466451">.</span><span class="builtinfunc" id="1466452">len</span>&nbsp;<span class="op" id="1466456">=</span>&nbsp;<span class="ident" id="1466458">pp</span><span class="op" id="1466460">.</span><span class="builtinfunc" id="1466461">len</span>&nbsp;<span class="op" id="1466465">*</span>&nbsp;<span class="builtintype" id="1466467">int</span><span class="op" id="1466470">(</span><span class="ident" id="1466471">unsafe</span><span class="op" id="1466477">.</span><span class="ident" id="1466478">Sizeof</span><span class="op" id="1466484">(</span><span class="ident" id="1466485">p</span><span class="op" id="1466486">[</span><span class="num" id="1466487">0</span><span class="op" id="1466488">]</span><span class="op" id="1466489">)</span><span class="op" id="1466490">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1466493">rp</span><span class="op" id="1466495">.</span><span class="builtinfunc" id="1466496">cap</span>&nbsp;<span class="op" id="1466500">=</span>&nbsp;<span class="ident" id="1466502">rp</span><span class="op" id="1466504">.</span><span class="builtinfunc" id="1466505">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1466511">return</span><br>
<span class="lineno"></span><span class="op" id="1466518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1466521">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1466600">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1466685">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1466764">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1466839">//</span><br>
<span class="lineno">420</span><span class="comment" id="1466842">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1466898">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1466964">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1466988">func</span>&nbsp;<span class="ident" id="1466993">CPUProfile</span><span class="op" id="1467003">(</span><span class="op" id="1467004">)</span>&nbsp;<span class="op" id="1467006">[</span><span class="op" id="1467007">]</span><span class="builtintype" id="1467008">byte</span>&nbsp;<span class="op" id="1467013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1467016">return</span>&nbsp;<span class="ident" id="1467023">cpuprof</span><span class="op" id="1467030">.</span><span class="ident" id="1467031">getprofile</span><span class="op" id="1467041">(</span><span class="op" id="1467042">)</span><br>
<span class="lineno">425</span><span class="op" id="1467044">}</span>
</div>
</body>
</html>
