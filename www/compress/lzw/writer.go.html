<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5503476">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5503531">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5503585">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5503636">package</span>&nbsp;<span class="ident" id="5503644">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5503649">import</span>&nbsp;<span class="op" id="5503656">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5503659">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5503668">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5503678">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5503685">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5503690">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5503693">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="5503738">type</span>&nbsp;<span class="ident" id="5503743">writer</span>&nbsp;<span class="keyword" id="5503750">interface</span>&nbsp;<span class="op" id="5503760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503763">io</span><span class="op" id="5503765">.</span><span class="ident" id="5503766">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503778">Flush</span><span class="op" id="5503783">(</span><span class="op" id="5503784">)</span>&nbsp;<span class="builtintype" id="5503786">error</span><br>
<span class="lineno"></span><span class="op" id="5503792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5503795">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="5503872">type</span>&nbsp;<span class="ident" id="5503877">errWriteCloser</span>&nbsp;<span class="keyword" id="5503892">struct</span>&nbsp;<span class="op" id="5503899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5503902">err</span>&nbsp;<span class="builtintype" id="5503906">error</span><br>
<span class="lineno"></span><span class="op" id="5503912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5503915">func</span>&nbsp;<span class="op" id="5503920">(</span><span class="ident" id="5503921">e</span>&nbsp;<span class="op" id="5503923">*</span><span class="ident" id="5503924">errWriteCloser</span><span class="op" id="5503938">)</span>&nbsp;<span class="ident" id="5503940">Write</span><span class="op" id="5503945">(</span><span class="op" id="5503946">[</span><span class="op" id="5503947">]</span><span class="builtintype" id="5503948">byte</span><span class="op" id="5503952">)</span>&nbsp;<span class="op" id="5503954">(</span><span class="builtintype" id="5503955">int</span><span class="op" id="5503958">,</span>&nbsp;<span class="builtintype" id="5503960">error</span><span class="op" id="5503965">)</span>&nbsp;<span class="op" id="5503967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5503970">return</span>&nbsp;<span class="num" id="5503977">0</span><span class="op" id="5503978">,</span>&nbsp;<span class="ident" id="5503980">e</span><span class="op" id="5503981">.</span><span class="ident" id="5503982">err</span><br>
<span class="lineno"></span><span class="op" id="5503986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5503989">func</span>&nbsp;<span class="op" id="5503994">(</span><span class="ident" id="5503995">e</span>&nbsp;<span class="op" id="5503997">*</span><span class="ident" id="5503998">errWriteCloser</span><span class="op" id="5504012">)</span>&nbsp;<span class="ident" id="5504014">Close</span><span class="op" id="5504019">(</span><span class="op" id="5504020">)</span>&nbsp;<span class="builtintype" id="5504022">error</span>&nbsp;<span class="op" id="5504028">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5504031">return</span>&nbsp;<span class="ident" id="5504038">e</span><span class="op" id="5504039">.</span><span class="ident" id="5504040">err</span><br>
<span class="lineno"></span><span class="op" id="5504044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5504047">const</span>&nbsp;<span class="op" id="5504053">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504056">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504128">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504169">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504181">=</span>&nbsp;<span class="num" id="5504183">1</span><span class="op" id="5504184">&lt;&lt;</span><span class="num" id="5504186">12</span>&nbsp;<span class="op" id="5504189">-</span>&nbsp;<span class="num" id="5504191">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504194">invalidCode</span>&nbsp;<span class="op" id="5504206">=</span>&nbsp;<span class="num" id="5504208">1</span><span class="op" id="5504209">&lt;&lt;</span><span class="num" id="5504211">32</span>&nbsp;<span class="op" id="5504214">-</span>&nbsp;<span class="num" id="5504216">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504219">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504296">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504375">tableSize</span>&nbsp;<span class="op" id="5504385">=</span>&nbsp;<span class="num" id="5504387">4</span>&nbsp;<span class="op" id="5504389">*</span>&nbsp;<span class="num" id="5504391">1</span>&nbsp;<span class="op" id="5504393">&lt;&lt;</span>&nbsp;<span class="num" id="5504396">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504400">tableMask</span>&nbsp;<span class="op" id="5504410">=</span>&nbsp;<span class="ident" id="5504412">tableSize</span>&nbsp;<span class="op" id="5504422">-</span>&nbsp;<span class="num" id="5504424">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504427">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504498">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504561">invalidEntry</span>&nbsp;<span class="op" id="5504574">=</span>&nbsp;<span class="num" id="5504576">0</span><br>
<span class="lineno">45</span><span class="op" id="5504578">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5504581">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="5504611">type</span>&nbsp;<span class="ident" id="5504616">encoder</span>&nbsp;<span class="keyword" id="5504624">struct</span>&nbsp;<span class="op" id="5504631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504634">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504692">w</span>&nbsp;<span class="ident" id="5504694">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504702">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504760">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504809">order</span>&nbsp;<span class="ident" id="5504815">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504822">write</span>&nbsp;<span class="keyword" id="5504828">func</span><span class="op" id="5504832">(</span><span class="op" id="5504833">*</span><span class="ident" id="5504834">encoder</span><span class="op" id="5504841">,</span>&nbsp;<span class="builtintype" id="5504843">uint32</span><span class="op" id="5504849">)</span>&nbsp;<span class="builtintype" id="5504851">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504858">bits</span>&nbsp;&nbsp;<span class="builtintype" id="5504864">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504872">nBits</span>&nbsp;<span class="builtintype" id="5504878">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504884">width</span>&nbsp;<span class="builtintype" id="5504890">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504896">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5504948">litWidth</span>&nbsp;<span class="builtintype" id="5504957">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5504963">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505017">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505080">hi</span><span class="op" id="5505082">,</span>&nbsp;<span class="ident" id="5505084">overflow</span>&nbsp;<span class="builtintype" id="5505093">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505101">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505175">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505239">savedCode</span>&nbsp;<span class="builtintype" id="5505249">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505257">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505332">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505386">err</span>&nbsp;<span class="builtintype" id="5505390">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505397">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505471">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505544">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5505615">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505649">table</span>&nbsp;<span class="op" id="5505655">[</span><span class="ident" id="5505656">tableSize</span><span class="op" id="5505665">]</span><span class="builtintype" id="5505666">uint32</span><br>
<span class="lineno"></span><span class="op" id="5505673">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="5505676">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5505747">func</span>&nbsp;<span class="op" id="5505752">(</span><span class="ident" id="5505753">e</span>&nbsp;<span class="op" id="5505755">*</span><span class="ident" id="5505756">encoder</span><span class="op" id="5505763">)</span>&nbsp;<span class="ident" id="5505765">writeLSB</span><span class="op" id="5505773">(</span><span class="ident" id="5505774">c</span>&nbsp;<span class="builtintype" id="5505776">uint32</span><span class="op" id="5505782">)</span>&nbsp;<span class="builtintype" id="5505784">error</span>&nbsp;<span class="op" id="5505790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505793">e</span><span class="op" id="5505794">.</span><span class="ident" id="5505795">bits</span>&nbsp;<span class="op" id="5505800">|=</span>&nbsp;<span class="ident" id="5505803">c</span>&nbsp;<span class="op" id="5505805">&lt;&lt;</span>&nbsp;<span class="ident" id="5505808">e</span><span class="op" id="5505809">.</span><span class="ident" id="5505810">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505817">e</span><span class="op" id="5505818">.</span><span class="ident" id="5505819">nBits</span>&nbsp;<span class="op" id="5505825">+=</span>&nbsp;<span class="ident" id="5505828">e</span><span class="op" id="5505829">.</span><span class="ident" id="5505830">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505837">for</span>&nbsp;<span class="ident" id="5505841">e</span><span class="op" id="5505842">.</span><span class="ident" id="5505843">nBits</span>&nbsp;<span class="op" id="5505849">&gt;=</span>&nbsp;<span class="num" id="5505852">8</span>&nbsp;<span class="op" id="5505854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505858">if</span>&nbsp;<span class="ident" id="5505861">err</span>&nbsp;<span class="op" id="5505865">:=</span>&nbsp;<span class="ident" id="5505868">e</span><span class="op" id="5505869">.</span><span class="ident" id="5505870">w</span><span class="op" id="5505871">.</span><span class="ident" id="5505872">WriteByte</span><span class="op" id="5505881">(</span><span class="builtintype" id="5505882">uint8</span><span class="op" id="5505887">(</span><span class="ident" id="5505888">e</span><span class="op" id="5505889">.</span><span class="ident" id="5505890">bits</span><span class="op" id="5505894">)</span><span class="op" id="5505895">)</span><span class="op" id="5505896">;</span>&nbsp;<span class="ident" id="5505898">err</span>&nbsp;<span class="op" id="5505902">!=</span>&nbsp;<span class="ident" id="5505905">nil</span>&nbsp;<span class="op" id="5505909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505914">return</span>&nbsp;<span class="ident" id="5505921">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505931">e</span><span class="op" id="5505932">.</span><span class="ident" id="5505933">bits</span>&nbsp;<span class="op" id="5505938">&gt;&gt;=</span>&nbsp;<span class="num" id="5505942">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5505946">e</span><span class="op" id="5505947">.</span><span class="ident" id="5505948">nBits</span>&nbsp;<span class="op" id="5505954">-=</span>&nbsp;<span class="num" id="5505957">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5505960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5505963">return</span>&nbsp;<span class="ident" id="5505970">nil</span><br>
<span class="lineno"></span><span class="op" id="5505974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="5505977">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5506047">func</span>&nbsp;<span class="op" id="5506052">(</span><span class="ident" id="5506053">e</span>&nbsp;<span class="op" id="5506055">*</span><span class="ident" id="5506056">encoder</span><span class="op" id="5506063">)</span>&nbsp;<span class="ident" id="5506065">writeMSB</span><span class="op" id="5506073">(</span><span class="ident" id="5506074">c</span>&nbsp;<span class="builtintype" id="5506076">uint32</span><span class="op" id="5506082">)</span>&nbsp;<span class="builtintype" id="5506084">error</span>&nbsp;<span class="op" id="5506090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506093">e</span><span class="op" id="5506094">.</span><span class="ident" id="5506095">bits</span>&nbsp;<span class="op" id="5506100">|=</span>&nbsp;<span class="ident" id="5506103">c</span>&nbsp;<span class="op" id="5506105">&lt;&lt;</span>&nbsp;<span class="op" id="5506108">(</span><span class="num" id="5506109">32</span>&nbsp;<span class="op" id="5506112">-</span>&nbsp;<span class="ident" id="5506114">e</span><span class="op" id="5506115">.</span><span class="ident" id="5506116">width</span>&nbsp;<span class="op" id="5506122">-</span>&nbsp;<span class="ident" id="5506124">e</span><span class="op" id="5506125">.</span><span class="ident" id="5506126">nBits</span><span class="op" id="5506131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506134">e</span><span class="op" id="5506135">.</span><span class="ident" id="5506136">nBits</span>&nbsp;<span class="op" id="5506142">+=</span>&nbsp;<span class="ident" id="5506145">e</span><span class="op" id="5506146">.</span><span class="ident" id="5506147">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506154">for</span>&nbsp;<span class="ident" id="5506158">e</span><span class="op" id="5506159">.</span><span class="ident" id="5506160">nBits</span>&nbsp;<span class="op" id="5506166">&gt;=</span>&nbsp;<span class="num" id="5506169">8</span>&nbsp;<span class="op" id="5506171">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506175">if</span>&nbsp;<span class="ident" id="5506178">err</span>&nbsp;<span class="op" id="5506182">:=</span>&nbsp;<span class="ident" id="5506185">e</span><span class="op" id="5506186">.</span><span class="ident" id="5506187">w</span><span class="op" id="5506188">.</span><span class="ident" id="5506189">WriteByte</span><span class="op" id="5506198">(</span><span class="builtintype" id="5506199">uint8</span><span class="op" id="5506204">(</span><span class="ident" id="5506205">e</span><span class="op" id="5506206">.</span><span class="ident" id="5506207">bits</span>&nbsp;<span class="op" id="5506212">&gt;&gt;</span>&nbsp;<span class="num" id="5506215">24</span><span class="op" id="5506217">)</span><span class="op" id="5506218">)</span><span class="op" id="5506219">;</span>&nbsp;<span class="ident" id="5506221">err</span>&nbsp;<span class="op" id="5506225">!=</span>&nbsp;<span class="ident" id="5506228">nil</span>&nbsp;<span class="op" id="5506232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506237">return</span>&nbsp;<span class="ident" id="5506244">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506254">e</span><span class="op" id="5506255">.</span><span class="ident" id="5506256">bits</span>&nbsp;<span class="op" id="5506261">&lt;&lt;=</span>&nbsp;<span class="num" id="5506265">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506269">e</span><span class="op" id="5506270">.</span><span class="ident" id="5506271">nBits</span>&nbsp;<span class="op" id="5506277">-=</span>&nbsp;<span class="num" id="5506280">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506286">return</span>&nbsp;<span class="ident" id="5506293">nil</span><br>
<span class="lineno"></span><span class="op" id="5506297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5506300">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="5506378">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="5506437">var</span>&nbsp;<span class="ident" id="5506441">errOutOfCodes</span>&nbsp;<span class="op" id="5506455">=</span>&nbsp;<span class="ident" id="5506457">errors</span><span class="op" id="5506463">.</span><span class="ident" id="5506464">New</span><span class="op" id="5506467">(</span><span class="string" id="5506468">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="5506487">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5506490">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5506563">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="5506637">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="5506681">func</span>&nbsp;<span class="op" id="5506686">(</span><span class="ident" id="5506687">e</span>&nbsp;<span class="op" id="5506689">*</span><span class="ident" id="5506690">encoder</span><span class="op" id="5506697">)</span>&nbsp;<span class="ident" id="5506699">incHi</span><span class="op" id="5506704">(</span><span class="op" id="5506705">)</span>&nbsp;<span class="builtintype" id="5506707">error</span>&nbsp;<span class="op" id="5506713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506716">e</span><span class="op" id="5506717">.</span><span class="ident" id="5506718">hi</span><span class="op" id="5506720">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506724">if</span>&nbsp;<span class="ident" id="5506727">e</span><span class="op" id="5506728">.</span><span class="ident" id="5506729">hi</span>&nbsp;<span class="op" id="5506732">==</span>&nbsp;<span class="ident" id="5506735">e</span><span class="op" id="5506736">.</span><span class="ident" id="5506737">overflow</span>&nbsp;<span class="op" id="5506746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506750">e</span><span class="op" id="5506751">.</span><span class="ident" id="5506752">width</span><span class="op" id="5506757">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506762">e</span><span class="op" id="5506763">.</span><span class="ident" id="5506764">overflow</span>&nbsp;<span class="op" id="5506773">&lt;&lt;=</span>&nbsp;<span class="num" id="5506777">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506783">if</span>&nbsp;<span class="ident" id="5506786">e</span><span class="op" id="5506787">.</span><span class="ident" id="5506788">hi</span>&nbsp;<span class="op" id="5506791">==</span>&nbsp;<span class="ident" id="5506794">maxCode</span>&nbsp;<span class="op" id="5506802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506806">clear</span>&nbsp;<span class="op" id="5506812">:=</span>&nbsp;<span class="builtintype" id="5506815">uint32</span><span class="op" id="5506821">(</span><span class="num" id="5506822">1</span><span class="op" id="5506823">)</span>&nbsp;<span class="op" id="5506825">&lt;&lt;</span>&nbsp;<span class="ident" id="5506828">e</span><span class="op" id="5506829">.</span><span class="ident" id="5506830">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506841">if</span>&nbsp;<span class="ident" id="5506844">err</span>&nbsp;<span class="op" id="5506848">:=</span>&nbsp;<span class="ident" id="5506851">e</span><span class="op" id="5506852">.</span><span class="ident" id="5506853">write</span><span class="op" id="5506858">(</span><span class="ident" id="5506859">e</span><span class="op" id="5506860">,</span>&nbsp;<span class="ident" id="5506862">clear</span><span class="op" id="5506867">)</span><span class="op" id="5506868">;</span>&nbsp;<span class="ident" id="5506870">err</span>&nbsp;<span class="op" id="5506874">!=</span>&nbsp;<span class="ident" id="5506877">nil</span>&nbsp;<span class="op" id="5506881">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506886">return</span>&nbsp;<span class="ident" id="5506893">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5506899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506903">e</span><span class="op" id="5506904">.</span><span class="ident" id="5506905">width</span>&nbsp;<span class="op" id="5506911">=</span>&nbsp;<span class="builtintype" id="5506913">uint</span><span class="op" id="5506917">(</span><span class="ident" id="5506918">e</span><span class="op" id="5506919">.</span><span class="ident" id="5506920">litWidth</span><span class="op" id="5506928">)</span>&nbsp;<span class="op" id="5506930">+</span>&nbsp;<span class="num" id="5506932">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506936">e</span><span class="op" id="5506937">.</span><span class="ident" id="5506938">hi</span>&nbsp;<span class="op" id="5506941">=</span>&nbsp;<span class="ident" id="5506943">clear</span>&nbsp;<span class="op" id="5506949">+</span>&nbsp;<span class="num" id="5506951">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5506955">e</span><span class="op" id="5506956">.</span><span class="ident" id="5506957">overflow</span>&nbsp;<span class="op" id="5506966">=</span>&nbsp;<span class="ident" id="5506968">clear</span>&nbsp;<span class="op" id="5506974">&lt;&lt;</span>&nbsp;<span class="num" id="5506977">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5506981">for</span>&nbsp;<span class="ident" id="5506985">i</span>&nbsp;<span class="op" id="5506987">:=</span>&nbsp;<span class="keyword" id="5506990">range</span>&nbsp;<span class="ident" id="5506996">e</span><span class="op" id="5506997">.</span><span class="ident" id="5506998">table</span>&nbsp;<span class="op" id="5507004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507009">e</span><span class="op" id="5507010">.</span><span class="ident" id="5507011">table</span><span class="op" id="5507016">[</span><span class="ident" id="5507017">i</span><span class="op" id="5507018">]</span>&nbsp;<span class="op" id="5507020">=</span>&nbsp;<span class="ident" id="5507022">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507041">return</span>&nbsp;<span class="ident" id="5507048">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507063">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507066">return</span>&nbsp;<span class="ident" id="5507073">nil</span><br>
<span class="lineno"></span><span class="op" id="5507077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5507080">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5507155">func</span>&nbsp;<span class="op" id="5507160">(</span><span class="ident" id="5507161">e</span>&nbsp;<span class="op" id="5507163">*</span><span class="ident" id="5507164">encoder</span><span class="op" id="5507171">)</span>&nbsp;<span class="ident" id="5507173">Write</span><span class="op" id="5507178">(</span><span class="ident" id="5507179">p</span>&nbsp;<span class="op" id="5507181">[</span><span class="op" id="5507182">]</span><span class="builtintype" id="5507183">byte</span><span class="op" id="5507187">)</span>&nbsp;<span class="op" id="5507189">(</span><span class="ident" id="5507190">n</span>&nbsp;<span class="builtintype" id="5507192">int</span><span class="op" id="5507195">,</span>&nbsp;<span class="ident" id="5507197">err</span>&nbsp;<span class="builtintype" id="5507201">error</span><span class="op" id="5507206">)</span>&nbsp;<span class="op" id="5507208">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507211">if</span>&nbsp;<span class="ident" id="5507214">e</span><span class="op" id="5507215">.</span><span class="ident" id="5507216">err</span>&nbsp;<span class="op" id="5507220">!=</span>&nbsp;<span class="ident" id="5507223">nil</span>&nbsp;<span class="op" id="5507227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507231">return</span>&nbsp;<span class="num" id="5507238">0</span><span class="op" id="5507239">,</span>&nbsp;<span class="ident" id="5507241">e</span><span class="op" id="5507242">.</span><span class="ident" id="5507243">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507251">if</span>&nbsp;<span class="builtinfunc" id="5507254">len</span><span class="op" id="5507257">(</span><span class="ident" id="5507258">p</span><span class="op" id="5507259">)</span>&nbsp;<span class="op" id="5507261">==</span>&nbsp;<span class="num" id="5507264">0</span>&nbsp;<span class="op" id="5507266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507270">return</span>&nbsp;<span class="num" id="5507277">0</span><span class="op" id="5507278">,</span>&nbsp;<span class="ident" id="5507280">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507288">n</span>&nbsp;<span class="op" id="5507290">=</span>&nbsp;<span class="builtinfunc" id="5507292">len</span><span class="op" id="5507295">(</span><span class="ident" id="5507296">p</span><span class="op" id="5507297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507300">litMask</span>&nbsp;<span class="op" id="5507308">:=</span>&nbsp;<span class="builtintype" id="5507311">uint32</span><span class="op" id="5507317">(</span><span class="num" id="5507318">1</span><span class="op" id="5507319">&lt;&lt;</span><span class="ident" id="5507321">e</span><span class="op" id="5507322">.</span><span class="ident" id="5507323">litWidth</span>&nbsp;<span class="op" id="5507332">-</span>&nbsp;<span class="num" id="5507334">1</span><span class="op" id="5507335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507338">code</span>&nbsp;<span class="op" id="5507343">:=</span>&nbsp;<span class="ident" id="5507346">e</span><span class="op" id="5507347">.</span><span class="ident" id="5507348">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507359">if</span>&nbsp;<span class="ident" id="5507362">code</span>&nbsp;<span class="op" id="5507367">==</span>&nbsp;<span class="ident" id="5507370">invalidCode</span>&nbsp;<span class="op" id="5507382">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5507386">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507437">code</span><span class="op" id="5507441">,</span>&nbsp;<span class="ident" id="5507443">p</span>&nbsp;<span class="op" id="5507445">=</span>&nbsp;<span class="builtintype" id="5507447">uint32</span><span class="op" id="5507453">(</span><span class="ident" id="5507454">p</span><span class="op" id="5507455">[</span><span class="num" id="5507456">0</span><span class="op" id="5507457">]</span><span class="op" id="5507458">)</span><span class="op" id="5507459">&amp;</span><span class="ident" id="5507460">litMask</span><span class="op" id="5507467">,</span>&nbsp;<span class="ident" id="5507469">p</span><span class="op" id="5507470">[</span><span class="num" id="5507471">1</span><span class="op" id="5507472">:</span><span class="op" id="5507473">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507476">}</span><br>
<span class="lineno"></span><span class="ident" id="5507478">loop</span><span class="op" id="5507482">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507485">for</span>&nbsp;<span class="ident" id="5507489">_</span><span class="op" id="5507490">,</span>&nbsp;<span class="ident" id="5507492">x</span>&nbsp;<span class="op" id="5507494">:=</span>&nbsp;<span class="keyword" id="5507497">range</span>&nbsp;<span class="ident" id="5507503">p</span>&nbsp;<span class="op" id="5507505">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507509">literal</span>&nbsp;<span class="op" id="5507517">:=</span>&nbsp;<span class="builtintype" id="5507520">uint32</span><span class="op" id="5507526">(</span><span class="ident" id="5507527">x</span><span class="op" id="5507528">)</span>&nbsp;<span class="op" id="5507530">&amp;</span>&nbsp;<span class="ident" id="5507532">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507542">key</span>&nbsp;<span class="op" id="5507546">:=</span>&nbsp;<span class="ident" id="5507549">code</span><span class="op" id="5507553">&lt;&lt;</span><span class="num" id="5507555">8</span>&nbsp;<span class="op" id="5507557">|</span>&nbsp;<span class="ident" id="5507559">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5507569">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5507642">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507675">hash</span>&nbsp;<span class="op" id="5507680">:=</span>&nbsp;<span class="op" id="5507683">(</span><span class="ident" id="5507684">key</span><span class="op" id="5507687">&gt;&gt;</span><span class="num" id="5507689">12</span>&nbsp;<span class="op" id="5507692">^</span>&nbsp;<span class="ident" id="5507694">key</span><span class="op" id="5507697">)</span>&nbsp;<span class="op" id="5507699">&amp;</span>&nbsp;<span class="ident" id="5507701">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507713">for</span>&nbsp;<span class="ident" id="5507717">h</span><span class="op" id="5507718">,</span>&nbsp;<span class="ident" id="5507720">t</span>&nbsp;<span class="op" id="5507722">:=</span>&nbsp;<span class="ident" id="5507725">hash</span><span class="op" id="5507729">,</span>&nbsp;<span class="ident" id="5507731">e</span><span class="op" id="5507732">.</span><span class="ident" id="5507733">table</span><span class="op" id="5507738">[</span><span class="ident" id="5507739">hash</span><span class="op" id="5507743">]</span><span class="op" id="5507744">;</span>&nbsp;<span class="ident" id="5507746">t</span>&nbsp;<span class="op" id="5507748">!=</span>&nbsp;<span class="ident" id="5507751">invalidEntry</span><span class="op" id="5507763">;</span>&nbsp;<span class="op" id="5507765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507770">if</span>&nbsp;<span class="ident" id="5507773">key</span>&nbsp;<span class="op" id="5507777">==</span>&nbsp;<span class="ident" id="5507780">t</span><span class="op" id="5507781">&gt;&gt;</span><span class="num" id="5507783">12</span>&nbsp;<span class="op" id="5507786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507792">code</span>&nbsp;<span class="op" id="5507797">=</span>&nbsp;<span class="ident" id="5507799">t</span>&nbsp;<span class="op" id="5507801">&amp;</span>&nbsp;<span class="ident" id="5507803">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507815">continue</span>&nbsp;<span class="ident" id="5507824">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507832">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507837">h</span>&nbsp;<span class="op" id="5507839">=</span>&nbsp;<span class="op" id="5507841">(</span><span class="ident" id="5507842">h</span>&nbsp;<span class="op" id="5507844">+</span>&nbsp;<span class="num" id="5507846">1</span><span class="op" id="5507847">)</span>&nbsp;<span class="op" id="5507849">&amp;</span>&nbsp;<span class="ident" id="5507851">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5507864">t</span>&nbsp;<span class="op" id="5507866">=</span>&nbsp;<span class="ident" id="5507868">e</span><span class="op" id="5507869">.</span><span class="ident" id="5507870">table</span><span class="op" id="5507875">[</span><span class="ident" id="5507876">h</span><span class="op" id="5507877">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5507881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5507885">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5507958">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5507986">if</span>&nbsp;<span class="ident" id="5507989">e</span><span class="op" id="5507990">.</span><span class="ident" id="5507991">err</span>&nbsp;<span class="op" id="5507995">=</span>&nbsp;<span class="ident" id="5507997">e</span><span class="op" id="5507998">.</span><span class="ident" id="5507999">write</span><span class="op" id="5508004">(</span><span class="ident" id="5508005">e</span><span class="op" id="5508006">,</span>&nbsp;<span class="ident" id="5508008">code</span><span class="op" id="5508012">)</span><span class="op" id="5508013">;</span>&nbsp;<span class="ident" id="5508015">e</span><span class="op" id="5508016">.</span><span class="ident" id="5508017">err</span>&nbsp;<span class="op" id="5508021">!=</span>&nbsp;<span class="ident" id="5508024">nil</span>&nbsp;<span class="op" id="5508028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508033">return</span>&nbsp;<span class="num" id="5508040">0</span><span class="op" id="5508041">,</span>&nbsp;<span class="ident" id="5508043">e</span><span class="op" id="5508044">.</span><span class="ident" id="5508045">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508055">code</span>&nbsp;<span class="op" id="5508060">=</span>&nbsp;<span class="ident" id="5508062">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508072">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508146">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508219">if</span>&nbsp;<span class="ident" id="5508222">err1</span>&nbsp;<span class="op" id="5508227">:=</span>&nbsp;<span class="ident" id="5508230">e</span><span class="op" id="5508231">.</span><span class="ident" id="5508232">incHi</span><span class="op" id="5508237">(</span><span class="op" id="5508238">)</span><span class="op" id="5508239">;</span>&nbsp;<span class="ident" id="5508241">err1</span>&nbsp;<span class="op" id="5508246">!=</span>&nbsp;<span class="ident" id="5508249">nil</span>&nbsp;<span class="op" id="5508253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508258">if</span>&nbsp;<span class="ident" id="5508261">err1</span>&nbsp;<span class="op" id="5508266">==</span>&nbsp;<span class="ident" id="5508269">errOutOfCodes</span>&nbsp;<span class="op" id="5508283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508289">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508301">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508306">e</span><span class="op" id="5508307">.</span><span class="ident" id="5508308">err</span>&nbsp;<span class="op" id="5508312">=</span>&nbsp;<span class="ident" id="5508314">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508322">return</span>&nbsp;<span class="num" id="5508329">0</span><span class="op" id="5508330">,</span>&nbsp;<span class="ident" id="5508332">e</span><span class="op" id="5508333">.</span><span class="ident" id="5508334">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508344">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508417">for</span>&nbsp;<span class="op" id="5508421">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508426">if</span>&nbsp;<span class="ident" id="5508429">e</span><span class="op" id="5508430">.</span><span class="ident" id="5508431">table</span><span class="op" id="5508436">[</span><span class="ident" id="5508437">hash</span><span class="op" id="5508441">]</span>&nbsp;<span class="op" id="5508443">==</span>&nbsp;<span class="ident" id="5508446">invalidEntry</span>&nbsp;<span class="op" id="5508459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508465">e</span><span class="op" id="5508466">.</span><span class="ident" id="5508467">table</span><span class="op" id="5508472">[</span><span class="ident" id="5508473">hash</span><span class="op" id="5508477">]</span>&nbsp;<span class="op" id="5508479">=</span>&nbsp;<span class="op" id="5508481">(</span><span class="ident" id="5508482">key</span>&nbsp;<span class="op" id="5508486">&lt;&lt;</span>&nbsp;<span class="num" id="5508489">12</span><span class="op" id="5508491">)</span>&nbsp;<span class="op" id="5508493">|</span>&nbsp;<span class="ident" id="5508495">e</span><span class="op" id="5508496">.</span><span class="ident" id="5508497">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508504">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508518">hash</span>&nbsp;<span class="op" id="5508523">=</span>&nbsp;<span class="op" id="5508525">(</span><span class="ident" id="5508526">hash</span>&nbsp;<span class="op" id="5508531">+</span>&nbsp;<span class="num" id="5508533">1</span><span class="op" id="5508534">)</span>&nbsp;<span class="op" id="5508536">&amp;</span>&nbsp;<span class="ident" id="5508538">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508556">e</span><span class="op" id="5508557">.</span><span class="ident" id="5508558">savedCode</span>&nbsp;<span class="op" id="5508568">=</span>&nbsp;<span class="ident" id="5508570">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508576">return</span>&nbsp;<span class="ident" id="5508583">n</span><span class="op" id="5508584">,</span>&nbsp;<span class="ident" id="5508586">nil</span><br>
<span class="lineno"></span><span class="op" id="5508590">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5508593">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5508672">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5508704">func</span>&nbsp;<span class="op" id="5508709">(</span><span class="ident" id="5508710">e</span>&nbsp;<span class="op" id="5508712">*</span><span class="ident" id="5508713">encoder</span><span class="op" id="5508720">)</span>&nbsp;<span class="ident" id="5508722">Close</span><span class="op" id="5508727">(</span><span class="op" id="5508728">)</span>&nbsp;<span class="builtintype" id="5508730">error</span>&nbsp;<span class="op" id="5508736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508739">if</span>&nbsp;<span class="ident" id="5508742">e</span><span class="op" id="5508743">.</span><span class="ident" id="5508744">err</span>&nbsp;<span class="op" id="5508748">!=</span>&nbsp;<span class="ident" id="5508751">nil</span>&nbsp;<span class="op" id="5508755">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508759">if</span>&nbsp;<span class="ident" id="5508762">e</span><span class="op" id="5508763">.</span><span class="ident" id="5508764">err</span>&nbsp;<span class="op" id="5508768">==</span>&nbsp;<span class="ident" id="5508771">errClosed</span>&nbsp;<span class="op" id="5508781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508786">return</span>&nbsp;<span class="ident" id="5508793">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508803">return</span>&nbsp;<span class="ident" id="5508810">e</span><span class="op" id="5508811">.</span><span class="ident" id="5508812">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5508817">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508820">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5508873">e</span><span class="op" id="5508874">.</span><span class="ident" id="5508875">err</span>&nbsp;<span class="op" id="5508879">=</span>&nbsp;<span class="ident" id="5508881">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5508892">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508926">if</span>&nbsp;<span class="ident" id="5508929">e</span><span class="op" id="5508930">.</span><span class="ident" id="5508931">savedCode</span>&nbsp;<span class="op" id="5508941">!=</span>&nbsp;<span class="ident" id="5508944">invalidCode</span>&nbsp;<span class="op" id="5508956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5508960">if</span>&nbsp;<span class="ident" id="5508963">err</span>&nbsp;<span class="op" id="5508967">:=</span>&nbsp;<span class="ident" id="5508970">e</span><span class="op" id="5508971">.</span><span class="ident" id="5508972">write</span><span class="op" id="5508977">(</span><span class="ident" id="5508978">e</span><span class="op" id="5508979">,</span>&nbsp;<span class="ident" id="5508981">e</span><span class="op" id="5508982">.</span><span class="ident" id="5508983">savedCode</span><span class="op" id="5508992">)</span><span class="op" id="5508993">;</span>&nbsp;<span class="ident" id="5508995">err</span>&nbsp;<span class="op" id="5508999">!=</span>&nbsp;<span class="ident" id="5509002">nil</span>&nbsp;<span class="op" id="5509006">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509011">return</span>&nbsp;<span class="ident" id="5509018">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509028">if</span>&nbsp;<span class="ident" id="5509031">err</span>&nbsp;<span class="op" id="5509035">:=</span>&nbsp;<span class="ident" id="5509038">e</span><span class="op" id="5509039">.</span><span class="ident" id="5509040">incHi</span><span class="op" id="5509045">(</span><span class="op" id="5509046">)</span><span class="op" id="5509047">;</span>&nbsp;<span class="ident" id="5509049">err</span>&nbsp;<span class="op" id="5509053">!=</span>&nbsp;<span class="ident" id="5509056">nil</span>&nbsp;<span class="op" id="5509060">&amp;&amp;</span>&nbsp;<span class="ident" id="5509063">err</span>&nbsp;<span class="op" id="5509067">!=</span>&nbsp;<span class="ident" id="5509070">errOutOfCodes</span>&nbsp;<span class="op" id="5509084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509089">return</span>&nbsp;<span class="ident" id="5509096">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509102">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5509108">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509132">eof</span>&nbsp;<span class="op" id="5509136">:=</span>&nbsp;<span class="builtintype" id="5509139">uint32</span><span class="op" id="5509145">(</span><span class="num" id="5509146">1</span><span class="op" id="5509147">)</span><span class="op" id="5509148">&lt;&lt;</span><span class="ident" id="5509150">e</span><span class="op" id="5509151">.</span><span class="ident" id="5509152">litWidth</span>&nbsp;<span class="op" id="5509161">+</span>&nbsp;<span class="num" id="5509163">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509166">if</span>&nbsp;<span class="ident" id="5509169">err</span>&nbsp;<span class="op" id="5509173">:=</span>&nbsp;<span class="ident" id="5509176">e</span><span class="op" id="5509177">.</span><span class="ident" id="5509178">write</span><span class="op" id="5509183">(</span><span class="ident" id="5509184">e</span><span class="op" id="5509185">,</span>&nbsp;<span class="ident" id="5509187">eof</span><span class="op" id="5509190">)</span><span class="op" id="5509191">;</span>&nbsp;<span class="ident" id="5509193">err</span>&nbsp;<span class="op" id="5509197">!=</span>&nbsp;<span class="ident" id="5509200">nil</span>&nbsp;<span class="op" id="5509204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509208">return</span>&nbsp;<span class="ident" id="5509215">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5509223">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509249">if</span>&nbsp;<span class="ident" id="5509252">e</span><span class="op" id="5509253">.</span><span class="ident" id="5509254">nBits</span>&nbsp;<span class="op" id="5509260">&gt;</span>&nbsp;<span class="num" id="5509262">0</span>&nbsp;<span class="op" id="5509264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509268">if</span>&nbsp;<span class="ident" id="5509271">e</span><span class="op" id="5509272">.</span><span class="ident" id="5509273">order</span>&nbsp;<span class="op" id="5509279">==</span>&nbsp;<span class="ident" id="5509282">MSB</span>&nbsp;<span class="op" id="5509286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509291">e</span><span class="op" id="5509292">.</span><span class="ident" id="5509293">bits</span>&nbsp;<span class="op" id="5509298">&gt;&gt;=</span>&nbsp;<span class="num" id="5509302">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509311">if</span>&nbsp;<span class="ident" id="5509314">err</span>&nbsp;<span class="op" id="5509318">:=</span>&nbsp;<span class="ident" id="5509321">e</span><span class="op" id="5509322">.</span><span class="ident" id="5509323">w</span><span class="op" id="5509324">.</span><span class="ident" id="5509325">WriteByte</span><span class="op" id="5509334">(</span><span class="builtintype" id="5509335">uint8</span><span class="op" id="5509340">(</span><span class="ident" id="5509341">e</span><span class="op" id="5509342">.</span><span class="ident" id="5509343">bits</span><span class="op" id="5509347">)</span><span class="op" id="5509348">)</span><span class="op" id="5509349">;</span>&nbsp;<span class="ident" id="5509351">err</span>&nbsp;<span class="op" id="5509355">!=</span>&nbsp;<span class="ident" id="5509358">nil</span>&nbsp;<span class="op" id="5509362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509367">return</span>&nbsp;<span class="ident" id="5509374">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5509383">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509386">return</span>&nbsp;<span class="ident" id="5509393">e</span><span class="op" id="5509394">.</span><span class="ident" id="5509395">w</span><span class="op" id="5509396">.</span><span class="ident" id="5509397">Flush</span><span class="op" id="5509402">(</span><span class="op" id="5509403">)</span><br>
<span class="lineno"></span><span class="op" id="5509405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5509408">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="5509451">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="5509525">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5509600">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="5509621">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5509694">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="5509729">func</span>&nbsp;<span class="ident" id="5509734">NewWriter</span><span class="op" id="5509743">(</span><span class="ident" id="5509744">w</span>&nbsp;<span class="ident" id="5509746">io</span><span class="op" id="5509748">.</span><span class="ident" id="5509749">Writer</span><span class="op" id="5509755">,</span>&nbsp;<span class="ident" id="5509757">order</span>&nbsp;<span class="ident" id="5509763">Order</span><span class="op" id="5509768">,</span>&nbsp;<span class="ident" id="5509770">litWidth</span>&nbsp;<span class="builtintype" id="5509779">int</span><span class="op" id="5509782">)</span>&nbsp;<span class="ident" id="5509784">io</span><span class="op" id="5509786">.</span><span class="ident" id="5509787">WriteCloser</span>&nbsp;<span class="op" id="5509799">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509802">var</span>&nbsp;<span class="ident" id="5509806">write</span>&nbsp;<span class="keyword" id="5509812">func</span><span class="op" id="5509816">(</span><span class="op" id="5509817">*</span><span class="ident" id="5509818">encoder</span><span class="op" id="5509825">,</span>&nbsp;<span class="builtintype" id="5509827">uint32</span><span class="op" id="5509833">)</span>&nbsp;<span class="builtintype" id="5509835">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509842">switch</span>&nbsp;<span class="ident" id="5509849">order</span>&nbsp;<span class="op" id="5509855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509858">case</span>&nbsp;<span class="ident" id="5509863">LSB</span><span class="op" id="5509866">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509870">write</span>&nbsp;<span class="op" id="5509876">=</span>&nbsp;<span class="op" id="5509878">(</span><span class="op" id="5509879">*</span><span class="ident" id="5509880">encoder</span><span class="op" id="5509887">)</span><span class="op" id="5509888">.</span><span class="ident" id="5509889">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509899">case</span>&nbsp;<span class="ident" id="5509904">MSB</span><span class="op" id="5509907">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5509911">write</span>&nbsp;<span class="op" id="5509917">=</span>&nbsp;<span class="op" id="5509919">(</span><span class="op" id="5509920">*</span><span class="ident" id="5509921">encoder</span><span class="op" id="5509928">)</span><span class="op" id="5509929">.</span><span class="ident" id="5509930">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509940">default</span><span class="op" id="5509947">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5509951">return</span>&nbsp;<span class="op" id="5509958">&amp;</span><span class="ident" id="5509959">errWriteCloser</span><span class="op" id="5509973">{</span><span class="ident" id="5509974">errors</span><span class="op" id="5509980">.</span><span class="ident" id="5509981">New</span><span class="op" id="5509984">(</span><span class="string" id="5509985">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="5510005">)</span><span class="op" id="5510006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510012">if</span>&nbsp;<span class="ident" id="5510015">litWidth</span>&nbsp;<span class="op" id="5510024">&lt;</span>&nbsp;<span class="num" id="5510026">2</span>&nbsp;<span class="op" id="5510028">||</span>&nbsp;<span class="num" id="5510031">8</span>&nbsp;<span class="op" id="5510033">&lt;</span>&nbsp;<span class="ident" id="5510035">litWidth</span>&nbsp;<span class="op" id="5510044">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510048">return</span>&nbsp;<span class="op" id="5510055">&amp;</span><span class="ident" id="5510056">errWriteCloser</span><span class="op" id="5510070">{</span><span class="ident" id="5510071">fmt</span><span class="op" id="5510074">.</span><span class="ident" id="5510075">Errorf</span><span class="op" id="5510081">(</span><span class="string" id="5510082">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5510113">,</span>&nbsp;<span class="ident" id="5510115">litWidth</span><span class="op" id="5510123">)</span><span class="op" id="5510124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510130">bw</span><span class="op" id="5510132">,</span>&nbsp;<span class="ident" id="5510134">ok</span>&nbsp;<span class="op" id="5510137">:=</span>&nbsp;<span class="ident" id="5510140">w</span><span class="op" id="5510141">.</span><span class="op" id="5510142">(</span><span class="ident" id="5510143">writer</span><span class="op" id="5510149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510152">if</span>&nbsp;<span class="op" id="5510155">!</span><span class="ident" id="5510156">ok</span>&nbsp;<span class="op" id="5510159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510163">bw</span>&nbsp;<span class="op" id="5510166">=</span>&nbsp;<span class="ident" id="5510168">bufio</span><span class="op" id="5510173">.</span><span class="ident" id="5510174">NewWriter</span><span class="op" id="5510183">(</span><span class="ident" id="5510184">w</span><span class="op" id="5510185">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510191">lw</span>&nbsp;<span class="op" id="5510194">:=</span>&nbsp;<span class="builtintype" id="5510197">uint</span><span class="op" id="5510201">(</span><span class="ident" id="5510202">litWidth</span><span class="op" id="5510210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5510213">return</span>&nbsp;<span class="op" id="5510220">&amp;</span><span class="ident" id="5510221">encoder</span><span class="op" id="5510228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510232">w</span><span class="op" id="5510233">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510243">bw</span><span class="op" id="5510245">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510249">order</span><span class="op" id="5510254">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510260">order</span><span class="op" id="5510265">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510269">write</span><span class="op" id="5510274">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510280">write</span><span class="op" id="5510285">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510289">width</span><span class="op" id="5510294">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5510300">1</span>&nbsp;<span class="op" id="5510302">+</span>&nbsp;<span class="ident" id="5510304">lw</span><span class="op" id="5510306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510310">litWidth</span><span class="op" id="5510318">:</span>&nbsp;&nbsp;<span class="ident" id="5510321">lw</span><span class="op" id="5510323">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510327">hi</span><span class="op" id="5510329">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="5510338">1</span><span class="op" id="5510339">&lt;&lt;</span><span class="ident" id="5510341">lw</span>&nbsp;<span class="op" id="5510344">+</span>&nbsp;<span class="num" id="5510346">1</span><span class="op" id="5510347">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510351">overflow</span><span class="op" id="5510359">:</span>&nbsp;&nbsp;<span class="num" id="5510362">1</span>&nbsp;<span class="op" id="5510364">&lt;&lt;</span>&nbsp;<span class="op" id="5510367">(</span><span class="ident" id="5510368">lw</span>&nbsp;<span class="op" id="5510371">+</span>&nbsp;<span class="num" id="5510373">1</span><span class="op" id="5510374">)</span><span class="op" id="5510375">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5510379">savedCode</span><span class="op" id="5510388">:</span>&nbsp;<span class="ident" id="5510390">invalidCode</span><span class="op" id="5510401">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5510404">}</span><br>
<span class="lineno"></span><span class="op" id="5510406">}</span>
</div>
</body>
</html>
