<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html" class="current">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2479992">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2480047">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2480101">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2480152">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2480217">//&nbsp;Fork,&nbsp;exec,&nbsp;wait,&nbsp;etc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2480244">package</span>&nbsp;<span class="ident" id="2480252">syscall</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2480261">import</span>&nbsp;<span class="op" id="2480268">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2480271">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2480282">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2480290">&#34;unsafe&#34;</span><br>
<span class="lineno">15</span><span class="op" id="2480299">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2480302">//&nbsp;Lock&nbsp;synchronizing&nbsp;creation&nbsp;of&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;with&nbsp;fork.</span><br>
<span class="lineno"></span><span class="comment" id="2480368">//</span><br>
<span class="lineno"></span><span class="comment" id="2480371">//&nbsp;We&nbsp;want&nbsp;the&nbsp;child&nbsp;in&nbsp;a&nbsp;fork/exec&nbsp;sequence&nbsp;to&nbsp;inherit&nbsp;only&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="2480436">//&nbsp;file&nbsp;descriptors&nbsp;we&nbsp;intend.&nbsp;&nbsp;To&nbsp;do&nbsp;that,&nbsp;we&nbsp;mark&nbsp;all&nbsp;file</span><br>
<span class="lineno"></span><span class="comment" id="2480497">//&nbsp;descriptors&nbsp;close-on-exec&nbsp;and&nbsp;then,&nbsp;in&nbsp;the&nbsp;child,&nbsp;explicitly</span><br>
<span class="lineno"></span><span class="comment" id="2480561">//&nbsp;unmark&nbsp;the&nbsp;ones&nbsp;we&nbsp;want&nbsp;the&nbsp;exec&#39;ed&nbsp;program&nbsp;to&nbsp;keep.</span><br>
<span class="lineno"></span><span class="comment" id="2480617">//&nbsp;Unix&nbsp;doesn&#39;t&nbsp;make&nbsp;this&nbsp;easy:&nbsp;there&nbsp;is,&nbsp;in&nbsp;general,&nbsp;no&nbsp;way&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2480681">//&nbsp;allocate&nbsp;a&nbsp;new&nbsp;file&nbsp;descriptor&nbsp;close-on-exec.&nbsp;&nbsp;Instead&nbsp;you</span><br>
<span class="lineno">25</span><span class="comment" id="2480743">//&nbsp;have&nbsp;to&nbsp;allocate&nbsp;the&nbsp;descriptor&nbsp;and&nbsp;then&nbsp;mark&nbsp;it&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="comment" id="2480810">//&nbsp;If&nbsp;a&nbsp;fork&nbsp;happens&nbsp;between&nbsp;those&nbsp;two&nbsp;events,&nbsp;the&nbsp;child&#39;s&nbsp;exec</span><br>
<span class="lineno"></span><span class="comment" id="2480874">//&nbsp;will&nbsp;inherit&nbsp;an&nbsp;unwanted&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="comment" id="2480919">//</span><br>
<span class="lineno"></span><span class="comment" id="2480922">//&nbsp;This&nbsp;lock&nbsp;solves&nbsp;that&nbsp;race:&nbsp;the&nbsp;create&nbsp;new&nbsp;fd/mark&nbsp;close-on-exec</span><br>
<span class="lineno">30</span><span class="comment" id="2480990">//&nbsp;operation&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;reading,&nbsp;and&nbsp;the&nbsp;fork&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2481061">//&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;writing.&nbsp;&nbsp;At&nbsp;least,&nbsp;that&#39;s&nbsp;the&nbsp;idea.</span><br>
<span class="lineno"></span><span class="comment" id="2481130">//&nbsp;There&nbsp;are&nbsp;some&nbsp;complications.</span><br>
<span class="lineno"></span><span class="comment" id="2481163">//</span><br>
<span class="lineno"></span><span class="comment" id="2481166">//&nbsp;Some&nbsp;system&nbsp;calls&nbsp;that&nbsp;create&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;can&nbsp;block</span><br>
<span class="lineno">35</span><span class="comment" id="2481230">//&nbsp;for&nbsp;arbitrarily&nbsp;long&nbsp;times:&nbsp;open&nbsp;on&nbsp;a&nbsp;hung&nbsp;NFS&nbsp;server&nbsp;or&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="2481296">//&nbsp;pipe,&nbsp;accept&nbsp;on&nbsp;a&nbsp;socket,&nbsp;and&nbsp;so&nbsp;on.&nbsp;&nbsp;We&nbsp;can&#39;t&nbsp;reasonably&nbsp;grab</span><br>
<span class="lineno"></span><span class="comment" id="2481362">//&nbsp;the&nbsp;lock&nbsp;across&nbsp;those&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2481399">//</span><br>
<span class="lineno"></span><span class="comment" id="2481402">//&nbsp;It&nbsp;is&nbsp;worse&nbsp;to&nbsp;inherit&nbsp;some&nbsp;file&nbsp;descriptors&nbsp;than&nbsp;others.</span><br>
<span class="lineno">40</span><span class="comment" id="2481463">//&nbsp;If&nbsp;a&nbsp;non-malicious&nbsp;child&nbsp;accidentally&nbsp;inherits&nbsp;an&nbsp;open&nbsp;ordinary&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="2481536">//&nbsp;that&#39;s&nbsp;not&nbsp;a&nbsp;big&nbsp;deal.&nbsp;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;if&nbsp;a&nbsp;long-lived&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="2481604">//&nbsp;accidentally&nbsp;inherits&nbsp;the&nbsp;write&nbsp;end&nbsp;of&nbsp;a&nbsp;pipe,&nbsp;then&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span><span class="comment" id="2481670">//&nbsp;of&nbsp;that&nbsp;pipe&nbsp;will&nbsp;not&nbsp;see&nbsp;EOF&nbsp;until&nbsp;that&nbsp;child&nbsp;exits,&nbsp;potentially</span><br>
<span class="lineno"></span><span class="comment" id="2481739">//&nbsp;causing&nbsp;the&nbsp;parent&nbsp;program&nbsp;to&nbsp;hang.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;common&nbsp;problem</span><br>
<span class="lineno">45</span><span class="comment" id="2481804">//&nbsp;in&nbsp;threaded&nbsp;C&nbsp;programs&nbsp;that&nbsp;use&nbsp;popen.</span><br>
<span class="lineno"></span><span class="comment" id="2481846">//</span><br>
<span class="lineno"></span><span class="comment" id="2481849">//&nbsp;Luckily,&nbsp;the&nbsp;file&nbsp;descriptors&nbsp;that&nbsp;are&nbsp;most&nbsp;important&nbsp;not&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2481913">//&nbsp;inherit&nbsp;are&nbsp;not&nbsp;the&nbsp;ones&nbsp;that&nbsp;can&nbsp;take&nbsp;an&nbsp;arbitrarily&nbsp;long&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="2481980">//&nbsp;to&nbsp;create:&nbsp;pipe&nbsp;returns&nbsp;instantly,&nbsp;and&nbsp;the&nbsp;net&nbsp;package&nbsp;uses</span><br>
<span class="lineno">50</span><span class="comment" id="2482043">//&nbsp;non-blocking&nbsp;I/O&nbsp;to&nbsp;accept&nbsp;on&nbsp;a&nbsp;listening&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="2482096">//&nbsp;The&nbsp;rules&nbsp;for&nbsp;which&nbsp;file&nbsp;descriptor-creating&nbsp;operations&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2482163">//&nbsp;ForkLock&nbsp;are&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="2482191">//</span><br>
<span class="lineno"></span><span class="comment" id="2482194">//&nbsp;1)&nbsp;Pipe.&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno">55</span><span class="comment" id="2482244">//&nbsp;2)&nbsp;Socket.&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2482294">//&nbsp;3)&nbsp;Accept.&nbsp;&nbsp;If&nbsp;using&nbsp;non-blocking&nbsp;mode,&nbsp;use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2482355">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno"></span><span class="comment" id="2482401">//&nbsp;4)&nbsp;Open.&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;block.&nbsp;&nbsp;Use&nbsp;O_CLOEXEC&nbsp;if&nbsp;available&nbsp;(Linux).</span><br>
<span class="lineno"></span><span class="comment" id="2482464">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno">60</span><span class="comment" id="2482510">//&nbsp;5)&nbsp;Dup.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2482560">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;Linux,&nbsp;could&nbsp;use&nbsp;fcntl&nbsp;F_DUPFD_CLOEXEC</span><br>
<span class="lineno"></span><span class="comment" id="2482617">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instead&nbsp;of&nbsp;the&nbsp;ForkLock,&nbsp;but&nbsp;only&nbsp;for&nbsp;dup(fd,&nbsp;-1).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2482684">var</span>&nbsp;<span class="ident" id="2482688">ForkLock</span>&nbsp;<span class="ident" id="2482697">sync</span><span class="op" id="2482701">.</span><span class="ident" id="2482702">RWMutex</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2482711">//&nbsp;StringSlicePtr&nbsp;is&nbsp;deprecated.&nbsp;Use&nbsp;SlicePtrFromStrings&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="2482777">//&nbsp;If&nbsp;any&nbsp;string&nbsp;contains&nbsp;a&nbsp;NUL&nbsp;byte&nbsp;this&nbsp;function&nbsp;panics&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="2482843">//&nbsp;of&nbsp;returning&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="2482869">func</span>&nbsp;<span class="ident" id="2482874">StringSlicePtr</span><span class="op" id="2482888">(</span><span class="ident" id="2482889">ss</span>&nbsp;<span class="op" id="2482892">[</span><span class="op" id="2482893">]</span><span class="builtintype" id="2482894">string</span><span class="op" id="2482900">)</span>&nbsp;<span class="op" id="2482902">[</span><span class="op" id="2482903">]</span><span class="op" id="2482904">*</span><span class="builtintype" id="2482905">byte</span>&nbsp;<span class="op" id="2482910">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2482913">bb</span>&nbsp;<span class="op" id="2482916">:=</span>&nbsp;<span class="builtinfunc" id="2482919">make</span><span class="op" id="2482923">(</span><span class="op" id="2482924">[</span><span class="op" id="2482925">]</span><span class="op" id="2482926">*</span><span class="builtintype" id="2482927">byte</span><span class="op" id="2482931">,</span>&nbsp;<span class="builtinfunc" id="2482933">len</span><span class="op" id="2482936">(</span><span class="ident" id="2482937">ss</span><span class="op" id="2482939">)</span><span class="op" id="2482940">+</span><span class="num" id="2482941">1</span><span class="op" id="2482942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2482945">for</span>&nbsp;<span class="ident" id="2482949">i</span>&nbsp;<span class="op" id="2482951">:=</span>&nbsp;<span class="num" id="2482954">0</span><span class="op" id="2482955">;</span>&nbsp;<span class="ident" id="2482957">i</span>&nbsp;<span class="op" id="2482959">&lt;</span>&nbsp;<span class="builtinfunc" id="2482961">len</span><span class="op" id="2482964">(</span><span class="ident" id="2482965">ss</span><span class="op" id="2482967">)</span><span class="op" id="2482968">;</span>&nbsp;<span class="ident" id="2482970">i</span><span class="op" id="2482971">++</span>&nbsp;<span class="op" id="2482974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2482978">bb</span><span class="op" id="2482980">[</span><span class="ident" id="2482981">i</span><span class="op" id="2482982">]</span>&nbsp;<span class="op" id="2482984">=</span>&nbsp;<span class="ident" id="2482986">StringBytePtr</span><span class="op" id="2482999">(</span><span class="ident" id="2483000">ss</span><span class="op" id="2483002">[</span><span class="ident" id="2483003">i</span><span class="op" id="2483004">]</span><span class="op" id="2483005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2483008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2483011">bb</span><span class="op" id="2483013">[</span><span class="builtinfunc" id="2483014">len</span><span class="op" id="2483017">(</span><span class="ident" id="2483018">ss</span><span class="op" id="2483020">)</span><span class="op" id="2483021">]</span>&nbsp;<span class="op" id="2483023">=</span>&nbsp;<span class="builtintype" id="2483025">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2483030">return</span>&nbsp;<span class="ident" id="2483037">bb</span><br>
<span class="lineno"></span><span class="op" id="2483040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2483043">//&nbsp;SlicePtrFromStrings&nbsp;converts&nbsp;a&nbsp;slice&nbsp;of&nbsp;strings&nbsp;to&nbsp;a&nbsp;slice&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2483108">//&nbsp;pointers&nbsp;to&nbsp;NUL-terminated&nbsp;byte&nbsp;slices.&nbsp;If&nbsp;any&nbsp;string&nbsp;contains</span><br>
<span class="lineno">80</span><span class="comment" id="2483174">//&nbsp;a&nbsp;NUL&nbsp;byte,&nbsp;it&nbsp;returns&nbsp;(nil,&nbsp;EINVAL).</span><br>
<span class="lineno"></span><span class="keyword" id="2483215">func</span>&nbsp;<span class="ident" id="2483220">SlicePtrFromStrings</span><span class="op" id="2483239">(</span><span class="ident" id="2483240">ss</span>&nbsp;<span class="op" id="2483243">[</span><span class="op" id="2483244">]</span><span class="builtintype" id="2483245">string</span><span class="op" id="2483251">)</span>&nbsp;<span class="op" id="2483253">(</span><span class="op" id="2483254">[</span><span class="op" id="2483255">]</span><span class="op" id="2483256">*</span><span class="builtintype" id="2483257">byte</span><span class="op" id="2483261">,</span>&nbsp;<span class="builtintype" id="2483263">error</span><span class="op" id="2483268">)</span>&nbsp;<span class="op" id="2483270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2483273">var</span>&nbsp;<span class="ident" id="2483277">err</span>&nbsp;<span class="builtintype" id="2483281">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2483288">bb</span>&nbsp;<span class="op" id="2483291">:=</span>&nbsp;<span class="builtinfunc" id="2483294">make</span><span class="op" id="2483298">(</span><span class="op" id="2483299">[</span><span class="op" id="2483300">]</span><span class="op" id="2483301">*</span><span class="builtintype" id="2483302">byte</span><span class="op" id="2483306">,</span>&nbsp;<span class="builtinfunc" id="2483308">len</span><span class="op" id="2483311">(</span><span class="ident" id="2483312">ss</span><span class="op" id="2483314">)</span><span class="op" id="2483315">+</span><span class="num" id="2483316">1</span><span class="op" id="2483317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2483320">for</span>&nbsp;<span class="ident" id="2483324">i</span>&nbsp;<span class="op" id="2483326">:=</span>&nbsp;<span class="num" id="2483329">0</span><span class="op" id="2483330">;</span>&nbsp;<span class="ident" id="2483332">i</span>&nbsp;<span class="op" id="2483334">&lt;</span>&nbsp;<span class="builtinfunc" id="2483336">len</span><span class="op" id="2483339">(</span><span class="ident" id="2483340">ss</span><span class="op" id="2483342">)</span><span class="op" id="2483343">;</span>&nbsp;<span class="ident" id="2483345">i</span><span class="op" id="2483346">++</span>&nbsp;<span class="op" id="2483349">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2483353">bb</span><span class="op" id="2483355">[</span><span class="ident" id="2483356">i</span><span class="op" id="2483357">]</span><span class="op" id="2483358">,</span>&nbsp;<span class="ident" id="2483360">err</span>&nbsp;<span class="op" id="2483364">=</span>&nbsp;<span class="ident" id="2483366">BytePtrFromString</span><span class="op" id="2483383">(</span><span class="ident" id="2483384">ss</span><span class="op" id="2483386">[</span><span class="ident" id="2483387">i</span><span class="op" id="2483388">]</span><span class="op" id="2483389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2483393">if</span>&nbsp;<span class="ident" id="2483396">err</span>&nbsp;<span class="op" id="2483400">!=</span>&nbsp;<span class="builtintype" id="2483403">nil</span>&nbsp;<span class="op" id="2483407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2483412">return</span>&nbsp;<span class="builtintype" id="2483419">nil</span><span class="op" id="2483422">,</span>&nbsp;<span class="ident" id="2483424">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2483430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2483433">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2483436">bb</span><span class="op" id="2483438">[</span><span class="builtinfunc" id="2483439">len</span><span class="op" id="2483442">(</span><span class="ident" id="2483443">ss</span><span class="op" id="2483445">)</span><span class="op" id="2483446">]</span>&nbsp;<span class="op" id="2483448">=</span>&nbsp;<span class="builtintype" id="2483450">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2483455">return</span>&nbsp;<span class="ident" id="2483462">bb</span><span class="op" id="2483464">,</span>&nbsp;<span class="builtintype" id="2483466">nil</span><br>
<span class="lineno"></span><span class="op" id="2483470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2483473">func</span>&nbsp;<span class="ident" id="2483478">CloseOnExec</span><span class="op" id="2483489">(</span><span class="ident" id="2483490">fd</span>&nbsp;<span class="builtintype" id="2483493">int</span><span class="op" id="2483496">)</span>&nbsp;<span class="op" id="2483498">{</span>&nbsp;<span class="ident" id="2483500">fcntl</span><span class="op" id="2483505">(</span><span class="ident" id="2483506">fd</span><span class="op" id="2483508">,</span>&nbsp;<span class="ident" id="2483510">F_SETFD</span><span class="op" id="2483517">,</span>&nbsp;<span class="ident" id="2483519">FD_CLOEXEC</span><span class="op" id="2483529">)</span>&nbsp;<span class="op" id="2483531">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="2483534">func</span>&nbsp;<span class="ident" id="2483539">SetNonblock</span><span class="op" id="2483550">(</span><span class="ident" id="2483551">fd</span>&nbsp;<span class="builtintype" id="2483554">int</span><span class="op" id="2483557">,</span>&nbsp;<span class="ident" id="2483559">nonblocking</span>&nbsp;<span class="builtintype" id="2483571">bool</span><span class="op" id="2483575">)</span>&nbsp;<span class="op" id="2483577">(</span><span class="ident" id="2483578">err</span>&nbsp;<span class="builtintype" id="2483582">error</span><span class="op" id="2483587">)</span>&nbsp;<span class="op" id="2483589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2483592">flag</span><span class="op" id="2483596">,</span>&nbsp;<span class="ident" id="2483598">err</span>&nbsp;<span class="op" id="2483602">:=</span>&nbsp;<span class="ident" id="2483605">fcntl</span><span class="op" id="2483610">(</span><span class="ident" id="2483611">fd</span><span class="op" id="2483613">,</span>&nbsp;<span class="ident" id="2483615">F_GETFL</span><span class="op" id="2483622">,</span>&nbsp;<span class="num" id="2483624">0</span><span class="op" id="2483625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2483628">if</span>&nbsp;<span class="ident" id="2483631">err</span>&nbsp;<span class="op" id="2483635">!=</span>&nbsp;<span class="builtintype" id="2483638">nil</span>&nbsp;<span class="op" id="2483642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2483646">return</span>&nbsp;<span class="ident" id="2483653">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2483658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2483661">if</span>&nbsp;<span class="ident" id="2483664">nonblocking</span>&nbsp;<span class="op" id="2483676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2483680">flag</span>&nbsp;<span class="op" id="2483685">|=</span>&nbsp;<span class="ident" id="2483688">O_NONBLOCK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2483700">}</span>&nbsp;<span class="keyword" id="2483702">else</span>&nbsp;<span class="op" id="2483707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2483711">flag</span>&nbsp;<span class="op" id="2483716">&amp;=</span>&nbsp;<span class="op" id="2483719">^</span><span class="ident" id="2483720">O_NONBLOCK</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2483732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2483735">_</span><span class="op" id="2483736">,</span>&nbsp;<span class="ident" id="2483738">err</span>&nbsp;<span class="op" id="2483742">=</span>&nbsp;<span class="ident" id="2483744">fcntl</span><span class="op" id="2483749">(</span><span class="ident" id="2483750">fd</span><span class="op" id="2483752">,</span>&nbsp;<span class="ident" id="2483754">F_SETFL</span><span class="op" id="2483761">,</span>&nbsp;<span class="ident" id="2483763">flag</span><span class="op" id="2483767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2483770">return</span>&nbsp;<span class="ident" id="2483777">err</span><br>
<span class="lineno"></span><span class="op" id="2483781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="2483784">//&nbsp;Credential&nbsp;holds&nbsp;user&nbsp;and&nbsp;group&nbsp;identities&nbsp;to&nbsp;be&nbsp;assumed</span><br>
<span class="lineno"></span><span class="comment" id="2483844">//&nbsp;by&nbsp;a&nbsp;child&nbsp;process&nbsp;started&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno"></span><span class="keyword" id="2483891">type</span>&nbsp;<span class="ident" id="2483896">Credential</span>&nbsp;<span class="keyword" id="2483907">struct</span>&nbsp;<span class="op" id="2483914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2483917">Uid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2483924">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2483933">//&nbsp;User&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2483946">Gid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2483953">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2483962">//&nbsp;Group&nbsp;ID.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2483976">Groups</span>&nbsp;<span class="op" id="2483983">[</span><span class="op" id="2483984">]</span><span class="builtintype" id="2483985">uint32</span>&nbsp;<span class="comment" id="2483992">//&nbsp;Supplementary&nbsp;group&nbsp;IDs.</span><br>
<span class="lineno"></span><span class="op" id="2484020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2484023">//&nbsp;ProcAttr&nbsp;holds&nbsp;attributes&nbsp;that&nbsp;will&nbsp;be&nbsp;applied&nbsp;to&nbsp;a&nbsp;new&nbsp;process&nbsp;started</span><br>
<span class="lineno"></span><span class="comment" id="2484098">//&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno">120</span><span class="keyword" id="2484118">type</span>&nbsp;<span class="ident" id="2484123">ProcAttr</span>&nbsp;<span class="keyword" id="2484132">struct</span>&nbsp;<span class="op" id="2484139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484142">Dir</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2484148">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2484158">//&nbsp;Current&nbsp;working&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484189">Env</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2484195">[</span><span class="op" id="2484196">]</span><span class="builtintype" id="2484197">string</span>&nbsp;&nbsp;<span class="comment" id="2484205">//&nbsp;Environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484222">Files</span>&nbsp;<span class="op" id="2484228">[</span><span class="op" id="2484229">]</span><span class="builtintype" id="2484230">uintptr</span>&nbsp;<span class="comment" id="2484238">//&nbsp;File&nbsp;descriptors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484260">Sys</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2484266">*</span><span class="ident" id="2484267">SysProcAttr</span><br>
<span class="lineno">125</span><span class="op" id="2484279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2484282">var</span>&nbsp;<span class="ident" id="2484286">zeroProcAttr</span>&nbsp;<span class="ident" id="2484299">ProcAttr</span><br>
<span class="lineno"></span><span class="keyword" id="2484308">var</span>&nbsp;<span class="ident" id="2484312">zeroSysProcAttr</span>&nbsp;<span class="ident" id="2484328">SysProcAttr</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2484341">func</span>&nbsp;<span class="ident" id="2484346">forkExec</span><span class="op" id="2484354">(</span><span class="ident" id="2484355">argv0</span>&nbsp;<span class="builtintype" id="2484361">string</span><span class="op" id="2484367">,</span>&nbsp;<span class="ident" id="2484369">argv</span>&nbsp;<span class="op" id="2484374">[</span><span class="op" id="2484375">]</span><span class="builtintype" id="2484376">string</span><span class="op" id="2484382">,</span>&nbsp;<span class="ident" id="2484384">attr</span>&nbsp;<span class="op" id="2484389">*</span><span class="ident" id="2484390">ProcAttr</span><span class="op" id="2484398">)</span>&nbsp;<span class="op" id="2484400">(</span><span class="ident" id="2484401">pid</span>&nbsp;<span class="builtintype" id="2484405">int</span><span class="op" id="2484408">,</span>&nbsp;<span class="ident" id="2484410">err</span>&nbsp;<span class="builtintype" id="2484414">error</span><span class="op" id="2484419">)</span>&nbsp;<span class="op" id="2484421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484424">var</span>&nbsp;<span class="ident" id="2484428">p</span>&nbsp;<span class="op" id="2484430">[</span><span class="num" id="2484431">2</span><span class="op" id="2484432">]</span><span class="builtintype" id="2484433">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484438">var</span>&nbsp;<span class="ident" id="2484442">n</span>&nbsp;<span class="builtintype" id="2484444">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484449">var</span>&nbsp;<span class="ident" id="2484453">err1</span>&nbsp;<span class="ident" id="2484458">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484465">var</span>&nbsp;<span class="ident" id="2484469">wstatus</span>&nbsp;<span class="ident" id="2484477">WaitStatus</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484490">if</span>&nbsp;<span class="ident" id="2484493">attr</span>&nbsp;<span class="op" id="2484498">==</span>&nbsp;<span class="builtintype" id="2484501">nil</span>&nbsp;<span class="op" id="2484505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484509">attr</span>&nbsp;<span class="op" id="2484514">=</span>&nbsp;<span class="op" id="2484516">&amp;</span><span class="ident" id="2484517">zeroProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2484531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484534">sys</span>&nbsp;<span class="op" id="2484538">:=</span>&nbsp;<span class="ident" id="2484541">attr</span><span class="op" id="2484545">.</span><span class="ident" id="2484546">Sys</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484551">if</span>&nbsp;<span class="ident" id="2484554">sys</span>&nbsp;<span class="op" id="2484558">==</span>&nbsp;<span class="builtintype" id="2484561">nil</span>&nbsp;<span class="op" id="2484565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484569">sys</span>&nbsp;<span class="op" id="2484573">=</span>&nbsp;<span class="op" id="2484575">&amp;</span><span class="ident" id="2484576">zeroSysProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2484593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484597">p</span><span class="op" id="2484598">[</span><span class="num" id="2484599">0</span><span class="op" id="2484600">]</span>&nbsp;<span class="op" id="2484602">=</span>&nbsp;<span class="op" id="2484604">-</span><span class="num" id="2484605">1</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484608">p</span><span class="op" id="2484609">[</span><span class="num" id="2484610">1</span><span class="op" id="2484611">]</span>&nbsp;<span class="op" id="2484613">=</span>&nbsp;<span class="op" id="2484615">-</span><span class="num" id="2484616">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2484620">//&nbsp;Convert&nbsp;args&nbsp;to&nbsp;C&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484648">argv0p</span><span class="op" id="2484654">,</span>&nbsp;<span class="ident" id="2484656">err</span>&nbsp;<span class="op" id="2484660">:=</span>&nbsp;<span class="ident" id="2484663">BytePtrFromString</span><span class="op" id="2484680">(</span><span class="ident" id="2484681">argv0</span><span class="op" id="2484686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484689">if</span>&nbsp;<span class="ident" id="2484692">err</span>&nbsp;<span class="op" id="2484696">!=</span>&nbsp;<span class="builtintype" id="2484699">nil</span>&nbsp;<span class="op" id="2484703">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484707">return</span>&nbsp;<span class="num" id="2484714">0</span><span class="op" id="2484715">,</span>&nbsp;<span class="ident" id="2484717">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2484722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484725">argvp</span><span class="op" id="2484730">,</span>&nbsp;<span class="ident" id="2484732">err</span>&nbsp;<span class="op" id="2484736">:=</span>&nbsp;<span class="ident" id="2484739">SlicePtrFromStrings</span><span class="op" id="2484758">(</span><span class="ident" id="2484759">argv</span><span class="op" id="2484763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484766">if</span>&nbsp;<span class="ident" id="2484769">err</span>&nbsp;<span class="op" id="2484773">!=</span>&nbsp;<span class="builtintype" id="2484776">nil</span>&nbsp;<span class="op" id="2484780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484784">return</span>&nbsp;<span class="num" id="2484791">0</span><span class="op" id="2484792">,</span>&nbsp;<span class="ident" id="2484794">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2484799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484802">envvp</span><span class="op" id="2484807">,</span>&nbsp;<span class="ident" id="2484809">err</span>&nbsp;<span class="op" id="2484813">:=</span>&nbsp;<span class="ident" id="2484816">SlicePtrFromStrings</span><span class="op" id="2484835">(</span><span class="ident" id="2484836">attr</span><span class="op" id="2484840">.</span><span class="ident" id="2484841">Env</span><span class="op" id="2484844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484847">if</span>&nbsp;<span class="ident" id="2484850">err</span>&nbsp;<span class="op" id="2484854">!=</span>&nbsp;<span class="builtintype" id="2484857">nil</span>&nbsp;<span class="op" id="2484861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484865">return</span>&nbsp;<span class="num" id="2484872">0</span><span class="op" id="2484873">,</span>&nbsp;<span class="ident" id="2484875">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2484880">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2484884">if</span>&nbsp;<span class="op" id="2484887">(</span><span class="ident" id="2484888">runtime</span><span class="op" id="2484895">.</span><span class="ident" id="2484896">GOOS</span>&nbsp;<span class="op" id="2484901">==</span>&nbsp;<span class="string" id="2484904">&#34;freebsd&#34;</span>&nbsp;<span class="op" id="2484914">||</span>&nbsp;<span class="ident" id="2484917">runtime</span><span class="op" id="2484924">.</span><span class="ident" id="2484925">GOOS</span>&nbsp;<span class="op" id="2484930">==</span>&nbsp;<span class="string" id="2484933">&#34;dragonfly&#34;</span><span class="op" id="2484944">)</span>&nbsp;<span class="op" id="2484946">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2484949">len</span><span class="op" id="2484952">(</span><span class="ident" id="2484953">argv</span><span class="op" id="2484957">[</span><span class="num" id="2484958">0</span><span class="op" id="2484959">]</span><span class="op" id="2484960">)</span>&nbsp;<span class="op" id="2484962">&gt;</span>&nbsp;<span class="builtinfunc" id="2484964">len</span><span class="op" id="2484967">(</span><span class="ident" id="2484968">argv0</span><span class="op" id="2484973">)</span>&nbsp;<span class="op" id="2484975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2484979">argvp</span><span class="op" id="2484984">[</span><span class="num" id="2484985">0</span><span class="op" id="2484986">]</span>&nbsp;<span class="op" id="2484988">=</span>&nbsp;<span class="ident" id="2484990">argv0p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2484998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485002">var</span>&nbsp;<span class="ident" id="2485006">chroot</span>&nbsp;<span class="op" id="2485013">*</span><span class="builtintype" id="2485014">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485020">if</span>&nbsp;<span class="ident" id="2485023">sys</span><span class="op" id="2485026">.</span><span class="ident" id="2485027">Chroot</span>&nbsp;<span class="op" id="2485034">!=</span>&nbsp;<span class="string" id="2485037">&#34;&#34;</span>&nbsp;<span class="op" id="2485040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2485044">chroot</span><span class="op" id="2485050">,</span>&nbsp;<span class="ident" id="2485052">err</span>&nbsp;<span class="op" id="2485056">=</span>&nbsp;<span class="ident" id="2485058">BytePtrFromString</span><span class="op" id="2485075">(</span><span class="ident" id="2485076">sys</span><span class="op" id="2485079">.</span><span class="ident" id="2485080">Chroot</span><span class="op" id="2485086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485090">if</span>&nbsp;<span class="ident" id="2485093">err</span>&nbsp;<span class="op" id="2485097">!=</span>&nbsp;<span class="builtintype" id="2485100">nil</span>&nbsp;<span class="op" id="2485104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485109">return</span>&nbsp;<span class="num" id="2485116">0</span><span class="op" id="2485117">,</span>&nbsp;<span class="ident" id="2485119">err</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2485125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2485128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485131">var</span>&nbsp;<span class="ident" id="2485135">dir</span>&nbsp;<span class="op" id="2485139">*</span><span class="builtintype" id="2485140">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485146">if</span>&nbsp;<span class="ident" id="2485149">attr</span><span class="op" id="2485153">.</span><span class="ident" id="2485154">Dir</span>&nbsp;<span class="op" id="2485158">!=</span>&nbsp;<span class="string" id="2485161">&#34;&#34;</span>&nbsp;<span class="op" id="2485164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2485168">dir</span><span class="op" id="2485171">,</span>&nbsp;<span class="ident" id="2485173">err</span>&nbsp;<span class="op" id="2485177">=</span>&nbsp;<span class="ident" id="2485179">BytePtrFromString</span><span class="op" id="2485196">(</span><span class="ident" id="2485197">attr</span><span class="op" id="2485201">.</span><span class="ident" id="2485202">Dir</span><span class="op" id="2485205">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485209">if</span>&nbsp;<span class="ident" id="2485212">err</span>&nbsp;<span class="op" id="2485216">!=</span>&nbsp;<span class="builtintype" id="2485219">nil</span>&nbsp;<span class="op" id="2485223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485228">return</span>&nbsp;<span class="num" id="2485235">0</span><span class="op" id="2485236">,</span>&nbsp;<span class="ident" id="2485238">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2485244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2485247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2485251">//&nbsp;Acquire&nbsp;the&nbsp;fork&nbsp;lock&nbsp;so&nbsp;that&nbsp;no&nbsp;other&nbsp;threads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2485302">//&nbsp;create&nbsp;new&nbsp;fds&nbsp;that&nbsp;are&nbsp;not&nbsp;yet&nbsp;close-on-exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2485352">//&nbsp;before&nbsp;we&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2485372">ForkLock</span><span class="op" id="2485380">.</span><span class="ident" id="2485381">Lock</span><span class="op" id="2485385">(</span><span class="op" id="2485386">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2485390">//&nbsp;Allocate&nbsp;child&nbsp;status&nbsp;pipe&nbsp;close&nbsp;on&nbsp;exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485436">if</span>&nbsp;<span class="ident" id="2485439">err</span>&nbsp;<span class="op" id="2485443">=</span>&nbsp;<span class="ident" id="2485445">forkExecPipe</span><span class="op" id="2485457">(</span><span class="ident" id="2485458">p</span><span class="op" id="2485459">[</span><span class="op" id="2485460">:</span><span class="op" id="2485461">]</span><span class="op" id="2485462">)</span><span class="op" id="2485463">;</span>&nbsp;<span class="ident" id="2485465">err</span>&nbsp;<span class="op" id="2485469">!=</span>&nbsp;<span class="builtintype" id="2485472">nil</span>&nbsp;<span class="op" id="2485476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485480">goto</span>&nbsp;<span class="builtintype" id="2485485">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2485492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2485496">//&nbsp;Kick&nbsp;off&nbsp;child.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2485516">pid</span><span class="op" id="2485519">,</span>&nbsp;<span class="ident" id="2485521">err1</span>&nbsp;<span class="op" id="2485526">=</span>&nbsp;<span class="ident" id="2485528">forkAndExecInChild</span><span class="op" id="2485546">(</span><span class="ident" id="2485547">argv0p</span><span class="op" id="2485553">,</span>&nbsp;<span class="ident" id="2485555">argvp</span><span class="op" id="2485560">,</span>&nbsp;<span class="ident" id="2485562">envvp</span><span class="op" id="2485567">,</span>&nbsp;<span class="ident" id="2485569">chroot</span><span class="op" id="2485575">,</span>&nbsp;<span class="ident" id="2485577">dir</span><span class="op" id="2485580">,</span>&nbsp;<span class="ident" id="2485582">attr</span><span class="op" id="2485586">,</span>&nbsp;<span class="ident" id="2485588">sys</span><span class="op" id="2485591">,</span>&nbsp;<span class="ident" id="2485593">p</span><span class="op" id="2485594">[</span><span class="num" id="2485595">1</span><span class="op" id="2485596">]</span><span class="op" id="2485597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485600">if</span>&nbsp;<span class="ident" id="2485603">err1</span>&nbsp;<span class="op" id="2485608">!=</span>&nbsp;<span class="num" id="2485611">0</span>&nbsp;<span class="op" id="2485613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2485617">err</span>&nbsp;<span class="op" id="2485621">=</span>&nbsp;<span class="ident" id="2485623">Errno</span><span class="op" id="2485628">(</span><span class="ident" id="2485629">err1</span><span class="op" id="2485633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485637">goto</span>&nbsp;<span class="builtintype" id="2485642">error</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2485649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2485652">ForkLock</span><span class="op" id="2485660">.</span><span class="ident" id="2485661">Unlock</span><span class="op" id="2485667">(</span><span class="op" id="2485668">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2485672">//&nbsp;Read&nbsp;child&nbsp;error&nbsp;status&nbsp;from&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2485711">Close</span><span class="op" id="2485716">(</span><span class="ident" id="2485717">p</span><span class="op" id="2485718">[</span><span class="num" id="2485719">1</span><span class="op" id="2485720">]</span><span class="op" id="2485721">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2485724">n</span><span class="op" id="2485725">,</span>&nbsp;<span class="ident" id="2485727">err</span>&nbsp;<span class="op" id="2485731">=</span>&nbsp;<span class="ident" id="2485733">readlen</span><span class="op" id="2485740">(</span><span class="ident" id="2485741">p</span><span class="op" id="2485742">[</span><span class="num" id="2485743">0</span><span class="op" id="2485744">]</span><span class="op" id="2485745">,</span>&nbsp;<span class="op" id="2485747">(</span><span class="op" id="2485748">*</span><span class="builtintype" id="2485749">byte</span><span class="op" id="2485753">)</span><span class="op" id="2485754">(</span><span class="ident" id="2485755">unsafe</span><span class="op" id="2485761">.</span><span class="ident" id="2485762">Pointer</span><span class="op" id="2485769">(</span><span class="op" id="2485770">&amp;</span><span class="ident" id="2485771">err1</span><span class="op" id="2485775">)</span><span class="op" id="2485776">)</span><span class="op" id="2485777">,</span>&nbsp;<span class="builtintype" id="2485779">int</span><span class="op" id="2485782">(</span><span class="ident" id="2485783">unsafe</span><span class="op" id="2485789">.</span><span class="ident" id="2485790">Sizeof</span><span class="op" id="2485796">(</span><span class="ident" id="2485797">err1</span><span class="op" id="2485801">)</span><span class="op" id="2485802">)</span><span class="op" id="2485803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2485806">Close</span><span class="op" id="2485811">(</span><span class="ident" id="2485812">p</span><span class="op" id="2485813">[</span><span class="num" id="2485814">0</span><span class="op" id="2485815">]</span><span class="op" id="2485816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485819">if</span>&nbsp;<span class="ident" id="2485822">err</span>&nbsp;<span class="op" id="2485826">!=</span>&nbsp;<span class="builtintype" id="2485829">nil</span>&nbsp;<span class="op" id="2485833">||</span>&nbsp;<span class="ident" id="2485836">n</span>&nbsp;<span class="op" id="2485838">!=</span>&nbsp;<span class="num" id="2485841">0</span>&nbsp;<span class="op" id="2485843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485847">if</span>&nbsp;<span class="ident" id="2485850">n</span>&nbsp;<span class="op" id="2485852">==</span>&nbsp;<span class="builtintype" id="2485855">int</span><span class="op" id="2485858">(</span><span class="ident" id="2485859">unsafe</span><span class="op" id="2485865">.</span><span class="ident" id="2485866">Sizeof</span><span class="op" id="2485872">(</span><span class="ident" id="2485873">err1</span><span class="op" id="2485877">)</span><span class="op" id="2485878">)</span>&nbsp;<span class="op" id="2485880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2485885">err</span>&nbsp;<span class="op" id="2485889">=</span>&nbsp;<span class="ident" id="2485891">Errno</span><span class="op" id="2485896">(</span><span class="ident" id="2485897">err1</span><span class="op" id="2485901">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2485905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2485909">if</span>&nbsp;<span class="ident" id="2485912">err</span>&nbsp;<span class="op" id="2485916">==</span>&nbsp;<span class="builtintype" id="2485919">nil</span>&nbsp;<span class="op" id="2485923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2485928">err</span>&nbsp;<span class="op" id="2485932">=</span>&nbsp;<span class="ident" id="2485934">EPIPE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2485942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2485947">//&nbsp;Child&nbsp;failed;&nbsp;wait&nbsp;for&nbsp;it&nbsp;to&nbsp;exit,&nbsp;to&nbsp;make&nbsp;sure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2486000">//&nbsp;the&nbsp;zombies&nbsp;don&#39;t&nbsp;accumulate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2486035">_</span><span class="op" id="2486036">,</span>&nbsp;<span class="ident" id="2486038">err1</span>&nbsp;<span class="op" id="2486043">:=</span>&nbsp;<span class="ident" id="2486046">Wait4</span><span class="op" id="2486051">(</span><span class="ident" id="2486052">pid</span><span class="op" id="2486055">,</span>&nbsp;<span class="op" id="2486057">&amp;</span><span class="ident" id="2486058">wstatus</span><span class="op" id="2486065">,</span>&nbsp;<span class="num" id="2486067">0</span><span class="op" id="2486068">,</span>&nbsp;<span class="builtintype" id="2486070">nil</span><span class="op" id="2486073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2486077">for</span>&nbsp;<span class="ident" id="2486081">err1</span>&nbsp;<span class="op" id="2486086">==</span>&nbsp;<span class="ident" id="2486089">EINTR</span>&nbsp;<span class="op" id="2486095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2486100">_</span><span class="op" id="2486101">,</span>&nbsp;<span class="ident" id="2486103">err1</span>&nbsp;<span class="op" id="2486108">=</span>&nbsp;<span class="ident" id="2486110">Wait4</span><span class="op" id="2486115">(</span><span class="ident" id="2486116">pid</span><span class="op" id="2486119">,</span>&nbsp;<span class="op" id="2486121">&amp;</span><span class="ident" id="2486122">wstatus</span><span class="op" id="2486129">,</span>&nbsp;<span class="num" id="2486131">0</span><span class="op" id="2486132">,</span>&nbsp;<span class="builtintype" id="2486134">nil</span><span class="op" id="2486137">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2486141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2486145">return</span>&nbsp;<span class="num" id="2486152">0</span><span class="op" id="2486153">,</span>&nbsp;<span class="ident" id="2486155">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2486160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2486164">//&nbsp;Read&nbsp;got&nbsp;EOF,&nbsp;so&nbsp;pipe&nbsp;closed&nbsp;on&nbsp;exec,&nbsp;so&nbsp;exec&nbsp;succeeded.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2486225">return</span>&nbsp;<span class="ident" id="2486232">pid</span><span class="op" id="2486235">,</span>&nbsp;<span class="builtintype" id="2486237">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="builtintype" id="2486242">error</span><span class="op" id="2486247">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2486250">if</span>&nbsp;<span class="ident" id="2486253">p</span><span class="op" id="2486254">[</span><span class="num" id="2486255">0</span><span class="op" id="2486256">]</span>&nbsp;<span class="op" id="2486258">&gt;=</span>&nbsp;<span class="num" id="2486261">0</span>&nbsp;<span class="op" id="2486263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2486267">Close</span><span class="op" id="2486272">(</span><span class="ident" id="2486273">p</span><span class="op" id="2486274">[</span><span class="num" id="2486275">0</span><span class="op" id="2486276">]</span><span class="op" id="2486277">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2486281">Close</span><span class="op" id="2486286">(</span><span class="ident" id="2486287">p</span><span class="op" id="2486288">[</span><span class="num" id="2486289">1</span><span class="op" id="2486290">]</span><span class="op" id="2486291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2486294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2486297">ForkLock</span><span class="op" id="2486305">.</span><span class="ident" id="2486306">Unlock</span><span class="op" id="2486312">(</span><span class="op" id="2486313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2486316">return</span>&nbsp;<span class="num" id="2486323">0</span><span class="op" id="2486324">,</span>&nbsp;<span class="ident" id="2486326">err</span><br>
<span class="lineno"></span><span class="op" id="2486330">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="2486333">//&nbsp;Combination&nbsp;of&nbsp;fork&nbsp;and&nbsp;exec,&nbsp;careful&nbsp;to&nbsp;be&nbsp;thread&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="2486393">func</span>&nbsp;<span class="ident" id="2486398">ForkExec</span><span class="op" id="2486406">(</span><span class="ident" id="2486407">argv0</span>&nbsp;<span class="builtintype" id="2486413">string</span><span class="op" id="2486419">,</span>&nbsp;<span class="ident" id="2486421">argv</span>&nbsp;<span class="op" id="2486426">[</span><span class="op" id="2486427">]</span><span class="builtintype" id="2486428">string</span><span class="op" id="2486434">,</span>&nbsp;<span class="ident" id="2486436">attr</span>&nbsp;<span class="op" id="2486441">*</span><span class="ident" id="2486442">ProcAttr</span><span class="op" id="2486450">)</span>&nbsp;<span class="op" id="2486452">(</span><span class="ident" id="2486453">pid</span>&nbsp;<span class="builtintype" id="2486457">int</span><span class="op" id="2486460">,</span>&nbsp;<span class="ident" id="2486462">err</span>&nbsp;<span class="builtintype" id="2486466">error</span><span class="op" id="2486471">)</span>&nbsp;<span class="op" id="2486473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2486476">return</span>&nbsp;<span class="ident" id="2486483">forkExec</span><span class="op" id="2486491">(</span><span class="ident" id="2486492">argv0</span><span class="op" id="2486497">,</span>&nbsp;<span class="ident" id="2486499">argv</span><span class="op" id="2486503">,</span>&nbsp;<span class="ident" id="2486505">attr</span><span class="op" id="2486509">)</span><br>
<span class="lineno"></span><span class="op" id="2486511">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="2486514">//&nbsp;StartProcess&nbsp;wraps&nbsp;ForkExec&nbsp;for&nbsp;package&nbsp;os.</span><br>
<span class="lineno"></span><span class="keyword" id="2486561">func</span>&nbsp;<span class="ident" id="2486566">StartProcess</span><span class="op" id="2486578">(</span><span class="ident" id="2486579">argv0</span>&nbsp;<span class="builtintype" id="2486585">string</span><span class="op" id="2486591">,</span>&nbsp;<span class="ident" id="2486593">argv</span>&nbsp;<span class="op" id="2486598">[</span><span class="op" id="2486599">]</span><span class="builtintype" id="2486600">string</span><span class="op" id="2486606">,</span>&nbsp;<span class="ident" id="2486608">attr</span>&nbsp;<span class="op" id="2486613">*</span><span class="ident" id="2486614">ProcAttr</span><span class="op" id="2486622">)</span>&nbsp;<span class="op" id="2486624">(</span><span class="ident" id="2486625">pid</span>&nbsp;<span class="builtintype" id="2486629">int</span><span class="op" id="2486632">,</span>&nbsp;<span class="ident" id="2486634">handle</span>&nbsp;<span class="builtintype" id="2486641">uintptr</span><span class="op" id="2486648">,</span>&nbsp;<span class="ident" id="2486650">err</span>&nbsp;<span class="builtintype" id="2486654">error</span><span class="op" id="2486659">)</span>&nbsp;<span class="op" id="2486661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2486664">pid</span><span class="op" id="2486667">,</span>&nbsp;<span class="ident" id="2486669">err</span>&nbsp;<span class="op" id="2486673">=</span>&nbsp;<span class="ident" id="2486675">forkExec</span><span class="op" id="2486683">(</span><span class="ident" id="2486684">argv0</span><span class="op" id="2486689">,</span>&nbsp;<span class="ident" id="2486691">argv</span><span class="op" id="2486695">,</span>&nbsp;<span class="ident" id="2486697">attr</span><span class="op" id="2486701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2486704">return</span>&nbsp;<span class="ident" id="2486711">pid</span><span class="op" id="2486714">,</span>&nbsp;<span class="num" id="2486716">0</span><span class="op" id="2486717">,</span>&nbsp;<span class="ident" id="2486719">err</span><br>
<span class="lineno">240</span><span class="op" id="2486723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2486726">//&nbsp;Ordinary&nbsp;exec.</span><br>
<span class="lineno"></span><span class="keyword" id="2486744">func</span>&nbsp;<span class="ident" id="2486749">Exec</span><span class="op" id="2486753">(</span><span class="ident" id="2486754">argv0</span>&nbsp;<span class="builtintype" id="2486760">string</span><span class="op" id="2486766">,</span>&nbsp;<span class="ident" id="2486768">argv</span>&nbsp;<span class="op" id="2486773">[</span><span class="op" id="2486774">]</span><span class="builtintype" id="2486775">string</span><span class="op" id="2486781">,</span>&nbsp;<span class="ident" id="2486783">envv</span>&nbsp;<span class="op" id="2486788">[</span><span class="op" id="2486789">]</span><span class="builtintype" id="2486790">string</span><span class="op" id="2486796">)</span>&nbsp;<span class="op" id="2486798">(</span><span class="ident" id="2486799">err</span>&nbsp;<span class="builtintype" id="2486803">error</span><span class="op" id="2486808">)</span>&nbsp;<span class="op" id="2486810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2486813">argv0p</span><span class="op" id="2486819">,</span>&nbsp;<span class="ident" id="2486821">err</span>&nbsp;<span class="op" id="2486825">:=</span>&nbsp;<span class="ident" id="2486828">BytePtrFromString</span><span class="op" id="2486845">(</span><span class="ident" id="2486846">argv0</span><span class="op" id="2486851">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2486854">if</span>&nbsp;<span class="ident" id="2486857">err</span>&nbsp;<span class="op" id="2486861">!=</span>&nbsp;<span class="builtintype" id="2486864">nil</span>&nbsp;<span class="op" id="2486868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2486872">return</span>&nbsp;<span class="ident" id="2486879">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2486884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2486887">argvp</span><span class="op" id="2486892">,</span>&nbsp;<span class="ident" id="2486894">err</span>&nbsp;<span class="op" id="2486898">:=</span>&nbsp;<span class="ident" id="2486901">SlicePtrFromStrings</span><span class="op" id="2486920">(</span><span class="ident" id="2486921">argv</span><span class="op" id="2486925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2486928">if</span>&nbsp;<span class="ident" id="2486931">err</span>&nbsp;<span class="op" id="2486935">!=</span>&nbsp;<span class="builtintype" id="2486938">nil</span>&nbsp;<span class="op" id="2486942">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2486946">return</span>&nbsp;<span class="ident" id="2486953">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2486958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2486961">envvp</span><span class="op" id="2486966">,</span>&nbsp;<span class="ident" id="2486968">err</span>&nbsp;<span class="op" id="2486972">:=</span>&nbsp;<span class="ident" id="2486975">SlicePtrFromStrings</span><span class="op" id="2486994">(</span><span class="ident" id="2486995">envv</span><span class="op" id="2486999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2487002">if</span>&nbsp;<span class="ident" id="2487005">err</span>&nbsp;<span class="op" id="2487009">!=</span>&nbsp;<span class="builtintype" id="2487012">nil</span>&nbsp;<span class="op" id="2487016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2487020">return</span>&nbsp;<span class="ident" id="2487027">err</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2487032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2487035">_</span><span class="op" id="2487036">,</span>&nbsp;<span class="ident" id="2487038">_</span><span class="op" id="2487039">,</span>&nbsp;<span class="ident" id="2487041">err1</span>&nbsp;<span class="op" id="2487046">:=</span>&nbsp;<span class="ident" id="2487049">RawSyscall</span><span class="op" id="2487059">(</span><span class="ident" id="2487060">SYS_EXECVE</span><span class="op" id="2487070">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2487074">uintptr</span><span class="op" id="2487081">(</span><span class="ident" id="2487082">unsafe</span><span class="op" id="2487088">.</span><span class="ident" id="2487089">Pointer</span><span class="op" id="2487096">(</span><span class="ident" id="2487097">argv0p</span><span class="op" id="2487103">)</span><span class="op" id="2487104">)</span><span class="op" id="2487105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2487109">uintptr</span><span class="op" id="2487116">(</span><span class="ident" id="2487117">unsafe</span><span class="op" id="2487123">.</span><span class="ident" id="2487124">Pointer</span><span class="op" id="2487131">(</span><span class="op" id="2487132">&amp;</span><span class="ident" id="2487133">argvp</span><span class="op" id="2487138">[</span><span class="num" id="2487139">0</span><span class="op" id="2487140">]</span><span class="op" id="2487141">)</span><span class="op" id="2487142">)</span><span class="op" id="2487143">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2487147">uintptr</span><span class="op" id="2487154">(</span><span class="ident" id="2487155">unsafe</span><span class="op" id="2487161">.</span><span class="ident" id="2487162">Pointer</span><span class="op" id="2487169">(</span><span class="op" id="2487170">&amp;</span><span class="ident" id="2487171">envvp</span><span class="op" id="2487176">[</span><span class="num" id="2487177">0</span><span class="op" id="2487178">]</span><span class="op" id="2487179">)</span><span class="op" id="2487180">)</span><span class="op" id="2487181">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2487184">return</span>&nbsp;<span class="ident" id="2487191">Errno</span><span class="op" id="2487196">(</span><span class="ident" id="2487197">err1</span><span class="op" id="2487201">)</span><br>
<span class="lineno"></span><span class="op" id="2487203">}</span>
</div>
</body>
</html>
