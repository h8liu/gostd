<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3325150">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3325205">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3325259">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3325310">package</span>&nbsp;<span class="ident" id="3325318">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3325323">import</span>&nbsp;<span class="string" id="3325330">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3325345">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="3325399">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="3325455">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="3325494">type</span>&nbsp;<span class="ident" id="3325499">fdMutex</span>&nbsp;<span class="keyword" id="3325507">struct</span>&nbsp;<span class="op" id="3325514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3325517">state</span>&nbsp;<span class="ident" id="3325523">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3325531">rsema</span>&nbsp;<span class="builtintype" id="3325537">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3325545">wsema</span>&nbsp;<span class="builtintype" id="3325551">uint32</span><br>
<span class="lineno"></span><span class="op" id="3325558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3325561">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="3325603">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="3325688">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3325725">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3325763">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="3325822">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="3325871">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="3325921">const</span>&nbsp;<span class="op" id="3325927">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3325930">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="3325943">=</span>&nbsp;<span class="num" id="3325945">1</span>&nbsp;<span class="op" id="3325947">&lt;&lt;</span>&nbsp;<span class="num" id="3325950">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3325953">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3325966">=</span>&nbsp;<span class="num" id="3325968">1</span>&nbsp;<span class="op" id="3325970">&lt;&lt;</span>&nbsp;<span class="num" id="3325973">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3325976">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3325989">=</span>&nbsp;<span class="num" id="3325991">1</span>&nbsp;<span class="op" id="3325993">&lt;&lt;</span>&nbsp;<span class="num" id="3325996">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3325999">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3326012">=</span>&nbsp;<span class="num" id="3326014">1</span>&nbsp;<span class="op" id="3326016">&lt;&lt;</span>&nbsp;<span class="num" id="3326019">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3326022">mutexRefMask</span>&nbsp;<span class="op" id="3326035">=</span>&nbsp;<span class="op" id="3326037">(</span><span class="num" id="3326038">1</span><span class="op" id="3326039">&lt;&lt;</span><span class="num" id="3326041">20</span>&nbsp;<span class="op" id="3326044">-</span>&nbsp;<span class="num" id="3326046">1</span><span class="op" id="3326047">)</span>&nbsp;<span class="op" id="3326049">&lt;&lt;</span>&nbsp;<span class="num" id="3326052">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3326055">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3326068">=</span>&nbsp;<span class="num" id="3326070">1</span>&nbsp;<span class="op" id="3326072">&lt;&lt;</span>&nbsp;<span class="num" id="3326075">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3326079">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3326092">=</span>&nbsp;<span class="op" id="3326094">(</span><span class="num" id="3326095">1</span><span class="op" id="3326096">&lt;&lt;</span><span class="num" id="3326098">20</span>&nbsp;<span class="op" id="3326101">-</span>&nbsp;<span class="num" id="3326103">1</span><span class="op" id="3326104">)</span>&nbsp;<span class="op" id="3326106">&lt;&lt;</span>&nbsp;<span class="num" id="3326109">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3326113">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3326126">=</span>&nbsp;<span class="num" id="3326128">1</span>&nbsp;<span class="op" id="3326130">&lt;&lt;</span>&nbsp;<span class="num" id="3326133">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3326137">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3326150">=</span>&nbsp;<span class="op" id="3326152">(</span><span class="num" id="3326153">1</span><span class="op" id="3326154">&lt;&lt;</span><span class="num" id="3326156">20</span>&nbsp;<span class="op" id="3326159">-</span>&nbsp;<span class="num" id="3326161">1</span><span class="op" id="3326162">)</span>&nbsp;<span class="op" id="3326164">&lt;&lt;</span>&nbsp;<span class="num" id="3326167">43</span><br>
<span class="lineno">35</span><span class="op" id="3326170">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3326173">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="3326229">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="3326288">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="3326369">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3326446">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="3326519">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="3326569">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3326620">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="3326664">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3326751">func</span>&nbsp;<span class="op" id="3326756">(</span><span class="ident" id="3326757">mu</span>&nbsp;<span class="op" id="3326760">*</span><span class="ident" id="3326761">fdMutex</span><span class="op" id="3326768">)</span>&nbsp;<span class="ident" id="3326770">Incref</span><span class="op" id="3326776">(</span><span class="op" id="3326777">)</span>&nbsp;<span class="builtintype" id="3326779">bool</span>&nbsp;<span class="op" id="3326784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3326787">for</span>&nbsp;<span class="op" id="3326791">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3326795">old</span>&nbsp;<span class="op" id="3326799">:=</span>&nbsp;<span class="ident" id="3326802">atomic</span><span class="op" id="3326808">.</span><span class="ident" id="3326809">LoadUint64</span><span class="op" id="3326819">(</span><span class="op" id="3326820">&amp;</span><span class="ident" id="3326821">mu</span><span class="op" id="3326823">.</span><span class="ident" id="3326824">state</span><span class="op" id="3326829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3326833">if</span>&nbsp;<span class="ident" id="3326836">old</span><span class="op" id="3326839">&amp;</span><span class="ident" id="3326840">mutexClosed</span>&nbsp;<span class="op" id="3326852">!=</span>&nbsp;<span class="num" id="3326855">0</span>&nbsp;<span class="op" id="3326857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3326862">return</span>&nbsp;<span class="ident" id="3326869">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3326877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3326881">new</span>&nbsp;<span class="op" id="3326885">:=</span>&nbsp;<span class="ident" id="3326888">old</span>&nbsp;<span class="op" id="3326892">+</span>&nbsp;<span class="ident" id="3326894">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3326905">if</span>&nbsp;<span class="builtinfunc" id="3326908">new</span><span class="op" id="3326911">&amp;</span><span class="ident" id="3326912">mutexRefMask</span>&nbsp;<span class="op" id="3326925">==</span>&nbsp;<span class="num" id="3326928">0</span>&nbsp;<span class="op" id="3326930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3326935">panic</span><span class="op" id="3326940">(</span><span class="string" id="3326941">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3326968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3326972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3326976">if</span>&nbsp;<span class="ident" id="3326979">atomic</span><span class="op" id="3326985">.</span><span class="ident" id="3326986">CompareAndSwapUint64</span><span class="op" id="3327006">(</span><span class="op" id="3327007">&amp;</span><span class="ident" id="3327008">mu</span><span class="op" id="3327010">.</span><span class="ident" id="3327011">state</span><span class="op" id="3327016">,</span>&nbsp;<span class="ident" id="3327018">old</span><span class="op" id="3327021">,</span>&nbsp;<span class="builtinfunc" id="3327023">new</span><span class="op" id="3327026">)</span>&nbsp;<span class="op" id="3327028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327033">return</span>&nbsp;<span class="ident" id="3327040">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3327047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3327050">}</span><br>
<span class="lineno"></span><span class="op" id="3327052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3327055">func</span>&nbsp;<span class="op" id="3327060">(</span><span class="ident" id="3327061">mu</span>&nbsp;<span class="op" id="3327064">*</span><span class="ident" id="3327065">fdMutex</span><span class="op" id="3327072">)</span>&nbsp;<span class="ident" id="3327074">IncrefAndClose</span><span class="op" id="3327088">(</span><span class="op" id="3327089">)</span>&nbsp;<span class="builtintype" id="3327091">bool</span>&nbsp;<span class="op" id="3327096">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327099">for</span>&nbsp;<span class="op" id="3327103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3327107">old</span>&nbsp;<span class="op" id="3327111">:=</span>&nbsp;<span class="ident" id="3327114">atomic</span><span class="op" id="3327120">.</span><span class="ident" id="3327121">LoadUint64</span><span class="op" id="3327131">(</span><span class="op" id="3327132">&amp;</span><span class="ident" id="3327133">mu</span><span class="op" id="3327135">.</span><span class="ident" id="3327136">state</span><span class="op" id="3327141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327145">if</span>&nbsp;<span class="ident" id="3327148">old</span><span class="op" id="3327151">&amp;</span><span class="ident" id="3327152">mutexClosed</span>&nbsp;<span class="op" id="3327164">!=</span>&nbsp;<span class="num" id="3327167">0</span>&nbsp;<span class="op" id="3327169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327174">return</span>&nbsp;<span class="ident" id="3327181">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3327189">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3327193">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3327238">new</span>&nbsp;<span class="op" id="3327242">:=</span>&nbsp;<span class="op" id="3327245">(</span><span class="ident" id="3327246">old</span>&nbsp;<span class="op" id="3327250">|</span>&nbsp;<span class="ident" id="3327252">mutexClosed</span><span class="op" id="3327263">)</span>&nbsp;<span class="op" id="3327265">+</span>&nbsp;<span class="ident" id="3327267">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327278">if</span>&nbsp;<span class="builtinfunc" id="3327281">new</span><span class="op" id="3327284">&amp;</span><span class="ident" id="3327285">mutexRefMask</span>&nbsp;<span class="op" id="3327298">==</span>&nbsp;<span class="num" id="3327301">0</span>&nbsp;<span class="op" id="3327303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3327308">panic</span><span class="op" id="3327313">(</span><span class="string" id="3327314">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3327341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3327345">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3327349">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3327389">new</span>&nbsp;<span class="op" id="3327393">&amp;^=</span>&nbsp;<span class="ident" id="3327397">mutexRMask</span>&nbsp;<span class="op" id="3327408">|</span>&nbsp;<span class="ident" id="3327410">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327423">if</span>&nbsp;<span class="ident" id="3327426">atomic</span><span class="op" id="3327432">.</span><span class="ident" id="3327433">CompareAndSwapUint64</span><span class="op" id="3327453">(</span><span class="op" id="3327454">&amp;</span><span class="ident" id="3327455">mu</span><span class="op" id="3327457">.</span><span class="ident" id="3327458">state</span><span class="op" id="3327463">,</span>&nbsp;<span class="ident" id="3327465">old</span><span class="op" id="3327468">,</span>&nbsp;<span class="builtinfunc" id="3327470">new</span><span class="op" id="3327473">)</span>&nbsp;<span class="op" id="3327475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3327480">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3327519">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327569">for</span>&nbsp;<span class="ident" id="3327573">old</span><span class="op" id="3327576">&amp;</span><span class="ident" id="3327577">mutexRMask</span>&nbsp;<span class="op" id="3327588">!=</span>&nbsp;<span class="num" id="3327591">0</span>&nbsp;<span class="op" id="3327593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3327599">old</span>&nbsp;<span class="op" id="3327603">-=</span>&nbsp;<span class="ident" id="3327606">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3327621">runtime_Semrelease</span><span class="op" id="3327639">(</span><span class="op" id="3327640">&amp;</span><span class="ident" id="3327641">mu</span><span class="op" id="3327643">.</span><span class="ident" id="3327644">rsema</span><span class="op" id="3327649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3327654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327659">for</span>&nbsp;<span class="ident" id="3327663">old</span><span class="op" id="3327666">&amp;</span><span class="ident" id="3327667">mutexWMask</span>&nbsp;<span class="op" id="3327678">!=</span>&nbsp;<span class="num" id="3327681">0</span>&nbsp;<span class="op" id="3327683">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3327689">old</span>&nbsp;<span class="op" id="3327693">-=</span>&nbsp;<span class="ident" id="3327696">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3327711">runtime_Semrelease</span><span class="op" id="3327729">(</span><span class="op" id="3327730">&amp;</span><span class="ident" id="3327731">mu</span><span class="op" id="3327733">.</span><span class="ident" id="3327734">wsema</span><span class="op" id="3327739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3327744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327749">return</span>&nbsp;<span class="ident" id="3327756">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3327763">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3327766">}</span><br>
<span class="lineno"></span><span class="op" id="3327768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3327771">func</span>&nbsp;<span class="op" id="3327776">(</span><span class="ident" id="3327777">mu</span>&nbsp;<span class="op" id="3327780">*</span><span class="ident" id="3327781">fdMutex</span><span class="op" id="3327788">)</span>&nbsp;<span class="ident" id="3327790">Decref</span><span class="op" id="3327796">(</span><span class="op" id="3327797">)</span>&nbsp;<span class="builtintype" id="3327799">bool</span>&nbsp;<span class="op" id="3327804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327807">for</span>&nbsp;<span class="op" id="3327811">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3327815">old</span>&nbsp;<span class="op" id="3327819">:=</span>&nbsp;<span class="ident" id="3327822">atomic</span><span class="op" id="3327828">.</span><span class="ident" id="3327829">LoadUint64</span><span class="op" id="3327839">(</span><span class="op" id="3327840">&amp;</span><span class="ident" id="3327841">mu</span><span class="op" id="3327843">.</span><span class="ident" id="3327844">state</span><span class="op" id="3327849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327853">if</span>&nbsp;<span class="ident" id="3327856">old</span><span class="op" id="3327859">&amp;</span><span class="ident" id="3327860">mutexRefMask</span>&nbsp;<span class="op" id="3327873">==</span>&nbsp;<span class="num" id="3327876">0</span>&nbsp;<span class="op" id="3327878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3327883">panic</span><span class="op" id="3327888">(</span><span class="string" id="3327889">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3327916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3327920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3327924">new</span>&nbsp;<span class="op" id="3327928">:=</span>&nbsp;<span class="ident" id="3327931">old</span>&nbsp;<span class="op" id="3327935">-</span>&nbsp;<span class="ident" id="3327937">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327948">if</span>&nbsp;<span class="ident" id="3327951">atomic</span><span class="op" id="3327957">.</span><span class="ident" id="3327958">CompareAndSwapUint64</span><span class="op" id="3327978">(</span><span class="op" id="3327979">&amp;</span><span class="ident" id="3327980">mu</span><span class="op" id="3327982">.</span><span class="ident" id="3327983">state</span><span class="op" id="3327988">,</span>&nbsp;<span class="ident" id="3327990">old</span><span class="op" id="3327993">,</span>&nbsp;<span class="builtinfunc" id="3327995">new</span><span class="op" id="3327998">)</span>&nbsp;<span class="op" id="3328000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328005">return</span>&nbsp;<span class="builtinfunc" id="3328012">new</span><span class="op" id="3328015">&amp;</span><span class="op" id="3328016">(</span><span class="ident" id="3328017">mutexClosed</span><span class="op" id="3328028">|</span><span class="ident" id="3328029">mutexRefMask</span><span class="op" id="3328041">)</span>&nbsp;<span class="op" id="3328043">==</span>&nbsp;<span class="ident" id="3328046">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328063">}</span><br>
<span class="lineno"></span><span class="op" id="3328065">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3328068">func</span>&nbsp;<span class="op" id="3328073">(</span><span class="ident" id="3328074">mu</span>&nbsp;<span class="op" id="3328077">*</span><span class="ident" id="3328078">fdMutex</span><span class="op" id="3328085">)</span>&nbsp;<span class="ident" id="3328087">RWLock</span><span class="op" id="3328093">(</span><span class="ident" id="3328094">read</span>&nbsp;<span class="builtintype" id="3328099">bool</span><span class="op" id="3328103">)</span>&nbsp;<span class="builtintype" id="3328105">bool</span>&nbsp;<span class="op" id="3328110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328113">var</span>&nbsp;<span class="ident" id="3328117">mutexBit</span><span class="op" id="3328125">,</span>&nbsp;<span class="ident" id="3328127">mutexWait</span><span class="op" id="3328136">,</span>&nbsp;<span class="ident" id="3328138">mutexMask</span>&nbsp;<span class="ident" id="3328148">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328156">var</span>&nbsp;<span class="ident" id="3328160">mutexSema</span>&nbsp;<span class="op" id="3328170">*</span><span class="builtintype" id="3328171">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328179">if</span>&nbsp;<span class="ident" id="3328182">read</span>&nbsp;<span class="op" id="3328187">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3328191">mutexBit</span>&nbsp;<span class="op" id="3328200">=</span>&nbsp;<span class="ident" id="3328202">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3328215">mutexWait</span>&nbsp;<span class="op" id="3328225">=</span>&nbsp;<span class="ident" id="3328227">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3328240">mutexMask</span>&nbsp;<span class="op" id="3328250">=</span>&nbsp;<span class="ident" id="3328252">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3328265">mutexSema</span>&nbsp;<span class="op" id="3328275">=</span>&nbsp;<span class="op" id="3328277">&amp;</span><span class="ident" id="3328278">mu</span><span class="op" id="3328280">.</span><span class="ident" id="3328281">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328288">}</span>&nbsp;<span class="keyword" id="3328290">else</span>&nbsp;<span class="op" id="3328295">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3328299">mutexBit</span>&nbsp;<span class="op" id="3328308">=</span>&nbsp;<span class="ident" id="3328310">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3328323">mutexWait</span>&nbsp;<span class="op" id="3328333">=</span>&nbsp;<span class="ident" id="3328335">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3328348">mutexMask</span>&nbsp;<span class="op" id="3328358">=</span>&nbsp;<span class="ident" id="3328360">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3328373">mutexSema</span>&nbsp;<span class="op" id="3328383">=</span>&nbsp;<span class="op" id="3328385">&amp;</span><span class="ident" id="3328386">mu</span><span class="op" id="3328388">.</span><span class="ident" id="3328389">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328396">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328399">for</span>&nbsp;<span class="op" id="3328403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3328407">old</span>&nbsp;<span class="op" id="3328411">:=</span>&nbsp;<span class="ident" id="3328414">atomic</span><span class="op" id="3328420">.</span><span class="ident" id="3328421">LoadUint64</span><span class="op" id="3328431">(</span><span class="op" id="3328432">&amp;</span><span class="ident" id="3328433">mu</span><span class="op" id="3328435">.</span><span class="ident" id="3328436">state</span><span class="op" id="3328441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328445">if</span>&nbsp;<span class="ident" id="3328448">old</span><span class="op" id="3328451">&amp;</span><span class="ident" id="3328452">mutexClosed</span>&nbsp;<span class="op" id="3328464">!=</span>&nbsp;<span class="num" id="3328467">0</span>&nbsp;<span class="op" id="3328469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328474">return</span>&nbsp;<span class="ident" id="3328481">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328489">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328493">var</span>&nbsp;<span class="builtinfunc" id="3328497">new</span>&nbsp;<span class="ident" id="3328501">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328510">if</span>&nbsp;<span class="ident" id="3328513">old</span><span class="op" id="3328516">&amp;</span><span class="ident" id="3328517">mutexBit</span>&nbsp;<span class="op" id="3328526">==</span>&nbsp;<span class="num" id="3328529">0</span>&nbsp;<span class="op" id="3328531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3328536">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3328568">new</span>&nbsp;<span class="op" id="3328572">=</span>&nbsp;<span class="op" id="3328574">(</span><span class="ident" id="3328575">old</span>&nbsp;<span class="op" id="3328579">|</span>&nbsp;<span class="ident" id="3328581">mutexBit</span><span class="op" id="3328589">)</span>&nbsp;<span class="op" id="3328591">+</span>&nbsp;<span class="ident" id="3328593">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328605">if</span>&nbsp;<span class="builtinfunc" id="3328608">new</span><span class="op" id="3328611">&amp;</span><span class="ident" id="3328612">mutexRefMask</span>&nbsp;<span class="op" id="3328625">==</span>&nbsp;<span class="num" id="3328628">0</span>&nbsp;<span class="op" id="3328630">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3328636">panic</span><span class="op" id="3328641">(</span><span class="string" id="3328642">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3328669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328678">}</span>&nbsp;<span class="keyword" id="3328680">else</span>&nbsp;<span class="op" id="3328685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3328690">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3328711">new</span>&nbsp;<span class="op" id="3328715">=</span>&nbsp;<span class="ident" id="3328717">old</span>&nbsp;<span class="op" id="3328721">+</span>&nbsp;<span class="ident" id="3328723">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328736">if</span>&nbsp;<span class="builtinfunc" id="3328739">new</span><span class="op" id="3328742">&amp;</span><span class="ident" id="3328743">mutexMask</span>&nbsp;<span class="op" id="3328753">==</span>&nbsp;<span class="num" id="3328756">0</span>&nbsp;<span class="op" id="3328758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3328764">panic</span><span class="op" id="3328769">(</span><span class="string" id="3328770">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3328797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328810">if</span>&nbsp;<span class="ident" id="3328813">atomic</span><span class="op" id="3328819">.</span><span class="ident" id="3328820">CompareAndSwapUint64</span><span class="op" id="3328840">(</span><span class="op" id="3328841">&amp;</span><span class="ident" id="3328842">mu</span><span class="op" id="3328844">.</span><span class="ident" id="3328845">state</span><span class="op" id="3328850">,</span>&nbsp;<span class="ident" id="3328852">old</span><span class="op" id="3328855">,</span>&nbsp;<span class="builtinfunc" id="3328857">new</span><span class="op" id="3328860">)</span>&nbsp;<span class="op" id="3328862">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328867">if</span>&nbsp;<span class="ident" id="3328870">old</span><span class="op" id="3328873">&amp;</span><span class="ident" id="3328874">mutexBit</span>&nbsp;<span class="op" id="3328883">==</span>&nbsp;<span class="num" id="3328886">0</span>&nbsp;<span class="op" id="3328888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328894">return</span>&nbsp;<span class="ident" id="3328901">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3328914">runtime_Semacquire</span><span class="op" id="3328932">(</span><span class="ident" id="3328933">mutexSema</span><span class="op" id="3328942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3328947">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328995">}</span><br>
<span class="lineno"></span><span class="op" id="3328997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3329000">func</span>&nbsp;<span class="op" id="3329005">(</span><span class="ident" id="3329006">mu</span>&nbsp;<span class="op" id="3329009">*</span><span class="ident" id="3329010">fdMutex</span><span class="op" id="3329017">)</span>&nbsp;<span class="ident" id="3329019">RWUnlock</span><span class="op" id="3329027">(</span><span class="ident" id="3329028">read</span>&nbsp;<span class="builtintype" id="3329033">bool</span><span class="op" id="3329037">)</span>&nbsp;<span class="builtintype" id="3329039">bool</span>&nbsp;<span class="op" id="3329044">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329047">var</span>&nbsp;<span class="ident" id="3329051">mutexBit</span><span class="op" id="3329059">,</span>&nbsp;<span class="ident" id="3329061">mutexWait</span><span class="op" id="3329070">,</span>&nbsp;<span class="ident" id="3329072">mutexMask</span>&nbsp;<span class="ident" id="3329082">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329090">var</span>&nbsp;<span class="ident" id="3329094">mutexSema</span>&nbsp;<span class="op" id="3329104">*</span><span class="builtintype" id="3329105">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329113">if</span>&nbsp;<span class="ident" id="3329116">read</span>&nbsp;<span class="op" id="3329121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329125">mutexBit</span>&nbsp;<span class="op" id="3329134">=</span>&nbsp;<span class="ident" id="3329136">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329149">mutexWait</span>&nbsp;<span class="op" id="3329159">=</span>&nbsp;<span class="ident" id="3329161">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329174">mutexMask</span>&nbsp;<span class="op" id="3329184">=</span>&nbsp;<span class="ident" id="3329186">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329199">mutexSema</span>&nbsp;<span class="op" id="3329209">=</span>&nbsp;<span class="op" id="3329211">&amp;</span><span class="ident" id="3329212">mu</span><span class="op" id="3329214">.</span><span class="ident" id="3329215">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3329222">}</span>&nbsp;<span class="keyword" id="3329224">else</span>&nbsp;<span class="op" id="3329229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329233">mutexBit</span>&nbsp;<span class="op" id="3329242">=</span>&nbsp;<span class="ident" id="3329244">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329257">mutexWait</span>&nbsp;<span class="op" id="3329267">=</span>&nbsp;<span class="ident" id="3329269">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329282">mutexMask</span>&nbsp;<span class="op" id="3329292">=</span>&nbsp;<span class="ident" id="3329294">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329307">mutexSema</span>&nbsp;<span class="op" id="3329317">=</span>&nbsp;<span class="op" id="3329319">&amp;</span><span class="ident" id="3329320">mu</span><span class="op" id="3329322">.</span><span class="ident" id="3329323">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3329330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329333">for</span>&nbsp;<span class="op" id="3329337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329341">old</span>&nbsp;<span class="op" id="3329345">:=</span>&nbsp;<span class="ident" id="3329348">atomic</span><span class="op" id="3329354">.</span><span class="ident" id="3329355">LoadUint64</span><span class="op" id="3329365">(</span><span class="op" id="3329366">&amp;</span><span class="ident" id="3329367">mu</span><span class="op" id="3329369">.</span><span class="ident" id="3329370">state</span><span class="op" id="3329375">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329379">if</span>&nbsp;<span class="ident" id="3329382">old</span><span class="op" id="3329385">&amp;</span><span class="ident" id="3329386">mutexBit</span>&nbsp;<span class="op" id="3329395">==</span>&nbsp;<span class="num" id="3329398">0</span>&nbsp;<span class="op" id="3329400">||</span>&nbsp;<span class="ident" id="3329403">old</span><span class="op" id="3329406">&amp;</span><span class="ident" id="3329407">mutexRefMask</span>&nbsp;<span class="op" id="3329420">==</span>&nbsp;<span class="num" id="3329423">0</span>&nbsp;<span class="op" id="3329425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3329430">panic</span><span class="op" id="3329435">(</span><span class="string" id="3329436">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3329463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3329467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3329471">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3329535">new</span>&nbsp;<span class="op" id="3329539">:=</span>&nbsp;<span class="op" id="3329542">(</span><span class="ident" id="3329543">old</span>&nbsp;<span class="op" id="3329547">&amp;^</span>&nbsp;<span class="ident" id="3329550">mutexBit</span><span class="op" id="3329558">)</span>&nbsp;<span class="op" id="3329560">-</span>&nbsp;<span class="ident" id="3329562">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329573">if</span>&nbsp;<span class="ident" id="3329576">old</span><span class="op" id="3329579">&amp;</span><span class="ident" id="3329580">mutexMask</span>&nbsp;<span class="op" id="3329590">!=</span>&nbsp;<span class="num" id="3329593">0</span>&nbsp;<span class="op" id="3329595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3329600">new</span>&nbsp;<span class="op" id="3329604">-=</span>&nbsp;<span class="ident" id="3329607">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3329619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329623">if</span>&nbsp;<span class="ident" id="3329626">atomic</span><span class="op" id="3329632">.</span><span class="ident" id="3329633">CompareAndSwapUint64</span><span class="op" id="3329653">(</span><span class="op" id="3329654">&amp;</span><span class="ident" id="3329655">mu</span><span class="op" id="3329657">.</span><span class="ident" id="3329658">state</span><span class="op" id="3329663">,</span>&nbsp;<span class="ident" id="3329665">old</span><span class="op" id="3329668">,</span>&nbsp;<span class="builtinfunc" id="3329670">new</span><span class="op" id="3329673">)</span>&nbsp;<span class="op" id="3329675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329680">if</span>&nbsp;<span class="ident" id="3329683">old</span><span class="op" id="3329686">&amp;</span><span class="ident" id="3329687">mutexMask</span>&nbsp;<span class="op" id="3329697">!=</span>&nbsp;<span class="num" id="3329700">0</span>&nbsp;<span class="op" id="3329702">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329708">runtime_Semrelease</span><span class="op" id="3329726">(</span><span class="ident" id="3329727">mutexSema</span><span class="op" id="3329736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3329741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329746">return</span>&nbsp;<span class="builtinfunc" id="3329753">new</span><span class="op" id="3329756">&amp;</span><span class="op" id="3329757">(</span><span class="ident" id="3329758">mutexClosed</span><span class="op" id="3329769">|</span><span class="ident" id="3329770">mutexRefMask</span><span class="op" id="3329782">)</span>&nbsp;<span class="op" id="3329784">==</span>&nbsp;<span class="ident" id="3329787">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3329801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3329804">}</span><br>
<span class="lineno">180</span><span class="op" id="3329806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3329809">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3329844">func</span>&nbsp;<span class="ident" id="3329849">runtime_Semacquire</span><span class="op" id="3329867">(</span><span class="ident" id="3329868">sema</span>&nbsp;<span class="op" id="3329873">*</span><span class="builtintype" id="3329874">uint32</span><span class="op" id="3329880">)</span><br>
<span class="lineno"></span><span class="keyword" id="3329882">func</span>&nbsp;<span class="ident" id="3329887">runtime_Semrelease</span><span class="op" id="3329905">(</span><span class="ident" id="3329906">sema</span>&nbsp;<span class="op" id="3329911">*</span><span class="builtintype" id="3329912">uint32</span><span class="op" id="3329918">)</span>
</div>
</body>
</html>
