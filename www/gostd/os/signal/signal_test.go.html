<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>os/signal</h2>
<ul>
<li><a href="/gostd/os/signal/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/os/signal/signal.go.html">signal.go</a></li>
<li><a href="/gostd/os/signal/signal_test.go.html">signal_test.go</a></li>
<li><a href="/gostd/os/signal/signal_unix.go.html">signal_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7571783">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7571838">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7571892">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7571943">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7572008">package</span>&nbsp;<span class="ident" id="7572016">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7572024">import</span>&nbsp;<span class="op" id="7572031">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7572034">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7572042">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7572055">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7572061">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7572072">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7572083">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7572094">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7572105">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7572116">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7572123">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7572126">func</span>&nbsp;<span class="ident" id="7572131">waitSig</span><span class="op" id="7572138">(</span><span class="ident" id="7572139">t</span>&nbsp;<span class="op" id="7572141">*</span><span class="ident" id="7572142">testing</span><span class="op" id="7572149">.</span><span class="ident" id="7572150">T</span><span class="op" id="7572151">,</span>&nbsp;<span class="ident" id="7572153">c</span>&nbsp;<span class="op" id="7572155">&lt;-</span><span class="keyword" id="7572157">chan</span>&nbsp;<span class="ident" id="7572162">os</span><span class="op" id="7572164">.</span><span class="ident" id="7572165">Signal</span><span class="op" id="7572171">,</span>&nbsp;<span class="ident" id="7572173">sig</span>&nbsp;<span class="ident" id="7572177">os</span><span class="op" id="7572179">.</span><span class="ident" id="7572180">Signal</span><span class="op" id="7572186">)</span>&nbsp;<span class="op" id="7572188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572191">select</span>&nbsp;<span class="op" id="7572198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572201">case</span>&nbsp;<span class="ident" id="7572206">s</span>&nbsp;<span class="op" id="7572208">:=</span>&nbsp;<span class="op" id="7572211">&lt;-</span><span class="ident" id="7572213">c</span><span class="op" id="7572214">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572218">if</span>&nbsp;<span class="ident" id="7572221">s</span>&nbsp;<span class="op" id="7572223">!=</span>&nbsp;<span class="ident" id="7572226">sig</span>&nbsp;<span class="op" id="7572230">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572235">t</span><span class="op" id="7572236">.</span><span class="ident" id="7572237">Fatalf</span><span class="op" id="7572243">(</span><span class="string" id="7572244">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7572268">,</span>&nbsp;<span class="ident" id="7572270">s</span><span class="op" id="7572271">,</span>&nbsp;<span class="ident" id="7572273">sig</span><span class="op" id="7572276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7572280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572283">case</span>&nbsp;<span class="op" id="7572288">&lt;-</span><span class="ident" id="7572290">time</span><span class="op" id="7572294">.</span><span class="ident" id="7572295">After</span><span class="op" id="7572300">(</span><span class="num" id="7572301">1</span>&nbsp;<span class="op" id="7572303">*</span>&nbsp;<span class="ident" id="7572305">time</span><span class="op" id="7572309">.</span><span class="ident" id="7572310">Second</span><span class="op" id="7572316">)</span><span class="op" id="7572317">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572321">t</span><span class="op" id="7572322">.</span><span class="ident" id="7572323">Fatalf</span><span class="op" id="7572329">(</span><span class="string" id="7572330">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="7572354">,</span>&nbsp;<span class="ident" id="7572356">sig</span><span class="op" id="7572359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7572362">}</span><br>
<span class="lineno">30</span><span class="op" id="7572364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7572367">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="7572409">func</span>&nbsp;<span class="ident" id="7572414">TestSignal</span><span class="op" id="7572424">(</span><span class="ident" id="7572425">t</span>&nbsp;<span class="op" id="7572427">*</span><span class="ident" id="7572428">testing</span><span class="op" id="7572435">.</span><span class="ident" id="7572436">T</span><span class="op" id="7572437">)</span>&nbsp;<span class="op" id="7572439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572442">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572461">c</span>&nbsp;<span class="op" id="7572463">:=</span>&nbsp;<span class="builtinfunc" id="7572466">make</span><span class="op" id="7572470">(</span><span class="keyword" id="7572471">chan</span>&nbsp;<span class="ident" id="7572476">os</span><span class="op" id="7572478">.</span><span class="ident" id="7572479">Signal</span><span class="op" id="7572485">,</span>&nbsp;<span class="num" id="7572487">1</span><span class="op" id="7572488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572491">Notify</span><span class="op" id="7572497">(</span><span class="ident" id="7572498">c</span><span class="op" id="7572499">,</span>&nbsp;<span class="ident" id="7572501">syscall</span><span class="op" id="7572508">.</span><span class="ident" id="7572509">SIGHUP</span><span class="op" id="7572515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7572518">defer</span>&nbsp;<span class="ident" id="7572524">Stop</span><span class="op" id="7572528">(</span><span class="ident" id="7572529">c</span><span class="op" id="7572530">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572534">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572565">t</span><span class="op" id="7572566">.</span><span class="ident" id="7572567">Logf</span><span class="op" id="7572571">(</span><span class="string" id="7572572">&#34;sighup...&#34;</span><span class="op" id="7572583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572586">syscall</span><span class="op" id="7572593">.</span><span class="ident" id="7572594">Kill</span><span class="op" id="7572598">(</span><span class="ident" id="7572599">syscall</span><span class="op" id="7572606">.</span><span class="ident" id="7572607">Getpid</span><span class="op" id="7572613">(</span><span class="op" id="7572614">)</span><span class="op" id="7572615">,</span>&nbsp;<span class="ident" id="7572617">syscall</span><span class="op" id="7572624">.</span><span class="ident" id="7572625">SIGHUP</span><span class="op" id="7572631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572634">waitSig</span><span class="op" id="7572641">(</span><span class="ident" id="7572642">t</span><span class="op" id="7572643">,</span>&nbsp;<span class="ident" id="7572645">c</span><span class="op" id="7572646">,</span>&nbsp;<span class="ident" id="7572648">syscall</span><span class="op" id="7572655">.</span><span class="ident" id="7572656">SIGHUP</span><span class="op" id="7572662">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572666">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572701">c1</span>&nbsp;<span class="op" id="7572704">:=</span>&nbsp;<span class="builtinfunc" id="7572707">make</span><span class="op" id="7572711">(</span><span class="keyword" id="7572712">chan</span>&nbsp;<span class="ident" id="7572717">os</span><span class="op" id="7572719">.</span><span class="ident" id="7572720">Signal</span><span class="op" id="7572726">,</span>&nbsp;<span class="num" id="7572728">1</span><span class="op" id="7572729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572732">Notify</span><span class="op" id="7572738">(</span><span class="ident" id="7572739">c1</span><span class="op" id="7572741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572745">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572778">t</span><span class="op" id="7572779">.</span><span class="ident" id="7572780">Logf</span><span class="op" id="7572784">(</span><span class="string" id="7572785">&#34;sigwinch...&#34;</span><span class="op" id="7572798">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572801">syscall</span><span class="op" id="7572808">.</span><span class="ident" id="7572809">Kill</span><span class="op" id="7572813">(</span><span class="ident" id="7572814">syscall</span><span class="op" id="7572821">.</span><span class="ident" id="7572822">Getpid</span><span class="op" id="7572828">(</span><span class="op" id="7572829">)</span><span class="op" id="7572830">,</span>&nbsp;<span class="ident" id="7572832">syscall</span><span class="op" id="7572839">.</span><span class="ident" id="7572840">SIGWINCH</span><span class="op" id="7572848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7572851">waitSig</span><span class="op" id="7572858">(</span><span class="ident" id="7572859">t</span><span class="op" id="7572860">,</span>&nbsp;<span class="ident" id="7572862">c1</span><span class="op" id="7572864">,</span>&nbsp;<span class="ident" id="7572866">syscall</span><span class="op" id="7572873">.</span><span class="ident" id="7572874">SIGWINCH</span><span class="op" id="7572882">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572886">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572931">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7572981">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573019">t</span><span class="op" id="7573020">.</span><span class="ident" id="7573021">Logf</span><span class="op" id="7573025">(</span><span class="string" id="7573026">&#34;sighup...&#34;</span><span class="op" id="7573037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573040">syscall</span><span class="op" id="7573047">.</span><span class="ident" id="7573048">Kill</span><span class="op" id="7573052">(</span><span class="ident" id="7573053">syscall</span><span class="op" id="7573060">.</span><span class="ident" id="7573061">Getpid</span><span class="op" id="7573067">(</span><span class="op" id="7573068">)</span><span class="op" id="7573069">,</span>&nbsp;<span class="ident" id="7573071">syscall</span><span class="op" id="7573078">.</span><span class="ident" id="7573079">SIGHUP</span><span class="op" id="7573085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573088">waitSig</span><span class="op" id="7573095">(</span><span class="ident" id="7573096">t</span><span class="op" id="7573097">,</span>&nbsp;<span class="ident" id="7573099">c1</span><span class="op" id="7573101">,</span>&nbsp;<span class="ident" id="7573103">syscall</span><span class="op" id="7573110">.</span><span class="ident" id="7573111">SIGHUP</span><span class="op" id="7573117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573120">t</span><span class="op" id="7573121">.</span><span class="ident" id="7573122">Logf</span><span class="op" id="7573126">(</span><span class="string" id="7573127">&#34;sighup...&#34;</span><span class="op" id="7573138">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573141">syscall</span><span class="op" id="7573148">.</span><span class="ident" id="7573149">Kill</span><span class="op" id="7573153">(</span><span class="ident" id="7573154">syscall</span><span class="op" id="7573161">.</span><span class="ident" id="7573162">Getpid</span><span class="op" id="7573168">(</span><span class="op" id="7573169">)</span><span class="op" id="7573170">,</span>&nbsp;<span class="ident" id="7573172">syscall</span><span class="op" id="7573179">.</span><span class="ident" id="7573180">SIGHUP</span><span class="op" id="7573186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573189">waitSig</span><span class="op" id="7573196">(</span><span class="ident" id="7573197">t</span><span class="op" id="7573198">,</span>&nbsp;<span class="ident" id="7573200">c1</span><span class="op" id="7573202">,</span>&nbsp;<span class="ident" id="7573204">syscall</span><span class="op" id="7573211">.</span><span class="ident" id="7573212">SIGHUP</span><span class="op" id="7573218">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7573222">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573274">waitSig</span><span class="op" id="7573281">(</span><span class="ident" id="7573282">t</span><span class="op" id="7573283">,</span>&nbsp;<span class="ident" id="7573285">c</span><span class="op" id="7573286">,</span>&nbsp;<span class="ident" id="7573288">syscall</span><span class="op" id="7573295">.</span><span class="ident" id="7573296">SIGHUP</span><span class="op" id="7573302">)</span><br>
<span class="lineno">65</span><span class="op" id="7573304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7573307">func</span>&nbsp;<span class="ident" id="7573312">TestStress</span><span class="op" id="7573322">(</span><span class="ident" id="7573323">t</span>&nbsp;<span class="op" id="7573325">*</span><span class="ident" id="7573326">testing</span><span class="op" id="7573333">.</span><span class="ident" id="7573334">T</span><span class="op" id="7573335">)</span>&nbsp;<span class="op" id="7573337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573340">dur</span>&nbsp;<span class="op" id="7573344">:=</span>&nbsp;<span class="num" id="7573347">3</span>&nbsp;<span class="op" id="7573349">*</span>&nbsp;<span class="ident" id="7573351">time</span><span class="op" id="7573355">.</span><span class="ident" id="7573356">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573364">if</span>&nbsp;<span class="ident" id="7573367">testing</span><span class="op" id="7573374">.</span><span class="ident" id="7573375">Short</span><span class="op" id="7573380">(</span><span class="op" id="7573381">)</span>&nbsp;<span class="op" id="7573383">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573387">dur</span>&nbsp;<span class="op" id="7573391">=</span>&nbsp;<span class="num" id="7573393">100</span>&nbsp;<span class="op" id="7573397">*</span>&nbsp;<span class="ident" id="7573399">time</span><span class="op" id="7573403">.</span><span class="ident" id="7573404">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573420">defer</span>&nbsp;<span class="ident" id="7573426">runtime</span><span class="op" id="7573433">.</span><span class="ident" id="7573434">GOMAXPROCS</span><span class="op" id="7573444">(</span><span class="ident" id="7573445">runtime</span><span class="op" id="7573452">.</span><span class="ident" id="7573453">GOMAXPROCS</span><span class="op" id="7573463">(</span><span class="num" id="7573464">4</span><span class="op" id="7573465">)</span><span class="op" id="7573466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573469">done</span>&nbsp;<span class="op" id="7573474">:=</span>&nbsp;<span class="builtinfunc" id="7573477">make</span><span class="op" id="7573481">(</span><span class="keyword" id="7573482">chan</span>&nbsp;<span class="builtintype" id="7573487">bool</span><span class="op" id="7573491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573494">finished</span>&nbsp;<span class="op" id="7573503">:=</span>&nbsp;<span class="builtinfunc" id="7573506">make</span><span class="op" id="7573510">(</span><span class="keyword" id="7573511">chan</span>&nbsp;<span class="builtintype" id="7573516">bool</span><span class="op" id="7573520">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573523">go</span>&nbsp;<span class="keyword" id="7573526">func</span><span class="op" id="7573530">(</span><span class="op" id="7573531">)</span>&nbsp;<span class="op" id="7573533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573537">sig</span>&nbsp;<span class="op" id="7573541">:=</span>&nbsp;<span class="builtinfunc" id="7573544">make</span><span class="op" id="7573548">(</span><span class="keyword" id="7573549">chan</span>&nbsp;<span class="ident" id="7573554">os</span><span class="op" id="7573556">.</span><span class="ident" id="7573557">Signal</span><span class="op" id="7573563">,</span>&nbsp;<span class="num" id="7573565">1</span><span class="op" id="7573566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573570">Notify</span><span class="op" id="7573576">(</span><span class="ident" id="7573577">sig</span><span class="op" id="7573580">,</span>&nbsp;<span class="ident" id="7573582">syscall</span><span class="op" id="7573589">.</span><span class="ident" id="7573590">SIGUSR1</span><span class="op" id="7573597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573601">defer</span>&nbsp;<span class="ident" id="7573607">Stop</span><span class="op" id="7573611">(</span><span class="ident" id="7573612">sig</span><span class="op" id="7573615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573618">Loop</span><span class="op" id="7573622">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573626">for</span>&nbsp;<span class="op" id="7573630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573635">select</span>&nbsp;<span class="op" id="7573642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573647">case</span>&nbsp;<span class="op" id="7573652">&lt;-</span><span class="ident" id="7573654">sig</span><span class="op" id="7573657">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573662">case</span>&nbsp;<span class="op" id="7573667">&lt;-</span><span class="ident" id="7573669">done</span><span class="op" id="7573673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573679">break</span>&nbsp;<span class="ident" id="7573685">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573701">finished</span>&nbsp;<span class="op" id="7573710">&lt;-</span>&nbsp;<span class="builtintype" id="7573713">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573719">}</span><span class="op" id="7573720">(</span><span class="op" id="7573721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573724">go</span>&nbsp;<span class="keyword" id="7573727">func</span><span class="op" id="7573731">(</span><span class="op" id="7573732">)</span>&nbsp;<span class="op" id="7573734">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573737">Loop</span><span class="op" id="7573741">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573745">for</span>&nbsp;<span class="op" id="7573749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573754">select</span>&nbsp;<span class="op" id="7573761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573766">case</span>&nbsp;<span class="op" id="7573771">&lt;-</span><span class="ident" id="7573773">done</span><span class="op" id="7573777">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573783">break</span>&nbsp;<span class="ident" id="7573789">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7573797">default</span><span class="op" id="7573804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573810">syscall</span><span class="op" id="7573817">.</span><span class="ident" id="7573818">Kill</span><span class="op" id="7573822">(</span><span class="ident" id="7573823">syscall</span><span class="op" id="7573830">.</span><span class="ident" id="7573831">Getpid</span><span class="op" id="7573837">(</span><span class="op" id="7573838">)</span><span class="op" id="7573839">,</span>&nbsp;<span class="ident" id="7573841">syscall</span><span class="op" id="7573848">.</span><span class="ident" id="7573849">SIGUSR1</span><span class="op" id="7573856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573862">runtime</span><span class="op" id="7573869">.</span><span class="ident" id="7573870">Gosched</span><span class="op" id="7573877">(</span><span class="op" id="7573878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573887">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573891">finished</span>&nbsp;<span class="op" id="7573900">&lt;-</span>&nbsp;<span class="builtintype" id="7573903">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573909">}</span><span class="op" id="7573910">(</span><span class="op" id="7573911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7573914">time</span><span class="op" id="7573918">.</span><span class="ident" id="7573919">Sleep</span><span class="op" id="7573924">(</span><span class="ident" id="7573925">dur</span><span class="op" id="7573928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7573931">close</span><span class="op" id="7573936">(</span><span class="ident" id="7573937">done</span><span class="op" id="7573941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573944">&lt;-</span><span class="ident" id="7573946">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7573956">&lt;-</span><span class="ident" id="7573958">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7573968">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7574039">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7574089">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574153">time</span><span class="op" id="7574157">.</span><span class="ident" id="7574158">Sleep</span><span class="op" id="7574163">(</span><span class="num" id="7574164">10</span>&nbsp;<span class="op" id="7574167">*</span>&nbsp;<span class="ident" id="7574169">time</span><span class="op" id="7574173">.</span><span class="ident" id="7574174">Millisecond</span><span class="op" id="7574185">)</span><br>
<span class="lineno">110</span><span class="op" id="7574187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7574190">var</span>&nbsp;<span class="ident" id="7574194">sendUncaughtSighup</span>&nbsp;<span class="op" id="7574213">=</span>&nbsp;<span class="ident" id="7574215">flag</span><span class="op" id="7574219">.</span><span class="ident" id="7574220">Int</span><span class="op" id="7574223">(</span><span class="string" id="7574224">&#34;send_uncaught_sighup&#34;</span><span class="op" id="7574246">,</span>&nbsp;<span class="num" id="7574248">0</span><span class="op" id="7574249">,</span>&nbsp;<span class="string" id="7574251">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="7574289">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7574292">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="7574347">func</span>&nbsp;<span class="ident" id="7574352">TestStop</span><span class="op" id="7574360">(</span><span class="ident" id="7574361">t</span>&nbsp;<span class="op" id="7574363">*</span><span class="ident" id="7574364">testing</span><span class="op" id="7574371">.</span><span class="ident" id="7574372">T</span><span class="op" id="7574373">)</span>&nbsp;<span class="op" id="7574375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574378">sigs</span>&nbsp;<span class="op" id="7574383">:=</span>&nbsp;<span class="op" id="7574386">[</span><span class="op" id="7574387">]</span><span class="ident" id="7574388">syscall</span><span class="op" id="7574395">.</span><span class="ident" id="7574396">Signal</span><span class="op" id="7574402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574406">syscall</span><span class="op" id="7574413">.</span><span class="ident" id="7574414">SIGWINCH</span><span class="op" id="7574422">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574426">syscall</span><span class="op" id="7574433">.</span><span class="ident" id="7574434">SIGHUP</span><span class="op" id="7574440">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7574443">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574447">for</span>&nbsp;<span class="ident" id="7574451">_</span><span class="op" id="7574452">,</span>&nbsp;<span class="ident" id="7574454">sig</span>&nbsp;<span class="op" id="7574458">:=</span>&nbsp;<span class="keyword" id="7574461">range</span>&nbsp;<span class="ident" id="7574467">sigs</span>&nbsp;<span class="op" id="7574472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7574476">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7574498">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7574543">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574614">if</span>&nbsp;<span class="ident" id="7574617">sig</span>&nbsp;<span class="op" id="7574621">!=</span>&nbsp;<span class="ident" id="7574624">syscall</span><span class="op" id="7574631">.</span><span class="ident" id="7574632">SIGHUP</span>&nbsp;<span class="op" id="7574639">||</span>&nbsp;<span class="op" id="7574642">*</span><span class="ident" id="7574643">sendUncaughtSighup</span>&nbsp;<span class="op" id="7574662">==</span>&nbsp;<span class="num" id="7574665">1</span>&nbsp;<span class="op" id="7574667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574672">syscall</span><span class="op" id="7574679">.</span><span class="ident" id="7574680">Kill</span><span class="op" id="7574684">(</span><span class="ident" id="7574685">syscall</span><span class="op" id="7574692">.</span><span class="ident" id="7574693">Getpid</span><span class="op" id="7574699">(</span><span class="op" id="7574700">)</span><span class="op" id="7574701">,</span>&nbsp;<span class="ident" id="7574703">sig</span><span class="op" id="7574706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7574710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574714">time</span><span class="op" id="7574718">.</span><span class="ident" id="7574719">Sleep</span><span class="op" id="7574724">(</span><span class="num" id="7574725">100</span>&nbsp;<span class="op" id="7574729">*</span>&nbsp;<span class="ident" id="7574731">time</span><span class="op" id="7574735">.</span><span class="ident" id="7574736">Millisecond</span><span class="op" id="7574747">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7574752">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574772">c</span>&nbsp;<span class="op" id="7574774">:=</span>&nbsp;<span class="builtinfunc" id="7574777">make</span><span class="op" id="7574781">(</span><span class="keyword" id="7574782">chan</span>&nbsp;<span class="ident" id="7574787">os</span><span class="op" id="7574789">.</span><span class="ident" id="7574790">Signal</span><span class="op" id="7574796">,</span>&nbsp;<span class="num" id="7574798">1</span><span class="op" id="7574799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574803">Notify</span><span class="op" id="7574809">(</span><span class="ident" id="7574810">c</span><span class="op" id="7574811">,</span>&nbsp;<span class="ident" id="7574813">sig</span><span class="op" id="7574816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574820">defer</span>&nbsp;<span class="ident" id="7574826">Stop</span><span class="op" id="7574830">(</span><span class="ident" id="7574831">c</span><span class="op" id="7574832">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7574837">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574872">syscall</span><span class="op" id="7574879">.</span><span class="ident" id="7574880">Kill</span><span class="op" id="7574884">(</span><span class="ident" id="7574885">syscall</span><span class="op" id="7574892">.</span><span class="ident" id="7574893">Getpid</span><span class="op" id="7574899">(</span><span class="op" id="7574900">)</span><span class="op" id="7574901">,</span>&nbsp;<span class="ident" id="7574903">sig</span><span class="op" id="7574906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574910">waitSig</span><span class="op" id="7574917">(</span><span class="ident" id="7574918">t</span><span class="op" id="7574919">,</span>&nbsp;<span class="ident" id="7574921">c</span><span class="op" id="7574922">,</span>&nbsp;<span class="ident" id="7574924">sig</span><span class="op" id="7574927">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574932">Stop</span><span class="op" id="7574936">(</span><span class="ident" id="7574937">c</span><span class="op" id="7574938">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574942">select</span>&nbsp;<span class="op" id="7574949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7574953">case</span>&nbsp;<span class="ident" id="7574958">s</span>&nbsp;<span class="op" id="7574960">:=</span>&nbsp;<span class="op" id="7574963">&lt;-</span><span class="ident" id="7574965">c</span><span class="op" id="7574966">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7574971">t</span><span class="op" id="7574972">.</span><span class="ident" id="7574973">Fatalf</span><span class="op" id="7574979">(</span><span class="string" id="7574980">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7575002">,</span>&nbsp;<span class="ident" id="7575004">s</span><span class="op" id="7575005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575009">case</span>&nbsp;<span class="op" id="7575014">&lt;-</span><span class="ident" id="7575016">time</span><span class="op" id="7575020">.</span><span class="ident" id="7575021">After</span><span class="op" id="7575026">(</span><span class="num" id="7575027">100</span>&nbsp;<span class="op" id="7575031">*</span>&nbsp;<span class="ident" id="7575033">time</span><span class="op" id="7575037">.</span><span class="ident" id="7575038">Millisecond</span><span class="op" id="7575049">)</span><span class="op" id="7575050">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575055">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575088">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575110">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575155">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575226">if</span>&nbsp;<span class="ident" id="7575229">sig</span>&nbsp;<span class="op" id="7575233">!=</span>&nbsp;<span class="ident" id="7575236">syscall</span><span class="op" id="7575243">.</span><span class="ident" id="7575244">SIGHUP</span>&nbsp;<span class="op" id="7575251">||</span>&nbsp;<span class="op" id="7575254">*</span><span class="ident" id="7575255">sendUncaughtSighup</span>&nbsp;<span class="op" id="7575274">==</span>&nbsp;<span class="num" id="7575277">2</span>&nbsp;<span class="op" id="7575279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575284">syscall</span><span class="op" id="7575291">.</span><span class="ident" id="7575292">Kill</span><span class="op" id="7575296">(</span><span class="ident" id="7575297">syscall</span><span class="op" id="7575304">.</span><span class="ident" id="7575305">Getpid</span><span class="op" id="7575311">(</span><span class="op" id="7575312">)</span><span class="op" id="7575313">,</span>&nbsp;<span class="ident" id="7575315">sig</span><span class="op" id="7575318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575327">select</span>&nbsp;<span class="op" id="7575334">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575338">case</span>&nbsp;<span class="ident" id="7575343">s</span>&nbsp;<span class="op" id="7575345">:=</span>&nbsp;<span class="op" id="7575348">&lt;-</span><span class="ident" id="7575350">c</span><span class="op" id="7575351">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575356">t</span><span class="op" id="7575357">.</span><span class="ident" id="7575358">Fatalf</span><span class="op" id="7575364">(</span><span class="string" id="7575365">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7575387">,</span>&nbsp;<span class="ident" id="7575389">s</span><span class="op" id="7575390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7575394">case</span>&nbsp;<span class="op" id="7575399">&lt;-</span><span class="ident" id="7575401">time</span><span class="op" id="7575405">.</span><span class="ident" id="7575406">After</span><span class="op" id="7575411">(</span><span class="num" id="7575412">100</span>&nbsp;<span class="op" id="7575416">*</span>&nbsp;<span class="ident" id="7575418">time</span><span class="op" id="7575422">.</span><span class="ident" id="7575423">Millisecond</span><span class="op" id="7575434">)</span><span class="op" id="7575435">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575440">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575468">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7575471">}</span><br>
<span class="lineno"></span><span class="op" id="7575473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7575476">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="7575557">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="7575566">func</span>&nbsp;<span class="ident" id="7575571">TestNohup</span><span class="op" id="7575580">(</span><span class="ident" id="7575581">t</span>&nbsp;<span class="op" id="7575583">*</span><span class="ident" id="7575584">testing</span><span class="op" id="7575591">.</span><span class="ident" id="7575592">T</span><span class="op" id="7575593">)</span>&nbsp;<span class="op" id="7575595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575598">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575662">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575715">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575759">c</span>&nbsp;<span class="op" id="7575761">:=</span>&nbsp;<span class="builtinfunc" id="7575764">make</span><span class="op" id="7575768">(</span><span class="keyword" id="7575769">chan</span>&nbsp;<span class="ident" id="7575774">os</span><span class="op" id="7575776">.</span><span class="ident" id="7575777">Signal</span><span class="op" id="7575783">,</span>&nbsp;<span class="num" id="7575785">1</span><span class="op" id="7575786">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7575789">Notify</span><span class="op" id="7575795">(</span><span class="ident" id="7575796">c</span><span class="op" id="7575797">,</span>&nbsp;<span class="ident" id="7575799">syscall</span><span class="op" id="7575806">.</span><span class="ident" id="7575807">SIGHUP</span><span class="op" id="7575813">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575817">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575890">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7575957">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7576023">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7576102">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7576180">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7576184">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7576267">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7576350">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7576354">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576414">for</span>&nbsp;<span class="ident" id="7576418">i</span>&nbsp;<span class="op" id="7576420">:=</span>&nbsp;<span class="num" id="7576423">1</span><span class="op" id="7576424">;</span>&nbsp;<span class="ident" id="7576426">i</span>&nbsp;<span class="op" id="7576428">&lt;=</span>&nbsp;<span class="num" id="7576431">2</span><span class="op" id="7576432">;</span>&nbsp;<span class="ident" id="7576434">i</span><span class="op" id="7576435">++</span>&nbsp;<span class="op" id="7576438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576442">out</span><span class="op" id="7576445">,</span>&nbsp;<span class="ident" id="7576447">err</span>&nbsp;<span class="op" id="7576451">:=</span>&nbsp;<span class="ident" id="7576454">exec</span><span class="op" id="7576458">.</span><span class="ident" id="7576459">Command</span><span class="op" id="7576466">(</span><span class="ident" id="7576467">os</span><span class="op" id="7576469">.</span><span class="ident" id="7576470">Args</span><span class="op" id="7576474">[</span><span class="num" id="7576475">0</span><span class="op" id="7576476">]</span><span class="op" id="7576477">,</span>&nbsp;<span class="string" id="7576479">&#34;-test.run=TestStop&#34;</span><span class="op" id="7576499">,</span>&nbsp;<span class="string" id="7576501">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7576525">+</span><span class="ident" id="7576526">strconv</span><span class="op" id="7576533">.</span><span class="ident" id="7576534">Itoa</span><span class="op" id="7576538">(</span><span class="ident" id="7576539">i</span><span class="op" id="7576540">)</span><span class="op" id="7576541">)</span><span class="op" id="7576542">.</span><span class="ident" id="7576543">CombinedOutput</span><span class="op" id="7576557">(</span><span class="op" id="7576558">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576562">if</span>&nbsp;<span class="ident" id="7576565">err</span>&nbsp;<span class="op" id="7576569">==</span>&nbsp;<span class="ident" id="7576572">nil</span>&nbsp;<span class="op" id="7576576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576581">t</span><span class="op" id="7576582">.</span><span class="ident" id="7576583">Fatalf</span><span class="op" id="7576589">(</span><span class="string" id="7576590">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="7576679">,</span>&nbsp;<span class="ident" id="7576681">i</span><span class="op" id="7576682">,</span>&nbsp;<span class="ident" id="7576684">out</span><span class="op" id="7576687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7576691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7576694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576698">Stop</span><span class="op" id="7576702">(</span><span class="ident" id="7576703">c</span><span class="op" id="7576704">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7576708">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576766">_</span><span class="op" id="7576767">,</span>&nbsp;<span class="ident" id="7576769">err</span>&nbsp;<span class="op" id="7576773">:=</span>&nbsp;<span class="ident" id="7576776">os</span><span class="op" id="7576778">.</span><span class="ident" id="7576779">Stat</span><span class="op" id="7576783">(</span><span class="string" id="7576784">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7576800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576803">if</span>&nbsp;<span class="ident" id="7576806">err</span>&nbsp;<span class="op" id="7576810">!=</span>&nbsp;<span class="ident" id="7576813">nil</span>&nbsp;<span class="op" id="7576817">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576821">t</span><span class="op" id="7576822">.</span><span class="ident" id="7576823">Skip</span><span class="op" id="7576827">(</span><span class="string" id="7576828">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="7576877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7576880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7576884">for</span>&nbsp;<span class="ident" id="7576888">i</span>&nbsp;<span class="op" id="7576890">:=</span>&nbsp;<span class="num" id="7576893">1</span><span class="op" id="7576894">;</span>&nbsp;<span class="ident" id="7576896">i</span>&nbsp;<span class="op" id="7576898">&lt;=</span>&nbsp;<span class="num" id="7576901">2</span><span class="op" id="7576902">;</span>&nbsp;<span class="ident" id="7576904">i</span><span class="op" id="7576905">++</span>&nbsp;<span class="op" id="7576908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576912">os</span><span class="op" id="7576914">.</span><span class="ident" id="7576915">Remove</span><span class="op" id="7576921">(</span><span class="string" id="7576922">&#34;nohup.out&#34;</span><span class="op" id="7576933">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7576937">out</span><span class="op" id="7576940">,</span>&nbsp;<span class="ident" id="7576942">err</span>&nbsp;<span class="op" id="7576946">:=</span>&nbsp;<span class="ident" id="7576949">exec</span><span class="op" id="7576953">.</span><span class="ident" id="7576954">Command</span><span class="op" id="7576961">(</span><span class="string" id="7576962">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7576978">,</span>&nbsp;<span class="ident" id="7576980">os</span><span class="op" id="7576982">.</span><span class="ident" id="7576983">Args</span><span class="op" id="7576987">[</span><span class="num" id="7576988">0</span><span class="op" id="7576989">]</span><span class="op" id="7576990">,</span>&nbsp;<span class="string" id="7576992">&#34;-test.run=TestStop&#34;</span><span class="op" id="7577012">,</span>&nbsp;<span class="string" id="7577014">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7577038">+</span><span class="ident" id="7577039">strconv</span><span class="op" id="7577046">.</span><span class="ident" id="7577047">Itoa</span><span class="op" id="7577051">(</span><span class="ident" id="7577052">i</span><span class="op" id="7577053">)</span><span class="op" id="7577054">)</span><span class="op" id="7577055">.</span><span class="ident" id="7577056">CombinedOutput</span><span class="op" id="7577070">(</span><span class="op" id="7577071">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7577076">data</span><span class="op" id="7577080">,</span>&nbsp;<span class="ident" id="7577082">_</span>&nbsp;<span class="op" id="7577084">:=</span>&nbsp;<span class="ident" id="7577087">ioutil</span><span class="op" id="7577093">.</span><span class="ident" id="7577094">ReadFile</span><span class="op" id="7577102">(</span><span class="string" id="7577103">&#34;nohup.out&#34;</span><span class="op" id="7577114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7577118">os</span><span class="op" id="7577120">.</span><span class="ident" id="7577121">Remove</span><span class="op" id="7577127">(</span><span class="string" id="7577128">&#34;nohup.out&#34;</span><span class="op" id="7577139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7577143">if</span>&nbsp;<span class="ident" id="7577146">err</span>&nbsp;<span class="op" id="7577150">!=</span>&nbsp;<span class="ident" id="7577153">nil</span>&nbsp;<span class="op" id="7577157">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7577162">t</span><span class="op" id="7577163">.</span><span class="ident" id="7577164">Fatalf</span><span class="op" id="7577170">(</span><span class="string" id="7577171">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="7577282">,</span>&nbsp;<span class="ident" id="7577284">i</span><span class="op" id="7577285">,</span>&nbsp;<span class="ident" id="7577287">err</span><span class="op" id="7577290">,</span>&nbsp;<span class="ident" id="7577292">out</span><span class="op" id="7577295">,</span>&nbsp;<span class="ident" id="7577297">data</span><span class="op" id="7577301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7577305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7577308">}</span><br>
<span class="lineno"></span><span class="op" id="7577310">}</span>
</div>
</body>
</html>
