<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3200746">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3200802">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3200856">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3200907">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3200985">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3201032">package</span>&nbsp;<span class="ident" id="3201040">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3201045">import</span>&nbsp;<span class="op" id="3201052">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3201055">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3201066">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3201073">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3201076">func</span>&nbsp;<span class="ident" id="3201081">probeIPv4Stack</span><span class="op" id="3201095">(</span><span class="op" id="3201096">)</span>&nbsp;<span class="builtintype" id="3201098">bool</span>&nbsp;<span class="op" id="3201103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3201106">s</span><span class="op" id="3201107">,</span>&nbsp;<span class="ident" id="3201109">err</span>&nbsp;<span class="op" id="3201113">:=</span>&nbsp;<span class="ident" id="3201116">syscall</span><span class="op" id="3201123">.</span><span class="ident" id="3201124">Socket</span><span class="op" id="3201130">(</span><span class="ident" id="3201131">syscall</span><span class="op" id="3201138">.</span><span class="ident" id="3201139">AF_INET</span><span class="op" id="3201146">,</span>&nbsp;<span class="ident" id="3201148">syscall</span><span class="op" id="3201155">.</span><span class="ident" id="3201156">SOCK_STREAM</span><span class="op" id="3201167">,</span>&nbsp;<span class="ident" id="3201169">syscall</span><span class="op" id="3201176">.</span><span class="ident" id="3201177">IPPROTO_TCP</span><span class="op" id="3201188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3201191">switch</span>&nbsp;<span class="ident" id="3201198">err</span>&nbsp;<span class="op" id="3201202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3201205">case</span>&nbsp;<span class="ident" id="3201210">syscall</span><span class="op" id="3201217">.</span><span class="ident" id="3201218">EAFNOSUPPORT</span><span class="op" id="3201230">,</span>&nbsp;<span class="ident" id="3201232">syscall</span><span class="op" id="3201239">.</span><span class="ident" id="3201240">EPROTONOSUPPORT</span><span class="op" id="3201255">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3201259">return</span>&nbsp;<span class="builtintype" id="3201266">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3201273">case</span>&nbsp;<span class="ident" id="3201278">nil</span><span class="op" id="3201281">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3201285">closesocket</span><span class="op" id="3201296">(</span><span class="ident" id="3201297">s</span><span class="op" id="3201298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3201301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3201304">return</span>&nbsp;<span class="builtintype" id="3201311">true</span><br>
<span class="lineno">25</span><span class="op" id="3201316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3201319">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="3201378">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="3201441">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="3201507">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="3201568">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="3201631">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3201686">//</span><br>
<span class="lineno"></span><span class="comment" id="3201689">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="3201756">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="3201820">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3201874">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3201939">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="3202005">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="3202066">func</span>&nbsp;<span class="ident" id="3202071">probeIPv6Stack</span><span class="op" id="3202085">(</span><span class="op" id="3202086">)</span>&nbsp;<span class="op" id="3202088">(</span><span class="ident" id="3202089">supportsIPv6</span><span class="op" id="3202101">,</span>&nbsp;<span class="ident" id="3202103">supportsIPv4map</span>&nbsp;<span class="builtintype" id="3202119">bool</span><span class="op" id="3202123">)</span>&nbsp;<span class="op" id="3202125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3202128">var</span>&nbsp;<span class="ident" id="3202132">probes</span>&nbsp;<span class="op" id="3202139">=</span>&nbsp;<span class="op" id="3202141">[</span><span class="op" id="3202142">]</span><span class="keyword" id="3202143">struct</span>&nbsp;<span class="op" id="3202150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3202154">laddr</span>&nbsp;<span class="ident" id="3202160">TCPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3202170">value</span>&nbsp;<span class="builtintype" id="3202176">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3202182">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3202188">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3202194">}</span><span class="op" id="3202195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3202199">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3202234">{</span><span class="ident" id="3202235">laddr</span><span class="op" id="3202240">:</span>&nbsp;<span class="ident" id="3202242">TCPAddr</span><span class="op" id="3202249">{</span><span class="ident" id="3202250">IP</span><span class="op" id="3202252">:</span>&nbsp;<span class="ident" id="3202254">ParseIP</span><span class="op" id="3202261">(</span><span class="string" id="3202262">&#34;::1&#34;</span><span class="op" id="3202267">)</span><span class="op" id="3202268">}</span><span class="op" id="3202269">,</span>&nbsp;<span class="ident" id="3202271">value</span><span class="op" id="3202276">:</span>&nbsp;<span class="num" id="3202278">1</span><span class="op" id="3202279">}</span><span class="op" id="3202280">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3202284">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3202339">{</span><span class="ident" id="3202340">laddr</span><span class="op" id="3202345">:</span>&nbsp;<span class="ident" id="3202347">TCPAddr</span><span class="op" id="3202354">{</span><span class="ident" id="3202355">IP</span><span class="op" id="3202357">:</span>&nbsp;<span class="ident" id="3202359">IPv4</span><span class="op" id="3202363">(</span><span class="num" id="3202364">127</span><span class="op" id="3202367">,</span>&nbsp;<span class="num" id="3202369">0</span><span class="op" id="3202370">,</span>&nbsp;<span class="num" id="3202372">0</span><span class="op" id="3202373">,</span>&nbsp;<span class="num" id="3202375">1</span><span class="op" id="3202376">)</span><span class="op" id="3202377">}</span><span class="op" id="3202378">,</span>&nbsp;<span class="ident" id="3202380">value</span><span class="op" id="3202385">:</span>&nbsp;<span class="num" id="3202387">0</span><span class="op" id="3202388">}</span><span class="op" id="3202389">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3202392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3202396">for</span>&nbsp;<span class="ident" id="3202400">i</span>&nbsp;<span class="op" id="3202402">:=</span>&nbsp;<span class="keyword" id="3202405">range</span>&nbsp;<span class="ident" id="3202411">probes</span>&nbsp;<span class="op" id="3202418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3202422">s</span><span class="op" id="3202423">,</span>&nbsp;<span class="ident" id="3202425">err</span>&nbsp;<span class="op" id="3202429">:=</span>&nbsp;<span class="ident" id="3202432">syscall</span><span class="op" id="3202439">.</span><span class="ident" id="3202440">Socket</span><span class="op" id="3202446">(</span><span class="ident" id="3202447">syscall</span><span class="op" id="3202454">.</span><span class="ident" id="3202455">AF_INET6</span><span class="op" id="3202463">,</span>&nbsp;<span class="ident" id="3202465">syscall</span><span class="op" id="3202472">.</span><span class="ident" id="3202473">SOCK_STREAM</span><span class="op" id="3202484">,</span>&nbsp;<span class="ident" id="3202486">syscall</span><span class="op" id="3202493">.</span><span class="ident" id="3202494">IPPROTO_TCP</span><span class="op" id="3202505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3202509">if</span>&nbsp;<span class="ident" id="3202512">err</span>&nbsp;<span class="op" id="3202516">!=</span>&nbsp;<span class="ident" id="3202519">nil</span>&nbsp;<span class="op" id="3202523">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3202528">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3202539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3202543">defer</span>&nbsp;<span class="ident" id="3202549">closesocket</span><span class="op" id="3202560">(</span><span class="ident" id="3202561">s</span><span class="op" id="3202562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3202566">syscall</span><span class="op" id="3202573">.</span><span class="ident" id="3202574">SetsockoptInt</span><span class="op" id="3202587">(</span><span class="ident" id="3202588">s</span><span class="op" id="3202589">,</span>&nbsp;<span class="ident" id="3202591">syscall</span><span class="op" id="3202598">.</span><span class="ident" id="3202599">IPPROTO_IPV6</span><span class="op" id="3202611">,</span>&nbsp;<span class="ident" id="3202613">syscall</span><span class="op" id="3202620">.</span><span class="ident" id="3202621">IPV6_V6ONLY</span><span class="op" id="3202632">,</span>&nbsp;<span class="ident" id="3202634">probes</span><span class="op" id="3202640">[</span><span class="ident" id="3202641">i</span><span class="op" id="3202642">]</span><span class="op" id="3202643">.</span><span class="ident" id="3202644">value</span><span class="op" id="3202649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3202653">sa</span><span class="op" id="3202655">,</span>&nbsp;<span class="ident" id="3202657">err</span>&nbsp;<span class="op" id="3202661">:=</span>&nbsp;<span class="ident" id="3202664">probes</span><span class="op" id="3202670">[</span><span class="ident" id="3202671">i</span><span class="op" id="3202672">]</span><span class="op" id="3202673">.</span><span class="ident" id="3202674">laddr</span><span class="op" id="3202679">.</span><span class="ident" id="3202680">sockaddr</span><span class="op" id="3202688">(</span><span class="ident" id="3202689">syscall</span><span class="op" id="3202696">.</span><span class="ident" id="3202697">AF_INET6</span><span class="op" id="3202705">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3202709">if</span>&nbsp;<span class="ident" id="3202712">err</span>&nbsp;<span class="op" id="3202716">!=</span>&nbsp;<span class="ident" id="3202719">nil</span>&nbsp;<span class="op" id="3202723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3202728">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3202739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3202743">if</span>&nbsp;<span class="ident" id="3202746">err</span>&nbsp;<span class="op" id="3202750">:=</span>&nbsp;<span class="ident" id="3202753">syscall</span><span class="op" id="3202760">.</span><span class="ident" id="3202761">Bind</span><span class="op" id="3202765">(</span><span class="ident" id="3202766">s</span><span class="op" id="3202767">,</span>&nbsp;<span class="ident" id="3202769">sa</span><span class="op" id="3202771">)</span><span class="op" id="3202772">;</span>&nbsp;<span class="ident" id="3202774">err</span>&nbsp;<span class="op" id="3202778">!=</span>&nbsp;<span class="ident" id="3202781">nil</span>&nbsp;<span class="op" id="3202785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3202790">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3202801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3202805">probes</span><span class="op" id="3202811">[</span><span class="ident" id="3202812">i</span><span class="op" id="3202813">]</span><span class="op" id="3202814">.</span><span class="ident" id="3202815">ok</span>&nbsp;<span class="op" id="3202818">=</span>&nbsp;<span class="builtintype" id="3202820">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3202826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3202830">return</span>&nbsp;<span class="ident" id="3202837">probes</span><span class="op" id="3202843">[</span><span class="num" id="3202844">0</span><span class="op" id="3202845">]</span><span class="op" id="3202846">.</span><span class="ident" id="3202847">ok</span><span class="op" id="3202849">,</span>&nbsp;<span class="ident" id="3202851">probes</span><span class="op" id="3202857">[</span><span class="num" id="3202858">1</span><span class="op" id="3202859">]</span><span class="op" id="3202860">.</span><span class="ident" id="3202861">ok</span><br>
<span class="lineno">70</span><span class="op" id="3202864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3202867">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3202931">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="3202993">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="3203057">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3203119">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="3203185">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="3203249">//</span><br>
<span class="lineno"></span><span class="comment" id="3203252">//&nbsp;&nbsp;&nbsp;&nbsp1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="3203289">//&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="3203349">//&nbsp;&nbsp;&nbsp;&nbspcapabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3203408">//&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="3203464">//&nbsp;&nbsp;&nbsp;&nbspsocket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="3203523">//&nbsp;&nbsp;&nbsp;&nbspwildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="3203574">//</span><br>
<span class="lineno"></span><span class="comment" id="3203577">//&nbsp;&nbsp;&nbsp;&nbsp2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3203625">//&nbsp;&nbsp;&nbsp;&nbspSame&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3203639">//</span><br>
<span class="lineno"></span><span class="comment" id="3203642">//&nbsp;&nbsp;&nbsp;&nbsp3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="3203687">//&nbsp;&nbsp;&nbsp;&nbspAlmost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="3203746">//&nbsp;&nbsp;&nbsp;&nbsplisten&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3203804">//&nbsp;&nbsp;&nbsp;&nbspthe&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="3203864">//&nbsp;&nbsp;&nbsp;&nbspmapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="3203887">//</span><br>
<span class="lineno">95</span><span class="comment" id="3203890">//&nbsp;&nbsp;&nbsp;&nbsp4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3203945">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3203998">//</span><br>
<span class="lineno"></span><span class="comment" id="3204001">//&nbsp;&nbsp;&nbsp;&nbsp5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3204053">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="3204114">//&nbsp;&nbsp;&nbsp;&nbsplisten.</span><br>
<span class="lineno"></span><span class="comment" id="3204125">//</span><br>
<span class="lineno"></span><span class="comment" id="3204128">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="3204196">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="3204263">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="3204297">//</span><br>
<span class="lineno"></span><span class="comment" id="3204300">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="3204368">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="3204429">func</span>&nbsp;<span class="ident" id="3204434">favoriteAddrFamily</span><span class="op" id="3204452">(</span><span class="ident" id="3204453">net</span>&nbsp;<span class="builtintype" id="3204457">string</span><span class="op" id="3204463">,</span>&nbsp;<span class="ident" id="3204465">laddr</span><span class="op" id="3204470">,</span>&nbsp;<span class="ident" id="3204472">raddr</span>&nbsp;<span class="ident" id="3204478">sockaddr</span><span class="op" id="3204486">,</span>&nbsp;<span class="ident" id="3204488">mode</span>&nbsp;<span class="builtintype" id="3204493">string</span><span class="op" id="3204499">)</span>&nbsp;<span class="op" id="3204501">(</span><span class="ident" id="3204502">family</span>&nbsp;<span class="builtintype" id="3204509">int</span><span class="op" id="3204512">,</span>&nbsp;<span class="ident" id="3204514">ipv6only</span>&nbsp;<span class="builtintype" id="3204523">bool</span><span class="op" id="3204527">)</span>&nbsp;<span class="op" id="3204529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204532">switch</span>&nbsp;<span class="ident" id="3204539">net</span><span class="op" id="3204542">[</span><span class="builtinfunc" id="3204543">len</span><span class="op" id="3204546">(</span><span class="ident" id="3204547">net</span><span class="op" id="3204550">)</span><span class="op" id="3204551">-</span><span class="num" id="3204552">1</span><span class="op" id="3204553">]</span>&nbsp;<span class="op" id="3204555">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204558">case</span>&nbsp;<span class="string" id="3204563">&#39;4&#39;</span><span class="op" id="3204566">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204570">return</span>&nbsp;<span class="ident" id="3204577">syscall</span><span class="op" id="3204584">.</span><span class="ident" id="3204585">AF_INET</span><span class="op" id="3204592">,</span>&nbsp;<span class="builtintype" id="3204594">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204601">case</span>&nbsp;<span class="string" id="3204606">&#39;6&#39;</span><span class="op" id="3204609">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204613">return</span>&nbsp;<span class="ident" id="3204620">syscall</span><span class="op" id="3204627">.</span><span class="ident" id="3204628">AF_INET6</span><span class="op" id="3204636">,</span>&nbsp;<span class="builtintype" id="3204638">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3204644">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204648">if</span>&nbsp;<span class="ident" id="3204651">mode</span>&nbsp;<span class="op" id="3204656">==</span>&nbsp;<span class="string" id="3204659">&#34;listen&#34;</span>&nbsp;<span class="op" id="3204668">&amp;&amp;</span>&nbsp;<span class="op" id="3204671">(</span><span class="ident" id="3204672">laddr</span>&nbsp;<span class="op" id="3204678">==</span>&nbsp;<span class="ident" id="3204681">nil</span>&nbsp;<span class="op" id="3204685">||</span>&nbsp;<span class="ident" id="3204688">laddr</span><span class="op" id="3204693">.</span><span class="ident" id="3204694">isWildcard</span><span class="op" id="3204704">(</span><span class="op" id="3204705">)</span><span class="op" id="3204706">)</span>&nbsp;<span class="op" id="3204708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204712">if</span>&nbsp;<span class="ident" id="3204715">supportsIPv4map</span>&nbsp;<span class="op" id="3204731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204736">return</span>&nbsp;<span class="ident" id="3204743">syscall</span><span class="op" id="3204750">.</span><span class="ident" id="3204751">AF_INET6</span><span class="op" id="3204759">,</span>&nbsp;<span class="builtintype" id="3204761">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3204769">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204773">if</span>&nbsp;<span class="ident" id="3204776">laddr</span>&nbsp;<span class="op" id="3204782">==</span>&nbsp;<span class="ident" id="3204785">nil</span>&nbsp;<span class="op" id="3204789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204794">return</span>&nbsp;<span class="ident" id="3204801">syscall</span><span class="op" id="3204808">.</span><span class="ident" id="3204809">AF_INET</span><span class="op" id="3204816">,</span>&nbsp;<span class="builtintype" id="3204818">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3204826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204830">return</span>&nbsp;<span class="ident" id="3204837">laddr</span><span class="op" id="3204842">.</span><span class="ident" id="3204843">family</span><span class="op" id="3204849">(</span><span class="op" id="3204850">)</span><span class="op" id="3204851">,</span>&nbsp;<span class="builtintype" id="3204853">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3204860">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204864">if</span>&nbsp;<span class="op" id="3204867">(</span><span class="ident" id="3204868">laddr</span>&nbsp;<span class="op" id="3204874">==</span>&nbsp;<span class="ident" id="3204877">nil</span>&nbsp;<span class="op" id="3204881">||</span>&nbsp;<span class="ident" id="3204884">laddr</span><span class="op" id="3204889">.</span><span class="ident" id="3204890">family</span><span class="op" id="3204896">(</span><span class="op" id="3204897">)</span>&nbsp;<span class="op" id="3204899">==</span>&nbsp;<span class="ident" id="3204902">syscall</span><span class="op" id="3204909">.</span><span class="ident" id="3204910">AF_INET</span><span class="op" id="3204917">)</span>&nbsp;<span class="op" id="3204919">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3204924">(</span><span class="ident" id="3204925">raddr</span>&nbsp;<span class="op" id="3204931">==</span>&nbsp;<span class="ident" id="3204934">nil</span>&nbsp;<span class="op" id="3204938">||</span>&nbsp;<span class="ident" id="3204941">raddr</span><span class="op" id="3204946">.</span><span class="ident" id="3204947">family</span><span class="op" id="3204953">(</span><span class="op" id="3204954">)</span>&nbsp;<span class="op" id="3204956">==</span>&nbsp;<span class="ident" id="3204959">syscall</span><span class="op" id="3204966">.</span><span class="ident" id="3204967">AF_INET</span><span class="op" id="3204974">)</span>&nbsp;<span class="op" id="3204976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3204980">return</span>&nbsp;<span class="ident" id="3204987">syscall</span><span class="op" id="3204994">.</span><span class="ident" id="3204995">AF_INET</span><span class="op" id="3205002">,</span>&nbsp;<span class="builtintype" id="3205004">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3205011">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3205014">return</span>&nbsp;<span class="ident" id="3205021">syscall</span><span class="op" id="3205028">.</span><span class="ident" id="3205029">AF_INET6</span><span class="op" id="3205037">,</span>&nbsp;<span class="builtintype" id="3205039">false</span><br>
<span class="lineno"></span><span class="op" id="3205045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3205048">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="3205084">func</span>&nbsp;<span class="ident" id="3205089">internetSocket</span><span class="op" id="3205103">(</span><span class="ident" id="3205104">net</span>&nbsp;<span class="builtintype" id="3205108">string</span><span class="op" id="3205114">,</span>&nbsp;<span class="ident" id="3205116">laddr</span><span class="op" id="3205121">,</span>&nbsp;<span class="ident" id="3205123">raddr</span>&nbsp;<span class="ident" id="3205129">sockaddr</span><span class="op" id="3205137">,</span>&nbsp;<span class="ident" id="3205139">deadline</span>&nbsp;<span class="ident" id="3205148">time</span><span class="op" id="3205152">.</span><span class="ident" id="3205153">Time</span><span class="op" id="3205157">,</span>&nbsp;<span class="ident" id="3205159">sotype</span><span class="op" id="3205165">,</span>&nbsp;<span class="ident" id="3205167">proto</span>&nbsp;<span class="builtintype" id="3205173">int</span><span class="op" id="3205176">,</span>&nbsp;<span class="ident" id="3205178">mode</span>&nbsp;<span class="builtintype" id="3205183">string</span><span class="op" id="3205189">)</span>&nbsp;<span class="op" id="3205191">(</span><span class="ident" id="3205192">fd</span>&nbsp;<span class="op" id="3205195">*</span><span class="ident" id="3205196">netFD</span><span class="op" id="3205201">,</span>&nbsp;<span class="ident" id="3205203">err</span>&nbsp;<span class="builtintype" id="3205207">error</span><span class="op" id="3205212">)</span>&nbsp;<span class="op" id="3205214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3205217">family</span><span class="op" id="3205223">,</span>&nbsp;<span class="ident" id="3205225">ipv6only</span>&nbsp;<span class="op" id="3205234">:=</span>&nbsp;<span class="ident" id="3205237">favoriteAddrFamily</span><span class="op" id="3205255">(</span><span class="ident" id="3205256">net</span><span class="op" id="3205259">,</span>&nbsp;<span class="ident" id="3205261">laddr</span><span class="op" id="3205266">,</span>&nbsp;<span class="ident" id="3205268">raddr</span><span class="op" id="3205273">,</span>&nbsp;<span class="ident" id="3205275">mode</span><span class="op" id="3205279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3205282">return</span>&nbsp;<span class="ident" id="3205289">socket</span><span class="op" id="3205295">(</span><span class="ident" id="3205296">net</span><span class="op" id="3205299">,</span>&nbsp;<span class="ident" id="3205301">family</span><span class="op" id="3205307">,</span>&nbsp;<span class="ident" id="3205309">sotype</span><span class="op" id="3205315">,</span>&nbsp;<span class="ident" id="3205317">proto</span><span class="op" id="3205322">,</span>&nbsp;<span class="ident" id="3205324">ipv6only</span><span class="op" id="3205332">,</span>&nbsp;<span class="ident" id="3205334">laddr</span><span class="op" id="3205339">,</span>&nbsp;<span class="ident" id="3205341">raddr</span><span class="op" id="3205346">,</span>&nbsp;<span class="ident" id="3205348">deadline</span><span class="op" id="3205356">)</span><br>
<span class="lineno"></span><span class="op" id="3205358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3205361">func</span>&nbsp;<span class="ident" id="3205366">ipToSockaddr</span><span class="op" id="3205378">(</span><span class="ident" id="3205379">family</span>&nbsp;<span class="builtintype" id="3205386">int</span><span class="op" id="3205389">,</span>&nbsp;<span class="ident" id="3205391">ip</span>&nbsp;<span class="ident" id="3205394">IP</span><span class="op" id="3205396">,</span>&nbsp;<span class="ident" id="3205398">port</span>&nbsp;<span class="builtintype" id="3205403">int</span><span class="op" id="3205406">,</span>&nbsp;<span class="ident" id="3205408">zone</span>&nbsp;<span class="builtintype" id="3205413">string</span><span class="op" id="3205419">)</span>&nbsp;<span class="op" id="3205421">(</span><span class="ident" id="3205422">syscall</span><span class="op" id="3205429">.</span><span class="ident" id="3205430">Sockaddr</span><span class="op" id="3205438">,</span>&nbsp;<span class="builtintype" id="3205440">error</span><span class="op" id="3205445">)</span>&nbsp;<span class="op" id="3205447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3205450">switch</span>&nbsp;<span class="ident" id="3205457">family</span>&nbsp;<span class="op" id="3205464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3205467">case</span>&nbsp;<span class="ident" id="3205472">syscall</span><span class="op" id="3205479">.</span><span class="ident" id="3205480">AF_INET</span><span class="op" id="3205487">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3205491">if</span>&nbsp;<span class="builtinfunc" id="3205494">len</span><span class="op" id="3205497">(</span><span class="ident" id="3205498">ip</span><span class="op" id="3205500">)</span>&nbsp;<span class="op" id="3205502">==</span>&nbsp;<span class="num" id="3205505">0</span>&nbsp;<span class="op" id="3205507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3205512">ip</span>&nbsp;<span class="op" id="3205515">=</span>&nbsp;<span class="ident" id="3205517">IPv4zero</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3205528">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3205532">if</span>&nbsp;<span class="ident" id="3205535">ip</span>&nbsp;<span class="op" id="3205538">=</span>&nbsp;<span class="ident" id="3205540">ip</span><span class="op" id="3205542">.</span><span class="ident" id="3205543">To4</span><span class="op" id="3205546">(</span><span class="op" id="3205547">)</span><span class="op" id="3205548">;</span>&nbsp;<span class="ident" id="3205550">ip</span>&nbsp;<span class="op" id="3205553">==</span>&nbsp;<span class="ident" id="3205556">nil</span>&nbsp;<span class="op" id="3205560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3205565">return</span>&nbsp;<span class="ident" id="3205572">nil</span><span class="op" id="3205575">,</span>&nbsp;<span class="ident" id="3205577">InvalidAddrError</span><span class="op" id="3205593">(</span><span class="string" id="3205594">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="3205612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3205616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3205620">sa</span>&nbsp;<span class="op" id="3205623">:=</span>&nbsp;<span class="builtinfunc" id="3205626">new</span><span class="op" id="3205629">(</span><span class="ident" id="3205630">syscall</span><span class="op" id="3205637">.</span><span class="ident" id="3205638">SockaddrInet4</span><span class="op" id="3205651">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3205655">for</span>&nbsp;<span class="ident" id="3205659">i</span>&nbsp;<span class="op" id="3205661">:=</span>&nbsp;<span class="num" id="3205664">0</span><span class="op" id="3205665">;</span>&nbsp;<span class="ident" id="3205667">i</span>&nbsp;<span class="op" id="3205669">&lt;</span>&nbsp;<span class="ident" id="3205671">IPv4len</span><span class="op" id="3205678">;</span>&nbsp;<span class="ident" id="3205680">i</span><span class="op" id="3205681">++</span>&nbsp;<span class="op" id="3205684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3205689">sa</span><span class="op" id="3205691">.</span><span class="ident" id="3205692">Addr</span><span class="op" id="3205696">[</span><span class="ident" id="3205697">i</span><span class="op" id="3205698">]</span>&nbsp;<span class="op" id="3205700">=</span>&nbsp;<span class="ident" id="3205702">ip</span><span class="op" id="3205704">[</span><span class="ident" id="3205705">i</span><span class="op" id="3205706">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3205710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3205714">sa</span><span class="op" id="3205716">.</span><span class="ident" id="3205717">Port</span>&nbsp;<span class="op" id="3205722">=</span>&nbsp;<span class="ident" id="3205724">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3205731">return</span>&nbsp;<span class="ident" id="3205738">sa</span><span class="op" id="3205740">,</span>&nbsp;<span class="ident" id="3205742">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3205747">case</span>&nbsp;<span class="ident" id="3205752">syscall</span><span class="op" id="3205759">.</span><span class="ident" id="3205760">AF_INET6</span><span class="op" id="3205768">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3205772">if</span>&nbsp;<span class="builtinfunc" id="3205775">len</span><span class="op" id="3205778">(</span><span class="ident" id="3205779">ip</span><span class="op" id="3205781">)</span>&nbsp;<span class="op" id="3205783">==</span>&nbsp;<span class="num" id="3205786">0</span>&nbsp;<span class="op" id="3205788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3205793">ip</span>&nbsp;<span class="op" id="3205796">=</span>&nbsp;<span class="ident" id="3205798">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3205809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3205813">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3205888">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3205959">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3206030">if</span>&nbsp;<span class="ident" id="3206033">ip</span><span class="op" id="3206035">.</span><span class="ident" id="3206036">Equal</span><span class="op" id="3206041">(</span><span class="ident" id="3206042">IPv4zero</span><span class="op" id="3206050">)</span>&nbsp;<span class="op" id="3206052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3206057">ip</span>&nbsp;<span class="op" id="3206060">=</span>&nbsp;<span class="ident" id="3206062">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3206073">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3206077">if</span>&nbsp;<span class="ident" id="3206080">ip</span>&nbsp;<span class="op" id="3206083">=</span>&nbsp;<span class="ident" id="3206085">ip</span><span class="op" id="3206087">.</span><span class="ident" id="3206088">To16</span><span class="op" id="3206092">(</span><span class="op" id="3206093">)</span><span class="op" id="3206094">;</span>&nbsp;<span class="ident" id="3206096">ip</span>&nbsp;<span class="op" id="3206099">==</span>&nbsp;<span class="ident" id="3206102">nil</span>&nbsp;<span class="op" id="3206106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3206111">return</span>&nbsp;<span class="ident" id="3206118">nil</span><span class="op" id="3206121">,</span>&nbsp;<span class="ident" id="3206123">InvalidAddrError</span><span class="op" id="3206139">(</span><span class="string" id="3206140">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="3206158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3206162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3206166">sa</span>&nbsp;<span class="op" id="3206169">:=</span>&nbsp;<span class="builtinfunc" id="3206172">new</span><span class="op" id="3206175">(</span><span class="ident" id="3206176">syscall</span><span class="op" id="3206183">.</span><span class="ident" id="3206184">SockaddrInet6</span><span class="op" id="3206197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3206201">for</span>&nbsp;<span class="ident" id="3206205">i</span>&nbsp;<span class="op" id="3206207">:=</span>&nbsp;<span class="num" id="3206210">0</span><span class="op" id="3206211">;</span>&nbsp;<span class="ident" id="3206213">i</span>&nbsp;<span class="op" id="3206215">&lt;</span>&nbsp;<span class="ident" id="3206217">IPv6len</span><span class="op" id="3206224">;</span>&nbsp;<span class="ident" id="3206226">i</span><span class="op" id="3206227">++</span>&nbsp;<span class="op" id="3206230">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3206235">sa</span><span class="op" id="3206237">.</span><span class="ident" id="3206238">Addr</span><span class="op" id="3206242">[</span><span class="ident" id="3206243">i</span><span class="op" id="3206244">]</span>&nbsp;<span class="op" id="3206246">=</span>&nbsp;<span class="ident" id="3206248">ip</span><span class="op" id="3206250">[</span><span class="ident" id="3206251">i</span><span class="op" id="3206252">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3206256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3206260">sa</span><span class="op" id="3206262">.</span><span class="ident" id="3206263">Port</span>&nbsp;<span class="op" id="3206268">=</span>&nbsp;<span class="ident" id="3206270">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3206277">sa</span><span class="op" id="3206279">.</span><span class="ident" id="3206280">ZoneId</span>&nbsp;<span class="op" id="3206287">=</span>&nbsp;<span class="builtintype" id="3206289">uint32</span><span class="op" id="3206295">(</span><span class="ident" id="3206296">zoneToInt</span><span class="op" id="3206305">(</span><span class="ident" id="3206306">zone</span><span class="op" id="3206310">)</span><span class="op" id="3206311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3206315">return</span>&nbsp;<span class="ident" id="3206322">sa</span><span class="op" id="3206324">,</span>&nbsp;<span class="ident" id="3206326">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3206331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3206334">return</span>&nbsp;<span class="ident" id="3206341">nil</span><span class="op" id="3206344">,</span>&nbsp;<span class="ident" id="3206346">InvalidAddrError</span><span class="op" id="3206362">(</span><span class="string" id="3206363">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="3206389">)</span><br>
<span class="lineno"></span><span class="op" id="3206391">}</span>
</div>
</body>
</html>
