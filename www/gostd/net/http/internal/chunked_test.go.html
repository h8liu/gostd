<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html" class="current">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7755306">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7755361">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7755415">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7755466">package</span>&nbsp;<span class="ident" id="7755474">internal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7755484">import</span>&nbsp;<span class="op" id="7755491">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7755494">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7755503">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7755512">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7755519">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7755525">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7755538">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7755549">&#34;testing&#34;</span><br>
<span class="lineno">15</span><span class="op" id="7755559">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7755562">func</span>&nbsp;<span class="ident" id="7755567">TestChunk</span><span class="op" id="7755576">(</span><span class="ident" id="7755577">t</span>&nbsp;<span class="op" id="7755579">*</span><span class="ident" id="7755580">testing</span><span class="op" id="7755587">.</span><span class="ident" id="7755588">T</span><span class="op" id="7755589">)</span>&nbsp;<span class="op" id="7755591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7755594">var</span>&nbsp;<span class="ident" id="7755598">b</span>&nbsp;<span class="ident" id="7755600">bytes</span><span class="op" id="7755605">.</span><span class="ident" id="7755606">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7755615">w</span>&nbsp;<span class="op" id="7755617">:=</span>&nbsp;<span class="ident" id="7755620">NewChunkedWriter</span><span class="op" id="7755636">(</span><span class="op" id="7755637">&amp;</span><span class="ident" id="7755638">b</span><span class="op" id="7755639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7755642">const</span>&nbsp;<span class="ident" id="7755648">chunk1</span>&nbsp;<span class="op" id="7755655">=</span>&nbsp;<span class="string" id="7755657">&#34;hello,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7755668">const</span>&nbsp;<span class="ident" id="7755674">chunk2</span>&nbsp;<span class="op" id="7755681">=</span>&nbsp;<span class="string" id="7755683">&#34;world!&nbsp;0123456789abcdef&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7755710">w</span><span class="op" id="7755711">.</span><span class="ident" id="7755712">Write</span><span class="op" id="7755717">(</span><span class="op" id="7755718">[</span><span class="op" id="7755719">]</span><span class="builtintype" id="7755720">byte</span><span class="op" id="7755724">(</span><span class="ident" id="7755725">chunk1</span><span class="op" id="7755731">)</span><span class="op" id="7755732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7755735">w</span><span class="op" id="7755736">.</span><span class="ident" id="7755737">Write</span><span class="op" id="7755742">(</span><span class="op" id="7755743">[</span><span class="op" id="7755744">]</span><span class="builtintype" id="7755745">byte</span><span class="op" id="7755749">(</span><span class="ident" id="7755750">chunk2</span><span class="op" id="7755756">)</span><span class="op" id="7755757">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7755760">w</span><span class="op" id="7755761">.</span><span class="ident" id="7755762">Close</span><span class="op" id="7755767">(</span><span class="op" id="7755768">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7755772">if</span>&nbsp;<span class="ident" id="7755775">g</span><span class="op" id="7755776">,</span>&nbsp;<span class="ident" id="7755778">e</span>&nbsp;<span class="op" id="7755780">:=</span>&nbsp;<span class="ident" id="7755783">b</span><span class="op" id="7755784">.</span><span class="ident" id="7755785">String</span><span class="op" id="7755791">(</span><span class="op" id="7755792">)</span><span class="op" id="7755793">,</span>&nbsp;<span class="string" id="7755795">&#34;7\r\nhello,&nbsp;\r\n17\r\nworld!&nbsp;0123456789abcdef\r\n0\r\n&#34;</span><span class="op" id="7755851">;</span>&nbsp;<span class="ident" id="7755853">g</span>&nbsp;<span class="op" id="7755855">!=</span>&nbsp;<span class="ident" id="7755858">e</span>&nbsp;<span class="op" id="7755860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7755864">t</span><span class="op" id="7755865">.</span><span class="ident" id="7755866">Fatalf</span><span class="op" id="7755872">(</span><span class="string" id="7755873">&#34;chunk&nbsp;writer&nbsp;wrote&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7755905">,</span>&nbsp;<span class="ident" id="7755907">g</span><span class="op" id="7755908">,</span>&nbsp;<span class="ident" id="7755910">e</span><span class="op" id="7755911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7755914">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7755918">r</span>&nbsp;<span class="op" id="7755920">:=</span>&nbsp;<span class="ident" id="7755923">NewChunkedReader</span><span class="op" id="7755939">(</span><span class="op" id="7755940">&amp;</span><span class="ident" id="7755941">b</span><span class="op" id="7755942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7755945">data</span><span class="op" id="7755949">,</span>&nbsp;<span class="ident" id="7755951">err</span>&nbsp;<span class="op" id="7755955">:=</span>&nbsp;<span class="ident" id="7755958">ioutil</span><span class="op" id="7755964">.</span><span class="ident" id="7755965">ReadAll</span><span class="op" id="7755972">(</span><span class="ident" id="7755973">r</span><span class="op" id="7755974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7755977">if</span>&nbsp;<span class="ident" id="7755980">err</span>&nbsp;<span class="op" id="7755984">!=</span>&nbsp;<span class="builtintype" id="7755987">nil</span>&nbsp;<span class="op" id="7755991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7755995">t</span><span class="op" id="7755996">.</span><span class="ident" id="7755997">Logf</span><span class="op" id="7756001">(</span><span class="string" id="7756002">`data:&nbsp;&#34;%s&#34;`</span><span class="op" id="7756014">,</span>&nbsp;<span class="ident" id="7756016">data</span><span class="op" id="7756020">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756024">t</span><span class="op" id="7756025">.</span><span class="ident" id="7756026">Fatalf</span><span class="op" id="7756032">(</span><span class="string" id="7756033">&#34;ReadAll&nbsp;from&nbsp;reader:&nbsp;%v&#34;</span><span class="op" id="7756058">,</span>&nbsp;<span class="ident" id="7756060">err</span><span class="op" id="7756063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7756066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7756069">if</span>&nbsp;<span class="ident" id="7756072">g</span><span class="op" id="7756073">,</span>&nbsp;<span class="ident" id="7756075">e</span>&nbsp;<span class="op" id="7756077">:=</span>&nbsp;<span class="builtintype" id="7756080">string</span><span class="op" id="7756086">(</span><span class="ident" id="7756087">data</span><span class="op" id="7756091">)</span><span class="op" id="7756092">,</span>&nbsp;<span class="ident" id="7756094">chunk1</span><span class="op" id="7756100">+</span><span class="ident" id="7756101">chunk2</span><span class="op" id="7756107">;</span>&nbsp;<span class="ident" id="7756109">g</span>&nbsp;<span class="op" id="7756111">!=</span>&nbsp;<span class="ident" id="7756114">e</span>&nbsp;<span class="op" id="7756116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756120">t</span><span class="op" id="7756121">.</span><span class="ident" id="7756122">Errorf</span><span class="op" id="7756128">(</span><span class="string" id="7756129">&#34;chunk&nbsp;reader&nbsp;read&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7756160">,</span>&nbsp;<span class="ident" id="7756162">g</span><span class="op" id="7756163">,</span>&nbsp;<span class="ident" id="7756165">e</span><span class="op" id="7756166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7756169">}</span><br>
<span class="lineno">40</span><span class="op" id="7756171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7756174">func</span>&nbsp;<span class="ident" id="7756179">TestChunkReadMultiple</span><span class="op" id="7756200">(</span><span class="ident" id="7756201">t</span>&nbsp;<span class="op" id="7756203">*</span><span class="ident" id="7756204">testing</span><span class="op" id="7756211">.</span><span class="ident" id="7756212">T</span><span class="op" id="7756213">)</span>&nbsp;<span class="op" id="7756215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7756218">//&nbsp;Bunch&nbsp;of&nbsp;small&nbsp;chunks,&nbsp;all&nbsp;read&nbsp;together.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7756264">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7756268">var</span>&nbsp;<span class="ident" id="7756272">b</span>&nbsp;<span class="ident" id="7756274">bytes</span><span class="op" id="7756279">.</span><span class="ident" id="7756280">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756289">w</span>&nbsp;<span class="op" id="7756291">:=</span>&nbsp;<span class="ident" id="7756294">NewChunkedWriter</span><span class="op" id="7756310">(</span><span class="op" id="7756311">&amp;</span><span class="ident" id="7756312">b</span><span class="op" id="7756313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756317">w</span><span class="op" id="7756318">.</span><span class="ident" id="7756319">Write</span><span class="op" id="7756324">(</span><span class="op" id="7756325">[</span><span class="op" id="7756326">]</span><span class="builtintype" id="7756327">byte</span><span class="op" id="7756331">(</span><span class="string" id="7756332">&#34;foo&#34;</span><span class="op" id="7756337">)</span><span class="op" id="7756338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756342">w</span><span class="op" id="7756343">.</span><span class="ident" id="7756344">Write</span><span class="op" id="7756349">(</span><span class="op" id="7756350">[</span><span class="op" id="7756351">]</span><span class="builtintype" id="7756352">byte</span><span class="op" id="7756356">(</span><span class="string" id="7756357">&#34;bar&#34;</span><span class="op" id="7756362">)</span><span class="op" id="7756363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756367">w</span><span class="op" id="7756368">.</span><span class="ident" id="7756369">Close</span><span class="op" id="7756374">(</span><span class="op" id="7756375">)</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756380">r</span>&nbsp;<span class="op" id="7756382">:=</span>&nbsp;<span class="ident" id="7756385">NewChunkedReader</span><span class="op" id="7756401">(</span><span class="op" id="7756402">&amp;</span><span class="ident" id="7756403">b</span><span class="op" id="7756404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756408">buf</span>&nbsp;<span class="op" id="7756412">:=</span>&nbsp;<span class="builtinfunc" id="7756415">make</span><span class="op" id="7756419">(</span><span class="op" id="7756420">[</span><span class="op" id="7756421">]</span><span class="builtintype" id="7756422">byte</span><span class="op" id="7756426">,</span>&nbsp;<span class="num" id="7756428">10</span><span class="op" id="7756430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756434">n</span><span class="op" id="7756435">,</span>&nbsp;<span class="ident" id="7756437">err</span>&nbsp;<span class="op" id="7756441">:=</span>&nbsp;<span class="ident" id="7756444">r</span><span class="op" id="7756445">.</span><span class="ident" id="7756446">Read</span><span class="op" id="7756450">(</span><span class="ident" id="7756451">buf</span><span class="op" id="7756454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7756458">if</span>&nbsp;<span class="ident" id="7756461">n</span>&nbsp;<span class="op" id="7756463">!=</span>&nbsp;<span class="num" id="7756466">6</span>&nbsp;<span class="op" id="7756468">||</span>&nbsp;<span class="ident" id="7756471">err</span>&nbsp;<span class="op" id="7756475">!=</span>&nbsp;<span class="ident" id="7756478">io</span><span class="op" id="7756480">.</span><span class="ident" id="7756481">EOF</span>&nbsp;<span class="op" id="7756485">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756490">t</span><span class="op" id="7756491">.</span><span class="ident" id="7756492">Errorf</span><span class="op" id="7756498">(</span><span class="string" id="7756499">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;6,&nbsp;EOF&#34;</span><span class="op" id="7756527">,</span>&nbsp;<span class="ident" id="7756529">n</span><span class="op" id="7756530">,</span>&nbsp;<span class="ident" id="7756532">err</span><span class="op" id="7756535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7756539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756543">buf</span>&nbsp;<span class="op" id="7756547">=</span>&nbsp;<span class="ident" id="7756549">buf</span><span class="op" id="7756552">[</span><span class="op" id="7756553">:</span><span class="ident" id="7756554">n</span><span class="op" id="7756555">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7756559">if</span>&nbsp;<span class="builtintype" id="7756562">string</span><span class="op" id="7756568">(</span><span class="ident" id="7756569">buf</span><span class="op" id="7756572">)</span>&nbsp;<span class="op" id="7756574">!=</span>&nbsp;<span class="string" id="7756577">&#34;foobar&#34;</span>&nbsp;<span class="op" id="7756586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756591">t</span><span class="op" id="7756592">.</span><span class="ident" id="7756593">Errorf</span><span class="op" id="7756599">(</span><span class="string" id="7756600">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7756620">,</span>&nbsp;<span class="ident" id="7756622">buf</span><span class="op" id="7756625">,</span>&nbsp;<span class="string" id="7756627">&#34;foobar&#34;</span><span class="op" id="7756635">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7756639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7756642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7756646">//&nbsp;One&nbsp;big&nbsp;chunk&nbsp;followed&nbsp;by&nbsp;a&nbsp;little&nbsp;chunk,&nbsp;but&nbsp;the&nbsp;small&nbsp;bufio.Reader&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7756724">//&nbsp;should&nbsp;prevent&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;from&nbsp;being&nbsp;read.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7756784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7756788">var</span>&nbsp;<span class="ident" id="7756792">b</span>&nbsp;<span class="ident" id="7756794">bytes</span><span class="op" id="7756799">.</span><span class="ident" id="7756800">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7756809">w</span>&nbsp;<span class="op" id="7756811">:=</span>&nbsp;<span class="ident" id="7756814">NewChunkedWriter</span><span class="op" id="7756830">(</span><span class="op" id="7756831">&amp;</span><span class="ident" id="7756832">b</span><span class="op" id="7756833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7756837">//&nbsp;fillBufChunk&nbsp;is&nbsp;11&nbsp;bytes&nbsp;+&nbsp;3&nbsp;bytes&nbsp;header&nbsp;+&nbsp;2&nbsp;bytes&nbsp;footer&nbsp;=&nbsp;16&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7756913">//&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;bufio&nbsp;ReaderSize&nbsp;below&nbsp;(the&nbsp;minimum),&nbsp;so&nbsp;even</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7756980">//&nbsp;though&nbsp;we&#39;re&nbsp;going&nbsp;to&nbsp;try&nbsp;to&nbsp;Read&nbsp;with&nbsp;a&nbsp;buffer&nbsp;larger&nbsp;enough&nbsp;to&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7757055">//&nbsp;receive&nbsp;&#34;foo&#34;,&nbsp;the&nbsp;second&nbsp;chunk&nbsp;header&nbsp;won&#39;t&nbsp;be&nbsp;read&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7757118">const</span>&nbsp;<span class="ident" id="7757124">fillBufChunk</span>&nbsp;<span class="op" id="7757137">=</span>&nbsp;<span class="string" id="7757139">&#34;0123456789a&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7757155">const</span>&nbsp;<span class="ident" id="7757161">shortChunk</span>&nbsp;<span class="op" id="7757172">=</span>&nbsp;<span class="string" id="7757174">&#34;foo&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757182">w</span><span class="op" id="7757183">.</span><span class="ident" id="7757184">Write</span><span class="op" id="7757189">(</span><span class="op" id="7757190">[</span><span class="op" id="7757191">]</span><span class="builtintype" id="7757192">byte</span><span class="op" id="7757196">(</span><span class="ident" id="7757197">fillBufChunk</span><span class="op" id="7757209">)</span><span class="op" id="7757210">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757214">w</span><span class="op" id="7757215">.</span><span class="ident" id="7757216">Write</span><span class="op" id="7757221">(</span><span class="op" id="7757222">[</span><span class="op" id="7757223">]</span><span class="builtintype" id="7757224">byte</span><span class="op" id="7757228">(</span><span class="ident" id="7757229">shortChunk</span><span class="op" id="7757239">)</span><span class="op" id="7757240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757244">w</span><span class="op" id="7757245">.</span><span class="ident" id="7757246">Close</span><span class="op" id="7757251">(</span><span class="op" id="7757252">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757257">r</span>&nbsp;<span class="op" id="7757259">:=</span>&nbsp;<span class="ident" id="7757262">NewChunkedReader</span><span class="op" id="7757278">(</span><span class="ident" id="7757279">bufio</span><span class="op" id="7757284">.</span><span class="ident" id="7757285">NewReaderSize</span><span class="op" id="7757298">(</span><span class="op" id="7757299">&amp;</span><span class="ident" id="7757300">b</span><span class="op" id="7757301">,</span>&nbsp;<span class="num" id="7757303">16</span><span class="op" id="7757305">)</span><span class="op" id="7757306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757310">buf</span>&nbsp;<span class="op" id="7757314">:=</span>&nbsp;<span class="builtinfunc" id="7757317">make</span><span class="op" id="7757321">(</span><span class="op" id="7757322">[</span><span class="op" id="7757323">]</span><span class="builtintype" id="7757324">byte</span><span class="op" id="7757328">,</span>&nbsp;<span class="builtinfunc" id="7757330">len</span><span class="op" id="7757333">(</span><span class="ident" id="7757334">fillBufChunk</span><span class="op" id="7757346">)</span><span class="op" id="7757347">+</span><span class="builtinfunc" id="7757348">len</span><span class="op" id="7757351">(</span><span class="ident" id="7757352">shortChunk</span><span class="op" id="7757362">)</span><span class="op" id="7757363">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757367">n</span><span class="op" id="7757368">,</span>&nbsp;<span class="ident" id="7757370">err</span>&nbsp;<span class="op" id="7757374">:=</span>&nbsp;<span class="ident" id="7757377">r</span><span class="op" id="7757378">.</span><span class="ident" id="7757379">Read</span><span class="op" id="7757383">(</span><span class="ident" id="7757384">buf</span><span class="op" id="7757387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7757391">if</span>&nbsp;<span class="ident" id="7757394">n</span>&nbsp;<span class="op" id="7757396">!=</span>&nbsp;<span class="builtinfunc" id="7757399">len</span><span class="op" id="7757402">(</span><span class="ident" id="7757403">fillBufChunk</span><span class="op" id="7757415">)</span>&nbsp;<span class="op" id="7757417">||</span>&nbsp;<span class="ident" id="7757420">err</span>&nbsp;<span class="op" id="7757424">!=</span>&nbsp;<span class="builtintype" id="7757427">nil</span>&nbsp;<span class="op" id="7757431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757436">t</span><span class="op" id="7757437">.</span><span class="ident" id="7757438">Errorf</span><span class="op" id="7757444">(</span><span class="string" id="7757445">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;nil&#34;</span><span class="op" id="7757474">,</span>&nbsp;<span class="ident" id="7757476">n</span><span class="op" id="7757477">,</span>&nbsp;<span class="ident" id="7757479">err</span><span class="op" id="7757482">,</span>&nbsp;<span class="builtinfunc" id="7757484">len</span><span class="op" id="7757487">(</span><span class="ident" id="7757488">fillBufChunk</span><span class="op" id="7757500">)</span><span class="op" id="7757501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7757505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757509">buf</span>&nbsp;<span class="op" id="7757513">=</span>&nbsp;<span class="ident" id="7757515">buf</span><span class="op" id="7757518">[</span><span class="op" id="7757519">:</span><span class="ident" id="7757520">n</span><span class="op" id="7757521">]</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7757525">if</span>&nbsp;<span class="builtintype" id="7757528">string</span><span class="op" id="7757534">(</span><span class="ident" id="7757535">buf</span><span class="op" id="7757538">)</span>&nbsp;<span class="op" id="7757540">!=</span>&nbsp;<span class="ident" id="7757543">fillBufChunk</span>&nbsp;<span class="op" id="7757556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757561">t</span><span class="op" id="7757562">.</span><span class="ident" id="7757563">Errorf</span><span class="op" id="7757569">(</span><span class="string" id="7757570">&#34;Read&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7757590">,</span>&nbsp;<span class="ident" id="7757592">buf</span><span class="op" id="7757595">,</span>&nbsp;<span class="ident" id="7757597">fillBufChunk</span><span class="op" id="7757609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7757613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757618">n</span><span class="op" id="7757619">,</span>&nbsp;<span class="ident" id="7757621">err</span>&nbsp;<span class="op" id="7757625">=</span>&nbsp;<span class="ident" id="7757627">r</span><span class="op" id="7757628">.</span><span class="ident" id="7757629">Read</span><span class="op" id="7757633">(</span><span class="ident" id="7757634">buf</span><span class="op" id="7757637">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7757641">if</span>&nbsp;<span class="ident" id="7757644">n</span>&nbsp;<span class="op" id="7757646">!=</span>&nbsp;<span class="builtinfunc" id="7757649">len</span><span class="op" id="7757652">(</span><span class="ident" id="7757653">shortChunk</span><span class="op" id="7757663">)</span>&nbsp;<span class="op" id="7757665">||</span>&nbsp;<span class="ident" id="7757668">err</span>&nbsp;<span class="op" id="7757672">!=</span>&nbsp;<span class="ident" id="7757675">io</span><span class="op" id="7757677">.</span><span class="ident" id="7757678">EOF</span>&nbsp;<span class="op" id="7757682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757687">t</span><span class="op" id="7757688">.</span><span class="ident" id="7757689">Errorf</span><span class="op" id="7757695">(</span><span class="string" id="7757696">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;%d,&nbsp;EOF&#34;</span><span class="op" id="7757725">,</span>&nbsp;<span class="ident" id="7757727">n</span><span class="op" id="7757728">,</span>&nbsp;<span class="ident" id="7757730">err</span><span class="op" id="7757733">,</span>&nbsp;<span class="builtinfunc" id="7757735">len</span><span class="op" id="7757738">(</span><span class="ident" id="7757739">shortChunk</span><span class="op" id="7757749">)</span><span class="op" id="7757750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7757754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7757757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7757761">//&nbsp;And&nbsp;test&nbsp;that&nbsp;we&nbsp;see&nbsp;an&nbsp;EOF&nbsp;chunk,&nbsp;even&nbsp;though&nbsp;our&nbsp;buffer&nbsp;is&nbsp;already&nbsp;full:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7757840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757844">r</span>&nbsp;<span class="op" id="7757846">:=</span>&nbsp;<span class="ident" id="7757849">NewChunkedReader</span><span class="op" id="7757865">(</span><span class="ident" id="7757866">bufio</span><span class="op" id="7757871">.</span><span class="ident" id="7757872">NewReader</span><span class="op" id="7757881">(</span><span class="ident" id="7757882">strings</span><span class="op" id="7757889">.</span><span class="ident" id="7757890">NewReader</span><span class="op" id="7757899">(</span><span class="string" id="7757900">&#34;3\r\nfoo\r\n0\r\n&#34;</span><span class="op" id="7757919">)</span><span class="op" id="7757920">)</span><span class="op" id="7757921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757925">buf</span>&nbsp;<span class="op" id="7757929">:=</span>&nbsp;<span class="builtinfunc" id="7757932">make</span><span class="op" id="7757936">(</span><span class="op" id="7757937">[</span><span class="op" id="7757938">]</span><span class="builtintype" id="7757939">byte</span><span class="op" id="7757943">,</span>&nbsp;<span class="num" id="7757945">3</span><span class="op" id="7757946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7757950">n</span><span class="op" id="7757951">,</span>&nbsp;<span class="ident" id="7757953">err</span>&nbsp;<span class="op" id="7757957">:=</span>&nbsp;<span class="ident" id="7757960">r</span><span class="op" id="7757961">.</span><span class="ident" id="7757962">Read</span><span class="op" id="7757966">(</span><span class="ident" id="7757967">buf</span><span class="op" id="7757970">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7757974">if</span>&nbsp;<span class="ident" id="7757977">n</span>&nbsp;<span class="op" id="7757979">!=</span>&nbsp;<span class="num" id="7757982">3</span>&nbsp;<span class="op" id="7757984">||</span>&nbsp;<span class="ident" id="7757987">err</span>&nbsp;<span class="op" id="7757991">!=</span>&nbsp;<span class="ident" id="7757994">io</span><span class="op" id="7757996">.</span><span class="ident" id="7757997">EOF</span>&nbsp;<span class="op" id="7758001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758006">t</span><span class="op" id="7758007">.</span><span class="ident" id="7758008">Errorf</span><span class="op" id="7758014">(</span><span class="string" id="7758015">&#34;Read&nbsp;=&nbsp;%d,&nbsp;%v;&nbsp;want&nbsp;3,&nbsp;EOF&#34;</span><span class="op" id="7758043">,</span>&nbsp;<span class="ident" id="7758045">n</span><span class="op" id="7758046">,</span>&nbsp;<span class="ident" id="7758048">err</span><span class="op" id="7758051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7758055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7758059">if</span>&nbsp;<span class="builtintype" id="7758062">string</span><span class="op" id="7758068">(</span><span class="ident" id="7758069">buf</span><span class="op" id="7758072">)</span>&nbsp;<span class="op" id="7758074">!=</span>&nbsp;<span class="string" id="7758077">&#34;foo&#34;</span>&nbsp;<span class="op" id="7758083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758088">t</span><span class="op" id="7758089">.</span><span class="ident" id="7758090">Errorf</span><span class="op" id="7758096">(</span><span class="string" id="7758097">&#34;buf&nbsp;=&nbsp;%q;&nbsp;want&nbsp;foo&#34;</span><span class="op" id="7758117">,</span>&nbsp;<span class="ident" id="7758119">buf</span><span class="op" id="7758122">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7758126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7758129">}</span><br>
<span class="lineno"></span><span class="op" id="7758131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7758134">func</span>&nbsp;<span class="ident" id="7758139">TestChunkReaderAllocs</span><span class="op" id="7758160">(</span><span class="ident" id="7758161">t</span>&nbsp;<span class="op" id="7758163">*</span><span class="ident" id="7758164">testing</span><span class="op" id="7758171">.</span><span class="ident" id="7758172">T</span><span class="op" id="7758173">)</span>&nbsp;<span class="op" id="7758175">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7758178">if</span>&nbsp;<span class="ident" id="7758181">testing</span><span class="op" id="7758188">.</span><span class="ident" id="7758189">Short</span><span class="op" id="7758194">(</span><span class="op" id="7758195">)</span>&nbsp;<span class="op" id="7758197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758201">t</span><span class="op" id="7758202">.</span><span class="ident" id="7758203">Skip</span><span class="op" id="7758207">(</span><span class="string" id="7758208">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7758232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7758235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7758238">var</span>&nbsp;<span class="ident" id="7758242">buf</span>&nbsp;<span class="ident" id="7758246">bytes</span><span class="op" id="7758251">.</span><span class="ident" id="7758252">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758260">w</span>&nbsp;<span class="op" id="7758262">:=</span>&nbsp;<span class="ident" id="7758265">NewChunkedWriter</span><span class="op" id="7758281">(</span><span class="op" id="7758282">&amp;</span><span class="ident" id="7758283">buf</span><span class="op" id="7758286">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758289">a</span><span class="op" id="7758290">,</span>&nbsp;<span class="ident" id="7758292">b</span><span class="op" id="7758293">,</span>&nbsp;<span class="ident" id="7758295">c</span>&nbsp;<span class="op" id="7758297">:=</span>&nbsp;<span class="op" id="7758300">[</span><span class="op" id="7758301">]</span><span class="builtintype" id="7758302">byte</span><span class="op" id="7758306">(</span><span class="string" id="7758307">&#34;aaaaaa&#34;</span><span class="op" id="7758315">)</span><span class="op" id="7758316">,</span>&nbsp;<span class="op" id="7758318">[</span><span class="op" id="7758319">]</span><span class="builtintype" id="7758320">byte</span><span class="op" id="7758324">(</span><span class="string" id="7758325">&#34;bbbbbbbbbbbb&#34;</span><span class="op" id="7758339">)</span><span class="op" id="7758340">,</span>&nbsp;<span class="op" id="7758342">[</span><span class="op" id="7758343">]</span><span class="builtintype" id="7758344">byte</span><span class="op" id="7758348">(</span><span class="string" id="7758349">&#34;cccccccccccccccccccccccc&#34;</span><span class="op" id="7758375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758378">w</span><span class="op" id="7758379">.</span><span class="ident" id="7758380">Write</span><span class="op" id="7758385">(</span><span class="ident" id="7758386">a</span><span class="op" id="7758387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758390">w</span><span class="op" id="7758391">.</span><span class="ident" id="7758392">Write</span><span class="op" id="7758397">(</span><span class="ident" id="7758398">b</span><span class="op" id="7758399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758402">w</span><span class="op" id="7758403">.</span><span class="ident" id="7758404">Write</span><span class="op" id="7758409">(</span><span class="ident" id="7758410">c</span><span class="op" id="7758411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758414">w</span><span class="op" id="7758415">.</span><span class="ident" id="7758416">Close</span><span class="op" id="7758421">(</span><span class="op" id="7758422">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758426">readBuf</span>&nbsp;<span class="op" id="7758434">:=</span>&nbsp;<span class="builtinfunc" id="7758437">make</span><span class="op" id="7758441">(</span><span class="op" id="7758442">[</span><span class="op" id="7758443">]</span><span class="builtintype" id="7758444">byte</span><span class="op" id="7758448">,</span>&nbsp;<span class="builtinfunc" id="7758450">len</span><span class="op" id="7758453">(</span><span class="ident" id="7758454">a</span><span class="op" id="7758455">)</span><span class="op" id="7758456">+</span><span class="builtinfunc" id="7758457">len</span><span class="op" id="7758460">(</span><span class="ident" id="7758461">b</span><span class="op" id="7758462">)</span><span class="op" id="7758463">+</span><span class="builtinfunc" id="7758464">len</span><span class="op" id="7758467">(</span><span class="ident" id="7758468">c</span><span class="op" id="7758469">)</span><span class="op" id="7758470">+</span><span class="num" id="7758471">1</span><span class="op" id="7758472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758475">byter</span>&nbsp;<span class="op" id="7758481">:=</span>&nbsp;<span class="ident" id="7758484">bytes</span><span class="op" id="7758489">.</span><span class="ident" id="7758490">NewReader</span><span class="op" id="7758499">(</span><span class="ident" id="7758500">buf</span><span class="op" id="7758503">.</span><span class="ident" id="7758504">Bytes</span><span class="op" id="7758509">(</span><span class="op" id="7758510">)</span><span class="op" id="7758511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758514">bufr</span>&nbsp;<span class="op" id="7758519">:=</span>&nbsp;<span class="ident" id="7758522">bufio</span><span class="op" id="7758527">.</span><span class="ident" id="7758528">NewReader</span><span class="op" id="7758537">(</span><span class="ident" id="7758538">byter</span><span class="op" id="7758543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758546">mallocs</span>&nbsp;<span class="op" id="7758554">:=</span>&nbsp;<span class="ident" id="7758557">testing</span><span class="op" id="7758564">.</span><span class="ident" id="7758565">AllocsPerRun</span><span class="op" id="7758577">(</span><span class="num" id="7758578">100</span><span class="op" id="7758581">,</span>&nbsp;<span class="keyword" id="7758583">func</span><span class="op" id="7758587">(</span><span class="op" id="7758588">)</span>&nbsp;<span class="op" id="7758590">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758594">byter</span><span class="op" id="7758599">.</span><span class="ident" id="7758600">Seek</span><span class="op" id="7758604">(</span><span class="num" id="7758605">0</span><span class="op" id="7758606">,</span>&nbsp;<span class="num" id="7758608">0</span><span class="op" id="7758609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758613">bufr</span><span class="op" id="7758617">.</span><span class="ident" id="7758618">Reset</span><span class="op" id="7758623">(</span><span class="ident" id="7758624">byter</span><span class="op" id="7758629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758633">r</span>&nbsp;<span class="op" id="7758635">:=</span>&nbsp;<span class="ident" id="7758638">NewChunkedReader</span><span class="op" id="7758654">(</span><span class="ident" id="7758655">bufr</span><span class="op" id="7758659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758663">n</span><span class="op" id="7758664">,</span>&nbsp;<span class="ident" id="7758666">err</span>&nbsp;<span class="op" id="7758670">:=</span>&nbsp;<span class="ident" id="7758673">io</span><span class="op" id="7758675">.</span><span class="ident" id="7758676">ReadFull</span><span class="op" id="7758684">(</span><span class="ident" id="7758685">r</span><span class="op" id="7758686">,</span>&nbsp;<span class="ident" id="7758688">readBuf</span><span class="op" id="7758695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7758699">if</span>&nbsp;<span class="ident" id="7758702">n</span>&nbsp;<span class="op" id="7758704">!=</span>&nbsp;<span class="builtinfunc" id="7758707">len</span><span class="op" id="7758710">(</span><span class="ident" id="7758711">readBuf</span><span class="op" id="7758718">)</span><span class="op" id="7758719">-</span><span class="num" id="7758720">1</span>&nbsp;<span class="op" id="7758722">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758727">t</span><span class="op" id="7758728">.</span><span class="ident" id="7758729">Fatalf</span><span class="op" id="7758735">(</span><span class="string" id="7758736">&#34;read&nbsp;%d&nbsp;bytes;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7758760">,</span>&nbsp;<span class="ident" id="7758762">n</span><span class="op" id="7758763">,</span>&nbsp;<span class="builtinfunc" id="7758765">len</span><span class="op" id="7758768">(</span><span class="ident" id="7758769">readBuf</span><span class="op" id="7758776">)</span><span class="op" id="7758777">-</span><span class="num" id="7758778">1</span><span class="op" id="7758779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7758783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7758787">if</span>&nbsp;<span class="ident" id="7758790">err</span>&nbsp;<span class="op" id="7758794">!=</span>&nbsp;<span class="ident" id="7758797">io</span><span class="op" id="7758799">.</span><span class="ident" id="7758800">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="7758817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758822">t</span><span class="op" id="7758823">.</span><span class="ident" id="7758824">Fatalf</span><span class="op" id="7758830">(</span><span class="string" id="7758831">&#34;read&nbsp;error&nbsp;=&nbsp;%v;&nbsp;want&nbsp;ErrUnexpectedEOF&#34;</span><span class="op" id="7758871">,</span>&nbsp;<span class="ident" id="7758873">err</span><span class="op" id="7758876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7758880">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7758883">}</span><span class="op" id="7758884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7758887">if</span>&nbsp;<span class="ident" id="7758890">mallocs</span>&nbsp;<span class="op" id="7758898">&gt;</span>&nbsp;<span class="num" id="7758900">1.5</span>&nbsp;<span class="op" id="7758904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7758908">t</span><span class="op" id="7758909">.</span><span class="ident" id="7758910">Errorf</span><span class="op" id="7758916">(</span><span class="string" id="7758917">&#34;mallocs&nbsp;=&nbsp;%v;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7758939">,</span>&nbsp;<span class="ident" id="7758941">mallocs</span><span class="op" id="7758948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7758951">}</span><br>
<span class="lineno"></span><span class="op" id="7758953">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="7758956">func</span>&nbsp;<span class="ident" id="7758961">TestParseHexUint</span><span class="op" id="7758977">(</span><span class="ident" id="7758978">t</span>&nbsp;<span class="op" id="7758980">*</span><span class="ident" id="7758981">testing</span><span class="op" id="7758988">.</span><span class="ident" id="7758989">T</span><span class="op" id="7758990">)</span>&nbsp;<span class="op" id="7758992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7758995">for</span>&nbsp;<span class="ident" id="7758999">i</span>&nbsp;<span class="op" id="7759001">:=</span>&nbsp;<span class="ident" id="7759004">uint64</span><span class="op" id="7759010">(</span><span class="num" id="7759011">0</span><span class="op" id="7759012">)</span><span class="op" id="7759013">;</span>&nbsp;<span class="ident" id="7759015">i</span>&nbsp;<span class="op" id="7759017">&lt;=</span>&nbsp;<span class="num" id="7759020">1234</span><span class="op" id="7759024">;</span>&nbsp;<span class="ident" id="7759026">i</span><span class="op" id="7759027">++</span>&nbsp;<span class="op" id="7759030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7759034">line</span>&nbsp;<span class="op" id="7759039">:=</span>&nbsp;<span class="op" id="7759042">[</span><span class="op" id="7759043">]</span><span class="builtintype" id="7759044">byte</span><span class="op" id="7759048">(</span><span class="ident" id="7759049">fmt</span><span class="op" id="7759052">.</span><span class="ident" id="7759053">Sprintf</span><span class="op" id="7759060">(</span><span class="string" id="7759061">&#34;%x&#34;</span><span class="op" id="7759065">,</span>&nbsp;<span class="ident" id="7759067">i</span><span class="op" id="7759068">)</span><span class="op" id="7759069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7759073">got</span><span class="op" id="7759076">,</span>&nbsp;<span class="ident" id="7759078">err</span>&nbsp;<span class="op" id="7759082">:=</span>&nbsp;<span class="ident" id="7759085">parseHexUint</span><span class="op" id="7759097">(</span><span class="ident" id="7759098">line</span><span class="op" id="7759102">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7759106">if</span>&nbsp;<span class="ident" id="7759109">err</span>&nbsp;<span class="op" id="7759113">!=</span>&nbsp;<span class="builtintype" id="7759116">nil</span>&nbsp;<span class="op" id="7759120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7759125">t</span><span class="op" id="7759126">.</span><span class="ident" id="7759127">Fatalf</span><span class="op" id="7759133">(</span><span class="string" id="7759134">&#34;on&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="7759145">,</span>&nbsp;<span class="ident" id="7759147">i</span><span class="op" id="7759148">,</span>&nbsp;<span class="ident" id="7759150">err</span><span class="op" id="7759153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7759157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7759161">if</span>&nbsp;<span class="ident" id="7759164">got</span>&nbsp;<span class="op" id="7759168">!=</span>&nbsp;<span class="ident" id="7759171">i</span>&nbsp;<span class="op" id="7759173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7759178">t</span><span class="op" id="7759179">.</span><span class="ident" id="7759180">Errorf</span><span class="op" id="7759186">(</span><span class="string" id="7759187">&#34;for&nbsp;input&nbsp;%q&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7759215">,</span>&nbsp;<span class="ident" id="7759217">line</span><span class="op" id="7759221">,</span>&nbsp;<span class="ident" id="7759223">got</span><span class="op" id="7759226">,</span>&nbsp;<span class="ident" id="7759228">i</span><span class="op" id="7759229">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7759233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7759236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7759239">_</span><span class="op" id="7759240">,</span>&nbsp;<span class="ident" id="7759242">err</span>&nbsp;<span class="op" id="7759246">:=</span>&nbsp;<span class="ident" id="7759249">parseHexUint</span><span class="op" id="7759261">(</span><span class="op" id="7759262">[</span><span class="op" id="7759263">]</span><span class="builtintype" id="7759264">byte</span><span class="op" id="7759268">(</span><span class="string" id="7759269">&#34;bogus&#34;</span><span class="op" id="7759276">)</span><span class="op" id="7759277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7759280">if</span>&nbsp;<span class="ident" id="7759283">err</span>&nbsp;<span class="op" id="7759287">==</span>&nbsp;<span class="builtintype" id="7759290">nil</span>&nbsp;<span class="op" id="7759294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7759298">t</span><span class="op" id="7759299">.</span><span class="ident" id="7759300">Error</span><span class="op" id="7759305">(</span><span class="string" id="7759306">&#34;expected&nbsp;error&nbsp;on&nbsp;bogus&nbsp;input&#34;</span><span class="op" id="7759337">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7759340">}</span><br>
<span class="lineno"></span><span class="op" id="7759342">}</span>
</div>
</body>
</html>
