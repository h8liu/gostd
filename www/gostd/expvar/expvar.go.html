<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>expvar</h2>
<ul>
<li><a href="/gostd/expvar/expvar.go.html">expvar.go</a></li>
<li><a href="/gostd/expvar/expvar_test.go.html">expvar_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5146413">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5146468">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5146522">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5146573">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="5146651">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5146727">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5146758">//</span><br>
<span class="lineno"></span><span class="comment" id="5146761">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="5146827">//</span><br>
<span class="lineno"></span><span class="comment" id="5146830">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5146900">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="5146924">//</span><br>
<span class="lineno"></span><span class="comment" id="5146927">//&nbsp;&nbsp;&nbsp;&nbspcmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="5146948">//&nbsp;&nbsp;&nbsp;&nbspmemstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="5146978">//</span><br>
<span class="lineno"></span><span class="comment" id="5146981">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5147046">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5147114">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="5147164">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5147185">//</span><br>
<span class="lineno"></span><span class="keyword" id="5147188">package</span>&nbsp;<span class="ident" id="5147196">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5147204">import</span>&nbsp;<span class="op" id="5147211">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5147214">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5147223">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5147240">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5147247">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5147254">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5147266">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5147272">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5147283">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5147291">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5147302">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="5147309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5147312">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5147367">type</span>&nbsp;<span class="ident" id="5147372">Var</span>&nbsp;<span class="keyword" id="5147376">interface</span>&nbsp;<span class="op" id="5147386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147389">String</span><span class="op" id="5147395">(</span><span class="op" id="5147396">)</span>&nbsp;<span class="builtintype" id="5147398">string</span><br>
<span class="lineno">40</span><span class="op" id="5147405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5147408">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5147478">type</span>&nbsp;<span class="ident" id="5147483">Int</span>&nbsp;<span class="keyword" id="5147487">struct</span>&nbsp;<span class="op" id="5147494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147497">mu</span>&nbsp;<span class="ident" id="5147500">sync</span><span class="op" id="5147504">.</span><span class="ident" id="5147505">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147514">i</span>&nbsp;&nbsp;<span class="ident" id="5147517">int64</span><br>
<span class="lineno"></span><span class="op" id="5147523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5147526">func</span>&nbsp;<span class="op" id="5147531">(</span><span class="ident" id="5147532">v</span>&nbsp;<span class="op" id="5147534">*</span><span class="ident" id="5147535">Int</span><span class="op" id="5147538">)</span>&nbsp;<span class="ident" id="5147540">String</span><span class="op" id="5147546">(</span><span class="op" id="5147547">)</span>&nbsp;<span class="builtintype" id="5147549">string</span>&nbsp;<span class="op" id="5147556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147559">v</span><span class="op" id="5147560">.</span><span class="ident" id="5147561">mu</span><span class="op" id="5147563">.</span><span class="ident" id="5147564">RLock</span><span class="op" id="5147569">(</span><span class="op" id="5147570">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147573">defer</span>&nbsp;<span class="ident" id="5147579">v</span><span class="op" id="5147580">.</span><span class="ident" id="5147581">mu</span><span class="op" id="5147583">.</span><span class="ident" id="5147584">RUnlock</span><span class="op" id="5147591">(</span><span class="op" id="5147592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147595">return</span>&nbsp;<span class="ident" id="5147602">strconv</span><span class="op" id="5147609">.</span><span class="ident" id="5147610">FormatInt</span><span class="op" id="5147619">(</span><span class="ident" id="5147620">v</span><span class="op" id="5147621">.</span><span class="ident" id="5147622">i</span><span class="op" id="5147623">,</span>&nbsp;<span class="num" id="5147625">10</span><span class="op" id="5147627">)</span><br>
<span class="lineno"></span><span class="op" id="5147629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5147632">func</span>&nbsp;<span class="op" id="5147637">(</span><span class="ident" id="5147638">v</span>&nbsp;<span class="op" id="5147640">*</span><span class="ident" id="5147641">Int</span><span class="op" id="5147644">)</span>&nbsp;<span class="ident" id="5147646">Add</span><span class="op" id="5147649">(</span><span class="ident" id="5147650">delta</span>&nbsp;<span class="ident" id="5147656">int64</span><span class="op" id="5147661">)</span>&nbsp;<span class="op" id="5147663">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147666">v</span><span class="op" id="5147667">.</span><span class="ident" id="5147668">mu</span><span class="op" id="5147670">.</span><span class="ident" id="5147671">Lock</span><span class="op" id="5147675">(</span><span class="op" id="5147676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147679">defer</span>&nbsp;<span class="ident" id="5147685">v</span><span class="op" id="5147686">.</span><span class="ident" id="5147687">mu</span><span class="op" id="5147689">.</span><span class="ident" id="5147690">Unlock</span><span class="op" id="5147696">(</span><span class="op" id="5147697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147700">v</span><span class="op" id="5147701">.</span><span class="ident" id="5147702">i</span>&nbsp;<span class="op" id="5147704">+=</span>&nbsp;<span class="ident" id="5147707">delta</span><br>
<span class="lineno"></span><span class="op" id="5147713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5147716">func</span>&nbsp;<span class="op" id="5147721">(</span><span class="ident" id="5147722">v</span>&nbsp;<span class="op" id="5147724">*</span><span class="ident" id="5147725">Int</span><span class="op" id="5147728">)</span>&nbsp;<span class="ident" id="5147730">Set</span><span class="op" id="5147733">(</span><span class="ident" id="5147734">value</span>&nbsp;<span class="ident" id="5147740">int64</span><span class="op" id="5147745">)</span>&nbsp;<span class="op" id="5147747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147750">v</span><span class="op" id="5147751">.</span><span class="ident" id="5147752">mu</span><span class="op" id="5147754">.</span><span class="ident" id="5147755">Lock</span><span class="op" id="5147759">(</span><span class="op" id="5147760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147763">defer</span>&nbsp;<span class="ident" id="5147769">v</span><span class="op" id="5147770">.</span><span class="ident" id="5147771">mu</span><span class="op" id="5147773">.</span><span class="ident" id="5147774">Unlock</span><span class="op" id="5147780">(</span><span class="op" id="5147781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147784">v</span><span class="op" id="5147785">.</span><span class="ident" id="5147786">i</span>&nbsp;<span class="op" id="5147788">=</span>&nbsp;<span class="ident" id="5147790">value</span><br>
<span class="lineno"></span><span class="op" id="5147796">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="5147799">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5147869">type</span>&nbsp;<span class="ident" id="5147874">Float</span>&nbsp;<span class="keyword" id="5147880">struct</span>&nbsp;<span class="op" id="5147887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147890">mu</span>&nbsp;<span class="ident" id="5147893">sync</span><span class="op" id="5147897">.</span><span class="ident" id="5147898">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147907">f</span>&nbsp;&nbsp;<span class="builtintype" id="5147910">float64</span><br>
<span class="lineno">70</span><span class="op" id="5147918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5147921">func</span>&nbsp;<span class="op" id="5147926">(</span><span class="ident" id="5147927">v</span>&nbsp;<span class="op" id="5147929">*</span><span class="ident" id="5147930">Float</span><span class="op" id="5147935">)</span>&nbsp;<span class="ident" id="5147937">String</span><span class="op" id="5147943">(</span><span class="op" id="5147944">)</span>&nbsp;<span class="builtintype" id="5147946">string</span>&nbsp;<span class="op" id="5147953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5147956">v</span><span class="op" id="5147957">.</span><span class="ident" id="5147958">mu</span><span class="op" id="5147960">.</span><span class="ident" id="5147961">RLock</span><span class="op" id="5147966">(</span><span class="op" id="5147967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147970">defer</span>&nbsp;<span class="ident" id="5147976">v</span><span class="op" id="5147977">.</span><span class="ident" id="5147978">mu</span><span class="op" id="5147980">.</span><span class="ident" id="5147981">RUnlock</span><span class="op" id="5147988">(</span><span class="op" id="5147989">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147992">return</span>&nbsp;<span class="ident" id="5147999">strconv</span><span class="op" id="5148006">.</span><span class="ident" id="5148007">FormatFloat</span><span class="op" id="5148018">(</span><span class="ident" id="5148019">v</span><span class="op" id="5148020">.</span><span class="ident" id="5148021">f</span><span class="op" id="5148022">,</span>&nbsp;<span class="string" id="5148024">&#39;g&#39;</span><span class="op" id="5148027">,</span>&nbsp;<span class="op" id="5148029">-</span><span class="num" id="5148030">1</span><span class="op" id="5148031">,</span>&nbsp;<span class="num" id="5148033">64</span><span class="op" id="5148035">)</span><br>
<span class="lineno"></span><span class="op" id="5148037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5148040">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5148064">func</span>&nbsp;<span class="op" id="5148069">(</span><span class="ident" id="5148070">v</span>&nbsp;<span class="op" id="5148072">*</span><span class="ident" id="5148073">Float</span><span class="op" id="5148078">)</span>&nbsp;<span class="ident" id="5148080">Add</span><span class="op" id="5148083">(</span><span class="ident" id="5148084">delta</span>&nbsp;<span class="builtintype" id="5148090">float64</span><span class="op" id="5148097">)</span>&nbsp;<span class="op" id="5148099">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148102">v</span><span class="op" id="5148103">.</span><span class="ident" id="5148104">mu</span><span class="op" id="5148106">.</span><span class="ident" id="5148107">Lock</span><span class="op" id="5148111">(</span><span class="op" id="5148112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148115">defer</span>&nbsp;<span class="ident" id="5148121">v</span><span class="op" id="5148122">.</span><span class="ident" id="5148123">mu</span><span class="op" id="5148125">.</span><span class="ident" id="5148126">Unlock</span><span class="op" id="5148132">(</span><span class="op" id="5148133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148136">v</span><span class="op" id="5148137">.</span><span class="ident" id="5148138">f</span>&nbsp;<span class="op" id="5148140">+=</span>&nbsp;<span class="ident" id="5148143">delta</span><br>
<span class="lineno"></span><span class="op" id="5148149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="5148152">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5148176">func</span>&nbsp;<span class="op" id="5148181">(</span><span class="ident" id="5148182">v</span>&nbsp;<span class="op" id="5148184">*</span><span class="ident" id="5148185">Float</span><span class="op" id="5148190">)</span>&nbsp;<span class="ident" id="5148192">Set</span><span class="op" id="5148195">(</span><span class="ident" id="5148196">value</span>&nbsp;<span class="builtintype" id="5148202">float64</span><span class="op" id="5148209">)</span>&nbsp;<span class="op" id="5148211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148214">v</span><span class="op" id="5148215">.</span><span class="ident" id="5148216">mu</span><span class="op" id="5148218">.</span><span class="ident" id="5148219">Lock</span><span class="op" id="5148223">(</span><span class="op" id="5148224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148227">defer</span>&nbsp;<span class="ident" id="5148233">v</span><span class="op" id="5148234">.</span><span class="ident" id="5148235">mu</span><span class="op" id="5148237">.</span><span class="ident" id="5148238">Unlock</span><span class="op" id="5148244">(</span><span class="op" id="5148245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148248">v</span><span class="op" id="5148249">.</span><span class="ident" id="5148250">f</span>&nbsp;<span class="op" id="5148252">=</span>&nbsp;<span class="ident" id="5148254">value</span><br>
<span class="lineno">90</span><span class="op" id="5148260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5148263">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5148336">type</span>&nbsp;<span class="ident" id="5148341">Map</span>&nbsp;<span class="keyword" id="5148345">struct</span>&nbsp;<span class="op" id="5148352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148355">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5148360">sync</span><span class="op" id="5148364">.</span><span class="ident" id="5148365">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148374">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5148379">map</span><span class="op" id="5148382">[</span><span class="builtintype" id="5148383">string</span><span class="op" id="5148389">]</span><span class="ident" id="5148390">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148395">keys</span>&nbsp;<span class="op" id="5148400">[</span><span class="op" id="5148401">]</span><span class="builtintype" id="5148402">string</span>&nbsp;<span class="comment" id="5148409">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5148419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5148422">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="5148470">type</span>&nbsp;<span class="ident" id="5148475">KeyValue</span>&nbsp;<span class="keyword" id="5148484">struct</span>&nbsp;<span class="op" id="5148491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148494">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5148500">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148508">Value</span>&nbsp;<span class="ident" id="5148514">Var</span><br>
<span class="lineno"></span><span class="op" id="5148518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="5148521">func</span>&nbsp;<span class="op" id="5148526">(</span><span class="ident" id="5148527">v</span>&nbsp;<span class="op" id="5148529">*</span><span class="ident" id="5148530">Map</span><span class="op" id="5148533">)</span>&nbsp;<span class="ident" id="5148535">String</span><span class="op" id="5148541">(</span><span class="op" id="5148542">)</span>&nbsp;<span class="builtintype" id="5148544">string</span>&nbsp;<span class="op" id="5148551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148554">v</span><span class="op" id="5148555">.</span><span class="ident" id="5148556">mu</span><span class="op" id="5148558">.</span><span class="ident" id="5148559">RLock</span><span class="op" id="5148564">(</span><span class="op" id="5148565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148568">defer</span>&nbsp;<span class="ident" id="5148574">v</span><span class="op" id="5148575">.</span><span class="ident" id="5148576">mu</span><span class="op" id="5148578">.</span><span class="ident" id="5148579">RUnlock</span><span class="op" id="5148586">(</span><span class="op" id="5148587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148590">var</span>&nbsp;<span class="ident" id="5148594">b</span>&nbsp;<span class="ident" id="5148596">bytes</span><span class="op" id="5148601">.</span><span class="ident" id="5148602">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148610">fmt</span><span class="op" id="5148613">.</span><span class="ident" id="5148614">Fprintf</span><span class="op" id="5148621">(</span><span class="op" id="5148622">&amp;</span><span class="ident" id="5148623">b</span><span class="op" id="5148624">,</span>&nbsp;<span class="string" id="5148626">&#34;{&#34;</span><span class="op" id="5148629">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148632">first</span>&nbsp;<span class="op" id="5148638">:=</span>&nbsp;<span class="builtintype" id="5148641">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148647">v</span><span class="op" id="5148648">.</span><span class="ident" id="5148649">doLocked</span><span class="op" id="5148657">(</span><span class="keyword" id="5148658">func</span><span class="op" id="5148662">(</span><span class="ident" id="5148663">kv</span>&nbsp;<span class="ident" id="5148666">KeyValue</span><span class="op" id="5148674">)</span>&nbsp;<span class="op" id="5148676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148680">if</span>&nbsp;<span class="op" id="5148683">!</span><span class="ident" id="5148684">first</span>&nbsp;<span class="op" id="5148690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148695">fmt</span><span class="op" id="5148698">.</span><span class="ident" id="5148699">Fprintf</span><span class="op" id="5148706">(</span><span class="op" id="5148707">&amp;</span><span class="ident" id="5148708">b</span><span class="op" id="5148709">,</span>&nbsp;<span class="string" id="5148711">&#34;,&nbsp;&#34;</span><span class="op" id="5148715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5148719">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148723">fmt</span><span class="op" id="5148726">.</span><span class="ident" id="5148727">Fprintf</span><span class="op" id="5148734">(</span><span class="op" id="5148735">&amp;</span><span class="ident" id="5148736">b</span><span class="op" id="5148737">,</span>&nbsp;<span class="string" id="5148739">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="5148747">,</span>&nbsp;<span class="ident" id="5148749">kv</span><span class="op" id="5148751">.</span><span class="ident" id="5148752">Key</span><span class="op" id="5148755">,</span>&nbsp;<span class="ident" id="5148757">kv</span><span class="op" id="5148759">.</span><span class="ident" id="5148760">Value</span><span class="op" id="5148765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148769">first</span>&nbsp;<span class="op" id="5148775">=</span>&nbsp;<span class="builtintype" id="5148777">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5148784">}</span><span class="op" id="5148785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148788">fmt</span><span class="op" id="5148791">.</span><span class="ident" id="5148792">Fprintf</span><span class="op" id="5148799">(</span><span class="op" id="5148800">&amp;</span><span class="ident" id="5148801">b</span><span class="op" id="5148802">,</span>&nbsp;<span class="string" id="5148804">&#34;}&#34;</span><span class="op" id="5148807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148810">return</span>&nbsp;<span class="ident" id="5148817">b</span><span class="op" id="5148818">.</span><span class="ident" id="5148819">String</span><span class="op" id="5148825">(</span><span class="op" id="5148826">)</span><br>
<span class="lineno">120</span><span class="op" id="5148828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5148831">func</span>&nbsp;<span class="op" id="5148836">(</span><span class="ident" id="5148837">v</span>&nbsp;<span class="op" id="5148839">*</span><span class="ident" id="5148840">Map</span><span class="op" id="5148843">)</span>&nbsp;<span class="ident" id="5148845">Init</span><span class="op" id="5148849">(</span><span class="op" id="5148850">)</span>&nbsp;<span class="op" id="5148852">*</span><span class="ident" id="5148853">Map</span>&nbsp;<span class="op" id="5148857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148860">v</span><span class="op" id="5148861">.</span><span class="ident" id="5148862">m</span>&nbsp;<span class="op" id="5148864">=</span>&nbsp;<span class="builtinfunc" id="5148866">make</span><span class="op" id="5148870">(</span><span class="keyword" id="5148871">map</span><span class="op" id="5148874">[</span><span class="builtintype" id="5148875">string</span><span class="op" id="5148881">]</span><span class="ident" id="5148882">Var</span><span class="op" id="5148885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148888">return</span>&nbsp;<span class="ident" id="5148895">v</span><br>
<span class="lineno">125</span><span class="op" id="5148897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5148900">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="5148957">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5148991">func</span>&nbsp;<span class="op" id="5148996">(</span><span class="ident" id="5148997">v</span>&nbsp;<span class="op" id="5148999">*</span><span class="ident" id="5149000">Map</span><span class="op" id="5149003">)</span>&nbsp;<span class="ident" id="5149005">updateKeys</span><span class="op" id="5149015">(</span><span class="op" id="5149016">)</span>&nbsp;<span class="op" id="5149018">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149021">if</span>&nbsp;<span class="builtinfunc" id="5149024">len</span><span class="op" id="5149027">(</span><span class="ident" id="5149028">v</span><span class="op" id="5149029">.</span><span class="ident" id="5149030">m</span><span class="op" id="5149031">)</span>&nbsp;<span class="op" id="5149033">==</span>&nbsp;<span class="builtinfunc" id="5149036">len</span><span class="op" id="5149039">(</span><span class="ident" id="5149040">v</span><span class="op" id="5149041">.</span><span class="ident" id="5149042">keys</span><span class="op" id="5149046">)</span>&nbsp;<span class="op" id="5149048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5149052">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149069">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5149077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149080">v</span><span class="op" id="5149081">.</span><span class="ident" id="5149082">keys</span>&nbsp;<span class="op" id="5149087">=</span>&nbsp;<span class="ident" id="5149089">v</span><span class="op" id="5149090">.</span><span class="ident" id="5149091">keys</span><span class="op" id="5149095">[</span><span class="op" id="5149096">:</span><span class="num" id="5149097">0</span><span class="op" id="5149098">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149101">for</span>&nbsp;<span class="ident" id="5149105">k</span>&nbsp;<span class="op" id="5149107">:=</span>&nbsp;<span class="keyword" id="5149110">range</span>&nbsp;<span class="ident" id="5149116">v</span><span class="op" id="5149117">.</span><span class="ident" id="5149118">m</span>&nbsp;<span class="op" id="5149120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149124">v</span><span class="op" id="5149125">.</span><span class="ident" id="5149126">keys</span>&nbsp;<span class="op" id="5149131">=</span>&nbsp;<span class="builtinfunc" id="5149133">append</span><span class="op" id="5149139">(</span><span class="ident" id="5149140">v</span><span class="op" id="5149141">.</span><span class="ident" id="5149142">keys</span><span class="op" id="5149146">,</span>&nbsp;<span class="ident" id="5149148">k</span><span class="op" id="5149149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5149152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149155">sort</span><span class="op" id="5149159">.</span><span class="ident" id="5149160">Strings</span><span class="op" id="5149167">(</span><span class="ident" id="5149168">v</span><span class="op" id="5149169">.</span><span class="ident" id="5149170">keys</span><span class="op" id="5149174">)</span><br>
<span class="lineno"></span><span class="op" id="5149176">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="5149179">func</span>&nbsp;<span class="op" id="5149184">(</span><span class="ident" id="5149185">v</span>&nbsp;<span class="op" id="5149187">*</span><span class="ident" id="5149188">Map</span><span class="op" id="5149191">)</span>&nbsp;<span class="ident" id="5149193">Get</span><span class="op" id="5149196">(</span><span class="ident" id="5149197">key</span>&nbsp;<span class="builtintype" id="5149201">string</span><span class="op" id="5149207">)</span>&nbsp;<span class="ident" id="5149209">Var</span>&nbsp;<span class="op" id="5149213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149216">v</span><span class="op" id="5149217">.</span><span class="ident" id="5149218">mu</span><span class="op" id="5149220">.</span><span class="ident" id="5149221">RLock</span><span class="op" id="5149226">(</span><span class="op" id="5149227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149230">defer</span>&nbsp;<span class="ident" id="5149236">v</span><span class="op" id="5149237">.</span><span class="ident" id="5149238">mu</span><span class="op" id="5149240">.</span><span class="ident" id="5149241">RUnlock</span><span class="op" id="5149248">(</span><span class="op" id="5149249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149252">return</span>&nbsp;<span class="ident" id="5149259">v</span><span class="op" id="5149260">.</span><span class="ident" id="5149261">m</span><span class="op" id="5149262">[</span><span class="ident" id="5149263">key</span><span class="op" id="5149266">]</span><br>
<span class="lineno">145</span><span class="op" id="5149268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5149271">func</span>&nbsp;<span class="op" id="5149276">(</span><span class="ident" id="5149277">v</span>&nbsp;<span class="op" id="5149279">*</span><span class="ident" id="5149280">Map</span><span class="op" id="5149283">)</span>&nbsp;<span class="ident" id="5149285">Set</span><span class="op" id="5149288">(</span><span class="ident" id="5149289">key</span>&nbsp;<span class="builtintype" id="5149293">string</span><span class="op" id="5149299">,</span>&nbsp;<span class="ident" id="5149301">av</span>&nbsp;<span class="ident" id="5149304">Var</span><span class="op" id="5149307">)</span>&nbsp;<span class="op" id="5149309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149312">v</span><span class="op" id="5149313">.</span><span class="ident" id="5149314">mu</span><span class="op" id="5149316">.</span><span class="ident" id="5149317">Lock</span><span class="op" id="5149321">(</span><span class="op" id="5149322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149325">defer</span>&nbsp;<span class="ident" id="5149331">v</span><span class="op" id="5149332">.</span><span class="ident" id="5149333">mu</span><span class="op" id="5149335">.</span><span class="ident" id="5149336">Unlock</span><span class="op" id="5149342">(</span><span class="op" id="5149343">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149346">v</span><span class="op" id="5149347">.</span><span class="ident" id="5149348">m</span><span class="op" id="5149349">[</span><span class="ident" id="5149350">key</span><span class="op" id="5149353">]</span>&nbsp;<span class="op" id="5149355">=</span>&nbsp;<span class="ident" id="5149357">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149361">v</span><span class="op" id="5149362">.</span><span class="ident" id="5149363">updateKeys</span><span class="op" id="5149373">(</span><span class="op" id="5149374">)</span><br>
<span class="lineno"></span><span class="op" id="5149376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5149379">func</span>&nbsp;<span class="op" id="5149384">(</span><span class="ident" id="5149385">v</span>&nbsp;<span class="op" id="5149387">*</span><span class="ident" id="5149388">Map</span><span class="op" id="5149391">)</span>&nbsp;<span class="ident" id="5149393">Add</span><span class="op" id="5149396">(</span><span class="ident" id="5149397">key</span>&nbsp;<span class="builtintype" id="5149401">string</span><span class="op" id="5149407">,</span>&nbsp;<span class="ident" id="5149409">delta</span>&nbsp;<span class="ident" id="5149415">int64</span><span class="op" id="5149420">)</span>&nbsp;<span class="op" id="5149422">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149425">v</span><span class="op" id="5149426">.</span><span class="ident" id="5149427">mu</span><span class="op" id="5149429">.</span><span class="ident" id="5149430">RLock</span><span class="op" id="5149435">(</span><span class="op" id="5149436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149439">av</span><span class="op" id="5149441">,</span>&nbsp;<span class="ident" id="5149443">ok</span>&nbsp;<span class="op" id="5149446">:=</span>&nbsp;<span class="ident" id="5149449">v</span><span class="op" id="5149450">.</span><span class="ident" id="5149451">m</span><span class="op" id="5149452">[</span><span class="ident" id="5149453">key</span><span class="op" id="5149456">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149459">v</span><span class="op" id="5149460">.</span><span class="ident" id="5149461">mu</span><span class="op" id="5149463">.</span><span class="ident" id="5149464">RUnlock</span><span class="op" id="5149471">(</span><span class="op" id="5149472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149475">if</span>&nbsp;<span class="op" id="5149478">!</span><span class="ident" id="5149479">ok</span>&nbsp;<span class="op" id="5149482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5149486">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149524">v</span><span class="op" id="5149525">.</span><span class="ident" id="5149526">mu</span><span class="op" id="5149528">.</span><span class="ident" id="5149529">Lock</span><span class="op" id="5149533">(</span><span class="op" id="5149534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149538">av</span><span class="op" id="5149540">,</span>&nbsp;<span class="ident" id="5149542">ok</span>&nbsp;<span class="op" id="5149545">=</span>&nbsp;<span class="ident" id="5149547">v</span><span class="op" id="5149548">.</span><span class="ident" id="5149549">m</span><span class="op" id="5149550">[</span><span class="ident" id="5149551">key</span><span class="op" id="5149554">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149558">if</span>&nbsp;<span class="op" id="5149561">!</span><span class="ident" id="5149562">ok</span>&nbsp;<span class="op" id="5149565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149570">av</span>&nbsp;<span class="op" id="5149573">=</span>&nbsp;<span class="builtinfunc" id="5149575">new</span><span class="op" id="5149578">(</span><span class="ident" id="5149579">Int</span><span class="op" id="5149582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149587">v</span><span class="op" id="5149588">.</span><span class="ident" id="5149589">m</span><span class="op" id="5149590">[</span><span class="ident" id="5149591">key</span><span class="op" id="5149594">]</span>&nbsp;<span class="op" id="5149596">=</span>&nbsp;<span class="ident" id="5149598">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149604">v</span><span class="op" id="5149605">.</span><span class="ident" id="5149606">updateKeys</span><span class="op" id="5149616">(</span><span class="op" id="5149617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5149621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149625">v</span><span class="op" id="5149626">.</span><span class="ident" id="5149627">mu</span><span class="op" id="5149629">.</span><span class="ident" id="5149630">Unlock</span><span class="op" id="5149636">(</span><span class="op" id="5149637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5149640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5149644">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149678">if</span>&nbsp;<span class="ident" id="5149681">iv</span><span class="op" id="5149683">,</span>&nbsp;<span class="ident" id="5149685">ok</span>&nbsp;<span class="op" id="5149688">:=</span>&nbsp;<span class="ident" id="5149691">av</span><span class="op" id="5149693">.</span><span class="op" id="5149694">(</span><span class="op" id="5149695">*</span><span class="ident" id="5149696">Int</span><span class="op" id="5149699">)</span><span class="op" id="5149700">;</span>&nbsp;<span class="ident" id="5149702">ok</span>&nbsp;<span class="op" id="5149705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149709">iv</span><span class="op" id="5149711">.</span><span class="ident" id="5149712">Add</span><span class="op" id="5149715">(</span><span class="ident" id="5149716">delta</span><span class="op" id="5149721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5149724">}</span><br>
<span class="lineno"></span><span class="op" id="5149726">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="5149729">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="5149804">func</span>&nbsp;<span class="op" id="5149809">(</span><span class="ident" id="5149810">v</span>&nbsp;<span class="op" id="5149812">*</span><span class="ident" id="5149813">Map</span><span class="op" id="5149816">)</span>&nbsp;<span class="ident" id="5149818">AddFloat</span><span class="op" id="5149826">(</span><span class="ident" id="5149827">key</span>&nbsp;<span class="builtintype" id="5149831">string</span><span class="op" id="5149837">,</span>&nbsp;<span class="ident" id="5149839">delta</span>&nbsp;<span class="builtintype" id="5149845">float64</span><span class="op" id="5149852">)</span>&nbsp;<span class="op" id="5149854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149857">v</span><span class="op" id="5149858">.</span><span class="ident" id="5149859">mu</span><span class="op" id="5149861">.</span><span class="ident" id="5149862">RLock</span><span class="op" id="5149867">(</span><span class="op" id="5149868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149871">av</span><span class="op" id="5149873">,</span>&nbsp;<span class="ident" id="5149875">ok</span>&nbsp;<span class="op" id="5149878">:=</span>&nbsp;<span class="ident" id="5149881">v</span><span class="op" id="5149882">.</span><span class="ident" id="5149883">m</span><span class="op" id="5149884">[</span><span class="ident" id="5149885">key</span><span class="op" id="5149888">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149891">v</span><span class="op" id="5149892">.</span><span class="ident" id="5149893">mu</span><span class="op" id="5149895">.</span><span class="ident" id="5149896">RUnlock</span><span class="op" id="5149903">(</span><span class="op" id="5149904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149907">if</span>&nbsp;<span class="op" id="5149910">!</span><span class="ident" id="5149911">ok</span>&nbsp;<span class="op" id="5149914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5149918">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149956">v</span><span class="op" id="5149957">.</span><span class="ident" id="5149958">mu</span><span class="op" id="5149960">.</span><span class="ident" id="5149961">Lock</span><span class="op" id="5149965">(</span><span class="op" id="5149966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149970">av</span><span class="op" id="5149972">,</span>&nbsp;<span class="ident" id="5149974">ok</span>&nbsp;<span class="op" id="5149977">=</span>&nbsp;<span class="ident" id="5149979">v</span><span class="op" id="5149980">.</span><span class="ident" id="5149981">m</span><span class="op" id="5149982">[</span><span class="ident" id="5149983">key</span><span class="op" id="5149986">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149990">if</span>&nbsp;<span class="op" id="5149993">!</span><span class="ident" id="5149994">ok</span>&nbsp;<span class="op" id="5149997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150002">av</span>&nbsp;<span class="op" id="5150005">=</span>&nbsp;<span class="builtinfunc" id="5150007">new</span><span class="op" id="5150010">(</span><span class="ident" id="5150011">Float</span><span class="op" id="5150016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150021">v</span><span class="op" id="5150022">.</span><span class="ident" id="5150023">m</span><span class="op" id="5150024">[</span><span class="ident" id="5150025">key</span><span class="op" id="5150028">]</span>&nbsp;<span class="op" id="5150030">=</span>&nbsp;<span class="ident" id="5150032">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150038">v</span><span class="op" id="5150039">.</span><span class="ident" id="5150040">updateKeys</span><span class="op" id="5150050">(</span><span class="op" id="5150051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150055">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150059">v</span><span class="op" id="5150060">.</span><span class="ident" id="5150061">mu</span><span class="op" id="5150063">.</span><span class="ident" id="5150064">Unlock</span><span class="op" id="5150070">(</span><span class="op" id="5150071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5150078">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150114">if</span>&nbsp;<span class="ident" id="5150117">iv</span><span class="op" id="5150119">,</span>&nbsp;<span class="ident" id="5150121">ok</span>&nbsp;<span class="op" id="5150124">:=</span>&nbsp;<span class="ident" id="5150127">av</span><span class="op" id="5150129">.</span><span class="op" id="5150130">(</span><span class="op" id="5150131">*</span><span class="ident" id="5150132">Float</span><span class="op" id="5150137">)</span><span class="op" id="5150138">;</span>&nbsp;<span class="ident" id="5150140">ok</span>&nbsp;<span class="op" id="5150143">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150147">iv</span><span class="op" id="5150149">.</span><span class="ident" id="5150150">Add</span><span class="op" id="5150153">(</span><span class="ident" id="5150154">delta</span><span class="op" id="5150159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150162">}</span><br>
<span class="lineno"></span><span class="op" id="5150164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5150167">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="5150208">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5150251">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5150304">func</span>&nbsp;<span class="op" id="5150309">(</span><span class="ident" id="5150310">v</span>&nbsp;<span class="op" id="5150312">*</span><span class="ident" id="5150313">Map</span><span class="op" id="5150316">)</span>&nbsp;<span class="ident" id="5150318">Do</span><span class="op" id="5150320">(</span><span class="ident" id="5150321">f</span>&nbsp;<span class="keyword" id="5150323">func</span><span class="op" id="5150327">(</span><span class="ident" id="5150328">KeyValue</span><span class="op" id="5150336">)</span><span class="op" id="5150337">)</span>&nbsp;<span class="op" id="5150339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150342">v</span><span class="op" id="5150343">.</span><span class="ident" id="5150344">mu</span><span class="op" id="5150346">.</span><span class="ident" id="5150347">RLock</span><span class="op" id="5150352">(</span><span class="op" id="5150353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150356">defer</span>&nbsp;<span class="ident" id="5150362">v</span><span class="op" id="5150363">.</span><span class="ident" id="5150364">mu</span><span class="op" id="5150366">.</span><span class="ident" id="5150367">RUnlock</span><span class="op" id="5150374">(</span><span class="op" id="5150375">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150378">v</span><span class="op" id="5150379">.</span><span class="ident" id="5150380">doLocked</span><span class="op" id="5150388">(</span><span class="ident" id="5150389">f</span><span class="op" id="5150390">)</span><br>
<span class="lineno"></span><span class="op" id="5150392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5150395">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="5150442">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="5150474">func</span>&nbsp;<span class="op" id="5150479">(</span><span class="ident" id="5150480">v</span>&nbsp;<span class="op" id="5150482">*</span><span class="ident" id="5150483">Map</span><span class="op" id="5150486">)</span>&nbsp;<span class="ident" id="5150488">doLocked</span><span class="op" id="5150496">(</span><span class="ident" id="5150497">f</span>&nbsp;<span class="keyword" id="5150499">func</span><span class="op" id="5150503">(</span><span class="ident" id="5150504">KeyValue</span><span class="op" id="5150512">)</span><span class="op" id="5150513">)</span>&nbsp;<span class="op" id="5150515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150518">for</span>&nbsp;<span class="ident" id="5150522">_</span><span class="op" id="5150523">,</span>&nbsp;<span class="ident" id="5150525">k</span>&nbsp;<span class="op" id="5150527">:=</span>&nbsp;<span class="keyword" id="5150530">range</span>&nbsp;<span class="ident" id="5150536">v</span><span class="op" id="5150537">.</span><span class="ident" id="5150538">keys</span>&nbsp;<span class="op" id="5150543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150547">f</span><span class="op" id="5150548">(</span><span class="ident" id="5150549">KeyValue</span><span class="op" id="5150557">{</span><span class="ident" id="5150558">k</span><span class="op" id="5150559">,</span>&nbsp;<span class="ident" id="5150561">v</span><span class="op" id="5150562">.</span><span class="ident" id="5150563">m</span><span class="op" id="5150564">[</span><span class="ident" id="5150565">k</span><span class="op" id="5150566">]</span><span class="op" id="5150567">}</span><span class="op" id="5150568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150571">}</span><br>
<span class="lineno"></span><span class="op" id="5150573">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="5150576">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5150641">type</span>&nbsp;<span class="ident" id="5150646">String</span>&nbsp;<span class="keyword" id="5150653">struct</span>&nbsp;<span class="op" id="5150660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150663">mu</span>&nbsp;<span class="ident" id="5150666">sync</span><span class="op" id="5150670">.</span><span class="ident" id="5150671">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150680">s</span>&nbsp;&nbsp;<span class="builtintype" id="5150683">string</span><br>
<span class="lineno">220</span><span class="op" id="5150690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5150693">func</span>&nbsp;<span class="op" id="5150698">(</span><span class="ident" id="5150699">v</span>&nbsp;<span class="op" id="5150701">*</span><span class="ident" id="5150702">String</span><span class="op" id="5150708">)</span>&nbsp;<span class="ident" id="5150710">String</span><span class="op" id="5150716">(</span><span class="op" id="5150717">)</span>&nbsp;<span class="builtintype" id="5150719">string</span>&nbsp;<span class="op" id="5150726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150729">v</span><span class="op" id="5150730">.</span><span class="ident" id="5150731">mu</span><span class="op" id="5150733">.</span><span class="ident" id="5150734">RLock</span><span class="op" id="5150739">(</span><span class="op" id="5150740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150743">defer</span>&nbsp;<span class="ident" id="5150749">v</span><span class="op" id="5150750">.</span><span class="ident" id="5150751">mu</span><span class="op" id="5150753">.</span><span class="ident" id="5150754">RUnlock</span><span class="op" id="5150761">(</span><span class="op" id="5150762">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150765">return</span>&nbsp;<span class="ident" id="5150772">strconv</span><span class="op" id="5150779">.</span><span class="ident" id="5150780">Quote</span><span class="op" id="5150785">(</span><span class="ident" id="5150786">v</span><span class="op" id="5150787">.</span><span class="ident" id="5150788">s</span><span class="op" id="5150789">)</span><br>
<span class="lineno"></span><span class="op" id="5150791">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5150794">func</span>&nbsp;<span class="op" id="5150799">(</span><span class="ident" id="5150800">v</span>&nbsp;<span class="op" id="5150802">*</span><span class="ident" id="5150803">String</span><span class="op" id="5150809">)</span>&nbsp;<span class="ident" id="5150811">Set</span><span class="op" id="5150814">(</span><span class="ident" id="5150815">value</span>&nbsp;<span class="builtintype" id="5150821">string</span><span class="op" id="5150827">)</span>&nbsp;<span class="op" id="5150829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150832">v</span><span class="op" id="5150833">.</span><span class="ident" id="5150834">mu</span><span class="op" id="5150836">.</span><span class="ident" id="5150837">Lock</span><span class="op" id="5150841">(</span><span class="op" id="5150842">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150845">defer</span>&nbsp;<span class="ident" id="5150851">v</span><span class="op" id="5150852">.</span><span class="ident" id="5150853">mu</span><span class="op" id="5150855">.</span><span class="ident" id="5150856">Unlock</span><span class="op" id="5150862">(</span><span class="op" id="5150863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150866">v</span><span class="op" id="5150867">.</span><span class="ident" id="5150868">s</span>&nbsp;<span class="op" id="5150870">=</span>&nbsp;<span class="ident" id="5150872">value</span><br>
<span class="lineno"></span><span class="op" id="5150878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5150881">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="5150928">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="5150977">type</span>&nbsp;<span class="ident" id="5150982">Func</span>&nbsp;<span class="keyword" id="5150987">func</span><span class="op" id="5150991">(</span><span class="op" id="5150992">)</span>&nbsp;<span class="keyword" id="5150994">interface</span><span class="op" id="5151003">{</span><span class="op" id="5151004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5151007">func</span>&nbsp;<span class="op" id="5151012">(</span><span class="ident" id="5151013">f</span>&nbsp;<span class="ident" id="5151015">Func</span><span class="op" id="5151019">)</span>&nbsp;<span class="ident" id="5151021">String</span><span class="op" id="5151027">(</span><span class="op" id="5151028">)</span>&nbsp;<span class="builtintype" id="5151030">string</span>&nbsp;<span class="op" id="5151037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151040">v</span><span class="op" id="5151041">,</span>&nbsp;<span class="ident" id="5151043">_</span>&nbsp;<span class="op" id="5151045">:=</span>&nbsp;<span class="ident" id="5151048">json</span><span class="op" id="5151052">.</span><span class="ident" id="5151053">Marshal</span><span class="op" id="5151060">(</span><span class="ident" id="5151061">f</span><span class="op" id="5151062">(</span><span class="op" id="5151063">)</span><span class="op" id="5151064">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151067">return</span>&nbsp;<span class="builtintype" id="5151074">string</span><span class="op" id="5151080">(</span><span class="ident" id="5151081">v</span><span class="op" id="5151082">)</span><br>
<span class="lineno"></span><span class="op" id="5151084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5151087">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5151115">var</span>&nbsp;<span class="op" id="5151119">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151122">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5151130">sync</span><span class="op" id="5151134">.</span><span class="ident" id="5151135">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151144">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5151152">=</span>&nbsp;<span class="builtinfunc" id="5151154">make</span><span class="op" id="5151158">(</span><span class="keyword" id="5151159">map</span><span class="op" id="5151162">[</span><span class="builtintype" id="5151163">string</span><span class="op" id="5151169">]</span><span class="ident" id="5151170">Var</span><span class="op" id="5151173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151176">varKeys</span>&nbsp;<span class="op" id="5151184">[</span><span class="op" id="5151185">]</span><span class="builtintype" id="5151186">string</span>&nbsp;<span class="comment" id="5151193">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5151203">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="5151206">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5151282">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="5151358">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5151398">func</span>&nbsp;<span class="ident" id="5151403">Publish</span><span class="op" id="5151410">(</span><span class="ident" id="5151411">name</span>&nbsp;<span class="builtintype" id="5151416">string</span><span class="op" id="5151422">,</span>&nbsp;<span class="ident" id="5151424">v</span>&nbsp;<span class="ident" id="5151426">Var</span><span class="op" id="5151429">)</span>&nbsp;<span class="op" id="5151431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151434">mutex</span><span class="op" id="5151439">.</span><span class="ident" id="5151440">Lock</span><span class="op" id="5151444">(</span><span class="op" id="5151445">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151448">defer</span>&nbsp;<span class="ident" id="5151454">mutex</span><span class="op" id="5151459">.</span><span class="ident" id="5151460">Unlock</span><span class="op" id="5151466">(</span><span class="op" id="5151467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151470">if</span>&nbsp;<span class="ident" id="5151473">_</span><span class="op" id="5151474">,</span>&nbsp;<span class="ident" id="5151476">existing</span>&nbsp;<span class="op" id="5151485">:=</span>&nbsp;<span class="ident" id="5151488">vars</span><span class="op" id="5151492">[</span><span class="ident" id="5151493">name</span><span class="op" id="5151497">]</span><span class="op" id="5151498">;</span>&nbsp;<span class="ident" id="5151500">existing</span>&nbsp;<span class="op" id="5151509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151513">log</span><span class="op" id="5151516">.</span><span class="ident" id="5151517">Panicln</span><span class="op" id="5151524">(</span><span class="string" id="5151525">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="5151554">,</span>&nbsp;<span class="ident" id="5151556">name</span><span class="op" id="5151560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151566">vars</span><span class="op" id="5151570">[</span><span class="ident" id="5151571">name</span><span class="op" id="5151575">]</span>&nbsp;<span class="op" id="5151577">=</span>&nbsp;<span class="ident" id="5151579">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151582">varKeys</span>&nbsp;<span class="op" id="5151590">=</span>&nbsp;<span class="builtinfunc" id="5151592">append</span><span class="op" id="5151598">(</span><span class="ident" id="5151599">varKeys</span><span class="op" id="5151606">,</span>&nbsp;<span class="ident" id="5151608">name</span><span class="op" id="5151612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151615">sort</span><span class="op" id="5151619">.</span><span class="ident" id="5151620">Strings</span><span class="op" id="5151627">(</span><span class="ident" id="5151628">varKeys</span><span class="op" id="5151635">)</span><br>
<span class="lineno"></span><span class="op" id="5151637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5151640">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="5151684">func</span>&nbsp;<span class="ident" id="5151689">Get</span><span class="op" id="5151692">(</span><span class="ident" id="5151693">name</span>&nbsp;<span class="builtintype" id="5151698">string</span><span class="op" id="5151704">)</span>&nbsp;<span class="ident" id="5151706">Var</span>&nbsp;<span class="op" id="5151710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151713">mutex</span><span class="op" id="5151718">.</span><span class="ident" id="5151719">RLock</span><span class="op" id="5151724">(</span><span class="op" id="5151725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151728">defer</span>&nbsp;<span class="ident" id="5151734">mutex</span><span class="op" id="5151739">.</span><span class="ident" id="5151740">RUnlock</span><span class="op" id="5151747">(</span><span class="op" id="5151748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151751">return</span>&nbsp;<span class="ident" id="5151758">vars</span><span class="op" id="5151762">[</span><span class="ident" id="5151763">name</span><span class="op" id="5151767">]</span><br>
<span class="lineno"></span><span class="op" id="5151769">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="5151772">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5151835">func</span>&nbsp;<span class="ident" id="5151840">NewInt</span><span class="op" id="5151846">(</span><span class="ident" id="5151847">name</span>&nbsp;<span class="builtintype" id="5151852">string</span><span class="op" id="5151858">)</span>&nbsp;<span class="op" id="5151860">*</span><span class="ident" id="5151861">Int</span>&nbsp;<span class="op" id="5151865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151868">v</span>&nbsp;<span class="op" id="5151870">:=</span>&nbsp;<span class="builtinfunc" id="5151873">new</span><span class="op" id="5151876">(</span><span class="ident" id="5151877">Int</span><span class="op" id="5151880">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151883">Publish</span><span class="op" id="5151890">(</span><span class="ident" id="5151891">name</span><span class="op" id="5151895">,</span>&nbsp;<span class="ident" id="5151897">v</span><span class="op" id="5151898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151901">return</span>&nbsp;<span class="ident" id="5151908">v</span><br>
<span class="lineno"></span><span class="op" id="5151910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5151913">func</span>&nbsp;<span class="ident" id="5151918">NewFloat</span><span class="op" id="5151926">(</span><span class="ident" id="5151927">name</span>&nbsp;<span class="builtintype" id="5151932">string</span><span class="op" id="5151938">)</span>&nbsp;<span class="op" id="5151940">*</span><span class="ident" id="5151941">Float</span>&nbsp;<span class="op" id="5151947">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151950">v</span>&nbsp;<span class="op" id="5151952">:=</span>&nbsp;<span class="builtinfunc" id="5151955">new</span><span class="op" id="5151958">(</span><span class="ident" id="5151959">Float</span><span class="op" id="5151964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151967">Publish</span><span class="op" id="5151974">(</span><span class="ident" id="5151975">name</span><span class="op" id="5151979">,</span>&nbsp;<span class="ident" id="5151981">v</span><span class="op" id="5151982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151985">return</span>&nbsp;<span class="ident" id="5151992">v</span><br>
<span class="lineno"></span><span class="op" id="5151994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5151997">func</span>&nbsp;<span class="ident" id="5152002">NewMap</span><span class="op" id="5152008">(</span><span class="ident" id="5152009">name</span>&nbsp;<span class="builtintype" id="5152014">string</span><span class="op" id="5152020">)</span>&nbsp;<span class="op" id="5152022">*</span><span class="ident" id="5152023">Map</span>&nbsp;<span class="op" id="5152027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152030">v</span>&nbsp;<span class="op" id="5152032">:=</span>&nbsp;<span class="builtinfunc" id="5152035">new</span><span class="op" id="5152038">(</span><span class="ident" id="5152039">Map</span><span class="op" id="5152042">)</span><span class="op" id="5152043">.</span><span class="ident" id="5152044">Init</span><span class="op" id="5152048">(</span><span class="op" id="5152049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152052">Publish</span><span class="op" id="5152059">(</span><span class="ident" id="5152060">name</span><span class="op" id="5152064">,</span>&nbsp;<span class="ident" id="5152066">v</span><span class="op" id="5152067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152070">return</span>&nbsp;<span class="ident" id="5152077">v</span><br>
<span class="lineno"></span><span class="op" id="5152079">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="5152082">func</span>&nbsp;<span class="ident" id="5152087">NewString</span><span class="op" id="5152096">(</span><span class="ident" id="5152097">name</span>&nbsp;<span class="builtintype" id="5152102">string</span><span class="op" id="5152108">)</span>&nbsp;<span class="op" id="5152110">*</span><span class="ident" id="5152111">String</span>&nbsp;<span class="op" id="5152118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152121">v</span>&nbsp;<span class="op" id="5152123">:=</span>&nbsp;<span class="builtinfunc" id="5152126">new</span><span class="op" id="5152129">(</span><span class="ident" id="5152130">String</span><span class="op" id="5152136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152139">Publish</span><span class="op" id="5152146">(</span><span class="ident" id="5152147">name</span><span class="op" id="5152151">,</span>&nbsp;<span class="ident" id="5152153">v</span><span class="op" id="5152154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152157">return</span>&nbsp;<span class="ident" id="5152164">v</span><br>
<span class="lineno">295</span><span class="op" id="5152166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5152169">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="5152211">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5152270">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="5152323">func</span>&nbsp;<span class="ident" id="5152328">Do</span><span class="op" id="5152330">(</span><span class="ident" id="5152331">f</span>&nbsp;<span class="keyword" id="5152333">func</span><span class="op" id="5152337">(</span><span class="ident" id="5152338">KeyValue</span><span class="op" id="5152346">)</span><span class="op" id="5152347">)</span>&nbsp;<span class="op" id="5152349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152352">mutex</span><span class="op" id="5152357">.</span><span class="ident" id="5152358">RLock</span><span class="op" id="5152363">(</span><span class="op" id="5152364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152367">defer</span>&nbsp;<span class="ident" id="5152373">mutex</span><span class="op" id="5152378">.</span><span class="ident" id="5152379">RUnlock</span><span class="op" id="5152386">(</span><span class="op" id="5152387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152390">for</span>&nbsp;<span class="ident" id="5152394">_</span><span class="op" id="5152395">,</span>&nbsp;<span class="ident" id="5152397">k</span>&nbsp;<span class="op" id="5152399">:=</span>&nbsp;<span class="keyword" id="5152402">range</span>&nbsp;<span class="ident" id="5152408">varKeys</span>&nbsp;<span class="op" id="5152416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152420">f</span><span class="op" id="5152421">(</span><span class="ident" id="5152422">KeyValue</span><span class="op" id="5152430">{</span><span class="ident" id="5152431">k</span><span class="op" id="5152432">,</span>&nbsp;<span class="ident" id="5152434">vars</span><span class="op" id="5152438">[</span><span class="ident" id="5152439">k</span><span class="op" id="5152440">]</span><span class="op" id="5152441">}</span><span class="op" id="5152442">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152445">}</span><br>
<span class="lineno"></span><span class="op" id="5152447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5152450">func</span>&nbsp;<span class="ident" id="5152455">expvarHandler</span><span class="op" id="5152468">(</span><span class="ident" id="5152469">w</span>&nbsp;<span class="ident" id="5152471">http</span><span class="op" id="5152475">.</span><span class="ident" id="5152476">ResponseWriter</span><span class="op" id="5152490">,</span>&nbsp;<span class="ident" id="5152492">r</span>&nbsp;<span class="op" id="5152494">*</span><span class="ident" id="5152495">http</span><span class="op" id="5152499">.</span><span class="ident" id="5152500">Request</span><span class="op" id="5152507">)</span>&nbsp;<span class="op" id="5152509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152512">w</span><span class="op" id="5152513">.</span><span class="ident" id="5152514">Header</span><span class="op" id="5152520">(</span><span class="op" id="5152521">)</span><span class="op" id="5152522">.</span><span class="ident" id="5152523">Set</span><span class="op" id="5152526">(</span><span class="string" id="5152527">&#34;Content-Type&#34;</span><span class="op" id="5152541">,</span>&nbsp;<span class="string" id="5152543">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="5152576">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152579">fmt</span><span class="op" id="5152582">.</span><span class="ident" id="5152583">Fprintf</span><span class="op" id="5152590">(</span><span class="ident" id="5152591">w</span><span class="op" id="5152592">,</span>&nbsp;<span class="string" id="5152594">&#34;{\n&#34;</span><span class="op" id="5152599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152602">first</span>&nbsp;<span class="op" id="5152608">:=</span>&nbsp;<span class="builtintype" id="5152611">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152617">Do</span><span class="op" id="5152619">(</span><span class="keyword" id="5152620">func</span><span class="op" id="5152624">(</span><span class="ident" id="5152625">kv</span>&nbsp;<span class="ident" id="5152628">KeyValue</span><span class="op" id="5152636">)</span>&nbsp;<span class="op" id="5152638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152642">if</span>&nbsp;<span class="op" id="5152645">!</span><span class="ident" id="5152646">first</span>&nbsp;<span class="op" id="5152652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152657">fmt</span><span class="op" id="5152660">.</span><span class="ident" id="5152661">Fprintf</span><span class="op" id="5152668">(</span><span class="ident" id="5152669">w</span><span class="op" id="5152670">,</span>&nbsp;<span class="string" id="5152672">&#34;,\n&#34;</span><span class="op" id="5152677">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152685">first</span>&nbsp;<span class="op" id="5152691">=</span>&nbsp;<span class="builtintype" id="5152693">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152701">fmt</span><span class="op" id="5152704">.</span><span class="ident" id="5152705">Fprintf</span><span class="op" id="5152712">(</span><span class="ident" id="5152713">w</span><span class="op" id="5152714">,</span>&nbsp;<span class="string" id="5152716">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="5152724">,</span>&nbsp;<span class="ident" id="5152726">kv</span><span class="op" id="5152728">.</span><span class="ident" id="5152729">Key</span><span class="op" id="5152732">,</span>&nbsp;<span class="ident" id="5152734">kv</span><span class="op" id="5152736">.</span><span class="ident" id="5152737">Value</span><span class="op" id="5152742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152745">}</span><span class="op" id="5152746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152749">fmt</span><span class="op" id="5152752">.</span><span class="ident" id="5152753">Fprintf</span><span class="op" id="5152760">(</span><span class="ident" id="5152761">w</span><span class="op" id="5152762">,</span>&nbsp;<span class="string" id="5152764">&#34;\n}\n&#34;</span><span class="op" id="5152771">)</span><br>
<span class="lineno">320</span><span class="op" id="5152773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5152776">func</span>&nbsp;<span class="ident" id="5152781">cmdline</span><span class="op" id="5152788">(</span><span class="op" id="5152789">)</span>&nbsp;<span class="keyword" id="5152791">interface</span><span class="op" id="5152800">{</span><span class="op" id="5152801">}</span>&nbsp;<span class="op" id="5152803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152806">return</span>&nbsp;<span class="ident" id="5152813">os</span><span class="op" id="5152815">.</span><span class="ident" id="5152816">Args</span><br>
<span class="lineno"></span><span class="op" id="5152821">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="5152824">func</span>&nbsp;<span class="ident" id="5152829">memstats</span><span class="op" id="5152837">(</span><span class="op" id="5152838">)</span>&nbsp;<span class="keyword" id="5152840">interface</span><span class="op" id="5152849">{</span><span class="op" id="5152850">}</span>&nbsp;<span class="op" id="5152852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152855">stats</span>&nbsp;<span class="op" id="5152861">:=</span>&nbsp;<span class="builtinfunc" id="5152864">new</span><span class="op" id="5152867">(</span><span class="ident" id="5152868">runtime</span><span class="op" id="5152875">.</span><span class="ident" id="5152876">MemStats</span><span class="op" id="5152884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152887">runtime</span><span class="op" id="5152894">.</span><span class="ident" id="5152895">ReadMemStats</span><span class="op" id="5152907">(</span><span class="ident" id="5152908">stats</span><span class="op" id="5152913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152916">return</span>&nbsp;<span class="op" id="5152923">*</span><span class="ident" id="5152924">stats</span><br>
<span class="lineno">330</span><span class="op" id="5152930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5152933">func</span>&nbsp;<span class="ident" id="5152938">init</span><span class="op" id="5152942">(</span><span class="op" id="5152943">)</span>&nbsp;<span class="op" id="5152945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152948">http</span><span class="op" id="5152952">.</span><span class="ident" id="5152953">HandleFunc</span><span class="op" id="5152963">(</span><span class="string" id="5152964">&#34;/debug/vars&#34;</span><span class="op" id="5152977">,</span>&nbsp;<span class="ident" id="5152979">expvarHandler</span><span class="op" id="5152992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152995">Publish</span><span class="op" id="5153002">(</span><span class="string" id="5153003">&#34;cmdline&#34;</span><span class="op" id="5153012">,</span>&nbsp;<span class="ident" id="5153014">Func</span><span class="op" id="5153018">(</span><span class="ident" id="5153019">cmdline</span><span class="op" id="5153026">)</span><span class="op" id="5153027">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153030">Publish</span><span class="op" id="5153037">(</span><span class="string" id="5153038">&#34;memstats&#34;</span><span class="op" id="5153048">,</span>&nbsp;<span class="ident" id="5153050">Func</span><span class="op" id="5153054">(</span><span class="ident" id="5153055">memstats</span><span class="op" id="5153063">)</span><span class="op" id="5153064">)</span><br>
<span class="lineno"></span><span class="op" id="5153066">}</span>
</div>
</body>
</html>
