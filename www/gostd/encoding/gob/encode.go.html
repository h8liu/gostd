<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html" class="current">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5544652">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5544707">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5544761">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5544812">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5544867">package</span>&nbsp;<span class="ident" id="5544875">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5544880">import</span>&nbsp;<span class="op" id="5544887">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5544890">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5544902">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5544910">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="5544920">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5544923">const</span>&nbsp;<span class="ident" id="5544929">uint64Size</span>&nbsp;<span class="op" id="5544940">=</span>&nbsp;<span class="num" id="5544942">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5544945">type</span>&nbsp;<span class="ident" id="5544950">encHelper</span>&nbsp;<span class="keyword" id="5544960">func</span><span class="op" id="5544964">(</span><span class="ident" id="5544965">state</span>&nbsp;<span class="op" id="5544971">*</span><span class="ident" id="5544972">encoderState</span><span class="op" id="5544984">,</span>&nbsp;<span class="ident" id="5544986">v</span>&nbsp;<span class="ident" id="5544988">reflect</span><span class="op" id="5544995">.</span><span class="ident" id="5544996">Value</span><span class="op" id="5545001">)</span>&nbsp;<span class="builtintype" id="5545003">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5545009">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="5545086">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5545152">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5545222">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="5545253">type</span>&nbsp;<span class="ident" id="5545258">encoderState</span>&nbsp;<span class="keyword" id="5545271">struct</span>&nbsp;<span class="op" id="5545278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5545281">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5545290">*</span><span class="ident" id="5545291">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5545300">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5545309">*</span><span class="ident" id="5545310">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5545321">sendZero</span>&nbsp;<span class="builtintype" id="5545330">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5545351">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5545421">fieldnum</span>&nbsp;<span class="builtintype" id="5545430">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5545451">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5545486">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5545495">[</span><span class="num" id="5545496">1</span>&nbsp;<span class="op" id="5545498">+</span>&nbsp;<span class="ident" id="5545500">uint64Size</span><span class="op" id="5545510">]</span><span class="builtintype" id="5545511">byte</span>&nbsp;<span class="comment" id="5545516">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5545574">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5545583">*</span><span class="ident" id="5545584">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5545604">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="5545621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5545624">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="5545710">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5545805">type</span>&nbsp;<span class="ident" id="5545810">encBuffer</span>&nbsp;<span class="keyword" id="5545820">struct</span>&nbsp;<span class="op" id="5545827">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5545830">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5545838">[</span><span class="op" id="5545839">]</span><span class="builtintype" id="5545840">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5545846">scratch</span>&nbsp;<span class="op" id="5545854">[</span><span class="num" id="5545855">64</span><span class="op" id="5545857">]</span><span class="builtintype" id="5545858">byte</span><br>
<span class="lineno"></span><span class="op" id="5545863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5545866">func</span>&nbsp;<span class="op" id="5545871">(</span><span class="ident" id="5545872">e</span>&nbsp;<span class="op" id="5545874">*</span><span class="ident" id="5545875">encBuffer</span><span class="op" id="5545884">)</span>&nbsp;<span class="ident" id="5545886">WriteByte</span><span class="op" id="5545895">(</span><span class="ident" id="5545896">c</span>&nbsp;<span class="builtintype" id="5545898">byte</span><span class="op" id="5545902">)</span>&nbsp;<span class="op" id="5545904">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5545907">e</span><span class="op" id="5545908">.</span><span class="ident" id="5545909">data</span>&nbsp;<span class="op" id="5545914">=</span>&nbsp;<span class="builtinfunc" id="5545916">append</span><span class="op" id="5545922">(</span><span class="ident" id="5545923">e</span><span class="op" id="5545924">.</span><span class="ident" id="5545925">data</span><span class="op" id="5545929">,</span>&nbsp;<span class="ident" id="5545931">c</span><span class="op" id="5545932">)</span><br>
<span class="lineno"></span><span class="op" id="5545934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5545937">func</span>&nbsp;<span class="op" id="5545942">(</span><span class="ident" id="5545943">e</span>&nbsp;<span class="op" id="5545945">*</span><span class="ident" id="5545946">encBuffer</span><span class="op" id="5545955">)</span>&nbsp;<span class="ident" id="5545957">Write</span><span class="op" id="5545962">(</span><span class="ident" id="5545963">p</span>&nbsp;<span class="op" id="5545965">[</span><span class="op" id="5545966">]</span><span class="builtintype" id="5545967">byte</span><span class="op" id="5545971">)</span>&nbsp;<span class="op" id="5545973">(</span><span class="builtintype" id="5545974">int</span><span class="op" id="5545977">,</span>&nbsp;<span class="builtintype" id="5545979">error</span><span class="op" id="5545984">)</span>&nbsp;<span class="op" id="5545986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5545989">e</span><span class="op" id="5545990">.</span><span class="ident" id="5545991">data</span>&nbsp;<span class="op" id="5545996">=</span>&nbsp;<span class="builtinfunc" id="5545998">append</span><span class="op" id="5546004">(</span><span class="ident" id="5546005">e</span><span class="op" id="5546006">.</span><span class="ident" id="5546007">data</span><span class="op" id="5546011">,</span>&nbsp;<span class="ident" id="5546013">p</span><span class="op" id="5546014">...</span><span class="op" id="5546017">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5546020">return</span>&nbsp;<span class="builtinfunc" id="5546027">len</span><span class="op" id="5546030">(</span><span class="ident" id="5546031">p</span><span class="op" id="5546032">)</span><span class="op" id="5546033">,</span>&nbsp;<span class="builtintype" id="5546035">nil</span><br>
<span class="lineno"></span><span class="op" id="5546039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5546042">func</span>&nbsp;<span class="op" id="5546047">(</span><span class="ident" id="5546048">e</span>&nbsp;<span class="op" id="5546050">*</span><span class="ident" id="5546051">encBuffer</span><span class="op" id="5546060">)</span>&nbsp;<span class="ident" id="5546062">WriteString</span><span class="op" id="5546073">(</span><span class="ident" id="5546074">s</span>&nbsp;<span class="builtintype" id="5546076">string</span><span class="op" id="5546082">)</span>&nbsp;<span class="op" id="5546084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546087">e</span><span class="op" id="5546088">.</span><span class="ident" id="5546089">data</span>&nbsp;<span class="op" id="5546094">=</span>&nbsp;<span class="builtinfunc" id="5546096">append</span><span class="op" id="5546102">(</span><span class="ident" id="5546103">e</span><span class="op" id="5546104">.</span><span class="ident" id="5546105">data</span><span class="op" id="5546109">,</span>&nbsp;<span class="ident" id="5546111">s</span><span class="op" id="5546112">...</span><span class="op" id="5546115">)</span><br>
<span class="lineno">50</span><span class="op" id="5546117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5546120">func</span>&nbsp;<span class="op" id="5546125">(</span><span class="ident" id="5546126">e</span>&nbsp;<span class="op" id="5546128">*</span><span class="ident" id="5546129">encBuffer</span><span class="op" id="5546138">)</span>&nbsp;<span class="ident" id="5546140">Len</span><span class="op" id="5546143">(</span><span class="op" id="5546144">)</span>&nbsp;<span class="builtintype" id="5546146">int</span>&nbsp;<span class="op" id="5546150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5546153">return</span>&nbsp;<span class="builtinfunc" id="5546160">len</span><span class="op" id="5546163">(</span><span class="ident" id="5546164">e</span><span class="op" id="5546165">.</span><span class="ident" id="5546166">data</span><span class="op" id="5546170">)</span><br>
<span class="lineno"></span><span class="op" id="5546172">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="5546175">func</span>&nbsp;<span class="op" id="5546180">(</span><span class="ident" id="5546181">e</span>&nbsp;<span class="op" id="5546183">*</span><span class="ident" id="5546184">encBuffer</span><span class="op" id="5546193">)</span>&nbsp;<span class="ident" id="5546195">Bytes</span><span class="op" id="5546200">(</span><span class="op" id="5546201">)</span>&nbsp;<span class="op" id="5546203">[</span><span class="op" id="5546204">]</span><span class="builtintype" id="5546205">byte</span>&nbsp;<span class="op" id="5546210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5546213">return</span>&nbsp;<span class="ident" id="5546220">e</span><span class="op" id="5546221">.</span><span class="ident" id="5546222">data</span><br>
<span class="lineno"></span><span class="op" id="5546227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5546230">func</span>&nbsp;<span class="op" id="5546235">(</span><span class="ident" id="5546236">e</span>&nbsp;<span class="op" id="5546238">*</span><span class="ident" id="5546239">encBuffer</span><span class="op" id="5546248">)</span>&nbsp;<span class="ident" id="5546250">Reset</span><span class="op" id="5546255">(</span><span class="op" id="5546256">)</span>&nbsp;<span class="op" id="5546258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546261">e</span><span class="op" id="5546262">.</span><span class="ident" id="5546263">data</span>&nbsp;<span class="op" id="5546268">=</span>&nbsp;<span class="ident" id="5546270">e</span><span class="op" id="5546271">.</span><span class="ident" id="5546272">data</span><span class="op" id="5546276">[</span><span class="num" id="5546277">0</span><span class="op" id="5546278">:</span><span class="num" id="5546279">0</span><span class="op" id="5546280">]</span><br>
<span class="lineno"></span><span class="op" id="5546282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5546285">func</span>&nbsp;<span class="op" id="5546290">(</span><span class="ident" id="5546291">enc</span>&nbsp;<span class="op" id="5546295">*</span><span class="ident" id="5546296">Encoder</span><span class="op" id="5546303">)</span>&nbsp;<span class="ident" id="5546305">newEncoderState</span><span class="op" id="5546320">(</span><span class="ident" id="5546321">b</span>&nbsp;<span class="op" id="5546323">*</span><span class="ident" id="5546324">encBuffer</span><span class="op" id="5546333">)</span>&nbsp;<span class="op" id="5546335">*</span><span class="ident" id="5546336">encoderState</span>&nbsp;<span class="op" id="5546349">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546352">e</span>&nbsp;<span class="op" id="5546354">:=</span>&nbsp;<span class="ident" id="5546357">enc</span><span class="op" id="5546360">.</span><span class="ident" id="5546361">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5546371">if</span>&nbsp;<span class="ident" id="5546374">e</span>&nbsp;<span class="op" id="5546376">==</span>&nbsp;<span class="builtintype" id="5546379">nil</span>&nbsp;<span class="op" id="5546383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546387">e</span>&nbsp;<span class="op" id="5546389">=</span>&nbsp;<span class="builtinfunc" id="5546391">new</span><span class="op" id="5546394">(</span><span class="ident" id="5546395">encoderState</span><span class="op" id="5546407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546411">e</span><span class="op" id="5546412">.</span><span class="ident" id="5546413">enc</span>&nbsp;<span class="op" id="5546417">=</span>&nbsp;<span class="ident" id="5546419">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5546424">}</span>&nbsp;<span class="keyword" id="5546426">else</span>&nbsp;<span class="op" id="5546431">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546435">enc</span><span class="op" id="5546438">.</span><span class="ident" id="5546439">freeList</span>&nbsp;<span class="op" id="5546448">=</span>&nbsp;<span class="ident" id="5546450">e</span><span class="op" id="5546451">.</span><span class="ident" id="5546452">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5546458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546461">e</span><span class="op" id="5546462">.</span><span class="ident" id="5546463">sendZero</span>&nbsp;<span class="op" id="5546472">=</span>&nbsp;<span class="builtintype" id="5546474">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546481">e</span><span class="op" id="5546482">.</span><span class="ident" id="5546483">fieldnum</span>&nbsp;<span class="op" id="5546492">=</span>&nbsp;<span class="num" id="5546494">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546497">e</span><span class="op" id="5546498">.</span><span class="ident" id="5546499">b</span>&nbsp;<span class="op" id="5546501">=</span>&nbsp;<span class="ident" id="5546503">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5546506">if</span>&nbsp;<span class="builtinfunc" id="5546509">len</span><span class="op" id="5546512">(</span><span class="ident" id="5546513">b</span><span class="op" id="5546514">.</span><span class="ident" id="5546515">data</span><span class="op" id="5546519">)</span>&nbsp;<span class="op" id="5546521">==</span>&nbsp;<span class="num" id="5546524">0</span>&nbsp;<span class="op" id="5546526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546530">b</span><span class="op" id="5546531">.</span><span class="ident" id="5546532">data</span>&nbsp;<span class="op" id="5546537">=</span>&nbsp;<span class="ident" id="5546539">b</span><span class="op" id="5546540">.</span><span class="ident" id="5546541">scratch</span><span class="op" id="5546548">[</span><span class="num" id="5546549">0</span><span class="op" id="5546550">:</span><span class="num" id="5546551">0</span><span class="op" id="5546552">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5546555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5546558">return</span>&nbsp;<span class="ident" id="5546565">e</span><br>
<span class="lineno"></span><span class="op" id="5546567">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="5546570">func</span>&nbsp;<span class="op" id="5546575">(</span><span class="ident" id="5546576">enc</span>&nbsp;<span class="op" id="5546580">*</span><span class="ident" id="5546581">Encoder</span><span class="op" id="5546588">)</span>&nbsp;<span class="ident" id="5546590">freeEncoderState</span><span class="op" id="5546606">(</span><span class="ident" id="5546607">e</span>&nbsp;<span class="op" id="5546609">*</span><span class="ident" id="5546610">encoderState</span><span class="op" id="5546622">)</span>&nbsp;<span class="op" id="5546624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546627">e</span><span class="op" id="5546628">.</span><span class="ident" id="5546629">next</span>&nbsp;<span class="op" id="5546634">=</span>&nbsp;<span class="ident" id="5546636">enc</span><span class="op" id="5546639">.</span><span class="ident" id="5546640">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5546650">enc</span><span class="op" id="5546653">.</span><span class="ident" id="5546654">freeList</span>&nbsp;<span class="op" id="5546663">=</span>&nbsp;<span class="ident" id="5546665">e</span><br>
<span class="lineno"></span><span class="op" id="5546667">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="5546670">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="5546741">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="5546802">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="5546870">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="5546903">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="5546964">func</span>&nbsp;<span class="op" id="5546969">(</span><span class="ident" id="5546970">state</span>&nbsp;<span class="op" id="5546976">*</span><span class="ident" id="5546977">encoderState</span><span class="op" id="5546989">)</span>&nbsp;<span class="ident" id="5546991">encodeUint</span><span class="op" id="5547001">(</span><span class="ident" id="5547002">x</span>&nbsp;<span class="ident" id="5547004">uint64</span><span class="op" id="5547010">)</span>&nbsp;<span class="op" id="5547012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5547015">if</span>&nbsp;<span class="ident" id="5547018">x</span>&nbsp;<span class="op" id="5547020">&lt;=</span>&nbsp;<span class="num" id="5547023">0x7F</span>&nbsp;<span class="op" id="5547028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547032">state</span><span class="op" id="5547037">.</span><span class="ident" id="5547038">b</span><span class="op" id="5547039">.</span><span class="ident" id="5547040">WriteByte</span><span class="op" id="5547049">(</span><span class="builtintype" id="5547050">uint8</span><span class="op" id="5547055">(</span><span class="ident" id="5547056">x</span><span class="op" id="5547057">)</span><span class="op" id="5547058">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5547062">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5547070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547073">i</span>&nbsp;<span class="op" id="5547075">:=</span>&nbsp;<span class="ident" id="5547078">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5547090">for</span>&nbsp;<span class="ident" id="5547094">x</span>&nbsp;<span class="op" id="5547096">&gt;</span>&nbsp;<span class="num" id="5547098">0</span>&nbsp;<span class="op" id="5547100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547104">state</span><span class="op" id="5547109">.</span><span class="ident" id="5547110">buf</span><span class="op" id="5547113">[</span><span class="ident" id="5547114">i</span><span class="op" id="5547115">]</span>&nbsp;<span class="op" id="5547117">=</span>&nbsp;<span class="builtintype" id="5547119">uint8</span><span class="op" id="5547124">(</span><span class="ident" id="5547125">x</span><span class="op" id="5547126">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547130">x</span>&nbsp;<span class="op" id="5547132">&gt;&gt;=</span>&nbsp;<span class="num" id="5547136">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547140">i</span><span class="op" id="5547141">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5547145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547148">state</span><span class="op" id="5547153">.</span><span class="ident" id="5547154">buf</span><span class="op" id="5547157">[</span><span class="ident" id="5547158">i</span><span class="op" id="5547159">]</span>&nbsp;<span class="op" id="5547161">=</span>&nbsp;<span class="builtintype" id="5547163">uint8</span><span class="op" id="5547168">(</span><span class="ident" id="5547169">i</span>&nbsp;<span class="op" id="5547171">-</span>&nbsp;<span class="ident" id="5547173">uint64Size</span><span class="op" id="5547183">)</span>&nbsp;<span class="comment" id="5547185">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547211">state</span><span class="op" id="5547216">.</span><span class="ident" id="5547217">b</span><span class="op" id="5547218">.</span><span class="ident" id="5547219">Write</span><span class="op" id="5547224">(</span><span class="ident" id="5547225">state</span><span class="op" id="5547230">.</span><span class="ident" id="5547231">buf</span><span class="op" id="5547234">[</span><span class="ident" id="5547235">i</span>&nbsp;<span class="op" id="5547237">:</span>&nbsp;<span class="ident" id="5547239">uint64Size</span><span class="op" id="5547249">+</span><span class="num" id="5547250">1</span><span class="op" id="5547251">]</span><span class="op" id="5547252">)</span><br>
<span class="lineno">105</span><span class="op" id="5547254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5547257">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="5547315">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="5547401">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="5547429">func</span>&nbsp;<span class="op" id="5547434">(</span><span class="ident" id="5547435">state</span>&nbsp;<span class="op" id="5547441">*</span><span class="ident" id="5547442">encoderState</span><span class="op" id="5547454">)</span>&nbsp;<span class="ident" id="5547456">encodeInt</span><span class="op" id="5547465">(</span><span class="ident" id="5547466">i</span>&nbsp;<span class="ident" id="5547468">int64</span><span class="op" id="5547473">)</span>&nbsp;<span class="op" id="5547475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5547478">var</span>&nbsp;<span class="ident" id="5547482">x</span>&nbsp;<span class="ident" id="5547484">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5547492">if</span>&nbsp;<span class="ident" id="5547495">i</span>&nbsp;<span class="op" id="5547497">&lt;</span>&nbsp;<span class="num" id="5547499">0</span>&nbsp;<span class="op" id="5547501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547505">x</span>&nbsp;<span class="op" id="5547507">=</span>&nbsp;<span class="ident" id="5547509">uint64</span><span class="op" id="5547515">(</span><span class="op" id="5547516">^</span><span class="ident" id="5547517">i</span><span class="op" id="5547518">&lt;&lt;</span><span class="num" id="5547520">1</span><span class="op" id="5547521">)</span>&nbsp;<span class="op" id="5547523">|</span>&nbsp;<span class="num" id="5547525">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5547528">}</span>&nbsp;<span class="keyword" id="5547530">else</span>&nbsp;<span class="op" id="5547535">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547539">x</span>&nbsp;<span class="op" id="5547541">=</span>&nbsp;<span class="ident" id="5547543">uint64</span><span class="op" id="5547549">(</span><span class="ident" id="5547550">i</span>&nbsp;<span class="op" id="5547552">&lt;&lt;</span>&nbsp;<span class="num" id="5547555">1</span><span class="op" id="5547556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5547559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547562">state</span><span class="op" id="5547567">.</span><span class="ident" id="5547568">encodeUint</span><span class="op" id="5547578">(</span><span class="ident" id="5547579">uint64</span><span class="op" id="5547585">(</span><span class="ident" id="5547586">x</span><span class="op" id="5547587">)</span><span class="op" id="5547588">)</span><br>
<span class="lineno"></span><span class="op" id="5547590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="5547593">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5547661">type</span>&nbsp;<span class="ident" id="5547666">encOp</span>&nbsp;<span class="keyword" id="5547672">func</span><span class="op" id="5547676">(</span><span class="ident" id="5547677">i</span>&nbsp;<span class="op" id="5547679">*</span><span class="ident" id="5547680">encInstr</span><span class="op" id="5547688">,</span>&nbsp;<span class="ident" id="5547690">state</span>&nbsp;<span class="op" id="5547696">*</span><span class="ident" id="5547697">encoderState</span><span class="op" id="5547709">,</span>&nbsp;<span class="ident" id="5547711">v</span>&nbsp;<span class="ident" id="5547713">reflect</span><span class="op" id="5547720">.</span><span class="ident" id="5547721">Value</span><span class="op" id="5547726">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5547729">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="5547775">type</span>&nbsp;<span class="ident" id="5547780">encInstr</span>&nbsp;<span class="keyword" id="5547789">struct</span>&nbsp;<span class="op" id="5547796">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547799">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547805">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547812">field</span>&nbsp;<span class="builtintype" id="5547818">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5547824">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547850">index</span>&nbsp;<span class="op" id="5547856">[</span><span class="op" id="5547857">]</span><span class="builtintype" id="5547858">int</span>&nbsp;<span class="comment" id="5547862">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5547879">indir</span>&nbsp;<span class="builtintype" id="5547885">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5547891">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="5547957">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5547960">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="5548053">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="5548107">func</span>&nbsp;<span class="op" id="5548112">(</span><span class="ident" id="5548113">state</span>&nbsp;<span class="op" id="5548119">*</span><span class="ident" id="5548120">encoderState</span><span class="op" id="5548132">)</span>&nbsp;<span class="ident" id="5548134">update</span><span class="op" id="5548140">(</span><span class="ident" id="5548141">instr</span>&nbsp;<span class="op" id="5548147">*</span><span class="ident" id="5548148">encInstr</span><span class="op" id="5548156">)</span>&nbsp;<span class="op" id="5548158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5548161">if</span>&nbsp;<span class="ident" id="5548164">instr</span>&nbsp;<span class="op" id="5548170">!=</span>&nbsp;<span class="builtintype" id="5548173">nil</span>&nbsp;<span class="op" id="5548177">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5548181">state</span><span class="op" id="5548186">.</span><span class="ident" id="5548187">encodeUint</span><span class="op" id="5548197">(</span><span class="ident" id="5548198">uint64</span><span class="op" id="5548204">(</span><span class="ident" id="5548205">instr</span><span class="op" id="5548210">.</span><span class="ident" id="5548211">field</span>&nbsp;<span class="op" id="5548217">-</span>&nbsp;<span class="ident" id="5548219">state</span><span class="op" id="5548224">.</span><span class="ident" id="5548225">fieldnum</span><span class="op" id="5548233">)</span><span class="op" id="5548234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5548238">state</span><span class="op" id="5548243">.</span><span class="ident" id="5548244">fieldnum</span>&nbsp;<span class="op" id="5548253">=</span>&nbsp;<span class="ident" id="5548255">instr</span><span class="op" id="5548260">.</span><span class="ident" id="5548261">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5548268">}</span><br>
<span class="lineno"></span><span class="op" id="5548270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="5548273">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="5548337">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="5548405">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5548472">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="5548539">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="5548603">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5548670">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="5548736">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5548748">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="5548815">func</span>&nbsp;<span class="ident" id="5548820">encIndirect</span><span class="op" id="5548831">(</span><span class="ident" id="5548832">pv</span>&nbsp;<span class="ident" id="5548835">reflect</span><span class="op" id="5548842">.</span><span class="ident" id="5548843">Value</span><span class="op" id="5548848">,</span>&nbsp;<span class="ident" id="5548850">indir</span>&nbsp;<span class="builtintype" id="5548856">int</span><span class="op" id="5548859">)</span>&nbsp;<span class="ident" id="5548861">reflect</span><span class="op" id="5548868">.</span><span class="ident" id="5548869">Value</span>&nbsp;<span class="op" id="5548875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5548878">for</span>&nbsp;<span class="op" id="5548882">;</span>&nbsp;<span class="ident" id="5548884">indir</span>&nbsp;<span class="op" id="5548890">&gt;</span>&nbsp;<span class="num" id="5548892">0</span><span class="op" id="5548893">;</span>&nbsp;<span class="ident" id="5548895">indir</span><span class="op" id="5548900">--</span>&nbsp;<span class="op" id="5548903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5548907">if</span>&nbsp;<span class="ident" id="5548910">pv</span><span class="op" id="5548912">.</span><span class="ident" id="5548913">IsNil</span><span class="op" id="5548918">(</span><span class="op" id="5548919">)</span>&nbsp;<span class="op" id="5548921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5548926">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5548934">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5548938">pv</span>&nbsp;<span class="op" id="5548941">=</span>&nbsp;<span class="ident" id="5548943">pv</span><span class="op" id="5548945">.</span><span class="ident" id="5548946">Elem</span><span class="op" id="5548950">(</span><span class="op" id="5548951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5548954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5548957">return</span>&nbsp;<span class="ident" id="5548964">pv</span><br>
<span class="lineno"></span><span class="op" id="5548967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="5548970">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="5549037">func</span>&nbsp;<span class="ident" id="5549042">encBool</span><span class="op" id="5549049">(</span><span class="ident" id="5549050">i</span>&nbsp;<span class="op" id="5549052">*</span><span class="ident" id="5549053">encInstr</span><span class="op" id="5549061">,</span>&nbsp;<span class="ident" id="5549063">state</span>&nbsp;<span class="op" id="5549069">*</span><span class="ident" id="5549070">encoderState</span><span class="op" id="5549082">,</span>&nbsp;<span class="ident" id="5549084">v</span>&nbsp;<span class="ident" id="5549086">reflect</span><span class="op" id="5549093">.</span><span class="ident" id="5549094">Value</span><span class="op" id="5549099">)</span>&nbsp;<span class="op" id="5549101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549104">b</span>&nbsp;<span class="op" id="5549106">:=</span>&nbsp;<span class="ident" id="5549109">v</span><span class="op" id="5549110">.</span><span class="ident" id="5549111">Bool</span><span class="op" id="5549115">(</span><span class="op" id="5549116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5549119">if</span>&nbsp;<span class="ident" id="5549122">b</span>&nbsp;<span class="op" id="5549124">||</span>&nbsp;<span class="ident" id="5549127">state</span><span class="op" id="5549132">.</span><span class="ident" id="5549133">sendZero</span>&nbsp;<span class="op" id="5549142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549146">state</span><span class="op" id="5549151">.</span><span class="ident" id="5549152">update</span><span class="op" id="5549158">(</span><span class="ident" id="5549159">i</span><span class="op" id="5549160">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5549164">if</span>&nbsp;<span class="ident" id="5549167">b</span>&nbsp;<span class="op" id="5549169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549174">state</span><span class="op" id="5549179">.</span><span class="ident" id="5549180">encodeUint</span><span class="op" id="5549190">(</span><span class="num" id="5549191">1</span><span class="op" id="5549192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5549196">}</span>&nbsp;<span class="keyword" id="5549198">else</span>&nbsp;<span class="op" id="5549203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549208">state</span><span class="op" id="5549213">.</span><span class="ident" id="5549214">encodeUint</span><span class="op" id="5549224">(</span><span class="num" id="5549225">0</span><span class="op" id="5549226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5549230">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5549233">}</span><br>
<span class="lineno"></span><span class="op" id="5549235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5549238">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5549321">func</span>&nbsp;<span class="ident" id="5549326">encInt</span><span class="op" id="5549332">(</span><span class="ident" id="5549333">i</span>&nbsp;<span class="op" id="5549335">*</span><span class="ident" id="5549336">encInstr</span><span class="op" id="5549344">,</span>&nbsp;<span class="ident" id="5549346">state</span>&nbsp;<span class="op" id="5549352">*</span><span class="ident" id="5549353">encoderState</span><span class="op" id="5549365">,</span>&nbsp;<span class="ident" id="5549367">v</span>&nbsp;<span class="ident" id="5549369">reflect</span><span class="op" id="5549376">.</span><span class="ident" id="5549377">Value</span><span class="op" id="5549382">)</span>&nbsp;<span class="op" id="5549384">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549387">value</span>&nbsp;<span class="op" id="5549393">:=</span>&nbsp;<span class="ident" id="5549396">v</span><span class="op" id="5549397">.</span><span class="ident" id="5549398">Int</span><span class="op" id="5549401">(</span><span class="op" id="5549402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5549405">if</span>&nbsp;<span class="ident" id="5549408">value</span>&nbsp;<span class="op" id="5549414">!=</span>&nbsp;<span class="num" id="5549417">0</span>&nbsp;<span class="op" id="5549419">||</span>&nbsp;<span class="ident" id="5549422">state</span><span class="op" id="5549427">.</span><span class="ident" id="5549428">sendZero</span>&nbsp;<span class="op" id="5549437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549441">state</span><span class="op" id="5549446">.</span><span class="ident" id="5549447">update</span><span class="op" id="5549453">(</span><span class="ident" id="5549454">i</span><span class="op" id="5549455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549459">state</span><span class="op" id="5549464">.</span><span class="ident" id="5549465">encodeInt</span><span class="op" id="5549474">(</span><span class="ident" id="5549475">value</span><span class="op" id="5549480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5549483">}</span><br>
<span class="lineno">180</span><span class="op" id="5549485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5549488">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5549587">func</span>&nbsp;<span class="ident" id="5549592">encUint</span><span class="op" id="5549599">(</span><span class="ident" id="5549600">i</span>&nbsp;<span class="op" id="5549602">*</span><span class="ident" id="5549603">encInstr</span><span class="op" id="5549611">,</span>&nbsp;<span class="ident" id="5549613">state</span>&nbsp;<span class="op" id="5549619">*</span><span class="ident" id="5549620">encoderState</span><span class="op" id="5549632">,</span>&nbsp;<span class="ident" id="5549634">v</span>&nbsp;<span class="ident" id="5549636">reflect</span><span class="op" id="5549643">.</span><span class="ident" id="5549644">Value</span><span class="op" id="5549649">)</span>&nbsp;<span class="op" id="5549651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549654">value</span>&nbsp;<span class="op" id="5549660">:=</span>&nbsp;<span class="ident" id="5549663">v</span><span class="op" id="5549664">.</span><span class="ident" id="5549665">Uint</span><span class="op" id="5549669">(</span><span class="op" id="5549670">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5549673">if</span>&nbsp;<span class="ident" id="5549676">value</span>&nbsp;<span class="op" id="5549682">!=</span>&nbsp;<span class="num" id="5549685">0</span>&nbsp;<span class="op" id="5549687">||</span>&nbsp;<span class="ident" id="5549690">state</span><span class="op" id="5549695">.</span><span class="ident" id="5549696">sendZero</span>&nbsp;<span class="op" id="5549705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549709">state</span><span class="op" id="5549714">.</span><span class="ident" id="5549715">update</span><span class="op" id="5549721">(</span><span class="ident" id="5549722">i</span><span class="op" id="5549723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5549727">state</span><span class="op" id="5549732">.</span><span class="ident" id="5549733">encodeUint</span><span class="op" id="5549743">(</span><span class="ident" id="5549744">value</span><span class="op" id="5549749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5549752">}</span><br>
<span class="lineno"></span><span class="op" id="5549754">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5549757">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="5549832">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="5549902">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="5549974">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="5550046">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5550111">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="5550125">func</span>&nbsp;<span class="ident" id="5550130">floatBits</span><span class="op" id="5550139">(</span><span class="ident" id="5550140">f</span>&nbsp;<span class="builtintype" id="5550142">float64</span><span class="op" id="5550149">)</span>&nbsp;<span class="ident" id="5550151">uint64</span>&nbsp;<span class="op" id="5550158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550161">u</span>&nbsp;<span class="op" id="5550163">:=</span>&nbsp;<span class="ident" id="5550166">math</span><span class="op" id="5550170">.</span><span class="ident" id="5550171">Float64bits</span><span class="op" id="5550182">(</span><span class="ident" id="5550183">f</span><span class="op" id="5550184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5550187">var</span>&nbsp;<span class="ident" id="5550191">v</span>&nbsp;<span class="ident" id="5550193">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5550201">for</span>&nbsp;<span class="ident" id="5550205">i</span>&nbsp;<span class="op" id="5550207">:=</span>&nbsp;<span class="num" id="5550210">0</span><span class="op" id="5550211">;</span>&nbsp;<span class="ident" id="5550213">i</span>&nbsp;<span class="op" id="5550215">&lt;</span>&nbsp;<span class="num" id="5550217">8</span><span class="op" id="5550218">;</span>&nbsp;<span class="ident" id="5550220">i</span><span class="op" id="5550221">++</span>&nbsp;<span class="op" id="5550224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550228">v</span>&nbsp;<span class="op" id="5550230">&lt;&lt;=</span>&nbsp;<span class="num" id="5550234">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550238">v</span>&nbsp;<span class="op" id="5550240">|=</span>&nbsp;<span class="ident" id="5550243">u</span>&nbsp;<span class="op" id="5550245">&amp;</span>&nbsp;<span class="num" id="5550247">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550254">u</span>&nbsp;<span class="op" id="5550256">&gt;&gt;=</span>&nbsp;<span class="num" id="5550260">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5550263">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5550266">return</span>&nbsp;<span class="ident" id="5550273">v</span><br>
<span class="lineno"></span><span class="op" id="5550275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5550278">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5550358">func</span>&nbsp;<span class="ident" id="5550363">encFloat</span><span class="op" id="5550371">(</span><span class="ident" id="5550372">i</span>&nbsp;<span class="op" id="5550374">*</span><span class="ident" id="5550375">encInstr</span><span class="op" id="5550383">,</span>&nbsp;<span class="ident" id="5550385">state</span>&nbsp;<span class="op" id="5550391">*</span><span class="ident" id="5550392">encoderState</span><span class="op" id="5550404">,</span>&nbsp;<span class="ident" id="5550406">v</span>&nbsp;<span class="ident" id="5550408">reflect</span><span class="op" id="5550415">.</span><span class="ident" id="5550416">Value</span><span class="op" id="5550421">)</span>&nbsp;<span class="op" id="5550423">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550426">f</span>&nbsp;<span class="op" id="5550428">:=</span>&nbsp;<span class="ident" id="5550431">v</span><span class="op" id="5550432">.</span><span class="ident" id="5550433">Float</span><span class="op" id="5550438">(</span><span class="op" id="5550439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5550442">if</span>&nbsp;<span class="ident" id="5550445">f</span>&nbsp;<span class="op" id="5550447">!=</span>&nbsp;<span class="num" id="5550450">0</span>&nbsp;<span class="op" id="5550452">||</span>&nbsp;<span class="ident" id="5550455">state</span><span class="op" id="5550460">.</span><span class="ident" id="5550461">sendZero</span>&nbsp;<span class="op" id="5550470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550474">bits</span>&nbsp;<span class="op" id="5550479">:=</span>&nbsp;<span class="ident" id="5550482">floatBits</span><span class="op" id="5550491">(</span><span class="ident" id="5550492">f</span><span class="op" id="5550493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550497">state</span><span class="op" id="5550502">.</span><span class="ident" id="5550503">update</span><span class="op" id="5550509">(</span><span class="ident" id="5550510">i</span><span class="op" id="5550511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550515">state</span><span class="op" id="5550520">.</span><span class="ident" id="5550521">encodeUint</span><span class="op" id="5550531">(</span><span class="ident" id="5550532">bits</span><span class="op" id="5550536">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5550539">}</span><br>
<span class="lineno"></span><span class="op" id="5550541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5550544">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5550624">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="5550703">func</span>&nbsp;<span class="ident" id="5550708">encComplex</span><span class="op" id="5550718">(</span><span class="ident" id="5550719">i</span>&nbsp;<span class="op" id="5550721">*</span><span class="ident" id="5550722">encInstr</span><span class="op" id="5550730">,</span>&nbsp;<span class="ident" id="5550732">state</span>&nbsp;<span class="op" id="5550738">*</span><span class="ident" id="5550739">encoderState</span><span class="op" id="5550751">,</span>&nbsp;<span class="ident" id="5550753">v</span>&nbsp;<span class="ident" id="5550755">reflect</span><span class="op" id="5550762">.</span><span class="ident" id="5550763">Value</span><span class="op" id="5550768">)</span>&nbsp;<span class="op" id="5550770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550773">c</span>&nbsp;<span class="op" id="5550775">:=</span>&nbsp;<span class="ident" id="5550778">v</span><span class="op" id="5550779">.</span><span class="ident" id="5550780">Complex</span><span class="op" id="5550787">(</span><span class="op" id="5550788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5550791">if</span>&nbsp;<span class="ident" id="5550794">c</span>&nbsp;<span class="op" id="5550796">!=</span>&nbsp;<span class="num" id="5550799">0</span><span class="op" id="5550800">+</span><span class="num" id="5550801">0i</span>&nbsp;<span class="op" id="5550804">||</span>&nbsp;<span class="ident" id="5550807">state</span><span class="op" id="5550812">.</span><span class="ident" id="5550813">sendZero</span>&nbsp;<span class="op" id="5550822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550826">rpart</span>&nbsp;<span class="op" id="5550832">:=</span>&nbsp;<span class="ident" id="5550835">floatBits</span><span class="op" id="5550844">(</span><span class="builtinfunc" id="5550845">real</span><span class="op" id="5550849">(</span><span class="ident" id="5550850">c</span><span class="op" id="5550851">)</span><span class="op" id="5550852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550856">ipart</span>&nbsp;<span class="op" id="5550862">:=</span>&nbsp;<span class="ident" id="5550865">floatBits</span><span class="op" id="5550874">(</span><span class="builtinfunc" id="5550875">imag</span><span class="op" id="5550879">(</span><span class="ident" id="5550880">c</span><span class="op" id="5550881">)</span><span class="op" id="5550882">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550886">state</span><span class="op" id="5550891">.</span><span class="ident" id="5550892">update</span><span class="op" id="5550898">(</span><span class="ident" id="5550899">i</span><span class="op" id="5550900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550904">state</span><span class="op" id="5550909">.</span><span class="ident" id="5550910">encodeUint</span><span class="op" id="5550920">(</span><span class="ident" id="5550921">rpart</span><span class="op" id="5550926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5550930">state</span><span class="op" id="5550935">.</span><span class="ident" id="5550936">encodeUint</span><span class="op" id="5550946">(</span><span class="ident" id="5550947">ipart</span><span class="op" id="5550952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5550955">}</span><br>
<span class="lineno"></span><span class="op" id="5550957">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5550960">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5551017">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5551092">func</span>&nbsp;<span class="ident" id="5551097">encUint8Array</span><span class="op" id="5551110">(</span><span class="ident" id="5551111">i</span>&nbsp;<span class="op" id="5551113">*</span><span class="ident" id="5551114">encInstr</span><span class="op" id="5551122">,</span>&nbsp;<span class="ident" id="5551124">state</span>&nbsp;<span class="op" id="5551130">*</span><span class="ident" id="5551131">encoderState</span><span class="op" id="5551143">,</span>&nbsp;<span class="ident" id="5551145">v</span>&nbsp;<span class="ident" id="5551147">reflect</span><span class="op" id="5551154">.</span><span class="ident" id="5551155">Value</span><span class="op" id="5551160">)</span>&nbsp;<span class="op" id="5551162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5551165">b</span>&nbsp;<span class="op" id="5551167">:=</span>&nbsp;<span class="ident" id="5551170">v</span><span class="op" id="5551171">.</span><span class="ident" id="5551172">Bytes</span><span class="op" id="5551177">(</span><span class="op" id="5551178">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5551181">if</span>&nbsp;<span class="builtinfunc" id="5551184">len</span><span class="op" id="5551187">(</span><span class="ident" id="5551188">b</span><span class="op" id="5551189">)</span>&nbsp;<span class="op" id="5551191">&gt;</span>&nbsp;<span class="num" id="5551193">0</span>&nbsp;<span class="op" id="5551195">||</span>&nbsp;<span class="ident" id="5551198">state</span><span class="op" id="5551203">.</span><span class="ident" id="5551204">sendZero</span>&nbsp;<span class="op" id="5551213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5551217">state</span><span class="op" id="5551222">.</span><span class="ident" id="5551223">update</span><span class="op" id="5551229">(</span><span class="ident" id="5551230">i</span><span class="op" id="5551231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5551235">state</span><span class="op" id="5551240">.</span><span class="ident" id="5551241">encodeUint</span><span class="op" id="5551251">(</span><span class="ident" id="5551252">uint64</span><span class="op" id="5551258">(</span><span class="builtinfunc" id="5551259">len</span><span class="op" id="5551262">(</span><span class="ident" id="5551263">b</span><span class="op" id="5551264">)</span><span class="op" id="5551265">)</span><span class="op" id="5551266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5551270">state</span><span class="op" id="5551275">.</span><span class="ident" id="5551276">b</span><span class="op" id="5551277">.</span><span class="ident" id="5551278">Write</span><span class="op" id="5551283">(</span><span class="ident" id="5551284">b</span><span class="op" id="5551285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5551288">}</span><br>
<span class="lineno">240</span><span class="op" id="5551290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5551293">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5551342">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="5551413">func</span>&nbsp;<span class="ident" id="5551418">encString</span><span class="op" id="5551427">(</span><span class="ident" id="5551428">i</span>&nbsp;<span class="op" id="5551430">*</span><span class="ident" id="5551431">encInstr</span><span class="op" id="5551439">,</span>&nbsp;<span class="ident" id="5551441">state</span>&nbsp;<span class="op" id="5551447">*</span><span class="ident" id="5551448">encoderState</span><span class="op" id="5551460">,</span>&nbsp;<span class="ident" id="5551462">v</span>&nbsp;<span class="ident" id="5551464">reflect</span><span class="op" id="5551471">.</span><span class="ident" id="5551472">Value</span><span class="op" id="5551477">)</span>&nbsp;<span class="op" id="5551479">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5551482">s</span>&nbsp;<span class="op" id="5551484">:=</span>&nbsp;<span class="ident" id="5551487">v</span><span class="op" id="5551488">.</span><span class="ident" id="5551489">String</span><span class="op" id="5551495">(</span><span class="op" id="5551496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5551499">if</span>&nbsp;<span class="builtinfunc" id="5551502">len</span><span class="op" id="5551505">(</span><span class="ident" id="5551506">s</span><span class="op" id="5551507">)</span>&nbsp;<span class="op" id="5551509">&gt;</span>&nbsp;<span class="num" id="5551511">0</span>&nbsp;<span class="op" id="5551513">||</span>&nbsp;<span class="ident" id="5551516">state</span><span class="op" id="5551521">.</span><span class="ident" id="5551522">sendZero</span>&nbsp;<span class="op" id="5551531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5551535">state</span><span class="op" id="5551540">.</span><span class="ident" id="5551541">update</span><span class="op" id="5551547">(</span><span class="ident" id="5551548">i</span><span class="op" id="5551549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5551553">state</span><span class="op" id="5551558">.</span><span class="ident" id="5551559">encodeUint</span><span class="op" id="5551569">(</span><span class="ident" id="5551570">uint64</span><span class="op" id="5551576">(</span><span class="builtinfunc" id="5551577">len</span><span class="op" id="5551580">(</span><span class="ident" id="5551581">s</span><span class="op" id="5551582">)</span><span class="op" id="5551583">)</span><span class="op" id="5551584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5551588">state</span><span class="op" id="5551593">.</span><span class="ident" id="5551594">b</span><span class="op" id="5551595">.</span><span class="ident" id="5551596">WriteString</span><span class="op" id="5551607">(</span><span class="ident" id="5551608">s</span><span class="op" id="5551609">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5551612">}</span><br>
<span class="lineno"></span><span class="op" id="5551614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5551617">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="5551677">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="5551708">func</span>&nbsp;<span class="ident" id="5551713">encStructTerminator</span><span class="op" id="5551732">(</span><span class="ident" id="5551733">i</span>&nbsp;<span class="op" id="5551735">*</span><span class="ident" id="5551736">encInstr</span><span class="op" id="5551744">,</span>&nbsp;<span class="ident" id="5551746">state</span>&nbsp;<span class="op" id="5551752">*</span><span class="ident" id="5551753">encoderState</span><span class="op" id="5551765">,</span>&nbsp;<span class="ident" id="5551767">v</span>&nbsp;<span class="ident" id="5551769">reflect</span><span class="op" id="5551776">.</span><span class="ident" id="5551777">Value</span><span class="op" id="5551782">)</span>&nbsp;<span class="op" id="5551784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5551787">state</span><span class="op" id="5551792">.</span><span class="ident" id="5551793">encodeUint</span><span class="op" id="5551803">(</span><span class="num" id="5551804">0</span><span class="op" id="5551805">)</span><br>
<span class="lineno"></span><span class="op" id="5551807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5551810">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5551831">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="5551909">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="5551989">type</span>&nbsp;<span class="ident" id="5551994">encEngine</span>&nbsp;<span class="keyword" id="5552004">struct</span>&nbsp;<span class="op" id="5552011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5552014">instr</span>&nbsp;<span class="op" id="5552020">[</span><span class="op" id="5552021">]</span><span class="ident" id="5552022">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="5552031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5552034">const</span>&nbsp;<span class="ident" id="5552040">singletonField</span>&nbsp;<span class="op" id="5552055">=</span>&nbsp;<span class="num" id="5552057">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5552060">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="5552127">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="5552181">func</span>&nbsp;<span class="ident" id="5552186">valid</span><span class="op" id="5552191">(</span><span class="ident" id="5552192">v</span>&nbsp;<span class="ident" id="5552194">reflect</span><span class="op" id="5552201">.</span><span class="ident" id="5552202">Value</span><span class="op" id="5552207">)</span>&nbsp;<span class="builtintype" id="5552209">bool</span>&nbsp;<span class="op" id="5552214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5552217">switch</span>&nbsp;<span class="ident" id="5552224">v</span><span class="op" id="5552225">.</span><span class="ident" id="5552226">Kind</span><span class="op" id="5552230">(</span><span class="op" id="5552231">)</span>&nbsp;<span class="op" id="5552233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5552236">case</span>&nbsp;<span class="ident" id="5552241">reflect</span><span class="op" id="5552248">.</span><span class="ident" id="5552249">Invalid</span><span class="op" id="5552256">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5552260">return</span>&nbsp;<span class="builtintype" id="5552267">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5552274">case</span>&nbsp;<span class="ident" id="5552279">reflect</span><span class="op" id="5552286">.</span><span class="ident" id="5552287">Ptr</span><span class="op" id="5552290">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5552294">return</span>&nbsp;<span class="op" id="5552301">!</span><span class="ident" id="5552302">v</span><span class="op" id="5552303">.</span><span class="ident" id="5552304">IsNil</span><span class="op" id="5552309">(</span><span class="op" id="5552310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5552313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5552316">return</span>&nbsp;<span class="builtintype" id="5552323">true</span><br>
<span class="lineno"></span><span class="op" id="5552328">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="5552331">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5552392">func</span>&nbsp;<span class="op" id="5552397">(</span><span class="ident" id="5552398">enc</span>&nbsp;<span class="op" id="5552402">*</span><span class="ident" id="5552403">Encoder</span><span class="op" id="5552410">)</span>&nbsp;<span class="ident" id="5552412">encodeSingle</span><span class="op" id="5552424">(</span><span class="ident" id="5552425">b</span>&nbsp;<span class="op" id="5552427">*</span><span class="ident" id="5552428">encBuffer</span><span class="op" id="5552437">,</span>&nbsp;<span class="ident" id="5552439">engine</span>&nbsp;<span class="op" id="5552446">*</span><span class="ident" id="5552447">encEngine</span><span class="op" id="5552456">,</span>&nbsp;<span class="ident" id="5552458">value</span>&nbsp;<span class="ident" id="5552464">reflect</span><span class="op" id="5552471">.</span><span class="ident" id="5552472">Value</span><span class="op" id="5552477">)</span>&nbsp;<span class="op" id="5552479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5552482">state</span>&nbsp;<span class="op" id="5552488">:=</span>&nbsp;<span class="ident" id="5552491">enc</span><span class="op" id="5552494">.</span><span class="ident" id="5552495">newEncoderState</span><span class="op" id="5552510">(</span><span class="ident" id="5552511">b</span><span class="op" id="5552512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5552515">defer</span>&nbsp;<span class="ident" id="5552521">enc</span><span class="op" id="5552524">.</span><span class="ident" id="5552525">freeEncoderState</span><span class="op" id="5552541">(</span><span class="ident" id="5552542">state</span><span class="op" id="5552547">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5552550">state</span><span class="op" id="5552555">.</span><span class="ident" id="5552556">fieldnum</span>&nbsp;<span class="op" id="5552565">=</span>&nbsp;<span class="ident" id="5552567">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5552583">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5552656">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5552727">state</span><span class="op" id="5552732">.</span><span class="ident" id="5552733">sendZero</span>&nbsp;<span class="op" id="5552742">=</span>&nbsp;<span class="builtintype" id="5552744">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5552750">instr</span>&nbsp;<span class="op" id="5552756">:=</span>&nbsp;<span class="op" id="5552759">&amp;</span><span class="ident" id="5552760">engine</span><span class="op" id="5552766">.</span><span class="ident" id="5552767">instr</span><span class="op" id="5552772">[</span><span class="ident" id="5552773">singletonField</span><span class="op" id="5552787">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5552790">if</span>&nbsp;<span class="ident" id="5552793">instr</span><span class="op" id="5552798">.</span><span class="ident" id="5552799">indir</span>&nbsp;<span class="op" id="5552805">&gt;</span>&nbsp;<span class="num" id="5552807">0</span>&nbsp;<span class="op" id="5552809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5552813">value</span>&nbsp;<span class="op" id="5552819">=</span>&nbsp;<span class="ident" id="5552821">encIndirect</span><span class="op" id="5552832">(</span><span class="ident" id="5552833">value</span><span class="op" id="5552838">,</span>&nbsp;<span class="ident" id="5552840">instr</span><span class="op" id="5552845">.</span><span class="ident" id="5552846">indir</span><span class="op" id="5552851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5552854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5552857">if</span>&nbsp;<span class="ident" id="5552860">valid</span><span class="op" id="5552865">(</span><span class="ident" id="5552866">value</span><span class="op" id="5552871">)</span>&nbsp;<span class="op" id="5552873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5552877">instr</span><span class="op" id="5552882">.</span><span class="ident" id="5552883">op</span><span class="op" id="5552885">(</span><span class="ident" id="5552886">instr</span><span class="op" id="5552891">,</span>&nbsp;<span class="ident" id="5552893">state</span><span class="op" id="5552898">,</span>&nbsp;<span class="ident" id="5552900">value</span><span class="op" id="5552905">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5552908">}</span><br>
<span class="lineno"></span><span class="op" id="5552910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5552913">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5552960">func</span>&nbsp;<span class="op" id="5552965">(</span><span class="ident" id="5552966">enc</span>&nbsp;<span class="op" id="5552970">*</span><span class="ident" id="5552971">Encoder</span><span class="op" id="5552978">)</span>&nbsp;<span class="ident" id="5552980">encodeStruct</span><span class="op" id="5552992">(</span><span class="ident" id="5552993">b</span>&nbsp;<span class="op" id="5552995">*</span><span class="ident" id="5552996">encBuffer</span><span class="op" id="5553005">,</span>&nbsp;<span class="ident" id="5553007">engine</span>&nbsp;<span class="op" id="5553014">*</span><span class="ident" id="5553015">encEngine</span><span class="op" id="5553024">,</span>&nbsp;<span class="ident" id="5553026">value</span>&nbsp;<span class="ident" id="5553032">reflect</span><span class="op" id="5553039">.</span><span class="ident" id="5553040">Value</span><span class="op" id="5553045">)</span>&nbsp;<span class="op" id="5553047">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553050">if</span>&nbsp;<span class="op" id="5553053">!</span><span class="ident" id="5553054">valid</span><span class="op" id="5553059">(</span><span class="ident" id="5553060">value</span><span class="op" id="5553065">)</span>&nbsp;<span class="op" id="5553067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553071">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5553079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5553082">state</span>&nbsp;<span class="op" id="5553088">:=</span>&nbsp;<span class="ident" id="5553091">enc</span><span class="op" id="5553094">.</span><span class="ident" id="5553095">newEncoderState</span><span class="op" id="5553110">(</span><span class="ident" id="5553111">b</span><span class="op" id="5553112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553115">defer</span>&nbsp;<span class="ident" id="5553121">enc</span><span class="op" id="5553124">.</span><span class="ident" id="5553125">freeEncoderState</span><span class="op" id="5553141">(</span><span class="ident" id="5553142">state</span><span class="op" id="5553147">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5553150">state</span><span class="op" id="5553155">.</span><span class="ident" id="5553156">fieldnum</span>&nbsp;<span class="op" id="5553165">=</span>&nbsp;<span class="op" id="5553167">-</span><span class="num" id="5553168">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553171">for</span>&nbsp;<span class="ident" id="5553175">i</span>&nbsp;<span class="op" id="5553177">:=</span>&nbsp;<span class="num" id="5553180">0</span><span class="op" id="5553181">;</span>&nbsp;<span class="ident" id="5553183">i</span>&nbsp;<span class="op" id="5553185">&lt;</span>&nbsp;<span class="builtinfunc" id="5553187">len</span><span class="op" id="5553190">(</span><span class="ident" id="5553191">engine</span><span class="op" id="5553197">.</span><span class="ident" id="5553198">instr</span><span class="op" id="5553203">)</span><span class="op" id="5553204">;</span>&nbsp;<span class="ident" id="5553206">i</span><span class="op" id="5553207">++</span>&nbsp;<span class="op" id="5553210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5553214">instr</span>&nbsp;<span class="op" id="5553220">:=</span>&nbsp;<span class="op" id="5553223">&amp;</span><span class="ident" id="5553224">engine</span><span class="op" id="5553230">.</span><span class="ident" id="5553231">instr</span><span class="op" id="5553236">[</span><span class="ident" id="5553237">i</span><span class="op" id="5553238">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553242">if</span>&nbsp;<span class="ident" id="5553245">i</span>&nbsp;<span class="op" id="5553247">&gt;=</span>&nbsp;<span class="ident" id="5553250">value</span><span class="op" id="5553255">.</span><span class="ident" id="5553256">NumField</span><span class="op" id="5553264">(</span><span class="op" id="5553265">)</span>&nbsp;<span class="op" id="5553267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5553272">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5553298">instr</span><span class="op" id="5553303">.</span><span class="ident" id="5553304">op</span><span class="op" id="5553306">(</span><span class="ident" id="5553307">instr</span><span class="op" id="5553312">,</span>&nbsp;<span class="ident" id="5553314">state</span><span class="op" id="5553319">,</span>&nbsp;<span class="ident" id="5553321">reflect</span><span class="op" id="5553328">.</span><span class="ident" id="5553329">Value</span><span class="op" id="5553334">{</span><span class="op" id="5553335">}</span><span class="op" id="5553336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553341">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5553349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5553353">field</span>&nbsp;<span class="op" id="5553359">:=</span>&nbsp;<span class="ident" id="5553362">value</span><span class="op" id="5553367">.</span><span class="ident" id="5553368">FieldByIndex</span><span class="op" id="5553380">(</span><span class="ident" id="5553381">instr</span><span class="op" id="5553386">.</span><span class="ident" id="5553387">index</span><span class="op" id="5553392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553396">if</span>&nbsp;<span class="ident" id="5553399">instr</span><span class="op" id="5553404">.</span><span class="ident" id="5553405">indir</span>&nbsp;<span class="op" id="5553411">&gt;</span>&nbsp;<span class="num" id="5553413">0</span>&nbsp;<span class="op" id="5553415">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5553420">field</span>&nbsp;<span class="op" id="5553426">=</span>&nbsp;<span class="ident" id="5553428">encIndirect</span><span class="op" id="5553439">(</span><span class="ident" id="5553440">field</span><span class="op" id="5553445">,</span>&nbsp;<span class="ident" id="5553447">instr</span><span class="op" id="5553452">.</span><span class="ident" id="5553453">indir</span><span class="op" id="5553458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5553463">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553535">if</span>&nbsp;<span class="op" id="5553538">!</span><span class="ident" id="5553539">valid</span><span class="op" id="5553544">(</span><span class="ident" id="5553545">field</span><span class="op" id="5553550">)</span>&nbsp;<span class="op" id="5553552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553558">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5553570">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5553574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5553578">instr</span><span class="op" id="5553583">.</span><span class="ident" id="5553584">op</span><span class="op" id="5553586">(</span><span class="ident" id="5553587">instr</span><span class="op" id="5553592">,</span>&nbsp;<span class="ident" id="5553594">state</span><span class="op" id="5553599">,</span>&nbsp;<span class="ident" id="5553601">field</span><span class="op" id="5553606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5553609">}</span><br>
<span class="lineno"></span><span class="op" id="5553611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="5553614">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5553647">func</span>&nbsp;<span class="op" id="5553652">(</span><span class="ident" id="5553653">enc</span>&nbsp;<span class="op" id="5553657">*</span><span class="ident" id="5553658">Encoder</span><span class="op" id="5553665">)</span>&nbsp;<span class="ident" id="5553667">encodeArray</span><span class="op" id="5553678">(</span><span class="ident" id="5553679">b</span>&nbsp;<span class="op" id="5553681">*</span><span class="ident" id="5553682">encBuffer</span><span class="op" id="5553691">,</span>&nbsp;<span class="ident" id="5553693">value</span>&nbsp;<span class="ident" id="5553699">reflect</span><span class="op" id="5553706">.</span><span class="ident" id="5553707">Value</span><span class="op" id="5553712">,</span>&nbsp;<span class="ident" id="5553714">op</span>&nbsp;<span class="ident" id="5553717">encOp</span><span class="op" id="5553722">,</span>&nbsp;<span class="ident" id="5553724">elemIndir</span>&nbsp;<span class="builtintype" id="5553734">int</span><span class="op" id="5553737">,</span>&nbsp;<span class="ident" id="5553739">length</span>&nbsp;<span class="builtintype" id="5553746">int</span><span class="op" id="5553749">,</span>&nbsp;<span class="ident" id="5553751">helper</span>&nbsp;<span class="ident" id="5553758">encHelper</span><span class="op" id="5553767">)</span>&nbsp;<span class="op" id="5553769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5553772">state</span>&nbsp;<span class="op" id="5553778">:=</span>&nbsp;<span class="ident" id="5553781">enc</span><span class="op" id="5553784">.</span><span class="ident" id="5553785">newEncoderState</span><span class="op" id="5553800">(</span><span class="ident" id="5553801">b</span><span class="op" id="5553802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553805">defer</span>&nbsp;<span class="ident" id="5553811">enc</span><span class="op" id="5553814">.</span><span class="ident" id="5553815">freeEncoderState</span><span class="op" id="5553831">(</span><span class="ident" id="5553832">state</span><span class="op" id="5553837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5553840">state</span><span class="op" id="5553845">.</span><span class="ident" id="5553846">fieldnum</span>&nbsp;<span class="op" id="5553855">=</span>&nbsp;<span class="op" id="5553857">-</span><span class="num" id="5553858">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5553861">state</span><span class="op" id="5553866">.</span><span class="ident" id="5553867">sendZero</span>&nbsp;<span class="op" id="5553876">=</span>&nbsp;<span class="builtintype" id="5553878">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5553884">state</span><span class="op" id="5553889">.</span><span class="ident" id="5553890">encodeUint</span><span class="op" id="5553900">(</span><span class="ident" id="5553901">uint64</span><span class="op" id="5553907">(</span><span class="ident" id="5553908">length</span><span class="op" id="5553914">)</span><span class="op" id="5553915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553918">if</span>&nbsp;<span class="ident" id="5553921">helper</span>&nbsp;<span class="op" id="5553928">!=</span>&nbsp;<span class="builtintype" id="5553931">nil</span>&nbsp;<span class="op" id="5553935">&amp;&amp;</span>&nbsp;<span class="ident" id="5553938">helper</span><span class="op" id="5553944">(</span><span class="ident" id="5553945">state</span><span class="op" id="5553950">,</span>&nbsp;<span class="ident" id="5553952">value</span><span class="op" id="5553957">)</span>&nbsp;<span class="op" id="5553959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553963">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5553971">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5553974">for</span>&nbsp;<span class="ident" id="5553978">i</span>&nbsp;<span class="op" id="5553980">:=</span>&nbsp;<span class="num" id="5553983">0</span><span class="op" id="5553984">;</span>&nbsp;<span class="ident" id="5553986">i</span>&nbsp;<span class="op" id="5553988">&lt;</span>&nbsp;<span class="ident" id="5553990">length</span><span class="op" id="5553996">;</span>&nbsp;<span class="ident" id="5553998">i</span><span class="op" id="5553999">++</span>&nbsp;<span class="op" id="5554002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554006">elem</span>&nbsp;<span class="op" id="5554011">:=</span>&nbsp;<span class="ident" id="5554014">value</span><span class="op" id="5554019">.</span><span class="ident" id="5554020">Index</span><span class="op" id="5554025">(</span><span class="ident" id="5554026">i</span><span class="op" id="5554027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5554031">if</span>&nbsp;<span class="ident" id="5554034">elemIndir</span>&nbsp;<span class="op" id="5554044">&gt;</span>&nbsp;<span class="num" id="5554046">0</span>&nbsp;<span class="op" id="5554048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554053">elem</span>&nbsp;<span class="op" id="5554058">=</span>&nbsp;<span class="ident" id="5554060">encIndirect</span><span class="op" id="5554071">(</span><span class="ident" id="5554072">elem</span><span class="op" id="5554076">,</span>&nbsp;<span class="ident" id="5554078">elemIndir</span><span class="op" id="5554087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5554092">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5554163">if</span>&nbsp;<span class="op" id="5554166">!</span><span class="ident" id="5554167">valid</span><span class="op" id="5554172">(</span><span class="ident" id="5554173">elem</span><span class="op" id="5554177">)</span>&nbsp;<span class="op" id="5554179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554185">errorf</span><span class="op" id="5554191">(</span><span class="string" id="5554192">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5554218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5554223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5554227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554231">op</span><span class="op" id="5554233">(</span><span class="builtintype" id="5554234">nil</span><span class="op" id="5554237">,</span>&nbsp;<span class="ident" id="5554239">state</span><span class="op" id="5554244">,</span>&nbsp;<span class="ident" id="5554246">elem</span><span class="op" id="5554250">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5554253">}</span><br>
<span class="lineno"></span><span class="op" id="5554255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5554258">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5554326">func</span>&nbsp;<span class="ident" id="5554331">encodeReflectValue</span><span class="op" id="5554349">(</span><span class="ident" id="5554350">state</span>&nbsp;<span class="op" id="5554356">*</span><span class="ident" id="5554357">encoderState</span><span class="op" id="5554369">,</span>&nbsp;<span class="ident" id="5554371">v</span>&nbsp;<span class="ident" id="5554373">reflect</span><span class="op" id="5554380">.</span><span class="ident" id="5554381">Value</span><span class="op" id="5554386">,</span>&nbsp;<span class="ident" id="5554388">op</span>&nbsp;<span class="ident" id="5554391">encOp</span><span class="op" id="5554396">,</span>&nbsp;<span class="ident" id="5554398">indir</span>&nbsp;<span class="builtintype" id="5554404">int</span><span class="op" id="5554407">)</span>&nbsp;<span class="op" id="5554409">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5554412">for</span>&nbsp;<span class="ident" id="5554416">i</span>&nbsp;<span class="op" id="5554418">:=</span>&nbsp;<span class="num" id="5554421">0</span><span class="op" id="5554422">;</span>&nbsp;<span class="ident" id="5554424">i</span>&nbsp;<span class="op" id="5554426">&lt;</span>&nbsp;<span class="ident" id="5554428">indir</span>&nbsp;<span class="op" id="5554434">&amp;&amp;</span>&nbsp;<span class="ident" id="5554437">v</span><span class="op" id="5554438">.</span><span class="ident" id="5554439">IsValid</span><span class="op" id="5554446">(</span><span class="op" id="5554447">)</span><span class="op" id="5554448">;</span>&nbsp;<span class="ident" id="5554450">i</span><span class="op" id="5554451">++</span>&nbsp;<span class="op" id="5554454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554458">v</span>&nbsp;<span class="op" id="5554460">=</span>&nbsp;<span class="ident" id="5554462">reflect</span><span class="op" id="5554469">.</span><span class="ident" id="5554470">Indirect</span><span class="op" id="5554478">(</span><span class="ident" id="5554479">v</span><span class="op" id="5554480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5554483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5554486">if</span>&nbsp;<span class="op" id="5554489">!</span><span class="ident" id="5554490">v</span><span class="op" id="5554491">.</span><span class="ident" id="5554492">IsValid</span><span class="op" id="5554499">(</span><span class="op" id="5554500">)</span>&nbsp;<span class="op" id="5554502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554506">errorf</span><span class="op" id="5554512">(</span><span class="string" id="5554513">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="5554546">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5554549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554552">op</span><span class="op" id="5554554">(</span><span class="builtintype" id="5554555">nil</span><span class="op" id="5554558">,</span>&nbsp;<span class="ident" id="5554560">state</span><span class="op" id="5554565">,</span>&nbsp;<span class="ident" id="5554567">v</span><span class="op" id="5554568">)</span><br>
<span class="lineno"></span><span class="op" id="5554570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5554573">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="5554647">func</span>&nbsp;<span class="op" id="5554652">(</span><span class="ident" id="5554653">enc</span>&nbsp;<span class="op" id="5554657">*</span><span class="ident" id="5554658">Encoder</span><span class="op" id="5554665">)</span>&nbsp;<span class="ident" id="5554667">encodeMap</span><span class="op" id="5554676">(</span><span class="ident" id="5554677">b</span>&nbsp;<span class="op" id="5554679">*</span><span class="ident" id="5554680">encBuffer</span><span class="op" id="5554689">,</span>&nbsp;<span class="ident" id="5554691">mv</span>&nbsp;<span class="ident" id="5554694">reflect</span><span class="op" id="5554701">.</span><span class="ident" id="5554702">Value</span><span class="op" id="5554707">,</span>&nbsp;<span class="ident" id="5554709">keyOp</span><span class="op" id="5554714">,</span>&nbsp;<span class="ident" id="5554716">elemOp</span>&nbsp;<span class="ident" id="5554723">encOp</span><span class="op" id="5554728">,</span>&nbsp;<span class="ident" id="5554730">keyIndir</span><span class="op" id="5554738">,</span>&nbsp;<span class="ident" id="5554740">elemIndir</span>&nbsp;<span class="builtintype" id="5554750">int</span><span class="op" id="5554753">)</span>&nbsp;<span class="op" id="5554755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554758">state</span>&nbsp;<span class="op" id="5554764">:=</span>&nbsp;<span class="ident" id="5554767">enc</span><span class="op" id="5554770">.</span><span class="ident" id="5554771">newEncoderState</span><span class="op" id="5554786">(</span><span class="ident" id="5554787">b</span><span class="op" id="5554788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554791">state</span><span class="op" id="5554796">.</span><span class="ident" id="5554797">fieldnum</span>&nbsp;<span class="op" id="5554806">=</span>&nbsp;<span class="op" id="5554808">-</span><span class="num" id="5554809">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554812">state</span><span class="op" id="5554817">.</span><span class="ident" id="5554818">sendZero</span>&nbsp;<span class="op" id="5554827">=</span>&nbsp;<span class="builtintype" id="5554829">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554835">keys</span>&nbsp;<span class="op" id="5554840">:=</span>&nbsp;<span class="ident" id="5554843">mv</span><span class="op" id="5554845">.</span><span class="ident" id="5554846">MapKeys</span><span class="op" id="5554853">(</span><span class="op" id="5554854">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554857">state</span><span class="op" id="5554862">.</span><span class="ident" id="5554863">encodeUint</span><span class="op" id="5554873">(</span><span class="ident" id="5554874">uint64</span><span class="op" id="5554880">(</span><span class="builtinfunc" id="5554881">len</span><span class="op" id="5554884">(</span><span class="ident" id="5554885">keys</span><span class="op" id="5554889">)</span><span class="op" id="5554890">)</span><span class="op" id="5554891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5554894">for</span>&nbsp;<span class="ident" id="5554898">_</span><span class="op" id="5554899">,</span>&nbsp;<span class="ident" id="5554901">key</span>&nbsp;<span class="op" id="5554905">:=</span>&nbsp;<span class="keyword" id="5554908">range</span>&nbsp;<span class="ident" id="5554914">keys</span>&nbsp;<span class="op" id="5554919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554923">encodeReflectValue</span><span class="op" id="5554941">(</span><span class="ident" id="5554942">state</span><span class="op" id="5554947">,</span>&nbsp;<span class="ident" id="5554949">key</span><span class="op" id="5554952">,</span>&nbsp;<span class="ident" id="5554954">keyOp</span><span class="op" id="5554959">,</span>&nbsp;<span class="ident" id="5554961">keyIndir</span><span class="op" id="5554969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5554973">encodeReflectValue</span><span class="op" id="5554991">(</span><span class="ident" id="5554992">state</span><span class="op" id="5554997">,</span>&nbsp;<span class="ident" id="5554999">mv</span><span class="op" id="5555001">.</span><span class="ident" id="5555002">MapIndex</span><span class="op" id="5555010">(</span><span class="ident" id="5555011">key</span><span class="op" id="5555014">)</span><span class="op" id="5555015">,</span>&nbsp;<span class="ident" id="5555017">elemOp</span><span class="op" id="5555023">,</span>&nbsp;<span class="ident" id="5555025">elemIndir</span><span class="op" id="5555034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5555037">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5555040">enc</span><span class="op" id="5555043">.</span><span class="ident" id="5555044">freeEncoderState</span><span class="op" id="5555060">(</span><span class="ident" id="5555061">state</span><span class="op" id="5555066">)</span><br>
<span class="lineno"></span><span class="op" id="5555068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5555071">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="5555122">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="5555204">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="5555291">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="5555374">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5555399">func</span>&nbsp;<span class="op" id="5555404">(</span><span class="ident" id="5555405">enc</span>&nbsp;<span class="op" id="5555409">*</span><span class="ident" id="5555410">Encoder</span><span class="op" id="5555417">)</span>&nbsp;<span class="ident" id="5555419">encodeInterface</span><span class="op" id="5555434">(</span><span class="ident" id="5555435">b</span>&nbsp;<span class="op" id="5555437">*</span><span class="ident" id="5555438">encBuffer</span><span class="op" id="5555447">,</span>&nbsp;<span class="ident" id="5555449">iv</span>&nbsp;<span class="ident" id="5555452">reflect</span><span class="op" id="5555459">.</span><span class="ident" id="5555460">Value</span><span class="op" id="5555465">)</span>&nbsp;<span class="op" id="5555467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5555470">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5555535">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5555606">elem</span>&nbsp;<span class="op" id="5555611">:=</span>&nbsp;<span class="ident" id="5555614">iv</span><span class="op" id="5555616">.</span><span class="ident" id="5555617">Elem</span><span class="op" id="5555621">(</span><span class="op" id="5555622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5555625">if</span>&nbsp;<span class="ident" id="5555628">elem</span><span class="op" id="5555632">.</span><span class="ident" id="5555633">Kind</span><span class="op" id="5555637">(</span><span class="op" id="5555638">)</span>&nbsp;<span class="op" id="5555640">==</span>&nbsp;<span class="ident" id="5555643">reflect</span><span class="op" id="5555650">.</span><span class="ident" id="5555651">Ptr</span>&nbsp;<span class="op" id="5555655">&amp;&amp;</span>&nbsp;<span class="ident" id="5555658">elem</span><span class="op" id="5555662">.</span><span class="ident" id="5555663">IsNil</span><span class="op" id="5555668">(</span><span class="op" id="5555669">)</span>&nbsp;<span class="op" id="5555671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5555675">errorf</span><span class="op" id="5555681">(</span><span class="string" id="5555682">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="5555742">,</span>&nbsp;<span class="ident" id="5555744">iv</span><span class="op" id="5555746">.</span><span class="ident" id="5555747">Elem</span><span class="op" id="5555751">(</span><span class="op" id="5555752">)</span><span class="op" id="5555753">.</span><span class="ident" id="5555754">Type</span><span class="op" id="5555758">(</span><span class="op" id="5555759">)</span><span class="op" id="5555760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5555763">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5555766">state</span>&nbsp;<span class="op" id="5555772">:=</span>&nbsp;<span class="ident" id="5555775">enc</span><span class="op" id="5555778">.</span><span class="ident" id="5555779">newEncoderState</span><span class="op" id="5555794">(</span><span class="ident" id="5555795">b</span><span class="op" id="5555796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5555799">state</span><span class="op" id="5555804">.</span><span class="ident" id="5555805">fieldnum</span>&nbsp;<span class="op" id="5555814">=</span>&nbsp;<span class="op" id="5555816">-</span><span class="num" id="5555817">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5555820">state</span><span class="op" id="5555825">.</span><span class="ident" id="5555826">sendZero</span>&nbsp;<span class="op" id="5555835">=</span>&nbsp;<span class="builtintype" id="5555837">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5555843">if</span>&nbsp;<span class="ident" id="5555846">iv</span><span class="op" id="5555848">.</span><span class="ident" id="5555849">IsNil</span><span class="op" id="5555854">(</span><span class="op" id="5555855">)</span>&nbsp;<span class="op" id="5555857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5555861">state</span><span class="op" id="5555866">.</span><span class="ident" id="5555867">encodeUint</span><span class="op" id="5555877">(</span><span class="num" id="5555878">0</span><span class="op" id="5555879">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5555883">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5555891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5555895">ut</span>&nbsp;<span class="op" id="5555898">:=</span>&nbsp;<span class="ident" id="5555901">userType</span><span class="op" id="5555909">(</span><span class="ident" id="5555910">iv</span><span class="op" id="5555912">.</span><span class="ident" id="5555913">Elem</span><span class="op" id="5555917">(</span><span class="op" id="5555918">)</span><span class="op" id="5555919">.</span><span class="ident" id="5555920">Type</span><span class="op" id="5555924">(</span><span class="op" id="5555925">)</span><span class="op" id="5555926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5555929">registerLock</span><span class="op" id="5555941">.</span><span class="ident" id="5555942">RLock</span><span class="op" id="5555947">(</span><span class="op" id="5555948">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5555951">name</span><span class="op" id="5555955">,</span>&nbsp;<span class="ident" id="5555957">ok</span>&nbsp;<span class="op" id="5555960">:=</span>&nbsp;<span class="ident" id="5555963">concreteTypeToName</span><span class="op" id="5555981">[</span><span class="ident" id="5555982">ut</span><span class="op" id="5555984">.</span><span class="ident" id="5555985">base</span><span class="op" id="5555989">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5555992">registerLock</span><span class="op" id="5556004">.</span><span class="ident" id="5556005">RUnlock</span><span class="op" id="5556012">(</span><span class="op" id="5556013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5556016">if</span>&nbsp;<span class="op" id="5556019">!</span><span class="ident" id="5556020">ok</span>&nbsp;<span class="op" id="5556023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556027">errorf</span><span class="op" id="5556033">(</span><span class="string" id="5556034">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="5556073">,</span>&nbsp;<span class="ident" id="5556075">ut</span><span class="op" id="5556077">.</span><span class="ident" id="5556078">base</span><span class="op" id="5556082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5556085">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5556088">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556107">state</span><span class="op" id="5556112">.</span><span class="ident" id="5556113">encodeUint</span><span class="op" id="5556123">(</span><span class="ident" id="5556124">uint64</span><span class="op" id="5556130">(</span><span class="builtinfunc" id="5556131">len</span><span class="op" id="5556134">(</span><span class="ident" id="5556135">name</span><span class="op" id="5556139">)</span><span class="op" id="5556140">)</span><span class="op" id="5556141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556144">state</span><span class="op" id="5556149">.</span><span class="ident" id="5556150">b</span><span class="op" id="5556151">.</span><span class="ident" id="5556152">WriteString</span><span class="op" id="5556163">(</span><span class="ident" id="5556164">name</span><span class="op" id="5556168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5556171">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556208">enc</span><span class="op" id="5556211">.</span><span class="ident" id="5556212">sendTypeDescriptor</span><span class="op" id="5556230">(</span><span class="ident" id="5556231">enc</span><span class="op" id="5556234">.</span><span class="ident" id="5556235">writer</span><span class="op" id="5556241">(</span><span class="op" id="5556242">)</span><span class="op" id="5556243">,</span>&nbsp;<span class="ident" id="5556245">state</span><span class="op" id="5556250">,</span>&nbsp;<span class="ident" id="5556252">ut</span><span class="op" id="5556254">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5556257">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556279">enc</span><span class="op" id="5556282">.</span><span class="ident" id="5556283">sendTypeId</span><span class="op" id="5556293">(</span><span class="ident" id="5556294">state</span><span class="op" id="5556299">,</span>&nbsp;<span class="ident" id="5556301">ut</span><span class="op" id="5556303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5556306">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5556375">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556429">enc</span><span class="op" id="5556432">.</span><span class="ident" id="5556433">pushWriter</span><span class="op" id="5556443">(</span><span class="ident" id="5556444">b</span><span class="op" id="5556445">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556448">data</span>&nbsp;<span class="op" id="5556453">:=</span>&nbsp;<span class="builtinfunc" id="5556456">new</span><span class="op" id="5556459">(</span><span class="ident" id="5556460">encBuffer</span><span class="op" id="5556469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556472">data</span><span class="op" id="5556476">.</span><span class="ident" id="5556477">Write</span><span class="op" id="5556482">(</span><span class="ident" id="5556483">spaceForLength</span><span class="op" id="5556497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556500">enc</span><span class="op" id="5556503">.</span><span class="ident" id="5556504">encode</span><span class="op" id="5556510">(</span><span class="ident" id="5556511">data</span><span class="op" id="5556515">,</span>&nbsp;<span class="ident" id="5556517">elem</span><span class="op" id="5556521">,</span>&nbsp;<span class="ident" id="5556523">ut</span><span class="op" id="5556525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5556528">if</span>&nbsp;<span class="ident" id="5556531">enc</span><span class="op" id="5556534">.</span><span class="ident" id="5556535">err</span>&nbsp;<span class="op" id="5556539">!=</span>&nbsp;<span class="builtintype" id="5556542">nil</span>&nbsp;<span class="op" id="5556546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556550">error_</span><span class="op" id="5556556">(</span><span class="ident" id="5556557">enc</span><span class="op" id="5556560">.</span><span class="ident" id="5556561">err</span><span class="op" id="5556564">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5556567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556570">enc</span><span class="op" id="5556573">.</span><span class="ident" id="5556574">popWriter</span><span class="op" id="5556583">(</span><span class="op" id="5556584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556587">enc</span><span class="op" id="5556590">.</span><span class="ident" id="5556591">writeMessage</span><span class="op" id="5556603">(</span><span class="ident" id="5556604">b</span><span class="op" id="5556605">,</span>&nbsp;<span class="ident" id="5556607">data</span><span class="op" id="5556611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5556614">if</span>&nbsp;<span class="ident" id="5556617">enc</span><span class="op" id="5556620">.</span><span class="ident" id="5556621">err</span>&nbsp;<span class="op" id="5556625">!=</span>&nbsp;<span class="builtintype" id="5556628">nil</span>&nbsp;<span class="op" id="5556632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556636">error_</span><span class="op" id="5556642">(</span><span class="ident" id="5556643">enc</span><span class="op" id="5556646">.</span><span class="ident" id="5556647">err</span><span class="op" id="5556650">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5556653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5556656">enc</span><span class="op" id="5556659">.</span><span class="ident" id="5556660">freeEncoderState</span><span class="op" id="5556676">(</span><span class="ident" id="5556677">state</span><span class="op" id="5556682">)</span><br>
<span class="lineno"></span><span class="op" id="5556684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5556687">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="5556748">func</span>&nbsp;<span class="ident" id="5556753">isZero</span><span class="op" id="5556759">(</span><span class="ident" id="5556760">val</span>&nbsp;<span class="ident" id="5556764">reflect</span><span class="op" id="5556771">.</span><span class="ident" id="5556772">Value</span><span class="op" id="5556777">)</span>&nbsp;<span class="builtintype" id="5556779">bool</span>&nbsp;<span class="op" id="5556784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5556787">switch</span>&nbsp;<span class="ident" id="5556794">val</span><span class="op" id="5556797">.</span><span class="ident" id="5556798">Kind</span><span class="op" id="5556802">(</span><span class="op" id="5556803">)</span>&nbsp;<span class="op" id="5556805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5556808">case</span>&nbsp;<span class="ident" id="5556813">reflect</span><span class="op" id="5556820">.</span><span class="ident" id="5556821">Array</span><span class="op" id="5556826">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5556830">for</span>&nbsp;<span class="ident" id="5556834">i</span>&nbsp;<span class="op" id="5556836">:=</span>&nbsp;<span class="num" id="5556839">0</span><span class="op" id="5556840">;</span>&nbsp;<span class="ident" id="5556842">i</span>&nbsp;<span class="op" id="5556844">&lt;</span>&nbsp;<span class="ident" id="5556846">val</span><span class="op" id="5556849">.</span><span class="ident" id="5556850">Len</span><span class="op" id="5556853">(</span><span class="op" id="5556854">)</span><span class="op" id="5556855">;</span>&nbsp;<span class="ident" id="5556857">i</span><span class="op" id="5556858">++</span>&nbsp;<span class="op" id="5556861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5556866">if</span>&nbsp;<span class="op" id="5556869">!</span><span class="ident" id="5556870">isZero</span><span class="op" id="5556876">(</span><span class="ident" id="5556877">val</span><span class="op" id="5556880">.</span><span class="ident" id="5556881">Index</span><span class="op" id="5556886">(</span><span class="ident" id="5556887">i</span><span class="op" id="5556888">)</span><span class="op" id="5556889">)</span>&nbsp;<span class="op" id="5556891">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5556897">return</span>&nbsp;<span class="builtintype" id="5556904">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5556913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5556917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5556921">return</span>&nbsp;<span class="builtintype" id="5556928">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5556934">case</span>&nbsp;<span class="ident" id="5556939">reflect</span><span class="op" id="5556946">.</span><span class="ident" id="5556947">Map</span><span class="op" id="5556950">,</span>&nbsp;<span class="ident" id="5556952">reflect</span><span class="op" id="5556959">.</span><span class="ident" id="5556960">Slice</span><span class="op" id="5556965">,</span>&nbsp;<span class="ident" id="5556967">reflect</span><span class="op" id="5556974">.</span><span class="ident" id="5556975">String</span><span class="op" id="5556981">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5556985">return</span>&nbsp;<span class="ident" id="5556992">val</span><span class="op" id="5556995">.</span><span class="ident" id="5556996">Len</span><span class="op" id="5556999">(</span><span class="op" id="5557000">)</span>&nbsp;<span class="op" id="5557002">==</span>&nbsp;<span class="num" id="5557005">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557008">case</span>&nbsp;<span class="ident" id="5557013">reflect</span><span class="op" id="5557020">.</span><span class="ident" id="5557021">Bool</span><span class="op" id="5557025">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557029">return</span>&nbsp;<span class="op" id="5557036">!</span><span class="ident" id="5557037">val</span><span class="op" id="5557040">.</span><span class="ident" id="5557041">Bool</span><span class="op" id="5557045">(</span><span class="op" id="5557046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557049">case</span>&nbsp;<span class="ident" id="5557054">reflect</span><span class="op" id="5557061">.</span><span class="ident" id="5557062">Complex64</span><span class="op" id="5557071">,</span>&nbsp;<span class="ident" id="5557073">reflect</span><span class="op" id="5557080">.</span><span class="ident" id="5557081">Complex128</span><span class="op" id="5557091">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557095">return</span>&nbsp;<span class="ident" id="5557102">val</span><span class="op" id="5557105">.</span><span class="ident" id="5557106">Complex</span><span class="op" id="5557113">(</span><span class="op" id="5557114">)</span>&nbsp;<span class="op" id="5557116">==</span>&nbsp;<span class="num" id="5557119">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557122">case</span>&nbsp;<span class="ident" id="5557127">reflect</span><span class="op" id="5557134">.</span><span class="ident" id="5557135">Chan</span><span class="op" id="5557139">,</span>&nbsp;<span class="ident" id="5557141">reflect</span><span class="op" id="5557148">.</span><span class="ident" id="5557149">Func</span><span class="op" id="5557153">,</span>&nbsp;<span class="ident" id="5557155">reflect</span><span class="op" id="5557162">.</span><span class="ident" id="5557163">Interface</span><span class="op" id="5557172">,</span>&nbsp;<span class="ident" id="5557174">reflect</span><span class="op" id="5557181">.</span><span class="ident" id="5557182">Ptr</span><span class="op" id="5557185">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557189">return</span>&nbsp;<span class="ident" id="5557196">val</span><span class="op" id="5557199">.</span><span class="ident" id="5557200">IsNil</span><span class="op" id="5557205">(</span><span class="op" id="5557206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557209">case</span>&nbsp;<span class="ident" id="5557214">reflect</span><span class="op" id="5557221">.</span><span class="ident" id="5557222">Int</span><span class="op" id="5557225">,</span>&nbsp;<span class="ident" id="5557227">reflect</span><span class="op" id="5557234">.</span><span class="ident" id="5557235">Int8</span><span class="op" id="5557239">,</span>&nbsp;<span class="ident" id="5557241">reflect</span><span class="op" id="5557248">.</span><span class="ident" id="5557249">Int16</span><span class="op" id="5557254">,</span>&nbsp;<span class="ident" id="5557256">reflect</span><span class="op" id="5557263">.</span><span class="ident" id="5557264">Int32</span><span class="op" id="5557269">,</span>&nbsp;<span class="ident" id="5557271">reflect</span><span class="op" id="5557278">.</span><span class="ident" id="5557279">Int64</span><span class="op" id="5557284">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557288">return</span>&nbsp;<span class="ident" id="5557295">val</span><span class="op" id="5557298">.</span><span class="ident" id="5557299">Int</span><span class="op" id="5557302">(</span><span class="op" id="5557303">)</span>&nbsp;<span class="op" id="5557305">==</span>&nbsp;<span class="num" id="5557308">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557311">case</span>&nbsp;<span class="ident" id="5557316">reflect</span><span class="op" id="5557323">.</span><span class="ident" id="5557324">Float32</span><span class="op" id="5557331">,</span>&nbsp;<span class="ident" id="5557333">reflect</span><span class="op" id="5557340">.</span><span class="ident" id="5557341">Float64</span><span class="op" id="5557348">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557352">return</span>&nbsp;<span class="ident" id="5557359">val</span><span class="op" id="5557362">.</span><span class="ident" id="5557363">Float</span><span class="op" id="5557368">(</span><span class="op" id="5557369">)</span>&nbsp;<span class="op" id="5557371">==</span>&nbsp;<span class="num" id="5557374">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557377">case</span>&nbsp;<span class="ident" id="5557382">reflect</span><span class="op" id="5557389">.</span><span class="ident" id="5557390">Uint</span><span class="op" id="5557394">,</span>&nbsp;<span class="ident" id="5557396">reflect</span><span class="op" id="5557403">.</span><span class="ident" id="5557404">Uint8</span><span class="op" id="5557409">,</span>&nbsp;<span class="ident" id="5557411">reflect</span><span class="op" id="5557418">.</span><span class="ident" id="5557419">Uint16</span><span class="op" id="5557425">,</span>&nbsp;<span class="ident" id="5557427">reflect</span><span class="op" id="5557434">.</span><span class="ident" id="5557435">Uint32</span><span class="op" id="5557441">,</span>&nbsp;<span class="ident" id="5557443">reflect</span><span class="op" id="5557450">.</span><span class="ident" id="5557451">Uint64</span><span class="op" id="5557457">,</span>&nbsp;<span class="ident" id="5557459">reflect</span><span class="op" id="5557466">.</span><span class="ident" id="5557467">Uintptr</span><span class="op" id="5557474">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557478">return</span>&nbsp;<span class="ident" id="5557485">val</span><span class="op" id="5557488">.</span><span class="ident" id="5557489">Uint</span><span class="op" id="5557493">(</span><span class="op" id="5557494">)</span>&nbsp;<span class="op" id="5557496">==</span>&nbsp;<span class="num" id="5557499">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557502">case</span>&nbsp;<span class="ident" id="5557507">reflect</span><span class="op" id="5557514">.</span><span class="ident" id="5557515">Struct</span><span class="op" id="5557521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557525">for</span>&nbsp;<span class="ident" id="5557529">i</span>&nbsp;<span class="op" id="5557531">:=</span>&nbsp;<span class="num" id="5557534">0</span><span class="op" id="5557535">;</span>&nbsp;<span class="ident" id="5557537">i</span>&nbsp;<span class="op" id="5557539">&lt;</span>&nbsp;<span class="ident" id="5557541">val</span><span class="op" id="5557544">.</span><span class="ident" id="5557545">NumField</span><span class="op" id="5557553">(</span><span class="op" id="5557554">)</span><span class="op" id="5557555">;</span>&nbsp;<span class="ident" id="5557557">i</span><span class="op" id="5557558">++</span>&nbsp;<span class="op" id="5557561">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557566">if</span>&nbsp;<span class="op" id="5557569">!</span><span class="ident" id="5557570">isZero</span><span class="op" id="5557576">(</span><span class="ident" id="5557577">val</span><span class="op" id="5557580">.</span><span class="ident" id="5557581">Field</span><span class="op" id="5557586">(</span><span class="ident" id="5557587">i</span><span class="op" id="5557588">)</span><span class="op" id="5557589">)</span>&nbsp;<span class="op" id="5557591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557597">return</span>&nbsp;<span class="builtintype" id="5557604">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5557613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5557617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557621">return</span>&nbsp;<span class="builtintype" id="5557628">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5557634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5557637">panic</span><span class="op" id="5557642">(</span><span class="string" id="5557643">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="5557669">+</span>&nbsp;<span class="ident" id="5557671">val</span><span class="op" id="5557674">.</span><span class="ident" id="5557675">Type</span><span class="op" id="5557679">(</span><span class="op" id="5557680">)</span><span class="op" id="5557681">.</span><span class="ident" id="5557682">String</span><span class="op" id="5557688">(</span><span class="op" id="5557689">)</span><span class="op" id="5557690">)</span><br>
<span class="lineno"></span><span class="op" id="5557692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5557695">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="5557770">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="5557807">func</span>&nbsp;<span class="op" id="5557812">(</span><span class="ident" id="5557813">enc</span>&nbsp;<span class="op" id="5557817">*</span><span class="ident" id="5557818">Encoder</span><span class="op" id="5557825">)</span>&nbsp;<span class="ident" id="5557827">encodeGobEncoder</span><span class="op" id="5557843">(</span><span class="ident" id="5557844">b</span>&nbsp;<span class="op" id="5557846">*</span><span class="ident" id="5557847">encBuffer</span><span class="op" id="5557856">,</span>&nbsp;<span class="ident" id="5557858">ut</span>&nbsp;<span class="op" id="5557861">*</span><span class="ident" id="5557862">userTypeInfo</span><span class="op" id="5557874">,</span>&nbsp;<span class="ident" id="5557876">v</span>&nbsp;<span class="ident" id="5557878">reflect</span><span class="op" id="5557885">.</span><span class="ident" id="5557886">Value</span><span class="op" id="5557891">)</span>&nbsp;<span class="op" id="5557893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5557896">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557954">var</span>&nbsp;<span class="ident" id="5557958">data</span>&nbsp;<span class="op" id="5557963">[</span><span class="op" id="5557964">]</span><span class="builtintype" id="5557965">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5557971">var</span>&nbsp;<span class="ident" id="5557975">err</span>&nbsp;<span class="builtintype" id="5557979">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5557986">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5558017">switch</span>&nbsp;<span class="ident" id="5558024">ut</span><span class="op" id="5558026">.</span><span class="ident" id="5558027">externalEnc</span>&nbsp;<span class="op" id="5558039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5558042">case</span>&nbsp;<span class="ident" id="5558047">xGob</span><span class="op" id="5558051">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558055">data</span><span class="op" id="5558059">,</span>&nbsp;<span class="ident" id="5558061">err</span>&nbsp;<span class="op" id="5558065">=</span>&nbsp;<span class="ident" id="5558067">v</span><span class="op" id="5558068">.</span><span class="ident" id="5558069">Interface</span><span class="op" id="5558078">(</span><span class="op" id="5558079">)</span><span class="op" id="5558080">.</span><span class="op" id="5558081">(</span><span class="ident" id="5558082">GobEncoder</span><span class="op" id="5558092">)</span><span class="op" id="5558093">.</span><span class="ident" id="5558094">GobEncode</span><span class="op" id="5558103">(</span><span class="op" id="5558104">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5558107">case</span>&nbsp;<span class="ident" id="5558112">xBinary</span><span class="op" id="5558119">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558123">data</span><span class="op" id="5558127">,</span>&nbsp;<span class="ident" id="5558129">err</span>&nbsp;<span class="op" id="5558133">=</span>&nbsp;<span class="ident" id="5558135">v</span><span class="op" id="5558136">.</span><span class="ident" id="5558137">Interface</span><span class="op" id="5558146">(</span><span class="op" id="5558147">)</span><span class="op" id="5558148">.</span><span class="op" id="5558149">(</span><span class="ident" id="5558150">encoding</span><span class="op" id="5558158">.</span><span class="ident" id="5558159">BinaryMarshaler</span><span class="op" id="5558174">)</span><span class="op" id="5558175">.</span><span class="ident" id="5558176">MarshalBinary</span><span class="op" id="5558189">(</span><span class="op" id="5558190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5558193">case</span>&nbsp;<span class="ident" id="5558198">xText</span><span class="op" id="5558203">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558207">data</span><span class="op" id="5558211">,</span>&nbsp;<span class="ident" id="5558213">err</span>&nbsp;<span class="op" id="5558217">=</span>&nbsp;<span class="ident" id="5558219">v</span><span class="op" id="5558220">.</span><span class="ident" id="5558221">Interface</span><span class="op" id="5558230">(</span><span class="op" id="5558231">)</span><span class="op" id="5558232">.</span><span class="op" id="5558233">(</span><span class="ident" id="5558234">encoding</span><span class="op" id="5558242">.</span><span class="ident" id="5558243">TextMarshaler</span><span class="op" id="5558256">)</span><span class="op" id="5558257">.</span><span class="ident" id="5558258">MarshalText</span><span class="op" id="5558269">(</span><span class="op" id="5558270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5558273">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5558276">if</span>&nbsp;<span class="ident" id="5558279">err</span>&nbsp;<span class="op" id="5558283">!=</span>&nbsp;<span class="builtintype" id="5558286">nil</span>&nbsp;<span class="op" id="5558290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558294">error_</span><span class="op" id="5558300">(</span><span class="ident" id="5558301">err</span><span class="op" id="5558304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5558307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558310">state</span>&nbsp;<span class="op" id="5558316">:=</span>&nbsp;<span class="ident" id="5558319">enc</span><span class="op" id="5558322">.</span><span class="ident" id="5558323">newEncoderState</span><span class="op" id="5558338">(</span><span class="ident" id="5558339">b</span><span class="op" id="5558340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558343">state</span><span class="op" id="5558348">.</span><span class="ident" id="5558349">fieldnum</span>&nbsp;<span class="op" id="5558358">=</span>&nbsp;<span class="op" id="5558360">-</span><span class="num" id="5558361">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558364">state</span><span class="op" id="5558369">.</span><span class="ident" id="5558370">encodeUint</span><span class="op" id="5558380">(</span><span class="ident" id="5558381">uint64</span><span class="op" id="5558387">(</span><span class="builtinfunc" id="5558388">len</span><span class="op" id="5558391">(</span><span class="ident" id="5558392">data</span><span class="op" id="5558396">)</span><span class="op" id="5558397">)</span><span class="op" id="5558398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558401">state</span><span class="op" id="5558406">.</span><span class="ident" id="5558407">b</span><span class="op" id="5558408">.</span><span class="ident" id="5558409">Write</span><span class="op" id="5558414">(</span><span class="ident" id="5558415">data</span><span class="op" id="5558419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558422">enc</span><span class="op" id="5558425">.</span><span class="ident" id="5558426">freeEncoderState</span><span class="op" id="5558442">(</span><span class="ident" id="5558443">state</span><span class="op" id="5558448">)</span><br>
<span class="lineno"></span><span class="op" id="5558450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="5558453">var</span>&nbsp;<span class="ident" id="5558457">encOpTable</span>&nbsp;<span class="op" id="5558468">=</span>&nbsp;<span class="op" id="5558470">[</span><span class="op" id="5558471">...</span><span class="op" id="5558474">]</span><span class="ident" id="5558475">encOp</span><span class="op" id="5558480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558483">reflect</span><span class="op" id="5558490">.</span><span class="ident" id="5558491">Bool</span><span class="op" id="5558495">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558503">encBool</span><span class="op" id="5558510">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558513">reflect</span><span class="op" id="5558520">.</span><span class="ident" id="5558521">Int</span><span class="op" id="5558524">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558533">encInt</span><span class="op" id="5558539">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558542">reflect</span><span class="op" id="5558549">.</span><span class="ident" id="5558550">Int8</span><span class="op" id="5558554">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558562">encInt</span><span class="op" id="5558568">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558571">reflect</span><span class="op" id="5558578">.</span><span class="ident" id="5558579">Int16</span><span class="op" id="5558584">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558591">encInt</span><span class="op" id="5558597">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558600">reflect</span><span class="op" id="5558607">.</span><span class="ident" id="5558608">Int32</span><span class="op" id="5558613">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558620">encInt</span><span class="op" id="5558626">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558629">reflect</span><span class="op" id="5558636">.</span><span class="ident" id="5558637">Int64</span><span class="op" id="5558642">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558649">encInt</span><span class="op" id="5558655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558658">reflect</span><span class="op" id="5558665">.</span><span class="ident" id="5558666">Uint</span><span class="op" id="5558670">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558678">encUint</span><span class="op" id="5558685">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558688">reflect</span><span class="op" id="5558695">.</span><span class="ident" id="5558696">Uint8</span><span class="op" id="5558701">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558708">encUint</span><span class="op" id="5558715">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558718">reflect</span><span class="op" id="5558725">.</span><span class="ident" id="5558726">Uint16</span><span class="op" id="5558732">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558738">encUint</span><span class="op" id="5558745">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558748">reflect</span><span class="op" id="5558755">.</span><span class="ident" id="5558756">Uint32</span><span class="op" id="5558762">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558768">encUint</span><span class="op" id="5558775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558778">reflect</span><span class="op" id="5558785">.</span><span class="ident" id="5558786">Uint64</span><span class="op" id="5558792">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558798">encUint</span><span class="op" id="5558805">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558808">reflect</span><span class="op" id="5558815">.</span><span class="ident" id="5558816">Uintptr</span><span class="op" id="5558823">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558828">encUint</span><span class="op" id="5558835">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558838">reflect</span><span class="op" id="5558845">.</span><span class="ident" id="5558846">Float32</span><span class="op" id="5558853">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558858">encFloat</span><span class="op" id="5558866">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558869">reflect</span><span class="op" id="5558876">.</span><span class="ident" id="5558877">Float64</span><span class="op" id="5558884">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558889">encFloat</span><span class="op" id="5558897">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558900">reflect</span><span class="op" id="5558907">.</span><span class="ident" id="5558908">Complex64</span><span class="op" id="5558917">:</span>&nbsp;&nbsp;<span class="ident" id="5558920">encComplex</span><span class="op" id="5558930">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558933">reflect</span><span class="op" id="5558940">.</span><span class="ident" id="5558941">Complex128</span><span class="op" id="5558951">:</span>&nbsp;<span class="ident" id="5558953">encComplex</span><span class="op" id="5558963">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558966">reflect</span><span class="op" id="5558973">.</span><span class="ident" id="5558974">String</span><span class="op" id="5558980">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5558986">encString</span><span class="op" id="5558995">,</span><br>
<span class="lineno"></span><span class="op" id="5558997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="5559000">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5559082">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5559120">func</span>&nbsp;<span class="ident" id="5559125">encOpFor</span><span class="op" id="5559133">(</span><span class="ident" id="5559134">rt</span>&nbsp;<span class="ident" id="5559137">reflect</span><span class="op" id="5559144">.</span><span class="ident" id="5559145">Type</span><span class="op" id="5559149">,</span>&nbsp;<span class="ident" id="5559151">inProgress</span>&nbsp;<span class="keyword" id="5559162">map</span><span class="op" id="5559165">[</span><span class="ident" id="5559166">reflect</span><span class="op" id="5559173">.</span><span class="ident" id="5559174">Type</span><span class="op" id="5559178">]</span><span class="op" id="5559179">*</span><span class="ident" id="5559180">encOp</span><span class="op" id="5559185">,</span>&nbsp;<span class="ident" id="5559187">building</span>&nbsp;<span class="keyword" id="5559196">map</span><span class="op" id="5559199">[</span><span class="op" id="5559200">*</span><span class="ident" id="5559201">typeInfo</span><span class="op" id="5559209">]</span><span class="builtintype" id="5559210">bool</span><span class="op" id="5559214">)</span>&nbsp;<span class="op" id="5559216">(</span><span class="op" id="5559217">*</span><span class="ident" id="5559218">encOp</span><span class="op" id="5559223">,</span>&nbsp;<span class="builtintype" id="5559225">int</span><span class="op" id="5559228">)</span>&nbsp;<span class="op" id="5559230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5559233">ut</span>&nbsp;<span class="op" id="5559236">:=</span>&nbsp;<span class="ident" id="5559239">userType</span><span class="op" id="5559247">(</span><span class="ident" id="5559248">rt</span><span class="op" id="5559250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5559253">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5559333">if</span>&nbsp;<span class="ident" id="5559336">ut</span><span class="op" id="5559338">.</span><span class="ident" id="5559339">externalEnc</span>&nbsp;<span class="op" id="5559351">!=</span>&nbsp;<span class="num" id="5559354">0</span>&nbsp;<span class="op" id="5559356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5559360">return</span>&nbsp;<span class="ident" id="5559367">gobEncodeOpFor</span><span class="op" id="5559381">(</span><span class="ident" id="5559382">ut</span><span class="op" id="5559384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5559387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5559390">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5559475">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5559532">if</span>&nbsp;<span class="ident" id="5559535">opPtr</span>&nbsp;<span class="op" id="5559541">:=</span>&nbsp;<span class="ident" id="5559544">inProgress</span><span class="op" id="5559554">[</span><span class="ident" id="5559555">rt</span><span class="op" id="5559557">]</span><span class="op" id="5559558">;</span>&nbsp;<span class="ident" id="5559560">opPtr</span>&nbsp;<span class="op" id="5559566">!=</span>&nbsp;<span class="builtintype" id="5559569">nil</span>&nbsp;<span class="op" id="5559573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5559577">return</span>&nbsp;<span class="ident" id="5559584">opPtr</span><span class="op" id="5559589">,</span>&nbsp;<span class="ident" id="5559591">ut</span><span class="op" id="5559593">.</span><span class="ident" id="5559594">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5559601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5559604">typ</span>&nbsp;<span class="op" id="5559608">:=</span>&nbsp;<span class="ident" id="5559611">ut</span><span class="op" id="5559613">.</span><span class="ident" id="5559614">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5559620">indir</span>&nbsp;<span class="op" id="5559626">:=</span>&nbsp;<span class="ident" id="5559629">ut</span><span class="op" id="5559631">.</span><span class="ident" id="5559632">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5559639">k</span>&nbsp;<span class="op" id="5559641">:=</span>&nbsp;<span class="ident" id="5559644">typ</span><span class="op" id="5559647">.</span><span class="ident" id="5559648">Kind</span><span class="op" id="5559652">(</span><span class="op" id="5559653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5559656">var</span>&nbsp;<span class="ident" id="5559660">op</span>&nbsp;<span class="ident" id="5559663">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5559670">if</span>&nbsp;<span class="builtintype" id="5559673">int</span><span class="op" id="5559676">(</span><span class="ident" id="5559677">k</span><span class="op" id="5559678">)</span>&nbsp;<span class="op" id="5559680">&lt;</span>&nbsp;<span class="builtinfunc" id="5559682">len</span><span class="op" id="5559685">(</span><span class="ident" id="5559686">encOpTable</span><span class="op" id="5559696">)</span>&nbsp;<span class="op" id="5559698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5559702">op</span>&nbsp;<span class="op" id="5559705">=</span>&nbsp;<span class="ident" id="5559707">encOpTable</span><span class="op" id="5559717">[</span><span class="ident" id="5559718">k</span><span class="op" id="5559719">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5559722">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5559725">if</span>&nbsp;<span class="ident" id="5559728">op</span>&nbsp;<span class="op" id="5559731">==</span>&nbsp;<span class="builtintype" id="5559734">nil</span>&nbsp;<span class="op" id="5559738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5559742">inProgress</span><span class="op" id="5559752">[</span><span class="ident" id="5559753">rt</span><span class="op" id="5559755">]</span>&nbsp;<span class="op" id="5559757">=</span>&nbsp;<span class="op" id="5559759">&amp;</span><span class="ident" id="5559760">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5559765">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5559784">switch</span>&nbsp;<span class="ident" id="5559791">t</span>&nbsp;<span class="op" id="5559793">:=</span>&nbsp;<span class="ident" id="5559796">typ</span><span class="op" id="5559799">;</span>&nbsp;<span class="ident" id="5559801">t</span><span class="op" id="5559802">.</span><span class="ident" id="5559803">Kind</span><span class="op" id="5559807">(</span><span class="op" id="5559808">)</span>&nbsp;<span class="op" id="5559810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5559814">case</span>&nbsp;<span class="ident" id="5559819">reflect</span><span class="op" id="5559826">.</span><span class="ident" id="5559827">Slice</span><span class="op" id="5559832">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5559837">if</span>&nbsp;<span class="ident" id="5559840">t</span><span class="op" id="5559841">.</span><span class="ident" id="5559842">Elem</span><span class="op" id="5559846">(</span><span class="op" id="5559847">)</span><span class="op" id="5559848">.</span><span class="ident" id="5559849">Kind</span><span class="op" id="5559853">(</span><span class="op" id="5559854">)</span>&nbsp;<span class="op" id="5559856">==</span>&nbsp;<span class="ident" id="5559859">reflect</span><span class="op" id="5559866">.</span><span class="ident" id="5559867">Uint8</span>&nbsp;<span class="op" id="5559873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5559879">op</span>&nbsp;<span class="op" id="5559882">=</span>&nbsp;<span class="ident" id="5559884">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5559902">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5559911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5559916">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5559987">elemOp</span><span class="op" id="5559993">,</span>&nbsp;<span class="ident" id="5559995">elemIndir</span>&nbsp;<span class="op" id="5560005">:=</span>&nbsp;<span class="ident" id="5560008">encOpFor</span><span class="op" id="5560016">(</span><span class="ident" id="5560017">t</span><span class="op" id="5560018">.</span><span class="ident" id="5560019">Elem</span><span class="op" id="5560023">(</span><span class="op" id="5560024">)</span><span class="op" id="5560025">,</span>&nbsp;<span class="ident" id="5560027">inProgress</span><span class="op" id="5560037">,</span>&nbsp;<span class="ident" id="5560039">building</span><span class="op" id="5560047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560052">helper</span>&nbsp;<span class="op" id="5560059">:=</span>&nbsp;<span class="ident" id="5560062">encSliceHelper</span><span class="op" id="5560076">[</span><span class="ident" id="5560077">t</span><span class="op" id="5560078">.</span><span class="ident" id="5560079">Elem</span><span class="op" id="5560083">(</span><span class="op" id="5560084">)</span><span class="op" id="5560085">.</span><span class="ident" id="5560086">Kind</span><span class="op" id="5560090">(</span><span class="op" id="5560091">)</span><span class="op" id="5560092">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560097">op</span>&nbsp;<span class="op" id="5560100">=</span>&nbsp;<span class="keyword" id="5560102">func</span><span class="op" id="5560106">(</span><span class="ident" id="5560107">i</span>&nbsp;<span class="op" id="5560109">*</span><span class="ident" id="5560110">encInstr</span><span class="op" id="5560118">,</span>&nbsp;<span class="ident" id="5560120">state</span>&nbsp;<span class="op" id="5560126">*</span><span class="ident" id="5560127">encoderState</span><span class="op" id="5560139">,</span>&nbsp;<span class="ident" id="5560141">slice</span>&nbsp;<span class="ident" id="5560147">reflect</span><span class="op" id="5560154">.</span><span class="ident" id="5560155">Value</span><span class="op" id="5560160">)</span>&nbsp;<span class="op" id="5560162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5560168">if</span>&nbsp;<span class="op" id="5560171">!</span><span class="ident" id="5560172">state</span><span class="op" id="5560177">.</span><span class="ident" id="5560178">sendZero</span>&nbsp;<span class="op" id="5560187">&amp;&amp;</span>&nbsp;<span class="ident" id="5560190">slice</span><span class="op" id="5560195">.</span><span class="ident" id="5560196">Len</span><span class="op" id="5560199">(</span><span class="op" id="5560200">)</span>&nbsp;<span class="op" id="5560202">==</span>&nbsp;<span class="num" id="5560205">0</span>&nbsp;<span class="op" id="5560207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5560214">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5560225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560231">state</span><span class="op" id="5560236">.</span><span class="ident" id="5560237">update</span><span class="op" id="5560243">(</span><span class="ident" id="5560244">i</span><span class="op" id="5560245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560251">state</span><span class="op" id="5560256">.</span><span class="ident" id="5560257">enc</span><span class="op" id="5560260">.</span><span class="ident" id="5560261">encodeArray</span><span class="op" id="5560272">(</span><span class="ident" id="5560273">state</span><span class="op" id="5560278">.</span><span class="ident" id="5560279">b</span><span class="op" id="5560280">,</span>&nbsp;<span class="ident" id="5560282">slice</span><span class="op" id="5560287">,</span>&nbsp;<span class="op" id="5560289">*</span><span class="ident" id="5560290">elemOp</span><span class="op" id="5560296">,</span>&nbsp;<span class="ident" id="5560298">elemIndir</span><span class="op" id="5560307">,</span>&nbsp;<span class="ident" id="5560309">slice</span><span class="op" id="5560314">.</span><span class="ident" id="5560315">Len</span><span class="op" id="5560318">(</span><span class="op" id="5560319">)</span><span class="op" id="5560320">,</span>&nbsp;<span class="ident" id="5560322">helper</span><span class="op" id="5560328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5560333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5560337">case</span>&nbsp;<span class="ident" id="5560342">reflect</span><span class="op" id="5560349">.</span><span class="ident" id="5560350">Array</span><span class="op" id="5560355">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5560360">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560401">elemOp</span><span class="op" id="5560407">,</span>&nbsp;<span class="ident" id="5560409">elemIndir</span>&nbsp;<span class="op" id="5560419">:=</span>&nbsp;<span class="ident" id="5560422">encOpFor</span><span class="op" id="5560430">(</span><span class="ident" id="5560431">t</span><span class="op" id="5560432">.</span><span class="ident" id="5560433">Elem</span><span class="op" id="5560437">(</span><span class="op" id="5560438">)</span><span class="op" id="5560439">,</span>&nbsp;<span class="ident" id="5560441">inProgress</span><span class="op" id="5560451">,</span>&nbsp;<span class="ident" id="5560453">building</span><span class="op" id="5560461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560466">helper</span>&nbsp;<span class="op" id="5560473">:=</span>&nbsp;<span class="ident" id="5560476">encArrayHelper</span><span class="op" id="5560490">[</span><span class="ident" id="5560491">t</span><span class="op" id="5560492">.</span><span class="ident" id="5560493">Elem</span><span class="op" id="5560497">(</span><span class="op" id="5560498">)</span><span class="op" id="5560499">.</span><span class="ident" id="5560500">Kind</span><span class="op" id="5560504">(</span><span class="op" id="5560505">)</span><span class="op" id="5560506">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560511">op</span>&nbsp;<span class="op" id="5560514">=</span>&nbsp;<span class="keyword" id="5560516">func</span><span class="op" id="5560520">(</span><span class="ident" id="5560521">i</span>&nbsp;<span class="op" id="5560523">*</span><span class="ident" id="5560524">encInstr</span><span class="op" id="5560532">,</span>&nbsp;<span class="ident" id="5560534">state</span>&nbsp;<span class="op" id="5560540">*</span><span class="ident" id="5560541">encoderState</span><span class="op" id="5560553">,</span>&nbsp;<span class="ident" id="5560555">array</span>&nbsp;<span class="ident" id="5560561">reflect</span><span class="op" id="5560568">.</span><span class="ident" id="5560569">Value</span><span class="op" id="5560574">)</span>&nbsp;<span class="op" id="5560576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560582">state</span><span class="op" id="5560587">.</span><span class="ident" id="5560588">update</span><span class="op" id="5560594">(</span><span class="ident" id="5560595">i</span><span class="op" id="5560596">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560602">state</span><span class="op" id="5560607">.</span><span class="ident" id="5560608">enc</span><span class="op" id="5560611">.</span><span class="ident" id="5560612">encodeArray</span><span class="op" id="5560623">(</span><span class="ident" id="5560624">state</span><span class="op" id="5560629">.</span><span class="ident" id="5560630">b</span><span class="op" id="5560631">,</span>&nbsp;<span class="ident" id="5560633">array</span><span class="op" id="5560638">,</span>&nbsp;<span class="op" id="5560640">*</span><span class="ident" id="5560641">elemOp</span><span class="op" id="5560647">,</span>&nbsp;<span class="ident" id="5560649">elemIndir</span><span class="op" id="5560658">,</span>&nbsp;<span class="ident" id="5560660">array</span><span class="op" id="5560665">.</span><span class="ident" id="5560666">Len</span><span class="op" id="5560669">(</span><span class="op" id="5560670">)</span><span class="op" id="5560671">,</span>&nbsp;<span class="ident" id="5560673">helper</span><span class="op" id="5560679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5560684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5560688">case</span>&nbsp;<span class="ident" id="5560693">reflect</span><span class="op" id="5560700">.</span><span class="ident" id="5560701">Map</span><span class="op" id="5560704">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560709">keyOp</span><span class="op" id="5560714">,</span>&nbsp;<span class="ident" id="5560716">keyIndir</span>&nbsp;<span class="op" id="5560725">:=</span>&nbsp;<span class="ident" id="5560728">encOpFor</span><span class="op" id="5560736">(</span><span class="ident" id="5560737">t</span><span class="op" id="5560738">.</span><span class="ident" id="5560739">Key</span><span class="op" id="5560742">(</span><span class="op" id="5560743">)</span><span class="op" id="5560744">,</span>&nbsp;<span class="ident" id="5560746">inProgress</span><span class="op" id="5560756">,</span>&nbsp;<span class="ident" id="5560758">building</span><span class="op" id="5560766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560771">elemOp</span><span class="op" id="5560777">,</span>&nbsp;<span class="ident" id="5560779">elemIndir</span>&nbsp;<span class="op" id="5560789">:=</span>&nbsp;<span class="ident" id="5560792">encOpFor</span><span class="op" id="5560800">(</span><span class="ident" id="5560801">t</span><span class="op" id="5560802">.</span><span class="ident" id="5560803">Elem</span><span class="op" id="5560807">(</span><span class="op" id="5560808">)</span><span class="op" id="5560809">,</span>&nbsp;<span class="ident" id="5560811">inProgress</span><span class="op" id="5560821">,</span>&nbsp;<span class="ident" id="5560823">building</span><span class="op" id="5560831">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5560836">op</span>&nbsp;<span class="op" id="5560839">=</span>&nbsp;<span class="keyword" id="5560841">func</span><span class="op" id="5560845">(</span><span class="ident" id="5560846">i</span>&nbsp;<span class="op" id="5560848">*</span><span class="ident" id="5560849">encInstr</span><span class="op" id="5560857">,</span>&nbsp;<span class="ident" id="5560859">state</span>&nbsp;<span class="op" id="5560865">*</span><span class="ident" id="5560866">encoderState</span><span class="op" id="5560878">,</span>&nbsp;<span class="ident" id="5560880">mv</span>&nbsp;<span class="ident" id="5560883">reflect</span><span class="op" id="5560890">.</span><span class="ident" id="5560891">Value</span><span class="op" id="5560896">)</span>&nbsp;<span class="op" id="5560898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5560904">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5560962">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5561031">if</span>&nbsp;<span class="op" id="5561034">!</span><span class="ident" id="5561035">state</span><span class="op" id="5561040">.</span><span class="ident" id="5561041">sendZero</span>&nbsp;<span class="op" id="5561050">&amp;&amp;</span>&nbsp;<span class="ident" id="5561053">mv</span><span class="op" id="5561055">.</span><span class="ident" id="5561056">IsNil</span><span class="op" id="5561061">(</span><span class="op" id="5561062">)</span>&nbsp;<span class="op" id="5561064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5561071">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5561082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561088">state</span><span class="op" id="5561093">.</span><span class="ident" id="5561094">update</span><span class="op" id="5561100">(</span><span class="ident" id="5561101">i</span><span class="op" id="5561102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561108">state</span><span class="op" id="5561113">.</span><span class="ident" id="5561114">enc</span><span class="op" id="5561117">.</span><span class="ident" id="5561118">encodeMap</span><span class="op" id="5561127">(</span><span class="ident" id="5561128">state</span><span class="op" id="5561133">.</span><span class="ident" id="5561134">b</span><span class="op" id="5561135">,</span>&nbsp;<span class="ident" id="5561137">mv</span><span class="op" id="5561139">,</span>&nbsp;<span class="op" id="5561141">*</span><span class="ident" id="5561142">keyOp</span><span class="op" id="5561147">,</span>&nbsp;<span class="op" id="5561149">*</span><span class="ident" id="5561150">elemOp</span><span class="op" id="5561156">,</span>&nbsp;<span class="ident" id="5561158">keyIndir</span><span class="op" id="5561166">,</span>&nbsp;<span class="ident" id="5561168">elemIndir</span><span class="op" id="5561177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5561182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5561186">case</span>&nbsp;<span class="ident" id="5561191">reflect</span><span class="op" id="5561198">.</span><span class="ident" id="5561199">Struct</span><span class="op" id="5561205">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5561210">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561285">getEncEngine</span><span class="op" id="5561297">(</span><span class="ident" id="5561298">userType</span><span class="op" id="5561306">(</span><span class="ident" id="5561307">typ</span><span class="op" id="5561310">)</span><span class="op" id="5561311">,</span>&nbsp;<span class="ident" id="5561313">building</span><span class="op" id="5561321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561326">info</span>&nbsp;<span class="op" id="5561331">:=</span>&nbsp;<span class="ident" id="5561334">mustGetTypeInfo</span><span class="op" id="5561349">(</span><span class="ident" id="5561350">typ</span><span class="op" id="5561353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561358">op</span>&nbsp;<span class="op" id="5561361">=</span>&nbsp;<span class="keyword" id="5561363">func</span><span class="op" id="5561367">(</span><span class="ident" id="5561368">i</span>&nbsp;<span class="op" id="5561370">*</span><span class="ident" id="5561371">encInstr</span><span class="op" id="5561379">,</span>&nbsp;<span class="ident" id="5561381">state</span>&nbsp;<span class="op" id="5561387">*</span><span class="ident" id="5561388">encoderState</span><span class="op" id="5561400">,</span>&nbsp;<span class="ident" id="5561402">sv</span>&nbsp;<span class="ident" id="5561405">reflect</span><span class="op" id="5561412">.</span><span class="ident" id="5561413">Value</span><span class="op" id="5561418">)</span>&nbsp;<span class="op" id="5561420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561426">state</span><span class="op" id="5561431">.</span><span class="ident" id="5561432">update</span><span class="op" id="5561438">(</span><span class="ident" id="5561439">i</span><span class="op" id="5561440">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5561446">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561517">enc</span>&nbsp;<span class="op" id="5561521">:=</span>&nbsp;<span class="ident" id="5561524">info</span><span class="op" id="5561528">.</span><span class="ident" id="5561529">encoder</span><span class="op" id="5561536">.</span><span class="ident" id="5561537">Load</span><span class="op" id="5561541">(</span><span class="op" id="5561542">)</span><span class="op" id="5561543">.</span><span class="op" id="5561544">(</span><span class="op" id="5561545">*</span><span class="ident" id="5561546">encEngine</span><span class="op" id="5561555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561561">state</span><span class="op" id="5561566">.</span><span class="ident" id="5561567">enc</span><span class="op" id="5561570">.</span><span class="ident" id="5561571">encodeStruct</span><span class="op" id="5561583">(</span><span class="ident" id="5561584">state</span><span class="op" id="5561589">.</span><span class="ident" id="5561590">b</span><span class="op" id="5561591">,</span>&nbsp;<span class="ident" id="5561593">enc</span><span class="op" id="5561596">,</span>&nbsp;<span class="ident" id="5561598">sv</span><span class="op" id="5561600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5561605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5561609">case</span>&nbsp;<span class="ident" id="5561614">reflect</span><span class="op" id="5561621">.</span><span class="ident" id="5561622">Interface</span><span class="op" id="5561631">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561636">op</span>&nbsp;<span class="op" id="5561639">=</span>&nbsp;<span class="keyword" id="5561641">func</span><span class="op" id="5561645">(</span><span class="ident" id="5561646">i</span>&nbsp;<span class="op" id="5561648">*</span><span class="ident" id="5561649">encInstr</span><span class="op" id="5561657">,</span>&nbsp;<span class="ident" id="5561659">state</span>&nbsp;<span class="op" id="5561665">*</span><span class="ident" id="5561666">encoderState</span><span class="op" id="5561678">,</span>&nbsp;<span class="ident" id="5561680">iv</span>&nbsp;<span class="ident" id="5561683">reflect</span><span class="op" id="5561690">.</span><span class="ident" id="5561691">Value</span><span class="op" id="5561696">)</span>&nbsp;<span class="op" id="5561698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5561704">if</span>&nbsp;<span class="op" id="5561707">!</span><span class="ident" id="5561708">state</span><span class="op" id="5561713">.</span><span class="ident" id="5561714">sendZero</span>&nbsp;<span class="op" id="5561723">&amp;&amp;</span>&nbsp;<span class="op" id="5561726">(</span><span class="op" id="5561727">!</span><span class="ident" id="5561728">iv</span><span class="op" id="5561730">.</span><span class="ident" id="5561731">IsValid</span><span class="op" id="5561738">(</span><span class="op" id="5561739">)</span>&nbsp;<span class="op" id="5561741">||</span>&nbsp;<span class="ident" id="5561744">iv</span><span class="op" id="5561746">.</span><span class="ident" id="5561747">IsNil</span><span class="op" id="5561752">(</span><span class="op" id="5561753">)</span><span class="op" id="5561754">)</span>&nbsp;<span class="op" id="5561756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5561763">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5561774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561780">state</span><span class="op" id="5561785">.</span><span class="ident" id="5561786">update</span><span class="op" id="5561792">(</span><span class="ident" id="5561793">i</span><span class="op" id="5561794">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561800">state</span><span class="op" id="5561805">.</span><span class="ident" id="5561806">enc</span><span class="op" id="5561809">.</span><span class="ident" id="5561810">encodeInterface</span><span class="op" id="5561825">(</span><span class="ident" id="5561826">state</span><span class="op" id="5561831">.</span><span class="ident" id="5561832">b</span><span class="op" id="5561833">,</span>&nbsp;<span class="ident" id="5561835">iv</span><span class="op" id="5561837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5561842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5561846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5561849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5561852">if</span>&nbsp;<span class="ident" id="5561855">op</span>&nbsp;<span class="op" id="5561858">==</span>&nbsp;<span class="builtintype" id="5561861">nil</span>&nbsp;<span class="op" id="5561865">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5561869">errorf</span><span class="op" id="5561875">(</span><span class="string" id="5561876">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5561906">,</span>&nbsp;<span class="ident" id="5561908">rt</span><span class="op" id="5561910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5561913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5561916">return</span>&nbsp;<span class="op" id="5561923">&amp;</span><span class="ident" id="5561924">op</span><span class="op" id="5561926">,</span>&nbsp;<span class="ident" id="5561928">indir</span><br>
<span class="lineno"></span><span class="op" id="5561934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="5561937">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="5562020">func</span>&nbsp;<span class="ident" id="5562025">gobEncodeOpFor</span><span class="op" id="5562039">(</span><span class="ident" id="5562040">ut</span>&nbsp;<span class="op" id="5562043">*</span><span class="ident" id="5562044">userTypeInfo</span><span class="op" id="5562056">)</span>&nbsp;<span class="op" id="5562058">(</span><span class="op" id="5562059">*</span><span class="ident" id="5562060">encOp</span><span class="op" id="5562065">,</span>&nbsp;<span class="builtintype" id="5562067">int</span><span class="op" id="5562070">)</span>&nbsp;<span class="op" id="5562072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562075">rt</span>&nbsp;<span class="op" id="5562078">:=</span>&nbsp;<span class="ident" id="5562081">ut</span><span class="op" id="5562083">.</span><span class="ident" id="5562084">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5562090">if</span>&nbsp;<span class="ident" id="5562093">ut</span><span class="op" id="5562095">.</span><span class="ident" id="5562096">encIndir</span>&nbsp;<span class="op" id="5562105">==</span>&nbsp;<span class="op" id="5562108">-</span><span class="num" id="5562109">1</span>&nbsp;<span class="op" id="5562111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562115">rt</span>&nbsp;<span class="op" id="5562118">=</span>&nbsp;<span class="ident" id="5562120">reflect</span><span class="op" id="5562127">.</span><span class="ident" id="5562128">PtrTo</span><span class="op" id="5562133">(</span><span class="ident" id="5562134">rt</span><span class="op" id="5562136">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5562139">}</span>&nbsp;<span class="keyword" id="5562141">else</span>&nbsp;<span class="keyword" id="5562146">if</span>&nbsp;<span class="ident" id="5562149">ut</span><span class="op" id="5562151">.</span><span class="ident" id="5562152">encIndir</span>&nbsp;<span class="op" id="5562161">&gt;</span>&nbsp;<span class="num" id="5562163">0</span>&nbsp;<span class="op" id="5562165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5562169">for</span>&nbsp;<span class="ident" id="5562173">i</span>&nbsp;<span class="op" id="5562175">:=</span>&nbsp;<span class="builtintype" id="5562178">int8</span><span class="op" id="5562182">(</span><span class="num" id="5562183">0</span><span class="op" id="5562184">)</span><span class="op" id="5562185">;</span>&nbsp;<span class="ident" id="5562187">i</span>&nbsp;<span class="op" id="5562189">&lt;</span>&nbsp;<span class="ident" id="5562191">ut</span><span class="op" id="5562193">.</span><span class="ident" id="5562194">encIndir</span><span class="op" id="5562202">;</span>&nbsp;<span class="ident" id="5562204">i</span><span class="op" id="5562205">++</span>&nbsp;<span class="op" id="5562208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562213">rt</span>&nbsp;<span class="op" id="5562216">=</span>&nbsp;<span class="ident" id="5562218">rt</span><span class="op" id="5562220">.</span><span class="ident" id="5562221">Elem</span><span class="op" id="5562225">(</span><span class="op" id="5562226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5562230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5562233">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5562236">var</span>&nbsp;<span class="ident" id="5562240">op</span>&nbsp;<span class="ident" id="5562243">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562250">op</span>&nbsp;<span class="op" id="5562253">=</span>&nbsp;<span class="keyword" id="5562255">func</span><span class="op" id="5562259">(</span><span class="ident" id="5562260">i</span>&nbsp;<span class="op" id="5562262">*</span><span class="ident" id="5562263">encInstr</span><span class="op" id="5562271">,</span>&nbsp;<span class="ident" id="5562273">state</span>&nbsp;<span class="op" id="5562279">*</span><span class="ident" id="5562280">encoderState</span><span class="op" id="5562292">,</span>&nbsp;<span class="ident" id="5562294">v</span>&nbsp;<span class="ident" id="5562296">reflect</span><span class="op" id="5562303">.</span><span class="ident" id="5562304">Value</span><span class="op" id="5562309">)</span>&nbsp;<span class="op" id="5562311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5562315">if</span>&nbsp;<span class="ident" id="5562318">ut</span><span class="op" id="5562320">.</span><span class="ident" id="5562321">encIndir</span>&nbsp;<span class="op" id="5562330">==</span>&nbsp;<span class="op" id="5562333">-</span><span class="num" id="5562334">1</span>&nbsp;<span class="op" id="5562336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5562341">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5562402">if</span>&nbsp;<span class="op" id="5562405">!</span><span class="ident" id="5562406">v</span><span class="op" id="5562407">.</span><span class="ident" id="5562408">CanAddr</span><span class="op" id="5562415">(</span><span class="op" id="5562416">)</span>&nbsp;<span class="op" id="5562418">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562424">errorf</span><span class="op" id="5562430">(</span><span class="string" id="5562431">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="5562463">,</span>&nbsp;<span class="ident" id="5562465">rt</span><span class="op" id="5562467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5562472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562477">v</span>&nbsp;<span class="op" id="5562479">=</span>&nbsp;<span class="ident" id="5562481">v</span><span class="op" id="5562482">.</span><span class="ident" id="5562483">Addr</span><span class="op" id="5562487">(</span><span class="op" id="5562488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5562492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5562496">if</span>&nbsp;<span class="op" id="5562499">!</span><span class="ident" id="5562500">state</span><span class="op" id="5562505">.</span><span class="ident" id="5562506">sendZero</span>&nbsp;<span class="op" id="5562515">&amp;&amp;</span>&nbsp;<span class="ident" id="5562518">isZero</span><span class="op" id="5562524">(</span><span class="ident" id="5562525">v</span><span class="op" id="5562526">)</span>&nbsp;<span class="op" id="5562528">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5562533">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5562542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562546">state</span><span class="op" id="5562551">.</span><span class="ident" id="5562552">update</span><span class="op" id="5562558">(</span><span class="ident" id="5562559">i</span><span class="op" id="5562560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562564">state</span><span class="op" id="5562569">.</span><span class="ident" id="5562570">enc</span><span class="op" id="5562573">.</span><span class="ident" id="5562574">encodeGobEncoder</span><span class="op" id="5562590">(</span><span class="ident" id="5562591">state</span><span class="op" id="5562596">.</span><span class="ident" id="5562597">b</span><span class="op" id="5562598">,</span>&nbsp;<span class="ident" id="5562600">ut</span><span class="op" id="5562602">,</span>&nbsp;<span class="ident" id="5562604">v</span><span class="op" id="5562605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5562608">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5562611">return</span>&nbsp;<span class="op" id="5562618">&amp;</span><span class="ident" id="5562619">op</span><span class="op" id="5562621">,</span>&nbsp;<span class="builtintype" id="5562623">int</span><span class="op" id="5562626">(</span><span class="ident" id="5562627">ut</span><span class="op" id="5562629">.</span><span class="ident" id="5562630">encIndir</span><span class="op" id="5562638">)</span>&nbsp;<span class="comment" id="5562640">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="5562703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5562706">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5562760">func</span>&nbsp;<span class="ident" id="5562765">compileEnc</span><span class="op" id="5562775">(</span><span class="ident" id="5562776">ut</span>&nbsp;<span class="op" id="5562779">*</span><span class="ident" id="5562780">userTypeInfo</span><span class="op" id="5562792">,</span>&nbsp;<span class="ident" id="5562794">building</span>&nbsp;<span class="keyword" id="5562803">map</span><span class="op" id="5562806">[</span><span class="op" id="5562807">*</span><span class="ident" id="5562808">typeInfo</span><span class="op" id="5562816">]</span><span class="builtintype" id="5562817">bool</span><span class="op" id="5562821">)</span>&nbsp;<span class="op" id="5562823">*</span><span class="ident" id="5562824">encEngine</span>&nbsp;<span class="op" id="5562834">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562837">srt</span>&nbsp;<span class="op" id="5562841">:=</span>&nbsp;<span class="ident" id="5562844">ut</span><span class="op" id="5562846">.</span><span class="ident" id="5562847">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562853">engine</span>&nbsp;<span class="op" id="5562860">:=</span>&nbsp;<span class="builtinfunc" id="5562863">new</span><span class="op" id="5562866">(</span><span class="ident" id="5562867">encEngine</span><span class="op" id="5562876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562879">seen</span>&nbsp;<span class="op" id="5562884">:=</span>&nbsp;<span class="builtinfunc" id="5562887">make</span><span class="op" id="5562891">(</span><span class="keyword" id="5562892">map</span><span class="op" id="5562895">[</span><span class="ident" id="5562896">reflect</span><span class="op" id="5562903">.</span><span class="ident" id="5562904">Type</span><span class="op" id="5562908">]</span><span class="op" id="5562909">*</span><span class="ident" id="5562910">encOp</span><span class="op" id="5562915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562918">rt</span>&nbsp;<span class="op" id="5562921">:=</span>&nbsp;<span class="ident" id="5562924">ut</span><span class="op" id="5562926">.</span><span class="ident" id="5562927">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5562933">if</span>&nbsp;<span class="ident" id="5562936">ut</span><span class="op" id="5562938">.</span><span class="ident" id="5562939">externalEnc</span>&nbsp;<span class="op" id="5562951">!=</span>&nbsp;<span class="num" id="5562954">0</span>&nbsp;<span class="op" id="5562956">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5562960">rt</span>&nbsp;<span class="op" id="5562963">=</span>&nbsp;<span class="ident" id="5562965">ut</span><span class="op" id="5562967">.</span><span class="ident" id="5562968">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5562974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5562977">if</span>&nbsp;<span class="ident" id="5562980">ut</span><span class="op" id="5562982">.</span><span class="ident" id="5562983">externalEnc</span>&nbsp;<span class="op" id="5562995">==</span>&nbsp;<span class="num" id="5562998">0</span>&nbsp;<span class="op" id="5563000">&amp;&amp;</span>&nbsp;<span class="ident" id="5563003">srt</span><span class="op" id="5563006">.</span><span class="ident" id="5563007">Kind</span><span class="op" id="5563011">(</span><span class="op" id="5563012">)</span>&nbsp;<span class="op" id="5563014">==</span>&nbsp;<span class="ident" id="5563017">reflect</span><span class="op" id="5563024">.</span><span class="ident" id="5563025">Struct</span>&nbsp;<span class="op" id="5563032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5563036">for</span>&nbsp;<span class="ident" id="5563040">fieldNum</span><span class="op" id="5563048">,</span>&nbsp;<span class="ident" id="5563050">wireFieldNum</span>&nbsp;<span class="op" id="5563063">:=</span>&nbsp;<span class="num" id="5563066">0</span><span class="op" id="5563067">,</span>&nbsp;<span class="num" id="5563069">0</span><span class="op" id="5563070">;</span>&nbsp;<span class="ident" id="5563072">fieldNum</span>&nbsp;<span class="op" id="5563081">&lt;</span>&nbsp;<span class="ident" id="5563083">srt</span><span class="op" id="5563086">.</span><span class="ident" id="5563087">NumField</span><span class="op" id="5563095">(</span><span class="op" id="5563096">)</span><span class="op" id="5563097">;</span>&nbsp;<span class="ident" id="5563099">fieldNum</span><span class="op" id="5563107">++</span>&nbsp;<span class="op" id="5563110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563115">f</span>&nbsp;<span class="op" id="5563117">:=</span>&nbsp;<span class="ident" id="5563120">srt</span><span class="op" id="5563123">.</span><span class="ident" id="5563124">Field</span><span class="op" id="5563129">(</span><span class="ident" id="5563130">fieldNum</span><span class="op" id="5563138">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5563143">if</span>&nbsp;<span class="op" id="5563146">!</span><span class="ident" id="5563147">isSent</span><span class="op" id="5563153">(</span><span class="op" id="5563154">&amp;</span><span class="ident" id="5563155">f</span><span class="op" id="5563156">)</span>&nbsp;<span class="op" id="5563158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5563164">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5563176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563181">op</span><span class="op" id="5563183">,</span>&nbsp;<span class="ident" id="5563185">indir</span>&nbsp;<span class="op" id="5563191">:=</span>&nbsp;<span class="ident" id="5563194">encOpFor</span><span class="op" id="5563202">(</span><span class="ident" id="5563203">f</span><span class="op" id="5563204">.</span><span class="ident" id="5563205">Type</span><span class="op" id="5563209">,</span>&nbsp;<span class="ident" id="5563211">seen</span><span class="op" id="5563215">,</span>&nbsp;<span class="ident" id="5563217">building</span><span class="op" id="5563225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563230">engine</span><span class="op" id="5563236">.</span><span class="ident" id="5563237">instr</span>&nbsp;<span class="op" id="5563243">=</span>&nbsp;<span class="builtinfunc" id="5563245">append</span><span class="op" id="5563251">(</span><span class="ident" id="5563252">engine</span><span class="op" id="5563258">.</span><span class="ident" id="5563259">instr</span><span class="op" id="5563264">,</span>&nbsp;<span class="ident" id="5563266">encInstr</span><span class="op" id="5563274">{</span><span class="op" id="5563275">*</span><span class="ident" id="5563276">op</span><span class="op" id="5563278">,</span>&nbsp;<span class="ident" id="5563280">wireFieldNum</span><span class="op" id="5563292">,</span>&nbsp;<span class="ident" id="5563294">f</span><span class="op" id="5563295">.</span><span class="ident" id="5563296">Index</span><span class="op" id="5563301">,</span>&nbsp;<span class="ident" id="5563303">indir</span><span class="op" id="5563308">}</span><span class="op" id="5563309">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563314">wireFieldNum</span><span class="op" id="5563326">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5563331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5563335">if</span>&nbsp;<span class="ident" id="5563338">srt</span><span class="op" id="5563341">.</span><span class="ident" id="5563342">NumField</span><span class="op" id="5563350">(</span><span class="op" id="5563351">)</span>&nbsp;<span class="op" id="5563353">&gt;</span>&nbsp;<span class="num" id="5563355">0</span>&nbsp;<span class="op" id="5563357">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5563360">len</span><span class="op" id="5563363">(</span><span class="ident" id="5563364">engine</span><span class="op" id="5563370">.</span><span class="ident" id="5563371">instr</span><span class="op" id="5563376">)</span>&nbsp;<span class="op" id="5563378">==</span>&nbsp;<span class="num" id="5563381">0</span>&nbsp;<span class="op" id="5563383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563388">errorf</span><span class="op" id="5563394">(</span><span class="string" id="5563395">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="5563427">,</span>&nbsp;<span class="ident" id="5563429">rt</span><span class="op" id="5563431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5563435">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563439">engine</span><span class="op" id="5563445">.</span><span class="ident" id="5563446">instr</span>&nbsp;<span class="op" id="5563452">=</span>&nbsp;<span class="builtinfunc" id="5563454">append</span><span class="op" id="5563460">(</span><span class="ident" id="5563461">engine</span><span class="op" id="5563467">.</span><span class="ident" id="5563468">instr</span><span class="op" id="5563473">,</span>&nbsp;<span class="ident" id="5563475">encInstr</span><span class="op" id="5563483">{</span><span class="ident" id="5563484">encStructTerminator</span><span class="op" id="5563503">,</span>&nbsp;<span class="num" id="5563505">0</span><span class="op" id="5563506">,</span>&nbsp;<span class="builtintype" id="5563508">nil</span><span class="op" id="5563511">,</span>&nbsp;<span class="num" id="5563513">0</span><span class="op" id="5563514">}</span><span class="op" id="5563515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5563518">}</span>&nbsp;<span class="keyword" id="5563520">else</span>&nbsp;<span class="op" id="5563525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563529">engine</span><span class="op" id="5563535">.</span><span class="ident" id="5563536">instr</span>&nbsp;<span class="op" id="5563542">=</span>&nbsp;<span class="builtinfunc" id="5563544">make</span><span class="op" id="5563548">(</span><span class="op" id="5563549">[</span><span class="op" id="5563550">]</span><span class="ident" id="5563551">encInstr</span><span class="op" id="5563559">,</span>&nbsp;<span class="num" id="5563561">1</span><span class="op" id="5563562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563566">op</span><span class="op" id="5563568">,</span>&nbsp;<span class="ident" id="5563570">indir</span>&nbsp;<span class="op" id="5563576">:=</span>&nbsp;<span class="ident" id="5563579">encOpFor</span><span class="op" id="5563587">(</span><span class="ident" id="5563588">rt</span><span class="op" id="5563590">,</span>&nbsp;<span class="ident" id="5563592">seen</span><span class="op" id="5563596">,</span>&nbsp;<span class="ident" id="5563598">building</span><span class="op" id="5563606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563610">engine</span><span class="op" id="5563616">.</span><span class="ident" id="5563617">instr</span><span class="op" id="5563622">[</span><span class="num" id="5563623">0</span><span class="op" id="5563624">]</span>&nbsp;<span class="op" id="5563626">=</span>&nbsp;<span class="ident" id="5563628">encInstr</span><span class="op" id="5563636">{</span><span class="op" id="5563637">*</span><span class="ident" id="5563638">op</span><span class="op" id="5563640">,</span>&nbsp;<span class="ident" id="5563642">singletonField</span><span class="op" id="5563656">,</span>&nbsp;<span class="builtintype" id="5563658">nil</span><span class="op" id="5563661">,</span>&nbsp;<span class="ident" id="5563663">indir</span><span class="op" id="5563668">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5563671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5563674">return</span>&nbsp;<span class="ident" id="5563681">engine</span><br>
<span class="lineno"></span><span class="op" id="5563688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5563691">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="5563747">func</span>&nbsp;<span class="ident" id="5563752">getEncEngine</span><span class="op" id="5563764">(</span><span class="ident" id="5563765">ut</span>&nbsp;<span class="op" id="5563768">*</span><span class="ident" id="5563769">userTypeInfo</span><span class="op" id="5563781">,</span>&nbsp;<span class="ident" id="5563783">building</span>&nbsp;<span class="keyword" id="5563792">map</span><span class="op" id="5563795">[</span><span class="op" id="5563796">*</span><span class="ident" id="5563797">typeInfo</span><span class="op" id="5563805">]</span><span class="builtintype" id="5563806">bool</span><span class="op" id="5563810">)</span>&nbsp;<span class="op" id="5563812">*</span><span class="ident" id="5563813">encEngine</span>&nbsp;<span class="op" id="5563823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563826">info</span><span class="op" id="5563830">,</span>&nbsp;<span class="ident" id="5563832">err</span>&nbsp;<span class="op" id="5563836">:=</span>&nbsp;<span class="ident" id="5563839">getTypeInfo</span><span class="op" id="5563850">(</span><span class="ident" id="5563851">ut</span><span class="op" id="5563853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5563856">if</span>&nbsp;<span class="ident" id="5563859">err</span>&nbsp;<span class="op" id="5563863">!=</span>&nbsp;<span class="builtintype" id="5563866">nil</span>&nbsp;<span class="op" id="5563870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563874">error_</span><span class="op" id="5563880">(</span><span class="ident" id="5563881">err</span><span class="op" id="5563884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5563887">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563890">enc</span><span class="op" id="5563893">,</span>&nbsp;<span class="ident" id="5563895">ok</span>&nbsp;<span class="op" id="5563898">:=</span>&nbsp;<span class="ident" id="5563901">info</span><span class="op" id="5563905">.</span><span class="ident" id="5563906">encoder</span><span class="op" id="5563913">.</span><span class="ident" id="5563914">Load</span><span class="op" id="5563918">(</span><span class="op" id="5563919">)</span><span class="op" id="5563920">.</span><span class="op" id="5563921">(</span><span class="op" id="5563922">*</span><span class="ident" id="5563923">encEngine</span><span class="op" id="5563932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5563935">if</span>&nbsp;<span class="op" id="5563938">!</span><span class="ident" id="5563939">ok</span>&nbsp;<span class="op" id="5563942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5563946">enc</span>&nbsp;<span class="op" id="5563950">=</span>&nbsp;<span class="ident" id="5563952">buildEncEngine</span><span class="op" id="5563966">(</span><span class="ident" id="5563967">info</span><span class="op" id="5563971">,</span>&nbsp;<span class="ident" id="5563973">ut</span><span class="op" id="5563975">,</span>&nbsp;<span class="ident" id="5563977">building</span><span class="op" id="5563985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5563988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5563991">return</span>&nbsp;<span class="ident" id="5563998">enc</span><br>
<span class="lineno">660</span><span class="op" id="5564002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5564005">func</span>&nbsp;<span class="ident" id="5564010">buildEncEngine</span><span class="op" id="5564024">(</span><span class="ident" id="5564025">info</span>&nbsp;<span class="op" id="5564030">*</span><span class="ident" id="5564031">typeInfo</span><span class="op" id="5564039">,</span>&nbsp;<span class="ident" id="5564041">ut</span>&nbsp;<span class="op" id="5564044">*</span><span class="ident" id="5564045">userTypeInfo</span><span class="op" id="5564057">,</span>&nbsp;<span class="ident" id="5564059">building</span>&nbsp;<span class="keyword" id="5564068">map</span><span class="op" id="5564071">[</span><span class="op" id="5564072">*</span><span class="ident" id="5564073">typeInfo</span><span class="op" id="5564081">]</span><span class="builtintype" id="5564082">bool</span><span class="op" id="5564086">)</span>&nbsp;<span class="op" id="5564088">*</span><span class="ident" id="5564089">encEngine</span>&nbsp;<span class="op" id="5564099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5564102">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5564133">if</span>&nbsp;<span class="ident" id="5564136">building</span>&nbsp;<span class="op" id="5564145">!=</span>&nbsp;<span class="builtintype" id="5564148">nil</span>&nbsp;<span class="op" id="5564152">&amp;&amp;</span>&nbsp;<span class="ident" id="5564155">building</span><span class="op" id="5564163">[</span><span class="ident" id="5564164">info</span><span class="op" id="5564168">]</span>&nbsp;<span class="op" id="5564170">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5564174">return</span>&nbsp;<span class="builtintype" id="5564181">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5564186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564189">info</span><span class="op" id="5564193">.</span><span class="ident" id="5564194">encInit</span><span class="op" id="5564201">.</span><span class="ident" id="5564202">Lock</span><span class="op" id="5564206">(</span><span class="op" id="5564207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5564210">defer</span>&nbsp;<span class="ident" id="5564216">info</span><span class="op" id="5564220">.</span><span class="ident" id="5564221">encInit</span><span class="op" id="5564228">.</span><span class="ident" id="5564229">Unlock</span><span class="op" id="5564235">(</span><span class="op" id="5564236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564239">enc</span><span class="op" id="5564242">,</span>&nbsp;<span class="ident" id="5564244">ok</span>&nbsp;<span class="op" id="5564247">:=</span>&nbsp;<span class="ident" id="5564250">info</span><span class="op" id="5564254">.</span><span class="ident" id="5564255">encoder</span><span class="op" id="5564262">.</span><span class="ident" id="5564263">Load</span><span class="op" id="5564267">(</span><span class="op" id="5564268">)</span><span class="op" id="5564269">.</span><span class="op" id="5564270">(</span><span class="op" id="5564271">*</span><span class="ident" id="5564272">encEngine</span><span class="op" id="5564281">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5564284">if</span>&nbsp;<span class="op" id="5564287">!</span><span class="ident" id="5564288">ok</span>&nbsp;<span class="op" id="5564291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5564295">if</span>&nbsp;<span class="ident" id="5564298">building</span>&nbsp;<span class="op" id="5564307">==</span>&nbsp;<span class="builtintype" id="5564310">nil</span>&nbsp;<span class="op" id="5564314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564319">building</span>&nbsp;<span class="op" id="5564328">=</span>&nbsp;<span class="builtinfunc" id="5564330">make</span><span class="op" id="5564334">(</span><span class="keyword" id="5564335">map</span><span class="op" id="5564338">[</span><span class="op" id="5564339">*</span><span class="ident" id="5564340">typeInfo</span><span class="op" id="5564348">]</span><span class="builtintype" id="5564349">bool</span><span class="op" id="5564353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5564357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564361">building</span><span class="op" id="5564369">[</span><span class="ident" id="5564370">info</span><span class="op" id="5564374">]</span>&nbsp;<span class="op" id="5564376">=</span>&nbsp;<span class="builtintype" id="5564378">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564385">enc</span>&nbsp;<span class="op" id="5564389">=</span>&nbsp;<span class="ident" id="5564391">compileEnc</span><span class="op" id="5564401">(</span><span class="ident" id="5564402">ut</span><span class="op" id="5564404">,</span>&nbsp;<span class="ident" id="5564406">building</span><span class="op" id="5564414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564418">info</span><span class="op" id="5564422">.</span><span class="ident" id="5564423">encoder</span><span class="op" id="5564430">.</span><span class="ident" id="5564431">Store</span><span class="op" id="5564436">(</span><span class="ident" id="5564437">enc</span><span class="op" id="5564440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5564443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5564446">return</span>&nbsp;<span class="ident" id="5564453">enc</span><br>
<span class="lineno"></span><span class="op" id="5564457">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="5564460">func</span>&nbsp;<span class="op" id="5564465">(</span><span class="ident" id="5564466">enc</span>&nbsp;<span class="op" id="5564470">*</span><span class="ident" id="5564471">Encoder</span><span class="op" id="5564478">)</span>&nbsp;<span class="ident" id="5564480">encode</span><span class="op" id="5564486">(</span><span class="ident" id="5564487">b</span>&nbsp;<span class="op" id="5564489">*</span><span class="ident" id="5564490">encBuffer</span><span class="op" id="5564499">,</span>&nbsp;<span class="ident" id="5564501">value</span>&nbsp;<span class="ident" id="5564507">reflect</span><span class="op" id="5564514">.</span><span class="ident" id="5564515">Value</span><span class="op" id="5564520">,</span>&nbsp;<span class="ident" id="5564522">ut</span>&nbsp;<span class="op" id="5564525">*</span><span class="ident" id="5564526">userTypeInfo</span><span class="op" id="5564538">)</span>&nbsp;<span class="op" id="5564540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5564543">defer</span>&nbsp;<span class="ident" id="5564549">catchError</span><span class="op" id="5564559">(</span><span class="op" id="5564560">&amp;</span><span class="ident" id="5564561">enc</span><span class="op" id="5564564">.</span><span class="ident" id="5564565">err</span><span class="op" id="5564568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564571">engine</span>&nbsp;<span class="op" id="5564578">:=</span>&nbsp;<span class="ident" id="5564581">getEncEngine</span><span class="op" id="5564593">(</span><span class="ident" id="5564594">ut</span><span class="op" id="5564596">,</span>&nbsp;<span class="builtintype" id="5564598">nil</span><span class="op" id="5564601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564604">indir</span>&nbsp;<span class="op" id="5564610">:=</span>&nbsp;<span class="ident" id="5564613">ut</span><span class="op" id="5564615">.</span><span class="ident" id="5564616">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5564623">if</span>&nbsp;<span class="ident" id="5564626">ut</span><span class="op" id="5564628">.</span><span class="ident" id="5564629">externalEnc</span>&nbsp;<span class="op" id="5564641">!=</span>&nbsp;<span class="num" id="5564644">0</span>&nbsp;<span class="op" id="5564646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564650">indir</span>&nbsp;<span class="op" id="5564656">=</span>&nbsp;<span class="builtintype" id="5564658">int</span><span class="op" id="5564661">(</span><span class="ident" id="5564662">ut</span><span class="op" id="5564664">.</span><span class="ident" id="5564665">encIndir</span><span class="op" id="5564673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5564676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5564679">for</span>&nbsp;<span class="ident" id="5564683">i</span>&nbsp;<span class="op" id="5564685">:=</span>&nbsp;<span class="num" id="5564688">0</span><span class="op" id="5564689">;</span>&nbsp;<span class="ident" id="5564691">i</span>&nbsp;<span class="op" id="5564693">&lt;</span>&nbsp;<span class="ident" id="5564695">indir</span><span class="op" id="5564700">;</span>&nbsp;<span class="ident" id="5564702">i</span><span class="op" id="5564703">++</span>&nbsp;<span class="op" id="5564706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564710">value</span>&nbsp;<span class="op" id="5564716">=</span>&nbsp;<span class="ident" id="5564718">reflect</span><span class="op" id="5564725">.</span><span class="ident" id="5564726">Indirect</span><span class="op" id="5564734">(</span><span class="ident" id="5564735">value</span><span class="op" id="5564740">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5564743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5564746">if</span>&nbsp;<span class="ident" id="5564749">ut</span><span class="op" id="5564751">.</span><span class="ident" id="5564752">externalEnc</span>&nbsp;<span class="op" id="5564764">==</span>&nbsp;<span class="num" id="5564767">0</span>&nbsp;<span class="op" id="5564769">&amp;&amp;</span>&nbsp;<span class="ident" id="5564772">value</span><span class="op" id="5564777">.</span><span class="ident" id="5564778">Type</span><span class="op" id="5564782">(</span><span class="op" id="5564783">)</span><span class="op" id="5564784">.</span><span class="ident" id="5564785">Kind</span><span class="op" id="5564789">(</span><span class="op" id="5564790">)</span>&nbsp;<span class="op" id="5564792">==</span>&nbsp;<span class="ident" id="5564795">reflect</span><span class="op" id="5564802">.</span><span class="ident" id="5564803">Struct</span>&nbsp;<span class="op" id="5564810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564814">enc</span><span class="op" id="5564817">.</span><span class="ident" id="5564818">encodeStruct</span><span class="op" id="5564830">(</span><span class="ident" id="5564831">b</span><span class="op" id="5564832">,</span>&nbsp;<span class="ident" id="5564834">engine</span><span class="op" id="5564840">,</span>&nbsp;<span class="ident" id="5564842">value</span><span class="op" id="5564847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5564850">}</span>&nbsp;<span class="keyword" id="5564852">else</span>&nbsp;<span class="op" id="5564857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5564861">enc</span><span class="op" id="5564864">.</span><span class="ident" id="5564865">encodeSingle</span><span class="op" id="5564877">(</span><span class="ident" id="5564878">b</span><span class="op" id="5564879">,</span>&nbsp;<span class="ident" id="5564881">engine</span><span class="op" id="5564887">,</span>&nbsp;<span class="ident" id="5564889">value</span><span class="op" id="5564894">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5564897">}</span><br>
<span class="lineno"></span><span class="op" id="5564899">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
