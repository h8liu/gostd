<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6872106">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6872161">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6872215">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6872266">package</span>&nbsp;<span class="ident" id="6872274">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6872280">import</span>&nbsp;<span class="op" id="6872287">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872290">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872299">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872306">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872315">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872330">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872336">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872349">&#34;math/rand&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872362">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872368">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872379">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="6872389">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6872392">//&nbsp;TestDecodeProgressive&nbsp;tests&nbsp;that&nbsp;decoding&nbsp;the&nbsp;baseline&nbsp;and&nbsp;progressive</span><br>
<span class="lineno"></span><span class="comment" id="6872466">//&nbsp;versions&nbsp;of&nbsp;the&nbsp;same&nbsp;image&nbsp;result&nbsp;in&nbsp;exactly&nbsp;the&nbsp;same&nbsp;pixel&nbsp;data,&nbsp;in&nbsp;YCbCr</span><br>
<span class="lineno"></span><span class="comment" id="6872544">//&nbsp;space&nbsp;for&nbsp;color&nbsp;images,&nbsp;and&nbsp;Y&nbsp;space&nbsp;for&nbsp;grayscale&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="6872605">func</span>&nbsp;<span class="ident" id="6872610">TestDecodeProgressive</span><span class="op" id="6872631">(</span><span class="ident" id="6872632">t</span>&nbsp;<span class="op" id="6872634">*</span><span class="ident" id="6872635">testing</span><span class="op" id="6872642">.</span><span class="ident" id="6872643">T</span><span class="op" id="6872644">)</span>&nbsp;<span class="op" id="6872646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872649">testCases</span>&nbsp;<span class="op" id="6872659">:=</span>&nbsp;<span class="op" id="6872662">[</span><span class="op" id="6872663">]</span><span class="builtintype" id="6872664">string</span><span class="op" id="6872670">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872674">&#34;../testdata/video-001&#34;</span><span class="op" id="6872697">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872701">&#34;../testdata/video-001.q50.420&#34;</span><span class="op" id="6872732">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872736">&#34;../testdata/video-001.q50.422&#34;</span><span class="op" id="6872767">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872771">&#34;../testdata/video-001.q50.440&#34;</span><span class="op" id="6872802">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872806">&#34;../testdata/video-001.q50.444&#34;</span><span class="op" id="6872837">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872841">&#34;../testdata/video-005.gray.q50&#34;</span><span class="op" id="6872873">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872877">&#34;../testdata/video-005.gray.q50.2x2&#34;</span><span class="op" id="6872913">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6872917">&#34;../testdata/video-001.separate.dc.progression&#34;</span><span class="op" id="6872964">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872970">for</span>&nbsp;<span class="ident" id="6872974">_</span><span class="op" id="6872975">,</span>&nbsp;<span class="ident" id="6872977">tc</span>&nbsp;<span class="op" id="6872980">:=</span>&nbsp;<span class="keyword" id="6872983">range</span>&nbsp;<span class="ident" id="6872989">testCases</span>&nbsp;<span class="op" id="6872999">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873003">m0</span><span class="op" id="6873005">,</span>&nbsp;<span class="ident" id="6873007">err</span>&nbsp;<span class="op" id="6873011">:=</span>&nbsp;<span class="ident" id="6873014">decodeFile</span><span class="op" id="6873024">(</span><span class="ident" id="6873025">tc</span>&nbsp;<span class="op" id="6873028">+</span>&nbsp;<span class="string" id="6873030">&#34;.jpeg&#34;</span><span class="op" id="6873037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873041">if</span>&nbsp;<span class="ident" id="6873044">err</span>&nbsp;<span class="op" id="6873048">!=</span>&nbsp;<span class="ident" id="6873051">nil</span>&nbsp;<span class="op" id="6873055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873060">t</span><span class="op" id="6873061">.</span><span class="ident" id="6873062">Errorf</span><span class="op" id="6873068">(</span><span class="string" id="6873069">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="6873077">,</span>&nbsp;<span class="ident" id="6873079">tc</span><span class="op" id="6873081">+</span><span class="string" id="6873082">&#34;.jpeg&#34;</span><span class="op" id="6873089">,</span>&nbsp;<span class="ident" id="6873091">err</span><span class="op" id="6873094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873099">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873110">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873114">m1</span><span class="op" id="6873116">,</span>&nbsp;<span class="ident" id="6873118">err</span>&nbsp;<span class="op" id="6873122">:=</span>&nbsp;<span class="ident" id="6873125">decodeFile</span><span class="op" id="6873135">(</span><span class="ident" id="6873136">tc</span>&nbsp;<span class="op" id="6873139">+</span>&nbsp;<span class="string" id="6873141">&#34;.progressive.jpeg&#34;</span><span class="op" id="6873160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873164">if</span>&nbsp;<span class="ident" id="6873167">err</span>&nbsp;<span class="op" id="6873171">!=</span>&nbsp;<span class="ident" id="6873174">nil</span>&nbsp;<span class="op" id="6873178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873183">t</span><span class="op" id="6873184">.</span><span class="ident" id="6873185">Errorf</span><span class="op" id="6873191">(</span><span class="string" id="6873192">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="6873200">,</span>&nbsp;<span class="ident" id="6873202">tc</span><span class="op" id="6873204">+</span><span class="string" id="6873205">&#34;.progressive.jpeg&#34;</span><span class="op" id="6873224">,</span>&nbsp;<span class="ident" id="6873226">err</span><span class="op" id="6873229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873234">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873245">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873249">if</span>&nbsp;<span class="ident" id="6873252">m0</span><span class="op" id="6873254">.</span><span class="ident" id="6873255">Bounds</span><span class="op" id="6873261">(</span><span class="op" id="6873262">)</span>&nbsp;<span class="op" id="6873264">!=</span>&nbsp;<span class="ident" id="6873267">m1</span><span class="op" id="6873269">.</span><span class="ident" id="6873270">Bounds</span><span class="op" id="6873276">(</span><span class="op" id="6873277">)</span>&nbsp;<span class="op" id="6873279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873284">t</span><span class="op" id="6873285">.</span><span class="ident" id="6873286">Errorf</span><span class="op" id="6873292">(</span><span class="string" id="6873293">&#34;%s:&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="6873323">,</span>&nbsp;<span class="ident" id="6873325">tc</span><span class="op" id="6873327">,</span>&nbsp;<span class="ident" id="6873329">m0</span><span class="op" id="6873331">.</span><span class="ident" id="6873332">Bounds</span><span class="op" id="6873338">(</span><span class="op" id="6873339">)</span><span class="op" id="6873340">,</span>&nbsp;<span class="ident" id="6873342">m1</span><span class="op" id="6873344">.</span><span class="ident" id="6873345">Bounds</span><span class="op" id="6873351">(</span><span class="op" id="6873352">)</span><span class="op" id="6873353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873358">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6873373">//&nbsp;All&nbsp;of&nbsp;the&nbsp;video-*.jpeg&nbsp;files&nbsp;are&nbsp;150x103.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873421">if</span>&nbsp;<span class="ident" id="6873424">m0</span><span class="op" id="6873426">.</span><span class="ident" id="6873427">Bounds</span><span class="op" id="6873433">(</span><span class="op" id="6873434">)</span>&nbsp;<span class="op" id="6873436">!=</span>&nbsp;<span class="ident" id="6873439">image</span><span class="op" id="6873444">.</span><span class="ident" id="6873445">Rect</span><span class="op" id="6873449">(</span><span class="num" id="6873450">0</span><span class="op" id="6873451">,</span>&nbsp;<span class="num" id="6873453">0</span><span class="op" id="6873454">,</span>&nbsp;<span class="num" id="6873456">150</span><span class="op" id="6873459">,</span>&nbsp;<span class="num" id="6873461">103</span><span class="op" id="6873464">)</span>&nbsp;<span class="op" id="6873466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873471">t</span><span class="op" id="6873472">.</span><span class="ident" id="6873473">Errorf</span><span class="op" id="6873479">(</span><span class="string" id="6873480">&#34;%s:&nbsp;bad&nbsp;bounds:&nbsp;%v&#34;</span><span class="op" id="6873500">,</span>&nbsp;<span class="ident" id="6873502">tc</span><span class="op" id="6873504">,</span>&nbsp;<span class="ident" id="6873506">m0</span><span class="op" id="6873508">.</span><span class="ident" id="6873509">Bounds</span><span class="op" id="6873515">(</span><span class="op" id="6873516">)</span><span class="op" id="6873517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873522">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873538">switch</span>&nbsp;<span class="ident" id="6873545">m0</span>&nbsp;<span class="op" id="6873548">:=</span>&nbsp;<span class="ident" id="6873551">m0</span><span class="op" id="6873553">.</span><span class="op" id="6873554">(</span><span class="keyword" id="6873555">type</span><span class="op" id="6873559">)</span>&nbsp;<span class="op" id="6873561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873565">case</span>&nbsp;<span class="op" id="6873570">*</span><span class="ident" id="6873571">image</span><span class="op" id="6873576">.</span><span class="ident" id="6873577">YCbCr</span><span class="op" id="6873582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873587">m1</span>&nbsp;<span class="op" id="6873590">:=</span>&nbsp;<span class="ident" id="6873593">m1</span><span class="op" id="6873595">.</span><span class="op" id="6873596">(</span><span class="op" id="6873597">*</span><span class="ident" id="6873598">image</span><span class="op" id="6873603">.</span><span class="ident" id="6873604">YCbCr</span><span class="op" id="6873609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873614">if</span>&nbsp;<span class="ident" id="6873617">err</span>&nbsp;<span class="op" id="6873621">:=</span>&nbsp;<span class="ident" id="6873624">check</span><span class="op" id="6873629">(</span><span class="ident" id="6873630">m0</span><span class="op" id="6873632">.</span><span class="ident" id="6873633">Bounds</span><span class="op" id="6873639">(</span><span class="op" id="6873640">)</span><span class="op" id="6873641">,</span>&nbsp;<span class="ident" id="6873643">m0</span><span class="op" id="6873645">.</span><span class="ident" id="6873646">Y</span><span class="op" id="6873647">,</span>&nbsp;<span class="ident" id="6873649">m1</span><span class="op" id="6873651">.</span><span class="ident" id="6873652">Y</span><span class="op" id="6873653">,</span>&nbsp;<span class="ident" id="6873655">m0</span><span class="op" id="6873657">.</span><span class="ident" id="6873658">YStride</span><span class="op" id="6873665">,</span>&nbsp;<span class="ident" id="6873667">m1</span><span class="op" id="6873669">.</span><span class="ident" id="6873670">YStride</span><span class="op" id="6873677">)</span><span class="op" id="6873678">;</span>&nbsp;<span class="ident" id="6873680">err</span>&nbsp;<span class="op" id="6873684">!=</span>&nbsp;<span class="ident" id="6873687">nil</span>&nbsp;<span class="op" id="6873691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873697">t</span><span class="op" id="6873698">.</span><span class="ident" id="6873699">Errorf</span><span class="op" id="6873705">(</span><span class="string" id="6873706">&#34;%s&nbsp;(Y):&nbsp;%v&#34;</span><span class="op" id="6873718">,</span>&nbsp;<span class="ident" id="6873720">tc</span><span class="op" id="6873722">,</span>&nbsp;<span class="ident" id="6873724">err</span><span class="op" id="6873727">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873733">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873750">if</span>&nbsp;<span class="ident" id="6873753">err</span>&nbsp;<span class="op" id="6873757">:=</span>&nbsp;<span class="ident" id="6873760">check</span><span class="op" id="6873765">(</span><span class="ident" id="6873766">m0</span><span class="op" id="6873768">.</span><span class="ident" id="6873769">Bounds</span><span class="op" id="6873775">(</span><span class="op" id="6873776">)</span><span class="op" id="6873777">,</span>&nbsp;<span class="ident" id="6873779">m0</span><span class="op" id="6873781">.</span><span class="ident" id="6873782">Cb</span><span class="op" id="6873784">,</span>&nbsp;<span class="ident" id="6873786">m1</span><span class="op" id="6873788">.</span><span class="ident" id="6873789">Cb</span><span class="op" id="6873791">,</span>&nbsp;<span class="ident" id="6873793">m0</span><span class="op" id="6873795">.</span><span class="ident" id="6873796">CStride</span><span class="op" id="6873803">,</span>&nbsp;<span class="ident" id="6873805">m1</span><span class="op" id="6873807">.</span><span class="ident" id="6873808">CStride</span><span class="op" id="6873815">)</span><span class="op" id="6873816">;</span>&nbsp;<span class="ident" id="6873818">err</span>&nbsp;<span class="op" id="6873822">!=</span>&nbsp;<span class="ident" id="6873825">nil</span>&nbsp;<span class="op" id="6873829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873835">t</span><span class="op" id="6873836">.</span><span class="ident" id="6873837">Errorf</span><span class="op" id="6873843">(</span><span class="string" id="6873844">&#34;%s&nbsp;(Cb):&nbsp;%v&#34;</span><span class="op" id="6873857">,</span>&nbsp;<span class="ident" id="6873859">tc</span><span class="op" id="6873861">,</span>&nbsp;<span class="ident" id="6873863">err</span><span class="op" id="6873866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873872">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873889">if</span>&nbsp;<span class="ident" id="6873892">err</span>&nbsp;<span class="op" id="6873896">:=</span>&nbsp;<span class="ident" id="6873899">check</span><span class="op" id="6873904">(</span><span class="ident" id="6873905">m0</span><span class="op" id="6873907">.</span><span class="ident" id="6873908">Bounds</span><span class="op" id="6873914">(</span><span class="op" id="6873915">)</span><span class="op" id="6873916">,</span>&nbsp;<span class="ident" id="6873918">m0</span><span class="op" id="6873920">.</span><span class="ident" id="6873921">Cr</span><span class="op" id="6873923">,</span>&nbsp;<span class="ident" id="6873925">m1</span><span class="op" id="6873927">.</span><span class="ident" id="6873928">Cr</span><span class="op" id="6873930">,</span>&nbsp;<span class="ident" id="6873932">m0</span><span class="op" id="6873934">.</span><span class="ident" id="6873935">CStride</span><span class="op" id="6873942">,</span>&nbsp;<span class="ident" id="6873944">m1</span><span class="op" id="6873946">.</span><span class="ident" id="6873947">CStride</span><span class="op" id="6873954">)</span><span class="op" id="6873955">;</span>&nbsp;<span class="ident" id="6873957">err</span>&nbsp;<span class="op" id="6873961">!=</span>&nbsp;<span class="ident" id="6873964">nil</span>&nbsp;<span class="op" id="6873968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873974">t</span><span class="op" id="6873975">.</span><span class="ident" id="6873976">Errorf</span><span class="op" id="6873982">(</span><span class="string" id="6873983">&#34;%s&nbsp;(Cr):&nbsp;%v&#34;</span><span class="op" id="6873996">,</span>&nbsp;<span class="ident" id="6873998">tc</span><span class="op" id="6874000">,</span>&nbsp;<span class="ident" id="6874002">err</span><span class="op" id="6874005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874011">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874023">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874027">case</span>&nbsp;<span class="op" id="6874032">*</span><span class="ident" id="6874033">image</span><span class="op" id="6874038">.</span><span class="ident" id="6874039">Gray</span><span class="op" id="6874043">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874048">m1</span>&nbsp;<span class="op" id="6874051">:=</span>&nbsp;<span class="ident" id="6874054">m1</span><span class="op" id="6874056">.</span><span class="op" id="6874057">(</span><span class="op" id="6874058">*</span><span class="ident" id="6874059">image</span><span class="op" id="6874064">.</span><span class="ident" id="6874065">Gray</span><span class="op" id="6874069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874074">if</span>&nbsp;<span class="ident" id="6874077">err</span>&nbsp;<span class="op" id="6874081">:=</span>&nbsp;<span class="ident" id="6874084">check</span><span class="op" id="6874089">(</span><span class="ident" id="6874090">m0</span><span class="op" id="6874092">.</span><span class="ident" id="6874093">Bounds</span><span class="op" id="6874099">(</span><span class="op" id="6874100">)</span><span class="op" id="6874101">,</span>&nbsp;<span class="ident" id="6874103">m0</span><span class="op" id="6874105">.</span><span class="ident" id="6874106">Pix</span><span class="op" id="6874109">,</span>&nbsp;<span class="ident" id="6874111">m1</span><span class="op" id="6874113">.</span><span class="ident" id="6874114">Pix</span><span class="op" id="6874117">,</span>&nbsp;<span class="ident" id="6874119">m0</span><span class="op" id="6874121">.</span><span class="ident" id="6874122">Stride</span><span class="op" id="6874128">,</span>&nbsp;<span class="ident" id="6874130">m1</span><span class="op" id="6874132">.</span><span class="ident" id="6874133">Stride</span><span class="op" id="6874139">)</span><span class="op" id="6874140">;</span>&nbsp;<span class="ident" id="6874142">err</span>&nbsp;<span class="op" id="6874146">!=</span>&nbsp;<span class="ident" id="6874149">nil</span>&nbsp;<span class="op" id="6874153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874159">t</span><span class="op" id="6874160">.</span><span class="ident" id="6874161">Errorf</span><span class="op" id="6874167">(</span><span class="string" id="6874168">&#34;%s:&nbsp;%v&#34;</span><span class="op" id="6874176">,</span>&nbsp;<span class="ident" id="6874178">tc</span><span class="op" id="6874180">,</span>&nbsp;<span class="ident" id="6874182">err</span><span class="op" id="6874185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874191">continue</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874207">default</span><span class="op" id="6874214">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874219">t</span><span class="op" id="6874220">.</span><span class="ident" id="6874221">Errorf</span><span class="op" id="6874227">(</span><span class="string" id="6874228">&#34;%s:&nbsp;unexpected&nbsp;image&nbsp;type&nbsp;%T&#34;</span><span class="op" id="6874258">,</span>&nbsp;<span class="ident" id="6874260">tc</span><span class="op" id="6874262">,</span>&nbsp;<span class="ident" id="6874264">m0</span><span class="op" id="6874266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874271">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874282">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874285">}</span><br>
<span class="lineno"></span><span class="op" id="6874287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6874290">func</span>&nbsp;<span class="ident" id="6874295">decodeFile</span><span class="op" id="6874305">(</span><span class="ident" id="6874306">filename</span>&nbsp;<span class="builtintype" id="6874315">string</span><span class="op" id="6874321">)</span>&nbsp;<span class="op" id="6874323">(</span><span class="ident" id="6874324">image</span><span class="op" id="6874329">.</span><span class="ident" id="6874330">Image</span><span class="op" id="6874335">,</span>&nbsp;<span class="builtintype" id="6874337">error</span><span class="op" id="6874342">)</span>&nbsp;<span class="op" id="6874344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874347">f</span><span class="op" id="6874348">,</span>&nbsp;<span class="ident" id="6874350">err</span>&nbsp;<span class="op" id="6874354">:=</span>&nbsp;<span class="ident" id="6874357">os</span><span class="op" id="6874359">.</span><span class="ident" id="6874360">Open</span><span class="op" id="6874364">(</span><span class="ident" id="6874365">filename</span><span class="op" id="6874373">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874376">if</span>&nbsp;<span class="ident" id="6874379">err</span>&nbsp;<span class="op" id="6874383">!=</span>&nbsp;<span class="ident" id="6874386">nil</span>&nbsp;<span class="op" id="6874390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874394">return</span>&nbsp;<span class="ident" id="6874401">nil</span><span class="op" id="6874404">,</span>&nbsp;<span class="ident" id="6874406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874414">defer</span>&nbsp;<span class="ident" id="6874420">f</span><span class="op" id="6874421">.</span><span class="ident" id="6874422">Close</span><span class="op" id="6874427">(</span><span class="op" id="6874428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874431">return</span>&nbsp;<span class="ident" id="6874438">Decode</span><span class="op" id="6874444">(</span><span class="ident" id="6874445">f</span><span class="op" id="6874446">)</span><br>
<span class="lineno">90</span><span class="op" id="6874448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6874451">type</span>&nbsp;<span class="ident" id="6874456">eofReader</span>&nbsp;<span class="keyword" id="6874466">struct</span>&nbsp;<span class="op" id="6874473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874476">data</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6874485">[</span><span class="op" id="6874486">]</span><span class="builtintype" id="6874487">byte</span>&nbsp;<span class="comment" id="6874492">//&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;without&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874526">dataEOF</span>&nbsp;&nbsp;<span class="op" id="6874535">[</span><span class="op" id="6874536">]</span><span class="builtintype" id="6874537">byte</span>&nbsp;<span class="comment" id="6874542">//&nbsp;then&nbsp;deliver&nbsp;from&nbsp;Read&nbsp;with&nbsp;EOF&nbsp;on&nbsp;last&nbsp;chunk</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874592">lenAtEOF</span>&nbsp;<span class="builtintype" id="6874601">int</span><br>
<span class="lineno"></span><span class="op" id="6874605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6874608">func</span>&nbsp;<span class="op" id="6874613">(</span><span class="ident" id="6874614">r</span>&nbsp;<span class="op" id="6874616">*</span><span class="ident" id="6874617">eofReader</span><span class="op" id="6874626">)</span>&nbsp;<span class="ident" id="6874628">Read</span><span class="op" id="6874632">(</span><span class="ident" id="6874633">b</span>&nbsp;<span class="op" id="6874635">[</span><span class="op" id="6874636">]</span><span class="builtintype" id="6874637">byte</span><span class="op" id="6874641">)</span>&nbsp;<span class="op" id="6874643">(</span><span class="ident" id="6874644">n</span>&nbsp;<span class="builtintype" id="6874646">int</span><span class="op" id="6874649">,</span>&nbsp;<span class="ident" id="6874651">err</span>&nbsp;<span class="builtintype" id="6874655">error</span><span class="op" id="6874660">)</span>&nbsp;<span class="op" id="6874662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874665">if</span>&nbsp;<span class="builtinfunc" id="6874668">len</span><span class="op" id="6874671">(</span><span class="ident" id="6874672">r</span><span class="op" id="6874673">.</span><span class="ident" id="6874674">data</span><span class="op" id="6874678">)</span>&nbsp;<span class="op" id="6874680">&gt;</span>&nbsp;<span class="num" id="6874682">0</span>&nbsp;<span class="op" id="6874684">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874688">n</span>&nbsp;<span class="op" id="6874690">=</span>&nbsp;<span class="builtinfunc" id="6874692">copy</span><span class="op" id="6874696">(</span><span class="ident" id="6874697">b</span><span class="op" id="6874698">,</span>&nbsp;<span class="ident" id="6874700">r</span><span class="op" id="6874701">.</span><span class="ident" id="6874702">data</span><span class="op" id="6874706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874710">r</span><span class="op" id="6874711">.</span><span class="ident" id="6874712">data</span>&nbsp;<span class="op" id="6874717">=</span>&nbsp;<span class="ident" id="6874719">r</span><span class="op" id="6874720">.</span><span class="ident" id="6874721">data</span><span class="op" id="6874725">[</span><span class="ident" id="6874726">n</span><span class="op" id="6874727">:</span><span class="op" id="6874728">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874731">}</span>&nbsp;<span class="keyword" id="6874733">else</span>&nbsp;<span class="op" id="6874738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874742">n</span>&nbsp;<span class="op" id="6874744">=</span>&nbsp;<span class="builtinfunc" id="6874746">copy</span><span class="op" id="6874750">(</span><span class="ident" id="6874751">b</span><span class="op" id="6874752">,</span>&nbsp;<span class="ident" id="6874754">r</span><span class="op" id="6874755">.</span><span class="ident" id="6874756">dataEOF</span><span class="op" id="6874763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874767">r</span><span class="op" id="6874768">.</span><span class="ident" id="6874769">dataEOF</span>&nbsp;<span class="op" id="6874777">=</span>&nbsp;<span class="ident" id="6874779">r</span><span class="op" id="6874780">.</span><span class="ident" id="6874781">dataEOF</span><span class="op" id="6874788">[</span><span class="ident" id="6874789">n</span><span class="op" id="6874790">:</span><span class="op" id="6874791">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874795">if</span>&nbsp;<span class="builtinfunc" id="6874798">len</span><span class="op" id="6874801">(</span><span class="ident" id="6874802">r</span><span class="op" id="6874803">.</span><span class="ident" id="6874804">dataEOF</span><span class="op" id="6874811">)</span>&nbsp;<span class="op" id="6874813">==</span>&nbsp;<span class="num" id="6874816">0</span>&nbsp;<span class="op" id="6874818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874823">err</span>&nbsp;<span class="op" id="6874827">=</span>&nbsp;<span class="ident" id="6874829">io</span><span class="op" id="6874831">.</span><span class="ident" id="6874832">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874839">if</span>&nbsp;<span class="ident" id="6874842">r</span><span class="op" id="6874843">.</span><span class="ident" id="6874844">lenAtEOF</span>&nbsp;<span class="op" id="6874853">==</span>&nbsp;<span class="op" id="6874856">-</span><span class="num" id="6874857">1</span>&nbsp;<span class="op" id="6874859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874865">r</span><span class="op" id="6874866">.</span><span class="ident" id="6874867">lenAtEOF</span>&nbsp;<span class="op" id="6874876">=</span>&nbsp;<span class="ident" id="6874878">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874883">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874893">return</span><br>
<span class="lineno"></span><span class="op" id="6874900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="6874903">func</span>&nbsp;<span class="ident" id="6874908">TestDecodeEOF</span><span class="op" id="6874921">(</span><span class="ident" id="6874922">t</span>&nbsp;<span class="op" id="6874924">*</span><span class="ident" id="6874925">testing</span><span class="op" id="6874932">.</span><span class="ident" id="6874933">T</span><span class="op" id="6874934">)</span>&nbsp;<span class="op" id="6874936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6874939">//&nbsp;Check&nbsp;that&nbsp;if&nbsp;reader&nbsp;returns&nbsp;final&nbsp;data&nbsp;and&nbsp;EOF&nbsp;at&nbsp;same&nbsp;time,&nbsp;jpeg&nbsp;handles&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875022">data</span><span class="op" id="6875026">,</span>&nbsp;<span class="ident" id="6875028">err</span>&nbsp;<span class="op" id="6875032">:=</span>&nbsp;<span class="ident" id="6875035">ioutil</span><span class="op" id="6875041">.</span><span class="ident" id="6875042">ReadFile</span><span class="op" id="6875050">(</span><span class="string" id="6875051">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="6875079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875082">if</span>&nbsp;<span class="ident" id="6875085">err</span>&nbsp;<span class="op" id="6875089">!=</span>&nbsp;<span class="ident" id="6875092">nil</span>&nbsp;<span class="op" id="6875096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875100">t</span><span class="op" id="6875101">.</span><span class="ident" id="6875102">Fatal</span><span class="op" id="6875107">(</span><span class="ident" id="6875108">err</span><span class="op" id="6875111">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875118">n</span>&nbsp;<span class="op" id="6875120">:=</span>&nbsp;<span class="builtinfunc" id="6875123">len</span><span class="op" id="6875126">(</span><span class="ident" id="6875127">data</span><span class="op" id="6875131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875134">for</span>&nbsp;<span class="ident" id="6875138">i</span>&nbsp;<span class="op" id="6875140">:=</span>&nbsp;<span class="num" id="6875143">0</span><span class="op" id="6875144">;</span>&nbsp;<span class="ident" id="6875146">i</span>&nbsp;<span class="op" id="6875148">&lt;</span>&nbsp;<span class="ident" id="6875150">n</span><span class="op" id="6875151">;</span>&nbsp;<span class="op" id="6875153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875157">r</span>&nbsp;<span class="op" id="6875159">:=</span>&nbsp;<span class="op" id="6875162">&amp;</span><span class="ident" id="6875163">eofReader</span><span class="op" id="6875172">{</span><span class="ident" id="6875173">data</span><span class="op" id="6875177">[</span><span class="op" id="6875178">:</span><span class="ident" id="6875179">n</span><span class="op" id="6875180">-</span><span class="ident" id="6875181">i</span><span class="op" id="6875182">]</span><span class="op" id="6875183">,</span>&nbsp;<span class="ident" id="6875185">data</span><span class="op" id="6875189">[</span><span class="ident" id="6875190">n</span><span class="op" id="6875191">-</span><span class="ident" id="6875192">i</span><span class="op" id="6875193">:</span><span class="op" id="6875194">]</span><span class="op" id="6875195">,</span>&nbsp;<span class="op" id="6875197">-</span><span class="num" id="6875198">1</span><span class="op" id="6875199">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875203">_</span><span class="op" id="6875204">,</span>&nbsp;<span class="ident" id="6875206">err</span>&nbsp;<span class="op" id="6875210">:=</span>&nbsp;<span class="ident" id="6875213">Decode</span><span class="op" id="6875219">(</span><span class="ident" id="6875220">r</span><span class="op" id="6875221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875225">if</span>&nbsp;<span class="ident" id="6875228">err</span>&nbsp;<span class="op" id="6875232">!=</span>&nbsp;<span class="ident" id="6875235">nil</span>&nbsp;<span class="op" id="6875239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875244">t</span><span class="op" id="6875245">.</span><span class="ident" id="6875246">Errorf</span><span class="op" id="6875252">(</span><span class="string" id="6875253">&#34;Decode&nbsp;with&nbsp;Read()&nbsp;=&nbsp;%d,&nbsp;EOF:&nbsp;%v&#34;</span><span class="op" id="6875287">,</span>&nbsp;<span class="ident" id="6875289">r</span><span class="op" id="6875290">.</span><span class="ident" id="6875291">lenAtEOF</span><span class="op" id="6875299">,</span>&nbsp;<span class="ident" id="6875301">err</span><span class="op" id="6875304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875312">if</span>&nbsp;<span class="ident" id="6875315">i</span>&nbsp;<span class="op" id="6875317">==</span>&nbsp;<span class="num" id="6875320">0</span>&nbsp;<span class="op" id="6875322">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875327">i</span>&nbsp;<span class="op" id="6875329">=</span>&nbsp;<span class="num" id="6875331">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875335">}</span>&nbsp;<span class="keyword" id="6875337">else</span>&nbsp;<span class="op" id="6875342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875347">i</span>&nbsp;<span class="op" id="6875349">*=</span>&nbsp;<span class="num" id="6875352">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875359">}</span><br>
<span class="lineno">135</span><span class="op" id="6875361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6875364">//&nbsp;check&nbsp;checks&nbsp;that&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;are&nbsp;equal,&nbsp;within&nbsp;the&nbsp;given&nbsp;bounds.</span><br>
<span class="lineno"></span><span class="keyword" id="6875438">func</span>&nbsp;<span class="ident" id="6875443">check</span><span class="op" id="6875448">(</span><span class="ident" id="6875449">bounds</span>&nbsp;<span class="ident" id="6875456">image</span><span class="op" id="6875461">.</span><span class="ident" id="6875462">Rectangle</span><span class="op" id="6875471">,</span>&nbsp;<span class="ident" id="6875473">pix0</span><span class="op" id="6875477">,</span>&nbsp;<span class="ident" id="6875479">pix1</span>&nbsp;<span class="op" id="6875484">[</span><span class="op" id="6875485">]</span><span class="builtintype" id="6875486">byte</span><span class="op" id="6875490">,</span>&nbsp;<span class="ident" id="6875492">stride0</span><span class="op" id="6875499">,</span>&nbsp;<span class="ident" id="6875501">stride1</span>&nbsp;<span class="builtintype" id="6875509">int</span><span class="op" id="6875512">)</span>&nbsp;<span class="builtintype" id="6875514">error</span>&nbsp;<span class="op" id="6875520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875523">if</span>&nbsp;<span class="ident" id="6875526">stride0</span>&nbsp;<span class="op" id="6875534">&lt;=</span>&nbsp;<span class="num" id="6875537">0</span>&nbsp;<span class="op" id="6875539">||</span>&nbsp;<span class="ident" id="6875542">stride0</span><span class="op" id="6875549">%</span><span class="num" id="6875550">8</span>&nbsp;<span class="op" id="6875552">!=</span>&nbsp;<span class="num" id="6875555">0</span>&nbsp;<span class="op" id="6875557">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875561">return</span>&nbsp;<span class="ident" id="6875568">fmt</span><span class="op" id="6875571">.</span><span class="ident" id="6875572">Errorf</span><span class="op" id="6875578">(</span><span class="string" id="6875579">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="6875594">,</span>&nbsp;<span class="ident" id="6875596">stride0</span><span class="op" id="6875603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875609">if</span>&nbsp;<span class="ident" id="6875612">stride1</span>&nbsp;<span class="op" id="6875620">&lt;=</span>&nbsp;<span class="num" id="6875623">0</span>&nbsp;<span class="op" id="6875625">||</span>&nbsp;<span class="ident" id="6875628">stride1</span><span class="op" id="6875635">%</span><span class="num" id="6875636">8</span>&nbsp;<span class="op" id="6875638">!=</span>&nbsp;<span class="num" id="6875641">0</span>&nbsp;<span class="op" id="6875643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875647">return</span>&nbsp;<span class="ident" id="6875654">fmt</span><span class="op" id="6875657">.</span><span class="ident" id="6875658">Errorf</span><span class="op" id="6875664">(</span><span class="string" id="6875665">&#34;bad&nbsp;stride&nbsp;%d&#34;</span><span class="op" id="6875680">,</span>&nbsp;<span class="ident" id="6875682">stride1</span><span class="op" id="6875689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875692">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6875695">//&nbsp;Compare&nbsp;the&nbsp;two&nbsp;pix&nbsp;data,&nbsp;one&nbsp;8x8&nbsp;block&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875750">for</span>&nbsp;<span class="ident" id="6875754">y</span>&nbsp;<span class="op" id="6875756">:=</span>&nbsp;<span class="num" id="6875759">0</span><span class="op" id="6875760">;</span>&nbsp;<span class="ident" id="6875762">y</span>&nbsp;<span class="op" id="6875764">&lt;</span>&nbsp;<span class="builtinfunc" id="6875766">len</span><span class="op" id="6875769">(</span><span class="ident" id="6875770">pix0</span><span class="op" id="6875774">)</span><span class="op" id="6875775">/</span><span class="ident" id="6875776">stride0</span>&nbsp;<span class="op" id="6875784">&amp;&amp;</span>&nbsp;<span class="ident" id="6875787">y</span>&nbsp;<span class="op" id="6875789">&lt;</span>&nbsp;<span class="builtinfunc" id="6875791">len</span><span class="op" id="6875794">(</span><span class="ident" id="6875795">pix1</span><span class="op" id="6875799">)</span><span class="op" id="6875800">/</span><span class="ident" id="6875801">stride1</span><span class="op" id="6875808">;</span>&nbsp;<span class="ident" id="6875810">y</span>&nbsp;<span class="op" id="6875812">+=</span>&nbsp;<span class="num" id="6875815">8</span>&nbsp;<span class="op" id="6875817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875821">for</span>&nbsp;<span class="ident" id="6875825">x</span>&nbsp;<span class="op" id="6875827">:=</span>&nbsp;<span class="num" id="6875830">0</span><span class="op" id="6875831">;</span>&nbsp;<span class="ident" id="6875833">x</span>&nbsp;<span class="op" id="6875835">&lt;</span>&nbsp;<span class="ident" id="6875837">stride0</span>&nbsp;<span class="op" id="6875845">&amp;&amp;</span>&nbsp;<span class="ident" id="6875848">x</span>&nbsp;<span class="op" id="6875850">&lt;</span>&nbsp;<span class="ident" id="6875852">stride1</span><span class="op" id="6875859">;</span>&nbsp;<span class="ident" id="6875861">x</span>&nbsp;<span class="op" id="6875863">+=</span>&nbsp;<span class="num" id="6875866">8</span>&nbsp;<span class="op" id="6875868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875873">if</span>&nbsp;<span class="ident" id="6875876">x</span>&nbsp;<span class="op" id="6875878">&gt;=</span>&nbsp;<span class="ident" id="6875881">bounds</span><span class="op" id="6875887">.</span><span class="ident" id="6875888">Max</span><span class="op" id="6875891">.</span><span class="ident" id="6875892">X</span>&nbsp;<span class="op" id="6875894">||</span>&nbsp;<span class="ident" id="6875897">y</span>&nbsp;<span class="op" id="6875899">&gt;=</span>&nbsp;<span class="ident" id="6875902">bounds</span><span class="op" id="6875908">.</span><span class="ident" id="6875909">Max</span><span class="op" id="6875912">.</span><span class="ident" id="6875913">Y</span>&nbsp;<span class="op" id="6875915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6875921">//&nbsp;We&nbsp;don&#39;t&nbsp;care&nbsp;if&nbsp;the&nbsp;two&nbsp;pix&nbsp;data&nbsp;differ&nbsp;if&nbsp;the&nbsp;8x8&nbsp;block&nbsp;is</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6875989">//&nbsp;entirely&nbsp;outside&nbsp;of&nbsp;the&nbsp;image&#39;s&nbsp;bounds.&nbsp;For&nbsp;example,&nbsp;this&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6876058">//&nbsp;occur&nbsp;with&nbsp;a&nbsp;4:2:0&nbsp;chroma&nbsp;subsampling&nbsp;and&nbsp;a&nbsp;1x1&nbsp;image.&nbsp;Baseline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6876129">//&nbsp;decoding&nbsp;works&nbsp;on&nbsp;the&nbsp;one&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole;&nbsp;progressive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6876196">//&nbsp;decoding&#39;s&nbsp;first&nbsp;pass&nbsp;works&nbsp;on&nbsp;that&nbsp;16x16&nbsp;MCU&nbsp;as&nbsp;a&nbsp;whole&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6876264">//&nbsp;refinement&nbsp;passes&nbsp;only&nbsp;process&nbsp;one&nbsp;8x8&nbsp;block&nbsp;within&nbsp;the&nbsp;MCU.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876332">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876350">for</span>&nbsp;<span class="ident" id="6876354">j</span>&nbsp;<span class="op" id="6876356">:=</span>&nbsp;<span class="num" id="6876359">0</span><span class="op" id="6876360">;</span>&nbsp;<span class="ident" id="6876362">j</span>&nbsp;<span class="op" id="6876364">&lt;</span>&nbsp;<span class="num" id="6876366">8</span><span class="op" id="6876367">;</span>&nbsp;<span class="ident" id="6876369">j</span><span class="op" id="6876370">++</span>&nbsp;<span class="op" id="6876373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876379">for</span>&nbsp;<span class="ident" id="6876383">i</span>&nbsp;<span class="op" id="6876385">:=</span>&nbsp;<span class="num" id="6876388">0</span><span class="op" id="6876389">;</span>&nbsp;<span class="ident" id="6876391">i</span>&nbsp;<span class="op" id="6876393">&lt;</span>&nbsp;<span class="num" id="6876395">8</span><span class="op" id="6876396">;</span>&nbsp;<span class="ident" id="6876398">i</span><span class="op" id="6876399">++</span>&nbsp;<span class="op" id="6876402">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876409">index0</span>&nbsp;<span class="op" id="6876416">:=</span>&nbsp;<span class="op" id="6876419">(</span><span class="ident" id="6876420">y</span><span class="op" id="6876421">+</span><span class="ident" id="6876422">j</span><span class="op" id="6876423">)</span><span class="op" id="6876424">*</span><span class="ident" id="6876425">stride0</span>&nbsp;<span class="op" id="6876433">+</span>&nbsp;<span class="op" id="6876435">(</span><span class="ident" id="6876436">x</span>&nbsp;<span class="op" id="6876438">+</span>&nbsp;<span class="ident" id="6876440">i</span><span class="op" id="6876441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876448">index1</span>&nbsp;<span class="op" id="6876455">:=</span>&nbsp;<span class="op" id="6876458">(</span><span class="ident" id="6876459">y</span><span class="op" id="6876460">+</span><span class="ident" id="6876461">j</span><span class="op" id="6876462">)</span><span class="op" id="6876463">*</span><span class="ident" id="6876464">stride1</span>&nbsp;<span class="op" id="6876472">+</span>&nbsp;<span class="op" id="6876474">(</span><span class="ident" id="6876475">x</span>&nbsp;<span class="op" id="6876477">+</span>&nbsp;<span class="ident" id="6876479">i</span><span class="op" id="6876480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876487">if</span>&nbsp;<span class="ident" id="6876490">pix0</span><span class="op" id="6876494">[</span><span class="ident" id="6876495">index0</span><span class="op" id="6876501">]</span>&nbsp;<span class="op" id="6876503">!=</span>&nbsp;<span class="ident" id="6876506">pix1</span><span class="op" id="6876510">[</span><span class="ident" id="6876511">index1</span><span class="op" id="6876517">]</span>&nbsp;<span class="op" id="6876519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876527">return</span>&nbsp;<span class="ident" id="6876534">fmt</span><span class="op" id="6876537">.</span><span class="ident" id="6876538">Errorf</span><span class="op" id="6876544">(</span><span class="string" id="6876545">&#34;blocks&nbsp;at&nbsp;(%d,&nbsp;%d)&nbsp;differ:\n%sand\n%s&#34;</span><span class="op" id="6876584">,</span>&nbsp;<span class="ident" id="6876586">x</span><span class="op" id="6876587">,</span>&nbsp;<span class="ident" id="6876589">y</span><span class="op" id="6876590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876599">pixString</span><span class="op" id="6876608">(</span><span class="ident" id="6876609">pix0</span><span class="op" id="6876613">,</span>&nbsp;<span class="ident" id="6876615">stride0</span><span class="op" id="6876622">,</span>&nbsp;<span class="ident" id="6876624">x</span><span class="op" id="6876625">,</span>&nbsp;<span class="ident" id="6876627">y</span><span class="op" id="6876628">)</span><span class="op" id="6876629">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876638">pixString</span><span class="op" id="6876647">(</span><span class="ident" id="6876648">pix1</span><span class="op" id="6876652">,</span>&nbsp;<span class="ident" id="6876654">stride1</span><span class="op" id="6876661">,</span>&nbsp;<span class="ident" id="6876663">x</span><span class="op" id="6876664">,</span>&nbsp;<span class="ident" id="6876666">y</span><span class="op" id="6876667">)</span><span class="op" id="6876668">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876694">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876704">return</span>&nbsp;<span class="ident" id="6876711">nil</span><br>
<span class="lineno"></span><span class="op" id="6876715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="6876718">func</span>&nbsp;<span class="ident" id="6876723">pixString</span><span class="op" id="6876732">(</span><span class="ident" id="6876733">pix</span>&nbsp;<span class="op" id="6876737">[</span><span class="op" id="6876738">]</span><span class="builtintype" id="6876739">byte</span><span class="op" id="6876743">,</span>&nbsp;<span class="ident" id="6876745">stride</span><span class="op" id="6876751">,</span>&nbsp;<span class="ident" id="6876753">x</span><span class="op" id="6876754">,</span>&nbsp;<span class="ident" id="6876756">y</span>&nbsp;<span class="builtintype" id="6876758">int</span><span class="op" id="6876761">)</span>&nbsp;<span class="builtintype" id="6876763">string</span>&nbsp;<span class="op" id="6876770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876773">s</span>&nbsp;<span class="op" id="6876775">:=</span>&nbsp;<span class="ident" id="6876778">bytes</span><span class="op" id="6876783">.</span><span class="ident" id="6876784">NewBuffer</span><span class="op" id="6876793">(</span><span class="ident" id="6876794">nil</span><span class="op" id="6876797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876800">for</span>&nbsp;<span class="ident" id="6876804">j</span>&nbsp;<span class="op" id="6876806">:=</span>&nbsp;<span class="num" id="6876809">0</span><span class="op" id="6876810">;</span>&nbsp;<span class="ident" id="6876812">j</span>&nbsp;<span class="op" id="6876814">&lt;</span>&nbsp;<span class="num" id="6876816">8</span><span class="op" id="6876817">;</span>&nbsp;<span class="ident" id="6876819">j</span><span class="op" id="6876820">++</span>&nbsp;<span class="op" id="6876823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876827">fmt</span><span class="op" id="6876830">.</span><span class="ident" id="6876831">Fprintf</span><span class="op" id="6876838">(</span><span class="ident" id="6876839">s</span><span class="op" id="6876840">,</span>&nbsp;<span class="string" id="6876842">&#34;\t&#34;</span><span class="op" id="6876846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876850">for</span>&nbsp;<span class="ident" id="6876854">i</span>&nbsp;<span class="op" id="6876856">:=</span>&nbsp;<span class="num" id="6876859">0</span><span class="op" id="6876860">;</span>&nbsp;<span class="ident" id="6876862">i</span>&nbsp;<span class="op" id="6876864">&lt;</span>&nbsp;<span class="num" id="6876866">8</span><span class="op" id="6876867">;</span>&nbsp;<span class="ident" id="6876869">i</span><span class="op" id="6876870">++</span>&nbsp;<span class="op" id="6876873">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876878">fmt</span><span class="op" id="6876881">.</span><span class="ident" id="6876882">Fprintf</span><span class="op" id="6876889">(</span><span class="ident" id="6876890">s</span><span class="op" id="6876891">,</span>&nbsp;<span class="string" id="6876893">&#34;%02x&nbsp;&#34;</span><span class="op" id="6876900">,</span>&nbsp;<span class="ident" id="6876902">pix</span><span class="op" id="6876905">[</span><span class="op" id="6876906">(</span><span class="ident" id="6876907">y</span><span class="op" id="6876908">+</span><span class="ident" id="6876909">j</span><span class="op" id="6876910">)</span><span class="op" id="6876911">*</span><span class="ident" id="6876912">stride</span><span class="op" id="6876918">+</span><span class="op" id="6876919">(</span><span class="ident" id="6876920">x</span><span class="op" id="6876921">+</span><span class="ident" id="6876922">i</span><span class="op" id="6876923">)</span><span class="op" id="6876924">]</span><span class="op" id="6876925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876933">fmt</span><span class="op" id="6876936">.</span><span class="ident" id="6876937">Fprintf</span><span class="op" id="6876944">(</span><span class="ident" id="6876945">s</span><span class="op" id="6876946">,</span>&nbsp;<span class="string" id="6876948">&#34;\n&#34;</span><span class="op" id="6876952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876958">return</span>&nbsp;<span class="ident" id="6876965">s</span><span class="op" id="6876966">.</span><span class="ident" id="6876967">String</span><span class="op" id="6876973">(</span><span class="op" id="6876974">)</span><br>
<span class="lineno">185</span><span class="op" id="6876976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876979">func</span>&nbsp;<span class="ident" id="6876984">TestExtraneousData</span><span class="op" id="6877002">(</span><span class="ident" id="6877003">t</span>&nbsp;<span class="op" id="6877005">*</span><span class="ident" id="6877006">testing</span><span class="op" id="6877013">.</span><span class="ident" id="6877014">T</span><span class="op" id="6877015">)</span>&nbsp;<span class="op" id="6877017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877020">//&nbsp;Encode&nbsp;a&nbsp;1x1&nbsp;red&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877048">src</span>&nbsp;<span class="op" id="6877052">:=</span>&nbsp;<span class="ident" id="6877055">image</span><span class="op" id="6877060">.</span><span class="ident" id="6877061">NewRGBA</span><span class="op" id="6877068">(</span><span class="ident" id="6877069">image</span><span class="op" id="6877074">.</span><span class="ident" id="6877075">Rect</span><span class="op" id="6877079">(</span><span class="num" id="6877080">0</span><span class="op" id="6877081">,</span>&nbsp;<span class="num" id="6877083">0</span><span class="op" id="6877084">,</span>&nbsp;<span class="num" id="6877086">1</span><span class="op" id="6877087">,</span>&nbsp;<span class="num" id="6877089">1</span><span class="op" id="6877090">)</span><span class="op" id="6877091">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877094">src</span><span class="op" id="6877097">.</span><span class="ident" id="6877098">Set</span><span class="op" id="6877101">(</span><span class="num" id="6877102">0</span><span class="op" id="6877103">,</span>&nbsp;<span class="num" id="6877105">0</span><span class="op" id="6877106">,</span>&nbsp;<span class="ident" id="6877108">color</span><span class="op" id="6877113">.</span><span class="ident" id="6877114">RGBA</span><span class="op" id="6877118">{</span><span class="num" id="6877119">0xff</span><span class="op" id="6877123">,</span>&nbsp;<span class="num" id="6877125">0x00</span><span class="op" id="6877129">,</span>&nbsp;<span class="num" id="6877131">0x00</span><span class="op" id="6877135">,</span>&nbsp;<span class="num" id="6877137">0xff</span><span class="op" id="6877141">}</span><span class="op" id="6877142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877145">buf</span>&nbsp;<span class="op" id="6877149">:=</span>&nbsp;<span class="builtinfunc" id="6877152">new</span><span class="op" id="6877155">(</span><span class="ident" id="6877156">bytes</span><span class="op" id="6877161">.</span><span class="ident" id="6877162">Buffer</span><span class="op" id="6877168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877171">if</span>&nbsp;<span class="ident" id="6877174">err</span>&nbsp;<span class="op" id="6877178">:=</span>&nbsp;<span class="ident" id="6877181">Encode</span><span class="op" id="6877187">(</span><span class="ident" id="6877188">buf</span><span class="op" id="6877191">,</span>&nbsp;<span class="ident" id="6877193">src</span><span class="op" id="6877196">,</span>&nbsp;<span class="ident" id="6877198">nil</span><span class="op" id="6877201">)</span><span class="op" id="6877202">;</span>&nbsp;<span class="ident" id="6877204">err</span>&nbsp;<span class="op" id="6877208">!=</span>&nbsp;<span class="ident" id="6877211">nil</span>&nbsp;<span class="op" id="6877215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877219">t</span><span class="op" id="6877220">.</span><span class="ident" id="6877221">Fatalf</span><span class="op" id="6877227">(</span><span class="string" id="6877228">&#34;encode:&nbsp;%v&#34;</span><span class="op" id="6877240">,</span>&nbsp;<span class="ident" id="6877242">err</span><span class="op" id="6877245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877248">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877251">enc</span>&nbsp;<span class="op" id="6877255">:=</span>&nbsp;<span class="ident" id="6877258">buf</span><span class="op" id="6877261">.</span><span class="ident" id="6877262">String</span><span class="op" id="6877268">(</span><span class="op" id="6877269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877272">//&nbsp;Sanity&nbsp;check&nbsp;that&nbsp;the&nbsp;encoded&nbsp;JPEG&nbsp;is&nbsp;long&nbsp;enough,&nbsp;that&nbsp;it&nbsp;ends&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877345">//&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker,&nbsp;and&nbsp;that&nbsp;it&nbsp;contains&nbsp;a&nbsp;&#34;\xff\xda&#34;&nbsp;SOS&nbsp;marker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877417">//&nbsp;somewhere&nbsp;in&nbsp;the&nbsp;final&nbsp;64&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877454">if</span>&nbsp;<span class="builtinfunc" id="6877457">len</span><span class="op" id="6877460">(</span><span class="ident" id="6877461">enc</span><span class="op" id="6877464">)</span>&nbsp;<span class="op" id="6877466">&lt;</span>&nbsp;<span class="num" id="6877468">64</span>&nbsp;<span class="op" id="6877471">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877475">t</span><span class="op" id="6877476">.</span><span class="ident" id="6877477">Fatalf</span><span class="op" id="6877483">(</span><span class="string" id="6877484">&#34;encoded&nbsp;JPEG&nbsp;is&nbsp;too&nbsp;short:&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="6877521">,</span>&nbsp;<span class="builtinfunc" id="6877523">len</span><span class="op" id="6877526">(</span><span class="ident" id="6877527">enc</span><span class="op" id="6877530">)</span><span class="op" id="6877531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877537">if</span>&nbsp;<span class="ident" id="6877540">got</span><span class="op" id="6877543">,</span>&nbsp;<span class="ident" id="6877545">want</span>&nbsp;<span class="op" id="6877550">:=</span>&nbsp;<span class="ident" id="6877553">enc</span><span class="op" id="6877556">[</span><span class="builtinfunc" id="6877557">len</span><span class="op" id="6877560">(</span><span class="ident" id="6877561">enc</span><span class="op" id="6877564">)</span><span class="op" id="6877565">-</span><span class="num" id="6877566">2</span><span class="op" id="6877567">:</span><span class="op" id="6877568">]</span><span class="op" id="6877569">,</span>&nbsp;<span class="string" id="6877571">&#34;\xff\xd9&#34;</span><span class="op" id="6877581">;</span>&nbsp;<span class="ident" id="6877583">got</span>&nbsp;<span class="op" id="6877587">!=</span>&nbsp;<span class="ident" id="6877590">want</span>&nbsp;<span class="op" id="6877595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877599">t</span><span class="op" id="6877600">.</span><span class="ident" id="6877601">Fatalf</span><span class="op" id="6877607">(</span><span class="string" id="6877608">&#34;encoded&nbsp;JPEG&nbsp;ends&nbsp;with&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6877644">,</span>&nbsp;<span class="ident" id="6877646">got</span><span class="op" id="6877649">,</span>&nbsp;<span class="ident" id="6877651">want</span><span class="op" id="6877655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877658">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877661">if</span>&nbsp;<span class="ident" id="6877664">s</span>&nbsp;<span class="op" id="6877666">:=</span>&nbsp;<span class="ident" id="6877669">enc</span><span class="op" id="6877672">[</span><span class="builtinfunc" id="6877673">len</span><span class="op" id="6877676">(</span><span class="ident" id="6877677">enc</span><span class="op" id="6877680">)</span><span class="op" id="6877681">-</span><span class="num" id="6877682">64</span><span class="op" id="6877684">:</span><span class="op" id="6877685">]</span><span class="op" id="6877686">;</span>&nbsp;<span class="op" id="6877688">!</span><span class="ident" id="6877689">strings</span><span class="op" id="6877696">.</span><span class="ident" id="6877697">Contains</span><span class="op" id="6877705">(</span><span class="ident" id="6877706">s</span><span class="op" id="6877707">,</span>&nbsp;<span class="string" id="6877709">&#34;\xff\xda&#34;</span><span class="op" id="6877719">)</span>&nbsp;<span class="op" id="6877721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877725">t</span><span class="op" id="6877726">.</span><span class="ident" id="6877727">Fatalf</span><span class="op" id="6877733">(</span><span class="string" id="6877734">&#34;encoded&nbsp;JPEG&nbsp;does&nbsp;not&nbsp;contain&nbsp;a&nbsp;SOS&nbsp;marker&nbsp;(ff&nbsp;da)&nbsp;near&nbsp;the&nbsp;end:&nbsp;%&nbsp;x&#34;</span><span class="op" id="6877804">,</span>&nbsp;<span class="ident" id="6877806">s</span><span class="op" id="6877807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877813">//&nbsp;Test&nbsp;that&nbsp;adding&nbsp;some&nbsp;random&nbsp;junk&nbsp;between&nbsp;the&nbsp;SOS&nbsp;marker&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877882">//&nbsp;EOI&nbsp;marker&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;decoding.</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877927">rnd</span>&nbsp;<span class="op" id="6877931">:=</span>&nbsp;<span class="ident" id="6877934">rand</span><span class="op" id="6877938">.</span><span class="ident" id="6877939">New</span><span class="op" id="6877942">(</span><span class="ident" id="6877943">rand</span><span class="op" id="6877947">.</span><span class="ident" id="6877948">NewSource</span><span class="op" id="6877957">(</span><span class="num" id="6877958">1</span><span class="op" id="6877959">)</span><span class="op" id="6877960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877963">for</span>&nbsp;<span class="ident" id="6877967">i</span><span class="op" id="6877968">,</span>&nbsp;<span class="ident" id="6877970">nerr</span>&nbsp;<span class="op" id="6877975">:=</span>&nbsp;<span class="num" id="6877978">0</span><span class="op" id="6877979">,</span>&nbsp;<span class="num" id="6877981">0</span><span class="op" id="6877982">;</span>&nbsp;<span class="ident" id="6877984">i</span>&nbsp;<span class="op" id="6877986">&lt;</span>&nbsp;<span class="num" id="6877988">1000</span>&nbsp;<span class="op" id="6877993">&amp;&amp;</span>&nbsp;<span class="ident" id="6877996">nerr</span>&nbsp;<span class="op" id="6878001">&lt;</span>&nbsp;<span class="num" id="6878003">10</span><span class="op" id="6878005">;</span>&nbsp;<span class="ident" id="6878007">i</span><span class="op" id="6878008">++</span>&nbsp;<span class="op" id="6878011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878015">buf</span><span class="op" id="6878018">.</span><span class="ident" id="6878019">Reset</span><span class="op" id="6878024">(</span><span class="op" id="6878025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878029">//&nbsp;Write&nbsp;all&nbsp;but&nbsp;the&nbsp;trailing&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878084">buf</span><span class="op" id="6878087">.</span><span class="ident" id="6878088">WriteString</span><span class="op" id="6878099">(</span><span class="ident" id="6878100">enc</span><span class="op" id="6878103">[</span><span class="op" id="6878104">:</span><span class="builtinfunc" id="6878105">len</span><span class="op" id="6878108">(</span><span class="ident" id="6878109">enc</span><span class="op" id="6878112">)</span><span class="op" id="6878113">-</span><span class="num" id="6878114">2</span><span class="op" id="6878115">]</span><span class="op" id="6878116">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878120">//&nbsp;Write&nbsp;some&nbsp;random&nbsp;extraneous&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878160">for</span>&nbsp;<span class="ident" id="6878164">n</span>&nbsp;<span class="op" id="6878166">:=</span>&nbsp;<span class="ident" id="6878169">rnd</span><span class="op" id="6878172">.</span><span class="ident" id="6878173">Intn</span><span class="op" id="6878177">(</span><span class="num" id="6878178">10</span><span class="op" id="6878180">)</span><span class="op" id="6878181">;</span>&nbsp;<span class="ident" id="6878183">n</span>&nbsp;<span class="op" id="6878185">&gt;</span>&nbsp;<span class="num" id="6878187">0</span><span class="op" id="6878188">;</span>&nbsp;<span class="ident" id="6878190">n</span><span class="op" id="6878191">--</span>&nbsp;<span class="op" id="6878194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878199">if</span>&nbsp;<span class="ident" id="6878202">x</span>&nbsp;<span class="op" id="6878204">:=</span>&nbsp;<span class="builtintype" id="6878207">byte</span><span class="op" id="6878211">(</span><span class="ident" id="6878212">rnd</span><span class="op" id="6878215">.</span><span class="ident" id="6878216">Intn</span><span class="op" id="6878220">(</span><span class="num" id="6878221">256</span><span class="op" id="6878224">)</span><span class="op" id="6878225">)</span><span class="op" id="6878226">;</span>&nbsp;<span class="ident" id="6878228">x</span>&nbsp;<span class="op" id="6878230">!=</span>&nbsp;<span class="num" id="6878233">0xff</span>&nbsp;<span class="op" id="6878238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878244">buf</span><span class="op" id="6878247">.</span><span class="ident" id="6878248">WriteByte</span><span class="op" id="6878257">(</span><span class="ident" id="6878258">x</span><span class="op" id="6878259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878264">}</span>&nbsp;<span class="keyword" id="6878266">else</span>&nbsp;<span class="op" id="6878271">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878277">//&nbsp;The&nbsp;JPEG&nbsp;format&nbsp;escapes&nbsp;a&nbsp;SOS&nbsp;0xff&nbsp;data&nbsp;byte&nbsp;as&nbsp;&#34;\xff\x00&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878344">buf</span><span class="op" id="6878347">.</span><span class="ident" id="6878348">WriteString</span><span class="op" id="6878359">(</span><span class="string" id="6878360">&#34;\xff\x00&#34;</span><span class="op" id="6878370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878383">//&nbsp;Write&nbsp;the&nbsp;&#34;\xff\xd9&#34;&nbsp;EOI&nbsp;marker.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878421">buf</span><span class="op" id="6878424">.</span><span class="ident" id="6878425">WriteString</span><span class="op" id="6878436">(</span><span class="string" id="6878437">&#34;\xff\xd9&#34;</span><span class="op" id="6878447">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878452">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;can&nbsp;still&nbsp;decode&nbsp;the&nbsp;resultant&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878509">got</span><span class="op" id="6878512">,</span>&nbsp;<span class="ident" id="6878514">err</span>&nbsp;<span class="op" id="6878518">:=</span>&nbsp;<span class="ident" id="6878521">Decode</span><span class="op" id="6878527">(</span><span class="ident" id="6878528">buf</span><span class="op" id="6878531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878535">if</span>&nbsp;<span class="ident" id="6878538">err</span>&nbsp;<span class="op" id="6878542">!=</span>&nbsp;<span class="ident" id="6878545">nil</span>&nbsp;<span class="op" id="6878549">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878554">t</span><span class="op" id="6878555">.</span><span class="ident" id="6878556">Errorf</span><span class="op" id="6878562">(</span><span class="string" id="6878563">&#34;could&nbsp;not&nbsp;decode&nbsp;image&nbsp;#%d:&nbsp;%v&#34;</span><span class="op" id="6878595">,</span>&nbsp;<span class="ident" id="6878597">i</span><span class="op" id="6878598">,</span>&nbsp;<span class="ident" id="6878600">err</span><span class="op" id="6878603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878608">nerr</span><span class="op" id="6878612">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878618">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878633">if</span>&nbsp;<span class="ident" id="6878636">got</span><span class="op" id="6878639">.</span><span class="ident" id="6878640">Bounds</span><span class="op" id="6878646">(</span><span class="op" id="6878647">)</span>&nbsp;<span class="op" id="6878649">!=</span>&nbsp;<span class="ident" id="6878652">src</span><span class="op" id="6878655">.</span><span class="ident" id="6878656">Bounds</span><span class="op" id="6878662">(</span><span class="op" id="6878663">)</span>&nbsp;<span class="op" id="6878665">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878670">t</span><span class="op" id="6878671">.</span><span class="ident" id="6878672">Errorf</span><span class="op" id="6878678">(</span><span class="string" id="6878679">&#34;image&nbsp;#%d,&nbsp;bounds&nbsp;differ:&nbsp;%v&nbsp;and&nbsp;%v&#34;</span><span class="op" id="6878716">,</span>&nbsp;<span class="ident" id="6878718">i</span><span class="op" id="6878719">,</span>&nbsp;<span class="ident" id="6878721">got</span><span class="op" id="6878724">.</span><span class="ident" id="6878725">Bounds</span><span class="op" id="6878731">(</span><span class="op" id="6878732">)</span><span class="op" id="6878733">,</span>&nbsp;<span class="ident" id="6878735">src</span><span class="op" id="6878738">.</span><span class="ident" id="6878739">Bounds</span><span class="op" id="6878745">(</span><span class="op" id="6878746">)</span><span class="op" id="6878747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878752">nerr</span><span class="op" id="6878756">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878762">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878777">if</span>&nbsp;<span class="ident" id="6878780">averageDelta</span><span class="op" id="6878792">(</span><span class="ident" id="6878793">got</span><span class="op" id="6878796">,</span>&nbsp;<span class="ident" id="6878798">src</span><span class="op" id="6878801">)</span>&nbsp;<span class="op" id="6878803">&gt;</span>&nbsp;<span class="num" id="6878805">2</span><span class="op" id="6878806">&lt;&lt;</span><span class="num" id="6878808">8</span>&nbsp;<span class="op" id="6878810">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878815">t</span><span class="op" id="6878816">.</span><span class="ident" id="6878817">Errorf</span><span class="op" id="6878823">(</span><span class="string" id="6878824">&#34;image&nbsp;#%d&nbsp;changed&nbsp;too&nbsp;much&nbsp;after&nbsp;a&nbsp;round&nbsp;trip&#34;</span><span class="op" id="6878871">,</span>&nbsp;<span class="ident" id="6878873">i</span><span class="op" id="6878874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878879">nerr</span><span class="op" id="6878883">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878889">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878903">}</span><br>
<span class="lineno">245</span><span class="op" id="6878905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6878908">func</span>&nbsp;<span class="ident" id="6878913">benchmarkDecode</span><span class="op" id="6878928">(</span><span class="ident" id="6878929">b</span>&nbsp;<span class="op" id="6878931">*</span><span class="ident" id="6878932">testing</span><span class="op" id="6878939">.</span><span class="ident" id="6878940">B</span><span class="op" id="6878941">,</span>&nbsp;<span class="ident" id="6878943">filename</span>&nbsp;<span class="builtintype" id="6878952">string</span><span class="op" id="6878958">)</span>&nbsp;<span class="op" id="6878960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878963">b</span><span class="op" id="6878964">.</span><span class="ident" id="6878965">StopTimer</span><span class="op" id="6878974">(</span><span class="op" id="6878975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878978">data</span><span class="op" id="6878982">,</span>&nbsp;<span class="ident" id="6878984">err</span>&nbsp;<span class="op" id="6878988">:=</span>&nbsp;<span class="ident" id="6878991">ioutil</span><span class="op" id="6878997">.</span><span class="ident" id="6878998">ReadFile</span><span class="op" id="6879006">(</span><span class="ident" id="6879007">filename</span><span class="op" id="6879015">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879018">if</span>&nbsp;<span class="ident" id="6879021">err</span>&nbsp;<span class="op" id="6879025">!=</span>&nbsp;<span class="ident" id="6879028">nil</span>&nbsp;<span class="op" id="6879032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879036">b</span><span class="op" id="6879037">.</span><span class="ident" id="6879038">Fatal</span><span class="op" id="6879043">(</span><span class="ident" id="6879044">err</span><span class="op" id="6879047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879053">cfg</span><span class="op" id="6879056">,</span>&nbsp;<span class="ident" id="6879058">err</span>&nbsp;<span class="op" id="6879062">:=</span>&nbsp;<span class="ident" id="6879065">DecodeConfig</span><span class="op" id="6879077">(</span><span class="ident" id="6879078">bytes</span><span class="op" id="6879083">.</span><span class="ident" id="6879084">NewReader</span><span class="op" id="6879093">(</span><span class="ident" id="6879094">data</span><span class="op" id="6879098">)</span><span class="op" id="6879099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879102">if</span>&nbsp;<span class="ident" id="6879105">err</span>&nbsp;<span class="op" id="6879109">!=</span>&nbsp;<span class="ident" id="6879112">nil</span>&nbsp;<span class="op" id="6879116">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879120">b</span><span class="op" id="6879121">.</span><span class="ident" id="6879122">Fatal</span><span class="op" id="6879127">(</span><span class="ident" id="6879128">err</span><span class="op" id="6879131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879137">b</span><span class="op" id="6879138">.</span><span class="ident" id="6879139">SetBytes</span><span class="op" id="6879147">(</span><span class="ident" id="6879148">int64</span><span class="op" id="6879153">(</span><span class="ident" id="6879154">cfg</span><span class="op" id="6879157">.</span><span class="ident" id="6879158">Width</span>&nbsp;<span class="op" id="6879164">*</span>&nbsp;<span class="ident" id="6879166">cfg</span><span class="op" id="6879169">.</span><span class="ident" id="6879170">Height</span>&nbsp;<span class="op" id="6879177">*</span>&nbsp;<span class="num" id="6879179">4</span><span class="op" id="6879180">)</span><span class="op" id="6879181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879184">b</span><span class="op" id="6879185">.</span><span class="ident" id="6879186">StartTimer</span><span class="op" id="6879196">(</span><span class="op" id="6879197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879200">for</span>&nbsp;<span class="ident" id="6879204">i</span>&nbsp;<span class="op" id="6879206">:=</span>&nbsp;<span class="num" id="6879209">0</span><span class="op" id="6879210">;</span>&nbsp;<span class="ident" id="6879212">i</span>&nbsp;<span class="op" id="6879214">&lt;</span>&nbsp;<span class="ident" id="6879216">b</span><span class="op" id="6879217">.</span><span class="ident" id="6879218">N</span><span class="op" id="6879219">;</span>&nbsp;<span class="ident" id="6879221">i</span><span class="op" id="6879222">++</span>&nbsp;<span class="op" id="6879225">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879229">Decode</span><span class="op" id="6879235">(</span><span class="ident" id="6879236">bytes</span><span class="op" id="6879241">.</span><span class="ident" id="6879242">NewReader</span><span class="op" id="6879251">(</span><span class="ident" id="6879252">data</span><span class="op" id="6879256">)</span><span class="op" id="6879257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879260">}</span><br>
<span class="lineno"></span><span class="op" id="6879262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6879265">func</span>&nbsp;<span class="ident" id="6879270">BenchmarkDecodeBaseline</span><span class="op" id="6879293">(</span><span class="ident" id="6879294">b</span>&nbsp;<span class="op" id="6879296">*</span><span class="ident" id="6879297">testing</span><span class="op" id="6879304">.</span><span class="ident" id="6879305">B</span><span class="op" id="6879306">)</span>&nbsp;<span class="op" id="6879308">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879311">benchmarkDecode</span><span class="op" id="6879326">(</span><span class="ident" id="6879327">b</span><span class="op" id="6879328">,</span>&nbsp;<span class="string" id="6879330">&#34;../testdata/video-001.jpeg&#34;</span><span class="op" id="6879358">)</span><br>
<span class="lineno"></span><span class="op" id="6879360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6879363">func</span>&nbsp;<span class="ident" id="6879368">BenchmarkDecodeProgressive</span><span class="op" id="6879394">(</span><span class="ident" id="6879395">b</span>&nbsp;<span class="op" id="6879397">*</span><span class="ident" id="6879398">testing</span><span class="op" id="6879405">.</span><span class="ident" id="6879406">B</span><span class="op" id="6879407">)</span>&nbsp;<span class="op" id="6879409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879412">benchmarkDecode</span><span class="op" id="6879427">(</span><span class="ident" id="6879428">b</span><span class="op" id="6879429">,</span>&nbsp;<span class="string" id="6879431">&#34;../testdata/video-001.progressive.jpeg&#34;</span><span class="op" id="6879471">)</span><br>
<span class="lineno">270</span><span class="op" id="6879473">}</span>
</div>
</body>
</html>
