<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/x509</h2>
<ul>
<li><a href="/gostd/crypto/x509/cert_pool.go.html">cert_pool.go</a></li>
<li><a href="/gostd/crypto/x509/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/x509/pem_decrypt.go.html">pem_decrypt.go</a></li>
<li><a href="/gostd/crypto/x509/pem_decrypt_test.go.html">pem_decrypt_test.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs1.go.html">pkcs1.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs8.go.html">pkcs8.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs8_test.go.html">pkcs8_test.go</a></li>
<li><a href="/gostd/crypto/x509/root.go.html">root.go</a></li>
<li><a href="/gostd/crypto/x509/root_unix.go.html">root_unix.go</a></li>
<li><a href="/gostd/crypto/x509/sec1.go.html">sec1.go</a></li>
<li><a href="/gostd/crypto/x509/sec1_test.go.html">sec1_test.go</a></li>
<li><a href="/gostd/crypto/x509/verify.go.html">verify.go</a></li>
<li><a href="/gostd/crypto/x509/verify_test.go.html">verify_test.go</a></li>
<li><a href="/gostd/crypto/x509/x509.go.html">x509.go</a></li>
<li><a href="/gostd/crypto/x509/x509_test.go.html">x509_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3591717">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3591772">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3591826">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3591877">package</span>&nbsp;<span class="ident" id="3591885">x509</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3591891">import</span>&nbsp;<span class="op" id="3591898">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3591901">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3591908">&#34;net&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3591915">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3591926">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3591937">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3591945">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="3591960">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3591963">type</span>&nbsp;<span class="ident" id="3591968">InvalidReason</span>&nbsp;<span class="builtintype" id="3591982">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3591987">const</span>&nbsp;<span class="op" id="3591993">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3591996">//&nbsp;NotAuthorizedToSign&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;another</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592068">//&nbsp;which&nbsp;isn&#39;t&nbsp;marked&nbsp;as&nbsp;a&nbsp;CA&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592112">NotAuthorizedToSign</span>&nbsp;<span class="ident" id="3592132">InvalidReason</span>&nbsp;<span class="op" id="3592146">=</span>&nbsp;<span class="ident" id="3592148">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592154">//&nbsp;Expired&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;has&nbsp;expired,&nbsp;based&nbsp;on&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592224">//&nbsp;given&nbsp;in&nbsp;the&nbsp;VerifyOptions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592256">Expired</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592265">//&nbsp;CANotAuthorizedForThisName&nbsp;results&nbsp;when&nbsp;an&nbsp;intermediate&nbsp;or&nbsp;root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592333">//&nbsp;certificate&nbsp;has&nbsp;a&nbsp;name&nbsp;constraint&nbsp;which&nbsp;doesn&#39;t&nbsp;include&nbsp;the&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592402">//&nbsp;being&nbsp;checked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592421">CANotAuthorizedForThisName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592449">//&nbsp;TooManyIntermediates&nbsp;results&nbsp;when&nbsp;a&nbsp;path&nbsp;length&nbsp;constraint&nbsp;is</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592515">//&nbsp;violated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592529">TooManyIntermediates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592551">//&nbsp;IncompatibleUsage&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&#39;s&nbsp;key&nbsp;usage&nbsp;indicates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3592624">//&nbsp;that&nbsp;it&nbsp;may&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;a&nbsp;different&nbsp;purpose.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592678">IncompatibleUsage</span><br>
<span class="lineno">35</span><span class="op" id="3592696">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3592699">//&nbsp;CertificateInvalidError&nbsp;results&nbsp;when&nbsp;an&nbsp;odd&nbsp;error&nbsp;occurs.&nbsp;Users&nbsp;of&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="3592774">//&nbsp;library&nbsp;probably&nbsp;want&nbsp;to&nbsp;handle&nbsp;all&nbsp;these&nbsp;errors&nbsp;uniformly.</span><br>
<span class="lineno"></span><span class="keyword" id="3592837">type</span>&nbsp;<span class="ident" id="3592842">CertificateInvalidError</span>&nbsp;<span class="keyword" id="3592866">struct</span>&nbsp;<span class="op" id="3592873">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592876">Cert</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3592883">*</span><span class="ident" id="3592884">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3592897">Reason</span>&nbsp;<span class="ident" id="3592904">InvalidReason</span><br>
<span class="lineno"></span><span class="op" id="3592918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3592921">func</span>&nbsp;<span class="op" id="3592926">(</span><span class="ident" id="3592927">e</span>&nbsp;<span class="ident" id="3592929">CertificateInvalidError</span><span class="op" id="3592952">)</span>&nbsp;<span class="ident" id="3592954">Error</span><span class="op" id="3592959">(</span><span class="op" id="3592960">)</span>&nbsp;<span class="builtintype" id="3592962">string</span>&nbsp;<span class="op" id="3592969">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592972">switch</span>&nbsp;<span class="ident" id="3592979">e</span><span class="op" id="3592980">.</span><span class="ident" id="3592981">Reason</span>&nbsp;<span class="op" id="3592988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3592991">case</span>&nbsp;<span class="ident" id="3592996">NotAuthorizedToSign</span><span class="op" id="3593015">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593019">return</span>&nbsp;<span class="string" id="3593026">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;other&nbsp;certificates&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593092">case</span>&nbsp;<span class="ident" id="3593097">Expired</span><span class="op" id="3593104">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593108">return</span>&nbsp;<span class="string" id="3593115">&#34;x509:&nbsp;certificate&nbsp;has&nbsp;expired&nbsp;or&nbsp;is&nbsp;not&nbsp;yet&nbsp;valid&#34;</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593168">case</span>&nbsp;<span class="ident" id="3593173">CANotAuthorizedForThisName</span><span class="op" id="3593199">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593203">return</span>&nbsp;<span class="string" id="3593210">&#34;x509:&nbsp;a&nbsp;root&nbsp;or&nbsp;intermediate&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;in&nbsp;this&nbsp;domain&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593295">case</span>&nbsp;<span class="ident" id="3593300">TooManyIntermediates</span><span class="op" id="3593320">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593324">return</span>&nbsp;<span class="string" id="3593331">&#34;x509:&nbsp;too&nbsp;many&nbsp;intermediates&nbsp;for&nbsp;path&nbsp;length&nbsp;constraint&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593390">case</span>&nbsp;<span class="ident" id="3593395">IncompatibleUsage</span><span class="op" id="3593412">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593416">return</span>&nbsp;<span class="string" id="3593423">&#34;x509:&nbsp;certificate&nbsp;specifies&nbsp;an&nbsp;incompatible&nbsp;key&nbsp;usage&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3593480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593483">return</span>&nbsp;<span class="string" id="3593490">&#34;x509:&nbsp;unknown&nbsp;error&#34;</span><br>
<span class="lineno"></span><span class="op" id="3593512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="3593515">//&nbsp;HostnameError&nbsp;results&nbsp;when&nbsp;the&nbsp;set&nbsp;of&nbsp;authorized&nbsp;names&nbsp;doesn&#39;t&nbsp;match&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3593591">//&nbsp;requested&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3593610">type</span>&nbsp;<span class="ident" id="3593615">HostnameError</span>&nbsp;<span class="keyword" id="3593629">struct</span>&nbsp;<span class="op" id="3593636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3593639">Certificate</span>&nbsp;<span class="op" id="3593651">*</span><span class="ident" id="3593652">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3593665">Host</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3593677">string</span><br>
<span class="lineno">65</span><span class="op" id="3593684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3593687">func</span>&nbsp;<span class="op" id="3593692">(</span><span class="ident" id="3593693">h</span>&nbsp;<span class="ident" id="3593695">HostnameError</span><span class="op" id="3593708">)</span>&nbsp;<span class="ident" id="3593710">Error</span><span class="op" id="3593715">(</span><span class="op" id="3593716">)</span>&nbsp;<span class="builtintype" id="3593718">string</span>&nbsp;<span class="op" id="3593725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3593728">c</span>&nbsp;<span class="op" id="3593730">:=</span>&nbsp;<span class="ident" id="3593733">h</span><span class="op" id="3593734">.</span><span class="ident" id="3593735">Certificate</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593749">var</span>&nbsp;<span class="ident" id="3593753">valid</span>&nbsp;<span class="builtintype" id="3593759">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593767">if</span>&nbsp;<span class="ident" id="3593770">ip</span>&nbsp;<span class="op" id="3593773">:=</span>&nbsp;<span class="ident" id="3593776">net</span><span class="op" id="3593779">.</span><span class="ident" id="3593780">ParseIP</span><span class="op" id="3593787">(</span><span class="ident" id="3593788">h</span><span class="op" id="3593789">.</span><span class="ident" id="3593790">Host</span><span class="op" id="3593794">)</span><span class="op" id="3593795">;</span>&nbsp;<span class="ident" id="3593797">ip</span>&nbsp;<span class="op" id="3593800">!=</span>&nbsp;<span class="ident" id="3593803">nil</span>&nbsp;<span class="op" id="3593807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3593811">//&nbsp;Trying&nbsp;to&nbsp;validate&nbsp;an&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593841">if</span>&nbsp;<span class="builtinfunc" id="3593844">len</span><span class="op" id="3593847">(</span><span class="ident" id="3593848">c</span><span class="op" id="3593849">.</span><span class="ident" id="3593850">IPAddresses</span><span class="op" id="3593861">)</span>&nbsp;<span class="op" id="3593863">==</span>&nbsp;<span class="num" id="3593866">0</span>&nbsp;<span class="op" id="3593868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593873">return</span>&nbsp;<span class="string" id="3593880">&#34;x509:&nbsp;cannot&nbsp;validate&nbsp;certificate&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3593921">+</span>&nbsp;<span class="ident" id="3593923">h</span><span class="op" id="3593924">.</span><span class="ident" id="3593925">Host</span>&nbsp;<span class="op" id="3593930">+</span>&nbsp;<span class="string" id="3593932">&#34;&nbsp;because&nbsp;it&nbsp;doesn&#39;t&nbsp;contain&nbsp;any&nbsp;IP&nbsp;SANs&#34;</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3593976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3593980">for</span>&nbsp;<span class="ident" id="3593984">_</span><span class="op" id="3593985">,</span>&nbsp;<span class="ident" id="3593987">san</span>&nbsp;<span class="op" id="3593991">:=</span>&nbsp;<span class="keyword" id="3593994">range</span>&nbsp;<span class="ident" id="3594000">c</span><span class="op" id="3594001">.</span><span class="ident" id="3594002">IPAddresses</span>&nbsp;<span class="op" id="3594014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594019">if</span>&nbsp;<span class="builtinfunc" id="3594022">len</span><span class="op" id="3594025">(</span><span class="ident" id="3594026">valid</span><span class="op" id="3594031">)</span>&nbsp;<span class="op" id="3594033">&gt;</span>&nbsp;<span class="num" id="3594035">0</span>&nbsp;<span class="op" id="3594037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594043">valid</span>&nbsp;<span class="op" id="3594049">+=</span>&nbsp;<span class="string" id="3594052">&#34;,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594060">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594065">valid</span>&nbsp;<span class="op" id="3594071">+=</span>&nbsp;<span class="ident" id="3594074">san</span><span class="op" id="3594077">.</span><span class="ident" id="3594078">String</span><span class="op" id="3594084">(</span><span class="op" id="3594085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594092">}</span>&nbsp;<span class="keyword" id="3594094">else</span>&nbsp;<span class="op" id="3594099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594103">if</span>&nbsp;<span class="builtinfunc" id="3594106">len</span><span class="op" id="3594109">(</span><span class="ident" id="3594110">c</span><span class="op" id="3594111">.</span><span class="ident" id="3594112">DNSNames</span><span class="op" id="3594120">)</span>&nbsp;<span class="op" id="3594122">&gt;</span>&nbsp;<span class="num" id="3594124">0</span>&nbsp;<span class="op" id="3594126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594131">valid</span>&nbsp;<span class="op" id="3594137">=</span>&nbsp;<span class="ident" id="3594139">strings</span><span class="op" id="3594146">.</span><span class="ident" id="3594147">Join</span><span class="op" id="3594151">(</span><span class="ident" id="3594152">c</span><span class="op" id="3594153">.</span><span class="ident" id="3594154">DNSNames</span><span class="op" id="3594162">,</span>&nbsp;<span class="string" id="3594164">&#34;,&nbsp;&#34;</span><span class="op" id="3594168">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594172">}</span>&nbsp;<span class="keyword" id="3594174">else</span>&nbsp;<span class="op" id="3594179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594184">valid</span>&nbsp;<span class="op" id="3594190">=</span>&nbsp;<span class="ident" id="3594192">c</span><span class="op" id="3594193">.</span><span class="ident" id="3594194">Subject</span><span class="op" id="3594201">.</span><span class="ident" id="3594202">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594221">return</span>&nbsp;<span class="string" id="3594228">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;valid&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3594262">+</span>&nbsp;<span class="ident" id="3594264">valid</span>&nbsp;<span class="op" id="3594270">+</span>&nbsp;<span class="string" id="3594272">&#34;,&nbsp;not&nbsp;&#34;</span>&nbsp;<span class="op" id="3594281">+</span>&nbsp;<span class="ident" id="3594283">h</span><span class="op" id="3594284">.</span><span class="ident" id="3594285">Host</span><br>
<span class="lineno">90</span><span class="op" id="3594290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3594293">//&nbsp;UnknownAuthorityError&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&nbsp;issuer&nbsp;is&nbsp;unknown</span><br>
<span class="lineno"></span><span class="keyword" id="3594365">type</span>&nbsp;<span class="ident" id="3594370">UnknownAuthorityError</span>&nbsp;<span class="keyword" id="3594392">struct</span>&nbsp;<span class="op" id="3594399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594402">cert</span>&nbsp;<span class="op" id="3594407">*</span><span class="ident" id="3594408">Certificate</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3594421">//&nbsp;hintErr&nbsp;contains&nbsp;an&nbsp;error&nbsp;that&nbsp;may&nbsp;be&nbsp;helpful&nbsp;in&nbsp;determining&nbsp;why&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3594493">//&nbsp;authority&nbsp;wasn&#39;t&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594521">hintErr</span>&nbsp;<span class="builtintype" id="3594529">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3594536">//&nbsp;hintCert&nbsp;contains&nbsp;a&nbsp;possible&nbsp;authority&nbsp;certificate&nbsp;that&nbsp;was&nbsp;rejected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3594609">//&nbsp;because&nbsp;of&nbsp;the&nbsp;error&nbsp;in&nbsp;hintErr.</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594646">hintCert</span>&nbsp;<span class="op" id="3594655">*</span><span class="ident" id="3594656">Certificate</span><br>
<span class="lineno"></span><span class="op" id="3594668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3594671">func</span>&nbsp;<span class="op" id="3594676">(</span><span class="ident" id="3594677">e</span>&nbsp;<span class="ident" id="3594679">UnknownAuthorityError</span><span class="op" id="3594700">)</span>&nbsp;<span class="ident" id="3594702">Error</span><span class="op" id="3594707">(</span><span class="op" id="3594708">)</span>&nbsp;<span class="builtintype" id="3594710">string</span>&nbsp;<span class="op" id="3594717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594720">s</span>&nbsp;<span class="op" id="3594722">:=</span>&nbsp;<span class="string" id="3594725">&#34;x509:&nbsp;certificate&nbsp;signed&nbsp;by&nbsp;unknown&nbsp;authority&#34;</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594774">if</span>&nbsp;<span class="ident" id="3594777">e</span><span class="op" id="3594778">.</span><span class="ident" id="3594779">hintErr</span>&nbsp;<span class="op" id="3594787">!=</span>&nbsp;<span class="ident" id="3594790">nil</span>&nbsp;<span class="op" id="3594794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594798">certName</span>&nbsp;<span class="op" id="3594807">:=</span>&nbsp;<span class="ident" id="3594810">e</span><span class="op" id="3594811">.</span><span class="ident" id="3594812">hintCert</span><span class="op" id="3594820">.</span><span class="ident" id="3594821">Subject</span><span class="op" id="3594828">.</span><span class="ident" id="3594829">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594842">if</span>&nbsp;<span class="builtinfunc" id="3594845">len</span><span class="op" id="3594848">(</span><span class="ident" id="3594849">certName</span><span class="op" id="3594857">)</span>&nbsp;<span class="op" id="3594859">==</span>&nbsp;<span class="num" id="3594862">0</span>&nbsp;<span class="op" id="3594864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3594869">if</span>&nbsp;<span class="builtinfunc" id="3594872">len</span><span class="op" id="3594875">(</span><span class="ident" id="3594876">e</span><span class="op" id="3594877">.</span><span class="ident" id="3594878">hintCert</span><span class="op" id="3594886">.</span><span class="ident" id="3594887">Subject</span><span class="op" id="3594894">.</span><span class="ident" id="3594895">Organization</span><span class="op" id="3594907">)</span>&nbsp;<span class="op" id="3594909">&gt;</span>&nbsp;<span class="num" id="3594911">0</span>&nbsp;<span class="op" id="3594913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594919">certName</span>&nbsp;<span class="op" id="3594928">=</span>&nbsp;<span class="ident" id="3594930">e</span><span class="op" id="3594931">.</span><span class="ident" id="3594932">hintCert</span><span class="op" id="3594940">.</span><span class="ident" id="3594941">Subject</span><span class="op" id="3594948">.</span><span class="ident" id="3594949">Organization</span><span class="op" id="3594961">[</span><span class="num" id="3594962">0</span><span class="op" id="3594963">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3594968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3594973">certName</span>&nbsp;<span class="op" id="3594982">=</span>&nbsp;<span class="string" id="3594984">&#34;serial:&#34;</span>&nbsp;<span class="op" id="3594994">+</span>&nbsp;<span class="ident" id="3594996">e</span><span class="op" id="3594997">.</span><span class="ident" id="3594998">hintCert</span><span class="op" id="3595006">.</span><span class="ident" id="3595007">SerialNumber</span><span class="op" id="3595019">.</span><span class="ident" id="3595020">String</span><span class="op" id="3595026">(</span><span class="op" id="3595027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595035">s</span>&nbsp;<span class="op" id="3595037">+=</span>&nbsp;<span class="ident" id="3595040">fmt</span><span class="op" id="3595043">.</span><span class="ident" id="3595044">Sprintf</span><span class="op" id="3595051">(</span><span class="string" id="3595052">&#34;&nbsp;(possibly&nbsp;because&nbsp;of&nbsp;%q&nbsp;while&nbsp;trying&nbsp;to&nbsp;verify&nbsp;candidate&nbsp;authority&nbsp;certificate&nbsp;%q)&#34;</span><span class="op" id="3595137">,</span>&nbsp;<span class="ident" id="3595139">e</span><span class="op" id="3595140">.</span><span class="ident" id="3595141">hintErr</span><span class="op" id="3595148">,</span>&nbsp;<span class="ident" id="3595150">certName</span><span class="op" id="3595158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3595161">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3595164">return</span>&nbsp;<span class="ident" id="3595171">s</span><br>
<span class="lineno"></span><span class="op" id="3595173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3595176">//&nbsp;SystemRootsError&nbsp;results&nbsp;when&nbsp;we&nbsp;fail&nbsp;to&nbsp;load&nbsp;the&nbsp;system&nbsp;root&nbsp;certificates.</span><br>
<span class="lineno"></span><span class="keyword" id="3595255">type</span>&nbsp;<span class="ident" id="3595260">SystemRootsError</span>&nbsp;<span class="keyword" id="3595277">struct</span><span class="op" id="3595283">{</span><span class="op" id="3595284">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="3595287">func</span>&nbsp;<span class="op" id="3595292">(</span><span class="ident" id="3595293">SystemRootsError</span><span class="op" id="3595309">)</span>&nbsp;<span class="ident" id="3595311">Error</span><span class="op" id="3595316">(</span><span class="op" id="3595317">)</span>&nbsp;<span class="builtintype" id="3595319">string</span>&nbsp;<span class="op" id="3595326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3595329">return</span>&nbsp;<span class="string" id="3595336">&#34;x509:&nbsp;failed&nbsp;to&nbsp;load&nbsp;system&nbsp;roots&nbsp;and&nbsp;no&nbsp;roots&nbsp;provided&#34;</span><br>
<span class="lineno"></span><span class="op" id="3595394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="3595397">//&nbsp;VerifyOptions&nbsp;contains&nbsp;parameters&nbsp;for&nbsp;Certificate.Verify.&nbsp;It&#39;s&nbsp;a&nbsp;structure</span><br>
<span class="lineno"></span><span class="comment" id="3595475">//&nbsp;because&nbsp;other&nbsp;PKIX&nbsp;verification&nbsp;APIs&nbsp;have&nbsp;ended&nbsp;up&nbsp;needing&nbsp;many&nbsp;options.</span><br>
<span class="lineno"></span><span class="keyword" id="3595551">type</span>&nbsp;<span class="ident" id="3595556">VerifyOptions</span>&nbsp;<span class="keyword" id="3595570">struct</span>&nbsp;<span class="op" id="3595577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595580">DNSName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3595594">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595602">Intermediates</span>&nbsp;<span class="op" id="3595616">*</span><span class="ident" id="3595617">CertPool</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595627">Roots</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3595641">*</span><span class="ident" id="3595642">CertPool</span>&nbsp;<span class="comment" id="3595651">//&nbsp;if&nbsp;nil,&nbsp;the&nbsp;system&nbsp;roots&nbsp;are&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3595689">CurrentTime</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3595703">time</span><span class="op" id="3595707">.</span><span class="ident" id="3595708">Time</span>&nbsp;<span class="comment" id="3595713">//&nbsp;if&nbsp;zero,&nbsp;the&nbsp;current&nbsp;time&nbsp;is&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3595751">//&nbsp;KeyUsage&nbsp;specifies&nbsp;which&nbsp;Extended&nbsp;Key&nbsp;Usage&nbsp;values&nbsp;are&nbsp;acceptable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3595822">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;means&nbsp;ExtKeyUsageServerAuth.&nbsp;Key&nbsp;usage&nbsp;is&nbsp;considered&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3595895">//&nbsp;constraint&nbsp;down&nbsp;the&nbsp;chain&nbsp;which&nbsp;mirrors&nbsp;Windows&nbsp;CryptoAPI&nbsp;behaviour,</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3595968">//&nbsp;but&nbsp;not&nbsp;the&nbsp;spec.&nbsp;To&nbsp;accept&nbsp;any&nbsp;key&nbsp;usage,&nbsp;include&nbsp;ExtKeyUsageAny.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596039">KeyUsages</span>&nbsp;<span class="op" id="3596049">[</span><span class="op" id="3596050">]</span><span class="ident" id="3596051">ExtKeyUsage</span><br>
<span class="lineno"></span><span class="op" id="3596063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3596066">const</span>&nbsp;<span class="op" id="3596072">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596075">leafCertificate</span>&nbsp;<span class="op" id="3596091">=</span>&nbsp;<span class="ident" id="3596093">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596099">intermediateCertificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596124">rootCertificate</span><br>
<span class="lineno"></span><span class="op" id="3596140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="3596143">//&nbsp;isValid&nbsp;performs&nbsp;validity&nbsp;checks&nbsp;on&nbsp;the&nbsp;c.</span><br>
<span class="lineno"></span><span class="keyword" id="3596189">func</span>&nbsp;<span class="op" id="3596194">(</span><span class="ident" id="3596195">c</span>&nbsp;<span class="op" id="3596197">*</span><span class="ident" id="3596198">Certificate</span><span class="op" id="3596209">)</span>&nbsp;<span class="ident" id="3596211">isValid</span><span class="op" id="3596218">(</span><span class="ident" id="3596219">certType</span>&nbsp;<span class="builtintype" id="3596228">int</span><span class="op" id="3596231">,</span>&nbsp;<span class="ident" id="3596233">currentChain</span>&nbsp;<span class="op" id="3596246">[</span><span class="op" id="3596247">]</span><span class="op" id="3596248">*</span><span class="ident" id="3596249">Certificate</span><span class="op" id="3596260">,</span>&nbsp;<span class="ident" id="3596262">opts</span>&nbsp;<span class="op" id="3596267">*</span><span class="ident" id="3596268">VerifyOptions</span><span class="op" id="3596281">)</span>&nbsp;<span class="builtintype" id="3596283">error</span>&nbsp;<span class="op" id="3596289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596292">now</span>&nbsp;<span class="op" id="3596296">:=</span>&nbsp;<span class="ident" id="3596299">opts</span><span class="op" id="3596303">.</span><span class="ident" id="3596304">CurrentTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3596317">if</span>&nbsp;<span class="ident" id="3596320">now</span><span class="op" id="3596323">.</span><span class="ident" id="3596324">IsZero</span><span class="op" id="3596330">(</span><span class="op" id="3596331">)</span>&nbsp;<span class="op" id="3596333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596337">now</span>&nbsp;<span class="op" id="3596341">=</span>&nbsp;<span class="ident" id="3596343">time</span><span class="op" id="3596347">.</span><span class="ident" id="3596348">Now</span><span class="op" id="3596351">(</span><span class="op" id="3596352">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3596358">if</span>&nbsp;<span class="ident" id="3596361">now</span><span class="op" id="3596364">.</span><span class="ident" id="3596365">Before</span><span class="op" id="3596371">(</span><span class="ident" id="3596372">c</span><span class="op" id="3596373">.</span><span class="ident" id="3596374">NotBefore</span><span class="op" id="3596383">)</span>&nbsp;<span class="op" id="3596385">||</span>&nbsp;<span class="ident" id="3596388">now</span><span class="op" id="3596391">.</span><span class="ident" id="3596392">After</span><span class="op" id="3596397">(</span><span class="ident" id="3596398">c</span><span class="op" id="3596399">.</span><span class="ident" id="3596400">NotAfter</span><span class="op" id="3596408">)</span>&nbsp;<span class="op" id="3596410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3596414">return</span>&nbsp;<span class="ident" id="3596421">CertificateInvalidError</span><span class="op" id="3596444">{</span><span class="ident" id="3596445">c</span><span class="op" id="3596446">,</span>&nbsp;<span class="ident" id="3596448">Expired</span><span class="op" id="3596455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3596462">if</span>&nbsp;<span class="builtinfunc" id="3596465">len</span><span class="op" id="3596468">(</span><span class="ident" id="3596469">c</span><span class="op" id="3596470">.</span><span class="ident" id="3596471">PermittedDNSDomains</span><span class="op" id="3596490">)</span>&nbsp;<span class="op" id="3596492">&gt;</span>&nbsp;<span class="num" id="3596494">0</span>&nbsp;<span class="op" id="3596496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596500">ok</span>&nbsp;<span class="op" id="3596503">:=</span>&nbsp;<span class="builtintype" id="3596506">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3596514">for</span>&nbsp;<span class="ident" id="3596518">_</span><span class="op" id="3596519">,</span>&nbsp;<span class="ident" id="3596521">domain</span>&nbsp;<span class="op" id="3596528">:=</span>&nbsp;<span class="keyword" id="3596531">range</span>&nbsp;<span class="ident" id="3596537">c</span><span class="op" id="3596538">.</span><span class="ident" id="3596539">PermittedDNSDomains</span>&nbsp;<span class="op" id="3596559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3596564">if</span>&nbsp;<span class="ident" id="3596567">opts</span><span class="op" id="3596571">.</span><span class="ident" id="3596572">DNSName</span>&nbsp;<span class="op" id="3596580">==</span>&nbsp;<span class="ident" id="3596583">domain</span>&nbsp;<span class="op" id="3596590">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596597">(</span><span class="ident" id="3596598">strings</span><span class="op" id="3596605">.</span><span class="ident" id="3596606">HasSuffix</span><span class="op" id="3596615">(</span><span class="ident" id="3596616">opts</span><span class="op" id="3596620">.</span><span class="ident" id="3596621">DNSName</span><span class="op" id="3596628">,</span>&nbsp;<span class="ident" id="3596630">domain</span><span class="op" id="3596636">)</span>&nbsp;<span class="op" id="3596638">&amp;&amp;</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3596646">len</span><span class="op" id="3596649">(</span><span class="ident" id="3596650">opts</span><span class="op" id="3596654">.</span><span class="ident" id="3596655">DNSName</span><span class="op" id="3596662">)</span>&nbsp;<span class="op" id="3596664">&gt;=</span>&nbsp;<span class="num" id="3596667">1</span><span class="op" id="3596668">+</span><span class="builtinfunc" id="3596669">len</span><span class="op" id="3596672">(</span><span class="ident" id="3596673">domain</span><span class="op" id="3596679">)</span>&nbsp;<span class="op" id="3596681">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596689">opts</span><span class="op" id="3596693">.</span><span class="ident" id="3596694">DNSName</span><span class="op" id="3596701">[</span><span class="builtinfunc" id="3596702">len</span><span class="op" id="3596705">(</span><span class="ident" id="3596706">opts</span><span class="op" id="3596710">.</span><span class="ident" id="3596711">DNSName</span><span class="op" id="3596718">)</span><span class="op" id="3596719">-</span><span class="builtinfunc" id="3596720">len</span><span class="op" id="3596723">(</span><span class="ident" id="3596724">domain</span><span class="op" id="3596730">)</span><span class="op" id="3596731">-</span><span class="num" id="3596732">1</span><span class="op" id="3596733">]</span>&nbsp;<span class="op" id="3596735">==</span>&nbsp;<span class="string" id="3596738">&#39;.&#39;</span><span class="op" id="3596741">)</span>&nbsp;<span class="op" id="3596743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3596749">ok</span>&nbsp;<span class="op" id="3596752">=</span>&nbsp;<span class="builtintype" id="3596754">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3596763">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596772">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3596781">if</span>&nbsp;<span class="op" id="3596784">!</span><span class="ident" id="3596785">ok</span>&nbsp;<span class="op" id="3596788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3596793">return</span>&nbsp;<span class="ident" id="3596800">CertificateInvalidError</span><span class="op" id="3596823">{</span><span class="ident" id="3596824">c</span><span class="op" id="3596825">,</span>&nbsp;<span class="ident" id="3596827">CANotAuthorizedForThisName</span><span class="op" id="3596853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596857">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3596860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596864">//&nbsp;KeyUsage&nbsp;status&nbsp;flags&nbsp;are&nbsp;ignored.&nbsp;From&nbsp;Engineering&nbsp;Security,&nbsp;Peter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3596936">//&nbsp;Gutmann:&nbsp;A&nbsp;European&nbsp;government&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signing&nbsp;certificates&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597009">//&nbsp;being&nbsp;valid&nbsp;for&nbsp;encryption&nbsp;only,&nbsp;but&nbsp;no-one&nbsp;noticed.&nbsp;Another</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597074">//&nbsp;European&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signature&nbsp;keys&nbsp;as&nbsp;not&nbsp;being&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597139">//&nbsp;signatures.&nbsp;A&nbsp;different&nbsp;CA&nbsp;marked&nbsp;its&nbsp;own&nbsp;trusted&nbsp;root&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597210">//&nbsp;as&nbsp;being&nbsp;invalid&nbsp;for&nbsp;certificate&nbsp;signing.&nbsp;&nbsp;Another&nbsp;national&nbsp;CA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597277">//&nbsp;distributed&nbsp;a&nbsp;certificate&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;data&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597342">//&nbsp;country’s&nbsp;tax&nbsp;authority&nbsp;that&nbsp;was&nbsp;marked&nbsp;as&nbsp;only&nbsp;being&nbsp;usable&nbsp;for</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597413">//&nbsp;digital&nbsp;signatures&nbsp;but&nbsp;not&nbsp;for&nbsp;encryption.&nbsp;Yet&nbsp;another&nbsp;CA&nbsp;reversed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597484">//&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bit&nbsp;flags&nbsp;in&nbsp;the&nbsp;keyUsage&nbsp;due&nbsp;to&nbsp;confusion&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597553">//&nbsp;encoding&nbsp;endianness,&nbsp;essentially&nbsp;setting&nbsp;a&nbsp;random&nbsp;keyUsage&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597619">//&nbsp;certificates&nbsp;that&nbsp;it&nbsp;issued.&nbsp;Another&nbsp;CA&nbsp;created&nbsp;a&nbsp;self-invalidating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597691">//&nbsp;certificate&nbsp;by&nbsp;adding&nbsp;a&nbsp;certificate&nbsp;policy&nbsp;statement&nbsp;stipulating</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597760">//&nbsp;that&nbsp;the&nbsp;certificate&nbsp;had&nbsp;to&nbsp;be&nbsp;used&nbsp;strictly&nbsp;as&nbsp;specified&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597829">//&nbsp;keyUsage,&nbsp;and&nbsp;a&nbsp;keyUsage&nbsp;containing&nbsp;a&nbsp;flag&nbsp;indicating&nbsp;that&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3597900">//&nbsp;encryption&nbsp;key&nbsp;could&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;Diffie-Hellman&nbsp;key&nbsp;agreement.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3597973">if</span>&nbsp;<span class="ident" id="3597976">certType</span>&nbsp;<span class="op" id="3597985">==</span>&nbsp;<span class="ident" id="3597988">intermediateCertificate</span>&nbsp;<span class="op" id="3598012">&amp;&amp;</span>&nbsp;<span class="op" id="3598015">(</span><span class="op" id="3598016">!</span><span class="ident" id="3598017">c</span><span class="op" id="3598018">.</span><span class="ident" id="3598019">BasicConstraintsValid</span>&nbsp;<span class="op" id="3598041">||</span>&nbsp;<span class="op" id="3598044">!</span><span class="ident" id="3598045">c</span><span class="op" id="3598046">.</span><span class="ident" id="3598047">IsCA</span><span class="op" id="3598051">)</span>&nbsp;<span class="op" id="3598053">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598057">return</span>&nbsp;<span class="ident" id="3598064">CertificateInvalidError</span><span class="op" id="3598087">{</span><span class="ident" id="3598088">c</span><span class="op" id="3598089">,</span>&nbsp;<span class="ident" id="3598091">NotAuthorizedToSign</span><span class="op" id="3598110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3598113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598117">if</span>&nbsp;<span class="ident" id="3598120">c</span><span class="op" id="3598121">.</span><span class="ident" id="3598122">BasicConstraintsValid</span>&nbsp;<span class="op" id="3598144">&amp;&amp;</span>&nbsp;<span class="ident" id="3598147">c</span><span class="op" id="3598148">.</span><span class="ident" id="3598149">MaxPathLen</span>&nbsp;<span class="op" id="3598160">&gt;=</span>&nbsp;<span class="num" id="3598163">0</span>&nbsp;<span class="op" id="3598165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3598169">numIntermediates</span>&nbsp;<span class="op" id="3598186">:=</span>&nbsp;<span class="builtinfunc" id="3598189">len</span><span class="op" id="3598192">(</span><span class="ident" id="3598193">currentChain</span><span class="op" id="3598205">)</span>&nbsp;<span class="op" id="3598207">-</span>&nbsp;<span class="num" id="3598209">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598213">if</span>&nbsp;<span class="ident" id="3598216">numIntermediates</span>&nbsp;<span class="op" id="3598233">&gt;</span>&nbsp;<span class="ident" id="3598235">c</span><span class="op" id="3598236">.</span><span class="ident" id="3598237">MaxPathLen</span>&nbsp;<span class="op" id="3598248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598253">return</span>&nbsp;<span class="ident" id="3598260">CertificateInvalidError</span><span class="op" id="3598283">{</span><span class="ident" id="3598284">c</span><span class="op" id="3598285">,</span>&nbsp;<span class="ident" id="3598287">TooManyIntermediates</span><span class="op" id="3598307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3598311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3598314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598318">return</span>&nbsp;<span class="ident" id="3598325">nil</span><br>
<span class="lineno"></span><span class="op" id="3598329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3598332">//&nbsp;Verify&nbsp;attempts&nbsp;to&nbsp;verify&nbsp;c&nbsp;by&nbsp;building&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;from&nbsp;c&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3598406">//&nbsp;certificate&nbsp;in&nbsp;opts.Roots,&nbsp;using&nbsp;certificates&nbsp;in&nbsp;opts.Intermediates&nbsp;if</span><br>
<span class="lineno">205</span><span class="comment" id="3598480">//&nbsp;needed.&nbsp;If&nbsp;successful,&nbsp;it&nbsp;returns&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;where&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="3598552">//&nbsp;element&nbsp;of&nbsp;the&nbsp;chain&nbsp;is&nbsp;c&nbsp;and&nbsp;the&nbsp;last&nbsp;element&nbsp;is&nbsp;from&nbsp;opts.Roots.</span><br>
<span class="lineno"></span><span class="comment" id="3598622">//</span><br>
<span class="lineno"></span><span class="comment" id="3598625">//&nbsp;If&nbsp;opts.Roots&nbsp;is&nbsp;nil&nbsp;and&nbsp;system&nbsp;roots&nbsp;are&nbsp;unavailable&nbsp;the&nbsp;returned&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3598701">//&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;SystemRootsError.</span><br>
<span class="lineno">210</span><span class="comment" id="3598738">//</span><br>
<span class="lineno"></span><span class="comment" id="3598741">//&nbsp;WARNING:&nbsp;this&nbsp;doesn&#39;t&nbsp;do&nbsp;any&nbsp;revocation&nbsp;checking.</span><br>
<span class="lineno"></span><span class="keyword" id="3598794">func</span>&nbsp;<span class="op" id="3598799">(</span><span class="ident" id="3598800">c</span>&nbsp;<span class="op" id="3598802">*</span><span class="ident" id="3598803">Certificate</span><span class="op" id="3598814">)</span>&nbsp;<span class="ident" id="3598816">Verify</span><span class="op" id="3598822">(</span><span class="ident" id="3598823">opts</span>&nbsp;<span class="ident" id="3598828">VerifyOptions</span><span class="op" id="3598841">)</span>&nbsp;<span class="op" id="3598843">(</span><span class="ident" id="3598844">chains</span>&nbsp;<span class="op" id="3598851">[</span><span class="op" id="3598852">]</span><span class="op" id="3598853">[</span><span class="op" id="3598854">]</span><span class="op" id="3598855">*</span><span class="ident" id="3598856">Certificate</span><span class="op" id="3598867">,</span>&nbsp;<span class="ident" id="3598869">err</span>&nbsp;<span class="builtintype" id="3598873">error</span><span class="op" id="3598878">)</span>&nbsp;<span class="op" id="3598880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3598883">//&nbsp;Use&nbsp;Windows&#39;s&nbsp;own&nbsp;verification&nbsp;and&nbsp;chain&nbsp;building.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598938">if</span>&nbsp;<span class="ident" id="3598941">opts</span><span class="op" id="3598945">.</span><span class="ident" id="3598946">Roots</span>&nbsp;<span class="op" id="3598952">==</span>&nbsp;<span class="ident" id="3598955">nil</span>&nbsp;<span class="op" id="3598959">&amp;&amp;</span>&nbsp;<span class="ident" id="3598962">runtime</span><span class="op" id="3598969">.</span><span class="ident" id="3598970">GOOS</span>&nbsp;<span class="op" id="3598975">==</span>&nbsp;<span class="string" id="3598978">&#34;windows&#34;</span>&nbsp;<span class="op" id="3598988">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3598992">return</span>&nbsp;<span class="ident" id="3598999">c</span><span class="op" id="3599000">.</span><span class="ident" id="3599001">systemVerify</span><span class="op" id="3599013">(</span><span class="op" id="3599014">&amp;</span><span class="ident" id="3599015">opts</span><span class="op" id="3599019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599026">if</span>&nbsp;<span class="ident" id="3599029">opts</span><span class="op" id="3599033">.</span><span class="ident" id="3599034">Roots</span>&nbsp;<span class="op" id="3599040">==</span>&nbsp;<span class="ident" id="3599043">nil</span>&nbsp;<span class="op" id="3599047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3599051">opts</span><span class="op" id="3599055">.</span><span class="ident" id="3599056">Roots</span>&nbsp;<span class="op" id="3599062">=</span>&nbsp;<span class="ident" id="3599064">systemRootsPool</span><span class="op" id="3599079">(</span><span class="op" id="3599080">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599084">if</span>&nbsp;<span class="ident" id="3599087">opts</span><span class="op" id="3599091">.</span><span class="ident" id="3599092">Roots</span>&nbsp;<span class="op" id="3599098">==</span>&nbsp;<span class="ident" id="3599101">nil</span>&nbsp;<span class="op" id="3599105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599110">return</span>&nbsp;<span class="ident" id="3599117">nil</span><span class="op" id="3599120">,</span>&nbsp;<span class="ident" id="3599122">SystemRootsError</span><span class="op" id="3599138">{</span><span class="op" id="3599139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3599150">err</span>&nbsp;<span class="op" id="3599154">=</span>&nbsp;<span class="ident" id="3599156">c</span><span class="op" id="3599157">.</span><span class="ident" id="3599158">isValid</span><span class="op" id="3599165">(</span><span class="ident" id="3599166">leafCertificate</span><span class="op" id="3599181">,</span>&nbsp;<span class="ident" id="3599183">nil</span><span class="op" id="3599186">,</span>&nbsp;<span class="op" id="3599188">&amp;</span><span class="ident" id="3599189">opts</span><span class="op" id="3599193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599196">if</span>&nbsp;<span class="ident" id="3599199">err</span>&nbsp;<span class="op" id="3599203">!=</span>&nbsp;<span class="ident" id="3599206">nil</span>&nbsp;<span class="op" id="3599210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599214">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599226">if</span>&nbsp;<span class="builtinfunc" id="3599229">len</span><span class="op" id="3599232">(</span><span class="ident" id="3599233">opts</span><span class="op" id="3599237">.</span><span class="ident" id="3599238">DNSName</span><span class="op" id="3599245">)</span>&nbsp;<span class="op" id="3599247">&gt;</span>&nbsp;<span class="num" id="3599249">0</span>&nbsp;<span class="op" id="3599251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3599255">err</span>&nbsp;<span class="op" id="3599259">=</span>&nbsp;<span class="ident" id="3599261">c</span><span class="op" id="3599262">.</span><span class="ident" id="3599263">VerifyHostname</span><span class="op" id="3599277">(</span><span class="ident" id="3599278">opts</span><span class="op" id="3599282">.</span><span class="ident" id="3599283">DNSName</span><span class="op" id="3599290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599294">if</span>&nbsp;<span class="ident" id="3599297">err</span>&nbsp;<span class="op" id="3599301">!=</span>&nbsp;<span class="ident" id="3599304">nil</span>&nbsp;<span class="op" id="3599308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599313">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599322">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3599329">candidateChains</span><span class="op" id="3599344">,</span>&nbsp;<span class="ident" id="3599346">err</span>&nbsp;<span class="op" id="3599350">:=</span>&nbsp;<span class="ident" id="3599353">c</span><span class="op" id="3599354">.</span><span class="ident" id="3599355">buildChains</span><span class="op" id="3599366">(</span><span class="builtinfunc" id="3599367">make</span><span class="op" id="3599371">(</span><span class="keyword" id="3599372">map</span><span class="op" id="3599375">[</span><span class="builtintype" id="3599376">int</span><span class="op" id="3599379">]</span><span class="op" id="3599380">[</span><span class="op" id="3599381">]</span><span class="op" id="3599382">[</span><span class="op" id="3599383">]</span><span class="op" id="3599384">*</span><span class="ident" id="3599385">Certificate</span><span class="op" id="3599396">)</span><span class="op" id="3599397">,</span>&nbsp;<span class="op" id="3599399">[</span><span class="op" id="3599400">]</span><span class="op" id="3599401">*</span><span class="ident" id="3599402">Certificate</span><span class="op" id="3599413">{</span><span class="ident" id="3599414">c</span><span class="op" id="3599415">}</span><span class="op" id="3599416">,</span>&nbsp;<span class="op" id="3599418">&amp;</span><span class="ident" id="3599419">opts</span><span class="op" id="3599423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599426">if</span>&nbsp;<span class="ident" id="3599429">err</span>&nbsp;<span class="op" id="3599433">!=</span>&nbsp;<span class="ident" id="3599436">nil</span>&nbsp;<span class="op" id="3599440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599444">return</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3599456">keyUsages</span>&nbsp;<span class="op" id="3599466">:=</span>&nbsp;<span class="ident" id="3599469">opts</span><span class="op" id="3599473">.</span><span class="ident" id="3599474">KeyUsages</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599485">if</span>&nbsp;<span class="builtinfunc" id="3599488">len</span><span class="op" id="3599491">(</span><span class="ident" id="3599492">keyUsages</span><span class="op" id="3599501">)</span>&nbsp;<span class="op" id="3599503">==</span>&nbsp;<span class="num" id="3599506">0</span>&nbsp;<span class="op" id="3599508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3599512">keyUsages</span>&nbsp;<span class="op" id="3599522">=</span>&nbsp;<span class="op" id="3599524">[</span><span class="op" id="3599525">]</span><span class="ident" id="3599526">ExtKeyUsage</span><span class="op" id="3599537">{</span><span class="ident" id="3599538">ExtKeyUsageServerAuth</span><span class="op" id="3599559">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3599566">//&nbsp;If&nbsp;any&nbsp;key&nbsp;usage&nbsp;is&nbsp;acceptable&nbsp;then&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599618">for</span>&nbsp;<span class="ident" id="3599622">_</span><span class="op" id="3599623">,</span>&nbsp;<span class="ident" id="3599625">usage</span>&nbsp;<span class="op" id="3599631">:=</span>&nbsp;<span class="keyword" id="3599634">range</span>&nbsp;<span class="ident" id="3599640">keyUsages</span>&nbsp;<span class="op" id="3599650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599654">if</span>&nbsp;<span class="ident" id="3599657">usage</span>&nbsp;<span class="op" id="3599663">==</span>&nbsp;<span class="ident" id="3599666">ExtKeyUsageAny</span>&nbsp;<span class="op" id="3599681">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3599686">chains</span>&nbsp;<span class="op" id="3599693">=</span>&nbsp;<span class="ident" id="3599695">candidateChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599714">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599730">for</span>&nbsp;<span class="ident" id="3599734">_</span><span class="op" id="3599735">,</span>&nbsp;<span class="ident" id="3599737">candidate</span>&nbsp;<span class="op" id="3599747">:=</span>&nbsp;<span class="keyword" id="3599750">range</span>&nbsp;<span class="ident" id="3599756">candidateChains</span>&nbsp;<span class="op" id="3599772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599776">if</span>&nbsp;<span class="ident" id="3599779">checkChainForKeyUsage</span><span class="op" id="3599800">(</span><span class="ident" id="3599801">candidate</span><span class="op" id="3599810">,</span>&nbsp;<span class="ident" id="3599812">keyUsages</span><span class="op" id="3599821">)</span>&nbsp;<span class="op" id="3599823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3599828">chains</span>&nbsp;<span class="op" id="3599835">=</span>&nbsp;<span class="builtinfunc" id="3599837">append</span><span class="op" id="3599843">(</span><span class="ident" id="3599844">chains</span><span class="op" id="3599850">,</span>&nbsp;<span class="ident" id="3599852">candidate</span><span class="op" id="3599861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599868">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599872">if</span>&nbsp;<span class="builtinfunc" id="3599875">len</span><span class="op" id="3599878">(</span><span class="ident" id="3599879">chains</span><span class="op" id="3599885">)</span>&nbsp;<span class="op" id="3599887">==</span>&nbsp;<span class="num" id="3599890">0</span>&nbsp;<span class="op" id="3599892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3599896">err</span>&nbsp;<span class="op" id="3599900">=</span>&nbsp;<span class="ident" id="3599902">CertificateInvalidError</span><span class="op" id="3599925">{</span><span class="ident" id="3599926">c</span><span class="op" id="3599927">,</span>&nbsp;<span class="ident" id="3599929">IncompatibleUsage</span><span class="op" id="3599946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3599949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3599953">return</span><br>
<span class="lineno"></span><span class="op" id="3599960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3599963">func</span>&nbsp;<span class="ident" id="3599968">appendToFreshChain</span><span class="op" id="3599986">(</span><span class="ident" id="3599987">chain</span>&nbsp;<span class="op" id="3599993">[</span><span class="op" id="3599994">]</span><span class="op" id="3599995">*</span><span class="ident" id="3599996">Certificate</span><span class="op" id="3600007">,</span>&nbsp;<span class="ident" id="3600009">cert</span>&nbsp;<span class="op" id="3600014">*</span><span class="ident" id="3600015">Certificate</span><span class="op" id="3600026">)</span>&nbsp;<span class="op" id="3600028">[</span><span class="op" id="3600029">]</span><span class="op" id="3600030">*</span><span class="ident" id="3600031">Certificate</span>&nbsp;<span class="op" id="3600043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3600046">n</span>&nbsp;<span class="op" id="3600048">:=</span>&nbsp;<span class="builtinfunc" id="3600051">make</span><span class="op" id="3600055">(</span><span class="op" id="3600056">[</span><span class="op" id="3600057">]</span><span class="op" id="3600058">*</span><span class="ident" id="3600059">Certificate</span><span class="op" id="3600070">,</span>&nbsp;<span class="builtinfunc" id="3600072">len</span><span class="op" id="3600075">(</span><span class="ident" id="3600076">chain</span><span class="op" id="3600081">)</span><span class="op" id="3600082">+</span><span class="num" id="3600083">1</span><span class="op" id="3600084">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3600087">copy</span><span class="op" id="3600091">(</span><span class="ident" id="3600092">n</span><span class="op" id="3600093">,</span>&nbsp;<span class="ident" id="3600095">chain</span><span class="op" id="3600100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3600103">n</span><span class="op" id="3600104">[</span><span class="builtinfunc" id="3600105">len</span><span class="op" id="3600108">(</span><span class="ident" id="3600109">chain</span><span class="op" id="3600114">)</span><span class="op" id="3600115">]</span>&nbsp;<span class="op" id="3600117">=</span>&nbsp;<span class="ident" id="3600119">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600125">return</span>&nbsp;<span class="ident" id="3600132">n</span><br>
<span class="lineno"></span><span class="op" id="3600134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="3600137">func</span>&nbsp;<span class="op" id="3600142">(</span><span class="ident" id="3600143">c</span>&nbsp;<span class="op" id="3600145">*</span><span class="ident" id="3600146">Certificate</span><span class="op" id="3600157">)</span>&nbsp;<span class="ident" id="3600159">buildChains</span><span class="op" id="3600170">(</span><span class="ident" id="3600171">cache</span>&nbsp;<span class="keyword" id="3600177">map</span><span class="op" id="3600180">[</span><span class="builtintype" id="3600181">int</span><span class="op" id="3600184">]</span><span class="op" id="3600185">[</span><span class="op" id="3600186">]</span><span class="op" id="3600187">[</span><span class="op" id="3600188">]</span><span class="op" id="3600189">*</span><span class="ident" id="3600190">Certificate</span><span class="op" id="3600201">,</span>&nbsp;<span class="ident" id="3600203">currentChain</span>&nbsp;<span class="op" id="3600216">[</span><span class="op" id="3600217">]</span><span class="op" id="3600218">*</span><span class="ident" id="3600219">Certificate</span><span class="op" id="3600230">,</span>&nbsp;<span class="ident" id="3600232">opts</span>&nbsp;<span class="op" id="3600237">*</span><span class="ident" id="3600238">VerifyOptions</span><span class="op" id="3600251">)</span>&nbsp;<span class="op" id="3600253">(</span><span class="ident" id="3600254">chains</span>&nbsp;<span class="op" id="3600261">[</span><span class="op" id="3600262">]</span><span class="op" id="3600263">[</span><span class="op" id="3600264">]</span><span class="op" id="3600265">*</span><span class="ident" id="3600266">Certificate</span><span class="op" id="3600277">,</span>&nbsp;<span class="ident" id="3600279">err</span>&nbsp;<span class="builtintype" id="3600283">error</span><span class="op" id="3600288">)</span>&nbsp;<span class="op" id="3600290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3600293">possibleRoots</span><span class="op" id="3600306">,</span>&nbsp;<span class="ident" id="3600308">failedRoot</span><span class="op" id="3600318">,</span>&nbsp;<span class="ident" id="3600320">rootErr</span>&nbsp;<span class="op" id="3600328">:=</span>&nbsp;<span class="ident" id="3600331">opts</span><span class="op" id="3600335">.</span><span class="ident" id="3600336">Roots</span><span class="op" id="3600341">.</span><span class="ident" id="3600342">findVerifiedParents</span><span class="op" id="3600361">(</span><span class="ident" id="3600362">c</span><span class="op" id="3600363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600366">for</span>&nbsp;<span class="ident" id="3600370">_</span><span class="op" id="3600371">,</span>&nbsp;<span class="ident" id="3600373">rootNum</span>&nbsp;<span class="op" id="3600381">:=</span>&nbsp;<span class="keyword" id="3600384">range</span>&nbsp;<span class="ident" id="3600390">possibleRoots</span>&nbsp;<span class="op" id="3600404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3600408">root</span>&nbsp;<span class="op" id="3600413">:=</span>&nbsp;<span class="ident" id="3600416">opts</span><span class="op" id="3600420">.</span><span class="ident" id="3600421">Roots</span><span class="op" id="3600426">.</span><span class="ident" id="3600427">certs</span><span class="op" id="3600432">[</span><span class="ident" id="3600433">rootNum</span><span class="op" id="3600440">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3600444">err</span>&nbsp;<span class="op" id="3600448">=</span>&nbsp;<span class="ident" id="3600450">root</span><span class="op" id="3600454">.</span><span class="ident" id="3600455">isValid</span><span class="op" id="3600462">(</span><span class="ident" id="3600463">rootCertificate</span><span class="op" id="3600478">,</span>&nbsp;<span class="ident" id="3600480">currentChain</span><span class="op" id="3600492">,</span>&nbsp;<span class="ident" id="3600494">opts</span><span class="op" id="3600498">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600502">if</span>&nbsp;<span class="ident" id="3600505">err</span>&nbsp;<span class="op" id="3600509">!=</span>&nbsp;<span class="ident" id="3600512">nil</span>&nbsp;<span class="op" id="3600516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600521">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3600532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3600536">chains</span>&nbsp;<span class="op" id="3600543">=</span>&nbsp;<span class="builtinfunc" id="3600545">append</span><span class="op" id="3600551">(</span><span class="ident" id="3600552">chains</span><span class="op" id="3600558">,</span>&nbsp;<span class="ident" id="3600560">appendToFreshChain</span><span class="op" id="3600578">(</span><span class="ident" id="3600579">currentChain</span><span class="op" id="3600591">,</span>&nbsp;<span class="ident" id="3600593">root</span><span class="op" id="3600597">)</span><span class="op" id="3600598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3600601">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3600605">possibleIntermediates</span><span class="op" id="3600626">,</span>&nbsp;<span class="ident" id="3600628">failedIntermediate</span><span class="op" id="3600646">,</span>&nbsp;<span class="ident" id="3600648">intermediateErr</span>&nbsp;<span class="op" id="3600664">:=</span>&nbsp;<span class="ident" id="3600667">opts</span><span class="op" id="3600671">.</span><span class="ident" id="3600672">Intermediates</span><span class="op" id="3600685">.</span><span class="ident" id="3600686">findVerifiedParents</span><span class="op" id="3600705">(</span><span class="ident" id="3600706">c</span><span class="op" id="3600707">)</span><br>
<span class="lineno"></span><span class="ident" id="3600709">nextIntermediate</span><span class="op" id="3600725">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600728">for</span>&nbsp;<span class="ident" id="3600732">_</span><span class="op" id="3600733">,</span>&nbsp;<span class="ident" id="3600735">intermediateNum</span>&nbsp;<span class="op" id="3600751">:=</span>&nbsp;<span class="keyword" id="3600754">range</span>&nbsp;<span class="ident" id="3600760">possibleIntermediates</span>&nbsp;<span class="op" id="3600782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3600786">intermediate</span>&nbsp;<span class="op" id="3600799">:=</span>&nbsp;<span class="ident" id="3600802">opts</span><span class="op" id="3600806">.</span><span class="ident" id="3600807">Intermediates</span><span class="op" id="3600820">.</span><span class="ident" id="3600821">certs</span><span class="op" id="3600826">[</span><span class="ident" id="3600827">intermediateNum</span><span class="op" id="3600842">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600846">for</span>&nbsp;<span class="ident" id="3600850">_</span><span class="op" id="3600851">,</span>&nbsp;<span class="ident" id="3600853">cert</span>&nbsp;<span class="op" id="3600858">:=</span>&nbsp;<span class="keyword" id="3600861">range</span>&nbsp;<span class="ident" id="3600867">currentChain</span>&nbsp;<span class="op" id="3600880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600885">if</span>&nbsp;<span class="ident" id="3600888">cert</span>&nbsp;<span class="op" id="3600893">==</span>&nbsp;<span class="ident" id="3600896">intermediate</span>&nbsp;<span class="op" id="3600909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3600915">continue</span>&nbsp;<span class="ident" id="3600924">nextIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3600944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3600948">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3600952">err</span>&nbsp;<span class="op" id="3600956">=</span>&nbsp;<span class="ident" id="3600958">intermediate</span><span class="op" id="3600970">.</span><span class="ident" id="3600971">isValid</span><span class="op" id="3600978">(</span><span class="ident" id="3600979">intermediateCertificate</span><span class="op" id="3601002">,</span>&nbsp;<span class="ident" id="3601004">currentChain</span><span class="op" id="3601016">,</span>&nbsp;<span class="ident" id="3601018">opts</span><span class="op" id="3601022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601026">if</span>&nbsp;<span class="ident" id="3601029">err</span>&nbsp;<span class="op" id="3601033">!=</span>&nbsp;<span class="ident" id="3601036">nil</span>&nbsp;<span class="op" id="3601040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601045">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601060">var</span>&nbsp;<span class="ident" id="3601064">childChains</span>&nbsp;<span class="op" id="3601076">[</span><span class="op" id="3601077">]</span><span class="op" id="3601078">[</span><span class="op" id="3601079">]</span><span class="op" id="3601080">*</span><span class="ident" id="3601081">Certificate</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601095">childChains</span><span class="op" id="3601106">,</span>&nbsp;<span class="ident" id="3601108">ok</span>&nbsp;<span class="op" id="3601111">:=</span>&nbsp;<span class="ident" id="3601114">cache</span><span class="op" id="3601119">[</span><span class="ident" id="3601120">intermediateNum</span><span class="op" id="3601135">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601139">if</span>&nbsp;<span class="op" id="3601142">!</span><span class="ident" id="3601143">ok</span>&nbsp;<span class="op" id="3601146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601151">childChains</span><span class="op" id="3601162">,</span>&nbsp;<span class="ident" id="3601164">err</span>&nbsp;<span class="op" id="3601168">=</span>&nbsp;<span class="ident" id="3601170">intermediate</span><span class="op" id="3601182">.</span><span class="ident" id="3601183">buildChains</span><span class="op" id="3601194">(</span><span class="ident" id="3601195">cache</span><span class="op" id="3601200">,</span>&nbsp;<span class="ident" id="3601202">appendToFreshChain</span><span class="op" id="3601220">(</span><span class="ident" id="3601221">currentChain</span><span class="op" id="3601233">,</span>&nbsp;<span class="ident" id="3601235">intermediate</span><span class="op" id="3601247">)</span><span class="op" id="3601248">,</span>&nbsp;<span class="ident" id="3601250">opts</span><span class="op" id="3601254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601259">cache</span><span class="op" id="3601264">[</span><span class="ident" id="3601265">intermediateNum</span><span class="op" id="3601280">]</span>&nbsp;<span class="op" id="3601282">=</span>&nbsp;<span class="ident" id="3601284">childChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601298">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601302">chains</span>&nbsp;<span class="op" id="3601309">=</span>&nbsp;<span class="builtinfunc" id="3601311">append</span><span class="op" id="3601317">(</span><span class="ident" id="3601318">chains</span><span class="op" id="3601324">,</span>&nbsp;<span class="ident" id="3601326">childChains</span><span class="op" id="3601337">...</span><span class="op" id="3601340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601347">if</span>&nbsp;<span class="builtinfunc" id="3601350">len</span><span class="op" id="3601353">(</span><span class="ident" id="3601354">chains</span><span class="op" id="3601360">)</span>&nbsp;<span class="op" id="3601362">&gt;</span>&nbsp;<span class="num" id="3601364">0</span>&nbsp;<span class="op" id="3601366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601370">err</span>&nbsp;<span class="op" id="3601374">=</span>&nbsp;<span class="ident" id="3601376">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601385">if</span>&nbsp;<span class="builtinfunc" id="3601388">len</span><span class="op" id="3601391">(</span><span class="ident" id="3601392">chains</span><span class="op" id="3601398">)</span>&nbsp;<span class="op" id="3601400">==</span>&nbsp;<span class="num" id="3601403">0</span>&nbsp;<span class="op" id="3601405">&amp;&amp;</span>&nbsp;<span class="ident" id="3601408">err</span>&nbsp;<span class="op" id="3601412">==</span>&nbsp;<span class="ident" id="3601415">nil</span>&nbsp;<span class="op" id="3601419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601423">hintErr</span>&nbsp;<span class="op" id="3601431">:=</span>&nbsp;<span class="ident" id="3601434">rootErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601444">hintCert</span>&nbsp;<span class="op" id="3601453">:=</span>&nbsp;<span class="ident" id="3601456">failedRoot</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601469">if</span>&nbsp;<span class="ident" id="3601472">hintErr</span>&nbsp;<span class="op" id="3601480">==</span>&nbsp;<span class="ident" id="3601483">nil</span>&nbsp;<span class="op" id="3601487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601492">hintErr</span>&nbsp;<span class="op" id="3601500">=</span>&nbsp;<span class="ident" id="3601502">intermediateErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601521">hintCert</span>&nbsp;<span class="op" id="3601530">=</span>&nbsp;<span class="ident" id="3601532">failedIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601557">err</span>&nbsp;<span class="op" id="3601561">=</span>&nbsp;<span class="ident" id="3601563">UnknownAuthorityError</span><span class="op" id="3601584">{</span><span class="ident" id="3601585">c</span><span class="op" id="3601586">,</span>&nbsp;<span class="ident" id="3601588">hintErr</span><span class="op" id="3601595">,</span>&nbsp;<span class="ident" id="3601597">hintCert</span><span class="op" id="3601605">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601612">return</span><br>
<span class="lineno"></span><span class="op" id="3601619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="keyword" id="3601622">func</span>&nbsp;<span class="ident" id="3601627">matchHostnames</span><span class="op" id="3601641">(</span><span class="ident" id="3601642">pattern</span><span class="op" id="3601649">,</span>&nbsp;<span class="ident" id="3601651">host</span>&nbsp;<span class="builtintype" id="3601656">string</span><span class="op" id="3601662">)</span>&nbsp;<span class="builtintype" id="3601664">bool</span>&nbsp;<span class="op" id="3601669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601672">if</span>&nbsp;<span class="builtinfunc" id="3601675">len</span><span class="op" id="3601678">(</span><span class="ident" id="3601679">pattern</span><span class="op" id="3601686">)</span>&nbsp;<span class="op" id="3601688">==</span>&nbsp;<span class="num" id="3601691">0</span>&nbsp;<span class="op" id="3601693">||</span>&nbsp;<span class="builtinfunc" id="3601696">len</span><span class="op" id="3601699">(</span><span class="ident" id="3601700">host</span><span class="op" id="3601704">)</span>&nbsp;<span class="op" id="3601706">==</span>&nbsp;<span class="num" id="3601709">0</span>&nbsp;<span class="op" id="3601711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601715">return</span>&nbsp;<span class="builtintype" id="3601722">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601733">patternParts</span>&nbsp;<span class="op" id="3601746">:=</span>&nbsp;<span class="ident" id="3601749">strings</span><span class="op" id="3601756">.</span><span class="ident" id="3601757">Split</span><span class="op" id="3601762">(</span><span class="ident" id="3601763">pattern</span><span class="op" id="3601770">,</span>&nbsp;<span class="string" id="3601772">&#34;.&#34;</span><span class="op" id="3601775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3601778">hostParts</span>&nbsp;<span class="op" id="3601788">:=</span>&nbsp;<span class="ident" id="3601791">strings</span><span class="op" id="3601798">.</span><span class="ident" id="3601799">Split</span><span class="op" id="3601804">(</span><span class="ident" id="3601805">host</span><span class="op" id="3601809">,</span>&nbsp;<span class="string" id="3601811">&#34;.&#34;</span><span class="op" id="3601814">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601818">if</span>&nbsp;<span class="builtinfunc" id="3601821">len</span><span class="op" id="3601824">(</span><span class="ident" id="3601825">patternParts</span><span class="op" id="3601837">)</span>&nbsp;<span class="op" id="3601839">!=</span>&nbsp;<span class="builtinfunc" id="3601842">len</span><span class="op" id="3601845">(</span><span class="ident" id="3601846">hostParts</span><span class="op" id="3601855">)</span>&nbsp;<span class="op" id="3601857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601861">return</span>&nbsp;<span class="builtintype" id="3601868">false</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601879">for</span>&nbsp;<span class="ident" id="3601883">i</span><span class="op" id="3601884">,</span>&nbsp;<span class="ident" id="3601886">patternPart</span>&nbsp;<span class="op" id="3601898">:=</span>&nbsp;<span class="keyword" id="3601901">range</span>&nbsp;<span class="ident" id="3601907">patternParts</span>&nbsp;<span class="op" id="3601920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601924">if</span>&nbsp;<span class="ident" id="3601927">patternPart</span>&nbsp;<span class="op" id="3601939">==</span>&nbsp;<span class="string" id="3601942">&#34;*&#34;</span>&nbsp;<span class="op" id="3601946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601951">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3601962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3601966">if</span>&nbsp;<span class="ident" id="3601969">patternPart</span>&nbsp;<span class="op" id="3601981">!=</span>&nbsp;<span class="ident" id="3601984">hostParts</span><span class="op" id="3601993">[</span><span class="ident" id="3601994">i</span><span class="op" id="3601995">]</span>&nbsp;<span class="op" id="3601997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602002">return</span>&nbsp;<span class="builtintype" id="3602009">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602020">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602024">return</span>&nbsp;<span class="builtintype" id="3602031">true</span><br>
<span class="lineno"></span><span class="op" id="3602036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3602039">//&nbsp;toLowerCaseASCII&nbsp;returns&nbsp;a&nbsp;lower-case&nbsp;version&nbsp;of&nbsp;in.&nbsp;See&nbsp;RFC&nbsp;6125&nbsp;6.4.1.&nbsp;We&nbsp;use</span><br>
<span class="lineno">350</span><span class="comment" id="3602122">//&nbsp;an&nbsp;explicitly&nbsp;ASCII&nbsp;function&nbsp;to&nbsp;avoid&nbsp;any&nbsp;sharp&nbsp;corners&nbsp;resulting&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3602196">//&nbsp;performing&nbsp;Unicode&nbsp;operations&nbsp;on&nbsp;DNS&nbsp;labels.</span><br>
<span class="lineno"></span><span class="keyword" id="3602244">func</span>&nbsp;<span class="ident" id="3602249">toLowerCaseASCII</span><span class="op" id="3602265">(</span><span class="ident" id="3602266">in</span>&nbsp;<span class="builtintype" id="3602269">string</span><span class="op" id="3602275">)</span>&nbsp;<span class="builtintype" id="3602277">string</span>&nbsp;<span class="op" id="3602284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3602287">//&nbsp;If&nbsp;the&nbsp;string&nbsp;is&nbsp;already&nbsp;lower-case&nbsp;then&nbsp;there&#39;s&nbsp;nothing&nbsp;to&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602355">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3602374">:=</span>&nbsp;<span class="builtintype" id="3602377">true</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602383">for</span>&nbsp;<span class="ident" id="3602387">_</span><span class="op" id="3602388">,</span>&nbsp;<span class="ident" id="3602390">c</span>&nbsp;<span class="op" id="3602392">:=</span>&nbsp;<span class="keyword" id="3602395">range</span>&nbsp;<span class="ident" id="3602401">in</span>&nbsp;<span class="op" id="3602404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602408">if</span>&nbsp;<span class="ident" id="3602411">c</span>&nbsp;<span class="op" id="3602413">==</span>&nbsp;<span class="ident" id="3602416">utf8</span><span class="op" id="3602420">.</span><span class="ident" id="3602421">RuneError</span>&nbsp;<span class="op" id="3602431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3602436">//&nbsp;If&nbsp;we&nbsp;get&nbsp;a&nbsp;UTF-8&nbsp;error&nbsp;then&nbsp;there&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3602486">//&nbsp;upper-case&nbsp;ASCII&nbsp;bytes&nbsp;in&nbsp;the&nbsp;invalid&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602540">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3602559">=</span>&nbsp;<span class="builtintype" id="3602561">false</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602570">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602582">if</span>&nbsp;<span class="string" id="3602585">&#39;A&#39;</span>&nbsp;<span class="op" id="3602589">&lt;=</span>&nbsp;<span class="ident" id="3602592">c</span>&nbsp;<span class="op" id="3602594">&amp;&amp;</span>&nbsp;<span class="ident" id="3602597">c</span>&nbsp;<span class="op" id="3602599">&lt;=</span>&nbsp;<span class="string" id="3602602">&#39;Z&#39;</span>&nbsp;<span class="op" id="3602606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602611">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3602630">=</span>&nbsp;<span class="builtintype" id="3602632">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602641">break</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602656">if</span>&nbsp;<span class="ident" id="3602659">isAlreadyLowerCase</span>&nbsp;<span class="op" id="3602678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602682">return</span>&nbsp;<span class="ident" id="3602689">in</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602697">out</span>&nbsp;<span class="op" id="3602701">:=</span>&nbsp;<span class="op" id="3602704">[</span><span class="op" id="3602705">]</span><span class="builtintype" id="3602706">byte</span><span class="op" id="3602710">(</span><span class="ident" id="3602711">in</span><span class="op" id="3602713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602716">for</span>&nbsp;<span class="ident" id="3602720">i</span><span class="op" id="3602721">,</span>&nbsp;<span class="ident" id="3602723">c</span>&nbsp;<span class="op" id="3602725">:=</span>&nbsp;<span class="keyword" id="3602728">range</span>&nbsp;<span class="ident" id="3602734">out</span>&nbsp;<span class="op" id="3602738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602742">if</span>&nbsp;<span class="string" id="3602745">&#39;A&#39;</span>&nbsp;<span class="op" id="3602749">&lt;=</span>&nbsp;<span class="ident" id="3602752">c</span>&nbsp;<span class="op" id="3602754">&amp;&amp;</span>&nbsp;<span class="ident" id="3602757">c</span>&nbsp;<span class="op" id="3602759">&lt;=</span>&nbsp;<span class="string" id="3602762">&#39;Z&#39;</span>&nbsp;<span class="op" id="3602766">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3602771">out</span><span class="op" id="3602774">[</span><span class="ident" id="3602775">i</span><span class="op" id="3602776">]</span>&nbsp;<span class="op" id="3602778">+=</span>&nbsp;<span class="string" id="3602781">&#39;a&#39;</span>&nbsp;<span class="op" id="3602785">-</span>&nbsp;<span class="string" id="3602787">&#39;A&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3602796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3602799">return</span>&nbsp;<span class="builtintype" id="3602806">string</span><span class="op" id="3602812">(</span><span class="ident" id="3602813">out</span><span class="op" id="3602816">)</span><br>
<span class="lineno"></span><span class="op" id="3602818">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="3602821">//&nbsp;VerifyHostname&nbsp;returns&nbsp;nil&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;valid&nbsp;certificate&nbsp;for&nbsp;the&nbsp;named&nbsp;host.</span><br>
<span class="lineno"></span><span class="comment" id="3602899">//&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error&nbsp;describing&nbsp;the&nbsp;mismatch.</span><br>
<span class="lineno"></span><span class="keyword" id="3602957">func</span>&nbsp;<span class="op" id="3602962">(</span><span class="ident" id="3602963">c</span>&nbsp;<span class="op" id="3602965">*</span><span class="ident" id="3602966">Certificate</span><span class="op" id="3602977">)</span>&nbsp;<span class="ident" id="3602979">VerifyHostname</span><span class="op" id="3602993">(</span><span class="ident" id="3602994">h</span>&nbsp;<span class="builtintype" id="3602996">string</span><span class="op" id="3603002">)</span>&nbsp;<span class="builtintype" id="3603004">error</span>&nbsp;<span class="op" id="3603010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3603013">//&nbsp;IP&nbsp;addresses&nbsp;may&nbsp;be&nbsp;written&nbsp;in&nbsp;[&nbsp;].</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3603053">candidateIP</span>&nbsp;<span class="op" id="3603065">:=</span>&nbsp;<span class="ident" id="3603068">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603071">if</span>&nbsp;<span class="builtinfunc" id="3603074">len</span><span class="op" id="3603077">(</span><span class="ident" id="3603078">h</span><span class="op" id="3603079">)</span>&nbsp;<span class="op" id="3603081">&gt;=</span>&nbsp;<span class="num" id="3603084">3</span>&nbsp;<span class="op" id="3603086">&amp;&amp;</span>&nbsp;<span class="ident" id="3603089">h</span><span class="op" id="3603090">[</span><span class="num" id="3603091">0</span><span class="op" id="3603092">]</span>&nbsp;<span class="op" id="3603094">==</span>&nbsp;<span class="string" id="3603097">&#39;[&#39;</span>&nbsp;<span class="op" id="3603101">&amp;&amp;</span>&nbsp;<span class="ident" id="3603104">h</span><span class="op" id="3603105">[</span><span class="builtinfunc" id="3603106">len</span><span class="op" id="3603109">(</span><span class="ident" id="3603110">h</span><span class="op" id="3603111">)</span><span class="op" id="3603112">-</span><span class="num" id="3603113">1</span><span class="op" id="3603114">]</span>&nbsp;<span class="op" id="3603116">==</span>&nbsp;<span class="string" id="3603119">&#39;]&#39;</span>&nbsp;<span class="op" id="3603123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3603127">candidateIP</span>&nbsp;<span class="op" id="3603139">=</span>&nbsp;<span class="ident" id="3603141">h</span><span class="op" id="3603142">[</span><span class="num" id="3603143">1</span>&nbsp;<span class="op" id="3603145">:</span>&nbsp;<span class="builtinfunc" id="3603147">len</span><span class="op" id="3603150">(</span><span class="ident" id="3603151">h</span><span class="op" id="3603152">)</span><span class="op" id="3603153">-</span><span class="num" id="3603154">1</span><span class="op" id="3603155">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3603158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603161">if</span>&nbsp;<span class="ident" id="3603164">ip</span>&nbsp;<span class="op" id="3603167">:=</span>&nbsp;<span class="ident" id="3603170">net</span><span class="op" id="3603173">.</span><span class="ident" id="3603174">ParseIP</span><span class="op" id="3603181">(</span><span class="ident" id="3603182">candidateIP</span><span class="op" id="3603193">)</span><span class="op" id="3603194">;</span>&nbsp;<span class="ident" id="3603196">ip</span>&nbsp;<span class="op" id="3603199">!=</span>&nbsp;<span class="ident" id="3603202">nil</span>&nbsp;<span class="op" id="3603206">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3603210">//&nbsp;We&nbsp;only&nbsp;match&nbsp;IP&nbsp;addresses&nbsp;against&nbsp;IP&nbsp;SANs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3603259">//&nbsp;https://tools.ietf.org/html/rfc6125#appendix-B.2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603313">for</span>&nbsp;<span class="ident" id="3603317">_</span><span class="op" id="3603318">,</span>&nbsp;<span class="ident" id="3603320">candidate</span>&nbsp;<span class="op" id="3603330">:=</span>&nbsp;<span class="keyword" id="3603333">range</span>&nbsp;<span class="ident" id="3603339">c</span><span class="op" id="3603340">.</span><span class="ident" id="3603341">IPAddresses</span>&nbsp;<span class="op" id="3603353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603358">if</span>&nbsp;<span class="ident" id="3603361">ip</span><span class="op" id="3603363">.</span><span class="ident" id="3603364">Equal</span><span class="op" id="3603369">(</span><span class="ident" id="3603370">candidate</span><span class="op" id="3603379">)</span>&nbsp;<span class="op" id="3603381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603387">return</span>&nbsp;<span class="ident" id="3603394">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3603401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3603405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603409">return</span>&nbsp;<span class="ident" id="3603416">HostnameError</span><span class="op" id="3603429">{</span><span class="ident" id="3603430">c</span><span class="op" id="3603431">,</span>&nbsp;<span class="ident" id="3603433">candidateIP</span><span class="op" id="3603444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3603447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3603451">lowered</span>&nbsp;<span class="op" id="3603459">:=</span>&nbsp;<span class="ident" id="3603462">toLowerCaseASCII</span><span class="op" id="3603478">(</span><span class="ident" id="3603479">h</span><span class="op" id="3603480">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603484">if</span>&nbsp;<span class="builtinfunc" id="3603487">len</span><span class="op" id="3603490">(</span><span class="ident" id="3603491">c</span><span class="op" id="3603492">.</span><span class="ident" id="3603493">DNSNames</span><span class="op" id="3603501">)</span>&nbsp;<span class="op" id="3603503">&gt;</span>&nbsp;<span class="num" id="3603505">0</span>&nbsp;<span class="op" id="3603507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603511">for</span>&nbsp;<span class="ident" id="3603515">_</span><span class="op" id="3603516">,</span>&nbsp;<span class="ident" id="3603518">match</span>&nbsp;<span class="op" id="3603524">:=</span>&nbsp;<span class="keyword" id="3603527">range</span>&nbsp;<span class="ident" id="3603533">c</span><span class="op" id="3603534">.</span><span class="ident" id="3603535">DNSNames</span>&nbsp;<span class="op" id="3603544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603549">if</span>&nbsp;<span class="ident" id="3603552">matchHostnames</span><span class="op" id="3603566">(</span><span class="ident" id="3603567">toLowerCaseASCII</span><span class="op" id="3603583">(</span><span class="ident" id="3603584">match</span><span class="op" id="3603589">)</span><span class="op" id="3603590">,</span>&nbsp;<span class="ident" id="3603592">lowered</span><span class="op" id="3603599">)</span>&nbsp;<span class="op" id="3603601">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603607">return</span>&nbsp;<span class="ident" id="3603614">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3603621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3603625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3603629">//&nbsp;If&nbsp;Subject&nbsp;Alt&nbsp;Name&nbsp;is&nbsp;given,&nbsp;we&nbsp;ignore&nbsp;the&nbsp;common&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3603690">}</span>&nbsp;<span class="keyword" id="3603692">else</span>&nbsp;<span class="keyword" id="3603697">if</span>&nbsp;<span class="ident" id="3603700">matchHostnames</span><span class="op" id="3603714">(</span><span class="ident" id="3603715">toLowerCaseASCII</span><span class="op" id="3603731">(</span><span class="ident" id="3603732">c</span><span class="op" id="3603733">.</span><span class="ident" id="3603734">Subject</span><span class="op" id="3603741">.</span><span class="ident" id="3603742">CommonName</span><span class="op" id="3603752">)</span><span class="op" id="3603753">,</span>&nbsp;<span class="ident" id="3603755">lowered</span><span class="op" id="3603762">)</span>&nbsp;<span class="op" id="3603764">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603768">return</span>&nbsp;<span class="ident" id="3603775">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3603780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603784">return</span>&nbsp;<span class="ident" id="3603791">HostnameError</span><span class="op" id="3603804">{</span><span class="ident" id="3603805">c</span><span class="op" id="3603806">,</span>&nbsp;<span class="ident" id="3603808">h</span><span class="op" id="3603809">}</span><br>
<span class="lineno"></span><span class="op" id="3603811">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span><span class="keyword" id="3603814">func</span>&nbsp;<span class="ident" id="3603819">checkChainForKeyUsage</span><span class="op" id="3603840">(</span><span class="ident" id="3603841">chain</span>&nbsp;<span class="op" id="3603847">[</span><span class="op" id="3603848">]</span><span class="op" id="3603849">*</span><span class="ident" id="3603850">Certificate</span><span class="op" id="3603861">,</span>&nbsp;<span class="ident" id="3603863">keyUsages</span>&nbsp;<span class="op" id="3603873">[</span><span class="op" id="3603874">]</span><span class="ident" id="3603875">ExtKeyUsage</span><span class="op" id="3603886">)</span>&nbsp;<span class="builtintype" id="3603888">bool</span>&nbsp;<span class="op" id="3603893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3603896">usages</span>&nbsp;<span class="op" id="3603903">:=</span>&nbsp;<span class="builtinfunc" id="3603906">make</span><span class="op" id="3603910">(</span><span class="op" id="3603911">[</span><span class="op" id="3603912">]</span><span class="ident" id="3603913">ExtKeyUsage</span><span class="op" id="3603924">,</span>&nbsp;<span class="builtinfunc" id="3603926">len</span><span class="op" id="3603929">(</span><span class="ident" id="3603930">keyUsages</span><span class="op" id="3603939">)</span><span class="op" id="3603940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3603943">copy</span><span class="op" id="3603947">(</span><span class="ident" id="3603948">usages</span><span class="op" id="3603954">,</span>&nbsp;<span class="ident" id="3603956">keyUsages</span><span class="op" id="3603965">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603969">if</span>&nbsp;<span class="builtinfunc" id="3603972">len</span><span class="op" id="3603975">(</span><span class="ident" id="3603976">chain</span><span class="op" id="3603981">)</span>&nbsp;<span class="op" id="3603983">==</span>&nbsp;<span class="num" id="3603986">0</span>&nbsp;<span class="op" id="3603988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3603992">return</span>&nbsp;<span class="builtintype" id="3603999">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604010">usagesRemaining</span>&nbsp;<span class="op" id="3604026">:=</span>&nbsp;<span class="builtinfunc" id="3604029">len</span><span class="op" id="3604032">(</span><span class="ident" id="3604033">usages</span><span class="op" id="3604039">)</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3604043">//&nbsp;We&nbsp;walk&nbsp;down&nbsp;the&nbsp;list&nbsp;and&nbsp;cross&nbsp;out&nbsp;any&nbsp;usages&nbsp;that&nbsp;aren&#39;t&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3604116">//&nbsp;by&nbsp;each&nbsp;certificate.&nbsp;If&nbsp;we&nbsp;cross&nbsp;out&nbsp;all&nbsp;the&nbsp;usages,&nbsp;then&nbsp;the&nbsp;chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3604188">//&nbsp;is&nbsp;unacceptable.</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="ident" id="3604209">NextCert</span><span class="op" id="3604217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604220">for</span>&nbsp;<span class="ident" id="3604224">i</span>&nbsp;<span class="op" id="3604226">:=</span>&nbsp;<span class="builtinfunc" id="3604229">len</span><span class="op" id="3604232">(</span><span class="ident" id="3604233">chain</span><span class="op" id="3604238">)</span>&nbsp;<span class="op" id="3604240">-</span>&nbsp;<span class="num" id="3604242">1</span><span class="op" id="3604243">;</span>&nbsp;<span class="ident" id="3604245">i</span>&nbsp;<span class="op" id="3604247">&gt;=</span>&nbsp;<span class="num" id="3604250">0</span><span class="op" id="3604251">;</span>&nbsp;<span class="ident" id="3604253">i</span><span class="op" id="3604254">--</span>&nbsp;<span class="op" id="3604257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604261">cert</span>&nbsp;<span class="op" id="3604266">:=</span>&nbsp;<span class="ident" id="3604269">chain</span><span class="op" id="3604274">[</span><span class="ident" id="3604275">i</span><span class="op" id="3604276">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604280">if</span>&nbsp;<span class="builtinfunc" id="3604283">len</span><span class="op" id="3604286">(</span><span class="ident" id="3604287">cert</span><span class="op" id="3604291">.</span><span class="ident" id="3604292">ExtKeyUsage</span><span class="op" id="3604303">)</span>&nbsp;<span class="op" id="3604305">==</span>&nbsp;<span class="num" id="3604308">0</span>&nbsp;<span class="op" id="3604310">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3604313">len</span><span class="op" id="3604316">(</span><span class="ident" id="3604317">cert</span><span class="op" id="3604321">.</span><span class="ident" id="3604322">UnknownExtKeyUsage</span><span class="op" id="3604340">)</span>&nbsp;<span class="op" id="3604342">==</span>&nbsp;<span class="num" id="3604345">0</span>&nbsp;<span class="op" id="3604347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3604352">//&nbsp;The&nbsp;certificate&nbsp;doesn&#39;t&nbsp;have&nbsp;any&nbsp;extended&nbsp;key&nbsp;usage&nbsp;specified.</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604421">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604437">for</span>&nbsp;<span class="ident" id="3604441">_</span><span class="op" id="3604442">,</span>&nbsp;<span class="ident" id="3604444">usage</span>&nbsp;<span class="op" id="3604450">:=</span>&nbsp;<span class="keyword" id="3604453">range</span>&nbsp;<span class="ident" id="3604459">cert</span><span class="op" id="3604463">.</span><span class="ident" id="3604464">ExtKeyUsage</span>&nbsp;<span class="op" id="3604476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604481">if</span>&nbsp;<span class="ident" id="3604484">usage</span>&nbsp;<span class="op" id="3604490">==</span>&nbsp;<span class="ident" id="3604493">ExtKeyUsageAny</span>&nbsp;<span class="op" id="3604508">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3604514">//&nbsp;The&nbsp;certificate&nbsp;is&nbsp;explicitly&nbsp;good&nbsp;for&nbsp;any&nbsp;usage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604571">continue</span>&nbsp;<span class="ident" id="3604580">NextCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604601">const</span>&nbsp;<span class="ident" id="3604607">invalidUsage</span>&nbsp;<span class="ident" id="3604620">ExtKeyUsage</span>&nbsp;<span class="op" id="3604632">=</span>&nbsp;<span class="op" id="3604634">-</span><span class="num" id="3604635">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604639">NextRequestedUsage</span><span class="op" id="3604657">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604661">for</span>&nbsp;<span class="ident" id="3604665">i</span><span class="op" id="3604666">,</span>&nbsp;<span class="ident" id="3604668">requestedUsage</span>&nbsp;<span class="op" id="3604683">:=</span>&nbsp;<span class="keyword" id="3604686">range</span>&nbsp;<span class="ident" id="3604692">usages</span>&nbsp;<span class="op" id="3604699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604704">if</span>&nbsp;<span class="ident" id="3604707">requestedUsage</span>&nbsp;<span class="op" id="3604722">==</span>&nbsp;<span class="ident" id="3604725">invalidUsage</span>&nbsp;<span class="op" id="3604738">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604744">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604762">for</span>&nbsp;<span class="ident" id="3604766">_</span><span class="op" id="3604767">,</span>&nbsp;<span class="ident" id="3604769">usage</span>&nbsp;<span class="op" id="3604775">:=</span>&nbsp;<span class="keyword" id="3604778">range</span>&nbsp;<span class="ident" id="3604784">cert</span><span class="op" id="3604788">.</span><span class="ident" id="3604789">ExtKeyUsage</span>&nbsp;<span class="op" id="3604801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604807">if</span>&nbsp;<span class="ident" id="3604810">requestedUsage</span>&nbsp;<span class="op" id="3604825">==</span>&nbsp;<span class="ident" id="3604828">usage</span>&nbsp;<span class="op" id="3604834">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3604841">continue</span>&nbsp;<span class="ident" id="3604850">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604873">}</span>&nbsp;<span class="keyword" id="3604875">else</span>&nbsp;<span class="keyword" id="3604880">if</span>&nbsp;<span class="ident" id="3604883">requestedUsage</span>&nbsp;<span class="op" id="3604898">==</span>&nbsp;<span class="ident" id="3604901">ExtKeyUsageServerAuth</span>&nbsp;<span class="op" id="3604923">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3604931">(</span><span class="ident" id="3604932">usage</span>&nbsp;<span class="op" id="3604938">==</span>&nbsp;<span class="ident" id="3604941">ExtKeyUsageNetscapeServerGatedCrypto</span>&nbsp;<span class="op" id="3604978">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3604987">usage</span>&nbsp;<span class="op" id="3604993">==</span>&nbsp;<span class="ident" id="3604996">ExtKeyUsageMicrosoftServerGatedCrypto</span><span class="op" id="3605033">)</span>&nbsp;<span class="op" id="3605035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3605042">//&nbsp;In&nbsp;order&nbsp;to&nbsp;support&nbsp;COMODO</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3605077">//&nbsp;certificate&nbsp;chains,&nbsp;we&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3605116">//&nbsp;accept&nbsp;Netscape&nbsp;or&nbsp;Microsoft&nbsp;SGC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3605157">//&nbsp;usages&nbsp;as&nbsp;equal&nbsp;to&nbsp;ServerAuth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605196">continue</span>&nbsp;<span class="ident" id="3605205">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605228">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3605239">usages</span><span class="op" id="3605245">[</span><span class="ident" id="3605246">i</span><span class="op" id="3605247">]</span>&nbsp;<span class="op" id="3605249">=</span>&nbsp;<span class="ident" id="3605251">invalidUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3605267">usagesRemaining</span><span class="op" id="3605282">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605288">if</span>&nbsp;<span class="ident" id="3605291">usagesRemaining</span>&nbsp;<span class="op" id="3605307">==</span>&nbsp;<span class="num" id="3605310">0</span>&nbsp;<span class="op" id="3605312">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605318">return</span>&nbsp;<span class="builtintype" id="3605325">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3605341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3605345">return</span>&nbsp;<span class="builtintype" id="3605352">true</span><br>
<span class="lineno"></span><span class="op" id="3605357">}</span>
</div>
</body>
</html>
