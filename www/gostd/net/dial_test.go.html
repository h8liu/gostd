<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6555498">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6555553">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6555607">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6555658">package</span>&nbsp;<span class="ident" id="6555666">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6555671">import</span>&nbsp;<span class="op" id="6555678">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555681">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555690">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555698">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555705">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555711">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555717">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555728">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555739">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555749">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555760">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555771">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555779">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6555790">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6555797">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6555800">func</span>&nbsp;<span class="ident" id="6555805">newLocalListener</span><span class="op" id="6555821">(</span><span class="ident" id="6555822">t</span>&nbsp;<span class="op" id="6555824">*</span><span class="ident" id="6555825">testing</span><span class="op" id="6555832">.</span><span class="ident" id="6555833">T</span><span class="op" id="6555834">)</span>&nbsp;<span class="ident" id="6555836">Listener</span>&nbsp;<span class="op" id="6555845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6555848">ln</span><span class="op" id="6555850">,</span>&nbsp;<span class="ident" id="6555852">err</span>&nbsp;<span class="op" id="6555856">:=</span>&nbsp;<span class="ident" id="6555859">Listen</span><span class="op" id="6555865">(</span><span class="string" id="6555866">&#34;tcp&#34;</span><span class="op" id="6555871">,</span>&nbsp;<span class="string" id="6555873">&#34;127.0.0.1:0&#34;</span><span class="op" id="6555886">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6555889">if</span>&nbsp;<span class="ident" id="6555892">err</span>&nbsp;<span class="op" id="6555896">!=</span>&nbsp;<span class="ident" id="6555899">nil</span>&nbsp;<span class="op" id="6555903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6555907">ln</span><span class="op" id="6555909">,</span>&nbsp;<span class="ident" id="6555911">err</span>&nbsp;<span class="op" id="6555915">=</span>&nbsp;<span class="ident" id="6555917">Listen</span><span class="op" id="6555923">(</span><span class="string" id="6555924">&#34;tcp6&#34;</span><span class="op" id="6555930">,</span>&nbsp;<span class="string" id="6555932">&#34;[::1]:0&#34;</span><span class="op" id="6555941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6555944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6555947">if</span>&nbsp;<span class="ident" id="6555950">err</span>&nbsp;<span class="op" id="6555954">!=</span>&nbsp;<span class="ident" id="6555957">nil</span>&nbsp;<span class="op" id="6555961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6555965">t</span><span class="op" id="6555966">.</span><span class="ident" id="6555967">Fatal</span><span class="op" id="6555972">(</span><span class="ident" id="6555973">err</span><span class="op" id="6555976">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6555979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6555982">return</span>&nbsp;<span class="ident" id="6555989">ln</span><br>
<span class="lineno"></span><span class="op" id="6555992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6555995">func</span>&nbsp;<span class="ident" id="6556000">TestDialTimeout</span><span class="op" id="6556015">(</span><span class="ident" id="6556016">t</span>&nbsp;<span class="op" id="6556018">*</span><span class="ident" id="6556019">testing</span><span class="op" id="6556026">.</span><span class="ident" id="6556027">T</span><span class="op" id="6556028">)</span>&nbsp;<span class="op" id="6556030">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6556033">origBacklog</span>&nbsp;<span class="op" id="6556045">:=</span>&nbsp;<span class="ident" id="6556048">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6556065">defer</span>&nbsp;<span class="keyword" id="6556071">func</span><span class="op" id="6556075">(</span><span class="op" id="6556076">)</span>&nbsp;<span class="op" id="6556078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6556082">listenerBacklog</span>&nbsp;<span class="op" id="6556098">=</span>&nbsp;<span class="ident" id="6556100">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6556113">}</span><span class="op" id="6556114">(</span><span class="op" id="6556115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6556118">listenerBacklog</span>&nbsp;<span class="op" id="6556134">=</span>&nbsp;<span class="num" id="6556136">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6556140">ln</span>&nbsp;<span class="op" id="6556143">:=</span>&nbsp;<span class="ident" id="6556146">newLocalListener</span><span class="op" id="6556162">(</span><span class="ident" id="6556163">t</span><span class="op" id="6556164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6556167">defer</span>&nbsp;<span class="ident" id="6556173">ln</span><span class="op" id="6556175">.</span><span class="ident" id="6556176">Close</span><span class="op" id="6556181">(</span><span class="op" id="6556182">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6556186">errc</span>&nbsp;<span class="op" id="6556191">:=</span>&nbsp;<span class="builtinfunc" id="6556194">make</span><span class="op" id="6556198">(</span><span class="keyword" id="6556199">chan</span>&nbsp;<span class="builtintype" id="6556204">error</span><span class="op" id="6556209">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6556213">numConns</span>&nbsp;<span class="op" id="6556222">:=</span>&nbsp;<span class="ident" id="6556225">listenerBacklog</span>&nbsp;<span class="op" id="6556241">+</span>&nbsp;<span class="num" id="6556243">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6556249">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6556306">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6556355">switch</span>&nbsp;<span class="ident" id="6556362">runtime</span><span class="op" id="6556369">.</span><span class="ident" id="6556370">GOOS</span>&nbsp;<span class="op" id="6556375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6556378">case</span>&nbsp;<span class="string" id="6556383">&#34;linux&#34;</span><span class="op" id="6556390">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6556394">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6556464">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6556534">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6556604">for</span>&nbsp;<span class="ident" id="6556608">i</span>&nbsp;<span class="op" id="6556610">:=</span>&nbsp;<span class="num" id="6556613">0</span><span class="op" id="6556614">;</span>&nbsp;<span class="ident" id="6556616">i</span>&nbsp;<span class="op" id="6556618">&lt;</span>&nbsp;<span class="ident" id="6556620">numConns</span><span class="op" id="6556628">;</span>&nbsp;<span class="ident" id="6556630">i</span><span class="op" id="6556631">++</span>&nbsp;<span class="op" id="6556634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6556639">go</span>&nbsp;<span class="keyword" id="6556642">func</span><span class="op" id="6556646">(</span><span class="op" id="6556647">)</span>&nbsp;<span class="op" id="6556649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6556655">_</span><span class="op" id="6556656">,</span>&nbsp;<span class="ident" id="6556658">err</span>&nbsp;<span class="op" id="6556662">:=</span>&nbsp;<span class="ident" id="6556665">DialTimeout</span><span class="op" id="6556676">(</span><span class="string" id="6556677">&#34;tcp&#34;</span><span class="op" id="6556682">,</span>&nbsp;<span class="ident" id="6556684">ln</span><span class="op" id="6556686">.</span><span class="ident" id="6556687">Addr</span><span class="op" id="6556691">(</span><span class="op" id="6556692">)</span><span class="op" id="6556693">.</span><span class="ident" id="6556694">String</span><span class="op" id="6556700">(</span><span class="op" id="6556701">)</span><span class="op" id="6556702">,</span>&nbsp;<span class="num" id="6556704">200</span><span class="op" id="6556707">*</span><span class="ident" id="6556708">time</span><span class="op" id="6556712">.</span><span class="ident" id="6556713">Millisecond</span><span class="op" id="6556724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6556730">errc</span>&nbsp;<span class="op" id="6556735">&lt;-</span>&nbsp;<span class="ident" id="6556738">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6556745">}</span><span class="op" id="6556746">(</span><span class="op" id="6556747">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6556751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6556754">case</span>&nbsp;<span class="string" id="6556759">&#34;darwin&#34;</span><span class="op" id="6556767">,</span>&nbsp;<span class="string" id="6556769">&#34;plan9&#34;</span><span class="op" id="6556776">,</span>&nbsp;<span class="string" id="6556778">&#34;windows&#34;</span><span class="op" id="6556787">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6556791">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6556845">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6556900">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6556954">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6556977">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6556982">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6557044">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6557100">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6557154">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6557214">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6557219">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6557286">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6557383">go</span>&nbsp;<span class="keyword" id="6557386">func</span><span class="op" id="6557390">(</span><span class="op" id="6557391">)</span>&nbsp;<span class="op" id="6557393">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6557398">c</span><span class="op" id="6557399">,</span>&nbsp;<span class="ident" id="6557401">err</span>&nbsp;<span class="op" id="6557405">:=</span>&nbsp;<span class="ident" id="6557408">DialTimeout</span><span class="op" id="6557419">(</span><span class="string" id="6557420">&#34;tcp&#34;</span><span class="op" id="6557425">,</span>&nbsp;<span class="string" id="6557427">&#34;127.0.71.111:49151&#34;</span><span class="op" id="6557447">,</span>&nbsp;<span class="num" id="6557449">200</span><span class="op" id="6557452">*</span><span class="ident" id="6557453">time</span><span class="op" id="6557457">.</span><span class="ident" id="6557458">Millisecond</span><span class="op" id="6557469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6557474">if</span>&nbsp;<span class="ident" id="6557477">err</span>&nbsp;<span class="op" id="6557481">==</span>&nbsp;<span class="ident" id="6557484">nil</span>&nbsp;<span class="op" id="6557488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6557494">err</span>&nbsp;<span class="op" id="6557498">=</span>&nbsp;<span class="ident" id="6557500">fmt</span><span class="op" id="6557503">.</span><span class="ident" id="6557504">Errorf</span><span class="op" id="6557510">(</span><span class="string" id="6557511">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="6557541">,</span>&nbsp;<span class="ident" id="6557543">c</span><span class="op" id="6557544">.</span><span class="ident" id="6557545">RemoteAddr</span><span class="op" id="6557555">(</span><span class="op" id="6557556">)</span><span class="op" id="6557557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6557563">c</span><span class="op" id="6557564">.</span><span class="ident" id="6557565">Close</span><span class="op" id="6557570">(</span><span class="op" id="6557571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6557576">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6557581">errc</span>&nbsp;<span class="op" id="6557586">&lt;-</span>&nbsp;<span class="ident" id="6557589">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6557595">}</span><span class="op" id="6557596">(</span><span class="op" id="6557597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6557600">default</span><span class="op" id="6557607">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6557611">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6557632">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6557698">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6557754">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6557770">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6557832">t</span><span class="op" id="6557833">.</span><span class="ident" id="6557834">Skipf</span><span class="op" id="6557839">(</span><span class="string" id="6557840">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="6557872">,</span>&nbsp;<span class="ident" id="6557874">runtime</span><span class="op" id="6557881">.</span><span class="ident" id="6557882">GOOS</span><span class="op" id="6557886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6557889">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6557893">connected</span>&nbsp;<span class="op" id="6557903">:=</span>&nbsp;<span class="num" id="6557906">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6557909">for</span>&nbsp;<span class="op" id="6557913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6557917">select</span>&nbsp;<span class="op" id="6557924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6557928">case</span>&nbsp;<span class="op" id="6557933">&lt;-</span><span class="ident" id="6557935">time</span><span class="op" id="6557939">.</span><span class="ident" id="6557940">After</span><span class="op" id="6557945">(</span><span class="num" id="6557946">15</span>&nbsp;<span class="op" id="6557949">*</span>&nbsp;<span class="ident" id="6557951">time</span><span class="op" id="6557955">.</span><span class="ident" id="6557956">Second</span><span class="op" id="6557962">)</span><span class="op" id="6557963">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6557968">t</span><span class="op" id="6557969">.</span><span class="ident" id="6557970">Fatal</span><span class="op" id="6557975">(</span><span class="string" id="6557976">&#34;too&nbsp;slow&#34;</span><span class="op" id="6557986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6557990">case</span>&nbsp;<span class="ident" id="6557995">err</span>&nbsp;<span class="op" id="6557999">:=</span>&nbsp;<span class="op" id="6558002">&lt;-</span><span class="ident" id="6558004">errc</span><span class="op" id="6558008">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6558013">if</span>&nbsp;<span class="ident" id="6558016">err</span>&nbsp;<span class="op" id="6558020">==</span>&nbsp;<span class="ident" id="6558023">nil</span>&nbsp;<span class="op" id="6558027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558033">connected</span><span class="op" id="6558042">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6558049">if</span>&nbsp;<span class="ident" id="6558052">connected</span>&nbsp;<span class="op" id="6558062">==</span>&nbsp;<span class="ident" id="6558065">numConns</span>&nbsp;<span class="op" id="6558074">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558081">t</span><span class="op" id="6558082">.</span><span class="ident" id="6558083">Fatal</span><span class="op" id="6558088">(</span><span class="string" id="6558089">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="6558143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6558149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6558154">}</span>&nbsp;<span class="keyword" id="6558156">else</span>&nbsp;<span class="op" id="6558161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558167">terr</span><span class="op" id="6558171">,</span>&nbsp;<span class="ident" id="6558173">ok</span>&nbsp;<span class="op" id="6558176">:=</span>&nbsp;<span class="ident" id="6558179">err</span><span class="op" id="6558182">.</span><span class="op" id="6558183">(</span><span class="ident" id="6558184">timeout</span><span class="op" id="6558191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6558197">if</span>&nbsp;<span class="op" id="6558200">!</span><span class="ident" id="6558201">ok</span>&nbsp;<span class="op" id="6558204">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558211">t</span><span class="op" id="6558212">.</span><span class="ident" id="6558213">Fatalf</span><span class="op" id="6558219">(</span><span class="string" id="6558220">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="6558269">,</span>&nbsp;<span class="ident" id="6558271">err</span><span class="op" id="6558274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6558280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6558286">if</span>&nbsp;<span class="op" id="6558289">!</span><span class="ident" id="6558290">terr</span><span class="op" id="6558294">.</span><span class="ident" id="6558295">Timeout</span><span class="op" id="6558302">(</span><span class="op" id="6558303">)</span>&nbsp;<span class="op" id="6558305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558312">t</span><span class="op" id="6558313">.</span><span class="ident" id="6558314">Fatalf</span><span class="op" id="6558320">(</span><span class="string" id="6558321">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="6558350">,</span>&nbsp;<span class="ident" id="6558352">err</span><span class="op" id="6558355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6558361">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6558367">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6558404">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6558414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6558418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6558421">}</span><br>
<span class="lineno">115</span><span class="op" id="6558423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6558426">func</span>&nbsp;<span class="ident" id="6558431">TestSelfConnect</span><span class="op" id="6558446">(</span><span class="ident" id="6558447">t</span>&nbsp;<span class="op" id="6558449">*</span><span class="ident" id="6558450">testing</span><span class="op" id="6558457">.</span><span class="ident" id="6558458">T</span><span class="op" id="6558459">)</span>&nbsp;<span class="op" id="6558461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6558464">if</span>&nbsp;<span class="ident" id="6558467">runtime</span><span class="op" id="6558474">.</span><span class="ident" id="6558475">GOOS</span>&nbsp;<span class="op" id="6558480">==</span>&nbsp;<span class="string" id="6558483">&#34;windows&#34;</span>&nbsp;<span class="op" id="6558493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6558497">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558544">t</span><span class="op" id="6558545">.</span><span class="ident" id="6558546">Skip</span><span class="op" id="6558550">(</span><span class="string" id="6558551">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="6558590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6558593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6558597">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6558646">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6558679">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558734">l</span><span class="op" id="6558735">,</span>&nbsp;<span class="ident" id="6558737">err</span>&nbsp;<span class="op" id="6558741">:=</span>&nbsp;<span class="ident" id="6558744">Listen</span><span class="op" id="6558750">(</span><span class="string" id="6558751">&#34;tcp&#34;</span><span class="op" id="6558756">,</span>&nbsp;<span class="string" id="6558758">&#34;127.0.0.1:0&#34;</span><span class="op" id="6558771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6558774">if</span>&nbsp;<span class="ident" id="6558777">err</span>&nbsp;<span class="op" id="6558781">!=</span>&nbsp;<span class="ident" id="6558784">nil</span>&nbsp;<span class="op" id="6558788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558792">t</span><span class="op" id="6558793">.</span><span class="ident" id="6558794">Fatal</span><span class="op" id="6558799">(</span><span class="ident" id="6558800">err</span><span class="op" id="6558803">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6558806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558809">c</span><span class="op" id="6558810">,</span>&nbsp;<span class="ident" id="6558812">err</span>&nbsp;<span class="op" id="6558816">:=</span>&nbsp;<span class="ident" id="6558819">Dial</span><span class="op" id="6558823">(</span><span class="string" id="6558824">&#34;tcp&#34;</span><span class="op" id="6558829">,</span>&nbsp;<span class="ident" id="6558831">l</span><span class="op" id="6558832">.</span><span class="ident" id="6558833">Addr</span><span class="op" id="6558837">(</span><span class="op" id="6558838">)</span><span class="op" id="6558839">.</span><span class="ident" id="6558840">String</span><span class="op" id="6558846">(</span><span class="op" id="6558847">)</span><span class="op" id="6558848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6558851">if</span>&nbsp;<span class="ident" id="6558854">err</span>&nbsp;<span class="op" id="6558858">!=</span>&nbsp;<span class="ident" id="6558861">nil</span>&nbsp;<span class="op" id="6558865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558869">t</span><span class="op" id="6558870">.</span><span class="ident" id="6558871">Fatal</span><span class="op" id="6558876">(</span><span class="ident" id="6558877">err</span><span class="op" id="6558880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6558883">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558886">addr</span>&nbsp;<span class="op" id="6558891">:=</span>&nbsp;<span class="ident" id="6558894">c</span><span class="op" id="6558895">.</span><span class="ident" id="6558896">LocalAddr</span><span class="op" id="6558905">(</span><span class="op" id="6558906">)</span><span class="op" id="6558907">.</span><span class="ident" id="6558908">String</span><span class="op" id="6558914">(</span><span class="op" id="6558915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558918">c</span><span class="op" id="6558919">.</span><span class="ident" id="6558920">Close</span><span class="op" id="6558925">(</span><span class="op" id="6558926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558929">l</span><span class="op" id="6558930">.</span><span class="ident" id="6558931">Close</span><span class="op" id="6558936">(</span><span class="op" id="6558937">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6558941">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6558988">n</span>&nbsp;<span class="op" id="6558990">:=</span>&nbsp;<span class="num" id="6558993">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6559001">if</span>&nbsp;<span class="ident" id="6559004">testing</span><span class="op" id="6559011">.</span><span class="ident" id="6559012">Short</span><span class="op" id="6559017">(</span><span class="op" id="6559018">)</span>&nbsp;<span class="op" id="6559020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6559024">n</span>&nbsp;<span class="op" id="6559026">=</span>&nbsp;<span class="num" id="6559028">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6559034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6559037">switch</span>&nbsp;<span class="ident" id="6559044">runtime</span><span class="op" id="6559051">.</span><span class="ident" id="6559052">GOOS</span>&nbsp;<span class="op" id="6559057">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6559060">case</span>&nbsp;<span class="string" id="6559065">&#34;darwin&#34;</span><span class="op" id="6559073">,</span>&nbsp;<span class="string" id="6559075">&#34;dragonfly&#34;</span><span class="op" id="6559086">,</span>&nbsp;<span class="string" id="6559088">&#34;freebsd&#34;</span><span class="op" id="6559097">,</span>&nbsp;<span class="string" id="6559099">&#34;netbsd&#34;</span><span class="op" id="6559107">,</span>&nbsp;<span class="string" id="6559109">&#34;openbsd&#34;</span><span class="op" id="6559118">,</span>&nbsp;<span class="string" id="6559120">&#34;plan9&#34;</span><span class="op" id="6559127">,</span>&nbsp;<span class="string" id="6559129">&#34;solaris&#34;</span><span class="op" id="6559138">,</span>&nbsp;<span class="string" id="6559140">&#34;windows&#34;</span><span class="op" id="6559149">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6559153">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6559203">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6559258">n</span>&nbsp;<span class="op" id="6559260">=</span>&nbsp;<span class="num" id="6559262">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6559267">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6559270">for</span>&nbsp;<span class="ident" id="6559274">i</span>&nbsp;<span class="op" id="6559276">:=</span>&nbsp;<span class="num" id="6559279">0</span><span class="op" id="6559280">;</span>&nbsp;<span class="ident" id="6559282">i</span>&nbsp;<span class="op" id="6559284">&lt;</span>&nbsp;<span class="ident" id="6559286">n</span><span class="op" id="6559287">;</span>&nbsp;<span class="ident" id="6559289">i</span><span class="op" id="6559290">++</span>&nbsp;<span class="op" id="6559293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6559297">c</span><span class="op" id="6559298">,</span>&nbsp;<span class="ident" id="6559300">err</span>&nbsp;<span class="op" id="6559304">:=</span>&nbsp;<span class="ident" id="6559307">DialTimeout</span><span class="op" id="6559318">(</span><span class="string" id="6559319">&#34;tcp&#34;</span><span class="op" id="6559324">,</span>&nbsp;<span class="ident" id="6559326">addr</span><span class="op" id="6559330">,</span>&nbsp;<span class="ident" id="6559332">time</span><span class="op" id="6559336">.</span><span class="ident" id="6559337">Millisecond</span><span class="op" id="6559348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6559352">if</span>&nbsp;<span class="ident" id="6559355">err</span>&nbsp;<span class="op" id="6559359">==</span>&nbsp;<span class="ident" id="6559362">nil</span>&nbsp;<span class="op" id="6559366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6559371">if</span>&nbsp;<span class="ident" id="6559374">c</span><span class="op" id="6559375">.</span><span class="ident" id="6559376">LocalAddr</span><span class="op" id="6559385">(</span><span class="op" id="6559386">)</span><span class="op" id="6559387">.</span><span class="ident" id="6559388">String</span><span class="op" id="6559394">(</span><span class="op" id="6559395">)</span>&nbsp;<span class="op" id="6559397">==</span>&nbsp;<span class="ident" id="6559400">addr</span>&nbsp;<span class="op" id="6559405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6559411">t</span><span class="op" id="6559412">.</span><span class="ident" id="6559413">Errorf</span><span class="op" id="6559419">(</span><span class="string" id="6559420">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="6559447">,</span>&nbsp;<span class="ident" id="6559449">i</span><span class="op" id="6559450">,</span>&nbsp;<span class="ident" id="6559452">addr</span><span class="op" id="6559456">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6559461">}</span>&nbsp;<span class="keyword" id="6559463">else</span>&nbsp;<span class="op" id="6559468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6559474">t</span><span class="op" id="6559475">.</span><span class="ident" id="6559476">Logf</span><span class="op" id="6559480">(</span><span class="string" id="6559481">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="6559543">,</span>&nbsp;<span class="ident" id="6559545">i</span><span class="op" id="6559546">,</span>&nbsp;<span class="ident" id="6559548">addr</span><span class="op" id="6559552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6559557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6559562">c</span><span class="op" id="6559563">.</span><span class="ident" id="6559564">Close</span><span class="op" id="6559569">(</span><span class="op" id="6559570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6559574">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6559577">}</span><br>
<span class="lineno"></span><span class="op" id="6559579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6559582">var</span>&nbsp;<span class="ident" id="6559586">runErrorTest</span>&nbsp;<span class="op" id="6559599">=</span>&nbsp;<span class="ident" id="6559601">flag</span><span class="op" id="6559605">.</span><span class="ident" id="6559606">Bool</span><span class="op" id="6559610">(</span><span class="string" id="6559611">&#34;run_error_test&#34;</span><span class="op" id="6559627">,</span>&nbsp;<span class="builtintype" id="6559629">false</span><span class="op" id="6559634">,</span>&nbsp;<span class="string" id="6559636">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="6559676">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6559679">type</span>&nbsp;<span class="ident" id="6559684">DialErrorTest</span>&nbsp;<span class="keyword" id="6559698">struct</span>&nbsp;<span class="op" id="6559705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6559708">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6559716">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6559724">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6559732">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6559740">Pattern</span>&nbsp;<span class="builtintype" id="6559748">string</span><br>
<span class="lineno"></span><span class="op" id="6559755">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="6559758">var</span>&nbsp;<span class="ident" id="6559762">dialErrorTests</span>&nbsp;<span class="op" id="6559777">=</span>&nbsp;<span class="op" id="6559779">[</span><span class="op" id="6559780">]</span><span class="ident" id="6559781">DialErrorTest</span><span class="op" id="6559794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6559797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6559801">&#34;datakit&#34;</span><span class="op" id="6559810">,</span>&nbsp;<span class="string" id="6559812">&#34;mh/astro/r70&#34;</span><span class="op" id="6559826">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6559830">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="6559882">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6559885">}</span><span class="op" id="6559886">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6559889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6559893">&#34;tcp&#34;</span><span class="op" id="6559898">,</span>&nbsp;<span class="string" id="6559900">&#34;127.0.0.1:☺&#34;</span><span class="op" id="6559915">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6559919">&#34;dial&nbsp;tcp&nbsp;127.0.0.1:☺:&nbsp;unknown&nbsp;port&nbsp;tcp/☺&#34;</span><span class="op" id="6559965">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6559968">}</span><span class="op" id="6559969">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6559972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6559976">&#34;tcp&#34;</span><span class="op" id="6559981">,</span>&nbsp;<span class="string" id="6559983">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="6560012">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560016">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="6560105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560108">}</span><span class="op" id="6560109">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560112">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560116">&#34;tcp&#34;</span><span class="op" id="6560121">,</span>&nbsp;<span class="string" id="6560123">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="6560166">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560170">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="6560287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560290">}</span><span class="op" id="6560291">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560298">&#34;tcp&#34;</span><span class="op" id="6560303">,</span>&nbsp;<span class="string" id="6560305">&#34;no-such-name:80&#34;</span><span class="op" id="6560322">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560326">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="6560400">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560403">}</span><span class="op" id="6560404">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560411">&#34;tcp&#34;</span><span class="op" id="6560416">,</span>&nbsp;<span class="string" id="6560418">&#34;mh/astro/r70:http&#34;</span><span class="op" id="6560437">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560441">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="6560511">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560514">}</span><span class="op" id="6560515">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560522">&#34;unix&#34;</span><span class="op" id="6560528">,</span>&nbsp;<span class="string" id="6560530">&#34;/etc/file-not-found&#34;</span><span class="op" id="6560551">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560555">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="6560613">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560616">}</span><span class="op" id="6560617">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560624">&#34;unix&#34;</span><span class="op" id="6560630">,</span>&nbsp;<span class="string" id="6560632">&#34;/etc/&#34;</span><span class="op" id="6560639">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560643">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="6560731">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560734">}</span><span class="op" id="6560735">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560738">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560742">&#34;unixpacket&#34;</span><span class="op" id="6560754">,</span>&nbsp;<span class="string" id="6560756">&#34;/etc/file-not-found&#34;</span><span class="op" id="6560777">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560781">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="6560845">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560848">}</span><span class="op" id="6560849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560856">&#34;unixpacket&#34;</span><span class="op" id="6560868">,</span>&nbsp;<span class="string" id="6560870">&#34;/etc/&#34;</span><span class="op" id="6560877">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6560881">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="6560975">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6560978">}</span><span class="op" id="6560979">,</span><br>
<span class="lineno"></span><span class="op" id="6560981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6560984">var</span>&nbsp;<span class="ident" id="6560988">duplicateErrorPattern</span>&nbsp;<span class="op" id="6561010">=</span>&nbsp;<span class="string" id="6561012">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6561035">func</span>&nbsp;<span class="ident" id="6561040">TestDialError</span><span class="op" id="6561053">(</span><span class="ident" id="6561054">t</span>&nbsp;<span class="op" id="6561056">*</span><span class="ident" id="6561057">testing</span><span class="op" id="6561064">.</span><span class="ident" id="6561065">T</span><span class="op" id="6561066">)</span>&nbsp;<span class="op" id="6561068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6561071">if</span>&nbsp;<span class="op" id="6561074">!</span><span class="op" id="6561075">*</span><span class="ident" id="6561076">runErrorTest</span>&nbsp;<span class="op" id="6561089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561093">t</span><span class="op" id="6561094">.</span><span class="ident" id="6561095">Logf</span><span class="op" id="6561099">(</span><span class="string" id="6561100">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="6561146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6561150">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6561158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6561161">for</span>&nbsp;<span class="ident" id="6561165">i</span><span class="op" id="6561166">,</span>&nbsp;<span class="ident" id="6561168">tt</span>&nbsp;<span class="op" id="6561171">:=</span>&nbsp;<span class="keyword" id="6561174">range</span>&nbsp;<span class="ident" id="6561180">dialErrorTests</span>&nbsp;<span class="op" id="6561195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561199">c</span><span class="op" id="6561200">,</span>&nbsp;<span class="ident" id="6561202">err</span>&nbsp;<span class="op" id="6561206">:=</span>&nbsp;<span class="ident" id="6561209">Dial</span><span class="op" id="6561213">(</span><span class="ident" id="6561214">tt</span><span class="op" id="6561216">.</span><span class="ident" id="6561217">Net</span><span class="op" id="6561220">,</span>&nbsp;<span class="ident" id="6561222">tt</span><span class="op" id="6561224">.</span><span class="ident" id="6561225">Raddr</span><span class="op" id="6561230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6561234">if</span>&nbsp;<span class="ident" id="6561237">c</span>&nbsp;<span class="op" id="6561239">!=</span>&nbsp;<span class="ident" id="6561242">nil</span>&nbsp;<span class="op" id="6561246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561251">c</span><span class="op" id="6561252">.</span><span class="ident" id="6561253">Close</span><span class="op" id="6561258">(</span><span class="op" id="6561259">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6561263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6561267">if</span>&nbsp;<span class="ident" id="6561270">err</span>&nbsp;<span class="op" id="6561274">==</span>&nbsp;<span class="ident" id="6561277">nil</span>&nbsp;<span class="op" id="6561281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561286">t</span><span class="op" id="6561287">.</span><span class="ident" id="6561288">Errorf</span><span class="op" id="6561294">(</span><span class="string" id="6561295">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="6561331">,</span>&nbsp;<span class="ident" id="6561333">i</span><span class="op" id="6561334">,</span>&nbsp;<span class="ident" id="6561336">tt</span><span class="op" id="6561338">.</span><span class="ident" id="6561339">Pattern</span><span class="op" id="6561346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6561351">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6561362">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561366">s</span>&nbsp;<span class="op" id="6561368">:=</span>&nbsp;<span class="ident" id="6561371">err</span><span class="op" id="6561374">.</span><span class="ident" id="6561375">Error</span><span class="op" id="6561380">(</span><span class="op" id="6561381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561385">match</span><span class="op" id="6561390">,</span>&nbsp;<span class="ident" id="6561392">_</span>&nbsp;<span class="op" id="6561394">:=</span>&nbsp;<span class="ident" id="6561397">regexp</span><span class="op" id="6561403">.</span><span class="ident" id="6561404">MatchString</span><span class="op" id="6561415">(</span><span class="ident" id="6561416">tt</span><span class="op" id="6561418">.</span><span class="ident" id="6561419">Pattern</span><span class="op" id="6561426">,</span>&nbsp;<span class="ident" id="6561428">s</span><span class="op" id="6561429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6561433">if</span>&nbsp;<span class="op" id="6561436">!</span><span class="ident" id="6561437">match</span>&nbsp;<span class="op" id="6561443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561448">t</span><span class="op" id="6561449">.</span><span class="ident" id="6561450">Errorf</span><span class="op" id="6561456">(</span><span class="string" id="6561457">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="6561486">,</span>&nbsp;<span class="ident" id="6561488">i</span><span class="op" id="6561489">,</span>&nbsp;<span class="ident" id="6561491">s</span><span class="op" id="6561492">,</span>&nbsp;<span class="ident" id="6561494">tt</span><span class="op" id="6561496">.</span><span class="ident" id="6561497">Pattern</span><span class="op" id="6561504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6561508">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561512">match</span><span class="op" id="6561517">,</span>&nbsp;<span class="ident" id="6561519">_</span>&nbsp;<span class="op" id="6561521">=</span>&nbsp;<span class="ident" id="6561523">regexp</span><span class="op" id="6561529">.</span><span class="ident" id="6561530">MatchString</span><span class="op" id="6561541">(</span><span class="ident" id="6561542">duplicateErrorPattern</span><span class="op" id="6561563">,</span>&nbsp;<span class="ident" id="6561565">s</span><span class="op" id="6561566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6561570">if</span>&nbsp;<span class="ident" id="6561573">match</span>&nbsp;<span class="op" id="6561579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561584">t</span><span class="op" id="6561585">.</span><span class="ident" id="6561586">Errorf</span><span class="op" id="6561592">(</span><span class="string" id="6561593">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="6561636">,</span>&nbsp;<span class="ident" id="6561638">i</span><span class="op" id="6561639">,</span>&nbsp;<span class="ident" id="6561641">s</span><span class="op" id="6561642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6561646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6561649">}</span><br>
<span class="lineno">240</span><span class="op" id="6561651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6561654">var</span>&nbsp;<span class="ident" id="6561658">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="6561687">=</span>&nbsp;<span class="op" id="6561689">[</span><span class="op" id="6561690">]</span><span class="keyword" id="6561691">struct</span>&nbsp;<span class="op" id="6561698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561701">net</span>&nbsp;&nbsp;<span class="builtintype" id="6561706">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561714">addr</span>&nbsp;<span class="builtintype" id="6561719">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6561727">err</span>&nbsp;&nbsp;<span class="builtintype" id="6561732">error</span><br>
<span class="lineno"></span><span class="op" id="6561738">}</span><span class="op" id="6561739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6561742">{</span><span class="string" id="6561743">&#34;foo&#34;</span><span class="op" id="6561748">,</span>&nbsp;<span class="string" id="6561750">&#34;bar&#34;</span><span class="op" id="6561755">,</span>&nbsp;<span class="op" id="6561757">&amp;</span><span class="ident" id="6561758">OpError</span><span class="op" id="6561765">{</span><span class="ident" id="6561766">Op</span><span class="op" id="6561768">:</span>&nbsp;<span class="string" id="6561770">&#34;dial&#34;</span><span class="op" id="6561776">,</span>&nbsp;<span class="ident" id="6561778">Net</span><span class="op" id="6561781">:</span>&nbsp;<span class="string" id="6561783">&#34;foo&#34;</span><span class="op" id="6561788">,</span>&nbsp;<span class="ident" id="6561790">Addr</span><span class="op" id="6561794">:</span>&nbsp;<span class="ident" id="6561796">nil</span><span class="op" id="6561799">,</span>&nbsp;<span class="ident" id="6561801">Err</span><span class="op" id="6561804">:</span>&nbsp;<span class="ident" id="6561806">UnknownNetworkError</span><span class="op" id="6561825">(</span><span class="string" id="6561826">&#34;foo&#34;</span><span class="op" id="6561831">)</span><span class="op" id="6561832">}</span><span class="op" id="6561833">}</span><span class="op" id="6561834">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6561837">{</span><span class="string" id="6561838">&#34;baz&#34;</span><span class="op" id="6561843">,</span>&nbsp;<span class="string" id="6561845">&#34;&#34;</span><span class="op" id="6561847">,</span>&nbsp;<span class="op" id="6561849">&amp;</span><span class="ident" id="6561850">OpError</span><span class="op" id="6561857">{</span><span class="ident" id="6561858">Op</span><span class="op" id="6561860">:</span>&nbsp;<span class="string" id="6561862">&#34;listen&#34;</span><span class="op" id="6561870">,</span>&nbsp;<span class="ident" id="6561872">Net</span><span class="op" id="6561875">:</span>&nbsp;<span class="string" id="6561877">&#34;baz&#34;</span><span class="op" id="6561882">,</span>&nbsp;<span class="ident" id="6561884">Addr</span><span class="op" id="6561888">:</span>&nbsp;<span class="ident" id="6561890">nil</span><span class="op" id="6561893">,</span>&nbsp;<span class="ident" id="6561895">Err</span><span class="op" id="6561898">:</span>&nbsp;<span class="ident" id="6561900">UnknownNetworkError</span><span class="op" id="6561919">(</span><span class="string" id="6561920">&#34;baz&#34;</span><span class="op" id="6561925">)</span><span class="op" id="6561926">}</span><span class="op" id="6561927">}</span><span class="op" id="6561928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6561931">{</span><span class="string" id="6561932">&#34;tcp&#34;</span><span class="op" id="6561937">,</span>&nbsp;<span class="string" id="6561939">&#34;&#34;</span><span class="op" id="6561941">,</span>&nbsp;<span class="op" id="6561943">&amp;</span><span class="ident" id="6561944">OpError</span><span class="op" id="6561951">{</span><span class="ident" id="6561952">Op</span><span class="op" id="6561954">:</span>&nbsp;<span class="string" id="6561956">&#34;dial&#34;</span><span class="op" id="6561962">,</span>&nbsp;<span class="ident" id="6561964">Net</span><span class="op" id="6561967">:</span>&nbsp;<span class="string" id="6561969">&#34;tcp&#34;</span><span class="op" id="6561974">,</span>&nbsp;<span class="ident" id="6561976">Addr</span><span class="op" id="6561980">:</span>&nbsp;<span class="ident" id="6561982">nil</span><span class="op" id="6561985">,</span>&nbsp;<span class="ident" id="6561987">Err</span><span class="op" id="6561990">:</span>&nbsp;<span class="ident" id="6561992">errMissingAddress</span><span class="op" id="6562009">}</span><span class="op" id="6562010">}</span><span class="op" id="6562011">,</span><br>
<span class="lineno">250</span><span class="op" id="6562013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6562016">func</span>&nbsp;<span class="ident" id="6562021">TestInvalidDialAndListenArgs</span><span class="op" id="6562049">(</span><span class="ident" id="6562050">t</span>&nbsp;<span class="op" id="6562052">*</span><span class="ident" id="6562053">testing</span><span class="op" id="6562060">.</span><span class="ident" id="6562061">T</span><span class="op" id="6562062">)</span>&nbsp;<span class="op" id="6562064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562067">for</span>&nbsp;<span class="ident" id="6562071">_</span><span class="op" id="6562072">,</span>&nbsp;<span class="ident" id="6562074">tt</span>&nbsp;<span class="op" id="6562077">:=</span>&nbsp;<span class="keyword" id="6562080">range</span>&nbsp;<span class="ident" id="6562086">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="6562115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562119">var</span>&nbsp;<span class="ident" id="6562123">err</span>&nbsp;<span class="builtintype" id="6562127">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562135">switch</span>&nbsp;<span class="ident" id="6562142">tt</span><span class="op" id="6562144">.</span><span class="ident" id="6562145">err</span><span class="op" id="6562148">.</span><span class="op" id="6562149">(</span><span class="op" id="6562150">*</span><span class="ident" id="6562151">OpError</span><span class="op" id="6562158">)</span><span class="op" id="6562159">.</span><span class="ident" id="6562160">Op</span>&nbsp;<span class="op" id="6562163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562167">case</span>&nbsp;<span class="string" id="6562172">&#34;dial&#34;</span><span class="op" id="6562178">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562183">_</span><span class="op" id="6562184">,</span>&nbsp;<span class="ident" id="6562186">err</span>&nbsp;<span class="op" id="6562190">=</span>&nbsp;<span class="ident" id="6562192">Dial</span><span class="op" id="6562196">(</span><span class="ident" id="6562197">tt</span><span class="op" id="6562199">.</span><span class="ident" id="6562200">net</span><span class="op" id="6562203">,</span>&nbsp;<span class="ident" id="6562205">tt</span><span class="op" id="6562207">.</span><span class="ident" id="6562208">addr</span><span class="op" id="6562212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562216">case</span>&nbsp;<span class="string" id="6562221">&#34;listen&#34;</span><span class="op" id="6562229">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562234">_</span><span class="op" id="6562235">,</span>&nbsp;<span class="ident" id="6562237">err</span>&nbsp;<span class="op" id="6562241">=</span>&nbsp;<span class="ident" id="6562243">Listen</span><span class="op" id="6562249">(</span><span class="ident" id="6562250">tt</span><span class="op" id="6562252">.</span><span class="ident" id="6562253">net</span><span class="op" id="6562256">,</span>&nbsp;<span class="ident" id="6562258">tt</span><span class="op" id="6562260">.</span><span class="ident" id="6562261">addr</span><span class="op" id="6562265">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6562269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562273">if</span>&nbsp;<span class="op" id="6562276">!</span><span class="ident" id="6562277">reflect</span><span class="op" id="6562284">.</span><span class="ident" id="6562285">DeepEqual</span><span class="op" id="6562294">(</span><span class="ident" id="6562295">tt</span><span class="op" id="6562297">.</span><span class="ident" id="6562298">err</span><span class="op" id="6562301">,</span>&nbsp;<span class="ident" id="6562303">err</span><span class="op" id="6562306">)</span>&nbsp;<span class="op" id="6562308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562313">t</span><span class="op" id="6562314">.</span><span class="ident" id="6562315">Fatalf</span><span class="op" id="6562321">(</span><span class="string" id="6562322">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="6562345">,</span>&nbsp;<span class="ident" id="6562347">err</span><span class="op" id="6562350">,</span>&nbsp;<span class="ident" id="6562352">tt</span><span class="op" id="6562354">.</span><span class="ident" id="6562355">err</span><span class="op" id="6562358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6562362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6562365">}</span><br>
<span class="lineno">265</span><span class="op" id="6562367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6562370">func</span>&nbsp;<span class="ident" id="6562375">TestDialTimeoutFDLeak</span><span class="op" id="6562396">(</span><span class="ident" id="6562397">t</span>&nbsp;<span class="op" id="6562399">*</span><span class="ident" id="6562400">testing</span><span class="op" id="6562407">.</span><span class="ident" id="6562408">T</span><span class="op" id="6562409">)</span>&nbsp;<span class="op" id="6562411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562414">if</span>&nbsp;<span class="ident" id="6562417">runtime</span><span class="op" id="6562424">.</span><span class="ident" id="6562425">GOOS</span>&nbsp;<span class="op" id="6562430">!=</span>&nbsp;<span class="string" id="6562433">&#34;linux&#34;</span>&nbsp;<span class="op" id="6562441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6562445">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562490">t</span><span class="op" id="6562491">.</span><span class="ident" id="6562492">Skipf</span><span class="op" id="6562497">(</span><span class="string" id="6562498">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6562519">,</span>&nbsp;<span class="ident" id="6562521">runtime</span><span class="op" id="6562528">.</span><span class="ident" id="6562529">GOOS</span><span class="op" id="6562533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6562536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562540">ln</span>&nbsp;<span class="op" id="6562543">:=</span>&nbsp;<span class="ident" id="6562546">newLocalListener</span><span class="op" id="6562562">(</span><span class="ident" id="6562563">t</span><span class="op" id="6562564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562567">defer</span>&nbsp;<span class="ident" id="6562573">ln</span><span class="op" id="6562575">.</span><span class="ident" id="6562576">Close</span><span class="op" id="6562581">(</span><span class="op" id="6562582">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562586">type</span>&nbsp;<span class="ident" id="6562591">connErr</span>&nbsp;<span class="keyword" id="6562599">struct</span>&nbsp;<span class="op" id="6562606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562610">conn</span>&nbsp;<span class="ident" id="6562615">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562622">err</span>&nbsp;&nbsp;<span class="builtintype" id="6562627">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6562634">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562637">dials</span>&nbsp;<span class="op" id="6562643">:=</span>&nbsp;<span class="ident" id="6562646">listenerBacklog</span>&nbsp;<span class="op" id="6562662">+</span>&nbsp;<span class="num" id="6562664">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6562669">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562749">maxGoodConnect</span>&nbsp;<span class="op" id="6562764">:=</span>&nbsp;<span class="ident" id="6562767">listenerBacklog</span>&nbsp;<span class="op" id="6562783">+</span>&nbsp;<span class="ident" id="6562785">runtime</span><span class="op" id="6562792">.</span><span class="ident" id="6562793">NumCPU</span><span class="op" id="6562799">(</span><span class="op" id="6562800">)</span><span class="op" id="6562801">*</span><span class="num" id="6562802">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562806">resc</span>&nbsp;<span class="op" id="6562811">:=</span>&nbsp;<span class="builtinfunc" id="6562814">make</span><span class="op" id="6562818">(</span><span class="keyword" id="6562819">chan</span>&nbsp;<span class="ident" id="6562824">connErr</span><span class="op" id="6562831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562834">for</span>&nbsp;<span class="ident" id="6562838">i</span>&nbsp;<span class="op" id="6562840">:=</span>&nbsp;<span class="num" id="6562843">0</span><span class="op" id="6562844">;</span>&nbsp;<span class="ident" id="6562846">i</span>&nbsp;<span class="op" id="6562848">&lt;</span>&nbsp;<span class="ident" id="6562850">dials</span><span class="op" id="6562855">;</span>&nbsp;<span class="ident" id="6562857">i</span><span class="op" id="6562858">++</span>&nbsp;<span class="op" id="6562861">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562865">go</span>&nbsp;<span class="keyword" id="6562868">func</span><span class="op" id="6562872">(</span><span class="op" id="6562873">)</span>&nbsp;<span class="op" id="6562875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562880">conn</span><span class="op" id="6562884">,</span>&nbsp;<span class="ident" id="6562886">err</span>&nbsp;<span class="op" id="6562890">:=</span>&nbsp;<span class="ident" id="6562893">DialTimeout</span><span class="op" id="6562904">(</span><span class="string" id="6562905">&#34;tcp&#34;</span><span class="op" id="6562910">,</span>&nbsp;<span class="ident" id="6562912">ln</span><span class="op" id="6562914">.</span><span class="ident" id="6562915">Addr</span><span class="op" id="6562919">(</span><span class="op" id="6562920">)</span><span class="op" id="6562921">.</span><span class="ident" id="6562922">String</span><span class="op" id="6562928">(</span><span class="op" id="6562929">)</span><span class="op" id="6562930">,</span>&nbsp;<span class="num" id="6562932">500</span><span class="op" id="6562935">*</span><span class="ident" id="6562936">time</span><span class="op" id="6562940">.</span><span class="ident" id="6562941">Millisecond</span><span class="op" id="6562952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6562957">resc</span>&nbsp;<span class="op" id="6562962">&lt;-</span>&nbsp;<span class="ident" id="6562965">connErr</span><span class="op" id="6562972">{</span><span class="ident" id="6562973">conn</span><span class="op" id="6562977">,</span>&nbsp;<span class="ident" id="6562979">err</span><span class="op" id="6562982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6562986">}</span><span class="op" id="6562987">(</span><span class="op" id="6562988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6562991">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6562995">var</span>&nbsp;<span class="ident" id="6562999">firstErr</span>&nbsp;<span class="builtintype" id="6563008">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563016">var</span>&nbsp;<span class="ident" id="6563020">ngood</span>&nbsp;<span class="builtintype" id="6563026">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563031">var</span>&nbsp;<span class="ident" id="6563035">toClose</span>&nbsp;<span class="op" id="6563043">[</span><span class="op" id="6563044">]</span><span class="ident" id="6563045">io</span><span class="op" id="6563047">.</span><span class="ident" id="6563048">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563056">for</span>&nbsp;<span class="ident" id="6563060">i</span>&nbsp;<span class="op" id="6563062">:=</span>&nbsp;<span class="num" id="6563065">0</span><span class="op" id="6563066">;</span>&nbsp;<span class="ident" id="6563068">i</span>&nbsp;<span class="op" id="6563070">&lt;</span>&nbsp;<span class="ident" id="6563072">dials</span><span class="op" id="6563077">;</span>&nbsp;<span class="ident" id="6563079">i</span><span class="op" id="6563080">++</span>&nbsp;<span class="op" id="6563083">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563087">ce</span>&nbsp;<span class="op" id="6563090">:=</span>&nbsp;<span class="op" id="6563093">&lt;-</span><span class="ident" id="6563095">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563102">if</span>&nbsp;<span class="ident" id="6563105">ce</span><span class="op" id="6563107">.</span><span class="ident" id="6563108">err</span>&nbsp;<span class="op" id="6563112">==</span>&nbsp;<span class="ident" id="6563115">nil</span>&nbsp;<span class="op" id="6563119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563124">ngood</span><span class="op" id="6563129">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563135">if</span>&nbsp;<span class="ident" id="6563138">ngood</span>&nbsp;<span class="op" id="6563144">&gt;</span>&nbsp;<span class="ident" id="6563146">maxGoodConnect</span>&nbsp;<span class="op" id="6563161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563167">t</span><span class="op" id="6563168">.</span><span class="ident" id="6563169">Errorf</span><span class="op" id="6563175">(</span><span class="string" id="6563176">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="6563215">,</span>&nbsp;<span class="ident" id="6563217">ngood</span><span class="op" id="6563222">,</span>&nbsp;<span class="ident" id="6563224">maxGoodConnect</span><span class="op" id="6563238">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6563243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563248">toClose</span>&nbsp;<span class="op" id="6563256">=</span>&nbsp;<span class="builtinfunc" id="6563258">append</span><span class="op" id="6563264">(</span><span class="ident" id="6563265">toClose</span><span class="op" id="6563272">,</span>&nbsp;<span class="ident" id="6563274">ce</span><span class="op" id="6563276">.</span><span class="ident" id="6563277">conn</span><span class="op" id="6563281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563286">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6563297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563301">err</span>&nbsp;<span class="op" id="6563305">:=</span>&nbsp;<span class="ident" id="6563308">ce</span><span class="op" id="6563310">.</span><span class="ident" id="6563311">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563317">if</span>&nbsp;<span class="ident" id="6563320">firstErr</span>&nbsp;<span class="op" id="6563329">==</span>&nbsp;<span class="string" id="6563332">&#34;&#34;</span>&nbsp;<span class="op" id="6563335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563340">firstErr</span>&nbsp;<span class="op" id="6563349">=</span>&nbsp;<span class="ident" id="6563351">err</span><span class="op" id="6563354">.</span><span class="ident" id="6563355">Error</span><span class="op" id="6563360">(</span><span class="op" id="6563361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6563365">}</span>&nbsp;<span class="keyword" id="6563367">else</span>&nbsp;<span class="keyword" id="6563372">if</span>&nbsp;<span class="ident" id="6563375">err</span><span class="op" id="6563378">.</span><span class="ident" id="6563379">Error</span><span class="op" id="6563384">(</span><span class="op" id="6563385">)</span>&nbsp;<span class="op" id="6563387">!=</span>&nbsp;<span class="ident" id="6563390">firstErr</span>&nbsp;<span class="op" id="6563399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563404">t</span><span class="op" id="6563405">.</span><span class="ident" id="6563406">Fatalf</span><span class="op" id="6563412">(</span><span class="string" id="6563413">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="6563471">,</span>&nbsp;<span class="ident" id="6563473">firstErr</span><span class="op" id="6563481">,</span>&nbsp;<span class="ident" id="6563483">err</span><span class="op" id="6563486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6563490">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6563493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563496">for</span>&nbsp;<span class="ident" id="6563500">_</span><span class="op" id="6563501">,</span>&nbsp;<span class="ident" id="6563503">c</span>&nbsp;<span class="op" id="6563505">:=</span>&nbsp;<span class="keyword" id="6563508">range</span>&nbsp;<span class="ident" id="6563514">toClose</span>&nbsp;<span class="op" id="6563522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563526">c</span><span class="op" id="6563527">.</span><span class="ident" id="6563528">Close</span><span class="op" id="6563533">(</span><span class="op" id="6563534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6563537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563540">for</span>&nbsp;<span class="ident" id="6563544">i</span>&nbsp;<span class="op" id="6563546">:=</span>&nbsp;<span class="num" id="6563549">0</span><span class="op" id="6563550">;</span>&nbsp;<span class="ident" id="6563552">i</span>&nbsp;<span class="op" id="6563554">&lt;</span>&nbsp;<span class="num" id="6563556">100</span><span class="op" id="6563559">;</span>&nbsp;<span class="ident" id="6563561">i</span><span class="op" id="6563562">++</span>&nbsp;<span class="op" id="6563565">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563569">if</span>&nbsp;<span class="ident" id="6563572">got</span>&nbsp;<span class="op" id="6563576">:=</span>&nbsp;<span class="ident" id="6563579">numFD</span><span class="op" id="6563584">(</span><span class="op" id="6563585">)</span><span class="op" id="6563586">;</span>&nbsp;<span class="ident" id="6563588">got</span>&nbsp;<span class="op" id="6563592">&lt;</span>&nbsp;<span class="ident" id="6563594">dials</span>&nbsp;<span class="op" id="6563600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6563605">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563624">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6563633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563637">time</span><span class="op" id="6563641">.</span><span class="ident" id="6563642">Sleep</span><span class="op" id="6563647">(</span><span class="num" id="6563648">10</span>&nbsp;<span class="op" id="6563651">*</span>&nbsp;<span class="ident" id="6563653">time</span><span class="op" id="6563657">.</span><span class="ident" id="6563658">Millisecond</span><span class="op" id="6563669">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6563672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563675">if</span>&nbsp;<span class="ident" id="6563678">got</span>&nbsp;<span class="op" id="6563682">:=</span>&nbsp;<span class="ident" id="6563685">numFD</span><span class="op" id="6563690">(</span><span class="op" id="6563691">)</span><span class="op" id="6563692">;</span>&nbsp;<span class="ident" id="6563694">got</span>&nbsp;<span class="op" id="6563698">&gt;=</span>&nbsp;<span class="ident" id="6563701">dials</span>&nbsp;<span class="op" id="6563707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563711">t</span><span class="op" id="6563712">.</span><span class="ident" id="6563713">Errorf</span><span class="op" id="6563719">(</span><span class="string" id="6563720">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="6563762">,</span>&nbsp;<span class="ident" id="6563764">dials</span><span class="op" id="6563769">,</span>&nbsp;<span class="ident" id="6563771">got</span><span class="op" id="6563774">,</span>&nbsp;<span class="ident" id="6563776">dials</span><span class="op" id="6563781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6563784">}</span><br>
<span class="lineno"></span><span class="op" id="6563786">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="6563789">func</span>&nbsp;<span class="ident" id="6563794">numTCP</span><span class="op" id="6563800">(</span><span class="op" id="6563801">)</span>&nbsp;<span class="op" id="6563803">(</span><span class="ident" id="6563804">ntcp</span><span class="op" id="6563808">,</span>&nbsp;<span class="ident" id="6563810">nopen</span><span class="op" id="6563815">,</span>&nbsp;<span class="ident" id="6563817">nclose</span>&nbsp;<span class="builtintype" id="6563824">int</span><span class="op" id="6563827">,</span>&nbsp;<span class="ident" id="6563829">err</span>&nbsp;<span class="builtintype" id="6563833">error</span><span class="op" id="6563838">)</span>&nbsp;<span class="op" id="6563840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563843">lsof</span><span class="op" id="6563847">,</span>&nbsp;<span class="ident" id="6563849">err</span>&nbsp;<span class="op" id="6563853">:=</span>&nbsp;<span class="ident" id="6563856">exec</span><span class="op" id="6563860">.</span><span class="ident" id="6563861">Command</span><span class="op" id="6563868">(</span><span class="string" id="6563869">&#34;lsof&#34;</span><span class="op" id="6563875">,</span>&nbsp;<span class="string" id="6563877">&#34;-n&#34;</span><span class="op" id="6563881">,</span>&nbsp;<span class="string" id="6563883">&#34;-p&#34;</span><span class="op" id="6563887">,</span>&nbsp;<span class="ident" id="6563889">strconv</span><span class="op" id="6563896">.</span><span class="ident" id="6563897">Itoa</span><span class="op" id="6563901">(</span><span class="ident" id="6563902">os</span><span class="op" id="6563904">.</span><span class="ident" id="6563905">Getpid</span><span class="op" id="6563911">(</span><span class="op" id="6563912">)</span><span class="op" id="6563913">)</span><span class="op" id="6563914">)</span><span class="op" id="6563915">.</span><span class="ident" id="6563916">Output</span><span class="op" id="6563922">(</span><span class="op" id="6563923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563926">if</span>&nbsp;<span class="ident" id="6563929">err</span>&nbsp;<span class="op" id="6563933">!=</span>&nbsp;<span class="ident" id="6563936">nil</span>&nbsp;<span class="op" id="6563940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6563944">return</span>&nbsp;<span class="num" id="6563951">0</span><span class="op" id="6563952">,</span>&nbsp;<span class="num" id="6563954">0</span><span class="op" id="6563955">,</span>&nbsp;<span class="num" id="6563957">0</span><span class="op" id="6563958">,</span>&nbsp;<span class="ident" id="6563960">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6563965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6563968">ntcp</span>&nbsp;<span class="op" id="6563973">+=</span>&nbsp;<span class="ident" id="6563976">bytes</span><span class="op" id="6563981">.</span><span class="ident" id="6563982">Count</span><span class="op" id="6563987">(</span><span class="ident" id="6563988">lsof</span><span class="op" id="6563992">,</span>&nbsp;<span class="op" id="6563994">[</span><span class="op" id="6563995">]</span><span class="builtintype" id="6563996">byte</span><span class="op" id="6564000">(</span><span class="string" id="6564001">&#34;TCP&#34;</span><span class="op" id="6564006">)</span><span class="op" id="6564007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6564010">for</span>&nbsp;<span class="ident" id="6564014">_</span><span class="op" id="6564015">,</span>&nbsp;<span class="ident" id="6564017">state</span>&nbsp;<span class="op" id="6564023">:=</span>&nbsp;<span class="keyword" id="6564026">range</span>&nbsp;<span class="op" id="6564032">[</span><span class="op" id="6564033">]</span><span class="builtintype" id="6564034">string</span><span class="op" id="6564040">{</span><span class="string" id="6564041">&#34;LISTEN&#34;</span><span class="op" id="6564049">,</span>&nbsp;<span class="string" id="6564051">&#34;SYN_SENT&#34;</span><span class="op" id="6564061">,</span>&nbsp;<span class="string" id="6564063">&#34;SYN_RECEIVED&#34;</span><span class="op" id="6564077">,</span>&nbsp;<span class="string" id="6564079">&#34;ESTABLISHED&#34;</span><span class="op" id="6564092">}</span>&nbsp;<span class="op" id="6564094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6564098">nopen</span>&nbsp;<span class="op" id="6564104">+=</span>&nbsp;<span class="ident" id="6564107">bytes</span><span class="op" id="6564112">.</span><span class="ident" id="6564113">Count</span><span class="op" id="6564118">(</span><span class="ident" id="6564119">lsof</span><span class="op" id="6564123">,</span>&nbsp;<span class="op" id="6564125">[</span><span class="op" id="6564126">]</span><span class="builtintype" id="6564127">byte</span><span class="op" id="6564131">(</span><span class="ident" id="6564132">state</span><span class="op" id="6564137">)</span><span class="op" id="6564138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6564141">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6564144">for</span>&nbsp;<span class="ident" id="6564148">_</span><span class="op" id="6564149">,</span>&nbsp;<span class="ident" id="6564151">state</span>&nbsp;<span class="op" id="6564157">:=</span>&nbsp;<span class="keyword" id="6564160">range</span>&nbsp;<span class="op" id="6564166">[</span><span class="op" id="6564167">]</span><span class="builtintype" id="6564168">string</span><span class="op" id="6564174">{</span><span class="string" id="6564175">&#34;CLOSED&#34;</span><span class="op" id="6564183">,</span>&nbsp;<span class="string" id="6564185">&#34;CLOSE_WAIT&#34;</span><span class="op" id="6564197">,</span>&nbsp;<span class="string" id="6564199">&#34;LAST_ACK&#34;</span><span class="op" id="6564209">,</span>&nbsp;<span class="string" id="6564211">&#34;FIN_WAIT_1&#34;</span><span class="op" id="6564223">,</span>&nbsp;<span class="string" id="6564225">&#34;FIN_WAIT_2&#34;</span><span class="op" id="6564237">,</span>&nbsp;<span class="string" id="6564239">&#34;CLOSING&#34;</span><span class="op" id="6564248">,</span>&nbsp;<span class="string" id="6564250">&#34;TIME_WAIT&#34;</span><span class="op" id="6564261">}</span>&nbsp;<span class="op" id="6564263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6564267">nclose</span>&nbsp;<span class="op" id="6564274">+=</span>&nbsp;<span class="ident" id="6564277">bytes</span><span class="op" id="6564282">.</span><span class="ident" id="6564283">Count</span><span class="op" id="6564288">(</span><span class="ident" id="6564289">lsof</span><span class="op" id="6564293">,</span>&nbsp;<span class="op" id="6564295">[</span><span class="op" id="6564296">]</span><span class="builtintype" id="6564297">byte</span><span class="op" id="6564301">(</span><span class="ident" id="6564302">state</span><span class="op" id="6564307">)</span><span class="op" id="6564308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6564311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6564314">return</span>&nbsp;<span class="ident" id="6564321">ntcp</span><span class="op" id="6564325">,</span>&nbsp;<span class="ident" id="6564327">nopen</span><span class="op" id="6564332">,</span>&nbsp;<span class="ident" id="6564334">nclose</span><span class="op" id="6564340">,</span>&nbsp;<span class="ident" id="6564342">nil</span><br>
<span class="lineno"></span><span class="op" id="6564346">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="6564349">func</span>&nbsp;<span class="ident" id="6564354">TestDialMultiFDLeak</span><span class="op" id="6564373">(</span><span class="ident" id="6564374">t</span>&nbsp;<span class="op" id="6564376">*</span><span class="ident" id="6564377">testing</span><span class="op" id="6564384">.</span><span class="ident" id="6564385">T</span><span class="op" id="6564386">)</span>&nbsp;<span class="op" id="6564388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6564391">t</span><span class="op" id="6564392">.</span><span class="ident" id="6564393">Skip</span><span class="op" id="6564397">(</span><span class="string" id="6564398">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="6564434">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6564438">if</span>&nbsp;<span class="op" id="6564441">!</span><span class="ident" id="6564442">supportsIPv4</span>&nbsp;<span class="op" id="6564455">||</span>&nbsp;<span class="op" id="6564458">!</span><span class="ident" id="6564459">supportsIPv6</span>&nbsp;<span class="op" id="6564472">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6564476">t</span><span class="op" id="6564477">.</span><span class="ident" id="6564478">Skip</span><span class="op" id="6564482">(</span><span class="string" id="6564483">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="6564519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6564522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6564526">halfDeadServer</span>&nbsp;<span class="op" id="6564541">:=</span>&nbsp;<span class="keyword" id="6564544">func</span><span class="op" id="6564548">(</span><span class="ident" id="6564549">dss</span>&nbsp;<span class="op" id="6564553">*</span><span class="ident" id="6564554">dualStackServer</span><span class="op" id="6564569">,</span>&nbsp;<span class="ident" id="6564571">ln</span>&nbsp;<span class="ident" id="6564574">Listener</span><span class="op" id="6564582">)</span>&nbsp;<span class="op" id="6564584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6564588">for</span>&nbsp;<span class="op" id="6564592">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6564597">if</span>&nbsp;<span class="ident" id="6564600">c</span><span class="op" id="6564601">,</span>&nbsp;<span class="ident" id="6564603">err</span>&nbsp;<span class="op" id="6564607">:=</span>&nbsp;<span class="ident" id="6564610">ln</span><span class="op" id="6564612">.</span><span class="ident" id="6564613">Accept</span><span class="op" id="6564619">(</span><span class="op" id="6564620">)</span><span class="op" id="6564621">;</span>&nbsp;<span class="ident" id="6564623">err</span>&nbsp;<span class="op" id="6564627">!=</span>&nbsp;<span class="ident" id="6564630">nil</span>&nbsp;<span class="op" id="6564634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6564640">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6564650">}</span>&nbsp;<span class="keyword" id="6564652">else</span>&nbsp;<span class="op" id="6564657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6564663">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6564696">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6564739">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6564752">dss</span><span class="op" id="6564755">.</span><span class="ident" id="6564756">putConn</span><span class="op" id="6564763">(</span><span class="ident" id="6564764">c</span><span class="op" id="6564765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6564770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6564774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6564777">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6564780">dss</span><span class="op" id="6564783">,</span>&nbsp;<span class="ident" id="6564785">err</span>&nbsp;<span class="op" id="6564789">:=</span>&nbsp;<span class="ident" id="6564792">newDualStackServer</span><span class="op" id="6564810">(</span><span class="op" id="6564811">[</span><span class="op" id="6564812">]</span><span class="ident" id="6564813">streamListener</span><span class="op" id="6564827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6564831">{</span><span class="ident" id="6564832">net</span><span class="op" id="6564835">:</span>&nbsp;<span class="string" id="6564837">&#34;tcp4&#34;</span><span class="op" id="6564843">,</span>&nbsp;<span class="ident" id="6564845">addr</span><span class="op" id="6564849">:</span>&nbsp;<span class="string" id="6564851">&#34;127.0.0.1&#34;</span><span class="op" id="6564862">}</span><span class="op" id="6564863">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6564867">{</span><span class="ident" id="6564868">net</span><span class="op" id="6564871">:</span>&nbsp;<span class="string" id="6564873">&#34;tcp6&#34;</span><span class="op" id="6564879">,</span>&nbsp;<span class="ident" id="6564881">addr</span><span class="op" id="6564885">:</span>&nbsp;<span class="string" id="6564887">&#34;[::1]&#34;</span><span class="op" id="6564894">}</span><span class="op" id="6564895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6564898">}</span><span class="op" id="6564899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6564902">if</span>&nbsp;<span class="ident" id="6564905">err</span>&nbsp;<span class="op" id="6564909">!=</span>&nbsp;<span class="ident" id="6564912">nil</span>&nbsp;<span class="op" id="6564916">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6564920">t</span><span class="op" id="6564921">.</span><span class="ident" id="6564922">Fatalf</span><span class="op" id="6564928">(</span><span class="string" id="6564929">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6564960">,</span>&nbsp;<span class="ident" id="6564962">err</span><span class="op" id="6564965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6564968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6564971">defer</span>&nbsp;<span class="ident" id="6564977">dss</span><span class="op" id="6564980">.</span><span class="ident" id="6564981">teardown</span><span class="op" id="6564989">(</span><span class="op" id="6564990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6564993">if</span>&nbsp;<span class="ident" id="6564996">err</span>&nbsp;<span class="op" id="6565000">:=</span>&nbsp;<span class="ident" id="6565003">dss</span><span class="op" id="6565006">.</span><span class="ident" id="6565007">buildup</span><span class="op" id="6565014">(</span><span class="ident" id="6565015">halfDeadServer</span><span class="op" id="6565029">)</span><span class="op" id="6565030">;</span>&nbsp;<span class="ident" id="6565032">err</span>&nbsp;<span class="op" id="6565036">!=</span>&nbsp;<span class="ident" id="6565039">nil</span>&nbsp;<span class="op" id="6565043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6565047">t</span><span class="op" id="6565048">.</span><span class="ident" id="6565049">Fatalf</span><span class="op" id="6565055">(</span><span class="string" id="6565056">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6565092">,</span>&nbsp;<span class="ident" id="6565094">err</span><span class="op" id="6565097">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6565100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6565104">_</span><span class="op" id="6565105">,</span>&nbsp;<span class="ident" id="6565107">before</span><span class="op" id="6565113">,</span>&nbsp;<span class="ident" id="6565115">_</span><span class="op" id="6565116">,</span>&nbsp;<span class="ident" id="6565118">err</span>&nbsp;<span class="op" id="6565122">:=</span>&nbsp;<span class="ident" id="6565125">numTCP</span><span class="op" id="6565131">(</span><span class="op" id="6565132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6565135">if</span>&nbsp;<span class="ident" id="6565138">err</span>&nbsp;<span class="op" id="6565142">!=</span>&nbsp;<span class="ident" id="6565145">nil</span>&nbsp;<span class="op" id="6565149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6565153">t</span><span class="op" id="6565154">.</span><span class="ident" id="6565155">Skipf</span><span class="op" id="6565160">(</span><span class="string" id="6565161">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="6565211">,</span>&nbsp;<span class="ident" id="6565213">err</span><span class="op" id="6565216">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6565219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6565223">var</span>&nbsp;<span class="ident" id="6565227">wg</span>&nbsp;<span class="ident" id="6565230">sync</span><span class="op" id="6565234">.</span><span class="ident" id="6565235">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6565246">portnum</span><span class="op" id="6565253">,</span>&nbsp;<span class="ident" id="6565255">_</span><span class="op" id="6565256">,</span>&nbsp;<span class="ident" id="6565258">_</span>&nbsp;<span class="op" id="6565260">:=</span>&nbsp;<span class="ident" id="6565263">dtoi</span><span class="op" id="6565267">(</span><span class="ident" id="6565268">dss</span><span class="op" id="6565271">.</span><span class="ident" id="6565272">port</span><span class="op" id="6565276">,</span>&nbsp;<span class="num" id="6565278">0</span><span class="op" id="6565279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6565282">ras</span>&nbsp;<span class="op" id="6565286">:=</span>&nbsp;<span class="ident" id="6565289">addrList</span><span class="op" id="6565297">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6565301">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6565354">&amp;</span><span class="ident" id="6565355">TCPAddr</span><span class="op" id="6565362">{</span><span class="ident" id="6565363">IP</span><span class="op" id="6565365">:</span>&nbsp;<span class="ident" id="6565367">IPv4</span><span class="op" id="6565371">(</span><span class="num" id="6565372">198</span><span class="op" id="6565375">,</span>&nbsp;<span class="num" id="6565377">18</span><span class="op" id="6565379">,</span>&nbsp;<span class="num" id="6565381">0</span><span class="op" id="6565382">,</span>&nbsp;<span class="num" id="6565384">254</span><span class="op" id="6565387">)</span><span class="op" id="6565388">,</span>&nbsp;<span class="ident" id="6565390">Port</span><span class="op" id="6565394">:</span>&nbsp;<span class="ident" id="6565396">portnum</span><span class="op" id="6565403">}</span><span class="op" id="6565404">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6565408">&amp;</span><span class="ident" id="6565409">TCPAddr</span><span class="op" id="6565416">{</span><span class="ident" id="6565417">IP</span><span class="op" id="6565419">:</span>&nbsp;<span class="ident" id="6565421">ParseIP</span><span class="op" id="6565428">(</span><span class="string" id="6565429">&#34;2001:2::254&#34;</span><span class="op" id="6565442">)</span><span class="op" id="6565443">,</span>&nbsp;<span class="ident" id="6565445">Port</span><span class="op" id="6565449">:</span>&nbsp;<span class="ident" id="6565451">portnum</span><span class="op" id="6565458">}</span><span class="op" id="6565459">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6565464">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6565501">&amp;</span><span class="ident" id="6565502">TCPAddr</span><span class="op" id="6565509">{</span><span class="ident" id="6565510">IP</span><span class="op" id="6565512">:</span>&nbsp;<span class="ident" id="6565514">IPv4</span><span class="op" id="6565518">(</span><span class="num" id="6565519">127</span><span class="op" id="6565522">,</span>&nbsp;<span class="num" id="6565524">0</span><span class="op" id="6565525">,</span>&nbsp;<span class="num" id="6565527">0</span><span class="op" id="6565528">,</span>&nbsp;<span class="num" id="6565530">1</span><span class="op" id="6565531">)</span><span class="op" id="6565532">,</span>&nbsp;<span class="ident" id="6565534">Port</span><span class="op" id="6565538">:</span>&nbsp;<span class="ident" id="6565540">portnum</span><span class="op" id="6565547">}</span><span class="op" id="6565548">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6565552">&amp;</span><span class="ident" id="6565553">TCPAddr</span><span class="op" id="6565560">{</span><span class="ident" id="6565561">IP</span><span class="op" id="6565563">:</span>&nbsp;<span class="ident" id="6565565">IPv6loopback</span><span class="op" id="6565577">,</span>&nbsp;<span class="ident" id="6565579">Port</span><span class="op" id="6565583">:</span>&nbsp;<span class="ident" id="6565585">portnum</span><span class="op" id="6565592">}</span><span class="op" id="6565593">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6565598">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6565650">&amp;</span><span class="ident" id="6565651">TCPAddr</span><span class="op" id="6565658">{</span><span class="ident" id="6565659">IP</span><span class="op" id="6565661">:</span>&nbsp;<span class="ident" id="6565663">IPv4</span><span class="op" id="6565667">(</span><span class="num" id="6565668">127</span><span class="op" id="6565671">,</span>&nbsp;<span class="num" id="6565673">0</span><span class="op" id="6565674">,</span>&nbsp;<span class="num" id="6565676">0</span><span class="op" id="6565677">,</span>&nbsp;<span class="num" id="6565679">1</span><span class="op" id="6565680">)</span><span class="op" id="6565681">,</span>&nbsp;<span class="ident" id="6565683">Port</span><span class="op" id="6565687">:</span>&nbsp;<span class="ident" id="6565689">portnum</span><span class="op" id="6565696">}</span><span class="op" id="6565697">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6565701">&amp;</span><span class="ident" id="6565702">TCPAddr</span><span class="op" id="6565709">{</span><span class="ident" id="6565710">IP</span><span class="op" id="6565712">:</span>&nbsp;<span class="ident" id="6565714">IPv6loopback</span><span class="op" id="6565726">,</span>&nbsp;<span class="ident" id="6565728">Port</span><span class="op" id="6565732">:</span>&nbsp;<span class="ident" id="6565734">portnum</span><span class="op" id="6565741">}</span><span class="op" id="6565742">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6565745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6565748">const</span>&nbsp;<span class="ident" id="6565754">T1</span>&nbsp;<span class="op" id="6565757">=</span>&nbsp;<span class="num" id="6565759">10</span>&nbsp;<span class="op" id="6565762">*</span>&nbsp;<span class="ident" id="6565764">time</span><span class="op" id="6565768">.</span><span class="ident" id="6565769">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6565782">const</span>&nbsp;<span class="ident" id="6565788">T2</span>&nbsp;<span class="op" id="6565791">=</span>&nbsp;<span class="num" id="6565793">2</span>&nbsp;<span class="op" id="6565795">*</span>&nbsp;<span class="ident" id="6565797">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6565801">const</span>&nbsp;<span class="ident" id="6565807">N</span>&nbsp;<span class="op" id="6565809">=</span>&nbsp;<span class="num" id="6565811">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6565815">for</span>&nbsp;<span class="ident" id="6565819">i</span>&nbsp;<span class="op" id="6565821">:=</span>&nbsp;<span class="num" id="6565824">0</span><span class="op" id="6565825">;</span>&nbsp;<span class="ident" id="6565827">i</span>&nbsp;<span class="op" id="6565829">&lt;</span>&nbsp;<span class="ident" id="6565831">N</span><span class="op" id="6565832">;</span>&nbsp;<span class="ident" id="6565834">i</span><span class="op" id="6565835">++</span>&nbsp;<span class="op" id="6565838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6565842">wg</span><span class="op" id="6565844">.</span><span class="ident" id="6565845">Add</span><span class="op" id="6565848">(</span><span class="num" id="6565849">1</span><span class="op" id="6565850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6565854">go</span>&nbsp;<span class="keyword" id="6565857">func</span><span class="op" id="6565861">(</span><span class="op" id="6565862">)</span>&nbsp;<span class="op" id="6565864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6565869">defer</span>&nbsp;<span class="ident" id="6565875">wg</span><span class="op" id="6565877">.</span><span class="ident" id="6565878">Done</span><span class="op" id="6565882">(</span><span class="op" id="6565883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6565888">if</span>&nbsp;<span class="ident" id="6565891">c</span><span class="op" id="6565892">,</span>&nbsp;<span class="ident" id="6565894">err</span>&nbsp;<span class="op" id="6565898">:=</span>&nbsp;<span class="ident" id="6565901">dialMulti</span><span class="op" id="6565910">(</span><span class="string" id="6565911">&#34;tcp&#34;</span><span class="op" id="6565916">,</span>&nbsp;<span class="string" id="6565918">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="6565938">,</span>&nbsp;<span class="ident" id="6565940">nil</span><span class="op" id="6565943">,</span>&nbsp;<span class="ident" id="6565945">ras</span><span class="op" id="6565948">,</span>&nbsp;<span class="ident" id="6565950">time</span><span class="op" id="6565954">.</span><span class="ident" id="6565955">Now</span><span class="op" id="6565958">(</span><span class="op" id="6565959">)</span><span class="op" id="6565960">.</span><span class="ident" id="6565961">Add</span><span class="op" id="6565964">(</span><span class="ident" id="6565965">T1</span><span class="op" id="6565967">)</span><span class="op" id="6565968">)</span><span class="op" id="6565969">;</span>&nbsp;<span class="ident" id="6565971">err</span>&nbsp;<span class="op" id="6565975">==</span>&nbsp;<span class="ident" id="6565978">nil</span>&nbsp;<span class="op" id="6565982">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6565988">c</span><span class="op" id="6565989">.</span><span class="ident" id="6565990">Close</span><span class="op" id="6565995">(</span><span class="op" id="6565996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6566001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6566005">}</span><span class="op" id="6566006">(</span><span class="op" id="6566007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6566010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566013">wg</span><span class="op" id="6566015">.</span><span class="ident" id="6566016">Wait</span><span class="op" id="6566020">(</span><span class="op" id="6566021">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566024">time</span><span class="op" id="6566028">.</span><span class="ident" id="6566029">Sleep</span><span class="op" id="6566034">(</span><span class="ident" id="6566035">T2</span><span class="op" id="6566037">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566041">ntcp</span><span class="op" id="6566045">,</span>&nbsp;<span class="ident" id="6566047">after</span><span class="op" id="6566052">,</span>&nbsp;<span class="ident" id="6566054">nclose</span><span class="op" id="6566060">,</span>&nbsp;<span class="ident" id="6566062">err</span>&nbsp;<span class="op" id="6566066">:=</span>&nbsp;<span class="ident" id="6566069">numTCP</span><span class="op" id="6566075">(</span><span class="op" id="6566076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566079">if</span>&nbsp;<span class="ident" id="6566082">err</span>&nbsp;<span class="op" id="6566086">!=</span>&nbsp;<span class="ident" id="6566089">nil</span>&nbsp;<span class="op" id="6566093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566097">t</span><span class="op" id="6566098">.</span><span class="ident" id="6566099">Skipf</span><span class="op" id="6566104">(</span><span class="string" id="6566105">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="6566155">,</span>&nbsp;<span class="ident" id="6566157">err</span><span class="op" id="6566160">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6566163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566166">t</span><span class="op" id="6566167">.</span><span class="ident" id="6566168">Logf</span><span class="op" id="6566172">(</span><span class="string" id="6566173">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="6566232">,</span>&nbsp;<span class="ident" id="6566234">ntcp</span><span class="op" id="6566238">,</span>&nbsp;<span class="ident" id="6566240">after</span><span class="op" id="6566245">,</span>&nbsp;<span class="ident" id="6566247">nclose</span><span class="op" id="6566253">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566257">if</span>&nbsp;<span class="ident" id="6566260">after</span>&nbsp;<span class="op" id="6566266">!=</span>&nbsp;<span class="ident" id="6566269">before</span>&nbsp;<span class="op" id="6566276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566280">t</span><span class="op" id="6566281">.</span><span class="ident" id="6566282">Fatalf</span><span class="op" id="6566288">(</span><span class="string" id="6566289">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="6566324">,</span>&nbsp;<span class="ident" id="6566326">after</span><span class="op" id="6566331">,</span>&nbsp;<span class="ident" id="6566333">before</span><span class="op" id="6566339">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6566342">}</span><br>
<span class="lineno"></span><span class="op" id="6566344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6566347">func</span>&nbsp;<span class="ident" id="6566352">numFD</span><span class="op" id="6566357">(</span><span class="op" id="6566358">)</span>&nbsp;<span class="builtintype" id="6566360">int</span>&nbsp;<span class="op" id="6566364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566367">if</span>&nbsp;<span class="ident" id="6566370">runtime</span><span class="op" id="6566377">.</span><span class="ident" id="6566378">GOOS</span>&nbsp;<span class="op" id="6566383">==</span>&nbsp;<span class="string" id="6566386">&#34;linux&#34;</span>&nbsp;<span class="op" id="6566394">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566398">f</span><span class="op" id="6566399">,</span>&nbsp;<span class="ident" id="6566401">err</span>&nbsp;<span class="op" id="6566405">:=</span>&nbsp;<span class="ident" id="6566408">os</span><span class="op" id="6566410">.</span><span class="ident" id="6566411">Open</span><span class="op" id="6566415">(</span><span class="string" id="6566416">&#34;/proc/self/fd&#34;</span><span class="op" id="6566431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566435">if</span>&nbsp;<span class="ident" id="6566438">err</span>&nbsp;<span class="op" id="6566442">!=</span>&nbsp;<span class="ident" id="6566445">nil</span>&nbsp;<span class="op" id="6566449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6566454">panic</span><span class="op" id="6566459">(</span><span class="ident" id="6566460">err</span><span class="op" id="6566463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6566467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566471">defer</span>&nbsp;<span class="ident" id="6566477">f</span><span class="op" id="6566478">.</span><span class="ident" id="6566479">Close</span><span class="op" id="6566484">(</span><span class="op" id="6566485">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566489">names</span><span class="op" id="6566494">,</span>&nbsp;<span class="ident" id="6566496">err</span>&nbsp;<span class="op" id="6566500">:=</span>&nbsp;<span class="ident" id="6566503">f</span><span class="op" id="6566504">.</span><span class="ident" id="6566505">Readdirnames</span><span class="op" id="6566517">(</span><span class="num" id="6566518">0</span><span class="op" id="6566519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566523">if</span>&nbsp;<span class="ident" id="6566526">err</span>&nbsp;<span class="op" id="6566530">!=</span>&nbsp;<span class="ident" id="6566533">nil</span>&nbsp;<span class="op" id="6566537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6566542">panic</span><span class="op" id="6566547">(</span><span class="ident" id="6566548">err</span><span class="op" id="6566551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6566555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566559">return</span>&nbsp;<span class="builtinfunc" id="6566566">len</span><span class="op" id="6566569">(</span><span class="ident" id="6566570">names</span><span class="op" id="6566575">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6566578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6566581">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6566637">panic</span><span class="op" id="6566642">(</span><span class="string" id="6566643">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="6566672">+</span>&nbsp;<span class="ident" id="6566674">runtime</span><span class="op" id="6566681">.</span><span class="ident" id="6566682">GOOS</span><span class="op" id="6566686">)</span><br>
<span class="lineno"></span><span class="op" id="6566688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="6566691">func</span>&nbsp;<span class="ident" id="6566696">TestDialer</span><span class="op" id="6566706">(</span><span class="ident" id="6566707">t</span>&nbsp;<span class="op" id="6566709">*</span><span class="ident" id="6566710">testing</span><span class="op" id="6566717">.</span><span class="ident" id="6566718">T</span><span class="op" id="6566719">)</span>&nbsp;<span class="op" id="6566721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566724">ln</span><span class="op" id="6566726">,</span>&nbsp;<span class="ident" id="6566728">err</span>&nbsp;<span class="op" id="6566732">:=</span>&nbsp;<span class="ident" id="6566735">Listen</span><span class="op" id="6566741">(</span><span class="string" id="6566742">&#34;tcp4&#34;</span><span class="op" id="6566748">,</span>&nbsp;<span class="string" id="6566750">&#34;127.0.0.1:0&#34;</span><span class="op" id="6566763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566766">if</span>&nbsp;<span class="ident" id="6566769">err</span>&nbsp;<span class="op" id="6566773">!=</span>&nbsp;<span class="ident" id="6566776">nil</span>&nbsp;<span class="op" id="6566780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566784">t</span><span class="op" id="6566785">.</span><span class="ident" id="6566786">Fatalf</span><span class="op" id="6566792">(</span><span class="string" id="6566793">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6566812">,</span>&nbsp;<span class="ident" id="6566814">err</span><span class="op" id="6566817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6566820">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566823">defer</span>&nbsp;<span class="ident" id="6566829">ln</span><span class="op" id="6566831">.</span><span class="ident" id="6566832">Close</span><span class="op" id="6566837">(</span><span class="op" id="6566838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566841">ch</span>&nbsp;<span class="op" id="6566844">:=</span>&nbsp;<span class="builtinfunc" id="6566847">make</span><span class="op" id="6566851">(</span><span class="keyword" id="6566852">chan</span>&nbsp;<span class="builtintype" id="6566857">error</span><span class="op" id="6566862">,</span>&nbsp;<span class="num" id="6566864">1</span><span class="op" id="6566865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566868">go</span>&nbsp;<span class="keyword" id="6566871">func</span><span class="op" id="6566875">(</span><span class="op" id="6566876">)</span>&nbsp;<span class="op" id="6566878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566882">c</span><span class="op" id="6566883">,</span>&nbsp;<span class="ident" id="6566885">err</span>&nbsp;<span class="op" id="6566889">:=</span>&nbsp;<span class="ident" id="6566892">ln</span><span class="op" id="6566894">.</span><span class="ident" id="6566895">Accept</span><span class="op" id="6566901">(</span><span class="op" id="6566902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566906">if</span>&nbsp;<span class="ident" id="6566909">err</span>&nbsp;<span class="op" id="6566913">!=</span>&nbsp;<span class="ident" id="6566916">nil</span>&nbsp;<span class="op" id="6566920">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6566925">ch</span>&nbsp;<span class="op" id="6566928">&lt;-</span>&nbsp;<span class="ident" id="6566931">fmt</span><span class="op" id="6566934">.</span><span class="ident" id="6566935">Errorf</span><span class="op" id="6566941">(</span><span class="string" id="6566942">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6566961">,</span>&nbsp;<span class="ident" id="6566963">err</span><span class="op" id="6566966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566971">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6566980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6566984">defer</span>&nbsp;<span class="ident" id="6566990">c</span><span class="op" id="6566991">.</span><span class="ident" id="6566992">Close</span><span class="op" id="6566997">(</span><span class="op" id="6566998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567002">ch</span>&nbsp;<span class="op" id="6567005">&lt;-</span>&nbsp;<span class="ident" id="6567008">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567013">}</span><span class="op" id="6567014">(</span><span class="op" id="6567015">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567019">laddr</span><span class="op" id="6567024">,</span>&nbsp;<span class="ident" id="6567026">err</span>&nbsp;<span class="op" id="6567030">:=</span>&nbsp;<span class="ident" id="6567033">ResolveTCPAddr</span><span class="op" id="6567047">(</span><span class="string" id="6567048">&#34;tcp4&#34;</span><span class="op" id="6567054">,</span>&nbsp;<span class="string" id="6567056">&#34;127.0.0.1:0&#34;</span><span class="op" id="6567069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6567072">if</span>&nbsp;<span class="ident" id="6567075">err</span>&nbsp;<span class="op" id="6567079">!=</span>&nbsp;<span class="ident" id="6567082">nil</span>&nbsp;<span class="op" id="6567086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567090">t</span><span class="op" id="6567091">.</span><span class="ident" id="6567092">Fatalf</span><span class="op" id="6567098">(</span><span class="string" id="6567099">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6567126">,</span>&nbsp;<span class="ident" id="6567128">err</span><span class="op" id="6567131">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567137">d</span>&nbsp;<span class="op" id="6567139">:=</span>&nbsp;<span class="op" id="6567142">&amp;</span><span class="ident" id="6567143">Dialer</span><span class="op" id="6567149">{</span><span class="ident" id="6567150">LocalAddr</span><span class="op" id="6567159">:</span>&nbsp;<span class="ident" id="6567161">laddr</span><span class="op" id="6567166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567169">c</span><span class="op" id="6567170">,</span>&nbsp;<span class="ident" id="6567172">err</span>&nbsp;<span class="op" id="6567176">:=</span>&nbsp;<span class="ident" id="6567179">d</span><span class="op" id="6567180">.</span><span class="ident" id="6567181">Dial</span><span class="op" id="6567185">(</span><span class="string" id="6567186">&#34;tcp4&#34;</span><span class="op" id="6567192">,</span>&nbsp;<span class="ident" id="6567194">ln</span><span class="op" id="6567196">.</span><span class="ident" id="6567197">Addr</span><span class="op" id="6567201">(</span><span class="op" id="6567202">)</span><span class="op" id="6567203">.</span><span class="ident" id="6567204">String</span><span class="op" id="6567210">(</span><span class="op" id="6567211">)</span><span class="op" id="6567212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6567215">if</span>&nbsp;<span class="ident" id="6567218">err</span>&nbsp;<span class="op" id="6567222">!=</span>&nbsp;<span class="ident" id="6567225">nil</span>&nbsp;<span class="op" id="6567229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567233">t</span><span class="op" id="6567234">.</span><span class="ident" id="6567235">Fatalf</span><span class="op" id="6567241">(</span><span class="string" id="6567242">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6567259">,</span>&nbsp;<span class="ident" id="6567261">err</span><span class="op" id="6567264">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6567270">defer</span>&nbsp;<span class="ident" id="6567276">c</span><span class="op" id="6567277">.</span><span class="ident" id="6567278">Close</span><span class="op" id="6567283">(</span><span class="op" id="6567284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567287">c</span><span class="op" id="6567288">.</span><span class="ident" id="6567289">Read</span><span class="op" id="6567293">(</span><span class="builtinfunc" id="6567294">make</span><span class="op" id="6567298">(</span><span class="op" id="6567299">[</span><span class="op" id="6567300">]</span><span class="builtintype" id="6567301">byte</span><span class="op" id="6567305">,</span>&nbsp;<span class="num" id="6567307">1</span><span class="op" id="6567308">)</span><span class="op" id="6567309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567312">err</span>&nbsp;<span class="op" id="6567316">=</span>&nbsp;<span class="op" id="6567318">&lt;-</span><span class="ident" id="6567320">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6567324">if</span>&nbsp;<span class="ident" id="6567327">err</span>&nbsp;<span class="op" id="6567331">!=</span>&nbsp;<span class="ident" id="6567334">nil</span>&nbsp;<span class="op" id="6567338">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567342">t</span><span class="op" id="6567343">.</span><span class="ident" id="6567344">Error</span><span class="op" id="6567349">(</span><span class="ident" id="6567350">err</span><span class="op" id="6567353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567356">}</span><br>
<span class="lineno"></span><span class="op" id="6567358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6567361">func</span>&nbsp;<span class="ident" id="6567366">TestDialDualStackLocalhost</span><span class="op" id="6567392">(</span><span class="ident" id="6567393">t</span>&nbsp;<span class="op" id="6567395">*</span><span class="ident" id="6567396">testing</span><span class="op" id="6567403">.</span><span class="ident" id="6567404">T</span><span class="op" id="6567405">)</span>&nbsp;<span class="op" id="6567407">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6567410">switch</span>&nbsp;<span class="ident" id="6567417">runtime</span><span class="op" id="6567424">.</span><span class="ident" id="6567425">GOOS</span>&nbsp;<span class="op" id="6567430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6567433">case</span>&nbsp;<span class="string" id="6567438">&#34;nacl&#34;</span><span class="op" id="6567444">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567448">t</span><span class="op" id="6567449">.</span><span class="ident" id="6567450">Skipf</span><span class="op" id="6567455">(</span><span class="string" id="6567456">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6567477">,</span>&nbsp;<span class="ident" id="6567479">runtime</span><span class="op" id="6567486">.</span><span class="ident" id="6567487">GOOS</span><span class="op" id="6567491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6567498">if</span>&nbsp;<span class="ident" id="6567501">ips</span><span class="op" id="6567504">,</span>&nbsp;<span class="ident" id="6567506">err</span>&nbsp;<span class="op" id="6567510">:=</span>&nbsp;<span class="ident" id="6567513">LookupIP</span><span class="op" id="6567521">(</span><span class="string" id="6567522">&#34;localhost&#34;</span><span class="op" id="6567533">)</span><span class="op" id="6567534">;</span>&nbsp;<span class="ident" id="6567536">err</span>&nbsp;<span class="op" id="6567540">!=</span>&nbsp;<span class="ident" id="6567543">nil</span>&nbsp;<span class="op" id="6567547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567551">t</span><span class="op" id="6567552">.</span><span class="ident" id="6567553">Fatalf</span><span class="op" id="6567559">(</span><span class="string" id="6567560">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6567581">,</span>&nbsp;<span class="ident" id="6567583">err</span><span class="op" id="6567586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567589">}</span>&nbsp;<span class="keyword" id="6567591">else</span>&nbsp;<span class="keyword" id="6567596">if</span>&nbsp;<span class="builtinfunc" id="6567599">len</span><span class="op" id="6567602">(</span><span class="ident" id="6567603">ips</span><span class="op" id="6567606">)</span>&nbsp;<span class="op" id="6567608">&lt;</span>&nbsp;<span class="num" id="6567610">2</span>&nbsp;<span class="op" id="6567612">||</span>&nbsp;<span class="op" id="6567615">!</span><span class="ident" id="6567616">supportsIPv4</span>&nbsp;<span class="op" id="6567629">||</span>&nbsp;<span class="op" id="6567632">!</span><span class="ident" id="6567633">supportsIPv6</span>&nbsp;<span class="op" id="6567646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567650">t</span><span class="op" id="6567651">.</span><span class="ident" id="6567652">Skip</span><span class="op" id="6567656">(</span><span class="string" id="6567657">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="6567729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567732">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567736">touchAndByeServer</span>&nbsp;<span class="op" id="6567754">:=</span>&nbsp;<span class="keyword" id="6567757">func</span><span class="op" id="6567761">(</span><span class="ident" id="6567762">dss</span>&nbsp;<span class="op" id="6567766">*</span><span class="ident" id="6567767">dualStackServer</span><span class="op" id="6567782">,</span>&nbsp;<span class="ident" id="6567784">ln</span>&nbsp;<span class="ident" id="6567787">Listener</span><span class="op" id="6567795">)</span>&nbsp;<span class="op" id="6567797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6567801">for</span>&nbsp;<span class="op" id="6567805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6567810">if</span>&nbsp;<span class="ident" id="6567813">c</span><span class="op" id="6567814">,</span>&nbsp;<span class="ident" id="6567816">err</span>&nbsp;<span class="op" id="6567820">:=</span>&nbsp;<span class="ident" id="6567823">ln</span><span class="op" id="6567825">.</span><span class="ident" id="6567826">Accept</span><span class="op" id="6567832">(</span><span class="op" id="6567833">)</span><span class="op" id="6567834">;</span>&nbsp;<span class="ident" id="6567836">err</span>&nbsp;<span class="op" id="6567840">!=</span>&nbsp;<span class="ident" id="6567843">nil</span>&nbsp;<span class="op" id="6567847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6567853">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567863">}</span>&nbsp;<span class="keyword" id="6567865">else</span>&nbsp;<span class="op" id="6567870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567876">c</span><span class="op" id="6567877">.</span><span class="ident" id="6567878">Close</span><span class="op" id="6567883">(</span><span class="op" id="6567884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567896">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6567899">dss</span><span class="op" id="6567902">,</span>&nbsp;<span class="ident" id="6567904">err</span>&nbsp;<span class="op" id="6567908">:=</span>&nbsp;<span class="ident" id="6567911">newDualStackServer</span><span class="op" id="6567929">(</span><span class="op" id="6567930">[</span><span class="op" id="6567931">]</span><span class="ident" id="6567932">streamListener</span><span class="op" id="6567946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567950">{</span><span class="ident" id="6567951">net</span><span class="op" id="6567954">:</span>&nbsp;<span class="string" id="6567956">&#34;tcp4&#34;</span><span class="op" id="6567962">,</span>&nbsp;<span class="ident" id="6567964">addr</span><span class="op" id="6567968">:</span>&nbsp;<span class="string" id="6567970">&#34;127.0.0.1&#34;</span><span class="op" id="6567981">}</span><span class="op" id="6567982">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6567986">{</span><span class="ident" id="6567987">net</span><span class="op" id="6567990">:</span>&nbsp;<span class="string" id="6567992">&#34;tcp6&#34;</span><span class="op" id="6567998">,</span>&nbsp;<span class="ident" id="6568000">addr</span><span class="op" id="6568004">:</span>&nbsp;<span class="string" id="6568006">&#34;[::1]&#34;</span><span class="op" id="6568013">}</span><span class="op" id="6568014">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568017">}</span><span class="op" id="6568018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568021">if</span>&nbsp;<span class="ident" id="6568024">err</span>&nbsp;<span class="op" id="6568028">!=</span>&nbsp;<span class="ident" id="6568031">nil</span>&nbsp;<span class="op" id="6568035">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568039">t</span><span class="op" id="6568040">.</span><span class="ident" id="6568041">Fatalf</span><span class="op" id="6568047">(</span><span class="string" id="6568048">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6568079">,</span>&nbsp;<span class="ident" id="6568081">err</span><span class="op" id="6568084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568090">defer</span>&nbsp;<span class="ident" id="6568096">dss</span><span class="op" id="6568099">.</span><span class="ident" id="6568100">teardown</span><span class="op" id="6568108">(</span><span class="op" id="6568109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568112">if</span>&nbsp;<span class="ident" id="6568115">err</span>&nbsp;<span class="op" id="6568119">:=</span>&nbsp;<span class="ident" id="6568122">dss</span><span class="op" id="6568125">.</span><span class="ident" id="6568126">buildup</span><span class="op" id="6568133">(</span><span class="ident" id="6568134">touchAndByeServer</span><span class="op" id="6568151">)</span><span class="op" id="6568152">;</span>&nbsp;<span class="ident" id="6568154">err</span>&nbsp;<span class="op" id="6568158">!=</span>&nbsp;<span class="ident" id="6568161">nil</span>&nbsp;<span class="op" id="6568165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568169">t</span><span class="op" id="6568170">.</span><span class="ident" id="6568171">Fatalf</span><span class="op" id="6568177">(</span><span class="string" id="6568178">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6568214">,</span>&nbsp;<span class="ident" id="6568216">err</span><span class="op" id="6568219">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568226">d</span>&nbsp;<span class="op" id="6568228">:=</span>&nbsp;<span class="op" id="6568231">&amp;</span><span class="ident" id="6568232">Dialer</span><span class="op" id="6568238">{</span><span class="ident" id="6568239">DualStack</span><span class="op" id="6568248">:</span>&nbsp;<span class="builtintype" id="6568250">true</span><span class="op" id="6568254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568257">for</span>&nbsp;<span class="keyword" id="6568261">range</span>&nbsp;<span class="ident" id="6568267">dss</span><span class="op" id="6568270">.</span><span class="ident" id="6568271">lns</span>&nbsp;<span class="op" id="6568275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568279">if</span>&nbsp;<span class="ident" id="6568282">c</span><span class="op" id="6568283">,</span>&nbsp;<span class="ident" id="6568285">err</span>&nbsp;<span class="op" id="6568289">:=</span>&nbsp;<span class="ident" id="6568292">d</span><span class="op" id="6568293">.</span><span class="ident" id="6568294">Dial</span><span class="op" id="6568298">(</span><span class="string" id="6568299">&#34;tcp&#34;</span><span class="op" id="6568304">,</span>&nbsp;<span class="string" id="6568306">&#34;localhost:&#34;</span><span class="op" id="6568318">+</span><span class="ident" id="6568319">dss</span><span class="op" id="6568322">.</span><span class="ident" id="6568323">port</span><span class="op" id="6568327">)</span><span class="op" id="6568328">;</span>&nbsp;<span class="ident" id="6568330">err</span>&nbsp;<span class="op" id="6568334">!=</span>&nbsp;<span class="ident" id="6568337">nil</span>&nbsp;<span class="op" id="6568341">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568346">t</span><span class="op" id="6568347">.</span><span class="ident" id="6568348">Errorf</span><span class="op" id="6568354">(</span><span class="string" id="6568355">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6568372">,</span>&nbsp;<span class="ident" id="6568374">err</span><span class="op" id="6568377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568381">}</span>&nbsp;<span class="keyword" id="6568383">else</span>&nbsp;<span class="op" id="6568388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568393">if</span>&nbsp;<span class="ident" id="6568396">addr</span>&nbsp;<span class="op" id="6568401">:=</span>&nbsp;<span class="ident" id="6568404">c</span><span class="op" id="6568405">.</span><span class="ident" id="6568406">LocalAddr</span><span class="op" id="6568415">(</span><span class="op" id="6568416">)</span><span class="op" id="6568417">.</span><span class="op" id="6568418">(</span><span class="op" id="6568419">*</span><span class="ident" id="6568420">TCPAddr</span><span class="op" id="6568427">)</span><span class="op" id="6568428">;</span>&nbsp;<span class="ident" id="6568430">addr</span><span class="op" id="6568434">.</span><span class="ident" id="6568435">IP</span><span class="op" id="6568437">.</span><span class="ident" id="6568438">To4</span><span class="op" id="6568441">(</span><span class="op" id="6568442">)</span>&nbsp;<span class="op" id="6568444">!=</span>&nbsp;<span class="ident" id="6568447">nil</span>&nbsp;<span class="op" id="6568451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568457">dss</span><span class="op" id="6568460">.</span><span class="ident" id="6568461">teardownNetwork</span><span class="op" id="6568476">(</span><span class="string" id="6568477">&#34;tcp4&#34;</span><span class="op" id="6568483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568488">}</span>&nbsp;<span class="keyword" id="6568490">else</span>&nbsp;<span class="keyword" id="6568495">if</span>&nbsp;<span class="ident" id="6568498">addr</span><span class="op" id="6568502">.</span><span class="ident" id="6568503">IP</span><span class="op" id="6568505">.</span><span class="ident" id="6568506">To16</span><span class="op" id="6568510">(</span><span class="op" id="6568511">)</span>&nbsp;<span class="op" id="6568513">!=</span>&nbsp;<span class="ident" id="6568516">nil</span>&nbsp;<span class="op" id="6568520">&amp;&amp;</span>&nbsp;<span class="ident" id="6568523">addr</span><span class="op" id="6568527">.</span><span class="ident" id="6568528">IP</span><span class="op" id="6568530">.</span><span class="ident" id="6568531">To4</span><span class="op" id="6568534">(</span><span class="op" id="6568535">)</span>&nbsp;<span class="op" id="6568537">==</span>&nbsp;<span class="ident" id="6568540">nil</span>&nbsp;<span class="op" id="6568544">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568550">dss</span><span class="op" id="6568553">.</span><span class="ident" id="6568554">teardownNetwork</span><span class="op" id="6568569">(</span><span class="string" id="6568570">&#34;tcp6&#34;</span><span class="op" id="6568576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568586">c</span><span class="op" id="6568587">.</span><span class="ident" id="6568588">Close</span><span class="op" id="6568593">(</span><span class="op" id="6568594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568601">}</span><br>
<span class="lineno">515</span><span class="op" id="6568603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6568606">func</span>&nbsp;<span class="ident" id="6568611">TestDialerKeepAlive</span><span class="op" id="6568630">(</span><span class="ident" id="6568631">t</span>&nbsp;<span class="op" id="6568633">*</span><span class="ident" id="6568634">testing</span><span class="op" id="6568641">.</span><span class="ident" id="6568642">T</span><span class="op" id="6568643">)</span>&nbsp;<span class="op" id="6568645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568648">ln</span>&nbsp;<span class="op" id="6568651">:=</span>&nbsp;<span class="ident" id="6568654">newLocalListener</span><span class="op" id="6568670">(</span><span class="ident" id="6568671">t</span><span class="op" id="6568672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568675">defer</span>&nbsp;<span class="ident" id="6568681">ln</span><span class="op" id="6568683">.</span><span class="ident" id="6568684">Close</span><span class="op" id="6568689">(</span><span class="op" id="6568690">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568693">defer</span>&nbsp;<span class="keyword" id="6568699">func</span><span class="op" id="6568703">(</span><span class="op" id="6568704">)</span>&nbsp;<span class="op" id="6568706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568710">testHookSetKeepAlive</span>&nbsp;<span class="op" id="6568731">=</span>&nbsp;<span class="keyword" id="6568733">func</span><span class="op" id="6568737">(</span><span class="op" id="6568738">)</span>&nbsp;<span class="op" id="6568740">{</span><span class="op" id="6568741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568744">}</span><span class="op" id="6568745">(</span><span class="op" id="6568746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568749">go</span>&nbsp;<span class="keyword" id="6568752">func</span><span class="op" id="6568756">(</span><span class="op" id="6568757">)</span>&nbsp;<span class="op" id="6568759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568763">for</span>&nbsp;<span class="op" id="6568767">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568772">c</span><span class="op" id="6568773">,</span>&nbsp;<span class="ident" id="6568775">err</span>&nbsp;<span class="op" id="6568779">:=</span>&nbsp;<span class="ident" id="6568782">ln</span><span class="op" id="6568784">.</span><span class="ident" id="6568785">Accept</span><span class="op" id="6568791">(</span><span class="op" id="6568792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568797">if</span>&nbsp;<span class="ident" id="6568800">err</span>&nbsp;<span class="op" id="6568804">!=</span>&nbsp;<span class="ident" id="6568807">nil</span>&nbsp;<span class="op" id="6568811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568817">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568832">c</span><span class="op" id="6568833">.</span><span class="ident" id="6568834">Close</span><span class="op" id="6568839">(</span><span class="op" id="6568840">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6568847">}</span><span class="op" id="6568848">(</span><span class="op" id="6568849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568852">for</span>&nbsp;<span class="ident" id="6568856">_</span><span class="op" id="6568857">,</span>&nbsp;<span class="ident" id="6568859">keepAlive</span>&nbsp;<span class="op" id="6568869">:=</span>&nbsp;<span class="keyword" id="6568872">range</span>&nbsp;<span class="op" id="6568878">[</span><span class="op" id="6568879">]</span><span class="builtintype" id="6568880">bool</span><span class="op" id="6568884">{</span><span class="builtintype" id="6568885">false</span><span class="op" id="6568890">,</span>&nbsp;<span class="builtintype" id="6568892">true</span><span class="op" id="6568896">}</span>&nbsp;<span class="op" id="6568898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568902">got</span>&nbsp;<span class="op" id="6568906">:=</span>&nbsp;<span class="builtintype" id="6568909">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568917">testHookSetKeepAlive</span>&nbsp;<span class="op" id="6568938">=</span>&nbsp;<span class="keyword" id="6568940">func</span><span class="op" id="6568944">(</span><span class="op" id="6568945">)</span>&nbsp;<span class="op" id="6568947">{</span>&nbsp;<span class="ident" id="6568949">got</span>&nbsp;<span class="op" id="6568953">=</span>&nbsp;<span class="builtintype" id="6568955">true</span>&nbsp;<span class="op" id="6568960">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568964">var</span>&nbsp;<span class="ident" id="6568968">d</span>&nbsp;<span class="ident" id="6568970">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6568979">if</span>&nbsp;<span class="ident" id="6568982">keepAlive</span>&nbsp;<span class="op" id="6568992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6568997">d</span><span class="op" id="6568998">.</span><span class="ident" id="6568999">KeepAlive</span>&nbsp;<span class="op" id="6569009">=</span>&nbsp;<span class="num" id="6569011">30</span>&nbsp;<span class="op" id="6569014">*</span>&nbsp;<span class="ident" id="6569016">time</span><span class="op" id="6569020">.</span><span class="ident" id="6569021">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6569030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569034">c</span><span class="op" id="6569035">,</span>&nbsp;<span class="ident" id="6569037">err</span>&nbsp;<span class="op" id="6569041">:=</span>&nbsp;<span class="ident" id="6569044">d</span><span class="op" id="6569045">.</span><span class="ident" id="6569046">Dial</span><span class="op" id="6569050">(</span><span class="string" id="6569051">&#34;tcp&#34;</span><span class="op" id="6569056">,</span>&nbsp;<span class="ident" id="6569058">ln</span><span class="op" id="6569060">.</span><span class="ident" id="6569061">Addr</span><span class="op" id="6569065">(</span><span class="op" id="6569066">)</span><span class="op" id="6569067">.</span><span class="ident" id="6569068">String</span><span class="op" id="6569074">(</span><span class="op" id="6569075">)</span><span class="op" id="6569076">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6569080">if</span>&nbsp;<span class="ident" id="6569083">err</span>&nbsp;<span class="op" id="6569087">!=</span>&nbsp;<span class="ident" id="6569090">nil</span>&nbsp;<span class="op" id="6569094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569099">t</span><span class="op" id="6569100">.</span><span class="ident" id="6569101">Fatal</span><span class="op" id="6569106">(</span><span class="ident" id="6569107">err</span><span class="op" id="6569110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6569114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569118">c</span><span class="op" id="6569119">.</span><span class="ident" id="6569120">Close</span><span class="op" id="6569125">(</span><span class="op" id="6569126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6569130">if</span>&nbsp;<span class="ident" id="6569133">got</span>&nbsp;<span class="op" id="6569137">!=</span>&nbsp;<span class="ident" id="6569140">keepAlive</span>&nbsp;<span class="op" id="6569150">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6569155">t</span><span class="op" id="6569156">.</span><span class="ident" id="6569157">Errorf</span><span class="op" id="6569163">(</span><span class="string" id="6569164">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6569222">,</span>&nbsp;<span class="ident" id="6569224">d</span><span class="op" id="6569225">.</span><span class="ident" id="6569226">KeepAlive</span><span class="op" id="6569235">,</span>&nbsp;<span class="ident" id="6569237">got</span><span class="op" id="6569240">,</span>&nbsp;<span class="op" id="6569242">!</span><span class="ident" id="6569243">got</span><span class="op" id="6569246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6569250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6569253">}</span><br>
<span class="lineno"></span><span class="op" id="6569255">}</span>
</div>
</body>
</html>
