<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/textproto</h2>
<ul>
<li><a href="/gostd/net/textproto/header.go.html">header.go</a></li>
<li><a href="/gostd/net/textproto/pipeline.go.html" class="current">pipeline.go</a></li>
<li><a href="/gostd/net/textproto/reader.go.html">reader.go</a></li>
<li><a href="/gostd/net/textproto/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/net/textproto/textproto.go.html">textproto.go</a></li>
<li><a href="/gostd/net/textproto/writer.go.html">writer.go</a></li>
<li><a href="/gostd/net/textproto/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4287301">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4287357">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4287411">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4287462">package</span>&nbsp;<span class="ident" id="4287470">textproto</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4287481">import</span>&nbsp;<span class="op" id="4287488">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4287491">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="4287498">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="4287501">//&nbsp;A&nbsp;Pipeline&nbsp;manages&nbsp;a&nbsp;pipelined&nbsp;in-order&nbsp;request/response&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="comment" id="4287571">//</span><br>
<span class="lineno"></span><span class="comment" id="4287574">//&nbsp;To&nbsp;use&nbsp;a&nbsp;Pipeline&nbsp;p&nbsp;to&nbsp;manage&nbsp;multiple&nbsp;clients&nbsp;on&nbsp;a&nbsp;connection,</span><br>
<span class="lineno"></span><span class="comment" id="4287641">//&nbsp;each&nbsp;client&nbsp;should&nbsp;run:</span><br>
<span class="lineno">15</span><span class="comment" id="4287668">//</span><br>
<span class="lineno"></span><span class="comment" id="4287671">//&nbsp;&nbsp;&nbsp;&nbsp;id&nbsp;:=&nbsp;p.Next()&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;take&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="4287706">//</span><br>
<span class="lineno"></span><span class="comment" id="4287709">//&nbsp;&nbsp;&nbsp;&nbsp;p.StartRequest(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;send&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="4287764">//&nbsp;&nbsp;&nbsp;&nbsp;«send&nbsp;request»</span><br>
<span class="lineno">20</span><span class="comment" id="4287784">//&nbsp;&nbsp;&nbsp;&nbsp;p.EndRequest(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;request&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="4287844">//</span><br>
<span class="lineno"></span><span class="comment" id="4287847">//&nbsp;&nbsp;&nbsp;&nbsp;p.StartResponse(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;read&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="4287904">//&nbsp;&nbsp;&nbsp;&nbsp;«read&nbsp;response»</span><br>
<span class="lineno"></span><span class="comment" id="4287925">//&nbsp;&nbsp;&nbsp;&nbsp;p.EndResponse(id)&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;response&nbsp;is&nbsp;read</span><br>
<span class="lineno">25</span><span class="comment" id="4287987">//</span><br>
<span class="lineno"></span><span class="comment" id="4287990">//&nbsp;A&nbsp;pipelined&nbsp;server&nbsp;can&nbsp;use&nbsp;the&nbsp;same&nbsp;calls&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4288050">//&nbsp;responses&nbsp;computed&nbsp;in&nbsp;parallel&nbsp;are&nbsp;written&nbsp;in&nbsp;the&nbsp;correct&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="4288118">type</span>&nbsp;<span class="ident" id="4288123">Pipeline</span>&nbsp;<span class="keyword" id="4288132">struct</span>&nbsp;<span class="op" id="4288139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288142">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288151">sync</span><span class="op" id="4288155">.</span><span class="ident" id="4288156">Mutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288163">id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4288172">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288178">request</span>&nbsp;&nbsp;<span class="ident" id="4288187">sequencer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288198">response</span>&nbsp;<span class="ident" id="4288207">sequencer</span><br>
<span class="lineno"></span><span class="op" id="4288217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4288220">//&nbsp;Next&nbsp;returns&nbsp;the&nbsp;next&nbsp;id&nbsp;for&nbsp;a&nbsp;request/response&nbsp;pair.</span><br>
<span class="lineno"></span><span class="keyword" id="4288277">func</span>&nbsp;<span class="op" id="4288282">(</span><span class="ident" id="4288283">p</span>&nbsp;<span class="op" id="4288285">*</span><span class="ident" id="4288286">Pipeline</span><span class="op" id="4288294">)</span>&nbsp;<span class="ident" id="4288296">Next</span><span class="op" id="4288300">(</span><span class="op" id="4288301">)</span>&nbsp;<span class="builtintype" id="4288303">uint</span>&nbsp;<span class="op" id="4288308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288311">p</span><span class="op" id="4288312">.</span><span class="ident" id="4288313">mu</span><span class="op" id="4288315">.</span><span class="ident" id="4288316">Lock</span><span class="op" id="4288320">(</span><span class="op" id="4288321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288324">id</span>&nbsp;<span class="op" id="4288327">:=</span>&nbsp;<span class="ident" id="4288330">p</span><span class="op" id="4288331">.</span><span class="ident" id="4288332">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288336">p</span><span class="op" id="4288337">.</span><span class="ident" id="4288338">id</span><span class="op" id="4288340">++</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288344">p</span><span class="op" id="4288345">.</span><span class="ident" id="4288346">mu</span><span class="op" id="4288348">.</span><span class="ident" id="4288349">Unlock</span><span class="op" id="4288355">(</span><span class="op" id="4288356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4288359">return</span>&nbsp;<span class="ident" id="4288366">id</span><br>
<span class="lineno"></span><span class="op" id="4288369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4288372">//&nbsp;StartRequest&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;send&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;receive)</span><br>
<span class="lineno">45</span><span class="comment" id="4288455">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="4288489">func</span>&nbsp;<span class="op" id="4288494">(</span><span class="ident" id="4288495">p</span>&nbsp;<span class="op" id="4288497">*</span><span class="ident" id="4288498">Pipeline</span><span class="op" id="4288506">)</span>&nbsp;<span class="ident" id="4288508">StartRequest</span><span class="op" id="4288520">(</span><span class="ident" id="4288521">id</span>&nbsp;<span class="builtintype" id="4288524">uint</span><span class="op" id="4288528">)</span>&nbsp;<span class="op" id="4288530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288533">p</span><span class="op" id="4288534">.</span><span class="ident" id="4288535">request</span><span class="op" id="4288542">.</span><span class="ident" id="4288543">Start</span><span class="op" id="4288548">(</span><span class="ident" id="4288549">id</span><span class="op" id="4288551">)</span><br>
<span class="lineno"></span><span class="op" id="4288553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4288556">//&nbsp;EndRequest&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="4288630">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;received).</span><br>
<span class="lineno"></span><span class="keyword" id="4288670">func</span>&nbsp;<span class="op" id="4288675">(</span><span class="ident" id="4288676">p</span>&nbsp;<span class="op" id="4288678">*</span><span class="ident" id="4288679">Pipeline</span><span class="op" id="4288687">)</span>&nbsp;<span class="ident" id="4288689">EndRequest</span><span class="op" id="4288699">(</span><span class="ident" id="4288700">id</span>&nbsp;<span class="builtintype" id="4288703">uint</span><span class="op" id="4288707">)</span>&nbsp;<span class="op" id="4288709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288712">p</span><span class="op" id="4288713">.</span><span class="ident" id="4288714">request</span><span class="op" id="4288721">.</span><span class="ident" id="4288722">End</span><span class="op" id="4288725">(</span><span class="ident" id="4288726">id</span><span class="op" id="4288728">)</span><br>
<span class="lineno"></span><span class="op" id="4288730">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="4288733">//&nbsp;StartResponse&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;receive&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;send)</span><br>
<span class="lineno"></span><span class="comment" id="4288817">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="4288851">func</span>&nbsp;<span class="op" id="4288856">(</span><span class="ident" id="4288857">p</span>&nbsp;<span class="op" id="4288859">*</span><span class="ident" id="4288860">Pipeline</span><span class="op" id="4288868">)</span>&nbsp;<span class="ident" id="4288870">StartResponse</span><span class="op" id="4288883">(</span><span class="ident" id="4288884">id</span>&nbsp;<span class="builtintype" id="4288887">uint</span><span class="op" id="4288891">)</span>&nbsp;<span class="op" id="4288893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4288896">p</span><span class="op" id="4288897">.</span><span class="ident" id="4288898">response</span><span class="op" id="4288906">.</span><span class="ident" id="4288907">Start</span><span class="op" id="4288912">(</span><span class="ident" id="4288913">id</span><span class="op" id="4288915">)</span><br>
<span class="lineno">60</span><span class="op" id="4288917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4288920">//&nbsp;EndResponse&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;response&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;received</span><br>
<span class="lineno"></span><span class="comment" id="4289000">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;sent).</span><br>
<span class="lineno"></span><span class="keyword" id="4289036">func</span>&nbsp;<span class="op" id="4289041">(</span><span class="ident" id="4289042">p</span>&nbsp;<span class="op" id="4289044">*</span><span class="ident" id="4289045">Pipeline</span><span class="op" id="4289053">)</span>&nbsp;<span class="ident" id="4289055">EndResponse</span><span class="op" id="4289066">(</span><span class="ident" id="4289067">id</span>&nbsp;<span class="builtintype" id="4289070">uint</span><span class="op" id="4289074">)</span>&nbsp;<span class="op" id="4289076">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289079">p</span><span class="op" id="4289080">.</span><span class="ident" id="4289081">response</span><span class="op" id="4289089">.</span><span class="ident" id="4289090">End</span><span class="op" id="4289093">(</span><span class="ident" id="4289094">id</span><span class="op" id="4289096">)</span><br>
<span class="lineno"></span><span class="op" id="4289098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4289101">//&nbsp;A&nbsp;sequencer&nbsp;schedules&nbsp;a&nbsp;sequence&nbsp;of&nbsp;numbered&nbsp;events&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="4289166">//&nbsp;happen&nbsp;in&nbsp;order,&nbsp;one&nbsp;after&nbsp;the&nbsp;other.&nbsp;&nbsp;The&nbsp;event&nbsp;numbering&nbsp;must&nbsp;start</span><br>
<span class="lineno">70</span><span class="comment" id="4289239">//&nbsp;at&nbsp;0&nbsp;and&nbsp;increment&nbsp;without&nbsp;skipping.&nbsp;&nbsp;The&nbsp;event&nbsp;number&nbsp;wraps&nbsp;around</span><br>
<span class="lineno"></span><span class="comment" id="4289310">//&nbsp;safely&nbsp;as&nbsp;long&nbsp;as&nbsp;there&nbsp;are&nbsp;not&nbsp;2^32&nbsp;simultaneous&nbsp;events&nbsp;pending.</span><br>
<span class="lineno"></span><span class="keyword" id="4289379">type</span>&nbsp;<span class="ident" id="4289384">sequencer</span>&nbsp;<span class="keyword" id="4289394">struct</span>&nbsp;<span class="op" id="4289401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289404">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4289409">sync</span><span class="op" id="4289413">.</span><span class="ident" id="4289414">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289421">id</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4289426">uint</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289432">wait</span>&nbsp;<span class="keyword" id="4289437">map</span><span class="op" id="4289440">[</span><span class="builtintype" id="4289441">uint</span><span class="op" id="4289445">]</span><span class="keyword" id="4289446">chan</span>&nbsp;<span class="builtintype" id="4289451">uint</span><br>
<span class="lineno"></span><span class="op" id="4289456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4289459">//&nbsp;Start&nbsp;waits&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;for&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;to&nbsp;begin.</span><br>
<span class="lineno"></span><span class="comment" id="4289527">//&nbsp;That&nbsp;is,&nbsp;except&nbsp;for&nbsp;the&nbsp;first&nbsp;event,&nbsp;it&nbsp;waits&nbsp;until&nbsp;End(id-1)&nbsp;has</span><br>
<span class="lineno">80</span><span class="comment" id="4289596">//&nbsp;been&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="4289612">func</span>&nbsp;<span class="op" id="4289617">(</span><span class="ident" id="4289618">s</span>&nbsp;<span class="op" id="4289620">*</span><span class="ident" id="4289621">sequencer</span><span class="op" id="4289630">)</span>&nbsp;<span class="ident" id="4289632">Start</span><span class="op" id="4289637">(</span><span class="ident" id="4289638">id</span>&nbsp;<span class="builtintype" id="4289641">uint</span><span class="op" id="4289645">)</span>&nbsp;<span class="op" id="4289647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289650">s</span><span class="op" id="4289651">.</span><span class="ident" id="4289652">mu</span><span class="op" id="4289654">.</span><span class="ident" id="4289655">Lock</span><span class="op" id="4289659">(</span><span class="op" id="4289660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289663">if</span>&nbsp;<span class="ident" id="4289666">s</span><span class="op" id="4289667">.</span><span class="ident" id="4289668">id</span>&nbsp;<span class="op" id="4289671">==</span>&nbsp;<span class="ident" id="4289674">id</span>&nbsp;<span class="op" id="4289677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289681">s</span><span class="op" id="4289682">.</span><span class="ident" id="4289683">mu</span><span class="op" id="4289685">.</span><span class="ident" id="4289686">Unlock</span><span class="op" id="4289692">(</span><span class="op" id="4289693">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289697">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4289705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289708">c</span>&nbsp;<span class="op" id="4289710">:=</span>&nbsp;<span class="builtinfunc" id="4289713">make</span><span class="op" id="4289717">(</span><span class="keyword" id="4289718">chan</span>&nbsp;<span class="builtintype" id="4289723">uint</span><span class="op" id="4289727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4289730">if</span>&nbsp;<span class="ident" id="4289733">s</span><span class="op" id="4289734">.</span><span class="ident" id="4289735">wait</span>&nbsp;<span class="op" id="4289740">==</span>&nbsp;<span class="builtintype" id="4289743">nil</span>&nbsp;<span class="op" id="4289747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289751">s</span><span class="op" id="4289752">.</span><span class="ident" id="4289753">wait</span>&nbsp;<span class="op" id="4289758">=</span>&nbsp;<span class="builtinfunc" id="4289760">make</span><span class="op" id="4289764">(</span><span class="keyword" id="4289765">map</span><span class="op" id="4289768">[</span><span class="builtintype" id="4289769">uint</span><span class="op" id="4289773">]</span><span class="keyword" id="4289774">chan</span>&nbsp;<span class="builtintype" id="4289779">uint</span><span class="op" id="4289783">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4289786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289789">s</span><span class="op" id="4289790">.</span><span class="ident" id="4289791">wait</span><span class="op" id="4289795">[</span><span class="ident" id="4289796">id</span><span class="op" id="4289798">]</span>&nbsp;<span class="op" id="4289800">=</span>&nbsp;<span class="ident" id="4289802">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4289805">s</span><span class="op" id="4289806">.</span><span class="ident" id="4289807">mu</span><span class="op" id="4289809">.</span><span class="ident" id="4289810">Unlock</span><span class="op" id="4289816">(</span><span class="op" id="4289817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4289820">&lt;-</span><span class="ident" id="4289822">c</span><br>
<span class="lineno"></span><span class="op" id="4289824">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="4289827">//&nbsp;End&nbsp;notifies&nbsp;the&nbsp;sequencer&nbsp;that&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;has&nbsp;completed,</span><br>
<span class="lineno"></span><span class="comment" id="4289899">//&nbsp;allowing&nbsp;it&nbsp;to&nbsp;schedule&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id+1.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4289975">//&nbsp;to&nbsp;call&nbsp;End&nbsp;with&nbsp;an&nbsp;id&nbsp;that&nbsp;is&nbsp;not&nbsp;the&nbsp;number&nbsp;of&nbsp;the&nbsp;active&nbsp;event.</span><br>
<span class="lineno"></span><span class="keyword" id="4290045">func</span>&nbsp;<span class="op" id="4290050">(</span><span class="ident" id="4290051">s</span>&nbsp;<span class="op" id="4290053">*</span><span class="ident" id="4290054">sequencer</span><span class="op" id="4290063">)</span>&nbsp;<span class="ident" id="4290065">End</span><span class="op" id="4290068">(</span><span class="ident" id="4290069">id</span>&nbsp;<span class="builtintype" id="4290072">uint</span><span class="op" id="4290076">)</span>&nbsp;<span class="op" id="4290078">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290081">s</span><span class="op" id="4290082">.</span><span class="ident" id="4290083">mu</span><span class="op" id="4290085">.</span><span class="ident" id="4290086">Lock</span><span class="op" id="4290090">(</span><span class="op" id="4290091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4290094">if</span>&nbsp;<span class="ident" id="4290097">s</span><span class="op" id="4290098">.</span><span class="ident" id="4290099">id</span>&nbsp;<span class="op" id="4290102">!=</span>&nbsp;<span class="ident" id="4290105">id</span>&nbsp;<span class="op" id="4290108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4290112">panic</span><span class="op" id="4290117">(</span><span class="string" id="4290118">&#34;out&nbsp;of&nbsp;sync&#34;</span><span class="op" id="4290131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4290134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290137">id</span><span class="op" id="4290139">++</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290143">s</span><span class="op" id="4290144">.</span><span class="ident" id="4290145">id</span>&nbsp;<span class="op" id="4290148">=</span>&nbsp;<span class="ident" id="4290150">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4290154">if</span>&nbsp;<span class="ident" id="4290157">s</span><span class="op" id="4290158">.</span><span class="ident" id="4290159">wait</span>&nbsp;<span class="op" id="4290164">==</span>&nbsp;<span class="builtintype" id="4290167">nil</span>&nbsp;<span class="op" id="4290171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290175">s</span><span class="op" id="4290176">.</span><span class="ident" id="4290177">wait</span>&nbsp;<span class="op" id="4290182">=</span>&nbsp;<span class="builtinfunc" id="4290184">make</span><span class="op" id="4290188">(</span><span class="keyword" id="4290189">map</span><span class="op" id="4290192">[</span><span class="builtintype" id="4290193">uint</span><span class="op" id="4290197">]</span><span class="keyword" id="4290198">chan</span>&nbsp;<span class="builtintype" id="4290203">uint</span><span class="op" id="4290207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4290210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290213">c</span><span class="op" id="4290214">,</span>&nbsp;<span class="ident" id="4290216">ok</span>&nbsp;<span class="op" id="4290219">:=</span>&nbsp;<span class="ident" id="4290222">s</span><span class="op" id="4290223">.</span><span class="ident" id="4290224">wait</span><span class="op" id="4290228">[</span><span class="ident" id="4290229">id</span><span class="op" id="4290231">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4290234">if</span>&nbsp;<span class="ident" id="4290237">ok</span>&nbsp;<span class="op" id="4290240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4290244">delete</span><span class="op" id="4290250">(</span><span class="ident" id="4290251">s</span><span class="op" id="4290252">.</span><span class="ident" id="4290253">wait</span><span class="op" id="4290257">,</span>&nbsp;<span class="ident" id="4290259">id</span><span class="op" id="4290261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4290264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290267">s</span><span class="op" id="4290268">.</span><span class="ident" id="4290269">mu</span><span class="op" id="4290271">.</span><span class="ident" id="4290272">Unlock</span><span class="op" id="4290278">(</span><span class="op" id="4290279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4290282">if</span>&nbsp;<span class="ident" id="4290285">ok</span>&nbsp;<span class="op" id="4290288">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4290292">c</span>&nbsp;<span class="op" id="4290294">&lt;-</span>&nbsp;<span class="num" id="4290297">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4290300">}</span><br>
<span class="lineno"></span><span class="op" id="4290302">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
