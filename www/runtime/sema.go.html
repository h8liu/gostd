<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2094688">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2094743">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2094797">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2094848">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="2094891">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="2094937">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="2094989">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="2095029">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="2095080">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="2095118">//</span><br>
<span class="lineno"></span><span class="comment" id="2095121">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="2095169">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="2095225">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="2095282">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="2095345">//</span><br>
<span class="lineno"></span><span class="comment" id="2095348">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="2095400">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="2095435">package</span>&nbsp;<span class="ident" id="2095443">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2095452">import</span>&nbsp;<span class="string" id="2095459">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2095469">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="2095512">type</span>&nbsp;<span class="ident" id="2095517">semaRoot</span>&nbsp;<span class="keyword" id="2095526">struct</span>&nbsp;<span class="op" id="2095533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095536">lock</span>&nbsp;&nbsp;<span class="ident" id="2095542"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179310">mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095549">head</span>&nbsp;&nbsp;<span class="op" id="2095555">*</span><span class="ident" id="2095556"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179851">sudog</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095563">tail</span>&nbsp;&nbsp;<span class="op" id="2095569">*</span><span class="ident" id="2095570"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179851">sudog</a></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095577">nwait</span>&nbsp;<span class="builtintype" id="2095583">uint32</span>&nbsp;<span class="comment" id="2095590">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="2095631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2095634">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="2095684">const</span>&nbsp;<span class="ident" id="2095690">semTabSize</span>&nbsp;<span class="op" id="2095701">=</span>&nbsp;<span class="num" id="2095703">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="2095708">var</span>&nbsp;<span class="ident" id="2095712">semtable</span>&nbsp;<span class="op" id="2095721">[</span><span class="ident" id="2095722"><a href="/runtime/sema.go.html#2095690">semTabSize</a></span><span class="op" id="2095732">]</span><span class="keyword" id="2095733">struct</span>&nbsp;<span class="op" id="2095740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095743">root</span>&nbsp;<span class="ident" id="2095748"><a href="/runtime/sema.go.html#2095517">semaRoot</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095758">pad</span>&nbsp;&nbsp;<span class="op" id="2095763">[</span><span class="ident" id="2095764"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2184836">_CacheLineSize</a></span>&nbsp;<span class="op" id="2095779">-</span>&nbsp;<span class="ident" id="2095781"><a href="/runtime/sema.go.html#2095459">unsafe</a></span><span class="op" id="2095787">.</span><span class="ident" id="2095788">Sizeof</span><span class="op" id="2095794">(</span><span class="ident" id="2095795"><a href="/runtime/sema.go.html#2095517">semaRoot</a></span><span class="op" id="2095803">{</span><span class="op" id="2095804">}</span><span class="op" id="2095805">)</span><span class="op" id="2095806">]</span><span class="builtintype" id="2095807">byte</span><br>
<span class="lineno"></span><span class="op" id="2095812">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="2095815">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="2095849">func</span>&nbsp;<span class="ident" id="2095854">asyncsemacquire</span><span class="op" id="2095869">(</span><span class="ident" id="2095870">addr</span>&nbsp;<span class="op" id="2095875">*</span><span class="builtintype" id="2095876">uint32</span><span class="op" id="2095882">)</span>&nbsp;<span class="op" id="2095884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095887"><a href="/runtime/sema.go.html#2096000">semacquire</a></span><span class="op" id="2095897">(</span><span class="ident" id="2095898"><a href="/runtime/sema.go.html#2095870">addr</a></span><span class="op" id="2095902">,</span>&nbsp;<span class="builtintype" id="2095904">true</span><span class="op" id="2095908">)</span><br>
<span class="lineno"></span><span class="op" id="2095910">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="2095913">func</span>&nbsp;<span class="ident" id="2095918">asyncsemrelease</span><span class="op" id="2095933">(</span><span class="ident" id="2095934">addr</span>&nbsp;<span class="op" id="2095939">*</span><span class="builtintype" id="2095940">uint32</span><span class="op" id="2095946">)</span>&nbsp;<span class="op" id="2095948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2095951"><a href="/runtime/sema.go.html#2097084">semrelease</a></span><span class="op" id="2095961">(</span><span class="ident" id="2095962"><a href="/runtime/sema.go.html#2095934">addr</a></span><span class="op" id="2095966">)</span><br>
<span class="lineno"></span><span class="op" id="2095968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="2095971">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="2095995">func</span>&nbsp;<span class="ident" id="2096000">semacquire</span><span class="op" id="2096010">(</span><span class="ident" id="2096011">addr</span>&nbsp;<span class="op" id="2096016">*</span><span class="builtintype" id="2096017">uint32</span><span class="op" id="2096023">,</span>&nbsp;<span class="ident" id="2096025">profile</span>&nbsp;<span class="builtintype" id="2096033">bool</span><span class="op" id="2096037">)</span>&nbsp;<span class="op" id="2096039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096042">gp</span>&nbsp;<span class="op" id="2096045">:=</span>&nbsp;<span class="ident" id="2096048"><a href="/runtime/stubs.go.html#2132021">getg</a></span><span class="op" id="2096052">(</span><span class="op" id="2096053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2096056">if</span>&nbsp;<span class="ident" id="2096059"><a href="/runtime/sema.go.html#2096042">gp</a></span>&nbsp;<span class="op" id="2096062">!=</span>&nbsp;<span class="ident" id="2096065"><a href="/runtime/sema.go.html#2096042">gp</a></span><span class="op" id="2096067">.</span><span class="ident" id="2096068">m</span><span class="op" id="2096069">.</span><span class="ident" id="2096070">curg</span>&nbsp;<span class="op" id="2096075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096079"><a href="/runtime/panic.go.html#2057429">gothrow</a></span><span class="op" id="2096086">(</span><span class="string" id="2096087">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="2096118">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2096121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2096125">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2096140">if</span>&nbsp;<span class="ident" id="2096143"><a href="/runtime/sema.go.html#2097939">cansemacquire</a></span><span class="op" id="2096156">(</span><span class="ident" id="2096157"><a href="/runtime/sema.go.html#2096011">addr</a></span><span class="op" id="2096161">)</span>&nbsp;<span class="op" id="2096163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2096167">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2096175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2096179">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2096196">//&nbsp;&nbsp;&nbsp;&nbspincrement&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2096223">//&nbsp;&nbsp;&nbsp;&nbsptry&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2096280">//&nbsp;&nbsp;&nbsp;&nbspenqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2096311">//&nbsp;&nbsp;&nbsp;&nbspsleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2096321">//&nbsp;&nbsp;&nbsp;&nbsp(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096369">s</span>&nbsp;<span class="op" id="2096371">:=</span>&nbsp;<span class="ident" id="2096374"><a href="/runtime/proc.go.html#2067140">acquireSudog</a></span><span class="op" id="2096386">(</span><span class="op" id="2096387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096390">root</span>&nbsp;<span class="op" id="2096395">:=</span>&nbsp;<span class="ident" id="2096398"><a href="/runtime/sema.go.html#2097827">semroot</a></span><span class="op" id="2096405">(</span><span class="ident" id="2096406"><a href="/runtime/sema.go.html#2096011">addr</a></span><span class="op" id="2096410">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096413">t0</span>&nbsp;<span class="op" id="2096416">:=</span>&nbsp;<span class="ident" id="2096419">int64</span><span class="op" id="2096424">(</span><span class="num" id="2096425">0</span><span class="op" id="2096426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096429"><a href="/runtime/sema.go.html#2096369">s</a></span><span class="op" id="2096430">.</span><span class="ident" id="2096431">releasetime</span>&nbsp;<span class="op" id="2096443">=</span>&nbsp;<span class="num" id="2096445">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2096448">if</span>&nbsp;<span class="ident" id="2096451"><a href="/runtime/sema.go.html#2096025">profile</a></span>&nbsp;<span class="op" id="2096459">&amp;&amp;</span>&nbsp;<span class="ident" id="2096462"><a href="/runtime/mprof.go.html#2019313">blockprofilerate</a></span>&nbsp;<span class="op" id="2096479">&gt;</span>&nbsp;<span class="num" id="2096481">0</span>&nbsp;<span class="op" id="2096483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096487"><a href="/runtime/sema.go.html#2096413">t0</a></span>&nbsp;<span class="op" id="2096490">=</span>&nbsp;<span class="ident" id="2096492"><a href="/runtime/stubs.go.html#2137246">cputicks</a></span><span class="op" id="2096500">(</span><span class="op" id="2096501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096505"><a href="/runtime/sema.go.html#2096369">s</a></span><span class="op" id="2096506">.</span><span class="ident" id="2096507">releasetime</span>&nbsp;<span class="op" id="2096519">=</span>&nbsp;<span class="op" id="2096521">-</span><span class="num" id="2096522">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2096525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2096528">for</span>&nbsp;<span class="op" id="2096532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096536"><a href="/runtime/lock_futex.go.html#1978439">lock</a></span><span class="op" id="2096540">(</span><span class="op" id="2096541">&amp;</span><span class="ident" id="2096542"><a href="/runtime/sema.go.html#2096390">root</a></span><span class="op" id="2096546">.</span><span class="ident" id="2096547">lock</span><span class="op" id="2096551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2096555">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096621"><a href="/runtime/atomic.go.html#1874050">xadd</a></span><span class="op" id="2096625">(</span><span class="op" id="2096626">&amp;</span><span class="ident" id="2096627"><a href="/runtime/sema.go.html#2096390">root</a></span><span class="op" id="2096631">.</span><span class="ident" id="2096632">nwait</span><span class="op" id="2096637">,</span>&nbsp;<span class="num" id="2096639">1</span><span class="op" id="2096640">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2096644">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2096693">if</span>&nbsp;<span class="ident" id="2096696"><a href="/runtime/sema.go.html#2097939">cansemacquire</a></span><span class="op" id="2096709">(</span><span class="ident" id="2096710"><a href="/runtime/sema.go.html#2096011">addr</a></span><span class="op" id="2096714">)</span>&nbsp;<span class="op" id="2096716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096721"><a href="/runtime/atomic.go.html#1874050">xadd</a></span><span class="op" id="2096725">(</span><span class="op" id="2096726">&amp;</span><span class="ident" id="2096727"><a href="/runtime/sema.go.html#2096390">root</a></span><span class="op" id="2096731">.</span><span class="ident" id="2096732">nwait</span><span class="op" id="2096737">,</span>&nbsp;<span class="op" id="2096739">-</span><span class="num" id="2096740">1</span><span class="op" id="2096741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096746"><a href="/runtime/lock_futex.go.html#1979731">unlock</a></span><span class="op" id="2096752">(</span><span class="op" id="2096753">&amp;</span><span class="ident" id="2096754"><a href="/runtime/sema.go.html#2096390">root</a></span><span class="op" id="2096758">.</span><span class="ident" id="2096759">lock</span><span class="op" id="2096763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2096768">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2096776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2096780">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2096844">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096887"><a href="/runtime/sema.go.html#2096390">root</a></span><span class="op" id="2096891">.</span><span class="ident" id="2096892">queue</span><span class="op" id="2096897">(</span><span class="ident" id="2096898"><a href="/runtime/sema.go.html#2096011">addr</a></span><span class="op" id="2096902">,</span>&nbsp;<span class="ident" id="2096904"><a href="/runtime/sema.go.html#2096369">s</a></span><span class="op" id="2096905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2096909"><a href="/runtime/proc.go.html#2066901">goparkunlock</a></span><span class="op" id="2096921">(</span><span class="op" id="2096922">&amp;</span><span class="ident" id="2096923"><a href="/runtime/sema.go.html#2096390">root</a></span><span class="op" id="2096927">.</span><span class="ident" id="2096928">lock</span><span class="op" id="2096932">,</span>&nbsp;<span class="string" id="2096934">&#34;semacquire&#34;</span><span class="op" id="2096946">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2096950">if</span>&nbsp;<span class="ident" id="2096953"><a href="/runtime/sema.go.html#2097939">cansemacquire</a></span><span class="op" id="2096966">(</span><span class="ident" id="2096967"><a href="/runtime/sema.go.html#2096011">addr</a></span><span class="op" id="2096971">)</span>&nbsp;<span class="op" id="2096973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2096978">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2096986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2096989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2096992">if</span>&nbsp;<span class="ident" id="2096995"><a href="/runtime/sema.go.html#2096369">s</a></span><span class="op" id="2096996">.</span><span class="ident" id="2096997">releasetime</span>&nbsp;<span class="op" id="2097009">&gt;</span>&nbsp;<span class="num" id="2097011">0</span>&nbsp;<span class="op" id="2097013">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097017"><a href="/runtime/mprof.go.html#2020096">blockevent</a></span><span class="op" id="2097027">(</span><span class="ident" id="2097028">int64</span><span class="op" id="2097033">(</span><span class="ident" id="2097034"><a href="/runtime/sema.go.html#2096369">s</a></span><span class="op" id="2097035">.</span><span class="ident" id="2097036">releasetime</span><span class="op" id="2097047">)</span><span class="op" id="2097048">-</span><span class="ident" id="2097049"><a href="/runtime/sema.go.html#2096413">t0</a></span><span class="op" id="2097051">,</span>&nbsp;<span class="num" id="2097053">3</span><span class="op" id="2097054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2097057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097060"><a href="/runtime/proc.go.html#2067870">releaseSudog</a></span><span class="op" id="2097072">(</span><span class="ident" id="2097073"><a href="/runtime/sema.go.html#2096369">s</a></span><span class="op" id="2097074">)</span><br>
<span class="lineno"></span><span class="op" id="2097076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="2097079">func</span>&nbsp;<span class="ident" id="2097084">semrelease</span><span class="op" id="2097094">(</span><span class="ident" id="2097095">addr</span>&nbsp;<span class="op" id="2097100">*</span><span class="builtintype" id="2097101">uint32</span><span class="op" id="2097107">)</span>&nbsp;<span class="op" id="2097109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097112">root</span>&nbsp;<span class="op" id="2097117">:=</span>&nbsp;<span class="ident" id="2097120"><a href="/runtime/sema.go.html#2097827">semroot</a></span><span class="op" id="2097127">(</span><span class="ident" id="2097128"><a href="/runtime/sema.go.html#2097095">addr</a></span><span class="op" id="2097132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097135"><a href="/runtime/atomic.go.html#1874050">xadd</a></span><span class="op" id="2097139">(</span><span class="ident" id="2097140"><a href="/runtime/sema.go.html#2097095">addr</a></span><span class="op" id="2097144">,</span>&nbsp;<span class="num" id="2097146">1</span><span class="op" id="2097147">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2097151">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2097178">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2097246">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2097276">if</span>&nbsp;<span class="ident" id="2097279"><a href="/runtime/atomic.go.html#1874432">atomicload</a></span><span class="op" id="2097289">(</span><span class="op" id="2097290">&amp;</span><span class="ident" id="2097291"><a href="/runtime/sema.go.html#2097112">root</a></span><span class="op" id="2097295">.</span><span class="ident" id="2097296">nwait</span><span class="op" id="2097301">)</span>&nbsp;<span class="op" id="2097303">==</span>&nbsp;<span class="num" id="2097306">0</span>&nbsp;<span class="op" id="2097308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2097312">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2097320">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2097324">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097374"><a href="/runtime/lock_futex.go.html#1978439">lock</a></span><span class="op" id="2097378">(</span><span class="op" id="2097379">&amp;</span><span class="ident" id="2097380"><a href="/runtime/sema.go.html#2097112">root</a></span><span class="op" id="2097384">.</span><span class="ident" id="2097385">lock</span><span class="op" id="2097389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2097392">if</span>&nbsp;<span class="ident" id="2097395"><a href="/runtime/atomic.go.html#1874432">atomicload</a></span><span class="op" id="2097405">(</span><span class="op" id="2097406">&amp;</span><span class="ident" id="2097407"><a href="/runtime/sema.go.html#2097112">root</a></span><span class="op" id="2097411">.</span><span class="ident" id="2097412">nwait</span><span class="op" id="2097417">)</span>&nbsp;<span class="op" id="2097419">==</span>&nbsp;<span class="num" id="2097422">0</span>&nbsp;<span class="op" id="2097424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2097428">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2097485">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097531"><a href="/runtime/lock_futex.go.html#1979731">unlock</a></span><span class="op" id="2097537">(</span><span class="op" id="2097538">&amp;</span><span class="ident" id="2097539"><a href="/runtime/sema.go.html#2097112">root</a></span><span class="op" id="2097543">.</span><span class="ident" id="2097544">lock</span><span class="op" id="2097548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2097552">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2097560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097563">s</span>&nbsp;<span class="op" id="2097565">:=</span>&nbsp;<span class="ident" id="2097568"><a href="/runtime/sema.go.html#2097112">root</a></span><span class="op" id="2097572">.</span><span class="ident" id="2097573">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2097579">for</span>&nbsp;<span class="op" id="2097583">;</span>&nbsp;<span class="ident" id="2097585"><a href="/runtime/sema.go.html#2097563">s</a></span>&nbsp;<span class="op" id="2097587">!=</span>&nbsp;<span class="ident" id="2097590">nil</span><span class="op" id="2097593">;</span>&nbsp;<span class="ident" id="2097595"><a href="/runtime/sema.go.html#2097563">s</a></span>&nbsp;<span class="op" id="2097597">=</span>&nbsp;<span class="ident" id="2097599"><a href="/runtime/sema.go.html#2097563">s</a></span><span class="op" id="2097600">.</span><span class="ident" id="2097601">next</span>&nbsp;<span class="op" id="2097606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2097610">if</span>&nbsp;<span class="ident" id="2097613"><a href="/runtime/sema.go.html#2097563">s</a></span><span class="op" id="2097614">.</span><span class="ident" id="2097615">elem</span>&nbsp;<span class="op" id="2097620">==</span>&nbsp;<span class="ident" id="2097623"><a href="/runtime/sema.go.html#2095459">unsafe</a></span><span class="op" id="2097629">.</span><span class="ident" id="2097630">Pointer</span><span class="op" id="2097637">(</span><span class="ident" id="2097638"><a href="/runtime/sema.go.html#2097095">addr</a></span><span class="op" id="2097642">)</span>&nbsp;<span class="op" id="2097644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097649"><a href="/runtime/atomic.go.html#1874050">xadd</a></span><span class="op" id="2097653">(</span><span class="op" id="2097654">&amp;</span><span class="ident" id="2097655"><a href="/runtime/sema.go.html#2097112">root</a></span><span class="op" id="2097659">.</span><span class="ident" id="2097660">nwait</span><span class="op" id="2097665">,</span>&nbsp;<span class="op" id="2097667">-</span><span class="num" id="2097668">1</span><span class="op" id="2097669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097674"><a href="/runtime/sema.go.html#2097112">root</a></span><span class="op" id="2097678">.</span><span class="ident" id="2097679">dequeue</span><span class="op" id="2097686">(</span><span class="ident" id="2097687"><a href="/runtime/sema.go.html#2097563">s</a></span><span class="op" id="2097688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2097693">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2097701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2097704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097707"><a href="/runtime/lock_futex.go.html#1979731">unlock</a></span><span class="op" id="2097713">(</span><span class="op" id="2097714">&amp;</span><span class="ident" id="2097715"><a href="/runtime/sema.go.html#2097112">root</a></span><span class="op" id="2097719">.</span><span class="ident" id="2097720">lock</span><span class="op" id="2097724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2097727">if</span>&nbsp;<span class="ident" id="2097730"><a href="/runtime/sema.go.html#2097563">s</a></span>&nbsp;<span class="op" id="2097732">!=</span>&nbsp;<span class="ident" id="2097735">nil</span>&nbsp;<span class="op" id="2097739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2097743">if</span>&nbsp;<span class="ident" id="2097746"><a href="/runtime/sema.go.html#2097563">s</a></span><span class="op" id="2097747">.</span><span class="ident" id="2097748">releasetime</span>&nbsp;<span class="op" id="2097760">!=</span>&nbsp;<span class="num" id="2097763">0</span>&nbsp;<span class="op" id="2097765">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097770"><a href="/runtime/sema.go.html#2097563">s</a></span><span class="op" id="2097771">.</span><span class="ident" id="2097772">releasetime</span>&nbsp;<span class="op" id="2097784">=</span>&nbsp;<span class="ident" id="2097786"><a href="/runtime/stubs.go.html#2137246">cputicks</a></span><span class="op" id="2097794">(</span><span class="op" id="2097795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2097799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097803"><a href="/runtime/proc.go.html#2067021">goready</a></span><span class="op" id="2097810">(</span><span class="ident" id="2097811"><a href="/runtime/sema.go.html#2097563">s</a></span><span class="op" id="2097812">.</span><span class="ident" id="2097813">g</span><span class="op" id="2097814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2097817">}</span><br>
<span class="lineno"></span><span class="op" id="2097819">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="2097822">func</span>&nbsp;<span class="ident" id="2097827">semroot</span><span class="op" id="2097834">(</span><span class="ident" id="2097835">addr</span>&nbsp;<span class="op" id="2097840">*</span><span class="builtintype" id="2097841">uint32</span><span class="op" id="2097847">)</span>&nbsp;<span class="op" id="2097849">*</span><span class="ident" id="2097850"><a href="/runtime/sema.go.html#2095517">semaRoot</a></span>&nbsp;<span class="op" id="2097859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2097862">return</span>&nbsp;<span class="op" id="2097869">&amp;</span><span class="ident" id="2097870"><a href="/runtime/sema.go.html#2095712">semtable</a></span><span class="op" id="2097878">[</span><span class="op" id="2097879">(</span><span class="builtintype" id="2097880">uintptr</span><span class="op" id="2097887">(</span><span class="ident" id="2097888"><a href="/runtime/sema.go.html#2095459">unsafe</a></span><span class="op" id="2097894">.</span><span class="ident" id="2097895">Pointer</span><span class="op" id="2097902">(</span><span class="ident" id="2097903"><a href="/runtime/sema.go.html#2097835">addr</a></span><span class="op" id="2097907">)</span><span class="op" id="2097908">)</span><span class="op" id="2097909">&gt;&gt;</span><span class="num" id="2097911">3</span><span class="op" id="2097912">)</span><span class="op" id="2097913">%</span><span class="ident" id="2097914"><a href="/runtime/sema.go.html#2095690">semTabSize</a></span><span class="op" id="2097924">]</span><span class="op" id="2097925">.</span><span class="ident" id="2097926">root</span><br>
<span class="lineno"></span><span class="op" id="2097931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="2097934">func</span>&nbsp;<span class="ident" id="2097939">cansemacquire</span><span class="op" id="2097952">(</span><span class="ident" id="2097953">addr</span>&nbsp;<span class="op" id="2097958">*</span><span class="builtintype" id="2097959">uint32</span><span class="op" id="2097965">)</span>&nbsp;<span class="builtintype" id="2097967">bool</span>&nbsp;<span class="op" id="2097972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2097975">for</span>&nbsp;<span class="op" id="2097979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2097983">v</span>&nbsp;<span class="op" id="2097985">:=</span>&nbsp;<span class="ident" id="2097988"><a href="/runtime/atomic.go.html#1874432">atomicload</a></span><span class="op" id="2097998">(</span><span class="ident" id="2097999"><a href="/runtime/sema.go.html#2097953">addr</a></span><span class="op" id="2098003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098007">if</span>&nbsp;<span class="ident" id="2098010"><a href="/runtime/sema.go.html#2097983">v</a></span>&nbsp;<span class="op" id="2098012">==</span>&nbsp;<span class="num" id="2098015">0</span>&nbsp;<span class="op" id="2098017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098022">return</span>&nbsp;<span class="builtintype" id="2098029">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098041">if</span>&nbsp;<span class="ident" id="2098044"><a href="/runtime/stubs.go.html#2137846">cas</a></span><span class="op" id="2098047">(</span><span class="ident" id="2098048"><a href="/runtime/sema.go.html#2097953">addr</a></span><span class="op" id="2098052">,</span>&nbsp;<span class="ident" id="2098054"><a href="/runtime/sema.go.html#2097983">v</a></span><span class="op" id="2098055">,</span>&nbsp;<span class="ident" id="2098057"><a href="/runtime/sema.go.html#2097983">v</a></span><span class="op" id="2098058">-</span><span class="num" id="2098059">1</span><span class="op" id="2098060">)</span>&nbsp;<span class="op" id="2098062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098067">return</span>&nbsp;<span class="builtintype" id="2098074">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098084">}</span><br>
<span class="lineno">150</span><span class="op" id="2098086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2098089">func</span>&nbsp;<span class="op" id="2098094">(</span><span class="ident" id="2098095">root</span>&nbsp;<span class="op" id="2098100">*</span><span class="ident" id="2098101"><a href="/runtime/sema.go.html#2095517">semaRoot</a></span><span class="op" id="2098109">)</span>&nbsp;<span class="ident" id="2098111">queue</span><span class="op" id="2098116">(</span><span class="ident" id="2098117">addr</span>&nbsp;<span class="op" id="2098122">*</span><span class="builtintype" id="2098123">uint32</span><span class="op" id="2098129">,</span>&nbsp;<span class="ident" id="2098131">s</span>&nbsp;<span class="op" id="2098133">*</span><span class="ident" id="2098134"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179851">sudog</a></span><span class="op" id="2098139">)</span>&nbsp;<span class="op" id="2098141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098144"><a href="/runtime/sema.go.html#2098131">s</a></span><span class="op" id="2098145">.</span><span class="ident" id="2098146">g</span>&nbsp;<span class="op" id="2098148">=</span>&nbsp;<span class="ident" id="2098150"><a href="/runtime/stubs.go.html#2132021">getg</a></span><span class="op" id="2098154">(</span><span class="op" id="2098155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098158"><a href="/runtime/sema.go.html#2098131">s</a></span><span class="op" id="2098159">.</span><span class="ident" id="2098160">elem</span>&nbsp;<span class="op" id="2098165">=</span>&nbsp;<span class="ident" id="2098167"><a href="/runtime/sema.go.html#2095459">unsafe</a></span><span class="op" id="2098173">.</span><span class="ident" id="2098174">Pointer</span><span class="op" id="2098181">(</span><span class="ident" id="2098182"><a href="/runtime/sema.go.html#2098117">addr</a></span><span class="op" id="2098186">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098189"><a href="/runtime/sema.go.html#2098131">s</a></span><span class="op" id="2098190">.</span><span class="ident" id="2098191">next</span>&nbsp;<span class="op" id="2098196">=</span>&nbsp;<span class="ident" id="2098198">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098203"><a href="/runtime/sema.go.html#2098131">s</a></span><span class="op" id="2098204">.</span><span class="ident" id="2098205">prev</span>&nbsp;<span class="op" id="2098210">=</span>&nbsp;<span class="ident" id="2098212"><a href="/runtime/sema.go.html#2098095">root</a></span><span class="op" id="2098216">.</span><span class="ident" id="2098217">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098223">if</span>&nbsp;<span class="ident" id="2098226"><a href="/runtime/sema.go.html#2098095">root</a></span><span class="op" id="2098230">.</span><span class="ident" id="2098231">tail</span>&nbsp;<span class="op" id="2098236">!=</span>&nbsp;<span class="ident" id="2098239">nil</span>&nbsp;<span class="op" id="2098243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098247"><a href="/runtime/sema.go.html#2098095">root</a></span><span class="op" id="2098251">.</span><span class="ident" id="2098252">tail</span><span class="op" id="2098256">.</span><span class="ident" id="2098257">next</span>&nbsp;<span class="op" id="2098262">=</span>&nbsp;<span class="ident" id="2098264"><a href="/runtime/sema.go.html#2098131">s</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098267">}</span>&nbsp;<span class="keyword" id="2098269">else</span>&nbsp;<span class="op" id="2098274">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098278"><a href="/runtime/sema.go.html#2098095">root</a></span><span class="op" id="2098282">.</span><span class="ident" id="2098283">head</span>&nbsp;<span class="op" id="2098288">=</span>&nbsp;<span class="ident" id="2098290"><a href="/runtime/sema.go.html#2098131">s</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098296"><a href="/runtime/sema.go.html#2098095">root</a></span><span class="op" id="2098300">.</span><span class="ident" id="2098301">tail</span>&nbsp;<span class="op" id="2098306">=</span>&nbsp;<span class="ident" id="2098308"><a href="/runtime/sema.go.html#2098131">s</a></span><br>
<span class="lineno"></span><span class="op" id="2098310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="2098313">func</span>&nbsp;<span class="op" id="2098318">(</span><span class="ident" id="2098319">root</span>&nbsp;<span class="op" id="2098324">*</span><span class="ident" id="2098325"><a href="/runtime/sema.go.html#2095517">semaRoot</a></span><span class="op" id="2098333">)</span>&nbsp;<span class="ident" id="2098335">dequeue</span><span class="op" id="2098342">(</span><span class="ident" id="2098343">s</span>&nbsp;<span class="op" id="2098345">*</span><span class="ident" id="2098346"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179851">sudog</a></span><span class="op" id="2098351">)</span>&nbsp;<span class="op" id="2098353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098356">if</span>&nbsp;<span class="ident" id="2098359"><a href="/runtime/sema.go.html#2098343">s</a></span><span class="op" id="2098360">.</span><span class="ident" id="2098361">next</span>&nbsp;<span class="op" id="2098366">!=</span>&nbsp;<span class="ident" id="2098369">nil</span>&nbsp;<span class="op" id="2098373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098377"><a href="/runtime/sema.go.html#2098343">s</a></span><span class="op" id="2098378">.</span><span class="ident" id="2098379">next</span><span class="op" id="2098383">.</span><span class="ident" id="2098384">prev</span>&nbsp;<span class="op" id="2098389">=</span>&nbsp;<span class="ident" id="2098391"><a href="/runtime/sema.go.html#2098343">s</a></span><span class="op" id="2098392">.</span><span class="ident" id="2098393">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098399">}</span>&nbsp;<span class="keyword" id="2098401">else</span>&nbsp;<span class="op" id="2098406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098410"><a href="/runtime/sema.go.html#2098319">root</a></span><span class="op" id="2098414">.</span><span class="ident" id="2098415">tail</span>&nbsp;<span class="op" id="2098420">=</span>&nbsp;<span class="ident" id="2098422"><a href="/runtime/sema.go.html#2098343">s</a></span><span class="op" id="2098423">.</span><span class="ident" id="2098424">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098433">if</span>&nbsp;<span class="ident" id="2098436"><a href="/runtime/sema.go.html#2098343">s</a></span><span class="op" id="2098437">.</span><span class="ident" id="2098438">prev</span>&nbsp;<span class="op" id="2098443">!=</span>&nbsp;<span class="ident" id="2098446">nil</span>&nbsp;<span class="op" id="2098450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098454"><a href="/runtime/sema.go.html#2098343">s</a></span><span class="op" id="2098455">.</span><span class="ident" id="2098456">prev</span><span class="op" id="2098460">.</span><span class="ident" id="2098461">next</span>&nbsp;<span class="op" id="2098466">=</span>&nbsp;<span class="ident" id="2098468"><a href="/runtime/sema.go.html#2098343">s</a></span><span class="op" id="2098469">.</span><span class="ident" id="2098470">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098476">}</span>&nbsp;<span class="keyword" id="2098478">else</span>&nbsp;<span class="op" id="2098483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098487"><a href="/runtime/sema.go.html#2098319">root</a></span><span class="op" id="2098491">.</span><span class="ident" id="2098492">head</span>&nbsp;<span class="op" id="2098497">=</span>&nbsp;<span class="ident" id="2098499"><a href="/runtime/sema.go.html#2098343">s</a></span><span class="op" id="2098500">.</span><span class="ident" id="2098501">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2098507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098510"><a href="/runtime/sema.go.html#2098343">s</a></span><span class="op" id="2098511">.</span><span class="ident" id="2098512">elem</span>&nbsp;<span class="op" id="2098517">=</span>&nbsp;<span class="ident" id="2098519">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098524"><a href="/runtime/sema.go.html#2098343">s</a></span><span class="op" id="2098525">.</span><span class="ident" id="2098526">next</span>&nbsp;<span class="op" id="2098531">=</span>&nbsp;<span class="ident" id="2098533">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098538"><a href="/runtime/sema.go.html#2098343">s</a></span><span class="op" id="2098539">.</span><span class="ident" id="2098540">prev</span>&nbsp;<span class="op" id="2098545">=</span>&nbsp;<span class="ident" id="2098547">nil</span><br>
<span class="lineno"></span><span class="op" id="2098551">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="2098554">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="2098594">type</span>&nbsp;<span class="ident" id="2098599">syncSema</span>&nbsp;<span class="keyword" id="2098608">struct</span>&nbsp;<span class="op" id="2098615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098618">lock</span>&nbsp;<span class="ident" id="2098623"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179310">mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098630">head</span>&nbsp;<span class="op" id="2098635">*</span><span class="ident" id="2098636"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179851">sudog</a></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098643">tail</span>&nbsp;<span class="op" id="2098648">*</span><span class="ident" id="2098649"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179851">sudog</a></span><br>
<span class="lineno"></span><span class="op" id="2098655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2098658">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="2098736">func</span>&nbsp;<span class="ident" id="2098741">syncsemacquire</span><span class="op" id="2098755">(</span><span class="ident" id="2098756">s</span>&nbsp;<span class="op" id="2098758">*</span><span class="ident" id="2098759"><a href="/runtime/sema.go.html#2098599">syncSema</a></span><span class="op" id="2098767">)</span>&nbsp;<span class="op" id="2098769">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098772"><a href="/runtime/lock_futex.go.html#1978439">lock</a></span><span class="op" id="2098776">(</span><span class="op" id="2098777">&amp;</span><span class="ident" id="2098778"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2098779">.</span><span class="ident" id="2098780">lock</span><span class="op" id="2098784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098787">if</span>&nbsp;<span class="ident" id="2098790"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2098791">.</span><span class="ident" id="2098792">head</span>&nbsp;<span class="op" id="2098797">!=</span>&nbsp;<span class="ident" id="2098800">nil</span>&nbsp;<span class="op" id="2098804">&amp;&amp;</span>&nbsp;<span class="ident" id="2098807"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2098808">.</span><span class="ident" id="2098809">head</span><span class="op" id="2098813">.</span><span class="ident" id="2098814">nrelease</span>&nbsp;<span class="op" id="2098823">&gt;</span>&nbsp;<span class="num" id="2098825">0</span>&nbsp;<span class="op" id="2098827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2098831">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098870">var</span>&nbsp;<span class="ident" id="2098874">wake</span>&nbsp;<span class="op" id="2098879">*</span><span class="ident" id="2098880"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2179851">sudog</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098888"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2098889">.</span><span class="ident" id="2098890">head</span><span class="op" id="2098894">.</span><span class="ident" id="2098895">nrelease</span><span class="op" id="2098903">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098908">if</span>&nbsp;<span class="ident" id="2098911"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2098912">.</span><span class="ident" id="2098913">head</span><span class="op" id="2098917">.</span><span class="ident" id="2098918">nrelease</span>&nbsp;<span class="op" id="2098927">==</span>&nbsp;<span class="num" id="2098930">0</span>&nbsp;<span class="op" id="2098932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098937"><a href="/runtime/sema.go.html#2098874">wake</a></span>&nbsp;<span class="op" id="2098942">=</span>&nbsp;<span class="ident" id="2098944"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2098945">.</span><span class="ident" id="2098946">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098954"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2098955">.</span><span class="ident" id="2098956">head</span>&nbsp;<span class="op" id="2098961">=</span>&nbsp;<span class="ident" id="2098963"><a href="/runtime/sema.go.html#2098874">wake</a></span><span class="op" id="2098967">.</span><span class="ident" id="2098968">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2098976">if</span>&nbsp;<span class="ident" id="2098979"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2098980">.</span><span class="ident" id="2098981">head</span>&nbsp;<span class="op" id="2098986">==</span>&nbsp;<span class="ident" id="2098989">nil</span>&nbsp;<span class="op" id="2098993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2098999"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2099000">.</span><span class="ident" id="2099001">tail</span>&nbsp;<span class="op" id="2099006">=</span>&nbsp;<span class="ident" id="2099008">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099023"><a href="/runtime/lock_futex.go.html#1979731">unlock</a></span><span class="op" id="2099029">(</span><span class="op" id="2099030">&amp;</span><span class="ident" id="2099031"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2099032">.</span><span class="ident" id="2099033">lock</span><span class="op" id="2099037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2099041">if</span>&nbsp;<span class="ident" id="2099044"><a href="/runtime/sema.go.html#2098874">wake</a></span>&nbsp;<span class="op" id="2099049">!=</span>&nbsp;<span class="ident" id="2099052">nil</span>&nbsp;<span class="op" id="2099056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099061"><a href="/runtime/sema.go.html#2098874">wake</a></span><span class="op" id="2099065">.</span><span class="ident" id="2099066">next</span>&nbsp;<span class="op" id="2099071">=</span>&nbsp;<span class="ident" id="2099073">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099080"><a href="/runtime/proc.go.html#2067021">goready</a></span><span class="op" id="2099087">(</span><span class="ident" id="2099088"><a href="/runtime/sema.go.html#2098874">wake</a></span><span class="op" id="2099092">.</span><span class="ident" id="2099093">g</span><span class="op" id="2099094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099101">}</span>&nbsp;<span class="keyword" id="2099103">else</span>&nbsp;<span class="op" id="2099108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099112">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099133">w</span>&nbsp;<span class="op" id="2099135">:=</span>&nbsp;<span class="ident" id="2099138"><a href="/runtime/proc.go.html#2067140">acquireSudog</a></span><span class="op" id="2099150">(</span><span class="op" id="2099151">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099155"><a href="/runtime/sema.go.html#2099133">w</a></span><span class="op" id="2099156">.</span><span class="ident" id="2099157">g</span>&nbsp;<span class="op" id="2099159">=</span>&nbsp;<span class="ident" id="2099161"><a href="/runtime/stubs.go.html#2132021">getg</a></span><span class="op" id="2099165">(</span><span class="op" id="2099166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099170"><a href="/runtime/sema.go.html#2099133">w</a></span><span class="op" id="2099171">.</span><span class="ident" id="2099172">nrelease</span>&nbsp;<span class="op" id="2099181">=</span>&nbsp;<span class="op" id="2099183">-</span><span class="num" id="2099184">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099188"><a href="/runtime/sema.go.html#2099133">w</a></span><span class="op" id="2099189">.</span><span class="ident" id="2099190">next</span>&nbsp;<span class="op" id="2099195">=</span>&nbsp;<span class="ident" id="2099197">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099203"><a href="/runtime/sema.go.html#2099133">w</a></span><span class="op" id="2099204">.</span><span class="ident" id="2099205">releasetime</span>&nbsp;<span class="op" id="2099217">=</span>&nbsp;<span class="num" id="2099219">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099223">t0</span>&nbsp;<span class="op" id="2099226">:=</span>&nbsp;<span class="ident" id="2099229">int64</span><span class="op" id="2099234">(</span><span class="num" id="2099235">0</span><span class="op" id="2099236">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2099240">if</span>&nbsp;<span class="ident" id="2099243"><a href="/runtime/mprof.go.html#2019313">blockprofilerate</a></span>&nbsp;<span class="op" id="2099260">&gt;</span>&nbsp;<span class="num" id="2099262">0</span>&nbsp;<span class="op" id="2099264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099269"><a href="/runtime/sema.go.html#2099223">t0</a></span>&nbsp;<span class="op" id="2099272">=</span>&nbsp;<span class="ident" id="2099274"><a href="/runtime/stubs.go.html#2137246">cputicks</a></span><span class="op" id="2099282">(</span><span class="op" id="2099283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099288"><a href="/runtime/sema.go.html#2099133">w</a></span><span class="op" id="2099289">.</span><span class="ident" id="2099290">releasetime</span>&nbsp;<span class="op" id="2099302">=</span>&nbsp;<span class="op" id="2099304">-</span><span class="num" id="2099305">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2099313">if</span>&nbsp;<span class="ident" id="2099316"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2099317">.</span><span class="ident" id="2099318">tail</span>&nbsp;<span class="op" id="2099323">==</span>&nbsp;<span class="ident" id="2099326">nil</span>&nbsp;<span class="op" id="2099330">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099335"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2099336">.</span><span class="ident" id="2099337">head</span>&nbsp;<span class="op" id="2099342">=</span>&nbsp;<span class="ident" id="2099344"><a href="/runtime/sema.go.html#2099133">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099348">}</span>&nbsp;<span class="keyword" id="2099350">else</span>&nbsp;<span class="op" id="2099355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099360"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2099361">.</span><span class="ident" id="2099362">tail</span><span class="op" id="2099366">.</span><span class="ident" id="2099367">next</span>&nbsp;<span class="op" id="2099372">=</span>&nbsp;<span class="ident" id="2099374"><a href="/runtime/sema.go.html#2099133">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099382"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2099383">.</span><span class="ident" id="2099384">tail</span>&nbsp;<span class="op" id="2099389">=</span>&nbsp;<span class="ident" id="2099391"><a href="/runtime/sema.go.html#2099133">w</a></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099395"><a href="/runtime/proc.go.html#2066901">goparkunlock</a></span><span class="op" id="2099407">(</span><span class="op" id="2099408">&amp;</span><span class="ident" id="2099409"><a href="/runtime/sema.go.html#2098756">s</a></span><span class="op" id="2099410">.</span><span class="ident" id="2099411">lock</span><span class="op" id="2099415">,</span>&nbsp;<span class="string" id="2099417">&#34;semacquire&#34;</span><span class="op" id="2099429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2099433">if</span>&nbsp;<span class="ident" id="2099436"><a href="/runtime/sema.go.html#2099223">t0</a></span>&nbsp;<span class="op" id="2099439">!=</span>&nbsp;<span class="num" id="2099442">0</span>&nbsp;<span class="op" id="2099444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099449"><a href="/runtime/mprof.go.html#2020096">blockevent</a></span><span class="op" id="2099459">(</span><span class="ident" id="2099460">int64</span><span class="op" id="2099465">(</span><span class="ident" id="2099466"><a href="/runtime/sema.go.html#2099133">w</a></span><span class="op" id="2099467">.</span><span class="ident" id="2099468">releasetime</span><span class="op" id="2099479">)</span><span class="op" id="2099480">-</span><span class="ident" id="2099481"><a href="/runtime/sema.go.html#2099223">t0</a></span><span class="op" id="2099483">,</span>&nbsp;<span class="num" id="2099485">2</span><span class="op" id="2099486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099494"><a href="/runtime/proc.go.html#2067870">releaseSudog</a></span><span class="op" id="2099506">(</span><span class="ident" id="2099507"><a href="/runtime/sema.go.html#2099133">w</a></span><span class="op" id="2099508">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099511">}</span><br>
<span class="lineno"></span><span class="op" id="2099513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2099516">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="2099594">func</span>&nbsp;<span class="ident" id="2099599">syncsemrelease</span><span class="op" id="2099613">(</span><span class="ident" id="2099614">s</span>&nbsp;<span class="op" id="2099616">*</span><span class="ident" id="2099617"><a href="/runtime/sema.go.html#2098599">syncSema</a></span><span class="op" id="2099625">,</span>&nbsp;<span class="ident" id="2099627">n</span>&nbsp;<span class="builtintype" id="2099629">uint32</span><span class="op" id="2099635">)</span>&nbsp;<span class="op" id="2099637">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099640"><a href="/runtime/lock_futex.go.html#1978439">lock</a></span><span class="op" id="2099644">(</span><span class="op" id="2099645">&amp;</span><span class="ident" id="2099646"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2099647">.</span><span class="ident" id="2099648">lock</span><span class="op" id="2099652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2099655">for</span>&nbsp;<span class="ident" id="2099659"><a href="/runtime/sema.go.html#2099627">n</a></span>&nbsp;<span class="op" id="2099661">&gt;</span>&nbsp;<span class="num" id="2099663">0</span>&nbsp;<span class="op" id="2099665">&amp;&amp;</span>&nbsp;<span class="ident" id="2099668"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2099669">.</span><span class="ident" id="2099670">head</span>&nbsp;<span class="op" id="2099675">!=</span>&nbsp;<span class="ident" id="2099678">nil</span>&nbsp;<span class="op" id="2099682">&amp;&amp;</span>&nbsp;<span class="ident" id="2099685"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2099686">.</span><span class="ident" id="2099687">head</span><span class="op" id="2099691">.</span><span class="ident" id="2099692">nrelease</span>&nbsp;<span class="op" id="2099701">&lt;</span>&nbsp;<span class="num" id="2099703">0</span>&nbsp;<span class="op" id="2099705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099709">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099748">wake</span>&nbsp;<span class="op" id="2099753">:=</span>&nbsp;<span class="ident" id="2099756"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2099757">.</span><span class="ident" id="2099758">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099765"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2099766">.</span><span class="ident" id="2099767">head</span>&nbsp;<span class="op" id="2099772">=</span>&nbsp;<span class="ident" id="2099774"><a href="/runtime/sema.go.html#2099748">wake</a></span><span class="op" id="2099778">.</span><span class="ident" id="2099779">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2099786">if</span>&nbsp;<span class="ident" id="2099789"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2099790">.</span><span class="ident" id="2099791">head</span>&nbsp;<span class="op" id="2099796">==</span>&nbsp;<span class="ident" id="2099799">nil</span>&nbsp;<span class="op" id="2099803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099808"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2099809">.</span><span class="ident" id="2099810">tail</span>&nbsp;<span class="op" id="2099815">=</span>&nbsp;<span class="ident" id="2099817">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2099827">if</span>&nbsp;<span class="ident" id="2099830"><a href="/runtime/sema.go.html#2099748">wake</a></span><span class="op" id="2099834">.</span><span class="ident" id="2099835">releasetime</span>&nbsp;<span class="op" id="2099847">!=</span>&nbsp;<span class="num" id="2099850">0</span>&nbsp;<span class="op" id="2099852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099857"><a href="/runtime/sema.go.html#2099748">wake</a></span><span class="op" id="2099861">.</span><span class="ident" id="2099862">releasetime</span>&nbsp;<span class="op" id="2099874">=</span>&nbsp;<span class="ident" id="2099876"><a href="/runtime/stubs.go.html#2137246">cputicks</a></span><span class="op" id="2099884">(</span><span class="op" id="2099885">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099893"><a href="/runtime/sema.go.html#2099748">wake</a></span><span class="op" id="2099897">.</span><span class="ident" id="2099898">next</span>&nbsp;<span class="op" id="2099903">=</span>&nbsp;<span class="ident" id="2099905">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099911"><a href="/runtime/proc.go.html#2067021">goready</a></span><span class="op" id="2099918">(</span><span class="ident" id="2099919"><a href="/runtime/sema.go.html#2099748">wake</a></span><span class="op" id="2099923">.</span><span class="ident" id="2099924">g</span><span class="op" id="2099925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099929"><a href="/runtime/sema.go.html#2099627">n</a></span><span class="op" id="2099930">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2099934">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2099937">if</span>&nbsp;<span class="ident" id="2099940"><a href="/runtime/sema.go.html#2099627">n</a></span>&nbsp;<span class="op" id="2099942">&gt;</span>&nbsp;<span class="num" id="2099944">0</span>&nbsp;<span class="op" id="2099946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2099950">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099970">w</span>&nbsp;<span class="op" id="2099972">:=</span>&nbsp;<span class="ident" id="2099975"><a href="/runtime/proc.go.html#2067140">acquireSudog</a></span><span class="op" id="2099987">(</span><span class="op" id="2099988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2099992"><a href="/runtime/sema.go.html#2099970">w</a></span><span class="op" id="2099993">.</span><span class="ident" id="2099994">g</span>&nbsp;<span class="op" id="2099996">=</span>&nbsp;<span class="ident" id="2099998"><a href="/runtime/stubs.go.html#2132021">getg</a></span><span class="op" id="2100002">(</span><span class="op" id="2100003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100007"><a href="/runtime/sema.go.html#2099970">w</a></span><span class="op" id="2100008">.</span><span class="ident" id="2100009">nrelease</span>&nbsp;<span class="op" id="2100018">=</span>&nbsp;<span class="builtintype" id="2100020">int32</span><span class="op" id="2100025">(</span><span class="ident" id="2100026"><a href="/runtime/sema.go.html#2099627">n</a></span><span class="op" id="2100027">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100031"><a href="/runtime/sema.go.html#2099970">w</a></span><span class="op" id="2100032">.</span><span class="ident" id="2100033">next</span>&nbsp;<span class="op" id="2100038">=</span>&nbsp;<span class="ident" id="2100040">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100046"><a href="/runtime/sema.go.html#2099970">w</a></span><span class="op" id="2100047">.</span><span class="ident" id="2100048">releasetime</span>&nbsp;<span class="op" id="2100060">=</span>&nbsp;<span class="num" id="2100062">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2100066">if</span>&nbsp;<span class="ident" id="2100069"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2100070">.</span><span class="ident" id="2100071">tail</span>&nbsp;<span class="op" id="2100076">==</span>&nbsp;<span class="ident" id="2100079">nil</span>&nbsp;<span class="op" id="2100083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100088"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2100089">.</span><span class="ident" id="2100090">head</span>&nbsp;<span class="op" id="2100095">=</span>&nbsp;<span class="ident" id="2100097"><a href="/runtime/sema.go.html#2099970">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100101">}</span>&nbsp;<span class="keyword" id="2100103">else</span>&nbsp;<span class="op" id="2100108">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100113"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2100114">.</span><span class="ident" id="2100115">tail</span><span class="op" id="2100119">.</span><span class="ident" id="2100120">next</span>&nbsp;<span class="op" id="2100125">=</span>&nbsp;<span class="ident" id="2100127"><a href="/runtime/sema.go.html#2099970">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100135"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2100136">.</span><span class="ident" id="2100137">tail</span>&nbsp;<span class="op" id="2100142">=</span>&nbsp;<span class="ident" id="2100144"><a href="/runtime/sema.go.html#2099970">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100148"><a href="/runtime/proc.go.html#2066901">goparkunlock</a></span><span class="op" id="2100160">(</span><span class="op" id="2100161">&amp;</span><span class="ident" id="2100162"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2100163">.</span><span class="ident" id="2100164">lock</span><span class="op" id="2100168">,</span>&nbsp;<span class="string" id="2100170">&#34;semarelease&#34;</span><span class="op" id="2100183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100187"><a href="/runtime/proc.go.html#2067870">releaseSudog</a></span><span class="op" id="2100199">(</span><span class="ident" id="2100200"><a href="/runtime/sema.go.html#2099970">w</a></span><span class="op" id="2100201">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100204">}</span>&nbsp;<span class="keyword" id="2100206">else</span>&nbsp;<span class="op" id="2100211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100215"><a href="/runtime/lock_futex.go.html#1979731">unlock</a></span><span class="op" id="2100221">(</span><span class="op" id="2100222">&amp;</span><span class="ident" id="2100223"><a href="/runtime/sema.go.html#2099614">s</a></span><span class="op" id="2100224">.</span><span class="ident" id="2100225">lock</span><span class="op" id="2100229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100232">}</span><br>
<span class="lineno"></span><span class="op" id="2100234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="2100237">func</span>&nbsp;<span class="ident" id="2100242">syncsemcheck</span><span class="op" id="2100254">(</span><span class="ident" id="2100255">sz</span>&nbsp;<span class="builtintype" id="2100258">uintptr</span><span class="op" id="2100265">)</span>&nbsp;<span class="op" id="2100267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2100270">if</span>&nbsp;<span class="ident" id="2100273"><a href="/runtime/sema.go.html#2100255">sz</a></span>&nbsp;<span class="op" id="2100276">!=</span>&nbsp;<span class="ident" id="2100279"><a href="/runtime/sema.go.html#2095459">unsafe</a></span><span class="op" id="2100285">.</span><span class="ident" id="2100286">Sizeof</span><span class="op" id="2100292">(</span><span class="ident" id="2100293"><a href="/runtime/sema.go.html#2098599">syncSema</a></span><span class="op" id="2100301">{</span><span class="op" id="2100302">}</span><span class="op" id="2100303">)</span>&nbsp;<span class="op" id="2100305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2100309">print</span><span class="op" id="2100314">(</span><span class="string" id="2100315">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="2100351">,</span>&nbsp;<span class="ident" id="2100353"><a href="/runtime/sema.go.html#2100255">sz</a></span><span class="op" id="2100355">,</span>&nbsp;<span class="string" id="2100357">&#34;&nbsp;runtime=&#34;</span><span class="op" id="2100368">,</span>&nbsp;<span class="ident" id="2100370"><a href="/runtime/sema.go.html#2095459">unsafe</a></span><span class="op" id="2100376">.</span><span class="ident" id="2100377">Sizeof</span><span class="op" id="2100383">(</span><span class="ident" id="2100384"><a href="/runtime/sema.go.html#2098599">syncSema</a></span><span class="op" id="2100392">{</span><span class="op" id="2100393">}</span><span class="op" id="2100394">)</span><span class="op" id="2100395">,</span>&nbsp;<span class="string" id="2100397">&#34;\n&#34;</span><span class="op" id="2100401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2100405"><a href="/runtime/panic.go.html#2057429">gothrow</a></span><span class="op" id="2100412">(</span><span class="string" id="2100413">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="2100432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2100435">}</span><br>
<span class="lineno">275</span><span class="op" id="2100437">}</span>
</div>
</body>
</html>
