<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5523547">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5523602">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5523656">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5523707">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="5523785">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5523861">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5523892">//</span><br>
<span class="lineno"></span><span class="comment" id="5523895">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="5523961">//</span><br>
<span class="lineno"></span><span class="comment" id="5523964">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5524034">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="5524058">//</span><br>
<span class="lineno"></span><span class="comment" id="5524061">//&nbsp;&nbsp;&nbsp;&nbspcmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="5524082">//&nbsp;&nbsp;&nbsp;&nbspmemstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="5524112">//</span><br>
<span class="lineno"></span><span class="comment" id="5524115">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5524180">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5524248">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="5524298">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5524319">//</span><br>
<span class="lineno"></span><span class="keyword" id="5524322">package</span>&nbsp;<span class="ident" id="5524330">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5524338">import</span>&nbsp;<span class="op" id="5524345">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5524348">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5524357">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5524374">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5524381">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5524388">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5524400">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5524406">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5524417">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5524425">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5524436">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="5524443">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5524446">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5524501">type</span>&nbsp;<span class="ident" id="5524506">Var</span>&nbsp;<span class="keyword" id="5524510">interface</span>&nbsp;<span class="op" id="5524520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524523">String</span><span class="op" id="5524529">(</span><span class="op" id="5524530">)</span>&nbsp;<span class="builtintype" id="5524532">string</span><br>
<span class="lineno">40</span><span class="op" id="5524539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5524542">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5524612">type</span>&nbsp;<span class="ident" id="5524617">Int</span>&nbsp;<span class="keyword" id="5524621">struct</span>&nbsp;<span class="op" id="5524628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524631">mu</span>&nbsp;<span class="ident" id="5524634">sync</span><span class="op" id="5524638">.</span><span class="ident" id="5524639">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524648">i</span>&nbsp;&nbsp;<span class="ident" id="5524651">int64</span><br>
<span class="lineno"></span><span class="op" id="5524657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5524660">func</span>&nbsp;<span class="op" id="5524665">(</span><span class="ident" id="5524666">v</span>&nbsp;<span class="op" id="5524668">*</span><span class="ident" id="5524669">Int</span><span class="op" id="5524672">)</span>&nbsp;<span class="ident" id="5524674">String</span><span class="op" id="5524680">(</span><span class="op" id="5524681">)</span>&nbsp;<span class="builtintype" id="5524683">string</span>&nbsp;<span class="op" id="5524690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524693">v</span><span class="op" id="5524694">.</span><span class="ident" id="5524695">mu</span><span class="op" id="5524697">.</span><span class="ident" id="5524698">RLock</span><span class="op" id="5524703">(</span><span class="op" id="5524704">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5524707">defer</span>&nbsp;<span class="ident" id="5524713">v</span><span class="op" id="5524714">.</span><span class="ident" id="5524715">mu</span><span class="op" id="5524717">.</span><span class="ident" id="5524718">RUnlock</span><span class="op" id="5524725">(</span><span class="op" id="5524726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5524729">return</span>&nbsp;<span class="ident" id="5524736">strconv</span><span class="op" id="5524743">.</span><span class="ident" id="5524744">FormatInt</span><span class="op" id="5524753">(</span><span class="ident" id="5524754">v</span><span class="op" id="5524755">.</span><span class="ident" id="5524756">i</span><span class="op" id="5524757">,</span>&nbsp;<span class="num" id="5524759">10</span><span class="op" id="5524761">)</span><br>
<span class="lineno"></span><span class="op" id="5524763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5524766">func</span>&nbsp;<span class="op" id="5524771">(</span><span class="ident" id="5524772">v</span>&nbsp;<span class="op" id="5524774">*</span><span class="ident" id="5524775">Int</span><span class="op" id="5524778">)</span>&nbsp;<span class="ident" id="5524780">Add</span><span class="op" id="5524783">(</span><span class="ident" id="5524784">delta</span>&nbsp;<span class="ident" id="5524790">int64</span><span class="op" id="5524795">)</span>&nbsp;<span class="op" id="5524797">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524800">v</span><span class="op" id="5524801">.</span><span class="ident" id="5524802">mu</span><span class="op" id="5524804">.</span><span class="ident" id="5524805">Lock</span><span class="op" id="5524809">(</span><span class="op" id="5524810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5524813">defer</span>&nbsp;<span class="ident" id="5524819">v</span><span class="op" id="5524820">.</span><span class="ident" id="5524821">mu</span><span class="op" id="5524823">.</span><span class="ident" id="5524824">Unlock</span><span class="op" id="5524830">(</span><span class="op" id="5524831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524834">v</span><span class="op" id="5524835">.</span><span class="ident" id="5524836">i</span>&nbsp;<span class="op" id="5524838">+=</span>&nbsp;<span class="ident" id="5524841">delta</span><br>
<span class="lineno"></span><span class="op" id="5524847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5524850">func</span>&nbsp;<span class="op" id="5524855">(</span><span class="ident" id="5524856">v</span>&nbsp;<span class="op" id="5524858">*</span><span class="ident" id="5524859">Int</span><span class="op" id="5524862">)</span>&nbsp;<span class="ident" id="5524864">Set</span><span class="op" id="5524867">(</span><span class="ident" id="5524868">value</span>&nbsp;<span class="ident" id="5524874">int64</span><span class="op" id="5524879">)</span>&nbsp;<span class="op" id="5524881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524884">v</span><span class="op" id="5524885">.</span><span class="ident" id="5524886">mu</span><span class="op" id="5524888">.</span><span class="ident" id="5524889">Lock</span><span class="op" id="5524893">(</span><span class="op" id="5524894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5524897">defer</span>&nbsp;<span class="ident" id="5524903">v</span><span class="op" id="5524904">.</span><span class="ident" id="5524905">mu</span><span class="op" id="5524907">.</span><span class="ident" id="5524908">Unlock</span><span class="op" id="5524914">(</span><span class="op" id="5524915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5524918">v</span><span class="op" id="5524919">.</span><span class="ident" id="5524920">i</span>&nbsp;<span class="op" id="5524922">=</span>&nbsp;<span class="ident" id="5524924">value</span><br>
<span class="lineno"></span><span class="op" id="5524930">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="5524933">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5525003">type</span>&nbsp;<span class="ident" id="5525008">Float</span>&nbsp;<span class="keyword" id="5525014">struct</span>&nbsp;<span class="op" id="5525021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525024">mu</span>&nbsp;<span class="ident" id="5525027">sync</span><span class="op" id="5525031">.</span><span class="ident" id="5525032">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525041">f</span>&nbsp;&nbsp;<span class="builtintype" id="5525044">float64</span><br>
<span class="lineno">70</span><span class="op" id="5525052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5525055">func</span>&nbsp;<span class="op" id="5525060">(</span><span class="ident" id="5525061">v</span>&nbsp;<span class="op" id="5525063">*</span><span class="ident" id="5525064">Float</span><span class="op" id="5525069">)</span>&nbsp;<span class="ident" id="5525071">String</span><span class="op" id="5525077">(</span><span class="op" id="5525078">)</span>&nbsp;<span class="builtintype" id="5525080">string</span>&nbsp;<span class="op" id="5525087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525090">v</span><span class="op" id="5525091">.</span><span class="ident" id="5525092">mu</span><span class="op" id="5525094">.</span><span class="ident" id="5525095">RLock</span><span class="op" id="5525100">(</span><span class="op" id="5525101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525104">defer</span>&nbsp;<span class="ident" id="5525110">v</span><span class="op" id="5525111">.</span><span class="ident" id="5525112">mu</span><span class="op" id="5525114">.</span><span class="ident" id="5525115">RUnlock</span><span class="op" id="5525122">(</span><span class="op" id="5525123">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525126">return</span>&nbsp;<span class="ident" id="5525133">strconv</span><span class="op" id="5525140">.</span><span class="ident" id="5525141">FormatFloat</span><span class="op" id="5525152">(</span><span class="ident" id="5525153">v</span><span class="op" id="5525154">.</span><span class="ident" id="5525155">f</span><span class="op" id="5525156">,</span>&nbsp;<span class="string" id="5525158">&#39;g&#39;</span><span class="op" id="5525161">,</span>&nbsp;<span class="op" id="5525163">-</span><span class="num" id="5525164">1</span><span class="op" id="5525165">,</span>&nbsp;<span class="num" id="5525167">64</span><span class="op" id="5525169">)</span><br>
<span class="lineno"></span><span class="op" id="5525171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5525174">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="5525198">func</span>&nbsp;<span class="op" id="5525203">(</span><span class="ident" id="5525204">v</span>&nbsp;<span class="op" id="5525206">*</span><span class="ident" id="5525207">Float</span><span class="op" id="5525212">)</span>&nbsp;<span class="ident" id="5525214">Add</span><span class="op" id="5525217">(</span><span class="ident" id="5525218">delta</span>&nbsp;<span class="builtintype" id="5525224">float64</span><span class="op" id="5525231">)</span>&nbsp;<span class="op" id="5525233">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525236">v</span><span class="op" id="5525237">.</span><span class="ident" id="5525238">mu</span><span class="op" id="5525240">.</span><span class="ident" id="5525241">Lock</span><span class="op" id="5525245">(</span><span class="op" id="5525246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525249">defer</span>&nbsp;<span class="ident" id="5525255">v</span><span class="op" id="5525256">.</span><span class="ident" id="5525257">mu</span><span class="op" id="5525259">.</span><span class="ident" id="5525260">Unlock</span><span class="op" id="5525266">(</span><span class="op" id="5525267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525270">v</span><span class="op" id="5525271">.</span><span class="ident" id="5525272">f</span>&nbsp;<span class="op" id="5525274">+=</span>&nbsp;<span class="ident" id="5525277">delta</span><br>
<span class="lineno"></span><span class="op" id="5525283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="5525286">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="5525310">func</span>&nbsp;<span class="op" id="5525315">(</span><span class="ident" id="5525316">v</span>&nbsp;<span class="op" id="5525318">*</span><span class="ident" id="5525319">Float</span><span class="op" id="5525324">)</span>&nbsp;<span class="ident" id="5525326">Set</span><span class="op" id="5525329">(</span><span class="ident" id="5525330">value</span>&nbsp;<span class="builtintype" id="5525336">float64</span><span class="op" id="5525343">)</span>&nbsp;<span class="op" id="5525345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525348">v</span><span class="op" id="5525349">.</span><span class="ident" id="5525350">mu</span><span class="op" id="5525352">.</span><span class="ident" id="5525353">Lock</span><span class="op" id="5525357">(</span><span class="op" id="5525358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525361">defer</span>&nbsp;<span class="ident" id="5525367">v</span><span class="op" id="5525368">.</span><span class="ident" id="5525369">mu</span><span class="op" id="5525371">.</span><span class="ident" id="5525372">Unlock</span><span class="op" id="5525378">(</span><span class="op" id="5525379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525382">v</span><span class="op" id="5525383">.</span><span class="ident" id="5525384">f</span>&nbsp;<span class="op" id="5525386">=</span>&nbsp;<span class="ident" id="5525388">value</span><br>
<span class="lineno">90</span><span class="op" id="5525394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5525397">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5525470">type</span>&nbsp;<span class="ident" id="5525475">Map</span>&nbsp;<span class="keyword" id="5525479">struct</span>&nbsp;<span class="op" id="5525486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525489">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5525494">sync</span><span class="op" id="5525498">.</span><span class="ident" id="5525499">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525508">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5525513">map</span><span class="op" id="5525516">[</span><span class="builtintype" id="5525517">string</span><span class="op" id="5525523">]</span><span class="ident" id="5525524">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525529">keys</span>&nbsp;<span class="op" id="5525534">[</span><span class="op" id="5525535">]</span><span class="builtintype" id="5525536">string</span>&nbsp;<span class="comment" id="5525543">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5525553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5525556">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="5525604">type</span>&nbsp;<span class="ident" id="5525609">KeyValue</span>&nbsp;<span class="keyword" id="5525618">struct</span>&nbsp;<span class="op" id="5525625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525628">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5525634">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525642">Value</span>&nbsp;<span class="ident" id="5525648">Var</span><br>
<span class="lineno"></span><span class="op" id="5525652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="5525655">func</span>&nbsp;<span class="op" id="5525660">(</span><span class="ident" id="5525661">v</span>&nbsp;<span class="op" id="5525663">*</span><span class="ident" id="5525664">Map</span><span class="op" id="5525667">)</span>&nbsp;<span class="ident" id="5525669">String</span><span class="op" id="5525675">(</span><span class="op" id="5525676">)</span>&nbsp;<span class="builtintype" id="5525678">string</span>&nbsp;<span class="op" id="5525685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525688">v</span><span class="op" id="5525689">.</span><span class="ident" id="5525690">mu</span><span class="op" id="5525692">.</span><span class="ident" id="5525693">RLock</span><span class="op" id="5525698">(</span><span class="op" id="5525699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525702">defer</span>&nbsp;<span class="ident" id="5525708">v</span><span class="op" id="5525709">.</span><span class="ident" id="5525710">mu</span><span class="op" id="5525712">.</span><span class="ident" id="5525713">RUnlock</span><span class="op" id="5525720">(</span><span class="op" id="5525721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525724">var</span>&nbsp;<span class="ident" id="5525728">b</span>&nbsp;<span class="ident" id="5525730">bytes</span><span class="op" id="5525735">.</span><span class="ident" id="5525736">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525744">fmt</span><span class="op" id="5525747">.</span><span class="ident" id="5525748">Fprintf</span><span class="op" id="5525755">(</span><span class="op" id="5525756">&amp;</span><span class="ident" id="5525757">b</span><span class="op" id="5525758">,</span>&nbsp;<span class="string" id="5525760">&#34;{&#34;</span><span class="op" id="5525763">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525766">first</span>&nbsp;<span class="op" id="5525772">:=</span>&nbsp;<span class="builtintype" id="5525775">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525781">v</span><span class="op" id="5525782">.</span><span class="ident" id="5525783">doLocked</span><span class="op" id="5525791">(</span><span class="keyword" id="5525792">func</span><span class="op" id="5525796">(</span><span class="ident" id="5525797">kv</span>&nbsp;<span class="ident" id="5525800">KeyValue</span><span class="op" id="5525808">)</span>&nbsp;<span class="op" id="5525810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525814">if</span>&nbsp;<span class="op" id="5525817">!</span><span class="ident" id="5525818">first</span>&nbsp;<span class="op" id="5525824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525829">fmt</span><span class="op" id="5525832">.</span><span class="ident" id="5525833">Fprintf</span><span class="op" id="5525840">(</span><span class="op" id="5525841">&amp;</span><span class="ident" id="5525842">b</span><span class="op" id="5525843">,</span>&nbsp;<span class="string" id="5525845">&#34;,&nbsp;&#34;</span><span class="op" id="5525849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5525853">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525857">fmt</span><span class="op" id="5525860">.</span><span class="ident" id="5525861">Fprintf</span><span class="op" id="5525868">(</span><span class="op" id="5525869">&amp;</span><span class="ident" id="5525870">b</span><span class="op" id="5525871">,</span>&nbsp;<span class="string" id="5525873">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="5525881">,</span>&nbsp;<span class="ident" id="5525883">kv</span><span class="op" id="5525885">.</span><span class="ident" id="5525886">Key</span><span class="op" id="5525889">,</span>&nbsp;<span class="ident" id="5525891">kv</span><span class="op" id="5525893">.</span><span class="ident" id="5525894">Value</span><span class="op" id="5525899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525903">first</span>&nbsp;<span class="op" id="5525909">=</span>&nbsp;<span class="builtintype" id="5525911">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5525918">}</span><span class="op" id="5525919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525922">fmt</span><span class="op" id="5525925">.</span><span class="ident" id="5525926">Fprintf</span><span class="op" id="5525933">(</span><span class="op" id="5525934">&amp;</span><span class="ident" id="5525935">b</span><span class="op" id="5525936">,</span>&nbsp;<span class="string" id="5525938">&#34;}&#34;</span><span class="op" id="5525941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5525944">return</span>&nbsp;<span class="ident" id="5525951">b</span><span class="op" id="5525952">.</span><span class="ident" id="5525953">String</span><span class="op" id="5525959">(</span><span class="op" id="5525960">)</span><br>
<span class="lineno">120</span><span class="op" id="5525962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5525965">func</span>&nbsp;<span class="op" id="5525970">(</span><span class="ident" id="5525971">v</span>&nbsp;<span class="op" id="5525973">*</span><span class="ident" id="5525974">Map</span><span class="op" id="5525977">)</span>&nbsp;<span class="ident" id="5525979">Init</span><span class="op" id="5525983">(</span><span class="op" id="5525984">)</span>&nbsp;<span class="op" id="5525986">*</span><span class="ident" id="5525987">Map</span>&nbsp;<span class="op" id="5525991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5525994">v</span><span class="op" id="5525995">.</span><span class="ident" id="5525996">m</span>&nbsp;<span class="op" id="5525998">=</span>&nbsp;<span class="builtinfunc" id="5526000">make</span><span class="op" id="5526004">(</span><span class="keyword" id="5526005">map</span><span class="op" id="5526008">[</span><span class="builtintype" id="5526009">string</span><span class="op" id="5526015">]</span><span class="ident" id="5526016">Var</span><span class="op" id="5526019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5526022">return</span>&nbsp;<span class="ident" id="5526029">v</span><br>
<span class="lineno">125</span><span class="op" id="5526031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5526034">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="5526091">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5526125">func</span>&nbsp;<span class="op" id="5526130">(</span><span class="ident" id="5526131">v</span>&nbsp;<span class="op" id="5526133">*</span><span class="ident" id="5526134">Map</span><span class="op" id="5526137">)</span>&nbsp;<span class="ident" id="5526139">updateKeys</span><span class="op" id="5526149">(</span><span class="op" id="5526150">)</span>&nbsp;<span class="op" id="5526152">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5526155">if</span>&nbsp;<span class="builtinfunc" id="5526158">len</span><span class="op" id="5526161">(</span><span class="ident" id="5526162">v</span><span class="op" id="5526163">.</span><span class="ident" id="5526164">m</span><span class="op" id="5526165">)</span>&nbsp;<span class="op" id="5526167">==</span>&nbsp;<span class="builtinfunc" id="5526170">len</span><span class="op" id="5526173">(</span><span class="ident" id="5526174">v</span><span class="op" id="5526175">.</span><span class="ident" id="5526176">keys</span><span class="op" id="5526180">)</span>&nbsp;<span class="op" id="5526182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5526186">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5526203">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5526211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526214">v</span><span class="op" id="5526215">.</span><span class="ident" id="5526216">keys</span>&nbsp;<span class="op" id="5526221">=</span>&nbsp;<span class="ident" id="5526223">v</span><span class="op" id="5526224">.</span><span class="ident" id="5526225">keys</span><span class="op" id="5526229">[</span><span class="op" id="5526230">:</span><span class="num" id="5526231">0</span><span class="op" id="5526232">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5526235">for</span>&nbsp;<span class="ident" id="5526239">k</span>&nbsp;<span class="op" id="5526241">:=</span>&nbsp;<span class="keyword" id="5526244">range</span>&nbsp;<span class="ident" id="5526250">v</span><span class="op" id="5526251">.</span><span class="ident" id="5526252">m</span>&nbsp;<span class="op" id="5526254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526258">v</span><span class="op" id="5526259">.</span><span class="ident" id="5526260">keys</span>&nbsp;<span class="op" id="5526265">=</span>&nbsp;<span class="builtinfunc" id="5526267">append</span><span class="op" id="5526273">(</span><span class="ident" id="5526274">v</span><span class="op" id="5526275">.</span><span class="ident" id="5526276">keys</span><span class="op" id="5526280">,</span>&nbsp;<span class="ident" id="5526282">k</span><span class="op" id="5526283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5526286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526289">sort</span><span class="op" id="5526293">.</span><span class="ident" id="5526294">Strings</span><span class="op" id="5526301">(</span><span class="ident" id="5526302">v</span><span class="op" id="5526303">.</span><span class="ident" id="5526304">keys</span><span class="op" id="5526308">)</span><br>
<span class="lineno"></span><span class="op" id="5526310">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="5526313">func</span>&nbsp;<span class="op" id="5526318">(</span><span class="ident" id="5526319">v</span>&nbsp;<span class="op" id="5526321">*</span><span class="ident" id="5526322">Map</span><span class="op" id="5526325">)</span>&nbsp;<span class="ident" id="5526327">Get</span><span class="op" id="5526330">(</span><span class="ident" id="5526331">key</span>&nbsp;<span class="builtintype" id="5526335">string</span><span class="op" id="5526341">)</span>&nbsp;<span class="ident" id="5526343">Var</span>&nbsp;<span class="op" id="5526347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526350">v</span><span class="op" id="5526351">.</span><span class="ident" id="5526352">mu</span><span class="op" id="5526354">.</span><span class="ident" id="5526355">RLock</span><span class="op" id="5526360">(</span><span class="op" id="5526361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5526364">defer</span>&nbsp;<span class="ident" id="5526370">v</span><span class="op" id="5526371">.</span><span class="ident" id="5526372">mu</span><span class="op" id="5526374">.</span><span class="ident" id="5526375">RUnlock</span><span class="op" id="5526382">(</span><span class="op" id="5526383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5526386">return</span>&nbsp;<span class="ident" id="5526393">v</span><span class="op" id="5526394">.</span><span class="ident" id="5526395">m</span><span class="op" id="5526396">[</span><span class="ident" id="5526397">key</span><span class="op" id="5526400">]</span><br>
<span class="lineno">145</span><span class="op" id="5526402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5526405">func</span>&nbsp;<span class="op" id="5526410">(</span><span class="ident" id="5526411">v</span>&nbsp;<span class="op" id="5526413">*</span><span class="ident" id="5526414">Map</span><span class="op" id="5526417">)</span>&nbsp;<span class="ident" id="5526419">Set</span><span class="op" id="5526422">(</span><span class="ident" id="5526423">key</span>&nbsp;<span class="builtintype" id="5526427">string</span><span class="op" id="5526433">,</span>&nbsp;<span class="ident" id="5526435">av</span>&nbsp;<span class="ident" id="5526438">Var</span><span class="op" id="5526441">)</span>&nbsp;<span class="op" id="5526443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526446">v</span><span class="op" id="5526447">.</span><span class="ident" id="5526448">mu</span><span class="op" id="5526450">.</span><span class="ident" id="5526451">Lock</span><span class="op" id="5526455">(</span><span class="op" id="5526456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5526459">defer</span>&nbsp;<span class="ident" id="5526465">v</span><span class="op" id="5526466">.</span><span class="ident" id="5526467">mu</span><span class="op" id="5526469">.</span><span class="ident" id="5526470">Unlock</span><span class="op" id="5526476">(</span><span class="op" id="5526477">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526480">v</span><span class="op" id="5526481">.</span><span class="ident" id="5526482">m</span><span class="op" id="5526483">[</span><span class="ident" id="5526484">key</span><span class="op" id="5526487">]</span>&nbsp;<span class="op" id="5526489">=</span>&nbsp;<span class="ident" id="5526491">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526495">v</span><span class="op" id="5526496">.</span><span class="ident" id="5526497">updateKeys</span><span class="op" id="5526507">(</span><span class="op" id="5526508">)</span><br>
<span class="lineno"></span><span class="op" id="5526510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5526513">func</span>&nbsp;<span class="op" id="5526518">(</span><span class="ident" id="5526519">v</span>&nbsp;<span class="op" id="5526521">*</span><span class="ident" id="5526522">Map</span><span class="op" id="5526525">)</span>&nbsp;<span class="ident" id="5526527">Add</span><span class="op" id="5526530">(</span><span class="ident" id="5526531">key</span>&nbsp;<span class="builtintype" id="5526535">string</span><span class="op" id="5526541">,</span>&nbsp;<span class="ident" id="5526543">delta</span>&nbsp;<span class="ident" id="5526549">int64</span><span class="op" id="5526554">)</span>&nbsp;<span class="op" id="5526556">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526559">v</span><span class="op" id="5526560">.</span><span class="ident" id="5526561">mu</span><span class="op" id="5526563">.</span><span class="ident" id="5526564">RLock</span><span class="op" id="5526569">(</span><span class="op" id="5526570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526573">av</span><span class="op" id="5526575">,</span>&nbsp;<span class="ident" id="5526577">ok</span>&nbsp;<span class="op" id="5526580">:=</span>&nbsp;<span class="ident" id="5526583">v</span><span class="op" id="5526584">.</span><span class="ident" id="5526585">m</span><span class="op" id="5526586">[</span><span class="ident" id="5526587">key</span><span class="op" id="5526590">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526593">v</span><span class="op" id="5526594">.</span><span class="ident" id="5526595">mu</span><span class="op" id="5526597">.</span><span class="ident" id="5526598">RUnlock</span><span class="op" id="5526605">(</span><span class="op" id="5526606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5526609">if</span>&nbsp;<span class="op" id="5526612">!</span><span class="ident" id="5526613">ok</span>&nbsp;<span class="op" id="5526616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5526620">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526658">v</span><span class="op" id="5526659">.</span><span class="ident" id="5526660">mu</span><span class="op" id="5526662">.</span><span class="ident" id="5526663">Lock</span><span class="op" id="5526667">(</span><span class="op" id="5526668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526672">av</span><span class="op" id="5526674">,</span>&nbsp;<span class="ident" id="5526676">ok</span>&nbsp;<span class="op" id="5526679">=</span>&nbsp;<span class="ident" id="5526681">v</span><span class="op" id="5526682">.</span><span class="ident" id="5526683">m</span><span class="op" id="5526684">[</span><span class="ident" id="5526685">key</span><span class="op" id="5526688">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5526692">if</span>&nbsp;<span class="op" id="5526695">!</span><span class="ident" id="5526696">ok</span>&nbsp;<span class="op" id="5526699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526704">av</span>&nbsp;<span class="op" id="5526707">=</span>&nbsp;<span class="builtinfunc" id="5526709">new</span><span class="op" id="5526712">(</span><span class="ident" id="5526713">Int</span><span class="op" id="5526716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526721">v</span><span class="op" id="5526722">.</span><span class="ident" id="5526723">m</span><span class="op" id="5526724">[</span><span class="ident" id="5526725">key</span><span class="op" id="5526728">]</span>&nbsp;<span class="op" id="5526730">=</span>&nbsp;<span class="ident" id="5526732">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526738">v</span><span class="op" id="5526739">.</span><span class="ident" id="5526740">updateKeys</span><span class="op" id="5526750">(</span><span class="op" id="5526751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5526755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526759">v</span><span class="op" id="5526760">.</span><span class="ident" id="5526761">mu</span><span class="op" id="5526763">.</span><span class="ident" id="5526764">Unlock</span><span class="op" id="5526770">(</span><span class="op" id="5526771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5526774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5526778">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5526812">if</span>&nbsp;<span class="ident" id="5526815">iv</span><span class="op" id="5526817">,</span>&nbsp;<span class="ident" id="5526819">ok</span>&nbsp;<span class="op" id="5526822">:=</span>&nbsp;<span class="ident" id="5526825">av</span><span class="op" id="5526827">.</span><span class="op" id="5526828">(</span><span class="op" id="5526829">*</span><span class="ident" id="5526830">Int</span><span class="op" id="5526833">)</span><span class="op" id="5526834">;</span>&nbsp;<span class="ident" id="5526836">ok</span>&nbsp;<span class="op" id="5526839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526843">iv</span><span class="op" id="5526845">.</span><span class="ident" id="5526846">Add</span><span class="op" id="5526849">(</span><span class="ident" id="5526850">delta</span><span class="op" id="5526855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5526858">}</span><br>
<span class="lineno"></span><span class="op" id="5526860">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="5526863">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="5526938">func</span>&nbsp;<span class="op" id="5526943">(</span><span class="ident" id="5526944">v</span>&nbsp;<span class="op" id="5526946">*</span><span class="ident" id="5526947">Map</span><span class="op" id="5526950">)</span>&nbsp;<span class="ident" id="5526952">AddFloat</span><span class="op" id="5526960">(</span><span class="ident" id="5526961">key</span>&nbsp;<span class="builtintype" id="5526965">string</span><span class="op" id="5526971">,</span>&nbsp;<span class="ident" id="5526973">delta</span>&nbsp;<span class="builtintype" id="5526979">float64</span><span class="op" id="5526986">)</span>&nbsp;<span class="op" id="5526988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5526991">v</span><span class="op" id="5526992">.</span><span class="ident" id="5526993">mu</span><span class="op" id="5526995">.</span><span class="ident" id="5526996">RLock</span><span class="op" id="5527001">(</span><span class="op" id="5527002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527005">av</span><span class="op" id="5527007">,</span>&nbsp;<span class="ident" id="5527009">ok</span>&nbsp;<span class="op" id="5527012">:=</span>&nbsp;<span class="ident" id="5527015">v</span><span class="op" id="5527016">.</span><span class="ident" id="5527017">m</span><span class="op" id="5527018">[</span><span class="ident" id="5527019">key</span><span class="op" id="5527022">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527025">v</span><span class="op" id="5527026">.</span><span class="ident" id="5527027">mu</span><span class="op" id="5527029">.</span><span class="ident" id="5527030">RUnlock</span><span class="op" id="5527037">(</span><span class="op" id="5527038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5527041">if</span>&nbsp;<span class="op" id="5527044">!</span><span class="ident" id="5527045">ok</span>&nbsp;<span class="op" id="5527048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5527052">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527090">v</span><span class="op" id="5527091">.</span><span class="ident" id="5527092">mu</span><span class="op" id="5527094">.</span><span class="ident" id="5527095">Lock</span><span class="op" id="5527099">(</span><span class="op" id="5527100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527104">av</span><span class="op" id="5527106">,</span>&nbsp;<span class="ident" id="5527108">ok</span>&nbsp;<span class="op" id="5527111">=</span>&nbsp;<span class="ident" id="5527113">v</span><span class="op" id="5527114">.</span><span class="ident" id="5527115">m</span><span class="op" id="5527116">[</span><span class="ident" id="5527117">key</span><span class="op" id="5527120">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5527124">if</span>&nbsp;<span class="op" id="5527127">!</span><span class="ident" id="5527128">ok</span>&nbsp;<span class="op" id="5527131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527136">av</span>&nbsp;<span class="op" id="5527139">=</span>&nbsp;<span class="builtinfunc" id="5527141">new</span><span class="op" id="5527144">(</span><span class="ident" id="5527145">Float</span><span class="op" id="5527150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527155">v</span><span class="op" id="5527156">.</span><span class="ident" id="5527157">m</span><span class="op" id="5527158">[</span><span class="ident" id="5527159">key</span><span class="op" id="5527162">]</span>&nbsp;<span class="op" id="5527164">=</span>&nbsp;<span class="ident" id="5527166">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527172">v</span><span class="op" id="5527173">.</span><span class="ident" id="5527174">updateKeys</span><span class="op" id="5527184">(</span><span class="op" id="5527185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5527189">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527193">v</span><span class="op" id="5527194">.</span><span class="ident" id="5527195">mu</span><span class="op" id="5527197">.</span><span class="ident" id="5527198">Unlock</span><span class="op" id="5527204">(</span><span class="op" id="5527205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5527208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5527212">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5527248">if</span>&nbsp;<span class="ident" id="5527251">iv</span><span class="op" id="5527253">,</span>&nbsp;<span class="ident" id="5527255">ok</span>&nbsp;<span class="op" id="5527258">:=</span>&nbsp;<span class="ident" id="5527261">av</span><span class="op" id="5527263">.</span><span class="op" id="5527264">(</span><span class="op" id="5527265">*</span><span class="ident" id="5527266">Float</span><span class="op" id="5527271">)</span><span class="op" id="5527272">;</span>&nbsp;<span class="ident" id="5527274">ok</span>&nbsp;<span class="op" id="5527277">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527281">iv</span><span class="op" id="5527283">.</span><span class="ident" id="5527284">Add</span><span class="op" id="5527287">(</span><span class="ident" id="5527288">delta</span><span class="op" id="5527293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5527296">}</span><br>
<span class="lineno"></span><span class="op" id="5527298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5527301">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="5527342">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5527385">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5527438">func</span>&nbsp;<span class="op" id="5527443">(</span><span class="ident" id="5527444">v</span>&nbsp;<span class="op" id="5527446">*</span><span class="ident" id="5527447">Map</span><span class="op" id="5527450">)</span>&nbsp;<span class="ident" id="5527452">Do</span><span class="op" id="5527454">(</span><span class="ident" id="5527455">f</span>&nbsp;<span class="keyword" id="5527457">func</span><span class="op" id="5527461">(</span><span class="ident" id="5527462">KeyValue</span><span class="op" id="5527470">)</span><span class="op" id="5527471">)</span>&nbsp;<span class="op" id="5527473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527476">v</span><span class="op" id="5527477">.</span><span class="ident" id="5527478">mu</span><span class="op" id="5527480">.</span><span class="ident" id="5527481">RLock</span><span class="op" id="5527486">(</span><span class="op" id="5527487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5527490">defer</span>&nbsp;<span class="ident" id="5527496">v</span><span class="op" id="5527497">.</span><span class="ident" id="5527498">mu</span><span class="op" id="5527500">.</span><span class="ident" id="5527501">RUnlock</span><span class="op" id="5527508">(</span><span class="op" id="5527509">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527512">v</span><span class="op" id="5527513">.</span><span class="ident" id="5527514">doLocked</span><span class="op" id="5527522">(</span><span class="ident" id="5527523">f</span><span class="op" id="5527524">)</span><br>
<span class="lineno"></span><span class="op" id="5527526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5527529">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="5527576">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="5527608">func</span>&nbsp;<span class="op" id="5527613">(</span><span class="ident" id="5527614">v</span>&nbsp;<span class="op" id="5527616">*</span><span class="ident" id="5527617">Map</span><span class="op" id="5527620">)</span>&nbsp;<span class="ident" id="5527622">doLocked</span><span class="op" id="5527630">(</span><span class="ident" id="5527631">f</span>&nbsp;<span class="keyword" id="5527633">func</span><span class="op" id="5527637">(</span><span class="ident" id="5527638">KeyValue</span><span class="op" id="5527646">)</span><span class="op" id="5527647">)</span>&nbsp;<span class="op" id="5527649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5527652">for</span>&nbsp;<span class="ident" id="5527656">_</span><span class="op" id="5527657">,</span>&nbsp;<span class="ident" id="5527659">k</span>&nbsp;<span class="op" id="5527661">:=</span>&nbsp;<span class="keyword" id="5527664">range</span>&nbsp;<span class="ident" id="5527670">v</span><span class="op" id="5527671">.</span><span class="ident" id="5527672">keys</span>&nbsp;<span class="op" id="5527677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527681">f</span><span class="op" id="5527682">(</span><span class="ident" id="5527683">KeyValue</span><span class="op" id="5527691">{</span><span class="ident" id="5527692">k</span><span class="op" id="5527693">,</span>&nbsp;<span class="ident" id="5527695">v</span><span class="op" id="5527696">.</span><span class="ident" id="5527697">m</span><span class="op" id="5527698">[</span><span class="ident" id="5527699">k</span><span class="op" id="5527700">]</span><span class="op" id="5527701">}</span><span class="op" id="5527702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5527705">}</span><br>
<span class="lineno"></span><span class="op" id="5527707">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="5527710">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="5527775">type</span>&nbsp;<span class="ident" id="5527780">String</span>&nbsp;<span class="keyword" id="5527787">struct</span>&nbsp;<span class="op" id="5527794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527797">mu</span>&nbsp;<span class="ident" id="5527800">sync</span><span class="op" id="5527804">.</span><span class="ident" id="5527805">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527814">s</span>&nbsp;&nbsp;<span class="builtintype" id="5527817">string</span><br>
<span class="lineno">220</span><span class="op" id="5527824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5527827">func</span>&nbsp;<span class="op" id="5527832">(</span><span class="ident" id="5527833">v</span>&nbsp;<span class="op" id="5527835">*</span><span class="ident" id="5527836">String</span><span class="op" id="5527842">)</span>&nbsp;<span class="ident" id="5527844">String</span><span class="op" id="5527850">(</span><span class="op" id="5527851">)</span>&nbsp;<span class="builtintype" id="5527853">string</span>&nbsp;<span class="op" id="5527860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527863">v</span><span class="op" id="5527864">.</span><span class="ident" id="5527865">mu</span><span class="op" id="5527867">.</span><span class="ident" id="5527868">RLock</span><span class="op" id="5527873">(</span><span class="op" id="5527874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5527877">defer</span>&nbsp;<span class="ident" id="5527883">v</span><span class="op" id="5527884">.</span><span class="ident" id="5527885">mu</span><span class="op" id="5527887">.</span><span class="ident" id="5527888">RUnlock</span><span class="op" id="5527895">(</span><span class="op" id="5527896">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5527899">return</span>&nbsp;<span class="ident" id="5527906">strconv</span><span class="op" id="5527913">.</span><span class="ident" id="5527914">Quote</span><span class="op" id="5527919">(</span><span class="ident" id="5527920">v</span><span class="op" id="5527921">.</span><span class="ident" id="5527922">s</span><span class="op" id="5527923">)</span><br>
<span class="lineno"></span><span class="op" id="5527925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5527928">func</span>&nbsp;<span class="op" id="5527933">(</span><span class="ident" id="5527934">v</span>&nbsp;<span class="op" id="5527936">*</span><span class="ident" id="5527937">String</span><span class="op" id="5527943">)</span>&nbsp;<span class="ident" id="5527945">Set</span><span class="op" id="5527948">(</span><span class="ident" id="5527949">value</span>&nbsp;<span class="builtintype" id="5527955">string</span><span class="op" id="5527961">)</span>&nbsp;<span class="op" id="5527963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5527966">v</span><span class="op" id="5527967">.</span><span class="ident" id="5527968">mu</span><span class="op" id="5527970">.</span><span class="ident" id="5527971">Lock</span><span class="op" id="5527975">(</span><span class="op" id="5527976">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5527979">defer</span>&nbsp;<span class="ident" id="5527985">v</span><span class="op" id="5527986">.</span><span class="ident" id="5527987">mu</span><span class="op" id="5527989">.</span><span class="ident" id="5527990">Unlock</span><span class="op" id="5527996">(</span><span class="op" id="5527997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528000">v</span><span class="op" id="5528001">.</span><span class="ident" id="5528002">s</span>&nbsp;<span class="op" id="5528004">=</span>&nbsp;<span class="ident" id="5528006">value</span><br>
<span class="lineno"></span><span class="op" id="5528012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5528015">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="5528062">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="5528111">type</span>&nbsp;<span class="ident" id="5528116">Func</span>&nbsp;<span class="keyword" id="5528121">func</span><span class="op" id="5528125">(</span><span class="op" id="5528126">)</span>&nbsp;<span class="keyword" id="5528128">interface</span><span class="op" id="5528137">{</span><span class="op" id="5528138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5528141">func</span>&nbsp;<span class="op" id="5528146">(</span><span class="ident" id="5528147">f</span>&nbsp;<span class="ident" id="5528149">Func</span><span class="op" id="5528153">)</span>&nbsp;<span class="ident" id="5528155">String</span><span class="op" id="5528161">(</span><span class="op" id="5528162">)</span>&nbsp;<span class="builtintype" id="5528164">string</span>&nbsp;<span class="op" id="5528171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528174">v</span><span class="op" id="5528175">,</span>&nbsp;<span class="ident" id="5528177">_</span>&nbsp;<span class="op" id="5528179">:=</span>&nbsp;<span class="ident" id="5528182">json</span><span class="op" id="5528186">.</span><span class="ident" id="5528187">Marshal</span><span class="op" id="5528194">(</span><span class="ident" id="5528195">f</span><span class="op" id="5528196">(</span><span class="op" id="5528197">)</span><span class="op" id="5528198">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528201">return</span>&nbsp;<span class="builtintype" id="5528208">string</span><span class="op" id="5528214">(</span><span class="ident" id="5528215">v</span><span class="op" id="5528216">)</span><br>
<span class="lineno"></span><span class="op" id="5528218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5528221">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="5528249">var</span>&nbsp;<span class="op" id="5528253">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528256">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5528264">sync</span><span class="op" id="5528268">.</span><span class="ident" id="5528269">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528278">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5528286">=</span>&nbsp;<span class="builtinfunc" id="5528288">make</span><span class="op" id="5528292">(</span><span class="keyword" id="5528293">map</span><span class="op" id="5528296">[</span><span class="builtintype" id="5528297">string</span><span class="op" id="5528303">]</span><span class="ident" id="5528304">Var</span><span class="op" id="5528307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528310">varKeys</span>&nbsp;<span class="op" id="5528318">[</span><span class="op" id="5528319">]</span><span class="builtintype" id="5528320">string</span>&nbsp;<span class="comment" id="5528327">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="5528337">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="5528340">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5528416">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="5528492">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5528532">func</span>&nbsp;<span class="ident" id="5528537">Publish</span><span class="op" id="5528544">(</span><span class="ident" id="5528545">name</span>&nbsp;<span class="builtintype" id="5528550">string</span><span class="op" id="5528556">,</span>&nbsp;<span class="ident" id="5528558">v</span>&nbsp;<span class="ident" id="5528560">Var</span><span class="op" id="5528563">)</span>&nbsp;<span class="op" id="5528565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528568">mutex</span><span class="op" id="5528573">.</span><span class="ident" id="5528574">Lock</span><span class="op" id="5528578">(</span><span class="op" id="5528579">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528582">defer</span>&nbsp;<span class="ident" id="5528588">mutex</span><span class="op" id="5528593">.</span><span class="ident" id="5528594">Unlock</span><span class="op" id="5528600">(</span><span class="op" id="5528601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528604">if</span>&nbsp;<span class="ident" id="5528607">_</span><span class="op" id="5528608">,</span>&nbsp;<span class="ident" id="5528610">existing</span>&nbsp;<span class="op" id="5528619">:=</span>&nbsp;<span class="ident" id="5528622">vars</span><span class="op" id="5528626">[</span><span class="ident" id="5528627">name</span><span class="op" id="5528631">]</span><span class="op" id="5528632">;</span>&nbsp;<span class="ident" id="5528634">existing</span>&nbsp;<span class="op" id="5528643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528647">log</span><span class="op" id="5528650">.</span><span class="ident" id="5528651">Panicln</span><span class="op" id="5528658">(</span><span class="string" id="5528659">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="5528688">,</span>&nbsp;<span class="ident" id="5528690">name</span><span class="op" id="5528694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5528697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528700">vars</span><span class="op" id="5528704">[</span><span class="ident" id="5528705">name</span><span class="op" id="5528709">]</span>&nbsp;<span class="op" id="5528711">=</span>&nbsp;<span class="ident" id="5528713">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528716">varKeys</span>&nbsp;<span class="op" id="5528724">=</span>&nbsp;<span class="builtinfunc" id="5528726">append</span><span class="op" id="5528732">(</span><span class="ident" id="5528733">varKeys</span><span class="op" id="5528740">,</span>&nbsp;<span class="ident" id="5528742">name</span><span class="op" id="5528746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528749">sort</span><span class="op" id="5528753">.</span><span class="ident" id="5528754">Strings</span><span class="op" id="5528761">(</span><span class="ident" id="5528762">varKeys</span><span class="op" id="5528769">)</span><br>
<span class="lineno"></span><span class="op" id="5528771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5528774">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="5528818">func</span>&nbsp;<span class="ident" id="5528823">Get</span><span class="op" id="5528826">(</span><span class="ident" id="5528827">name</span>&nbsp;<span class="builtintype" id="5528832">string</span><span class="op" id="5528838">)</span>&nbsp;<span class="ident" id="5528840">Var</span>&nbsp;<span class="op" id="5528844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5528847">mutex</span><span class="op" id="5528852">.</span><span class="ident" id="5528853">RLock</span><span class="op" id="5528858">(</span><span class="op" id="5528859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528862">defer</span>&nbsp;<span class="ident" id="5528868">mutex</span><span class="op" id="5528873">.</span><span class="ident" id="5528874">RUnlock</span><span class="op" id="5528881">(</span><span class="op" id="5528882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5528885">return</span>&nbsp;<span class="ident" id="5528892">vars</span><span class="op" id="5528896">[</span><span class="ident" id="5528897">name</span><span class="op" id="5528901">]</span><br>
<span class="lineno"></span><span class="op" id="5528903">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="5528906">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5528969">func</span>&nbsp;<span class="ident" id="5528974">NewInt</span><span class="op" id="5528980">(</span><span class="ident" id="5528981">name</span>&nbsp;<span class="builtintype" id="5528986">string</span><span class="op" id="5528992">)</span>&nbsp;<span class="op" id="5528994">*</span><span class="ident" id="5528995">Int</span>&nbsp;<span class="op" id="5528999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529002">v</span>&nbsp;<span class="op" id="5529004">:=</span>&nbsp;<span class="builtinfunc" id="5529007">new</span><span class="op" id="5529010">(</span><span class="ident" id="5529011">Int</span><span class="op" id="5529014">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529017">Publish</span><span class="op" id="5529024">(</span><span class="ident" id="5529025">name</span><span class="op" id="5529029">,</span>&nbsp;<span class="ident" id="5529031">v</span><span class="op" id="5529032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529035">return</span>&nbsp;<span class="ident" id="5529042">v</span><br>
<span class="lineno"></span><span class="op" id="5529044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5529047">func</span>&nbsp;<span class="ident" id="5529052">NewFloat</span><span class="op" id="5529060">(</span><span class="ident" id="5529061">name</span>&nbsp;<span class="builtintype" id="5529066">string</span><span class="op" id="5529072">)</span>&nbsp;<span class="op" id="5529074">*</span><span class="ident" id="5529075">Float</span>&nbsp;<span class="op" id="5529081">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529084">v</span>&nbsp;<span class="op" id="5529086">:=</span>&nbsp;<span class="builtinfunc" id="5529089">new</span><span class="op" id="5529092">(</span><span class="ident" id="5529093">Float</span><span class="op" id="5529098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529101">Publish</span><span class="op" id="5529108">(</span><span class="ident" id="5529109">name</span><span class="op" id="5529113">,</span>&nbsp;<span class="ident" id="5529115">v</span><span class="op" id="5529116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529119">return</span>&nbsp;<span class="ident" id="5529126">v</span><br>
<span class="lineno"></span><span class="op" id="5529128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5529131">func</span>&nbsp;<span class="ident" id="5529136">NewMap</span><span class="op" id="5529142">(</span><span class="ident" id="5529143">name</span>&nbsp;<span class="builtintype" id="5529148">string</span><span class="op" id="5529154">)</span>&nbsp;<span class="op" id="5529156">*</span><span class="ident" id="5529157">Map</span>&nbsp;<span class="op" id="5529161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529164">v</span>&nbsp;<span class="op" id="5529166">:=</span>&nbsp;<span class="builtinfunc" id="5529169">new</span><span class="op" id="5529172">(</span><span class="ident" id="5529173">Map</span><span class="op" id="5529176">)</span><span class="op" id="5529177">.</span><span class="ident" id="5529178">Init</span><span class="op" id="5529182">(</span><span class="op" id="5529183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529186">Publish</span><span class="op" id="5529193">(</span><span class="ident" id="5529194">name</span><span class="op" id="5529198">,</span>&nbsp;<span class="ident" id="5529200">v</span><span class="op" id="5529201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529204">return</span>&nbsp;<span class="ident" id="5529211">v</span><br>
<span class="lineno"></span><span class="op" id="5529213">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="5529216">func</span>&nbsp;<span class="ident" id="5529221">NewString</span><span class="op" id="5529230">(</span><span class="ident" id="5529231">name</span>&nbsp;<span class="builtintype" id="5529236">string</span><span class="op" id="5529242">)</span>&nbsp;<span class="op" id="5529244">*</span><span class="ident" id="5529245">String</span>&nbsp;<span class="op" id="5529252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529255">v</span>&nbsp;<span class="op" id="5529257">:=</span>&nbsp;<span class="builtinfunc" id="5529260">new</span><span class="op" id="5529263">(</span><span class="ident" id="5529264">String</span><span class="op" id="5529270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529273">Publish</span><span class="op" id="5529280">(</span><span class="ident" id="5529281">name</span><span class="op" id="5529285">,</span>&nbsp;<span class="ident" id="5529287">v</span><span class="op" id="5529288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529291">return</span>&nbsp;<span class="ident" id="5529298">v</span><br>
<span class="lineno">295</span><span class="op" id="5529300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5529303">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="5529345">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="5529404">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="5529457">func</span>&nbsp;<span class="ident" id="5529462">Do</span><span class="op" id="5529464">(</span><span class="ident" id="5529465">f</span>&nbsp;<span class="keyword" id="5529467">func</span><span class="op" id="5529471">(</span><span class="ident" id="5529472">KeyValue</span><span class="op" id="5529480">)</span><span class="op" id="5529481">)</span>&nbsp;<span class="op" id="5529483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529486">mutex</span><span class="op" id="5529491">.</span><span class="ident" id="5529492">RLock</span><span class="op" id="5529497">(</span><span class="op" id="5529498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529501">defer</span>&nbsp;<span class="ident" id="5529507">mutex</span><span class="op" id="5529512">.</span><span class="ident" id="5529513">RUnlock</span><span class="op" id="5529520">(</span><span class="op" id="5529521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529524">for</span>&nbsp;<span class="ident" id="5529528">_</span><span class="op" id="5529529">,</span>&nbsp;<span class="ident" id="5529531">k</span>&nbsp;<span class="op" id="5529533">:=</span>&nbsp;<span class="keyword" id="5529536">range</span>&nbsp;<span class="ident" id="5529542">varKeys</span>&nbsp;<span class="op" id="5529550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529554">f</span><span class="op" id="5529555">(</span><span class="ident" id="5529556">KeyValue</span><span class="op" id="5529564">{</span><span class="ident" id="5529565">k</span><span class="op" id="5529566">,</span>&nbsp;<span class="ident" id="5529568">vars</span><span class="op" id="5529572">[</span><span class="ident" id="5529573">k</span><span class="op" id="5529574">]</span><span class="op" id="5529575">}</span><span class="op" id="5529576">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529579">}</span><br>
<span class="lineno"></span><span class="op" id="5529581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5529584">func</span>&nbsp;<span class="ident" id="5529589">expvarHandler</span><span class="op" id="5529602">(</span><span class="ident" id="5529603">w</span>&nbsp;<span class="ident" id="5529605">http</span><span class="op" id="5529609">.</span><span class="ident" id="5529610">ResponseWriter</span><span class="op" id="5529624">,</span>&nbsp;<span class="ident" id="5529626">r</span>&nbsp;<span class="op" id="5529628">*</span><span class="ident" id="5529629">http</span><span class="op" id="5529633">.</span><span class="ident" id="5529634">Request</span><span class="op" id="5529641">)</span>&nbsp;<span class="op" id="5529643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529646">w</span><span class="op" id="5529647">.</span><span class="ident" id="5529648">Header</span><span class="op" id="5529654">(</span><span class="op" id="5529655">)</span><span class="op" id="5529656">.</span><span class="ident" id="5529657">Set</span><span class="op" id="5529660">(</span><span class="string" id="5529661">&#34;Content-Type&#34;</span><span class="op" id="5529675">,</span>&nbsp;<span class="string" id="5529677">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="5529710">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529713">fmt</span><span class="op" id="5529716">.</span><span class="ident" id="5529717">Fprintf</span><span class="op" id="5529724">(</span><span class="ident" id="5529725">w</span><span class="op" id="5529726">,</span>&nbsp;<span class="string" id="5529728">&#34;{\n&#34;</span><span class="op" id="5529733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529736">first</span>&nbsp;<span class="op" id="5529742">:=</span>&nbsp;<span class="builtintype" id="5529745">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529751">Do</span><span class="op" id="5529753">(</span><span class="keyword" id="5529754">func</span><span class="op" id="5529758">(</span><span class="ident" id="5529759">kv</span>&nbsp;<span class="ident" id="5529762">KeyValue</span><span class="op" id="5529770">)</span>&nbsp;<span class="op" id="5529772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529776">if</span>&nbsp;<span class="op" id="5529779">!</span><span class="ident" id="5529780">first</span>&nbsp;<span class="op" id="5529786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529791">fmt</span><span class="op" id="5529794">.</span><span class="ident" id="5529795">Fprintf</span><span class="op" id="5529802">(</span><span class="ident" id="5529803">w</span><span class="op" id="5529804">,</span>&nbsp;<span class="string" id="5529806">&#34;,\n&#34;</span><span class="op" id="5529811">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529819">first</span>&nbsp;<span class="op" id="5529825">=</span>&nbsp;<span class="builtintype" id="5529827">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529835">fmt</span><span class="op" id="5529838">.</span><span class="ident" id="5529839">Fprintf</span><span class="op" id="5529846">(</span><span class="ident" id="5529847">w</span><span class="op" id="5529848">,</span>&nbsp;<span class="string" id="5529850">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="5529858">,</span>&nbsp;<span class="ident" id="5529860">kv</span><span class="op" id="5529862">.</span><span class="ident" id="5529863">Key</span><span class="op" id="5529866">,</span>&nbsp;<span class="ident" id="5529868">kv</span><span class="op" id="5529870">.</span><span class="ident" id="5529871">Value</span><span class="op" id="5529876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5529879">}</span><span class="op" id="5529880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529883">fmt</span><span class="op" id="5529886">.</span><span class="ident" id="5529887">Fprintf</span><span class="op" id="5529894">(</span><span class="ident" id="5529895">w</span><span class="op" id="5529896">,</span>&nbsp;<span class="string" id="5529898">&#34;\n}\n&#34;</span><span class="op" id="5529905">)</span><br>
<span class="lineno">320</span><span class="op" id="5529907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5529910">func</span>&nbsp;<span class="ident" id="5529915">cmdline</span><span class="op" id="5529922">(</span><span class="op" id="5529923">)</span>&nbsp;<span class="keyword" id="5529925">interface</span><span class="op" id="5529934">{</span><span class="op" id="5529935">}</span>&nbsp;<span class="op" id="5529937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5529940">return</span>&nbsp;<span class="ident" id="5529947">os</span><span class="op" id="5529949">.</span><span class="ident" id="5529950">Args</span><br>
<span class="lineno"></span><span class="op" id="5529955">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="5529958">func</span>&nbsp;<span class="ident" id="5529963">memstats</span><span class="op" id="5529971">(</span><span class="op" id="5529972">)</span>&nbsp;<span class="keyword" id="5529974">interface</span><span class="op" id="5529983">{</span><span class="op" id="5529984">}</span>&nbsp;<span class="op" id="5529986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5529989">stats</span>&nbsp;<span class="op" id="5529995">:=</span>&nbsp;<span class="builtinfunc" id="5529998">new</span><span class="op" id="5530001">(</span><span class="ident" id="5530002">runtime</span><span class="op" id="5530009">.</span><span class="ident" id="5530010">MemStats</span><span class="op" id="5530018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530021">runtime</span><span class="op" id="5530028">.</span><span class="ident" id="5530029">ReadMemStats</span><span class="op" id="5530041">(</span><span class="ident" id="5530042">stats</span><span class="op" id="5530047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5530050">return</span>&nbsp;<span class="op" id="5530057">*</span><span class="ident" id="5530058">stats</span><br>
<span class="lineno">330</span><span class="op" id="5530064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5530067">func</span>&nbsp;<span class="ident" id="5530072">init</span><span class="op" id="5530076">(</span><span class="op" id="5530077">)</span>&nbsp;<span class="op" id="5530079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530082">http</span><span class="op" id="5530086">.</span><span class="ident" id="5530087">HandleFunc</span><span class="op" id="5530097">(</span><span class="string" id="5530098">&#34;/debug/vars&#34;</span><span class="op" id="5530111">,</span>&nbsp;<span class="ident" id="5530113">expvarHandler</span><span class="op" id="5530126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530129">Publish</span><span class="op" id="5530136">(</span><span class="string" id="5530137">&#34;cmdline&#34;</span><span class="op" id="5530146">,</span>&nbsp;<span class="ident" id="5530148">Func</span><span class="op" id="5530152">(</span><span class="ident" id="5530153">cmdline</span><span class="op" id="5530160">)</span><span class="op" id="5530161">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5530164">Publish</span><span class="op" id="5530171">(</span><span class="string" id="5530172">&#34;memstats&#34;</span><span class="op" id="5530182">,</span>&nbsp;<span class="ident" id="5530184">Func</span><span class="op" id="5530188">(</span><span class="ident" id="5530189">memstats</span><span class="op" id="5530197">)</span><span class="op" id="5530198">)</span><br>
<span class="lineno"></span><span class="op" id="5530200">}</span>
</div>
</body>
</html>
