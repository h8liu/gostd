<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html" class="current">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1440019">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1440074">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1440128">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1440179">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1440252">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1440332">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1440407">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1440454">//</span><br>
<span class="lineno">10</span><span class="comment" id="1440457">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1440534">package</span>&nbsp;<span class="ident" id="1440542">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1440548">import</span>&nbsp;<span class="op" id="1440555">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1440558">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1440573">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1440582">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1440585">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1440624">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1440679">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1440731">type</span>&nbsp;<span class="ident" id="1440736">Mutex</span>&nbsp;<span class="keyword" id="1440742">struct</span>&nbsp;<span class="op" id="1440749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440752">state</span>&nbsp;<span class="builtintype" id="1440758">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440765">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1440771">uint32</span><br>
<span class="lineno"></span><span class="op" id="1440778">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1440781">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1440847">type</span>&nbsp;<span class="ident" id="1440852">Locker</span>&nbsp;<span class="keyword" id="1440859">interface</span>&nbsp;<span class="op" id="1440869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440872">Lock</span><span class="op" id="1440876">(</span><span class="op" id="1440877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440880">Unlock</span><span class="op" id="1440886">(</span><span class="op" id="1440887">)</span><br>
<span class="lineno">30</span><span class="op" id="1440889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1440892">const</span>&nbsp;<span class="op" id="1440898">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440901">mutexLocked</span>&nbsp;<span class="op" id="1440913">=</span>&nbsp;<span class="num" id="1440915">1</span>&nbsp;<span class="op" id="1440917">&lt;&lt;</span>&nbsp;<span class="ident" id="1440920">iota</span>&nbsp;<span class="comment" id="1440925">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440945">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1440957">mutexWaiterShift</span>&nbsp;<span class="op" id="1440974">=</span>&nbsp;<span class="ident" id="1440976">iota</span><br>
<span class="lineno"></span><span class="op" id="1440981">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1440984">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1441001">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1441057">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1441097">func</span>&nbsp;<span class="op" id="1441102">(</span><span class="ident" id="1441103">m</span>&nbsp;<span class="op" id="1441105">*</span><span class="ident" id="1441106">Mutex</span><span class="op" id="1441111">)</span>&nbsp;<span class="ident" id="1441113">Lock</span><span class="op" id="1441117">(</span><span class="op" id="1441118">)</span>&nbsp;<span class="op" id="1441120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441123">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441159">if</span>&nbsp;<span class="ident" id="1441162">atomic</span><span class="op" id="1441168">.</span><span class="ident" id="1441169">CompareAndSwapInt32</span><span class="op" id="1441188">(</span><span class="op" id="1441189">&amp;</span><span class="ident" id="1441190">m</span><span class="op" id="1441191">.</span><span class="ident" id="1441192">state</span><span class="op" id="1441197">,</span>&nbsp;<span class="num" id="1441199">0</span><span class="op" id="1441200">,</span>&nbsp;<span class="ident" id="1441202">mutexLocked</span><span class="op" id="1441213">)</span>&nbsp;<span class="op" id="1441215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441219">if</span>&nbsp;<span class="ident" id="1441222">raceenabled</span>&nbsp;<span class="op" id="1441234">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441239">raceAcquire</span><span class="op" id="1441250">(</span><span class="ident" id="1441251">unsafe</span><span class="op" id="1441257">.</span><span class="ident" id="1441258">Pointer</span><span class="op" id="1441265">(</span><span class="ident" id="1441266">m</span><span class="op" id="1441267">)</span><span class="op" id="1441268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441276">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441288">awoke</span>&nbsp;<span class="op" id="1441294">:=</span>&nbsp;<span class="builtintype" id="1441297">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441304">for</span>&nbsp;<span class="op" id="1441308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441312">old</span>&nbsp;<span class="op" id="1441316">:=</span>&nbsp;<span class="ident" id="1441319">m</span><span class="op" id="1441320">.</span><span class="ident" id="1441321">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1441329">new</span>&nbsp;<span class="op" id="1441333">:=</span>&nbsp;<span class="ident" id="1441336">old</span>&nbsp;<span class="op" id="1441340">|</span>&nbsp;<span class="ident" id="1441342">mutexLocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441356">if</span>&nbsp;<span class="ident" id="1441359">old</span><span class="op" id="1441362">&amp;</span><span class="ident" id="1441363">mutexLocked</span>&nbsp;<span class="op" id="1441375">!=</span>&nbsp;<span class="num" id="1441378">0</span>&nbsp;<span class="op" id="1441380">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1441385">new</span>&nbsp;<span class="op" id="1441389">=</span>&nbsp;<span class="ident" id="1441391">old</span>&nbsp;<span class="op" id="1441395">+</span>&nbsp;<span class="num" id="1441397">1</span><span class="op" id="1441398">&lt;&lt;</span><span class="ident" id="1441400">mutexWaiterShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441423">if</span>&nbsp;<span class="ident" id="1441426">awoke</span>&nbsp;<span class="op" id="1441432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441437">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1441484">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1441535">new</span>&nbsp;<span class="op" id="1441539">&amp;^=</span>&nbsp;<span class="ident" id="1441543">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441560">if</span>&nbsp;<span class="ident" id="1441563">atomic</span><span class="op" id="1441569">.</span><span class="ident" id="1441570">CompareAndSwapInt32</span><span class="op" id="1441589">(</span><span class="op" id="1441590">&amp;</span><span class="ident" id="1441591">m</span><span class="op" id="1441592">.</span><span class="ident" id="1441593">state</span><span class="op" id="1441598">,</span>&nbsp;<span class="ident" id="1441600">old</span><span class="op" id="1441603">,</span>&nbsp;<span class="builtinfunc" id="1441605">new</span><span class="op" id="1441608">)</span>&nbsp;<span class="op" id="1441610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441615">if</span>&nbsp;<span class="ident" id="1441618">old</span><span class="op" id="1441621">&amp;</span><span class="ident" id="1441622">mutexLocked</span>&nbsp;<span class="op" id="1441634">==</span>&nbsp;<span class="num" id="1441637">0</span>&nbsp;<span class="op" id="1441639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441645">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441659">runtime_Semacquire</span><span class="op" id="1441677">(</span><span class="op" id="1441678">&amp;</span><span class="ident" id="1441679">m</span><span class="op" id="1441680">.</span><span class="ident" id="1441681">sema</span><span class="op" id="1441685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441690">awoke</span>&nbsp;<span class="op" id="1441696">=</span>&nbsp;<span class="builtintype" id="1441698">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441708">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1441712">if</span>&nbsp;<span class="ident" id="1441715">raceenabled</span>&nbsp;<span class="op" id="1441727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1441731">raceAcquire</span><span class="op" id="1441742">(</span><span class="ident" id="1441743">unsafe</span><span class="op" id="1441749">.</span><span class="ident" id="1441750">Pointer</span><span class="op" id="1441757">(</span><span class="ident" id="1441758">m</span><span class="op" id="1441759">)</span><span class="op" id="1441760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1441763">}</span><br>
<span class="lineno"></span><span class="op" id="1441765">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1441768">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1441789">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1441854">//</span><br>
<span class="lineno"></span><span class="comment" id="1441857">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1441922">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1441982">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1442029">func</span>&nbsp;<span class="op" id="1442034">(</span><span class="ident" id="1442035">m</span>&nbsp;<span class="op" id="1442037">*</span><span class="ident" id="1442038">Mutex</span><span class="op" id="1442043">)</span>&nbsp;<span class="ident" id="1442045">Unlock</span><span class="op" id="1442051">(</span><span class="op" id="1442052">)</span>&nbsp;<span class="op" id="1442054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442057">if</span>&nbsp;<span class="ident" id="1442060">raceenabled</span>&nbsp;<span class="op" id="1442072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442076">_</span>&nbsp;<span class="op" id="1442078">=</span>&nbsp;<span class="ident" id="1442080">m</span><span class="op" id="1442081">.</span><span class="ident" id="1442082">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442090">raceRelease</span><span class="op" id="1442101">(</span><span class="ident" id="1442102">unsafe</span><span class="op" id="1442108">.</span><span class="ident" id="1442109">Pointer</span><span class="op" id="1442116">(</span><span class="ident" id="1442117">m</span><span class="op" id="1442118">)</span><span class="op" id="1442119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442126">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1442156">new</span>&nbsp;<span class="op" id="1442160">:=</span>&nbsp;<span class="ident" id="1442163">atomic</span><span class="op" id="1442169">.</span><span class="ident" id="1442170">AddInt32</span><span class="op" id="1442178">(</span><span class="op" id="1442179">&amp;</span><span class="ident" id="1442180">m</span><span class="op" id="1442181">.</span><span class="ident" id="1442182">state</span><span class="op" id="1442187">,</span>&nbsp;<span class="op" id="1442189">-</span><span class="ident" id="1442190">mutexLocked</span><span class="op" id="1442201">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442204">if</span>&nbsp;<span class="op" id="1442207">(</span><span class="builtinfunc" id="1442208">new</span><span class="op" id="1442211">+</span><span class="ident" id="1442212">mutexLocked</span><span class="op" id="1442223">)</span><span class="op" id="1442224">&amp;</span><span class="ident" id="1442225">mutexLocked</span>&nbsp;<span class="op" id="1442237">==</span>&nbsp;<span class="num" id="1442240">0</span>&nbsp;<span class="op" id="1442242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1442246">panic</span><span class="op" id="1442251">(</span><span class="string" id="1442252">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1442284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442291">old</span>&nbsp;<span class="op" id="1442295">:=</span>&nbsp;<span class="builtinfunc" id="1442298">new</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442303">for</span>&nbsp;<span class="op" id="1442307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442311">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442367">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442428">if</span>&nbsp;<span class="ident" id="1442431">old</span><span class="op" id="1442434">&gt;&gt;</span><span class="ident" id="1442436">mutexWaiterShift</span>&nbsp;<span class="op" id="1442453">==</span>&nbsp;<span class="num" id="1442456">0</span>&nbsp;<span class="op" id="1442458">||</span>&nbsp;<span class="ident" id="1442461">old</span><span class="op" id="1442464">&amp;</span><span class="op" id="1442465">(</span><span class="ident" id="1442466">mutexLocked</span><span class="op" id="1442477">|</span><span class="ident" id="1442478">mutexWoken</span><span class="op" id="1442488">)</span>&nbsp;<span class="op" id="1442490">!=</span>&nbsp;<span class="num" id="1442493">0</span>&nbsp;<span class="op" id="1442495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442500">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442513">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1442550">new</span>&nbsp;<span class="op" id="1442554">=</span>&nbsp;<span class="op" id="1442556">(</span><span class="ident" id="1442557">old</span>&nbsp;<span class="op" id="1442561">-</span>&nbsp;<span class="num" id="1442563">1</span><span class="op" id="1442564">&lt;&lt;</span><span class="ident" id="1442566">mutexWaiterShift</span><span class="op" id="1442582">)</span>&nbsp;<span class="op" id="1442584">|</span>&nbsp;<span class="ident" id="1442586">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442599">if</span>&nbsp;<span class="ident" id="1442602">atomic</span><span class="op" id="1442608">.</span><span class="ident" id="1442609">CompareAndSwapInt32</span><span class="op" id="1442628">(</span><span class="op" id="1442629">&amp;</span><span class="ident" id="1442630">m</span><span class="op" id="1442631">.</span><span class="ident" id="1442632">state</span><span class="op" id="1442637">,</span>&nbsp;<span class="ident" id="1442639">old</span><span class="op" id="1442642">,</span>&nbsp;<span class="builtinfunc" id="1442644">new</span><span class="op" id="1442647">)</span>&nbsp;<span class="op" id="1442649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442654">runtime_Semrelease</span><span class="op" id="1442672">(</span><span class="op" id="1442673">&amp;</span><span class="ident" id="1442674">m</span><span class="op" id="1442675">.</span><span class="ident" id="1442676">sema</span><span class="op" id="1442680">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442685">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442698">old</span>&nbsp;<span class="op" id="1442702">=</span>&nbsp;<span class="ident" id="1442704">m</span><span class="op" id="1442705">.</span><span class="ident" id="1442706">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442713">}</span><br>
<span class="lineno"></span><span class="op" id="1442715">}</span>
</div>
</body>
</html>
