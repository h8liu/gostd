<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html" class="current">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3362036">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3362092">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3362146">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3362197">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3362275">package</span>&nbsp;<span class="ident" id="3362283">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3362288">import</span>&nbsp;<span class="op" id="3362295">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3362298">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3362304">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3362310">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3362321">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3362328">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3362331">//&nbsp;BUG(rsc):&nbsp;On&nbsp;OpenBSD,&nbsp;listening&nbsp;on&nbsp;the&nbsp;&#34;tcp&#34;&nbsp;network&nbsp;does&nbsp;not&nbsp;listen&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3362407">//&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;connections.&nbsp;This&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;IPv4&nbsp;traffic</span><br>
<span class="lineno"></span><span class="comment" id="3362484">//&nbsp;will&nbsp;not&nbsp;be&nbsp;routed&nbsp;to&nbsp;an&nbsp;IPv6&nbsp;socket&nbsp;-&nbsp;two&nbsp;separate&nbsp;sockets&nbsp;are&nbsp;required</span><br>
<span class="lineno"></span><span class="comment" id="3362560">//&nbsp;if&nbsp;both&nbsp;AFs&nbsp;are&nbsp;to&nbsp;be&nbsp;supported.&nbsp;See&nbsp;inet6(4)&nbsp;on&nbsp;OpenBSD&nbsp;for&nbsp;details.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3362634">func</span>&nbsp;<span class="ident" id="3362639">sockaddrToTCP</span><span class="op" id="3362652">(</span><span class="ident" id="3362653">sa</span>&nbsp;<span class="ident" id="3362656">syscall</span><span class="op" id="3362663">.</span><span class="ident" id="3362664">Sockaddr</span><span class="op" id="3362672">)</span>&nbsp;<span class="ident" id="3362674">Addr</span>&nbsp;<span class="op" id="3362679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3362682">switch</span>&nbsp;<span class="ident" id="3362689">sa</span>&nbsp;<span class="op" id="3362692">:=</span>&nbsp;<span class="ident" id="3362695">sa</span><span class="op" id="3362697">.</span><span class="op" id="3362698">(</span><span class="keyword" id="3362699">type</span><span class="op" id="3362703">)</span>&nbsp;<span class="op" id="3362705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3362708">case</span>&nbsp;<span class="op" id="3362713">*</span><span class="ident" id="3362714">syscall</span><span class="op" id="3362721">.</span><span class="ident" id="3362722">SockaddrInet4</span><span class="op" id="3362735">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3362739">return</span>&nbsp;<span class="op" id="3362746">&amp;</span><span class="ident" id="3362747">TCPAddr</span><span class="op" id="3362754">{</span><span class="ident" id="3362755">IP</span><span class="op" id="3362757">:</span>&nbsp;<span class="ident" id="3362759">sa</span><span class="op" id="3362761">.</span><span class="ident" id="3362762">Addr</span><span class="op" id="3362766">[</span><span class="num" id="3362767">0</span><span class="op" id="3362768">:</span><span class="op" id="3362769">]</span><span class="op" id="3362770">,</span>&nbsp;<span class="ident" id="3362772">Port</span><span class="op" id="3362776">:</span>&nbsp;<span class="ident" id="3362778">sa</span><span class="op" id="3362780">.</span><span class="ident" id="3362781">Port</span><span class="op" id="3362785">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3362788">case</span>&nbsp;<span class="op" id="3362793">*</span><span class="ident" id="3362794">syscall</span><span class="op" id="3362801">.</span><span class="ident" id="3362802">SockaddrInet6</span><span class="op" id="3362815">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3362819">return</span>&nbsp;<span class="op" id="3362826">&amp;</span><span class="ident" id="3362827">TCPAddr</span><span class="op" id="3362834">{</span><span class="ident" id="3362835">IP</span><span class="op" id="3362837">:</span>&nbsp;<span class="ident" id="3362839">sa</span><span class="op" id="3362841">.</span><span class="ident" id="3362842">Addr</span><span class="op" id="3362846">[</span><span class="num" id="3362847">0</span><span class="op" id="3362848">:</span><span class="op" id="3362849">]</span><span class="op" id="3362850">,</span>&nbsp;<span class="ident" id="3362852">Port</span><span class="op" id="3362856">:</span>&nbsp;<span class="ident" id="3362858">sa</span><span class="op" id="3362860">.</span><span class="ident" id="3362861">Port</span><span class="op" id="3362865">,</span>&nbsp;<span class="ident" id="3362867">Zone</span><span class="op" id="3362871">:</span>&nbsp;<span class="ident" id="3362873">zoneToString</span><span class="op" id="3362885">(</span><span class="builtintype" id="3362886">int</span><span class="op" id="3362889">(</span><span class="ident" id="3362890">sa</span><span class="op" id="3362892">.</span><span class="ident" id="3362893">ZoneId</span><span class="op" id="3362899">)</span><span class="op" id="3362900">)</span><span class="op" id="3362901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3362904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3362907">return</span>&nbsp;<span class="builtintype" id="3362914">nil</span><br>
<span class="lineno"></span><span class="op" id="3362918">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3362921">func</span>&nbsp;<span class="op" id="3362926">(</span><span class="ident" id="3362927">a</span>&nbsp;<span class="op" id="3362929">*</span><span class="ident" id="3362930">TCPAddr</span><span class="op" id="3362937">)</span>&nbsp;<span class="ident" id="3362939">family</span><span class="op" id="3362945">(</span><span class="op" id="3362946">)</span>&nbsp;<span class="builtintype" id="3362948">int</span>&nbsp;<span class="op" id="3362952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3362955">if</span>&nbsp;<span class="ident" id="3362958">a</span>&nbsp;<span class="op" id="3362960">==</span>&nbsp;<span class="builtintype" id="3362963">nil</span>&nbsp;<span class="op" id="3362967">||</span>&nbsp;<span class="builtinfunc" id="3362970">len</span><span class="op" id="3362973">(</span><span class="ident" id="3362974">a</span><span class="op" id="3362975">.</span><span class="ident" id="3362976">IP</span><span class="op" id="3362978">)</span>&nbsp;<span class="op" id="3362980">&lt;=</span>&nbsp;<span class="ident" id="3362983">IPv4len</span>&nbsp;<span class="op" id="3362991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3362995">return</span>&nbsp;<span class="ident" id="3363002">syscall</span><span class="op" id="3363009">.</span><span class="ident" id="3363010">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3363019">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363022">if</span>&nbsp;<span class="ident" id="3363025">a</span><span class="op" id="3363026">.</span><span class="ident" id="3363027">IP</span><span class="op" id="3363029">.</span><span class="ident" id="3363030">To4</span><span class="op" id="3363033">(</span><span class="op" id="3363034">)</span>&nbsp;<span class="op" id="3363036">!=</span>&nbsp;<span class="builtintype" id="3363039">nil</span>&nbsp;<span class="op" id="3363043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363047">return</span>&nbsp;<span class="ident" id="3363054">syscall</span><span class="op" id="3363061">.</span><span class="ident" id="3363062">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3363071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363074">return</span>&nbsp;<span class="ident" id="3363081">syscall</span><span class="op" id="3363088">.</span><span class="ident" id="3363089">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="3363098">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3363101">func</span>&nbsp;<span class="op" id="3363106">(</span><span class="ident" id="3363107">a</span>&nbsp;<span class="op" id="3363109">*</span><span class="ident" id="3363110">TCPAddr</span><span class="op" id="3363117">)</span>&nbsp;<span class="ident" id="3363119">isWildcard</span><span class="op" id="3363129">(</span><span class="op" id="3363130">)</span>&nbsp;<span class="builtintype" id="3363132">bool</span>&nbsp;<span class="op" id="3363137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363140">if</span>&nbsp;<span class="ident" id="3363143">a</span>&nbsp;<span class="op" id="3363145">==</span>&nbsp;<span class="builtintype" id="3363148">nil</span>&nbsp;<span class="op" id="3363152">||</span>&nbsp;<span class="ident" id="3363155">a</span><span class="op" id="3363156">.</span><span class="ident" id="3363157">IP</span>&nbsp;<span class="op" id="3363160">==</span>&nbsp;<span class="builtintype" id="3363163">nil</span>&nbsp;<span class="op" id="3363167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363171">return</span>&nbsp;<span class="builtintype" id="3363178">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3363184">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363187">return</span>&nbsp;<span class="ident" id="3363194">a</span><span class="op" id="3363195">.</span><span class="ident" id="3363196">IP</span><span class="op" id="3363198">.</span><span class="ident" id="3363199">IsUnspecified</span><span class="op" id="3363212">(</span><span class="op" id="3363213">)</span><br>
<span class="lineno"></span><span class="op" id="3363215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3363218">func</span>&nbsp;<span class="op" id="3363223">(</span><span class="ident" id="3363224">a</span>&nbsp;<span class="op" id="3363226">*</span><span class="ident" id="3363227">TCPAddr</span><span class="op" id="3363234">)</span>&nbsp;<span class="ident" id="3363236">sockaddr</span><span class="op" id="3363244">(</span><span class="ident" id="3363245">family</span>&nbsp;<span class="builtintype" id="3363252">int</span><span class="op" id="3363255">)</span>&nbsp;<span class="op" id="3363257">(</span><span class="ident" id="3363258">syscall</span><span class="op" id="3363265">.</span><span class="ident" id="3363266">Sockaddr</span><span class="op" id="3363274">,</span>&nbsp;<span class="builtintype" id="3363276">error</span><span class="op" id="3363281">)</span>&nbsp;<span class="op" id="3363283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363286">if</span>&nbsp;<span class="ident" id="3363289">a</span>&nbsp;<span class="op" id="3363291">==</span>&nbsp;<span class="builtintype" id="3363294">nil</span>&nbsp;<span class="op" id="3363298">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363302">return</span>&nbsp;<span class="builtintype" id="3363309">nil</span><span class="op" id="3363312">,</span>&nbsp;<span class="builtintype" id="3363314">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3363319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363322">return</span>&nbsp;<span class="ident" id="3363329">ipToSockaddr</span><span class="op" id="3363341">(</span><span class="ident" id="3363342">family</span><span class="op" id="3363348">,</span>&nbsp;<span class="ident" id="3363350">a</span><span class="op" id="3363351">.</span><span class="ident" id="3363352">IP</span><span class="op" id="3363354">,</span>&nbsp;<span class="ident" id="3363356">a</span><span class="op" id="3363357">.</span><span class="ident" id="3363358">Port</span><span class="op" id="3363362">,</span>&nbsp;<span class="ident" id="3363364">a</span><span class="op" id="3363365">.</span><span class="ident" id="3363366">Zone</span><span class="op" id="3363370">)</span><br>
<span class="lineno"></span><span class="op" id="3363372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3363375">//&nbsp;TCPConn&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;interface&nbsp;for&nbsp;TCP&nbsp;network</span><br>
<span class="lineno"></span><span class="comment" id="3363445">//&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3363461">type</span>&nbsp;<span class="ident" id="3363466">TCPConn</span>&nbsp;<span class="keyword" id="3363474">struct</span>&nbsp;<span class="op" id="3363481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3363484">conn</span><br>
<span class="lineno"></span><span class="op" id="3363489">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="3363492">func</span>&nbsp;<span class="ident" id="3363497">newTCPConn</span><span class="op" id="3363507">(</span><span class="ident" id="3363508">fd</span>&nbsp;<span class="op" id="3363511">*</span><span class="ident" id="3363512">netFD</span><span class="op" id="3363517">)</span>&nbsp;<span class="op" id="3363519">*</span><span class="ident" id="3363520">TCPConn</span>&nbsp;<span class="op" id="3363528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3363531">c</span>&nbsp;<span class="op" id="3363533">:=</span>&nbsp;<span class="op" id="3363536">&amp;</span><span class="ident" id="3363537">TCPConn</span><span class="op" id="3363544">{</span><span class="ident" id="3363545">conn</span><span class="op" id="3363549">{</span><span class="ident" id="3363550">fd</span><span class="op" id="3363552">}</span><span class="op" id="3363553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3363556">c</span><span class="op" id="3363557">.</span><span class="ident" id="3363558">SetNoDelay</span><span class="op" id="3363568">(</span><span class="builtintype" id="3363569">true</span><span class="op" id="3363573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363576">return</span>&nbsp;<span class="ident" id="3363583">c</span><br>
<span class="lineno">65</span><span class="op" id="3363585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3363588">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;io.ReaderFrom&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="3363646">func</span>&nbsp;<span class="op" id="3363651">(</span><span class="ident" id="3363652">c</span>&nbsp;<span class="op" id="3363654">*</span><span class="ident" id="3363655">TCPConn</span><span class="op" id="3363662">)</span>&nbsp;<span class="ident" id="3363664">ReadFrom</span><span class="op" id="3363672">(</span><span class="ident" id="3363673">r</span>&nbsp;<span class="ident" id="3363675">io</span><span class="op" id="3363677">.</span><span class="ident" id="3363678">Reader</span><span class="op" id="3363684">)</span>&nbsp;<span class="op" id="3363686">(</span><span class="ident" id="3363687">int64</span><span class="op" id="3363692">,</span>&nbsp;<span class="builtintype" id="3363694">error</span><span class="op" id="3363699">)</span>&nbsp;<span class="op" id="3363701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363704">if</span>&nbsp;<span class="ident" id="3363707">n</span><span class="op" id="3363708">,</span>&nbsp;<span class="ident" id="3363710">err</span><span class="op" id="3363713">,</span>&nbsp;<span class="ident" id="3363715">handled</span>&nbsp;<span class="op" id="3363723">:=</span>&nbsp;<span class="ident" id="3363726">sendFile</span><span class="op" id="3363734">(</span><span class="ident" id="3363735">c</span><span class="op" id="3363736">.</span><span class="ident" id="3363737">fd</span><span class="op" id="3363739">,</span>&nbsp;<span class="ident" id="3363741">r</span><span class="op" id="3363742">)</span><span class="op" id="3363743">;</span>&nbsp;<span class="ident" id="3363745">handled</span>&nbsp;<span class="op" id="3363753">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363757">return</span>&nbsp;<span class="ident" id="3363764">n</span><span class="op" id="3363765">,</span>&nbsp;<span class="ident" id="3363767">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3363772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363775">return</span>&nbsp;<span class="ident" id="3363782">genericReadFrom</span><span class="op" id="3363797">(</span><span class="ident" id="3363798">c</span><span class="op" id="3363799">,</span>&nbsp;<span class="ident" id="3363801">r</span><span class="op" id="3363802">)</span><br>
<span class="lineno"></span><span class="op" id="3363804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3363807">//&nbsp;CloseRead&nbsp;shuts&nbsp;down&nbsp;the&nbsp;reading&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3363871">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3363910">func</span>&nbsp;<span class="op" id="3363915">(</span><span class="ident" id="3363916">c</span>&nbsp;<span class="op" id="3363918">*</span><span class="ident" id="3363919">TCPConn</span><span class="op" id="3363926">)</span>&nbsp;<span class="ident" id="3363928">CloseRead</span><span class="op" id="3363937">(</span><span class="op" id="3363938">)</span>&nbsp;<span class="builtintype" id="3363940">error</span>&nbsp;<span class="op" id="3363946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363949">if</span>&nbsp;<span class="op" id="3363952">!</span><span class="ident" id="3363953">c</span><span class="op" id="3363954">.</span><span class="ident" id="3363955">ok</span><span class="op" id="3363957">(</span><span class="op" id="3363958">)</span>&nbsp;<span class="op" id="3363960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363964">return</span>&nbsp;<span class="ident" id="3363971">syscall</span><span class="op" id="3363978">.</span><span class="ident" id="3363979">EINVAL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3363987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3363990">return</span>&nbsp;<span class="ident" id="3363997">c</span><span class="op" id="3363998">.</span><span class="ident" id="3363999">fd</span><span class="op" id="3364001">.</span><span class="ident" id="3364002">closeRead</span><span class="op" id="3364011">(</span><span class="op" id="3364012">)</span><br>
<span class="lineno"></span><span class="op" id="3364014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3364017">//&nbsp;CloseWrite&nbsp;shuts&nbsp;down&nbsp;the&nbsp;writing&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno">85</span><span class="comment" id="3364082">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3364121">func</span>&nbsp;<span class="op" id="3364126">(</span><span class="ident" id="3364127">c</span>&nbsp;<span class="op" id="3364129">*</span><span class="ident" id="3364130">TCPConn</span><span class="op" id="3364137">)</span>&nbsp;<span class="ident" id="3364139">CloseWrite</span><span class="op" id="3364149">(</span><span class="op" id="3364150">)</span>&nbsp;<span class="builtintype" id="3364152">error</span>&nbsp;<span class="op" id="3364158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3364161">if</span>&nbsp;<span class="op" id="3364164">!</span><span class="ident" id="3364165">c</span><span class="op" id="3364166">.</span><span class="ident" id="3364167">ok</span><span class="op" id="3364169">(</span><span class="op" id="3364170">)</span>&nbsp;<span class="op" id="3364172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3364176">return</span>&nbsp;<span class="ident" id="3364183">syscall</span><span class="op" id="3364190">.</span><span class="ident" id="3364191">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3364199">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3364202">return</span>&nbsp;<span class="ident" id="3364209">c</span><span class="op" id="3364210">.</span><span class="ident" id="3364211">fd</span><span class="op" id="3364213">.</span><span class="ident" id="3364214">closeWrite</span><span class="op" id="3364224">(</span><span class="op" id="3364225">)</span><br>
<span class="lineno"></span><span class="op" id="3364227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3364230">//&nbsp;SetLinger&nbsp;sets&nbsp;the&nbsp;behavior&nbsp;of&nbsp;Close&nbsp;on&nbsp;a&nbsp;connection&nbsp;which&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="3364298">//&nbsp;has&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;sent&nbsp;or&nbsp;to&nbsp;be&nbsp;acknowledged.</span><br>
<span class="lineno">95</span><span class="comment" id="3364352">//</span><br>
<span class="lineno"></span><span class="comment" id="3364355">//&nbsp;If&nbsp;sec&nbsp;&lt;&nbsp;0&nbsp;(the&nbsp;default),&nbsp;the&nbsp;operating&nbsp;system&nbsp;finishes&nbsp;sending&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3364426">//&nbsp;data&nbsp;in&nbsp;the&nbsp;background.</span><br>
<span class="lineno"></span><span class="comment" id="3364453">//</span><br>
<span class="lineno"></span><span class="comment" id="3364456">//&nbsp;If&nbsp;sec&nbsp;==&nbsp;0,&nbsp;the&nbsp;operating&nbsp;system&nbsp;discards&nbsp;any&nbsp;unsent&nbsp;or</span><br>
<span class="lineno">100</span><span class="comment" id="3364516">//&nbsp;unacknowledged&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3364540">//</span><br>
<span class="lineno"></span><span class="comment" id="3364543">//&nbsp;If&nbsp;sec&nbsp;&gt;&nbsp;0,&nbsp;the&nbsp;data&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;background&nbsp;as&nbsp;with&nbsp;sec&nbsp;&lt;&nbsp;0.&nbsp;On</span><br>
<span class="lineno"></span><span class="comment" id="3364613">//&nbsp;some&nbsp;operating&nbsp;systems&nbsp;after&nbsp;sec&nbsp;seconds&nbsp;have&nbsp;elapsed&nbsp;any&nbsp;remaining</span><br>
<span class="lineno"></span><span class="comment" id="3364684">//&nbsp;unsent&nbsp;data&nbsp;may&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno">105</span><span class="keyword" id="3364717">func</span>&nbsp;<span class="op" id="3364722">(</span><span class="ident" id="3364723">c</span>&nbsp;<span class="op" id="3364725">*</span><span class="ident" id="3364726">TCPConn</span><span class="op" id="3364733">)</span>&nbsp;<span class="ident" id="3364735">SetLinger</span><span class="op" id="3364744">(</span><span class="ident" id="3364745">sec</span>&nbsp;<span class="builtintype" id="3364749">int</span><span class="op" id="3364752">)</span>&nbsp;<span class="builtintype" id="3364754">error</span>&nbsp;<span class="op" id="3364760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3364763">if</span>&nbsp;<span class="op" id="3364766">!</span><span class="ident" id="3364767">c</span><span class="op" id="3364768">.</span><span class="ident" id="3364769">ok</span><span class="op" id="3364771">(</span><span class="op" id="3364772">)</span>&nbsp;<span class="op" id="3364774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3364778">return</span>&nbsp;<span class="ident" id="3364785">syscall</span><span class="op" id="3364792">.</span><span class="ident" id="3364793">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3364801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3364804">return</span>&nbsp;<span class="ident" id="3364811">setLinger</span><span class="op" id="3364820">(</span><span class="ident" id="3364821">c</span><span class="op" id="3364822">.</span><span class="ident" id="3364823">fd</span><span class="op" id="3364825">,</span>&nbsp;<span class="ident" id="3364827">sec</span><span class="op" id="3364830">)</span><br>
<span class="lineno">110</span><span class="op" id="3364832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3364835">//&nbsp;SetKeepAlive&nbsp;sets&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;send</span><br>
<span class="lineno"></span><span class="comment" id="3364897">//&nbsp;keepalive&nbsp;messages&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3364938">func</span>&nbsp;<span class="op" id="3364943">(</span><span class="ident" id="3364944">c</span>&nbsp;<span class="op" id="3364946">*</span><span class="ident" id="3364947">TCPConn</span><span class="op" id="3364954">)</span>&nbsp;<span class="ident" id="3364956">SetKeepAlive</span><span class="op" id="3364968">(</span><span class="ident" id="3364969">keepalive</span>&nbsp;<span class="builtintype" id="3364979">bool</span><span class="op" id="3364983">)</span>&nbsp;<span class="builtintype" id="3364985">error</span>&nbsp;<span class="op" id="3364991">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3364994">if</span>&nbsp;<span class="op" id="3364997">!</span><span class="ident" id="3364998">c</span><span class="op" id="3364999">.</span><span class="ident" id="3365000">ok</span><span class="op" id="3365002">(</span><span class="op" id="3365003">)</span>&nbsp;<span class="op" id="3365005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365009">return</span>&nbsp;<span class="ident" id="3365016">syscall</span><span class="op" id="3365023">.</span><span class="ident" id="3365024">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3365032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365035">return</span>&nbsp;<span class="ident" id="3365042">setKeepAlive</span><span class="op" id="3365054">(</span><span class="ident" id="3365055">c</span><span class="op" id="3365056">.</span><span class="ident" id="3365057">fd</span><span class="op" id="3365059">,</span>&nbsp;<span class="ident" id="3365061">keepalive</span><span class="op" id="3365070">)</span><br>
<span class="lineno"></span><span class="op" id="3365072">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3365075">//&nbsp;SetKeepAlivePeriod&nbsp;sets&nbsp;period&nbsp;between&nbsp;keep&nbsp;alives.</span><br>
<span class="lineno"></span><span class="keyword" id="3365130">func</span>&nbsp;<span class="op" id="3365135">(</span><span class="ident" id="3365136">c</span>&nbsp;<span class="op" id="3365138">*</span><span class="ident" id="3365139">TCPConn</span><span class="op" id="3365146">)</span>&nbsp;<span class="ident" id="3365148">SetKeepAlivePeriod</span><span class="op" id="3365166">(</span><span class="ident" id="3365167">d</span>&nbsp;<span class="ident" id="3365169">time</span><span class="op" id="3365173">.</span><span class="ident" id="3365174">Duration</span><span class="op" id="3365182">)</span>&nbsp;<span class="builtintype" id="3365184">error</span>&nbsp;<span class="op" id="3365190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365193">if</span>&nbsp;<span class="op" id="3365196">!</span><span class="ident" id="3365197">c</span><span class="op" id="3365198">.</span><span class="ident" id="3365199">ok</span><span class="op" id="3365201">(</span><span class="op" id="3365202">)</span>&nbsp;<span class="op" id="3365204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365208">return</span>&nbsp;<span class="ident" id="3365215">syscall</span><span class="op" id="3365222">.</span><span class="ident" id="3365223">EINVAL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3365231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365234">return</span>&nbsp;<span class="ident" id="3365241">setKeepAlivePeriod</span><span class="op" id="3365259">(</span><span class="ident" id="3365260">c</span><span class="op" id="3365261">.</span><span class="ident" id="3365262">fd</span><span class="op" id="3365264">,</span>&nbsp;<span class="ident" id="3365266">d</span><span class="op" id="3365267">)</span><br>
<span class="lineno"></span><span class="op" id="3365269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3365272">//&nbsp;SetNoDelay&nbsp;controls&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;delay</span><br>
<span class="lineno">130</span><span class="comment" id="3365337">//&nbsp;packet&nbsp;transmission&nbsp;in&nbsp;hopes&nbsp;of&nbsp;sending&nbsp;fewer&nbsp;packets&nbsp;(Nagle&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3365403">//&nbsp;algorithm).&nbsp;&nbsp;The&nbsp;default&nbsp;is&nbsp;true&nbsp;(no&nbsp;delay),&nbsp;meaning&nbsp;that&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3365472">//&nbsp;sent&nbsp;as&nbsp;soon&nbsp;as&nbsp;possible&nbsp;after&nbsp;a&nbsp;Write.</span><br>
<span class="lineno"></span><span class="keyword" id="3365515">func</span>&nbsp;<span class="op" id="3365520">(</span><span class="ident" id="3365521">c</span>&nbsp;<span class="op" id="3365523">*</span><span class="ident" id="3365524">TCPConn</span><span class="op" id="3365531">)</span>&nbsp;<span class="ident" id="3365533">SetNoDelay</span><span class="op" id="3365543">(</span><span class="ident" id="3365544">noDelay</span>&nbsp;<span class="builtintype" id="3365552">bool</span><span class="op" id="3365556">)</span>&nbsp;<span class="builtintype" id="3365558">error</span>&nbsp;<span class="op" id="3365564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365567">if</span>&nbsp;<span class="op" id="3365570">!</span><span class="ident" id="3365571">c</span><span class="op" id="3365572">.</span><span class="ident" id="3365573">ok</span><span class="op" id="3365575">(</span><span class="op" id="3365576">)</span>&nbsp;<span class="op" id="3365578">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365582">return</span>&nbsp;<span class="ident" id="3365589">syscall</span><span class="op" id="3365596">.</span><span class="ident" id="3365597">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3365605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365608">return</span>&nbsp;<span class="ident" id="3365615">setNoDelay</span><span class="op" id="3365625">(</span><span class="ident" id="3365626">c</span><span class="op" id="3365627">.</span><span class="ident" id="3365628">fd</span><span class="op" id="3365630">,</span>&nbsp;<span class="ident" id="3365632">noDelay</span><span class="op" id="3365639">)</span><br>
<span class="lineno"></span><span class="op" id="3365641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3365644">//&nbsp;DialTCP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;net,</span><br>
<span class="lineno"></span><span class="comment" id="3365712">//&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;is&nbsp;not&nbsp;nil,&nbsp;it&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3365783">//&nbsp;used&nbsp;as&nbsp;the&nbsp;local&nbsp;address&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3365832">func</span>&nbsp;<span class="ident" id="3365837">DialTCP</span><span class="op" id="3365844">(</span><span class="ident" id="3365845">net</span>&nbsp;<span class="builtintype" id="3365849">string</span><span class="op" id="3365855">,</span>&nbsp;<span class="ident" id="3365857">laddr</span><span class="op" id="3365862">,</span>&nbsp;<span class="ident" id="3365864">raddr</span>&nbsp;<span class="op" id="3365870">*</span><span class="ident" id="3365871">TCPAddr</span><span class="op" id="3365878">)</span>&nbsp;<span class="op" id="3365880">(</span><span class="op" id="3365881">*</span><span class="ident" id="3365882">TCPConn</span><span class="op" id="3365889">,</span>&nbsp;<span class="builtintype" id="3365891">error</span><span class="op" id="3365896">)</span>&nbsp;<span class="op" id="3365898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365901">switch</span>&nbsp;<span class="ident" id="3365908">net</span>&nbsp;<span class="op" id="3365912">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365915">case</span>&nbsp;<span class="string" id="3365920">&#34;tcp&#34;</span><span class="op" id="3365925">,</span>&nbsp;<span class="string" id="3365927">&#34;tcp4&#34;</span><span class="op" id="3365933">,</span>&nbsp;<span class="string" id="3365935">&#34;tcp6&#34;</span><span class="op" id="3365941">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365944">default</span><span class="op" id="3365951">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3365955">return</span>&nbsp;<span class="builtintype" id="3365962">nil</span><span class="op" id="3365965">,</span>&nbsp;<span class="op" id="3365967">&amp;</span><span class="ident" id="3365968">OpError</span><span class="op" id="3365975">{</span><span class="ident" id="3365976">Op</span><span class="op" id="3365978">:</span>&nbsp;<span class="string" id="3365980">&#34;dial&#34;</span><span class="op" id="3365986">,</span>&nbsp;<span class="ident" id="3365988">Net</span><span class="op" id="3365991">:</span>&nbsp;<span class="ident" id="3365993">net</span><span class="op" id="3365996">,</span>&nbsp;<span class="ident" id="3365998">Addr</span><span class="op" id="3366002">:</span>&nbsp;<span class="ident" id="3366004">raddr</span><span class="op" id="3366009">,</span>&nbsp;<span class="ident" id="3366011">Err</span><span class="op" id="3366014">:</span>&nbsp;<span class="ident" id="3366016">UnknownNetworkError</span><span class="op" id="3366035">(</span><span class="ident" id="3366036">net</span><span class="op" id="3366039">)</span><span class="op" id="3366040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3366043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3366046">if</span>&nbsp;<span class="ident" id="3366049">raddr</span>&nbsp;<span class="op" id="3366055">==</span>&nbsp;<span class="builtintype" id="3366058">nil</span>&nbsp;<span class="op" id="3366062">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3366066">return</span>&nbsp;<span class="builtintype" id="3366073">nil</span><span class="op" id="3366076">,</span>&nbsp;<span class="op" id="3366078">&amp;</span><span class="ident" id="3366079">OpError</span><span class="op" id="3366086">{</span><span class="ident" id="3366087">Op</span><span class="op" id="3366089">:</span>&nbsp;<span class="string" id="3366091">&#34;dial&#34;</span><span class="op" id="3366097">,</span>&nbsp;<span class="ident" id="3366099">Net</span><span class="op" id="3366102">:</span>&nbsp;<span class="ident" id="3366104">net</span><span class="op" id="3366107">,</span>&nbsp;<span class="ident" id="3366109">Addr</span><span class="op" id="3366113">:</span>&nbsp;<span class="builtintype" id="3366115">nil</span><span class="op" id="3366118">,</span>&nbsp;<span class="ident" id="3366120">Err</span><span class="op" id="3366123">:</span>&nbsp;<span class="ident" id="3366125">errMissingAddress</span><span class="op" id="3366142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3366145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3366148">return</span>&nbsp;<span class="ident" id="3366155">dialTCP</span><span class="op" id="3366162">(</span><span class="ident" id="3366163">net</span><span class="op" id="3366166">,</span>&nbsp;<span class="ident" id="3366168">laddr</span><span class="op" id="3366173">,</span>&nbsp;<span class="ident" id="3366175">raddr</span><span class="op" id="3366180">,</span>&nbsp;<span class="ident" id="3366182">noDeadline</span><span class="op" id="3366192">)</span><br>
<span class="lineno"></span><span class="op" id="3366194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="3366197">func</span>&nbsp;<span class="ident" id="3366202">dialTCP</span><span class="op" id="3366209">(</span><span class="ident" id="3366210">net</span>&nbsp;<span class="builtintype" id="3366214">string</span><span class="op" id="3366220">,</span>&nbsp;<span class="ident" id="3366222">laddr</span><span class="op" id="3366227">,</span>&nbsp;<span class="ident" id="3366229">raddr</span>&nbsp;<span class="op" id="3366235">*</span><span class="ident" id="3366236">TCPAddr</span><span class="op" id="3366243">,</span>&nbsp;<span class="ident" id="3366245">deadline</span>&nbsp;<span class="ident" id="3366254">time</span><span class="op" id="3366258">.</span><span class="ident" id="3366259">Time</span><span class="op" id="3366263">)</span>&nbsp;<span class="op" id="3366265">(</span><span class="op" id="3366266">*</span><span class="ident" id="3366267">TCPConn</span><span class="op" id="3366274">,</span>&nbsp;<span class="builtintype" id="3366276">error</span><span class="op" id="3366281">)</span>&nbsp;<span class="op" id="3366283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3366286">fd</span><span class="op" id="3366288">,</span>&nbsp;<span class="ident" id="3366290">err</span>&nbsp;<span class="op" id="3366294">:=</span>&nbsp;<span class="ident" id="3366297">internetSocket</span><span class="op" id="3366311">(</span><span class="ident" id="3366312">net</span><span class="op" id="3366315">,</span>&nbsp;<span class="ident" id="3366317">laddr</span><span class="op" id="3366322">,</span>&nbsp;<span class="ident" id="3366324">raddr</span><span class="op" id="3366329">,</span>&nbsp;<span class="ident" id="3366331">deadline</span><span class="op" id="3366339">,</span>&nbsp;<span class="ident" id="3366341">syscall</span><span class="op" id="3366348">.</span><span class="ident" id="3366349">SOCK_STREAM</span><span class="op" id="3366360">,</span>&nbsp;<span class="num" id="3366362">0</span><span class="op" id="3366363">,</span>&nbsp;<span class="string" id="3366365">&#34;dial&#34;</span><span class="op" id="3366371">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3366375">//&nbsp;TCP&nbsp;has&nbsp;a&nbsp;rarely&nbsp;used&nbsp;mechanism&nbsp;called&nbsp;a&nbsp;&#39;simultaneous&nbsp;connection&#39;&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3366449">//&nbsp;which&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr1,&nbsp;addr2)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine&nbsp;at&nbsp;addr1&nbsp;can</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3366517">//&nbsp;connect&nbsp;to&nbsp;a&nbsp;simultaneous&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr2,&nbsp;addr1)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3366592">//&nbsp;at&nbsp;addr2,&nbsp;without&nbsp;either&nbsp;machine&nbsp;executing&nbsp;Listen.&nbsp;&nbsp;If&nbsp;laddr&nbsp;==&nbsp;nil,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3366665">//&nbsp;it&nbsp;means&nbsp;we&nbsp;want&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate&nbsp;originating&nbsp;local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3366738">//&nbsp;address.&nbsp;&nbsp;Some&nbsp;Linux&nbsp;kernels&nbsp;cycle&nbsp;blindly&nbsp;through&nbsp;a&nbsp;fixed&nbsp;range&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3366810">//&nbsp;local&nbsp;ports,&nbsp;regardless&nbsp;of&nbsp;destination&nbsp;port.&nbsp;&nbsp;If&nbsp;a&nbsp;kernel&nbsp;happens&nbsp;to</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3366883">//&nbsp;pick&nbsp;local&nbsp;port&nbsp;50001&nbsp;as&nbsp;the&nbsp;source&nbsp;for&nbsp;a&nbsp;Dial(&#34;tcp&#34;,&nbsp;&#34;&#34;,&nbsp;&#34;localhost:50001&#34;),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3366965">//&nbsp;then&nbsp;the&nbsp;Dial&nbsp;will&nbsp;succeed,&nbsp;having&nbsp;simultaneously&nbsp;connected&nbsp;to&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367040">//&nbsp;This&nbsp;can&nbsp;only&nbsp;happen&nbsp;when&nbsp;we&nbsp;are&nbsp;letting&nbsp;the&nbsp;kernel&nbsp;pick&nbsp;a&nbsp;port&nbsp;(laddr&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367123">//&nbsp;and&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;listener&nbsp;for&nbsp;the&nbsp;destination&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367186">//&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;argue&nbsp;this&nbsp;is&nbsp;anything&nbsp;other&nbsp;than&nbsp;a&nbsp;kernel&nbsp;bug.&nbsp;&nbsp;If&nbsp;we</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367258">//&nbsp;see&nbsp;this&nbsp;happen,&nbsp;rather&nbsp;than&nbsp;expose&nbsp;the&nbsp;buggy&nbsp;effect&nbsp;to&nbsp;users,&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367328">//&nbsp;close&nbsp;the&nbsp;fd&nbsp;and&nbsp;try&nbsp;again.&nbsp;&nbsp;If&nbsp;it&nbsp;happens&nbsp;twice&nbsp;more,&nbsp;we&nbsp;relent&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367401">//&nbsp;use&nbsp;the&nbsp;result.&nbsp;&nbsp;See&nbsp;also:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367432">//&nbsp;&nbsp;&nbsp;&nbsp;http://golang.org/issue/2690</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367465">//&nbsp;&nbsp;&nbsp;&nbsp;http://stackoverflow.com/questions/4949858/</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367513">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367517">//&nbsp;The&nbsp;opposite&nbsp;can&nbsp;also&nbsp;happen:&nbsp;if&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367595">//&nbsp;originating&nbsp;local&nbsp;address,&nbsp;sometimes&nbsp;it&nbsp;picks&nbsp;one&nbsp;that&nbsp;is&nbsp;already&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367673">//&nbsp;So&nbsp;if&nbsp;the&nbsp;error&nbsp;is&nbsp;EADDRNOTAVAIL,&nbsp;we&nbsp;have&nbsp;to&nbsp;try&nbsp;again&nbsp;too,&nbsp;just&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367746">//&nbsp;a&nbsp;different&nbsp;reason.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367770">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3367774">//&nbsp;The&nbsp;kernel&nbsp;socket&nbsp;code&nbsp;is&nbsp;no&nbsp;doubt&nbsp;enjoying&nbsp;watching&nbsp;us&nbsp;squirm.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3367842">for</span>&nbsp;<span class="ident" id="3367846">i</span>&nbsp;<span class="op" id="3367848">:=</span>&nbsp;<span class="num" id="3367851">0</span><span class="op" id="3367852">;</span>&nbsp;<span class="ident" id="3367854">i</span>&nbsp;<span class="op" id="3367856">&lt;</span>&nbsp;<span class="num" id="3367858">2</span>&nbsp;<span class="op" id="3367860">&amp;&amp;</span>&nbsp;<span class="op" id="3367863">(</span><span class="ident" id="3367864">laddr</span>&nbsp;<span class="op" id="3367870">==</span>&nbsp;<span class="builtintype" id="3367873">nil</span>&nbsp;<span class="op" id="3367877">||</span>&nbsp;<span class="ident" id="3367880">laddr</span><span class="op" id="3367885">.</span><span class="ident" id="3367886">Port</span>&nbsp;<span class="op" id="3367891">==</span>&nbsp;<span class="num" id="3367894">0</span><span class="op" id="3367895">)</span>&nbsp;<span class="op" id="3367897">&amp;&amp;</span>&nbsp;<span class="op" id="3367900">(</span><span class="ident" id="3367901">selfConnect</span><span class="op" id="3367912">(</span><span class="ident" id="3367913">fd</span><span class="op" id="3367915">,</span>&nbsp;<span class="ident" id="3367917">err</span><span class="op" id="3367920">)</span>&nbsp;<span class="op" id="3367922">||</span>&nbsp;<span class="ident" id="3367925">spuriousENOTAVAIL</span><span class="op" id="3367942">(</span><span class="ident" id="3367943">err</span><span class="op" id="3367946">)</span><span class="op" id="3367947">)</span><span class="op" id="3367948">;</span>&nbsp;<span class="ident" id="3367950">i</span><span class="op" id="3367951">++</span>&nbsp;<span class="op" id="3367954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3367958">if</span>&nbsp;<span class="ident" id="3367961">err</span>&nbsp;<span class="op" id="3367965">==</span>&nbsp;<span class="builtintype" id="3367968">nil</span>&nbsp;<span class="op" id="3367972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3367977">fd</span><span class="op" id="3367979">.</span><span class="ident" id="3367980">Close</span><span class="op" id="3367985">(</span><span class="op" id="3367986">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3367990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3367994">fd</span><span class="op" id="3367996">,</span>&nbsp;<span class="ident" id="3367998">err</span>&nbsp;<span class="op" id="3368002">=</span>&nbsp;<span class="ident" id="3368004">internetSocket</span><span class="op" id="3368018">(</span><span class="ident" id="3368019">net</span><span class="op" id="3368022">,</span>&nbsp;<span class="ident" id="3368024">laddr</span><span class="op" id="3368029">,</span>&nbsp;<span class="ident" id="3368031">raddr</span><span class="op" id="3368036">,</span>&nbsp;<span class="ident" id="3368038">deadline</span><span class="op" id="3368046">,</span>&nbsp;<span class="ident" id="3368048">syscall</span><span class="op" id="3368055">.</span><span class="ident" id="3368056">SOCK_STREAM</span><span class="op" id="3368067">,</span>&nbsp;<span class="num" id="3368069">0</span><span class="op" id="3368070">,</span>&nbsp;<span class="string" id="3368072">&#34;dial&#34;</span><span class="op" id="3368078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3368081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3368085">if</span>&nbsp;<span class="ident" id="3368088">err</span>&nbsp;<span class="op" id="3368092">!=</span>&nbsp;<span class="builtintype" id="3368095">nil</span>&nbsp;<span class="op" id="3368099">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3368103">return</span>&nbsp;<span class="builtintype" id="3368110">nil</span><span class="op" id="3368113">,</span>&nbsp;<span class="op" id="3368115">&amp;</span><span class="ident" id="3368116">OpError</span><span class="op" id="3368123">{</span><span class="ident" id="3368124">Op</span><span class="op" id="3368126">:</span>&nbsp;<span class="string" id="3368128">&#34;dial&#34;</span><span class="op" id="3368134">,</span>&nbsp;<span class="ident" id="3368136">Net</span><span class="op" id="3368139">:</span>&nbsp;<span class="ident" id="3368141">net</span><span class="op" id="3368144">,</span>&nbsp;<span class="ident" id="3368146">Addr</span><span class="op" id="3368150">:</span>&nbsp;<span class="ident" id="3368152">raddr</span><span class="op" id="3368157">,</span>&nbsp;<span class="ident" id="3368159">Err</span><span class="op" id="3368162">:</span>&nbsp;<span class="ident" id="3368164">err</span><span class="op" id="3368167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3368170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3368173">return</span>&nbsp;<span class="ident" id="3368180">newTCPConn</span><span class="op" id="3368190">(</span><span class="ident" id="3368191">fd</span><span class="op" id="3368193">)</span><span class="op" id="3368194">,</span>&nbsp;<span class="builtintype" id="3368196">nil</span><br>
<span class="lineno"></span><span class="op" id="3368200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="3368203">func</span>&nbsp;<span class="ident" id="3368208">selfConnect</span><span class="op" id="3368219">(</span><span class="ident" id="3368220">fd</span>&nbsp;<span class="op" id="3368223">*</span><span class="ident" id="3368224">netFD</span><span class="op" id="3368229">,</span>&nbsp;<span class="ident" id="3368231">err</span>&nbsp;<span class="builtintype" id="3368235">error</span><span class="op" id="3368240">)</span>&nbsp;<span class="builtintype" id="3368242">bool</span>&nbsp;<span class="op" id="3368247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3368250">//&nbsp;If&nbsp;the&nbsp;connect&nbsp;failed,&nbsp;we&nbsp;clearly&nbsp;didn&#39;t&nbsp;connect&nbsp;to&nbsp;ourselves.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3368317">if</span>&nbsp;<span class="ident" id="3368320">err</span>&nbsp;<span class="op" id="3368324">!=</span>&nbsp;<span class="builtintype" id="3368327">nil</span>&nbsp;<span class="op" id="3368331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3368335">return</span>&nbsp;<span class="builtintype" id="3368342">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3368349">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3368353">//&nbsp;The&nbsp;socket&nbsp;constructor&nbsp;can&nbsp;return&nbsp;an&nbsp;fd&nbsp;with&nbsp;raddr&nbsp;nil&nbsp;under&nbsp;certain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3368426">//&nbsp;unknown&nbsp;conditions.&nbsp;The&nbsp;errors&nbsp;in&nbsp;the&nbsp;calls&nbsp;there&nbsp;to&nbsp;Getpeername</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3368495">//&nbsp;are&nbsp;discarded,&nbsp;but&nbsp;we&nbsp;can&#39;t&nbsp;catch&nbsp;the&nbsp;problem&nbsp;there&nbsp;because&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3368565">//&nbsp;calls&nbsp;are&nbsp;sometimes&nbsp;legally&nbsp;erroneous&nbsp;with&nbsp;a&nbsp;&#34;socket&nbsp;not&nbsp;connected&#34;.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3368638">//&nbsp;Since&nbsp;this&nbsp;code&nbsp;(selfConnect)&nbsp;is&nbsp;already&nbsp;trying&nbsp;to&nbsp;work&nbsp;around</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3368705">//&nbsp;a&nbsp;problem,&nbsp;we&nbsp;make&nbsp;sure&nbsp;if&nbsp;this&nbsp;happens&nbsp;we&nbsp;recognize&nbsp;trouble&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3368774">//&nbsp;ask&nbsp;the&nbsp;DialTCP&nbsp;routine&nbsp;to&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3368816">//&nbsp;TODO:&nbsp;try&nbsp;to&nbsp;understand&nbsp;what&#39;s&nbsp;really&nbsp;going&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3368868">if</span>&nbsp;<span class="ident" id="3368871">fd</span><span class="op" id="3368873">.</span><span class="ident" id="3368874">laddr</span>&nbsp;<span class="op" id="3368880">==</span>&nbsp;<span class="builtintype" id="3368883">nil</span>&nbsp;<span class="op" id="3368887">||</span>&nbsp;<span class="ident" id="3368890">fd</span><span class="op" id="3368892">.</span><span class="ident" id="3368893">raddr</span>&nbsp;<span class="op" id="3368899">==</span>&nbsp;<span class="builtintype" id="3368902">nil</span>&nbsp;<span class="op" id="3368906">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3368910">return</span>&nbsp;<span class="builtintype" id="3368917">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3368923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3368926">l</span>&nbsp;<span class="op" id="3368928">:=</span>&nbsp;<span class="ident" id="3368931">fd</span><span class="op" id="3368933">.</span><span class="ident" id="3368934">laddr</span><span class="op" id="3368939">.</span><span class="op" id="3368940">(</span><span class="op" id="3368941">*</span><span class="ident" id="3368942">TCPAddr</span><span class="op" id="3368949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3368952">r</span>&nbsp;<span class="op" id="3368954">:=</span>&nbsp;<span class="ident" id="3368957">fd</span><span class="op" id="3368959">.</span><span class="ident" id="3368960">raddr</span><span class="op" id="3368965">.</span><span class="op" id="3368966">(</span><span class="op" id="3368967">*</span><span class="ident" id="3368968">TCPAddr</span><span class="op" id="3368975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3368978">return</span>&nbsp;<span class="ident" id="3368985">l</span><span class="op" id="3368986">.</span><span class="ident" id="3368987">Port</span>&nbsp;<span class="op" id="3368992">==</span>&nbsp;<span class="ident" id="3368995">r</span><span class="op" id="3368996">.</span><span class="ident" id="3368997">Port</span>&nbsp;<span class="op" id="3369002">&amp;&amp;</span>&nbsp;<span class="ident" id="3369005">l</span><span class="op" id="3369006">.</span><span class="ident" id="3369007">IP</span><span class="op" id="3369009">.</span><span class="ident" id="3369010">Equal</span><span class="op" id="3369015">(</span><span class="ident" id="3369016">r</span><span class="op" id="3369017">.</span><span class="ident" id="3369018">IP</span><span class="op" id="3369020">)</span><br>
<span class="lineno">215</span><span class="op" id="3369022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3369025">func</span>&nbsp;<span class="ident" id="3369030">spuriousENOTAVAIL</span><span class="op" id="3369047">(</span><span class="ident" id="3369048">err</span>&nbsp;<span class="builtintype" id="3369052">error</span><span class="op" id="3369057">)</span>&nbsp;<span class="builtintype" id="3369059">bool</span>&nbsp;<span class="op" id="3369064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3369067">e</span><span class="op" id="3369068">,</span>&nbsp;<span class="ident" id="3369070">ok</span>&nbsp;<span class="op" id="3369073">:=</span>&nbsp;<span class="ident" id="3369076">err</span><span class="op" id="3369079">.</span><span class="op" id="3369080">(</span><span class="op" id="3369081">*</span><span class="ident" id="3369082">OpError</span><span class="op" id="3369089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3369092">return</span>&nbsp;<span class="ident" id="3369099">ok</span>&nbsp;<span class="op" id="3369102">&amp;&amp;</span>&nbsp;<span class="ident" id="3369105">e</span><span class="op" id="3369106">.</span><span class="ident" id="3369107">Err</span>&nbsp;<span class="op" id="3369111">==</span>&nbsp;<span class="ident" id="3369114">syscall</span><span class="op" id="3369121">.</span><span class="ident" id="3369122">EADDRNOTAVAIL</span><br>
<span class="lineno">220</span><span class="op" id="3369136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3369139">//&nbsp;TCPListener&nbsp;is&nbsp;a&nbsp;TCP&nbsp;network&nbsp;listener.&nbsp;&nbsp;Clients&nbsp;should&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="3369207">//&nbsp;use&nbsp;variables&nbsp;of&nbsp;type&nbsp;Listener&nbsp;instead&nbsp;of&nbsp;assuming&nbsp;TCP.</span><br>
<span class="lineno"></span><span class="keyword" id="3369266">type</span>&nbsp;<span class="ident" id="3369271">TCPListener</span>&nbsp;<span class="keyword" id="3369283">struct</span>&nbsp;<span class="op" id="3369290">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3369293">fd</span>&nbsp;<span class="op" id="3369296">*</span><span class="ident" id="3369297">netFD</span><br>
<span class="lineno"></span><span class="op" id="3369303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3369306">//&nbsp;AcceptTCP&nbsp;accepts&nbsp;the&nbsp;next&nbsp;incoming&nbsp;call&nbsp;and&nbsp;returns&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="3369370">//&nbsp;connection.</span><br>
<span class="lineno">230</span><span class="keyword" id="3369385">func</span>&nbsp;<span class="op" id="3369390">(</span><span class="ident" id="3369391">l</span>&nbsp;<span class="op" id="3369393">*</span><span class="ident" id="3369394">TCPListener</span><span class="op" id="3369405">)</span>&nbsp;<span class="ident" id="3369407">AcceptTCP</span><span class="op" id="3369416">(</span><span class="op" id="3369417">)</span>&nbsp;<span class="op" id="3369419">(</span><span class="op" id="3369420">*</span><span class="ident" id="3369421">TCPConn</span><span class="op" id="3369428">,</span>&nbsp;<span class="builtintype" id="3369430">error</span><span class="op" id="3369435">)</span>&nbsp;<span class="op" id="3369437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3369440">if</span>&nbsp;<span class="ident" id="3369443">l</span>&nbsp;<span class="op" id="3369445">==</span>&nbsp;<span class="builtintype" id="3369448">nil</span>&nbsp;<span class="op" id="3369452">||</span>&nbsp;<span class="ident" id="3369455">l</span><span class="op" id="3369456">.</span><span class="ident" id="3369457">fd</span>&nbsp;<span class="op" id="3369460">==</span>&nbsp;<span class="builtintype" id="3369463">nil</span>&nbsp;<span class="op" id="3369467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3369471">return</span>&nbsp;<span class="builtintype" id="3369478">nil</span><span class="op" id="3369481">,</span>&nbsp;<span class="ident" id="3369483">syscall</span><span class="op" id="3369490">.</span><span class="ident" id="3369491">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3369499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3369502">fd</span><span class="op" id="3369504">,</span>&nbsp;<span class="ident" id="3369506">err</span>&nbsp;<span class="op" id="3369510">:=</span>&nbsp;<span class="ident" id="3369513">l</span><span class="op" id="3369514">.</span><span class="ident" id="3369515">fd</span><span class="op" id="3369517">.</span><span class="ident" id="3369518">accept</span><span class="op" id="3369524">(</span><span class="op" id="3369525">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3369528">if</span>&nbsp;<span class="ident" id="3369531">err</span>&nbsp;<span class="op" id="3369535">!=</span>&nbsp;<span class="builtintype" id="3369538">nil</span>&nbsp;<span class="op" id="3369542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3369546">return</span>&nbsp;<span class="builtintype" id="3369553">nil</span><span class="op" id="3369556">,</span>&nbsp;<span class="ident" id="3369558">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3369563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3369566">return</span>&nbsp;<span class="ident" id="3369573">newTCPConn</span><span class="op" id="3369583">(</span><span class="ident" id="3369584">fd</span><span class="op" id="3369586">)</span><span class="op" id="3369587">,</span>&nbsp;<span class="builtintype" id="3369589">nil</span><br>
<span class="lineno"></span><span class="op" id="3369593">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="3369596">//&nbsp;Accept&nbsp;implements&nbsp;the&nbsp;Accept&nbsp;method&nbsp;in&nbsp;the&nbsp;Listener&nbsp;interface;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3369665">//&nbsp;waits&nbsp;for&nbsp;the&nbsp;next&nbsp;call&nbsp;and&nbsp;returns&nbsp;a&nbsp;generic&nbsp;Conn.</span><br>
<span class="lineno"></span><span class="keyword" id="3369720">func</span>&nbsp;<span class="op" id="3369725">(</span><span class="ident" id="3369726">l</span>&nbsp;<span class="op" id="3369728">*</span><span class="ident" id="3369729">TCPListener</span><span class="op" id="3369740">)</span>&nbsp;<span class="ident" id="3369742">Accept</span><span class="op" id="3369748">(</span><span class="op" id="3369749">)</span>&nbsp;<span class="op" id="3369751">(</span><span class="ident" id="3369752">Conn</span><span class="op" id="3369756">,</span>&nbsp;<span class="builtintype" id="3369758">error</span><span class="op" id="3369763">)</span>&nbsp;<span class="op" id="3369765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3369768">c</span><span class="op" id="3369769">,</span>&nbsp;<span class="ident" id="3369771">err</span>&nbsp;<span class="op" id="3369775">:=</span>&nbsp;<span class="ident" id="3369778">l</span><span class="op" id="3369779">.</span><span class="ident" id="3369780">AcceptTCP</span><span class="op" id="3369789">(</span><span class="op" id="3369790">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3369793">if</span>&nbsp;<span class="ident" id="3369796">err</span>&nbsp;<span class="op" id="3369800">!=</span>&nbsp;<span class="builtintype" id="3369803">nil</span>&nbsp;<span class="op" id="3369807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3369811">return</span>&nbsp;<span class="builtintype" id="3369818">nil</span><span class="op" id="3369821">,</span>&nbsp;<span class="ident" id="3369823">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3369828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3369831">return</span>&nbsp;<span class="ident" id="3369838">c</span><span class="op" id="3369839">,</span>&nbsp;<span class="builtintype" id="3369841">nil</span><br>
<span class="lineno"></span><span class="op" id="3369845">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="3369848">//&nbsp;Close&nbsp;stops&nbsp;listening&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="3369893">//&nbsp;Already&nbsp;Accepted&nbsp;connections&nbsp;are&nbsp;not&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="3369941">func</span>&nbsp;<span class="op" id="3369946">(</span><span class="ident" id="3369947">l</span>&nbsp;<span class="op" id="3369949">*</span><span class="ident" id="3369950">TCPListener</span><span class="op" id="3369961">)</span>&nbsp;<span class="ident" id="3369963">Close</span><span class="op" id="3369968">(</span><span class="op" id="3369969">)</span>&nbsp;<span class="builtintype" id="3369971">error</span>&nbsp;<span class="op" id="3369977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3369980">if</span>&nbsp;<span class="ident" id="3369983">l</span>&nbsp;<span class="op" id="3369985">==</span>&nbsp;<span class="builtintype" id="3369988">nil</span>&nbsp;<span class="op" id="3369992">||</span>&nbsp;<span class="ident" id="3369995">l</span><span class="op" id="3369996">.</span><span class="ident" id="3369997">fd</span>&nbsp;<span class="op" id="3370000">==</span>&nbsp;<span class="builtintype" id="3370003">nil</span>&nbsp;<span class="op" id="3370007">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3370011">return</span>&nbsp;<span class="ident" id="3370018">syscall</span><span class="op" id="3370025">.</span><span class="ident" id="3370026">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3370034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3370037">return</span>&nbsp;<span class="ident" id="3370044">l</span><span class="op" id="3370045">.</span><span class="ident" id="3370046">fd</span><span class="op" id="3370048">.</span><span class="ident" id="3370049">Close</span><span class="op" id="3370054">(</span><span class="op" id="3370055">)</span><br>
<span class="lineno"></span><span class="op" id="3370057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="3370060">//&nbsp;Addr&nbsp;returns&nbsp;the&nbsp;listener&#39;s&nbsp;network&nbsp;address,&nbsp;a&nbsp;*TCPAddr.</span><br>
<span class="lineno"></span><span class="keyword" id="3370120">func</span>&nbsp;<span class="op" id="3370125">(</span><span class="ident" id="3370126">l</span>&nbsp;<span class="op" id="3370128">*</span><span class="ident" id="3370129">TCPListener</span><span class="op" id="3370140">)</span>&nbsp;<span class="ident" id="3370142">Addr</span><span class="op" id="3370146">(</span><span class="op" id="3370147">)</span>&nbsp;<span class="ident" id="3370149">Addr</span>&nbsp;<span class="op" id="3370154">{</span>&nbsp;<span class="keyword" id="3370156">return</span>&nbsp;<span class="ident" id="3370163">l</span><span class="op" id="3370164">.</span><span class="ident" id="3370165">fd</span><span class="op" id="3370167">.</span><span class="ident" id="3370168">laddr</span>&nbsp;<span class="op" id="3370174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3370177">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;deadline&nbsp;associated&nbsp;with&nbsp;the&nbsp;listener.</span><br>
<span class="lineno"></span><span class="comment" id="3370240">//&nbsp;A&nbsp;zero&nbsp;time&nbsp;value&nbsp;disables&nbsp;the&nbsp;deadline.</span><br>
<span class="lineno">265</span><span class="keyword" id="3370284">func</span>&nbsp;<span class="op" id="3370289">(</span><span class="ident" id="3370290">l</span>&nbsp;<span class="op" id="3370292">*</span><span class="ident" id="3370293">TCPListener</span><span class="op" id="3370304">)</span>&nbsp;<span class="ident" id="3370306">SetDeadline</span><span class="op" id="3370317">(</span><span class="ident" id="3370318">t</span>&nbsp;<span class="ident" id="3370320">time</span><span class="op" id="3370324">.</span><span class="ident" id="3370325">Time</span><span class="op" id="3370329">)</span>&nbsp;<span class="builtintype" id="3370331">error</span>&nbsp;<span class="op" id="3370337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3370340">if</span>&nbsp;<span class="ident" id="3370343">l</span>&nbsp;<span class="op" id="3370345">==</span>&nbsp;<span class="builtintype" id="3370348">nil</span>&nbsp;<span class="op" id="3370352">||</span>&nbsp;<span class="ident" id="3370355">l</span><span class="op" id="3370356">.</span><span class="ident" id="3370357">fd</span>&nbsp;<span class="op" id="3370360">==</span>&nbsp;<span class="builtintype" id="3370363">nil</span>&nbsp;<span class="op" id="3370367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3370371">return</span>&nbsp;<span class="ident" id="3370378">syscall</span><span class="op" id="3370385">.</span><span class="ident" id="3370386">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3370394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3370397">return</span>&nbsp;<span class="ident" id="3370404">l</span><span class="op" id="3370405">.</span><span class="ident" id="3370406">fd</span><span class="op" id="3370408">.</span><span class="ident" id="3370409">setDeadline</span><span class="op" id="3370420">(</span><span class="ident" id="3370421">t</span><span class="op" id="3370422">)</span><br>
<span class="lineno">270</span><span class="op" id="3370424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3370427">//&nbsp;File&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;underlying&nbsp;os.File,&nbsp;set&nbsp;to&nbsp;blocking</span><br>
<span class="lineno"></span><span class="comment" id="3370493">//&nbsp;mode.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;close&nbsp;f&nbsp;when&nbsp;finished.</span><br>
<span class="lineno"></span><span class="comment" id="3370563">//&nbsp;Closing&nbsp;l&nbsp;does&nbsp;not&nbsp;affect&nbsp;f,&nbsp;and&nbsp;closing&nbsp;f&nbsp;does&nbsp;not&nbsp;affect&nbsp;l.</span><br>
<span class="lineno">275</span><span class="comment" id="3370628">//</span><br>
<span class="lineno"></span><span class="comment" id="3370631">//&nbsp;The&nbsp;returned&nbsp;os.File&#39;s&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;different&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3370695">//&nbsp;connection&#39;s.&nbsp;&nbsp;Attempting&nbsp;to&nbsp;change&nbsp;properties&nbsp;of&nbsp;the&nbsp;original</span><br>
<span class="lineno"></span><span class="comment" id="3370761">//&nbsp;using&nbsp;this&nbsp;duplicate&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;have&nbsp;the&nbsp;desired&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="3370825">func</span>&nbsp;<span class="op" id="3370830">(</span><span class="ident" id="3370831">l</span>&nbsp;<span class="op" id="3370833">*</span><span class="ident" id="3370834">TCPListener</span><span class="op" id="3370845">)</span>&nbsp;<span class="ident" id="3370847">File</span><span class="op" id="3370851">(</span><span class="op" id="3370852">)</span>&nbsp;<span class="op" id="3370854">(</span><span class="ident" id="3370855">f</span>&nbsp;<span class="op" id="3370857">*</span><span class="ident" id="3370858">os</span><span class="op" id="3370860">.</span><span class="ident" id="3370861">File</span><span class="op" id="3370865">,</span>&nbsp;<span class="ident" id="3370867">err</span>&nbsp;<span class="builtintype" id="3370871">error</span><span class="op" id="3370876">)</span>&nbsp;<span class="op" id="3370878">{</span>&nbsp;<span class="keyword" id="3370880">return</span>&nbsp;<span class="ident" id="3370887">l</span><span class="op" id="3370888">.</span><span class="ident" id="3370889">fd</span><span class="op" id="3370891">.</span><span class="ident" id="3370892">dup</span><span class="op" id="3370895">(</span><span class="op" id="3370896">)</span>&nbsp;<span class="op" id="3370898">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3370901">//&nbsp;ListenTCP&nbsp;announces&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address&nbsp;laddr&nbsp;and&nbsp;returns&nbsp;a&nbsp;TCP</span><br>
<span class="lineno"></span><span class="comment" id="3370967">//&nbsp;listener.&nbsp;&nbsp;Net&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;has&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3371035">//&nbsp;port&nbsp;of&nbsp;0,&nbsp;ListenTCP&nbsp;will&nbsp;choose&nbsp;an&nbsp;available&nbsp;port.&nbsp;&nbsp;The&nbsp;caller&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="3371106">//&nbsp;use&nbsp;the&nbsp;Addr&nbsp;method&nbsp;of&nbsp;TCPListener&nbsp;to&nbsp;retrieve&nbsp;the&nbsp;chosen&nbsp;address.</span><br>
<span class="lineno">285</span><span class="keyword" id="3371176">func</span>&nbsp;<span class="ident" id="3371181">ListenTCP</span><span class="op" id="3371190">(</span><span class="ident" id="3371191">net</span>&nbsp;<span class="builtintype" id="3371195">string</span><span class="op" id="3371201">,</span>&nbsp;<span class="ident" id="3371203">laddr</span>&nbsp;<span class="op" id="3371209">*</span><span class="ident" id="3371210">TCPAddr</span><span class="op" id="3371217">)</span>&nbsp;<span class="op" id="3371219">(</span><span class="op" id="3371220">*</span><span class="ident" id="3371221">TCPListener</span><span class="op" id="3371232">,</span>&nbsp;<span class="builtintype" id="3371234">error</span><span class="op" id="3371239">)</span>&nbsp;<span class="op" id="3371241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3371244">switch</span>&nbsp;<span class="ident" id="3371251">net</span>&nbsp;<span class="op" id="3371255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3371258">case</span>&nbsp;<span class="string" id="3371263">&#34;tcp&#34;</span><span class="op" id="3371268">,</span>&nbsp;<span class="string" id="3371270">&#34;tcp4&#34;</span><span class="op" id="3371276">,</span>&nbsp;<span class="string" id="3371278">&#34;tcp6&#34;</span><span class="op" id="3371284">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3371287">default</span><span class="op" id="3371294">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3371298">return</span>&nbsp;<span class="builtintype" id="3371305">nil</span><span class="op" id="3371308">,</span>&nbsp;<span class="op" id="3371310">&amp;</span><span class="ident" id="3371311">OpError</span><span class="op" id="3371318">{</span><span class="ident" id="3371319">Op</span><span class="op" id="3371321">:</span>&nbsp;<span class="string" id="3371323">&#34;listen&#34;</span><span class="op" id="3371331">,</span>&nbsp;<span class="ident" id="3371333">Net</span><span class="op" id="3371336">:</span>&nbsp;<span class="ident" id="3371338">net</span><span class="op" id="3371341">,</span>&nbsp;<span class="ident" id="3371343">Addr</span><span class="op" id="3371347">:</span>&nbsp;<span class="ident" id="3371349">laddr</span><span class="op" id="3371354">,</span>&nbsp;<span class="ident" id="3371356">Err</span><span class="op" id="3371359">:</span>&nbsp;<span class="ident" id="3371361">UnknownNetworkError</span><span class="op" id="3371380">(</span><span class="ident" id="3371381">net</span><span class="op" id="3371384">)</span><span class="op" id="3371385">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3371388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3371391">if</span>&nbsp;<span class="ident" id="3371394">laddr</span>&nbsp;<span class="op" id="3371400">==</span>&nbsp;<span class="builtintype" id="3371403">nil</span>&nbsp;<span class="op" id="3371407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3371411">laddr</span>&nbsp;<span class="op" id="3371417">=</span>&nbsp;<span class="op" id="3371419">&amp;</span><span class="ident" id="3371420">TCPAddr</span><span class="op" id="3371427">{</span><span class="op" id="3371428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3371431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3371434">fd</span><span class="op" id="3371436">,</span>&nbsp;<span class="ident" id="3371438">err</span>&nbsp;<span class="op" id="3371442">:=</span>&nbsp;<span class="ident" id="3371445">internetSocket</span><span class="op" id="3371459">(</span><span class="ident" id="3371460">net</span><span class="op" id="3371463">,</span>&nbsp;<span class="ident" id="3371465">laddr</span><span class="op" id="3371470">,</span>&nbsp;<span class="builtintype" id="3371472">nil</span><span class="op" id="3371475">,</span>&nbsp;<span class="ident" id="3371477">noDeadline</span><span class="op" id="3371487">,</span>&nbsp;<span class="ident" id="3371489">syscall</span><span class="op" id="3371496">.</span><span class="ident" id="3371497">SOCK_STREAM</span><span class="op" id="3371508">,</span>&nbsp;<span class="num" id="3371510">0</span><span class="op" id="3371511">,</span>&nbsp;<span class="string" id="3371513">&#34;listen&#34;</span><span class="op" id="3371521">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3371524">if</span>&nbsp;<span class="ident" id="3371527">err</span>&nbsp;<span class="op" id="3371531">!=</span>&nbsp;<span class="builtintype" id="3371534">nil</span>&nbsp;<span class="op" id="3371538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3371542">return</span>&nbsp;<span class="builtintype" id="3371549">nil</span><span class="op" id="3371552">,</span>&nbsp;<span class="op" id="3371554">&amp;</span><span class="ident" id="3371555">OpError</span><span class="op" id="3371562">{</span><span class="ident" id="3371563">Op</span><span class="op" id="3371565">:</span>&nbsp;<span class="string" id="3371567">&#34;listen&#34;</span><span class="op" id="3371575">,</span>&nbsp;<span class="ident" id="3371577">Net</span><span class="op" id="3371580">:</span>&nbsp;<span class="ident" id="3371582">net</span><span class="op" id="3371585">,</span>&nbsp;<span class="ident" id="3371587">Addr</span><span class="op" id="3371591">:</span>&nbsp;<span class="ident" id="3371593">laddr</span><span class="op" id="3371598">,</span>&nbsp;<span class="ident" id="3371600">Err</span><span class="op" id="3371603">:</span>&nbsp;<span class="ident" id="3371605">err</span><span class="op" id="3371608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3371611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3371614">return</span>&nbsp;<span class="op" id="3371621">&amp;</span><span class="ident" id="3371622">TCPListener</span><span class="op" id="3371633">{</span><span class="ident" id="3371634">fd</span><span class="op" id="3371636">}</span><span class="op" id="3371637">,</span>&nbsp;<span class="builtintype" id="3371639">nil</span><br>
<span class="lineno"></span><span class="op" id="3371643">}</span>
</div>
</body>
</html>
