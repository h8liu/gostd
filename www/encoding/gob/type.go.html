<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;userTypeInfo&nbsp;stores&nbsp;the&nbsp;information&nbsp;associated&nbsp;with&nbsp;a&nbsp;type&nbsp;the&nbsp;user&nbsp;has&nbsp;handed</span><br>
<span class="lineno">20</span><span class="comment">//&nbsp;to&nbsp;the&nbsp;package.&nbsp;&nbsp;It&#39;s&nbsp;computed&nbsp;once&nbsp;and&nbsp;stored&nbsp;in&nbsp;a&nbsp;map&nbsp;keyed&nbsp;by&nbsp;reflection</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">userTypeInfo</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">user</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span>&nbsp;<span class="comment">//&nbsp;the&nbsp;type&nbsp;the&nbsp;user&nbsp;handed&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">base</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span>&nbsp;<span class="comment">//&nbsp;the&nbsp;base&nbsp;type&nbsp;after&nbsp;all&nbsp;indirections</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">indir</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;base&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">externalEnc</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;xGob,&nbsp;xBinary,&nbsp;or&nbsp;xText</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">externalDec</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;xGob,&nbsp;xBinary&nbsp;or&nbsp;xText</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">encIndir</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;receiver&nbsp;type;&nbsp;may&nbsp;be&nbsp;negative</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">decIndir</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">int8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;number&nbsp;of&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;receiver&nbsp;type;&nbsp;may&nbsp;be&nbsp;negative</span><br>
<span class="lineno">30</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;externalEncoding&nbsp;bits</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xGob</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">iota</span>&nbsp;<span class="comment">//&nbsp;GobEncoder&nbsp;or&nbsp;GobDecoder</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xBinary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;encoding.BinaryMarshaler&nbsp;or&nbsp;encoding.BinaryUnmarshaler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xText</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;encoding.TextMarshaler&nbsp;or&nbsp;encoding.TextUnmarshaler</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Protected&nbsp;by&nbsp;an&nbsp;RWMutex&nbsp;because&nbsp;we&nbsp;read&nbsp;it&nbsp;a&nbsp;lot&nbsp;and&nbsp;write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;it&nbsp;only&nbsp;when&nbsp;we&nbsp;see&nbsp;a&nbsp;new&nbsp;type,&nbsp;typically&nbsp;when&nbsp;compiling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">userTypeLock</span>&nbsp;&nbsp;<span class="ident">sync</span><span class="op">.</span><span class="ident">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">userTypeCache</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;validType&nbsp;returns,&nbsp;and&nbsp;saves,&nbsp;the&nbsp;information&nbsp;associated&nbsp;with&nbsp;user-provided&nbsp;type&nbsp;rt.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;the&nbsp;user&nbsp;type&nbsp;is&nbsp;not&nbsp;valid,&nbsp;err&nbsp;will&nbsp;be&nbsp;non-nil.&nbsp;&nbsp;To&nbsp;be&nbsp;used&nbsp;when&nbsp;the&nbsp;error&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;is&nbsp;not&nbsp;set&nbsp;up.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">validUserType</span><span class="op">(</span><span class="ident">rt</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">userTypeLock</span><span class="op">.</span><span class="ident">RLock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">userTypeCache</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">userTypeLock</span><span class="op">.</span><span class="ident">RUnlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Now&nbsp;set&nbsp;the&nbsp;value&nbsp;under&nbsp;the&nbsp;write&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">userTypeLock</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">userTypeLock</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">userTypeCache</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Lost&nbsp;the&nbsp;race;&nbsp;not&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">userTypeInfo</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">rt</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span><span class="op">.</span><span class="ident">user</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">rt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;A&nbsp;type&nbsp;that&nbsp;is&nbsp;just&nbsp;a&nbsp;cycle&nbsp;of&nbsp;pointers&nbsp;(such&nbsp;as&nbsp;type&nbsp;T&nbsp;*T)&nbsp;cannot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;be&nbsp;represented&nbsp;in&nbsp;gobs,&nbsp;which&nbsp;need&nbsp;some&nbsp;concrete&nbsp;data.&nbsp;&nbsp;We&nbsp;use&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;cycle&nbsp;detection&nbsp;algorithm&nbsp;from&nbsp;Knuth,&nbsp;Vol&nbsp;2,&nbsp;Section&nbsp;3.1,&nbsp;Ex&nbsp;6,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;pp&nbsp;539-540.&nbsp;&nbsp;As&nbsp;we&nbsp;step&nbsp;through&nbsp;indirections,&nbsp;run&nbsp;another&nbsp;type&nbsp;at</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;half&nbsp;speed.&nbsp;If&nbsp;they&nbsp;meet&nbsp;up,&nbsp;there&#39;s&nbsp;a&nbsp;cycle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">slowpoke</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span>&nbsp;<span class="comment">//&nbsp;walks&nbsp;half&nbsp;as&nbsp;fast&nbsp;as&nbsp;ut.base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">pt</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">pt</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">slowpoke</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;ut.base&nbsp;lapped&nbsp;slowpoke</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;recursive&nbsp;pointer&nbsp;type.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;can&#39;t&nbsp;represent&nbsp;recursive&nbsp;pointer&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">indir</span><span class="op">%</span><span class="num">2</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">slowpoke</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">slowpoke</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span><span class="op">.</span><span class="ident">indir</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ok</span><span class="op">,</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">implementsInterface</span><span class="op">(</span><span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><span class="op">,</span>&nbsp;<span class="ident">gobEncoderInterfaceType</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">encIndir</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">xGob</span><span class="op">,</span>&nbsp;<span class="ident">indir</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">ok</span><span class="op">,</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">implementsInterface</span><span class="op">(</span><span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><span class="op">,</span>&nbsp;<span class="ident">binaryMarshalerInterfaceType</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">encIndir</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">xBinary</span><span class="op">,</span>&nbsp;<span class="ident">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;NOTE(rsc):&nbsp;Would&nbsp;like&nbsp;to&nbsp;allow&nbsp;MarshalText&nbsp;here,&nbsp;but&nbsp;results&nbsp;in&nbsp;incompatibility</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;with&nbsp;older&nbsp;encodings&nbsp;for&nbsp;net.IP.&nbsp;See&nbsp;golang.org/issue/6760.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;}&nbsp;else&nbsp;if&nbsp;ok,&nbsp;indir&nbsp;:=&nbsp;implementsInterface(ut.user,&nbsp;textMarshalerInterfaceType);&nbsp;ok&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsput.externalEnc,&nbsp;ut.encIndir&nbsp;=&nbsp;xText,&nbsp;indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ok</span><span class="op">,</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">implementsInterface</span><span class="op">(</span><span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><span class="op">,</span>&nbsp;<span class="ident">gobDecoderInterfaceType</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span><span class="op">.</span><span class="ident">externalDec</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">decIndir</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">xGob</span><span class="op">,</span>&nbsp;<span class="ident">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">ok</span><span class="op">,</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">implementsInterface</span><span class="op">(</span><span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><span class="op">,</span>&nbsp;<span class="ident">binaryUnmarshalerInterfaceType</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span><span class="op">.</span><span class="ident">externalDec</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">decIndir</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">xBinary</span><span class="op">,</span>&nbsp;<span class="ident">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;See&nbsp;note&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;}&nbsp;else&nbsp;if&nbsp;ok,&nbsp;indir&nbsp;:=&nbsp;implementsInterface(ut.user,&nbsp;textUnmarshalerInterfaceType);&nbsp;ok&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsput.externalDec,&nbsp;ut.decIndir&nbsp;=&nbsp;xText,&nbsp;indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">userTypeCache</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gobEncoderInterfaceType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="op">(</span><span class="op">*</span><span class="ident">GobEncoder</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gobDecoderInterfaceType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="op">(</span><span class="op">*</span><span class="ident">GobDecoder</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">binaryMarshalerInterfaceType</span>&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="op">(</span><span class="op">*</span><span class="ident">encoding</span><span class="op">.</span><span class="ident">BinaryMarshaler</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">binaryUnmarshalerInterfaceType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="op">(</span><span class="op">*</span><span class="ident">encoding</span><span class="op">.</span><span class="ident">BinaryUnmarshaler</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">textMarshalerInterfaceType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="op">(</span><span class="op">*</span><span class="ident">encoding</span><span class="op">.</span><span class="ident">TextMarshaler</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">textUnmarshalerInterfaceType</span>&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="op">(</span><span class="op">*</span><span class="ident">encoding</span><span class="op">.</span><span class="ident">TextUnmarshaler</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;implementsInterface&nbsp;reports&nbsp;whether&nbsp;the&nbsp;type&nbsp;implements&nbsp;the</span><br>
<span class="lineno">125</span><span class="comment">//&nbsp;gobEncoder/gobDecoder&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;also&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;indirections&nbsp;required&nbsp;to&nbsp;get&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;implementation.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">implementsInterface</span><span class="op">(</span><span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="ident">gobEncDecType</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">success</span>&nbsp;<span class="builtintype">bool</span><span class="op">,</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="builtintype">int8</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;type&nbsp;might&nbsp;be&nbsp;a&nbsp;pointer&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;keep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;dereferencing&nbsp;to&nbsp;the&nbsp;base&nbsp;type&nbsp;until&nbsp;we&nbsp;find&nbsp;an&nbsp;implementation.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">Implements</span><span class="op">(</span><span class="ident">gobEncDecType</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">rt</span><span class="op">;</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">indir</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">100</span>&nbsp;<span class="op">{</span>&nbsp;<span class="comment">//&nbsp;insane&nbsp;number&nbsp;of&nbsp;indirections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><span class="op">,</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;No&nbsp;luck&nbsp;yet,&nbsp;but&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;base&nbsp;type&nbsp;(non-pointer),&nbsp;the&nbsp;pointer&nbsp;might&nbsp;satisfy.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Not&nbsp;a&nbsp;pointer,&nbsp;but&nbsp;does&nbsp;the&nbsp;pointer&nbsp;work?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">PtrTo</span><span class="op">(</span><span class="ident">typ</span><span class="op">)</span><span class="op">.</span><span class="ident">Implements</span><span class="op">(</span><span class="ident">gobEncDecType</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><span class="op">,</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;userType&nbsp;returns,&nbsp;and&nbsp;saves,&nbsp;the&nbsp;information&nbsp;associated&nbsp;with&nbsp;user-provided&nbsp;type&nbsp;rt.</span><br>
<span class="lineno">160</span><span class="comment">//&nbsp;If&nbsp;the&nbsp;user&nbsp;type&nbsp;is&nbsp;not&nbsp;valid,&nbsp;it&nbsp;calls&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">rt</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">validUserType</span><span class="op">(</span><span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ut</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;typeId&nbsp;represents&nbsp;a&nbsp;gob&nbsp;Type&nbsp;as&nbsp;an&nbsp;integer&nbsp;that&nbsp;can&nbsp;be&nbsp;passed&nbsp;on&nbsp;the&nbsp;wire.</span><br>
<span class="lineno">170</span><span class="comment">//&nbsp;Internally,&nbsp;typeIds&nbsp;are&nbsp;used&nbsp;as&nbsp;keys&nbsp;to&nbsp;a&nbsp;map&nbsp;to&nbsp;recover&nbsp;the&nbsp;underlying&nbsp;type&nbsp;info.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">typeId</span>&nbsp;<span class="builtintype">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">nextId</span>&nbsp;<span class="ident">typeId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;incremented&nbsp;for&nbsp;each&nbsp;new&nbsp;type&nbsp;we&nbsp;build</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">typeLock</span>&nbsp;<span class="ident">sync</span><span class="op">.</span><span class="ident">Mutex</span>&nbsp;<span class="comment">//&nbsp;set&nbsp;while&nbsp;building&nbsp;a&nbsp;type</span><br>
<span class="lineno">175</span><span class="keyword">const</span>&nbsp;<span class="ident">firstUserId</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">64</span>&nbsp;&nbsp;<span class="comment">//&nbsp;lowest&nbsp;id&nbsp;number&nbsp;granted&nbsp;to&nbsp;user</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">gobType</span>&nbsp;<span class="keyword">interface</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">id</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">typeId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">setId</span><span class="op">(</span><span class="ident">id</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype">string</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;not&nbsp;public;&nbsp;only&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span><span class="keyword">var</span>&nbsp;<span class="ident">types</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="ident">gobType</span><span class="op">)</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">idToType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="ident">gobType</span><span class="op">)</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">builtinIdToType</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="ident">gobType</span>&nbsp;<span class="comment">//&nbsp;set&nbsp;in&nbsp;init()&nbsp;after&nbsp;builtins&nbsp;are&nbsp;established</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">setTypeId</span><span class="op">(</span><span class="ident">typ</span>&nbsp;<span class="ident">gobType</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;When&nbsp;building&nbsp;recursive&nbsp;types,&nbsp;someone&nbsp;may&nbsp;get&nbsp;there&nbsp;before&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">id</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nextId</span><span class="op">++</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span><span class="op">.</span><span class="ident">setId</span><span class="op">(</span><span class="ident">nextId</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">idToType</span><span class="op">[</span><span class="ident">nextId</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">typ</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="ident">gobType</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">gobType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">idToType</span><span class="op">[</span><span class="ident">t</span><span class="op">]</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;string&nbsp;returns&nbsp;the&nbsp;string&nbsp;representation&nbsp;of&nbsp;the&nbsp;type&nbsp;associated&nbsp;with&nbsp;the&nbsp;typeId.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&lt;nil&gt;&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="builtintype">string</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Name&nbsp;returns&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;associated&nbsp;with&nbsp;the&nbsp;typeId.</span><br>
<span class="lineno">215</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="ident">name</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&lt;nil&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">name</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">220</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;CommonType&nbsp;holds&nbsp;elements&nbsp;of&nbsp;all&nbsp;types.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;is&nbsp;a&nbsp;historical&nbsp;artifact,&nbsp;kept&nbsp;for&nbsp;binary&nbsp;compatibility&nbsp;and&nbsp;exported</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;only&nbsp;for&nbsp;the&nbsp;benefit&nbsp;of&nbsp;the&nbsp;package&#39;s&nbsp;encoding&nbsp;of&nbsp;type&nbsp;descriptors.&nbsp;It&nbsp;is</span><br>
<span class="lineno">225</span><span class="comment">//&nbsp;not&nbsp;intended&nbsp;for&nbsp;direct&nbsp;use&nbsp;by&nbsp;clients.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">CommonType</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Name</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Id</span>&nbsp;&nbsp;&nbsp;<span class="ident">typeId</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">CommonType</span><span class="op">)</span>&nbsp;<span class="ident">id</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">typeId</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Id</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">CommonType</span><span class="op">)</span>&nbsp;<span class="ident">setId</span><span class="op">(</span><span class="ident">id</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="op">{</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Id</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">id</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">CommonType</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Name</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">CommonType</span><span class="op">)</span>&nbsp;<span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">CommonType</span><span class="op">)</span>&nbsp;<span class="ident">name</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Name</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Create&nbsp;and&nbsp;check&nbsp;predefined&nbsp;types</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;string&nbsp;for&nbsp;tBytes&nbsp;is&nbsp;&#34;bytes&#34;&nbsp;not&nbsp;&#34;[]byte&#34;&nbsp;to&nbsp;signify&nbsp;its&nbsp;specialness.</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Primordial&nbsp;types,&nbsp;needed&nbsp;during&nbsp;initialization.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Always&nbsp;passed&nbsp;as&nbsp;pointers&nbsp;so&nbsp;the&nbsp;interface{}&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;goes&nbsp;through&nbsp;without&nbsp;losing&nbsp;its&nbsp;interfaceness.</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tBool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;bool&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="builtintype">bool</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tInt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;int&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="builtintype">int</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tUint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;uint&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="builtintype">uint</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">3</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tFloat</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;float&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="builtintype">float64</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">4</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;bytes&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">5</span><span class="op">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tString</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;string&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="builtintype">string</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">6</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tComplex</span>&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;complex&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="builtintype">complex128</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">7</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tInterface</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;interface&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">8</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Reserve&nbsp;some&nbsp;Ids&nbsp;for&nbsp;compatible&nbsp;expansion</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tReserved7</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;_reserved1&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="keyword">struct</span><span class="op">{</span>&nbsp;<span class="ident">r7</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">}</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">9</span><span class="op">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tReserved6</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;_reserved1&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="keyword">struct</span><span class="op">{</span>&nbsp;<span class="ident">r6</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">}</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tReserved5</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;_reserved1&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="keyword">struct</span><span class="op">{</span>&nbsp;<span class="ident">r5</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">}</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">11</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tReserved4</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;_reserved1&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="keyword">struct</span><span class="op">{</span>&nbsp;<span class="ident">r4</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">}</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">12</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tReserved3</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;_reserved1&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="keyword">struct</span><span class="op">{</span>&nbsp;<span class="ident">r3</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">}</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">13</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tReserved2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;_reserved1&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="keyword">struct</span><span class="op">{</span>&nbsp;<span class="ident">r2</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">}</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">14</span><span class="op">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tReserved1</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="string">&#34;_reserved1&#34;</span><span class="op">,</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="keyword">struct</span><span class="op">{</span>&nbsp;<span class="ident">r1</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">}</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">15</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Predefined&nbsp;because&nbsp;it&#39;s&nbsp;needed&nbsp;by&nbsp;the&nbsp;Decoder</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">tWireType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mustGetTypeInfo</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">wireType</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">id</span><br>
<span class="lineno">270</span><span class="keyword">var</span>&nbsp;<span class="ident">wireTypeUserInfo</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span>&nbsp;<span class="comment">//&nbsp;userTypeInfo&nbsp;of&nbsp;(*wireType)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">init</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Some&nbsp;magic&nbsp;numbers&nbsp;to&nbsp;make&nbsp;sure&nbsp;there&nbsp;are&nbsp;no&nbsp;surprises.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkId</span><span class="op">(</span><span class="num">16</span><span class="op">,</span>&nbsp;<span class="ident">tWireType</span><span class="op">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkId</span><span class="op">(</span><span class="num">17</span><span class="op">,</span>&nbsp;<span class="ident">mustGetTypeInfo</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">arrayType</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">id</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkId</span><span class="op">(</span><span class="num">18</span><span class="op">,</span>&nbsp;<span class="ident">mustGetTypeInfo</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">CommonType</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">id</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkId</span><span class="op">(</span><span class="num">19</span><span class="op">,</span>&nbsp;<span class="ident">mustGetTypeInfo</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">sliceType</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">id</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkId</span><span class="op">(</span><span class="num">20</span><span class="op">,</span>&nbsp;<span class="ident">mustGetTypeInfo</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">structType</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">id</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkId</span><span class="op">(</span><span class="num">21</span><span class="op">,</span>&nbsp;<span class="ident">mustGetTypeInfo</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">fieldType</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">id</span><span class="op">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkId</span><span class="op">(</span><span class="num">23</span><span class="op">,</span>&nbsp;<span class="ident">mustGetTypeInfo</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">mapType</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><span class="op">)</span><span class="op">.</span><span class="ident">id</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">builtinIdToType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="ident">gobType</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">k</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">idToType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">builtinIdToType</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">v</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Move&nbsp;the&nbsp;id&nbsp;space&nbsp;upwards&nbsp;to&nbsp;allow&nbsp;for&nbsp;growth&nbsp;in&nbsp;the&nbsp;predefined&nbsp;world</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;without&nbsp;breaking&nbsp;existing&nbsp;files.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nextId</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">firstUserId</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintln</span><span class="op">(</span><span class="string">&#34;nextId&nbsp;too&nbsp;large:&#34;</span><span class="op">,</span>&nbsp;<span class="ident">nextId</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nextId</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">firstUserId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">registerBasics</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wireTypeUserInfo</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="op">(</span><span class="op">*</span><span class="ident">wireType</span><span class="op">)</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">295</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Array&nbsp;type</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">arrayType</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">CommonType</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Elem</span>&nbsp;<span class="ident">typeId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Len</span>&nbsp;&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newArrayType</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">arrayType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">arrayType</span><span class="op">{</span><span class="ident">CommonType</span><span class="op">{</span><span class="ident">Name</span><span class="op">:</span>&nbsp;<span class="ident">name</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">a</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">*</span><span class="ident">arrayType</span><span class="op">)</span>&nbsp;<span class="ident">init</span><span class="op">(</span><span class="ident">elem</span>&nbsp;<span class="ident">gobType</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Set&nbsp;our&nbsp;type&nbsp;id&nbsp;before&nbsp;evaluating&nbsp;the&nbsp;element&#39;s,&nbsp;in&nbsp;case&nbsp;it&#39;s&nbsp;our&nbsp;own.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">setTypeId</span><span class="op">(</span><span class="ident">a</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a</span><span class="op">.</span><span class="ident">Elem</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">elem</span><span class="op">.</span><span class="ident">id</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a</span><span class="op">.</span><span class="ident">Len</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">len</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">*</span><span class="ident">arrayType</span><span class="op">)</span>&nbsp;<span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">seen</span><span class="op">[</span><span class="ident">a</span><span class="op">.</span><span class="ident">Id</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">seen</span><span class="op">[</span><span class="ident">a</span><span class="op">.</span><span class="ident">Id</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;[%d]%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">Len</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">Elem</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">a</span>&nbsp;<span class="op">*</span><span class="ident">arrayType</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">safeString</span><span class="op">(</span><span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GobEncoder&nbsp;type&nbsp;(something&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface)</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">gobEncoderType</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">CommonType</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newGobEncoderType</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">gobEncoderType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">gobEncoderType</span><span class="op">{</span><span class="ident">CommonType</span><span class="op">{</span><span class="ident">Name</span><span class="op">:</span>&nbsp;<span class="ident">name</span><span class="op">}</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">setTypeId</span><span class="op">(</span><span class="ident">g</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">g</span><br>
<span class="lineno">335</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">g</span>&nbsp;<span class="op">*</span><span class="ident">gobEncoderType</span><span class="op">)</span>&nbsp;<span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">g</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">g</span>&nbsp;<span class="op">*</span><span class="ident">gobEncoderType</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">g</span><span class="op">.</span><span class="ident">Name</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Map&nbsp;type</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">mapType</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">CommonType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Key</span>&nbsp;&nbsp;<span class="ident">typeId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Elem</span>&nbsp;<span class="ident">typeId</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword">func</span>&nbsp;<span class="ident">newMapType</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">mapType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">mapType</span><span class="op">{</span><span class="ident">CommonType</span><span class="op">{</span><span class="ident">Name</span><span class="op">:</span>&nbsp;<span class="ident">name</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">m</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">m</span>&nbsp;<span class="op">*</span><span class="ident">mapType</span><span class="op">)</span>&nbsp;<span class="ident">init</span><span class="op">(</span><span class="ident">key</span><span class="op">,</span>&nbsp;<span class="ident">elem</span>&nbsp;<span class="ident">gobType</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Set&nbsp;our&nbsp;type&nbsp;id&nbsp;before&nbsp;evaluating&nbsp;the&nbsp;element&#39;s,&nbsp;in&nbsp;case&nbsp;it&#39;s&nbsp;our&nbsp;own.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">setTypeId</span><span class="op">(</span><span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">Key</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">key</span><span class="op">.</span><span class="ident">id</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">Elem</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">elem</span><span class="op">.</span><span class="ident">id</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">360</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">m</span>&nbsp;<span class="op">*</span><span class="ident">mapType</span><span class="op">)</span>&nbsp;<span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">seen</span><span class="op">[</span><span class="ident">m</span><span class="op">.</span><span class="ident">Id</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">seen</span><span class="op">[</span><span class="ident">m</span><span class="op">.</span><span class="ident">Id</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">key</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Key</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elem</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Elem</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;map[%s]%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">key</span><span class="op">,</span>&nbsp;<span class="ident">elem</span><span class="op">)</span><br>
<span class="lineno">370</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">m</span>&nbsp;<span class="op">*</span><span class="ident">mapType</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">safeString</span><span class="op">(</span><span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Slice&nbsp;type</span><br>
<span class="lineno">375</span><span class="keyword">type</span>&nbsp;<span class="ident">sliceType</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">CommonType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Elem</span>&nbsp;<span class="ident">typeId</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span><span class="keyword">func</span>&nbsp;<span class="ident">newSliceType</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">sliceType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">sliceType</span><span class="op">{</span><span class="ident">CommonType</span><span class="op">{</span><span class="ident">Name</span><span class="op">:</span>&nbsp;<span class="ident">name</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">*</span><span class="ident">sliceType</span><span class="op">)</span>&nbsp;<span class="ident">init</span><span class="op">(</span><span class="ident">elem</span>&nbsp;<span class="ident">gobType</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Set&nbsp;our&nbsp;type&nbsp;id&nbsp;before&nbsp;evaluating&nbsp;the&nbsp;element&#39;s,&nbsp;in&nbsp;case&nbsp;it&#39;s&nbsp;our&nbsp;own.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">setTypeId</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;See&nbsp;the&nbsp;comments&nbsp;about&nbsp;ids&nbsp;in&nbsp;newTypeObject.&nbsp;Only&nbsp;slices&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;structs&nbsp;have&nbsp;mutual&nbsp;recursion.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">elem</span><span class="op">.</span><span class="ident">id</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">setTypeId</span><span class="op">(</span><span class="ident">elem</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">.</span><span class="ident">Elem</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">elem</span><span class="op">.</span><span class="ident">id</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">*</span><span class="ident">sliceType</span><span class="op">)</span>&nbsp;<span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">seen</span><span class="op">[</span><span class="ident">s</span><span class="op">.</span><span class="ident">Id</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">seen</span><span class="op">[</span><span class="ident">s</span><span class="op">.</span><span class="ident">Id</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;[]%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Elem</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">*</span><span class="ident">sliceType</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">safeString</span><span class="op">(</span><span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Struct&nbsp;type</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">fieldType</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Name</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Id</span>&nbsp;&nbsp;&nbsp;<span class="ident">typeId</span><br>
<span class="lineno">410</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">structType</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">CommonType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Field</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">fieldType</span><br>
<span class="lineno">415</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">*</span><span class="ident">structType</span><span class="op">)</span>&nbsp;<span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&lt;nil&gt;&#34;</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">seen</span><span class="op">[</span><span class="ident">s</span><span class="op">.</span><span class="ident">Id</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">seen</span><span class="op">[</span><span class="ident">s</span><span class="op">.</span><span class="ident">Id</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">str</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Name</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;&nbsp;=&nbsp;struct&nbsp;{&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Field</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">str</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;%s&nbsp;%s;&nbsp;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">Name</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">Id</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">safeString</span><span class="op">(</span><span class="ident">seen</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">str</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;}&#34;</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">str</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">*</span><span class="ident">structType</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span>&nbsp;<span class="keyword">return</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">safeString</span><span class="op">(</span><span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">typeId</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword">func</span>&nbsp;<span class="ident">newStructType</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">structType</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">structType</span><span class="op">{</span><span class="ident">CommonType</span><span class="op">{</span><span class="ident">Name</span><span class="op">:</span>&nbsp;<span class="ident">name</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;historical&nbsp;reasons&nbsp;we&nbsp;set&nbsp;the&nbsp;id&nbsp;here&nbsp;rather&nbsp;than&nbsp;init.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;newTypeObject&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">setTypeId</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;newTypeObject&nbsp;allocates&nbsp;a&nbsp;gobType&nbsp;for&nbsp;the&nbsp;reflection&nbsp;type&nbsp;rt.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Unless&nbsp;ut&nbsp;represents&nbsp;a&nbsp;GobEncoder,&nbsp;rt&nbsp;should&nbsp;be&nbsp;the&nbsp;base&nbsp;type</span><br>
<span class="lineno">445</span><span class="comment">//&nbsp;of&nbsp;ut.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;is&nbsp;only&nbsp;called&nbsp;from&nbsp;the&nbsp;encoding&nbsp;side.&nbsp;The&nbsp;decoding&nbsp;side</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;works&nbsp;through&nbsp;typeIds&nbsp;and&nbsp;userTypeInfos&nbsp;alone.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newTypeObject</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">,</span>&nbsp;<span class="ident">rt</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">gobType</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Does&nbsp;this&nbsp;type&nbsp;implement&nbsp;GobEncoder?</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">newGobEncoderType</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">type0</span><span class="op">,</span>&nbsp;<span class="ident">type1</span>&nbsp;<span class="ident">gobType</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">delete</span><span class="op">(</span><span class="ident">types</span><span class="op">,</span>&nbsp;<span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Install&nbsp;the&nbsp;top-level&nbsp;type&nbsp;before&nbsp;the&nbsp;subtypes&nbsp;(e.g.&nbsp;struct&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;fields)&nbsp;so&nbsp;recursive&nbsp;types&nbsp;can&nbsp;be&nbsp;constructed&nbsp;safely.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">rt</span><span class="op">;</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;All&nbsp;basic&nbsp;types&nbsp;are&nbsp;easy:&nbsp;they&nbsp;are&nbsp;predefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Bool</span><span class="op">:</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">tBool</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int8</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int16</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int32</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int64</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">tInt</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint8</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint16</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint32</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint64</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uintptr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">tUint</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Float32</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Float64</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">tFloat</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Complex64</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Complex128</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">tComplex</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">String</span><span class="op">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">tString</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Interface</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">tInterface</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Array</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">at</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newArrayType</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">types</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">type0</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">getBaseType</span><span class="op">(</span><span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Historical&nbsp;aside:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;arrays,&nbsp;maps,&nbsp;and&nbsp;slices,&nbsp;we&nbsp;set&nbsp;the&nbsp;type&nbsp;id&nbsp;after&nbsp;the&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;are&nbsp;constructed.&nbsp;This&nbsp;is&nbsp;to&nbsp;retain&nbsp;the&nbsp;order&nbsp;of&nbsp;type&nbsp;id&nbsp;allocation&nbsp;after</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;a&nbsp;fix&nbsp;made&nbsp;to&nbsp;handle&nbsp;recursive&nbsp;types,&nbsp;which&nbsp;changed&nbsp;the&nbsp;order&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;which&nbsp;types&nbsp;are&nbsp;built.&nbsp;&nbsp;Delaying&nbsp;the&nbsp;setting&nbsp;in&nbsp;this&nbsp;way&nbsp;preserves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;type&nbsp;ids&nbsp;while&nbsp;allowing&nbsp;recursive&nbsp;types&nbsp;to&nbsp;be&nbsp;described.&nbsp;Structs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;done&nbsp;below,&nbsp;were&nbsp;already&nbsp;handling&nbsp;recursion&nbsp;correctly&nbsp;so&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;assign&nbsp;the&nbsp;top-level&nbsp;id&nbsp;before&nbsp;those&nbsp;of&nbsp;the&nbsp;field.</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">at</span><span class="op">.</span><span class="ident">init</span><span class="op">(</span><span class="ident">type0</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">at</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Map</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newMapType</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">types</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">type0</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">getBaseType</span><span class="op">(</span><span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Key</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">type1</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">getBaseType</span><span class="op">(</span><span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mt</span><span class="op">.</span><span class="ident">init</span><span class="op">(</span><span class="ident">type0</span><span class="op">,</span>&nbsp;<span class="ident">type1</span><span class="op">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">mt</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Slice</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;[]byte&nbsp;==&nbsp;[]uint8&nbsp;is&nbsp;a&nbsp;special&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">tBytes</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">st</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newSliceType</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">types</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">st</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">type0</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">getBaseType</span><span class="op">(</span><span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Name</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">st</span><span class="op">.</span><span class="ident">init</span><span class="op">(</span><span class="ident">type0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">st</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Struct</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">st</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newStructType</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">types</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">st</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">idToType</span><span class="op">[</span><span class="ident">st</span><span class="op">.</span><span class="ident">id</span><span class="op">(</span><span class="op">)</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">st</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">NumField</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Field</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">isSent</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">f</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span><span class="op">.</span><span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tname</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Name</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tname</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span><span class="op">.</span><span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tname</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gt</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getBaseType</span><span class="op">(</span><span class="ident">tname</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Some&nbsp;mutually&nbsp;recursive&nbsp;types&nbsp;can&nbsp;cause&nbsp;us&nbsp;to&nbsp;be&nbsp;here&nbsp;while</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;still&nbsp;defining&nbsp;the&nbsp;element.&nbsp;Fix&nbsp;the&nbsp;element&nbsp;type&nbsp;id&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;could&nbsp;do&nbsp;this&nbsp;more&nbsp;neatly&nbsp;by&nbsp;setting&nbsp;the&nbsp;id&nbsp;at&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;building&nbsp;every&nbsp;type,&nbsp;but&nbsp;that&nbsp;would&nbsp;break&nbsp;binary&nbsp;compatibility.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">gt</span><span class="op">.</span><span class="ident">id</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">setTypeId</span><span class="op">(</span><span class="ident">gt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">st</span><span class="op">.</span><span class="ident">Field</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">st</span><span class="op">.</span><span class="ident">Field</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">fieldType</span><span class="op">{</span><span class="ident">f</span><span class="op">.</span><span class="ident">Name</span><span class="op">,</span>&nbsp;<span class="ident">gt</span><span class="op">.</span><span class="ident">id</span><span class="op">(</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">st</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;gob&nbsp;NewTypeObject&nbsp;can&#39;t&nbsp;handle&nbsp;type:&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;isExported&nbsp;reports&nbsp;whether&nbsp;this&nbsp;is&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">isExported</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype">rune</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">utf8</span><span class="op">.</span><span class="ident">DecodeRuneInString</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">unicode</span><span class="op">.</span><span class="ident">IsUpper</span><span class="op">(</span><span class="builtintype">rune</span><span class="op">)</span><br>
<span class="lineno">570</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;isSent&nbsp;reports&nbsp;whether&nbsp;this&nbsp;struct&nbsp;field&nbsp;is&nbsp;to&nbsp;be&nbsp;transmitted.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;will&nbsp;be&nbsp;transmitted&nbsp;only&nbsp;if&nbsp;it&nbsp;is&nbsp;exported&nbsp;and&nbsp;not&nbsp;a&nbsp;chan&nbsp;or&nbsp;func&nbsp;field</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;or&nbsp;pointer&nbsp;to&nbsp;chan&nbsp;or&nbsp;func.</span><br>
<span class="lineno">575</span><span class="keyword">func</span>&nbsp;<span class="ident">isSent</span><span class="op">(</span><span class="ident">field</span>&nbsp;<span class="op">*</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">StructField</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">isExported</span><span class="op">(</span><span class="ident">field</span><span class="op">.</span><span class="ident">Name</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;the&nbsp;field&nbsp;is&nbsp;a&nbsp;chan&nbsp;or&nbsp;func&nbsp;or&nbsp;pointer&nbsp;thereto,&nbsp;don&#39;t&nbsp;send&nbsp;it.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;That&nbsp;is,&nbsp;treat&nbsp;it&nbsp;like&nbsp;an&nbsp;unexported&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">field</span><span class="op">.</span><span class="ident">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Chan</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Func</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;getBaseType&nbsp;returns&nbsp;the&nbsp;Gob&nbsp;type&nbsp;describing&nbsp;the&nbsp;given&nbsp;reflect.Type&#39;s&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;typeLock&nbsp;must&nbsp;be&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">getBaseType</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">rt</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">gobType</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">getType</span><span class="op">(</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;getType&nbsp;returns&nbsp;the&nbsp;Gob&nbsp;type&nbsp;describing&nbsp;the&nbsp;given&nbsp;reflect.Type.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Should&nbsp;be&nbsp;called&nbsp;only&nbsp;when&nbsp;handling&nbsp;GobEncoders/Decoders,</span><br>
<span class="lineno">600</span><span class="comment">//&nbsp;which&nbsp;may&nbsp;be&nbsp;pointers.&nbsp;&nbsp;All&nbsp;other&nbsp;types&nbsp;are&nbsp;handled&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;base&nbsp;type,&nbsp;never&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;typeLock&nbsp;must&nbsp;be&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">getType</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">,</span>&nbsp;<span class="ident">rt</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">gobType</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="ident">present</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">types</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">present</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">newTypeObject</span><span class="op">(</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">types</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">typ</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword">func</span>&nbsp;<span class="ident">checkId</span><span class="op">(</span><span class="ident">want</span><span class="op">,</span>&nbsp;<span class="ident">got</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">want</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">got</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Fprintf</span><span class="op">(</span><span class="ident">os</span><span class="op">.</span><span class="ident">Stderr</span><span class="op">,</span>&nbsp;<span class="string">&#34;checkId:&nbsp;%d&nbsp;should&nbsp;be&nbsp;%d\n&#34;</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">got</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">want</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;bootstrap&nbsp;type&nbsp;wrong&nbsp;id:&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">got</span><span class="op">.</span><span class="ident">name</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">got</span><span class="op">.</span><span class="builtintype">string</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;&nbsp;not&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">want</span><span class="op">.</span><span class="builtintype">string</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">620</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;used&nbsp;for&nbsp;building&nbsp;the&nbsp;basic&nbsp;types;&nbsp;called&nbsp;only&nbsp;from&nbsp;init().&nbsp;&nbsp;the&nbsp;incoming</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;interface&nbsp;always&nbsp;refers&nbsp;to&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">bootstrapType</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">expect</span>&nbsp;<span class="ident">typeId</span><span class="op">)</span>&nbsp;<span class="ident">typeId</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">e</span><span class="op">)</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">present</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">types</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">present</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;bootstrap&nbsp;type&nbsp;already&nbsp;present:&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">CommonType</span><span class="op">{</span><span class="ident">Name</span><span class="op">:</span>&nbsp;<span class="ident">name</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">types</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">setTypeId</span><span class="op">(</span><span class="ident">typ</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkId</span><span class="op">(</span><span class="ident">expect</span><span class="op">,</span>&nbsp;<span class="ident">nextId</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">userType</span><span class="op">(</span><span class="ident">rt</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;might&nbsp;as&nbsp;well&nbsp;cache&nbsp;it&nbsp;now</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nextId</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Representation&nbsp;of&nbsp;the&nbsp;information&nbsp;we&nbsp;send&nbsp;and&nbsp;receive&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Each&nbsp;value&nbsp;we&nbsp;send&nbsp;is&nbsp;preceded&nbsp;by&nbsp;its&nbsp;type&nbsp;definition:&nbsp;an&nbsp;encoded&nbsp;int.</span><br>
<span class="lineno">640</span><span class="comment">//&nbsp;However,&nbsp;the&nbsp;very&nbsp;first&nbsp;time&nbsp;we&nbsp;send&nbsp;the&nbsp;value,&nbsp;we&nbsp;first&nbsp;send&nbsp;the&nbsp;pair</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;(-id,&nbsp;wireType).</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;For&nbsp;bootstrapping&nbsp;purposes,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;recipient&nbsp;knows&nbsp;how</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;decode&nbsp;a&nbsp;wireType;&nbsp;it&nbsp;is&nbsp;exactly&nbsp;the&nbsp;wireType&nbsp;struct&nbsp;here,&nbsp;interpreted</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;using&nbsp;the&nbsp;gob&nbsp;rules&nbsp;for&nbsp;sending&nbsp;a&nbsp;structure,&nbsp;except&nbsp;that&nbsp;we&nbsp;assume&nbsp;the</span><br>
<span class="lineno">645</span><span class="comment">//&nbsp;ids&nbsp;for&nbsp;wireType&nbsp;and&nbsp;structType&nbsp;etc.&nbsp;are&nbsp;known.&nbsp;&nbsp;The&nbsp;relevant&nbsp;pieces</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;are&nbsp;built&nbsp;in&nbsp;encode.go&#39;s&nbsp;init()&nbsp;function.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;To&nbsp;maintain&nbsp;binary&nbsp;compatibility,&nbsp;if&nbsp;you&nbsp;extend&nbsp;this&nbsp;type,&nbsp;always&nbsp;put</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;new&nbsp;fields&nbsp;last.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">wireType</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ArrayT</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">arrayType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">SliceT</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">sliceType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">StructT</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">structType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">MapT</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">mapType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">GobEncoderT</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">gobEncoderType</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">BinaryMarshalerT</span>&nbsp;<span class="op">*</span><span class="ident">gobEncoderType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">TextMarshalerT</span>&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">gobEncoderType</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">w</span>&nbsp;<span class="op">*</span><span class="ident">wireType</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">unknown</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;unknown&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">w</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">unknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">ArrayT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">ArrayT</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">SliceT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">SliceT</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">StructT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">StructT</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">MapT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">MapT</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">GobEncoderT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">GobEncoderT</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">BinaryMarshalerT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">BinaryMarshalerT</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">TextMarshalerT</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">w</span><span class="op">.</span><span class="ident">TextMarshalerT</span><span class="op">.</span><span class="ident">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">unknown</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">typeInfo</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">typeId</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">encInit</span>&nbsp;<span class="ident">sync</span><span class="op">.</span><span class="ident">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;protects&nbsp;creation&nbsp;of&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">encoder</span>&nbsp;<span class="ident">atomic</span><span class="op">.</span><span class="ident">Value</span>&nbsp;<span class="comment">//&nbsp;*encEngine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wire</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">wireType</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span><span class="comment">//&nbsp;typeInfoMap&nbsp;is&nbsp;an&nbsp;atomic&nbsp;pointer&nbsp;to&nbsp;map[reflect.Type]*typeInfo.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&#39;s&nbsp;updated&nbsp;copy-on-write.&nbsp;Readers&nbsp;just&nbsp;do&nbsp;an&nbsp;atomic&nbsp;load</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;get&nbsp;the&nbsp;current&nbsp;version&nbsp;of&nbsp;the&nbsp;map.&nbsp;Writers&nbsp;make&nbsp;a&nbsp;full&nbsp;copy&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;map&nbsp;and&nbsp;atomically&nbsp;update&nbsp;the&nbsp;pointer&nbsp;to&nbsp;point&nbsp;to&nbsp;the&nbsp;new&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Under&nbsp;heavy&nbsp;read&nbsp;contention,&nbsp;this&nbsp;is&nbsp;significantly&nbsp;faster&nbsp;than&nbsp;a&nbsp;map</span><br>
<span class="lineno">695</span><span class="comment">//&nbsp;protected&nbsp;by&nbsp;a&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">typeInfoMap</span>&nbsp;<span class="ident">atomic</span><span class="op">.</span><span class="ident">Value</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">lookupTypeInfo</span><span class="op">(</span><span class="ident">rt</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">typeInfo</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">typeInfoMap</span><span class="op">.</span><span class="ident">Load</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="op">*</span><span class="ident">typeInfo</span><span class="op">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">m</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">getTypeInfo</span><span class="op">(</span><span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">typeInfo</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;want&nbsp;the&nbsp;user&nbsp;type,&nbsp;not&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">info</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">lookupTypeInfo</span><span class="op">(</span><span class="ident">rt</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">info</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">info</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">buildTypeInfo</span><span class="op">(</span><span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">715</span><span class="comment">//&nbsp;buildTypeInfo&nbsp;constructs&nbsp;the&nbsp;type&nbsp;information&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;and&nbsp;stores&nbsp;it&nbsp;in&nbsp;the&nbsp;type&nbsp;info&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">buildTypeInfo</span><span class="op">(</span><span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">,</span>&nbsp;<span class="ident">rt</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">typeInfo</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeLock</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">typeLock</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">info</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">lookupTypeInfo</span><span class="op">(</span><span class="ident">rt</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">info</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">info</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gt</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getBaseType</span><span class="op">(</span><span class="ident">rt</span><span class="op">.</span><span class="ident">Name</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">typeInfo</span><span class="op">{</span><span class="ident">id</span><span class="op">:</span>&nbsp;<span class="ident">gt</span><span class="op">.</span><span class="ident">id</span><span class="op">(</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno">730</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">userType</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getType</span><span class="op">(</span><span class="ident">rt</span><span class="op">.</span><span class="ident">Name</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">gt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">.</span><span class="ident">id</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">gobEncoderType</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">xGob</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span><span class="op">.</span><span class="ident">wire</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">wireType</span><span class="op">{</span><span class="ident">GobEncoderT</span><span class="op">:</span>&nbsp;<span class="ident">gt</span><span class="op">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">xBinary</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span><span class="op">.</span><span class="ident">wire</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">wireType</span><span class="op">{</span><span class="ident">BinaryMarshalerT</span><span class="op">:</span>&nbsp;<span class="ident">gt</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">xText</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span><span class="op">.</span><span class="ident">wire</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">wireType</span><span class="op">{</span><span class="ident">TextMarshalerT</span><span class="op">:</span>&nbsp;<span class="ident">gt</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">info</span><span class="op">.</span><span class="ident">id</span><span class="op">.</span><span class="ident">gobType</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">typ</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">rt</span><span class="op">;</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Array</span><span class="op">:</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span><span class="op">.</span><span class="ident">wire</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">wireType</span><span class="op">{</span><span class="ident">ArrayT</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">arrayType</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Map</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span><span class="op">.</span><span class="ident">wire</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">wireType</span><span class="op">{</span><span class="ident">MapT</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">mapType</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Slice</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;[]byte&nbsp;==&nbsp;[]uint8&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;handled&nbsp;separately</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span><span class="op">.</span><span class="ident">wire</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">wireType</span><span class="op">{</span><span class="ident">SliceT</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">sliceType</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Struct</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span><span class="op">.</span><span class="ident">wire</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">wireType</span><span class="op">{</span><span class="ident">StructT</span><span class="op">:</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">structType</span><span class="op">)</span><span class="op">}</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Create&nbsp;new&nbsp;map&nbsp;with&nbsp;old&nbsp;contents&nbsp;plus&nbsp;new&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">newm</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="op">*</span><span class="ident">typeInfo</span><span class="op">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">typeInfoMap</span><span class="op">.</span><span class="ident">Load</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="op">*</span><span class="ident">typeInfo</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">k</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">newm</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">newm</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">info</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typeInfoMap</span><span class="op">.</span><span class="ident">Store</span><span class="op">(</span><span class="ident">newm</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">info</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Called&nbsp;only&nbsp;when&nbsp;a&nbsp;panic&nbsp;is&nbsp;acceptable&nbsp;and&nbsp;unexpected.</span><br>
<span class="lineno">775</span><span class="keyword">func</span>&nbsp;<span class="ident">mustGetTypeInfo</span><span class="op">(</span><span class="ident">rt</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">typeInfo</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getTypeInfo</span><span class="op">(</span><span class="ident">userType</span><span class="op">(</span><span class="ident">rt</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;getTypeInfo:&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">err</span><span class="op">.</span><span class="ident">Error</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">t</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GobEncoder&nbsp;is&nbsp;the&nbsp;interface&nbsp;describing&nbsp;data&nbsp;that&nbsp;provides&nbsp;its&nbsp;own</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;representation&nbsp;for&nbsp;encoding&nbsp;values&nbsp;for&nbsp;transmission&nbsp;to&nbsp;a&nbsp;GobDecoder.</span><br>
<span class="lineno">785</span><span class="comment">//&nbsp;A&nbsp;type&nbsp;that&nbsp;implements&nbsp;GobEncoder&nbsp;and&nbsp;GobDecoder&nbsp;has&nbsp;complete</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;control&nbsp;over&nbsp;the&nbsp;representation&nbsp;of&nbsp;its&nbsp;data&nbsp;and&nbsp;may&nbsp;therefore</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;contain&nbsp;things&nbsp;such&nbsp;as&nbsp;private&nbsp;fields,&nbsp;channels,&nbsp;and&nbsp;functions,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;which&nbsp;are&nbsp;not&nbsp;usually&nbsp;transmissible&nbsp;in&nbsp;gob&nbsp;streams.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">790</span><span class="comment">//&nbsp;Note:&nbsp;Since&nbsp;gobs&nbsp;can&nbsp;be&nbsp;stored&nbsp;permanently,&nbsp;It&nbsp;is&nbsp;good&nbsp;design</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;guarantee&nbsp;the&nbsp;encoding&nbsp;used&nbsp;by&nbsp;a&nbsp;GobEncoder&nbsp;is&nbsp;stable&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;software&nbsp;evolves.&nbsp;&nbsp;For&nbsp;instance,&nbsp;it&nbsp;might&nbsp;make&nbsp;sense&nbsp;for&nbsp;GobEncode</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;include&nbsp;a&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">GobEncoder</span>&nbsp;<span class="keyword">interface</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;GobEncode&nbsp;returns&nbsp;a&nbsp;byte&nbsp;slice&nbsp;representing&nbsp;the&nbsp;encoding&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;receiver&nbsp;for&nbsp;transmission&nbsp;to&nbsp;a&nbsp;GobDecoder,&nbsp;usually&nbsp;of&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">GobEncode</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GobDecoder&nbsp;is&nbsp;the&nbsp;interface&nbsp;describing&nbsp;data&nbsp;that&nbsp;provides&nbsp;its&nbsp;own</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;routine&nbsp;for&nbsp;decoding&nbsp;transmitted&nbsp;values&nbsp;sent&nbsp;by&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">GobDecoder</span>&nbsp;<span class="keyword">interface</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;GobDecode&nbsp;overwrites&nbsp;the&nbsp;receiver,&nbsp;which&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer,</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;with&nbsp;the&nbsp;value&nbsp;represented&nbsp;by&nbsp;the&nbsp;byte&nbsp;slice,&nbsp;which&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;by&nbsp;GobEncode,&nbsp;usually&nbsp;for&nbsp;the&nbsp;same&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">GobDecode</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span><span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">registerLock</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">sync</span><span class="op">.</span><span class="ident">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nameToConcreteType</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="builtintype">string</span><span class="op">]</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">concreteTypeToName</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="builtintype">string</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno">815</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;rather&nbsp;than&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;type&#39;s&nbsp;default.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">RegisterName</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;reserved&nbsp;for&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;attempt&nbsp;to&nbsp;register&nbsp;empty&nbsp;name&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">registerLock</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">registerLock</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">value</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Check&nbsp;for&nbsp;incompatible&nbsp;duplicates.&nbsp;The&nbsp;name&nbsp;must&nbsp;refer&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;same&nbsp;user&nbsp;type,&nbsp;and&nbsp;vice&nbsp;versa.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">nameToConcreteType</span><span class="op">[</span><span class="ident">name</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">user</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;gob:&nbsp;registering&nbsp;duplicate&nbsp;types&nbsp;for&nbsp;%q:&nbsp;%s&nbsp;!=&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">concreteTypeToName</span><span class="op">[</span><span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">name</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;gob:&nbsp;registering&nbsp;duplicate&nbsp;names&nbsp;for&nbsp;%s:&nbsp;%q&nbsp;!=&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">name</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Store&nbsp;the&nbsp;name&nbsp;and&nbsp;type&nbsp;provided&nbsp;by&nbsp;the&nbsp;user....</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nameToConcreteType</span><span class="op">[</span><span class="ident">name</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;but&nbsp;the&nbsp;flattened&nbsp;type&nbsp;in&nbsp;the&nbsp;type&nbsp;table,&nbsp;since&nbsp;that&#39;s&nbsp;what&nbsp;decode&nbsp;needs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">concreteTypeToName</span><span class="op">[</span><span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">name</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">840</span><span class="comment">//&nbsp;Register&nbsp;records&nbsp;a&nbsp;type,&nbsp;identified&nbsp;by&nbsp;a&nbsp;value&nbsp;for&nbsp;that&nbsp;type,&nbsp;under&nbsp;its</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;internal&nbsp;type&nbsp;name.&nbsp;&nbsp;That&nbsp;name&nbsp;will&nbsp;identify&nbsp;the&nbsp;concrete&nbsp;type&nbsp;of&nbsp;a&nbsp;value</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;sent&nbsp;or&nbsp;received&nbsp;as&nbsp;an&nbsp;interface&nbsp;variable.&nbsp;&nbsp;Only&nbsp;types&nbsp;that&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;transferred&nbsp;as&nbsp;implementations&nbsp;of&nbsp;interface&nbsp;values&nbsp;need&nbsp;to&nbsp;be&nbsp;registered.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Expecting&nbsp;to&nbsp;be&nbsp;used&nbsp;only&nbsp;during&nbsp;initialization,&nbsp;it&nbsp;panics&nbsp;if&nbsp;the&nbsp;mapping</span><br>
<span class="lineno">845</span><span class="comment">//&nbsp;between&nbsp;types&nbsp;and&nbsp;names&nbsp;is&nbsp;not&nbsp;a&nbsp;bijection.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">Register</span><span class="op">(</span><span class="ident">value</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Default&nbsp;to&nbsp;printed&nbsp;representation&nbsp;for&nbsp;unnamed&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">TypeOf</span><span class="op">(</span><span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">850</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;But&nbsp;for&nbsp;named&nbsp;types&nbsp;(or&nbsp;pointers&nbsp;to&nbsp;them),&nbsp;qualify&nbsp;with&nbsp;import&nbsp;path&nbsp;(but&nbsp;see&nbsp;inner&nbsp;comment).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Dereference&nbsp;one&nbsp;pointer&nbsp;looking&nbsp;for&nbsp;a&nbsp;named&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">star</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">Name</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">pt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">rt</span><span class="op">;</span>&nbsp;<span class="ident">pt</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">star</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;*&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;NOTE:&nbsp;The&nbsp;following&nbsp;line&nbsp;should&nbsp;be&nbsp;rt&nbsp;=&nbsp;pt.Elem()&nbsp;to&nbsp;implement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;what&nbsp;the&nbsp;comment&nbsp;above&nbsp;claims,&nbsp;but&nbsp;fixing&nbsp;it&nbsp;would&nbsp;break&nbsp;compatibility</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;with&nbsp;existing&nbsp;gobs.</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Given&nbsp;package&nbsp;p&nbsp;imported&nbsp;as&nbsp;&#34;full/p&#34;&nbsp;with&nbsp;these&nbsp;definitions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;T1&nbsp;struct&nbsp;{&nbsp;...&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;this&nbsp;table&nbsp;shows&nbsp;the&nbsp;intended&nbsp;and&nbsp;actual&nbsp;strings&nbsp;used&nbsp;by&nbsp;gob&nbsp;to</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;name&nbsp;the&nbsp;types:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Correct&nbsp;string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Actual&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;T1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;full/p.T1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;full/p.T1</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;*T1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*full/p.T1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*p.T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;missing&nbsp;full&nbsp;path&nbsp;cannot&nbsp;be&nbsp;fixed&nbsp;without&nbsp;breaking&nbsp;existing&nbsp;gob&nbsp;decoders.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">pt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">Name</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">PkgPath</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">star</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">Name</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">star</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">PkgPath</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;.&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">Name</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">RegisterName</span><span class="op">(</span><span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span><br>
<span class="lineno">885</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">registerBasics</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">int</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">int8</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">int16</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">int32</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="ident">int64</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">uint</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">uint8</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">uint16</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">uint32</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">float32</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">float64</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">complex64</span><span class="op">(</span><span class="num">0i</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">complex128</span><span class="op">(</span><span class="num">0i</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="ident">false</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="string">&#34;&#34;</span><span class="op">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">int</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">int8</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">int16</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">int32</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">int64</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint8</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint16</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uint32</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">uint64</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">float32</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">float64</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">complex64</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">complex128</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">uintptr</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Register</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
