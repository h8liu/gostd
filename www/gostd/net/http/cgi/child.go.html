<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html" class="current">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5505304">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5505359">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5505413">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5505464">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="5505524">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5505537">package</span>&nbsp;<span class="ident" id="5505545">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="5505550">import</span>&nbsp;<span class="op" id="5505557">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505560">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505569">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505583">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505593">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505600">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505606">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505619">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505626">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505638">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505649">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505655">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5505666">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5505676">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5505679">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="5505745">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="5505807">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="5505848">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="5505908">func</span>&nbsp;<span class="ident" id="5505913">Request</span><span class="op" id="5505920">(</span><span class="op" id="5505921">)</span>&nbsp;<span class="op" id="5505923">(</span><span class="op" id="5505924">*</span><span class="ident" id="5505925">http</span><span class="op" id="5505929">.</span><span class="ident" id="5505930">Request</span><span class="op" id="5505937">,</span>&nbsp;<span class="builtintype" id="5505939">error</span><span class="op" id="5505944">)</span>&nbsp;<span class="op" id="5505946">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5505949">r</span><span class="op" id="5505950">,</span>&nbsp;<span class="ident" id="5505952">err</span>&nbsp;<span class="op" id="5505956">:=</span>&nbsp;<span class="ident" id="5505959">RequestFromMap</span><span class="op" id="5505973">(</span><span class="ident" id="5505974">envMap</span><span class="op" id="5505980">(</span><span class="ident" id="5505981">os</span><span class="op" id="5505983">.</span><span class="ident" id="5505984">Environ</span><span class="op" id="5505991">(</span><span class="op" id="5505992">)</span><span class="op" id="5505993">)</span><span class="op" id="5505994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5505997">if</span>&nbsp;<span class="ident" id="5506000">err</span>&nbsp;<span class="op" id="5506004">!=</span>&nbsp;<span class="builtintype" id="5506007">nil</span>&nbsp;<span class="op" id="5506011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506015">return</span>&nbsp;<span class="builtintype" id="5506022">nil</span><span class="op" id="5506025">,</span>&nbsp;<span class="ident" id="5506027">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506035">if</span>&nbsp;<span class="ident" id="5506038">r</span><span class="op" id="5506039">.</span><span class="ident" id="5506040">ContentLength</span>&nbsp;<span class="op" id="5506054">&gt;</span>&nbsp;<span class="num" id="5506056">0</span>&nbsp;<span class="op" id="5506058">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506062">r</span><span class="op" id="5506063">.</span><span class="ident" id="5506064">Body</span>&nbsp;<span class="op" id="5506069">=</span>&nbsp;<span class="ident" id="5506071">ioutil</span><span class="op" id="5506077">.</span><span class="ident" id="5506078">NopCloser</span><span class="op" id="5506087">(</span><span class="ident" id="5506088">io</span><span class="op" id="5506090">.</span><span class="ident" id="5506091">LimitReader</span><span class="op" id="5506102">(</span><span class="ident" id="5506103">os</span><span class="op" id="5506105">.</span><span class="ident" id="5506106">Stdin</span><span class="op" id="5506111">,</span>&nbsp;<span class="ident" id="5506113">r</span><span class="op" id="5506114">.</span><span class="ident" id="5506115">ContentLength</span><span class="op" id="5506128">)</span><span class="op" id="5506129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506135">return</span>&nbsp;<span class="ident" id="5506142">r</span><span class="op" id="5506143">,</span>&nbsp;<span class="builtintype" id="5506145">nil</span><br>
<span class="lineno"></span><span class="op" id="5506149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="5506152">func</span>&nbsp;<span class="ident" id="5506157">envMap</span><span class="op" id="5506163">(</span><span class="ident" id="5506164">env</span>&nbsp;<span class="op" id="5506168">[</span><span class="op" id="5506169">]</span><span class="builtintype" id="5506170">string</span><span class="op" id="5506176">)</span>&nbsp;<span class="keyword" id="5506178">map</span><span class="op" id="5506181">[</span><span class="builtintype" id="5506182">string</span><span class="op" id="5506188">]</span><span class="builtintype" id="5506189">string</span>&nbsp;<span class="op" id="5506196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506199">m</span>&nbsp;<span class="op" id="5506201">:=</span>&nbsp;<span class="builtinfunc" id="5506204">make</span><span class="op" id="5506208">(</span><span class="keyword" id="5506209">map</span><span class="op" id="5506212">[</span><span class="builtintype" id="5506213">string</span><span class="op" id="5506219">]</span><span class="builtintype" id="5506220">string</span><span class="op" id="5506226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506229">for</span>&nbsp;<span class="ident" id="5506233">_</span><span class="op" id="5506234">,</span>&nbsp;<span class="ident" id="5506236">kv</span>&nbsp;<span class="op" id="5506239">:=</span>&nbsp;<span class="keyword" id="5506242">range</span>&nbsp;<span class="ident" id="5506248">env</span>&nbsp;<span class="op" id="5506252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506256">if</span>&nbsp;<span class="ident" id="5506259">idx</span>&nbsp;<span class="op" id="5506263">:=</span>&nbsp;<span class="ident" id="5506266">strings</span><span class="op" id="5506273">.</span><span class="ident" id="5506274">Index</span><span class="op" id="5506279">(</span><span class="ident" id="5506280">kv</span><span class="op" id="5506282">,</span>&nbsp;<span class="string" id="5506284">&#34;=&#34;</span><span class="op" id="5506287">)</span><span class="op" id="5506288">;</span>&nbsp;<span class="ident" id="5506290">idx</span>&nbsp;<span class="op" id="5506294">!=</span>&nbsp;<span class="op" id="5506297">-</span><span class="num" id="5506298">1</span>&nbsp;<span class="op" id="5506300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506305">m</span><span class="op" id="5506306">[</span><span class="ident" id="5506307">kv</span><span class="op" id="5506309">[</span><span class="op" id="5506310">:</span><span class="ident" id="5506311">idx</span><span class="op" id="5506314">]</span><span class="op" id="5506315">]</span>&nbsp;<span class="op" id="5506317">=</span>&nbsp;<span class="ident" id="5506319">kv</span><span class="op" id="5506321">[</span><span class="ident" id="5506322">idx</span><span class="op" id="5506325">+</span><span class="num" id="5506326">1</span><span class="op" id="5506327">:</span><span class="op" id="5506328">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506338">return</span>&nbsp;<span class="ident" id="5506345">m</span><br>
<span class="lineno"></span><span class="op" id="5506347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5506350">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="5506412">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="5506467">func</span>&nbsp;<span class="ident" id="5506472">RequestFromMap</span><span class="op" id="5506486">(</span><span class="ident" id="5506487">params</span>&nbsp;<span class="keyword" id="5506494">map</span><span class="op" id="5506497">[</span><span class="builtintype" id="5506498">string</span><span class="op" id="5506504">]</span><span class="builtintype" id="5506505">string</span><span class="op" id="5506511">)</span>&nbsp;<span class="op" id="5506513">(</span><span class="op" id="5506514">*</span><span class="ident" id="5506515">http</span><span class="op" id="5506519">.</span><span class="ident" id="5506520">Request</span><span class="op" id="5506527">,</span>&nbsp;<span class="builtintype" id="5506529">error</span><span class="op" id="5506534">)</span>&nbsp;<span class="op" id="5506536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506539">r</span>&nbsp;<span class="op" id="5506541">:=</span>&nbsp;<span class="builtinfunc" id="5506544">new</span><span class="op" id="5506547">(</span><span class="ident" id="5506548">http</span><span class="op" id="5506552">.</span><span class="ident" id="5506553">Request</span><span class="op" id="5506560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506563">r</span><span class="op" id="5506564">.</span><span class="ident" id="5506565">Method</span>&nbsp;<span class="op" id="5506572">=</span>&nbsp;<span class="ident" id="5506574">params</span><span class="op" id="5506580">[</span><span class="string" id="5506581">&#34;REQUEST_METHOD&#34;</span><span class="op" id="5506597">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506600">if</span>&nbsp;<span class="ident" id="5506603">r</span><span class="op" id="5506604">.</span><span class="ident" id="5506605">Method</span>&nbsp;<span class="op" id="5506612">==</span>&nbsp;<span class="string" id="5506615">&#34;&#34;</span>&nbsp;<span class="op" id="5506618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506622">return</span>&nbsp;<span class="builtintype" id="5506629">nil</span><span class="op" id="5506632">,</span>&nbsp;<span class="ident" id="5506634">errors</span><span class="op" id="5506640">.</span><span class="ident" id="5506641">New</span><span class="op" id="5506644">(</span><span class="string" id="5506645">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="5506684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506691">r</span><span class="op" id="5506692">.</span><span class="ident" id="5506693">Proto</span>&nbsp;<span class="op" id="5506699">=</span>&nbsp;<span class="ident" id="5506701">params</span><span class="op" id="5506707">[</span><span class="string" id="5506708">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="5506725">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506728">var</span>&nbsp;<span class="ident" id="5506732">ok</span>&nbsp;<span class="builtintype" id="5506735">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506741">r</span><span class="op" id="5506742">.</span><span class="ident" id="5506743">ProtoMajor</span><span class="op" id="5506753">,</span>&nbsp;<span class="ident" id="5506755">r</span><span class="op" id="5506756">.</span><span class="ident" id="5506757">ProtoMinor</span><span class="op" id="5506767">,</span>&nbsp;<span class="ident" id="5506769">ok</span>&nbsp;<span class="op" id="5506772">=</span>&nbsp;<span class="ident" id="5506774">http</span><span class="op" id="5506778">.</span><span class="ident" id="5506779">ParseHTTPVersion</span><span class="op" id="5506795">(</span><span class="ident" id="5506796">r</span><span class="op" id="5506797">.</span><span class="ident" id="5506798">Proto</span><span class="op" id="5506803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506806">if</span>&nbsp;<span class="op" id="5506809">!</span><span class="ident" id="5506810">ok</span>&nbsp;<span class="op" id="5506813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506817">return</span>&nbsp;<span class="builtintype" id="5506824">nil</span><span class="op" id="5506827">,</span>&nbsp;<span class="ident" id="5506829">errors</span><span class="op" id="5506835">.</span><span class="ident" id="5506836">New</span><span class="op" id="5506839">(</span><span class="string" id="5506840">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="5506878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506881">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506885">r</span><span class="op" id="5506886">.</span><span class="ident" id="5506887">Close</span>&nbsp;<span class="op" id="5506893">=</span>&nbsp;<span class="builtintype" id="5506895">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506901">r</span><span class="op" id="5506902">.</span><span class="ident" id="5506903">Trailer</span>&nbsp;<span class="op" id="5506911">=</span>&nbsp;<span class="ident" id="5506913">http</span><span class="op" id="5506917">.</span><span class="ident" id="5506918">Header</span><span class="op" id="5506924">{</span><span class="op" id="5506925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506928">r</span><span class="op" id="5506929">.</span><span class="ident" id="5506930">Header</span>&nbsp;<span class="op" id="5506937">=</span>&nbsp;<span class="ident" id="5506939">http</span><span class="op" id="5506943">.</span><span class="ident" id="5506944">Header</span><span class="op" id="5506950">{</span><span class="op" id="5506951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506955">r</span><span class="op" id="5506956">.</span><span class="ident" id="5506957">Host</span>&nbsp;<span class="op" id="5506962">=</span>&nbsp;<span class="ident" id="5506964">params</span><span class="op" id="5506970">[</span><span class="string" id="5506971">&#34;HTTP_HOST&#34;</span><span class="op" id="5506982">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506986">if</span>&nbsp;<span class="ident" id="5506989">lenstr</span>&nbsp;<span class="op" id="5506996">:=</span>&nbsp;<span class="ident" id="5506999">params</span><span class="op" id="5507005">[</span><span class="string" id="5507006">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="5507022">]</span><span class="op" id="5507023">;</span>&nbsp;<span class="ident" id="5507025">lenstr</span>&nbsp;<span class="op" id="5507032">!=</span>&nbsp;<span class="string" id="5507035">&#34;&#34;</span>&nbsp;<span class="op" id="5507038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507042">clen</span><span class="op" id="5507046">,</span>&nbsp;<span class="ident" id="5507048">err</span>&nbsp;<span class="op" id="5507052">:=</span>&nbsp;<span class="ident" id="5507055">strconv</span><span class="op" id="5507062">.</span><span class="ident" id="5507063">ParseInt</span><span class="op" id="5507071">(</span><span class="ident" id="5507072">lenstr</span><span class="op" id="5507078">,</span>&nbsp;<span class="num" id="5507080">10</span><span class="op" id="5507082">,</span>&nbsp;<span class="num" id="5507084">64</span><span class="op" id="5507086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507090">if</span>&nbsp;<span class="ident" id="5507093">err</span>&nbsp;<span class="op" id="5507097">!=</span>&nbsp;<span class="builtintype" id="5507100">nil</span>&nbsp;<span class="op" id="5507104">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507109">return</span>&nbsp;<span class="builtintype" id="5507116">nil</span><span class="op" id="5507119">,</span>&nbsp;<span class="ident" id="5507121">errors</span><span class="op" id="5507127">.</span><span class="ident" id="5507128">New</span><span class="op" id="5507131">(</span><span class="string" id="5507132">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="5507175">+</span>&nbsp;<span class="ident" id="5507177">lenstr</span><span class="op" id="5507183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507191">r</span><span class="op" id="5507192">.</span><span class="ident" id="5507193">ContentLength</span>&nbsp;<span class="op" id="5507207">=</span>&nbsp;<span class="ident" id="5507209">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507219">if</span>&nbsp;<span class="ident" id="5507222">ct</span>&nbsp;<span class="op" id="5507225">:=</span>&nbsp;<span class="ident" id="5507228">params</span><span class="op" id="5507234">[</span><span class="string" id="5507235">&#34;CONTENT_TYPE&#34;</span><span class="op" id="5507249">]</span><span class="op" id="5507250">;</span>&nbsp;<span class="ident" id="5507252">ct</span>&nbsp;<span class="op" id="5507255">!=</span>&nbsp;<span class="string" id="5507258">&#34;&#34;</span>&nbsp;<span class="op" id="5507261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507265">r</span><span class="op" id="5507266">.</span><span class="ident" id="5507267">Header</span><span class="op" id="5507273">.</span><span class="ident" id="5507274">Set</span><span class="op" id="5507277">(</span><span class="string" id="5507278">&#34;Content-Type&#34;</span><span class="op" id="5507292">,</span>&nbsp;<span class="ident" id="5507294">ct</span><span class="op" id="5507296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5507303">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507358">for</span>&nbsp;<span class="ident" id="5507362">k</span><span class="op" id="5507363">,</span>&nbsp;<span class="ident" id="5507365">v</span>&nbsp;<span class="op" id="5507367">:=</span>&nbsp;<span class="keyword" id="5507370">range</span>&nbsp;<span class="ident" id="5507376">params</span>&nbsp;<span class="op" id="5507383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507387">if</span>&nbsp;<span class="op" id="5507390">!</span><span class="ident" id="5507391">strings</span><span class="op" id="5507398">.</span><span class="ident" id="5507399">HasPrefix</span><span class="op" id="5507408">(</span><span class="ident" id="5507409">k</span><span class="op" id="5507410">,</span>&nbsp;<span class="string" id="5507412">&#34;HTTP_&#34;</span><span class="op" id="5507419">)</span>&nbsp;<span class="op" id="5507421">||</span>&nbsp;<span class="ident" id="5507424">k</span>&nbsp;<span class="op" id="5507426">==</span>&nbsp;<span class="string" id="5507429">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="5507441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507446">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507461">r</span><span class="op" id="5507462">.</span><span class="ident" id="5507463">Header</span><span class="op" id="5507469">.</span><span class="ident" id="5507470">Add</span><span class="op" id="5507473">(</span><span class="ident" id="5507474">strings</span><span class="op" id="5507481">.</span><span class="ident" id="5507482">Replace</span><span class="op" id="5507489">(</span><span class="ident" id="5507490">k</span><span class="op" id="5507491">[</span><span class="num" id="5507492">5</span><span class="op" id="5507493">:</span><span class="op" id="5507494">]</span><span class="op" id="5507495">,</span>&nbsp;<span class="string" id="5507497">&#34;_&#34;</span><span class="op" id="5507500">,</span>&nbsp;<span class="string" id="5507502">&#34;-&#34;</span><span class="op" id="5507505">,</span>&nbsp;<span class="op" id="5507507">-</span><span class="num" id="5507508">1</span><span class="op" id="5507509">)</span><span class="op" id="5507510">,</span>&nbsp;<span class="ident" id="5507512">v</span><span class="op" id="5507513">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5507520">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507578">uriStr</span>&nbsp;<span class="op" id="5507585">:=</span>&nbsp;<span class="ident" id="5507588">params</span><span class="op" id="5507594">[</span><span class="string" id="5507595">&#34;REQUEST_URI&#34;</span><span class="op" id="5507608">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507611">if</span>&nbsp;<span class="ident" id="5507614">uriStr</span>&nbsp;<span class="op" id="5507621">==</span>&nbsp;<span class="string" id="5507624">&#34;&#34;</span>&nbsp;<span class="op" id="5507627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5507631">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507689">uriStr</span>&nbsp;<span class="op" id="5507696">=</span>&nbsp;<span class="ident" id="5507698">params</span><span class="op" id="5507704">[</span><span class="string" id="5507705">&#34;SCRIPT_NAME&#34;</span><span class="op" id="5507718">]</span>&nbsp;<span class="op" id="5507720">+</span>&nbsp;<span class="ident" id="5507722">params</span><span class="op" id="5507728">[</span><span class="string" id="5507729">&#34;PATH_INFO&#34;</span><span class="op" id="5507740">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507744">s</span>&nbsp;<span class="op" id="5507746">:=</span>&nbsp;<span class="ident" id="5507749">params</span><span class="op" id="5507755">[</span><span class="string" id="5507756">&#34;QUERY_STRING&#34;</span><span class="op" id="5507770">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507774">if</span>&nbsp;<span class="ident" id="5507777">s</span>&nbsp;<span class="op" id="5507779">!=</span>&nbsp;<span class="string" id="5507782">&#34;&#34;</span>&nbsp;<span class="op" id="5507785">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507790">uriStr</span>&nbsp;<span class="op" id="5507797">+=</span>&nbsp;<span class="string" id="5507800">&#34;?&#34;</span>&nbsp;<span class="op" id="5507804">+</span>&nbsp;<span class="ident" id="5507806">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5507817">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5507870">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507937">if</span>&nbsp;<span class="ident" id="5507940">s</span>&nbsp;<span class="op" id="5507942">:=</span>&nbsp;<span class="ident" id="5507945">params</span><span class="op" id="5507951">[</span><span class="string" id="5507952">&#34;HTTPS&#34;</span><span class="op" id="5507959">]</span><span class="op" id="5507960">;</span>&nbsp;<span class="ident" id="5507962">s</span>&nbsp;<span class="op" id="5507964">==</span>&nbsp;<span class="string" id="5507967">&#34;on&#34;</span>&nbsp;<span class="op" id="5507972">||</span>&nbsp;<span class="ident" id="5507975">s</span>&nbsp;<span class="op" id="5507977">==</span>&nbsp;<span class="string" id="5507980">&#34;ON&#34;</span>&nbsp;<span class="op" id="5507985">||</span>&nbsp;<span class="ident" id="5507988">s</span>&nbsp;<span class="op" id="5507990">==</span>&nbsp;<span class="string" id="5507993">&#34;1&#34;</span>&nbsp;<span class="op" id="5507997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508001">r</span><span class="op" id="5508002">.</span><span class="ident" id="5508003">TLS</span>&nbsp;<span class="op" id="5508007">=</span>&nbsp;<span class="op" id="5508009">&amp;</span><span class="ident" id="5508010">tls</span><span class="op" id="5508013">.</span><span class="ident" id="5508014">ConnectionState</span><span class="op" id="5508029">{</span><span class="ident" id="5508030">HandshakeComplete</span><span class="op" id="5508047">:</span>&nbsp;<span class="builtintype" id="5508049">true</span><span class="op" id="5508053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508060">if</span>&nbsp;<span class="ident" id="5508063">r</span><span class="op" id="5508064">.</span><span class="ident" id="5508065">Host</span>&nbsp;<span class="op" id="5508070">!=</span>&nbsp;<span class="string" id="5508073">&#34;&#34;</span>&nbsp;<span class="op" id="5508076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5508080">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508145">rawurl</span>&nbsp;<span class="op" id="5508152">:=</span>&nbsp;<span class="ident" id="5508155">r</span><span class="op" id="5508156">.</span><span class="ident" id="5508157">Host</span>&nbsp;<span class="op" id="5508162">+</span>&nbsp;<span class="ident" id="5508164">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508173">if</span>&nbsp;<span class="ident" id="5508176">r</span><span class="op" id="5508177">.</span><span class="ident" id="5508178">TLS</span>&nbsp;<span class="op" id="5508182">==</span>&nbsp;<span class="builtintype" id="5508185">nil</span>&nbsp;<span class="op" id="5508189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508194">rawurl</span>&nbsp;<span class="op" id="5508201">=</span>&nbsp;<span class="string" id="5508203">&#34;http://&#34;</span>&nbsp;<span class="op" id="5508213">+</span>&nbsp;<span class="ident" id="5508215">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508224">}</span>&nbsp;<span class="keyword" id="5508226">else</span>&nbsp;<span class="op" id="5508231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508236">rawurl</span>&nbsp;<span class="op" id="5508243">=</span>&nbsp;<span class="string" id="5508245">&#34;https://&#34;</span>&nbsp;<span class="op" id="5508256">+</span>&nbsp;<span class="ident" id="5508258">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508271">url</span><span class="op" id="5508274">,</span>&nbsp;<span class="ident" id="5508276">err</span>&nbsp;<span class="op" id="5508280">:=</span>&nbsp;<span class="ident" id="5508283">url</span><span class="op" id="5508286">.</span><span class="ident" id="5508287">Parse</span><span class="op" id="5508292">(</span><span class="ident" id="5508293">rawurl</span><span class="op" id="5508299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508303">if</span>&nbsp;<span class="ident" id="5508306">err</span>&nbsp;<span class="op" id="5508310">!=</span>&nbsp;<span class="builtintype" id="5508313">nil</span>&nbsp;<span class="op" id="5508317">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508322">return</span>&nbsp;<span class="builtintype" id="5508329">nil</span><span class="op" id="5508332">,</span>&nbsp;<span class="ident" id="5508334">errors</span><span class="op" id="5508340">.</span><span class="ident" id="5508341">New</span><span class="op" id="5508344">(</span><span class="string" id="5508345">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5508402">+</span>&nbsp;<span class="ident" id="5508404">rawurl</span><span class="op" id="5508410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508418">r</span><span class="op" id="5508419">.</span><span class="ident" id="5508420">URL</span>&nbsp;<span class="op" id="5508424">=</span>&nbsp;<span class="ident" id="5508426">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5508434">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5508495">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508515">if</span>&nbsp;<span class="ident" id="5508518">r</span><span class="op" id="5508519">.</span><span class="ident" id="5508520">URL</span>&nbsp;<span class="op" id="5508524">==</span>&nbsp;<span class="builtintype" id="5508527">nil</span>&nbsp;<span class="op" id="5508531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508535">url</span><span class="op" id="5508538">,</span>&nbsp;<span class="ident" id="5508540">err</span>&nbsp;<span class="op" id="5508544">:=</span>&nbsp;<span class="ident" id="5508547">url</span><span class="op" id="5508550">.</span><span class="ident" id="5508551">Parse</span><span class="op" id="5508556">(</span><span class="ident" id="5508557">uriStr</span><span class="op" id="5508563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508567">if</span>&nbsp;<span class="ident" id="5508570">err</span>&nbsp;<span class="op" id="5508574">!=</span>&nbsp;<span class="builtintype" id="5508577">nil</span>&nbsp;<span class="op" id="5508581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508586">return</span>&nbsp;<span class="builtintype" id="5508593">nil</span><span class="op" id="5508596">,</span>&nbsp;<span class="ident" id="5508598">errors</span><span class="op" id="5508604">.</span><span class="ident" id="5508605">New</span><span class="op" id="5508608">(</span><span class="string" id="5508609">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="5508657">+</span>&nbsp;<span class="ident" id="5508659">uriStr</span><span class="op" id="5508665">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508673">r</span><span class="op" id="5508674">.</span><span class="ident" id="5508675">URL</span>&nbsp;<span class="op" id="5508679">=</span>&nbsp;<span class="ident" id="5508681">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5508690">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5508752">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5508816">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508837">r</span><span class="op" id="5508838">.</span><span class="ident" id="5508839">RemoteAddr</span>&nbsp;<span class="op" id="5508850">=</span>&nbsp;<span class="ident" id="5508852">net</span><span class="op" id="5508855">.</span><span class="ident" id="5508856">JoinHostPort</span><span class="op" id="5508868">(</span><span class="ident" id="5508869">params</span><span class="op" id="5508875">[</span><span class="string" id="5508876">&#34;REMOTE_ADDR&#34;</span><span class="op" id="5508889">]</span><span class="op" id="5508890">,</span>&nbsp;<span class="string" id="5508892">&#34;0&#34;</span><span class="op" id="5508895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508899">return</span>&nbsp;<span class="ident" id="5508906">r</span><span class="op" id="5508907">,</span>&nbsp;<span class="builtintype" id="5508909">nil</span><br>
<span class="lineno">140</span><span class="op" id="5508913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5508916">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="5508983">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="5509041">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="5509105">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="5509130">func</span>&nbsp;<span class="ident" id="5509135">Serve</span><span class="op" id="5509140">(</span><span class="ident" id="5509141">handler</span>&nbsp;<span class="ident" id="5509149">http</span><span class="op" id="5509153">.</span><span class="ident" id="5509154">Handler</span><span class="op" id="5509161">)</span>&nbsp;<span class="builtintype" id="5509163">error</span>&nbsp;<span class="op" id="5509169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509172">req</span><span class="op" id="5509175">,</span>&nbsp;<span class="ident" id="5509177">err</span>&nbsp;<span class="op" id="5509181">:=</span>&nbsp;<span class="ident" id="5509184">Request</span><span class="op" id="5509191">(</span><span class="op" id="5509192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509195">if</span>&nbsp;<span class="ident" id="5509198">err</span>&nbsp;<span class="op" id="5509202">!=</span>&nbsp;<span class="builtintype" id="5509205">nil</span>&nbsp;<span class="op" id="5509209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509213">return</span>&nbsp;<span class="ident" id="5509220">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509228">if</span>&nbsp;<span class="ident" id="5509231">handler</span>&nbsp;<span class="op" id="5509239">==</span>&nbsp;<span class="builtintype" id="5509242">nil</span>&nbsp;<span class="op" id="5509246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509250">handler</span>&nbsp;<span class="op" id="5509258">=</span>&nbsp;<span class="ident" id="5509260">http</span><span class="op" id="5509264">.</span><span class="ident" id="5509265">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509285">rw</span>&nbsp;<span class="op" id="5509288">:=</span>&nbsp;<span class="op" id="5509291">&amp;</span><span class="ident" id="5509292">response</span><span class="op" id="5509300">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509304">req</span><span class="op" id="5509307">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509312">req</span><span class="op" id="5509315">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509319">header</span><span class="op" id="5509325">:</span>&nbsp;<span class="builtinfunc" id="5509327">make</span><span class="op" id="5509331">(</span><span class="ident" id="5509332">http</span><span class="op" id="5509336">.</span><span class="ident" id="5509337">Header</span><span class="op" id="5509343">)</span><span class="op" id="5509344">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509348">bufw</span><span class="op" id="5509352">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5509356">bufio</span><span class="op" id="5509361">.</span><span class="ident" id="5509362">NewWriter</span><span class="op" id="5509371">(</span><span class="ident" id="5509372">os</span><span class="op" id="5509374">.</span><span class="ident" id="5509375">Stdout</span><span class="op" id="5509381">)</span><span class="op" id="5509382">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509388">handler</span><span class="op" id="5509395">.</span><span class="ident" id="5509396">ServeHTTP</span><span class="op" id="5509405">(</span><span class="ident" id="5509406">rw</span><span class="op" id="5509408">,</span>&nbsp;<span class="ident" id="5509410">req</span><span class="op" id="5509413">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509416">rw</span><span class="op" id="5509418">.</span><span class="ident" id="5509419">Write</span><span class="op" id="5509424">(</span><span class="builtintype" id="5509425">nil</span><span class="op" id="5509428">)</span>&nbsp;<span class="comment" id="5509430">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509463">if</span>&nbsp;<span class="ident" id="5509466">err</span>&nbsp;<span class="op" id="5509470">=</span>&nbsp;<span class="ident" id="5509472">rw</span><span class="op" id="5509474">.</span><span class="ident" id="5509475">bufw</span><span class="op" id="5509479">.</span><span class="ident" id="5509480">Flush</span><span class="op" id="5509485">(</span><span class="op" id="5509486">)</span><span class="op" id="5509487">;</span>&nbsp;<span class="ident" id="5509489">err</span>&nbsp;<span class="op" id="5509493">!=</span>&nbsp;<span class="builtintype" id="5509496">nil</span>&nbsp;<span class="op" id="5509500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509504">return</span>&nbsp;<span class="ident" id="5509511">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509519">return</span>&nbsp;<span class="builtintype" id="5509526">nil</span><br>
<span class="lineno">165</span><span class="op" id="5509530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5509533">type</span>&nbsp;<span class="ident" id="5509538">response</span>&nbsp;<span class="keyword" id="5509547">struct</span>&nbsp;<span class="op" id="5509554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509557">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509568">*</span><span class="ident" id="5509569">http</span><span class="op" id="5509573">.</span><span class="ident" id="5509574">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509583">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509594">http</span><span class="op" id="5509598">.</span><span class="ident" id="5509599">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509607">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509618">*</span><span class="ident" id="5509619">bufio</span><span class="op" id="5509624">.</span><span class="ident" id="5509625">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509633">headerSent</span>&nbsp;<span class="builtintype" id="5509644">bool</span><br>
<span class="lineno"></span><span class="op" id="5509649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5509652">func</span>&nbsp;<span class="op" id="5509657">(</span><span class="ident" id="5509658">r</span>&nbsp;<span class="op" id="5509660">*</span><span class="ident" id="5509661">response</span><span class="op" id="5509669">)</span>&nbsp;<span class="ident" id="5509671">Flush</span><span class="op" id="5509676">(</span><span class="op" id="5509677">)</span>&nbsp;<span class="op" id="5509679">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509682">r</span><span class="op" id="5509683">.</span><span class="ident" id="5509684">bufw</span><span class="op" id="5509688">.</span><span class="ident" id="5509689">Flush</span><span class="op" id="5509694">(</span><span class="op" id="5509695">)</span><br>
<span class="lineno"></span><span class="op" id="5509697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5509700">func</span>&nbsp;<span class="op" id="5509705">(</span><span class="ident" id="5509706">r</span>&nbsp;<span class="op" id="5509708">*</span><span class="ident" id="5509709">response</span><span class="op" id="5509717">)</span>&nbsp;<span class="ident" id="5509719">Header</span><span class="op" id="5509725">(</span><span class="op" id="5509726">)</span>&nbsp;<span class="ident" id="5509728">http</span><span class="op" id="5509732">.</span><span class="ident" id="5509733">Header</span>&nbsp;<span class="op" id="5509740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509743">return</span>&nbsp;<span class="ident" id="5509750">r</span><span class="op" id="5509751">.</span><span class="ident" id="5509752">header</span><br>
<span class="lineno">180</span><span class="op" id="5509759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5509762">func</span>&nbsp;<span class="op" id="5509767">(</span><span class="ident" id="5509768">r</span>&nbsp;<span class="op" id="5509770">*</span><span class="ident" id="5509771">response</span><span class="op" id="5509779">)</span>&nbsp;<span class="ident" id="5509781">Write</span><span class="op" id="5509786">(</span><span class="ident" id="5509787">p</span>&nbsp;<span class="op" id="5509789">[</span><span class="op" id="5509790">]</span><span class="builtintype" id="5509791">byte</span><span class="op" id="5509795">)</span>&nbsp;<span class="op" id="5509797">(</span><span class="ident" id="5509798">n</span>&nbsp;<span class="builtintype" id="5509800">int</span><span class="op" id="5509803">,</span>&nbsp;<span class="ident" id="5509805">err</span>&nbsp;<span class="builtintype" id="5509809">error</span><span class="op" id="5509814">)</span>&nbsp;<span class="op" id="5509816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509819">if</span>&nbsp;<span class="op" id="5509822">!</span><span class="ident" id="5509823">r</span><span class="op" id="5509824">.</span><span class="ident" id="5509825">headerSent</span>&nbsp;<span class="op" id="5509836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509840">r</span><span class="op" id="5509841">.</span><span class="ident" id="5509842">WriteHeader</span><span class="op" id="5509853">(</span><span class="ident" id="5509854">http</span><span class="op" id="5509858">.</span><span class="ident" id="5509859">StatusOK</span><span class="op" id="5509867">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509873">return</span>&nbsp;<span class="ident" id="5509880">r</span><span class="op" id="5509881">.</span><span class="ident" id="5509882">bufw</span><span class="op" id="5509886">.</span><span class="ident" id="5509887">Write</span><span class="op" id="5509892">(</span><span class="ident" id="5509893">p</span><span class="op" id="5509894">)</span><br>
<span class="lineno"></span><span class="op" id="5509896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5509899">func</span>&nbsp;<span class="op" id="5509904">(</span><span class="ident" id="5509905">r</span>&nbsp;<span class="op" id="5509907">*</span><span class="ident" id="5509908">response</span><span class="op" id="5509916">)</span>&nbsp;<span class="ident" id="5509918">WriteHeader</span><span class="op" id="5509929">(</span><span class="ident" id="5509930">code</span>&nbsp;<span class="builtintype" id="5509935">int</span><span class="op" id="5509938">)</span>&nbsp;<span class="op" id="5509940">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509943">if</span>&nbsp;<span class="ident" id="5509946">r</span><span class="op" id="5509947">.</span><span class="ident" id="5509948">headerSent</span>&nbsp;<span class="op" id="5509959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509963">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510029">fmt</span><span class="op" id="5510032">.</span><span class="ident" id="5510033">Fprintf</span><span class="op" id="5510040">(</span><span class="ident" id="5510041">os</span><span class="op" id="5510043">.</span><span class="ident" id="5510044">Stderr</span><span class="op" id="5510050">,</span>&nbsp;<span class="string" id="5510052">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="5510107">,</span>&nbsp;<span class="ident" id="5510109">r</span><span class="op" id="5510110">.</span><span class="ident" id="5510111">req</span><span class="op" id="5510114">.</span><span class="ident" id="5510115">URL</span><span class="op" id="5510118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5510122">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5510130">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510133">r</span><span class="op" id="5510134">.</span><span class="ident" id="5510135">headerSent</span>&nbsp;<span class="op" id="5510146">=</span>&nbsp;<span class="builtintype" id="5510148">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510154">fmt</span><span class="op" id="5510157">.</span><span class="ident" id="5510158">Fprintf</span><span class="op" id="5510165">(</span><span class="ident" id="5510166">r</span><span class="op" id="5510167">.</span><span class="ident" id="5510168">bufw</span><span class="op" id="5510172">,</span>&nbsp;<span class="string" id="5510174">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="5510193">,</span>&nbsp;<span class="ident" id="5510195">code</span><span class="op" id="5510199">,</span>&nbsp;<span class="ident" id="5510201">http</span><span class="op" id="5510205">.</span><span class="ident" id="5510206">StatusText</span><span class="op" id="5510216">(</span><span class="ident" id="5510217">code</span><span class="op" id="5510221">)</span><span class="op" id="5510222">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510226">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5510257">if</span>&nbsp;<span class="ident" id="5510260">_</span><span class="op" id="5510261">,</span>&nbsp;<span class="ident" id="5510263">hasType</span>&nbsp;<span class="op" id="5510271">:=</span>&nbsp;<span class="ident" id="5510274">r</span><span class="op" id="5510275">.</span><span class="ident" id="5510276">header</span><span class="op" id="5510282">[</span><span class="string" id="5510283">&#34;Content-Type&#34;</span><span class="op" id="5510297">]</span><span class="op" id="5510298">;</span>&nbsp;<span class="op" id="5510300">!</span><span class="ident" id="5510301">hasType</span>&nbsp;<span class="op" id="5510309">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510313">r</span><span class="op" id="5510314">.</span><span class="ident" id="5510315">header</span><span class="op" id="5510321">.</span><span class="ident" id="5510322">Add</span><span class="op" id="5510325">(</span><span class="string" id="5510326">&#34;Content-Type&#34;</span><span class="op" id="5510340">,</span>&nbsp;<span class="string" id="5510342">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="5510368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5510371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510375">r</span><span class="op" id="5510376">.</span><span class="ident" id="5510377">header</span><span class="op" id="5510383">.</span><span class="ident" id="5510384">Write</span><span class="op" id="5510389">(</span><span class="ident" id="5510390">r</span><span class="op" id="5510391">.</span><span class="ident" id="5510392">bufw</span><span class="op" id="5510396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510399">r</span><span class="op" id="5510400">.</span><span class="ident" id="5510401">bufw</span><span class="op" id="5510405">.</span><span class="ident" id="5510406">WriteString</span><span class="op" id="5510417">(</span><span class="string" id="5510418">&#34;\r\n&#34;</span><span class="op" id="5510424">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510427">r</span><span class="op" id="5510428">.</span><span class="ident" id="5510429">bufw</span><span class="op" id="5510433">.</span><span class="ident" id="5510434">Flush</span><span class="op" id="5510439">(</span><span class="op" id="5510440">)</span><br>
<span class="lineno"></span><span class="op" id="5510442">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
