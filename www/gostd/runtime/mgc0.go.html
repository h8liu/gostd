<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1949068">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1949123">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1949177">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1949228">package</span>&nbsp;<span class="ident" id="1949236">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1949245">import</span>&nbsp;<span class="string" id="1949252">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1949262">//&nbsp;Called&nbsp;from&nbsp;C.&nbsp;Returns&nbsp;the&nbsp;Go&nbsp;type&nbsp;*m.</span><br>
<span class="lineno">10</span><span class="keyword" id="1949304">func</span>&nbsp;<span class="ident" id="1949309">gc_m_ptr</span><span class="op" id="1949317">(</span><span class="ident" id="1949318">ret</span>&nbsp;<span class="op" id="1949322">*</span><span class="keyword" id="1949323">interface</span><span class="op" id="1949332">{</span><span class="op" id="1949333">}</span><span class="op" id="1949334">)</span>&nbsp;<span class="op" id="1949336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1949339">*</span><span class="ident" id="1949340">ret</span>&nbsp;<span class="op" id="1949344">=</span>&nbsp;<span class="op" id="1949346">(</span><span class="op" id="1949347">*</span><span class="ident" id="1949348">m</span><span class="op" id="1949349">)</span><span class="op" id="1949350">(</span><span class="ident" id="1949351">nil</span><span class="op" id="1949354">)</span><br>
<span class="lineno"></span><span class="op" id="1949356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1949359">//&nbsp;Called&nbsp;from&nbsp;C.&nbsp;Returns&nbsp;the&nbsp;Go&nbsp;type&nbsp;*g.</span><br>
<span class="lineno">15</span><span class="keyword" id="1949401">func</span>&nbsp;<span class="ident" id="1949406">gc_g_ptr</span><span class="op" id="1949414">(</span><span class="ident" id="1949415">ret</span>&nbsp;<span class="op" id="1949419">*</span><span class="keyword" id="1949420">interface</span><span class="op" id="1949429">{</span><span class="op" id="1949430">}</span><span class="op" id="1949431">)</span>&nbsp;<span class="op" id="1949433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1949436">*</span><span class="ident" id="1949437">ret</span>&nbsp;<span class="op" id="1949441">=</span>&nbsp;<span class="op" id="1949443">(</span><span class="op" id="1949444">*</span><span class="ident" id="1949445">g</span><span class="op" id="1949446">)</span><span class="op" id="1949447">(</span><span class="ident" id="1949448">nil</span><span class="op" id="1949451">)</span><br>
<span class="lineno"></span><span class="op" id="1949453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1949456">//&nbsp;Called&nbsp;from&nbsp;C.&nbsp;Returns&nbsp;the&nbsp;Go&nbsp;type&nbsp;*itab.</span><br>
<span class="lineno">20</span><span class="keyword" id="1949501">func</span>&nbsp;<span class="ident" id="1949506">gc_itab_ptr</span><span class="op" id="1949517">(</span><span class="ident" id="1949518">ret</span>&nbsp;<span class="op" id="1949522">*</span><span class="keyword" id="1949523">interface</span><span class="op" id="1949532">{</span><span class="op" id="1949533">}</span><span class="op" id="1949534">)</span>&nbsp;<span class="op" id="1949536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1949539">*</span><span class="ident" id="1949540">ret</span>&nbsp;<span class="op" id="1949544">=</span>&nbsp;<span class="op" id="1949546">(</span><span class="op" id="1949547">*</span><span class="ident" id="1949548">itab</span><span class="op" id="1949552">)</span><span class="op" id="1949553">(</span><span class="ident" id="1949554">nil</span><span class="op" id="1949557">)</span><br>
<span class="lineno"></span><span class="op" id="1949559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1949562">func</span>&nbsp;<span class="ident" id="1949567">gc_unixnanotime</span><span class="op" id="1949582">(</span><span class="ident" id="1949583">now</span>&nbsp;<span class="op" id="1949587">*</span><span class="ident" id="1949588">int64</span><span class="op" id="1949593">)</span>&nbsp;<span class="op" id="1949595">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1949598">sec</span><span class="op" id="1949601">,</span>&nbsp;<span class="ident" id="1949603">nsec</span>&nbsp;<span class="op" id="1949608">:=</span>&nbsp;<span class="ident" id="1949611">timenow</span><span class="op" id="1949618">(</span><span class="op" id="1949619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1949622">*</span><span class="ident" id="1949623">now</span>&nbsp;<span class="op" id="1949627">=</span>&nbsp;<span class="ident" id="1949629">sec</span><span class="op" id="1949632">*</span><span class="num" id="1949633">1e9</span>&nbsp;<span class="op" id="1949637">+</span>&nbsp;<span class="ident" id="1949639">int64</span><span class="op" id="1949644">(</span><span class="ident" id="1949645">nsec</span><span class="op" id="1949649">)</span><br>
<span class="lineno"></span><span class="op" id="1949651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1949654">func</span>&nbsp;<span class="ident" id="1949659">freeOSMemory</span><span class="op" id="1949671">(</span><span class="op" id="1949672">)</span>&nbsp;<span class="op" id="1949674">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1949677">gogc</span><span class="op" id="1949681">(</span><span class="num" id="1949682">2</span><span class="op" id="1949683">)</span>&nbsp;<span class="comment" id="1949685">//&nbsp;force&nbsp;GC&nbsp;and&nbsp;do&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1949717">onM</span><span class="op" id="1949720">(</span><span class="ident" id="1949721">scavenge_m</span><span class="op" id="1949731">)</span><br>
<span class="lineno"></span><span class="op" id="1949733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1949736">var</span>&nbsp;<span class="ident" id="1949740">poolcleanup</span>&nbsp;<span class="keyword" id="1949752">func</span><span class="op" id="1949756">(</span><span class="op" id="1949757">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1949760">func</span>&nbsp;<span class="ident" id="1949765">registerPoolCleanup</span><span class="op" id="1949784">(</span><span class="ident" id="1949785">f</span>&nbsp;<span class="keyword" id="1949787">func</span><span class="op" id="1949791">(</span><span class="op" id="1949792">)</span><span class="op" id="1949793">)</span>&nbsp;<span class="op" id="1949795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1949798">poolcleanup</span>&nbsp;<span class="op" id="1949810">=</span>&nbsp;<span class="ident" id="1949812">f</span><br>
<span class="lineno"></span><span class="op" id="1949814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="1949817">func</span>&nbsp;<span class="ident" id="1949822">clearpools</span><span class="op" id="1949832">(</span><span class="op" id="1949833">)</span>&nbsp;<span class="op" id="1949835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1949838">//&nbsp;clear&nbsp;sync.Pools</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1949859">if</span>&nbsp;<span class="ident" id="1949862">poolcleanup</span>&nbsp;<span class="op" id="1949874">!=</span>&nbsp;<span class="ident" id="1949877">nil</span>&nbsp;<span class="op" id="1949881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1949885">poolcleanup</span><span class="op" id="1949896">(</span><span class="op" id="1949897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1949900">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1949904">for</span>&nbsp;<span class="ident" id="1949908">_</span><span class="op" id="1949909">,</span>&nbsp;<span class="ident" id="1949911">p</span>&nbsp;<span class="op" id="1949913">:=</span>&nbsp;<span class="keyword" id="1949916">range</span>&nbsp;<span class="op" id="1949922">&amp;</span><span class="ident" id="1949923">allp</span>&nbsp;<span class="op" id="1949928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1949932">if</span>&nbsp;<span class="ident" id="1949935">p</span>&nbsp;<span class="op" id="1949937">==</span>&nbsp;<span class="ident" id="1949940">nil</span>&nbsp;<span class="op" id="1949944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1949949">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1949957">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1949961">//&nbsp;clear&nbsp;tinyalloc&nbsp;pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1949987">if</span>&nbsp;<span class="ident" id="1949990">c</span>&nbsp;<span class="op" id="1949992">:=</span>&nbsp;<span class="ident" id="1949995">p</span><span class="op" id="1949996">.</span><span class="ident" id="1949997">mcache</span><span class="op" id="1950003">;</span>&nbsp;<span class="ident" id="1950005">c</span>&nbsp;<span class="op" id="1950007">!=</span>&nbsp;<span class="ident" id="1950010">nil</span>&nbsp;<span class="op" id="1950014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950019">c</span><span class="op" id="1950020">.</span><span class="ident" id="1950021">tiny</span>&nbsp;<span class="op" id="1950026">=</span>&nbsp;<span class="ident" id="1950028">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950035">c</span><span class="op" id="1950036">.</span><span class="ident" id="1950037">tinysize</span>&nbsp;<span class="op" id="1950046">=</span>&nbsp;<span class="num" id="1950048">0</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1950054">//&nbsp;disconnect&nbsp;cached&nbsp;list&nbsp;before&nbsp;dropping&nbsp;it&nbsp;on&nbsp;the&nbsp;floor,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1950116">//&nbsp;so&nbsp;that&nbsp;a&nbsp;dangling&nbsp;ref&nbsp;to&nbsp;one&nbsp;entry&nbsp;does&nbsp;not&nbsp;pin&nbsp;all&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1950184">var</span>&nbsp;<span class="ident" id="1950188">sg</span><span class="op" id="1950190">,</span>&nbsp;<span class="ident" id="1950192">sgnext</span>&nbsp;<span class="op" id="1950199">*</span><span class="ident" id="1950200">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1950209">for</span>&nbsp;<span class="ident" id="1950213">sg</span>&nbsp;<span class="op" id="1950216">=</span>&nbsp;<span class="ident" id="1950218">c</span><span class="op" id="1950219">.</span><span class="ident" id="1950220">sudogcache</span><span class="op" id="1950230">;</span>&nbsp;<span class="ident" id="1950232">sg</span>&nbsp;<span class="op" id="1950235">!=</span>&nbsp;<span class="ident" id="1950238">nil</span><span class="op" id="1950241">;</span>&nbsp;<span class="ident" id="1950243">sg</span>&nbsp;<span class="op" id="1950246">=</span>&nbsp;<span class="ident" id="1950248">sgnext</span>&nbsp;<span class="op" id="1950255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950261">sgnext</span>&nbsp;<span class="op" id="1950268">=</span>&nbsp;<span class="ident" id="1950270">sg</span><span class="op" id="1950272">.</span><span class="ident" id="1950273">next</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950282">sg</span><span class="op" id="1950284">.</span><span class="ident" id="1950285">next</span>&nbsp;<span class="op" id="1950290">=</span>&nbsp;<span class="ident" id="1950292">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1950299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950304">c</span><span class="op" id="1950305">.</span><span class="ident" id="1950306">sudogcache</span>&nbsp;<span class="op" id="1950317">=</span>&nbsp;<span class="ident" id="1950319">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1950325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1950330">//&nbsp;clear&nbsp;defer&nbsp;pools</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1950353">for</span>&nbsp;<span class="ident" id="1950357">i</span>&nbsp;<span class="op" id="1950359">:=</span>&nbsp;<span class="keyword" id="1950362">range</span>&nbsp;<span class="ident" id="1950368">p</span><span class="op" id="1950369">.</span><span class="ident" id="1950370">deferpool</span>&nbsp;<span class="op" id="1950380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1950385">//&nbsp;disconnect&nbsp;cached&nbsp;list&nbsp;before&nbsp;dropping&nbsp;it&nbsp;on&nbsp;the&nbsp;floor,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1950447">//&nbsp;so&nbsp;that&nbsp;a&nbsp;dangling&nbsp;ref&nbsp;to&nbsp;one&nbsp;entry&nbsp;does&nbsp;not&nbsp;pin&nbsp;all&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1950515">var</span>&nbsp;<span class="ident" id="1950519">d</span><span class="op" id="1950520">,</span>&nbsp;<span class="ident" id="1950522">dlink</span>&nbsp;<span class="op" id="1950528">*</span><span class="ident" id="1950529">_defer</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1950539">for</span>&nbsp;<span class="ident" id="1950543">d</span>&nbsp;<span class="op" id="1950545">=</span>&nbsp;<span class="ident" id="1950547">p</span><span class="op" id="1950548">.</span><span class="ident" id="1950549">deferpool</span><span class="op" id="1950558">[</span><span class="ident" id="1950559">i</span><span class="op" id="1950560">]</span><span class="op" id="1950561">;</span>&nbsp;<span class="ident" id="1950563">d</span>&nbsp;<span class="op" id="1950565">!=</span>&nbsp;<span class="ident" id="1950568">nil</span><span class="op" id="1950571">;</span>&nbsp;<span class="ident" id="1950573">d</span>&nbsp;<span class="op" id="1950575">=</span>&nbsp;<span class="ident" id="1950577">dlink</span>&nbsp;<span class="op" id="1950583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950589">dlink</span>&nbsp;<span class="op" id="1950595">=</span>&nbsp;<span class="ident" id="1950597">d</span><span class="op" id="1950598">.</span><span class="ident" id="1950599">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950608">d</span><span class="op" id="1950609">.</span><span class="ident" id="1950610">link</span>&nbsp;<span class="op" id="1950615">=</span>&nbsp;<span class="ident" id="1950617">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1950624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950629">p</span><span class="op" id="1950630">.</span><span class="ident" id="1950631">deferpool</span><span class="op" id="1950640">[</span><span class="ident" id="1950641">i</span><span class="op" id="1950642">]</span>&nbsp;<span class="op" id="1950644">=</span>&nbsp;<span class="ident" id="1950646">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1950652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1950655">}</span><br>
<span class="lineno"></span><span class="op" id="1950657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1950660">func</span>&nbsp;<span class="ident" id="1950665">gosweepone</span><span class="op" id="1950675">(</span><span class="op" id="1950676">)</span>&nbsp;<span class="builtintype" id="1950678">uintptr</span><br>
<span class="lineno">80</span><span class="keyword" id="1950686">func</span>&nbsp;<span class="ident" id="1950691">gosweepdone</span><span class="op" id="1950702">(</span><span class="op" id="1950703">)</span>&nbsp;<span class="builtintype" id="1950705">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1950711">func</span>&nbsp;<span class="ident" id="1950716">bgsweep</span><span class="op" id="1950723">(</span><span class="op" id="1950724">)</span>&nbsp;<span class="op" id="1950726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950729">getg</span><span class="op" id="1950733">(</span><span class="op" id="1950734">)</span><span class="op" id="1950735">.</span><span class="ident" id="1950736">issystem</span>&nbsp;<span class="op" id="1950745">=</span>&nbsp;<span class="builtintype" id="1950747">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1950753">for</span>&nbsp;<span class="op" id="1950757">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1950761">for</span>&nbsp;<span class="ident" id="1950765">gosweepone</span><span class="op" id="1950775">(</span><span class="op" id="1950776">)</span>&nbsp;<span class="op" id="1950778">!=</span>&nbsp;<span class="op" id="1950781">^</span><span class="builtintype" id="1950782">uintptr</span><span class="op" id="1950789">(</span><span class="num" id="1950790">0</span><span class="op" id="1950791">)</span>&nbsp;<span class="op" id="1950793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950798">sweep</span><span class="op" id="1950803">.</span><span class="ident" id="1950804">nbgsweep</span><span class="op" id="1950812">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950818">Gosched</span><span class="op" id="1950825">(</span><span class="op" id="1950826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1950830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950834">lock</span><span class="op" id="1950838">(</span><span class="op" id="1950839">&amp;</span><span class="ident" id="1950840">gclock</span><span class="op" id="1950846">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1950850">if</span>&nbsp;<span class="op" id="1950853">!</span><span class="ident" id="1950854">gosweepdone</span><span class="op" id="1950865">(</span><span class="op" id="1950866">)</span>&nbsp;<span class="op" id="1950868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1950873">//&nbsp;This&nbsp;can&nbsp;happen&nbsp;if&nbsp;a&nbsp;GC&nbsp;runs&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1950916">//&nbsp;gosweepone&nbsp;returning&nbsp;^0&nbsp;above</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1950952">//&nbsp;and&nbsp;the&nbsp;lock&nbsp;being&nbsp;acquired.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1950987">unlock</span><span class="op" id="1950993">(</span><span class="op" id="1950994">&amp;</span><span class="ident" id="1950995">gclock</span><span class="op" id="1951001">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1951006">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1951017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951021">sweep</span><span class="op" id="1951026">.</span><span class="ident" id="1951027">parked</span>&nbsp;<span class="op" id="1951034">=</span>&nbsp;<span class="builtintype" id="1951036">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951043">goparkunlock</span><span class="op" id="1951055">(</span><span class="op" id="1951056">&amp;</span><span class="ident" id="1951057">gclock</span><span class="op" id="1951063">,</span>&nbsp;<span class="string" id="1951065">&#34;GC&nbsp;sweep&nbsp;wait&#34;</span><span class="op" id="1951080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1951083">}</span><br>
<span class="lineno">100</span><span class="op" id="1951085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1951088">//&nbsp;NOTE:&nbsp;Really&nbsp;dst&nbsp;*unsafe.Pointer,&nbsp;src&nbsp;unsafe.Pointer,</span><br>
<span class="lineno"></span><span class="comment" id="1951145">//&nbsp;but&nbsp;if&nbsp;we&nbsp;do&nbsp;that,&nbsp;Go&nbsp;inserts&nbsp;a&nbsp;write&nbsp;barrier&nbsp;on&nbsp;*dst&nbsp;=&nbsp;src.</span><br>
<span class="lineno"></span><span class="comment" id="1951209">//go:nosplit</span><br>
<span class="lineno">105</span><span class="keyword" id="1951222">func</span>&nbsp;<span class="ident" id="1951227">writebarrierptr</span><span class="op" id="1951242">(</span><span class="ident" id="1951243">dst</span>&nbsp;<span class="op" id="1951247">*</span><span class="builtintype" id="1951248">uintptr</span><span class="op" id="1951255">,</span>&nbsp;<span class="ident" id="1951257">src</span>&nbsp;<span class="builtintype" id="1951261">uintptr</span><span class="op" id="1951268">)</span>&nbsp;<span class="op" id="1951270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1951273">*</span><span class="ident" id="1951274">dst</span>&nbsp;<span class="op" id="1951278">=</span>&nbsp;<span class="ident" id="1951280">src</span><br>
<span class="lineno"></span><span class="op" id="1951284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1951287">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1951300">func</span>&nbsp;<span class="ident" id="1951305">writebarrierstring</span><span class="op" id="1951323">(</span><span class="ident" id="1951324">dst</span>&nbsp;<span class="op" id="1951328">*</span><span class="op" id="1951329">[</span><span class="num" id="1951330">2</span><span class="op" id="1951331">]</span><span class="builtintype" id="1951332">uintptr</span><span class="op" id="1951339">,</span>&nbsp;<span class="ident" id="1951341">src</span>&nbsp;<span class="op" id="1951345">[</span><span class="num" id="1951346">2</span><span class="op" id="1951347">]</span><span class="builtintype" id="1951348">uintptr</span><span class="op" id="1951355">)</span>&nbsp;<span class="op" id="1951357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951360">dst</span><span class="op" id="1951363">[</span><span class="num" id="1951364">0</span><span class="op" id="1951365">]</span>&nbsp;<span class="op" id="1951367">=</span>&nbsp;<span class="ident" id="1951369">src</span><span class="op" id="1951372">[</span><span class="num" id="1951373">0</span><span class="op" id="1951374">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951377">dst</span><span class="op" id="1951380">[</span><span class="num" id="1951381">1</span><span class="op" id="1951382">]</span>&nbsp;<span class="op" id="1951384">=</span>&nbsp;<span class="ident" id="1951386">src</span><span class="op" id="1951389">[</span><span class="num" id="1951390">1</span><span class="op" id="1951391">]</span><br>
<span class="lineno"></span><span class="op" id="1951393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="1951396">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1951409">func</span>&nbsp;<span class="ident" id="1951414">writebarrierslice</span><span class="op" id="1951431">(</span><span class="ident" id="1951432">dst</span>&nbsp;<span class="op" id="1951436">*</span><span class="op" id="1951437">[</span><span class="num" id="1951438">3</span><span class="op" id="1951439">]</span><span class="builtintype" id="1951440">uintptr</span><span class="op" id="1951447">,</span>&nbsp;<span class="ident" id="1951449">src</span>&nbsp;<span class="op" id="1951453">[</span><span class="num" id="1951454">3</span><span class="op" id="1951455">]</span><span class="builtintype" id="1951456">uintptr</span><span class="op" id="1951463">)</span>&nbsp;<span class="op" id="1951465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951468">dst</span><span class="op" id="1951471">[</span><span class="num" id="1951472">0</span><span class="op" id="1951473">]</span>&nbsp;<span class="op" id="1951475">=</span>&nbsp;<span class="ident" id="1951477">src</span><span class="op" id="1951480">[</span><span class="num" id="1951481">0</span><span class="op" id="1951482">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951485">dst</span><span class="op" id="1951488">[</span><span class="num" id="1951489">1</span><span class="op" id="1951490">]</span>&nbsp;<span class="op" id="1951492">=</span>&nbsp;<span class="ident" id="1951494">src</span><span class="op" id="1951497">[</span><span class="num" id="1951498">1</span><span class="op" id="1951499">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951502">dst</span><span class="op" id="1951505">[</span><span class="num" id="1951506">2</span><span class="op" id="1951507">]</span>&nbsp;<span class="op" id="1951509">=</span>&nbsp;<span class="ident" id="1951511">src</span><span class="op" id="1951514">[</span><span class="num" id="1951515">2</span><span class="op" id="1951516">]</span><br>
<span class="lineno">120</span><span class="op" id="1951518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1951521">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1951534">func</span>&nbsp;<span class="ident" id="1951539">writebarrieriface</span><span class="op" id="1951556">(</span><span class="ident" id="1951557">dst</span>&nbsp;<span class="op" id="1951561">*</span><span class="op" id="1951562">[</span><span class="num" id="1951563">2</span><span class="op" id="1951564">]</span><span class="builtintype" id="1951565">uintptr</span><span class="op" id="1951572">,</span>&nbsp;<span class="ident" id="1951574">src</span>&nbsp;<span class="op" id="1951578">[</span><span class="num" id="1951579">2</span><span class="op" id="1951580">]</span><span class="builtintype" id="1951581">uintptr</span><span class="op" id="1951588">)</span>&nbsp;<span class="op" id="1951590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951593">dst</span><span class="op" id="1951596">[</span><span class="num" id="1951597">0</span><span class="op" id="1951598">]</span>&nbsp;<span class="op" id="1951600">=</span>&nbsp;<span class="ident" id="1951602">src</span><span class="op" id="1951605">[</span><span class="num" id="1951606">0</span><span class="op" id="1951607">]</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951610">dst</span><span class="op" id="1951613">[</span><span class="num" id="1951614">1</span><span class="op" id="1951615">]</span>&nbsp;<span class="op" id="1951617">=</span>&nbsp;<span class="ident" id="1951619">src</span><span class="op" id="1951622">[</span><span class="num" id="1951623">1</span><span class="op" id="1951624">]</span><br>
<span class="lineno"></span><span class="op" id="1951626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1951629">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1951642">func</span>&nbsp;<span class="ident" id="1951647">writebarrierfat2</span><span class="op" id="1951663">(</span><span class="ident" id="1951664">dst</span>&nbsp;<span class="op" id="1951668">*</span><span class="op" id="1951669">[</span><span class="num" id="1951670">2</span><span class="op" id="1951671">]</span><span class="builtintype" id="1951672">uintptr</span><span class="op" id="1951679">,</span>&nbsp;<span class="ident" id="1951681">_</span>&nbsp;<span class="op" id="1951683">*</span><span class="builtintype" id="1951684">byte</span><span class="op" id="1951688">,</span>&nbsp;<span class="ident" id="1951690">src</span>&nbsp;<span class="op" id="1951694">[</span><span class="num" id="1951695">2</span><span class="op" id="1951696">]</span><span class="builtintype" id="1951697">uintptr</span><span class="op" id="1951704">)</span>&nbsp;<span class="op" id="1951706">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951709">dst</span><span class="op" id="1951712">[</span><span class="num" id="1951713">0</span><span class="op" id="1951714">]</span>&nbsp;<span class="op" id="1951716">=</span>&nbsp;<span class="ident" id="1951718">src</span><span class="op" id="1951721">[</span><span class="num" id="1951722">0</span><span class="op" id="1951723">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951726">dst</span><span class="op" id="1951729">[</span><span class="num" id="1951730">1</span><span class="op" id="1951731">]</span>&nbsp;<span class="op" id="1951733">=</span>&nbsp;<span class="ident" id="1951735">src</span><span class="op" id="1951738">[</span><span class="num" id="1951739">1</span><span class="op" id="1951740">]</span><br>
<span class="lineno"></span><span class="op" id="1951742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1951745">//go:nosplit</span><br>
<span class="lineno">135</span><span class="keyword" id="1951758">func</span>&nbsp;<span class="ident" id="1951763">writebarrierfat3</span><span class="op" id="1951779">(</span><span class="ident" id="1951780">dst</span>&nbsp;<span class="op" id="1951784">*</span><span class="op" id="1951785">[</span><span class="num" id="1951786">3</span><span class="op" id="1951787">]</span><span class="builtintype" id="1951788">uintptr</span><span class="op" id="1951795">,</span>&nbsp;<span class="ident" id="1951797">_</span>&nbsp;<span class="op" id="1951799">*</span><span class="builtintype" id="1951800">byte</span><span class="op" id="1951804">,</span>&nbsp;<span class="ident" id="1951806">src</span>&nbsp;<span class="op" id="1951810">[</span><span class="num" id="1951811">3</span><span class="op" id="1951812">]</span><span class="builtintype" id="1951813">uintptr</span><span class="op" id="1951820">)</span>&nbsp;<span class="op" id="1951822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951825">dst</span><span class="op" id="1951828">[</span><span class="num" id="1951829">0</span><span class="op" id="1951830">]</span>&nbsp;<span class="op" id="1951832">=</span>&nbsp;<span class="ident" id="1951834">src</span><span class="op" id="1951837">[</span><span class="num" id="1951838">0</span><span class="op" id="1951839">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951842">dst</span><span class="op" id="1951845">[</span><span class="num" id="1951846">1</span><span class="op" id="1951847">]</span>&nbsp;<span class="op" id="1951849">=</span>&nbsp;<span class="ident" id="1951851">src</span><span class="op" id="1951854">[</span><span class="num" id="1951855">1</span><span class="op" id="1951856">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951859">dst</span><span class="op" id="1951862">[</span><span class="num" id="1951863">2</span><span class="op" id="1951864">]</span>&nbsp;<span class="op" id="1951866">=</span>&nbsp;<span class="ident" id="1951868">src</span><span class="op" id="1951871">[</span><span class="num" id="1951872">2</span><span class="op" id="1951873">]</span><br>
<span class="lineno"></span><span class="op" id="1951875">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1951878">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1951891">func</span>&nbsp;<span class="ident" id="1951896">writebarrierfat4</span><span class="op" id="1951912">(</span><span class="ident" id="1951913">dst</span>&nbsp;<span class="op" id="1951917">*</span><span class="op" id="1951918">[</span><span class="num" id="1951919">4</span><span class="op" id="1951920">]</span><span class="builtintype" id="1951921">uintptr</span><span class="op" id="1951928">,</span>&nbsp;<span class="ident" id="1951930">_</span>&nbsp;<span class="op" id="1951932">*</span><span class="builtintype" id="1951933">byte</span><span class="op" id="1951937">,</span>&nbsp;<span class="ident" id="1951939">src</span>&nbsp;<span class="op" id="1951943">[</span><span class="num" id="1951944">4</span><span class="op" id="1951945">]</span><span class="builtintype" id="1951946">uintptr</span><span class="op" id="1951953">)</span>&nbsp;<span class="op" id="1951955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951958">dst</span><span class="op" id="1951961">[</span><span class="num" id="1951962">0</span><span class="op" id="1951963">]</span>&nbsp;<span class="op" id="1951965">=</span>&nbsp;<span class="ident" id="1951967">src</span><span class="op" id="1951970">[</span><span class="num" id="1951971">0</span><span class="op" id="1951972">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951975">dst</span><span class="op" id="1951978">[</span><span class="num" id="1951979">1</span><span class="op" id="1951980">]</span>&nbsp;<span class="op" id="1951982">=</span>&nbsp;<span class="ident" id="1951984">src</span><span class="op" id="1951987">[</span><span class="num" id="1951988">1</span><span class="op" id="1951989">]</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1951992">dst</span><span class="op" id="1951995">[</span><span class="num" id="1951996">2</span><span class="op" id="1951997">]</span>&nbsp;<span class="op" id="1951999">=</span>&nbsp;<span class="ident" id="1952001">src</span><span class="op" id="1952004">[</span><span class="num" id="1952005">2</span><span class="op" id="1952006">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1952009">dst</span><span class="op" id="1952012">[</span><span class="num" id="1952013">3</span><span class="op" id="1952014">]</span>&nbsp;<span class="op" id="1952016">=</span>&nbsp;<span class="ident" id="1952018">src</span><span class="op" id="1952021">[</span><span class="num" id="1952022">3</span><span class="op" id="1952023">]</span><br>
<span class="lineno"></span><span class="op" id="1952025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1952028">//go:nosplit</span><br>
<span class="lineno">150</span><span class="keyword" id="1952041">func</span>&nbsp;<span class="ident" id="1952046">writebarrierfat</span><span class="op" id="1952061">(</span><span class="ident" id="1952062">typ</span>&nbsp;<span class="op" id="1952066">*</span><span class="ident" id="1952067">_type</span><span class="op" id="1952072">,</span>&nbsp;<span class="ident" id="1952074">dst</span><span class="op" id="1952077">,</span>&nbsp;<span class="ident" id="1952079">src</span>&nbsp;<span class="ident" id="1952083">unsafe</span><span class="op" id="1952089">.</span><span class="ident" id="1952090">Pointer</span><span class="op" id="1952097">)</span>&nbsp;<span class="op" id="1952099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1952102">memmove</span><span class="op" id="1952109">(</span><span class="ident" id="1952110">dst</span><span class="op" id="1952113">,</span>&nbsp;<span class="ident" id="1952115">src</span><span class="op" id="1952118">,</span>&nbsp;<span class="ident" id="1952120">typ</span><span class="op" id="1952123">.</span><span class="ident" id="1952124">size</span><span class="op" id="1952128">)</span><br>
<span class="lineno"></span><span class="op" id="1952130">}</span>
</div>
</body>
</html>
