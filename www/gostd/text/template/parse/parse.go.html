<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>text/template/parse</h2>
<ul>
<li><a href="/gostd/text/template/parse/lex.go.html">lex.go</a></li>
<li><a href="/gostd/text/template/parse/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/text/template/parse/node.go.html">node.go</a></li>
<li><a href="/gostd/text/template/parse/parse.go.html">parse.go</a></li>
<li><a href="/gostd/text/template/parse/parse_test.go.html">parse_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2977806">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2977861">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2977915">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2977966">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="2978044">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="2978123">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="2978199">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="2978228">package</span>&nbsp;<span class="ident" id="2978236">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2978243">import</span>&nbsp;<span class="op" id="2978250">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2978253">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2978262">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2978269">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2978280">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2978291">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="2978301">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2978304">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="2978363">type</span>&nbsp;<span class="ident" id="2978368">Tree</span>&nbsp;<span class="keyword" id="2978373">struct</span>&nbsp;<span class="op" id="2978380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978383">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2978393">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2978403">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978453">ParseName</span>&nbsp;<span class="builtintype" id="2978463">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2978473">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978544">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2978554">*</span><span class="ident" id="2978555">ListNode</span>&nbsp;<span class="comment" id="2978564">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978596">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2978606">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2978616">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2978671">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978710">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2978720">[</span><span class="op" id="2978721">]</span><span class="keyword" id="2978722">map</span><span class="op" id="2978725">[</span><span class="builtintype" id="2978726">string</span><span class="op" id="2978732">]</span><span class="keyword" id="2978733">interface</span><span class="op" id="2978742">{</span><span class="op" id="2978743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978746">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2978756">*</span><span class="ident" id="2978757">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978764">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2978774">[</span><span class="num" id="2978775">3</span><span class="op" id="2978776">]</span><span class="ident" id="2978777">item</span>&nbsp;<span class="comment" id="2978782">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978820">peekCount</span>&nbsp;<span class="builtintype" id="2978830">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2978835">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2978845">[</span><span class="op" id="2978846">]</span><span class="builtintype" id="2978847">string</span>&nbsp;<span class="comment" id="2978854">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="2978890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2978893">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="2978961">func</span>&nbsp;<span class="op" id="2978966">(</span><span class="ident" id="2978967">t</span>&nbsp;<span class="op" id="2978969">*</span><span class="ident" id="2978970">Tree</span><span class="op" id="2978974">)</span>&nbsp;<span class="ident" id="2978976">Copy</span><span class="op" id="2978980">(</span><span class="op" id="2978981">)</span>&nbsp;<span class="op" id="2978983">*</span><span class="ident" id="2978984">Tree</span>&nbsp;<span class="op" id="2978989">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2978992">if</span>&nbsp;<span class="ident" id="2978995">t</span>&nbsp;<span class="op" id="2978997">==</span>&nbsp;<span class="ident" id="2979000">nil</span>&nbsp;<span class="op" id="2979004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2979008">return</span>&nbsp;<span class="ident" id="2979015">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2979020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2979023">return</span>&nbsp;<span class="op" id="2979030">&amp;</span><span class="ident" id="2979031">Tree</span><span class="op" id="2979035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979039">Name</span><span class="op" id="2979043">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2979050">t</span><span class="op" id="2979051">.</span><span class="ident" id="2979052">Name</span><span class="op" id="2979056">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979060">ParseName</span><span class="op" id="2979069">:</span>&nbsp;<span class="ident" id="2979071">t</span><span class="op" id="2979072">.</span><span class="ident" id="2979073">ParseName</span><span class="op" id="2979082">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979086">Root</span><span class="op" id="2979090">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2979097">t</span><span class="op" id="2979098">.</span><span class="ident" id="2979099">Root</span><span class="op" id="2979103">.</span><span class="ident" id="2979104">CopyList</span><span class="op" id="2979112">(</span><span class="op" id="2979113">)</span><span class="op" id="2979114">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979118">text</span><span class="op" id="2979122">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2979129">t</span><span class="op" id="2979130">.</span><span class="ident" id="2979131">text</span><span class="op" id="2979135">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2979138">}</span><br>
<span class="lineno"></span><span class="op" id="2979140">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="2979143">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2979223">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="2979301">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="2979379">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="2979420">func</span>&nbsp;<span class="ident" id="2979425">Parse</span><span class="op" id="2979430">(</span><span class="ident" id="2979431">name</span><span class="op" id="2979435">,</span>&nbsp;<span class="ident" id="2979437">text</span><span class="op" id="2979441">,</span>&nbsp;<span class="ident" id="2979443">leftDelim</span><span class="op" id="2979452">,</span>&nbsp;<span class="ident" id="2979454">rightDelim</span>&nbsp;<span class="builtintype" id="2979465">string</span><span class="op" id="2979471">,</span>&nbsp;<span class="ident" id="2979473">funcs</span>&nbsp;<span class="op" id="2979479">...</span><span class="keyword" id="2979482">map</span><span class="op" id="2979485">[</span><span class="builtintype" id="2979486">string</span><span class="op" id="2979492">]</span><span class="keyword" id="2979493">interface</span><span class="op" id="2979502">{</span><span class="op" id="2979503">}</span><span class="op" id="2979504">)</span>&nbsp;<span class="op" id="2979506">(</span><span class="ident" id="2979507">treeSet</span>&nbsp;<span class="keyword" id="2979515">map</span><span class="op" id="2979518">[</span><span class="builtintype" id="2979519">string</span><span class="op" id="2979525">]</span><span class="op" id="2979526">*</span><span class="ident" id="2979527">Tree</span><span class="op" id="2979531">,</span>&nbsp;<span class="ident" id="2979533">err</span>&nbsp;<span class="builtintype" id="2979537">error</span><span class="op" id="2979542">)</span>&nbsp;<span class="op" id="2979544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979547">treeSet</span>&nbsp;<span class="op" id="2979555">=</span>&nbsp;<span class="builtinfunc" id="2979557">make</span><span class="op" id="2979561">(</span><span class="keyword" id="2979562">map</span><span class="op" id="2979565">[</span><span class="builtintype" id="2979566">string</span><span class="op" id="2979572">]</span><span class="op" id="2979573">*</span><span class="ident" id="2979574">Tree</span><span class="op" id="2979578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979581">t</span>&nbsp;<span class="op" id="2979583">:=</span>&nbsp;<span class="ident" id="2979586">New</span><span class="op" id="2979589">(</span><span class="ident" id="2979590">name</span><span class="op" id="2979594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979597">t</span><span class="op" id="2979598">.</span><span class="ident" id="2979599">text</span>&nbsp;<span class="op" id="2979604">=</span>&nbsp;<span class="ident" id="2979606">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979612">_</span><span class="op" id="2979613">,</span>&nbsp;<span class="ident" id="2979615">err</span>&nbsp;<span class="op" id="2979619">=</span>&nbsp;<span class="ident" id="2979621">t</span><span class="op" id="2979622">.</span><span class="ident" id="2979623">Parse</span><span class="op" id="2979628">(</span><span class="ident" id="2979629">text</span><span class="op" id="2979633">,</span>&nbsp;<span class="ident" id="2979635">leftDelim</span><span class="op" id="2979644">,</span>&nbsp;<span class="ident" id="2979646">rightDelim</span><span class="op" id="2979656">,</span>&nbsp;<span class="ident" id="2979658">treeSet</span><span class="op" id="2979665">,</span>&nbsp;<span class="ident" id="2979667">funcs</span><span class="op" id="2979672">...</span><span class="op" id="2979675">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2979678">return</span><br>
<span class="lineno"></span><span class="op" id="2979685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2979688">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="2979720">func</span>&nbsp;<span class="op" id="2979725">(</span><span class="ident" id="2979726">t</span>&nbsp;<span class="op" id="2979728">*</span><span class="ident" id="2979729">Tree</span><span class="op" id="2979733">)</span>&nbsp;<span class="ident" id="2979735">next</span><span class="op" id="2979739">(</span><span class="op" id="2979740">)</span>&nbsp;<span class="ident" id="2979742">item</span>&nbsp;<span class="op" id="2979747">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2979750">if</span>&nbsp;<span class="ident" id="2979753">t</span><span class="op" id="2979754">.</span><span class="ident" id="2979755">peekCount</span>&nbsp;<span class="op" id="2979765">&gt;</span>&nbsp;<span class="num" id="2979767">0</span>&nbsp;<span class="op" id="2979769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979773">t</span><span class="op" id="2979774">.</span><span class="ident" id="2979775">peekCount</span><span class="op" id="2979784">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2979788">}</span>&nbsp;<span class="keyword" id="2979790">else</span>&nbsp;<span class="op" id="2979795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979799">t</span><span class="op" id="2979800">.</span><span class="ident" id="2979801">token</span><span class="op" id="2979806">[</span><span class="num" id="2979807">0</span><span class="op" id="2979808">]</span>&nbsp;<span class="op" id="2979810">=</span>&nbsp;<span class="ident" id="2979812">t</span><span class="op" id="2979813">.</span><span class="ident" id="2979814">lex</span><span class="op" id="2979817">.</span><span class="ident" id="2979818">nextItem</span><span class="op" id="2979826">(</span><span class="op" id="2979827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2979830">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2979833">return</span>&nbsp;<span class="ident" id="2979840">t</span><span class="op" id="2979841">.</span><span class="ident" id="2979842">token</span><span class="op" id="2979847">[</span><span class="ident" id="2979848">t</span><span class="op" id="2979849">.</span><span class="ident" id="2979850">peekCount</span><span class="op" id="2979859">]</span><br>
<span class="lineno"></span><span class="op" id="2979861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2979864">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="2979911">func</span>&nbsp;<span class="op" id="2979916">(</span><span class="ident" id="2979917">t</span>&nbsp;<span class="op" id="2979919">*</span><span class="ident" id="2979920">Tree</span><span class="op" id="2979924">)</span>&nbsp;<span class="ident" id="2979926">backup</span><span class="op" id="2979932">(</span><span class="op" id="2979933">)</span>&nbsp;<span class="op" id="2979935">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2979938">t</span><span class="op" id="2979939">.</span><span class="ident" id="2979940">peekCount</span><span class="op" id="2979949">++</span><br>
<span class="lineno"></span><span class="op" id="2979952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2979955">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="2980004">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="2980042">func</span>&nbsp;<span class="op" id="2980047">(</span><span class="ident" id="2980048">t</span>&nbsp;<span class="op" id="2980050">*</span><span class="ident" id="2980051">Tree</span><span class="op" id="2980055">)</span>&nbsp;<span class="ident" id="2980057">backup2</span><span class="op" id="2980064">(</span><span class="ident" id="2980065">t1</span>&nbsp;<span class="ident" id="2980068">item</span><span class="op" id="2980072">)</span>&nbsp;<span class="op" id="2980074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980077">t</span><span class="op" id="2980078">.</span><span class="ident" id="2980079">token</span><span class="op" id="2980084">[</span><span class="num" id="2980085">1</span><span class="op" id="2980086">]</span>&nbsp;<span class="op" id="2980088">=</span>&nbsp;<span class="ident" id="2980090">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980094">t</span><span class="op" id="2980095">.</span><span class="ident" id="2980096">peekCount</span>&nbsp;<span class="op" id="2980106">=</span>&nbsp;<span class="num" id="2980108">2</span><br>
<span class="lineno"></span><span class="op" id="2980110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="2980113">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="2980163">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="2980201">func</span>&nbsp;<span class="op" id="2980206">(</span><span class="ident" id="2980207">t</span>&nbsp;<span class="op" id="2980209">*</span><span class="ident" id="2980210">Tree</span><span class="op" id="2980214">)</span>&nbsp;<span class="ident" id="2980216">backup3</span><span class="op" id="2980223">(</span><span class="ident" id="2980224">t2</span><span class="op" id="2980226">,</span>&nbsp;<span class="ident" id="2980228">t1</span>&nbsp;<span class="ident" id="2980231">item</span><span class="op" id="2980235">)</span>&nbsp;<span class="op" id="2980237">{</span>&nbsp;<span class="comment" id="2980239">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980278">t</span><span class="op" id="2980279">.</span><span class="ident" id="2980280">token</span><span class="op" id="2980285">[</span><span class="num" id="2980286">1</span><span class="op" id="2980287">]</span>&nbsp;<span class="op" id="2980289">=</span>&nbsp;<span class="ident" id="2980291">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980295">t</span><span class="op" id="2980296">.</span><span class="ident" id="2980297">token</span><span class="op" id="2980302">[</span><span class="num" id="2980303">2</span><span class="op" id="2980304">]</span>&nbsp;<span class="op" id="2980306">=</span>&nbsp;<span class="ident" id="2980308">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980312">t</span><span class="op" id="2980313">.</span><span class="ident" id="2980314">peekCount</span>&nbsp;<span class="op" id="2980324">=</span>&nbsp;<span class="num" id="2980326">3</span><br>
<span class="lineno"></span><span class="op" id="2980328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2980331">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="2980384">func</span>&nbsp;<span class="op" id="2980389">(</span><span class="ident" id="2980390">t</span>&nbsp;<span class="op" id="2980392">*</span><span class="ident" id="2980393">Tree</span><span class="op" id="2980397">)</span>&nbsp;<span class="ident" id="2980399">peek</span><span class="op" id="2980403">(</span><span class="op" id="2980404">)</span>&nbsp;<span class="ident" id="2980406">item</span>&nbsp;<span class="op" id="2980411">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980414">if</span>&nbsp;<span class="ident" id="2980417">t</span><span class="op" id="2980418">.</span><span class="ident" id="2980419">peekCount</span>&nbsp;<span class="op" id="2980429">&gt;</span>&nbsp;<span class="num" id="2980431">0</span>&nbsp;<span class="op" id="2980433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980437">return</span>&nbsp;<span class="ident" id="2980444">t</span><span class="op" id="2980445">.</span><span class="ident" id="2980446">token</span><span class="op" id="2980451">[</span><span class="ident" id="2980452">t</span><span class="op" id="2980453">.</span><span class="ident" id="2980454">peekCount</span><span class="op" id="2980463">-</span><span class="num" id="2980464">1</span><span class="op" id="2980465">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980471">t</span><span class="op" id="2980472">.</span><span class="ident" id="2980473">peekCount</span>&nbsp;<span class="op" id="2980483">=</span>&nbsp;<span class="num" id="2980485">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980488">t</span><span class="op" id="2980489">.</span><span class="ident" id="2980490">token</span><span class="op" id="2980495">[</span><span class="num" id="2980496">0</span><span class="op" id="2980497">]</span>&nbsp;<span class="op" id="2980499">=</span>&nbsp;<span class="ident" id="2980501">t</span><span class="op" id="2980502">.</span><span class="ident" id="2980503">lex</span><span class="op" id="2980506">.</span><span class="ident" id="2980507">nextItem</span><span class="op" id="2980515">(</span><span class="op" id="2980516">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980519">return</span>&nbsp;<span class="ident" id="2980526">t</span><span class="op" id="2980527">.</span><span class="ident" id="2980528">token</span><span class="op" id="2980533">[</span><span class="num" id="2980534">0</span><span class="op" id="2980535">]</span><br>
<span class="lineno"></span><span class="op" id="2980537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2980540">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="2980590">func</span>&nbsp;<span class="op" id="2980595">(</span><span class="ident" id="2980596">t</span>&nbsp;<span class="op" id="2980598">*</span><span class="ident" id="2980599">Tree</span><span class="op" id="2980603">)</span>&nbsp;<span class="ident" id="2980605">nextNonSpace</span><span class="op" id="2980617">(</span><span class="op" id="2980618">)</span>&nbsp;<span class="op" id="2980620">(</span><span class="ident" id="2980621">token</span>&nbsp;<span class="ident" id="2980627">item</span><span class="op" id="2980631">)</span>&nbsp;<span class="op" id="2980633">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980636">for</span>&nbsp;<span class="op" id="2980640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980644">token</span>&nbsp;<span class="op" id="2980650">=</span>&nbsp;<span class="ident" id="2980652">t</span><span class="op" id="2980653">.</span><span class="ident" id="2980654">next</span><span class="op" id="2980658">(</span><span class="op" id="2980659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980663">if</span>&nbsp;<span class="ident" id="2980666">token</span><span class="op" id="2980671">.</span><span class="ident" id="2980672">typ</span>&nbsp;<span class="op" id="2980676">!=</span>&nbsp;<span class="ident" id="2980679">itemSpace</span>&nbsp;<span class="op" id="2980689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980694">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980702">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980708">return</span>&nbsp;<span class="ident" id="2980715">token</span><br>
<span class="lineno"></span><span class="op" id="2980721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2980724">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="2980795">func</span>&nbsp;<span class="op" id="2980800">(</span><span class="ident" id="2980801">t</span>&nbsp;<span class="op" id="2980803">*</span><span class="ident" id="2980804">Tree</span><span class="op" id="2980808">)</span>&nbsp;<span class="ident" id="2980810">peekNonSpace</span><span class="op" id="2980822">(</span><span class="op" id="2980823">)</span>&nbsp;<span class="op" id="2980825">(</span><span class="ident" id="2980826">token</span>&nbsp;<span class="ident" id="2980832">item</span><span class="op" id="2980836">)</span>&nbsp;<span class="op" id="2980838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980841">for</span>&nbsp;<span class="op" id="2980845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980849">token</span>&nbsp;<span class="op" id="2980855">=</span>&nbsp;<span class="ident" id="2980857">t</span><span class="op" id="2980858">.</span><span class="ident" id="2980859">next</span><span class="op" id="2980863">(</span><span class="op" id="2980864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980868">if</span>&nbsp;<span class="ident" id="2980871">token</span><span class="op" id="2980876">.</span><span class="ident" id="2980877">typ</span>&nbsp;<span class="op" id="2980881">!=</span>&nbsp;<span class="ident" id="2980884">itemSpace</span>&nbsp;<span class="op" id="2980894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980899">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2980910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2980913">t</span><span class="op" id="2980914">.</span><span class="ident" id="2980915">backup</span><span class="op" id="2980921">(</span><span class="op" id="2980922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2980925">return</span>&nbsp;<span class="ident" id="2980932">token</span><br>
<span class="lineno"></span><span class="op" id="2980938">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="2980941">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2980954">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="2981009">func</span>&nbsp;<span class="ident" id="2981014">New</span><span class="op" id="2981017">(</span><span class="ident" id="2981018">name</span>&nbsp;<span class="builtintype" id="2981023">string</span><span class="op" id="2981029">,</span>&nbsp;<span class="ident" id="2981031">funcs</span>&nbsp;<span class="op" id="2981037">...</span><span class="keyword" id="2981040">map</span><span class="op" id="2981043">[</span><span class="builtintype" id="2981044">string</span><span class="op" id="2981050">]</span><span class="keyword" id="2981051">interface</span><span class="op" id="2981060">{</span><span class="op" id="2981061">}</span><span class="op" id="2981062">)</span>&nbsp;<span class="op" id="2981064">*</span><span class="ident" id="2981065">Tree</span>&nbsp;<span class="op" id="2981070">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981073">return</span>&nbsp;<span class="op" id="2981080">&amp;</span><span class="ident" id="2981081">Tree</span><span class="op" id="2981085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981089">Name</span><span class="op" id="2981093">:</span>&nbsp;&nbsp;<span class="ident" id="2981096">name</span><span class="op" id="2981100">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981104">funcs</span><span class="op" id="2981109">:</span>&nbsp;<span class="ident" id="2981111">funcs</span><span class="op" id="2981116">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981119">}</span><br>
<span class="lineno"></span><span class="op" id="2981121">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="2981124">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="2981220">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="2981307">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="2981339">func</span>&nbsp;<span class="op" id="2981344">(</span><span class="ident" id="2981345">t</span>&nbsp;<span class="op" id="2981347">*</span><span class="ident" id="2981348">Tree</span><span class="op" id="2981352">)</span>&nbsp;<span class="ident" id="2981354">ErrorContext</span><span class="op" id="2981366">(</span><span class="ident" id="2981367">n</span>&nbsp;<span class="ident" id="2981369">Node</span><span class="op" id="2981373">)</span>&nbsp;<span class="op" id="2981375">(</span><span class="ident" id="2981376">location</span><span class="op" id="2981384">,</span>&nbsp;<span class="ident" id="2981386">context</span>&nbsp;<span class="builtintype" id="2981394">string</span><span class="op" id="2981400">)</span>&nbsp;<span class="op" id="2981402">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981405">pos</span>&nbsp;<span class="op" id="2981409">:=</span>&nbsp;<span class="builtintype" id="2981412">int</span><span class="op" id="2981415">(</span><span class="ident" id="2981416">n</span><span class="op" id="2981417">.</span><span class="ident" id="2981418">Position</span><span class="op" id="2981426">(</span><span class="op" id="2981427">)</span><span class="op" id="2981428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981431">tree</span>&nbsp;<span class="op" id="2981436">:=</span>&nbsp;<span class="ident" id="2981439">n</span><span class="op" id="2981440">.</span><span class="ident" id="2981441">tree</span><span class="op" id="2981445">(</span><span class="op" id="2981446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981449">if</span>&nbsp;<span class="ident" id="2981452">tree</span>&nbsp;<span class="op" id="2981457">==</span>&nbsp;<span class="ident" id="2981460">nil</span>&nbsp;<span class="op" id="2981464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981468">tree</span>&nbsp;<span class="op" id="2981473">=</span>&nbsp;<span class="ident" id="2981475">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981478">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981481">text</span>&nbsp;<span class="op" id="2981486">:=</span>&nbsp;<span class="ident" id="2981489">tree</span><span class="op" id="2981493">.</span><span class="ident" id="2981494">text</span><span class="op" id="2981498">[</span><span class="op" id="2981499">:</span><span class="ident" id="2981500">pos</span><span class="op" id="2981503">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981506">byteNum</span>&nbsp;<span class="op" id="2981514">:=</span>&nbsp;<span class="ident" id="2981517">strings</span><span class="op" id="2981524">.</span><span class="ident" id="2981525">LastIndex</span><span class="op" id="2981534">(</span><span class="ident" id="2981535">text</span><span class="op" id="2981539">,</span>&nbsp;<span class="string" id="2981541">&#34;\n&#34;</span><span class="op" id="2981545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981548">if</span>&nbsp;<span class="ident" id="2981551">byteNum</span>&nbsp;<span class="op" id="2981559">==</span>&nbsp;<span class="op" id="2981562">-</span><span class="num" id="2981563">1</span>&nbsp;<span class="op" id="2981565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981569">byteNum</span>&nbsp;<span class="op" id="2981577">=</span>&nbsp;<span class="ident" id="2981579">pos</span>&nbsp;<span class="comment" id="2981583">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981602">}</span>&nbsp;<span class="keyword" id="2981604">else</span>&nbsp;<span class="op" id="2981609">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981613">byteNum</span><span class="op" id="2981620">++</span>&nbsp;<span class="comment" id="2981623">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981647">byteNum</span>&nbsp;<span class="op" id="2981655">=</span>&nbsp;<span class="ident" id="2981657">pos</span>&nbsp;<span class="op" id="2981661">-</span>&nbsp;<span class="ident" id="2981663">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981675">lineNum</span>&nbsp;<span class="op" id="2981683">:=</span>&nbsp;<span class="num" id="2981686">1</span>&nbsp;<span class="op" id="2981688">+</span>&nbsp;<span class="ident" id="2981690">strings</span><span class="op" id="2981697">.</span><span class="ident" id="2981698">Count</span><span class="op" id="2981703">(</span><span class="ident" id="2981704">text</span><span class="op" id="2981708">,</span>&nbsp;<span class="string" id="2981710">&#34;\n&#34;</span><span class="op" id="2981714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981717">context</span>&nbsp;<span class="op" id="2981725">=</span>&nbsp;<span class="ident" id="2981727">n</span><span class="op" id="2981728">.</span><span class="ident" id="2981729">String</span><span class="op" id="2981735">(</span><span class="op" id="2981736">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981739">if</span>&nbsp;<span class="builtinfunc" id="2981742">len</span><span class="op" id="2981745">(</span><span class="ident" id="2981746">context</span><span class="op" id="2981753">)</span>&nbsp;<span class="op" id="2981755">&gt;</span>&nbsp;<span class="num" id="2981757">20</span>&nbsp;<span class="op" id="2981760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2981764">context</span>&nbsp;<span class="op" id="2981772">=</span>&nbsp;<span class="ident" id="2981774">fmt</span><span class="op" id="2981777">.</span><span class="ident" id="2981778">Sprintf</span><span class="op" id="2981785">(</span><span class="string" id="2981786">&#34;%.20s...&#34;</span><span class="op" id="2981796">,</span>&nbsp;<span class="ident" id="2981798">context</span><span class="op" id="2981805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2981808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2981811">return</span>&nbsp;<span class="ident" id="2981818">fmt</span><span class="op" id="2981821">.</span><span class="ident" id="2981822">Sprintf</span><span class="op" id="2981829">(</span><span class="string" id="2981830">&#34;%s:%d:%d&#34;</span><span class="op" id="2981840">,</span>&nbsp;<span class="ident" id="2981842">tree</span><span class="op" id="2981846">.</span><span class="ident" id="2981847">ParseName</span><span class="op" id="2981856">,</span>&nbsp;<span class="ident" id="2981858">lineNum</span><span class="op" id="2981865">,</span>&nbsp;<span class="ident" id="2981867">byteNum</span><span class="op" id="2981874">)</span><span class="op" id="2981875">,</span>&nbsp;<span class="ident" id="2981877">context</span><br>
<span class="lineno"></span><span class="op" id="2981885">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="2981888">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="2981943">func</span>&nbsp;<span class="op" id="2981948">(</span><span class="ident" id="2981949">t</span>&nbsp;<span class="op" id="2981951">*</span><span class="ident" id="2981952">Tree</span><span class="op" id="2981956">)</span>&nbsp;<span class="ident" id="2981958">errorf</span><span class="op" id="2981964">(</span><span class="ident" id="2981965">format</span>&nbsp;<span class="builtintype" id="2981972">string</span><span class="op" id="2981978">,</span>&nbsp;<span class="ident" id="2981980">args</span>&nbsp;<span class="op" id="2981985">...</span><span class="keyword" id="2981988">interface</span><span class="op" id="2981997">{</span><span class="op" id="2981998">}</span><span class="op" id="2981999">)</span>&nbsp;<span class="op" id="2982001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982004">t</span><span class="op" id="2982005">.</span><span class="ident" id="2982006">Root</span>&nbsp;<span class="op" id="2982011">=</span>&nbsp;<span class="ident" id="2982013">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982018">format</span>&nbsp;<span class="op" id="2982025">=</span>&nbsp;<span class="ident" id="2982027">fmt</span><span class="op" id="2982030">.</span><span class="ident" id="2982031">Sprintf</span><span class="op" id="2982038">(</span><span class="string" id="2982039">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="2982060">,</span>&nbsp;<span class="ident" id="2982062">t</span><span class="op" id="2982063">.</span><span class="ident" id="2982064">ParseName</span><span class="op" id="2982073">,</span>&nbsp;<span class="ident" id="2982075">t</span><span class="op" id="2982076">.</span><span class="ident" id="2982077">lex</span><span class="op" id="2982080">.</span><span class="ident" id="2982081">lineNumber</span><span class="op" id="2982091">(</span><span class="op" id="2982092">)</span><span class="op" id="2982093">,</span>&nbsp;<span class="ident" id="2982095">format</span><span class="op" id="2982101">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2982104">panic</span><span class="op" id="2982109">(</span><span class="ident" id="2982110">fmt</span><span class="op" id="2982113">.</span><span class="ident" id="2982114">Errorf</span><span class="op" id="2982120">(</span><span class="ident" id="2982121">format</span><span class="op" id="2982127">,</span>&nbsp;<span class="ident" id="2982129">args</span><span class="op" id="2982133">...</span><span class="op" id="2982136">)</span><span class="op" id="2982137">)</span><br>
<span class="lineno"></span><span class="op" id="2982139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2982142">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="2982174">func</span>&nbsp;<span class="op" id="2982179">(</span><span class="ident" id="2982180">t</span>&nbsp;<span class="op" id="2982182">*</span><span class="ident" id="2982183">Tree</span><span class="op" id="2982187">)</span>&nbsp;<span class="builtintype" id="2982189">error</span><span class="op" id="2982194">(</span><span class="ident" id="2982195">err</span>&nbsp;<span class="builtintype" id="2982199">error</span><span class="op" id="2982204">)</span>&nbsp;<span class="op" id="2982206">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982209">t</span><span class="op" id="2982210">.</span><span class="ident" id="2982211">errorf</span><span class="op" id="2982217">(</span><span class="string" id="2982218">&#34;%s&#34;</span><span class="op" id="2982222">,</span>&nbsp;<span class="ident" id="2982224">err</span><span class="op" id="2982227">)</span><br>
<span class="lineno"></span><span class="op" id="2982229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2982232">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="2982307">func</span>&nbsp;<span class="op" id="2982312">(</span><span class="ident" id="2982313">t</span>&nbsp;<span class="op" id="2982315">*</span><span class="ident" id="2982316">Tree</span><span class="op" id="2982320">)</span>&nbsp;<span class="ident" id="2982322">expect</span><span class="op" id="2982328">(</span><span class="ident" id="2982329">expected</span>&nbsp;<span class="ident" id="2982338">itemType</span><span class="op" id="2982346">,</span>&nbsp;<span class="ident" id="2982348">context</span>&nbsp;<span class="builtintype" id="2982356">string</span><span class="op" id="2982362">)</span>&nbsp;<span class="ident" id="2982364">item</span>&nbsp;<span class="op" id="2982369">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982372">token</span>&nbsp;<span class="op" id="2982378">:=</span>&nbsp;<span class="ident" id="2982381">t</span><span class="op" id="2982382">.</span><span class="ident" id="2982383">nextNonSpace</span><span class="op" id="2982395">(</span><span class="op" id="2982396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982399">if</span>&nbsp;<span class="ident" id="2982402">token</span><span class="op" id="2982407">.</span><span class="ident" id="2982408">typ</span>&nbsp;<span class="op" id="2982412">!=</span>&nbsp;<span class="ident" id="2982415">expected</span>&nbsp;<span class="op" id="2982424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982428">t</span><span class="op" id="2982429">.</span><span class="ident" id="2982430">unexpected</span><span class="op" id="2982440">(</span><span class="ident" id="2982441">token</span><span class="op" id="2982446">,</span>&nbsp;<span class="ident" id="2982448">context</span><span class="op" id="2982455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2982458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982461">return</span>&nbsp;<span class="ident" id="2982468">token</span><br>
<span class="lineno">175</span><span class="op" id="2982474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2982477">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="2982565">func</span>&nbsp;<span class="op" id="2982570">(</span><span class="ident" id="2982571">t</span>&nbsp;<span class="op" id="2982573">*</span><span class="ident" id="2982574">Tree</span><span class="op" id="2982578">)</span>&nbsp;<span class="ident" id="2982580">expectOneOf</span><span class="op" id="2982591">(</span><span class="ident" id="2982592">expected1</span><span class="op" id="2982601">,</span>&nbsp;<span class="ident" id="2982603">expected2</span>&nbsp;<span class="ident" id="2982613">itemType</span><span class="op" id="2982621">,</span>&nbsp;<span class="ident" id="2982623">context</span>&nbsp;<span class="builtintype" id="2982631">string</span><span class="op" id="2982637">)</span>&nbsp;<span class="ident" id="2982639">item</span>&nbsp;<span class="op" id="2982644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982647">token</span>&nbsp;<span class="op" id="2982653">:=</span>&nbsp;<span class="ident" id="2982656">t</span><span class="op" id="2982657">.</span><span class="ident" id="2982658">nextNonSpace</span><span class="op" id="2982670">(</span><span class="op" id="2982671">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982674">if</span>&nbsp;<span class="ident" id="2982677">token</span><span class="op" id="2982682">.</span><span class="ident" id="2982683">typ</span>&nbsp;<span class="op" id="2982687">!=</span>&nbsp;<span class="ident" id="2982690">expected1</span>&nbsp;<span class="op" id="2982700">&amp;&amp;</span>&nbsp;<span class="ident" id="2982703">token</span><span class="op" id="2982708">.</span><span class="ident" id="2982709">typ</span>&nbsp;<span class="op" id="2982713">!=</span>&nbsp;<span class="ident" id="2982716">expected2</span>&nbsp;<span class="op" id="2982726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982730">t</span><span class="op" id="2982731">.</span><span class="ident" id="2982732">unexpected</span><span class="op" id="2982742">(</span><span class="ident" id="2982743">token</span><span class="op" id="2982748">,</span>&nbsp;<span class="ident" id="2982750">context</span><span class="op" id="2982757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2982760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2982763">return</span>&nbsp;<span class="ident" id="2982770">token</span><br>
<span class="lineno"></span><span class="op" id="2982776">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="2982779">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="2982846">func</span>&nbsp;<span class="op" id="2982851">(</span><span class="ident" id="2982852">t</span>&nbsp;<span class="op" id="2982854">*</span><span class="ident" id="2982855">Tree</span><span class="op" id="2982859">)</span>&nbsp;<span class="ident" id="2982861">unexpected</span><span class="op" id="2982871">(</span><span class="ident" id="2982872">token</span>&nbsp;<span class="ident" id="2982878">item</span><span class="op" id="2982882">,</span>&nbsp;<span class="ident" id="2982884">context</span>&nbsp;<span class="builtintype" id="2982892">string</span><span class="op" id="2982898">)</span>&nbsp;<span class="op" id="2982900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2982903">t</span><span class="op" id="2982904">.</span><span class="ident" id="2982905">errorf</span><span class="op" id="2982911">(</span><span class="string" id="2982912">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="2982933">,</span>&nbsp;<span class="ident" id="2982935">token</span><span class="op" id="2982940">,</span>&nbsp;<span class="ident" id="2982942">context</span><span class="op" id="2982949">)</span><br>
<span class="lineno"></span><span class="op" id="2982951">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="2982954">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="2983040">func</span>&nbsp;<span class="op" id="2983045">(</span><span class="ident" id="2983046">t</span>&nbsp;<span class="op" id="2983048">*</span><span class="ident" id="2983049">Tree</span><span class="op" id="2983053">)</span>&nbsp;<span class="builtinfunc" id="2983055">recover</span><span class="op" id="2983062">(</span><span class="ident" id="2983063">errp</span>&nbsp;<span class="op" id="2983068">*</span><span class="builtintype" id="2983069">error</span><span class="op" id="2983074">)</span>&nbsp;<span class="op" id="2983076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983079">e</span>&nbsp;<span class="op" id="2983081">:=</span>&nbsp;<span class="builtinfunc" id="2983084">recover</span><span class="op" id="2983091">(</span><span class="op" id="2983092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983095">if</span>&nbsp;<span class="ident" id="2983098">e</span>&nbsp;<span class="op" id="2983100">!=</span>&nbsp;<span class="ident" id="2983103">nil</span>&nbsp;<span class="op" id="2983107">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983111">if</span>&nbsp;<span class="ident" id="2983114">_</span><span class="op" id="2983115">,</span>&nbsp;<span class="ident" id="2983117">ok</span>&nbsp;<span class="op" id="2983120">:=</span>&nbsp;<span class="ident" id="2983123">e</span><span class="op" id="2983124">.</span><span class="op" id="2983125">(</span><span class="ident" id="2983126">runtime</span><span class="op" id="2983133">.</span><span class="ident" id="2983134">Error</span><span class="op" id="2983139">)</span><span class="op" id="2983140">;</span>&nbsp;<span class="ident" id="2983142">ok</span>&nbsp;<span class="op" id="2983145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2983150">panic</span><span class="op" id="2983155">(</span><span class="ident" id="2983156">e</span><span class="op" id="2983157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2983161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983165">if</span>&nbsp;<span class="ident" id="2983168">t</span>&nbsp;<span class="op" id="2983170">!=</span>&nbsp;<span class="ident" id="2983173">nil</span>&nbsp;<span class="op" id="2983177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983182">t</span><span class="op" id="2983183">.</span><span class="ident" id="2983184">stopParse</span><span class="op" id="2983193">(</span><span class="op" id="2983194">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2983198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2983202">*</span><span class="ident" id="2983203">errp</span>&nbsp;<span class="op" id="2983208">=</span>&nbsp;<span class="ident" id="2983210">e</span><span class="op" id="2983211">.</span><span class="op" id="2983212">(</span><span class="builtintype" id="2983213">error</span><span class="op" id="2983218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2983221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983224">return</span><br>
<span class="lineno"></span><span class="op" id="2983231">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="2983234">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="2983289">func</span>&nbsp;<span class="op" id="2983294">(</span><span class="ident" id="2983295">t</span>&nbsp;<span class="op" id="2983297">*</span><span class="ident" id="2983298">Tree</span><span class="op" id="2983302">)</span>&nbsp;<span class="ident" id="2983304">startParse</span><span class="op" id="2983314">(</span><span class="ident" id="2983315">funcs</span>&nbsp;<span class="op" id="2983321">[</span><span class="op" id="2983322">]</span><span class="keyword" id="2983323">map</span><span class="op" id="2983326">[</span><span class="builtintype" id="2983327">string</span><span class="op" id="2983333">]</span><span class="keyword" id="2983334">interface</span><span class="op" id="2983343">{</span><span class="op" id="2983344">}</span><span class="op" id="2983345">,</span>&nbsp;<span class="ident" id="2983347">lex</span>&nbsp;<span class="op" id="2983351">*</span><span class="ident" id="2983352">lexer</span><span class="op" id="2983357">)</span>&nbsp;<span class="op" id="2983359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983362">t</span><span class="op" id="2983363">.</span><span class="ident" id="2983364">Root</span>&nbsp;<span class="op" id="2983369">=</span>&nbsp;<span class="ident" id="2983371">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983376">t</span><span class="op" id="2983377">.</span><span class="ident" id="2983378">lex</span>&nbsp;<span class="op" id="2983382">=</span>&nbsp;<span class="ident" id="2983384">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983389">t</span><span class="op" id="2983390">.</span><span class="ident" id="2983391">vars</span>&nbsp;<span class="op" id="2983396">=</span>&nbsp;<span class="op" id="2983398">[</span><span class="op" id="2983399">]</span><span class="builtintype" id="2983400">string</span><span class="op" id="2983406">{</span><span class="string" id="2983407">&#34;$&#34;</span><span class="op" id="2983410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983413">t</span><span class="op" id="2983414">.</span><span class="ident" id="2983415">funcs</span>&nbsp;<span class="op" id="2983421">=</span>&nbsp;<span class="ident" id="2983423">funcs</span><br>
<span class="lineno"></span><span class="op" id="2983429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2983432">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="2983465">func</span>&nbsp;<span class="op" id="2983470">(</span><span class="ident" id="2983471">t</span>&nbsp;<span class="op" id="2983473">*</span><span class="ident" id="2983474">Tree</span><span class="op" id="2983478">)</span>&nbsp;<span class="ident" id="2983480">stopParse</span><span class="op" id="2983489">(</span><span class="op" id="2983490">)</span>&nbsp;<span class="op" id="2983492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983495">t</span><span class="op" id="2983496">.</span><span class="ident" id="2983497">lex</span>&nbsp;<span class="op" id="2983501">=</span>&nbsp;<span class="ident" id="2983503">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983508">t</span><span class="op" id="2983509">.</span><span class="ident" id="2983510">vars</span>&nbsp;<span class="op" id="2983515">=</span>&nbsp;<span class="ident" id="2983517">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983522">t</span><span class="op" id="2983523">.</span><span class="ident" id="2983524">funcs</span>&nbsp;<span class="op" id="2983530">=</span>&nbsp;<span class="ident" id="2983532">nil</span><br>
<span class="lineno"></span><span class="op" id="2983536">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="2983539">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2983619">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2983698">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2983776">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="2983796">func</span>&nbsp;<span class="op" id="2983801">(</span><span class="ident" id="2983802">t</span>&nbsp;<span class="op" id="2983804">*</span><span class="ident" id="2983805">Tree</span><span class="op" id="2983809">)</span>&nbsp;<span class="ident" id="2983811">Parse</span><span class="op" id="2983816">(</span><span class="ident" id="2983817">text</span><span class="op" id="2983821">,</span>&nbsp;<span class="ident" id="2983823">leftDelim</span><span class="op" id="2983832">,</span>&nbsp;<span class="ident" id="2983834">rightDelim</span>&nbsp;<span class="builtintype" id="2983845">string</span><span class="op" id="2983851">,</span>&nbsp;<span class="ident" id="2983853">treeSet</span>&nbsp;<span class="keyword" id="2983861">map</span><span class="op" id="2983864">[</span><span class="builtintype" id="2983865">string</span><span class="op" id="2983871">]</span><span class="op" id="2983872">*</span><span class="ident" id="2983873">Tree</span><span class="op" id="2983877">,</span>&nbsp;<span class="ident" id="2983879">funcs</span>&nbsp;<span class="op" id="2983885">...</span><span class="keyword" id="2983888">map</span><span class="op" id="2983891">[</span><span class="builtintype" id="2983892">string</span><span class="op" id="2983898">]</span><span class="keyword" id="2983899">interface</span><span class="op" id="2983908">{</span><span class="op" id="2983909">}</span><span class="op" id="2983910">)</span>&nbsp;<span class="op" id="2983912">(</span><span class="ident" id="2983913">tree</span>&nbsp;<span class="op" id="2983918">*</span><span class="ident" id="2983919">Tree</span><span class="op" id="2983923">,</span>&nbsp;<span class="ident" id="2983925">err</span>&nbsp;<span class="builtintype" id="2983929">error</span><span class="op" id="2983934">)</span>&nbsp;<span class="op" id="2983936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2983939">defer</span>&nbsp;<span class="ident" id="2983945">t</span><span class="op" id="2983946">.</span><span class="builtinfunc" id="2983947">recover</span><span class="op" id="2983954">(</span><span class="op" id="2983955">&amp;</span><span class="ident" id="2983956">err</span><span class="op" id="2983959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983962">t</span><span class="op" id="2983963">.</span><span class="ident" id="2983964">ParseName</span>&nbsp;<span class="op" id="2983974">=</span>&nbsp;<span class="ident" id="2983976">t</span><span class="op" id="2983977">.</span><span class="ident" id="2983978">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2983984">t</span><span class="op" id="2983985">.</span><span class="ident" id="2983986">startParse</span><span class="op" id="2983996">(</span><span class="ident" id="2983997">funcs</span><span class="op" id="2984002">,</span>&nbsp;<span class="ident" id="2984004">lex</span><span class="op" id="2984007">(</span><span class="ident" id="2984008">t</span><span class="op" id="2984009">.</span><span class="ident" id="2984010">Name</span><span class="op" id="2984014">,</span>&nbsp;<span class="ident" id="2984016">text</span><span class="op" id="2984020">,</span>&nbsp;<span class="ident" id="2984022">leftDelim</span><span class="op" id="2984031">,</span>&nbsp;<span class="ident" id="2984033">rightDelim</span><span class="op" id="2984043">)</span><span class="op" id="2984044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2984047">t</span><span class="op" id="2984048">.</span><span class="ident" id="2984049">text</span>&nbsp;<span class="op" id="2984054">=</span>&nbsp;<span class="ident" id="2984056">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2984062">t</span><span class="op" id="2984063">.</span><span class="ident" id="2984064">parse</span><span class="op" id="2984069">(</span><span class="ident" id="2984070">treeSet</span><span class="op" id="2984077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2984080">t</span><span class="op" id="2984081">.</span><span class="ident" id="2984082">add</span><span class="op" id="2984085">(</span><span class="ident" id="2984086">treeSet</span><span class="op" id="2984093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2984096">t</span><span class="op" id="2984097">.</span><span class="ident" id="2984098">stopParse</span><span class="op" id="2984107">(</span><span class="op" id="2984108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984111">return</span>&nbsp;<span class="ident" id="2984118">t</span><span class="op" id="2984119">,</span>&nbsp;<span class="ident" id="2984121">nil</span><br>
<span class="lineno"></span><span class="op" id="2984125">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="2984128">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="2984161">func</span>&nbsp;<span class="op" id="2984166">(</span><span class="ident" id="2984167">t</span>&nbsp;<span class="op" id="2984169">*</span><span class="ident" id="2984170">Tree</span><span class="op" id="2984174">)</span>&nbsp;<span class="ident" id="2984176">add</span><span class="op" id="2984179">(</span><span class="ident" id="2984180">treeSet</span>&nbsp;<span class="keyword" id="2984188">map</span><span class="op" id="2984191">[</span><span class="builtintype" id="2984192">string</span><span class="op" id="2984198">]</span><span class="op" id="2984199">*</span><span class="ident" id="2984200">Tree</span><span class="op" id="2984204">)</span>&nbsp;<span class="op" id="2984206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2984209">tree</span>&nbsp;<span class="op" id="2984214">:=</span>&nbsp;<span class="ident" id="2984217">treeSet</span><span class="op" id="2984224">[</span><span class="ident" id="2984225">t</span><span class="op" id="2984226">.</span><span class="ident" id="2984227">Name</span><span class="op" id="2984231">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984234">if</span>&nbsp;<span class="ident" id="2984237">tree</span>&nbsp;<span class="op" id="2984242">==</span>&nbsp;<span class="ident" id="2984245">nil</span>&nbsp;<span class="op" id="2984249">||</span>&nbsp;<span class="ident" id="2984252">IsEmptyTree</span><span class="op" id="2984263">(</span><span class="ident" id="2984264">tree</span><span class="op" id="2984268">.</span><span class="ident" id="2984269">Root</span><span class="op" id="2984273">)</span>&nbsp;<span class="op" id="2984275">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2984279">treeSet</span><span class="op" id="2984286">[</span><span class="ident" id="2984287">t</span><span class="op" id="2984288">.</span><span class="ident" id="2984289">Name</span><span class="op" id="2984293">]</span>&nbsp;<span class="op" id="2984295">=</span>&nbsp;<span class="ident" id="2984297">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984301">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2984309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984312">if</span>&nbsp;<span class="op" id="2984315">!</span><span class="ident" id="2984316">IsEmptyTree</span><span class="op" id="2984327">(</span><span class="ident" id="2984328">t</span><span class="op" id="2984329">.</span><span class="ident" id="2984330">Root</span><span class="op" id="2984334">)</span>&nbsp;<span class="op" id="2984336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2984340">t</span><span class="op" id="2984341">.</span><span class="ident" id="2984342">errorf</span><span class="op" id="2984348">(</span><span class="string" id="2984349">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="2984395">,</span>&nbsp;<span class="ident" id="2984397">t</span><span class="op" id="2984398">.</span><span class="ident" id="2984399">Name</span><span class="op" id="2984403">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2984406">}</span><br>
<span class="lineno"></span><span class="op" id="2984408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2984411">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="2984493">func</span>&nbsp;<span class="ident" id="2984498">IsEmptyTree</span><span class="op" id="2984509">(</span><span class="ident" id="2984510">n</span>&nbsp;<span class="ident" id="2984512">Node</span><span class="op" id="2984516">)</span>&nbsp;<span class="builtintype" id="2984518">bool</span>&nbsp;<span class="op" id="2984523">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984526">switch</span>&nbsp;<span class="ident" id="2984533">n</span>&nbsp;<span class="op" id="2984535">:=</span>&nbsp;<span class="ident" id="2984538">n</span><span class="op" id="2984539">.</span><span class="op" id="2984540">(</span><span class="keyword" id="2984541">type</span><span class="op" id="2984545">)</span>&nbsp;<span class="op" id="2984547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984550">case</span>&nbsp;<span class="ident" id="2984555">nil</span><span class="op" id="2984558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984562">return</span>&nbsp;<span class="builtintype" id="2984569">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984575">case</span>&nbsp;<span class="op" id="2984580">*</span><span class="ident" id="2984581">ActionNode</span><span class="op" id="2984591">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984594">case</span>&nbsp;<span class="op" id="2984599">*</span><span class="ident" id="2984600">IfNode</span><span class="op" id="2984606">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984609">case</span>&nbsp;<span class="op" id="2984614">*</span><span class="ident" id="2984615">ListNode</span><span class="op" id="2984623">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984627">for</span>&nbsp;<span class="ident" id="2984631">_</span><span class="op" id="2984632">,</span>&nbsp;<span class="ident" id="2984634">node</span>&nbsp;<span class="op" id="2984639">:=</span>&nbsp;<span class="keyword" id="2984642">range</span>&nbsp;<span class="ident" id="2984648">n</span><span class="op" id="2984649">.</span><span class="ident" id="2984650">Nodes</span>&nbsp;<span class="op" id="2984656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984661">if</span>&nbsp;<span class="op" id="2984664">!</span><span class="ident" id="2984665">IsEmptyTree</span><span class="op" id="2984676">(</span><span class="ident" id="2984677">node</span><span class="op" id="2984681">)</span>&nbsp;<span class="op" id="2984683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984689">return</span>&nbsp;<span class="builtintype" id="2984696">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2984705">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2984709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984713">return</span>&nbsp;<span class="builtintype" id="2984720">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984726">case</span>&nbsp;<span class="op" id="2984731">*</span><span class="ident" id="2984732">RangeNode</span><span class="op" id="2984741">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984744">case</span>&nbsp;<span class="op" id="2984749">*</span><span class="ident" id="2984750">TemplateNode</span><span class="op" id="2984762">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984765">case</span>&nbsp;<span class="op" id="2984770">*</span><span class="ident" id="2984771">TextNode</span><span class="op" id="2984779">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984783">return</span>&nbsp;<span class="builtinfunc" id="2984790">len</span><span class="op" id="2984793">(</span><span class="ident" id="2984794">bytes</span><span class="op" id="2984799">.</span><span class="ident" id="2984800">TrimSpace</span><span class="op" id="2984809">(</span><span class="ident" id="2984810">n</span><span class="op" id="2984811">.</span><span class="ident" id="2984812">Text</span><span class="op" id="2984816">)</span><span class="op" id="2984817">)</span>&nbsp;<span class="op" id="2984819">==</span>&nbsp;<span class="num" id="2984822">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984825">case</span>&nbsp;<span class="op" id="2984830">*</span><span class="ident" id="2984831">WithNode</span><span class="op" id="2984839">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984842">default</span><span class="op" id="2984849">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2984853">panic</span><span class="op" id="2984858">(</span><span class="string" id="2984859">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="2984876">+</span>&nbsp;<span class="ident" id="2984878">n</span><span class="op" id="2984879">.</span><span class="ident" id="2984880">String</span><span class="op" id="2984886">(</span><span class="op" id="2984887">)</span><span class="op" id="2984888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2984891">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2984894">return</span>&nbsp;<span class="builtintype" id="2984901">false</span><br>
<span class="lineno"></span><span class="op" id="2984907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2984910">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="2984980">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="2985037">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="2985056">func</span>&nbsp;<span class="op" id="2985061">(</span><span class="ident" id="2985062">t</span>&nbsp;<span class="op" id="2985064">*</span><span class="ident" id="2985065">Tree</span><span class="op" id="2985069">)</span>&nbsp;<span class="ident" id="2985071">parse</span><span class="op" id="2985076">(</span><span class="ident" id="2985077">treeSet</span>&nbsp;<span class="keyword" id="2985085">map</span><span class="op" id="2985088">[</span><span class="builtintype" id="2985089">string</span><span class="op" id="2985095">]</span><span class="op" id="2985096">*</span><span class="ident" id="2985097">Tree</span><span class="op" id="2985101">)</span>&nbsp;<span class="op" id="2985103">(</span><span class="ident" id="2985104">next</span>&nbsp;<span class="ident" id="2985109">Node</span><span class="op" id="2985113">)</span>&nbsp;<span class="op" id="2985115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985118">t</span><span class="op" id="2985119">.</span><span class="ident" id="2985120">Root</span>&nbsp;<span class="op" id="2985125">=</span>&nbsp;<span class="ident" id="2985127">t</span><span class="op" id="2985128">.</span><span class="ident" id="2985129">newList</span><span class="op" id="2985136">(</span><span class="ident" id="2985137">t</span><span class="op" id="2985138">.</span><span class="ident" id="2985139">peek</span><span class="op" id="2985143">(</span><span class="op" id="2985144">)</span><span class="op" id="2985145">.</span><span class="ident" id="2985146">pos</span><span class="op" id="2985149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985152">for</span>&nbsp;<span class="ident" id="2985156">t</span><span class="op" id="2985157">.</span><span class="ident" id="2985158">peek</span><span class="op" id="2985162">(</span><span class="op" id="2985163">)</span><span class="op" id="2985164">.</span><span class="ident" id="2985165">typ</span>&nbsp;<span class="op" id="2985169">!=</span>&nbsp;<span class="ident" id="2985172">itemEOF</span>&nbsp;<span class="op" id="2985180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985184">if</span>&nbsp;<span class="ident" id="2985187">t</span><span class="op" id="2985188">.</span><span class="ident" id="2985189">peek</span><span class="op" id="2985193">(</span><span class="op" id="2985194">)</span><span class="op" id="2985195">.</span><span class="ident" id="2985196">typ</span>&nbsp;<span class="op" id="2985200">==</span>&nbsp;<span class="ident" id="2985203">itemLeftDelim</span>&nbsp;<span class="op" id="2985217">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985222">delim</span>&nbsp;<span class="op" id="2985228">:=</span>&nbsp;<span class="ident" id="2985231">t</span><span class="op" id="2985232">.</span><span class="ident" id="2985233">next</span><span class="op" id="2985237">(</span><span class="op" id="2985238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985243">if</span>&nbsp;<span class="ident" id="2985246">t</span><span class="op" id="2985247">.</span><span class="ident" id="2985248">nextNonSpace</span><span class="op" id="2985260">(</span><span class="op" id="2985261">)</span><span class="op" id="2985262">.</span><span class="ident" id="2985263">typ</span>&nbsp;<span class="op" id="2985267">==</span>&nbsp;<span class="ident" id="2985270">itemDefine</span>&nbsp;<span class="op" id="2985281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985287">newT</span>&nbsp;<span class="op" id="2985292">:=</span>&nbsp;<span class="ident" id="2985295">New</span><span class="op" id="2985298">(</span><span class="string" id="2985299">&#34;definition&#34;</span><span class="op" id="2985311">)</span>&nbsp;<span class="comment" id="2985313">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985358">newT</span><span class="op" id="2985362">.</span><span class="ident" id="2985363">text</span>&nbsp;<span class="op" id="2985368">=</span>&nbsp;<span class="ident" id="2985370">t</span><span class="op" id="2985371">.</span><span class="ident" id="2985372">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985381">newT</span><span class="op" id="2985385">.</span><span class="ident" id="2985386">ParseName</span>&nbsp;<span class="op" id="2985396">=</span>&nbsp;<span class="ident" id="2985398">t</span><span class="op" id="2985399">.</span><span class="ident" id="2985400">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985414">newT</span><span class="op" id="2985418">.</span><span class="ident" id="2985419">startParse</span><span class="op" id="2985429">(</span><span class="ident" id="2985430">t</span><span class="op" id="2985431">.</span><span class="ident" id="2985432">funcs</span><span class="op" id="2985437">,</span>&nbsp;<span class="ident" id="2985439">t</span><span class="op" id="2985440">.</span><span class="ident" id="2985441">lex</span><span class="op" id="2985444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985450">newT</span><span class="op" id="2985454">.</span><span class="ident" id="2985455">parseDefinition</span><span class="op" id="2985470">(</span><span class="ident" id="2985471">treeSet</span><span class="op" id="2985478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985484">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2985496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985501">t</span><span class="op" id="2985502">.</span><span class="ident" id="2985503">backup2</span><span class="op" id="2985510">(</span><span class="ident" id="2985511">delim</span><span class="op" id="2985516">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2985520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985524">n</span>&nbsp;<span class="op" id="2985526">:=</span>&nbsp;<span class="ident" id="2985529">t</span><span class="op" id="2985530">.</span><span class="ident" id="2985531">textOrAction</span><span class="op" id="2985543">(</span><span class="op" id="2985544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985548">if</span>&nbsp;<span class="ident" id="2985551">n</span><span class="op" id="2985552">.</span><span class="ident" id="2985553">Type</span><span class="op" id="2985557">(</span><span class="op" id="2985558">)</span>&nbsp;<span class="op" id="2985560">==</span>&nbsp;<span class="ident" id="2985563">nodeEnd</span>&nbsp;<span class="op" id="2985571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985576">t</span><span class="op" id="2985577">.</span><span class="ident" id="2985578">errorf</span><span class="op" id="2985584">(</span><span class="string" id="2985585">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="2985600">,</span>&nbsp;<span class="ident" id="2985602">n</span><span class="op" id="2985603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2985607">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985611">t</span><span class="op" id="2985612">.</span><span class="ident" id="2985613">Root</span><span class="op" id="2985617">.</span><span class="builtinfunc" id="2985618">append</span><span class="op" id="2985624">(</span><span class="ident" id="2985625">n</span><span class="op" id="2985626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2985629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985632">return</span>&nbsp;<span class="ident" id="2985639">nil</span><br>
<span class="lineno"></span><span class="op" id="2985643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="2985646">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="2985722">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="2985803">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="2985820">func</span>&nbsp;<span class="op" id="2985825">(</span><span class="ident" id="2985826">t</span>&nbsp;<span class="op" id="2985828">*</span><span class="ident" id="2985829">Tree</span><span class="op" id="2985833">)</span>&nbsp;<span class="ident" id="2985835">parseDefinition</span><span class="op" id="2985850">(</span><span class="ident" id="2985851">treeSet</span>&nbsp;<span class="keyword" id="2985859">map</span><span class="op" id="2985862">[</span><span class="builtintype" id="2985863">string</span><span class="op" id="2985869">]</span><span class="op" id="2985870">*</span><span class="ident" id="2985871">Tree</span><span class="op" id="2985875">)</span>&nbsp;<span class="op" id="2985877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985880">const</span>&nbsp;<span class="ident" id="2985886">context</span>&nbsp;<span class="op" id="2985894">=</span>&nbsp;<span class="string" id="2985896">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985913">name</span>&nbsp;<span class="op" id="2985918">:=</span>&nbsp;<span class="ident" id="2985921">t</span><span class="op" id="2985922">.</span><span class="ident" id="2985923">expectOneOf</span><span class="op" id="2985934">(</span><span class="ident" id="2985935">itemString</span><span class="op" id="2985945">,</span>&nbsp;<span class="ident" id="2985947">itemRawString</span><span class="op" id="2985960">,</span>&nbsp;<span class="ident" id="2985962">context</span><span class="op" id="2985969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2985972">var</span>&nbsp;<span class="ident" id="2985976">err</span>&nbsp;<span class="builtintype" id="2985980">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2985987">t</span><span class="op" id="2985988">.</span><span class="ident" id="2985989">Name</span><span class="op" id="2985993">,</span>&nbsp;<span class="ident" id="2985995">err</span>&nbsp;<span class="op" id="2985999">=</span>&nbsp;<span class="ident" id="2986001">strconv</span><span class="op" id="2986008">.</span><span class="ident" id="2986009">Unquote</span><span class="op" id="2986016">(</span><span class="ident" id="2986017">name</span><span class="op" id="2986021">.</span><span class="ident" id="2986022">val</span><span class="op" id="2986025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986028">if</span>&nbsp;<span class="ident" id="2986031">err</span>&nbsp;<span class="op" id="2986035">!=</span>&nbsp;<span class="ident" id="2986038">nil</span>&nbsp;<span class="op" id="2986042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986046">t</span><span class="op" id="2986047">.</span><span class="builtintype" id="2986048">error</span><span class="op" id="2986053">(</span><span class="ident" id="2986054">err</span><span class="op" id="2986057">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2986060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986063">t</span><span class="op" id="2986064">.</span><span class="ident" id="2986065">expect</span><span class="op" id="2986071">(</span><span class="ident" id="2986072">itemRightDelim</span><span class="op" id="2986086">,</span>&nbsp;<span class="ident" id="2986088">context</span><span class="op" id="2986095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986098">var</span>&nbsp;<span class="ident" id="2986102">end</span>&nbsp;<span class="ident" id="2986106">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986112">t</span><span class="op" id="2986113">.</span><span class="ident" id="2986114">Root</span><span class="op" id="2986118">,</span>&nbsp;<span class="ident" id="2986120">end</span>&nbsp;<span class="op" id="2986124">=</span>&nbsp;<span class="ident" id="2986126">t</span><span class="op" id="2986127">.</span><span class="ident" id="2986128">itemList</span><span class="op" id="2986136">(</span><span class="op" id="2986137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986140">if</span>&nbsp;<span class="ident" id="2986143">end</span><span class="op" id="2986146">.</span><span class="ident" id="2986147">Type</span><span class="op" id="2986151">(</span><span class="op" id="2986152">)</span>&nbsp;<span class="op" id="2986154">!=</span>&nbsp;<span class="ident" id="2986157">nodeEnd</span>&nbsp;<span class="op" id="2986165">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986169">t</span><span class="op" id="2986170">.</span><span class="ident" id="2986171">errorf</span><span class="op" id="2986177">(</span><span class="string" id="2986178">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="2986199">,</span>&nbsp;<span class="ident" id="2986201">end</span><span class="op" id="2986204">,</span>&nbsp;<span class="ident" id="2986206">context</span><span class="op" id="2986213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2986216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986219">t</span><span class="op" id="2986220">.</span><span class="ident" id="2986221">add</span><span class="op" id="2986224">(</span><span class="ident" id="2986225">treeSet</span><span class="op" id="2986232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986235">t</span><span class="op" id="2986236">.</span><span class="ident" id="2986237">stopParse</span><span class="op" id="2986246">(</span><span class="op" id="2986247">)</span><br>
<span class="lineno"></span><span class="op" id="2986249">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="2986252">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="2986265">//&nbsp;&nbsp;&nbsp;&nbsptextOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="2986282">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="2986341">func</span>&nbsp;<span class="op" id="2986346">(</span><span class="ident" id="2986347">t</span>&nbsp;<span class="op" id="2986349">*</span><span class="ident" id="2986350">Tree</span><span class="op" id="2986354">)</span>&nbsp;<span class="ident" id="2986356">itemList</span><span class="op" id="2986364">(</span><span class="op" id="2986365">)</span>&nbsp;<span class="op" id="2986367">(</span><span class="ident" id="2986368">list</span>&nbsp;<span class="op" id="2986373">*</span><span class="ident" id="2986374">ListNode</span><span class="op" id="2986382">,</span>&nbsp;<span class="ident" id="2986384">next</span>&nbsp;<span class="ident" id="2986389">Node</span><span class="op" id="2986393">)</span>&nbsp;<span class="op" id="2986395">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986398">list</span>&nbsp;<span class="op" id="2986403">=</span>&nbsp;<span class="ident" id="2986405">t</span><span class="op" id="2986406">.</span><span class="ident" id="2986407">newList</span><span class="op" id="2986414">(</span><span class="ident" id="2986415">t</span><span class="op" id="2986416">.</span><span class="ident" id="2986417">peekNonSpace</span><span class="op" id="2986429">(</span><span class="op" id="2986430">)</span><span class="op" id="2986431">.</span><span class="ident" id="2986432">pos</span><span class="op" id="2986435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986438">for</span>&nbsp;<span class="ident" id="2986442">t</span><span class="op" id="2986443">.</span><span class="ident" id="2986444">peekNonSpace</span><span class="op" id="2986456">(</span><span class="op" id="2986457">)</span><span class="op" id="2986458">.</span><span class="ident" id="2986459">typ</span>&nbsp;<span class="op" id="2986463">!=</span>&nbsp;<span class="ident" id="2986466">itemEOF</span>&nbsp;<span class="op" id="2986474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986478">n</span>&nbsp;<span class="op" id="2986480">:=</span>&nbsp;<span class="ident" id="2986483">t</span><span class="op" id="2986484">.</span><span class="ident" id="2986485">textOrAction</span><span class="op" id="2986497">(</span><span class="op" id="2986498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986502">switch</span>&nbsp;<span class="ident" id="2986509">n</span><span class="op" id="2986510">.</span><span class="ident" id="2986511">Type</span><span class="op" id="2986515">(</span><span class="op" id="2986516">)</span>&nbsp;<span class="op" id="2986518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986522">case</span>&nbsp;<span class="ident" id="2986527">nodeEnd</span><span class="op" id="2986534">,</span>&nbsp;<span class="ident" id="2986536">nodeElse</span><span class="op" id="2986544">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986549">return</span>&nbsp;<span class="ident" id="2986556">list</span><span class="op" id="2986560">,</span>&nbsp;<span class="ident" id="2986562">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2986566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986570">list</span><span class="op" id="2986574">.</span><span class="builtinfunc" id="2986575">append</span><span class="op" id="2986581">(</span><span class="ident" id="2986582">n</span><span class="op" id="2986583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2986586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986589">t</span><span class="op" id="2986590">.</span><span class="ident" id="2986591">errorf</span><span class="op" id="2986597">(</span><span class="string" id="2986598">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="2986614">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986617">return</span><br>
<span class="lineno"></span><span class="op" id="2986624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2986627">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="2986644">//&nbsp;&nbsp;&nbsp;&nbsptext&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="2986661">func</span>&nbsp;<span class="op" id="2986666">(</span><span class="ident" id="2986667">t</span>&nbsp;<span class="op" id="2986669">*</span><span class="ident" id="2986670">Tree</span><span class="op" id="2986674">)</span>&nbsp;<span class="ident" id="2986676">textOrAction</span><span class="op" id="2986688">(</span><span class="op" id="2986689">)</span>&nbsp;<span class="ident" id="2986691">Node</span>&nbsp;<span class="op" id="2986696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986699">switch</span>&nbsp;<span class="ident" id="2986706">token</span>&nbsp;<span class="op" id="2986712">:=</span>&nbsp;<span class="ident" id="2986715">t</span><span class="op" id="2986716">.</span><span class="ident" id="2986717">nextNonSpace</span><span class="op" id="2986729">(</span><span class="op" id="2986730">)</span><span class="op" id="2986731">;</span>&nbsp;<span class="ident" id="2986733">token</span><span class="op" id="2986738">.</span><span class="ident" id="2986739">typ</span>&nbsp;<span class="op" id="2986743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986746">case</span>&nbsp;<span class="ident" id="2986751">itemText</span><span class="op" id="2986759">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986763">return</span>&nbsp;<span class="ident" id="2986770">t</span><span class="op" id="2986771">.</span><span class="ident" id="2986772">newText</span><span class="op" id="2986779">(</span><span class="ident" id="2986780">token</span><span class="op" id="2986785">.</span><span class="ident" id="2986786">pos</span><span class="op" id="2986789">,</span>&nbsp;<span class="ident" id="2986791">token</span><span class="op" id="2986796">.</span><span class="ident" id="2986797">val</span><span class="op" id="2986800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986803">case</span>&nbsp;<span class="ident" id="2986808">itemLeftDelim</span><span class="op" id="2986821">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986825">return</span>&nbsp;<span class="ident" id="2986832">t</span><span class="op" id="2986833">.</span><span class="ident" id="2986834">action</span><span class="op" id="2986840">(</span><span class="op" id="2986841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986844">default</span><span class="op" id="2986851">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2986855">t</span><span class="op" id="2986856">.</span><span class="ident" id="2986857">unexpected</span><span class="op" id="2986867">(</span><span class="ident" id="2986868">token</span><span class="op" id="2986873">,</span>&nbsp;<span class="string" id="2986875">&#34;input&#34;</span><span class="op" id="2986882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2986885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2986888">return</span>&nbsp;<span class="ident" id="2986895">nil</span><br>
<span class="lineno">350</span><span class="op" id="2986899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2986902">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="2986913">//&nbsp;&nbsp;&nbsp;&nbspcontrol</span><br>
<span class="lineno"></span><span class="comment" id="2986924">//&nbsp;&nbsp;&nbsp;&nbspcommand&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="2986950">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="2986990">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="2987038">func</span>&nbsp;<span class="op" id="2987043">(</span><span class="ident" id="2987044">t</span>&nbsp;<span class="op" id="2987046">*</span><span class="ident" id="2987047">Tree</span><span class="op" id="2987051">)</span>&nbsp;<span class="ident" id="2987053">action</span><span class="op" id="2987059">(</span><span class="op" id="2987060">)</span>&nbsp;<span class="op" id="2987062">(</span><span class="ident" id="2987063">n</span>&nbsp;<span class="ident" id="2987065">Node</span><span class="op" id="2987069">)</span>&nbsp;<span class="op" id="2987071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987074">switch</span>&nbsp;<span class="ident" id="2987081">token</span>&nbsp;<span class="op" id="2987087">:=</span>&nbsp;<span class="ident" id="2987090">t</span><span class="op" id="2987091">.</span><span class="ident" id="2987092">nextNonSpace</span><span class="op" id="2987104">(</span><span class="op" id="2987105">)</span><span class="op" id="2987106">;</span>&nbsp;<span class="ident" id="2987108">token</span><span class="op" id="2987113">.</span><span class="ident" id="2987114">typ</span>&nbsp;<span class="op" id="2987118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987121">case</span>&nbsp;<span class="ident" id="2987126">itemElse</span><span class="op" id="2987134">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987138">return</span>&nbsp;<span class="ident" id="2987145">t</span><span class="op" id="2987146">.</span><span class="ident" id="2987147">elseControl</span><span class="op" id="2987158">(</span><span class="op" id="2987159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987162">case</span>&nbsp;<span class="ident" id="2987167">itemEnd</span><span class="op" id="2987174">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987178">return</span>&nbsp;<span class="ident" id="2987185">t</span><span class="op" id="2987186">.</span><span class="ident" id="2987187">endControl</span><span class="op" id="2987197">(</span><span class="op" id="2987198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987201">case</span>&nbsp;<span class="ident" id="2987206">itemIf</span><span class="op" id="2987212">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987216">return</span>&nbsp;<span class="ident" id="2987223">t</span><span class="op" id="2987224">.</span><span class="ident" id="2987225">ifControl</span><span class="op" id="2987234">(</span><span class="op" id="2987235">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987238">case</span>&nbsp;<span class="ident" id="2987243">itemRange</span><span class="op" id="2987252">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987256">return</span>&nbsp;<span class="ident" id="2987263">t</span><span class="op" id="2987264">.</span><span class="ident" id="2987265">rangeControl</span><span class="op" id="2987277">(</span><span class="op" id="2987278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987281">case</span>&nbsp;<span class="ident" id="2987286">itemTemplate</span><span class="op" id="2987298">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987302">return</span>&nbsp;<span class="ident" id="2987309">t</span><span class="op" id="2987310">.</span><span class="ident" id="2987311">templateControl</span><span class="op" id="2987326">(</span><span class="op" id="2987327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987330">case</span>&nbsp;<span class="ident" id="2987335">itemWith</span><span class="op" id="2987343">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987347">return</span>&nbsp;<span class="ident" id="2987354">t</span><span class="op" id="2987355">.</span><span class="ident" id="2987356">withControl</span><span class="op" id="2987367">(</span><span class="op" id="2987368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2987371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2987374">t</span><span class="op" id="2987375">.</span><span class="ident" id="2987376">backup</span><span class="op" id="2987382">(</span><span class="op" id="2987383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2987386">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987438">return</span>&nbsp;<span class="ident" id="2987445">t</span><span class="op" id="2987446">.</span><span class="ident" id="2987447">newAction</span><span class="op" id="2987456">(</span><span class="ident" id="2987457">t</span><span class="op" id="2987458">.</span><span class="ident" id="2987459">peek</span><span class="op" id="2987463">(</span><span class="op" id="2987464">)</span><span class="op" id="2987465">.</span><span class="ident" id="2987466">pos</span><span class="op" id="2987469">,</span>&nbsp;<span class="ident" id="2987471">t</span><span class="op" id="2987472">.</span><span class="ident" id="2987473">lex</span><span class="op" id="2987476">.</span><span class="ident" id="2987477">lineNumber</span><span class="op" id="2987487">(</span><span class="op" id="2987488">)</span><span class="op" id="2987489">,</span>&nbsp;<span class="ident" id="2987491">t</span><span class="op" id="2987492">.</span><span class="ident" id="2987493">pipeline</span><span class="op" id="2987501">(</span><span class="string" id="2987502">&#34;command&#34;</span><span class="op" id="2987511">)</span><span class="op" id="2987512">)</span><br>
<span class="lineno">375</span><span class="op" id="2987514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2987517">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="2987530">//&nbsp;&nbsp;&nbsp;&nbspdeclarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="2987570">func</span>&nbsp;<span class="op" id="2987575">(</span><span class="ident" id="2987576">t</span>&nbsp;<span class="op" id="2987578">*</span><span class="ident" id="2987579">Tree</span><span class="op" id="2987583">)</span>&nbsp;<span class="ident" id="2987585">pipeline</span><span class="op" id="2987593">(</span><span class="ident" id="2987594">context</span>&nbsp;<span class="builtintype" id="2987602">string</span><span class="op" id="2987608">)</span>&nbsp;<span class="op" id="2987610">(</span><span class="ident" id="2987611">pipe</span>&nbsp;<span class="op" id="2987616">*</span><span class="ident" id="2987617">PipeNode</span><span class="op" id="2987625">)</span>&nbsp;<span class="op" id="2987627">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987630">var</span>&nbsp;<span class="ident" id="2987634">decl</span>&nbsp;<span class="op" id="2987639">[</span><span class="op" id="2987640">]</span><span class="op" id="2987641">*</span><span class="ident" id="2987642">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2987656">pos</span>&nbsp;<span class="op" id="2987660">:=</span>&nbsp;<span class="ident" id="2987663">t</span><span class="op" id="2987664">.</span><span class="ident" id="2987665">peekNonSpace</span><span class="op" id="2987677">(</span><span class="op" id="2987678">)</span><span class="op" id="2987679">.</span><span class="ident" id="2987680">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2987685">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987713">for</span>&nbsp;<span class="op" id="2987717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2987721">if</span>&nbsp;<span class="ident" id="2987724">v</span>&nbsp;<span class="op" id="2987726">:=</span>&nbsp;<span class="ident" id="2987729">t</span><span class="op" id="2987730">.</span><span class="ident" id="2987731">peekNonSpace</span><span class="op" id="2987743">(</span><span class="op" id="2987744">)</span><span class="op" id="2987745">;</span>&nbsp;<span class="ident" id="2987747">v</span><span class="op" id="2987748">.</span><span class="ident" id="2987749">typ</span>&nbsp;<span class="op" id="2987753">==</span>&nbsp;<span class="ident" id="2987756">itemVariable</span>&nbsp;<span class="op" id="2987769">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2987774">t</span><span class="op" id="2987775">.</span><span class="ident" id="2987776">next</span><span class="op" id="2987780">(</span><span class="op" id="2987781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2987786">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2987867">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2987950">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2988023">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2988091">tokenAfterVariable</span>&nbsp;<span class="op" id="2988110">:=</span>&nbsp;<span class="ident" id="2988113">t</span><span class="op" id="2988114">.</span><span class="ident" id="2988115">peek</span><span class="op" id="2988119">(</span><span class="op" id="2988120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988125">if</span>&nbsp;<span class="ident" id="2988128">next</span>&nbsp;<span class="op" id="2988133">:=</span>&nbsp;<span class="ident" id="2988136">t</span><span class="op" id="2988137">.</span><span class="ident" id="2988138">peekNonSpace</span><span class="op" id="2988150">(</span><span class="op" id="2988151">)</span><span class="op" id="2988152">;</span>&nbsp;<span class="ident" id="2988154">next</span><span class="op" id="2988158">.</span><span class="ident" id="2988159">typ</span>&nbsp;<span class="op" id="2988163">==</span>&nbsp;<span class="ident" id="2988166">itemColonEquals</span>&nbsp;<span class="op" id="2988182">||</span>&nbsp;<span class="op" id="2988185">(</span><span class="ident" id="2988186">next</span><span class="op" id="2988190">.</span><span class="ident" id="2988191">typ</span>&nbsp;<span class="op" id="2988195">==</span>&nbsp;<span class="ident" id="2988198">itemChar</span>&nbsp;<span class="op" id="2988207">&amp;&amp;</span>&nbsp;<span class="ident" id="2988210">next</span><span class="op" id="2988214">.</span><span class="ident" id="2988215">val</span>&nbsp;<span class="op" id="2988219">==</span>&nbsp;<span class="string" id="2988222">&#34;,&#34;</span><span class="op" id="2988225">)</span>&nbsp;<span class="op" id="2988227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2988233">t</span><span class="op" id="2988234">.</span><span class="ident" id="2988235">nextNonSpace</span><span class="op" id="2988247">(</span><span class="op" id="2988248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2988254">variable</span>&nbsp;<span class="op" id="2988263">:=</span>&nbsp;<span class="ident" id="2988266">t</span><span class="op" id="2988267">.</span><span class="ident" id="2988268">newVariable</span><span class="op" id="2988279">(</span><span class="ident" id="2988280">v</span><span class="op" id="2988281">.</span><span class="ident" id="2988282">pos</span><span class="op" id="2988285">,</span>&nbsp;<span class="ident" id="2988287">v</span><span class="op" id="2988288">.</span><span class="ident" id="2988289">val</span><span class="op" id="2988292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2988298">decl</span>&nbsp;<span class="op" id="2988303">=</span>&nbsp;<span class="builtinfunc" id="2988305">append</span><span class="op" id="2988311">(</span><span class="ident" id="2988312">decl</span><span class="op" id="2988316">,</span>&nbsp;<span class="ident" id="2988318">variable</span><span class="op" id="2988326">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2988332">t</span><span class="op" id="2988333">.</span><span class="ident" id="2988334">vars</span>&nbsp;<span class="op" id="2988339">=</span>&nbsp;<span class="builtinfunc" id="2988341">append</span><span class="op" id="2988347">(</span><span class="ident" id="2988348">t</span><span class="op" id="2988349">.</span><span class="ident" id="2988350">vars</span><span class="op" id="2988354">,</span>&nbsp;<span class="ident" id="2988356">v</span><span class="op" id="2988357">.</span><span class="ident" id="2988358">val</span><span class="op" id="2988361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988367">if</span>&nbsp;<span class="ident" id="2988370">next</span><span class="op" id="2988374">.</span><span class="ident" id="2988375">typ</span>&nbsp;<span class="op" id="2988379">==</span>&nbsp;<span class="ident" id="2988382">itemChar</span>&nbsp;<span class="op" id="2988391">&amp;&amp;</span>&nbsp;<span class="ident" id="2988394">next</span><span class="op" id="2988398">.</span><span class="ident" id="2988399">val</span>&nbsp;<span class="op" id="2988403">==</span>&nbsp;<span class="string" id="2988406">&#34;,&#34;</span>&nbsp;<span class="op" id="2988410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988417">if</span>&nbsp;<span class="ident" id="2988420">context</span>&nbsp;<span class="op" id="2988428">==</span>&nbsp;<span class="string" id="2988431">&#34;range&#34;</span>&nbsp;<span class="op" id="2988439">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2988442">len</span><span class="op" id="2988445">(</span><span class="ident" id="2988446">decl</span><span class="op" id="2988450">)</span>&nbsp;<span class="op" id="2988452">&lt;</span>&nbsp;<span class="num" id="2988454">2</span>&nbsp;<span class="op" id="2988456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988464">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2988478">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2988485">t</span><span class="op" id="2988486">.</span><span class="ident" id="2988487">errorf</span><span class="op" id="2988493">(</span><span class="string" id="2988494">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="2988523">,</span>&nbsp;<span class="ident" id="2988525">context</span><span class="op" id="2988532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2988538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2988543">}</span>&nbsp;<span class="keyword" id="2988545">else</span>&nbsp;<span class="keyword" id="2988550">if</span>&nbsp;<span class="ident" id="2988553">tokenAfterVariable</span><span class="op" id="2988571">.</span><span class="ident" id="2988572">typ</span>&nbsp;<span class="op" id="2988576">==</span>&nbsp;<span class="ident" id="2988579">itemSpace</span>&nbsp;<span class="op" id="2988589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2988595">t</span><span class="op" id="2988596">.</span><span class="ident" id="2988597">backup3</span><span class="op" id="2988604">(</span><span class="ident" id="2988605">v</span><span class="op" id="2988606">,</span>&nbsp;<span class="ident" id="2988608">tokenAfterVariable</span><span class="op" id="2988626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2988631">}</span>&nbsp;<span class="keyword" id="2988633">else</span>&nbsp;<span class="op" id="2988638">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2988644">t</span><span class="op" id="2988645">.</span><span class="ident" id="2988646">backup2</span><span class="op" id="2988653">(</span><span class="ident" id="2988654">v</span><span class="op" id="2988655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2988660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2988664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988668">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2988675">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2988678">pipe</span>&nbsp;<span class="op" id="2988683">=</span>&nbsp;<span class="ident" id="2988685">t</span><span class="op" id="2988686">.</span><span class="ident" id="2988687">newPipeline</span><span class="op" id="2988698">(</span><span class="ident" id="2988699">pos</span><span class="op" id="2988702">,</span>&nbsp;<span class="ident" id="2988704">t</span><span class="op" id="2988705">.</span><span class="ident" id="2988706">lex</span><span class="op" id="2988709">.</span><span class="ident" id="2988710">lineNumber</span><span class="op" id="2988720">(</span><span class="op" id="2988721">)</span><span class="op" id="2988722">,</span>&nbsp;<span class="ident" id="2988724">decl</span><span class="op" id="2988728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988731">for</span>&nbsp;<span class="op" id="2988735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988739">switch</span>&nbsp;<span class="ident" id="2988746">token</span>&nbsp;<span class="op" id="2988752">:=</span>&nbsp;<span class="ident" id="2988755">t</span><span class="op" id="2988756">.</span><span class="ident" id="2988757">nextNonSpace</span><span class="op" id="2988769">(</span><span class="op" id="2988770">)</span><span class="op" id="2988771">;</span>&nbsp;<span class="ident" id="2988773">token</span><span class="op" id="2988778">.</span><span class="ident" id="2988779">typ</span>&nbsp;<span class="op" id="2988783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988787">case</span>&nbsp;<span class="ident" id="2988792">itemRightDelim</span><span class="op" id="2988806">,</span>&nbsp;<span class="ident" id="2988808">itemRightParen</span><span class="op" id="2988822">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988827">if</span>&nbsp;<span class="builtinfunc" id="2988830">len</span><span class="op" id="2988833">(</span><span class="ident" id="2988834">pipe</span><span class="op" id="2988838">.</span><span class="ident" id="2988839">Cmds</span><span class="op" id="2988843">)</span>&nbsp;<span class="op" id="2988845">==</span>&nbsp;<span class="num" id="2988848">0</span>&nbsp;<span class="op" id="2988850">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2988856">t</span><span class="op" id="2988857">.</span><span class="ident" id="2988858">errorf</span><span class="op" id="2988864">(</span><span class="string" id="2988865">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="2988887">,</span>&nbsp;<span class="ident" id="2988889">context</span><span class="op" id="2988896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2988901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988906">if</span>&nbsp;<span class="ident" id="2988909">token</span><span class="op" id="2988914">.</span><span class="ident" id="2988915">typ</span>&nbsp;<span class="op" id="2988919">==</span>&nbsp;<span class="ident" id="2988922">itemRightParen</span>&nbsp;<span class="op" id="2988937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2988943">t</span><span class="op" id="2988944">.</span><span class="ident" id="2988945">backup</span><span class="op" id="2988951">(</span><span class="op" id="2988952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2988957">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988962">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2988971">case</span>&nbsp;<span class="ident" id="2988976">itemBool</span><span class="op" id="2988984">,</span>&nbsp;<span class="ident" id="2988986">itemCharConstant</span><span class="op" id="2989002">,</span>&nbsp;<span class="ident" id="2989004">itemComplex</span><span class="op" id="2989015">,</span>&nbsp;<span class="ident" id="2989017">itemDot</span><span class="op" id="2989024">,</span>&nbsp;<span class="ident" id="2989026">itemField</span><span class="op" id="2989035">,</span>&nbsp;<span class="ident" id="2989037">itemIdentifier</span><span class="op" id="2989051">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2989056">itemNumber</span><span class="op" id="2989066">,</span>&nbsp;<span class="ident" id="2989068">itemNil</span><span class="op" id="2989075">,</span>&nbsp;<span class="ident" id="2989077">itemRawString</span><span class="op" id="2989090">,</span>&nbsp;<span class="ident" id="2989092">itemString</span><span class="op" id="2989102">,</span>&nbsp;<span class="ident" id="2989104">itemVariable</span><span class="op" id="2989116">,</span>&nbsp;<span class="ident" id="2989118">itemLeftParen</span><span class="op" id="2989131">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2989136">t</span><span class="op" id="2989137">.</span><span class="ident" id="2989138">backup</span><span class="op" id="2989144">(</span><span class="op" id="2989145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2989150">pipe</span><span class="op" id="2989154">.</span><span class="builtinfunc" id="2989155">append</span><span class="op" id="2989161">(</span><span class="ident" id="2989162">t</span><span class="op" id="2989163">.</span><span class="ident" id="2989164">command</span><span class="op" id="2989171">(</span><span class="op" id="2989172">)</span><span class="op" id="2989173">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2989177">default</span><span class="op" id="2989184">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2989189">t</span><span class="op" id="2989190">.</span><span class="ident" id="2989191">unexpected</span><span class="op" id="2989201">(</span><span class="ident" id="2989202">token</span><span class="op" id="2989207">,</span>&nbsp;<span class="ident" id="2989209">context</span><span class="op" id="2989216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2989220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2989223">}</span><br>
<span class="lineno"></span><span class="op" id="2989225">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="2989228">func</span>&nbsp;<span class="op" id="2989233">(</span><span class="ident" id="2989234">t</span>&nbsp;<span class="op" id="2989236">*</span><span class="ident" id="2989237">Tree</span><span class="op" id="2989241">)</span>&nbsp;<span class="ident" id="2989243">parseControl</span><span class="op" id="2989255">(</span><span class="ident" id="2989256">allowElseIf</span>&nbsp;<span class="builtintype" id="2989268">bool</span><span class="op" id="2989272">,</span>&nbsp;<span class="ident" id="2989274">context</span>&nbsp;<span class="builtintype" id="2989282">string</span><span class="op" id="2989288">)</span>&nbsp;<span class="op" id="2989290">(</span><span class="ident" id="2989291">pos</span>&nbsp;<span class="ident" id="2989295">Pos</span><span class="op" id="2989298">,</span>&nbsp;<span class="ident" id="2989300">line</span>&nbsp;<span class="builtintype" id="2989305">int</span><span class="op" id="2989308">,</span>&nbsp;<span class="ident" id="2989310">pipe</span>&nbsp;<span class="op" id="2989315">*</span><span class="ident" id="2989316">PipeNode</span><span class="op" id="2989324">,</span>&nbsp;<span class="ident" id="2989326">list</span><span class="op" id="2989330">,</span>&nbsp;<span class="ident" id="2989332">elseList</span>&nbsp;<span class="op" id="2989341">*</span><span class="ident" id="2989342">ListNode</span><span class="op" id="2989350">)</span>&nbsp;<span class="op" id="2989352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2989355">defer</span>&nbsp;<span class="ident" id="2989361">t</span><span class="op" id="2989362">.</span><span class="ident" id="2989363">popVars</span><span class="op" id="2989370">(</span><span class="builtinfunc" id="2989371">len</span><span class="op" id="2989374">(</span><span class="ident" id="2989375">t</span><span class="op" id="2989376">.</span><span class="ident" id="2989377">vars</span><span class="op" id="2989381">)</span><span class="op" id="2989382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2989385">line</span>&nbsp;<span class="op" id="2989390">=</span>&nbsp;<span class="ident" id="2989392">t</span><span class="op" id="2989393">.</span><span class="ident" id="2989394">lex</span><span class="op" id="2989397">.</span><span class="ident" id="2989398">lineNumber</span><span class="op" id="2989408">(</span><span class="op" id="2989409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2989412">pipe</span>&nbsp;<span class="op" id="2989417">=</span>&nbsp;<span class="ident" id="2989419">t</span><span class="op" id="2989420">.</span><span class="ident" id="2989421">pipeline</span><span class="op" id="2989429">(</span><span class="ident" id="2989430">context</span><span class="op" id="2989437">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2989440">var</span>&nbsp;<span class="ident" id="2989444">next</span>&nbsp;<span class="ident" id="2989449">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2989455">list</span><span class="op" id="2989459">,</span>&nbsp;<span class="ident" id="2989461">next</span>&nbsp;<span class="op" id="2989466">=</span>&nbsp;<span class="ident" id="2989468">t</span><span class="op" id="2989469">.</span><span class="ident" id="2989470">itemList</span><span class="op" id="2989478">(</span><span class="op" id="2989479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2989482">switch</span>&nbsp;<span class="ident" id="2989489">next</span><span class="op" id="2989493">.</span><span class="ident" id="2989494">Type</span><span class="op" id="2989498">(</span><span class="op" id="2989499">)</span>&nbsp;<span class="op" id="2989501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2989504">case</span>&nbsp;<span class="ident" id="2989509">nodeEnd</span><span class="op" id="2989516">:</span>&nbsp;<span class="comment" id="2989518">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2989526">case</span>&nbsp;<span class="ident" id="2989531">nodeElse</span><span class="op" id="2989539">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2989543">if</span>&nbsp;<span class="ident" id="2989546">allowElseIf</span>&nbsp;<span class="op" id="2989558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2989563">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2989647">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2989714">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2989751">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2989760">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2989808">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2989894">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2989966">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2990021">if</span>&nbsp;<span class="ident" id="2990024">t</span><span class="op" id="2990025">.</span><span class="ident" id="2990026">peek</span><span class="op" id="2990030">(</span><span class="op" id="2990031">)</span><span class="op" id="2990032">.</span><span class="ident" id="2990033">typ</span>&nbsp;<span class="op" id="2990037">==</span>&nbsp;<span class="ident" id="2990040">itemIf</span>&nbsp;<span class="op" id="2990047">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2990053">t</span><span class="op" id="2990054">.</span><span class="ident" id="2990055">next</span><span class="op" id="2990059">(</span><span class="op" id="2990060">)</span>&nbsp;<span class="comment" id="2990062">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2990093">elseList</span>&nbsp;<span class="op" id="2990102">=</span>&nbsp;<span class="ident" id="2990104">t</span><span class="op" id="2990105">.</span><span class="ident" id="2990106">newList</span><span class="op" id="2990113">(</span><span class="ident" id="2990114">next</span><span class="op" id="2990118">.</span><span class="ident" id="2990119">Position</span><span class="op" id="2990127">(</span><span class="op" id="2990128">)</span><span class="op" id="2990129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2990135">elseList</span><span class="op" id="2990143">.</span><span class="builtinfunc" id="2990144">append</span><span class="op" id="2990150">(</span><span class="ident" id="2990151">t</span><span class="op" id="2990152">.</span><span class="ident" id="2990153">ifControl</span><span class="op" id="2990162">(</span><span class="op" id="2990163">)</span><span class="op" id="2990164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2990170">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2990235">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2990244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2990248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2990252">elseList</span><span class="op" id="2990260">,</span>&nbsp;<span class="ident" id="2990262">next</span>&nbsp;<span class="op" id="2990267">=</span>&nbsp;<span class="ident" id="2990269">t</span><span class="op" id="2990270">.</span><span class="ident" id="2990271">itemList</span><span class="op" id="2990279">(</span><span class="op" id="2990280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2990284">if</span>&nbsp;<span class="ident" id="2990287">next</span><span class="op" id="2990291">.</span><span class="ident" id="2990292">Type</span><span class="op" id="2990296">(</span><span class="op" id="2990297">)</span>&nbsp;<span class="op" id="2990299">!=</span>&nbsp;<span class="ident" id="2990302">nodeEnd</span>&nbsp;<span class="op" id="2990310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2990315">t</span><span class="op" id="2990316">.</span><span class="ident" id="2990317">errorf</span><span class="op" id="2990323">(</span><span class="string" id="2990324">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="2990348">,</span>&nbsp;<span class="ident" id="2990350">next</span><span class="op" id="2990354">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2990358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2990361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2990364">return</span>&nbsp;<span class="ident" id="2990371">pipe</span><span class="op" id="2990375">.</span><span class="ident" id="2990376">Position</span><span class="op" id="2990384">(</span><span class="op" id="2990385">)</span><span class="op" id="2990386">,</span>&nbsp;<span class="ident" id="2990388">line</span><span class="op" id="2990392">,</span>&nbsp;<span class="ident" id="2990394">pipe</span><span class="op" id="2990398">,</span>&nbsp;<span class="ident" id="2990400">list</span><span class="op" id="2990404">,</span>&nbsp;<span class="ident" id="2990406">elseList</span><br>
<span class="lineno"></span><span class="op" id="2990415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="2990418">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="2990425">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="2990461">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="2990515">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="2990538">func</span>&nbsp;<span class="op" id="2990543">(</span><span class="ident" id="2990544">t</span>&nbsp;<span class="op" id="2990546">*</span><span class="ident" id="2990547">Tree</span><span class="op" id="2990551">)</span>&nbsp;<span class="ident" id="2990553">ifControl</span><span class="op" id="2990562">(</span><span class="op" id="2990563">)</span>&nbsp;<span class="ident" id="2990565">Node</span>&nbsp;<span class="op" id="2990570">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2990573">return</span>&nbsp;<span class="ident" id="2990580">t</span><span class="op" id="2990581">.</span><span class="ident" id="2990582">newIf</span><span class="op" id="2990587">(</span><span class="ident" id="2990588">t</span><span class="op" id="2990589">.</span><span class="ident" id="2990590">parseControl</span><span class="op" id="2990602">(</span><span class="builtintype" id="2990603">true</span><span class="op" id="2990607">,</span>&nbsp;<span class="string" id="2990609">&#34;if&#34;</span><span class="op" id="2990613">)</span><span class="op" id="2990614">)</span><br>
<span class="lineno"></span><span class="op" id="2990616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2990619">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="2990629">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="2990668">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="2990725">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="2990751">func</span>&nbsp;<span class="op" id="2990756">(</span><span class="ident" id="2990757">t</span>&nbsp;<span class="op" id="2990759">*</span><span class="ident" id="2990760">Tree</span><span class="op" id="2990764">)</span>&nbsp;<span class="ident" id="2990766">rangeControl</span><span class="op" id="2990778">(</span><span class="op" id="2990779">)</span>&nbsp;<span class="ident" id="2990781">Node</span>&nbsp;<span class="op" id="2990786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2990789">return</span>&nbsp;<span class="ident" id="2990796">t</span><span class="op" id="2990797">.</span><span class="ident" id="2990798">newRange</span><span class="op" id="2990806">(</span><span class="ident" id="2990807">t</span><span class="op" id="2990808">.</span><span class="ident" id="2990809">parseControl</span><span class="op" id="2990821">(</span><span class="builtintype" id="2990822">false</span><span class="op" id="2990827">,</span>&nbsp;<span class="string" id="2990829">&#34;range&#34;</span><span class="op" id="2990836">)</span><span class="op" id="2990837">)</span><br>
<span class="lineno"></span><span class="op" id="2990839">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="2990842">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="2990851">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="2990889">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="2990945">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="2990968">func</span>&nbsp;<span class="op" id="2990973">(</span><span class="ident" id="2990974">t</span>&nbsp;<span class="op" id="2990976">*</span><span class="ident" id="2990977">Tree</span><span class="op" id="2990981">)</span>&nbsp;<span class="ident" id="2990983">withControl</span><span class="op" id="2990994">(</span><span class="op" id="2990995">)</span>&nbsp;<span class="ident" id="2990997">Node</span>&nbsp;<span class="op" id="2991002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2991005">return</span>&nbsp;<span class="ident" id="2991012">t</span><span class="op" id="2991013">.</span><span class="ident" id="2991014">newWith</span><span class="op" id="2991021">(</span><span class="ident" id="2991022">t</span><span class="op" id="2991023">.</span><span class="ident" id="2991024">parseControl</span><span class="op" id="2991036">(</span><span class="builtintype" id="2991037">false</span><span class="op" id="2991042">,</span>&nbsp;<span class="string" id="2991044">&#34;with&#34;</span><span class="op" id="2991050">)</span><span class="op" id="2991051">)</span><br>
<span class="lineno"></span><span class="op" id="2991053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2991056">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="2991064">//&nbsp;&nbsp;&nbsp;&nbsp{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="2991075">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="2991099">func</span>&nbsp;<span class="op" id="2991104">(</span><span class="ident" id="2991105">t</span>&nbsp;<span class="op" id="2991107">*</span><span class="ident" id="2991108">Tree</span><span class="op" id="2991112">)</span>&nbsp;<span class="ident" id="2991114">endControl</span><span class="op" id="2991124">(</span><span class="op" id="2991125">)</span>&nbsp;<span class="ident" id="2991127">Node</span>&nbsp;<span class="op" id="2991132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2991135">return</span>&nbsp;<span class="ident" id="2991142">t</span><span class="op" id="2991143">.</span><span class="ident" id="2991144">newEnd</span><span class="op" id="2991150">(</span><span class="ident" id="2991151">t</span><span class="op" id="2991152">.</span><span class="ident" id="2991153">expect</span><span class="op" id="2991159">(</span><span class="ident" id="2991160">itemRightDelim</span><span class="op" id="2991174">,</span>&nbsp;<span class="string" id="2991176">&#34;end&#34;</span><span class="op" id="2991181">)</span><span class="op" id="2991182">.</span><span class="ident" id="2991183">pos</span><span class="op" id="2991186">)</span><br>
<span class="lineno"></span><span class="op" id="2991188">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="2991191">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="2991200">//&nbsp;&nbsp;&nbsp;&nbsp{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="2991212">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="2991237">func</span>&nbsp;<span class="op" id="2991242">(</span><span class="ident" id="2991243">t</span>&nbsp;<span class="op" id="2991245">*</span><span class="ident" id="2991246">Tree</span><span class="op" id="2991250">)</span>&nbsp;<span class="ident" id="2991252">elseControl</span><span class="op" id="2991263">(</span><span class="op" id="2991264">)</span>&nbsp;<span class="ident" id="2991266">Node</span>&nbsp;<span class="op" id="2991271">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2991274">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2991306">peek</span>&nbsp;<span class="op" id="2991311">:=</span>&nbsp;<span class="ident" id="2991314">t</span><span class="op" id="2991315">.</span><span class="ident" id="2991316">peekNonSpace</span><span class="op" id="2991328">(</span><span class="op" id="2991329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2991332">if</span>&nbsp;<span class="ident" id="2991335">peek</span><span class="op" id="2991339">.</span><span class="ident" id="2991340">typ</span>&nbsp;<span class="op" id="2991344">==</span>&nbsp;<span class="ident" id="2991347">itemIf</span>&nbsp;<span class="op" id="2991354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2991358">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2991435">return</span>&nbsp;<span class="ident" id="2991442">t</span><span class="op" id="2991443">.</span><span class="ident" id="2991444">newElse</span><span class="op" id="2991451">(</span><span class="ident" id="2991452">peek</span><span class="op" id="2991456">.</span><span class="ident" id="2991457">pos</span><span class="op" id="2991460">,</span>&nbsp;<span class="ident" id="2991462">t</span><span class="op" id="2991463">.</span><span class="ident" id="2991464">lex</span><span class="op" id="2991467">.</span><span class="ident" id="2991468">lineNumber</span><span class="op" id="2991478">(</span><span class="op" id="2991479">)</span><span class="op" id="2991480">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2991483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2991486">return</span>&nbsp;<span class="ident" id="2991493">t</span><span class="op" id="2991494">.</span><span class="ident" id="2991495">newElse</span><span class="op" id="2991502">(</span><span class="ident" id="2991503">t</span><span class="op" id="2991504">.</span><span class="ident" id="2991505">expect</span><span class="op" id="2991511">(</span><span class="ident" id="2991512">itemRightDelim</span><span class="op" id="2991526">,</span>&nbsp;<span class="string" id="2991528">&#34;else&#34;</span><span class="op" id="2991534">)</span><span class="op" id="2991535">.</span><span class="ident" id="2991536">pos</span><span class="op" id="2991539">,</span>&nbsp;<span class="ident" id="2991541">t</span><span class="op" id="2991542">.</span><span class="ident" id="2991543">lex</span><span class="op" id="2991546">.</span><span class="ident" id="2991547">lineNumber</span><span class="op" id="2991557">(</span><span class="op" id="2991558">)</span><span class="op" id="2991559">)</span><br>
<span class="lineno"></span><span class="op" id="2991561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2991564">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="2991577">//&nbsp;&nbsp;&nbsp;&nbsp{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="2991614">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="2991689">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="2991705">func</span>&nbsp;<span class="op" id="2991710">(</span><span class="ident" id="2991711">t</span>&nbsp;<span class="op" id="2991713">*</span><span class="ident" id="2991714">Tree</span><span class="op" id="2991718">)</span>&nbsp;<span class="ident" id="2991720">templateControl</span><span class="op" id="2991735">(</span><span class="op" id="2991736">)</span>&nbsp;<span class="ident" id="2991738">Node</span>&nbsp;<span class="op" id="2991743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2991746">var</span>&nbsp;<span class="ident" id="2991750">name</span>&nbsp;<span class="builtintype" id="2991755">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2991763">token</span>&nbsp;<span class="op" id="2991769">:=</span>&nbsp;<span class="ident" id="2991772">t</span><span class="op" id="2991773">.</span><span class="ident" id="2991774">nextNonSpace</span><span class="op" id="2991786">(</span><span class="op" id="2991787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2991790">switch</span>&nbsp;<span class="ident" id="2991797">token</span><span class="op" id="2991802">.</span><span class="ident" id="2991803">typ</span>&nbsp;<span class="op" id="2991807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2991810">case</span>&nbsp;<span class="ident" id="2991815">itemString</span><span class="op" id="2991825">,</span>&nbsp;<span class="ident" id="2991827">itemRawString</span><span class="op" id="2991840">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2991844">s</span><span class="op" id="2991845">,</span>&nbsp;<span class="ident" id="2991847">err</span>&nbsp;<span class="op" id="2991851">:=</span>&nbsp;<span class="ident" id="2991854">strconv</span><span class="op" id="2991861">.</span><span class="ident" id="2991862">Unquote</span><span class="op" id="2991869">(</span><span class="ident" id="2991870">token</span><span class="op" id="2991875">.</span><span class="ident" id="2991876">val</span><span class="op" id="2991879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2991883">if</span>&nbsp;<span class="ident" id="2991886">err</span>&nbsp;<span class="op" id="2991890">!=</span>&nbsp;<span class="ident" id="2991893">nil</span>&nbsp;<span class="op" id="2991897">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2991902">t</span><span class="op" id="2991903">.</span><span class="builtintype" id="2991904">error</span><span class="op" id="2991909">(</span><span class="ident" id="2991910">err</span><span class="op" id="2991913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2991917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2991921">name</span>&nbsp;<span class="op" id="2991926">=</span>&nbsp;<span class="ident" id="2991928">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2991931">default</span><span class="op" id="2991938">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2991942">t</span><span class="op" id="2991943">.</span><span class="ident" id="2991944">unexpected</span><span class="op" id="2991954">(</span><span class="ident" id="2991955">token</span><span class="op" id="2991960">,</span>&nbsp;<span class="string" id="2991962">&#34;template&nbsp;invocation&#34;</span><span class="op" id="2991983">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2991986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2991989">var</span>&nbsp;<span class="ident" id="2991993">pipe</span>&nbsp;<span class="op" id="2991998">*</span><span class="ident" id="2991999">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992009">if</span>&nbsp;<span class="ident" id="2992012">t</span><span class="op" id="2992013">.</span><span class="ident" id="2992014">nextNonSpace</span><span class="op" id="2992026">(</span><span class="op" id="2992027">)</span><span class="op" id="2992028">.</span><span class="ident" id="2992029">typ</span>&nbsp;<span class="op" id="2992033">!=</span>&nbsp;<span class="ident" id="2992036">itemRightDelim</span>&nbsp;<span class="op" id="2992051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2992055">t</span><span class="op" id="2992056">.</span><span class="ident" id="2992057">backup</span><span class="op" id="2992063">(</span><span class="op" id="2992064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2992068">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2992121">pipe</span>&nbsp;<span class="op" id="2992126">=</span>&nbsp;<span class="ident" id="2992128">t</span><span class="op" id="2992129">.</span><span class="ident" id="2992130">pipeline</span><span class="op" id="2992138">(</span><span class="string" id="2992139">&#34;template&#34;</span><span class="op" id="2992149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2992152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992155">return</span>&nbsp;<span class="ident" id="2992162">t</span><span class="op" id="2992163">.</span><span class="ident" id="2992164">newTemplate</span><span class="op" id="2992175">(</span><span class="ident" id="2992176">token</span><span class="op" id="2992181">.</span><span class="ident" id="2992182">pos</span><span class="op" id="2992185">,</span>&nbsp;<span class="ident" id="2992187">t</span><span class="op" id="2992188">.</span><span class="ident" id="2992189">lex</span><span class="op" id="2992192">.</span><span class="ident" id="2992193">lineNumber</span><span class="op" id="2992203">(</span><span class="op" id="2992204">)</span><span class="op" id="2992205">,</span>&nbsp;<span class="ident" id="2992207">name</span><span class="op" id="2992211">,</span>&nbsp;<span class="ident" id="2992213">pipe</span><span class="op" id="2992217">)</span><br>
<span class="lineno"></span><span class="op" id="2992219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="2992222">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="2992234">//&nbsp;&nbsp;&nbsp;&nbspoperand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="2992262">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="2992338">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="2992422">func</span>&nbsp;<span class="op" id="2992427">(</span><span class="ident" id="2992428">t</span>&nbsp;<span class="op" id="2992430">*</span><span class="ident" id="2992431">Tree</span><span class="op" id="2992435">)</span>&nbsp;<span class="ident" id="2992437">command</span><span class="op" id="2992444">(</span><span class="op" id="2992445">)</span>&nbsp;<span class="op" id="2992447">*</span><span class="ident" id="2992448">CommandNode</span>&nbsp;<span class="op" id="2992460">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2992463">cmd</span>&nbsp;<span class="op" id="2992467">:=</span>&nbsp;<span class="ident" id="2992470">t</span><span class="op" id="2992471">.</span><span class="ident" id="2992472">newCommand</span><span class="op" id="2992482">(</span><span class="ident" id="2992483">t</span><span class="op" id="2992484">.</span><span class="ident" id="2992485">peekNonSpace</span><span class="op" id="2992497">(</span><span class="op" id="2992498">)</span><span class="op" id="2992499">.</span><span class="ident" id="2992500">pos</span><span class="op" id="2992503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992506">for</span>&nbsp;<span class="op" id="2992510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2992514">t</span><span class="op" id="2992515">.</span><span class="ident" id="2992516">peekNonSpace</span><span class="op" id="2992528">(</span><span class="op" id="2992529">)</span>&nbsp;<span class="comment" id="2992531">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2992557">operand</span>&nbsp;<span class="op" id="2992565">:=</span>&nbsp;<span class="ident" id="2992568">t</span><span class="op" id="2992569">.</span><span class="ident" id="2992570">operand</span><span class="op" id="2992577">(</span><span class="op" id="2992578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992582">if</span>&nbsp;<span class="ident" id="2992585">operand</span>&nbsp;<span class="op" id="2992593">!=</span>&nbsp;<span class="ident" id="2992596">nil</span>&nbsp;<span class="op" id="2992600">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2992605">cmd</span><span class="op" id="2992608">.</span><span class="builtinfunc" id="2992609">append</span><span class="op" id="2992615">(</span><span class="ident" id="2992616">operand</span><span class="op" id="2992623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2992627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992631">switch</span>&nbsp;<span class="ident" id="2992638">token</span>&nbsp;<span class="op" id="2992644">:=</span>&nbsp;<span class="ident" id="2992647">t</span><span class="op" id="2992648">.</span><span class="ident" id="2992649">next</span><span class="op" id="2992653">(</span><span class="op" id="2992654">)</span><span class="op" id="2992655">;</span>&nbsp;<span class="ident" id="2992657">token</span><span class="op" id="2992662">.</span><span class="ident" id="2992663">typ</span>&nbsp;<span class="op" id="2992667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992671">case</span>&nbsp;<span class="ident" id="2992676">itemSpace</span><span class="op" id="2992685">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992690">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992701">case</span>&nbsp;<span class="ident" id="2992706">itemError</span><span class="op" id="2992715">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2992720">t</span><span class="op" id="2992721">.</span><span class="ident" id="2992722">errorf</span><span class="op" id="2992728">(</span><span class="string" id="2992729">&#34;%s&#34;</span><span class="op" id="2992733">,</span>&nbsp;<span class="ident" id="2992735">token</span><span class="op" id="2992740">.</span><span class="ident" id="2992741">val</span><span class="op" id="2992744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992748">case</span>&nbsp;<span class="ident" id="2992753">itemRightDelim</span><span class="op" id="2992767">,</span>&nbsp;<span class="ident" id="2992769">itemRightParen</span><span class="op" id="2992783">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2992788">t</span><span class="op" id="2992789">.</span><span class="ident" id="2992790">backup</span><span class="op" id="2992796">(</span><span class="op" id="2992797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992801">case</span>&nbsp;<span class="ident" id="2992806">itemPipe</span><span class="op" id="2992814">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992818">default</span><span class="op" id="2992825">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2992830">t</span><span class="op" id="2992831">.</span><span class="ident" id="2992832">errorf</span><span class="op" id="2992838">(</span><span class="string" id="2992839">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="2992881">,</span>&nbsp;<span class="ident" id="2992883">token</span><span class="op" id="2992888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2992892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992896">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2992903">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992906">if</span>&nbsp;<span class="builtinfunc" id="2992909">len</span><span class="op" id="2992912">(</span><span class="ident" id="2992913">cmd</span><span class="op" id="2992916">.</span><span class="ident" id="2992917">Args</span><span class="op" id="2992921">)</span>&nbsp;<span class="op" id="2992923">==</span>&nbsp;<span class="num" id="2992926">0</span>&nbsp;<span class="op" id="2992928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2992932">t</span><span class="op" id="2992933">.</span><span class="ident" id="2992934">errorf</span><span class="op" id="2992940">(</span><span class="string" id="2992941">&#34;empty&nbsp;command&#34;</span><span class="op" id="2992956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2992959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2992962">return</span>&nbsp;<span class="ident" id="2992969">cmd</span><br>
<span class="lineno"></span><span class="op" id="2992973">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="2992976">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="2992988">//&nbsp;&nbsp;&nbsp;&nbspterm&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="2993004">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="2993063">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="2993110">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="2993165">func</span>&nbsp;<span class="op" id="2993170">(</span><span class="ident" id="2993171">t</span>&nbsp;<span class="op" id="2993173">*</span><span class="ident" id="2993174">Tree</span><span class="op" id="2993178">)</span>&nbsp;<span class="ident" id="2993180">operand</span><span class="op" id="2993187">(</span><span class="op" id="2993188">)</span>&nbsp;<span class="ident" id="2993190">Node</span>&nbsp;<span class="op" id="2993195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2993198">node</span>&nbsp;<span class="op" id="2993203">:=</span>&nbsp;<span class="ident" id="2993206">t</span><span class="op" id="2993207">.</span><span class="ident" id="2993208">term</span><span class="op" id="2993212">(</span><span class="op" id="2993213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2993216">if</span>&nbsp;<span class="ident" id="2993219">node</span>&nbsp;<span class="op" id="2993224">==</span>&nbsp;<span class="ident" id="2993227">nil</span>&nbsp;<span class="op" id="2993231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2993235">return</span>&nbsp;<span class="ident" id="2993242">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2993247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2993250">if</span>&nbsp;<span class="ident" id="2993253">t</span><span class="op" id="2993254">.</span><span class="ident" id="2993255">peek</span><span class="op" id="2993259">(</span><span class="op" id="2993260">)</span><span class="op" id="2993261">.</span><span class="ident" id="2993262">typ</span>&nbsp;<span class="op" id="2993266">==</span>&nbsp;<span class="ident" id="2993269">itemField</span>&nbsp;<span class="op" id="2993279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2993283">chain</span>&nbsp;<span class="op" id="2993289">:=</span>&nbsp;<span class="ident" id="2993292">t</span><span class="op" id="2993293">.</span><span class="ident" id="2993294">newChain</span><span class="op" id="2993302">(</span><span class="ident" id="2993303">t</span><span class="op" id="2993304">.</span><span class="ident" id="2993305">peek</span><span class="op" id="2993309">(</span><span class="op" id="2993310">)</span><span class="op" id="2993311">.</span><span class="ident" id="2993312">pos</span><span class="op" id="2993315">,</span>&nbsp;<span class="ident" id="2993317">node</span><span class="op" id="2993321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2993325">for</span>&nbsp;<span class="ident" id="2993329">t</span><span class="op" id="2993330">.</span><span class="ident" id="2993331">peek</span><span class="op" id="2993335">(</span><span class="op" id="2993336">)</span><span class="op" id="2993337">.</span><span class="ident" id="2993338">typ</span>&nbsp;<span class="op" id="2993342">==</span>&nbsp;<span class="ident" id="2993345">itemField</span>&nbsp;<span class="op" id="2993355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2993360">chain</span><span class="op" id="2993365">.</span><span class="ident" id="2993366">Add</span><span class="op" id="2993369">(</span><span class="ident" id="2993370">t</span><span class="op" id="2993371">.</span><span class="ident" id="2993372">next</span><span class="op" id="2993376">(</span><span class="op" id="2993377">)</span><span class="op" id="2993378">.</span><span class="ident" id="2993379">val</span><span class="op" id="2993382">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2993386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2993390">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2993461">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2993521">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2993558">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2993606">switch</span>&nbsp;<span class="ident" id="2993613">node</span><span class="op" id="2993617">.</span><span class="ident" id="2993618">Type</span><span class="op" id="2993622">(</span><span class="op" id="2993623">)</span>&nbsp;<span class="op" id="2993625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2993629">case</span>&nbsp;<span class="ident" id="2993634">NodeField</span><span class="op" id="2993643">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2993648">node</span>&nbsp;<span class="op" id="2993653">=</span>&nbsp;<span class="ident" id="2993655">t</span><span class="op" id="2993656">.</span><span class="ident" id="2993657">newField</span><span class="op" id="2993665">(</span><span class="ident" id="2993666">chain</span><span class="op" id="2993671">.</span><span class="ident" id="2993672">Position</span><span class="op" id="2993680">(</span><span class="op" id="2993681">)</span><span class="op" id="2993682">,</span>&nbsp;<span class="ident" id="2993684">chain</span><span class="op" id="2993689">.</span><span class="ident" id="2993690">String</span><span class="op" id="2993696">(</span><span class="op" id="2993697">)</span><span class="op" id="2993698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2993702">case</span>&nbsp;<span class="ident" id="2993707">NodeVariable</span><span class="op" id="2993719">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2993724">node</span>&nbsp;<span class="op" id="2993729">=</span>&nbsp;<span class="ident" id="2993731">t</span><span class="op" id="2993732">.</span><span class="ident" id="2993733">newVariable</span><span class="op" id="2993744">(</span><span class="ident" id="2993745">chain</span><span class="op" id="2993750">.</span><span class="ident" id="2993751">Position</span><span class="op" id="2993759">(</span><span class="op" id="2993760">)</span><span class="op" id="2993761">,</span>&nbsp;<span class="ident" id="2993763">chain</span><span class="op" id="2993768">.</span><span class="ident" id="2993769">String</span><span class="op" id="2993775">(</span><span class="op" id="2993776">)</span><span class="op" id="2993777">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2993781">default</span><span class="op" id="2993788">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2993793">node</span>&nbsp;<span class="op" id="2993798">=</span>&nbsp;<span class="ident" id="2993800">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2993808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2993811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2993814">return</span>&nbsp;<span class="ident" id="2993821">node</span><br>
<span class="lineno">595</span><span class="op" id="2993826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2993829">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="2993838">//&nbsp;&nbsp;&nbsp;&nbspliteral&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="2993880">//&nbsp;&nbsp;&nbsp;&nbspfunction&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="2993905">//&nbsp;&nbsp;&nbsp;&nbsp.</span><br>
<span class="lineno"></span><span class="comment" id="2993910">//&nbsp;&nbsp;&nbsp;&nbsp.Field</span><br>
<span class="lineno"></span><span class="comment" id="2993920">//&nbsp;&nbsp;&nbsp;&nbsp$</span><br>
<span class="lineno"></span><span class="comment" id="2993925">//&nbsp;&nbsp;&nbsp;&nbsp&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="2993945">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="2993981">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="2994032">func</span>&nbsp;<span class="op" id="2994037">(</span><span class="ident" id="2994038">t</span>&nbsp;<span class="op" id="2994040">*</span><span class="ident" id="2994041">Tree</span><span class="op" id="2994045">)</span>&nbsp;<span class="ident" id="2994047">term</span><span class="op" id="2994051">(</span><span class="op" id="2994052">)</span>&nbsp;<span class="ident" id="2994054">Node</span>&nbsp;<span class="op" id="2994059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994062">switch</span>&nbsp;<span class="ident" id="2994069">token</span>&nbsp;<span class="op" id="2994075">:=</span>&nbsp;<span class="ident" id="2994078">t</span><span class="op" id="2994079">.</span><span class="ident" id="2994080">nextNonSpace</span><span class="op" id="2994092">(</span><span class="op" id="2994093">)</span><span class="op" id="2994094">;</span>&nbsp;<span class="ident" id="2994096">token</span><span class="op" id="2994101">.</span><span class="ident" id="2994102">typ</span>&nbsp;<span class="op" id="2994106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994109">case</span>&nbsp;<span class="ident" id="2994114">itemError</span><span class="op" id="2994123">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994127">t</span><span class="op" id="2994128">.</span><span class="ident" id="2994129">errorf</span><span class="op" id="2994135">(</span><span class="string" id="2994136">&#34;%s&#34;</span><span class="op" id="2994140">,</span>&nbsp;<span class="ident" id="2994142">token</span><span class="op" id="2994147">.</span><span class="ident" id="2994148">val</span><span class="op" id="2994151">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994154">case</span>&nbsp;<span class="ident" id="2994159">itemIdentifier</span><span class="op" id="2994173">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994177">if</span>&nbsp;<span class="op" id="2994180">!</span><span class="ident" id="2994181">t</span><span class="op" id="2994182">.</span><span class="ident" id="2994183">hasFunction</span><span class="op" id="2994194">(</span><span class="ident" id="2994195">token</span><span class="op" id="2994200">.</span><span class="ident" id="2994201">val</span><span class="op" id="2994204">)</span>&nbsp;<span class="op" id="2994206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994211">t</span><span class="op" id="2994212">.</span><span class="ident" id="2994213">errorf</span><span class="op" id="2994219">(</span><span class="string" id="2994220">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="2994245">,</span>&nbsp;<span class="ident" id="2994247">token</span><span class="op" id="2994252">.</span><span class="ident" id="2994253">val</span><span class="op" id="2994256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2994260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994264">return</span>&nbsp;<span class="ident" id="2994271">NewIdentifier</span><span class="op" id="2994284">(</span><span class="ident" id="2994285">token</span><span class="op" id="2994290">.</span><span class="ident" id="2994291">val</span><span class="op" id="2994294">)</span><span class="op" id="2994295">.</span><span class="ident" id="2994296">SetTree</span><span class="op" id="2994303">(</span><span class="ident" id="2994304">t</span><span class="op" id="2994305">)</span><span class="op" id="2994306">.</span><span class="ident" id="2994307">SetPos</span><span class="op" id="2994313">(</span><span class="ident" id="2994314">token</span><span class="op" id="2994319">.</span><span class="ident" id="2994320">pos</span><span class="op" id="2994323">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994326">case</span>&nbsp;<span class="ident" id="2994331">itemDot</span><span class="op" id="2994338">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994342">return</span>&nbsp;<span class="ident" id="2994349">t</span><span class="op" id="2994350">.</span><span class="ident" id="2994351">newDot</span><span class="op" id="2994357">(</span><span class="ident" id="2994358">token</span><span class="op" id="2994363">.</span><span class="ident" id="2994364">pos</span><span class="op" id="2994367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994370">case</span>&nbsp;<span class="ident" id="2994375">itemNil</span><span class="op" id="2994382">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994386">return</span>&nbsp;<span class="ident" id="2994393">t</span><span class="op" id="2994394">.</span><span class="ident" id="2994395">newNil</span><span class="op" id="2994401">(</span><span class="ident" id="2994402">token</span><span class="op" id="2994407">.</span><span class="ident" id="2994408">pos</span><span class="op" id="2994411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994414">case</span>&nbsp;<span class="ident" id="2994419">itemVariable</span><span class="op" id="2994431">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994435">return</span>&nbsp;<span class="ident" id="2994442">t</span><span class="op" id="2994443">.</span><span class="ident" id="2994444">useVar</span><span class="op" id="2994450">(</span><span class="ident" id="2994451">token</span><span class="op" id="2994456">.</span><span class="ident" id="2994457">pos</span><span class="op" id="2994460">,</span>&nbsp;<span class="ident" id="2994462">token</span><span class="op" id="2994467">.</span><span class="ident" id="2994468">val</span><span class="op" id="2994471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994474">case</span>&nbsp;<span class="ident" id="2994479">itemField</span><span class="op" id="2994488">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994492">return</span>&nbsp;<span class="ident" id="2994499">t</span><span class="op" id="2994500">.</span><span class="ident" id="2994501">newField</span><span class="op" id="2994509">(</span><span class="ident" id="2994510">token</span><span class="op" id="2994515">.</span><span class="ident" id="2994516">pos</span><span class="op" id="2994519">,</span>&nbsp;<span class="ident" id="2994521">token</span><span class="op" id="2994526">.</span><span class="ident" id="2994527">val</span><span class="op" id="2994530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994533">case</span>&nbsp;<span class="ident" id="2994538">itemBool</span><span class="op" id="2994546">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994550">return</span>&nbsp;<span class="ident" id="2994557">t</span><span class="op" id="2994558">.</span><span class="ident" id="2994559">newBool</span><span class="op" id="2994566">(</span><span class="ident" id="2994567">token</span><span class="op" id="2994572">.</span><span class="ident" id="2994573">pos</span><span class="op" id="2994576">,</span>&nbsp;<span class="ident" id="2994578">token</span><span class="op" id="2994583">.</span><span class="ident" id="2994584">val</span>&nbsp;<span class="op" id="2994588">==</span>&nbsp;<span class="string" id="2994591">&#34;true&#34;</span><span class="op" id="2994597">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994600">case</span>&nbsp;<span class="ident" id="2994605">itemCharConstant</span><span class="op" id="2994621">,</span>&nbsp;<span class="ident" id="2994623">itemComplex</span><span class="op" id="2994634">,</span>&nbsp;<span class="ident" id="2994636">itemNumber</span><span class="op" id="2994646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994650">number</span><span class="op" id="2994656">,</span>&nbsp;<span class="ident" id="2994658">err</span>&nbsp;<span class="op" id="2994662">:=</span>&nbsp;<span class="ident" id="2994665">t</span><span class="op" id="2994666">.</span><span class="ident" id="2994667">newNumber</span><span class="op" id="2994676">(</span><span class="ident" id="2994677">token</span><span class="op" id="2994682">.</span><span class="ident" id="2994683">pos</span><span class="op" id="2994686">,</span>&nbsp;<span class="ident" id="2994688">token</span><span class="op" id="2994693">.</span><span class="ident" id="2994694">val</span><span class="op" id="2994697">,</span>&nbsp;<span class="ident" id="2994699">token</span><span class="op" id="2994704">.</span><span class="ident" id="2994705">typ</span><span class="op" id="2994708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994712">if</span>&nbsp;<span class="ident" id="2994715">err</span>&nbsp;<span class="op" id="2994719">!=</span>&nbsp;<span class="ident" id="2994722">nil</span>&nbsp;<span class="op" id="2994726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994731">t</span><span class="op" id="2994732">.</span><span class="builtintype" id="2994733">error</span><span class="op" id="2994738">(</span><span class="ident" id="2994739">err</span><span class="op" id="2994742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2994746">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994750">return</span>&nbsp;<span class="ident" id="2994757">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994765">case</span>&nbsp;<span class="ident" id="2994770">itemLeftParen</span><span class="op" id="2994783">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994787">pipe</span>&nbsp;<span class="op" id="2994792">:=</span>&nbsp;<span class="ident" id="2994795">t</span><span class="op" id="2994796">.</span><span class="ident" id="2994797">pipeline</span><span class="op" id="2994805">(</span><span class="string" id="2994806">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="2994830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994834">if</span>&nbsp;<span class="ident" id="2994837">token</span>&nbsp;<span class="op" id="2994843">:=</span>&nbsp;<span class="ident" id="2994846">t</span><span class="op" id="2994847">.</span><span class="ident" id="2994848">next</span><span class="op" id="2994852">(</span><span class="op" id="2994853">)</span><span class="op" id="2994854">;</span>&nbsp;<span class="ident" id="2994856">token</span><span class="op" id="2994861">.</span><span class="ident" id="2994862">typ</span>&nbsp;<span class="op" id="2994866">!=</span>&nbsp;<span class="ident" id="2994869">itemRightParen</span>&nbsp;<span class="op" id="2994884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994889">t</span><span class="op" id="2994890">.</span><span class="ident" id="2994891">errorf</span><span class="op" id="2994897">(</span><span class="string" id="2994898">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="2994935">,</span>&nbsp;<span class="ident" id="2994937">token</span><span class="op" id="2994942">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2994946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994950">return</span>&nbsp;<span class="ident" id="2994957">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2994963">case</span>&nbsp;<span class="ident" id="2994968">itemString</span><span class="op" id="2994978">,</span>&nbsp;<span class="ident" id="2994980">itemRawString</span><span class="op" id="2994993">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2994997">s</span><span class="op" id="2994998">,</span>&nbsp;<span class="ident" id="2995000">err</span>&nbsp;<span class="op" id="2995004">:=</span>&nbsp;<span class="ident" id="2995007">strconv</span><span class="op" id="2995014">.</span><span class="ident" id="2995015">Unquote</span><span class="op" id="2995022">(</span><span class="ident" id="2995023">token</span><span class="op" id="2995028">.</span><span class="ident" id="2995029">val</span><span class="op" id="2995032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995036">if</span>&nbsp;<span class="ident" id="2995039">err</span>&nbsp;<span class="op" id="2995043">!=</span>&nbsp;<span class="ident" id="2995046">nil</span>&nbsp;<span class="op" id="2995050">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2995055">t</span><span class="op" id="2995056">.</span><span class="builtintype" id="2995057">error</span><span class="op" id="2995062">(</span><span class="ident" id="2995063">err</span><span class="op" id="2995066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995074">return</span>&nbsp;<span class="ident" id="2995081">t</span><span class="op" id="2995082">.</span><span class="ident" id="2995083">newString</span><span class="op" id="2995092">(</span><span class="ident" id="2995093">token</span><span class="op" id="2995098">.</span><span class="ident" id="2995099">pos</span><span class="op" id="2995102">,</span>&nbsp;<span class="ident" id="2995104">token</span><span class="op" id="2995109">.</span><span class="ident" id="2995110">val</span><span class="op" id="2995113">,</span>&nbsp;<span class="ident" id="2995115">s</span><span class="op" id="2995116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2995122">t</span><span class="op" id="2995123">.</span><span class="ident" id="2995124">backup</span><span class="op" id="2995130">(</span><span class="op" id="2995131">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995134">return</span>&nbsp;<span class="ident" id="2995141">nil</span><br>
<span class="lineno"></span><span class="op" id="2995145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2995148">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="2995217">func</span>&nbsp;<span class="op" id="2995222">(</span><span class="ident" id="2995223">t</span>&nbsp;<span class="op" id="2995225">*</span><span class="ident" id="2995226">Tree</span><span class="op" id="2995230">)</span>&nbsp;<span class="ident" id="2995232">hasFunction</span><span class="op" id="2995243">(</span><span class="ident" id="2995244">name</span>&nbsp;<span class="builtintype" id="2995249">string</span><span class="op" id="2995255">)</span>&nbsp;<span class="builtintype" id="2995257">bool</span>&nbsp;<span class="op" id="2995262">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995265">for</span>&nbsp;<span class="ident" id="2995269">_</span><span class="op" id="2995270">,</span>&nbsp;<span class="ident" id="2995272">funcMap</span>&nbsp;<span class="op" id="2995280">:=</span>&nbsp;<span class="keyword" id="2995283">range</span>&nbsp;<span class="ident" id="2995289">t</span><span class="op" id="2995290">.</span><span class="ident" id="2995291">funcs</span>&nbsp;<span class="op" id="2995297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995301">if</span>&nbsp;<span class="ident" id="2995304">funcMap</span>&nbsp;<span class="op" id="2995312">==</span>&nbsp;<span class="ident" id="2995315">nil</span>&nbsp;<span class="op" id="2995319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995324">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995339">if</span>&nbsp;<span class="ident" id="2995342">funcMap</span><span class="op" id="2995349">[</span><span class="ident" id="2995350">name</span><span class="op" id="2995354">]</span>&nbsp;<span class="op" id="2995356">!=</span>&nbsp;<span class="ident" id="2995359">nil</span>&nbsp;<span class="op" id="2995363">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995368">return</span>&nbsp;<span class="builtintype" id="2995375">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995388">return</span>&nbsp;<span class="builtintype" id="2995395">false</span><br>
<span class="lineno"></span><span class="op" id="2995401">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="2995404">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="2995463">func</span>&nbsp;<span class="op" id="2995468">(</span><span class="ident" id="2995469">t</span>&nbsp;<span class="op" id="2995471">*</span><span class="ident" id="2995472">Tree</span><span class="op" id="2995476">)</span>&nbsp;<span class="ident" id="2995478">popVars</span><span class="op" id="2995485">(</span><span class="ident" id="2995486">n</span>&nbsp;<span class="builtintype" id="2995488">int</span><span class="op" id="2995491">)</span>&nbsp;<span class="op" id="2995493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2995496">t</span><span class="op" id="2995497">.</span><span class="ident" id="2995498">vars</span>&nbsp;<span class="op" id="2995503">=</span>&nbsp;<span class="ident" id="2995505">t</span><span class="op" id="2995506">.</span><span class="ident" id="2995507">vars</span><span class="op" id="2995511">[</span><span class="op" id="2995512">:</span><span class="ident" id="2995513">n</span><span class="op" id="2995514">]</span><br>
<span class="lineno"></span><span class="op" id="2995516">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="2995519">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2995587">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="2995615">func</span>&nbsp;<span class="op" id="2995620">(</span><span class="ident" id="2995621">t</span>&nbsp;<span class="op" id="2995623">*</span><span class="ident" id="2995624">Tree</span><span class="op" id="2995628">)</span>&nbsp;<span class="ident" id="2995630">useVar</span><span class="op" id="2995636">(</span><span class="ident" id="2995637">pos</span>&nbsp;<span class="ident" id="2995641">Pos</span><span class="op" id="2995644">,</span>&nbsp;<span class="ident" id="2995646">name</span>&nbsp;<span class="builtintype" id="2995651">string</span><span class="op" id="2995657">)</span>&nbsp;<span class="ident" id="2995659">Node</span>&nbsp;<span class="op" id="2995664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2995667">v</span>&nbsp;<span class="op" id="2995669">:=</span>&nbsp;<span class="ident" id="2995672">t</span><span class="op" id="2995673">.</span><span class="ident" id="2995674">newVariable</span><span class="op" id="2995685">(</span><span class="ident" id="2995686">pos</span><span class="op" id="2995689">,</span>&nbsp;<span class="ident" id="2995691">name</span><span class="op" id="2995695">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995698">for</span>&nbsp;<span class="ident" id="2995702">_</span><span class="op" id="2995703">,</span>&nbsp;<span class="ident" id="2995705">varName</span>&nbsp;<span class="op" id="2995713">:=</span>&nbsp;<span class="keyword" id="2995716">range</span>&nbsp;<span class="ident" id="2995722">t</span><span class="op" id="2995723">.</span><span class="ident" id="2995724">vars</span>&nbsp;<span class="op" id="2995729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995733">if</span>&nbsp;<span class="ident" id="2995736">varName</span>&nbsp;<span class="op" id="2995744">==</span>&nbsp;<span class="ident" id="2995747">v</span><span class="op" id="2995748">.</span><span class="ident" id="2995749">Ident</span><span class="op" id="2995754">[</span><span class="num" id="2995755">0</span><span class="op" id="2995756">]</span>&nbsp;<span class="op" id="2995758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995763">return</span>&nbsp;<span class="ident" id="2995770">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2995777">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2995780">t</span><span class="op" id="2995781">.</span><span class="ident" id="2995782">errorf</span><span class="op" id="2995788">(</span><span class="string" id="2995789">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="2995812">,</span>&nbsp;<span class="ident" id="2995814">v</span><span class="op" id="2995815">.</span><span class="ident" id="2995816">Ident</span><span class="op" id="2995821">[</span><span class="num" id="2995822">0</span><span class="op" id="2995823">]</span><span class="op" id="2995824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2995827">return</span>&nbsp;<span class="ident" id="2995834">nil</span><br>
<span class="lineno"></span><span class="op" id="2995838">}</span>
</div>
</body>
</html>
