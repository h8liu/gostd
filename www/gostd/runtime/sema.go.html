<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1691411">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1691466">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1691520">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1691571">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1691614">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1691660">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1691712">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1691752">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1691803">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1691841">//</span><br>
<span class="lineno"></span><span class="comment" id="1691844">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1691892">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1691948">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1692005">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1692068">//</span><br>
<span class="lineno"></span><span class="comment" id="1692071">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1692123">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1692158">package</span>&nbsp;<span class="ident" id="1692166">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1692175">import</span>&nbsp;<span class="string" id="1692182">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1692192">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1692235">type</span>&nbsp;<span class="ident" id="1692240">semaRoot</span>&nbsp;<span class="keyword" id="1692249">struct</span>&nbsp;<span class="op" id="1692256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692259">lock</span>&nbsp;&nbsp;<span class="ident" id="1692265">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692272">head</span>&nbsp;&nbsp;<span class="op" id="1692278">*</span><span class="ident" id="1692279">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692286">tail</span>&nbsp;&nbsp;<span class="op" id="1692292">*</span><span class="ident" id="1692293">sudog</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692300">nwait</span>&nbsp;<span class="builtintype" id="1692306">uint32</span>&nbsp;<span class="comment" id="1692313">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1692354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1692357">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1692407">const</span>&nbsp;<span class="ident" id="1692413">semTabSize</span>&nbsp;<span class="op" id="1692424">=</span>&nbsp;<span class="num" id="1692426">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1692431">var</span>&nbsp;<span class="ident" id="1692435">semtable</span>&nbsp;<span class="op" id="1692444">[</span><span class="ident" id="1692445">semTabSize</span><span class="op" id="1692455">]</span><span class="keyword" id="1692456">struct</span>&nbsp;<span class="op" id="1692463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692466">root</span>&nbsp;<span class="ident" id="1692471">semaRoot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692481">pad</span>&nbsp;&nbsp;<span class="op" id="1692486">[</span><span class="ident" id="1692487">_CacheLineSize</span>&nbsp;<span class="op" id="1692502">-</span>&nbsp;<span class="ident" id="1692504">unsafe</span><span class="op" id="1692510">.</span><span class="ident" id="1692511">Sizeof</span><span class="op" id="1692517">(</span><span class="ident" id="1692518">semaRoot</span><span class="op" id="1692526">{</span><span class="op" id="1692527">}</span><span class="op" id="1692528">)</span><span class="op" id="1692529">]</span><span class="builtintype" id="1692530">byte</span><br>
<span class="lineno"></span><span class="op" id="1692535">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1692538">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1692572">func</span>&nbsp;<span class="ident" id="1692577">asyncsemacquire</span><span class="op" id="1692592">(</span><span class="ident" id="1692593">addr</span>&nbsp;<span class="op" id="1692598">*</span><span class="builtintype" id="1692599">uint32</span><span class="op" id="1692605">)</span>&nbsp;<span class="op" id="1692607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692610">semacquire</span><span class="op" id="1692620">(</span><span class="ident" id="1692621">addr</span><span class="op" id="1692625">,</span>&nbsp;<span class="builtintype" id="1692627">true</span><span class="op" id="1692631">)</span><br>
<span class="lineno"></span><span class="op" id="1692633">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1692636">func</span>&nbsp;<span class="ident" id="1692641">asyncsemrelease</span><span class="op" id="1692656">(</span><span class="ident" id="1692657">addr</span>&nbsp;<span class="op" id="1692662">*</span><span class="builtintype" id="1692663">uint32</span><span class="op" id="1692669">)</span>&nbsp;<span class="op" id="1692671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692674">semrelease</span><span class="op" id="1692684">(</span><span class="ident" id="1692685">addr</span><span class="op" id="1692689">)</span><br>
<span class="lineno"></span><span class="op" id="1692691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1692694">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1692718">func</span>&nbsp;<span class="ident" id="1692723">semacquire</span><span class="op" id="1692733">(</span><span class="ident" id="1692734">addr</span>&nbsp;<span class="op" id="1692739">*</span><span class="builtintype" id="1692740">uint32</span><span class="op" id="1692746">,</span>&nbsp;<span class="ident" id="1692748">profile</span>&nbsp;<span class="builtintype" id="1692756">bool</span><span class="op" id="1692760">)</span>&nbsp;<span class="op" id="1692762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692765">gp</span>&nbsp;<span class="op" id="1692768">:=</span>&nbsp;<span class="ident" id="1692771">getg</span><span class="op" id="1692775">(</span><span class="op" id="1692776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692779">if</span>&nbsp;<span class="ident" id="1692782">gp</span>&nbsp;<span class="op" id="1692785">!=</span>&nbsp;<span class="ident" id="1692788">gp</span><span class="op" id="1692790">.</span><span class="ident" id="1692791">m</span><span class="op" id="1692792">.</span><span class="ident" id="1692793">curg</span>&nbsp;<span class="op" id="1692798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1692802">gothrow</span><span class="op" id="1692809">(</span><span class="string" id="1692810">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1692841">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692848">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692863">if</span>&nbsp;<span class="ident" id="1692866">cansemacquire</span><span class="op" id="1692879">(</span><span class="ident" id="1692880">addr</span><span class="op" id="1692884">)</span>&nbsp;<span class="op" id="1692886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1692890">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1692898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692902">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692919">//&nbsp;&nbsp;&nbsp;&nbspincrement&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1692946">//&nbsp;&nbsp;&nbsp;&nbsptry&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693003">//&nbsp;&nbsp;&nbsp;&nbspenqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693034">//&nbsp;&nbsp;&nbsp;&nbspsleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693044">//&nbsp;&nbsp;&nbsp;&nbsp(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693092">s</span>&nbsp;<span class="op" id="1693094">:=</span>&nbsp;<span class="ident" id="1693097">acquireSudog</span><span class="op" id="1693109">(</span><span class="op" id="1693110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693113">root</span>&nbsp;<span class="op" id="1693118">:=</span>&nbsp;<span class="ident" id="1693121">semroot</span><span class="op" id="1693128">(</span><span class="ident" id="1693129">addr</span><span class="op" id="1693133">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693136">t0</span>&nbsp;<span class="op" id="1693139">:=</span>&nbsp;<span class="ident" id="1693142">int64</span><span class="op" id="1693147">(</span><span class="num" id="1693148">0</span><span class="op" id="1693149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693152">s</span><span class="op" id="1693153">.</span><span class="ident" id="1693154">releasetime</span>&nbsp;<span class="op" id="1693166">=</span>&nbsp;<span class="num" id="1693168">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693171">if</span>&nbsp;<span class="ident" id="1693174">profile</span>&nbsp;<span class="op" id="1693182">&amp;&amp;</span>&nbsp;<span class="ident" id="1693185">blockprofilerate</span>&nbsp;<span class="op" id="1693202">&gt;</span>&nbsp;<span class="num" id="1693204">0</span>&nbsp;<span class="op" id="1693206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693210">t0</span>&nbsp;<span class="op" id="1693213">=</span>&nbsp;<span class="ident" id="1693215">cputicks</span><span class="op" id="1693223">(</span><span class="op" id="1693224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693228">s</span><span class="op" id="1693229">.</span><span class="ident" id="1693230">releasetime</span>&nbsp;<span class="op" id="1693242">=</span>&nbsp;<span class="op" id="1693244">-</span><span class="num" id="1693245">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693251">for</span>&nbsp;<span class="op" id="1693255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693259">lock</span><span class="op" id="1693263">(</span><span class="op" id="1693264">&amp;</span><span class="ident" id="1693265">root</span><span class="op" id="1693269">.</span><span class="ident" id="1693270">lock</span><span class="op" id="1693274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693278">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693344">xadd</span><span class="op" id="1693348">(</span><span class="op" id="1693349">&amp;</span><span class="ident" id="1693350">root</span><span class="op" id="1693354">.</span><span class="ident" id="1693355">nwait</span><span class="op" id="1693360">,</span>&nbsp;<span class="num" id="1693362">1</span><span class="op" id="1693363">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693367">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693416">if</span>&nbsp;<span class="ident" id="1693419">cansemacquire</span><span class="op" id="1693432">(</span><span class="ident" id="1693433">addr</span><span class="op" id="1693437">)</span>&nbsp;<span class="op" id="1693439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693444">xadd</span><span class="op" id="1693448">(</span><span class="op" id="1693449">&amp;</span><span class="ident" id="1693450">root</span><span class="op" id="1693454">.</span><span class="ident" id="1693455">nwait</span><span class="op" id="1693460">,</span>&nbsp;<span class="op" id="1693462">-</span><span class="num" id="1693463">1</span><span class="op" id="1693464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693469">unlock</span><span class="op" id="1693475">(</span><span class="op" id="1693476">&amp;</span><span class="ident" id="1693477">root</span><span class="op" id="1693481">.</span><span class="ident" id="1693482">lock</span><span class="op" id="1693486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693491">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693503">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693567">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693610">root</span><span class="op" id="1693614">.</span><span class="ident" id="1693615">queue</span><span class="op" id="1693620">(</span><span class="ident" id="1693621">addr</span><span class="op" id="1693625">,</span>&nbsp;<span class="ident" id="1693627">s</span><span class="op" id="1693628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693632">goparkunlock</span><span class="op" id="1693644">(</span><span class="op" id="1693645">&amp;</span><span class="ident" id="1693646">root</span><span class="op" id="1693650">.</span><span class="ident" id="1693651">lock</span><span class="op" id="1693655">,</span>&nbsp;<span class="string" id="1693657">&#34;semacquire&#34;</span><span class="op" id="1693669">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693673">if</span>&nbsp;<span class="ident" id="1693676">cansemacquire</span><span class="op" id="1693689">(</span><span class="ident" id="1693690">addr</span><span class="op" id="1693694">)</span>&nbsp;<span class="op" id="1693696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693701">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693715">if</span>&nbsp;<span class="ident" id="1693718">s</span><span class="op" id="1693719">.</span><span class="ident" id="1693720">releasetime</span>&nbsp;<span class="op" id="1693732">&gt;</span>&nbsp;<span class="num" id="1693734">0</span>&nbsp;<span class="op" id="1693736">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693740">blockevent</span><span class="op" id="1693750">(</span><span class="ident" id="1693751">int64</span><span class="op" id="1693756">(</span><span class="ident" id="1693757">s</span><span class="op" id="1693758">.</span><span class="ident" id="1693759">releasetime</span><span class="op" id="1693770">)</span><span class="op" id="1693771">-</span><span class="ident" id="1693772">t0</span><span class="op" id="1693774">,</span>&nbsp;<span class="num" id="1693776">3</span><span class="op" id="1693777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1693780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693783">releaseSudog</span><span class="op" id="1693795">(</span><span class="ident" id="1693796">s</span><span class="op" id="1693797">)</span><br>
<span class="lineno"></span><span class="op" id="1693799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1693802">func</span>&nbsp;<span class="ident" id="1693807">semrelease</span><span class="op" id="1693817">(</span><span class="ident" id="1693818">addr</span>&nbsp;<span class="op" id="1693823">*</span><span class="builtintype" id="1693824">uint32</span><span class="op" id="1693830">)</span>&nbsp;<span class="op" id="1693832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693835">root</span>&nbsp;<span class="op" id="1693840">:=</span>&nbsp;<span class="ident" id="1693843">semroot</span><span class="op" id="1693850">(</span><span class="ident" id="1693851">addr</span><span class="op" id="1693855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1693858">xadd</span><span class="op" id="1693862">(</span><span class="ident" id="1693863">addr</span><span class="op" id="1693867">,</span>&nbsp;<span class="num" id="1693869">1</span><span class="op" id="1693870">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693874">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693901">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1693969">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1693999">if</span>&nbsp;<span class="ident" id="1694002">atomicload</span><span class="op" id="1694012">(</span><span class="op" id="1694013">&amp;</span><span class="ident" id="1694014">root</span><span class="op" id="1694018">.</span><span class="ident" id="1694019">nwait</span><span class="op" id="1694024">)</span>&nbsp;<span class="op" id="1694026">==</span>&nbsp;<span class="num" id="1694029">0</span>&nbsp;<span class="op" id="1694031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694035">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694043">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1694047">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694097">lock</span><span class="op" id="1694101">(</span><span class="op" id="1694102">&amp;</span><span class="ident" id="1694103">root</span><span class="op" id="1694107">.</span><span class="ident" id="1694108">lock</span><span class="op" id="1694112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694115">if</span>&nbsp;<span class="ident" id="1694118">atomicload</span><span class="op" id="1694128">(</span><span class="op" id="1694129">&amp;</span><span class="ident" id="1694130">root</span><span class="op" id="1694134">.</span><span class="ident" id="1694135">nwait</span><span class="op" id="1694140">)</span>&nbsp;<span class="op" id="1694142">==</span>&nbsp;<span class="num" id="1694145">0</span>&nbsp;<span class="op" id="1694147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1694151">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1694208">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694254">unlock</span><span class="op" id="1694260">(</span><span class="op" id="1694261">&amp;</span><span class="ident" id="1694262">root</span><span class="op" id="1694266">.</span><span class="ident" id="1694267">lock</span><span class="op" id="1694271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694275">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694286">s</span>&nbsp;<span class="op" id="1694288">:=</span>&nbsp;<span class="ident" id="1694291">root</span><span class="op" id="1694295">.</span><span class="ident" id="1694296">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694302">for</span>&nbsp;<span class="op" id="1694306">;</span>&nbsp;<span class="ident" id="1694308">s</span>&nbsp;<span class="op" id="1694310">!=</span>&nbsp;<span class="ident" id="1694313">nil</span><span class="op" id="1694316">;</span>&nbsp;<span class="ident" id="1694318">s</span>&nbsp;<span class="op" id="1694320">=</span>&nbsp;<span class="ident" id="1694322">s</span><span class="op" id="1694323">.</span><span class="ident" id="1694324">next</span>&nbsp;<span class="op" id="1694329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694333">if</span>&nbsp;<span class="ident" id="1694336">s</span><span class="op" id="1694337">.</span><span class="ident" id="1694338">elem</span>&nbsp;<span class="op" id="1694343">==</span>&nbsp;<span class="ident" id="1694346">unsafe</span><span class="op" id="1694352">.</span><span class="ident" id="1694353">Pointer</span><span class="op" id="1694360">(</span><span class="ident" id="1694361">addr</span><span class="op" id="1694365">)</span>&nbsp;<span class="op" id="1694367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694372">xadd</span><span class="op" id="1694376">(</span><span class="op" id="1694377">&amp;</span><span class="ident" id="1694378">root</span><span class="op" id="1694382">.</span><span class="ident" id="1694383">nwait</span><span class="op" id="1694388">,</span>&nbsp;<span class="op" id="1694390">-</span><span class="num" id="1694391">1</span><span class="op" id="1694392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694397">root</span><span class="op" id="1694401">.</span><span class="ident" id="1694402">dequeue</span><span class="op" id="1694409">(</span><span class="ident" id="1694410">s</span><span class="op" id="1694411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694416">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694430">unlock</span><span class="op" id="1694436">(</span><span class="op" id="1694437">&amp;</span><span class="ident" id="1694438">root</span><span class="op" id="1694442">.</span><span class="ident" id="1694443">lock</span><span class="op" id="1694447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694450">if</span>&nbsp;<span class="ident" id="1694453">s</span>&nbsp;<span class="op" id="1694455">!=</span>&nbsp;<span class="ident" id="1694458">nil</span>&nbsp;<span class="op" id="1694462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694466">if</span>&nbsp;<span class="ident" id="1694469">s</span><span class="op" id="1694470">.</span><span class="ident" id="1694471">releasetime</span>&nbsp;<span class="op" id="1694483">!=</span>&nbsp;<span class="num" id="1694486">0</span>&nbsp;<span class="op" id="1694488">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694493">s</span><span class="op" id="1694494">.</span><span class="ident" id="1694495">releasetime</span>&nbsp;<span class="op" id="1694507">=</span>&nbsp;<span class="ident" id="1694509">cputicks</span><span class="op" id="1694517">(</span><span class="op" id="1694518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694526">goready</span><span class="op" id="1694533">(</span><span class="ident" id="1694534">s</span><span class="op" id="1694535">.</span><span class="ident" id="1694536">g</span><span class="op" id="1694537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694540">}</span><br>
<span class="lineno"></span><span class="op" id="1694542">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1694545">func</span>&nbsp;<span class="ident" id="1694550">semroot</span><span class="op" id="1694557">(</span><span class="ident" id="1694558">addr</span>&nbsp;<span class="op" id="1694563">*</span><span class="builtintype" id="1694564">uint32</span><span class="op" id="1694570">)</span>&nbsp;<span class="op" id="1694572">*</span><span class="ident" id="1694573">semaRoot</span>&nbsp;<span class="op" id="1694582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694585">return</span>&nbsp;<span class="op" id="1694592">&amp;</span><span class="ident" id="1694593">semtable</span><span class="op" id="1694601">[</span><span class="op" id="1694602">(</span><span class="builtintype" id="1694603">uintptr</span><span class="op" id="1694610">(</span><span class="ident" id="1694611">unsafe</span><span class="op" id="1694617">.</span><span class="ident" id="1694618">Pointer</span><span class="op" id="1694625">(</span><span class="ident" id="1694626">addr</span><span class="op" id="1694630">)</span><span class="op" id="1694631">)</span><span class="op" id="1694632">&gt;&gt;</span><span class="num" id="1694634">3</span><span class="op" id="1694635">)</span><span class="op" id="1694636">%</span><span class="ident" id="1694637">semTabSize</span><span class="op" id="1694647">]</span><span class="op" id="1694648">.</span><span class="ident" id="1694649">root</span><br>
<span class="lineno"></span><span class="op" id="1694654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1694657">func</span>&nbsp;<span class="ident" id="1694662">cansemacquire</span><span class="op" id="1694675">(</span><span class="ident" id="1694676">addr</span>&nbsp;<span class="op" id="1694681">*</span><span class="builtintype" id="1694682">uint32</span><span class="op" id="1694688">)</span>&nbsp;<span class="builtintype" id="1694690">bool</span>&nbsp;<span class="op" id="1694695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694698">for</span>&nbsp;<span class="op" id="1694702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694706">v</span>&nbsp;<span class="op" id="1694708">:=</span>&nbsp;<span class="ident" id="1694711">atomicload</span><span class="op" id="1694721">(</span><span class="ident" id="1694722">addr</span><span class="op" id="1694726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694730">if</span>&nbsp;<span class="ident" id="1694733">v</span>&nbsp;<span class="op" id="1694735">==</span>&nbsp;<span class="num" id="1694738">0</span>&nbsp;<span class="op" id="1694740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694745">return</span>&nbsp;<span class="builtintype" id="1694752">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694764">if</span>&nbsp;<span class="ident" id="1694767">cas</span><span class="op" id="1694770">(</span><span class="ident" id="1694771">addr</span><span class="op" id="1694775">,</span>&nbsp;<span class="ident" id="1694777">v</span><span class="op" id="1694778">,</span>&nbsp;<span class="ident" id="1694780">v</span><span class="op" id="1694781">-</span><span class="num" id="1694782">1</span><span class="op" id="1694783">)</span>&nbsp;<span class="op" id="1694785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694790">return</span>&nbsp;<span class="builtintype" id="1694797">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694807">}</span><br>
<span class="lineno">150</span><span class="op" id="1694809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1694812">func</span>&nbsp;<span class="op" id="1694817">(</span><span class="ident" id="1694818">root</span>&nbsp;<span class="op" id="1694823">*</span><span class="ident" id="1694824">semaRoot</span><span class="op" id="1694832">)</span>&nbsp;<span class="ident" id="1694834">queue</span><span class="op" id="1694839">(</span><span class="ident" id="1694840">addr</span>&nbsp;<span class="op" id="1694845">*</span><span class="builtintype" id="1694846">uint32</span><span class="op" id="1694852">,</span>&nbsp;<span class="ident" id="1694854">s</span>&nbsp;<span class="op" id="1694856">*</span><span class="ident" id="1694857">sudog</span><span class="op" id="1694862">)</span>&nbsp;<span class="op" id="1694864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694867">s</span><span class="op" id="1694868">.</span><span class="ident" id="1694869">g</span>&nbsp;<span class="op" id="1694871">=</span>&nbsp;<span class="ident" id="1694873">getg</span><span class="op" id="1694877">(</span><span class="op" id="1694878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694881">s</span><span class="op" id="1694882">.</span><span class="ident" id="1694883">elem</span>&nbsp;<span class="op" id="1694888">=</span>&nbsp;<span class="ident" id="1694890">unsafe</span><span class="op" id="1694896">.</span><span class="ident" id="1694897">Pointer</span><span class="op" id="1694904">(</span><span class="ident" id="1694905">addr</span><span class="op" id="1694909">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694912">s</span><span class="op" id="1694913">.</span><span class="ident" id="1694914">next</span>&nbsp;<span class="op" id="1694919">=</span>&nbsp;<span class="ident" id="1694921">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694926">s</span><span class="op" id="1694927">.</span><span class="ident" id="1694928">prev</span>&nbsp;<span class="op" id="1694933">=</span>&nbsp;<span class="ident" id="1694935">root</span><span class="op" id="1694939">.</span><span class="ident" id="1694940">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1694946">if</span>&nbsp;<span class="ident" id="1694949">root</span><span class="op" id="1694953">.</span><span class="ident" id="1694954">tail</span>&nbsp;<span class="op" id="1694959">!=</span>&nbsp;<span class="ident" id="1694962">nil</span>&nbsp;<span class="op" id="1694966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1694970">root</span><span class="op" id="1694974">.</span><span class="ident" id="1694975">tail</span><span class="op" id="1694979">.</span><span class="ident" id="1694980">next</span>&nbsp;<span class="op" id="1694985">=</span>&nbsp;<span class="ident" id="1694987">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1694990">}</span>&nbsp;<span class="keyword" id="1694992">else</span>&nbsp;<span class="op" id="1694997">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695001">root</span><span class="op" id="1695005">.</span><span class="ident" id="1695006">head</span>&nbsp;<span class="op" id="1695011">=</span>&nbsp;<span class="ident" id="1695013">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695019">root</span><span class="op" id="1695023">.</span><span class="ident" id="1695024">tail</span>&nbsp;<span class="op" id="1695029">=</span>&nbsp;<span class="ident" id="1695031">s</span><br>
<span class="lineno"></span><span class="op" id="1695033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1695036">func</span>&nbsp;<span class="op" id="1695041">(</span><span class="ident" id="1695042">root</span>&nbsp;<span class="op" id="1695047">*</span><span class="ident" id="1695048">semaRoot</span><span class="op" id="1695056">)</span>&nbsp;<span class="ident" id="1695058">dequeue</span><span class="op" id="1695065">(</span><span class="ident" id="1695066">s</span>&nbsp;<span class="op" id="1695068">*</span><span class="ident" id="1695069">sudog</span><span class="op" id="1695074">)</span>&nbsp;<span class="op" id="1695076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695079">if</span>&nbsp;<span class="ident" id="1695082">s</span><span class="op" id="1695083">.</span><span class="ident" id="1695084">next</span>&nbsp;<span class="op" id="1695089">!=</span>&nbsp;<span class="ident" id="1695092">nil</span>&nbsp;<span class="op" id="1695096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695100">s</span><span class="op" id="1695101">.</span><span class="ident" id="1695102">next</span><span class="op" id="1695106">.</span><span class="ident" id="1695107">prev</span>&nbsp;<span class="op" id="1695112">=</span>&nbsp;<span class="ident" id="1695114">s</span><span class="op" id="1695115">.</span><span class="ident" id="1695116">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695122">}</span>&nbsp;<span class="keyword" id="1695124">else</span>&nbsp;<span class="op" id="1695129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695133">root</span><span class="op" id="1695137">.</span><span class="ident" id="1695138">tail</span>&nbsp;<span class="op" id="1695143">=</span>&nbsp;<span class="ident" id="1695145">s</span><span class="op" id="1695146">.</span><span class="ident" id="1695147">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695156">if</span>&nbsp;<span class="ident" id="1695159">s</span><span class="op" id="1695160">.</span><span class="ident" id="1695161">prev</span>&nbsp;<span class="op" id="1695166">!=</span>&nbsp;<span class="ident" id="1695169">nil</span>&nbsp;<span class="op" id="1695173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695177">s</span><span class="op" id="1695178">.</span><span class="ident" id="1695179">prev</span><span class="op" id="1695183">.</span><span class="ident" id="1695184">next</span>&nbsp;<span class="op" id="1695189">=</span>&nbsp;<span class="ident" id="1695191">s</span><span class="op" id="1695192">.</span><span class="ident" id="1695193">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695199">}</span>&nbsp;<span class="keyword" id="1695201">else</span>&nbsp;<span class="op" id="1695206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695210">root</span><span class="op" id="1695214">.</span><span class="ident" id="1695215">head</span>&nbsp;<span class="op" id="1695220">=</span>&nbsp;<span class="ident" id="1695222">s</span><span class="op" id="1695223">.</span><span class="ident" id="1695224">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695233">s</span><span class="op" id="1695234">.</span><span class="ident" id="1695235">elem</span>&nbsp;<span class="op" id="1695240">=</span>&nbsp;<span class="ident" id="1695242">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695247">s</span><span class="op" id="1695248">.</span><span class="ident" id="1695249">next</span>&nbsp;<span class="op" id="1695254">=</span>&nbsp;<span class="ident" id="1695256">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695261">s</span><span class="op" id="1695262">.</span><span class="ident" id="1695263">prev</span>&nbsp;<span class="op" id="1695268">=</span>&nbsp;<span class="ident" id="1695270">nil</span><br>
<span class="lineno"></span><span class="op" id="1695274">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1695277">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1695317">type</span>&nbsp;<span class="ident" id="1695322">syncSema</span>&nbsp;<span class="keyword" id="1695331">struct</span>&nbsp;<span class="op" id="1695338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695341">lock</span>&nbsp;<span class="ident" id="1695346">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695353">head</span>&nbsp;<span class="op" id="1695358">*</span><span class="ident" id="1695359">sudog</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695366">tail</span>&nbsp;<span class="op" id="1695371">*</span><span class="ident" id="1695372">sudog</span><br>
<span class="lineno"></span><span class="op" id="1695378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1695381">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1695459">func</span>&nbsp;<span class="ident" id="1695464">syncsemacquire</span><span class="op" id="1695478">(</span><span class="ident" id="1695479">s</span>&nbsp;<span class="op" id="1695481">*</span><span class="ident" id="1695482">syncSema</span><span class="op" id="1695490">)</span>&nbsp;<span class="op" id="1695492">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695495">lock</span><span class="op" id="1695499">(</span><span class="op" id="1695500">&amp;</span><span class="ident" id="1695501">s</span><span class="op" id="1695502">.</span><span class="ident" id="1695503">lock</span><span class="op" id="1695507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695510">if</span>&nbsp;<span class="ident" id="1695513">s</span><span class="op" id="1695514">.</span><span class="ident" id="1695515">head</span>&nbsp;<span class="op" id="1695520">!=</span>&nbsp;<span class="ident" id="1695523">nil</span>&nbsp;<span class="op" id="1695527">&amp;&amp;</span>&nbsp;<span class="ident" id="1695530">s</span><span class="op" id="1695531">.</span><span class="ident" id="1695532">head</span><span class="op" id="1695536">.</span><span class="ident" id="1695537">nrelease</span>&nbsp;<span class="op" id="1695546">&gt;</span>&nbsp;<span class="num" id="1695548">0</span>&nbsp;<span class="op" id="1695550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1695554">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695593">var</span>&nbsp;<span class="ident" id="1695597">wake</span>&nbsp;<span class="op" id="1695602">*</span><span class="ident" id="1695603">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695611">s</span><span class="op" id="1695612">.</span><span class="ident" id="1695613">head</span><span class="op" id="1695617">.</span><span class="ident" id="1695618">nrelease</span><span class="op" id="1695626">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695631">if</span>&nbsp;<span class="ident" id="1695634">s</span><span class="op" id="1695635">.</span><span class="ident" id="1695636">head</span><span class="op" id="1695640">.</span><span class="ident" id="1695641">nrelease</span>&nbsp;<span class="op" id="1695650">==</span>&nbsp;<span class="num" id="1695653">0</span>&nbsp;<span class="op" id="1695655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695660">wake</span>&nbsp;<span class="op" id="1695665">=</span>&nbsp;<span class="ident" id="1695667">s</span><span class="op" id="1695668">.</span><span class="ident" id="1695669">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695677">s</span><span class="op" id="1695678">.</span><span class="ident" id="1695679">head</span>&nbsp;<span class="op" id="1695684">=</span>&nbsp;<span class="ident" id="1695686">wake</span><span class="op" id="1695690">.</span><span class="ident" id="1695691">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695699">if</span>&nbsp;<span class="ident" id="1695702">s</span><span class="op" id="1695703">.</span><span class="ident" id="1695704">head</span>&nbsp;<span class="op" id="1695709">==</span>&nbsp;<span class="ident" id="1695712">nil</span>&nbsp;<span class="op" id="1695716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695722">s</span><span class="op" id="1695723">.</span><span class="ident" id="1695724">tail</span>&nbsp;<span class="op" id="1695729">=</span>&nbsp;<span class="ident" id="1695731">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695746">unlock</span><span class="op" id="1695752">(</span><span class="op" id="1695753">&amp;</span><span class="ident" id="1695754">s</span><span class="op" id="1695755">.</span><span class="ident" id="1695756">lock</span><span class="op" id="1695760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695764">if</span>&nbsp;<span class="ident" id="1695767">wake</span>&nbsp;<span class="op" id="1695772">!=</span>&nbsp;<span class="ident" id="1695775">nil</span>&nbsp;<span class="op" id="1695779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695784">wake</span><span class="op" id="1695788">.</span><span class="ident" id="1695789">next</span>&nbsp;<span class="op" id="1695794">=</span>&nbsp;<span class="ident" id="1695796">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695803">goready</span><span class="op" id="1695810">(</span><span class="ident" id="1695811">wake</span><span class="op" id="1695815">.</span><span class="ident" id="1695816">g</span><span class="op" id="1695817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1695824">}</span>&nbsp;<span class="keyword" id="1695826">else</span>&nbsp;<span class="op" id="1695831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1695835">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695856">w</span>&nbsp;<span class="op" id="1695858">:=</span>&nbsp;<span class="ident" id="1695861">acquireSudog</span><span class="op" id="1695873">(</span><span class="op" id="1695874">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695878">w</span><span class="op" id="1695879">.</span><span class="ident" id="1695880">g</span>&nbsp;<span class="op" id="1695882">=</span>&nbsp;<span class="ident" id="1695884">getg</span><span class="op" id="1695888">(</span><span class="op" id="1695889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695893">w</span><span class="op" id="1695894">.</span><span class="ident" id="1695895">nrelease</span>&nbsp;<span class="op" id="1695904">=</span>&nbsp;<span class="op" id="1695906">-</span><span class="num" id="1695907">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695911">w</span><span class="op" id="1695912">.</span><span class="ident" id="1695913">next</span>&nbsp;<span class="op" id="1695918">=</span>&nbsp;<span class="ident" id="1695920">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695926">w</span><span class="op" id="1695927">.</span><span class="ident" id="1695928">releasetime</span>&nbsp;<span class="op" id="1695940">=</span>&nbsp;<span class="num" id="1695942">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695946">t0</span>&nbsp;<span class="op" id="1695949">:=</span>&nbsp;<span class="ident" id="1695952">int64</span><span class="op" id="1695957">(</span><span class="num" id="1695958">0</span><span class="op" id="1695959">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1695963">if</span>&nbsp;<span class="ident" id="1695966">blockprofilerate</span>&nbsp;<span class="op" id="1695983">&gt;</span>&nbsp;<span class="num" id="1695985">0</span>&nbsp;<span class="op" id="1695987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1695992">t0</span>&nbsp;<span class="op" id="1695995">=</span>&nbsp;<span class="ident" id="1695997">cputicks</span><span class="op" id="1696005">(</span><span class="op" id="1696006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696011">w</span><span class="op" id="1696012">.</span><span class="ident" id="1696013">releasetime</span>&nbsp;<span class="op" id="1696025">=</span>&nbsp;<span class="op" id="1696027">-</span><span class="num" id="1696028">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696036">if</span>&nbsp;<span class="ident" id="1696039">s</span><span class="op" id="1696040">.</span><span class="ident" id="1696041">tail</span>&nbsp;<span class="op" id="1696046">==</span>&nbsp;<span class="ident" id="1696049">nil</span>&nbsp;<span class="op" id="1696053">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696058">s</span><span class="op" id="1696059">.</span><span class="ident" id="1696060">head</span>&nbsp;<span class="op" id="1696065">=</span>&nbsp;<span class="ident" id="1696067">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696071">}</span>&nbsp;<span class="keyword" id="1696073">else</span>&nbsp;<span class="op" id="1696078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696083">s</span><span class="op" id="1696084">.</span><span class="ident" id="1696085">tail</span><span class="op" id="1696089">.</span><span class="ident" id="1696090">next</span>&nbsp;<span class="op" id="1696095">=</span>&nbsp;<span class="ident" id="1696097">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696105">s</span><span class="op" id="1696106">.</span><span class="ident" id="1696107">tail</span>&nbsp;<span class="op" id="1696112">=</span>&nbsp;<span class="ident" id="1696114">w</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696118">goparkunlock</span><span class="op" id="1696130">(</span><span class="op" id="1696131">&amp;</span><span class="ident" id="1696132">s</span><span class="op" id="1696133">.</span><span class="ident" id="1696134">lock</span><span class="op" id="1696138">,</span>&nbsp;<span class="string" id="1696140">&#34;semacquire&#34;</span><span class="op" id="1696152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696156">if</span>&nbsp;<span class="ident" id="1696159">t0</span>&nbsp;<span class="op" id="1696162">!=</span>&nbsp;<span class="num" id="1696165">0</span>&nbsp;<span class="op" id="1696167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696172">blockevent</span><span class="op" id="1696182">(</span><span class="ident" id="1696183">int64</span><span class="op" id="1696188">(</span><span class="ident" id="1696189">w</span><span class="op" id="1696190">.</span><span class="ident" id="1696191">releasetime</span><span class="op" id="1696202">)</span><span class="op" id="1696203">-</span><span class="ident" id="1696204">t0</span><span class="op" id="1696206">,</span>&nbsp;<span class="num" id="1696208">2</span><span class="op" id="1696209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696217">releaseSudog</span><span class="op" id="1696229">(</span><span class="ident" id="1696230">w</span><span class="op" id="1696231">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696234">}</span><br>
<span class="lineno"></span><span class="op" id="1696236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1696239">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1696317">func</span>&nbsp;<span class="ident" id="1696322">syncsemrelease</span><span class="op" id="1696336">(</span><span class="ident" id="1696337">s</span>&nbsp;<span class="op" id="1696339">*</span><span class="ident" id="1696340">syncSema</span><span class="op" id="1696348">,</span>&nbsp;<span class="ident" id="1696350">n</span>&nbsp;<span class="builtintype" id="1696352">uint32</span><span class="op" id="1696358">)</span>&nbsp;<span class="op" id="1696360">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696363">lock</span><span class="op" id="1696367">(</span><span class="op" id="1696368">&amp;</span><span class="ident" id="1696369">s</span><span class="op" id="1696370">.</span><span class="ident" id="1696371">lock</span><span class="op" id="1696375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696378">for</span>&nbsp;<span class="ident" id="1696382">n</span>&nbsp;<span class="op" id="1696384">&gt;</span>&nbsp;<span class="num" id="1696386">0</span>&nbsp;<span class="op" id="1696388">&amp;&amp;</span>&nbsp;<span class="ident" id="1696391">s</span><span class="op" id="1696392">.</span><span class="ident" id="1696393">head</span>&nbsp;<span class="op" id="1696398">!=</span>&nbsp;<span class="ident" id="1696401">nil</span>&nbsp;<span class="op" id="1696405">&amp;&amp;</span>&nbsp;<span class="ident" id="1696408">s</span><span class="op" id="1696409">.</span><span class="ident" id="1696410">head</span><span class="op" id="1696414">.</span><span class="ident" id="1696415">nrelease</span>&nbsp;<span class="op" id="1696424">&lt;</span>&nbsp;<span class="num" id="1696426">0</span>&nbsp;<span class="op" id="1696428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1696432">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696471">wake</span>&nbsp;<span class="op" id="1696476">:=</span>&nbsp;<span class="ident" id="1696479">s</span><span class="op" id="1696480">.</span><span class="ident" id="1696481">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696488">s</span><span class="op" id="1696489">.</span><span class="ident" id="1696490">head</span>&nbsp;<span class="op" id="1696495">=</span>&nbsp;<span class="ident" id="1696497">wake</span><span class="op" id="1696501">.</span><span class="ident" id="1696502">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696509">if</span>&nbsp;<span class="ident" id="1696512">s</span><span class="op" id="1696513">.</span><span class="ident" id="1696514">head</span>&nbsp;<span class="op" id="1696519">==</span>&nbsp;<span class="ident" id="1696522">nil</span>&nbsp;<span class="op" id="1696526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696531">s</span><span class="op" id="1696532">.</span><span class="ident" id="1696533">tail</span>&nbsp;<span class="op" id="1696538">=</span>&nbsp;<span class="ident" id="1696540">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696550">if</span>&nbsp;<span class="ident" id="1696553">wake</span><span class="op" id="1696557">.</span><span class="ident" id="1696558">releasetime</span>&nbsp;<span class="op" id="1696570">!=</span>&nbsp;<span class="num" id="1696573">0</span>&nbsp;<span class="op" id="1696575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696580">wake</span><span class="op" id="1696584">.</span><span class="ident" id="1696585">releasetime</span>&nbsp;<span class="op" id="1696597">=</span>&nbsp;<span class="ident" id="1696599">cputicks</span><span class="op" id="1696607">(</span><span class="op" id="1696608">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696616">wake</span><span class="op" id="1696620">.</span><span class="ident" id="1696621">next</span>&nbsp;<span class="op" id="1696626">=</span>&nbsp;<span class="ident" id="1696628">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696634">goready</span><span class="op" id="1696641">(</span><span class="ident" id="1696642">wake</span><span class="op" id="1696646">.</span><span class="ident" id="1696647">g</span><span class="op" id="1696648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696652">n</span><span class="op" id="1696653">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696657">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696660">if</span>&nbsp;<span class="ident" id="1696663">n</span>&nbsp;<span class="op" id="1696665">&gt;</span>&nbsp;<span class="num" id="1696667">0</span>&nbsp;<span class="op" id="1696669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1696673">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696693">w</span>&nbsp;<span class="op" id="1696695">:=</span>&nbsp;<span class="ident" id="1696698">acquireSudog</span><span class="op" id="1696710">(</span><span class="op" id="1696711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696715">w</span><span class="op" id="1696716">.</span><span class="ident" id="1696717">g</span>&nbsp;<span class="op" id="1696719">=</span>&nbsp;<span class="ident" id="1696721">getg</span><span class="op" id="1696725">(</span><span class="op" id="1696726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696730">w</span><span class="op" id="1696731">.</span><span class="ident" id="1696732">nrelease</span>&nbsp;<span class="op" id="1696741">=</span>&nbsp;<span class="builtintype" id="1696743">int32</span><span class="op" id="1696748">(</span><span class="ident" id="1696749">n</span><span class="op" id="1696750">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696754">w</span><span class="op" id="1696755">.</span><span class="ident" id="1696756">next</span>&nbsp;<span class="op" id="1696761">=</span>&nbsp;<span class="ident" id="1696763">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696769">w</span><span class="op" id="1696770">.</span><span class="ident" id="1696771">releasetime</span>&nbsp;<span class="op" id="1696783">=</span>&nbsp;<span class="num" id="1696785">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696789">if</span>&nbsp;<span class="ident" id="1696792">s</span><span class="op" id="1696793">.</span><span class="ident" id="1696794">tail</span>&nbsp;<span class="op" id="1696799">==</span>&nbsp;<span class="ident" id="1696802">nil</span>&nbsp;<span class="op" id="1696806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696811">s</span><span class="op" id="1696812">.</span><span class="ident" id="1696813">head</span>&nbsp;<span class="op" id="1696818">=</span>&nbsp;<span class="ident" id="1696820">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696824">}</span>&nbsp;<span class="keyword" id="1696826">else</span>&nbsp;<span class="op" id="1696831">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696836">s</span><span class="op" id="1696837">.</span><span class="ident" id="1696838">tail</span><span class="op" id="1696842">.</span><span class="ident" id="1696843">next</span>&nbsp;<span class="op" id="1696848">=</span>&nbsp;<span class="ident" id="1696850">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696858">s</span><span class="op" id="1696859">.</span><span class="ident" id="1696860">tail</span>&nbsp;<span class="op" id="1696865">=</span>&nbsp;<span class="ident" id="1696867">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696871">goparkunlock</span><span class="op" id="1696883">(</span><span class="op" id="1696884">&amp;</span><span class="ident" id="1696885">s</span><span class="op" id="1696886">.</span><span class="ident" id="1696887">lock</span><span class="op" id="1696891">,</span>&nbsp;<span class="string" id="1696893">&#34;semarelease&#34;</span><span class="op" id="1696906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696910">releaseSudog</span><span class="op" id="1696922">(</span><span class="ident" id="1696923">w</span><span class="op" id="1696924">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696927">}</span>&nbsp;<span class="keyword" id="1696929">else</span>&nbsp;<span class="op" id="1696934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1696938">unlock</span><span class="op" id="1696944">(</span><span class="op" id="1696945">&amp;</span><span class="ident" id="1696946">s</span><span class="op" id="1696947">.</span><span class="ident" id="1696948">lock</span><span class="op" id="1696952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1696955">}</span><br>
<span class="lineno"></span><span class="op" id="1696957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1696960">func</span>&nbsp;<span class="ident" id="1696965">syncsemcheck</span><span class="op" id="1696977">(</span><span class="ident" id="1696978">sz</span>&nbsp;<span class="builtintype" id="1696981">uintptr</span><span class="op" id="1696988">)</span>&nbsp;<span class="op" id="1696990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1696993">if</span>&nbsp;<span class="ident" id="1696996">sz</span>&nbsp;<span class="op" id="1696999">!=</span>&nbsp;<span class="ident" id="1697002">unsafe</span><span class="op" id="1697008">.</span><span class="ident" id="1697009">Sizeof</span><span class="op" id="1697015">(</span><span class="ident" id="1697016">syncSema</span><span class="op" id="1697024">{</span><span class="op" id="1697025">}</span><span class="op" id="1697026">)</span>&nbsp;<span class="op" id="1697028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1697032">print</span><span class="op" id="1697037">(</span><span class="string" id="1697038">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1697074">,</span>&nbsp;<span class="ident" id="1697076">sz</span><span class="op" id="1697078">,</span>&nbsp;<span class="string" id="1697080">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1697091">,</span>&nbsp;<span class="ident" id="1697093">unsafe</span><span class="op" id="1697099">.</span><span class="ident" id="1697100">Sizeof</span><span class="op" id="1697106">(</span><span class="ident" id="1697107">syncSema</span><span class="op" id="1697115">{</span><span class="op" id="1697116">}</span><span class="op" id="1697117">)</span><span class="op" id="1697118">,</span>&nbsp;<span class="string" id="1697120">&#34;\n&#34;</span><span class="op" id="1697124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1697128">gothrow</span><span class="op" id="1697135">(</span><span class="string" id="1697136">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1697155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1697158">}</span><br>
<span class="lineno">275</span><span class="op" id="1697160">}</span>
</div>
</body>
</html>
