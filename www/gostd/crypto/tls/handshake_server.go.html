<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html" class="current">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3821800">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3821855">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3821909">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3821960">package</span>&nbsp;<span class="ident" id="3821968">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3821973">import</span>&nbsp;<span class="op" id="3821980">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3821983">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3821993">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3822009">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3822023">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3822040">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3822055">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3822072">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3822082">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3822089">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="3822094">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3822097">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="3822173">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="3822225">type</span>&nbsp;<span class="ident" id="3822230">serverHandshakeState</span>&nbsp;<span class="keyword" id="3822251">struct</span>&nbsp;<span class="op" id="3822258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822261">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822277">*</span><span class="ident" id="3822278">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822284">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822300">*</span><span class="ident" id="3822301">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822317">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822333">*</span><span class="ident" id="3822334">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822350">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822366">*</span><span class="ident" id="3822367">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822380">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3822396">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822402">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3822418">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822424">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822440">*</span><span class="ident" id="3822441">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822455">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822471">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822485">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822501">[</span><span class="op" id="3822502">]</span><span class="builtintype" id="3822503">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822509">certsFromClient</span>&nbsp;<span class="op" id="3822525">[</span><span class="op" id="3822526">]</span><span class="op" id="3822527">[</span><span class="op" id="3822528">]</span><span class="builtintype" id="3822529">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822535">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822551">*</span><span class="ident" id="3822552">Certificate</span><br>
<span class="lineno"></span><span class="op" id="3822564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3822567">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3822624">func</span>&nbsp;<span class="op" id="3822629">(</span><span class="ident" id="3822630">c</span>&nbsp;<span class="op" id="3822632">*</span><span class="ident" id="3822633">Conn</span><span class="op" id="3822637">)</span>&nbsp;<span class="ident" id="3822639">serverHandshake</span><span class="op" id="3822654">(</span><span class="op" id="3822655">)</span>&nbsp;<span class="builtintype" id="3822657">error</span>&nbsp;<span class="op" id="3822663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822666">config</span>&nbsp;<span class="op" id="3822673">:=</span>&nbsp;<span class="ident" id="3822676">c</span><span class="op" id="3822677">.</span><span class="ident" id="3822678">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3822687">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3822758">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822788">config</span><span class="op" id="3822794">.</span><span class="ident" id="3822795">serverInitOnce</span><span class="op" id="3822809">.</span><span class="ident" id="3822810">Do</span><span class="op" id="3822812">(</span><span class="ident" id="3822813">config</span><span class="op" id="3822819">.</span><span class="ident" id="3822820">serverInit</span><span class="op" id="3822830">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822834">hs</span>&nbsp;<span class="op" id="3822837">:=</span>&nbsp;<span class="ident" id="3822840">serverHandshakeState</span><span class="op" id="3822860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822864">c</span><span class="op" id="3822865">:</span>&nbsp;<span class="ident" id="3822867">c</span><span class="op" id="3822868">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822874">isResume</span><span class="op" id="3822882">,</span>&nbsp;<span class="ident" id="3822884">err</span>&nbsp;<span class="op" id="3822888">:=</span>&nbsp;<span class="ident" id="3822891">hs</span><span class="op" id="3822893">.</span><span class="ident" id="3822894">readClientHello</span><span class="op" id="3822909">(</span><span class="op" id="3822910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3822913">if</span>&nbsp;<span class="ident" id="3822916">err</span>&nbsp;<span class="op" id="3822920">!=</span>&nbsp;<span class="builtintype" id="3822923">nil</span>&nbsp;<span class="op" id="3822927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3822931">return</span>&nbsp;<span class="ident" id="3822938">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822943">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3822947">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823039">if</span>&nbsp;<span class="ident" id="3823042">isResume</span>&nbsp;<span class="op" id="3823051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3823055">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823140">if</span>&nbsp;<span class="ident" id="3823143">err</span>&nbsp;<span class="op" id="3823147">:=</span>&nbsp;<span class="ident" id="3823150">hs</span><span class="op" id="3823152">.</span><span class="ident" id="3823153">doResumeHandshake</span><span class="op" id="3823170">(</span><span class="op" id="3823171">)</span><span class="op" id="3823172">;</span>&nbsp;<span class="ident" id="3823174">err</span>&nbsp;<span class="op" id="3823178">!=</span>&nbsp;<span class="builtintype" id="3823181">nil</span>&nbsp;<span class="op" id="3823185">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823190">return</span>&nbsp;<span class="ident" id="3823197">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823207">if</span>&nbsp;<span class="ident" id="3823210">err</span>&nbsp;<span class="op" id="3823214">:=</span>&nbsp;<span class="ident" id="3823217">hs</span><span class="op" id="3823219">.</span><span class="ident" id="3823220">establishKeys</span><span class="op" id="3823233">(</span><span class="op" id="3823234">)</span><span class="op" id="3823235">;</span>&nbsp;<span class="ident" id="3823237">err</span>&nbsp;<span class="op" id="3823241">!=</span>&nbsp;<span class="builtintype" id="3823244">nil</span>&nbsp;<span class="op" id="3823248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823253">return</span>&nbsp;<span class="ident" id="3823260">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823266">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823270">if</span>&nbsp;<span class="ident" id="3823273">err</span>&nbsp;<span class="op" id="3823277">:=</span>&nbsp;<span class="ident" id="3823280">hs</span><span class="op" id="3823282">.</span><span class="ident" id="3823283">sendFinished</span><span class="op" id="3823295">(</span><span class="ident" id="3823296">c</span><span class="op" id="3823297">.</span><span class="ident" id="3823298">firstFinished</span><span class="op" id="3823311">[</span><span class="op" id="3823312">:</span><span class="op" id="3823313">]</span><span class="op" id="3823314">)</span><span class="op" id="3823315">;</span>&nbsp;<span class="ident" id="3823317">err</span>&nbsp;<span class="op" id="3823321">!=</span>&nbsp;<span class="builtintype" id="3823324">nil</span>&nbsp;<span class="op" id="3823328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823333">return</span>&nbsp;<span class="ident" id="3823340">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823350">if</span>&nbsp;<span class="ident" id="3823353">err</span>&nbsp;<span class="op" id="3823357">:=</span>&nbsp;<span class="ident" id="3823360">hs</span><span class="op" id="3823362">.</span><span class="ident" id="3823363">readFinished</span><span class="op" id="3823375">(</span><span class="builtintype" id="3823376">nil</span><span class="op" id="3823379">)</span><span class="op" id="3823380">;</span>&nbsp;<span class="ident" id="3823382">err</span>&nbsp;<span class="op" id="3823386">!=</span>&nbsp;<span class="builtintype" id="3823389">nil</span>&nbsp;<span class="op" id="3823393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823398">return</span>&nbsp;<span class="ident" id="3823405">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823415">c</span><span class="op" id="3823416">.</span><span class="ident" id="3823417">didResume</span>&nbsp;<span class="op" id="3823427">=</span>&nbsp;<span class="builtintype" id="3823429">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823435">}</span>&nbsp;<span class="keyword" id="3823437">else</span>&nbsp;<span class="op" id="3823442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3823446">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3823508">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823546">if</span>&nbsp;<span class="ident" id="3823549">err</span>&nbsp;<span class="op" id="3823553">:=</span>&nbsp;<span class="ident" id="3823556">hs</span><span class="op" id="3823558">.</span><span class="ident" id="3823559">doFullHandshake</span><span class="op" id="3823574">(</span><span class="op" id="3823575">)</span><span class="op" id="3823576">;</span>&nbsp;<span class="ident" id="3823578">err</span>&nbsp;<span class="op" id="3823582">!=</span>&nbsp;<span class="builtintype" id="3823585">nil</span>&nbsp;<span class="op" id="3823589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823594">return</span>&nbsp;<span class="ident" id="3823601">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823611">if</span>&nbsp;<span class="ident" id="3823614">err</span>&nbsp;<span class="op" id="3823618">:=</span>&nbsp;<span class="ident" id="3823621">hs</span><span class="op" id="3823623">.</span><span class="ident" id="3823624">establishKeys</span><span class="op" id="3823637">(</span><span class="op" id="3823638">)</span><span class="op" id="3823639">;</span>&nbsp;<span class="ident" id="3823641">err</span>&nbsp;<span class="op" id="3823645">!=</span>&nbsp;<span class="builtintype" id="3823648">nil</span>&nbsp;<span class="op" id="3823652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823657">return</span>&nbsp;<span class="ident" id="3823664">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823674">if</span>&nbsp;<span class="ident" id="3823677">err</span>&nbsp;<span class="op" id="3823681">:=</span>&nbsp;<span class="ident" id="3823684">hs</span><span class="op" id="3823686">.</span><span class="ident" id="3823687">readFinished</span><span class="op" id="3823699">(</span><span class="ident" id="3823700">c</span><span class="op" id="3823701">.</span><span class="ident" id="3823702">firstFinished</span><span class="op" id="3823715">[</span><span class="op" id="3823716">:</span><span class="op" id="3823717">]</span><span class="op" id="3823718">)</span><span class="op" id="3823719">;</span>&nbsp;<span class="ident" id="3823721">err</span>&nbsp;<span class="op" id="3823725">!=</span>&nbsp;<span class="builtintype" id="3823728">nil</span>&nbsp;<span class="op" id="3823732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823737">return</span>&nbsp;<span class="ident" id="3823744">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823754">if</span>&nbsp;<span class="ident" id="3823757">err</span>&nbsp;<span class="op" id="3823761">:=</span>&nbsp;<span class="ident" id="3823764">hs</span><span class="op" id="3823766">.</span><span class="ident" id="3823767">sendSessionTicket</span><span class="op" id="3823784">(</span><span class="op" id="3823785">)</span><span class="op" id="3823786">;</span>&nbsp;<span class="ident" id="3823788">err</span>&nbsp;<span class="op" id="3823792">!=</span>&nbsp;<span class="builtintype" id="3823795">nil</span>&nbsp;<span class="op" id="3823799">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823804">return</span>&nbsp;<span class="ident" id="3823811">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823821">if</span>&nbsp;<span class="ident" id="3823824">err</span>&nbsp;<span class="op" id="3823828">:=</span>&nbsp;<span class="ident" id="3823831">hs</span><span class="op" id="3823833">.</span><span class="ident" id="3823834">sendFinished</span><span class="op" id="3823846">(</span><span class="builtintype" id="3823847">nil</span><span class="op" id="3823850">)</span><span class="op" id="3823851">;</span>&nbsp;<span class="ident" id="3823853">err</span>&nbsp;<span class="op" id="3823857">!=</span>&nbsp;<span class="builtintype" id="3823860">nil</span>&nbsp;<span class="op" id="3823864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823869">return</span>&nbsp;<span class="ident" id="3823876">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823882">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823888">c</span><span class="op" id="3823889">.</span><span class="ident" id="3823890">handshakeComplete</span>&nbsp;<span class="op" id="3823908">=</span>&nbsp;<span class="builtintype" id="3823910">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823917">return</span>&nbsp;<span class="builtintype" id="3823924">nil</span><br>
<span class="lineno"></span><span class="op" id="3823928">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3823931">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="3824006">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="3824053">func</span>&nbsp;<span class="op" id="3824058">(</span><span class="ident" id="3824059">hs</span>&nbsp;<span class="op" id="3824062">*</span><span class="ident" id="3824063">serverHandshakeState</span><span class="op" id="3824083">)</span>&nbsp;<span class="ident" id="3824085">readClientHello</span><span class="op" id="3824100">(</span><span class="op" id="3824101">)</span>&nbsp;<span class="op" id="3824103">(</span><span class="ident" id="3824104">isResume</span>&nbsp;<span class="builtintype" id="3824113">bool</span><span class="op" id="3824117">,</span>&nbsp;<span class="ident" id="3824119">err</span>&nbsp;<span class="builtintype" id="3824123">error</span><span class="op" id="3824128">)</span>&nbsp;<span class="op" id="3824130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824133">config</span>&nbsp;<span class="op" id="3824140">:=</span>&nbsp;<span class="ident" id="3824143">hs</span><span class="op" id="3824145">.</span><span class="ident" id="3824146">c</span><span class="op" id="3824147">.</span><span class="ident" id="3824148">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824156">c</span>&nbsp;<span class="op" id="3824158">:=</span>&nbsp;<span class="ident" id="3824161">hs</span><span class="op" id="3824163">.</span><span class="ident" id="3824164">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824168">msg</span><span class="op" id="3824171">,</span>&nbsp;<span class="ident" id="3824173">err</span>&nbsp;<span class="op" id="3824177">:=</span>&nbsp;<span class="ident" id="3824180">c</span><span class="op" id="3824181">.</span><span class="ident" id="3824182">readHandshake</span><span class="op" id="3824195">(</span><span class="op" id="3824196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824199">if</span>&nbsp;<span class="ident" id="3824202">err</span>&nbsp;<span class="op" id="3824206">!=</span>&nbsp;<span class="builtintype" id="3824209">nil</span>&nbsp;<span class="op" id="3824213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824217">return</span>&nbsp;<span class="builtintype" id="3824224">false</span><span class="op" id="3824229">,</span>&nbsp;<span class="ident" id="3824231">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3824236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824239">var</span>&nbsp;<span class="ident" id="3824243">ok</span>&nbsp;<span class="builtintype" id="3824246">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824252">hs</span><span class="op" id="3824254">.</span><span class="ident" id="3824255">clientHello</span><span class="op" id="3824266">,</span>&nbsp;<span class="ident" id="3824268">ok</span>&nbsp;<span class="op" id="3824271">=</span>&nbsp;<span class="ident" id="3824273">msg</span><span class="op" id="3824276">.</span><span class="op" id="3824277">(</span><span class="op" id="3824278">*</span><span class="ident" id="3824279">clientHelloMsg</span><span class="op" id="3824293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824296">if</span>&nbsp;<span class="op" id="3824299">!</span><span class="ident" id="3824300">ok</span>&nbsp;<span class="op" id="3824303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824307">c</span><span class="op" id="3824308">.</span><span class="ident" id="3824309">sendAlert</span><span class="op" id="3824318">(</span><span class="ident" id="3824319">alertUnexpectedMessage</span><span class="op" id="3824341">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824345">return</span>&nbsp;<span class="builtintype" id="3824352">false</span><span class="op" id="3824357">,</span>&nbsp;<span class="ident" id="3824359">unexpectedMessageError</span><span class="op" id="3824381">(</span><span class="ident" id="3824382">hs</span><span class="op" id="3824384">.</span><span class="ident" id="3824385">clientHello</span><span class="op" id="3824396">,</span>&nbsp;<span class="ident" id="3824398">msg</span><span class="op" id="3824401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3824404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824407">c</span><span class="op" id="3824408">.</span><span class="ident" id="3824409">vers</span><span class="op" id="3824413">,</span>&nbsp;<span class="ident" id="3824415">ok</span>&nbsp;<span class="op" id="3824418">=</span>&nbsp;<span class="ident" id="3824420">config</span><span class="op" id="3824426">.</span><span class="ident" id="3824427">mutualVersion</span><span class="op" id="3824440">(</span><span class="ident" id="3824441">hs</span><span class="op" id="3824443">.</span><span class="ident" id="3824444">clientHello</span><span class="op" id="3824455">.</span><span class="ident" id="3824456">vers</span><span class="op" id="3824460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824463">if</span>&nbsp;<span class="op" id="3824466">!</span><span class="ident" id="3824467">ok</span>&nbsp;<span class="op" id="3824470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824474">c</span><span class="op" id="3824475">.</span><span class="ident" id="3824476">sendAlert</span><span class="op" id="3824485">(</span><span class="ident" id="3824486">alertProtocolVersion</span><span class="op" id="3824506">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824510">return</span>&nbsp;<span class="builtintype" id="3824517">false</span><span class="op" id="3824522">,</span>&nbsp;<span class="ident" id="3824524">fmt</span><span class="op" id="3824527">.</span><span class="ident" id="3824528">Errorf</span><span class="op" id="3824534">(</span><span class="string" id="3824535">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="3824603">,</span>&nbsp;<span class="ident" id="3824605">hs</span><span class="op" id="3824607">.</span><span class="ident" id="3824608">clientHello</span><span class="op" id="3824619">.</span><span class="ident" id="3824620">vers</span><span class="op" id="3824624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3824627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824630">c</span><span class="op" id="3824631">.</span><span class="ident" id="3824632">haveVers</span>&nbsp;<span class="op" id="3824641">=</span>&nbsp;<span class="builtintype" id="3824643">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824650">hs</span><span class="op" id="3824652">.</span><span class="ident" id="3824653">finishedHash</span>&nbsp;<span class="op" id="3824666">=</span>&nbsp;<span class="ident" id="3824668">newFinishedHash</span><span class="op" id="3824683">(</span><span class="ident" id="3824684">c</span><span class="op" id="3824685">.</span><span class="ident" id="3824686">vers</span><span class="op" id="3824690">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824693">hs</span><span class="op" id="3824695">.</span><span class="ident" id="3824696">finishedHash</span><span class="op" id="3824708">.</span><span class="ident" id="3824709">Write</span><span class="op" id="3824714">(</span><span class="ident" id="3824715">hs</span><span class="op" id="3824717">.</span><span class="ident" id="3824718">clientHello</span><span class="op" id="3824729">.</span><span class="ident" id="3824730">marshal</span><span class="op" id="3824737">(</span><span class="op" id="3824738">)</span><span class="op" id="3824739">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824743">hs</span><span class="op" id="3824745">.</span><span class="ident" id="3824746">hello</span>&nbsp;<span class="op" id="3824752">=</span>&nbsp;<span class="builtinfunc" id="3824754">new</span><span class="op" id="3824757">(</span><span class="ident" id="3824758">serverHelloMsg</span><span class="op" id="3824772">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824776">supportedCurve</span>&nbsp;<span class="op" id="3824791">:=</span>&nbsp;<span class="builtintype" id="3824794">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824801">preferredCurves</span>&nbsp;<span class="op" id="3824817">:=</span>&nbsp;<span class="ident" id="3824820">config</span><span class="op" id="3824826">.</span><span class="ident" id="3824827">curvePreferences</span><span class="op" id="3824843">(</span><span class="op" id="3824844">)</span><br>
<span class="lineno"></span><span class="ident" id="3824846">Curves</span><span class="op" id="3824852">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824855">for</span>&nbsp;<span class="ident" id="3824859">_</span><span class="op" id="3824860">,</span>&nbsp;<span class="ident" id="3824862">curve</span>&nbsp;<span class="op" id="3824868">:=</span>&nbsp;<span class="keyword" id="3824871">range</span>&nbsp;<span class="ident" id="3824877">hs</span><span class="op" id="3824879">.</span><span class="ident" id="3824880">clientHello</span><span class="op" id="3824891">.</span><span class="ident" id="3824892">supportedCurves</span>&nbsp;<span class="op" id="3824908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824912">for</span>&nbsp;<span class="ident" id="3824916">_</span><span class="op" id="3824917">,</span>&nbsp;<span class="ident" id="3824919">supported</span>&nbsp;<span class="op" id="3824929">:=</span>&nbsp;<span class="keyword" id="3824932">range</span>&nbsp;<span class="ident" id="3824938">preferredCurves</span>&nbsp;<span class="op" id="3824954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824959">if</span>&nbsp;<span class="ident" id="3824962">supported</span>&nbsp;<span class="op" id="3824972">==</span>&nbsp;<span class="ident" id="3824975">curve</span>&nbsp;<span class="op" id="3824981">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824987">supportedCurve</span>&nbsp;<span class="op" id="3825002">=</span>&nbsp;<span class="builtintype" id="3825004">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825013">break</span>&nbsp;<span class="ident" id="3825019">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825036">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825040">supportedPointFormat</span>&nbsp;<span class="op" id="3825061">:=</span>&nbsp;<span class="builtintype" id="3825064">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825071">for</span>&nbsp;<span class="ident" id="3825075">_</span><span class="op" id="3825076">,</span>&nbsp;<span class="ident" id="3825078">pointFormat</span>&nbsp;<span class="op" id="3825090">:=</span>&nbsp;<span class="keyword" id="3825093">range</span>&nbsp;<span class="ident" id="3825099">hs</span><span class="op" id="3825101">.</span><span class="ident" id="3825102">clientHello</span><span class="op" id="3825113">.</span><span class="ident" id="3825114">supportedPoints</span>&nbsp;<span class="op" id="3825130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825134">if</span>&nbsp;<span class="ident" id="3825137">pointFormat</span>&nbsp;<span class="op" id="3825149">==</span>&nbsp;<span class="ident" id="3825152">pointFormatUncompressed</span>&nbsp;<span class="op" id="3825176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825181">supportedPointFormat</span>&nbsp;<span class="op" id="3825202">=</span>&nbsp;<span class="builtintype" id="3825204">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825212">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825226">hs</span><span class="op" id="3825228">.</span><span class="ident" id="3825229">ellipticOk</span>&nbsp;<span class="op" id="3825240">=</span>&nbsp;<span class="ident" id="3825242">supportedCurve</span>&nbsp;<span class="op" id="3825257">&amp;&amp;</span>&nbsp;<span class="ident" id="3825260">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825283">foundCompression</span>&nbsp;<span class="op" id="3825300">:=</span>&nbsp;<span class="builtintype" id="3825303">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3825310">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825385">for</span>&nbsp;<span class="ident" id="3825389">_</span><span class="op" id="3825390">,</span>&nbsp;<span class="ident" id="3825392">compression</span>&nbsp;<span class="op" id="3825404">:=</span>&nbsp;<span class="keyword" id="3825407">range</span>&nbsp;<span class="ident" id="3825413">hs</span><span class="op" id="3825415">.</span><span class="ident" id="3825416">clientHello</span><span class="op" id="3825427">.</span><span class="ident" id="3825428">compressionMethods</span>&nbsp;<span class="op" id="3825447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825451">if</span>&nbsp;<span class="ident" id="3825454">compression</span>&nbsp;<span class="op" id="3825466">==</span>&nbsp;<span class="ident" id="3825469">compressionNone</span>&nbsp;<span class="op" id="3825485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825490">foundCompression</span>&nbsp;<span class="op" id="3825507">=</span>&nbsp;<span class="builtintype" id="3825509">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825517">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825532">if</span>&nbsp;<span class="op" id="3825535">!</span><span class="ident" id="3825536">foundCompression</span>&nbsp;<span class="op" id="3825553">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825557">c</span><span class="op" id="3825558">.</span><span class="ident" id="3825559">sendAlert</span><span class="op" id="3825568">(</span><span class="ident" id="3825569">alertHandshakeFailure</span><span class="op" id="3825590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825594">return</span>&nbsp;<span class="builtintype" id="3825601">false</span><span class="op" id="3825606">,</span>&nbsp;<span class="ident" id="3825608">errors</span><span class="op" id="3825614">.</span><span class="ident" id="3825615">New</span><span class="op" id="3825618">(</span><span class="string" id="3825619">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="3825674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825681">hs</span><span class="op" id="3825683">.</span><span class="ident" id="3825684">hello</span><span class="op" id="3825689">.</span><span class="ident" id="3825690">vers</span>&nbsp;<span class="op" id="3825695">=</span>&nbsp;<span class="ident" id="3825697">c</span><span class="op" id="3825698">.</span><span class="ident" id="3825699">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825705">hs</span><span class="op" id="3825707">.</span><span class="ident" id="3825708">hello</span><span class="op" id="3825713">.</span><span class="ident" id="3825714">random</span>&nbsp;<span class="op" id="3825721">=</span>&nbsp;<span class="builtinfunc" id="3825723">make</span><span class="op" id="3825727">(</span><span class="op" id="3825728">[</span><span class="op" id="3825729">]</span><span class="builtintype" id="3825730">byte</span><span class="op" id="3825734">,</span>&nbsp;<span class="num" id="3825736">32</span><span class="op" id="3825738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825741">_</span><span class="op" id="3825742">,</span>&nbsp;<span class="ident" id="3825744">err</span>&nbsp;<span class="op" id="3825748">=</span>&nbsp;<span class="ident" id="3825750">io</span><span class="op" id="3825752">.</span><span class="ident" id="3825753">ReadFull</span><span class="op" id="3825761">(</span><span class="ident" id="3825762">config</span><span class="op" id="3825768">.</span><span class="ident" id="3825769">rand</span><span class="op" id="3825773">(</span><span class="op" id="3825774">)</span><span class="op" id="3825775">,</span>&nbsp;<span class="ident" id="3825777">hs</span><span class="op" id="3825779">.</span><span class="ident" id="3825780">hello</span><span class="op" id="3825785">.</span><span class="ident" id="3825786">random</span><span class="op" id="3825792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825795">if</span>&nbsp;<span class="ident" id="3825798">err</span>&nbsp;<span class="op" id="3825802">!=</span>&nbsp;<span class="builtintype" id="3825805">nil</span>&nbsp;<span class="op" id="3825809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825813">c</span><span class="op" id="3825814">.</span><span class="ident" id="3825815">sendAlert</span><span class="op" id="3825824">(</span><span class="ident" id="3825825">alertInternalError</span><span class="op" id="3825843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825847">return</span>&nbsp;<span class="builtintype" id="3825854">false</span><span class="op" id="3825859">,</span>&nbsp;<span class="ident" id="3825861">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825869">hs</span><span class="op" id="3825871">.</span><span class="ident" id="3825872">hello</span><span class="op" id="3825877">.</span><span class="ident" id="3825878">secureRenegotiation</span>&nbsp;<span class="op" id="3825898">=</span>&nbsp;<span class="ident" id="3825900">hs</span><span class="op" id="3825902">.</span><span class="ident" id="3825903">clientHello</span><span class="op" id="3825914">.</span><span class="ident" id="3825915">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825936">hs</span><span class="op" id="3825938">.</span><span class="ident" id="3825939">hello</span><span class="op" id="3825944">.</span><span class="ident" id="3825945">compressionMethod</span>&nbsp;<span class="op" id="3825963">=</span>&nbsp;<span class="ident" id="3825965">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825982">if</span>&nbsp;<span class="builtinfunc" id="3825985">len</span><span class="op" id="3825988">(</span><span class="ident" id="3825989">hs</span><span class="op" id="3825991">.</span><span class="ident" id="3825992">clientHello</span><span class="op" id="3826003">.</span><span class="ident" id="3826004">serverName</span><span class="op" id="3826014">)</span>&nbsp;<span class="op" id="3826016">&gt;</span>&nbsp;<span class="num" id="3826018">0</span>&nbsp;<span class="op" id="3826020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826024">c</span><span class="op" id="3826025">.</span><span class="ident" id="3826026">serverName</span>&nbsp;<span class="op" id="3826037">=</span>&nbsp;<span class="ident" id="3826039">hs</span><span class="op" id="3826041">.</span><span class="ident" id="3826042">clientHello</span><span class="op" id="3826053">.</span><span class="ident" id="3826054">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3826066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826070">if</span>&nbsp;<span class="builtinfunc" id="3826073">len</span><span class="op" id="3826076">(</span><span class="ident" id="3826077">hs</span><span class="op" id="3826079">.</span><span class="ident" id="3826080">clientHello</span><span class="op" id="3826091">.</span><span class="ident" id="3826092">alpnProtocols</span><span class="op" id="3826105">)</span>&nbsp;<span class="op" id="3826107">&gt;</span>&nbsp;<span class="num" id="3826109">0</span>&nbsp;<span class="op" id="3826111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826115">if</span>&nbsp;<span class="ident" id="3826118">selectedProto</span><span class="op" id="3826131">,</span>&nbsp;<span class="ident" id="3826133">fallback</span>&nbsp;<span class="op" id="3826142">:=</span>&nbsp;<span class="ident" id="3826145">mutualProtocol</span><span class="op" id="3826159">(</span><span class="ident" id="3826160">hs</span><span class="op" id="3826162">.</span><span class="ident" id="3826163">clientHello</span><span class="op" id="3826174">.</span><span class="ident" id="3826175">alpnProtocols</span><span class="op" id="3826188">,</span>&nbsp;<span class="ident" id="3826190">c</span><span class="op" id="3826191">.</span><span class="ident" id="3826192">config</span><span class="op" id="3826198">.</span><span class="ident" id="3826199">NextProtos</span><span class="op" id="3826209">)</span><span class="op" id="3826210">;</span>&nbsp;<span class="op" id="3826212">!</span><span class="ident" id="3826213">fallback</span>&nbsp;<span class="op" id="3826222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826227">hs</span><span class="op" id="3826229">.</span><span class="ident" id="3826230">hello</span><span class="op" id="3826235">.</span><span class="ident" id="3826236">alpnProtocol</span>&nbsp;<span class="op" id="3826249">=</span>&nbsp;<span class="ident" id="3826251">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826268">c</span><span class="op" id="3826269">.</span><span class="ident" id="3826270">clientProtocol</span>&nbsp;<span class="op" id="3826285">=</span>&nbsp;<span class="ident" id="3826287">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3826303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3826306">}</span>&nbsp;<span class="keyword" id="3826308">else</span>&nbsp;<span class="op" id="3826313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3826317">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3826389">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3826448">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3826485">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826542">if</span>&nbsp;<span class="ident" id="3826545">hs</span><span class="op" id="3826547">.</span><span class="ident" id="3826548">clientHello</span><span class="op" id="3826559">.</span><span class="ident" id="3826560">nextProtoNeg</span>&nbsp;<span class="op" id="3826573">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3826576">len</span><span class="op" id="3826579">(</span><span class="ident" id="3826580">config</span><span class="op" id="3826586">.</span><span class="ident" id="3826587">NextProtos</span><span class="op" id="3826597">)</span>&nbsp;<span class="op" id="3826599">&gt;</span>&nbsp;<span class="num" id="3826601">0</span>&nbsp;<span class="op" id="3826603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826608">hs</span><span class="op" id="3826610">.</span><span class="ident" id="3826611">hello</span><span class="op" id="3826616">.</span><span class="ident" id="3826617">nextProtoNeg</span>&nbsp;<span class="op" id="3826630">=</span>&nbsp;<span class="builtintype" id="3826632">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826640">hs</span><span class="op" id="3826642">.</span><span class="ident" id="3826643">hello</span><span class="op" id="3826648">.</span><span class="ident" id="3826649">nextProtos</span>&nbsp;<span class="op" id="3826660">=</span>&nbsp;<span class="ident" id="3826662">config</span><span class="op" id="3826668">.</span><span class="ident" id="3826669">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3826682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3826685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826689">if</span>&nbsp;<span class="builtinfunc" id="3826692">len</span><span class="op" id="3826695">(</span><span class="ident" id="3826696">config</span><span class="op" id="3826702">.</span><span class="ident" id="3826703">Certificates</span><span class="op" id="3826715">)</span>&nbsp;<span class="op" id="3826717">==</span>&nbsp;<span class="num" id="3826720">0</span>&nbsp;<span class="op" id="3826722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826726">c</span><span class="op" id="3826727">.</span><span class="ident" id="3826728">sendAlert</span><span class="op" id="3826737">(</span><span class="ident" id="3826738">alertInternalError</span><span class="op" id="3826756">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826760">return</span>&nbsp;<span class="builtintype" id="3826767">false</span><span class="op" id="3826772">,</span>&nbsp;<span class="ident" id="3826774">errors</span><span class="op" id="3826780">.</span><span class="ident" id="3826781">New</span><span class="op" id="3826784">(</span><span class="string" id="3826785">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="3826818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3826821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826824">hs</span><span class="op" id="3826826">.</span><span class="ident" id="3826827">cert</span>&nbsp;<span class="op" id="3826832">=</span>&nbsp;<span class="op" id="3826834">&amp;</span><span class="ident" id="3826835">config</span><span class="op" id="3826841">.</span><span class="ident" id="3826842">Certificates</span><span class="op" id="3826854">[</span><span class="num" id="3826855">0</span><span class="op" id="3826856">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826859">if</span>&nbsp;<span class="builtinfunc" id="3826862">len</span><span class="op" id="3826865">(</span><span class="ident" id="3826866">hs</span><span class="op" id="3826868">.</span><span class="ident" id="3826869">clientHello</span><span class="op" id="3826880">.</span><span class="ident" id="3826881">serverName</span><span class="op" id="3826891">)</span>&nbsp;<span class="op" id="3826893">&gt;</span>&nbsp;<span class="num" id="3826895">0</span>&nbsp;<span class="op" id="3826897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826901">chi</span>&nbsp;<span class="op" id="3826905">:=</span>&nbsp;<span class="op" id="3826908">&amp;</span><span class="ident" id="3826909">ClientHelloInfo</span><span class="op" id="3826924">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826929">CipherSuites</span><span class="op" id="3826941">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826946">hs</span><span class="op" id="3826948">.</span><span class="ident" id="3826949">clientHello</span><span class="op" id="3826960">.</span><span class="ident" id="3826961">cipherSuites</span><span class="op" id="3826973">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826978">ServerName</span><span class="op" id="3826988">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826995">hs</span><span class="op" id="3826997">.</span><span class="ident" id="3826998">clientHello</span><span class="op" id="3827009">.</span><span class="ident" id="3827010">serverName</span><span class="op" id="3827020">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827025">SupportedCurves</span><span class="op" id="3827040">:</span>&nbsp;<span class="ident" id="3827042">hs</span><span class="op" id="3827044">.</span><span class="ident" id="3827045">clientHello</span><span class="op" id="3827056">.</span><span class="ident" id="3827057">supportedCurves</span><span class="op" id="3827072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827077">SupportedPoints</span><span class="op" id="3827092">:</span>&nbsp;<span class="ident" id="3827094">hs</span><span class="op" id="3827096">.</span><span class="ident" id="3827097">clientHello</span><span class="op" id="3827108">.</span><span class="ident" id="3827109">supportedPoints</span><span class="op" id="3827124">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827128">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827132">if</span>&nbsp;<span class="ident" id="3827135">hs</span><span class="op" id="3827137">.</span><span class="ident" id="3827138">cert</span><span class="op" id="3827142">,</span>&nbsp;<span class="ident" id="3827144">err</span>&nbsp;<span class="op" id="3827148">=</span>&nbsp;<span class="ident" id="3827150">config</span><span class="op" id="3827156">.</span><span class="ident" id="3827157">getCertificate</span><span class="op" id="3827171">(</span><span class="ident" id="3827172">chi</span><span class="op" id="3827175">)</span><span class="op" id="3827176">;</span>&nbsp;<span class="ident" id="3827178">err</span>&nbsp;<span class="op" id="3827182">!=</span>&nbsp;<span class="builtintype" id="3827185">nil</span>&nbsp;<span class="op" id="3827189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827194">c</span><span class="op" id="3827195">.</span><span class="ident" id="3827196">sendAlert</span><span class="op" id="3827205">(</span><span class="ident" id="3827206">alertInternalError</span><span class="op" id="3827224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827229">return</span>&nbsp;<span class="builtintype" id="3827236">false</span><span class="op" id="3827241">,</span>&nbsp;<span class="ident" id="3827243">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827252">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827256">_</span><span class="op" id="3827257">,</span>&nbsp;<span class="ident" id="3827259">hs</span><span class="op" id="3827261">.</span><span class="ident" id="3827262">ecdsaOk</span>&nbsp;<span class="op" id="3827270">=</span>&nbsp;<span class="ident" id="3827272">hs</span><span class="op" id="3827274">.</span><span class="ident" id="3827275">cert</span><span class="op" id="3827279">.</span><span class="ident" id="3827280">PrivateKey</span><span class="op" id="3827290">.</span><span class="op" id="3827291">(</span><span class="op" id="3827292">*</span><span class="ident" id="3827293">ecdsa</span><span class="op" id="3827298">.</span><span class="ident" id="3827299">PrivateKey</span><span class="op" id="3827309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827313">if</span>&nbsp;<span class="ident" id="3827316">hs</span><span class="op" id="3827318">.</span><span class="ident" id="3827319">checkForResumption</span><span class="op" id="3827337">(</span><span class="op" id="3827338">)</span>&nbsp;<span class="op" id="3827340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827344">return</span>&nbsp;<span class="builtintype" id="3827351">true</span><span class="op" id="3827355">,</span>&nbsp;<span class="builtintype" id="3827357">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827366">var</span>&nbsp;<span class="ident" id="3827370">preferenceList</span><span class="op" id="3827384">,</span>&nbsp;<span class="ident" id="3827386">supportedList</span>&nbsp;<span class="op" id="3827400">[</span><span class="op" id="3827401">]</span><span class="builtintype" id="3827402">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827410">if</span>&nbsp;<span class="ident" id="3827413">c</span><span class="op" id="3827414">.</span><span class="ident" id="3827415">config</span><span class="op" id="3827421">.</span><span class="ident" id="3827422">PreferServerCipherSuites</span>&nbsp;<span class="op" id="3827447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827451">preferenceList</span>&nbsp;<span class="op" id="3827466">=</span>&nbsp;<span class="ident" id="3827468">c</span><span class="op" id="3827469">.</span><span class="ident" id="3827470">config</span><span class="op" id="3827476">.</span><span class="ident" id="3827477">cipherSuites</span><span class="op" id="3827489">(</span><span class="op" id="3827490">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827494">supportedList</span>&nbsp;<span class="op" id="3827508">=</span>&nbsp;<span class="ident" id="3827510">hs</span><span class="op" id="3827512">.</span><span class="ident" id="3827513">clientHello</span><span class="op" id="3827524">.</span><span class="ident" id="3827525">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827539">}</span>&nbsp;<span class="keyword" id="3827541">else</span>&nbsp;<span class="op" id="3827546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827550">preferenceList</span>&nbsp;<span class="op" id="3827565">=</span>&nbsp;<span class="ident" id="3827567">hs</span><span class="op" id="3827569">.</span><span class="ident" id="3827570">clientHello</span><span class="op" id="3827581">.</span><span class="ident" id="3827582">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827597">supportedList</span>&nbsp;<span class="op" id="3827611">=</span>&nbsp;<span class="ident" id="3827613">c</span><span class="op" id="3827614">.</span><span class="ident" id="3827615">config</span><span class="op" id="3827621">.</span><span class="ident" id="3827622">cipherSuites</span><span class="op" id="3827634">(</span><span class="op" id="3827635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827638">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827642">for</span>&nbsp;<span class="ident" id="3827646">_</span><span class="op" id="3827647">,</span>&nbsp;<span class="ident" id="3827649">id</span>&nbsp;<span class="op" id="3827652">:=</span>&nbsp;<span class="keyword" id="3827655">range</span>&nbsp;<span class="ident" id="3827661">preferenceList</span>&nbsp;<span class="op" id="3827676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827680">if</span>&nbsp;<span class="ident" id="3827683">hs</span><span class="op" id="3827685">.</span><span class="ident" id="3827686">suite</span>&nbsp;<span class="op" id="3827692">=</span>&nbsp;<span class="ident" id="3827694">c</span><span class="op" id="3827695">.</span><span class="ident" id="3827696">tryCipherSuite</span><span class="op" id="3827710">(</span><span class="ident" id="3827711">id</span><span class="op" id="3827713">,</span>&nbsp;<span class="ident" id="3827715">supportedList</span><span class="op" id="3827728">,</span>&nbsp;<span class="ident" id="3827730">c</span><span class="op" id="3827731">.</span><span class="ident" id="3827732">vers</span><span class="op" id="3827736">,</span>&nbsp;<span class="ident" id="3827738">hs</span><span class="op" id="3827740">.</span><span class="ident" id="3827741">ellipticOk</span><span class="op" id="3827751">,</span>&nbsp;<span class="ident" id="3827753">hs</span><span class="op" id="3827755">.</span><span class="ident" id="3827756">ecdsaOk</span><span class="op" id="3827763">)</span><span class="op" id="3827764">;</span>&nbsp;<span class="ident" id="3827766">hs</span><span class="op" id="3827768">.</span><span class="ident" id="3827769">suite</span>&nbsp;<span class="op" id="3827775">!=</span>&nbsp;<span class="builtintype" id="3827778">nil</span>&nbsp;<span class="op" id="3827782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827787">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827795">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827798">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827802">if</span>&nbsp;<span class="ident" id="3827805">hs</span><span class="op" id="3827807">.</span><span class="ident" id="3827808">suite</span>&nbsp;<span class="op" id="3827814">==</span>&nbsp;<span class="builtintype" id="3827817">nil</span>&nbsp;<span class="op" id="3827821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827825">c</span><span class="op" id="3827826">.</span><span class="ident" id="3827827">sendAlert</span><span class="op" id="3827836">(</span><span class="ident" id="3827837">alertHandshakeFailure</span><span class="op" id="3827858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827862">return</span>&nbsp;<span class="builtintype" id="3827869">false</span><span class="op" id="3827874">,</span>&nbsp;<span class="ident" id="3827876">errors</span><span class="op" id="3827882">.</span><span class="ident" id="3827883">New</span><span class="op" id="3827886">(</span><span class="string" id="3827887">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="3827945">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3827952">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828022">for</span>&nbsp;<span class="ident" id="3828026">_</span><span class="op" id="3828027">,</span>&nbsp;<span class="ident" id="3828029">id</span>&nbsp;<span class="op" id="3828032">:=</span>&nbsp;<span class="keyword" id="3828035">range</span>&nbsp;<span class="ident" id="3828041">hs</span><span class="op" id="3828043">.</span><span class="ident" id="3828044">clientHello</span><span class="op" id="3828055">.</span><span class="ident" id="3828056">cipherSuites</span>&nbsp;<span class="op" id="3828069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828073">if</span>&nbsp;<span class="ident" id="3828076">id</span>&nbsp;<span class="op" id="3828079">==</span>&nbsp;<span class="ident" id="3828082">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="3828100">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828105">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828154">if</span>&nbsp;<span class="ident" id="3828157">hs</span><span class="op" id="3828159">.</span><span class="ident" id="3828160">clientHello</span><span class="op" id="3828171">.</span><span class="ident" id="3828172">vers</span>&nbsp;<span class="op" id="3828177">&lt;</span>&nbsp;<span class="ident" id="3828179">c</span><span class="op" id="3828180">.</span><span class="ident" id="3828181">config</span><span class="op" id="3828187">.</span><span class="ident" id="3828188">MaxVersion</span>&nbsp;<span class="op" id="3828199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828205">c</span><span class="op" id="3828206">.</span><span class="ident" id="3828207">sendAlert</span><span class="op" id="3828216">(</span><span class="ident" id="3828217">alertInappropriateFallback</span><span class="op" id="3828243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828249">return</span>&nbsp;<span class="builtintype" id="3828256">false</span><span class="op" id="3828261">,</span>&nbsp;<span class="ident" id="3828263">errors</span><span class="op" id="3828269">.</span><span class="ident" id="3828270">New</span><span class="op" id="3828273">(</span><span class="string" id="3828274">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="3828324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3828329">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828334">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3828342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3828345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828349">return</span>&nbsp;<span class="builtintype" id="3828356">false</span><span class="op" id="3828361">,</span>&nbsp;<span class="builtintype" id="3828363">nil</span><br>
<span class="lineno">240</span><span class="op" id="3828367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3828370">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3828457">func</span>&nbsp;<span class="op" id="3828462">(</span><span class="ident" id="3828463">hs</span>&nbsp;<span class="op" id="3828466">*</span><span class="ident" id="3828467">serverHandshakeState</span><span class="op" id="3828487">)</span>&nbsp;<span class="ident" id="3828489">checkForResumption</span><span class="op" id="3828507">(</span><span class="op" id="3828508">)</span>&nbsp;<span class="builtintype" id="3828510">bool</span>&nbsp;<span class="op" id="3828515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828518">c</span>&nbsp;<span class="op" id="3828520">:=</span>&nbsp;<span class="ident" id="3828523">hs</span><span class="op" id="3828525">.</span><span class="ident" id="3828526">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828530">if</span>&nbsp;<span class="ident" id="3828533">c</span><span class="op" id="3828534">.</span><span class="ident" id="3828535">config</span><span class="op" id="3828541">.</span><span class="ident" id="3828542">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3828565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828569">return</span>&nbsp;<span class="builtintype" id="3828576">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3828583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828587">var</span>&nbsp;<span class="ident" id="3828591">ok</span>&nbsp;<span class="builtintype" id="3828594">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828600">if</span>&nbsp;<span class="ident" id="3828603">hs</span><span class="op" id="3828605">.</span><span class="ident" id="3828606">sessionState</span><span class="op" id="3828618">,</span>&nbsp;<span class="ident" id="3828620">ok</span>&nbsp;<span class="op" id="3828623">=</span>&nbsp;<span class="ident" id="3828625">c</span><span class="op" id="3828626">.</span><span class="ident" id="3828627">decryptTicket</span><span class="op" id="3828640">(</span><span class="ident" id="3828641">hs</span><span class="op" id="3828643">.</span><span class="ident" id="3828644">clientHello</span><span class="op" id="3828655">.</span><span class="ident" id="3828656">sessionTicket</span><span class="op" id="3828669">)</span><span class="op" id="3828670">;</span>&nbsp;<span class="op" id="3828672">!</span><span class="ident" id="3828673">ok</span>&nbsp;<span class="op" id="3828676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828680">return</span>&nbsp;<span class="builtintype" id="3828687">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3828694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828698">if</span>&nbsp;<span class="ident" id="3828701">hs</span><span class="op" id="3828703">.</span><span class="ident" id="3828704">sessionState</span><span class="op" id="3828716">.</span><span class="ident" id="3828717">vers</span>&nbsp;<span class="op" id="3828722">&gt;</span>&nbsp;<span class="ident" id="3828724">hs</span><span class="op" id="3828726">.</span><span class="ident" id="3828727">clientHello</span><span class="op" id="3828738">.</span><span class="ident" id="3828739">vers</span>&nbsp;<span class="op" id="3828744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828748">return</span>&nbsp;<span class="builtintype" id="3828755">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3828762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828765">if</span>&nbsp;<span class="ident" id="3828768">vers</span><span class="op" id="3828772">,</span>&nbsp;<span class="ident" id="3828774">ok</span>&nbsp;<span class="op" id="3828777">:=</span>&nbsp;<span class="ident" id="3828780">c</span><span class="op" id="3828781">.</span><span class="ident" id="3828782">config</span><span class="op" id="3828788">.</span><span class="ident" id="3828789">mutualVersion</span><span class="op" id="3828802">(</span><span class="ident" id="3828803">hs</span><span class="op" id="3828805">.</span><span class="ident" id="3828806">sessionState</span><span class="op" id="3828818">.</span><span class="ident" id="3828819">vers</span><span class="op" id="3828823">)</span><span class="op" id="3828824">;</span>&nbsp;<span class="op" id="3828826">!</span><span class="ident" id="3828827">ok</span>&nbsp;<span class="op" id="3828830">||</span>&nbsp;<span class="ident" id="3828833">vers</span>&nbsp;<span class="op" id="3828838">!=</span>&nbsp;<span class="ident" id="3828841">hs</span><span class="op" id="3828843">.</span><span class="ident" id="3828844">sessionState</span><span class="op" id="3828856">.</span><span class="ident" id="3828857">vers</span>&nbsp;<span class="op" id="3828862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828866">return</span>&nbsp;<span class="builtintype" id="3828873">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3828880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828884">cipherSuiteOk</span>&nbsp;<span class="op" id="3828898">:=</span>&nbsp;<span class="builtintype" id="3828901">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828908">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828984">for</span>&nbsp;<span class="ident" id="3828988">_</span><span class="op" id="3828989">,</span>&nbsp;<span class="ident" id="3828991">id</span>&nbsp;<span class="op" id="3828994">:=</span>&nbsp;<span class="keyword" id="3828997">range</span>&nbsp;<span class="ident" id="3829003">hs</span><span class="op" id="3829005">.</span><span class="ident" id="3829006">clientHello</span><span class="op" id="3829017">.</span><span class="ident" id="3829018">cipherSuites</span>&nbsp;<span class="op" id="3829031">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829035">if</span>&nbsp;<span class="ident" id="3829038">id</span>&nbsp;<span class="op" id="3829041">==</span>&nbsp;<span class="ident" id="3829044">hs</span><span class="op" id="3829046">.</span><span class="ident" id="3829047">sessionState</span><span class="op" id="3829059">.</span><span class="ident" id="3829060">cipherSuite</span>&nbsp;<span class="op" id="3829072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829077">cipherSuiteOk</span>&nbsp;<span class="op" id="3829091">=</span>&nbsp;<span class="builtintype" id="3829093">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829101">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3829109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3829112">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829115">if</span>&nbsp;<span class="op" id="3829118">!</span><span class="ident" id="3829119">cipherSuiteOk</span>&nbsp;<span class="op" id="3829133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829137">return</span>&nbsp;<span class="builtintype" id="3829144">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3829151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3829155">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829220">hs</span><span class="op" id="3829222">.</span><span class="ident" id="3829223">suite</span>&nbsp;<span class="op" id="3829229">=</span>&nbsp;<span class="ident" id="3829231">c</span><span class="op" id="3829232">.</span><span class="ident" id="3829233">tryCipherSuite</span><span class="op" id="3829247">(</span><span class="ident" id="3829248">hs</span><span class="op" id="3829250">.</span><span class="ident" id="3829251">sessionState</span><span class="op" id="3829263">.</span><span class="ident" id="3829264">cipherSuite</span><span class="op" id="3829275">,</span>&nbsp;<span class="ident" id="3829277">c</span><span class="op" id="3829278">.</span><span class="ident" id="3829279">config</span><span class="op" id="3829285">.</span><span class="ident" id="3829286">cipherSuites</span><span class="op" id="3829298">(</span><span class="op" id="3829299">)</span><span class="op" id="3829300">,</span>&nbsp;<span class="ident" id="3829302">hs</span><span class="op" id="3829304">.</span><span class="ident" id="3829305">sessionState</span><span class="op" id="3829317">.</span><span class="ident" id="3829318">vers</span><span class="op" id="3829322">,</span>&nbsp;<span class="ident" id="3829324">hs</span><span class="op" id="3829326">.</span><span class="ident" id="3829327">ellipticOk</span><span class="op" id="3829337">,</span>&nbsp;<span class="ident" id="3829339">hs</span><span class="op" id="3829341">.</span><span class="ident" id="3829342">ecdsaOk</span><span class="op" id="3829349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829352">if</span>&nbsp;<span class="ident" id="3829355">hs</span><span class="op" id="3829357">.</span><span class="ident" id="3829358">suite</span>&nbsp;<span class="op" id="3829364">==</span>&nbsp;<span class="builtintype" id="3829367">nil</span>&nbsp;<span class="op" id="3829371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829375">return</span>&nbsp;<span class="builtintype" id="3829382">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3829389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829393">sessionHasClientCerts</span>&nbsp;<span class="op" id="3829415">:=</span>&nbsp;<span class="builtinfunc" id="3829418">len</span><span class="op" id="3829421">(</span><span class="ident" id="3829422">hs</span><span class="op" id="3829424">.</span><span class="ident" id="3829425">sessionState</span><span class="op" id="3829437">.</span><span class="ident" id="3829438">certificates</span><span class="op" id="3829450">)</span>&nbsp;<span class="op" id="3829452">!=</span>&nbsp;<span class="num" id="3829455">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829458">needClientCerts</span>&nbsp;<span class="op" id="3829474">:=</span>&nbsp;<span class="ident" id="3829477">c</span><span class="op" id="3829478">.</span><span class="ident" id="3829479">config</span><span class="op" id="3829485">.</span><span class="ident" id="3829486">ClientAuth</span>&nbsp;<span class="op" id="3829497">==</span>&nbsp;<span class="ident" id="3829500">RequireAnyClientCert</span>&nbsp;<span class="op" id="3829521">||</span>&nbsp;<span class="ident" id="3829524">c</span><span class="op" id="3829525">.</span><span class="ident" id="3829526">config</span><span class="op" id="3829532">.</span><span class="ident" id="3829533">ClientAuth</span>&nbsp;<span class="op" id="3829544">==</span>&nbsp;<span class="ident" id="3829547">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829575">if</span>&nbsp;<span class="ident" id="3829578">needClientCerts</span>&nbsp;<span class="op" id="3829594">&amp;&amp;</span>&nbsp;<span class="op" id="3829597">!</span><span class="ident" id="3829598">sessionHasClientCerts</span>&nbsp;<span class="op" id="3829620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829624">return</span>&nbsp;<span class="builtintype" id="3829631">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3829638">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829641">if</span>&nbsp;<span class="ident" id="3829644">sessionHasClientCerts</span>&nbsp;<span class="op" id="3829666">&amp;&amp;</span>&nbsp;<span class="ident" id="3829669">c</span><span class="op" id="3829670">.</span><span class="ident" id="3829671">config</span><span class="op" id="3829677">.</span><span class="ident" id="3829678">ClientAuth</span>&nbsp;<span class="op" id="3829689">==</span>&nbsp;<span class="ident" id="3829692">NoClientCert</span>&nbsp;<span class="op" id="3829705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829709">return</span>&nbsp;<span class="builtintype" id="3829716">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3829723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3829727">return</span>&nbsp;<span class="builtintype" id="3829734">true</span><br>
<span class="lineno">290</span><span class="op" id="3829739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3829742">func</span>&nbsp;<span class="op" id="3829747">(</span><span class="ident" id="3829748">hs</span>&nbsp;<span class="op" id="3829751">*</span><span class="ident" id="3829752">serverHandshakeState</span><span class="op" id="3829772">)</span>&nbsp;<span class="ident" id="3829774">doResumeHandshake</span><span class="op" id="3829791">(</span><span class="op" id="3829792">)</span>&nbsp;<span class="builtintype" id="3829794">error</span>&nbsp;<span class="op" id="3829800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829803">c</span>&nbsp;<span class="op" id="3829805">:=</span>&nbsp;<span class="ident" id="3829808">hs</span><span class="op" id="3829810">.</span><span class="ident" id="3829811">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829815">hs</span><span class="op" id="3829817">.</span><span class="ident" id="3829818">hello</span><span class="op" id="3829823">.</span><span class="ident" id="3829824">cipherSuite</span>&nbsp;<span class="op" id="3829836">=</span>&nbsp;<span class="ident" id="3829838">hs</span><span class="op" id="3829840">.</span><span class="ident" id="3829841">suite</span><span class="op" id="3829846">.</span><span class="ident" id="3829847">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3829851">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3829921">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3829956">hs</span><span class="op" id="3829958">.</span><span class="ident" id="3829959">hello</span><span class="op" id="3829964">.</span><span class="ident" id="3829965">sessionId</span>&nbsp;<span class="op" id="3829975">=</span>&nbsp;<span class="ident" id="3829977">hs</span><span class="op" id="3829979">.</span><span class="ident" id="3829980">clientHello</span><span class="op" id="3829991">.</span><span class="ident" id="3829992">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830003">hs</span><span class="op" id="3830005">.</span><span class="ident" id="3830006">finishedHash</span><span class="op" id="3830018">.</span><span class="ident" id="3830019">Write</span><span class="op" id="3830024">(</span><span class="ident" id="3830025">hs</span><span class="op" id="3830027">.</span><span class="ident" id="3830028">hello</span><span class="op" id="3830033">.</span><span class="ident" id="3830034">marshal</span><span class="op" id="3830041">(</span><span class="op" id="3830042">)</span><span class="op" id="3830043">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830046">c</span><span class="op" id="3830047">.</span><span class="ident" id="3830048">writeRecord</span><span class="op" id="3830059">(</span><span class="ident" id="3830060">recordTypeHandshake</span><span class="op" id="3830079">,</span>&nbsp;<span class="ident" id="3830081">hs</span><span class="op" id="3830083">.</span><span class="ident" id="3830084">hello</span><span class="op" id="3830089">.</span><span class="ident" id="3830090">marshal</span><span class="op" id="3830097">(</span><span class="op" id="3830098">)</span><span class="op" id="3830099">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3830103">if</span>&nbsp;<span class="builtinfunc" id="3830106">len</span><span class="op" id="3830109">(</span><span class="ident" id="3830110">hs</span><span class="op" id="3830112">.</span><span class="ident" id="3830113">sessionState</span><span class="op" id="3830125">.</span><span class="ident" id="3830126">certificates</span><span class="op" id="3830138">)</span>&nbsp;<span class="op" id="3830140">&gt;</span>&nbsp;<span class="num" id="3830142">0</span>&nbsp;<span class="op" id="3830144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3830148">if</span>&nbsp;<span class="ident" id="3830151">_</span><span class="op" id="3830152">,</span>&nbsp;<span class="ident" id="3830154">err</span>&nbsp;<span class="op" id="3830158">:=</span>&nbsp;<span class="ident" id="3830161">hs</span><span class="op" id="3830163">.</span><span class="ident" id="3830164">processCertsFromClient</span><span class="op" id="3830186">(</span><span class="ident" id="3830187">hs</span><span class="op" id="3830189">.</span><span class="ident" id="3830190">sessionState</span><span class="op" id="3830202">.</span><span class="ident" id="3830203">certificates</span><span class="op" id="3830215">)</span><span class="op" id="3830216">;</span>&nbsp;<span class="ident" id="3830218">err</span>&nbsp;<span class="op" id="3830222">!=</span>&nbsp;<span class="builtintype" id="3830225">nil</span>&nbsp;<span class="op" id="3830229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3830234">return</span>&nbsp;<span class="ident" id="3830241">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3830247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3830250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830254">hs</span><span class="op" id="3830256">.</span><span class="ident" id="3830257">masterSecret</span>&nbsp;<span class="op" id="3830270">=</span>&nbsp;<span class="ident" id="3830272">hs</span><span class="op" id="3830274">.</span><span class="ident" id="3830275">sessionState</span><span class="op" id="3830287">.</span><span class="ident" id="3830288">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3830303">return</span>&nbsp;<span class="builtintype" id="3830310">nil</span><br>
<span class="lineno"></span><span class="op" id="3830314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3830317">func</span>&nbsp;<span class="op" id="3830322">(</span><span class="ident" id="3830323">hs</span>&nbsp;<span class="op" id="3830326">*</span><span class="ident" id="3830327">serverHandshakeState</span><span class="op" id="3830347">)</span>&nbsp;<span class="ident" id="3830349">doFullHandshake</span><span class="op" id="3830364">(</span><span class="op" id="3830365">)</span>&nbsp;<span class="builtintype" id="3830367">error</span>&nbsp;<span class="op" id="3830373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830376">config</span>&nbsp;<span class="op" id="3830383">:=</span>&nbsp;<span class="ident" id="3830386">hs</span><span class="op" id="3830388">.</span><span class="ident" id="3830389">c</span><span class="op" id="3830390">.</span><span class="ident" id="3830391">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830399">c</span>&nbsp;<span class="op" id="3830401">:=</span>&nbsp;<span class="ident" id="3830404">hs</span><span class="op" id="3830406">.</span><span class="ident" id="3830407">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3830411">if</span>&nbsp;<span class="ident" id="3830414">hs</span><span class="op" id="3830416">.</span><span class="ident" id="3830417">clientHello</span><span class="op" id="3830428">.</span><span class="ident" id="3830429">ocspStapling</span>&nbsp;<span class="op" id="3830442">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3830445">len</span><span class="op" id="3830448">(</span><span class="ident" id="3830449">hs</span><span class="op" id="3830451">.</span><span class="ident" id="3830452">cert</span><span class="op" id="3830456">.</span><span class="ident" id="3830457">OCSPStaple</span><span class="op" id="3830467">)</span>&nbsp;<span class="op" id="3830469">&gt;</span>&nbsp;<span class="num" id="3830471">0</span>&nbsp;<span class="op" id="3830473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830477">hs</span><span class="op" id="3830479">.</span><span class="ident" id="3830480">hello</span><span class="op" id="3830485">.</span><span class="ident" id="3830486">ocspStapling</span>&nbsp;<span class="op" id="3830499">=</span>&nbsp;<span class="builtintype" id="3830501">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3830507">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830511">hs</span><span class="op" id="3830513">.</span><span class="ident" id="3830514">hello</span><span class="op" id="3830519">.</span><span class="ident" id="3830520">ticketSupported</span>&nbsp;<span class="op" id="3830536">=</span>&nbsp;<span class="ident" id="3830538">hs</span><span class="op" id="3830540">.</span><span class="ident" id="3830541">clientHello</span><span class="op" id="3830552">.</span><span class="ident" id="3830553">ticketSupported</span>&nbsp;<span class="op" id="3830569">&amp;&amp;</span>&nbsp;<span class="op" id="3830572">!</span><span class="ident" id="3830573">config</span><span class="op" id="3830579">.</span><span class="ident" id="3830580">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830604">hs</span><span class="op" id="3830606">.</span><span class="ident" id="3830607">hello</span><span class="op" id="3830612">.</span><span class="ident" id="3830613">cipherSuite</span>&nbsp;<span class="op" id="3830625">=</span>&nbsp;<span class="ident" id="3830627">hs</span><span class="op" id="3830629">.</span><span class="ident" id="3830630">suite</span><span class="op" id="3830635">.</span><span class="ident" id="3830636">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830640">hs</span><span class="op" id="3830642">.</span><span class="ident" id="3830643">finishedHash</span><span class="op" id="3830655">.</span><span class="ident" id="3830656">Write</span><span class="op" id="3830661">(</span><span class="ident" id="3830662">hs</span><span class="op" id="3830664">.</span><span class="ident" id="3830665">hello</span><span class="op" id="3830670">.</span><span class="ident" id="3830671">marshal</span><span class="op" id="3830678">(</span><span class="op" id="3830679">)</span><span class="op" id="3830680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830683">c</span><span class="op" id="3830684">.</span><span class="ident" id="3830685">writeRecord</span><span class="op" id="3830696">(</span><span class="ident" id="3830697">recordTypeHandshake</span><span class="op" id="3830716">,</span>&nbsp;<span class="ident" id="3830718">hs</span><span class="op" id="3830720">.</span><span class="ident" id="3830721">hello</span><span class="op" id="3830726">.</span><span class="ident" id="3830727">marshal</span><span class="op" id="3830734">(</span><span class="op" id="3830735">)</span><span class="op" id="3830736">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830740">certMsg</span>&nbsp;<span class="op" id="3830748">:=</span>&nbsp;<span class="builtinfunc" id="3830751">new</span><span class="op" id="3830754">(</span><span class="ident" id="3830755">certificateMsg</span><span class="op" id="3830769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830772">certMsg</span><span class="op" id="3830779">.</span><span class="ident" id="3830780">certificates</span>&nbsp;<span class="op" id="3830793">=</span>&nbsp;<span class="ident" id="3830795">hs</span><span class="op" id="3830797">.</span><span class="ident" id="3830798">cert</span><span class="op" id="3830802">.</span><span class="ident" id="3830803">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830816">hs</span><span class="op" id="3830818">.</span><span class="ident" id="3830819">finishedHash</span><span class="op" id="3830831">.</span><span class="ident" id="3830832">Write</span><span class="op" id="3830837">(</span><span class="ident" id="3830838">certMsg</span><span class="op" id="3830845">.</span><span class="ident" id="3830846">marshal</span><span class="op" id="3830853">(</span><span class="op" id="3830854">)</span><span class="op" id="3830855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830858">c</span><span class="op" id="3830859">.</span><span class="ident" id="3830860">writeRecord</span><span class="op" id="3830871">(</span><span class="ident" id="3830872">recordTypeHandshake</span><span class="op" id="3830891">,</span>&nbsp;<span class="ident" id="3830893">certMsg</span><span class="op" id="3830900">.</span><span class="ident" id="3830901">marshal</span><span class="op" id="3830908">(</span><span class="op" id="3830909">)</span><span class="op" id="3830910">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3830914">if</span>&nbsp;<span class="ident" id="3830917">hs</span><span class="op" id="3830919">.</span><span class="ident" id="3830920">hello</span><span class="op" id="3830925">.</span><span class="ident" id="3830926">ocspStapling</span>&nbsp;<span class="op" id="3830939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830943">certStatus</span>&nbsp;<span class="op" id="3830954">:=</span>&nbsp;<span class="builtinfunc" id="3830957">new</span><span class="op" id="3830960">(</span><span class="ident" id="3830961">certificateStatusMsg</span><span class="op" id="3830981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3830985">certStatus</span><span class="op" id="3830995">.</span><span class="ident" id="3830996">statusType</span>&nbsp;<span class="op" id="3831007">=</span>&nbsp;<span class="ident" id="3831009">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831026">certStatus</span><span class="op" id="3831036">.</span><span class="ident" id="3831037">response</span>&nbsp;<span class="op" id="3831046">=</span>&nbsp;<span class="ident" id="3831048">hs</span><span class="op" id="3831050">.</span><span class="ident" id="3831051">cert</span><span class="op" id="3831055">.</span><span class="ident" id="3831056">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831069">hs</span><span class="op" id="3831071">.</span><span class="ident" id="3831072">finishedHash</span><span class="op" id="3831084">.</span><span class="ident" id="3831085">Write</span><span class="op" id="3831090">(</span><span class="ident" id="3831091">certStatus</span><span class="op" id="3831101">.</span><span class="ident" id="3831102">marshal</span><span class="op" id="3831109">(</span><span class="op" id="3831110">)</span><span class="op" id="3831111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831115">c</span><span class="op" id="3831116">.</span><span class="ident" id="3831117">writeRecord</span><span class="op" id="3831128">(</span><span class="ident" id="3831129">recordTypeHandshake</span><span class="op" id="3831148">,</span>&nbsp;<span class="ident" id="3831150">certStatus</span><span class="op" id="3831160">.</span><span class="ident" id="3831161">marshal</span><span class="op" id="3831168">(</span><span class="op" id="3831169">)</span><span class="op" id="3831170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3831173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831177">keyAgreement</span>&nbsp;<span class="op" id="3831190">:=</span>&nbsp;<span class="ident" id="3831193">hs</span><span class="op" id="3831195">.</span><span class="ident" id="3831196">suite</span><span class="op" id="3831201">.</span><span class="ident" id="3831202">ka</span><span class="op" id="3831204">(</span><span class="ident" id="3831205">c</span><span class="op" id="3831206">.</span><span class="ident" id="3831207">vers</span><span class="op" id="3831211">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831214">skx</span><span class="op" id="3831217">,</span>&nbsp;<span class="ident" id="3831219">err</span>&nbsp;<span class="op" id="3831223">:=</span>&nbsp;<span class="ident" id="3831226">keyAgreement</span><span class="op" id="3831238">.</span><span class="ident" id="3831239">generateServerKeyExchange</span><span class="op" id="3831264">(</span><span class="ident" id="3831265">config</span><span class="op" id="3831271">,</span>&nbsp;<span class="ident" id="3831273">hs</span><span class="op" id="3831275">.</span><span class="ident" id="3831276">cert</span><span class="op" id="3831280">,</span>&nbsp;<span class="ident" id="3831282">hs</span><span class="op" id="3831284">.</span><span class="ident" id="3831285">clientHello</span><span class="op" id="3831296">,</span>&nbsp;<span class="ident" id="3831298">hs</span><span class="op" id="3831300">.</span><span class="ident" id="3831301">hello</span><span class="op" id="3831306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3831309">if</span>&nbsp;<span class="ident" id="3831312">err</span>&nbsp;<span class="op" id="3831316">!=</span>&nbsp;<span class="builtintype" id="3831319">nil</span>&nbsp;<span class="op" id="3831323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831327">c</span><span class="op" id="3831328">.</span><span class="ident" id="3831329">sendAlert</span><span class="op" id="3831338">(</span><span class="ident" id="3831339">alertHandshakeFailure</span><span class="op" id="3831360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3831364">return</span>&nbsp;<span class="ident" id="3831371">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3831376">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3831379">if</span>&nbsp;<span class="ident" id="3831382">skx</span>&nbsp;<span class="op" id="3831386">!=</span>&nbsp;<span class="builtintype" id="3831389">nil</span>&nbsp;<span class="op" id="3831393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831397">hs</span><span class="op" id="3831399">.</span><span class="ident" id="3831400">finishedHash</span><span class="op" id="3831412">.</span><span class="ident" id="3831413">Write</span><span class="op" id="3831418">(</span><span class="ident" id="3831419">skx</span><span class="op" id="3831422">.</span><span class="ident" id="3831423">marshal</span><span class="op" id="3831430">(</span><span class="op" id="3831431">)</span><span class="op" id="3831432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831436">c</span><span class="op" id="3831437">.</span><span class="ident" id="3831438">writeRecord</span><span class="op" id="3831449">(</span><span class="ident" id="3831450">recordTypeHandshake</span><span class="op" id="3831469">,</span>&nbsp;<span class="ident" id="3831471">skx</span><span class="op" id="3831474">.</span><span class="ident" id="3831475">marshal</span><span class="op" id="3831482">(</span><span class="op" id="3831483">)</span><span class="op" id="3831484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3831487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3831491">if</span>&nbsp;<span class="ident" id="3831494">config</span><span class="op" id="3831500">.</span><span class="ident" id="3831501">ClientAuth</span>&nbsp;<span class="op" id="3831512">&gt;=</span>&nbsp;<span class="ident" id="3831515">RequestClientCert</span>&nbsp;<span class="op" id="3831533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831537">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831571">certReq</span>&nbsp;<span class="op" id="3831579">:=</span>&nbsp;<span class="builtinfunc" id="3831582">new</span><span class="op" id="3831585">(</span><span class="ident" id="3831586">certificateRequestMsg</span><span class="op" id="3831607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831611">certReq</span><span class="op" id="3831618">.</span><span class="ident" id="3831619">certificateTypes</span>&nbsp;<span class="op" id="3831636">=</span>&nbsp;<span class="op" id="3831638">[</span><span class="op" id="3831639">]</span><span class="builtintype" id="3831640">byte</span><span class="op" id="3831644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3831649">byte</span><span class="op" id="3831653">(</span><span class="ident" id="3831654">certTypeRSASign</span><span class="op" id="3831669">)</span><span class="op" id="3831670">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3831675">byte</span><span class="op" id="3831679">(</span><span class="ident" id="3831680">certTypeECDSASign</span><span class="op" id="3831697">)</span><span class="op" id="3831698">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3831702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3831706">if</span>&nbsp;<span class="ident" id="3831709">c</span><span class="op" id="3831710">.</span><span class="ident" id="3831711">vers</span>&nbsp;<span class="op" id="3831716">&gt;=</span>&nbsp;<span class="ident" id="3831719">VersionTLS12</span>&nbsp;<span class="op" id="3831732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831737">certReq</span><span class="op" id="3831744">.</span><span class="ident" id="3831745">hasSignatureAndHash</span>&nbsp;<span class="op" id="3831765">=</span>&nbsp;<span class="builtintype" id="3831767">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3831775">certReq</span><span class="op" id="3831782">.</span><span class="ident" id="3831783">signatureAndHashes</span>&nbsp;<span class="op" id="3831802">=</span>&nbsp;<span class="ident" id="3831804">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3831845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831850">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831906">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3831967">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3832024">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3832082">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832129">if</span>&nbsp;<span class="ident" id="3832132">config</span><span class="op" id="3832138">.</span><span class="ident" id="3832139">ClientCAs</span>&nbsp;<span class="op" id="3832149">!=</span>&nbsp;<span class="builtintype" id="3832152">nil</span>&nbsp;<span class="op" id="3832156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832161">certReq</span><span class="op" id="3832168">.</span><span class="ident" id="3832169">certificateAuthorities</span>&nbsp;<span class="op" id="3832192">=</span>&nbsp;<span class="ident" id="3832194">config</span><span class="op" id="3832200">.</span><span class="ident" id="3832201">ClientCAs</span><span class="op" id="3832210">.</span><span class="ident" id="3832211">Subjects</span><span class="op" id="3832219">(</span><span class="op" id="3832220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832224">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832228">hs</span><span class="op" id="3832230">.</span><span class="ident" id="3832231">finishedHash</span><span class="op" id="3832243">.</span><span class="ident" id="3832244">Write</span><span class="op" id="3832249">(</span><span class="ident" id="3832250">certReq</span><span class="op" id="3832257">.</span><span class="ident" id="3832258">marshal</span><span class="op" id="3832265">(</span><span class="op" id="3832266">)</span><span class="op" id="3832267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832271">c</span><span class="op" id="3832272">.</span><span class="ident" id="3832273">writeRecord</span><span class="op" id="3832284">(</span><span class="ident" id="3832285">recordTypeHandshake</span><span class="op" id="3832304">,</span>&nbsp;<span class="ident" id="3832306">certReq</span><span class="op" id="3832313">.</span><span class="ident" id="3832314">marshal</span><span class="op" id="3832321">(</span><span class="op" id="3832322">)</span><span class="op" id="3832323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832330">helloDone</span>&nbsp;<span class="op" id="3832340">:=</span>&nbsp;<span class="builtinfunc" id="3832343">new</span><span class="op" id="3832346">(</span><span class="ident" id="3832347">serverHelloDoneMsg</span><span class="op" id="3832365">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832368">hs</span><span class="op" id="3832370">.</span><span class="ident" id="3832371">finishedHash</span><span class="op" id="3832383">.</span><span class="ident" id="3832384">Write</span><span class="op" id="3832389">(</span><span class="ident" id="3832390">helloDone</span><span class="op" id="3832399">.</span><span class="ident" id="3832400">marshal</span><span class="op" id="3832407">(</span><span class="op" id="3832408">)</span><span class="op" id="3832409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832412">c</span><span class="op" id="3832413">.</span><span class="ident" id="3832414">writeRecord</span><span class="op" id="3832425">(</span><span class="ident" id="3832426">recordTypeHandshake</span><span class="op" id="3832445">,</span>&nbsp;<span class="ident" id="3832447">helloDone</span><span class="op" id="3832456">.</span><span class="ident" id="3832457">marshal</span><span class="op" id="3832464">(</span><span class="op" id="3832465">)</span><span class="op" id="3832466">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832470">var</span>&nbsp;<span class="ident" id="3832474">pub</span>&nbsp;<span class="ident" id="3832478">crypto</span><span class="op" id="3832484">.</span><span class="ident" id="3832485">PublicKey</span>&nbsp;<span class="comment" id="3832495">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832535">msg</span><span class="op" id="3832538">,</span>&nbsp;<span class="ident" id="3832540">err</span>&nbsp;<span class="op" id="3832544">:=</span>&nbsp;<span class="ident" id="3832547">c</span><span class="op" id="3832548">.</span><span class="ident" id="3832549">readHandshake</span><span class="op" id="3832562">(</span><span class="op" id="3832563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832566">if</span>&nbsp;<span class="ident" id="3832569">err</span>&nbsp;<span class="op" id="3832573">!=</span>&nbsp;<span class="builtintype" id="3832576">nil</span>&nbsp;<span class="op" id="3832580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832584">return</span>&nbsp;<span class="ident" id="3832591">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832600">var</span>&nbsp;<span class="ident" id="3832604">ok</span>&nbsp;<span class="builtintype" id="3832607">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3832613">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3832683">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832728">if</span>&nbsp;<span class="ident" id="3832731">config</span><span class="op" id="3832737">.</span><span class="ident" id="3832738">ClientAuth</span>&nbsp;<span class="op" id="3832749">&gt;=</span>&nbsp;<span class="ident" id="3832752">RequestClientCert</span>&nbsp;<span class="op" id="3832770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832774">if</span>&nbsp;<span class="ident" id="3832777">certMsg</span><span class="op" id="3832784">,</span>&nbsp;<span class="ident" id="3832786">ok</span>&nbsp;<span class="op" id="3832789">=</span>&nbsp;<span class="ident" id="3832791">msg</span><span class="op" id="3832794">.</span><span class="op" id="3832795">(</span><span class="op" id="3832796">*</span><span class="ident" id="3832797">certificateMsg</span><span class="op" id="3832811">)</span><span class="op" id="3832812">;</span>&nbsp;<span class="op" id="3832814">!</span><span class="ident" id="3832815">ok</span>&nbsp;<span class="op" id="3832818">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832823">c</span><span class="op" id="3832824">.</span><span class="ident" id="3832825">sendAlert</span><span class="op" id="3832834">(</span><span class="ident" id="3832835">alertUnexpectedMessage</span><span class="op" id="3832857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832862">return</span>&nbsp;<span class="ident" id="3832869">unexpectedMessageError</span><span class="op" id="3832891">(</span><span class="ident" id="3832892">certMsg</span><span class="op" id="3832899">,</span>&nbsp;<span class="ident" id="3832901">msg</span><span class="op" id="3832904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3832912">hs</span><span class="op" id="3832914">.</span><span class="ident" id="3832915">finishedHash</span><span class="op" id="3832927">.</span><span class="ident" id="3832928">Write</span><span class="op" id="3832933">(</span><span class="ident" id="3832934">certMsg</span><span class="op" id="3832941">.</span><span class="ident" id="3832942">marshal</span><span class="op" id="3832949">(</span><span class="op" id="3832950">)</span><span class="op" id="3832951">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3832956">if</span>&nbsp;<span class="builtinfunc" id="3832959">len</span><span class="op" id="3832962">(</span><span class="ident" id="3832963">certMsg</span><span class="op" id="3832970">.</span><span class="ident" id="3832971">certificates</span><span class="op" id="3832983">)</span>&nbsp;<span class="op" id="3832985">==</span>&nbsp;<span class="num" id="3832988">0</span>&nbsp;<span class="op" id="3832990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3832995">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833047">switch</span>&nbsp;<span class="ident" id="3833054">config</span><span class="op" id="3833060">.</span><span class="ident" id="3833061">ClientAuth</span>&nbsp;<span class="op" id="3833072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833077">case</span>&nbsp;<span class="ident" id="3833082">RequireAnyClientCert</span><span class="op" id="3833102">,</span>&nbsp;<span class="ident" id="3833104">RequireAndVerifyClientCert</span><span class="op" id="3833130">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833136">c</span><span class="op" id="3833137">.</span><span class="ident" id="3833138">sendAlert</span><span class="op" id="3833147">(</span><span class="ident" id="3833148">alertBadCertificate</span><span class="op" id="3833167">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833173">return</span>&nbsp;<span class="ident" id="3833180">errors</span><span class="op" id="3833186">.</span><span class="ident" id="3833187">New</span><span class="op" id="3833190">(</span><span class="string" id="3833191">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="3833233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833247">pub</span><span class="op" id="3833250">,</span>&nbsp;<span class="ident" id="3833252">err</span>&nbsp;<span class="op" id="3833256">=</span>&nbsp;<span class="ident" id="3833258">hs</span><span class="op" id="3833260">.</span><span class="ident" id="3833261">processCertsFromClient</span><span class="op" id="3833283">(</span><span class="ident" id="3833284">certMsg</span><span class="op" id="3833291">.</span><span class="ident" id="3833292">certificates</span><span class="op" id="3833304">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833308">if</span>&nbsp;<span class="ident" id="3833311">err</span>&nbsp;<span class="op" id="3833315">!=</span>&nbsp;<span class="builtintype" id="3833318">nil</span>&nbsp;<span class="op" id="3833322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833327">return</span>&nbsp;<span class="ident" id="3833334">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833345">msg</span><span class="op" id="3833348">,</span>&nbsp;<span class="ident" id="3833350">err</span>&nbsp;<span class="op" id="3833354">=</span>&nbsp;<span class="ident" id="3833356">c</span><span class="op" id="3833357">.</span><span class="ident" id="3833358">readHandshake</span><span class="op" id="3833371">(</span><span class="op" id="3833372">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833376">if</span>&nbsp;<span class="ident" id="3833379">err</span>&nbsp;<span class="op" id="3833383">!=</span>&nbsp;<span class="builtintype" id="3833386">nil</span>&nbsp;<span class="op" id="3833390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833395">return</span>&nbsp;<span class="ident" id="3833402">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3833415">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833443">ckx</span><span class="op" id="3833446">,</span>&nbsp;<span class="ident" id="3833448">ok</span>&nbsp;<span class="op" id="3833451">:=</span>&nbsp;<span class="ident" id="3833454">msg</span><span class="op" id="3833457">.</span><span class="op" id="3833458">(</span><span class="op" id="3833459">*</span><span class="ident" id="3833460">clientKeyExchangeMsg</span><span class="op" id="3833480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833483">if</span>&nbsp;<span class="op" id="3833486">!</span><span class="ident" id="3833487">ok</span>&nbsp;<span class="op" id="3833490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833494">c</span><span class="op" id="3833495">.</span><span class="ident" id="3833496">sendAlert</span><span class="op" id="3833505">(</span><span class="ident" id="3833506">alertUnexpectedMessage</span><span class="op" id="3833528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3833532">return</span>&nbsp;<span class="ident" id="3833539">unexpectedMessageError</span><span class="op" id="3833561">(</span><span class="ident" id="3833562">ckx</span><span class="op" id="3833565">,</span>&nbsp;<span class="ident" id="3833567">msg</span><span class="op" id="3833570">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833576">hs</span><span class="op" id="3833578">.</span><span class="ident" id="3833579">finishedHash</span><span class="op" id="3833591">.</span><span class="ident" id="3833592">Write</span><span class="op" id="3833597">(</span><span class="ident" id="3833598">ckx</span><span class="op" id="3833601">.</span><span class="ident" id="3833602">marshal</span><span class="op" id="3833609">(</span><span class="op" id="3833610">)</span><span class="op" id="3833611">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3833615">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3833696">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3833769">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3833838">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3833918">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3833998">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834052">if</span>&nbsp;<span class="builtinfunc" id="3834055">len</span><span class="op" id="3834058">(</span><span class="ident" id="3834059">c</span><span class="op" id="3834060">.</span><span class="ident" id="3834061">peerCertificates</span><span class="op" id="3834077">)</span>&nbsp;<span class="op" id="3834079">&gt;</span>&nbsp;<span class="num" id="3834081">0</span>&nbsp;<span class="op" id="3834083">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3834087">msg</span><span class="op" id="3834090">,</span>&nbsp;<span class="ident" id="3834092">err</span>&nbsp;<span class="op" id="3834096">=</span>&nbsp;<span class="ident" id="3834098">c</span><span class="op" id="3834099">.</span><span class="ident" id="3834100">readHandshake</span><span class="op" id="3834113">(</span><span class="op" id="3834114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834118">if</span>&nbsp;<span class="ident" id="3834121">err</span>&nbsp;<span class="op" id="3834125">!=</span>&nbsp;<span class="builtintype" id="3834128">nil</span>&nbsp;<span class="op" id="3834132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834137">return</span>&nbsp;<span class="ident" id="3834144">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3834150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3834154">certVerify</span><span class="op" id="3834164">,</span>&nbsp;<span class="ident" id="3834166">ok</span>&nbsp;<span class="op" id="3834169">:=</span>&nbsp;<span class="ident" id="3834172">msg</span><span class="op" id="3834175">.</span><span class="op" id="3834176">(</span><span class="op" id="3834177">*</span><span class="ident" id="3834178">certificateVerifyMsg</span><span class="op" id="3834198">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834202">if</span>&nbsp;<span class="op" id="3834205">!</span><span class="ident" id="3834206">ok</span>&nbsp;<span class="op" id="3834209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3834214">c</span><span class="op" id="3834215">.</span><span class="ident" id="3834216">sendAlert</span><span class="op" id="3834225">(</span><span class="ident" id="3834226">alertUnexpectedMessage</span><span class="op" id="3834248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834253">return</span>&nbsp;<span class="ident" id="3834260">unexpectedMessageError</span><span class="op" id="3834282">(</span><span class="ident" id="3834283">certVerify</span><span class="op" id="3834293">,</span>&nbsp;<span class="ident" id="3834295">msg</span><span class="op" id="3834298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3834302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834307">switch</span>&nbsp;<span class="ident" id="3834314">key</span>&nbsp;<span class="op" id="3834318">:=</span>&nbsp;<span class="ident" id="3834321">pub</span><span class="op" id="3834324">.</span><span class="op" id="3834325">(</span><span class="keyword" id="3834326">type</span><span class="op" id="3834330">)</span>&nbsp;<span class="op" id="3834332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834336">case</span>&nbsp;<span class="op" id="3834341">*</span><span class="ident" id="3834342">ecdsa</span><span class="op" id="3834347">.</span><span class="ident" id="3834348">PublicKey</span><span class="op" id="3834357">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3834362">ecdsaSig</span>&nbsp;<span class="op" id="3834371">:=</span>&nbsp;<span class="builtinfunc" id="3834374">new</span><span class="op" id="3834377">(</span><span class="ident" id="3834378">ecdsaSignature</span><span class="op" id="3834392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834397">if</span>&nbsp;<span class="ident" id="3834400">_</span><span class="op" id="3834401">,</span>&nbsp;<span class="ident" id="3834403">err</span>&nbsp;<span class="op" id="3834407">=</span>&nbsp;<span class="ident" id="3834409">asn1</span><span class="op" id="3834413">.</span><span class="ident" id="3834414">Unmarshal</span><span class="op" id="3834423">(</span><span class="ident" id="3834424">certVerify</span><span class="op" id="3834434">.</span><span class="ident" id="3834435">signature</span><span class="op" id="3834444">,</span>&nbsp;<span class="ident" id="3834446">ecdsaSig</span><span class="op" id="3834454">)</span><span class="op" id="3834455">;</span>&nbsp;<span class="ident" id="3834457">err</span>&nbsp;<span class="op" id="3834461">!=</span>&nbsp;<span class="builtintype" id="3834464">nil</span>&nbsp;<span class="op" id="3834468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834474">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3834483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834488">if</span>&nbsp;<span class="ident" id="3834491">ecdsaSig</span><span class="op" id="3834499">.</span><span class="ident" id="3834500">R</span><span class="op" id="3834501">.</span><span class="ident" id="3834502">Sign</span><span class="op" id="3834506">(</span><span class="op" id="3834507">)</span>&nbsp;<span class="op" id="3834509">&lt;=</span>&nbsp;<span class="num" id="3834512">0</span>&nbsp;<span class="op" id="3834514">||</span>&nbsp;<span class="ident" id="3834517">ecdsaSig</span><span class="op" id="3834525">.</span><span class="ident" id="3834526">S</span><span class="op" id="3834527">.</span><span class="ident" id="3834528">Sign</span><span class="op" id="3834532">(</span><span class="op" id="3834533">)</span>&nbsp;<span class="op" id="3834535">&lt;=</span>&nbsp;<span class="num" id="3834538">0</span>&nbsp;<span class="op" id="3834540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3834546">err</span>&nbsp;<span class="op" id="3834550">=</span>&nbsp;<span class="ident" id="3834552">errors</span><span class="op" id="3834558">.</span><span class="ident" id="3834559">New</span><span class="op" id="3834562">(</span><span class="string" id="3834563">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3834614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834620">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3834629">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3834634">digest</span><span class="op" id="3834640">,</span>&nbsp;<span class="ident" id="3834642">_</span><span class="op" id="3834643">,</span>&nbsp;<span class="ident" id="3834645">_</span>&nbsp;<span class="op" id="3834647">:=</span>&nbsp;<span class="ident" id="3834650">hs</span><span class="op" id="3834652">.</span><span class="ident" id="3834653">finishedHash</span><span class="op" id="3834665">.</span><span class="ident" id="3834666">hashForClientCertificate</span><span class="op" id="3834690">(</span><span class="ident" id="3834691">signatureECDSA</span><span class="op" id="3834705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834710">if</span>&nbsp;<span class="op" id="3834713">!</span><span class="ident" id="3834714">ecdsa</span><span class="op" id="3834719">.</span><span class="ident" id="3834720">Verify</span><span class="op" id="3834726">(</span><span class="ident" id="3834727">key</span><span class="op" id="3834730">,</span>&nbsp;<span class="ident" id="3834732">digest</span><span class="op" id="3834738">,</span>&nbsp;<span class="ident" id="3834740">ecdsaSig</span><span class="op" id="3834748">.</span><span class="ident" id="3834749">R</span><span class="op" id="3834750">,</span>&nbsp;<span class="ident" id="3834752">ecdsaSig</span><span class="op" id="3834760">.</span><span class="ident" id="3834761">S</span><span class="op" id="3834762">)</span>&nbsp;<span class="op" id="3834764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3834770">err</span>&nbsp;<span class="op" id="3834774">=</span>&nbsp;<span class="ident" id="3834776">errors</span><span class="op" id="3834782">.</span><span class="ident" id="3834783">New</span><span class="op" id="3834786">(</span><span class="string" id="3834787">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3834815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834821">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3834830">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3834834">case</span>&nbsp;<span class="op" id="3834839">*</span><span class="ident" id="3834840">rsa</span><span class="op" id="3834843">.</span><span class="ident" id="3834844">PublicKey</span><span class="op" id="3834853">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3834858">digest</span><span class="op" id="3834864">,</span>&nbsp;<span class="ident" id="3834866">hashFunc</span><span class="op" id="3834874">,</span>&nbsp;<span class="ident" id="3834876">_</span>&nbsp;<span class="op" id="3834878">:=</span>&nbsp;<span class="ident" id="3834881">hs</span><span class="op" id="3834883">.</span><span class="ident" id="3834884">finishedHash</span><span class="op" id="3834896">.</span><span class="ident" id="3834897">hashForClientCertificate</span><span class="op" id="3834921">(</span><span class="ident" id="3834922">signatureRSA</span><span class="op" id="3834934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3834939">err</span>&nbsp;<span class="op" id="3834943">=</span>&nbsp;<span class="ident" id="3834945">rsa</span><span class="op" id="3834948">.</span><span class="ident" id="3834949">VerifyPKCS1v15</span><span class="op" id="3834963">(</span><span class="ident" id="3834964">key</span><span class="op" id="3834967">,</span>&nbsp;<span class="ident" id="3834969">hashFunc</span><span class="op" id="3834977">,</span>&nbsp;<span class="ident" id="3834979">digest</span><span class="op" id="3834985">,</span>&nbsp;<span class="ident" id="3834987">certVerify</span><span class="op" id="3834997">.</span><span class="ident" id="3834998">signature</span><span class="op" id="3835007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3835011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3835015">if</span>&nbsp;<span class="ident" id="3835018">err</span>&nbsp;<span class="op" id="3835022">!=</span>&nbsp;<span class="builtintype" id="3835025">nil</span>&nbsp;<span class="op" id="3835029">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835034">c</span><span class="op" id="3835035">.</span><span class="ident" id="3835036">sendAlert</span><span class="op" id="3835045">(</span><span class="ident" id="3835046">alertBadCertificate</span><span class="op" id="3835065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3835070">return</span>&nbsp;<span class="ident" id="3835077">errors</span><span class="op" id="3835083">.</span><span class="ident" id="3835084">New</span><span class="op" id="3835087">(</span><span class="string" id="3835088">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="3835142">+</span>&nbsp;<span class="ident" id="3835144">err</span><span class="op" id="3835147">.</span><span class="ident" id="3835148">Error</span><span class="op" id="3835153">(</span><span class="op" id="3835154">)</span><span class="op" id="3835155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3835159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835164">hs</span><span class="op" id="3835166">.</span><span class="ident" id="3835167">finishedHash</span><span class="op" id="3835179">.</span><span class="ident" id="3835180">Write</span><span class="op" id="3835185">(</span><span class="ident" id="3835186">certVerify</span><span class="op" id="3835196">.</span><span class="ident" id="3835197">marshal</span><span class="op" id="3835204">(</span><span class="op" id="3835205">)</span><span class="op" id="3835206">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3835209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835213">preMasterSecret</span><span class="op" id="3835228">,</span>&nbsp;<span class="ident" id="3835230">err</span>&nbsp;<span class="op" id="3835234">:=</span>&nbsp;<span class="ident" id="3835237">keyAgreement</span><span class="op" id="3835249">.</span><span class="ident" id="3835250">processClientKeyExchange</span><span class="op" id="3835274">(</span><span class="ident" id="3835275">config</span><span class="op" id="3835281">,</span>&nbsp;<span class="ident" id="3835283">hs</span><span class="op" id="3835285">.</span><span class="ident" id="3835286">cert</span><span class="op" id="3835290">,</span>&nbsp;<span class="ident" id="3835292">ckx</span><span class="op" id="3835295">,</span>&nbsp;<span class="ident" id="3835297">c</span><span class="op" id="3835298">.</span><span class="ident" id="3835299">vers</span><span class="op" id="3835303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3835306">if</span>&nbsp;<span class="ident" id="3835309">err</span>&nbsp;<span class="op" id="3835313">!=</span>&nbsp;<span class="builtintype" id="3835316">nil</span>&nbsp;<span class="op" id="3835320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835324">c</span><span class="op" id="3835325">.</span><span class="ident" id="3835326">sendAlert</span><span class="op" id="3835335">(</span><span class="ident" id="3835336">alertHandshakeFailure</span><span class="op" id="3835357">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3835361">return</span>&nbsp;<span class="ident" id="3835368">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3835373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835376">hs</span><span class="op" id="3835378">.</span><span class="ident" id="3835379">masterSecret</span>&nbsp;<span class="op" id="3835392">=</span>&nbsp;<span class="ident" id="3835394">masterFromPreMasterSecret</span><span class="op" id="3835419">(</span><span class="ident" id="3835420">c</span><span class="op" id="3835421">.</span><span class="ident" id="3835422">vers</span><span class="op" id="3835426">,</span>&nbsp;<span class="ident" id="3835428">preMasterSecret</span><span class="op" id="3835443">,</span>&nbsp;<span class="ident" id="3835445">hs</span><span class="op" id="3835447">.</span><span class="ident" id="3835448">clientHello</span><span class="op" id="3835459">.</span><span class="ident" id="3835460">random</span><span class="op" id="3835466">,</span>&nbsp;<span class="ident" id="3835468">hs</span><span class="op" id="3835470">.</span><span class="ident" id="3835471">hello</span><span class="op" id="3835476">.</span><span class="ident" id="3835477">random</span><span class="op" id="3835483">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3835487">return</span>&nbsp;<span class="builtintype" id="3835494">nil</span><br>
<span class="lineno">475</span><span class="op" id="3835498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3835501">func</span>&nbsp;<span class="op" id="3835506">(</span><span class="ident" id="3835507">hs</span>&nbsp;<span class="op" id="3835510">*</span><span class="ident" id="3835511">serverHandshakeState</span><span class="op" id="3835531">)</span>&nbsp;<span class="ident" id="3835533">establishKeys</span><span class="op" id="3835546">(</span><span class="op" id="3835547">)</span>&nbsp;<span class="builtintype" id="3835549">error</span>&nbsp;<span class="op" id="3835555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835558">c</span>&nbsp;<span class="op" id="3835560">:=</span>&nbsp;<span class="ident" id="3835563">hs</span><span class="op" id="3835565">.</span><span class="ident" id="3835566">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835570">clientMAC</span><span class="op" id="3835579">,</span>&nbsp;<span class="ident" id="3835581">serverMAC</span><span class="op" id="3835590">,</span>&nbsp;<span class="ident" id="3835592">clientKey</span><span class="op" id="3835601">,</span>&nbsp;<span class="ident" id="3835603">serverKey</span><span class="op" id="3835612">,</span>&nbsp;<span class="ident" id="3835614">clientIV</span><span class="op" id="3835622">,</span>&nbsp;<span class="ident" id="3835624">serverIV</span>&nbsp;<span class="op" id="3835633">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835638">keysFromMasterSecret</span><span class="op" id="3835658">(</span><span class="ident" id="3835659">c</span><span class="op" id="3835660">.</span><span class="ident" id="3835661">vers</span><span class="op" id="3835665">,</span>&nbsp;<span class="ident" id="3835667">hs</span><span class="op" id="3835669">.</span><span class="ident" id="3835670">masterSecret</span><span class="op" id="3835682">,</span>&nbsp;<span class="ident" id="3835684">hs</span><span class="op" id="3835686">.</span><span class="ident" id="3835687">clientHello</span><span class="op" id="3835698">.</span><span class="ident" id="3835699">random</span><span class="op" id="3835705">,</span>&nbsp;<span class="ident" id="3835707">hs</span><span class="op" id="3835709">.</span><span class="ident" id="3835710">hello</span><span class="op" id="3835715">.</span><span class="ident" id="3835716">random</span><span class="op" id="3835722">,</span>&nbsp;<span class="ident" id="3835724">hs</span><span class="op" id="3835726">.</span><span class="ident" id="3835727">suite</span><span class="op" id="3835732">.</span><span class="ident" id="3835733">macLen</span><span class="op" id="3835739">,</span>&nbsp;<span class="ident" id="3835741">hs</span><span class="op" id="3835743">.</span><span class="ident" id="3835744">suite</span><span class="op" id="3835749">.</span><span class="ident" id="3835750">keyLen</span><span class="op" id="3835756">,</span>&nbsp;<span class="ident" id="3835758">hs</span><span class="op" id="3835760">.</span><span class="ident" id="3835761">suite</span><span class="op" id="3835766">.</span><span class="ident" id="3835767">ivLen</span><span class="op" id="3835772">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3835776">var</span>&nbsp;<span class="ident" id="3835780">clientCipher</span><span class="op" id="3835792">,</span>&nbsp;<span class="ident" id="3835794">serverCipher</span>&nbsp;<span class="keyword" id="3835807">interface</span><span class="op" id="3835816">{</span><span class="op" id="3835817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3835820">var</span>&nbsp;<span class="ident" id="3835824">clientHash</span><span class="op" id="3835834">,</span>&nbsp;<span class="ident" id="3835836">serverHash</span>&nbsp;<span class="ident" id="3835847">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3835861">if</span>&nbsp;<span class="ident" id="3835864">hs</span><span class="op" id="3835866">.</span><span class="ident" id="3835867">suite</span><span class="op" id="3835872">.</span><span class="ident" id="3835873">aead</span>&nbsp;<span class="op" id="3835878">==</span>&nbsp;<span class="builtintype" id="3835881">nil</span>&nbsp;<span class="op" id="3835885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835889">clientCipher</span>&nbsp;<span class="op" id="3835902">=</span>&nbsp;<span class="ident" id="3835904">hs</span><span class="op" id="3835906">.</span><span class="ident" id="3835907">suite</span><span class="op" id="3835912">.</span><span class="ident" id="3835913">cipher</span><span class="op" id="3835919">(</span><span class="ident" id="3835920">clientKey</span><span class="op" id="3835929">,</span>&nbsp;<span class="ident" id="3835931">clientIV</span><span class="op" id="3835939">,</span>&nbsp;<span class="builtintype" id="3835941">true</span>&nbsp;<span class="comment" id="3835946">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3835963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835967">clientHash</span>&nbsp;<span class="op" id="3835978">=</span>&nbsp;<span class="ident" id="3835980">hs</span><span class="op" id="3835982">.</span><span class="ident" id="3835983">suite</span><span class="op" id="3835988">.</span><span class="ident" id="3835989">mac</span><span class="op" id="3835992">(</span><span class="ident" id="3835993">c</span><span class="op" id="3835994">.</span><span class="ident" id="3835995">vers</span><span class="op" id="3835999">,</span>&nbsp;<span class="ident" id="3836001">clientMAC</span><span class="op" id="3836010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836014">serverCipher</span>&nbsp;<span class="op" id="3836027">=</span>&nbsp;<span class="ident" id="3836029">hs</span><span class="op" id="3836031">.</span><span class="ident" id="3836032">suite</span><span class="op" id="3836037">.</span><span class="ident" id="3836038">cipher</span><span class="op" id="3836044">(</span><span class="ident" id="3836045">serverKey</span><span class="op" id="3836054">,</span>&nbsp;<span class="ident" id="3836056">serverIV</span><span class="op" id="3836064">,</span>&nbsp;<span class="builtintype" id="3836066">false</span>&nbsp;<span class="comment" id="3836072">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3836093">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836097">serverHash</span>&nbsp;<span class="op" id="3836108">=</span>&nbsp;<span class="ident" id="3836110">hs</span><span class="op" id="3836112">.</span><span class="ident" id="3836113">suite</span><span class="op" id="3836118">.</span><span class="ident" id="3836119">mac</span><span class="op" id="3836122">(</span><span class="ident" id="3836123">c</span><span class="op" id="3836124">.</span><span class="ident" id="3836125">vers</span><span class="op" id="3836129">,</span>&nbsp;<span class="ident" id="3836131">serverMAC</span><span class="op" id="3836140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3836143">}</span>&nbsp;<span class="keyword" id="3836145">else</span>&nbsp;<span class="op" id="3836150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836154">clientCipher</span>&nbsp;<span class="op" id="3836167">=</span>&nbsp;<span class="ident" id="3836169">hs</span><span class="op" id="3836171">.</span><span class="ident" id="3836172">suite</span><span class="op" id="3836177">.</span><span class="ident" id="3836178">aead</span><span class="op" id="3836182">(</span><span class="ident" id="3836183">clientKey</span><span class="op" id="3836192">,</span>&nbsp;<span class="ident" id="3836194">clientIV</span><span class="op" id="3836202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836206">serverCipher</span>&nbsp;<span class="op" id="3836219">=</span>&nbsp;<span class="ident" id="3836221">hs</span><span class="op" id="3836223">.</span><span class="ident" id="3836224">suite</span><span class="op" id="3836229">.</span><span class="ident" id="3836230">aead</span><span class="op" id="3836234">(</span><span class="ident" id="3836235">serverKey</span><span class="op" id="3836244">,</span>&nbsp;<span class="ident" id="3836246">serverIV</span><span class="op" id="3836254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3836257">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836261">c</span><span class="op" id="3836262">.</span><span class="ident" id="3836263">in</span><span class="op" id="3836265">.</span><span class="ident" id="3836266">prepareCipherSpec</span><span class="op" id="3836283">(</span><span class="ident" id="3836284">c</span><span class="op" id="3836285">.</span><span class="ident" id="3836286">vers</span><span class="op" id="3836290">,</span>&nbsp;<span class="ident" id="3836292">clientCipher</span><span class="op" id="3836304">,</span>&nbsp;<span class="ident" id="3836306">clientHash</span><span class="op" id="3836316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836319">c</span><span class="op" id="3836320">.</span><span class="ident" id="3836321">out</span><span class="op" id="3836324">.</span><span class="ident" id="3836325">prepareCipherSpec</span><span class="op" id="3836342">(</span><span class="ident" id="3836343">c</span><span class="op" id="3836344">.</span><span class="ident" id="3836345">vers</span><span class="op" id="3836349">,</span>&nbsp;<span class="ident" id="3836351">serverCipher</span><span class="op" id="3836363">,</span>&nbsp;<span class="ident" id="3836365">serverHash</span><span class="op" id="3836375">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3836379">return</span>&nbsp;<span class="builtintype" id="3836386">nil</span><br>
<span class="lineno">500</span><span class="op" id="3836390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3836393">func</span>&nbsp;<span class="op" id="3836398">(</span><span class="ident" id="3836399">hs</span>&nbsp;<span class="op" id="3836402">*</span><span class="ident" id="3836403">serverHandshakeState</span><span class="op" id="3836423">)</span>&nbsp;<span class="ident" id="3836425">readFinished</span><span class="op" id="3836437">(</span><span class="ident" id="3836438">out</span>&nbsp;<span class="op" id="3836442">[</span><span class="op" id="3836443">]</span><span class="builtintype" id="3836444">byte</span><span class="op" id="3836448">)</span>&nbsp;<span class="builtintype" id="3836450">error</span>&nbsp;<span class="op" id="3836456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836459">c</span>&nbsp;<span class="op" id="3836461">:=</span>&nbsp;<span class="ident" id="3836464">hs</span><span class="op" id="3836466">.</span><span class="ident" id="3836467">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836471">c</span><span class="op" id="3836472">.</span><span class="ident" id="3836473">readRecord</span><span class="op" id="3836483">(</span><span class="ident" id="3836484">recordTypeChangeCipherSpec</span><span class="op" id="3836510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3836513">if</span>&nbsp;<span class="ident" id="3836516">err</span>&nbsp;<span class="op" id="3836520">:=</span>&nbsp;<span class="ident" id="3836523">c</span><span class="op" id="3836524">.</span><span class="ident" id="3836525">in</span><span class="op" id="3836527">.</span><span class="builtintype" id="3836528">error</span><span class="op" id="3836533">(</span><span class="op" id="3836534">)</span><span class="op" id="3836535">;</span>&nbsp;<span class="ident" id="3836537">err</span>&nbsp;<span class="op" id="3836541">!=</span>&nbsp;<span class="builtintype" id="3836544">nil</span>&nbsp;<span class="op" id="3836548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3836552">return</span>&nbsp;<span class="ident" id="3836559">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3836564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3836568">if</span>&nbsp;<span class="ident" id="3836571">hs</span><span class="op" id="3836573">.</span><span class="ident" id="3836574">hello</span><span class="op" id="3836579">.</span><span class="ident" id="3836580">nextProtoNeg</span>&nbsp;<span class="op" id="3836593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836597">msg</span><span class="op" id="3836600">,</span>&nbsp;<span class="ident" id="3836602">err</span>&nbsp;<span class="op" id="3836606">:=</span>&nbsp;<span class="ident" id="3836609">c</span><span class="op" id="3836610">.</span><span class="ident" id="3836611">readHandshake</span><span class="op" id="3836624">(</span><span class="op" id="3836625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3836629">if</span>&nbsp;<span class="ident" id="3836632">err</span>&nbsp;<span class="op" id="3836636">!=</span>&nbsp;<span class="builtintype" id="3836639">nil</span>&nbsp;<span class="op" id="3836643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3836648">return</span>&nbsp;<span class="ident" id="3836655">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3836661">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836665">nextProto</span><span class="op" id="3836674">,</span>&nbsp;<span class="ident" id="3836676">ok</span>&nbsp;<span class="op" id="3836679">:=</span>&nbsp;<span class="ident" id="3836682">msg</span><span class="op" id="3836685">.</span><span class="op" id="3836686">(</span><span class="op" id="3836687">*</span><span class="ident" id="3836688">nextProtoMsg</span><span class="op" id="3836700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3836704">if</span>&nbsp;<span class="op" id="3836707">!</span><span class="ident" id="3836708">ok</span>&nbsp;<span class="op" id="3836711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836716">c</span><span class="op" id="3836717">.</span><span class="ident" id="3836718">sendAlert</span><span class="op" id="3836727">(</span><span class="ident" id="3836728">alertUnexpectedMessage</span><span class="op" id="3836750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3836755">return</span>&nbsp;<span class="ident" id="3836762">unexpectedMessageError</span><span class="op" id="3836784">(</span><span class="ident" id="3836785">nextProto</span><span class="op" id="3836794">,</span>&nbsp;<span class="ident" id="3836796">msg</span><span class="op" id="3836799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3836803">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836807">hs</span><span class="op" id="3836809">.</span><span class="ident" id="3836810">finishedHash</span><span class="op" id="3836822">.</span><span class="ident" id="3836823">Write</span><span class="op" id="3836828">(</span><span class="ident" id="3836829">nextProto</span><span class="op" id="3836838">.</span><span class="ident" id="3836839">marshal</span><span class="op" id="3836846">(</span><span class="op" id="3836847">)</span><span class="op" id="3836848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836852">c</span><span class="op" id="3836853">.</span><span class="ident" id="3836854">clientProtocol</span>&nbsp;<span class="op" id="3836869">=</span>&nbsp;<span class="ident" id="3836871">nextProto</span><span class="op" id="3836880">.</span><span class="ident" id="3836881">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3836888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836892">msg</span><span class="op" id="3836895">,</span>&nbsp;<span class="ident" id="3836897">err</span>&nbsp;<span class="op" id="3836901">:=</span>&nbsp;<span class="ident" id="3836904">c</span><span class="op" id="3836905">.</span><span class="ident" id="3836906">readHandshake</span><span class="op" id="3836919">(</span><span class="op" id="3836920">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3836923">if</span>&nbsp;<span class="ident" id="3836926">err</span>&nbsp;<span class="op" id="3836930">!=</span>&nbsp;<span class="builtintype" id="3836933">nil</span>&nbsp;<span class="op" id="3836937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3836941">return</span>&nbsp;<span class="ident" id="3836948">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3836953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3836956">clientFinished</span><span class="op" id="3836970">,</span>&nbsp;<span class="ident" id="3836972">ok</span>&nbsp;<span class="op" id="3836975">:=</span>&nbsp;<span class="ident" id="3836978">msg</span><span class="op" id="3836981">.</span><span class="op" id="3836982">(</span><span class="op" id="3836983">*</span><span class="ident" id="3836984">finishedMsg</span><span class="op" id="3836995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3836998">if</span>&nbsp;<span class="op" id="3837001">!</span><span class="ident" id="3837002">ok</span>&nbsp;<span class="op" id="3837005">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837009">c</span><span class="op" id="3837010">.</span><span class="ident" id="3837011">sendAlert</span><span class="op" id="3837020">(</span><span class="ident" id="3837021">alertUnexpectedMessage</span><span class="op" id="3837043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3837047">return</span>&nbsp;<span class="ident" id="3837054">unexpectedMessageError</span><span class="op" id="3837076">(</span><span class="ident" id="3837077">clientFinished</span><span class="op" id="3837091">,</span>&nbsp;<span class="ident" id="3837093">msg</span><span class="op" id="3837096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3837099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837103">verify</span>&nbsp;<span class="op" id="3837110">:=</span>&nbsp;<span class="ident" id="3837113">hs</span><span class="op" id="3837115">.</span><span class="ident" id="3837116">finishedHash</span><span class="op" id="3837128">.</span><span class="ident" id="3837129">clientSum</span><span class="op" id="3837138">(</span><span class="ident" id="3837139">hs</span><span class="op" id="3837141">.</span><span class="ident" id="3837142">masterSecret</span><span class="op" id="3837154">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3837157">if</span>&nbsp;<span class="builtinfunc" id="3837160">len</span><span class="op" id="3837163">(</span><span class="ident" id="3837164">verify</span><span class="op" id="3837170">)</span>&nbsp;<span class="op" id="3837172">!=</span>&nbsp;<span class="builtinfunc" id="3837175">len</span><span class="op" id="3837178">(</span><span class="ident" id="3837179">clientFinished</span><span class="op" id="3837193">.</span><span class="ident" id="3837194">verifyData</span><span class="op" id="3837204">)</span>&nbsp;<span class="op" id="3837206">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837211">subtle</span><span class="op" id="3837217">.</span><span class="ident" id="3837218">ConstantTimeCompare</span><span class="op" id="3837237">(</span><span class="ident" id="3837238">verify</span><span class="op" id="3837244">,</span>&nbsp;<span class="ident" id="3837246">clientFinished</span><span class="op" id="3837260">.</span><span class="ident" id="3837261">verifyData</span><span class="op" id="3837271">)</span>&nbsp;<span class="op" id="3837273">!=</span>&nbsp;<span class="num" id="3837276">1</span>&nbsp;<span class="op" id="3837278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837282">c</span><span class="op" id="3837283">.</span><span class="ident" id="3837284">sendAlert</span><span class="op" id="3837293">(</span><span class="ident" id="3837294">alertHandshakeFailure</span><span class="op" id="3837315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3837319">return</span>&nbsp;<span class="ident" id="3837326">errors</span><span class="op" id="3837332">.</span><span class="ident" id="3837333">New</span><span class="op" id="3837336">(</span><span class="string" id="3837337">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="3837382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3837385">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837389">hs</span><span class="op" id="3837391">.</span><span class="ident" id="3837392">finishedHash</span><span class="op" id="3837404">.</span><span class="ident" id="3837405">Write</span><span class="op" id="3837410">(</span><span class="ident" id="3837411">clientFinished</span><span class="op" id="3837425">.</span><span class="ident" id="3837426">marshal</span><span class="op" id="3837433">(</span><span class="op" id="3837434">)</span><span class="op" id="3837435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3837438">copy</span><span class="op" id="3837442">(</span><span class="ident" id="3837443">out</span><span class="op" id="3837446">,</span>&nbsp;<span class="ident" id="3837448">verify</span><span class="op" id="3837454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3837457">return</span>&nbsp;<span class="builtintype" id="3837464">nil</span><br>
<span class="lineno"></span><span class="op" id="3837468">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="3837471">func</span>&nbsp;<span class="op" id="3837476">(</span><span class="ident" id="3837477">hs</span>&nbsp;<span class="op" id="3837480">*</span><span class="ident" id="3837481">serverHandshakeState</span><span class="op" id="3837501">)</span>&nbsp;<span class="ident" id="3837503">sendSessionTicket</span><span class="op" id="3837520">(</span><span class="op" id="3837521">)</span>&nbsp;<span class="builtintype" id="3837523">error</span>&nbsp;<span class="op" id="3837529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3837532">if</span>&nbsp;<span class="op" id="3837535">!</span><span class="ident" id="3837536">hs</span><span class="op" id="3837538">.</span><span class="ident" id="3837539">hello</span><span class="op" id="3837544">.</span><span class="ident" id="3837545">ticketSupported</span>&nbsp;<span class="op" id="3837561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3837565">return</span>&nbsp;<span class="builtintype" id="3837572">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3837577">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837581">c</span>&nbsp;<span class="op" id="3837583">:=</span>&nbsp;<span class="ident" id="3837586">hs</span><span class="op" id="3837588">.</span><span class="ident" id="3837589">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837592">m</span>&nbsp;<span class="op" id="3837594">:=</span>&nbsp;<span class="builtinfunc" id="3837597">new</span><span class="op" id="3837600">(</span><span class="ident" id="3837601">newSessionTicketMsg</span><span class="op" id="3837620">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3837624">var</span>&nbsp;<span class="ident" id="3837628">err</span>&nbsp;<span class="builtintype" id="3837632">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837639">state</span>&nbsp;<span class="op" id="3837645">:=</span>&nbsp;<span class="ident" id="3837648">sessionState</span><span class="op" id="3837660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837664">vers</span><span class="op" id="3837668">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837678">c</span><span class="op" id="3837679">.</span><span class="ident" id="3837680">vers</span><span class="op" id="3837684">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837688">cipherSuite</span><span class="op" id="3837699">:</span>&nbsp;&nbsp;<span class="ident" id="3837702">hs</span><span class="op" id="3837704">.</span><span class="ident" id="3837705">suite</span><span class="op" id="3837710">.</span><span class="ident" id="3837711">id</span><span class="op" id="3837713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837717">masterSecret</span><span class="op" id="3837729">:</span>&nbsp;<span class="ident" id="3837731">hs</span><span class="op" id="3837733">.</span><span class="ident" id="3837734">masterSecret</span><span class="op" id="3837746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837750">certificates</span><span class="op" id="3837762">:</span>&nbsp;<span class="ident" id="3837764">hs</span><span class="op" id="3837766">.</span><span class="ident" id="3837767">certsFromClient</span><span class="op" id="3837782">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3837785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837788">m</span><span class="op" id="3837789">.</span><span class="ident" id="3837790">ticket</span><span class="op" id="3837796">,</span>&nbsp;<span class="ident" id="3837798">err</span>&nbsp;<span class="op" id="3837802">=</span>&nbsp;<span class="ident" id="3837804">c</span><span class="op" id="3837805">.</span><span class="ident" id="3837806">encryptTicket</span><span class="op" id="3837819">(</span><span class="op" id="3837820">&amp;</span><span class="ident" id="3837821">state</span><span class="op" id="3837826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3837829">if</span>&nbsp;<span class="ident" id="3837832">err</span>&nbsp;<span class="op" id="3837836">!=</span>&nbsp;<span class="builtintype" id="3837839">nil</span>&nbsp;<span class="op" id="3837843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3837847">return</span>&nbsp;<span class="ident" id="3837854">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3837859">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837863">hs</span><span class="op" id="3837865">.</span><span class="ident" id="3837866">finishedHash</span><span class="op" id="3837878">.</span><span class="ident" id="3837879">Write</span><span class="op" id="3837884">(</span><span class="ident" id="3837885">m</span><span class="op" id="3837886">.</span><span class="ident" id="3837887">marshal</span><span class="op" id="3837894">(</span><span class="op" id="3837895">)</span><span class="op" id="3837896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3837899">c</span><span class="op" id="3837900">.</span><span class="ident" id="3837901">writeRecord</span><span class="op" id="3837912">(</span><span class="ident" id="3837913">recordTypeHandshake</span><span class="op" id="3837932">,</span>&nbsp;<span class="ident" id="3837934">m</span><span class="op" id="3837935">.</span><span class="ident" id="3837936">marshal</span><span class="op" id="3837943">(</span><span class="op" id="3837944">)</span><span class="op" id="3837945">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3837949">return</span>&nbsp;<span class="builtintype" id="3837956">nil</span><br>
<span class="lineno">570</span><span class="op" id="3837960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3837963">func</span>&nbsp;<span class="op" id="3837968">(</span><span class="ident" id="3837969">hs</span>&nbsp;<span class="op" id="3837972">*</span><span class="ident" id="3837973">serverHandshakeState</span><span class="op" id="3837993">)</span>&nbsp;<span class="ident" id="3837995">sendFinished</span><span class="op" id="3838007">(</span><span class="ident" id="3838008">out</span>&nbsp;<span class="op" id="3838012">[</span><span class="op" id="3838013">]</span><span class="builtintype" id="3838014">byte</span><span class="op" id="3838018">)</span>&nbsp;<span class="builtintype" id="3838020">error</span>&nbsp;<span class="op" id="3838026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838029">c</span>&nbsp;<span class="op" id="3838031">:=</span>&nbsp;<span class="ident" id="3838034">hs</span><span class="op" id="3838036">.</span><span class="ident" id="3838037">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838041">c</span><span class="op" id="3838042">.</span><span class="ident" id="3838043">writeRecord</span><span class="op" id="3838054">(</span><span class="ident" id="3838055">recordTypeChangeCipherSpec</span><span class="op" id="3838081">,</span>&nbsp;<span class="op" id="3838083">[</span><span class="op" id="3838084">]</span><span class="builtintype" id="3838085">byte</span><span class="op" id="3838089">{</span><span class="num" id="3838090">1</span><span class="op" id="3838091">}</span><span class="op" id="3838092">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838096">finished</span>&nbsp;<span class="op" id="3838105">:=</span>&nbsp;<span class="builtinfunc" id="3838108">new</span><span class="op" id="3838111">(</span><span class="ident" id="3838112">finishedMsg</span><span class="op" id="3838123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838126">finished</span><span class="op" id="3838134">.</span><span class="ident" id="3838135">verifyData</span>&nbsp;<span class="op" id="3838146">=</span>&nbsp;<span class="ident" id="3838148">hs</span><span class="op" id="3838150">.</span><span class="ident" id="3838151">finishedHash</span><span class="op" id="3838163">.</span><span class="ident" id="3838164">serverSum</span><span class="op" id="3838173">(</span><span class="ident" id="3838174">hs</span><span class="op" id="3838176">.</span><span class="ident" id="3838177">masterSecret</span><span class="op" id="3838189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838192">hs</span><span class="op" id="3838194">.</span><span class="ident" id="3838195">finishedHash</span><span class="op" id="3838207">.</span><span class="ident" id="3838208">Write</span><span class="op" id="3838213">(</span><span class="ident" id="3838214">finished</span><span class="op" id="3838222">.</span><span class="ident" id="3838223">marshal</span><span class="op" id="3838230">(</span><span class="op" id="3838231">)</span><span class="op" id="3838232">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838235">c</span><span class="op" id="3838236">.</span><span class="ident" id="3838237">writeRecord</span><span class="op" id="3838248">(</span><span class="ident" id="3838249">recordTypeHandshake</span><span class="op" id="3838268">,</span>&nbsp;<span class="ident" id="3838270">finished</span><span class="op" id="3838278">.</span><span class="ident" id="3838279">marshal</span><span class="op" id="3838286">(</span><span class="op" id="3838287">)</span><span class="op" id="3838288">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838292">c</span><span class="op" id="3838293">.</span><span class="ident" id="3838294">cipherSuite</span>&nbsp;<span class="op" id="3838306">=</span>&nbsp;<span class="ident" id="3838308">hs</span><span class="op" id="3838310">.</span><span class="ident" id="3838311">suite</span><span class="op" id="3838316">.</span><span class="ident" id="3838317">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3838321">copy</span><span class="op" id="3838325">(</span><span class="ident" id="3838326">out</span><span class="op" id="3838329">,</span>&nbsp;<span class="ident" id="3838331">finished</span><span class="op" id="3838339">.</span><span class="ident" id="3838340">verifyData</span><span class="op" id="3838350">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3838354">return</span>&nbsp;<span class="builtintype" id="3838361">nil</span><br>
<span class="lineno"></span><span class="op" id="3838365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3838368">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3838445">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="3838522">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3838565">func</span>&nbsp;<span class="op" id="3838570">(</span><span class="ident" id="3838571">hs</span>&nbsp;<span class="op" id="3838574">*</span><span class="ident" id="3838575">serverHandshakeState</span><span class="op" id="3838595">)</span>&nbsp;<span class="ident" id="3838597">processCertsFromClient</span><span class="op" id="3838619">(</span><span class="ident" id="3838620">certificates</span>&nbsp;<span class="op" id="3838633">[</span><span class="op" id="3838634">]</span><span class="op" id="3838635">[</span><span class="op" id="3838636">]</span><span class="builtintype" id="3838637">byte</span><span class="op" id="3838641">)</span>&nbsp;<span class="op" id="3838643">(</span><span class="ident" id="3838644">crypto</span><span class="op" id="3838650">.</span><span class="ident" id="3838651">PublicKey</span><span class="op" id="3838660">,</span>&nbsp;<span class="builtintype" id="3838662">error</span><span class="op" id="3838667">)</span>&nbsp;<span class="op" id="3838669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838672">c</span>&nbsp;<span class="op" id="3838674">:=</span>&nbsp;<span class="ident" id="3838677">hs</span><span class="op" id="3838679">.</span><span class="ident" id="3838680">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838684">hs</span><span class="op" id="3838686">.</span><span class="ident" id="3838687">certsFromClient</span>&nbsp;<span class="op" id="3838703">=</span>&nbsp;<span class="ident" id="3838705">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838719">certs</span>&nbsp;<span class="op" id="3838725">:=</span>&nbsp;<span class="builtinfunc" id="3838728">make</span><span class="op" id="3838732">(</span><span class="op" id="3838733">[</span><span class="op" id="3838734">]</span><span class="op" id="3838735">*</span><span class="ident" id="3838736">x509</span><span class="op" id="3838740">.</span><span class="ident" id="3838741">Certificate</span><span class="op" id="3838752">,</span>&nbsp;<span class="builtinfunc" id="3838754">len</span><span class="op" id="3838757">(</span><span class="ident" id="3838758">certificates</span><span class="op" id="3838770">)</span><span class="op" id="3838771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3838774">var</span>&nbsp;<span class="ident" id="3838778">err</span>&nbsp;<span class="builtintype" id="3838782">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3838789">for</span>&nbsp;<span class="ident" id="3838793">i</span><span class="op" id="3838794">,</span>&nbsp;<span class="ident" id="3838796">asn1Data</span>&nbsp;<span class="op" id="3838805">:=</span>&nbsp;<span class="keyword" id="3838808">range</span>&nbsp;<span class="ident" id="3838814">certificates</span>&nbsp;<span class="op" id="3838827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3838831">if</span>&nbsp;<span class="ident" id="3838834">certs</span><span class="op" id="3838839">[</span><span class="ident" id="3838840">i</span><span class="op" id="3838841">]</span><span class="op" id="3838842">,</span>&nbsp;<span class="ident" id="3838844">err</span>&nbsp;<span class="op" id="3838848">=</span>&nbsp;<span class="ident" id="3838850">x509</span><span class="op" id="3838854">.</span><span class="ident" id="3838855">ParseCertificate</span><span class="op" id="3838871">(</span><span class="ident" id="3838872">asn1Data</span><span class="op" id="3838880">)</span><span class="op" id="3838881">;</span>&nbsp;<span class="ident" id="3838883">err</span>&nbsp;<span class="op" id="3838887">!=</span>&nbsp;<span class="builtintype" id="3838890">nil</span>&nbsp;<span class="op" id="3838894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3838899">c</span><span class="op" id="3838900">.</span><span class="ident" id="3838901">sendAlert</span><span class="op" id="3838910">(</span><span class="ident" id="3838911">alertBadCertificate</span><span class="op" id="3838930">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3838935">return</span>&nbsp;<span class="builtintype" id="3838942">nil</span><span class="op" id="3838945">,</span>&nbsp;<span class="ident" id="3838947">errors</span><span class="op" id="3838953">.</span><span class="ident" id="3838954">New</span><span class="op" id="3838957">(</span><span class="string" id="3838958">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3839002">+</span>&nbsp;<span class="ident" id="3839004">err</span><span class="op" id="3839007">.</span><span class="ident" id="3839008">Error</span><span class="op" id="3839013">(</span><span class="op" id="3839014">)</span><span class="op" id="3839015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839026">if</span>&nbsp;<span class="ident" id="3839029">c</span><span class="op" id="3839030">.</span><span class="ident" id="3839031">config</span><span class="op" id="3839037">.</span><span class="ident" id="3839038">ClientAuth</span>&nbsp;<span class="op" id="3839049">&gt;=</span>&nbsp;<span class="ident" id="3839052">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="3839076">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3839079">len</span><span class="op" id="3839082">(</span><span class="ident" id="3839083">certs</span><span class="op" id="3839088">)</span>&nbsp;<span class="op" id="3839090">&gt;</span>&nbsp;<span class="num" id="3839092">0</span>&nbsp;<span class="op" id="3839094">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839098">opts</span>&nbsp;<span class="op" id="3839103">:=</span>&nbsp;<span class="ident" id="3839106">x509</span><span class="op" id="3839110">.</span><span class="ident" id="3839111">VerifyOptions</span><span class="op" id="3839124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839129">Roots</span><span class="op" id="3839134">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839144">c</span><span class="op" id="3839145">.</span><span class="ident" id="3839146">config</span><span class="op" id="3839152">.</span><span class="ident" id="3839153">ClientCAs</span><span class="op" id="3839162">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839167">CurrentTime</span><span class="op" id="3839178">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3839182">c</span><span class="op" id="3839183">.</span><span class="ident" id="3839184">config</span><span class="op" id="3839190">.</span><span class="ident" id="3839191">time</span><span class="op" id="3839195">(</span><span class="op" id="3839196">)</span><span class="op" id="3839197">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839202">Intermediates</span><span class="op" id="3839215">:</span>&nbsp;<span class="ident" id="3839217">x509</span><span class="op" id="3839221">.</span><span class="ident" id="3839222">NewCertPool</span><span class="op" id="3839233">(</span><span class="op" id="3839234">)</span><span class="op" id="3839235">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839240">KeyUsages</span><span class="op" id="3839249">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839255">[</span><span class="op" id="3839256">]</span><span class="ident" id="3839257">x509</span><span class="op" id="3839261">.</span><span class="ident" id="3839262">ExtKeyUsage</span><span class="op" id="3839273">{</span><span class="ident" id="3839274">x509</span><span class="op" id="3839278">.</span><span class="ident" id="3839279">ExtKeyUsageClientAuth</span><span class="op" id="3839300">}</span><span class="op" id="3839301">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839310">for</span>&nbsp;<span class="ident" id="3839314">_</span><span class="op" id="3839315">,</span>&nbsp;<span class="ident" id="3839317">cert</span>&nbsp;<span class="op" id="3839322">:=</span>&nbsp;<span class="keyword" id="3839325">range</span>&nbsp;<span class="ident" id="3839331">certs</span><span class="op" id="3839336">[</span><span class="num" id="3839337">1</span><span class="op" id="3839338">:</span><span class="op" id="3839339">]</span>&nbsp;<span class="op" id="3839341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839346">opts</span><span class="op" id="3839350">.</span><span class="ident" id="3839351">Intermediates</span><span class="op" id="3839364">.</span><span class="ident" id="3839365">AddCert</span><span class="op" id="3839372">(</span><span class="ident" id="3839373">cert</span><span class="op" id="3839377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839381">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839386">chains</span><span class="op" id="3839392">,</span>&nbsp;<span class="ident" id="3839394">err</span>&nbsp;<span class="op" id="3839398">:=</span>&nbsp;<span class="ident" id="3839401">certs</span><span class="op" id="3839406">[</span><span class="num" id="3839407">0</span><span class="op" id="3839408">]</span><span class="op" id="3839409">.</span><span class="ident" id="3839410">Verify</span><span class="op" id="3839416">(</span><span class="ident" id="3839417">opts</span><span class="op" id="3839421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839425">if</span>&nbsp;<span class="ident" id="3839428">err</span>&nbsp;<span class="op" id="3839432">!=</span>&nbsp;<span class="builtintype" id="3839435">nil</span>&nbsp;<span class="op" id="3839439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839444">c</span><span class="op" id="3839445">.</span><span class="ident" id="3839446">sendAlert</span><span class="op" id="3839455">(</span><span class="ident" id="3839456">alertBadCertificate</span><span class="op" id="3839475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839480">return</span>&nbsp;<span class="builtintype" id="3839487">nil</span><span class="op" id="3839490">,</span>&nbsp;<span class="ident" id="3839492">errors</span><span class="op" id="3839498">.</span><span class="ident" id="3839499">New</span><span class="op" id="3839502">(</span><span class="string" id="3839503">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3839550">+</span>&nbsp;<span class="ident" id="3839552">err</span><span class="op" id="3839555">.</span><span class="ident" id="3839556">Error</span><span class="op" id="3839561">(</span><span class="op" id="3839562">)</span><span class="op" id="3839563">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839572">ok</span>&nbsp;<span class="op" id="3839575">:=</span>&nbsp;<span class="builtintype" id="3839578">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839586">for</span>&nbsp;<span class="ident" id="3839590">_</span><span class="op" id="3839591">,</span>&nbsp;<span class="ident" id="3839593">ku</span>&nbsp;<span class="op" id="3839596">:=</span>&nbsp;<span class="keyword" id="3839599">range</span>&nbsp;<span class="ident" id="3839605">certs</span><span class="op" id="3839610">[</span><span class="num" id="3839611">0</span><span class="op" id="3839612">]</span><span class="op" id="3839613">.</span><span class="ident" id="3839614">ExtKeyUsage</span>&nbsp;<span class="op" id="3839626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839631">if</span>&nbsp;<span class="ident" id="3839634">ku</span>&nbsp;<span class="op" id="3839637">==</span>&nbsp;<span class="ident" id="3839640">x509</span><span class="op" id="3839644">.</span><span class="ident" id="3839645">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="3839667">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839673">ok</span>&nbsp;<span class="op" id="3839676">=</span>&nbsp;<span class="builtintype" id="3839678">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839687">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839704">if</span>&nbsp;<span class="op" id="3839707">!</span><span class="ident" id="3839708">ok</span>&nbsp;<span class="op" id="3839711">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839716">c</span><span class="op" id="3839717">.</span><span class="ident" id="3839718">sendAlert</span><span class="op" id="3839727">(</span><span class="ident" id="3839728">alertHandshakeFailure</span><span class="op" id="3839749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839754">return</span>&nbsp;<span class="builtintype" id="3839761">nil</span><span class="op" id="3839764">,</span>&nbsp;<span class="ident" id="3839766">errors</span><span class="op" id="3839772">.</span><span class="ident" id="3839773">New</span><span class="op" id="3839776">(</span><span class="string" id="3839777">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="3839880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3839889">c</span><span class="op" id="3839890">.</span><span class="ident" id="3839891">verifiedChains</span>&nbsp;<span class="op" id="3839906">=</span>&nbsp;<span class="ident" id="3839908">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839920">if</span>&nbsp;<span class="builtinfunc" id="3839923">len</span><span class="op" id="3839926">(</span><span class="ident" id="3839927">certs</span><span class="op" id="3839932">)</span>&nbsp;<span class="op" id="3839934">&gt;</span>&nbsp;<span class="num" id="3839936">0</span>&nbsp;<span class="op" id="3839938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839942">var</span>&nbsp;<span class="ident" id="3839946">pub</span>&nbsp;<span class="ident" id="3839950">crypto</span><span class="op" id="3839956">.</span><span class="ident" id="3839957">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3839969">switch</span>&nbsp;<span class="ident" id="3839976">key</span>&nbsp;<span class="op" id="3839980">:=</span>&nbsp;<span class="ident" id="3839983">certs</span><span class="op" id="3839988">[</span><span class="num" id="3839989">0</span><span class="op" id="3839990">]</span><span class="op" id="3839991">.</span><span class="ident" id="3839992">PublicKey</span><span class="op" id="3840001">.</span><span class="op" id="3840002">(</span><span class="keyword" id="3840003">type</span><span class="op" id="3840007">)</span>&nbsp;<span class="op" id="3840009">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840013">case</span>&nbsp;<span class="op" id="3840018">*</span><span class="ident" id="3840019">ecdsa</span><span class="op" id="3840024">.</span><span class="ident" id="3840025">PublicKey</span><span class="op" id="3840034">,</span>&nbsp;<span class="op" id="3840036">*</span><span class="ident" id="3840037">rsa</span><span class="op" id="3840040">.</span><span class="ident" id="3840041">PublicKey</span><span class="op" id="3840050">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3840055">pub</span>&nbsp;<span class="op" id="3840059">=</span>&nbsp;<span class="ident" id="3840061">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840067">default</span><span class="op" id="3840074">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3840079">c</span><span class="op" id="3840080">.</span><span class="ident" id="3840081">sendAlert</span><span class="op" id="3840090">(</span><span class="ident" id="3840091">alertUnsupportedCertificate</span><span class="op" id="3840118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840123">return</span>&nbsp;<span class="builtintype" id="3840130">nil</span><span class="op" id="3840133">,</span>&nbsp;<span class="ident" id="3840135">fmt</span><span class="op" id="3840138">.</span><span class="ident" id="3840139">Errorf</span><span class="op" id="3840145">(</span><span class="string" id="3840146">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="3840219">,</span>&nbsp;<span class="ident" id="3840221">certs</span><span class="op" id="3840226">[</span><span class="num" id="3840227">0</span><span class="op" id="3840228">]</span><span class="op" id="3840229">.</span><span class="ident" id="3840230">PublicKey</span><span class="op" id="3840239">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3840243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3840247">c</span><span class="op" id="3840248">.</span><span class="ident" id="3840249">peerCertificates</span>&nbsp;<span class="op" id="3840266">=</span>&nbsp;<span class="ident" id="3840268">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840276">return</span>&nbsp;<span class="ident" id="3840283">pub</span><span class="op" id="3840286">,</span>&nbsp;<span class="builtintype" id="3840288">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3840293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840297">return</span>&nbsp;<span class="builtintype" id="3840304">nil</span><span class="op" id="3840307">,</span>&nbsp;<span class="builtintype" id="3840309">nil</span><br>
<span class="lineno"></span><span class="op" id="3840313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3840316">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="3840395">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="3840420">func</span>&nbsp;<span class="op" id="3840425">(</span><span class="ident" id="3840426">c</span>&nbsp;<span class="op" id="3840428">*</span><span class="ident" id="3840429">Conn</span><span class="op" id="3840433">)</span>&nbsp;<span class="ident" id="3840435">tryCipherSuite</span><span class="op" id="3840449">(</span><span class="ident" id="3840450">id</span>&nbsp;<span class="builtintype" id="3840453">uint16</span><span class="op" id="3840459">,</span>&nbsp;<span class="ident" id="3840461">supportedCipherSuites</span>&nbsp;<span class="op" id="3840483">[</span><span class="op" id="3840484">]</span><span class="builtintype" id="3840485">uint16</span><span class="op" id="3840491">,</span>&nbsp;<span class="ident" id="3840493">version</span>&nbsp;<span class="builtintype" id="3840501">uint16</span><span class="op" id="3840507">,</span>&nbsp;<span class="ident" id="3840509">ellipticOk</span><span class="op" id="3840519">,</span>&nbsp;<span class="ident" id="3840521">ecdsaOk</span>&nbsp;<span class="builtintype" id="3840529">bool</span><span class="op" id="3840533">)</span>&nbsp;<span class="op" id="3840535">*</span><span class="ident" id="3840536">cipherSuite</span>&nbsp;<span class="op" id="3840548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840551">for</span>&nbsp;<span class="ident" id="3840555">_</span><span class="op" id="3840556">,</span>&nbsp;<span class="ident" id="3840558">supported</span>&nbsp;<span class="op" id="3840568">:=</span>&nbsp;<span class="keyword" id="3840571">range</span>&nbsp;<span class="ident" id="3840577">supportedCipherSuites</span>&nbsp;<span class="op" id="3840599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840603">if</span>&nbsp;<span class="ident" id="3840606">id</span>&nbsp;<span class="op" id="3840609">==</span>&nbsp;<span class="ident" id="3840612">supported</span>&nbsp;<span class="op" id="3840622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840627">var</span>&nbsp;<span class="ident" id="3840631">candidate</span>&nbsp;<span class="op" id="3840641">*</span><span class="ident" id="3840642">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840658">for</span>&nbsp;<span class="ident" id="3840662">_</span><span class="op" id="3840663">,</span>&nbsp;<span class="ident" id="3840665">s</span>&nbsp;<span class="op" id="3840667">:=</span>&nbsp;<span class="keyword" id="3840670">range</span>&nbsp;<span class="ident" id="3840676">cipherSuites</span>&nbsp;<span class="op" id="3840689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840695">if</span>&nbsp;<span class="ident" id="3840698">s</span><span class="op" id="3840699">.</span><span class="ident" id="3840700">id</span>&nbsp;<span class="op" id="3840703">==</span>&nbsp;<span class="ident" id="3840706">id</span>&nbsp;<span class="op" id="3840709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3840716">candidate</span>&nbsp;<span class="op" id="3840726">=</span>&nbsp;<span class="ident" id="3840728">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840735">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3840745">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3840750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840755">if</span>&nbsp;<span class="ident" id="3840758">candidate</span>&nbsp;<span class="op" id="3840768">==</span>&nbsp;<span class="builtintype" id="3840771">nil</span>&nbsp;<span class="op" id="3840775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840781">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3840793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3840798">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3840846">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840877">if</span>&nbsp;<span class="op" id="3840880">(</span><span class="ident" id="3840881">candidate</span><span class="op" id="3840890">.</span><span class="ident" id="3840891">flags</span><span class="op" id="3840896">&amp;</span><span class="ident" id="3840897">suiteECDHE</span>&nbsp;<span class="op" id="3840908">!=</span>&nbsp;<span class="num" id="3840911">0</span><span class="op" id="3840912">)</span>&nbsp;<span class="op" id="3840914">&amp;&amp;</span>&nbsp;<span class="op" id="3840917">!</span><span class="ident" id="3840918">ellipticOk</span>&nbsp;<span class="op" id="3840929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840935">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3840947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3840952">if</span>&nbsp;<span class="op" id="3840955">(</span><span class="ident" id="3840956">candidate</span><span class="op" id="3840965">.</span><span class="ident" id="3840966">flags</span><span class="op" id="3840971">&amp;</span><span class="ident" id="3840972">suiteECDSA</span>&nbsp;<span class="op" id="3840983">!=</span>&nbsp;<span class="num" id="3840986">0</span><span class="op" id="3840987">)</span>&nbsp;<span class="op" id="3840989">!=</span>&nbsp;<span class="ident" id="3840992">ecdsaOk</span>&nbsp;<span class="op" id="3841000">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3841006">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3841018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3841023">if</span>&nbsp;<span class="ident" id="3841026">version</span>&nbsp;<span class="op" id="3841034">&lt;</span>&nbsp;<span class="ident" id="3841036">VersionTLS12</span>&nbsp;<span class="op" id="3841049">&amp;&amp;</span>&nbsp;<span class="ident" id="3841052">candidate</span><span class="op" id="3841061">.</span><span class="ident" id="3841062">flags</span><span class="op" id="3841067">&amp;</span><span class="ident" id="3841068">suiteTLS12</span>&nbsp;<span class="op" id="3841079">!=</span>&nbsp;<span class="num" id="3841082">0</span>&nbsp;<span class="op" id="3841084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3841090">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3841102">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3841107">return</span>&nbsp;<span class="ident" id="3841114">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3841126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3841129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3841133">return</span>&nbsp;<span class="builtintype" id="3841140">nil</span><br>
<span class="lineno">685</span><span class="op" id="3841144">}</span>
</div>
</body>
</html>
