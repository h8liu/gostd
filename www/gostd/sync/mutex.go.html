<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html" class="current">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1389945">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1390000">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1390054">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1390105">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1390178">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1390258">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1390333">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1390380">//</span><br>
<span class="lineno">10</span><span class="comment" id="1390383">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1390460">package</span>&nbsp;<span class="ident" id="1390468">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1390474">import</span>&nbsp;<span class="op" id="1390481">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1390484">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1390499">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1390508">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1390511">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1390550">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1390605">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1390657">type</span>&nbsp;<span class="ident" id="1390662">Mutex</span>&nbsp;<span class="keyword" id="1390668">struct</span>&nbsp;<span class="op" id="1390675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1390678">state</span>&nbsp;<span class="builtintype" id="1390684">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1390691">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1390697">uint32</span><br>
<span class="lineno"></span><span class="op" id="1390704">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1390707">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1390773">type</span>&nbsp;<span class="ident" id="1390778">Locker</span>&nbsp;<span class="keyword" id="1390785">interface</span>&nbsp;<span class="op" id="1390795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1390798">Lock</span><span class="op" id="1390802">(</span><span class="op" id="1390803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1390806">Unlock</span><span class="op" id="1390812">(</span><span class="op" id="1390813">)</span><br>
<span class="lineno">30</span><span class="op" id="1390815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1390818">const</span>&nbsp;<span class="op" id="1390824">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1390827">mutexLocked</span>&nbsp;<span class="op" id="1390839">=</span>&nbsp;<span class="num" id="1390841">1</span>&nbsp;<span class="op" id="1390843">&lt;&lt;</span>&nbsp;<span class="ident" id="1390846">iota</span>&nbsp;<span class="comment" id="1390851">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1390871">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1390883">mutexWaiterShift</span>&nbsp;<span class="op" id="1390900">=</span>&nbsp;<span class="ident" id="1390902">iota</span><br>
<span class="lineno"></span><span class="op" id="1390907">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1390910">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1390927">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1390983">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1391023">func</span>&nbsp;<span class="op" id="1391028">(</span><span class="ident" id="1391029">m</span>&nbsp;<span class="op" id="1391031">*</span><span class="ident" id="1391032">Mutex</span><span class="op" id="1391037">)</span>&nbsp;<span class="ident" id="1391039">Lock</span><span class="op" id="1391043">(</span><span class="op" id="1391044">)</span>&nbsp;<span class="op" id="1391046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1391049">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1391085">if</span>&nbsp;<span class="ident" id="1391088">atomic</span><span class="op" id="1391094">.</span><span class="ident" id="1391095">CompareAndSwapInt32</span><span class="op" id="1391114">(</span><span class="op" id="1391115">&amp;</span><span class="ident" id="1391116">m</span><span class="op" id="1391117">.</span><span class="ident" id="1391118">state</span><span class="op" id="1391123">,</span>&nbsp;<span class="num" id="1391125">0</span><span class="op" id="1391126">,</span>&nbsp;<span class="ident" id="1391128">mutexLocked</span><span class="op" id="1391139">)</span>&nbsp;<span class="op" id="1391141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1391145">if</span>&nbsp;<span class="ident" id="1391148">raceenabled</span>&nbsp;<span class="op" id="1391160">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1391165">raceAcquire</span><span class="op" id="1391176">(</span><span class="ident" id="1391177">unsafe</span><span class="op" id="1391183">.</span><span class="ident" id="1391184">Pointer</span><span class="op" id="1391191">(</span><span class="ident" id="1391192">m</span><span class="op" id="1391193">)</span><span class="op" id="1391194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1391198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1391202">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1391210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1391214">awoke</span>&nbsp;<span class="op" id="1391220">:=</span>&nbsp;<span class="builtintype" id="1391223">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1391230">for</span>&nbsp;<span class="op" id="1391234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1391238">old</span>&nbsp;<span class="op" id="1391242">:=</span>&nbsp;<span class="ident" id="1391245">m</span><span class="op" id="1391246">.</span><span class="ident" id="1391247">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1391255">new</span>&nbsp;<span class="op" id="1391259">:=</span>&nbsp;<span class="ident" id="1391262">old</span>&nbsp;<span class="op" id="1391266">|</span>&nbsp;<span class="ident" id="1391268">mutexLocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1391282">if</span>&nbsp;<span class="ident" id="1391285">old</span><span class="op" id="1391288">&amp;</span><span class="ident" id="1391289">mutexLocked</span>&nbsp;<span class="op" id="1391301">!=</span>&nbsp;<span class="num" id="1391304">0</span>&nbsp;<span class="op" id="1391306">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1391311">new</span>&nbsp;<span class="op" id="1391315">=</span>&nbsp;<span class="ident" id="1391317">old</span>&nbsp;<span class="op" id="1391321">+</span>&nbsp;<span class="num" id="1391323">1</span><span class="op" id="1391324">&lt;&lt;</span><span class="ident" id="1391326">mutexWaiterShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1391345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1391349">if</span>&nbsp;<span class="ident" id="1391352">awoke</span>&nbsp;<span class="op" id="1391358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1391363">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1391410">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1391461">new</span>&nbsp;<span class="op" id="1391465">&amp;^=</span>&nbsp;<span class="ident" id="1391469">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1391482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1391486">if</span>&nbsp;<span class="ident" id="1391489">atomic</span><span class="op" id="1391495">.</span><span class="ident" id="1391496">CompareAndSwapInt32</span><span class="op" id="1391515">(</span><span class="op" id="1391516">&amp;</span><span class="ident" id="1391517">m</span><span class="op" id="1391518">.</span><span class="ident" id="1391519">state</span><span class="op" id="1391524">,</span>&nbsp;<span class="ident" id="1391526">old</span><span class="op" id="1391529">,</span>&nbsp;<span class="builtinfunc" id="1391531">new</span><span class="op" id="1391534">)</span>&nbsp;<span class="op" id="1391536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1391541">if</span>&nbsp;<span class="ident" id="1391544">old</span><span class="op" id="1391547">&amp;</span><span class="ident" id="1391548">mutexLocked</span>&nbsp;<span class="op" id="1391560">==</span>&nbsp;<span class="num" id="1391563">0</span>&nbsp;<span class="op" id="1391565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1391571">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1391580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1391585">runtime_Semacquire</span><span class="op" id="1391603">(</span><span class="op" id="1391604">&amp;</span><span class="ident" id="1391605">m</span><span class="op" id="1391606">.</span><span class="ident" id="1391607">sema</span><span class="op" id="1391611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1391616">awoke</span>&nbsp;<span class="op" id="1391622">=</span>&nbsp;<span class="builtintype" id="1391624">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1391631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1391634">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1391638">if</span>&nbsp;<span class="ident" id="1391641">raceenabled</span>&nbsp;<span class="op" id="1391653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1391657">raceAcquire</span><span class="op" id="1391668">(</span><span class="ident" id="1391669">unsafe</span><span class="op" id="1391675">.</span><span class="ident" id="1391676">Pointer</span><span class="op" id="1391683">(</span><span class="ident" id="1391684">m</span><span class="op" id="1391685">)</span><span class="op" id="1391686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1391689">}</span><br>
<span class="lineno"></span><span class="op" id="1391691">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1391694">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1391715">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1391780">//</span><br>
<span class="lineno"></span><span class="comment" id="1391783">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1391848">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1391908">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1391955">func</span>&nbsp;<span class="op" id="1391960">(</span><span class="ident" id="1391961">m</span>&nbsp;<span class="op" id="1391963">*</span><span class="ident" id="1391964">Mutex</span><span class="op" id="1391969">)</span>&nbsp;<span class="ident" id="1391971">Unlock</span><span class="op" id="1391977">(</span><span class="op" id="1391978">)</span>&nbsp;<span class="op" id="1391980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1391983">if</span>&nbsp;<span class="ident" id="1391986">raceenabled</span>&nbsp;<span class="op" id="1391998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1392002">_</span>&nbsp;<span class="op" id="1392004">=</span>&nbsp;<span class="ident" id="1392006">m</span><span class="op" id="1392007">.</span><span class="ident" id="1392008">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1392016">raceRelease</span><span class="op" id="1392027">(</span><span class="ident" id="1392028">unsafe</span><span class="op" id="1392034">.</span><span class="ident" id="1392035">Pointer</span><span class="op" id="1392042">(</span><span class="ident" id="1392043">m</span><span class="op" id="1392044">)</span><span class="op" id="1392045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1392048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1392052">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1392082">new</span>&nbsp;<span class="op" id="1392086">:=</span>&nbsp;<span class="ident" id="1392089">atomic</span><span class="op" id="1392095">.</span><span class="ident" id="1392096">AddInt32</span><span class="op" id="1392104">(</span><span class="op" id="1392105">&amp;</span><span class="ident" id="1392106">m</span><span class="op" id="1392107">.</span><span class="ident" id="1392108">state</span><span class="op" id="1392113">,</span>&nbsp;<span class="op" id="1392115">-</span><span class="ident" id="1392116">mutexLocked</span><span class="op" id="1392127">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1392130">if</span>&nbsp;<span class="op" id="1392133">(</span><span class="builtinfunc" id="1392134">new</span><span class="op" id="1392137">+</span><span class="ident" id="1392138">mutexLocked</span><span class="op" id="1392149">)</span><span class="op" id="1392150">&amp;</span><span class="ident" id="1392151">mutexLocked</span>&nbsp;<span class="op" id="1392163">==</span>&nbsp;<span class="num" id="1392166">0</span>&nbsp;<span class="op" id="1392168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1392172">panic</span><span class="op" id="1392177">(</span><span class="string" id="1392178">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1392210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1392213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1392217">old</span>&nbsp;<span class="op" id="1392221">:=</span>&nbsp;<span class="builtinfunc" id="1392224">new</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1392229">for</span>&nbsp;<span class="op" id="1392233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1392237">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1392293">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1392354">if</span>&nbsp;<span class="ident" id="1392357">old</span><span class="op" id="1392360">&gt;&gt;</span><span class="ident" id="1392362">mutexWaiterShift</span>&nbsp;<span class="op" id="1392379">==</span>&nbsp;<span class="num" id="1392382">0</span>&nbsp;<span class="op" id="1392384">||</span>&nbsp;<span class="ident" id="1392387">old</span><span class="op" id="1392390">&amp;</span><span class="op" id="1392391">(</span><span class="ident" id="1392392">mutexLocked</span><span class="op" id="1392403">|</span><span class="ident" id="1392404">mutexWoken</span><span class="op" id="1392414">)</span>&nbsp;<span class="op" id="1392416">!=</span>&nbsp;<span class="num" id="1392419">0</span>&nbsp;<span class="op" id="1392421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1392426">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1392435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1392439">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1392476">new</span>&nbsp;<span class="op" id="1392480">=</span>&nbsp;<span class="op" id="1392482">(</span><span class="ident" id="1392483">old</span>&nbsp;<span class="op" id="1392487">-</span>&nbsp;<span class="num" id="1392489">1</span><span class="op" id="1392490">&lt;&lt;</span><span class="ident" id="1392492">mutexWaiterShift</span><span class="op" id="1392508">)</span>&nbsp;<span class="op" id="1392510">|</span>&nbsp;<span class="ident" id="1392512">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1392525">if</span>&nbsp;<span class="ident" id="1392528">atomic</span><span class="op" id="1392534">.</span><span class="ident" id="1392535">CompareAndSwapInt32</span><span class="op" id="1392554">(</span><span class="op" id="1392555">&amp;</span><span class="ident" id="1392556">m</span><span class="op" id="1392557">.</span><span class="ident" id="1392558">state</span><span class="op" id="1392563">,</span>&nbsp;<span class="ident" id="1392565">old</span><span class="op" id="1392568">,</span>&nbsp;<span class="builtinfunc" id="1392570">new</span><span class="op" id="1392573">)</span>&nbsp;<span class="op" id="1392575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1392580">runtime_Semrelease</span><span class="op" id="1392598">(</span><span class="op" id="1392599">&amp;</span><span class="ident" id="1392600">m</span><span class="op" id="1392601">.</span><span class="ident" id="1392602">sema</span><span class="op" id="1392606">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1392611">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1392620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1392624">old</span>&nbsp;<span class="op" id="1392628">=</span>&nbsp;<span class="ident" id="1392630">m</span><span class="op" id="1392631">.</span><span class="ident" id="1392632">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1392639">}</span><br>
<span class="lineno"></span><span class="op" id="1392641">}</span>
</div>
</body>
</html>
