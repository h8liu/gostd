<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6304479">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6304534">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6304588">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6304639">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="6304699">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6304712">package</span>&nbsp;<span class="ident" id="6304720">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6304725">import</span>&nbsp;<span class="op" id="6304732">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304735">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304744">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304758">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304768">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304775">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304781">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304794">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304801">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304813">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304824">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304830">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6304841">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="6304851">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="6304854">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="6304920">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="6304982">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="6305023">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="6305083">func</span>&nbsp;<span class="ident" id="6305088">Request</span><span class="op" id="6305095">(</span><span class="op" id="6305096">)</span>&nbsp;<span class="op" id="6305098">(</span><span class="op" id="6305099">*</span><span class="ident" id="6305100">http</span><span class="op" id="6305104">.</span><span class="ident" id="6305105">Request</span><span class="op" id="6305112">,</span>&nbsp;<span class="builtintype" id="6305114">error</span><span class="op" id="6305119">)</span>&nbsp;<span class="op" id="6305121">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305124">r</span><span class="op" id="6305125">,</span>&nbsp;<span class="ident" id="6305127">err</span>&nbsp;<span class="op" id="6305131">:=</span>&nbsp;<span class="ident" id="6305134">RequestFromMap</span><span class="op" id="6305148">(</span><span class="ident" id="6305149">envMap</span><span class="op" id="6305155">(</span><span class="ident" id="6305156">os</span><span class="op" id="6305158">.</span><span class="ident" id="6305159">Environ</span><span class="op" id="6305166">(</span><span class="op" id="6305167">)</span><span class="op" id="6305168">)</span><span class="op" id="6305169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305172">if</span>&nbsp;<span class="ident" id="6305175">err</span>&nbsp;<span class="op" id="6305179">!=</span>&nbsp;<span class="ident" id="6305182">nil</span>&nbsp;<span class="op" id="6305186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305190">return</span>&nbsp;<span class="ident" id="6305197">nil</span><span class="op" id="6305200">,</span>&nbsp;<span class="ident" id="6305202">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305210">if</span>&nbsp;<span class="ident" id="6305213">r</span><span class="op" id="6305214">.</span><span class="ident" id="6305215">ContentLength</span>&nbsp;<span class="op" id="6305229">&gt;</span>&nbsp;<span class="num" id="6305231">0</span>&nbsp;<span class="op" id="6305233">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305237">r</span><span class="op" id="6305238">.</span><span class="ident" id="6305239">Body</span>&nbsp;<span class="op" id="6305244">=</span>&nbsp;<span class="ident" id="6305246">ioutil</span><span class="op" id="6305252">.</span><span class="ident" id="6305253">NopCloser</span><span class="op" id="6305262">(</span><span class="ident" id="6305263">io</span><span class="op" id="6305265">.</span><span class="ident" id="6305266">LimitReader</span><span class="op" id="6305277">(</span><span class="ident" id="6305278">os</span><span class="op" id="6305280">.</span><span class="ident" id="6305281">Stdin</span><span class="op" id="6305286">,</span>&nbsp;<span class="ident" id="6305288">r</span><span class="op" id="6305289">.</span><span class="ident" id="6305290">ContentLength</span><span class="op" id="6305303">)</span><span class="op" id="6305304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305310">return</span>&nbsp;<span class="ident" id="6305317">r</span><span class="op" id="6305318">,</span>&nbsp;<span class="ident" id="6305320">nil</span><br>
<span class="lineno"></span><span class="op" id="6305324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6305327">func</span>&nbsp;<span class="ident" id="6305332">envMap</span><span class="op" id="6305338">(</span><span class="ident" id="6305339">env</span>&nbsp;<span class="op" id="6305343">[</span><span class="op" id="6305344">]</span><span class="builtintype" id="6305345">string</span><span class="op" id="6305351">)</span>&nbsp;<span class="keyword" id="6305353">map</span><span class="op" id="6305356">[</span><span class="builtintype" id="6305357">string</span><span class="op" id="6305363">]</span><span class="builtintype" id="6305364">string</span>&nbsp;<span class="op" id="6305371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305374">m</span>&nbsp;<span class="op" id="6305376">:=</span>&nbsp;<span class="builtinfunc" id="6305379">make</span><span class="op" id="6305383">(</span><span class="keyword" id="6305384">map</span><span class="op" id="6305387">[</span><span class="builtintype" id="6305388">string</span><span class="op" id="6305394">]</span><span class="builtintype" id="6305395">string</span><span class="op" id="6305401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305404">for</span>&nbsp;<span class="ident" id="6305408">_</span><span class="op" id="6305409">,</span>&nbsp;<span class="ident" id="6305411">kv</span>&nbsp;<span class="op" id="6305414">:=</span>&nbsp;<span class="keyword" id="6305417">range</span>&nbsp;<span class="ident" id="6305423">env</span>&nbsp;<span class="op" id="6305427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305431">if</span>&nbsp;<span class="ident" id="6305434">idx</span>&nbsp;<span class="op" id="6305438">:=</span>&nbsp;<span class="ident" id="6305441">strings</span><span class="op" id="6305448">.</span><span class="ident" id="6305449">Index</span><span class="op" id="6305454">(</span><span class="ident" id="6305455">kv</span><span class="op" id="6305457">,</span>&nbsp;<span class="string" id="6305459">&#34;=&#34;</span><span class="op" id="6305462">)</span><span class="op" id="6305463">;</span>&nbsp;<span class="ident" id="6305465">idx</span>&nbsp;<span class="op" id="6305469">!=</span>&nbsp;<span class="op" id="6305472">-</span><span class="num" id="6305473">1</span>&nbsp;<span class="op" id="6305475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305480">m</span><span class="op" id="6305481">[</span><span class="ident" id="6305482">kv</span><span class="op" id="6305484">[</span><span class="op" id="6305485">:</span><span class="ident" id="6305486">idx</span><span class="op" id="6305489">]</span><span class="op" id="6305490">]</span>&nbsp;<span class="op" id="6305492">=</span>&nbsp;<span class="ident" id="6305494">kv</span><span class="op" id="6305496">[</span><span class="ident" id="6305497">idx</span><span class="op" id="6305500">+</span><span class="num" id="6305501">1</span><span class="op" id="6305502">:</span><span class="op" id="6305503">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305513">return</span>&nbsp;<span class="ident" id="6305520">m</span><br>
<span class="lineno"></span><span class="op" id="6305522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="6305525">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="6305587">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="6305642">func</span>&nbsp;<span class="ident" id="6305647">RequestFromMap</span><span class="op" id="6305661">(</span><span class="ident" id="6305662">params</span>&nbsp;<span class="keyword" id="6305669">map</span><span class="op" id="6305672">[</span><span class="builtintype" id="6305673">string</span><span class="op" id="6305679">]</span><span class="builtintype" id="6305680">string</span><span class="op" id="6305686">)</span>&nbsp;<span class="op" id="6305688">(</span><span class="op" id="6305689">*</span><span class="ident" id="6305690">http</span><span class="op" id="6305694">.</span><span class="ident" id="6305695">Request</span><span class="op" id="6305702">,</span>&nbsp;<span class="builtintype" id="6305704">error</span><span class="op" id="6305709">)</span>&nbsp;<span class="op" id="6305711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305714">r</span>&nbsp;<span class="op" id="6305716">:=</span>&nbsp;<span class="builtinfunc" id="6305719">new</span><span class="op" id="6305722">(</span><span class="ident" id="6305723">http</span><span class="op" id="6305727">.</span><span class="ident" id="6305728">Request</span><span class="op" id="6305735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305738">r</span><span class="op" id="6305739">.</span><span class="ident" id="6305740">Method</span>&nbsp;<span class="op" id="6305747">=</span>&nbsp;<span class="ident" id="6305749">params</span><span class="op" id="6305755">[</span><span class="string" id="6305756">&#34;REQUEST_METHOD&#34;</span><span class="op" id="6305772">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305775">if</span>&nbsp;<span class="ident" id="6305778">r</span><span class="op" id="6305779">.</span><span class="ident" id="6305780">Method</span>&nbsp;<span class="op" id="6305787">==</span>&nbsp;<span class="string" id="6305790">&#34;&#34;</span>&nbsp;<span class="op" id="6305793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305797">return</span>&nbsp;<span class="ident" id="6305804">nil</span><span class="op" id="6305807">,</span>&nbsp;<span class="ident" id="6305809">errors</span><span class="op" id="6305815">.</span><span class="ident" id="6305816">New</span><span class="op" id="6305819">(</span><span class="string" id="6305820">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="6305859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6305862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305866">r</span><span class="op" id="6305867">.</span><span class="ident" id="6305868">Proto</span>&nbsp;<span class="op" id="6305874">=</span>&nbsp;<span class="ident" id="6305876">params</span><span class="op" id="6305882">[</span><span class="string" id="6305883">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="6305900">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305903">var</span>&nbsp;<span class="ident" id="6305907">ok</span>&nbsp;<span class="builtintype" id="6305910">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6305916">r</span><span class="op" id="6305917">.</span><span class="ident" id="6305918">ProtoMajor</span><span class="op" id="6305928">,</span>&nbsp;<span class="ident" id="6305930">r</span><span class="op" id="6305931">.</span><span class="ident" id="6305932">ProtoMinor</span><span class="op" id="6305942">,</span>&nbsp;<span class="ident" id="6305944">ok</span>&nbsp;<span class="op" id="6305947">=</span>&nbsp;<span class="ident" id="6305949">http</span><span class="op" id="6305953">.</span><span class="ident" id="6305954">ParseHTTPVersion</span><span class="op" id="6305970">(</span><span class="ident" id="6305971">r</span><span class="op" id="6305972">.</span><span class="ident" id="6305973">Proto</span><span class="op" id="6305978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305981">if</span>&nbsp;<span class="op" id="6305984">!</span><span class="ident" id="6305985">ok</span>&nbsp;<span class="op" id="6305988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6305992">return</span>&nbsp;<span class="ident" id="6305999">nil</span><span class="op" id="6306002">,</span>&nbsp;<span class="ident" id="6306004">errors</span><span class="op" id="6306010">.</span><span class="ident" id="6306011">New</span><span class="op" id="6306014">(</span><span class="string" id="6306015">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="6306053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306056">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306060">r</span><span class="op" id="6306061">.</span><span class="ident" id="6306062">Close</span>&nbsp;<span class="op" id="6306068">=</span>&nbsp;<span class="builtintype" id="6306070">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306076">r</span><span class="op" id="6306077">.</span><span class="ident" id="6306078">Trailer</span>&nbsp;<span class="op" id="6306086">=</span>&nbsp;<span class="ident" id="6306088">http</span><span class="op" id="6306092">.</span><span class="ident" id="6306093">Header</span><span class="op" id="6306099">{</span><span class="op" id="6306100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306103">r</span><span class="op" id="6306104">.</span><span class="ident" id="6306105">Header</span>&nbsp;<span class="op" id="6306112">=</span>&nbsp;<span class="ident" id="6306114">http</span><span class="op" id="6306118">.</span><span class="ident" id="6306119">Header</span><span class="op" id="6306125">{</span><span class="op" id="6306126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306130">r</span><span class="op" id="6306131">.</span><span class="ident" id="6306132">Host</span>&nbsp;<span class="op" id="6306137">=</span>&nbsp;<span class="ident" id="6306139">params</span><span class="op" id="6306145">[</span><span class="string" id="6306146">&#34;HTTP_HOST&#34;</span><span class="op" id="6306157">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306161">if</span>&nbsp;<span class="ident" id="6306164">lenstr</span>&nbsp;<span class="op" id="6306171">:=</span>&nbsp;<span class="ident" id="6306174">params</span><span class="op" id="6306180">[</span><span class="string" id="6306181">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="6306197">]</span><span class="op" id="6306198">;</span>&nbsp;<span class="ident" id="6306200">lenstr</span>&nbsp;<span class="op" id="6306207">!=</span>&nbsp;<span class="string" id="6306210">&#34;&#34;</span>&nbsp;<span class="op" id="6306213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306217">clen</span><span class="op" id="6306221">,</span>&nbsp;<span class="ident" id="6306223">err</span>&nbsp;<span class="op" id="6306227">:=</span>&nbsp;<span class="ident" id="6306230">strconv</span><span class="op" id="6306237">.</span><span class="ident" id="6306238">ParseInt</span><span class="op" id="6306246">(</span><span class="ident" id="6306247">lenstr</span><span class="op" id="6306253">,</span>&nbsp;<span class="num" id="6306255">10</span><span class="op" id="6306257">,</span>&nbsp;<span class="num" id="6306259">64</span><span class="op" id="6306261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306265">if</span>&nbsp;<span class="ident" id="6306268">err</span>&nbsp;<span class="op" id="6306272">!=</span>&nbsp;<span class="ident" id="6306275">nil</span>&nbsp;<span class="op" id="6306279">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306284">return</span>&nbsp;<span class="ident" id="6306291">nil</span><span class="op" id="6306294">,</span>&nbsp;<span class="ident" id="6306296">errors</span><span class="op" id="6306302">.</span><span class="ident" id="6306303">New</span><span class="op" id="6306306">(</span><span class="string" id="6306307">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="6306350">+</span>&nbsp;<span class="ident" id="6306352">lenstr</span><span class="op" id="6306358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306366">r</span><span class="op" id="6306367">.</span><span class="ident" id="6306368">ContentLength</span>&nbsp;<span class="op" id="6306382">=</span>&nbsp;<span class="ident" id="6306384">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306394">if</span>&nbsp;<span class="ident" id="6306397">ct</span>&nbsp;<span class="op" id="6306400">:=</span>&nbsp;<span class="ident" id="6306403">params</span><span class="op" id="6306409">[</span><span class="string" id="6306410">&#34;CONTENT_TYPE&#34;</span><span class="op" id="6306424">]</span><span class="op" id="6306425">;</span>&nbsp;<span class="ident" id="6306427">ct</span>&nbsp;<span class="op" id="6306430">!=</span>&nbsp;<span class="string" id="6306433">&#34;&#34;</span>&nbsp;<span class="op" id="6306436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306440">r</span><span class="op" id="6306441">.</span><span class="ident" id="6306442">Header</span><span class="op" id="6306448">.</span><span class="ident" id="6306449">Set</span><span class="op" id="6306452">(</span><span class="string" id="6306453">&#34;Content-Type&#34;</span><span class="op" id="6306467">,</span>&nbsp;<span class="ident" id="6306469">ct</span><span class="op" id="6306471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6306478">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306533">for</span>&nbsp;<span class="ident" id="6306537">k</span><span class="op" id="6306538">,</span>&nbsp;<span class="ident" id="6306540">v</span>&nbsp;<span class="op" id="6306542">:=</span>&nbsp;<span class="keyword" id="6306545">range</span>&nbsp;<span class="ident" id="6306551">params</span>&nbsp;<span class="op" id="6306558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306562">if</span>&nbsp;<span class="op" id="6306565">!</span><span class="ident" id="6306566">strings</span><span class="op" id="6306573">.</span><span class="ident" id="6306574">HasPrefix</span><span class="op" id="6306583">(</span><span class="ident" id="6306584">k</span><span class="op" id="6306585">,</span>&nbsp;<span class="string" id="6306587">&#34;HTTP_&#34;</span><span class="op" id="6306594">)</span>&nbsp;<span class="op" id="6306596">||</span>&nbsp;<span class="ident" id="6306599">k</span>&nbsp;<span class="op" id="6306601">==</span>&nbsp;<span class="string" id="6306604">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="6306616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306621">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306636">r</span><span class="op" id="6306637">.</span><span class="ident" id="6306638">Header</span><span class="op" id="6306644">.</span><span class="ident" id="6306645">Add</span><span class="op" id="6306648">(</span><span class="ident" id="6306649">strings</span><span class="op" id="6306656">.</span><span class="ident" id="6306657">Replace</span><span class="op" id="6306664">(</span><span class="ident" id="6306665">k</span><span class="op" id="6306666">[</span><span class="num" id="6306667">5</span><span class="op" id="6306668">:</span><span class="op" id="6306669">]</span><span class="op" id="6306670">,</span>&nbsp;<span class="string" id="6306672">&#34;_&#34;</span><span class="op" id="6306675">,</span>&nbsp;<span class="string" id="6306677">&#34;-&#34;</span><span class="op" id="6306680">,</span>&nbsp;<span class="op" id="6306682">-</span><span class="num" id="6306683">1</span><span class="op" id="6306684">)</span><span class="op" id="6306685">,</span>&nbsp;<span class="ident" id="6306687">v</span><span class="op" id="6306688">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6306695">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306753">uriStr</span>&nbsp;<span class="op" id="6306760">:=</span>&nbsp;<span class="ident" id="6306763">params</span><span class="op" id="6306769">[</span><span class="string" id="6306770">&#34;REQUEST_URI&#34;</span><span class="op" id="6306783">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306786">if</span>&nbsp;<span class="ident" id="6306789">uriStr</span>&nbsp;<span class="op" id="6306796">==</span>&nbsp;<span class="string" id="6306799">&#34;&#34;</span>&nbsp;<span class="op" id="6306802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6306806">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306864">uriStr</span>&nbsp;<span class="op" id="6306871">=</span>&nbsp;<span class="ident" id="6306873">params</span><span class="op" id="6306879">[</span><span class="string" id="6306880">&#34;SCRIPT_NAME&#34;</span><span class="op" id="6306893">]</span>&nbsp;<span class="op" id="6306895">+</span>&nbsp;<span class="ident" id="6306897">params</span><span class="op" id="6306903">[</span><span class="string" id="6306904">&#34;PATH_INFO&#34;</span><span class="op" id="6306915">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306919">s</span>&nbsp;<span class="op" id="6306921">:=</span>&nbsp;<span class="ident" id="6306924">params</span><span class="op" id="6306930">[</span><span class="string" id="6306931">&#34;QUERY_STRING&#34;</span><span class="op" id="6306945">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6306949">if</span>&nbsp;<span class="ident" id="6306952">s</span>&nbsp;<span class="op" id="6306954">!=</span>&nbsp;<span class="string" id="6306957">&#34;&#34;</span>&nbsp;<span class="op" id="6306960">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6306965">uriStr</span>&nbsp;<span class="op" id="6306972">+=</span>&nbsp;<span class="string" id="6306975">&#34;?&#34;</span>&nbsp;<span class="op" id="6306979">+</span>&nbsp;<span class="ident" id="6306981">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6306988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6306992">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6307045">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307112">if</span>&nbsp;<span class="ident" id="6307115">s</span>&nbsp;<span class="op" id="6307117">:=</span>&nbsp;<span class="ident" id="6307120">params</span><span class="op" id="6307126">[</span><span class="string" id="6307127">&#34;HTTPS&#34;</span><span class="op" id="6307134">]</span><span class="op" id="6307135">;</span>&nbsp;<span class="ident" id="6307137">s</span>&nbsp;<span class="op" id="6307139">==</span>&nbsp;<span class="string" id="6307142">&#34;on&#34;</span>&nbsp;<span class="op" id="6307147">||</span>&nbsp;<span class="ident" id="6307150">s</span>&nbsp;<span class="op" id="6307152">==</span>&nbsp;<span class="string" id="6307155">&#34;ON&#34;</span>&nbsp;<span class="op" id="6307160">||</span>&nbsp;<span class="ident" id="6307163">s</span>&nbsp;<span class="op" id="6307165">==</span>&nbsp;<span class="string" id="6307168">&#34;1&#34;</span>&nbsp;<span class="op" id="6307172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307176">r</span><span class="op" id="6307177">.</span><span class="ident" id="6307178">TLS</span>&nbsp;<span class="op" id="6307182">=</span>&nbsp;<span class="op" id="6307184">&amp;</span><span class="ident" id="6307185">tls</span><span class="op" id="6307188">.</span><span class="ident" id="6307189">ConnectionState</span><span class="op" id="6307204">{</span><span class="ident" id="6307205">HandshakeComplete</span><span class="op" id="6307222">:</span>&nbsp;<span class="builtintype" id="6307224">true</span><span class="op" id="6307228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307235">if</span>&nbsp;<span class="ident" id="6307238">r</span><span class="op" id="6307239">.</span><span class="ident" id="6307240">Host</span>&nbsp;<span class="op" id="6307245">!=</span>&nbsp;<span class="string" id="6307248">&#34;&#34;</span>&nbsp;<span class="op" id="6307251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6307255">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307320">rawurl</span>&nbsp;<span class="op" id="6307327">:=</span>&nbsp;<span class="ident" id="6307330">r</span><span class="op" id="6307331">.</span><span class="ident" id="6307332">Host</span>&nbsp;<span class="op" id="6307337">+</span>&nbsp;<span class="ident" id="6307339">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307348">if</span>&nbsp;<span class="ident" id="6307351">r</span><span class="op" id="6307352">.</span><span class="ident" id="6307353">TLS</span>&nbsp;<span class="op" id="6307357">==</span>&nbsp;<span class="ident" id="6307360">nil</span>&nbsp;<span class="op" id="6307364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307369">rawurl</span>&nbsp;<span class="op" id="6307376">=</span>&nbsp;<span class="string" id="6307378">&#34;http://&#34;</span>&nbsp;<span class="op" id="6307388">+</span>&nbsp;<span class="ident" id="6307390">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307399">}</span>&nbsp;<span class="keyword" id="6307401">else</span>&nbsp;<span class="op" id="6307406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307411">rawurl</span>&nbsp;<span class="op" id="6307418">=</span>&nbsp;<span class="string" id="6307420">&#34;https://&#34;</span>&nbsp;<span class="op" id="6307431">+</span>&nbsp;<span class="ident" id="6307433">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307446">url</span><span class="op" id="6307449">,</span>&nbsp;<span class="ident" id="6307451">err</span>&nbsp;<span class="op" id="6307455">:=</span>&nbsp;<span class="ident" id="6307458">url</span><span class="op" id="6307461">.</span><span class="ident" id="6307462">Parse</span><span class="op" id="6307467">(</span><span class="ident" id="6307468">rawurl</span><span class="op" id="6307474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307478">if</span>&nbsp;<span class="ident" id="6307481">err</span>&nbsp;<span class="op" id="6307485">!=</span>&nbsp;<span class="ident" id="6307488">nil</span>&nbsp;<span class="op" id="6307492">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307497">return</span>&nbsp;<span class="ident" id="6307504">nil</span><span class="op" id="6307507">,</span>&nbsp;<span class="ident" id="6307509">errors</span><span class="op" id="6307515">.</span><span class="ident" id="6307516">New</span><span class="op" id="6307519">(</span><span class="string" id="6307520">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="6307577">+</span>&nbsp;<span class="ident" id="6307579">rawurl</span><span class="op" id="6307585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307593">r</span><span class="op" id="6307594">.</span><span class="ident" id="6307595">URL</span>&nbsp;<span class="op" id="6307599">=</span>&nbsp;<span class="ident" id="6307601">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6307609">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6307670">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307690">if</span>&nbsp;<span class="ident" id="6307693">r</span><span class="op" id="6307694">.</span><span class="ident" id="6307695">URL</span>&nbsp;<span class="op" id="6307699">==</span>&nbsp;<span class="ident" id="6307702">nil</span>&nbsp;<span class="op" id="6307706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307710">url</span><span class="op" id="6307713">,</span>&nbsp;<span class="ident" id="6307715">err</span>&nbsp;<span class="op" id="6307719">:=</span>&nbsp;<span class="ident" id="6307722">url</span><span class="op" id="6307725">.</span><span class="ident" id="6307726">Parse</span><span class="op" id="6307731">(</span><span class="ident" id="6307732">uriStr</span><span class="op" id="6307738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307742">if</span>&nbsp;<span class="ident" id="6307745">err</span>&nbsp;<span class="op" id="6307749">!=</span>&nbsp;<span class="ident" id="6307752">nil</span>&nbsp;<span class="op" id="6307756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6307761">return</span>&nbsp;<span class="ident" id="6307768">nil</span><span class="op" id="6307771">,</span>&nbsp;<span class="ident" id="6307773">errors</span><span class="op" id="6307779">.</span><span class="ident" id="6307780">New</span><span class="op" id="6307783">(</span><span class="string" id="6307784">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="6307832">+</span>&nbsp;<span class="ident" id="6307834">uriStr</span><span class="op" id="6307840">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6307848">r</span><span class="op" id="6307849">.</span><span class="ident" id="6307850">URL</span>&nbsp;<span class="op" id="6307854">=</span>&nbsp;<span class="ident" id="6307856">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6307861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6307865">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6307927">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6307991">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308012">r</span><span class="op" id="6308013">.</span><span class="ident" id="6308014">RemoteAddr</span>&nbsp;<span class="op" id="6308025">=</span>&nbsp;<span class="ident" id="6308027">net</span><span class="op" id="6308030">.</span><span class="ident" id="6308031">JoinHostPort</span><span class="op" id="6308043">(</span><span class="ident" id="6308044">params</span><span class="op" id="6308050">[</span><span class="string" id="6308051">&#34;REMOTE_ADDR&#34;</span><span class="op" id="6308064">]</span><span class="op" id="6308065">,</span>&nbsp;<span class="string" id="6308067">&#34;0&#34;</span><span class="op" id="6308070">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6308074">return</span>&nbsp;<span class="ident" id="6308081">r</span><span class="op" id="6308082">,</span>&nbsp;<span class="ident" id="6308084">nil</span><br>
<span class="lineno">140</span><span class="op" id="6308088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6308091">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="6308158">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="6308216">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="6308280">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="6308305">func</span>&nbsp;<span class="ident" id="6308310">Serve</span><span class="op" id="6308315">(</span><span class="ident" id="6308316">handler</span>&nbsp;<span class="ident" id="6308324">http</span><span class="op" id="6308328">.</span><span class="ident" id="6308329">Handler</span><span class="op" id="6308336">)</span>&nbsp;<span class="builtintype" id="6308338">error</span>&nbsp;<span class="op" id="6308344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308347">req</span><span class="op" id="6308350">,</span>&nbsp;<span class="ident" id="6308352">err</span>&nbsp;<span class="op" id="6308356">:=</span>&nbsp;<span class="ident" id="6308359">Request</span><span class="op" id="6308366">(</span><span class="op" id="6308367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6308370">if</span>&nbsp;<span class="ident" id="6308373">err</span>&nbsp;<span class="op" id="6308377">!=</span>&nbsp;<span class="ident" id="6308380">nil</span>&nbsp;<span class="op" id="6308384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6308388">return</span>&nbsp;<span class="ident" id="6308395">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6308400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6308403">if</span>&nbsp;<span class="ident" id="6308406">handler</span>&nbsp;<span class="op" id="6308414">==</span>&nbsp;<span class="ident" id="6308417">nil</span>&nbsp;<span class="op" id="6308421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308425">handler</span>&nbsp;<span class="op" id="6308433">=</span>&nbsp;<span class="ident" id="6308435">http</span><span class="op" id="6308439">.</span><span class="ident" id="6308440">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6308457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308460">rw</span>&nbsp;<span class="op" id="6308463">:=</span>&nbsp;<span class="op" id="6308466">&amp;</span><span class="ident" id="6308467">response</span><span class="op" id="6308475">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308479">req</span><span class="op" id="6308482">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6308487">req</span><span class="op" id="6308490">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308494">header</span><span class="op" id="6308500">:</span>&nbsp;<span class="builtinfunc" id="6308502">make</span><span class="op" id="6308506">(</span><span class="ident" id="6308507">http</span><span class="op" id="6308511">.</span><span class="ident" id="6308512">Header</span><span class="op" id="6308518">)</span><span class="op" id="6308519">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308523">bufw</span><span class="op" id="6308527">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6308531">bufio</span><span class="op" id="6308536">.</span><span class="ident" id="6308537">NewWriter</span><span class="op" id="6308546">(</span><span class="ident" id="6308547">os</span><span class="op" id="6308549">.</span><span class="ident" id="6308550">Stdout</span><span class="op" id="6308556">)</span><span class="op" id="6308557">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6308560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308563">handler</span><span class="op" id="6308570">.</span><span class="ident" id="6308571">ServeHTTP</span><span class="op" id="6308580">(</span><span class="ident" id="6308581">rw</span><span class="op" id="6308583">,</span>&nbsp;<span class="ident" id="6308585">req</span><span class="op" id="6308588">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308591">rw</span><span class="op" id="6308593">.</span><span class="ident" id="6308594">Write</span><span class="op" id="6308599">(</span><span class="ident" id="6308600">nil</span><span class="op" id="6308603">)</span>&nbsp;<span class="comment" id="6308605">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6308638">if</span>&nbsp;<span class="ident" id="6308641">err</span>&nbsp;<span class="op" id="6308645">=</span>&nbsp;<span class="ident" id="6308647">rw</span><span class="op" id="6308649">.</span><span class="ident" id="6308650">bufw</span><span class="op" id="6308654">.</span><span class="ident" id="6308655">Flush</span><span class="op" id="6308660">(</span><span class="op" id="6308661">)</span><span class="op" id="6308662">;</span>&nbsp;<span class="ident" id="6308664">err</span>&nbsp;<span class="op" id="6308668">!=</span>&nbsp;<span class="ident" id="6308671">nil</span>&nbsp;<span class="op" id="6308675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6308679">return</span>&nbsp;<span class="ident" id="6308686">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6308691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6308694">return</span>&nbsp;<span class="ident" id="6308701">nil</span><br>
<span class="lineno">165</span><span class="op" id="6308705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6308708">type</span>&nbsp;<span class="ident" id="6308713">response</span>&nbsp;<span class="keyword" id="6308722">struct</span>&nbsp;<span class="op" id="6308729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308732">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6308743">*</span><span class="ident" id="6308744">http</span><span class="op" id="6308748">.</span><span class="ident" id="6308749">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308758">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6308769">http</span><span class="op" id="6308773">.</span><span class="ident" id="6308774">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308782">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6308793">*</span><span class="ident" id="6308794">bufio</span><span class="op" id="6308799">.</span><span class="ident" id="6308800">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308808">headerSent</span>&nbsp;<span class="builtintype" id="6308819">bool</span><br>
<span class="lineno"></span><span class="op" id="6308824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6308827">func</span>&nbsp;<span class="op" id="6308832">(</span><span class="ident" id="6308833">r</span>&nbsp;<span class="op" id="6308835">*</span><span class="ident" id="6308836">response</span><span class="op" id="6308844">)</span>&nbsp;<span class="ident" id="6308846">Flush</span><span class="op" id="6308851">(</span><span class="op" id="6308852">)</span>&nbsp;<span class="op" id="6308854">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6308857">r</span><span class="op" id="6308858">.</span><span class="ident" id="6308859">bufw</span><span class="op" id="6308863">.</span><span class="ident" id="6308864">Flush</span><span class="op" id="6308869">(</span><span class="op" id="6308870">)</span><br>
<span class="lineno"></span><span class="op" id="6308872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6308875">func</span>&nbsp;<span class="op" id="6308880">(</span><span class="ident" id="6308881">r</span>&nbsp;<span class="op" id="6308883">*</span><span class="ident" id="6308884">response</span><span class="op" id="6308892">)</span>&nbsp;<span class="ident" id="6308894">Header</span><span class="op" id="6308900">(</span><span class="op" id="6308901">)</span>&nbsp;<span class="ident" id="6308903">http</span><span class="op" id="6308907">.</span><span class="ident" id="6308908">Header</span>&nbsp;<span class="op" id="6308915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6308918">return</span>&nbsp;<span class="ident" id="6308925">r</span><span class="op" id="6308926">.</span><span class="ident" id="6308927">header</span><br>
<span class="lineno">180</span><span class="op" id="6308934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6308937">func</span>&nbsp;<span class="op" id="6308942">(</span><span class="ident" id="6308943">r</span>&nbsp;<span class="op" id="6308945">*</span><span class="ident" id="6308946">response</span><span class="op" id="6308954">)</span>&nbsp;<span class="ident" id="6308956">Write</span><span class="op" id="6308961">(</span><span class="ident" id="6308962">p</span>&nbsp;<span class="op" id="6308964">[</span><span class="op" id="6308965">]</span><span class="builtintype" id="6308966">byte</span><span class="op" id="6308970">)</span>&nbsp;<span class="op" id="6308972">(</span><span class="ident" id="6308973">n</span>&nbsp;<span class="builtintype" id="6308975">int</span><span class="op" id="6308978">,</span>&nbsp;<span class="ident" id="6308980">err</span>&nbsp;<span class="builtintype" id="6308984">error</span><span class="op" id="6308989">)</span>&nbsp;<span class="op" id="6308991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6308994">if</span>&nbsp;<span class="op" id="6308997">!</span><span class="ident" id="6308998">r</span><span class="op" id="6308999">.</span><span class="ident" id="6309000">headerSent</span>&nbsp;<span class="op" id="6309011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6309015">r</span><span class="op" id="6309016">.</span><span class="ident" id="6309017">WriteHeader</span><span class="op" id="6309028">(</span><span class="ident" id="6309029">http</span><span class="op" id="6309033">.</span><span class="ident" id="6309034">StatusOK</span><span class="op" id="6309042">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6309045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6309048">return</span>&nbsp;<span class="ident" id="6309055">r</span><span class="op" id="6309056">.</span><span class="ident" id="6309057">bufw</span><span class="op" id="6309061">.</span><span class="ident" id="6309062">Write</span><span class="op" id="6309067">(</span><span class="ident" id="6309068">p</span><span class="op" id="6309069">)</span><br>
<span class="lineno"></span><span class="op" id="6309071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6309074">func</span>&nbsp;<span class="op" id="6309079">(</span><span class="ident" id="6309080">r</span>&nbsp;<span class="op" id="6309082">*</span><span class="ident" id="6309083">response</span><span class="op" id="6309091">)</span>&nbsp;<span class="ident" id="6309093">WriteHeader</span><span class="op" id="6309104">(</span><span class="ident" id="6309105">code</span>&nbsp;<span class="builtintype" id="6309110">int</span><span class="op" id="6309113">)</span>&nbsp;<span class="op" id="6309115">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6309118">if</span>&nbsp;<span class="ident" id="6309121">r</span><span class="op" id="6309122">.</span><span class="ident" id="6309123">headerSent</span>&nbsp;<span class="op" id="6309134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6309138">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6309204">fmt</span><span class="op" id="6309207">.</span><span class="ident" id="6309208">Fprintf</span><span class="op" id="6309215">(</span><span class="ident" id="6309216">os</span><span class="op" id="6309218">.</span><span class="ident" id="6309219">Stderr</span><span class="op" id="6309225">,</span>&nbsp;<span class="string" id="6309227">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="6309282">,</span>&nbsp;<span class="ident" id="6309284">r</span><span class="op" id="6309285">.</span><span class="ident" id="6309286">req</span><span class="op" id="6309289">.</span><span class="ident" id="6309290">URL</span><span class="op" id="6309293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6309297">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6309305">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6309308">r</span><span class="op" id="6309309">.</span><span class="ident" id="6309310">headerSent</span>&nbsp;<span class="op" id="6309321">=</span>&nbsp;<span class="builtintype" id="6309323">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6309329">fmt</span><span class="op" id="6309332">.</span><span class="ident" id="6309333">Fprintf</span><span class="op" id="6309340">(</span><span class="ident" id="6309341">r</span><span class="op" id="6309342">.</span><span class="ident" id="6309343">bufw</span><span class="op" id="6309347">,</span>&nbsp;<span class="string" id="6309349">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6309368">,</span>&nbsp;<span class="ident" id="6309370">code</span><span class="op" id="6309374">,</span>&nbsp;<span class="ident" id="6309376">http</span><span class="op" id="6309380">.</span><span class="ident" id="6309381">StatusText</span><span class="op" id="6309391">(</span><span class="ident" id="6309392">code</span><span class="op" id="6309396">)</span><span class="op" id="6309397">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6309401">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6309432">if</span>&nbsp;<span class="ident" id="6309435">_</span><span class="op" id="6309436">,</span>&nbsp;<span class="ident" id="6309438">hasType</span>&nbsp;<span class="op" id="6309446">:=</span>&nbsp;<span class="ident" id="6309449">r</span><span class="op" id="6309450">.</span><span class="ident" id="6309451">header</span><span class="op" id="6309457">[</span><span class="string" id="6309458">&#34;Content-Type&#34;</span><span class="op" id="6309472">]</span><span class="op" id="6309473">;</span>&nbsp;<span class="op" id="6309475">!</span><span class="ident" id="6309476">hasType</span>&nbsp;<span class="op" id="6309484">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6309488">r</span><span class="op" id="6309489">.</span><span class="ident" id="6309490">header</span><span class="op" id="6309496">.</span><span class="ident" id="6309497">Add</span><span class="op" id="6309500">(</span><span class="string" id="6309501">&#34;Content-Type&#34;</span><span class="op" id="6309515">,</span>&nbsp;<span class="string" id="6309517">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6309543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6309546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6309550">r</span><span class="op" id="6309551">.</span><span class="ident" id="6309552">header</span><span class="op" id="6309558">.</span><span class="ident" id="6309559">Write</span><span class="op" id="6309564">(</span><span class="ident" id="6309565">r</span><span class="op" id="6309566">.</span><span class="ident" id="6309567">bufw</span><span class="op" id="6309571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6309574">r</span><span class="op" id="6309575">.</span><span class="ident" id="6309576">bufw</span><span class="op" id="6309580">.</span><span class="ident" id="6309581">WriteString</span><span class="op" id="6309592">(</span><span class="string" id="6309593">&#34;\r\n&#34;</span><span class="op" id="6309599">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6309602">r</span><span class="op" id="6309603">.</span><span class="ident" id="6309604">bufw</span><span class="op" id="6309608">.</span><span class="ident" id="6309609">Flush</span><span class="op" id="6309614">(</span><span class="op" id="6309615">)</span><br>
<span class="lineno"></span><span class="op" id="6309617">}</span>
</div>
</body>
</html>
