<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html" class="current">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3817431">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3817486">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3817540">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3817591">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3817628">package</span>&nbsp;<span class="ident" id="3817636">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3817642">import</span>&nbsp;<span class="op" id="3817649">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817652">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817662">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817669">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817675">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817683">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817701">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817718">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817729">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817735">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817743">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817760">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817771">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3817782">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3817789">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3817792">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3817868">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="3817896">//</span><br>
<span class="lineno"></span><span class="comment" id="3817899">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3817977">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="3818057">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="3818112">//</span><br>
<span class="lineno"></span><span class="comment" id="3818115">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3818150">type</span>&nbsp;<span class="ident" id="3818155">Dir</span>&nbsp;<span class="builtintype" id="3818159">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="3818167">func</span>&nbsp;<span class="op" id="3818172">(</span><span class="ident" id="3818173">d</span>&nbsp;<span class="ident" id="3818175">Dir</span><span class="op" id="3818178">)</span>&nbsp;<span class="ident" id="3818180">Open</span><span class="op" id="3818184">(</span><span class="ident" id="3818185">name</span>&nbsp;<span class="builtintype" id="3818190">string</span><span class="op" id="3818196">)</span>&nbsp;<span class="op" id="3818198">(</span><span class="ident" id="3818199">File</span><span class="op" id="3818203">,</span>&nbsp;<span class="builtintype" id="3818205">error</span><span class="op" id="3818210">)</span>&nbsp;<span class="op" id="3818212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818215">if</span>&nbsp;<span class="ident" id="3818218">filepath</span><span class="op" id="3818226">.</span><span class="ident" id="3818227">Separator</span>&nbsp;<span class="op" id="3818237">!=</span>&nbsp;<span class="string" id="3818240">&#39;/&#39;</span>&nbsp;<span class="op" id="3818244">&amp;&amp;</span>&nbsp;<span class="ident" id="3818247">strings</span><span class="op" id="3818254">.</span><span class="ident" id="3818255">IndexRune</span><span class="op" id="3818264">(</span><span class="ident" id="3818265">name</span><span class="op" id="3818269">,</span>&nbsp;<span class="ident" id="3818271">filepath</span><span class="op" id="3818279">.</span><span class="ident" id="3818280">Separator</span><span class="op" id="3818289">)</span>&nbsp;<span class="op" id="3818291">&gt;=</span>&nbsp;<span class="num" id="3818294">0</span>&nbsp;<span class="op" id="3818296">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818301">strings</span><span class="op" id="3818308">.</span><span class="ident" id="3818309">Contains</span><span class="op" id="3818317">(</span><span class="ident" id="3818318">name</span><span class="op" id="3818322">,</span>&nbsp;<span class="string" id="3818324">&#34;\x00&#34;</span><span class="op" id="3818330">)</span>&nbsp;<span class="op" id="3818332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818336">return</span>&nbsp;<span class="ident" id="3818343">nil</span><span class="op" id="3818346">,</span>&nbsp;<span class="ident" id="3818348">errors</span><span class="op" id="3818354">.</span><span class="ident" id="3818355">New</span><span class="op" id="3818358">(</span><span class="string" id="3818359">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="3818397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818400">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818403">dir</span>&nbsp;<span class="op" id="3818407">:=</span>&nbsp;<span class="builtintype" id="3818410">string</span><span class="op" id="3818416">(</span><span class="ident" id="3818417">d</span><span class="op" id="3818418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818421">if</span>&nbsp;<span class="ident" id="3818424">dir</span>&nbsp;<span class="op" id="3818428">==</span>&nbsp;<span class="string" id="3818431">&#34;&#34;</span>&nbsp;<span class="op" id="3818434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818438">dir</span>&nbsp;<span class="op" id="3818442">=</span>&nbsp;<span class="string" id="3818444">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818452">f</span><span class="op" id="3818453">,</span>&nbsp;<span class="ident" id="3818455">err</span>&nbsp;<span class="op" id="3818459">:=</span>&nbsp;<span class="ident" id="3818462">os</span><span class="op" id="3818464">.</span><span class="ident" id="3818465">Open</span><span class="op" id="3818469">(</span><span class="ident" id="3818470">filepath</span><span class="op" id="3818478">.</span><span class="ident" id="3818479">Join</span><span class="op" id="3818483">(</span><span class="ident" id="3818484">dir</span><span class="op" id="3818487">,</span>&nbsp;<span class="ident" id="3818489">filepath</span><span class="op" id="3818497">.</span><span class="ident" id="3818498">FromSlash</span><span class="op" id="3818507">(</span><span class="ident" id="3818508">path</span><span class="op" id="3818512">.</span><span class="ident" id="3818513">Clean</span><span class="op" id="3818518">(</span><span class="string" id="3818519">&#34;/&#34;</span><span class="op" id="3818522">+</span><span class="ident" id="3818523">name</span><span class="op" id="3818527">)</span><span class="op" id="3818528">)</span><span class="op" id="3818529">)</span><span class="op" id="3818530">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818533">if</span>&nbsp;<span class="ident" id="3818536">err</span>&nbsp;<span class="op" id="3818540">!=</span>&nbsp;<span class="ident" id="3818543">nil</span>&nbsp;<span class="op" id="3818547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818551">return</span>&nbsp;<span class="ident" id="3818558">nil</span><span class="op" id="3818561">,</span>&nbsp;<span class="ident" id="3818563">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3818568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3818571">return</span>&nbsp;<span class="ident" id="3818578">f</span><span class="op" id="3818579">,</span>&nbsp;<span class="ident" id="3818581">nil</span><br>
<span class="lineno"></span><span class="op" id="3818585">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="3818588">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="3818654">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="3818722">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="3818785">type</span>&nbsp;<span class="ident" id="3818790">FileSystem</span>&nbsp;<span class="keyword" id="3818801">interface</span>&nbsp;<span class="op" id="3818811">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3818814">Open</span><span class="op" id="3818818">(</span><span class="ident" id="3818819">name</span>&nbsp;<span class="builtintype" id="3818824">string</span><span class="op" id="3818830">)</span>&nbsp;<span class="op" id="3818832">(</span><span class="ident" id="3818833">File</span><span class="op" id="3818837">,</span>&nbsp;<span class="builtintype" id="3818839">error</span><span class="op" id="3818844">)</span><br>
<span class="lineno"></span><span class="op" id="3818846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3818849">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3818912">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="3818956">//</span><br>
<span class="lineno"></span><span class="comment" id="3818959">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="3819022">type</span>&nbsp;<span class="ident" id="3819027">File</span>&nbsp;<span class="keyword" id="3819032">interface</span>&nbsp;<span class="op" id="3819042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819045">io</span><span class="op" id="3819047">.</span><span class="ident" id="3819048">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819056">io</span><span class="op" id="3819058">.</span><span class="ident" id="3819059">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819067">Readdir</span><span class="op" id="3819074">(</span><span class="ident" id="3819075">count</span>&nbsp;<span class="builtintype" id="3819081">int</span><span class="op" id="3819084">)</span>&nbsp;<span class="op" id="3819086">(</span><span class="op" id="3819087">[</span><span class="op" id="3819088">]</span><span class="ident" id="3819089">os</span><span class="op" id="3819091">.</span><span class="ident" id="3819092">FileInfo</span><span class="op" id="3819100">,</span>&nbsp;<span class="builtintype" id="3819102">error</span><span class="op" id="3819107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819110">Seek</span><span class="op" id="3819114">(</span><span class="ident" id="3819115">offset</span>&nbsp;<span class="ident" id="3819122">int64</span><span class="op" id="3819127">,</span>&nbsp;<span class="ident" id="3819129">whence</span>&nbsp;<span class="builtintype" id="3819136">int</span><span class="op" id="3819139">)</span>&nbsp;<span class="op" id="3819141">(</span><span class="ident" id="3819142">int64</span><span class="op" id="3819147">,</span>&nbsp;<span class="builtintype" id="3819149">error</span><span class="op" id="3819154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819157">Stat</span><span class="op" id="3819161">(</span><span class="op" id="3819162">)</span>&nbsp;<span class="op" id="3819164">(</span><span class="ident" id="3819165">os</span><span class="op" id="3819167">.</span><span class="ident" id="3819168">FileInfo</span><span class="op" id="3819176">,</span>&nbsp;<span class="builtintype" id="3819178">error</span><span class="op" id="3819183">)</span><br>
<span class="lineno"></span><span class="op" id="3819185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3819188">func</span>&nbsp;<span class="ident" id="3819193">dirList</span><span class="op" id="3819200">(</span><span class="ident" id="3819201">w</span>&nbsp;<span class="ident" id="3819203">ResponseWriter</span><span class="op" id="3819217">,</span>&nbsp;<span class="ident" id="3819219">f</span>&nbsp;<span class="ident" id="3819221">File</span><span class="op" id="3819225">)</span>&nbsp;<span class="op" id="3819227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819230">w</span><span class="op" id="3819231">.</span><span class="ident" id="3819232">Header</span><span class="op" id="3819238">(</span><span class="op" id="3819239">)</span><span class="op" id="3819240">.</span><span class="ident" id="3819241">Set</span><span class="op" id="3819244">(</span><span class="string" id="3819245">&#34;Content-Type&#34;</span><span class="op" id="3819259">,</span>&nbsp;<span class="string" id="3819261">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="3819287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819290">fmt</span><span class="op" id="3819293">.</span><span class="ident" id="3819294">Fprintf</span><span class="op" id="3819301">(</span><span class="ident" id="3819302">w</span><span class="op" id="3819303">,</span>&nbsp;<span class="string" id="3819305">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="3819314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3819317">for</span>&nbsp;<span class="op" id="3819321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819325">dirs</span><span class="op" id="3819329">,</span>&nbsp;<span class="ident" id="3819331">err</span>&nbsp;<span class="op" id="3819335">:=</span>&nbsp;<span class="ident" id="3819338">f</span><span class="op" id="3819339">.</span><span class="ident" id="3819340">Readdir</span><span class="op" id="3819347">(</span><span class="num" id="3819348">100</span><span class="op" id="3819351">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3819355">if</span>&nbsp;<span class="ident" id="3819358">err</span>&nbsp;<span class="op" id="3819362">!=</span>&nbsp;<span class="ident" id="3819365">nil</span>&nbsp;<span class="op" id="3819369">||</span>&nbsp;<span class="builtinfunc" id="3819372">len</span><span class="op" id="3819375">(</span><span class="ident" id="3819376">dirs</span><span class="op" id="3819380">)</span>&nbsp;<span class="op" id="3819382">==</span>&nbsp;<span class="num" id="3819385">0</span>&nbsp;<span class="op" id="3819387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3819392">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3819400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3819404">for</span>&nbsp;<span class="ident" id="3819408">_</span><span class="op" id="3819409">,</span>&nbsp;<span class="ident" id="3819411">d</span>&nbsp;<span class="op" id="3819413">:=</span>&nbsp;<span class="keyword" id="3819416">range</span>&nbsp;<span class="ident" id="3819422">dirs</span>&nbsp;<span class="op" id="3819427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819432">name</span>&nbsp;<span class="op" id="3819437">:=</span>&nbsp;<span class="ident" id="3819440">d</span><span class="op" id="3819441">.</span><span class="ident" id="3819442">Name</span><span class="op" id="3819446">(</span><span class="op" id="3819447">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3819452">if</span>&nbsp;<span class="ident" id="3819455">d</span><span class="op" id="3819456">.</span><span class="ident" id="3819457">IsDir</span><span class="op" id="3819462">(</span><span class="op" id="3819463">)</span>&nbsp;<span class="op" id="3819465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819471">name</span>&nbsp;<span class="op" id="3819476">+=</span>&nbsp;<span class="string" id="3819479">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3819486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819491">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819558">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3819624">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819650">url</span>&nbsp;<span class="op" id="3819654">:=</span>&nbsp;<span class="ident" id="3819657">url</span><span class="op" id="3819660">.</span><span class="ident" id="3819661">URL</span><span class="op" id="3819664">{</span><span class="ident" id="3819665">Path</span><span class="op" id="3819669">:</span>&nbsp;<span class="ident" id="3819671">name</span><span class="op" id="3819675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819680">fmt</span><span class="op" id="3819683">.</span><span class="ident" id="3819684">Fprintf</span><span class="op" id="3819691">(</span><span class="ident" id="3819692">w</span><span class="op" id="3819693">,</span>&nbsp;<span class="string" id="3819695">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="3819720">,</span>&nbsp;<span class="ident" id="3819722">url</span><span class="op" id="3819725">.</span><span class="ident" id="3819726">String</span><span class="op" id="3819732">(</span><span class="op" id="3819733">)</span><span class="op" id="3819734">,</span>&nbsp;<span class="ident" id="3819736">htmlReplacer</span><span class="op" id="3819748">.</span><span class="ident" id="3819749">Replace</span><span class="op" id="3819756">(</span><span class="ident" id="3819757">name</span><span class="op" id="3819761">)</span><span class="op" id="3819762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3819766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3819769">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3819772">fmt</span><span class="op" id="3819775">.</span><span class="ident" id="3819776">Fprintf</span><span class="op" id="3819783">(</span><span class="ident" id="3819784">w</span><span class="op" id="3819785">,</span>&nbsp;<span class="string" id="3819787">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="3819797">)</span><br>
<span class="lineno"></span><span class="op" id="3819799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3819802">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3819866">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="3819937">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3820008">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="3820047">//</span><br>
<span class="lineno"></span><span class="comment" id="3820050">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="3820116">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="3820182">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="3820253">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="3820293">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3820363">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3820394">//</span><br>
<span class="lineno">105</span><span class="comment" id="3820397">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3820463">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3820532">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="3820597">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="3820645">//</span><br>
<span class="lineno">110</span><span class="comment" id="3820648">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="3820706">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="3820765">//</span><br>
<span class="lineno"></span><span class="comment" id="3820768">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3820834">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="3820887">//</span><br>
<span class="lineno"></span><span class="comment" id="3820890">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3820952">func</span>&nbsp;<span class="ident" id="3820957">ServeContent</span><span class="op" id="3820969">(</span><span class="ident" id="3820970">w</span>&nbsp;<span class="ident" id="3820972">ResponseWriter</span><span class="op" id="3820986">,</span>&nbsp;<span class="ident" id="3820988">req</span>&nbsp;<span class="op" id="3820992">*</span><span class="ident" id="3820993">Request</span><span class="op" id="3821000">,</span>&nbsp;<span class="ident" id="3821002">name</span>&nbsp;<span class="builtintype" id="3821007">string</span><span class="op" id="3821013">,</span>&nbsp;<span class="ident" id="3821015">modtime</span>&nbsp;<span class="ident" id="3821023">time</span><span class="op" id="3821027">.</span><span class="ident" id="3821028">Time</span><span class="op" id="3821032">,</span>&nbsp;<span class="ident" id="3821034">content</span>&nbsp;<span class="ident" id="3821042">io</span><span class="op" id="3821044">.</span><span class="ident" id="3821045">ReadSeeker</span><span class="op" id="3821055">)</span>&nbsp;<span class="op" id="3821057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821060">sizeFunc</span>&nbsp;<span class="op" id="3821069">:=</span>&nbsp;<span class="keyword" id="3821072">func</span><span class="op" id="3821076">(</span><span class="op" id="3821077">)</span>&nbsp;<span class="op" id="3821079">(</span><span class="ident" id="3821080">int64</span><span class="op" id="3821085">,</span>&nbsp;<span class="builtintype" id="3821087">error</span><span class="op" id="3821092">)</span>&nbsp;<span class="op" id="3821094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821098">size</span><span class="op" id="3821102">,</span>&nbsp;<span class="ident" id="3821104">err</span>&nbsp;<span class="op" id="3821108">:=</span>&nbsp;<span class="ident" id="3821111">content</span><span class="op" id="3821118">.</span><span class="ident" id="3821119">Seek</span><span class="op" id="3821123">(</span><span class="num" id="3821124">0</span><span class="op" id="3821125">,</span>&nbsp;<span class="ident" id="3821127">os</span><span class="op" id="3821129">.</span><span class="ident" id="3821130">SEEK_END</span><span class="op" id="3821138">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821142">if</span>&nbsp;<span class="ident" id="3821145">err</span>&nbsp;<span class="op" id="3821149">!=</span>&nbsp;<span class="ident" id="3821152">nil</span>&nbsp;<span class="op" id="3821156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821161">return</span>&nbsp;<span class="num" id="3821168">0</span><span class="op" id="3821169">,</span>&nbsp;<span class="ident" id="3821171">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821187">_</span><span class="op" id="3821188">,</span>&nbsp;<span class="ident" id="3821190">err</span>&nbsp;<span class="op" id="3821194">=</span>&nbsp;<span class="ident" id="3821196">content</span><span class="op" id="3821203">.</span><span class="ident" id="3821204">Seek</span><span class="op" id="3821208">(</span><span class="num" id="3821209">0</span><span class="op" id="3821210">,</span>&nbsp;<span class="ident" id="3821212">os</span><span class="op" id="3821214">.</span><span class="ident" id="3821215">SEEK_SET</span><span class="op" id="3821223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821227">if</span>&nbsp;<span class="ident" id="3821230">err</span>&nbsp;<span class="op" id="3821234">!=</span>&nbsp;<span class="ident" id="3821237">nil</span>&nbsp;<span class="op" id="3821241">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821246">return</span>&nbsp;<span class="num" id="3821253">0</span><span class="op" id="3821254">,</span>&nbsp;<span class="ident" id="3821256">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3821272">return</span>&nbsp;<span class="ident" id="3821279">size</span><span class="op" id="3821283">,</span>&nbsp;<span class="ident" id="3821285">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3821290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3821293">serveContent</span><span class="op" id="3821305">(</span><span class="ident" id="3821306">w</span><span class="op" id="3821307">,</span>&nbsp;<span class="ident" id="3821309">req</span><span class="op" id="3821312">,</span>&nbsp;<span class="ident" id="3821314">name</span><span class="op" id="3821318">,</span>&nbsp;<span class="ident" id="3821320">modtime</span><span class="op" id="3821327">,</span>&nbsp;<span class="ident" id="3821329">sizeFunc</span><span class="op" id="3821337">,</span>&nbsp;<span class="ident" id="3821339">content</span><span class="op" id="3821346">)</span><br>
<span class="lineno">130</span><span class="op" id="3821348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3821351">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="3821420">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3821487">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="3821555">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="3821565">var</span>&nbsp;<span class="ident" id="3821569">errSeeker</span>&nbsp;<span class="op" id="3821579">=</span>&nbsp;<span class="ident" id="3821581">errors</span><span class="op" id="3821587">.</span><span class="ident" id="3821588">New</span><span class="op" id="3821591">(</span><span class="string" id="3821592">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="3821611">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3821614">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="3821694">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="3821738">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3821794">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3821883">func</span>&nbsp;<span class="ident" id="3821888">serveContent</span><span class="op" id="3821900">(</span><span class="ident" id="3821901">w</span>&nbsp;<span class="ident" id="3821903">ResponseWriter</span><span class="op" id="3821917">,</span>&nbsp;<span class="ident" id="3821919">r</span>&nbsp;<span class="op" id="3821921">*</span><span class="ident" id="3821922">Request</span><span class="op" id="3821929">,</span>&nbsp;<span class="ident" id="3821931">name</span>&nbsp;<span class="builtintype" id="3821936">string</span><span class="op" id="3821942">,</span>&nbsp;<span class="ident" id="3821944">modtime</span>&nbsp;<span class="ident" id="3821952">time</span><span class="op" id="3821956">.</span><span class="ident" id="3821957">Time</span><span class="op" id="3821961">,</span>&nbsp;<span class="ident" id="3821963">sizeFunc</span>&nbsp;<span class="keyword" id="3821972">func</span><span class="op" id="3821976">(</span><span class="op" id="3821977">)</span>&nbsp;<span class="op" id="3821979">(</span><span class="ident" id="3821980">int64</span><span class="op" id="3821985">,</span>&nbsp;<span class="builtintype" id="3821987">error</span><span class="op" id="3821992">)</span><span class="op" id="3821993">,</span>&nbsp;<span class="ident" id="3821995">content</span>&nbsp;<span class="ident" id="3822003">io</span><span class="op" id="3822005">.</span><span class="ident" id="3822006">ReadSeeker</span><span class="op" id="3822016">)</span>&nbsp;<span class="op" id="3822018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822021">if</span>&nbsp;<span class="ident" id="3822024">checkLastModified</span><span class="op" id="3822041">(</span><span class="ident" id="3822042">w</span><span class="op" id="3822043">,</span>&nbsp;<span class="ident" id="3822045">r</span><span class="op" id="3822046">,</span>&nbsp;<span class="ident" id="3822048">modtime</span><span class="op" id="3822055">)</span>&nbsp;<span class="op" id="3822057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822061">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3822069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822072">rangeReq</span><span class="op" id="3822080">,</span>&nbsp;<span class="ident" id="3822082">done</span>&nbsp;<span class="op" id="3822087">:=</span>&nbsp;<span class="ident" id="3822090">checkETag</span><span class="op" id="3822099">(</span><span class="ident" id="3822100">w</span><span class="op" id="3822101">,</span>&nbsp;<span class="ident" id="3822103">r</span><span class="op" id="3822104">,</span>&nbsp;<span class="ident" id="3822106">modtime</span><span class="op" id="3822113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822116">if</span>&nbsp;<span class="ident" id="3822119">done</span>&nbsp;<span class="op" id="3822124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822128">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3822136">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822140">code</span>&nbsp;<span class="op" id="3822145">:=</span>&nbsp;<span class="ident" id="3822148">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3822159">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3822231">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822299">ctypes</span><span class="op" id="3822305">,</span>&nbsp;<span class="ident" id="3822307">haveType</span>&nbsp;<span class="op" id="3822316">:=</span>&nbsp;<span class="ident" id="3822319">w</span><span class="op" id="3822320">.</span><span class="ident" id="3822321">Header</span><span class="op" id="3822327">(</span><span class="op" id="3822328">)</span><span class="op" id="3822329">[</span><span class="string" id="3822330">&#34;Content-Type&#34;</span><span class="op" id="3822344">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822347">var</span>&nbsp;<span class="ident" id="3822351">ctype</span>&nbsp;<span class="builtintype" id="3822357">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822365">if</span>&nbsp;<span class="op" id="3822368">!</span><span class="ident" id="3822369">haveType</span>&nbsp;<span class="op" id="3822378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822382">ctype</span>&nbsp;<span class="op" id="3822388">=</span>&nbsp;<span class="ident" id="3822390">mime</span><span class="op" id="3822394">.</span><span class="ident" id="3822395">TypeByExtension</span><span class="op" id="3822410">(</span><span class="ident" id="3822411">filepath</span><span class="op" id="3822419">.</span><span class="ident" id="3822420">Ext</span><span class="op" id="3822423">(</span><span class="ident" id="3822424">name</span><span class="op" id="3822428">)</span><span class="op" id="3822429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822433">if</span>&nbsp;<span class="ident" id="3822436">ctype</span>&nbsp;<span class="op" id="3822442">==</span>&nbsp;<span class="string" id="3822445">&#34;&#34;</span>&nbsp;<span class="op" id="3822448">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3822453">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822512">var</span>&nbsp;<span class="ident" id="3822516">buf</span>&nbsp;<span class="op" id="3822520">[</span><span class="ident" id="3822521">sniffLen</span><span class="op" id="3822529">]</span><span class="builtintype" id="3822530">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822538">n</span><span class="op" id="3822539">,</span>&nbsp;<span class="ident" id="3822541">_</span>&nbsp;<span class="op" id="3822543">:=</span>&nbsp;<span class="ident" id="3822546">io</span><span class="op" id="3822548">.</span><span class="ident" id="3822549">ReadFull</span><span class="op" id="3822557">(</span><span class="ident" id="3822558">content</span><span class="op" id="3822565">,</span>&nbsp;<span class="ident" id="3822567">buf</span><span class="op" id="3822570">[</span><span class="op" id="3822571">:</span><span class="op" id="3822572">]</span><span class="op" id="3822573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822578">ctype</span>&nbsp;<span class="op" id="3822584">=</span>&nbsp;<span class="ident" id="3822586">DetectContentType</span><span class="op" id="3822603">(</span><span class="ident" id="3822604">buf</span><span class="op" id="3822607">[</span><span class="op" id="3822608">:</span><span class="ident" id="3822609">n</span><span class="op" id="3822610">]</span><span class="op" id="3822611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822616">_</span><span class="op" id="3822617">,</span>&nbsp;<span class="ident" id="3822619">err</span>&nbsp;<span class="op" id="3822623">:=</span>&nbsp;<span class="ident" id="3822626">content</span><span class="op" id="3822633">.</span><span class="ident" id="3822634">Seek</span><span class="op" id="3822638">(</span><span class="num" id="3822639">0</span><span class="op" id="3822640">,</span>&nbsp;<span class="ident" id="3822642">os</span><span class="op" id="3822644">.</span><span class="ident" id="3822645">SEEK_SET</span><span class="op" id="3822653">)</span>&nbsp;<span class="comment" id="3822655">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822689">if</span>&nbsp;<span class="ident" id="3822692">err</span>&nbsp;<span class="op" id="3822696">!=</span>&nbsp;<span class="ident" id="3822699">nil</span>&nbsp;<span class="op" id="3822703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822709">Error</span><span class="op" id="3822714">(</span><span class="ident" id="3822715">w</span><span class="op" id="3822716">,</span>&nbsp;<span class="string" id="3822718">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="3822737">,</span>&nbsp;<span class="ident" id="3822739">StatusInternalServerError</span><span class="op" id="3822764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822770">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3822780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3822784">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822788">w</span><span class="op" id="3822789">.</span><span class="ident" id="3822790">Header</span><span class="op" id="3822796">(</span><span class="op" id="3822797">)</span><span class="op" id="3822798">.</span><span class="ident" id="3822799">Set</span><span class="op" id="3822802">(</span><span class="string" id="3822803">&#34;Content-Type&#34;</span><span class="op" id="3822817">,</span>&nbsp;<span class="ident" id="3822819">ctype</span><span class="op" id="3822824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3822827">}</span>&nbsp;<span class="keyword" id="3822829">else</span>&nbsp;<span class="keyword" id="3822834">if</span>&nbsp;<span class="builtinfunc" id="3822837">len</span><span class="op" id="3822840">(</span><span class="ident" id="3822841">ctypes</span><span class="op" id="3822847">)</span>&nbsp;<span class="op" id="3822849">&gt;</span>&nbsp;<span class="num" id="3822851">0</span>&nbsp;<span class="op" id="3822853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822857">ctype</span>&nbsp;<span class="op" id="3822863">=</span>&nbsp;<span class="ident" id="3822865">ctypes</span><span class="op" id="3822871">[</span><span class="num" id="3822872">0</span><span class="op" id="3822873">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3822876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822880">size</span><span class="op" id="3822884">,</span>&nbsp;<span class="ident" id="3822886">err</span>&nbsp;<span class="op" id="3822890">:=</span>&nbsp;<span class="ident" id="3822893">sizeFunc</span><span class="op" id="3822901">(</span><span class="op" id="3822902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822905">if</span>&nbsp;<span class="ident" id="3822908">err</span>&nbsp;<span class="op" id="3822912">!=</span>&nbsp;<span class="ident" id="3822915">nil</span>&nbsp;<span class="op" id="3822919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3822923">Error</span><span class="op" id="3822928">(</span><span class="ident" id="3822929">w</span><span class="op" id="3822930">,</span>&nbsp;<span class="ident" id="3822932">err</span><span class="op" id="3822935">.</span><span class="ident" id="3822936">Error</span><span class="op" id="3822941">(</span><span class="op" id="3822942">)</span><span class="op" id="3822943">,</span>&nbsp;<span class="ident" id="3822945">StatusInternalServerError</span><span class="op" id="3822970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3822974">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3822982">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3822986">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823019">sendSize</span>&nbsp;<span class="op" id="3823028">:=</span>&nbsp;<span class="ident" id="3823031">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823037">var</span>&nbsp;<span class="ident" id="3823041">sendContent</span>&nbsp;<span class="ident" id="3823053">io</span><span class="op" id="3823055">.</span><span class="ident" id="3823056">Reader</span>&nbsp;<span class="op" id="3823063">=</span>&nbsp;<span class="ident" id="3823065">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823074">if</span>&nbsp;<span class="ident" id="3823077">size</span>&nbsp;<span class="op" id="3823082">&gt;=</span>&nbsp;<span class="num" id="3823085">0</span>&nbsp;<span class="op" id="3823087">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823091">ranges</span><span class="op" id="3823097">,</span>&nbsp;<span class="ident" id="3823099">err</span>&nbsp;<span class="op" id="3823103">:=</span>&nbsp;<span class="ident" id="3823106">parseRange</span><span class="op" id="3823116">(</span><span class="ident" id="3823117">rangeReq</span><span class="op" id="3823125">,</span>&nbsp;<span class="ident" id="3823127">size</span><span class="op" id="3823131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823135">if</span>&nbsp;<span class="ident" id="3823138">err</span>&nbsp;<span class="op" id="3823142">!=</span>&nbsp;<span class="ident" id="3823145">nil</span>&nbsp;<span class="op" id="3823149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823154">Error</span><span class="op" id="3823159">(</span><span class="ident" id="3823160">w</span><span class="op" id="3823161">,</span>&nbsp;<span class="ident" id="3823163">err</span><span class="op" id="3823166">.</span><span class="ident" id="3823167">Error</span><span class="op" id="3823172">(</span><span class="op" id="3823173">)</span><span class="op" id="3823174">,</span>&nbsp;<span class="ident" id="3823176">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3823210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823215">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3823224">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823228">if</span>&nbsp;<span class="ident" id="3823231">sumRangesSize</span><span class="op" id="3823244">(</span><span class="ident" id="3823245">ranges</span><span class="op" id="3823251">)</span>&nbsp;<span class="op" id="3823253">&gt;</span>&nbsp;<span class="ident" id="3823255">size</span>&nbsp;<span class="op" id="3823260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823265">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823315">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823360">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823410">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3823456">ranges</span>&nbsp;<span class="op" id="3823463">=</span>&nbsp;<span class="ident" id="3823465">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3823471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823475">switch</span>&nbsp;<span class="op" id="3823482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3823486">case</span>&nbsp;<span class="builtinfunc" id="3823491">len</span><span class="op" id="3823494">(</span><span class="ident" id="3823495">ranges</span><span class="op" id="3823501">)</span>&nbsp;<span class="op" id="3823503">==</span>&nbsp;<span class="num" id="3823506">1</span><span class="op" id="3823507">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823512">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823543">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823604">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823660">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823716">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823771">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823824">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823880">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823908">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823918">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3823976">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824034">ra</span>&nbsp;<span class="op" id="3824037">:=</span>&nbsp;<span class="ident" id="3824040">ranges</span><span class="op" id="3824046">[</span><span class="num" id="3824047">0</span><span class="op" id="3824048">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824053">if</span>&nbsp;<span class="ident" id="3824056">_</span><span class="op" id="3824057">,</span>&nbsp;<span class="ident" id="3824059">err</span>&nbsp;<span class="op" id="3824063">:=</span>&nbsp;<span class="ident" id="3824066">content</span><span class="op" id="3824073">.</span><span class="ident" id="3824074">Seek</span><span class="op" id="3824078">(</span><span class="ident" id="3824079">ra</span><span class="op" id="3824081">.</span><span class="ident" id="3824082">start</span><span class="op" id="3824087">,</span>&nbsp;<span class="ident" id="3824089">os</span><span class="op" id="3824091">.</span><span class="ident" id="3824092">SEEK_SET</span><span class="op" id="3824100">)</span><span class="op" id="3824101">;</span>&nbsp;<span class="ident" id="3824103">err</span>&nbsp;<span class="op" id="3824107">!=</span>&nbsp;<span class="ident" id="3824110">nil</span>&nbsp;<span class="op" id="3824114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824120">Error</span><span class="op" id="3824125">(</span><span class="ident" id="3824126">w</span><span class="op" id="3824127">,</span>&nbsp;<span class="ident" id="3824129">err</span><span class="op" id="3824132">.</span><span class="ident" id="3824133">Error</span><span class="op" id="3824138">(</span><span class="op" id="3824139">)</span><span class="op" id="3824140">,</span>&nbsp;<span class="ident" id="3824142">StatusRequestedRangeNotSatisfiable</span><span class="op" id="3824176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824182">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3824192">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824197">sendSize</span>&nbsp;<span class="op" id="3824206">=</span>&nbsp;<span class="ident" id="3824208">ra</span><span class="op" id="3824210">.</span><span class="ident" id="3824211">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824221">code</span>&nbsp;<span class="op" id="3824226">=</span>&nbsp;<span class="ident" id="3824228">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824252">w</span><span class="op" id="3824253">.</span><span class="ident" id="3824254">Header</span><span class="op" id="3824260">(</span><span class="op" id="3824261">)</span><span class="op" id="3824262">.</span><span class="ident" id="3824263">Set</span><span class="op" id="3824266">(</span><span class="string" id="3824267">&#34;Content-Range&#34;</span><span class="op" id="3824282">,</span>&nbsp;<span class="ident" id="3824284">ra</span><span class="op" id="3824286">.</span><span class="ident" id="3824287">contentRange</span><span class="op" id="3824299">(</span><span class="ident" id="3824300">size</span><span class="op" id="3824304">)</span><span class="op" id="3824305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824309">case</span>&nbsp;<span class="builtinfunc" id="3824314">len</span><span class="op" id="3824317">(</span><span class="ident" id="3824318">ranges</span><span class="op" id="3824324">)</span>&nbsp;<span class="op" id="3824326">&gt;</span>&nbsp;<span class="num" id="3824328">1</span><span class="op" id="3824329">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824334">sendSize</span>&nbsp;<span class="op" id="3824343">=</span>&nbsp;<span class="ident" id="3824345">rangesMIMESize</span><span class="op" id="3824359">(</span><span class="ident" id="3824360">ranges</span><span class="op" id="3824366">,</span>&nbsp;<span class="ident" id="3824368">ctype</span><span class="op" id="3824373">,</span>&nbsp;<span class="ident" id="3824375">size</span><span class="op" id="3824379">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824384">code</span>&nbsp;<span class="op" id="3824389">=</span>&nbsp;<span class="ident" id="3824391">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824416">pr</span><span class="op" id="3824418">,</span>&nbsp;<span class="ident" id="3824420">pw</span>&nbsp;<span class="op" id="3824423">:=</span>&nbsp;<span class="ident" id="3824426">io</span><span class="op" id="3824428">.</span><span class="ident" id="3824429">Pipe</span><span class="op" id="3824433">(</span><span class="op" id="3824434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824439">mw</span>&nbsp;<span class="op" id="3824442">:=</span>&nbsp;<span class="ident" id="3824445">multipart</span><span class="op" id="3824454">.</span><span class="ident" id="3824455">NewWriter</span><span class="op" id="3824464">(</span><span class="ident" id="3824465">pw</span><span class="op" id="3824467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824472">w</span><span class="op" id="3824473">.</span><span class="ident" id="3824474">Header</span><span class="op" id="3824480">(</span><span class="op" id="3824481">)</span><span class="op" id="3824482">.</span><span class="ident" id="3824483">Set</span><span class="op" id="3824486">(</span><span class="string" id="3824487">&#34;Content-Type&#34;</span><span class="op" id="3824501">,</span>&nbsp;<span class="string" id="3824503">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="3824536">+</span><span class="ident" id="3824537">mw</span><span class="op" id="3824539">.</span><span class="ident" id="3824540">Boundary</span><span class="op" id="3824548">(</span><span class="op" id="3824549">)</span><span class="op" id="3824550">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824555">sendContent</span>&nbsp;<span class="op" id="3824567">=</span>&nbsp;<span class="ident" id="3824569">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824575">defer</span>&nbsp;<span class="ident" id="3824581">pr</span><span class="op" id="3824583">.</span><span class="ident" id="3824584">Close</span><span class="op" id="3824589">(</span><span class="op" id="3824590">)</span>&nbsp;<span class="comment" id="3824592">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824664">go</span>&nbsp;<span class="keyword" id="3824667">func</span><span class="op" id="3824671">(</span><span class="op" id="3824672">)</span>&nbsp;<span class="op" id="3824674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824680">for</span>&nbsp;<span class="ident" id="3824684">_</span><span class="op" id="3824685">,</span>&nbsp;<span class="ident" id="3824687">ra</span>&nbsp;<span class="op" id="3824690">:=</span>&nbsp;<span class="keyword" id="3824693">range</span>&nbsp;<span class="ident" id="3824699">ranges</span>&nbsp;<span class="op" id="3824706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824713">part</span><span class="op" id="3824717">,</span>&nbsp;<span class="ident" id="3824719">err</span>&nbsp;<span class="op" id="3824723">:=</span>&nbsp;<span class="ident" id="3824726">mw</span><span class="op" id="3824728">.</span><span class="ident" id="3824729">CreatePart</span><span class="op" id="3824739">(</span><span class="ident" id="3824740">ra</span><span class="op" id="3824742">.</span><span class="ident" id="3824743">mimeHeader</span><span class="op" id="3824753">(</span><span class="ident" id="3824754">ctype</span><span class="op" id="3824759">,</span>&nbsp;<span class="ident" id="3824761">size</span><span class="op" id="3824765">)</span><span class="op" id="3824766">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824773">if</span>&nbsp;<span class="ident" id="3824776">err</span>&nbsp;<span class="op" id="3824780">!=</span>&nbsp;<span class="ident" id="3824783">nil</span>&nbsp;<span class="op" id="3824787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824795">pw</span><span class="op" id="3824797">.</span><span class="ident" id="3824798">CloseWithError</span><span class="op" id="3824812">(</span><span class="ident" id="3824813">err</span><span class="op" id="3824816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824824">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3824836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824843">if</span>&nbsp;<span class="ident" id="3824846">_</span><span class="op" id="3824847">,</span>&nbsp;<span class="ident" id="3824849">err</span>&nbsp;<span class="op" id="3824853">:=</span>&nbsp;<span class="ident" id="3824856">content</span><span class="op" id="3824863">.</span><span class="ident" id="3824864">Seek</span><span class="op" id="3824868">(</span><span class="ident" id="3824869">ra</span><span class="op" id="3824871">.</span><span class="ident" id="3824872">start</span><span class="op" id="3824877">,</span>&nbsp;<span class="ident" id="3824879">os</span><span class="op" id="3824881">.</span><span class="ident" id="3824882">SEEK_SET</span><span class="op" id="3824890">)</span><span class="op" id="3824891">;</span>&nbsp;<span class="ident" id="3824893">err</span>&nbsp;<span class="op" id="3824897">!=</span>&nbsp;<span class="ident" id="3824900">nil</span>&nbsp;<span class="op" id="3824904">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824912">pw</span><span class="op" id="3824914">.</span><span class="ident" id="3824915">CloseWithError</span><span class="op" id="3824929">(</span><span class="ident" id="3824930">err</span><span class="op" id="3824933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824941">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3824953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3824960">if</span>&nbsp;<span class="ident" id="3824963">_</span><span class="op" id="3824964">,</span>&nbsp;<span class="ident" id="3824966">err</span>&nbsp;<span class="op" id="3824970">:=</span>&nbsp;<span class="ident" id="3824973">io</span><span class="op" id="3824975">.</span><span class="ident" id="3824976">CopyN</span><span class="op" id="3824981">(</span><span class="ident" id="3824982">part</span><span class="op" id="3824986">,</span>&nbsp;<span class="ident" id="3824988">content</span><span class="op" id="3824995">,</span>&nbsp;<span class="ident" id="3824997">ra</span><span class="op" id="3824999">.</span><span class="ident" id="3825000">length</span><span class="op" id="3825006">)</span><span class="op" id="3825007">;</span>&nbsp;<span class="ident" id="3825009">err</span>&nbsp;<span class="op" id="3825013">!=</span>&nbsp;<span class="ident" id="3825016">nil</span>&nbsp;<span class="op" id="3825020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825028">pw</span><span class="op" id="3825030">.</span><span class="ident" id="3825031">CloseWithError</span><span class="op" id="3825045">(</span><span class="ident" id="3825046">err</span><span class="op" id="3825049">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825057">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825081">mw</span><span class="op" id="3825083">.</span><span class="ident" id="3825084">Close</span><span class="op" id="3825089">(</span><span class="op" id="3825090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825096">pw</span><span class="op" id="3825098">.</span><span class="ident" id="3825099">Close</span><span class="op" id="3825104">(</span><span class="op" id="3825105">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825110">}</span><span class="op" id="3825111">(</span><span class="op" id="3825112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825121">w</span><span class="op" id="3825122">.</span><span class="ident" id="3825123">Header</span><span class="op" id="3825129">(</span><span class="op" id="3825130">)</span><span class="op" id="3825131">.</span><span class="ident" id="3825132">Set</span><span class="op" id="3825135">(</span><span class="string" id="3825136">&#34;Accept-Ranges&#34;</span><span class="op" id="3825151">,</span>&nbsp;<span class="string" id="3825153">&#34;bytes&#34;</span><span class="op" id="3825160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825164">if</span>&nbsp;<span class="ident" id="3825167">w</span><span class="op" id="3825168">.</span><span class="ident" id="3825169">Header</span><span class="op" id="3825175">(</span><span class="op" id="3825176">)</span><span class="op" id="3825177">.</span><span class="ident" id="3825178">Get</span><span class="op" id="3825181">(</span><span class="string" id="3825182">&#34;Content-Encoding&#34;</span><span class="op" id="3825200">)</span>&nbsp;<span class="op" id="3825202">==</span>&nbsp;<span class="string" id="3825205">&#34;&#34;</span>&nbsp;<span class="op" id="3825208">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825213">w</span><span class="op" id="3825214">.</span><span class="ident" id="3825215">Header</span><span class="op" id="3825221">(</span><span class="op" id="3825222">)</span><span class="op" id="3825223">.</span><span class="ident" id="3825224">Set</span><span class="op" id="3825227">(</span><span class="string" id="3825228">&#34;Content-Length&#34;</span><span class="op" id="3825244">,</span>&nbsp;<span class="ident" id="3825246">strconv</span><span class="op" id="3825253">.</span><span class="ident" id="3825254">FormatInt</span><span class="op" id="3825263">(</span><span class="ident" id="3825264">sendSize</span><span class="op" id="3825272">,</span>&nbsp;<span class="num" id="3825274">10</span><span class="op" id="3825276">)</span><span class="op" id="3825277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825288">w</span><span class="op" id="3825289">.</span><span class="ident" id="3825290">WriteHeader</span><span class="op" id="3825301">(</span><span class="ident" id="3825302">code</span><span class="op" id="3825306">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825310">if</span>&nbsp;<span class="ident" id="3825313">r</span><span class="op" id="3825314">.</span><span class="ident" id="3825315">Method</span>&nbsp;<span class="op" id="3825322">!=</span>&nbsp;<span class="string" id="3825325">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3825332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825336">io</span><span class="op" id="3825338">.</span><span class="ident" id="3825339">CopyN</span><span class="op" id="3825344">(</span><span class="ident" id="3825345">w</span><span class="op" id="3825346">,</span>&nbsp;<span class="ident" id="3825348">sendContent</span><span class="op" id="3825359">,</span>&nbsp;<span class="ident" id="3825361">sendSize</span><span class="op" id="3825369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825372">}</span><br>
<span class="lineno"></span><span class="op" id="3825374">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="3825377">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="3825456">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="3825513">func</span>&nbsp;<span class="ident" id="3825518">checkLastModified</span><span class="op" id="3825535">(</span><span class="ident" id="3825536">w</span>&nbsp;<span class="ident" id="3825538">ResponseWriter</span><span class="op" id="3825552">,</span>&nbsp;<span class="ident" id="3825554">r</span>&nbsp;<span class="op" id="3825556">*</span><span class="ident" id="3825557">Request</span><span class="op" id="3825564">,</span>&nbsp;<span class="ident" id="3825566">modtime</span>&nbsp;<span class="ident" id="3825574">time</span><span class="op" id="3825578">.</span><span class="ident" id="3825579">Time</span><span class="op" id="3825583">)</span>&nbsp;<span class="builtintype" id="3825585">bool</span>&nbsp;<span class="op" id="3825590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825593">if</span>&nbsp;<span class="ident" id="3825596">modtime</span><span class="op" id="3825603">.</span><span class="ident" id="3825604">IsZero</span><span class="op" id="3825610">(</span><span class="op" id="3825611">)</span>&nbsp;<span class="op" id="3825613">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825617">return</span>&nbsp;<span class="builtintype" id="3825624">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3825631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3825635">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3825699">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3825767">if</span>&nbsp;<span class="ident" id="3825770">t</span><span class="op" id="3825771">,</span>&nbsp;<span class="ident" id="3825773">err</span>&nbsp;<span class="op" id="3825777">:=</span>&nbsp;<span class="ident" id="3825780">time</span><span class="op" id="3825784">.</span><span class="ident" id="3825785">Parse</span><span class="op" id="3825790">(</span><span class="ident" id="3825791">TimeFormat</span><span class="op" id="3825801">,</span>&nbsp;<span class="ident" id="3825803">r</span><span class="op" id="3825804">.</span><span class="ident" id="3825805">Header</span><span class="op" id="3825811">.</span><span class="ident" id="3825812">Get</span><span class="op" id="3825815">(</span><span class="string" id="3825816">&#34;If-Modified-Since&#34;</span><span class="op" id="3825835">)</span><span class="op" id="3825836">)</span><span class="op" id="3825837">;</span>&nbsp;<span class="ident" id="3825839">err</span>&nbsp;<span class="op" id="3825843">==</span>&nbsp;<span class="ident" id="3825846">nil</span>&nbsp;<span class="op" id="3825850">&amp;&amp;</span>&nbsp;<span class="ident" id="3825853">modtime</span><span class="op" id="3825860">.</span><span class="ident" id="3825861">Before</span><span class="op" id="3825867">(</span><span class="ident" id="3825868">t</span><span class="op" id="3825869">.</span><span class="ident" id="3825870">Add</span><span class="op" id="3825873">(</span><span class="num" id="3825874">1</span><span class="op" id="3825875">*</span><span class="ident" id="3825876">time</span><span class="op" id="3825880">.</span><span class="ident" id="3825881">Second</span><span class="op" id="3825887">)</span><span class="op" id="3825888">)</span>&nbsp;<span class="op" id="3825890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825894">h</span>&nbsp;<span class="op" id="3825896">:=</span>&nbsp;<span class="ident" id="3825899">w</span><span class="op" id="3825900">.</span><span class="ident" id="3825901">Header</span><span class="op" id="3825907">(</span><span class="op" id="3825908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3825912">delete</span><span class="op" id="3825918">(</span><span class="ident" id="3825919">h</span><span class="op" id="3825920">,</span>&nbsp;<span class="string" id="3825922">&#34;Content-Type&#34;</span><span class="op" id="3825936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3825940">delete</span><span class="op" id="3825946">(</span><span class="ident" id="3825947">h</span><span class="op" id="3825948">,</span>&nbsp;<span class="string" id="3825950">&#34;Content-Length&#34;</span><span class="op" id="3825966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825970">w</span><span class="op" id="3825971">.</span><span class="ident" id="3825972">WriteHeader</span><span class="op" id="3825983">(</span><span class="ident" id="3825984">StatusNotModified</span><span class="op" id="3826001">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826005">return</span>&nbsp;<span class="builtintype" id="3826012">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3826018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826021">w</span><span class="op" id="3826022">.</span><span class="ident" id="3826023">Header</span><span class="op" id="3826029">(</span><span class="op" id="3826030">)</span><span class="op" id="3826031">.</span><span class="ident" id="3826032">Set</span><span class="op" id="3826035">(</span><span class="string" id="3826036">&#34;Last-Modified&#34;</span><span class="op" id="3826051">,</span>&nbsp;<span class="ident" id="3826053">modtime</span><span class="op" id="3826060">.</span><span class="ident" id="3826061">UTC</span><span class="op" id="3826064">(</span><span class="op" id="3826065">)</span><span class="op" id="3826066">.</span><span class="ident" id="3826067">Format</span><span class="op" id="3826073">(</span><span class="ident" id="3826074">TimeFormat</span><span class="op" id="3826084">)</span><span class="op" id="3826085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826088">return</span>&nbsp;<span class="builtintype" id="3826095">false</span><br>
<span class="lineno"></span><span class="op" id="3826101">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3826104">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="3826163">//</span><br>
<span class="lineno"></span><span class="comment" id="3826166">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3826226">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="3826295">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="3826353">//</span><br>
<span class="lineno"></span><span class="comment" id="3826356">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3826427">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="3826475">func</span>&nbsp;<span class="ident" id="3826480">checkETag</span><span class="op" id="3826489">(</span><span class="ident" id="3826490">w</span>&nbsp;<span class="ident" id="3826492">ResponseWriter</span><span class="op" id="3826506">,</span>&nbsp;<span class="ident" id="3826508">r</span>&nbsp;<span class="op" id="3826510">*</span><span class="ident" id="3826511">Request</span><span class="op" id="3826518">,</span>&nbsp;<span class="ident" id="3826520">modtime</span>&nbsp;<span class="ident" id="3826528">time</span><span class="op" id="3826532">.</span><span class="ident" id="3826533">Time</span><span class="op" id="3826537">)</span>&nbsp;<span class="op" id="3826539">(</span><span class="ident" id="3826540">rangeReq</span>&nbsp;<span class="builtintype" id="3826549">string</span><span class="op" id="3826555">,</span>&nbsp;<span class="ident" id="3826557">done</span>&nbsp;<span class="builtintype" id="3826562">bool</span><span class="op" id="3826566">)</span>&nbsp;<span class="op" id="3826568">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826571">etag</span>&nbsp;<span class="op" id="3826576">:=</span>&nbsp;<span class="ident" id="3826579">w</span><span class="op" id="3826580">.</span><span class="ident" id="3826581">Header</span><span class="op" id="3826587">(</span><span class="op" id="3826588">)</span><span class="op" id="3826589">.</span><span class="ident" id="3826590">get</span><span class="op" id="3826593">(</span><span class="string" id="3826594">&#34;Etag&#34;</span><span class="op" id="3826600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826603">rangeReq</span>&nbsp;<span class="op" id="3826612">=</span>&nbsp;<span class="ident" id="3826614">r</span><span class="op" id="3826615">.</span><span class="ident" id="3826616">Header</span><span class="op" id="3826622">.</span><span class="ident" id="3826623">get</span><span class="op" id="3826626">(</span><span class="string" id="3826627">&#34;Range&#34;</span><span class="op" id="3826634">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826638">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826707">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826737">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826820">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826839">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826874">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3826937">if</span>&nbsp;<span class="ident" id="3826940">ir</span>&nbsp;<span class="op" id="3826943">:=</span>&nbsp;<span class="ident" id="3826946">r</span><span class="op" id="3826947">.</span><span class="ident" id="3826948">Header</span><span class="op" id="3826954">.</span><span class="ident" id="3826955">get</span><span class="op" id="3826958">(</span><span class="string" id="3826959">&#34;If-Range&#34;</span><span class="op" id="3826969">)</span><span class="op" id="3826970">;</span>&nbsp;<span class="ident" id="3826972">ir</span>&nbsp;<span class="op" id="3826975">!=</span>&nbsp;<span class="string" id="3826978">&#34;&#34;</span>&nbsp;<span class="op" id="3826981">&amp;&amp;</span>&nbsp;<span class="ident" id="3826984">ir</span>&nbsp;<span class="op" id="3826987">!=</span>&nbsp;<span class="ident" id="3826990">etag</span>&nbsp;<span class="op" id="3826995">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826999">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827071">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827121">timeMatches</span>&nbsp;<span class="op" id="3827133">:=</span>&nbsp;<span class="builtintype" id="3827136">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827144">if</span>&nbsp;<span class="op" id="3827147">!</span><span class="ident" id="3827148">modtime</span><span class="op" id="3827155">.</span><span class="ident" id="3827156">IsZero</span><span class="op" id="3827162">(</span><span class="op" id="3827163">)</span>&nbsp;<span class="op" id="3827165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827170">if</span>&nbsp;<span class="ident" id="3827173">t</span><span class="op" id="3827174">,</span>&nbsp;<span class="ident" id="3827176">err</span>&nbsp;<span class="op" id="3827180">:=</span>&nbsp;<span class="ident" id="3827183">ParseTime</span><span class="op" id="3827192">(</span><span class="ident" id="3827193">ir</span><span class="op" id="3827195">)</span><span class="op" id="3827196">;</span>&nbsp;<span class="ident" id="3827198">err</span>&nbsp;<span class="op" id="3827202">==</span>&nbsp;<span class="ident" id="3827205">nil</span>&nbsp;<span class="op" id="3827209">&amp;&amp;</span>&nbsp;<span class="ident" id="3827212">t</span><span class="op" id="3827213">.</span><span class="ident" id="3827214">Unix</span><span class="op" id="3827218">(</span><span class="op" id="3827219">)</span>&nbsp;<span class="op" id="3827221">==</span>&nbsp;<span class="ident" id="3827224">modtime</span><span class="op" id="3827231">.</span><span class="ident" id="3827232">Unix</span><span class="op" id="3827236">(</span><span class="op" id="3827237">)</span>&nbsp;<span class="op" id="3827239">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827245">timeMatches</span>&nbsp;<span class="op" id="3827257">=</span>&nbsp;<span class="builtintype" id="3827259">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3827267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3827271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827275">if</span>&nbsp;<span class="op" id="3827278">!</span><span class="ident" id="3827279">timeMatches</span>&nbsp;<span class="op" id="3827291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827296">rangeReq</span>&nbsp;<span class="op" id="3827305">=</span>&nbsp;<span class="string" id="3827307">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3827312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3827315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827319">if</span>&nbsp;<span class="ident" id="3827322">inm</span>&nbsp;<span class="op" id="3827326">:=</span>&nbsp;<span class="ident" id="3827329">r</span><span class="op" id="3827330">.</span><span class="ident" id="3827331">Header</span><span class="op" id="3827337">.</span><span class="ident" id="3827338">get</span><span class="op" id="3827341">(</span><span class="string" id="3827342">&#34;If-None-Match&#34;</span><span class="op" id="3827357">)</span><span class="op" id="3827358">;</span>&nbsp;<span class="ident" id="3827360">inm</span>&nbsp;<span class="op" id="3827364">!=</span>&nbsp;<span class="string" id="3827367">&#34;&#34;</span>&nbsp;<span class="op" id="3827370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827374">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827395">if</span>&nbsp;<span class="ident" id="3827398">etag</span>&nbsp;<span class="op" id="3827403">==</span>&nbsp;<span class="string" id="3827406">&#34;&#34;</span>&nbsp;<span class="op" id="3827409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827414">return</span>&nbsp;<span class="ident" id="3827421">rangeReq</span><span class="op" id="3827429">,</span>&nbsp;<span class="builtintype" id="3827431">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3827439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827444">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827506">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827559">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827619">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827679">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827734">if</span>&nbsp;<span class="ident" id="3827737">r</span><span class="op" id="3827738">.</span><span class="ident" id="3827739">Method</span>&nbsp;<span class="op" id="3827746">!=</span>&nbsp;<span class="string" id="3827749">&#34;GET&#34;</span>&nbsp;<span class="op" id="3827755">&amp;&amp;</span>&nbsp;<span class="ident" id="3827758">r</span><span class="op" id="3827759">.</span><span class="ident" id="3827760">Method</span>&nbsp;<span class="op" id="3827767">!=</span>&nbsp;<span class="string" id="3827770">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3827777">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827782">return</span>&nbsp;<span class="ident" id="3827789">rangeReq</span><span class="op" id="3827797">,</span>&nbsp;<span class="builtintype" id="3827799">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3827807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827812">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827878">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827945">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3827973">if</span>&nbsp;<span class="ident" id="3827976">inm</span>&nbsp;<span class="op" id="3827980">==</span>&nbsp;<span class="ident" id="3827983">etag</span>&nbsp;<span class="op" id="3827988">||</span>&nbsp;<span class="ident" id="3827991">inm</span>&nbsp;<span class="op" id="3827995">==</span>&nbsp;<span class="string" id="3827998">&#34;*&#34;</span>&nbsp;<span class="op" id="3828002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828007">h</span>&nbsp;<span class="op" id="3828009">:=</span>&nbsp;<span class="ident" id="3828012">w</span><span class="op" id="3828013">.</span><span class="ident" id="3828014">Header</span><span class="op" id="3828020">(</span><span class="op" id="3828021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3828026">delete</span><span class="op" id="3828032">(</span><span class="ident" id="3828033">h</span><span class="op" id="3828034">,</span>&nbsp;<span class="string" id="3828036">&#34;Content-Type&#34;</span><span class="op" id="3828050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3828055">delete</span><span class="op" id="3828061">(</span><span class="ident" id="3828062">h</span><span class="op" id="3828063">,</span>&nbsp;<span class="string" id="3828065">&#34;Content-Length&#34;</span><span class="op" id="3828081">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828086">w</span><span class="op" id="3828087">.</span><span class="ident" id="3828088">WriteHeader</span><span class="op" id="3828099">(</span><span class="ident" id="3828100">StatusNotModified</span><span class="op" id="3828117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828122">return</span>&nbsp;<span class="string" id="3828129">&#34;&#34;</span><span class="op" id="3828131">,</span>&nbsp;<span class="builtintype" id="3828133">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828146">return</span>&nbsp;<span class="ident" id="3828153">rangeReq</span><span class="op" id="3828161">,</span>&nbsp;<span class="builtintype" id="3828163">false</span><br>
<span class="lineno">340</span><span class="op" id="3828169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3828172">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="3828222">func</span>&nbsp;<span class="ident" id="3828227">serveFile</span><span class="op" id="3828236">(</span><span class="ident" id="3828237">w</span>&nbsp;<span class="ident" id="3828239">ResponseWriter</span><span class="op" id="3828253">,</span>&nbsp;<span class="ident" id="3828255">r</span>&nbsp;<span class="op" id="3828257">*</span><span class="ident" id="3828258">Request</span><span class="op" id="3828265">,</span>&nbsp;<span class="ident" id="3828267">fs</span>&nbsp;<span class="ident" id="3828270">FileSystem</span><span class="op" id="3828280">,</span>&nbsp;<span class="ident" id="3828282">name</span>&nbsp;<span class="builtintype" id="3828287">string</span><span class="op" id="3828293">,</span>&nbsp;<span class="ident" id="3828295">redirect</span>&nbsp;<span class="builtintype" id="3828304">bool</span><span class="op" id="3828308">)</span>&nbsp;<span class="op" id="3828310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828313">const</span>&nbsp;<span class="ident" id="3828319">indexPage</span>&nbsp;<span class="op" id="3828329">=</span>&nbsp;<span class="string" id="3828331">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3828347">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3828383">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3828451">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828506">if</span>&nbsp;<span class="ident" id="3828509">strings</span><span class="op" id="3828516">.</span><span class="ident" id="3828517">HasSuffix</span><span class="op" id="3828526">(</span><span class="ident" id="3828527">r</span><span class="op" id="3828528">.</span><span class="ident" id="3828529">URL</span><span class="op" id="3828532">.</span><span class="ident" id="3828533">Path</span><span class="op" id="3828537">,</span>&nbsp;<span class="ident" id="3828539">indexPage</span><span class="op" id="3828548">)</span>&nbsp;<span class="op" id="3828550">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828554">localRedirect</span><span class="op" id="3828567">(</span><span class="ident" id="3828568">w</span><span class="op" id="3828569">,</span>&nbsp;<span class="ident" id="3828571">r</span><span class="op" id="3828572">,</span>&nbsp;<span class="string" id="3828574">&#34;./&#34;</span><span class="op" id="3828578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828582">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828594">f</span><span class="op" id="3828595">,</span>&nbsp;<span class="ident" id="3828597">err</span>&nbsp;<span class="op" id="3828601">:=</span>&nbsp;<span class="ident" id="3828604">fs</span><span class="op" id="3828606">.</span><span class="ident" id="3828607">Open</span><span class="op" id="3828611">(</span><span class="ident" id="3828612">name</span><span class="op" id="3828616">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828619">if</span>&nbsp;<span class="ident" id="3828622">err</span>&nbsp;<span class="op" id="3828626">!=</span>&nbsp;<span class="ident" id="3828629">nil</span>&nbsp;<span class="op" id="3828633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3828637">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828668">NotFound</span><span class="op" id="3828676">(</span><span class="ident" id="3828677">w</span><span class="op" id="3828678">,</span>&nbsp;<span class="ident" id="3828680">r</span><span class="op" id="3828681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828685">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828693">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828696">defer</span>&nbsp;<span class="ident" id="3828702">f</span><span class="op" id="3828703">.</span><span class="ident" id="3828704">Close</span><span class="op" id="3828709">(</span><span class="op" id="3828710">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828714">d</span><span class="op" id="3828715">,</span>&nbsp;<span class="ident" id="3828717">err1</span>&nbsp;<span class="op" id="3828722">:=</span>&nbsp;<span class="ident" id="3828725">f</span><span class="op" id="3828726">.</span><span class="ident" id="3828727">Stat</span><span class="op" id="3828731">(</span><span class="op" id="3828732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828735">if</span>&nbsp;<span class="ident" id="3828738">err1</span>&nbsp;<span class="op" id="3828743">!=</span>&nbsp;<span class="ident" id="3828746">nil</span>&nbsp;<span class="op" id="3828750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3828754">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828785">NotFound</span><span class="op" id="3828793">(</span><span class="ident" id="3828794">w</span><span class="op" id="3828795">,</span>&nbsp;<span class="ident" id="3828797">r</span><span class="op" id="3828798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828802">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3828810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828814">if</span>&nbsp;<span class="ident" id="3828817">redirect</span>&nbsp;<span class="op" id="3828826">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3828830">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3828889">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828926">url</span>&nbsp;<span class="op" id="3828930">:=</span>&nbsp;<span class="ident" id="3828933">r</span><span class="op" id="3828934">.</span><span class="ident" id="3828935">URL</span><span class="op" id="3828938">.</span><span class="ident" id="3828939">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828946">if</span>&nbsp;<span class="ident" id="3828949">d</span><span class="op" id="3828950">.</span><span class="ident" id="3828951">IsDir</span><span class="op" id="3828956">(</span><span class="op" id="3828957">)</span>&nbsp;<span class="op" id="3828959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3828964">if</span>&nbsp;<span class="ident" id="3828967">url</span><span class="op" id="3828970">[</span><span class="builtinfunc" id="3828971">len</span><span class="op" id="3828974">(</span><span class="ident" id="3828975">url</span><span class="op" id="3828978">)</span><span class="op" id="3828979">-</span><span class="num" id="3828980">1</span><span class="op" id="3828981">]</span>&nbsp;<span class="op" id="3828983">!=</span>&nbsp;<span class="string" id="3828986">&#39;/&#39;</span>&nbsp;<span class="op" id="3828990">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828996">localRedirect</span><span class="op" id="3829009">(</span><span class="ident" id="3829010">w</span><span class="op" id="3829011">,</span>&nbsp;<span class="ident" id="3829013">r</span><span class="op" id="3829014">,</span>&nbsp;<span class="ident" id="3829016">path</span><span class="op" id="3829020">.</span><span class="ident" id="3829021">Base</span><span class="op" id="3829025">(</span><span class="ident" id="3829026">url</span><span class="op" id="3829029">)</span><span class="op" id="3829030">+</span><span class="string" id="3829031">&#34;/&#34;</span><span class="op" id="3829034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829040">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829054">}</span>&nbsp;<span class="keyword" id="3829056">else</span>&nbsp;<span class="op" id="3829061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829066">if</span>&nbsp;<span class="ident" id="3829069">url</span><span class="op" id="3829072">[</span><span class="builtinfunc" id="3829073">len</span><span class="op" id="3829076">(</span><span class="ident" id="3829077">url</span><span class="op" id="3829080">)</span><span class="op" id="3829081">-</span><span class="num" id="3829082">1</span><span class="op" id="3829083">]</span>&nbsp;<span class="op" id="3829085">==</span>&nbsp;<span class="string" id="3829088">&#39;/&#39;</span>&nbsp;<span class="op" id="3829092">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829098">localRedirect</span><span class="op" id="3829111">(</span><span class="ident" id="3829112">w</span><span class="op" id="3829113">,</span>&nbsp;<span class="ident" id="3829115">r</span><span class="op" id="3829116">,</span>&nbsp;<span class="string" id="3829118">&#34;../&#34;</span><span class="op" id="3829123">+</span><span class="ident" id="3829124">path</span><span class="op" id="3829128">.</span><span class="ident" id="3829129">Base</span><span class="op" id="3829133">(</span><span class="ident" id="3829134">url</span><span class="op" id="3829137">)</span><span class="op" id="3829138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829144">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829161">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3829165">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829222">if</span>&nbsp;<span class="ident" id="3829225">d</span><span class="op" id="3829226">.</span><span class="ident" id="3829227">IsDir</span><span class="op" id="3829232">(</span><span class="op" id="3829233">)</span>&nbsp;<span class="op" id="3829235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829239">index</span>&nbsp;<span class="op" id="3829245">:=</span>&nbsp;<span class="ident" id="3829248">strings</span><span class="op" id="3829255">.</span><span class="ident" id="3829256">TrimSuffix</span><span class="op" id="3829266">(</span><span class="ident" id="3829267">name</span><span class="op" id="3829271">,</span>&nbsp;<span class="string" id="3829273">&#34;/&#34;</span><span class="op" id="3829276">)</span>&nbsp;<span class="op" id="3829278">+</span>&nbsp;<span class="ident" id="3829280">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829292">ff</span><span class="op" id="3829294">,</span>&nbsp;<span class="ident" id="3829296">err</span>&nbsp;<span class="op" id="3829300">:=</span>&nbsp;<span class="ident" id="3829303">fs</span><span class="op" id="3829305">.</span><span class="ident" id="3829306">Open</span><span class="op" id="3829310">(</span><span class="ident" id="3829311">index</span><span class="op" id="3829316">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829320">if</span>&nbsp;<span class="ident" id="3829323">err</span>&nbsp;<span class="op" id="3829327">==</span>&nbsp;<span class="ident" id="3829330">nil</span>&nbsp;<span class="op" id="3829334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829339">defer</span>&nbsp;<span class="ident" id="3829345">ff</span><span class="op" id="3829347">.</span><span class="ident" id="3829348">Close</span><span class="op" id="3829353">(</span><span class="op" id="3829354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829359">dd</span><span class="op" id="3829361">,</span>&nbsp;<span class="ident" id="3829363">err</span>&nbsp;<span class="op" id="3829367">:=</span>&nbsp;<span class="ident" id="3829370">ff</span><span class="op" id="3829372">.</span><span class="ident" id="3829373">Stat</span><span class="op" id="3829377">(</span><span class="op" id="3829378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829383">if</span>&nbsp;<span class="ident" id="3829386">err</span>&nbsp;<span class="op" id="3829390">==</span>&nbsp;<span class="ident" id="3829393">nil</span>&nbsp;<span class="op" id="3829397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829403">name</span>&nbsp;<span class="op" id="3829408">=</span>&nbsp;<span class="ident" id="3829410">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829420">d</span>&nbsp;<span class="op" id="3829422">=</span>&nbsp;<span class="ident" id="3829424">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829431">f</span>&nbsp;<span class="op" id="3829433">=</span>&nbsp;<span class="ident" id="3829435">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829448">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3829452">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829511">if</span>&nbsp;<span class="ident" id="3829514">d</span><span class="op" id="3829515">.</span><span class="ident" id="3829516">IsDir</span><span class="op" id="3829521">(</span><span class="op" id="3829522">)</span>&nbsp;<span class="op" id="3829524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829528">if</span>&nbsp;<span class="ident" id="3829531">checkLastModified</span><span class="op" id="3829548">(</span><span class="ident" id="3829549">w</span><span class="op" id="3829550">,</span>&nbsp;<span class="ident" id="3829552">r</span><span class="op" id="3829553">,</span>&nbsp;<span class="ident" id="3829555">d</span><span class="op" id="3829556">.</span><span class="ident" id="3829557">ModTime</span><span class="op" id="3829564">(</span><span class="op" id="3829565">)</span><span class="op" id="3829566">)</span>&nbsp;<span class="op" id="3829568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829573">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829586">dirList</span><span class="op" id="3829593">(</span><span class="ident" id="3829594">w</span><span class="op" id="3829595">,</span>&nbsp;<span class="ident" id="3829597">f</span><span class="op" id="3829598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829602">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3829614">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829660">sizeFunc</span>&nbsp;<span class="op" id="3829669">:=</span>&nbsp;<span class="keyword" id="3829672">func</span><span class="op" id="3829676">(</span><span class="op" id="3829677">)</span>&nbsp;<span class="op" id="3829679">(</span><span class="ident" id="3829680">int64</span><span class="op" id="3829685">,</span>&nbsp;<span class="builtintype" id="3829687">error</span><span class="op" id="3829692">)</span>&nbsp;<span class="op" id="3829694">{</span>&nbsp;<span class="keyword" id="3829696">return</span>&nbsp;<span class="ident" id="3829703">d</span><span class="op" id="3829704">.</span><span class="ident" id="3829705">Size</span><span class="op" id="3829709">(</span><span class="op" id="3829710">)</span><span class="op" id="3829711">,</span>&nbsp;<span class="ident" id="3829713">nil</span>&nbsp;<span class="op" id="3829717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829720">serveContent</span><span class="op" id="3829732">(</span><span class="ident" id="3829733">w</span><span class="op" id="3829734">,</span>&nbsp;<span class="ident" id="3829736">r</span><span class="op" id="3829737">,</span>&nbsp;<span class="ident" id="3829739">d</span><span class="op" id="3829740">.</span><span class="ident" id="3829741">Name</span><span class="op" id="3829745">(</span><span class="op" id="3829746">)</span><span class="op" id="3829747">,</span>&nbsp;<span class="ident" id="3829749">d</span><span class="op" id="3829750">.</span><span class="ident" id="3829751">ModTime</span><span class="op" id="3829758">(</span><span class="op" id="3829759">)</span><span class="op" id="3829760">,</span>&nbsp;<span class="ident" id="3829762">sizeFunc</span><span class="op" id="3829770">,</span>&nbsp;<span class="ident" id="3829772">f</span><span class="op" id="3829773">)</span><br>
<span class="lineno"></span><span class="op" id="3829775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3829778">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3829831">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="3829907">func</span>&nbsp;<span class="ident" id="3829912">localRedirect</span><span class="op" id="3829925">(</span><span class="ident" id="3829926">w</span>&nbsp;<span class="ident" id="3829928">ResponseWriter</span><span class="op" id="3829942">,</span>&nbsp;<span class="ident" id="3829944">r</span>&nbsp;<span class="op" id="3829946">*</span><span class="ident" id="3829947">Request</span><span class="op" id="3829954">,</span>&nbsp;<span class="ident" id="3829956">newPath</span>&nbsp;<span class="builtintype" id="3829964">string</span><span class="op" id="3829970">)</span>&nbsp;<span class="op" id="3829972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829975">if</span>&nbsp;<span class="ident" id="3829978">q</span>&nbsp;<span class="op" id="3829980">:=</span>&nbsp;<span class="ident" id="3829983">r</span><span class="op" id="3829984">.</span><span class="ident" id="3829985">URL</span><span class="op" id="3829988">.</span><span class="ident" id="3829989">RawQuery</span><span class="op" id="3829997">;</span>&nbsp;<span class="ident" id="3829999">q</span>&nbsp;<span class="op" id="3830001">!=</span>&nbsp;<span class="string" id="3830004">&#34;&#34;</span>&nbsp;<span class="op" id="3830007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830011">newPath</span>&nbsp;<span class="op" id="3830019">+=</span>&nbsp;<span class="string" id="3830022">&#34;?&#34;</span>&nbsp;<span class="op" id="3830026">+</span>&nbsp;<span class="ident" id="3830028">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3830031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830034">w</span><span class="op" id="3830035">.</span><span class="ident" id="3830036">Header</span><span class="op" id="3830042">(</span><span class="op" id="3830043">)</span><span class="op" id="3830044">.</span><span class="ident" id="3830045">Set</span><span class="op" id="3830048">(</span><span class="string" id="3830049">&#34;Location&#34;</span><span class="op" id="3830059">,</span>&nbsp;<span class="ident" id="3830061">newPath</span><span class="op" id="3830068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830071">w</span><span class="op" id="3830072">.</span><span class="ident" id="3830073">WriteHeader</span><span class="op" id="3830084">(</span><span class="ident" id="3830085">StatusMovedPermanently</span><span class="op" id="3830107">)</span><br>
<span class="lineno"></span><span class="op" id="3830109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="3830112">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="3830198">func</span>&nbsp;<span class="ident" id="3830203">ServeFile</span><span class="op" id="3830212">(</span><span class="ident" id="3830213">w</span>&nbsp;<span class="ident" id="3830215">ResponseWriter</span><span class="op" id="3830229">,</span>&nbsp;<span class="ident" id="3830231">r</span>&nbsp;<span class="op" id="3830233">*</span><span class="ident" id="3830234">Request</span><span class="op" id="3830241">,</span>&nbsp;<span class="ident" id="3830243">name</span>&nbsp;<span class="builtintype" id="3830248">string</span><span class="op" id="3830254">)</span>&nbsp;<span class="op" id="3830256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830259">dir</span><span class="op" id="3830262">,</span>&nbsp;<span class="ident" id="3830264">file</span>&nbsp;<span class="op" id="3830269">:=</span>&nbsp;<span class="ident" id="3830272">filepath</span><span class="op" id="3830280">.</span><span class="ident" id="3830281">Split</span><span class="op" id="3830286">(</span><span class="ident" id="3830287">name</span><span class="op" id="3830291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830294">serveFile</span><span class="op" id="3830303">(</span><span class="ident" id="3830304">w</span><span class="op" id="3830305">,</span>&nbsp;<span class="ident" id="3830307">r</span><span class="op" id="3830308">,</span>&nbsp;<span class="ident" id="3830310">Dir</span><span class="op" id="3830313">(</span><span class="ident" id="3830314">dir</span><span class="op" id="3830317">)</span><span class="op" id="3830318">,</span>&nbsp;<span class="ident" id="3830320">file</span><span class="op" id="3830324">,</span>&nbsp;<span class="builtintype" id="3830326">false</span><span class="op" id="3830331">)</span><br>
<span class="lineno"></span><span class="op" id="3830333">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3830336">type</span>&nbsp;<span class="ident" id="3830341">fileHandler</span>&nbsp;<span class="keyword" id="3830353">struct</span>&nbsp;<span class="op" id="3830360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830363">root</span>&nbsp;<span class="ident" id="3830368">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="3830379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="3830382">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3830440">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="3830496">//</span><br>
<span class="lineno"></span><span class="comment" id="3830499">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="3830560">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="3830577">//</span><br>
<span class="lineno"></span><span class="comment" id="3830580">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="3830639">func</span>&nbsp;<span class="ident" id="3830644">FileServer</span><span class="op" id="3830654">(</span><span class="ident" id="3830655">root</span>&nbsp;<span class="ident" id="3830660">FileSystem</span><span class="op" id="3830670">)</span>&nbsp;<span class="ident" id="3830672">Handler</span>&nbsp;<span class="op" id="3830680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830683">return</span>&nbsp;<span class="op" id="3830690">&amp;</span><span class="ident" id="3830691">fileHandler</span><span class="op" id="3830702">{</span><span class="ident" id="3830703">root</span><span class="op" id="3830707">}</span><br>
<span class="lineno"></span><span class="op" id="3830709">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="3830712">func</span>&nbsp;<span class="op" id="3830717">(</span><span class="ident" id="3830718">f</span>&nbsp;<span class="op" id="3830720">*</span><span class="ident" id="3830721">fileHandler</span><span class="op" id="3830732">)</span>&nbsp;<span class="ident" id="3830734">ServeHTTP</span><span class="op" id="3830743">(</span><span class="ident" id="3830744">w</span>&nbsp;<span class="ident" id="3830746">ResponseWriter</span><span class="op" id="3830760">,</span>&nbsp;<span class="ident" id="3830762">r</span>&nbsp;<span class="op" id="3830764">*</span><span class="ident" id="3830765">Request</span><span class="op" id="3830772">)</span>&nbsp;<span class="op" id="3830774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830777">upath</span>&nbsp;<span class="op" id="3830783">:=</span>&nbsp;<span class="ident" id="3830786">r</span><span class="op" id="3830787">.</span><span class="ident" id="3830788">URL</span><span class="op" id="3830791">.</span><span class="ident" id="3830792">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830798">if</span>&nbsp;<span class="op" id="3830801">!</span><span class="ident" id="3830802">strings</span><span class="op" id="3830809">.</span><span class="ident" id="3830810">HasPrefix</span><span class="op" id="3830819">(</span><span class="ident" id="3830820">upath</span><span class="op" id="3830825">,</span>&nbsp;<span class="string" id="3830827">&#34;/&#34;</span><span class="op" id="3830830">)</span>&nbsp;<span class="op" id="3830832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830836">upath</span>&nbsp;<span class="op" id="3830842">=</span>&nbsp;<span class="string" id="3830844">&#34;/&#34;</span>&nbsp;<span class="op" id="3830848">+</span>&nbsp;<span class="ident" id="3830850">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830858">r</span><span class="op" id="3830859">.</span><span class="ident" id="3830860">URL</span><span class="op" id="3830863">.</span><span class="ident" id="3830864">Path</span>&nbsp;<span class="op" id="3830869">=</span>&nbsp;<span class="ident" id="3830871">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3830878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830881">serveFile</span><span class="op" id="3830890">(</span><span class="ident" id="3830891">w</span><span class="op" id="3830892">,</span>&nbsp;<span class="ident" id="3830894">r</span><span class="op" id="3830895">,</span>&nbsp;<span class="ident" id="3830897">f</span><span class="op" id="3830898">.</span><span class="ident" id="3830899">root</span><span class="op" id="3830903">,</span>&nbsp;<span class="ident" id="3830905">path</span><span class="op" id="3830909">.</span><span class="ident" id="3830910">Clean</span><span class="op" id="3830915">(</span><span class="ident" id="3830916">upath</span><span class="op" id="3830921">)</span><span class="op" id="3830922">,</span>&nbsp;<span class="builtintype" id="3830924">true</span><span class="op" id="3830928">)</span><br>
<span class="lineno"></span><span class="op" id="3830930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="3830933">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3830997">type</span>&nbsp;<span class="ident" id="3831002">httpRange</span>&nbsp;<span class="keyword" id="3831012">struct</span>&nbsp;<span class="op" id="3831019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831022">start</span><span class="op" id="3831027">,</span>&nbsp;<span class="ident" id="3831029">length</span>&nbsp;<span class="ident" id="3831036">int64</span><br>
<span class="lineno"></span><span class="op" id="3831042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="3831045">func</span>&nbsp;<span class="op" id="3831050">(</span><span class="ident" id="3831051">r</span>&nbsp;<span class="ident" id="3831053">httpRange</span><span class="op" id="3831062">)</span>&nbsp;<span class="ident" id="3831064">contentRange</span><span class="op" id="3831076">(</span><span class="ident" id="3831077">size</span>&nbsp;<span class="ident" id="3831082">int64</span><span class="op" id="3831087">)</span>&nbsp;<span class="builtintype" id="3831089">string</span>&nbsp;<span class="op" id="3831096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831099">return</span>&nbsp;<span class="ident" id="3831106">fmt</span><span class="op" id="3831109">.</span><span class="ident" id="3831110">Sprintf</span><span class="op" id="3831117">(</span><span class="string" id="3831118">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="3831134">,</span>&nbsp;<span class="ident" id="3831136">r</span><span class="op" id="3831137">.</span><span class="ident" id="3831138">start</span><span class="op" id="3831143">,</span>&nbsp;<span class="ident" id="3831145">r</span><span class="op" id="3831146">.</span><span class="ident" id="3831147">start</span><span class="op" id="3831152">+</span><span class="ident" id="3831153">r</span><span class="op" id="3831154">.</span><span class="ident" id="3831155">length</span><span class="op" id="3831161">-</span><span class="num" id="3831162">1</span><span class="op" id="3831163">,</span>&nbsp;<span class="ident" id="3831165">size</span><span class="op" id="3831169">)</span><br>
<span class="lineno"></span><span class="op" id="3831171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3831174">func</span>&nbsp;<span class="op" id="3831179">(</span><span class="ident" id="3831180">r</span>&nbsp;<span class="ident" id="3831182">httpRange</span><span class="op" id="3831191">)</span>&nbsp;<span class="ident" id="3831193">mimeHeader</span><span class="op" id="3831203">(</span><span class="ident" id="3831204">contentType</span>&nbsp;<span class="builtintype" id="3831216">string</span><span class="op" id="3831222">,</span>&nbsp;<span class="ident" id="3831224">size</span>&nbsp;<span class="ident" id="3831229">int64</span><span class="op" id="3831234">)</span>&nbsp;<span class="ident" id="3831236">textproto</span><span class="op" id="3831245">.</span><span class="ident" id="3831246">MIMEHeader</span>&nbsp;<span class="op" id="3831257">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831260">return</span>&nbsp;<span class="ident" id="3831267">textproto</span><span class="op" id="3831276">.</span><span class="ident" id="3831277">MIMEHeader</span><span class="op" id="3831287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3831291">&#34;Content-Range&#34;</span><span class="op" id="3831306">:</span>&nbsp;<span class="op" id="3831308">{</span><span class="ident" id="3831309">r</span><span class="op" id="3831310">.</span><span class="ident" id="3831311">contentRange</span><span class="op" id="3831323">(</span><span class="ident" id="3831324">size</span><span class="op" id="3831328">)</span><span class="op" id="3831329">}</span><span class="op" id="3831330">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3831334">&#34;Content-Type&#34;</span><span class="op" id="3831348">:</span>&nbsp;&nbsp;<span class="op" id="3831351">{</span><span class="ident" id="3831352">contentType</span><span class="op" id="3831363">}</span><span class="op" id="3831364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3831367">}</span><br>
<span class="lineno"></span><span class="op" id="3831369">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="3831372">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="3831432">func</span>&nbsp;<span class="ident" id="3831437">parseRange</span><span class="op" id="3831447">(</span><span class="ident" id="3831448">s</span>&nbsp;<span class="builtintype" id="3831450">string</span><span class="op" id="3831456">,</span>&nbsp;<span class="ident" id="3831458">size</span>&nbsp;<span class="ident" id="3831463">int64</span><span class="op" id="3831468">)</span>&nbsp;<span class="op" id="3831470">(</span><span class="op" id="3831471">[</span><span class="op" id="3831472">]</span><span class="ident" id="3831473">httpRange</span><span class="op" id="3831482">,</span>&nbsp;<span class="builtintype" id="3831484">error</span><span class="op" id="3831489">)</span>&nbsp;<span class="op" id="3831491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831494">if</span>&nbsp;<span class="ident" id="3831497">s</span>&nbsp;<span class="op" id="3831499">==</span>&nbsp;<span class="string" id="3831502">&#34;&#34;</span>&nbsp;<span class="op" id="3831505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831509">return</span>&nbsp;<span class="ident" id="3831516">nil</span><span class="op" id="3831519">,</span>&nbsp;<span class="ident" id="3831521">nil</span>&nbsp;<span class="comment" id="3831525">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3831548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831551">const</span>&nbsp;<span class="ident" id="3831557">b</span>&nbsp;<span class="op" id="3831559">=</span>&nbsp;<span class="string" id="3831561">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831571">if</span>&nbsp;<span class="op" id="3831574">!</span><span class="ident" id="3831575">strings</span><span class="op" id="3831582">.</span><span class="ident" id="3831583">HasPrefix</span><span class="op" id="3831592">(</span><span class="ident" id="3831593">s</span><span class="op" id="3831594">,</span>&nbsp;<span class="ident" id="3831596">b</span><span class="op" id="3831597">)</span>&nbsp;<span class="op" id="3831599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831603">return</span>&nbsp;<span class="ident" id="3831610">nil</span><span class="op" id="3831613">,</span>&nbsp;<span class="ident" id="3831615">errors</span><span class="op" id="3831621">.</span><span class="ident" id="3831622">New</span><span class="op" id="3831625">(</span><span class="string" id="3831626">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3831641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3831644">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831647">var</span>&nbsp;<span class="ident" id="3831651">ranges</span>&nbsp;<span class="op" id="3831658">[</span><span class="op" id="3831659">]</span><span class="ident" id="3831660">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831671">for</span>&nbsp;<span class="ident" id="3831675">_</span><span class="op" id="3831676">,</span>&nbsp;<span class="ident" id="3831678">ra</span>&nbsp;<span class="op" id="3831681">:=</span>&nbsp;<span class="keyword" id="3831684">range</span>&nbsp;<span class="ident" id="3831690">strings</span><span class="op" id="3831697">.</span><span class="ident" id="3831698">Split</span><span class="op" id="3831703">(</span><span class="ident" id="3831704">s</span><span class="op" id="3831705">[</span><span class="builtinfunc" id="3831706">len</span><span class="op" id="3831709">(</span><span class="ident" id="3831710">b</span><span class="op" id="3831711">)</span><span class="op" id="3831712">:</span><span class="op" id="3831713">]</span><span class="op" id="3831714">,</span>&nbsp;<span class="string" id="3831716">&#34;,&#34;</span><span class="op" id="3831719">)</span>&nbsp;<span class="op" id="3831721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831725">ra</span>&nbsp;<span class="op" id="3831728">=</span>&nbsp;<span class="ident" id="3831730">strings</span><span class="op" id="3831737">.</span><span class="ident" id="3831738">TrimSpace</span><span class="op" id="3831747">(</span><span class="ident" id="3831748">ra</span><span class="op" id="3831750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831754">if</span>&nbsp;<span class="ident" id="3831757">ra</span>&nbsp;<span class="op" id="3831760">==</span>&nbsp;<span class="string" id="3831763">&#34;&#34;</span>&nbsp;<span class="op" id="3831766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831771">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3831782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831786">i</span>&nbsp;<span class="op" id="3831788">:=</span>&nbsp;<span class="ident" id="3831791">strings</span><span class="op" id="3831798">.</span><span class="ident" id="3831799">Index</span><span class="op" id="3831804">(</span><span class="ident" id="3831805">ra</span><span class="op" id="3831807">,</span>&nbsp;<span class="string" id="3831809">&#34;-&#34;</span><span class="op" id="3831812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831816">if</span>&nbsp;<span class="ident" id="3831819">i</span>&nbsp;<span class="op" id="3831821">&lt;</span>&nbsp;<span class="num" id="3831823">0</span>&nbsp;<span class="op" id="3831825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831830">return</span>&nbsp;<span class="ident" id="3831837">nil</span><span class="op" id="3831840">,</span>&nbsp;<span class="ident" id="3831842">errors</span><span class="op" id="3831848">.</span><span class="ident" id="3831849">New</span><span class="op" id="3831852">(</span><span class="string" id="3831853">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3831868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3831872">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831876">start</span><span class="op" id="3831881">,</span>&nbsp;<span class="ident" id="3831883">end</span>&nbsp;<span class="op" id="3831887">:=</span>&nbsp;<span class="ident" id="3831890">strings</span><span class="op" id="3831897">.</span><span class="ident" id="3831898">TrimSpace</span><span class="op" id="3831907">(</span><span class="ident" id="3831908">ra</span><span class="op" id="3831910">[</span><span class="op" id="3831911">:</span><span class="ident" id="3831912">i</span><span class="op" id="3831913">]</span><span class="op" id="3831914">)</span><span class="op" id="3831915">,</span>&nbsp;<span class="ident" id="3831917">strings</span><span class="op" id="3831924">.</span><span class="ident" id="3831925">TrimSpace</span><span class="op" id="3831934">(</span><span class="ident" id="3831935">ra</span><span class="op" id="3831937">[</span><span class="ident" id="3831938">i</span><span class="op" id="3831939">+</span><span class="num" id="3831940">1</span><span class="op" id="3831941">:</span><span class="op" id="3831942">]</span><span class="op" id="3831943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831947">var</span>&nbsp;<span class="ident" id="3831951">r</span>&nbsp;<span class="ident" id="3831953">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3831965">if</span>&nbsp;<span class="ident" id="3831968">start</span>&nbsp;<span class="op" id="3831974">==</span>&nbsp;<span class="string" id="3831977">&#34;&#34;</span>&nbsp;<span class="op" id="3831980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3831985">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832035">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832086">i</span><span class="op" id="3832087">,</span>&nbsp;<span class="ident" id="3832089">err</span>&nbsp;<span class="op" id="3832093">:=</span>&nbsp;<span class="ident" id="3832096">strconv</span><span class="op" id="3832103">.</span><span class="ident" id="3832104">ParseInt</span><span class="op" id="3832112">(</span><span class="ident" id="3832113">end</span><span class="op" id="3832116">,</span>&nbsp;<span class="num" id="3832118">10</span><span class="op" id="3832120">,</span>&nbsp;<span class="num" id="3832122">64</span><span class="op" id="3832124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832129">if</span>&nbsp;<span class="ident" id="3832132">err</span>&nbsp;<span class="op" id="3832136">!=</span>&nbsp;<span class="ident" id="3832139">nil</span>&nbsp;<span class="op" id="3832143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832149">return</span>&nbsp;<span class="ident" id="3832156">nil</span><span class="op" id="3832159">,</span>&nbsp;<span class="ident" id="3832161">errors</span><span class="op" id="3832167">.</span><span class="ident" id="3832168">New</span><span class="op" id="3832171">(</span><span class="string" id="3832172">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3832187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832197">if</span>&nbsp;<span class="ident" id="3832200">i</span>&nbsp;<span class="op" id="3832202">&gt;</span>&nbsp;<span class="ident" id="3832204">size</span>&nbsp;<span class="op" id="3832209">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832215">i</span>&nbsp;<span class="op" id="3832217">=</span>&nbsp;<span class="ident" id="3832219">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832232">r</span><span class="op" id="3832233">.</span><span class="ident" id="3832234">start</span>&nbsp;<span class="op" id="3832240">=</span>&nbsp;<span class="ident" id="3832242">size</span>&nbsp;<span class="op" id="3832247">-</span>&nbsp;<span class="ident" id="3832249">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832254">r</span><span class="op" id="3832255">.</span><span class="ident" id="3832256">length</span>&nbsp;<span class="op" id="3832263">=</span>&nbsp;<span class="ident" id="3832265">size</span>&nbsp;<span class="op" id="3832270">-</span>&nbsp;<span class="ident" id="3832272">r</span><span class="op" id="3832273">.</span><span class="ident" id="3832274">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832282">}</span>&nbsp;<span class="keyword" id="3832284">else</span>&nbsp;<span class="op" id="3832289">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832294">i</span><span class="op" id="3832295">,</span>&nbsp;<span class="ident" id="3832297">err</span>&nbsp;<span class="op" id="3832301">:=</span>&nbsp;<span class="ident" id="3832304">strconv</span><span class="op" id="3832311">.</span><span class="ident" id="3832312">ParseInt</span><span class="op" id="3832320">(</span><span class="ident" id="3832321">start</span><span class="op" id="3832326">,</span>&nbsp;<span class="num" id="3832328">10</span><span class="op" id="3832330">,</span>&nbsp;<span class="num" id="3832332">64</span><span class="op" id="3832334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832339">if</span>&nbsp;<span class="ident" id="3832342">err</span>&nbsp;<span class="op" id="3832346">!=</span>&nbsp;<span class="ident" id="3832349">nil</span>&nbsp;<span class="op" id="3832353">||</span>&nbsp;<span class="ident" id="3832356">i</span>&nbsp;<span class="op" id="3832358">&gt;</span>&nbsp;<span class="ident" id="3832360">size</span>&nbsp;<span class="op" id="3832365">||</span>&nbsp;<span class="ident" id="3832368">i</span>&nbsp;<span class="op" id="3832370">&lt;</span>&nbsp;<span class="num" id="3832372">0</span>&nbsp;<span class="op" id="3832374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832380">return</span>&nbsp;<span class="ident" id="3832387">nil</span><span class="op" id="3832390">,</span>&nbsp;<span class="ident" id="3832392">errors</span><span class="op" id="3832398">.</span><span class="ident" id="3832399">New</span><span class="op" id="3832402">(</span><span class="string" id="3832403">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3832418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832428">r</span><span class="op" id="3832429">.</span><span class="ident" id="3832430">start</span>&nbsp;<span class="op" id="3832436">=</span>&nbsp;<span class="ident" id="3832438">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832443">if</span>&nbsp;<span class="ident" id="3832446">end</span>&nbsp;<span class="op" id="3832450">==</span>&nbsp;<span class="string" id="3832453">&#34;&#34;</span>&nbsp;<span class="op" id="3832456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832462">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832527">r</span><span class="op" id="3832528">.</span><span class="ident" id="3832529">length</span>&nbsp;<span class="op" id="3832536">=</span>&nbsp;<span class="ident" id="3832538">size</span>&nbsp;<span class="op" id="3832543">-</span>&nbsp;<span class="ident" id="3832545">r</span><span class="op" id="3832546">.</span><span class="ident" id="3832547">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832556">}</span>&nbsp;<span class="keyword" id="3832558">else</span>&nbsp;<span class="op" id="3832563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832569">i</span><span class="op" id="3832570">,</span>&nbsp;<span class="ident" id="3832572">err</span>&nbsp;<span class="op" id="3832576">:=</span>&nbsp;<span class="ident" id="3832579">strconv</span><span class="op" id="3832586">.</span><span class="ident" id="3832587">ParseInt</span><span class="op" id="3832595">(</span><span class="ident" id="3832596">end</span><span class="op" id="3832599">,</span>&nbsp;<span class="num" id="3832601">10</span><span class="op" id="3832603">,</span>&nbsp;<span class="num" id="3832605">64</span><span class="op" id="3832607">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832613">if</span>&nbsp;<span class="ident" id="3832616">err</span>&nbsp;<span class="op" id="3832620">!=</span>&nbsp;<span class="ident" id="3832623">nil</span>&nbsp;<span class="op" id="3832627">||</span>&nbsp;<span class="ident" id="3832630">r</span><span class="op" id="3832631">.</span><span class="ident" id="3832632">start</span>&nbsp;<span class="op" id="3832638">&gt;</span>&nbsp;<span class="ident" id="3832640">i</span>&nbsp;<span class="op" id="3832642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832649">return</span>&nbsp;<span class="ident" id="3832656">nil</span><span class="op" id="3832659">,</span>&nbsp;<span class="ident" id="3832661">errors</span><span class="op" id="3832667">.</span><span class="ident" id="3832668">New</span><span class="op" id="3832671">(</span><span class="string" id="3832672">&#34;invalid&nbsp;range&#34;</span><span class="op" id="3832687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832699">if</span>&nbsp;<span class="ident" id="3832702">i</span>&nbsp;<span class="op" id="3832704">&gt;=</span>&nbsp;<span class="ident" id="3832707">size</span>&nbsp;<span class="op" id="3832712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832719">i</span>&nbsp;<span class="op" id="3832721">=</span>&nbsp;<span class="ident" id="3832723">size</span>&nbsp;<span class="op" id="3832728">-</span>&nbsp;<span class="num" id="3832730">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832742">r</span><span class="op" id="3832743">.</span><span class="ident" id="3832744">length</span>&nbsp;<span class="op" id="3832751">=</span>&nbsp;<span class="ident" id="3832753">i</span>&nbsp;<span class="op" id="3832755">-</span>&nbsp;<span class="ident" id="3832757">r</span><span class="op" id="3832758">.</span><span class="ident" id="3832759">start</span>&nbsp;<span class="op" id="3832765">+</span>&nbsp;<span class="num" id="3832767">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832780">ranges</span>&nbsp;<span class="op" id="3832787">=</span>&nbsp;<span class="builtinfunc" id="3832789">append</span><span class="op" id="3832795">(</span><span class="ident" id="3832796">ranges</span><span class="op" id="3832802">,</span>&nbsp;<span class="ident" id="3832804">r</span><span class="op" id="3832805">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832811">return</span>&nbsp;<span class="ident" id="3832818">ranges</span><span class="op" id="3832824">,</span>&nbsp;<span class="ident" id="3832826">nil</span><br>
<span class="lineno"></span><span class="op" id="3832830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3832833">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="3832898">type</span>&nbsp;<span class="ident" id="3832903">countingWriter</span>&nbsp;<span class="ident" id="3832918">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3832925">func</span>&nbsp;<span class="op" id="3832930">(</span><span class="ident" id="3832931">w</span>&nbsp;<span class="op" id="3832933">*</span><span class="ident" id="3832934">countingWriter</span><span class="op" id="3832948">)</span>&nbsp;<span class="ident" id="3832950">Write</span><span class="op" id="3832955">(</span><span class="ident" id="3832956">p</span>&nbsp;<span class="op" id="3832958">[</span><span class="op" id="3832959">]</span><span class="builtintype" id="3832960">byte</span><span class="op" id="3832964">)</span>&nbsp;<span class="op" id="3832966">(</span><span class="ident" id="3832967">n</span>&nbsp;<span class="builtintype" id="3832969">int</span><span class="op" id="3832972">,</span>&nbsp;<span class="ident" id="3832974">err</span>&nbsp;<span class="builtintype" id="3832978">error</span><span class="op" id="3832983">)</span>&nbsp;<span class="op" id="3832985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832988">*</span><span class="ident" id="3832989">w</span>&nbsp;<span class="op" id="3832991">+=</span>&nbsp;<span class="ident" id="3832994">countingWriter</span><span class="op" id="3833008">(</span><span class="builtinfunc" id="3833009">len</span><span class="op" id="3833012">(</span><span class="ident" id="3833013">p</span><span class="op" id="3833014">)</span><span class="op" id="3833015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833018">return</span>&nbsp;<span class="builtinfunc" id="3833025">len</span><span class="op" id="3833028">(</span><span class="ident" id="3833029">p</span><span class="op" id="3833030">)</span><span class="op" id="3833031">,</span>&nbsp;<span class="ident" id="3833033">nil</span><br>
<span class="lineno">535</span><span class="op" id="3833037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3833040">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3833109">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3833153">func</span>&nbsp;<span class="ident" id="3833158">rangesMIMESize</span><span class="op" id="3833172">(</span><span class="ident" id="3833173">ranges</span>&nbsp;<span class="op" id="3833180">[</span><span class="op" id="3833181">]</span><span class="ident" id="3833182">httpRange</span><span class="op" id="3833191">,</span>&nbsp;<span class="ident" id="3833193">contentType</span>&nbsp;<span class="builtintype" id="3833205">string</span><span class="op" id="3833211">,</span>&nbsp;<span class="ident" id="3833213">contentSize</span>&nbsp;<span class="ident" id="3833225">int64</span><span class="op" id="3833230">)</span>&nbsp;<span class="op" id="3833232">(</span><span class="ident" id="3833233">encSize</span>&nbsp;<span class="ident" id="3833241">int64</span><span class="op" id="3833246">)</span>&nbsp;<span class="op" id="3833248">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833251">var</span>&nbsp;<span class="ident" id="3833255">w</span>&nbsp;<span class="ident" id="3833257">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833273">mw</span>&nbsp;<span class="op" id="3833276">:=</span>&nbsp;<span class="ident" id="3833279">multipart</span><span class="op" id="3833288">.</span><span class="ident" id="3833289">NewWriter</span><span class="op" id="3833298">(</span><span class="op" id="3833299">&amp;</span><span class="ident" id="3833300">w</span><span class="op" id="3833301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833304">for</span>&nbsp;<span class="ident" id="3833308">_</span><span class="op" id="3833309">,</span>&nbsp;<span class="ident" id="3833311">ra</span>&nbsp;<span class="op" id="3833314">:=</span>&nbsp;<span class="keyword" id="3833317">range</span>&nbsp;<span class="ident" id="3833323">ranges</span>&nbsp;<span class="op" id="3833330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833334">mw</span><span class="op" id="3833336">.</span><span class="ident" id="3833337">CreatePart</span><span class="op" id="3833347">(</span><span class="ident" id="3833348">ra</span><span class="op" id="3833350">.</span><span class="ident" id="3833351">mimeHeader</span><span class="op" id="3833361">(</span><span class="ident" id="3833362">contentType</span><span class="op" id="3833373">,</span>&nbsp;<span class="ident" id="3833375">contentSize</span><span class="op" id="3833386">)</span><span class="op" id="3833387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833391">encSize</span>&nbsp;<span class="op" id="3833399">+=</span>&nbsp;<span class="ident" id="3833402">ra</span><span class="op" id="3833404">.</span><span class="ident" id="3833405">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3833413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833416">mw</span><span class="op" id="3833418">.</span><span class="ident" id="3833419">Close</span><span class="op" id="3833424">(</span><span class="op" id="3833425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833428">encSize</span>&nbsp;<span class="op" id="3833436">+=</span>&nbsp;<span class="ident" id="3833439">int64</span><span class="op" id="3833444">(</span><span class="ident" id="3833445">w</span><span class="op" id="3833446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833449">return</span><br>
<span class="lineno"></span><span class="op" id="3833456">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="3833459">func</span>&nbsp;<span class="ident" id="3833464">sumRangesSize</span><span class="op" id="3833477">(</span><span class="ident" id="3833478">ranges</span>&nbsp;<span class="op" id="3833485">[</span><span class="op" id="3833486">]</span><span class="ident" id="3833487">httpRange</span><span class="op" id="3833496">)</span>&nbsp;<span class="op" id="3833498">(</span><span class="ident" id="3833499">size</span>&nbsp;<span class="ident" id="3833504">int64</span><span class="op" id="3833509">)</span>&nbsp;<span class="op" id="3833511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833514">for</span>&nbsp;<span class="ident" id="3833518">_</span><span class="op" id="3833519">,</span>&nbsp;<span class="ident" id="3833521">ra</span>&nbsp;<span class="op" id="3833524">:=</span>&nbsp;<span class="keyword" id="3833527">range</span>&nbsp;<span class="ident" id="3833533">ranges</span>&nbsp;<span class="op" id="3833540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833544">size</span>&nbsp;<span class="op" id="3833549">+=</span>&nbsp;<span class="ident" id="3833552">ra</span><span class="op" id="3833554">.</span><span class="ident" id="3833555">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3833563">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3833566">return</span><br>
<span class="lineno"></span><span class="op" id="3833573">}</span>
</div>
</body>
</html>
