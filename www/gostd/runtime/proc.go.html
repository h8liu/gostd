<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html" class="current">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1617345">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1617400">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1617454">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1617505">package</span>&nbsp;<span class="ident" id="1617513">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1617522">import</span>&nbsp;<span class="string" id="1617529">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1617539">func</span>&nbsp;<span class="ident" id="1617544">newsysmon</span><span class="op" id="1617553">(</span><span class="op" id="1617554">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1617557">func</span>&nbsp;<span class="ident" id="1617562">runtime_init</span><span class="op" id="1617574">(</span><span class="op" id="1617575">)</span><br>
<span class="lineno"></span><span class="keyword" id="1617577">func</span>&nbsp;<span class="ident" id="1617582">main_init</span><span class="op" id="1617591">(</span><span class="op" id="1617592">)</span><br>
<span class="lineno"></span><span class="keyword" id="1617594">func</span>&nbsp;<span class="ident" id="1617599">main_main</span><span class="op" id="1617608">(</span><span class="op" id="1617609">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="1617612">//&nbsp;The&nbsp;main&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1617635">func</span>&nbsp;<span class="ident" id="1617640">main</span><span class="op" id="1617644">(</span><span class="op" id="1617645">)</span>&nbsp;<span class="op" id="1617647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617650">g</span>&nbsp;<span class="op" id="1617652">:=</span>&nbsp;<span class="ident" id="1617655">getg</span><span class="op" id="1617659">(</span><span class="op" id="1617660">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1617664">//&nbsp;Racectx&nbsp;of&nbsp;m0-&gt;g0&nbsp;is&nbsp;used&nbsp;only&nbsp;as&nbsp;the&nbsp;parent&nbsp;of&nbsp;the&nbsp;main&nbsp;goroutine.</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1617736">//&nbsp;It&nbsp;must&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;anything&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617779">g</span><span class="op" id="1617780">.</span><span class="ident" id="1617781">m</span><span class="op" id="1617782">.</span><span class="ident" id="1617783">g0</span><span class="op" id="1617785">.</span><span class="ident" id="1617786">racectx</span>&nbsp;<span class="op" id="1617794">=</span>&nbsp;<span class="num" id="1617796">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1617800">//&nbsp;Max&nbsp;stack&nbsp;size&nbsp;is&nbsp;1&nbsp;GB&nbsp;on&nbsp;64-bit,&nbsp;250&nbsp;MB&nbsp;on&nbsp;32-bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1617856">//&nbsp;Using&nbsp;decimal&nbsp;instead&nbsp;of&nbsp;binary&nbsp;GB&nbsp;and&nbsp;MB&nbsp;because</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1617910">//&nbsp;they&nbsp;look&nbsp;nicer&nbsp;in&nbsp;the&nbsp;stack&nbsp;overflow&nbsp;failure&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1617969">if</span>&nbsp;<span class="ident" id="1617972">ptrSize</span>&nbsp;<span class="op" id="1617980">==</span>&nbsp;<span class="num" id="1617983">8</span>&nbsp;<span class="op" id="1617985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1617989">maxstacksize</span>&nbsp;<span class="op" id="1618002">=</span>&nbsp;<span class="num" id="1618004">1000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618016">}</span>&nbsp;<span class="keyword" id="1618018">else</span>&nbsp;<span class="op" id="1618023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618027">maxstacksize</span>&nbsp;<span class="op" id="1618040">=</span>&nbsp;<span class="num" id="1618042">250000000</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618057">onM</span><span class="op" id="1618060">(</span><span class="ident" id="1618061">newsysmon</span><span class="op" id="1618070">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618074">//&nbsp;Lock&nbsp;the&nbsp;main&nbsp;goroutine&nbsp;onto&nbsp;this,&nbsp;the&nbsp;main&nbsp;OS&nbsp;thread,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618133">//&nbsp;during&nbsp;initialization.&nbsp;&nbsp;Most&nbsp;programs&nbsp;won&#39;t&nbsp;care,&nbsp;but&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618197">//&nbsp;do&nbsp;require&nbsp;certain&nbsp;calls&nbsp;to&nbsp;be&nbsp;made&nbsp;by&nbsp;the&nbsp;main&nbsp;thread.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618257">//&nbsp;Those&nbsp;can&nbsp;arrange&nbsp;for&nbsp;main.main&nbsp;to&nbsp;run&nbsp;in&nbsp;the&nbsp;main&nbsp;thread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618319">//&nbsp;by&nbsp;calling&nbsp;runtime.LockOSThread&nbsp;during&nbsp;initialization</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618377">//&nbsp;to&nbsp;preserve&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618403">lockOSThread</span><span class="op" id="1618415">(</span><span class="op" id="1618416">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618420">if</span>&nbsp;<span class="ident" id="1618423">g</span><span class="op" id="1618424">.</span><span class="ident" id="1618425">m</span>&nbsp;<span class="op" id="1618427">!=</span>&nbsp;<span class="op" id="1618430">&amp;</span><span class="ident" id="1618431">m0</span>&nbsp;<span class="op" id="1618434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618438">gothrow</span><span class="op" id="1618445">(</span><span class="string" id="1618446">&#34;runtime.main&nbsp;not&nbsp;on&nbsp;m0&#34;</span><span class="op" id="1618470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618473">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618477">runtime_init</span><span class="op" id="1618489">(</span><span class="op" id="1618490">)</span>&nbsp;<span class="comment" id="1618492">//&nbsp;must&nbsp;be&nbsp;before&nbsp;defer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618518">//&nbsp;Defer&nbsp;unlock&nbsp;so&nbsp;that&nbsp;runtime.Goexit&nbsp;during&nbsp;init&nbsp;does&nbsp;the&nbsp;unlock&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618591">needUnlock</span>&nbsp;<span class="op" id="1618602">:=</span>&nbsp;<span class="builtintype" id="1618605">true</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618611">defer</span>&nbsp;<span class="keyword" id="1618617">func</span><span class="op" id="1618621">(</span><span class="op" id="1618622">)</span>&nbsp;<span class="op" id="1618624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618628">if</span>&nbsp;<span class="ident" id="1618631">needUnlock</span>&nbsp;<span class="op" id="1618642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618647">unlockOSThread</span><span class="op" id="1618661">(</span><span class="op" id="1618662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618669">}</span><span class="op" id="1618670">(</span><span class="op" id="1618671">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618675">memstats</span><span class="op" id="1618683">.</span><span class="ident" id="1618684">enablegc</span>&nbsp;<span class="op" id="1618693">=</span>&nbsp;<span class="builtintype" id="1618695">true</span>&nbsp;<span class="comment" id="1618700">//&nbsp;now&nbsp;that&nbsp;runtime&nbsp;is&nbsp;initialized,&nbsp;GC&nbsp;is&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618749">main_init</span><span class="op" id="1618758">(</span><span class="op" id="1618759">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618763">needUnlock</span>&nbsp;<span class="op" id="1618774">=</span>&nbsp;<span class="builtintype" id="1618776">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618783">unlockOSThread</span><span class="op" id="1618797">(</span><span class="op" id="1618798">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618802">main_main</span><span class="op" id="1618811">(</span><span class="op" id="1618812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1618815">if</span>&nbsp;<span class="ident" id="1618818">raceenabled</span>&nbsp;<span class="op" id="1618830">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618834">racefini</span><span class="op" id="1618842">(</span><span class="op" id="1618843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1618846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618850">//&nbsp;Make&nbsp;racy&nbsp;client&nbsp;program&nbsp;work:&nbsp;if&nbsp;panicking&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618901">//&nbsp;another&nbsp;goroutine&nbsp;at&nbsp;the&nbsp;same&nbsp;time&nbsp;as&nbsp;main&nbsp;returns,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618957">//&nbsp;let&nbsp;the&nbsp;other&nbsp;goroutine&nbsp;finish&nbsp;printing&nbsp;the&nbsp;panic&nbsp;trace.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1619018">//&nbsp;Once&nbsp;it&nbsp;does,&nbsp;it&nbsp;will&nbsp;exit.&nbsp;See&nbsp;issue&nbsp;3934.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619066">if</span>&nbsp;<span class="ident" id="1619069">panicking</span>&nbsp;<span class="op" id="1619079">!=</span>&nbsp;<span class="num" id="1619082">0</span>&nbsp;<span class="op" id="1619084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619088">gopark</span><span class="op" id="1619094">(</span><span class="ident" id="1619095">nil</span><span class="op" id="1619098">,</span>&nbsp;<span class="ident" id="1619100">nil</span><span class="op" id="1619103">,</span>&nbsp;<span class="string" id="1619105">&#34;panicwait&#34;</span><span class="op" id="1619116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619119">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619123">exit</span><span class="op" id="1619127">(</span><span class="num" id="1619128">0</span><span class="op" id="1619129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619132">for</span>&nbsp;<span class="op" id="1619136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619140">var</span>&nbsp;<span class="ident" id="1619144">x</span>&nbsp;<span class="op" id="1619146">*</span><span class="builtintype" id="1619147">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619155">*</span><span class="ident" id="1619156">x</span>&nbsp;<span class="op" id="1619158">=</span>&nbsp;<span class="num" id="1619160">0</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619163">}</span><br>
<span class="lineno"></span><span class="op" id="1619165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1619168">var</span>&nbsp;<span class="ident" id="1619172">parkunlock_c</span>&nbsp;<span class="builtintype" id="1619185">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1619191">//&nbsp;start&nbsp;forcegc&nbsp;helper&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="keyword" id="1619225">func</span>&nbsp;<span class="ident" id="1619230">init</span><span class="op" id="1619234">(</span><span class="op" id="1619235">)</span>&nbsp;<span class="op" id="1619237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619240">go</span>&nbsp;<span class="ident" id="1619243">forcegchelper</span><span class="op" id="1619256">(</span><span class="op" id="1619257">)</span><br>
<span class="lineno"></span><span class="op" id="1619259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1619262">func</span>&nbsp;<span class="ident" id="1619267">forcegchelper</span><span class="op" id="1619280">(</span><span class="op" id="1619281">)</span>&nbsp;<span class="op" id="1619283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619286">forcegc</span><span class="op" id="1619293">.</span><span class="ident" id="1619294">g</span>&nbsp;<span class="op" id="1619296">=</span>&nbsp;<span class="ident" id="1619298">getg</span><span class="op" id="1619302">(</span><span class="op" id="1619303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619306">forcegc</span><span class="op" id="1619313">.</span><span class="ident" id="1619314">g</span><span class="op" id="1619315">.</span><span class="ident" id="1619316">issystem</span>&nbsp;<span class="op" id="1619325">=</span>&nbsp;<span class="builtintype" id="1619327">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619333">for</span>&nbsp;<span class="op" id="1619337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619341">lock</span><span class="op" id="1619345">(</span><span class="op" id="1619346">&amp;</span><span class="ident" id="1619347">forcegc</span><span class="op" id="1619354">.</span><span class="ident" id="1619355">lock</span><span class="op" id="1619359">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619363">if</span>&nbsp;<span class="ident" id="1619366">forcegc</span><span class="op" id="1619373">.</span><span class="ident" id="1619374">idle</span>&nbsp;<span class="op" id="1619379">!=</span>&nbsp;<span class="num" id="1619382">0</span>&nbsp;<span class="op" id="1619384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619389">gothrow</span><span class="op" id="1619396">(</span><span class="string" id="1619397">&#34;forcegc:&nbsp;phase&nbsp;error&#34;</span><span class="op" id="1619419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619427">atomicstore</span><span class="op" id="1619438">(</span><span class="op" id="1619439">&amp;</span><span class="ident" id="1619440">forcegc</span><span class="op" id="1619447">.</span><span class="ident" id="1619448">idle</span><span class="op" id="1619452">,</span>&nbsp;<span class="num" id="1619454">1</span><span class="op" id="1619455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619459">goparkunlock</span><span class="op" id="1619471">(</span><span class="op" id="1619472">&amp;</span><span class="ident" id="1619473">forcegc</span><span class="op" id="1619480">.</span><span class="ident" id="1619481">lock</span><span class="op" id="1619485">,</span>&nbsp;<span class="string" id="1619487">&#34;force&nbsp;gc&nbsp;(idle)&#34;</span><span class="op" id="1619504">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1619508">//&nbsp;this&nbsp;goroutine&nbsp;is&nbsp;explicitly&nbsp;resumed&nbsp;by&nbsp;sysmon</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1619560">if</span>&nbsp;<span class="ident" id="1619563">debug</span><span class="op" id="1619568">.</span><span class="ident" id="1619569">gctrace</span>&nbsp;<span class="op" id="1619577">&gt;</span>&nbsp;<span class="num" id="1619579">0</span>&nbsp;<span class="op" id="1619581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1619586">println</span><span class="op" id="1619593">(</span><span class="string" id="1619594">&#34;GC&nbsp;forced&#34;</span><span class="op" id="1619605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619613">gogc</span><span class="op" id="1619617">(</span><span class="num" id="1619618">1</span><span class="op" id="1619619">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619622">}</span><br>
<span class="lineno"></span><span class="op" id="1619624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1619627">//go:nosplit</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="1619641">//&nbsp;Gosched&nbsp;yields&nbsp;the&nbsp;processor,&nbsp;allowing&nbsp;other&nbsp;goroutines&nbsp;to&nbsp;run.&nbsp;&nbsp;It&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1619721">//&nbsp;suspend&nbsp;the&nbsp;current&nbsp;goroutine,&nbsp;so&nbsp;execution&nbsp;resumes&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="1619791">func</span>&nbsp;<span class="ident" id="1619796">Gosched</span><span class="op" id="1619803">(</span><span class="op" id="1619804">)</span>&nbsp;<span class="op" id="1619806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1619809">mcall</span><span class="op" id="1619814">(</span><span class="ident" id="1619815">gosched_m</span><span class="op" id="1619824">)</span><br>
<span class="lineno"></span><span class="op" id="1619826">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="1619829">//&nbsp;Puts&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;into&nbsp;a&nbsp;waiting&nbsp;state&nbsp;and&nbsp;calls&nbsp;unlockf.</span><br>
<span class="lineno"></span><span class="comment" id="1619899">//&nbsp;If&nbsp;unlockf&nbsp;returns&nbsp;false,&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;resumed.</span><br>
<span class="lineno"></span><span class="keyword" id="1619954">func</span>&nbsp;<span class="ident" id="1619959">gopark</span><span class="op" id="1619965">(</span><span class="ident" id="1619966">unlockf</span>&nbsp;<span class="ident" id="1619974">unsafe</span><span class="op" id="1619980">.</span><span class="ident" id="1619981">Pointer</span><span class="op" id="1619988">,</span>&nbsp;<span class="ident" id="1619990">lock</span>&nbsp;<span class="ident" id="1619995">unsafe</span><span class="op" id="1620001">.</span><span class="ident" id="1620002">Pointer</span><span class="op" id="1620009">,</span>&nbsp;<span class="ident" id="1620011">reason</span>&nbsp;<span class="builtintype" id="1620018">string</span><span class="op" id="1620024">)</span>&nbsp;<span class="op" id="1620026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620029">mp</span>&nbsp;<span class="op" id="1620032">:=</span>&nbsp;<span class="ident" id="1620035">acquirem</span><span class="op" id="1620043">(</span><span class="op" id="1620044">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620047">gp</span>&nbsp;<span class="op" id="1620050">:=</span>&nbsp;<span class="ident" id="1620053">mp</span><span class="op" id="1620055">.</span><span class="ident" id="1620056">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620062">status</span>&nbsp;<span class="op" id="1620069">:=</span>&nbsp;<span class="ident" id="1620072">readgstatus</span><span class="op" id="1620083">(</span><span class="ident" id="1620084">gp</span><span class="op" id="1620086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1620089">if</span>&nbsp;<span class="ident" id="1620092">status</span>&nbsp;<span class="op" id="1620099">!=</span>&nbsp;<span class="ident" id="1620102">_Grunning</span>&nbsp;<span class="op" id="1620112">&amp;&amp;</span>&nbsp;<span class="ident" id="1620115">status</span>&nbsp;<span class="op" id="1620122">!=</span>&nbsp;<span class="ident" id="1620125">_Gscanrunning</span>&nbsp;<span class="op" id="1620139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620143">gothrow</span><span class="op" id="1620150">(</span><span class="string" id="1620151">&#34;gopark:&nbsp;bad&nbsp;g&nbsp;status&#34;</span><span class="op" id="1620173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1620176">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620179">mp</span><span class="op" id="1620181">.</span><span class="ident" id="1620182">waitlock</span>&nbsp;<span class="op" id="1620191">=</span>&nbsp;<span class="ident" id="1620193">lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620199">mp</span><span class="op" id="1620201">.</span><span class="ident" id="1620202">waitunlockf</span>&nbsp;<span class="op" id="1620214">=</span>&nbsp;<span class="ident" id="1620216">unlockf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620225">gp</span><span class="op" id="1620227">.</span><span class="ident" id="1620228">waitreason</span>&nbsp;<span class="op" id="1620239">=</span>&nbsp;<span class="ident" id="1620241">reason</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620249">releasem</span><span class="op" id="1620257">(</span><span class="ident" id="1620258">mp</span><span class="op" id="1620260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1620263">//&nbsp;can&#39;t&nbsp;do&nbsp;anything&nbsp;that&nbsp;might&nbsp;move&nbsp;the&nbsp;G&nbsp;between&nbsp;Ms&nbsp;here.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620324">mcall</span><span class="op" id="1620329">(</span><span class="ident" id="1620330">park_m</span><span class="op" id="1620336">)</span><br>
<span class="lineno"></span><span class="op" id="1620338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1620341">//&nbsp;Puts&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;into&nbsp;a&nbsp;waiting&nbsp;state&nbsp;and&nbsp;unlocks&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1620414">//&nbsp;The&nbsp;goroutine&nbsp;can&nbsp;be&nbsp;made&nbsp;runnable&nbsp;again&nbsp;by&nbsp;calling&nbsp;goready(gp).</span><br>
<span class="lineno">135</span><span class="keyword" id="1620482">func</span>&nbsp;<span class="ident" id="1620487">goparkunlock</span><span class="op" id="1620499">(</span><span class="ident" id="1620500">lock</span>&nbsp;<span class="op" id="1620505">*</span><span class="ident" id="1620506">mutex</span><span class="op" id="1620511">,</span>&nbsp;<span class="ident" id="1620513">reason</span>&nbsp;<span class="builtintype" id="1620520">string</span><span class="op" id="1620526">)</span>&nbsp;<span class="op" id="1620528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620531">gopark</span><span class="op" id="1620537">(</span><span class="ident" id="1620538">unsafe</span><span class="op" id="1620544">.</span><span class="ident" id="1620545">Pointer</span><span class="op" id="1620552">(</span><span class="op" id="1620553">&amp;</span><span class="ident" id="1620554">parkunlock_c</span><span class="op" id="1620566">)</span><span class="op" id="1620567">,</span>&nbsp;<span class="ident" id="1620569">unsafe</span><span class="op" id="1620575">.</span><span class="ident" id="1620576">Pointer</span><span class="op" id="1620583">(</span><span class="ident" id="1620584">lock</span><span class="op" id="1620588">)</span><span class="op" id="1620589">,</span>&nbsp;<span class="ident" id="1620591">reason</span><span class="op" id="1620597">)</span><br>
<span class="lineno"></span><span class="op" id="1620599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1620602">func</span>&nbsp;<span class="ident" id="1620607">goready</span><span class="op" id="1620614">(</span><span class="ident" id="1620615">gp</span>&nbsp;<span class="op" id="1620618">*</span><span class="ident" id="1620619">g</span><span class="op" id="1620620">)</span>&nbsp;<span class="op" id="1620622">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620625">mp</span>&nbsp;<span class="op" id="1620628">:=</span>&nbsp;<span class="ident" id="1620631">acquirem</span><span class="op" id="1620639">(</span><span class="op" id="1620640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620643">mp</span><span class="op" id="1620645">.</span><span class="ident" id="1620646">ptrarg</span><span class="op" id="1620652">[</span><span class="num" id="1620653">0</span><span class="op" id="1620654">]</span>&nbsp;<span class="op" id="1620656">=</span>&nbsp;<span class="ident" id="1620658">unsafe</span><span class="op" id="1620664">.</span><span class="ident" id="1620665">Pointer</span><span class="op" id="1620672">(</span><span class="ident" id="1620673">gp</span><span class="op" id="1620675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620678">onM</span><span class="op" id="1620681">(</span><span class="ident" id="1620682">ready_m</span><span class="op" id="1620689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620692">releasem</span><span class="op" id="1620700">(</span><span class="ident" id="1620701">mp</span><span class="op" id="1620703">)</span><br>
<span class="lineno"></span><span class="op" id="1620705">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1620708">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1620721">func</span>&nbsp;<span class="ident" id="1620726">acquireSudog</span><span class="op" id="1620738">(</span><span class="op" id="1620739">)</span>&nbsp;<span class="op" id="1620741">*</span><span class="ident" id="1620742">sudog</span>&nbsp;<span class="op" id="1620748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620751">c</span>&nbsp;<span class="op" id="1620753">:=</span>&nbsp;<span class="ident" id="1620756">gomcache</span><span class="op" id="1620764">(</span><span class="op" id="1620765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620768">s</span>&nbsp;<span class="op" id="1620770">:=</span>&nbsp;<span class="ident" id="1620773">c</span><span class="op" id="1620774">.</span><span class="ident" id="1620775">sudogcache</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1620787">if</span>&nbsp;<span class="ident" id="1620790">s</span>&nbsp;<span class="op" id="1620792">!=</span>&nbsp;<span class="ident" id="1620795">nil</span>&nbsp;<span class="op" id="1620799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1620803">if</span>&nbsp;<span class="ident" id="1620806">s</span><span class="op" id="1620807">.</span><span class="ident" id="1620808">elem</span>&nbsp;<span class="op" id="1620813">!=</span>&nbsp;<span class="ident" id="1620816">nil</span>&nbsp;<span class="op" id="1620820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620825">gothrow</span><span class="op" id="1620832">(</span><span class="string" id="1620833">&#34;acquireSudog:&nbsp;found&nbsp;s.elem&nbsp;!=&nbsp;nil&nbsp;in&nbsp;cache&#34;</span><span class="op" id="1620877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1620881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620885">c</span><span class="op" id="1620886">.</span><span class="ident" id="1620887">sudogcache</span>&nbsp;<span class="op" id="1620898">=</span>&nbsp;<span class="ident" id="1620900">s</span><span class="op" id="1620901">.</span><span class="ident" id="1620902">next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1620909">s</span><span class="op" id="1620910">.</span><span class="ident" id="1620911">next</span>&nbsp;<span class="op" id="1620916">=</span>&nbsp;<span class="ident" id="1620918">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1620924">return</span>&nbsp;<span class="ident" id="1620931">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1620934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1620938">//&nbsp;Delicate&nbsp;dance:&nbsp;the&nbsp;semaphore&nbsp;implementation&nbsp;calls</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1620993">//&nbsp;acquireSudog,&nbsp;acquireSudog&nbsp;calls&nbsp;new(sudog),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1621042">//&nbsp;new&nbsp;calls&nbsp;malloc,&nbsp;malloc&nbsp;can&nbsp;call&nbsp;the&nbsp;garbage&nbsp;collector,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1621103">//&nbsp;and&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;calls&nbsp;the&nbsp;semaphore&nbsp;implementation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1621168">//&nbsp;in&nbsp;stoptheworld.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1621189">//&nbsp;Break&nbsp;the&nbsp;cycle&nbsp;by&nbsp;doing&nbsp;acquirem/releasem&nbsp;around&nbsp;new(sudog).</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1621255">//&nbsp;The&nbsp;acquirem/releasem&nbsp;increments&nbsp;m.locks&nbsp;during&nbsp;new(sudog),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1621319">//&nbsp;which&nbsp;keeps&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;from&nbsp;being&nbsp;invoked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621377">mp</span>&nbsp;<span class="op" id="1621380">:=</span>&nbsp;<span class="ident" id="1621383">acquirem</span><span class="op" id="1621391">(</span><span class="op" id="1621392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621395">p</span>&nbsp;<span class="op" id="1621397">:=</span>&nbsp;<span class="builtinfunc" id="1621400">new</span><span class="op" id="1621403">(</span><span class="ident" id="1621404">sudog</span><span class="op" id="1621409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621412">releasem</span><span class="op" id="1621420">(</span><span class="ident" id="1621421">mp</span><span class="op" id="1621423">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1621426">return</span>&nbsp;<span class="ident" id="1621433">p</span><br>
<span class="lineno"></span><span class="op" id="1621435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1621438">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1621451">func</span>&nbsp;<span class="ident" id="1621456">releaseSudog</span><span class="op" id="1621468">(</span><span class="ident" id="1621469">s</span>&nbsp;<span class="op" id="1621471">*</span><span class="ident" id="1621472">sudog</span><span class="op" id="1621477">)</span>&nbsp;<span class="op" id="1621479">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1621482">if</span>&nbsp;<span class="ident" id="1621485">s</span><span class="op" id="1621486">.</span><span class="ident" id="1621487">elem</span>&nbsp;<span class="op" id="1621492">!=</span>&nbsp;<span class="ident" id="1621495">nil</span>&nbsp;<span class="op" id="1621499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621503">gothrow</span><span class="op" id="1621510">(</span><span class="string" id="1621511">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;elem&#34;</span><span class="op" id="1621545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1621548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1621551">if</span>&nbsp;<span class="ident" id="1621554">s</span><span class="op" id="1621555">.</span><span class="ident" id="1621556">selectdone</span>&nbsp;<span class="op" id="1621567">!=</span>&nbsp;<span class="ident" id="1621570">nil</span>&nbsp;<span class="op" id="1621574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621578">gothrow</span><span class="op" id="1621585">(</span><span class="string" id="1621586">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;selectdone&#34;</span><span class="op" id="1621626">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1621629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1621632">if</span>&nbsp;<span class="ident" id="1621635">s</span><span class="op" id="1621636">.</span><span class="ident" id="1621637">next</span>&nbsp;<span class="op" id="1621642">!=</span>&nbsp;<span class="ident" id="1621645">nil</span>&nbsp;<span class="op" id="1621649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621653">gothrow</span><span class="op" id="1621660">(</span><span class="string" id="1621661">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;next&#34;</span><span class="op" id="1621695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1621698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1621701">if</span>&nbsp;<span class="ident" id="1621704">s</span><span class="op" id="1621705">.</span><span class="ident" id="1621706">prev</span>&nbsp;<span class="op" id="1621711">!=</span>&nbsp;<span class="ident" id="1621714">nil</span>&nbsp;<span class="op" id="1621718">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621722">gothrow</span><span class="op" id="1621729">(</span><span class="string" id="1621730">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;prev&#34;</span><span class="op" id="1621764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1621767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1621770">if</span>&nbsp;<span class="ident" id="1621773">s</span><span class="op" id="1621774">.</span><span class="ident" id="1621775">waitlink</span>&nbsp;<span class="op" id="1621784">!=</span>&nbsp;<span class="ident" id="1621787">nil</span>&nbsp;<span class="op" id="1621791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621795">gothrow</span><span class="op" id="1621802">(</span><span class="string" id="1621803">&#34;runtime:&nbsp;sudog&nbsp;with&nbsp;non-nil&nbsp;waitlink&#34;</span><span class="op" id="1621841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1621844">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621847">gp</span>&nbsp;<span class="op" id="1621850">:=</span>&nbsp;<span class="ident" id="1621853">getg</span><span class="op" id="1621857">(</span><span class="op" id="1621858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1621861">if</span>&nbsp;<span class="ident" id="1621864">gp</span><span class="op" id="1621866">.</span><span class="ident" id="1621867">param</span>&nbsp;<span class="op" id="1621873">!=</span>&nbsp;<span class="ident" id="1621876">nil</span>&nbsp;<span class="op" id="1621880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621884">gothrow</span><span class="op" id="1621891">(</span><span class="string" id="1621892">&#34;runtime:&nbsp;releaseSudog&nbsp;with&nbsp;non-nil&nbsp;gp.param&#34;</span><span class="op" id="1621937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1621940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621943">c</span>&nbsp;<span class="op" id="1621945">:=</span>&nbsp;<span class="ident" id="1621948">gomcache</span><span class="op" id="1621956">(</span><span class="op" id="1621957">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621960">s</span><span class="op" id="1621961">.</span><span class="ident" id="1621962">next</span>&nbsp;<span class="op" id="1621967">=</span>&nbsp;<span class="ident" id="1621969">c</span><span class="op" id="1621970">.</span><span class="ident" id="1621971">sudogcache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1621983">c</span><span class="op" id="1621984">.</span><span class="ident" id="1621985">sudogcache</span>&nbsp;<span class="op" id="1621996">=</span>&nbsp;<span class="ident" id="1621998">s</span><br>
<span class="lineno"></span><span class="op" id="1622000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1622003">//&nbsp;funcPC&nbsp;returns&nbsp;the&nbsp;entry&nbsp;PC&nbsp;of&nbsp;the&nbsp;function&nbsp;f.</span><br>
<span class="lineno">200</span><span class="comment" id="1622053">//&nbsp;It&nbsp;assumes&nbsp;that&nbsp;f&nbsp;is&nbsp;a&nbsp;func&nbsp;value.&nbsp;Otherwise&nbsp;the&nbsp;behavior&nbsp;is&nbsp;undefined.</span><br>
<span class="lineno"></span><span class="comment" id="1622128">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1622141">func</span>&nbsp;<span class="ident" id="1622146">funcPC</span><span class="op" id="1622152">(</span><span class="ident" id="1622153">f</span>&nbsp;<span class="keyword" id="1622155">interface</span><span class="op" id="1622164">{</span><span class="op" id="1622165">}</span><span class="op" id="1622166">)</span>&nbsp;<span class="builtintype" id="1622168">uintptr</span>&nbsp;<span class="op" id="1622176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1622179">return</span>&nbsp;<span class="op" id="1622186">*</span><span class="op" id="1622187">*</span><span class="op" id="1622188">(</span><span class="op" id="1622189">*</span><span class="op" id="1622190">*</span><span class="builtintype" id="1622191">uintptr</span><span class="op" id="1622198">)</span><span class="op" id="1622199">(</span><span class="ident" id="1622200">add</span><span class="op" id="1622203">(</span><span class="ident" id="1622204">unsafe</span><span class="op" id="1622210">.</span><span class="ident" id="1622211">Pointer</span><span class="op" id="1622218">(</span><span class="op" id="1622219">&amp;</span><span class="ident" id="1622220">f</span><span class="op" id="1622221">)</span><span class="op" id="1622222">,</span>&nbsp;<span class="ident" id="1622224">ptrSize</span><span class="op" id="1622231">)</span><span class="op" id="1622232">)</span><br>
<span class="lineno"></span><span class="op" id="1622234">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="1622237">//&nbsp;called&nbsp;from&nbsp;assembly</span><br>
<span class="lineno"></span><span class="keyword" id="1622261">func</span>&nbsp;<span class="ident" id="1622266">badmcall</span><span class="op" id="1622274">(</span><span class="ident" id="1622275">fn</span>&nbsp;<span class="keyword" id="1622278">func</span><span class="op" id="1622282">(</span><span class="op" id="1622283">*</span><span class="ident" id="1622284">g</span><span class="op" id="1622285">)</span><span class="op" id="1622286">)</span>&nbsp;<span class="op" id="1622288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1622291">gothrow</span><span class="op" id="1622298">(</span><span class="string" id="1622299">&#34;runtime:&nbsp;mcall&nbsp;called&nbsp;on&nbsp;m-&gt;g0&nbsp;stack&#34;</span><span class="op" id="1622337">)</span><br>
<span class="lineno"></span><span class="op" id="1622339">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="1622342">func</span>&nbsp;<span class="ident" id="1622347">badmcall2</span><span class="op" id="1622356">(</span><span class="ident" id="1622357">fn</span>&nbsp;<span class="keyword" id="1622360">func</span><span class="op" id="1622364">(</span><span class="op" id="1622365">*</span><span class="ident" id="1622366">g</span><span class="op" id="1622367">)</span><span class="op" id="1622368">)</span>&nbsp;<span class="op" id="1622370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1622373">gothrow</span><span class="op" id="1622380">(</span><span class="string" id="1622381">&#34;runtime:&nbsp;mcall&nbsp;function&nbsp;returned&#34;</span><span class="op" id="1622415">)</span><br>
<span class="lineno"></span><span class="op" id="1622417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="1622420">func</span>&nbsp;<span class="ident" id="1622425">badreflectcall</span><span class="op" id="1622439">(</span><span class="op" id="1622440">)</span>&nbsp;<span class="op" id="1622442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1622445">panic</span><span class="op" id="1622450">(</span><span class="string" id="1622451">&#34;runtime:&nbsp;arg&nbsp;size&nbsp;to&nbsp;reflect.call&nbsp;more&nbsp;than&nbsp;1GB&#34;</span><span class="op" id="1622500">)</span><br>
<span class="lineno"></span><span class="op" id="1622502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1622505">func</span>&nbsp;<span class="ident" id="1622510">lockedOSThread</span><span class="op" id="1622524">(</span><span class="op" id="1622525">)</span>&nbsp;<span class="builtintype" id="1622527">bool</span>&nbsp;<span class="op" id="1622532">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1622535">gp</span>&nbsp;<span class="op" id="1622538">:=</span>&nbsp;<span class="ident" id="1622541">getg</span><span class="op" id="1622545">(</span><span class="op" id="1622546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1622549">return</span>&nbsp;<span class="ident" id="1622556">gp</span><span class="op" id="1622558">.</span><span class="ident" id="1622559">lockedm</span>&nbsp;<span class="op" id="1622567">!=</span>&nbsp;<span class="ident" id="1622570">nil</span>&nbsp;<span class="op" id="1622574">&amp;&amp;</span>&nbsp;<span class="ident" id="1622577">gp</span><span class="op" id="1622579">.</span><span class="ident" id="1622580">m</span><span class="op" id="1622581">.</span><span class="ident" id="1622582">lockedg</span>&nbsp;<span class="op" id="1622590">!=</span>&nbsp;<span class="ident" id="1622593">nil</span><br>
<span class="lineno"></span><span class="op" id="1622597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1622600">func</span>&nbsp;<span class="ident" id="1622605">newP</span><span class="op" id="1622609">(</span><span class="op" id="1622610">)</span>&nbsp;<span class="op" id="1622612">*</span><span class="ident" id="1622613">p</span>&nbsp;<span class="op" id="1622615">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1622618">return</span>&nbsp;<span class="builtinfunc" id="1622625">new</span><span class="op" id="1622628">(</span><span class="ident" id="1622629">p</span><span class="op" id="1622630">)</span><br>
<span class="lineno"></span><span class="op" id="1622632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1622635">func</span>&nbsp;<span class="ident" id="1622640">newM</span><span class="op" id="1622644">(</span><span class="op" id="1622645">)</span>&nbsp;<span class="op" id="1622647">*</span><span class="ident" id="1622648">m</span>&nbsp;<span class="op" id="1622650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1622653">return</span>&nbsp;<span class="builtinfunc" id="1622660">new</span><span class="op" id="1622663">(</span><span class="ident" id="1622664">m</span><span class="op" id="1622665">)</span><br>
<span class="lineno">230</span><span class="op" id="1622667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1622670">func</span>&nbsp;<span class="ident" id="1622675">newG</span><span class="op" id="1622679">(</span><span class="op" id="1622680">)</span>&nbsp;<span class="op" id="1622682">*</span><span class="ident" id="1622683">g</span>&nbsp;<span class="op" id="1622685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1622688">return</span>&nbsp;<span class="builtinfunc" id="1622695">new</span><span class="op" id="1622698">(</span><span class="ident" id="1622699">g</span><span class="op" id="1622700">)</span><br>
<span class="lineno"></span><span class="op" id="1622702">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="keyword" id="1622705">func</span>&nbsp;<span class="ident" id="1622710">allgadd</span><span class="op" id="1622717">(</span><span class="ident" id="1622718">gp</span>&nbsp;<span class="op" id="1622721">*</span><span class="ident" id="1622722">g</span><span class="op" id="1622723">)</span>&nbsp;<span class="op" id="1622725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1622728">if</span>&nbsp;<span class="ident" id="1622731">readgstatus</span><span class="op" id="1622742">(</span><span class="ident" id="1622743">gp</span><span class="op" id="1622745">)</span>&nbsp;<span class="op" id="1622747">==</span>&nbsp;<span class="ident" id="1622750">_Gidle</span>&nbsp;<span class="op" id="1622757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1622761">gothrow</span><span class="op" id="1622768">(</span><span class="string" id="1622769">&#34;allgadd:&nbsp;bad&nbsp;status&nbsp;Gidle&#34;</span><span class="op" id="1622796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1622799">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1622803">lock</span><span class="op" id="1622807">(</span><span class="op" id="1622808">&amp;</span><span class="ident" id="1622809">allglock</span><span class="op" id="1622817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1622820">allgs</span>&nbsp;<span class="op" id="1622826">=</span>&nbsp;<span class="builtinfunc" id="1622828">append</span><span class="op" id="1622834">(</span><span class="ident" id="1622835">allgs</span><span class="op" id="1622840">,</span>&nbsp;<span class="ident" id="1622842">gp</span><span class="op" id="1622844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1622847">allg</span>&nbsp;<span class="op" id="1622852">=</span>&nbsp;<span class="op" id="1622854">&amp;</span><span class="ident" id="1622855">allgs</span><span class="op" id="1622860">[</span><span class="num" id="1622861">0</span><span class="op" id="1622862">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1622865">allglen</span>&nbsp;<span class="op" id="1622873">=</span>&nbsp;<span class="builtintype" id="1622875">uintptr</span><span class="op" id="1622882">(</span><span class="builtinfunc" id="1622883">len</span><span class="op" id="1622886">(</span><span class="ident" id="1622887">allgs</span><span class="op" id="1622892">)</span><span class="op" id="1622893">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1622896">unlock</span><span class="op" id="1622902">(</span><span class="op" id="1622903">&amp;</span><span class="ident" id="1622904">allglock</span><span class="op" id="1622912">)</span><br>
<span class="lineno"></span><span class="op" id="1622914">}</span>
</div>
</body>
</html>
