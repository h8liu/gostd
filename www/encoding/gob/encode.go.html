<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword">const</span>&nbsp;<span class="ident">uint64Size</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">encHelper</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">encoderState</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sendZero</span>&nbsp;<span class="builtintype">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fieldnum</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="num">1</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">uint64Size</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="comment">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">encBuffer</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">scratch</span>&nbsp;<span class="op">[</span><span class="num">64</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">)</span>&nbsp;<span class="ident">WriteByte</span><span class="op">(</span><span class="ident">c</span>&nbsp;<span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">data</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">data</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">)</span>&nbsp;<span class="ident">Write</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">data</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">data</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">)</span>&nbsp;<span class="ident">WriteString</span><span class="op">(</span><span class="ident">s</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">data</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">data</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno">50</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">)</span>&nbsp;<span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">e</span><span class="op">.</span><span class="ident">data</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">)</span>&nbsp;<span class="ident">Bytes</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">data</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">)</span>&nbsp;<span class="ident">Reset</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">data</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">data</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">enc</span>&nbsp;<span class="op">*</span><span class="ident">Encoder</span><span class="op">)</span>&nbsp;<span class="ident">newEncoderState</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">encoderState</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">enc</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">freeList</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><span class="op">.</span><span class="ident">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">.</span><span class="ident">data</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">data</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">scratch</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">e</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">enc</span>&nbsp;<span class="op">*</span><span class="ident">Encoder</span><span class="op">)</span>&nbsp;<span class="ident">freeEncoderState</span><span class="op">(</span><span class="ident">e</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span><span class="op">.</span><span class="ident">next</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">freeList</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">e</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">)</span>&nbsp;<span class="ident">encodeUint</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">uint64</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0x7F</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">WriteByte</span><span class="op">(</span><span class="builtintype">uint8</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">uint8</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">uint64Size</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">buf</span><span class="op">[</span><span class="ident">i</span>&nbsp;<span class="op">:</span>&nbsp;<span class="ident">uint64Size</span><span class="op">+</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">105</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">)</span>&nbsp;<span class="ident">encodeInt</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="ident">int64</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="ident">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="op">^</span><span class="ident">i</span><span class="op">&lt;&lt;</span><span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">|</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">uint64</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">encOp</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">encInstr</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">field</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">index</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">int</span>&nbsp;<span class="comment">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">indir</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">)</span>&nbsp;<span class="ident">update</span><span class="op">(</span><span class="ident">instr</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">instr</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="ident">instr</span><span class="op">.</span><span class="ident">field</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">instr</span><span class="op">.</span><span class="ident">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword">func</span>&nbsp;<span class="ident">encIndirect</span><span class="op">(</span><span class="ident">pv</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">,</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">;</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">indir</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">pv</span><span class="op">.</span><span class="ident">IsNil</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pv</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">pv</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">pv</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">encBool</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Bool</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">encInt</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Int</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeInt</span><span class="op">(</span><span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">180</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">encUint</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Uint</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">floatBits</span><span class="op">(</span><span class="ident">f</span>&nbsp;<span class="builtintype">float64</span><span class="op">)</span>&nbsp;<span class="ident">uint64</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">Float64bits</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">8</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">&lt;&lt;=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="ident">u</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="num">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">u</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">v</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">encFloat</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Float</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">floatBits</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">bits</span><span class="op">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword">func</span>&nbsp;<span class="ident">encComplex</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Complex</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span><span class="op">+</span><span class="num">0i</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rpart</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">floatBits</span><span class="op">(</span><span class="builtinfunc">real</span><span class="op">(</span><span class="ident">c</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ipart</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">floatBits</span><span class="op">(</span><span class="builtinfunc">imag</span><span class="op">(</span><span class="ident">c</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">rpart</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">ipart</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">encUint8Array</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Bytes</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">240</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">encString</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword">func</span>&nbsp;<span class="ident">encStructTerminator</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">encEngine</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">encInstr</span><br>
<span class="lineno">265</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">singletonField</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">valid</span><span class="op">(</span><span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Invalid</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">!</span><span class="ident">v</span><span class="op">.</span><span class="ident">IsNil</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">enc</span>&nbsp;<span class="op">*</span><span class="ident">Encoder</span><span class="op">)</span>&nbsp;<span class="ident">encodeSingle</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">,</span>&nbsp;<span class="ident">engine</span>&nbsp;<span class="op">*</span><span class="ident">encEngine</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">newEncoderState</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">freeEncoderState</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">[</span><span class="ident">singletonField</span><span class="op">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">instr</span><span class="op">.</span><span class="ident">indir</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">encIndirect</span><span class="op">(</span><span class="ident">value</span><span class="op">,</span>&nbsp;<span class="ident">instr</span><span class="op">.</span><span class="ident">indir</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">valid</span><span class="op">(</span><span class="ident">value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span><span class="op">.</span><span class="ident">op</span><span class="op">(</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">enc</span>&nbsp;<span class="op">*</span><span class="ident">Encoder</span><span class="op">)</span>&nbsp;<span class="ident">encodeStruct</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">,</span>&nbsp;<span class="ident">engine</span>&nbsp;<span class="op">*</span><span class="ident">encEngine</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">valid</span><span class="op">(</span><span class="ident">value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">newEncoderState</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">freeEncoderState</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">NumField</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span><span class="op">.</span><span class="ident">op</span><span class="op">(</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">{</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">field</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">FieldByIndex</span><span class="op">(</span><span class="ident">instr</span><span class="op">.</span><span class="ident">index</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">instr</span><span class="op">.</span><span class="ident">indir</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">field</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">encIndirect</span><span class="op">(</span><span class="ident">field</span><span class="op">,</span>&nbsp;<span class="ident">instr</span><span class="op">.</span><span class="ident">indir</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">valid</span><span class="op">(</span><span class="ident">field</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">instr</span><span class="op">.</span><span class="ident">op</span><span class="op">(</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">field</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">enc</span>&nbsp;<span class="op">*</span><span class="ident">Encoder</span><span class="op">)</span>&nbsp;<span class="ident">encodeArray</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">,</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="ident">encOp</span><span class="op">,</span>&nbsp;<span class="ident">elemIndir</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">length</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">helper</span>&nbsp;<span class="ident">encHelper</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">newEncoderState</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">freeEncoderState</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="ident">length</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">helper</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">helper</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">length</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elem</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Index</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">elemIndir</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elem</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">encIndirect</span><span class="op">(</span><span class="ident">elem</span><span class="op">,</span>&nbsp;<span class="ident">elemIndir</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">valid</span><span class="op">(</span><span class="ident">elem</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span><span class="op">(</span><span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">elem</span><span class="op">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">encodeReflectValue</span><span class="op">(</span><span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">,</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="ident">encOp</span><span class="op">,</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">IsValid</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Indirect</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">v</span><span class="op">.</span><span class="ident">IsValid</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span><span class="op">(</span><span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">enc</span>&nbsp;<span class="op">*</span><span class="ident">Encoder</span><span class="op">)</span>&nbsp;<span class="ident">encodeMap</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">,</span>&nbsp;<span class="ident">mv</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">,</span>&nbsp;<span class="ident">keyOp</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span>&nbsp;<span class="ident">encOp</span><span class="op">,</span>&nbsp;<span class="ident">keyIndir</span><span class="op">,</span>&nbsp;<span class="ident">elemIndir</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">newEncoderState</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keys</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mv</span><span class="op">.</span><span class="ident">MapKeys</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">keys</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">key</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">keys</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">encodeReflectValue</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">key</span><span class="op">,</span>&nbsp;<span class="ident">keyOp</span><span class="op">,</span>&nbsp;<span class="ident">keyIndir</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">encodeReflectValue</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">mv</span><span class="op">.</span><span class="ident">MapIndex</span><span class="op">(</span><span class="ident">key</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">elemIndir</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">freeEncoderState</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">enc</span>&nbsp;<span class="op">*</span><span class="ident">Encoder</span><span class="op">)</span>&nbsp;<span class="ident">encodeInterface</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">,</span>&nbsp;<span class="ident">iv</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elem</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">iv</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">elem</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">elem</span><span class="op">.</span><span class="ident">IsNil</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">newEncoderState</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">iv</span><span class="op">.</span><span class="ident">IsNil</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">iv</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">registerLock</span><span class="op">.</span><span class="ident">RLock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">name</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">concreteTypeToName</span><span class="op">[</span><span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">registerLock</span><span class="op">.</span><span class="ident">RUnlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">sendTypeDescriptor</span><span class="op">(</span><span class="ident">enc</span><span class="op">.</span><span class="ident">writer</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">sendTypeId</span><span class="op">(</span><span class="ident">state</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">pushWriter</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">encBuffer</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">spaceForLength</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">encode</span><span class="op">(</span><span class="ident">data</span><span class="op">,</span>&nbsp;<span class="ident">elem</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">enc</span><span class="op">.</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">popWriter</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">writeMessage</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">data</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">enc</span><span class="op">.</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">freeEncoderState</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword">func</span>&nbsp;<span class="ident">isZero</span><span class="op">(</span><span class="ident">val</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">val</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Array</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">val</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">isZero</span><span class="op">(</span><span class="ident">val</span><span class="op">.</span><span class="ident">Index</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Map</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Slice</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">String</span><span class="op">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">val</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Bool</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">!</span><span class="ident">val</span><span class="op">.</span><span class="ident">Bool</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Complex64</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Complex128</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">val</span><span class="op">.</span><span class="ident">Complex</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Chan</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Func</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Interface</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Ptr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">val</span><span class="op">.</span><span class="ident">IsNil</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int8</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int16</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int32</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int64</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">val</span><span class="op">.</span><span class="ident">Int</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Float32</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Float64</span><span class="op">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">val</span><span class="op">.</span><span class="ident">Float</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint8</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint16</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint32</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint64</span><span class="op">,</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uintptr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">val</span><span class="op">.</span><span class="ident">Uint</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Struct</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">val</span><span class="op">.</span><span class="ident">NumField</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">isZero</span><span class="op">(</span><span class="ident">val</span><span class="op">.</span><span class="ident">Field</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">val</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">enc</span>&nbsp;<span class="op">*</span><span class="ident">Encoder</span><span class="op">)</span>&nbsp;<span class="ident">encodeGobEncoder</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">,</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">data</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">xGob</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Interface</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="ident">GobEncoder</span><span class="op">)</span><span class="op">.</span><span class="ident">GobEncode</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">xBinary</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Interface</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="ident">encoding</span><span class="op">.</span><span class="ident">BinaryMarshaler</span><span class="op">)</span><span class="op">.</span><span class="ident">MarshalBinary</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">xText</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">data</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Interface</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="ident">encoding</span><span class="op">.</span><span class="ident">TextMarshaler</span><span class="op">)</span><span class="op">.</span><span class="ident">MarshalText</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">enc</span><span class="op">.</span><span class="ident">newEncoderState</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">fieldnum</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="num">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">encodeUint</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">data</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">freeEncoderState</span><span class="op">(</span><span class="ident">state</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword">var</span>&nbsp;<span class="ident">encOpTable</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">...</span><span class="op">]</span><span class="ident">encOp</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Bool</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encBool</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encInt</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int8</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encInt</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int16</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encInt</span><span class="op">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int32</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encInt</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Int64</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encInt</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encUint</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint8</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encUint</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint16</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encUint</span><span class="op">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint32</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encUint</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint64</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encUint</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uintptr</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encUint</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Float32</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encFloat</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Float64</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encFloat</span><span class="op">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Complex64</span><span class="op">:</span>&nbsp;&nbsp;<span class="ident">encComplex</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">Complex128</span><span class="op">:</span>&nbsp;<span class="ident">encComplex</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">reflect</span><span class="op">.</span><span class="ident">String</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident">encString</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">encOpFor</span><span class="op">(</span><span class="ident">rt</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="op">*</span><span class="ident">encOp</span><span class="op">,</span>&nbsp;<span class="ident">building</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="op">*</span><span class="ident">typeInfo</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">encOp</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ut</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">userType</span><span class="op">(</span><span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">gobEncodeOpFor</span><span class="op">(</span><span class="ident">ut</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">opPtr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">inProgress</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="ident">opPtr</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">opPtr</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">typ</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">indir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">typ</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="ident">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">k</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">encOpTable</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">encOpTable</span><span class="op">[</span><span class="ident">k</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">inProgress</span><span class="op">[</span><span class="ident">rt</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">typ</span><span class="op">;</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Slice</span><span class="op">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Uint8</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">elemIndir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">encOpFor</span><span class="op">(</span><span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">,</span>&nbsp;<span class="ident">building</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">helper</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">encSliceHelper</span><span class="op">[</span><span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">slice</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">slice</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">enc</span><span class="op">.</span><span class="ident">encodeArray</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">slice</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">elemIndir</span><span class="op">,</span>&nbsp;<span class="ident">slice</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">helper</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Array</span><span class="op">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">elemIndir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">encOpFor</span><span class="op">(</span><span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">,</span>&nbsp;<span class="ident">building</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">helper</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">encArrayHelper</span><span class="op">[</span><span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">array</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">enc</span><span class="op">.</span><span class="ident">encodeArray</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">array</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">elemIndir</span><span class="op">,</span>&nbsp;<span class="ident">array</span><span class="op">.</span><span class="ident">Len</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">helper</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Map</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">keyOp</span><span class="op">,</span>&nbsp;<span class="ident">keyIndir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">encOpFor</span><span class="op">(</span><span class="ident">t</span><span class="op">.</span><span class="ident">Key</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">,</span>&nbsp;<span class="ident">building</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">elemIndir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">encOpFor</span><span class="op">(</span><span class="ident">t</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">inProgress</span><span class="op">,</span>&nbsp;<span class="ident">building</span><span class="op">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">mv</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">mv</span><span class="op">.</span><span class="ident">IsNil</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">enc</span><span class="op">.</span><span class="ident">encodeMap</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">mv</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">keyOp</span><span class="op">,</span>&nbsp;<span class="op">*</span><span class="ident">elemOp</span><span class="op">,</span>&nbsp;<span class="ident">keyIndir</span><span class="op">,</span>&nbsp;<span class="ident">elemIndir</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Struct</span><span class="op">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">getEncEngine</span><span class="op">(</span><span class="ident">userType</span><span class="op">(</span><span class="ident">typ</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">building</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mustGetTypeInfo</span><span class="op">(</span><span class="ident">typ</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">sv</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">info</span><span class="op">.</span><span class="ident">encoder</span><span class="op">.</span><span class="ident">Load</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">encEngine</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">enc</span><span class="op">.</span><span class="ident">encodeStruct</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">enc</span><span class="op">,</span>&nbsp;<span class="ident">sv</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Interface</span><span class="op">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">iv</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">(</span><span class="op">!</span><span class="ident">iv</span><span class="op">.</span><span class="ident">IsValid</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">iv</span><span class="op">.</span><span class="ident">IsNil</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">enc</span><span class="op">.</span><span class="ident">encodeInterface</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">iv</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">indir</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">gobEncodeOpFor</span><span class="op">(</span><span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">encOp</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">encIndir</span>&nbsp;<span class="op">==</span>&nbsp;<span class="op">-</span><span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">PtrTo</span><span class="op">(</span><span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">encIndir</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int8</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">encIndir</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">rt</span><span class="op">.</span><span class="ident">Elem</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="ident">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span>&nbsp;<span class="op">=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">*</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="ident">state</span>&nbsp;<span class="op">*</span><span class="ident">encoderState</span><span class="op">,</span>&nbsp;<span class="ident">v</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">encIndir</span>&nbsp;<span class="op">==</span>&nbsp;<span class="op">-</span><span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">v</span><span class="op">.</span><span class="ident">CanAddr</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op">,</span>&nbsp;<span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">v</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">v</span><span class="op">.</span><span class="ident">Addr</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">state</span><span class="op">.</span><span class="ident">sendZero</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">isZero</span><span class="op">(</span><span class="ident">v</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">update</span><span class="op">(</span><span class="ident">i</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">state</span><span class="op">.</span><span class="ident">enc</span><span class="op">.</span><span class="ident">encodeGobEncoder</span><span class="op">(</span><span class="ident">state</span><span class="op">.</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">v</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">op</span><span class="op">,</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">ut</span><span class="op">.</span><span class="ident">encIndir</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">compileEnc</span><span class="op">(</span><span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">,</span>&nbsp;<span class="ident">building</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="op">*</span><span class="ident">typeInfo</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">encEngine</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">srt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">encEngine</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">seen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="ident">reflect</span><span class="op">.</span><span class="ident">Type</span><span class="op">]</span><span class="op">*</span><span class="ident">encOp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rt</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">srt</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">fieldNum</span><span class="op">,</span>&nbsp;<span class="ident">wireFieldNum</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">fieldNum</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">srt</span><span class="op">.</span><span class="ident">NumField</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">fieldNum</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">srt</span><span class="op">.</span><span class="ident">Field</span><span class="op">(</span><span class="ident">fieldNum</span><span class="op">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">isSent</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">f</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">encOpFor</span><span class="op">(</span><span class="ident">f</span><span class="op">.</span><span class="ident">Type</span><span class="op">,</span>&nbsp;<span class="ident">seen</span><span class="op">,</span>&nbsp;<span class="ident">building</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">encInstr</span><span class="op">{</span><span class="op">*</span><span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">wireFieldNum</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">Index</span><span class="op">,</span>&nbsp;<span class="ident">indir</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wireFieldNum</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">srt</span><span class="op">.</span><span class="ident">NumField</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errorf</span><span class="op">(</span><span class="string">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op">,</span>&nbsp;<span class="ident">rt</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">,</span>&nbsp;<span class="ident">encInstr</span><span class="op">{</span><span class="ident">encStructTerminator</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">encInstr</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">indir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">encOpFor</span><span class="op">(</span><span class="ident">rt</span><span class="op">,</span>&nbsp;<span class="ident">seen</span><span class="op">,</span>&nbsp;<span class="ident">building</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span><span class="op">.</span><span class="ident">instr</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">encInstr</span><span class="op">{</span><span class="op">*</span><span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">singletonField</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">indir</span><span class="op">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">engine</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword">func</span>&nbsp;<span class="ident">getEncEngine</span><span class="op">(</span><span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">,</span>&nbsp;<span class="ident">building</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="op">*</span><span class="ident">typeInfo</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">encEngine</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getTypeInfo</span><span class="op">(</span><span class="ident">ut</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">error_</span><span class="op">(</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">info</span><span class="op">.</span><span class="ident">encoder</span><span class="op">.</span><span class="ident">Load</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">encEngine</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">buildEncEngine</span><span class="op">(</span><span class="ident">info</span><span class="op">,</span>&nbsp;<span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">building</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">enc</span><br>
<span class="lineno">660</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">buildEncEngine</span><span class="op">(</span><span class="ident">info</span>&nbsp;<span class="op">*</span><span class="ident">typeInfo</span><span class="op">,</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">,</span>&nbsp;<span class="ident">building</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="op">*</span><span class="ident">typeInfo</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">encEngine</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">building</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">building</span><span class="op">[</span><span class="ident">info</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span><span class="op">.</span><span class="ident">encInit</span><span class="op">.</span><span class="ident">Lock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">info</span><span class="op">.</span><span class="ident">encInit</span><span class="op">.</span><span class="ident">Unlock</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">info</span><span class="op">.</span><span class="ident">encoder</span><span class="op">.</span><span class="ident">Load</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">encEngine</span><span class="op">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">building</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">building</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="op">*</span><span class="ident">typeInfo</span><span class="op">]</span><span class="builtintype">bool</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">building</span><span class="op">[</span><span class="ident">info</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">compileEnc</span><span class="op">(</span><span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">building</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">info</span><span class="op">.</span><span class="ident">encoder</span><span class="op">.</span><span class="ident">Store</span><span class="op">(</span><span class="ident">enc</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">enc</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">enc</span>&nbsp;<span class="op">*</span><span class="ident">Encoder</span><span class="op">)</span>&nbsp;<span class="ident">encode</span><span class="op">(</span><span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">encBuffer</span><span class="op">,</span>&nbsp;<span class="ident">value</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Value</span><span class="op">,</span>&nbsp;<span class="ident">ut</span>&nbsp;<span class="op">*</span><span class="ident">userTypeInfo</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">catchError</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">enc</span><span class="op">.</span><span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">engine</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">getEncEngine</span><span class="op">(</span><span class="ident">ut</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">indir</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">indir</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">ut</span><span class="op">.</span><span class="ident">encIndir</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">indir</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">value</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Indirect</span><span class="op">(</span><span class="ident">value</span><span class="op">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ut</span><span class="op">.</span><span class="ident">externalEnc</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">value</span><span class="op">.</span><span class="ident">Type</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Kind</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">reflect</span><span class="op">.</span><span class="ident">Struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">encodeStruct</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">engine</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">enc</span><span class="op">.</span><span class="ident">encodeSingle</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="ident">engine</span><span class="op">,</span>&nbsp;<span class="ident">value</span><span class="op">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
