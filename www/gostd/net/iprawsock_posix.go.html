<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3326838">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3326894">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3326948">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3326999">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3327077">package</span>&nbsp;<span class="ident" id="3327085">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3327090">import</span>&nbsp;<span class="op" id="3327097">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3327100">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3327111">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3327118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3327121">//&nbsp;BUG(mikio):&nbsp;On&nbsp;every&nbsp;POSIX&nbsp;platform,&nbsp;reads&nbsp;from&nbsp;the&nbsp;&#34;ip4&#34;&nbsp;network</span><br>
<span class="lineno">15</span><span class="comment" id="3327190">//&nbsp;using&nbsp;the&nbsp;ReadFrom&nbsp;or&nbsp;ReadFromIP&nbsp;method&nbsp;might&nbsp;not&nbsp;return&nbsp;a&nbsp;complete</span><br>
<span class="lineno"></span><span class="comment" id="3327261">//&nbsp;IPv4&nbsp;packet,&nbsp;including&nbsp;its&nbsp;header,&nbsp;even&nbsp;if&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span><span class="comment" id="3327322">//&nbsp;available.&nbsp;This&nbsp;can&nbsp;occur&nbsp;even&nbsp;in&nbsp;cases&nbsp;where&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment" id="3327389">//&nbsp;could&nbsp;return&nbsp;a&nbsp;complete&nbsp;packet.&nbsp;For&nbsp;this&nbsp;reason,&nbsp;it&nbsp;is&nbsp;recommended</span><br>
<span class="lineno"></span><span class="comment" id="3327459">//&nbsp;that&nbsp;you&nbsp;do&nbsp;not&nbsp;uses&nbsp;these&nbsp;methods&nbsp;if&nbsp;it&nbsp;is&nbsp;important&nbsp;to&nbsp;receive&nbsp;a</span><br>
<span class="lineno">20</span><span class="comment" id="3327529">//&nbsp;full&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment" id="3327545">//</span><br>
<span class="lineno"></span><span class="comment" id="3327548">//&nbsp;The&nbsp;Go&nbsp;1&nbsp;compatibility&nbsp;guidelines&nbsp;make&nbsp;it&nbsp;impossible&nbsp;for&nbsp;us&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3327614">//&nbsp;change&nbsp;the&nbsp;behavior&nbsp;of&nbsp;these&nbsp;methods;&nbsp;use&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment" id="3327677">//&nbsp;instead.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="3327690">func</span>&nbsp;<span class="ident" id="3327695">sockaddrToIP</span><span class="op" id="3327707">(</span><span class="ident" id="3327708">sa</span>&nbsp;<span class="ident" id="3327711">syscall</span><span class="op" id="3327718">.</span><span class="ident" id="3327719">Sockaddr</span><span class="op" id="3327727">)</span>&nbsp;<span class="ident" id="3327729">Addr</span>&nbsp;<span class="op" id="3327734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327737">switch</span>&nbsp;<span class="ident" id="3327744">sa</span>&nbsp;<span class="op" id="3327747">:=</span>&nbsp;<span class="ident" id="3327750">sa</span><span class="op" id="3327752">.</span><span class="op" id="3327753">(</span><span class="keyword" id="3327754">type</span><span class="op" id="3327758">)</span>&nbsp;<span class="op" id="3327760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327763">case</span>&nbsp;<span class="op" id="3327768">*</span><span class="ident" id="3327769">syscall</span><span class="op" id="3327776">.</span><span class="ident" id="3327777">SockaddrInet4</span><span class="op" id="3327790">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327794">return</span>&nbsp;<span class="op" id="3327801">&amp;</span><span class="ident" id="3327802">IPAddr</span><span class="op" id="3327808">{</span><span class="ident" id="3327809">IP</span><span class="op" id="3327811">:</span>&nbsp;<span class="ident" id="3327813">sa</span><span class="op" id="3327815">.</span><span class="ident" id="3327816">Addr</span><span class="op" id="3327820">[</span><span class="num" id="3327821">0</span><span class="op" id="3327822">:</span><span class="op" id="3327823">]</span><span class="op" id="3327824">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327827">case</span>&nbsp;<span class="op" id="3327832">*</span><span class="ident" id="3327833">syscall</span><span class="op" id="3327840">.</span><span class="ident" id="3327841">SockaddrInet6</span><span class="op" id="3327854">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327858">return</span>&nbsp;<span class="op" id="3327865">&amp;</span><span class="ident" id="3327866">IPAddr</span><span class="op" id="3327872">{</span><span class="ident" id="3327873">IP</span><span class="op" id="3327875">:</span>&nbsp;<span class="ident" id="3327877">sa</span><span class="op" id="3327879">.</span><span class="ident" id="3327880">Addr</span><span class="op" id="3327884">[</span><span class="num" id="3327885">0</span><span class="op" id="3327886">:</span><span class="op" id="3327887">]</span><span class="op" id="3327888">,</span>&nbsp;<span class="ident" id="3327890">Zone</span><span class="op" id="3327894">:</span>&nbsp;<span class="ident" id="3327896">zoneToString</span><span class="op" id="3327908">(</span><span class="builtintype" id="3327909">int</span><span class="op" id="3327912">(</span><span class="ident" id="3327913">sa</span><span class="op" id="3327915">.</span><span class="ident" id="3327916">ZoneId</span><span class="op" id="3327922">)</span><span class="op" id="3327923">)</span><span class="op" id="3327924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3327927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327930">return</span>&nbsp;<span class="ident" id="3327937">nil</span><br>
<span class="lineno"></span><span class="op" id="3327941">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3327944">func</span>&nbsp;<span class="op" id="3327949">(</span><span class="ident" id="3327950">a</span>&nbsp;<span class="op" id="3327952">*</span><span class="ident" id="3327953">IPAddr</span><span class="op" id="3327959">)</span>&nbsp;<span class="ident" id="3327961">family</span><span class="op" id="3327967">(</span><span class="op" id="3327968">)</span>&nbsp;<span class="builtintype" id="3327970">int</span>&nbsp;<span class="op" id="3327974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3327977">if</span>&nbsp;<span class="ident" id="3327980">a</span>&nbsp;<span class="op" id="3327982">==</span>&nbsp;<span class="ident" id="3327985">nil</span>&nbsp;<span class="op" id="3327989">||</span>&nbsp;<span class="builtinfunc" id="3327992">len</span><span class="op" id="3327995">(</span><span class="ident" id="3327996">a</span><span class="op" id="3327997">.</span><span class="ident" id="3327998">IP</span><span class="op" id="3328000">)</span>&nbsp;<span class="op" id="3328002">&lt;=</span>&nbsp;<span class="ident" id="3328005">IPv4len</span>&nbsp;<span class="op" id="3328013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328017">return</span>&nbsp;<span class="ident" id="3328024">syscall</span><span class="op" id="3328031">.</span><span class="ident" id="3328032">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328041">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328044">if</span>&nbsp;<span class="ident" id="3328047">a</span><span class="op" id="3328048">.</span><span class="ident" id="3328049">IP</span><span class="op" id="3328051">.</span><span class="ident" id="3328052">To4</span><span class="op" id="3328055">(</span><span class="op" id="3328056">)</span>&nbsp;<span class="op" id="3328058">!=</span>&nbsp;<span class="ident" id="3328061">nil</span>&nbsp;<span class="op" id="3328065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328069">return</span>&nbsp;<span class="ident" id="3328076">syscall</span><span class="op" id="3328083">.</span><span class="ident" id="3328084">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328096">return</span>&nbsp;<span class="ident" id="3328103">syscall</span><span class="op" id="3328110">.</span><span class="ident" id="3328111">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="3328120">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="3328123">func</span>&nbsp;<span class="op" id="3328128">(</span><span class="ident" id="3328129">a</span>&nbsp;<span class="op" id="3328131">*</span><span class="ident" id="3328132">IPAddr</span><span class="op" id="3328138">)</span>&nbsp;<span class="ident" id="3328140">isWildcard</span><span class="op" id="3328150">(</span><span class="op" id="3328151">)</span>&nbsp;<span class="builtintype" id="3328153">bool</span>&nbsp;<span class="op" id="3328158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328161">if</span>&nbsp;<span class="ident" id="3328164">a</span>&nbsp;<span class="op" id="3328166">==</span>&nbsp;<span class="ident" id="3328169">nil</span>&nbsp;<span class="op" id="3328173">||</span>&nbsp;<span class="ident" id="3328176">a</span><span class="op" id="3328177">.</span><span class="ident" id="3328178">IP</span>&nbsp;<span class="op" id="3328181">==</span>&nbsp;<span class="ident" id="3328184">nil</span>&nbsp;<span class="op" id="3328188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328192">return</span>&nbsp;<span class="builtintype" id="3328199">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328205">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328208">return</span>&nbsp;<span class="ident" id="3328215">a</span><span class="op" id="3328216">.</span><span class="ident" id="3328217">IP</span><span class="op" id="3328219">.</span><span class="ident" id="3328220">IsUnspecified</span><span class="op" id="3328233">(</span><span class="op" id="3328234">)</span><br>
<span class="lineno"></span><span class="op" id="3328236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3328239">func</span>&nbsp;<span class="op" id="3328244">(</span><span class="ident" id="3328245">a</span>&nbsp;<span class="op" id="3328247">*</span><span class="ident" id="3328248">IPAddr</span><span class="op" id="3328254">)</span>&nbsp;<span class="ident" id="3328256">sockaddr</span><span class="op" id="3328264">(</span><span class="ident" id="3328265">family</span>&nbsp;<span class="builtintype" id="3328272">int</span><span class="op" id="3328275">)</span>&nbsp;<span class="op" id="3328277">(</span><span class="ident" id="3328278">syscall</span><span class="op" id="3328285">.</span><span class="ident" id="3328286">Sockaddr</span><span class="op" id="3328294">,</span>&nbsp;<span class="builtintype" id="3328296">error</span><span class="op" id="3328301">)</span>&nbsp;<span class="op" id="3328303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328306">if</span>&nbsp;<span class="ident" id="3328309">a</span>&nbsp;<span class="op" id="3328311">==</span>&nbsp;<span class="ident" id="3328314">nil</span>&nbsp;<span class="op" id="3328318">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328322">return</span>&nbsp;<span class="ident" id="3328329">nil</span><span class="op" id="3328332">,</span>&nbsp;<span class="ident" id="3328334">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3328339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328342">return</span>&nbsp;<span class="ident" id="3328349">ipToSockaddr</span><span class="op" id="3328361">(</span><span class="ident" id="3328362">family</span><span class="op" id="3328368">,</span>&nbsp;<span class="ident" id="3328370">a</span><span class="op" id="3328371">.</span><span class="ident" id="3328372">IP</span><span class="op" id="3328374">,</span>&nbsp;<span class="num" id="3328376">0</span><span class="op" id="3328377">,</span>&nbsp;<span class="ident" id="3328379">a</span><span class="op" id="3328380">.</span><span class="ident" id="3328381">Zone</span><span class="op" id="3328385">)</span><br>
<span class="lineno"></span><span class="op" id="3328387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="3328390">//&nbsp;IPConn&nbsp;is&nbsp;the&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;and&nbsp;PacketConn&nbsp;interfaces</span><br>
<span class="lineno"></span><span class="comment" id="3328460">//&nbsp;for&nbsp;IP&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3328491">type</span>&nbsp;<span class="ident" id="3328496">IPConn</span>&nbsp;<span class="keyword" id="3328503">struct</span>&nbsp;<span class="op" id="3328510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3328513">conn</span><br>
<span class="lineno"></span><span class="op" id="3328518">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="3328521">func</span>&nbsp;<span class="ident" id="3328526">newIPConn</span><span class="op" id="3328535">(</span><span class="ident" id="3328536">fd</span>&nbsp;<span class="op" id="3328539">*</span><span class="ident" id="3328540">netFD</span><span class="op" id="3328545">)</span>&nbsp;<span class="op" id="3328547">*</span><span class="ident" id="3328548">IPConn</span>&nbsp;<span class="op" id="3328555">{</span>&nbsp;<span class="keyword" id="3328557">return</span>&nbsp;<span class="op" id="3328564">&amp;</span><span class="ident" id="3328565">IPConn</span><span class="op" id="3328571">{</span><span class="ident" id="3328572">conn</span><span class="op" id="3328576">{</span><span class="ident" id="3328577">fd</span><span class="op" id="3328579">}</span><span class="op" id="3328580">}</span>&nbsp;<span class="op" id="3328582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3328585">//&nbsp;ReadFromIP&nbsp;reads&nbsp;an&nbsp;IP&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="3328654">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b&nbsp;and&nbsp;the&nbsp;return&nbsp;address</span><br>
<span class="lineno">70</span><span class="comment" id="3328725">//&nbsp;that&nbsp;was&nbsp;on&nbsp;the&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment" id="3328752">//</span><br>
<span class="lineno"></span><span class="comment" id="3328755">//&nbsp;ReadFromIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3328818">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3328885">//&nbsp;SetReadDeadline.</span><br>
<span class="lineno">75</span><span class="keyword" id="3328905">func</span>&nbsp;<span class="op" id="3328910">(</span><span class="ident" id="3328911">c</span>&nbsp;<span class="op" id="3328913">*</span><span class="ident" id="3328914">IPConn</span><span class="op" id="3328920">)</span>&nbsp;<span class="ident" id="3328922">ReadFromIP</span><span class="op" id="3328932">(</span><span class="ident" id="3328933">b</span>&nbsp;<span class="op" id="3328935">[</span><span class="op" id="3328936">]</span><span class="builtintype" id="3328937">byte</span><span class="op" id="3328941">)</span>&nbsp;<span class="op" id="3328943">(</span><span class="builtintype" id="3328944">int</span><span class="op" id="3328947">,</span>&nbsp;<span class="op" id="3328949">*</span><span class="ident" id="3328950">IPAddr</span><span class="op" id="3328956">,</span>&nbsp;<span class="builtintype" id="3328958">error</span><span class="op" id="3328963">)</span>&nbsp;<span class="op" id="3328965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328968">if</span>&nbsp;<span class="op" id="3328971">!</span><span class="ident" id="3328972">c</span><span class="op" id="3328973">.</span><span class="ident" id="3328974">ok</span><span class="op" id="3328976">(</span><span class="op" id="3328977">)</span>&nbsp;<span class="op" id="3328979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3328983">return</span>&nbsp;<span class="num" id="3328990">0</span><span class="op" id="3328991">,</span>&nbsp;<span class="ident" id="3328993">nil</span><span class="op" id="3328996">,</span>&nbsp;<span class="ident" id="3328998">syscall</span><span class="op" id="3329005">.</span><span class="ident" id="3329006">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3329014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3329017">//&nbsp;TODO(cw,rsc):&nbsp;consider&nbsp;using&nbsp;readv&nbsp;if&nbsp;we&nbsp;know&nbsp;the&nbsp;family</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3329078">//&nbsp;type&nbsp;to&nbsp;avoid&nbsp;the&nbsp;header&nbsp;trim/copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329117">var</span>&nbsp;<span class="ident" id="3329121">addr</span>&nbsp;<span class="op" id="3329126">*</span><span class="ident" id="3329127">IPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329135">n</span><span class="op" id="3329136">,</span>&nbsp;<span class="ident" id="3329138">sa</span><span class="op" id="3329140">,</span>&nbsp;<span class="ident" id="3329142">err</span>&nbsp;<span class="op" id="3329146">:=</span>&nbsp;<span class="ident" id="3329149">c</span><span class="op" id="3329150">.</span><span class="ident" id="3329151">fd</span><span class="op" id="3329153">.</span><span class="ident" id="3329154">readFrom</span><span class="op" id="3329162">(</span><span class="ident" id="3329163">b</span><span class="op" id="3329164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329167">switch</span>&nbsp;<span class="ident" id="3329174">sa</span>&nbsp;<span class="op" id="3329177">:=</span>&nbsp;<span class="ident" id="3329180">sa</span><span class="op" id="3329182">.</span><span class="op" id="3329183">(</span><span class="keyword" id="3329184">type</span><span class="op" id="3329188">)</span>&nbsp;<span class="op" id="3329190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329193">case</span>&nbsp;<span class="op" id="3329198">*</span><span class="ident" id="3329199">syscall</span><span class="op" id="3329206">.</span><span class="ident" id="3329207">SockaddrInet4</span><span class="op" id="3329220">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329224">addr</span>&nbsp;<span class="op" id="3329229">=</span>&nbsp;<span class="op" id="3329231">&amp;</span><span class="ident" id="3329232">IPAddr</span><span class="op" id="3329238">{</span><span class="ident" id="3329239">IP</span><span class="op" id="3329241">:</span>&nbsp;<span class="ident" id="3329243">sa</span><span class="op" id="3329245">.</span><span class="ident" id="3329246">Addr</span><span class="op" id="3329250">[</span><span class="num" id="3329251">0</span><span class="op" id="3329252">:</span><span class="op" id="3329253">]</span><span class="op" id="3329254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329258">if</span>&nbsp;<span class="builtinfunc" id="3329261">len</span><span class="op" id="3329264">(</span><span class="ident" id="3329265">b</span><span class="op" id="3329266">)</span>&nbsp;<span class="op" id="3329268">&gt;=</span>&nbsp;<span class="ident" id="3329271">IPv4len</span>&nbsp;<span class="op" id="3329279">{</span>&nbsp;<span class="comment" id="3329281">//&nbsp;discard&nbsp;ipv4&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329307">hsize</span>&nbsp;<span class="op" id="3329313">:=</span>&nbsp;<span class="op" id="3329316">(</span><span class="builtintype" id="3329317">int</span><span class="op" id="3329320">(</span><span class="ident" id="3329321">b</span><span class="op" id="3329322">[</span><span class="num" id="3329323">0</span><span class="op" id="3329324">]</span><span class="op" id="3329325">)</span>&nbsp;<span class="op" id="3329327">&amp;</span>&nbsp;<span class="num" id="3329329">0xf</span><span class="op" id="3329332">)</span>&nbsp;<span class="op" id="3329334">*</span>&nbsp;<span class="num" id="3329336">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3329341">copy</span><span class="op" id="3329345">(</span><span class="ident" id="3329346">b</span><span class="op" id="3329347">,</span>&nbsp;<span class="ident" id="3329349">b</span><span class="op" id="3329350">[</span><span class="ident" id="3329351">hsize</span><span class="op" id="3329356">:</span><span class="op" id="3329357">]</span><span class="op" id="3329358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329363">n</span>&nbsp;<span class="op" id="3329365">-=</span>&nbsp;<span class="ident" id="3329368">hsize</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3329376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329379">case</span>&nbsp;<span class="op" id="3329384">*</span><span class="ident" id="3329385">syscall</span><span class="op" id="3329392">.</span><span class="ident" id="3329393">SockaddrInet6</span><span class="op" id="3329406">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329410">addr</span>&nbsp;<span class="op" id="3329415">=</span>&nbsp;<span class="op" id="3329417">&amp;</span><span class="ident" id="3329418">IPAddr</span><span class="op" id="3329424">{</span><span class="ident" id="3329425">IP</span><span class="op" id="3329427">:</span>&nbsp;<span class="ident" id="3329429">sa</span><span class="op" id="3329431">.</span><span class="ident" id="3329432">Addr</span><span class="op" id="3329436">[</span><span class="num" id="3329437">0</span><span class="op" id="3329438">:</span><span class="op" id="3329439">]</span><span class="op" id="3329440">,</span>&nbsp;<span class="ident" id="3329442">Zone</span><span class="op" id="3329446">:</span>&nbsp;<span class="ident" id="3329448">zoneToString</span><span class="op" id="3329460">(</span><span class="builtintype" id="3329461">int</span><span class="op" id="3329464">(</span><span class="ident" id="3329465">sa</span><span class="op" id="3329467">.</span><span class="ident" id="3329468">ZoneId</span><span class="op" id="3329474">)</span><span class="op" id="3329475">)</span><span class="op" id="3329476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3329479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329482">return</span>&nbsp;<span class="ident" id="3329489">n</span><span class="op" id="3329490">,</span>&nbsp;<span class="ident" id="3329492">addr</span><span class="op" id="3329496">,</span>&nbsp;<span class="ident" id="3329498">err</span><br>
<span class="lineno">95</span><span class="op" id="3329502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3329505">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="3329560">func</span>&nbsp;<span class="op" id="3329565">(</span><span class="ident" id="3329566">c</span>&nbsp;<span class="op" id="3329568">*</span><span class="ident" id="3329569">IPConn</span><span class="op" id="3329575">)</span>&nbsp;<span class="ident" id="3329577">ReadFrom</span><span class="op" id="3329585">(</span><span class="ident" id="3329586">b</span>&nbsp;<span class="op" id="3329588">[</span><span class="op" id="3329589">]</span><span class="builtintype" id="3329590">byte</span><span class="op" id="3329594">)</span>&nbsp;<span class="op" id="3329596">(</span><span class="builtintype" id="3329597">int</span><span class="op" id="3329600">,</span>&nbsp;<span class="ident" id="3329602">Addr</span><span class="op" id="3329606">,</span>&nbsp;<span class="builtintype" id="3329608">error</span><span class="op" id="3329613">)</span>&nbsp;<span class="op" id="3329615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329618">if</span>&nbsp;<span class="op" id="3329621">!</span><span class="ident" id="3329622">c</span><span class="op" id="3329623">.</span><span class="ident" id="3329624">ok</span><span class="op" id="3329626">(</span><span class="op" id="3329627">)</span>&nbsp;<span class="op" id="3329629">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329633">return</span>&nbsp;<span class="num" id="3329640">0</span><span class="op" id="3329641">,</span>&nbsp;<span class="ident" id="3329643">nil</span><span class="op" id="3329646">,</span>&nbsp;<span class="ident" id="3329648">syscall</span><span class="op" id="3329655">.</span><span class="ident" id="3329656">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3329664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3329667">n</span><span class="op" id="3329668">,</span>&nbsp;<span class="ident" id="3329670">addr</span><span class="op" id="3329674">,</span>&nbsp;<span class="ident" id="3329676">err</span>&nbsp;<span class="op" id="3329680">:=</span>&nbsp;<span class="ident" id="3329683">c</span><span class="op" id="3329684">.</span><span class="ident" id="3329685">ReadFromIP</span><span class="op" id="3329695">(</span><span class="ident" id="3329696">b</span><span class="op" id="3329697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3329700">return</span>&nbsp;<span class="ident" id="3329707">n</span><span class="op" id="3329708">,</span>&nbsp;<span class="ident" id="3329710">addr</span><span class="op" id="3329714">.</span><span class="ident" id="3329715">toAddr</span><span class="op" id="3329721">(</span><span class="op" id="3329722">)</span><span class="op" id="3329723">,</span>&nbsp;<span class="ident" id="3329725">err</span><br>
<span class="lineno"></span><span class="op" id="3329729">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="comment" id="3329732">//&nbsp;ReadMsgIP&nbsp;reads&nbsp;a&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3329803">//&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;into&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3329870">//&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;oob,&nbsp;the&nbsp;flags</span><br>
<span class="lineno"></span><span class="comment" id="3329941">//&nbsp;that&nbsp;were&nbsp;set&nbsp;on&nbsp;the&nbsp;packet&nbsp;and&nbsp;the&nbsp;source&nbsp;address&nbsp;of&nbsp;the&nbsp;packet.</span><br>
<span class="lineno">110</span><span class="keyword" id="3330010">func</span>&nbsp;<span class="op" id="3330015">(</span><span class="ident" id="3330016">c</span>&nbsp;<span class="op" id="3330018">*</span><span class="ident" id="3330019">IPConn</span><span class="op" id="3330025">)</span>&nbsp;<span class="ident" id="3330027">ReadMsgIP</span><span class="op" id="3330036">(</span><span class="ident" id="3330037">b</span><span class="op" id="3330038">,</span>&nbsp;<span class="ident" id="3330040">oob</span>&nbsp;<span class="op" id="3330044">[</span><span class="op" id="3330045">]</span><span class="builtintype" id="3330046">byte</span><span class="op" id="3330050">)</span>&nbsp;<span class="op" id="3330052">(</span><span class="ident" id="3330053">n</span><span class="op" id="3330054">,</span>&nbsp;<span class="ident" id="3330056">oobn</span><span class="op" id="3330060">,</span>&nbsp;<span class="ident" id="3330062">flags</span>&nbsp;<span class="builtintype" id="3330068">int</span><span class="op" id="3330071">,</span>&nbsp;<span class="ident" id="3330073">addr</span>&nbsp;<span class="op" id="3330078">*</span><span class="ident" id="3330079">IPAddr</span><span class="op" id="3330085">,</span>&nbsp;<span class="ident" id="3330087">err</span>&nbsp;<span class="builtintype" id="3330091">error</span><span class="op" id="3330096">)</span>&nbsp;<span class="op" id="3330098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330101">if</span>&nbsp;<span class="op" id="3330104">!</span><span class="ident" id="3330105">c</span><span class="op" id="3330106">.</span><span class="ident" id="3330107">ok</span><span class="op" id="3330109">(</span><span class="op" id="3330110">)</span>&nbsp;<span class="op" id="3330112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330116">return</span>&nbsp;<span class="num" id="3330123">0</span><span class="op" id="3330124">,</span>&nbsp;<span class="num" id="3330126">0</span><span class="op" id="3330127">,</span>&nbsp;<span class="num" id="3330129">0</span><span class="op" id="3330130">,</span>&nbsp;<span class="ident" id="3330132">nil</span><span class="op" id="3330135">,</span>&nbsp;<span class="ident" id="3330137">syscall</span><span class="op" id="3330144">.</span><span class="ident" id="3330145">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3330153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330156">var</span>&nbsp;<span class="ident" id="3330160">sa</span>&nbsp;<span class="ident" id="3330163">syscall</span><span class="op" id="3330170">.</span><span class="ident" id="3330171">Sockaddr</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3330181">n</span><span class="op" id="3330182">,</span>&nbsp;<span class="ident" id="3330184">oobn</span><span class="op" id="3330188">,</span>&nbsp;<span class="ident" id="3330190">flags</span><span class="op" id="3330195">,</span>&nbsp;<span class="ident" id="3330197">sa</span><span class="op" id="3330199">,</span>&nbsp;<span class="ident" id="3330201">err</span>&nbsp;<span class="op" id="3330205">=</span>&nbsp;<span class="ident" id="3330207">c</span><span class="op" id="3330208">.</span><span class="ident" id="3330209">fd</span><span class="op" id="3330211">.</span><span class="ident" id="3330212">readMsg</span><span class="op" id="3330219">(</span><span class="ident" id="3330220">b</span><span class="op" id="3330221">,</span>&nbsp;<span class="ident" id="3330223">oob</span><span class="op" id="3330226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330229">switch</span>&nbsp;<span class="ident" id="3330236">sa</span>&nbsp;<span class="op" id="3330239">:=</span>&nbsp;<span class="ident" id="3330242">sa</span><span class="op" id="3330244">.</span><span class="op" id="3330245">(</span><span class="keyword" id="3330246">type</span><span class="op" id="3330250">)</span>&nbsp;<span class="op" id="3330252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330255">case</span>&nbsp;<span class="op" id="3330260">*</span><span class="ident" id="3330261">syscall</span><span class="op" id="3330268">.</span><span class="ident" id="3330269">SockaddrInet4</span><span class="op" id="3330282">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3330286">addr</span>&nbsp;<span class="op" id="3330291">=</span>&nbsp;<span class="op" id="3330293">&amp;</span><span class="ident" id="3330294">IPAddr</span><span class="op" id="3330300">{</span><span class="ident" id="3330301">IP</span><span class="op" id="3330303">:</span>&nbsp;<span class="ident" id="3330305">sa</span><span class="op" id="3330307">.</span><span class="ident" id="3330308">Addr</span><span class="op" id="3330312">[</span><span class="num" id="3330313">0</span><span class="op" id="3330314">:</span><span class="op" id="3330315">]</span><span class="op" id="3330316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330319">case</span>&nbsp;<span class="op" id="3330324">*</span><span class="ident" id="3330325">syscall</span><span class="op" id="3330332">.</span><span class="ident" id="3330333">SockaddrInet6</span><span class="op" id="3330346">:</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3330350">addr</span>&nbsp;<span class="op" id="3330355">=</span>&nbsp;<span class="op" id="3330357">&amp;</span><span class="ident" id="3330358">IPAddr</span><span class="op" id="3330364">{</span><span class="ident" id="3330365">IP</span><span class="op" id="3330367">:</span>&nbsp;<span class="ident" id="3330369">sa</span><span class="op" id="3330371">.</span><span class="ident" id="3330372">Addr</span><span class="op" id="3330376">[</span><span class="num" id="3330377">0</span><span class="op" id="3330378">:</span><span class="op" id="3330379">]</span><span class="op" id="3330380">,</span>&nbsp;<span class="ident" id="3330382">Zone</span><span class="op" id="3330386">:</span>&nbsp;<span class="ident" id="3330388">zoneToString</span><span class="op" id="3330400">(</span><span class="builtintype" id="3330401">int</span><span class="op" id="3330404">(</span><span class="ident" id="3330405">sa</span><span class="op" id="3330407">.</span><span class="ident" id="3330408">ZoneId</span><span class="op" id="3330414">)</span><span class="op" id="3330415">)</span><span class="op" id="3330416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3330419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330422">return</span><br>
<span class="lineno"></span><span class="op" id="3330429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="3330432">//&nbsp;WriteToIP&nbsp;writes&nbsp;an&nbsp;IP&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="3330500">//&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="3330511">//</span><br>
<span class="lineno"></span><span class="comment" id="3330514">//&nbsp;WriteToIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3330576">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno">130</span><span class="comment" id="3330643">//&nbsp;SetWriteDeadline.&nbsp;&nbsp;On&nbsp;packet-oriented&nbsp;connections,&nbsp;write&nbsp;timeouts</span><br>
<span class="lineno"></span><span class="comment" id="3330712">//&nbsp;are&nbsp;rare.</span><br>
<span class="lineno"></span><span class="keyword" id="3330725">func</span>&nbsp;<span class="op" id="3330730">(</span><span class="ident" id="3330731">c</span>&nbsp;<span class="op" id="3330733">*</span><span class="ident" id="3330734">IPConn</span><span class="op" id="3330740">)</span>&nbsp;<span class="ident" id="3330742">WriteToIP</span><span class="op" id="3330751">(</span><span class="ident" id="3330752">b</span>&nbsp;<span class="op" id="3330754">[</span><span class="op" id="3330755">]</span><span class="builtintype" id="3330756">byte</span><span class="op" id="3330760">,</span>&nbsp;<span class="ident" id="3330762">addr</span>&nbsp;<span class="op" id="3330767">*</span><span class="ident" id="3330768">IPAddr</span><span class="op" id="3330774">)</span>&nbsp;<span class="op" id="3330776">(</span><span class="builtintype" id="3330777">int</span><span class="op" id="3330780">,</span>&nbsp;<span class="builtintype" id="3330782">error</span><span class="op" id="3330787">)</span>&nbsp;<span class="op" id="3330789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330792">if</span>&nbsp;<span class="op" id="3330795">!</span><span class="ident" id="3330796">c</span><span class="op" id="3330797">.</span><span class="ident" id="3330798">ok</span><span class="op" id="3330800">(</span><span class="op" id="3330801">)</span>&nbsp;<span class="op" id="3330803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330807">return</span>&nbsp;<span class="num" id="3330814">0</span><span class="op" id="3330815">,</span>&nbsp;<span class="ident" id="3330817">syscall</span><span class="op" id="3330824">.</span><span class="ident" id="3330825">EINVAL</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3330833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330836">if</span>&nbsp;<span class="ident" id="3330839">c</span><span class="op" id="3330840">.</span><span class="ident" id="3330841">fd</span><span class="op" id="3330843">.</span><span class="ident" id="3330844">isConnected</span>&nbsp;<span class="op" id="3330856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330860">return</span>&nbsp;<span class="num" id="3330867">0</span><span class="op" id="3330868">,</span>&nbsp;<span class="op" id="3330870">&amp;</span><span class="ident" id="3330871">OpError</span><span class="op" id="3330878">{</span><span class="ident" id="3330879">Op</span><span class="op" id="3330881">:</span>&nbsp;<span class="string" id="3330883">&#34;write&#34;</span><span class="op" id="3330890">,</span>&nbsp;<span class="ident" id="3330892">Net</span><span class="op" id="3330895">:</span>&nbsp;<span class="ident" id="3330897">c</span><span class="op" id="3330898">.</span><span class="ident" id="3330899">fd</span><span class="op" id="3330901">.</span><span class="ident" id="3330902">net</span><span class="op" id="3330905">,</span>&nbsp;<span class="ident" id="3330907">Addr</span><span class="op" id="3330911">:</span>&nbsp;<span class="ident" id="3330913">addr</span><span class="op" id="3330917">,</span>&nbsp;<span class="ident" id="3330919">Err</span><span class="op" id="3330922">:</span>&nbsp;<span class="ident" id="3330924">ErrWriteToConnected</span><span class="op" id="3330943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3330946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330949">if</span>&nbsp;<span class="ident" id="3330952">addr</span>&nbsp;<span class="op" id="3330957">==</span>&nbsp;<span class="ident" id="3330960">nil</span>&nbsp;<span class="op" id="3330964">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3330968">return</span>&nbsp;<span class="num" id="3330975">0</span><span class="op" id="3330976">,</span>&nbsp;<span class="op" id="3330978">&amp;</span><span class="ident" id="3330979">OpError</span><span class="op" id="3330986">{</span><span class="ident" id="3330987">Op</span><span class="op" id="3330989">:</span>&nbsp;<span class="string" id="3330991">&#34;write&#34;</span><span class="op" id="3330998">,</span>&nbsp;<span class="ident" id="3331000">Net</span><span class="op" id="3331003">:</span>&nbsp;<span class="ident" id="3331005">c</span><span class="op" id="3331006">.</span><span class="ident" id="3331007">fd</span><span class="op" id="3331009">.</span><span class="ident" id="3331010">net</span><span class="op" id="3331013">,</span>&nbsp;<span class="ident" id="3331015">Addr</span><span class="op" id="3331019">:</span>&nbsp;<span class="ident" id="3331021">nil</span><span class="op" id="3331024">,</span>&nbsp;<span class="ident" id="3331026">Err</span><span class="op" id="3331029">:</span>&nbsp;<span class="ident" id="3331031">errMissingAddress</span><span class="op" id="3331048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3331051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3331054">sa</span><span class="op" id="3331056">,</span>&nbsp;<span class="ident" id="3331058">err</span>&nbsp;<span class="op" id="3331062">:=</span>&nbsp;<span class="ident" id="3331065">addr</span><span class="op" id="3331069">.</span><span class="ident" id="3331070">sockaddr</span><span class="op" id="3331078">(</span><span class="ident" id="3331079">c</span><span class="op" id="3331080">.</span><span class="ident" id="3331081">fd</span><span class="op" id="3331083">.</span><span class="ident" id="3331084">family</span><span class="op" id="3331090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331093">if</span>&nbsp;<span class="ident" id="3331096">err</span>&nbsp;<span class="op" id="3331100">!=</span>&nbsp;<span class="ident" id="3331103">nil</span>&nbsp;<span class="op" id="3331107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331111">return</span>&nbsp;<span class="num" id="3331118">0</span><span class="op" id="3331119">,</span>&nbsp;<span class="op" id="3331121">&amp;</span><span class="ident" id="3331122">OpError</span><span class="op" id="3331129">{</span><span class="string" id="3331130">&#34;write&#34;</span><span class="op" id="3331137">,</span>&nbsp;<span class="ident" id="3331139">c</span><span class="op" id="3331140">.</span><span class="ident" id="3331141">fd</span><span class="op" id="3331143">.</span><span class="ident" id="3331144">net</span><span class="op" id="3331147">,</span>&nbsp;<span class="ident" id="3331149">addr</span><span class="op" id="3331153">,</span>&nbsp;<span class="ident" id="3331155">err</span><span class="op" id="3331158">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3331161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331164">return</span>&nbsp;<span class="ident" id="3331171">c</span><span class="op" id="3331172">.</span><span class="ident" id="3331173">fd</span><span class="op" id="3331175">.</span><span class="ident" id="3331176">writeTo</span><span class="op" id="3331183">(</span><span class="ident" id="3331184">b</span><span class="op" id="3331185">,</span>&nbsp;<span class="ident" id="3331187">sa</span><span class="op" id="3331189">)</span><br>
<span class="lineno"></span><span class="op" id="3331191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3331194">//&nbsp;WriteTo&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;WriteTo&nbsp;method.</span><br>
<span class="lineno">150</span><span class="keyword" id="3331247">func</span>&nbsp;<span class="op" id="3331252">(</span><span class="ident" id="3331253">c</span>&nbsp;<span class="op" id="3331255">*</span><span class="ident" id="3331256">IPConn</span><span class="op" id="3331262">)</span>&nbsp;<span class="ident" id="3331264">WriteTo</span><span class="op" id="3331271">(</span><span class="ident" id="3331272">b</span>&nbsp;<span class="op" id="3331274">[</span><span class="op" id="3331275">]</span><span class="builtintype" id="3331276">byte</span><span class="op" id="3331280">,</span>&nbsp;<span class="ident" id="3331282">addr</span>&nbsp;<span class="ident" id="3331287">Addr</span><span class="op" id="3331291">)</span>&nbsp;<span class="op" id="3331293">(</span><span class="builtintype" id="3331294">int</span><span class="op" id="3331297">,</span>&nbsp;<span class="builtintype" id="3331299">error</span><span class="op" id="3331304">)</span>&nbsp;<span class="op" id="3331306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331309">if</span>&nbsp;<span class="op" id="3331312">!</span><span class="ident" id="3331313">c</span><span class="op" id="3331314">.</span><span class="ident" id="3331315">ok</span><span class="op" id="3331317">(</span><span class="op" id="3331318">)</span>&nbsp;<span class="op" id="3331320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331324">return</span>&nbsp;<span class="num" id="3331331">0</span><span class="op" id="3331332">,</span>&nbsp;<span class="ident" id="3331334">syscall</span><span class="op" id="3331341">.</span><span class="ident" id="3331342">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3331350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3331353">a</span><span class="op" id="3331354">,</span>&nbsp;<span class="ident" id="3331356">ok</span>&nbsp;<span class="op" id="3331359">:=</span>&nbsp;<span class="ident" id="3331362">addr</span><span class="op" id="3331366">.</span><span class="op" id="3331367">(</span><span class="op" id="3331368">*</span><span class="ident" id="3331369">IPAddr</span><span class="op" id="3331375">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331378">if</span>&nbsp;<span class="op" id="3331381">!</span><span class="ident" id="3331382">ok</span>&nbsp;<span class="op" id="3331385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331389">return</span>&nbsp;<span class="num" id="3331396">0</span><span class="op" id="3331397">,</span>&nbsp;<span class="op" id="3331399">&amp;</span><span class="ident" id="3331400">OpError</span><span class="op" id="3331407">{</span><span class="string" id="3331408">&#34;write&#34;</span><span class="op" id="3331415">,</span>&nbsp;<span class="ident" id="3331417">c</span><span class="op" id="3331418">.</span><span class="ident" id="3331419">fd</span><span class="op" id="3331421">.</span><span class="ident" id="3331422">net</span><span class="op" id="3331425">,</span>&nbsp;<span class="ident" id="3331427">addr</span><span class="op" id="3331431">,</span>&nbsp;<span class="ident" id="3331433">syscall</span><span class="op" id="3331440">.</span><span class="ident" id="3331441">EINVAL</span><span class="op" id="3331447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3331450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331453">return</span>&nbsp;<span class="ident" id="3331460">c</span><span class="op" id="3331461">.</span><span class="ident" id="3331462">WriteToIP</span><span class="op" id="3331471">(</span><span class="ident" id="3331472">b</span><span class="op" id="3331473">,</span>&nbsp;<span class="ident" id="3331475">a</span><span class="op" id="3331476">)</span><br>
<span class="lineno"></span><span class="op" id="3331478">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3331481">//&nbsp;WriteMsgIP&nbsp;writes&nbsp;a&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3331551">//&nbsp;b&nbsp;and&nbsp;the&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;from&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3331618">//&nbsp;number&nbsp;of&nbsp;payload&nbsp;and&nbsp;out-of-band&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="keyword" id="3331670">func</span>&nbsp;<span class="op" id="3331675">(</span><span class="ident" id="3331676">c</span>&nbsp;<span class="op" id="3331678">*</span><span class="ident" id="3331679">IPConn</span><span class="op" id="3331685">)</span>&nbsp;<span class="ident" id="3331687">WriteMsgIP</span><span class="op" id="3331697">(</span><span class="ident" id="3331698">b</span><span class="op" id="3331699">,</span>&nbsp;<span class="ident" id="3331701">oob</span>&nbsp;<span class="op" id="3331705">[</span><span class="op" id="3331706">]</span><span class="builtintype" id="3331707">byte</span><span class="op" id="3331711">,</span>&nbsp;<span class="ident" id="3331713">addr</span>&nbsp;<span class="op" id="3331718">*</span><span class="ident" id="3331719">IPAddr</span><span class="op" id="3331725">)</span>&nbsp;<span class="op" id="3331727">(</span><span class="ident" id="3331728">n</span><span class="op" id="3331729">,</span>&nbsp;<span class="ident" id="3331731">oobn</span>&nbsp;<span class="builtintype" id="3331736">int</span><span class="op" id="3331739">,</span>&nbsp;<span class="ident" id="3331741">err</span>&nbsp;<span class="builtintype" id="3331745">error</span><span class="op" id="3331750">)</span>&nbsp;<span class="op" id="3331752">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331755">if</span>&nbsp;<span class="op" id="3331758">!</span><span class="ident" id="3331759">c</span><span class="op" id="3331760">.</span><span class="ident" id="3331761">ok</span><span class="op" id="3331763">(</span><span class="op" id="3331764">)</span>&nbsp;<span class="op" id="3331766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331770">return</span>&nbsp;<span class="num" id="3331777">0</span><span class="op" id="3331778">,</span>&nbsp;<span class="num" id="3331780">0</span><span class="op" id="3331781">,</span>&nbsp;<span class="ident" id="3331783">syscall</span><span class="op" id="3331790">.</span><span class="ident" id="3331791">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3331799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331802">if</span>&nbsp;<span class="ident" id="3331805">c</span><span class="op" id="3331806">.</span><span class="ident" id="3331807">fd</span><span class="op" id="3331809">.</span><span class="ident" id="3331810">isConnected</span>&nbsp;<span class="op" id="3331822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331826">return</span>&nbsp;<span class="num" id="3331833">0</span><span class="op" id="3331834">,</span>&nbsp;<span class="num" id="3331836">0</span><span class="op" id="3331837">,</span>&nbsp;<span class="op" id="3331839">&amp;</span><span class="ident" id="3331840">OpError</span><span class="op" id="3331847">{</span><span class="ident" id="3331848">Op</span><span class="op" id="3331850">:</span>&nbsp;<span class="string" id="3331852">&#34;write&#34;</span><span class="op" id="3331859">,</span>&nbsp;<span class="ident" id="3331861">Net</span><span class="op" id="3331864">:</span>&nbsp;<span class="ident" id="3331866">c</span><span class="op" id="3331867">.</span><span class="ident" id="3331868">fd</span><span class="op" id="3331870">.</span><span class="ident" id="3331871">net</span><span class="op" id="3331874">,</span>&nbsp;<span class="ident" id="3331876">Addr</span><span class="op" id="3331880">:</span>&nbsp;<span class="ident" id="3331882">addr</span><span class="op" id="3331886">,</span>&nbsp;<span class="ident" id="3331888">Err</span><span class="op" id="3331891">:</span>&nbsp;<span class="ident" id="3331893">ErrWriteToConnected</span><span class="op" id="3331912">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3331915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331918">if</span>&nbsp;<span class="ident" id="3331921">addr</span>&nbsp;<span class="op" id="3331926">==</span>&nbsp;<span class="ident" id="3331929">nil</span>&nbsp;<span class="op" id="3331933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3331937">return</span>&nbsp;<span class="num" id="3331944">0</span><span class="op" id="3331945">,</span>&nbsp;<span class="num" id="3331947">0</span><span class="op" id="3331948">,</span>&nbsp;<span class="op" id="3331950">&amp;</span><span class="ident" id="3331951">OpError</span><span class="op" id="3331958">{</span><span class="ident" id="3331959">Op</span><span class="op" id="3331961">:</span>&nbsp;<span class="string" id="3331963">&#34;write&#34;</span><span class="op" id="3331970">,</span>&nbsp;<span class="ident" id="3331972">Net</span><span class="op" id="3331975">:</span>&nbsp;<span class="ident" id="3331977">c</span><span class="op" id="3331978">.</span><span class="ident" id="3331979">fd</span><span class="op" id="3331981">.</span><span class="ident" id="3331982">net</span><span class="op" id="3331985">,</span>&nbsp;<span class="ident" id="3331987">Addr</span><span class="op" id="3331991">:</span>&nbsp;<span class="ident" id="3331993">nil</span><span class="op" id="3331996">,</span>&nbsp;<span class="ident" id="3331998">Err</span><span class="op" id="3332001">:</span>&nbsp;<span class="ident" id="3332003">errMissingAddress</span><span class="op" id="3332020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3332023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3332026">sa</span><span class="op" id="3332028">,</span>&nbsp;<span class="ident" id="3332030">err</span>&nbsp;<span class="op" id="3332034">:=</span>&nbsp;<span class="ident" id="3332037">addr</span><span class="op" id="3332041">.</span><span class="ident" id="3332042">sockaddr</span><span class="op" id="3332050">(</span><span class="ident" id="3332051">c</span><span class="op" id="3332052">.</span><span class="ident" id="3332053">fd</span><span class="op" id="3332055">.</span><span class="ident" id="3332056">family</span><span class="op" id="3332062">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332065">if</span>&nbsp;<span class="ident" id="3332068">err</span>&nbsp;<span class="op" id="3332072">!=</span>&nbsp;<span class="ident" id="3332075">nil</span>&nbsp;<span class="op" id="3332079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332083">return</span>&nbsp;<span class="num" id="3332090">0</span><span class="op" id="3332091">,</span>&nbsp;<span class="num" id="3332093">0</span><span class="op" id="3332094">,</span>&nbsp;<span class="op" id="3332096">&amp;</span><span class="ident" id="3332097">OpError</span><span class="op" id="3332104">{</span><span class="string" id="3332105">&#34;write&#34;</span><span class="op" id="3332112">,</span>&nbsp;<span class="ident" id="3332114">c</span><span class="op" id="3332115">.</span><span class="ident" id="3332116">fd</span><span class="op" id="3332118">.</span><span class="ident" id="3332119">net</span><span class="op" id="3332122">,</span>&nbsp;<span class="ident" id="3332124">addr</span><span class="op" id="3332128">,</span>&nbsp;<span class="ident" id="3332130">err</span><span class="op" id="3332133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3332136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332139">return</span>&nbsp;<span class="ident" id="3332146">c</span><span class="op" id="3332147">.</span><span class="ident" id="3332148">fd</span><span class="op" id="3332150">.</span><span class="ident" id="3332151">writeMsg</span><span class="op" id="3332159">(</span><span class="ident" id="3332160">b</span><span class="op" id="3332161">,</span>&nbsp;<span class="ident" id="3332163">oob</span><span class="op" id="3332166">,</span>&nbsp;<span class="ident" id="3332168">sa</span><span class="op" id="3332170">)</span><br>
<span class="lineno"></span><span class="op" id="3332172">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="3332175">//&nbsp;DialIP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;protocol</span><br>
<span class="lineno"></span><span class="comment" id="3332246">//&nbsp;netProto,&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;ip&#34;,&nbsp;&#34;ip4&#34;,&nbsp;or&nbsp;&#34;ip6&#34;&nbsp;followed&nbsp;by&nbsp;a&nbsp;colon</span><br>
<span class="lineno"></span><span class="comment" id="3332315">//&nbsp;and&nbsp;a&nbsp;protocol&nbsp;number&nbsp;or&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3332349">func</span>&nbsp;<span class="ident" id="3332354">DialIP</span><span class="op" id="3332360">(</span><span class="ident" id="3332361">netProto</span>&nbsp;<span class="builtintype" id="3332370">string</span><span class="op" id="3332376">,</span>&nbsp;<span class="ident" id="3332378">laddr</span><span class="op" id="3332383">,</span>&nbsp;<span class="ident" id="3332385">raddr</span>&nbsp;<span class="op" id="3332391">*</span><span class="ident" id="3332392">IPAddr</span><span class="op" id="3332398">)</span>&nbsp;<span class="op" id="3332400">(</span><span class="op" id="3332401">*</span><span class="ident" id="3332402">IPConn</span><span class="op" id="3332408">,</span>&nbsp;<span class="builtintype" id="3332410">error</span><span class="op" id="3332415">)</span>&nbsp;<span class="op" id="3332417">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332420">return</span>&nbsp;<span class="ident" id="3332427">dialIP</span><span class="op" id="3332433">(</span><span class="ident" id="3332434">netProto</span><span class="op" id="3332442">,</span>&nbsp;<span class="ident" id="3332444">laddr</span><span class="op" id="3332449">,</span>&nbsp;<span class="ident" id="3332451">raddr</span><span class="op" id="3332456">,</span>&nbsp;<span class="ident" id="3332458">noDeadline</span><span class="op" id="3332468">)</span><br>
<span class="lineno"></span><span class="op" id="3332470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3332473">func</span>&nbsp;<span class="ident" id="3332478">dialIP</span><span class="op" id="3332484">(</span><span class="ident" id="3332485">netProto</span>&nbsp;<span class="builtintype" id="3332494">string</span><span class="op" id="3332500">,</span>&nbsp;<span class="ident" id="3332502">laddr</span><span class="op" id="3332507">,</span>&nbsp;<span class="ident" id="3332509">raddr</span>&nbsp;<span class="op" id="3332515">*</span><span class="ident" id="3332516">IPAddr</span><span class="op" id="3332522">,</span>&nbsp;<span class="ident" id="3332524">deadline</span>&nbsp;<span class="ident" id="3332533">time</span><span class="op" id="3332537">.</span><span class="ident" id="3332538">Time</span><span class="op" id="3332542">)</span>&nbsp;<span class="op" id="3332544">(</span><span class="op" id="3332545">*</span><span class="ident" id="3332546">IPConn</span><span class="op" id="3332552">,</span>&nbsp;<span class="builtintype" id="3332554">error</span><span class="op" id="3332559">)</span>&nbsp;<span class="op" id="3332561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3332564">net</span><span class="op" id="3332567">,</span>&nbsp;<span class="ident" id="3332569">proto</span><span class="op" id="3332574">,</span>&nbsp;<span class="ident" id="3332576">err</span>&nbsp;<span class="op" id="3332580">:=</span>&nbsp;<span class="ident" id="3332583">parseNetwork</span><span class="op" id="3332595">(</span><span class="ident" id="3332596">netProto</span><span class="op" id="3332604">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332607">if</span>&nbsp;<span class="ident" id="3332610">err</span>&nbsp;<span class="op" id="3332614">!=</span>&nbsp;<span class="ident" id="3332617">nil</span>&nbsp;<span class="op" id="3332621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332625">return</span>&nbsp;<span class="ident" id="3332632">nil</span><span class="op" id="3332635">,</span>&nbsp;<span class="op" id="3332637">&amp;</span><span class="ident" id="3332638">OpError</span><span class="op" id="3332645">{</span><span class="ident" id="3332646">Op</span><span class="op" id="3332648">:</span>&nbsp;<span class="string" id="3332650">&#34;dial&#34;</span><span class="op" id="3332656">,</span>&nbsp;<span class="ident" id="3332658">Net</span><span class="op" id="3332661">:</span>&nbsp;<span class="ident" id="3332663">netProto</span><span class="op" id="3332671">,</span>&nbsp;<span class="ident" id="3332673">Addr</span><span class="op" id="3332677">:</span>&nbsp;<span class="ident" id="3332679">raddr</span><span class="op" id="3332684">,</span>&nbsp;<span class="ident" id="3332686">Err</span><span class="op" id="3332689">:</span>&nbsp;<span class="ident" id="3332691">err</span><span class="op" id="3332694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3332697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332700">switch</span>&nbsp;<span class="ident" id="3332707">net</span>&nbsp;<span class="op" id="3332711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332714">case</span>&nbsp;<span class="string" id="3332719">&#34;ip&#34;</span><span class="op" id="3332723">,</span>&nbsp;<span class="string" id="3332725">&#34;ip4&#34;</span><span class="op" id="3332730">,</span>&nbsp;<span class="string" id="3332732">&#34;ip6&#34;</span><span class="op" id="3332737">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332740">default</span><span class="op" id="3332747">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332751">return</span>&nbsp;<span class="ident" id="3332758">nil</span><span class="op" id="3332761">,</span>&nbsp;<span class="op" id="3332763">&amp;</span><span class="ident" id="3332764">OpError</span><span class="op" id="3332771">{</span><span class="ident" id="3332772">Op</span><span class="op" id="3332774">:</span>&nbsp;<span class="string" id="3332776">&#34;dial&#34;</span><span class="op" id="3332782">,</span>&nbsp;<span class="ident" id="3332784">Net</span><span class="op" id="3332787">:</span>&nbsp;<span class="ident" id="3332789">netProto</span><span class="op" id="3332797">,</span>&nbsp;<span class="ident" id="3332799">Addr</span><span class="op" id="3332803">:</span>&nbsp;<span class="ident" id="3332805">raddr</span><span class="op" id="3332810">,</span>&nbsp;<span class="ident" id="3332812">Err</span><span class="op" id="3332815">:</span>&nbsp;<span class="ident" id="3332817">UnknownNetworkError</span><span class="op" id="3332836">(</span><span class="ident" id="3332837">netProto</span><span class="op" id="3332845">)</span><span class="op" id="3332846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3332849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332852">if</span>&nbsp;<span class="ident" id="3332855">raddr</span>&nbsp;<span class="op" id="3332861">==</span>&nbsp;<span class="ident" id="3332864">nil</span>&nbsp;<span class="op" id="3332868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3332872">return</span>&nbsp;<span class="ident" id="3332879">nil</span><span class="op" id="3332882">,</span>&nbsp;<span class="op" id="3332884">&amp;</span><span class="ident" id="3332885">OpError</span><span class="op" id="3332892">{</span><span class="ident" id="3332893">Op</span><span class="op" id="3332895">:</span>&nbsp;<span class="string" id="3332897">&#34;dial&#34;</span><span class="op" id="3332903">,</span>&nbsp;<span class="ident" id="3332905">Net</span><span class="op" id="3332908">:</span>&nbsp;<span class="ident" id="3332910">netProto</span><span class="op" id="3332918">,</span>&nbsp;<span class="ident" id="3332920">Addr</span><span class="op" id="3332924">:</span>&nbsp;<span class="ident" id="3332926">nil</span><span class="op" id="3332929">,</span>&nbsp;<span class="ident" id="3332931">Err</span><span class="op" id="3332934">:</span>&nbsp;<span class="ident" id="3332936">errMissingAddress</span><span class="op" id="3332953">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3332956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3332959">fd</span><span class="op" id="3332961">,</span>&nbsp;<span class="ident" id="3332963">err</span>&nbsp;<span class="op" id="3332967">:=</span>&nbsp;<span class="ident" id="3332970">internetSocket</span><span class="op" id="3332984">(</span><span class="ident" id="3332985">net</span><span class="op" id="3332988">,</span>&nbsp;<span class="ident" id="3332990">laddr</span><span class="op" id="3332995">,</span>&nbsp;<span class="ident" id="3332997">raddr</span><span class="op" id="3333002">,</span>&nbsp;<span class="ident" id="3333004">deadline</span><span class="op" id="3333012">,</span>&nbsp;<span class="ident" id="3333014">syscall</span><span class="op" id="3333021">.</span><span class="ident" id="3333022">SOCK_RAW</span><span class="op" id="3333030">,</span>&nbsp;<span class="ident" id="3333032">proto</span><span class="op" id="3333037">,</span>&nbsp;<span class="string" id="3333039">&#34;dial&#34;</span><span class="op" id="3333045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333048">if</span>&nbsp;<span class="ident" id="3333051">err</span>&nbsp;<span class="op" id="3333055">!=</span>&nbsp;<span class="ident" id="3333058">nil</span>&nbsp;<span class="op" id="3333062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333066">return</span>&nbsp;<span class="ident" id="3333073">nil</span><span class="op" id="3333076">,</span>&nbsp;<span class="op" id="3333078">&amp;</span><span class="ident" id="3333079">OpError</span><span class="op" id="3333086">{</span><span class="ident" id="3333087">Op</span><span class="op" id="3333089">:</span>&nbsp;<span class="string" id="3333091">&#34;dial&#34;</span><span class="op" id="3333097">,</span>&nbsp;<span class="ident" id="3333099">Net</span><span class="op" id="3333102">:</span>&nbsp;<span class="ident" id="3333104">netProto</span><span class="op" id="3333112">,</span>&nbsp;<span class="ident" id="3333114">Addr</span><span class="op" id="3333118">:</span>&nbsp;<span class="ident" id="3333120">raddr</span><span class="op" id="3333125">,</span>&nbsp;<span class="ident" id="3333127">Err</span><span class="op" id="3333130">:</span>&nbsp;<span class="ident" id="3333132">err</span><span class="op" id="3333135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3333138">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333141">return</span>&nbsp;<span class="ident" id="3333148">newIPConn</span><span class="op" id="3333157">(</span><span class="ident" id="3333158">fd</span><span class="op" id="3333160">)</span><span class="op" id="3333161">,</span>&nbsp;<span class="ident" id="3333163">nil</span><br>
<span class="lineno"></span><span class="op" id="3333167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3333170">//&nbsp;ListenIP&nbsp;listens&nbsp;for&nbsp;incoming&nbsp;IP&nbsp;packets&nbsp;addressed&nbsp;to&nbsp;the&nbsp;local</span><br>
<span class="lineno"></span><span class="comment" id="3333237">//&nbsp;address&nbsp;laddr.&nbsp;&nbsp;The&nbsp;returned&nbsp;connection&#39;s&nbsp;ReadFrom&nbsp;and&nbsp;WriteTo</span><br>
<span class="lineno">210</span><span class="comment" id="3333303">//&nbsp;methods&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;receive&nbsp;and&nbsp;send&nbsp;IP&nbsp;packets&nbsp;with&nbsp;per-packet</span><br>
<span class="lineno"></span><span class="comment" id="3333373">//&nbsp;addressing.</span><br>
<span class="lineno"></span><span class="keyword" id="3333388">func</span>&nbsp;<span class="ident" id="3333393">ListenIP</span><span class="op" id="3333401">(</span><span class="ident" id="3333402">netProto</span>&nbsp;<span class="builtintype" id="3333411">string</span><span class="op" id="3333417">,</span>&nbsp;<span class="ident" id="3333419">laddr</span>&nbsp;<span class="op" id="3333425">*</span><span class="ident" id="3333426">IPAddr</span><span class="op" id="3333432">)</span>&nbsp;<span class="op" id="3333434">(</span><span class="op" id="3333435">*</span><span class="ident" id="3333436">IPConn</span><span class="op" id="3333442">,</span>&nbsp;<span class="builtintype" id="3333444">error</span><span class="op" id="3333449">)</span>&nbsp;<span class="op" id="3333451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3333454">net</span><span class="op" id="3333457">,</span>&nbsp;<span class="ident" id="3333459">proto</span><span class="op" id="3333464">,</span>&nbsp;<span class="ident" id="3333466">err</span>&nbsp;<span class="op" id="3333470">:=</span>&nbsp;<span class="ident" id="3333473">parseNetwork</span><span class="op" id="3333485">(</span><span class="ident" id="3333486">netProto</span><span class="op" id="3333494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333497">if</span>&nbsp;<span class="ident" id="3333500">err</span>&nbsp;<span class="op" id="3333504">!=</span>&nbsp;<span class="ident" id="3333507">nil</span>&nbsp;<span class="op" id="3333511">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333515">return</span>&nbsp;<span class="ident" id="3333522">nil</span><span class="op" id="3333525">,</span>&nbsp;<span class="op" id="3333527">&amp;</span><span class="ident" id="3333528">OpError</span><span class="op" id="3333535">{</span><span class="ident" id="3333536">Op</span><span class="op" id="3333538">:</span>&nbsp;<span class="string" id="3333540">&#34;dial&#34;</span><span class="op" id="3333546">,</span>&nbsp;<span class="ident" id="3333548">Net</span><span class="op" id="3333551">:</span>&nbsp;<span class="ident" id="3333553">netProto</span><span class="op" id="3333561">,</span>&nbsp;<span class="ident" id="3333563">Addr</span><span class="op" id="3333567">:</span>&nbsp;<span class="ident" id="3333569">laddr</span><span class="op" id="3333574">,</span>&nbsp;<span class="ident" id="3333576">Err</span><span class="op" id="3333579">:</span>&nbsp;<span class="ident" id="3333581">err</span><span class="op" id="3333584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3333587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333590">switch</span>&nbsp;<span class="ident" id="3333597">net</span>&nbsp;<span class="op" id="3333601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333604">case</span>&nbsp;<span class="string" id="3333609">&#34;ip&#34;</span><span class="op" id="3333613">,</span>&nbsp;<span class="string" id="3333615">&#34;ip4&#34;</span><span class="op" id="3333620">,</span>&nbsp;<span class="string" id="3333622">&#34;ip6&#34;</span><span class="op" id="3333627">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333630">default</span><span class="op" id="3333637">:</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333641">return</span>&nbsp;<span class="ident" id="3333648">nil</span><span class="op" id="3333651">,</span>&nbsp;<span class="op" id="3333653">&amp;</span><span class="ident" id="3333654">OpError</span><span class="op" id="3333661">{</span><span class="ident" id="3333662">Op</span><span class="op" id="3333664">:</span>&nbsp;<span class="string" id="3333666">&#34;listen&#34;</span><span class="op" id="3333674">,</span>&nbsp;<span class="ident" id="3333676">Net</span><span class="op" id="3333679">:</span>&nbsp;<span class="ident" id="3333681">netProto</span><span class="op" id="3333689">,</span>&nbsp;<span class="ident" id="3333691">Addr</span><span class="op" id="3333695">:</span>&nbsp;<span class="ident" id="3333697">laddr</span><span class="op" id="3333702">,</span>&nbsp;<span class="ident" id="3333704">Err</span><span class="op" id="3333707">:</span>&nbsp;<span class="ident" id="3333709">UnknownNetworkError</span><span class="op" id="3333728">(</span><span class="ident" id="3333729">netProto</span><span class="op" id="3333737">)</span><span class="op" id="3333738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3333741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3333744">fd</span><span class="op" id="3333746">,</span>&nbsp;<span class="ident" id="3333748">err</span>&nbsp;<span class="op" id="3333752">:=</span>&nbsp;<span class="ident" id="3333755">internetSocket</span><span class="op" id="3333769">(</span><span class="ident" id="3333770">net</span><span class="op" id="3333773">,</span>&nbsp;<span class="ident" id="3333775">laddr</span><span class="op" id="3333780">,</span>&nbsp;<span class="ident" id="3333782">nil</span><span class="op" id="3333785">,</span>&nbsp;<span class="ident" id="3333787">noDeadline</span><span class="op" id="3333797">,</span>&nbsp;<span class="ident" id="3333799">syscall</span><span class="op" id="3333806">.</span><span class="ident" id="3333807">SOCK_RAW</span><span class="op" id="3333815">,</span>&nbsp;<span class="ident" id="3333817">proto</span><span class="op" id="3333822">,</span>&nbsp;<span class="string" id="3333824">&#34;listen&#34;</span><span class="op" id="3333832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333835">if</span>&nbsp;<span class="ident" id="3333838">err</span>&nbsp;<span class="op" id="3333842">!=</span>&nbsp;<span class="ident" id="3333845">nil</span>&nbsp;<span class="op" id="3333849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333853">return</span>&nbsp;<span class="ident" id="3333860">nil</span><span class="op" id="3333863">,</span>&nbsp;<span class="op" id="3333865">&amp;</span><span class="ident" id="3333866">OpError</span><span class="op" id="3333873">{</span><span class="ident" id="3333874">Op</span><span class="op" id="3333876">:</span>&nbsp;<span class="string" id="3333878">&#34;listen&#34;</span><span class="op" id="3333886">,</span>&nbsp;<span class="ident" id="3333888">Net</span><span class="op" id="3333891">:</span>&nbsp;<span class="ident" id="3333893">netProto</span><span class="op" id="3333901">,</span>&nbsp;<span class="ident" id="3333903">Addr</span><span class="op" id="3333907">:</span>&nbsp;<span class="ident" id="3333909">laddr</span><span class="op" id="3333914">,</span>&nbsp;<span class="ident" id="3333916">Err</span><span class="op" id="3333919">:</span>&nbsp;<span class="ident" id="3333921">err</span><span class="op" id="3333924">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3333927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3333930">return</span>&nbsp;<span class="ident" id="3333937">newIPConn</span><span class="op" id="3333946">(</span><span class="ident" id="3333947">fd</span><span class="op" id="3333949">)</span><span class="op" id="3333950">,</span>&nbsp;<span class="ident" id="3333952">nil</span><br>
<span class="lineno"></span><span class="op" id="3333956">}</span>
</div>
</body>
</html>
