<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html" class="current">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7917747">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7917802">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7917856">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7917907">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7917933">package</span>&nbsp;<span class="ident" id="7917941">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7917946">import</span>&nbsp;<span class="op" id="7917953">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7917956">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7917965">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7917972">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7917978">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7917985">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7917997">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7918018">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7918024">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7918035">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7918052">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7918063">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7918074">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7918085">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7918096">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7918103">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="7918106">func</span>&nbsp;<span class="ident" id="7918111">newRequest</span><span class="op" id="7918121">(</span><span class="ident" id="7918122">httpreq</span>&nbsp;<span class="builtintype" id="7918130">string</span><span class="op" id="7918136">)</span>&nbsp;<span class="op" id="7918138">*</span><span class="ident" id="7918139">http</span><span class="op" id="7918143">.</span><span class="ident" id="7918144">Request</span>&nbsp;<span class="op" id="7918152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918155">buf</span>&nbsp;<span class="op" id="7918159">:=</span>&nbsp;<span class="ident" id="7918162">bufio</span><span class="op" id="7918167">.</span><span class="ident" id="7918168">NewReader</span><span class="op" id="7918177">(</span><span class="ident" id="7918178">strings</span><span class="op" id="7918185">.</span><span class="ident" id="7918186">NewReader</span><span class="op" id="7918195">(</span><span class="ident" id="7918196">httpreq</span><span class="op" id="7918203">)</span><span class="op" id="7918204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918207">req</span><span class="op" id="7918210">,</span>&nbsp;<span class="ident" id="7918212">err</span>&nbsp;<span class="op" id="7918216">:=</span>&nbsp;<span class="ident" id="7918219">http</span><span class="op" id="7918223">.</span><span class="ident" id="7918224">ReadRequest</span><span class="op" id="7918235">(</span><span class="ident" id="7918236">buf</span><span class="op" id="7918239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7918242">if</span>&nbsp;<span class="ident" id="7918245">err</span>&nbsp;<span class="op" id="7918249">!=</span>&nbsp;<span class="builtintype" id="7918252">nil</span>&nbsp;<span class="op" id="7918256">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7918260">panic</span><span class="op" id="7918265">(</span><span class="string" id="7918266">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="7918302">+</span>&nbsp;<span class="ident" id="7918304">httpreq</span><span class="op" id="7918311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7918314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918317">req</span><span class="op" id="7918320">.</span><span class="ident" id="7918321">RemoteAddr</span>&nbsp;<span class="op" id="7918332">=</span>&nbsp;<span class="string" id="7918334">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7918345">return</span>&nbsp;<span class="ident" id="7918352">req</span><br>
<span class="lineno"></span><span class="op" id="7918356">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="7918359">func</span>&nbsp;<span class="ident" id="7918364">runCgiTest</span><span class="op" id="7918374">(</span><span class="ident" id="7918375">t</span>&nbsp;<span class="op" id="7918377">*</span><span class="ident" id="7918378">testing</span><span class="op" id="7918385">.</span><span class="ident" id="7918386">T</span><span class="op" id="7918387">,</span>&nbsp;<span class="ident" id="7918389">h</span>&nbsp;<span class="op" id="7918391">*</span><span class="ident" id="7918392">Handler</span><span class="op" id="7918399">,</span>&nbsp;<span class="ident" id="7918401">httpreq</span>&nbsp;<span class="builtintype" id="7918409">string</span><span class="op" id="7918415">,</span>&nbsp;<span class="ident" id="7918417">expectedMap</span>&nbsp;<span class="keyword" id="7918429">map</span><span class="op" id="7918432">[</span><span class="builtintype" id="7918433">string</span><span class="op" id="7918439">]</span><span class="builtintype" id="7918440">string</span><span class="op" id="7918446">)</span>&nbsp;<span class="op" id="7918448">*</span><span class="ident" id="7918449">httptest</span><span class="op" id="7918457">.</span><span class="ident" id="7918458">ResponseRecorder</span>&nbsp;<span class="op" id="7918475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918478">rw</span>&nbsp;<span class="op" id="7918481">:=</span>&nbsp;<span class="ident" id="7918484">httptest</span><span class="op" id="7918492">.</span><span class="ident" id="7918493">NewRecorder</span><span class="op" id="7918504">(</span><span class="op" id="7918505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918508">req</span>&nbsp;<span class="op" id="7918512">:=</span>&nbsp;<span class="ident" id="7918515">newRequest</span><span class="op" id="7918525">(</span><span class="ident" id="7918526">httpreq</span><span class="op" id="7918533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918536">h</span><span class="op" id="7918537">.</span><span class="ident" id="7918538">ServeHTTP</span><span class="op" id="7918547">(</span><span class="ident" id="7918548">rw</span><span class="op" id="7918550">,</span>&nbsp;<span class="ident" id="7918552">req</span><span class="op" id="7918555">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7918559">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918617">m</span>&nbsp;<span class="op" id="7918619">:=</span>&nbsp;<span class="builtinfunc" id="7918622">make</span><span class="op" id="7918626">(</span><span class="keyword" id="7918627">map</span><span class="op" id="7918630">[</span><span class="builtintype" id="7918631">string</span><span class="op" id="7918637">]</span><span class="builtintype" id="7918638">string</span><span class="op" id="7918644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918647">m</span><span class="op" id="7918648">[</span><span class="string" id="7918649">&#34;_body&#34;</span><span class="op" id="7918656">]</span>&nbsp;<span class="op" id="7918658">=</span>&nbsp;<span class="ident" id="7918660">rw</span><span class="op" id="7918662">.</span><span class="ident" id="7918663">Body</span><span class="op" id="7918667">.</span><span class="ident" id="7918668">String</span><span class="op" id="7918674">(</span><span class="op" id="7918675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918678">linesRead</span>&nbsp;<span class="op" id="7918688">:=</span>&nbsp;<span class="num" id="7918691">0</span><br>
<span class="lineno">45</span><span class="ident" id="7918693">readlines</span><span class="op" id="7918702">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7918705">for</span>&nbsp;<span class="op" id="7918709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918713">line</span><span class="op" id="7918717">,</span>&nbsp;<span class="ident" id="7918719">err</span>&nbsp;<span class="op" id="7918723">:=</span>&nbsp;<span class="ident" id="7918726">rw</span><span class="op" id="7918728">.</span><span class="ident" id="7918729">Body</span><span class="op" id="7918733">.</span><span class="ident" id="7918734">ReadString</span><span class="op" id="7918744">(</span><span class="string" id="7918745">&#39;\n&#39;</span><span class="op" id="7918749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7918753">switch</span>&nbsp;<span class="op" id="7918760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7918764">case</span>&nbsp;<span class="ident" id="7918769">err</span>&nbsp;<span class="op" id="7918773">==</span>&nbsp;<span class="ident" id="7918776">io</span><span class="op" id="7918778">.</span><span class="ident" id="7918779">EOF</span><span class="op" id="7918782">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7918787">break</span>&nbsp;<span class="ident" id="7918793">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7918805">case</span>&nbsp;<span class="ident" id="7918810">err</span>&nbsp;<span class="op" id="7918814">!=</span>&nbsp;<span class="builtintype" id="7918817">nil</span><span class="op" id="7918820">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918825">t</span><span class="op" id="7918826">.</span><span class="ident" id="7918827">Fatalf</span><span class="op" id="7918833">(</span><span class="string" id="7918834">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="7918873">,</span>&nbsp;<span class="ident" id="7918875">err</span><span class="op" id="7918878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7918882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918886">linesRead</span><span class="op" id="7918895">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918900">trimmedLine</span>&nbsp;<span class="op" id="7918912">:=</span>&nbsp;<span class="ident" id="7918915">strings</span><span class="op" id="7918922">.</span><span class="ident" id="7918923">TrimRight</span><span class="op" id="7918932">(</span><span class="ident" id="7918933">line</span><span class="op" id="7918937">,</span>&nbsp;<span class="string" id="7918939">&#34;\r\n&#34;</span><span class="op" id="7918945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7918949">split</span>&nbsp;<span class="op" id="7918955">:=</span>&nbsp;<span class="ident" id="7918958">strings</span><span class="op" id="7918965">.</span><span class="ident" id="7918966">SplitN</span><span class="op" id="7918972">(</span><span class="ident" id="7918973">trimmedLine</span><span class="op" id="7918984">,</span>&nbsp;<span class="string" id="7918986">&#34;=&#34;</span><span class="op" id="7918989">,</span>&nbsp;<span class="num" id="7918991">2</span><span class="op" id="7918992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7918996">if</span>&nbsp;<span class="builtinfunc" id="7918999">len</span><span class="op" id="7919002">(</span><span class="ident" id="7919003">split</span><span class="op" id="7919008">)</span>&nbsp;<span class="op" id="7919010">!=</span>&nbsp;<span class="num" id="7919013">2</span>&nbsp;<span class="op" id="7919015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919020">t</span><span class="op" id="7919021">.</span><span class="ident" id="7919022">Fatalf</span><span class="op" id="7919028">(</span><span class="string" id="7919029">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="7919099">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7919105">len</span><span class="op" id="7919108">(</span><span class="ident" id="7919109">split</span><span class="op" id="7919114">)</span><span class="op" id="7919115">,</span>&nbsp;<span class="ident" id="7919117">linesRead</span><span class="op" id="7919126">,</span>&nbsp;<span class="ident" id="7919128">line</span><span class="op" id="7919132">,</span>&nbsp;<span class="ident" id="7919134">m</span><span class="op" id="7919135">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7919139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919143">m</span><span class="op" id="7919144">[</span><span class="ident" id="7919145">split</span><span class="op" id="7919150">[</span><span class="num" id="7919151">0</span><span class="op" id="7919152">]</span><span class="op" id="7919153">]</span>&nbsp;<span class="op" id="7919155">=</span>&nbsp;<span class="ident" id="7919157">split</span><span class="op" id="7919162">[</span><span class="num" id="7919163">1</span><span class="op" id="7919164">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7919167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7919171">for</span>&nbsp;<span class="ident" id="7919175">key</span><span class="op" id="7919178">,</span>&nbsp;<span class="ident" id="7919180">expected</span>&nbsp;<span class="op" id="7919189">:=</span>&nbsp;<span class="keyword" id="7919192">range</span>&nbsp;<span class="ident" id="7919198">expectedMap</span>&nbsp;<span class="op" id="7919210">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919214">got</span>&nbsp;<span class="op" id="7919218">:=</span>&nbsp;<span class="ident" id="7919221">m</span><span class="op" id="7919222">[</span><span class="ident" id="7919223">key</span><span class="op" id="7919226">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7919230">if</span>&nbsp;<span class="ident" id="7919233">key</span>&nbsp;<span class="op" id="7919237">==</span>&nbsp;<span class="string" id="7919240">&#34;cwd&#34;</span>&nbsp;<span class="op" id="7919246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7919251">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919293">fi1</span><span class="op" id="7919296">,</span>&nbsp;<span class="ident" id="7919298">_</span>&nbsp;<span class="op" id="7919300">:=</span>&nbsp;<span class="ident" id="7919303">os</span><span class="op" id="7919305">.</span><span class="ident" id="7919306">Stat</span><span class="op" id="7919310">(</span><span class="ident" id="7919311">got</span><span class="op" id="7919314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919319">fi2</span><span class="op" id="7919322">,</span>&nbsp;<span class="ident" id="7919324">_</span>&nbsp;<span class="op" id="7919326">:=</span>&nbsp;<span class="ident" id="7919329">os</span><span class="op" id="7919331">.</span><span class="ident" id="7919332">Stat</span><span class="op" id="7919336">(</span><span class="ident" id="7919337">expected</span><span class="op" id="7919345">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7919350">if</span>&nbsp;<span class="ident" id="7919353">os</span><span class="op" id="7919355">.</span><span class="ident" id="7919356">SameFile</span><span class="op" id="7919364">(</span><span class="ident" id="7919365">fi1</span><span class="op" id="7919368">,</span>&nbsp;<span class="ident" id="7919370">fi2</span><span class="op" id="7919373">)</span>&nbsp;<span class="op" id="7919375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919381">got</span>&nbsp;<span class="op" id="7919385">=</span>&nbsp;<span class="ident" id="7919387">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7919399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7919403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7919407">if</span>&nbsp;<span class="ident" id="7919410">got</span>&nbsp;<span class="op" id="7919414">!=</span>&nbsp;<span class="ident" id="7919417">expected</span>&nbsp;<span class="op" id="7919426">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919431">t</span><span class="op" id="7919432">.</span><span class="ident" id="7919433">Errorf</span><span class="op" id="7919439">(</span><span class="string" id="7919440">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7919472">,</span>&nbsp;<span class="ident" id="7919474">key</span><span class="op" id="7919477">,</span>&nbsp;<span class="ident" id="7919479">got</span><span class="op" id="7919482">,</span>&nbsp;<span class="ident" id="7919484">expected</span><span class="op" id="7919492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7919496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7919499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7919502">return</span>&nbsp;<span class="ident" id="7919509">rw</span><br>
<span class="lineno"></span><span class="op" id="7919512">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="7919515">var</span>&nbsp;<span class="ident" id="7919519">cgiTested</span><span class="op" id="7919528">,</span>&nbsp;<span class="ident" id="7919530">cgiWorks</span>&nbsp;<span class="builtintype" id="7919539">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7919545">func</span>&nbsp;<span class="ident" id="7919550">check</span><span class="op" id="7919555">(</span><span class="ident" id="7919556">t</span>&nbsp;<span class="op" id="7919558">*</span><span class="ident" id="7919559">testing</span><span class="op" id="7919566">.</span><span class="ident" id="7919567">T</span><span class="op" id="7919568">)</span>&nbsp;<span class="op" id="7919570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7919573">if</span>&nbsp;<span class="op" id="7919576">!</span><span class="ident" id="7919577">cgiTested</span>&nbsp;<span class="op" id="7919587">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919591">cgiTested</span>&nbsp;<span class="op" id="7919601">=</span>&nbsp;<span class="builtintype" id="7919603">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919610">cgiWorks</span>&nbsp;<span class="op" id="7919619">=</span>&nbsp;<span class="ident" id="7919621">exec</span><span class="op" id="7919625">.</span><span class="ident" id="7919626">Command</span><span class="op" id="7919633">(</span><span class="string" id="7919634">&#34;./testdata/test.cgi&#34;</span><span class="op" id="7919655">)</span><span class="op" id="7919656">.</span><span class="ident" id="7919657">Run</span><span class="op" id="7919660">(</span><span class="op" id="7919661">)</span>&nbsp;<span class="op" id="7919663">==</span>&nbsp;<span class="builtintype" id="7919666">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7919671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7919674">if</span>&nbsp;<span class="op" id="7919677">!</span><span class="ident" id="7919678">cgiWorks</span>&nbsp;<span class="op" id="7919687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7919691">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7919735">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919786">t</span><span class="op" id="7919787">.</span><span class="ident" id="7919788">Skip</span><span class="op" id="7919792">(</span><span class="string" id="7919793">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="7919826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7919829">}</span><br>
<span class="lineno"></span><span class="op" id="7919831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7919834">func</span>&nbsp;<span class="ident" id="7919839">TestCGIBasicGet</span><span class="op" id="7919854">(</span><span class="ident" id="7919855">t</span>&nbsp;<span class="op" id="7919857">*</span><span class="ident" id="7919858">testing</span><span class="op" id="7919865">.</span><span class="ident" id="7919866">T</span><span class="op" id="7919867">)</span>&nbsp;<span class="op" id="7919869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919872">check</span><span class="op" id="7919877">(</span><span class="ident" id="7919878">t</span><span class="op" id="7919879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919882">h</span>&nbsp;<span class="op" id="7919884">:=</span>&nbsp;<span class="op" id="7919887">&amp;</span><span class="ident" id="7919888">Handler</span><span class="op" id="7919895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919899">Path</span><span class="op" id="7919903">:</span>&nbsp;<span class="string" id="7919905">&#34;testdata/test.cgi&#34;</span><span class="op" id="7919924">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919928">Root</span><span class="op" id="7919932">:</span>&nbsp;<span class="string" id="7919934">&#34;/test.cgi&#34;</span><span class="op" id="7919945">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7919948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7919951">expectedMap</span>&nbsp;<span class="op" id="7919963">:=</span>&nbsp;<span class="keyword" id="7919966">map</span><span class="op" id="7919969">[</span><span class="builtintype" id="7919970">string</span><span class="op" id="7919976">]</span><span class="builtintype" id="7919977">string</span><span class="op" id="7919983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7919987">&#34;test&#34;</span><span class="op" id="7919993">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920012">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="7920023">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920027">&#34;param-a&#34;</span><span class="op" id="7920036">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920052">&#34;b&#34;</span><span class="op" id="7920055">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920059">&#34;param-foo&#34;</span><span class="op" id="7920070">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920084">&#34;bar&#34;</span><span class="op" id="7920089">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920093">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7920116">:</span>&nbsp;<span class="string" id="7920118">&#34;CGI/1.1&#34;</span><span class="op" id="7920127">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920131">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7920146">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920156">&#34;example.com&#34;</span><span class="op" id="7920169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920173">&#34;env-PATH_INFO&#34;</span><span class="op" id="7920188">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920198">&#34;&#34;</span><span class="op" id="7920200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920204">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7920222">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920229">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7920242">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920246">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7920263">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920271">&#34;1.2.3.4&#34;</span><span class="op" id="7920280">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920284">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7920301">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920309">&#34;1.2.3.4&#34;</span><span class="op" id="7920318">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920322">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7920342">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920347">&#34;GET&#34;</span><span class="op" id="7920352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920356">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7920373">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920381">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="7920404">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920408">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7920429">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7920433">&#34;testdata/test.cgi&#34;</span><span class="op" id="7920452">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920456">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7920473">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920481">&#34;/test.cgi&#34;</span><span class="op" id="7920492">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920496">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7920513">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920521">&#34;example.com&#34;</span><span class="op" id="7920534">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920538">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7920555">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920563">&#34;80&#34;</span><span class="op" id="7920567">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7920571">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7920592">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7920596">&#34;go&#34;</span><span class="op" id="7920600">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7920603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7920606">replay</span>&nbsp;<span class="op" id="7920613">:=</span>&nbsp;<span class="ident" id="7920616">runCgiTest</span><span class="op" id="7920626">(</span><span class="ident" id="7920627">t</span><span class="op" id="7920628">,</span>&nbsp;<span class="ident" id="7920630">h</span><span class="op" id="7920631">,</span>&nbsp;<span class="string" id="7920633">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7920692">,</span>&nbsp;<span class="ident" id="7920694">expectedMap</span><span class="op" id="7920705">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7920709">if</span>&nbsp;<span class="ident" id="7920712">expected</span><span class="op" id="7920720">,</span>&nbsp;<span class="ident" id="7920722">got</span>&nbsp;<span class="op" id="7920726">:=</span>&nbsp;<span class="string" id="7920729">&#34;text/html&#34;</span><span class="op" id="7920740">,</span>&nbsp;<span class="ident" id="7920742">replay</span><span class="op" id="7920748">.</span><span class="ident" id="7920749">Header</span><span class="op" id="7920755">(</span><span class="op" id="7920756">)</span><span class="op" id="7920757">.</span><span class="ident" id="7920758">Get</span><span class="op" id="7920761">(</span><span class="string" id="7920762">&#34;Content-Type&#34;</span><span class="op" id="7920776">)</span><span class="op" id="7920777">;</span>&nbsp;<span class="ident" id="7920779">got</span>&nbsp;<span class="op" id="7920783">!=</span>&nbsp;<span class="ident" id="7920786">expected</span>&nbsp;<span class="op" id="7920795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7920799">t</span><span class="op" id="7920800">.</span><span class="ident" id="7920801">Errorf</span><span class="op" id="7920807">(</span><span class="string" id="7920808">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7920847">,</span>&nbsp;<span class="ident" id="7920849">got</span><span class="op" id="7920852">,</span>&nbsp;<span class="ident" id="7920854">expected</span><span class="op" id="7920862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7920865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7920868">if</span>&nbsp;<span class="ident" id="7920871">expected</span><span class="op" id="7920879">,</span>&nbsp;<span class="ident" id="7920881">got</span>&nbsp;<span class="op" id="7920885">:=</span>&nbsp;<span class="string" id="7920888">&#34;X-Test-Value&#34;</span><span class="op" id="7920902">,</span>&nbsp;<span class="ident" id="7920904">replay</span><span class="op" id="7920910">.</span><span class="ident" id="7920911">Header</span><span class="op" id="7920917">(</span><span class="op" id="7920918">)</span><span class="op" id="7920919">.</span><span class="ident" id="7920920">Get</span><span class="op" id="7920923">(</span><span class="string" id="7920924">&#34;X-Test-Header&#34;</span><span class="op" id="7920939">)</span><span class="op" id="7920940">;</span>&nbsp;<span class="ident" id="7920942">got</span>&nbsp;<span class="op" id="7920946">!=</span>&nbsp;<span class="ident" id="7920949">expected</span>&nbsp;<span class="op" id="7920958">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7920962">t</span><span class="op" id="7920963">.</span><span class="ident" id="7920964">Errorf</span><span class="op" id="7920970">(</span><span class="string" id="7920971">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7921011">,</span>&nbsp;<span class="ident" id="7921013">got</span><span class="op" id="7921016">,</span>&nbsp;<span class="ident" id="7921018">expected</span><span class="op" id="7921026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7921029">}</span><br>
<span class="lineno"></span><span class="op" id="7921031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7921034">func</span>&nbsp;<span class="ident" id="7921039">TestCGIBasicGetAbsPath</span><span class="op" id="7921061">(</span><span class="ident" id="7921062">t</span>&nbsp;<span class="op" id="7921064">*</span><span class="ident" id="7921065">testing</span><span class="op" id="7921072">.</span><span class="ident" id="7921073">T</span><span class="op" id="7921074">)</span>&nbsp;<span class="op" id="7921076">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921079">check</span><span class="op" id="7921084">(</span><span class="ident" id="7921085">t</span><span class="op" id="7921086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921089">pwd</span><span class="op" id="7921092">,</span>&nbsp;<span class="ident" id="7921094">err</span>&nbsp;<span class="op" id="7921098">:=</span>&nbsp;<span class="ident" id="7921101">os</span><span class="op" id="7921103">.</span><span class="ident" id="7921104">Getwd</span><span class="op" id="7921109">(</span><span class="op" id="7921110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7921113">if</span>&nbsp;<span class="ident" id="7921116">err</span>&nbsp;<span class="op" id="7921120">!=</span>&nbsp;<span class="builtintype" id="7921123">nil</span>&nbsp;<span class="op" id="7921127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921131">t</span><span class="op" id="7921132">.</span><span class="ident" id="7921133">Fatalf</span><span class="op" id="7921139">(</span><span class="string" id="7921140">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7921157">,</span>&nbsp;<span class="ident" id="7921159">err</span><span class="op" id="7921162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7921165">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921168">h</span>&nbsp;<span class="op" id="7921170">:=</span>&nbsp;<span class="op" id="7921173">&amp;</span><span class="ident" id="7921174">Handler</span><span class="op" id="7921181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921185">Path</span><span class="op" id="7921189">:</span>&nbsp;<span class="ident" id="7921191">pwd</span>&nbsp;<span class="op" id="7921195">+</span>&nbsp;<span class="string" id="7921197">&#34;/testdata/test.cgi&#34;</span><span class="op" id="7921217">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921221">Root</span><span class="op" id="7921225">:</span>&nbsp;<span class="string" id="7921227">&#34;/test.cgi&#34;</span><span class="op" id="7921238">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7921241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921244">expectedMap</span>&nbsp;<span class="op" id="7921256">:=</span>&nbsp;<span class="keyword" id="7921259">map</span><span class="op" id="7921262">[</span><span class="builtintype" id="7921263">string</span><span class="op" id="7921269">]</span><span class="builtintype" id="7921270">string</span><span class="op" id="7921276">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921280">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7921297">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921303">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="7921326">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921330">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7921351">:</span>&nbsp;<span class="ident" id="7921353">pwd</span>&nbsp;<span class="op" id="7921357">+</span>&nbsp;<span class="string" id="7921359">&#34;/testdata/test.cgi&#34;</span><span class="op" id="7921379">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921383">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7921400">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921406">&#34;/test.cgi&#34;</span><span class="op" id="7921417">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7921420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921423">runCgiTest</span><span class="op" id="7921433">(</span><span class="ident" id="7921434">t</span><span class="op" id="7921435">,</span>&nbsp;<span class="ident" id="7921437">h</span><span class="op" id="7921438">,</span>&nbsp;<span class="string" id="7921440">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7921499">,</span>&nbsp;<span class="ident" id="7921501">expectedMap</span><span class="op" id="7921512">)</span><br>
<span class="lineno">145</span><span class="op" id="7921514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7921517">func</span>&nbsp;<span class="ident" id="7921522">TestPathInfo</span><span class="op" id="7921534">(</span><span class="ident" id="7921535">t</span>&nbsp;<span class="op" id="7921537">*</span><span class="ident" id="7921538">testing</span><span class="op" id="7921545">.</span><span class="ident" id="7921546">T</span><span class="op" id="7921547">)</span>&nbsp;<span class="op" id="7921549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921552">check</span><span class="op" id="7921557">(</span><span class="ident" id="7921558">t</span><span class="op" id="7921559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921562">h</span>&nbsp;<span class="op" id="7921564">:=</span>&nbsp;<span class="op" id="7921567">&amp;</span><span class="ident" id="7921568">Handler</span><span class="op" id="7921575">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921579">Path</span><span class="op" id="7921583">:</span>&nbsp;<span class="string" id="7921585">&#34;testdata/test.cgi&#34;</span><span class="op" id="7921604">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921608">Root</span><span class="op" id="7921612">:</span>&nbsp;<span class="string" id="7921614">&#34;/test.cgi&#34;</span><span class="op" id="7921625">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7921628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921631">expectedMap</span>&nbsp;<span class="op" id="7921643">:=</span>&nbsp;<span class="keyword" id="7921646">map</span><span class="op" id="7921649">[</span><span class="builtintype" id="7921650">string</span><span class="op" id="7921656">]</span><span class="builtintype" id="7921657">string</span><span class="op" id="7921663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921667">&#34;param-a&#34;</span><span class="op" id="7921676">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921690">&#34;b&#34;</span><span class="op" id="7921693">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921697">&#34;env-PATH_INFO&#34;</span><span class="op" id="7921712">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921720">&#34;/extrapath&#34;</span><span class="op" id="7921732">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921736">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7921754">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921759">&#34;a=b&#34;</span><span class="op" id="7921764">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921768">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7921785">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921791">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="7921816">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921820">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7921841">:</span>&nbsp;<span class="string" id="7921843">&#34;testdata/test.cgi&#34;</span><span class="op" id="7921862">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921866">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7921883">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7921889">&#34;/test.cgi&#34;</span><span class="op" id="7921900">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7921903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7921906">runCgiTest</span><span class="op" id="7921916">(</span><span class="ident" id="7921917">t</span><span class="op" id="7921918">,</span>&nbsp;<span class="ident" id="7921920">h</span><span class="op" id="7921921">,</span>&nbsp;<span class="string" id="7921923">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7921984">,</span>&nbsp;<span class="ident" id="7921986">expectedMap</span><span class="op" id="7921997">)</span><br>
<span class="lineno"></span><span class="op" id="7921999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7922002">func</span>&nbsp;<span class="ident" id="7922007">TestPathInfoDirRoot</span><span class="op" id="7922026">(</span><span class="ident" id="7922027">t</span>&nbsp;<span class="op" id="7922029">*</span><span class="ident" id="7922030">testing</span><span class="op" id="7922037">.</span><span class="ident" id="7922038">T</span><span class="op" id="7922039">)</span>&nbsp;<span class="op" id="7922041">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922044">check</span><span class="op" id="7922049">(</span><span class="ident" id="7922050">t</span><span class="op" id="7922051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922054">h</span>&nbsp;<span class="op" id="7922056">:=</span>&nbsp;<span class="op" id="7922059">&amp;</span><span class="ident" id="7922060">Handler</span><span class="op" id="7922067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922071">Path</span><span class="op" id="7922075">:</span>&nbsp;<span class="string" id="7922077">&#34;testdata/test.cgi&#34;</span><span class="op" id="7922096">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922100">Root</span><span class="op" id="7922104">:</span>&nbsp;<span class="string" id="7922106">&#34;/myscript/&#34;</span><span class="op" id="7922118">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7922121">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922124">expectedMap</span>&nbsp;<span class="op" id="7922136">:=</span>&nbsp;<span class="keyword" id="7922139">map</span><span class="op" id="7922142">[</span><span class="builtintype" id="7922143">string</span><span class="op" id="7922149">]</span><span class="builtintype" id="7922150">string</span><span class="op" id="7922156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922160">&#34;env-PATH_INFO&#34;</span><span class="op" id="7922175">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922183">&#34;bar&#34;</span><span class="op" id="7922188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922192">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7922210">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922215">&#34;a=b&#34;</span><span class="op" id="7922220">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922224">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7922241">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922247">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="7922266">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922270">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7922291">:</span>&nbsp;<span class="string" id="7922293">&#34;testdata/test.cgi&#34;</span><span class="op" id="7922312">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922316">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7922333">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922339">&#34;/myscript/&#34;</span><span class="op" id="7922351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7922354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922357">runCgiTest</span><span class="op" id="7922367">(</span><span class="ident" id="7922368">t</span><span class="op" id="7922369">,</span>&nbsp;<span class="ident" id="7922371">h</span><span class="op" id="7922372">,</span>&nbsp;<span class="string" id="7922374">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7922429">,</span>&nbsp;<span class="ident" id="7922431">expectedMap</span><span class="op" id="7922442">)</span><br>
<span class="lineno"></span><span class="op" id="7922444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7922447">func</span>&nbsp;<span class="ident" id="7922452">TestDupHeaders</span><span class="op" id="7922466">(</span><span class="ident" id="7922467">t</span>&nbsp;<span class="op" id="7922469">*</span><span class="ident" id="7922470">testing</span><span class="op" id="7922477">.</span><span class="ident" id="7922478">T</span><span class="op" id="7922479">)</span>&nbsp;<span class="op" id="7922481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922484">check</span><span class="op" id="7922489">(</span><span class="ident" id="7922490">t</span><span class="op" id="7922491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922494">h</span>&nbsp;<span class="op" id="7922496">:=</span>&nbsp;<span class="op" id="7922499">&amp;</span><span class="ident" id="7922500">Handler</span><span class="op" id="7922507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922511">Path</span><span class="op" id="7922515">:</span>&nbsp;<span class="string" id="7922517">&#34;testdata/test.cgi&#34;</span><span class="op" id="7922536">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7922539">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922542">expectedMap</span>&nbsp;<span class="op" id="7922554">:=</span>&nbsp;<span class="keyword" id="7922557">map</span><span class="op" id="7922560">[</span><span class="builtintype" id="7922561">string</span><span class="op" id="7922567">]</span><span class="builtintype" id="7922568">string</span><span class="op" id="7922574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922578">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7922595">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922601">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="7922620">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922624">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7922645">:</span>&nbsp;<span class="string" id="7922647">&#34;testdata/test.cgi&#34;</span><span class="op" id="7922666">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922670">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="7922687">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922693">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="7922711">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922715">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="7922731">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922738">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="7922750">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7922753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922756">runCgiTest</span><span class="op" id="7922766">(</span><span class="ident" id="7922767">t</span><span class="op" id="7922768">,</span>&nbsp;<span class="ident" id="7922770">h</span><span class="op" id="7922771">,</span>&nbsp;<span class="string" id="7922773">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="7922807">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922811">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="7922830">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922834">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="7922853">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922857">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="7922872">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922876">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="7922891">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7922895">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="7922918">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922922">expectedMap</span><span class="op" id="7922933">)</span><br>
<span class="lineno"></span><span class="op" id="7922935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="7922938">func</span>&nbsp;<span class="ident" id="7922943">TestPathInfoNoRoot</span><span class="op" id="7922961">(</span><span class="ident" id="7922962">t</span>&nbsp;<span class="op" id="7922964">*</span><span class="ident" id="7922965">testing</span><span class="op" id="7922972">.</span><span class="ident" id="7922973">T</span><span class="op" id="7922974">)</span>&nbsp;<span class="op" id="7922976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922979">check</span><span class="op" id="7922984">(</span><span class="ident" id="7922985">t</span><span class="op" id="7922986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7922989">h</span>&nbsp;<span class="op" id="7922991">:=</span>&nbsp;<span class="op" id="7922994">&amp;</span><span class="ident" id="7922995">Handler</span><span class="op" id="7923002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7923006">Path</span><span class="op" id="7923010">:</span>&nbsp;<span class="string" id="7923012">&#34;testdata/test.cgi&#34;</span><span class="op" id="7923031">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7923035">Root</span><span class="op" id="7923039">:</span>&nbsp;<span class="string" id="7923041">&#34;&#34;</span><span class="op" id="7923043">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7923046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7923049">expectedMap</span>&nbsp;<span class="op" id="7923061">:=</span>&nbsp;<span class="keyword" id="7923064">map</span><span class="op" id="7923067">[</span><span class="builtintype" id="7923068">string</span><span class="op" id="7923074">]</span><span class="builtintype" id="7923075">string</span><span class="op" id="7923081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923085">&#34;env-PATH_INFO&#34;</span><span class="op" id="7923100">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923108">&#34;/bar&#34;</span><span class="op" id="7923114">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923118">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7923136">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923141">&#34;a=b&#34;</span><span class="op" id="7923146">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923150">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7923167">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923173">&#34;/bar?a=b&#34;</span><span class="op" id="7923183">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923187">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7923208">:</span>&nbsp;<span class="string" id="7923210">&#34;testdata/test.cgi&#34;</span><span class="op" id="7923229">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923233">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7923250">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923256">&#34;/&#34;</span><span class="op" id="7923259">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7923262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7923265">runCgiTest</span><span class="op" id="7923275">(</span><span class="ident" id="7923276">t</span><span class="op" id="7923277">,</span>&nbsp;<span class="ident" id="7923279">h</span><span class="op" id="7923280">,</span>&nbsp;<span class="string" id="7923282">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7923328">,</span>&nbsp;<span class="ident" id="7923330">expectedMap</span><span class="op" id="7923341">)</span><br>
<span class="lineno"></span><span class="op" id="7923343">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="7923346">func</span>&nbsp;<span class="ident" id="7923351">TestCGIBasicPost</span><span class="op" id="7923367">(</span><span class="ident" id="7923368">t</span>&nbsp;<span class="op" id="7923370">*</span><span class="ident" id="7923371">testing</span><span class="op" id="7923378">.</span><span class="ident" id="7923379">T</span><span class="op" id="7923380">)</span>&nbsp;<span class="op" id="7923382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7923385">check</span><span class="op" id="7923390">(</span><span class="ident" id="7923391">t</span><span class="op" id="7923392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7923395">postReq</span>&nbsp;<span class="op" id="7923403">:=</span>&nbsp;<span class="string" id="7923406">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7923539">h</span>&nbsp;<span class="op" id="7923541">:=</span>&nbsp;<span class="op" id="7923544">&amp;</span><span class="ident" id="7923545">Handler</span><span class="op" id="7923552">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7923556">Path</span><span class="op" id="7923560">:</span>&nbsp;<span class="string" id="7923562">&#34;testdata/test.cgi&#34;</span><span class="op" id="7923581">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7923585">Root</span><span class="op" id="7923589">:</span>&nbsp;<span class="string" id="7923591">&#34;/test.cgi&#34;</span><span class="op" id="7923602">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7923605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7923608">expectedMap</span>&nbsp;<span class="op" id="7923620">:=</span>&nbsp;<span class="keyword" id="7923623">map</span><span class="op" id="7923626">[</span><span class="builtintype" id="7923627">string</span><span class="op" id="7923633">]</span><span class="builtintype" id="7923634">string</span><span class="op" id="7923640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923644">&#34;test&#34;</span><span class="op" id="7923650">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923666">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="7923677">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923681">&#34;param-postfoo&#34;</span><span class="op" id="7923696">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923703">&#34;postbar&#34;</span><span class="op" id="7923712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923716">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7923736">:</span>&nbsp;<span class="string" id="7923738">&#34;POST&#34;</span><span class="op" id="7923744">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923748">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="7923768">:</span>&nbsp;<span class="string" id="7923770">&#34;15&#34;</span><span class="op" id="7923774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923778">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7923795">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7923800">&#34;/test.cgi?a=b&#34;</span><span class="op" id="7923815">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7923818">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7923821">runCgiTest</span><span class="op" id="7923831">(</span><span class="ident" id="7923832">t</span><span class="op" id="7923833">,</span>&nbsp;<span class="ident" id="7923835">h</span><span class="op" id="7923836">,</span>&nbsp;<span class="ident" id="7923838">postReq</span><span class="op" id="7923845">,</span>&nbsp;<span class="ident" id="7923847">expectedMap</span><span class="op" id="7923858">)</span><br>
<span class="lineno"></span><span class="op" id="7923860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7923863">func</span>&nbsp;<span class="ident" id="7923868">chunk</span><span class="op" id="7923873">(</span><span class="ident" id="7923874">s</span>&nbsp;<span class="builtintype" id="7923876">string</span><span class="op" id="7923882">)</span>&nbsp;<span class="builtintype" id="7923884">string</span>&nbsp;<span class="op" id="7923891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7923894">return</span>&nbsp;<span class="ident" id="7923901">fmt</span><span class="op" id="7923904">.</span><span class="ident" id="7923905">Sprintf</span><span class="op" id="7923912">(</span><span class="string" id="7923913">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="7923927">,</span>&nbsp;<span class="builtinfunc" id="7923929">len</span><span class="op" id="7923932">(</span><span class="ident" id="7923933">s</span><span class="op" id="7923934">)</span><span class="op" id="7923935">,</span>&nbsp;<span class="ident" id="7923937">s</span><span class="op" id="7923938">)</span><br>
<span class="lineno">240</span><span class="op" id="7923940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7923943">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="7923991">func</span>&nbsp;<span class="ident" id="7923996">TestCGIPostChunked</span><span class="op" id="7924014">(</span><span class="ident" id="7924015">t</span>&nbsp;<span class="op" id="7924017">*</span><span class="ident" id="7924018">testing</span><span class="op" id="7924025">.</span><span class="ident" id="7924026">T</span><span class="op" id="7924027">)</span>&nbsp;<span class="op" id="7924029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924032">check</span><span class="op" id="7924037">(</span><span class="ident" id="7924038">t</span><span class="op" id="7924039">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924042">postReq</span>&nbsp;<span class="op" id="7924050">:=</span>&nbsp;<span class="string" id="7924053">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="7924178">+</span>&nbsp;<span class="ident" id="7924180">chunk</span><span class="op" id="7924185">(</span><span class="string" id="7924186">&#34;postfoo&#34;</span><span class="op" id="7924195">)</span>&nbsp;<span class="op" id="7924197">+</span>&nbsp;<span class="ident" id="7924199">chunk</span><span class="op" id="7924204">(</span><span class="string" id="7924205">&#34;=&#34;</span><span class="op" id="7924208">)</span>&nbsp;<span class="op" id="7924210">+</span>&nbsp;<span class="ident" id="7924212">chunk</span><span class="op" id="7924217">(</span><span class="string" id="7924218">&#34;postbar&#34;</span><span class="op" id="7924227">)</span>&nbsp;<span class="op" id="7924229">+</span>&nbsp;<span class="ident" id="7924231">chunk</span><span class="op" id="7924236">(</span><span class="string" id="7924237">&#34;&#34;</span><span class="op" id="7924239">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924243">h</span>&nbsp;<span class="op" id="7924245">:=</span>&nbsp;<span class="op" id="7924248">&amp;</span><span class="ident" id="7924249">Handler</span><span class="op" id="7924256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924260">Path</span><span class="op" id="7924264">:</span>&nbsp;<span class="string" id="7924266">&#34;testdata/test.cgi&#34;</span><span class="op" id="7924285">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924289">Root</span><span class="op" id="7924293">:</span>&nbsp;<span class="string" id="7924295">&#34;/test.cgi&#34;</span><span class="op" id="7924306">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7924309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924312">expectedMap</span>&nbsp;<span class="op" id="7924324">:=</span>&nbsp;<span class="keyword" id="7924327">map</span><span class="op" id="7924330">[</span><span class="builtintype" id="7924331">string</span><span class="op" id="7924337">]</span><span class="builtintype" id="7924338">string</span><span class="op" id="7924344">{</span><span class="op" id="7924345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924348">resp</span>&nbsp;<span class="op" id="7924353">:=</span>&nbsp;<span class="ident" id="7924356">runCgiTest</span><span class="op" id="7924366">(</span><span class="ident" id="7924367">t</span><span class="op" id="7924368">,</span>&nbsp;<span class="ident" id="7924370">h</span><span class="op" id="7924371">,</span>&nbsp;<span class="ident" id="7924373">postReq</span><span class="op" id="7924380">,</span>&nbsp;<span class="ident" id="7924382">expectedMap</span><span class="op" id="7924393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7924396">if</span>&nbsp;<span class="ident" id="7924399">got</span><span class="op" id="7924402">,</span>&nbsp;<span class="ident" id="7924404">expected</span>&nbsp;<span class="op" id="7924413">:=</span>&nbsp;<span class="ident" id="7924416">resp</span><span class="op" id="7924420">.</span><span class="ident" id="7924421">Code</span><span class="op" id="7924425">,</span>&nbsp;<span class="ident" id="7924427">http</span><span class="op" id="7924431">.</span><span class="ident" id="7924432">StatusBadRequest</span><span class="op" id="7924448">;</span>&nbsp;<span class="ident" id="7924450">got</span>&nbsp;<span class="op" id="7924454">!=</span>&nbsp;<span class="ident" id="7924457">expected</span>&nbsp;<span class="op" id="7924466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924470">t</span><span class="op" id="7924471">.</span><span class="ident" id="7924472">Fatalf</span><span class="op" id="7924478">(</span><span class="string" id="7924479">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7924540">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924545">expected</span><span class="op" id="7924553">,</span>&nbsp;<span class="ident" id="7924555">got</span><span class="op" id="7924558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7924561">}</span><br>
<span class="lineno"></span><span class="op" id="7924563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7924566">func</span>&nbsp;<span class="ident" id="7924571">TestRedirect</span><span class="op" id="7924583">(</span><span class="ident" id="7924584">t</span>&nbsp;<span class="op" id="7924586">*</span><span class="ident" id="7924587">testing</span><span class="op" id="7924594">.</span><span class="ident" id="7924595">T</span><span class="op" id="7924596">)</span>&nbsp;<span class="op" id="7924598">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924601">check</span><span class="op" id="7924606">(</span><span class="ident" id="7924607">t</span><span class="op" id="7924608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924611">h</span>&nbsp;<span class="op" id="7924613">:=</span>&nbsp;<span class="op" id="7924616">&amp;</span><span class="ident" id="7924617">Handler</span><span class="op" id="7924624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924628">Path</span><span class="op" id="7924632">:</span>&nbsp;<span class="string" id="7924634">&#34;testdata/test.cgi&#34;</span><span class="op" id="7924653">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924657">Root</span><span class="op" id="7924661">:</span>&nbsp;<span class="string" id="7924663">&#34;/test.cgi&#34;</span><span class="op" id="7924674">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7924677">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924680">rec</span>&nbsp;<span class="op" id="7924684">:=</span>&nbsp;<span class="ident" id="7924687">runCgiTest</span><span class="op" id="7924697">(</span><span class="ident" id="7924698">t</span><span class="op" id="7924699">,</span>&nbsp;<span class="ident" id="7924701">h</span><span class="op" id="7924702">,</span>&nbsp;<span class="string" id="7924704">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7924771">,</span>&nbsp;<span class="builtintype" id="7924773">nil</span><span class="op" id="7924776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7924779">if</span>&nbsp;<span class="ident" id="7924782">e</span><span class="op" id="7924783">,</span>&nbsp;<span class="ident" id="7924785">g</span>&nbsp;<span class="op" id="7924787">:=</span>&nbsp;<span class="num" id="7924790">302</span><span class="op" id="7924793">,</span>&nbsp;<span class="ident" id="7924795">rec</span><span class="op" id="7924798">.</span><span class="ident" id="7924799">Code</span><span class="op" id="7924803">;</span>&nbsp;<span class="ident" id="7924805">e</span>&nbsp;<span class="op" id="7924807">!=</span>&nbsp;<span class="ident" id="7924810">g</span>&nbsp;<span class="op" id="7924812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924816">t</span><span class="op" id="7924817">.</span><span class="ident" id="7924818">Errorf</span><span class="op" id="7924824">(</span><span class="string" id="7924825">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7924858">,</span>&nbsp;<span class="ident" id="7924860">e</span><span class="op" id="7924861">,</span>&nbsp;<span class="ident" id="7924863">g</span><span class="op" id="7924864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7924867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7924870">if</span>&nbsp;<span class="ident" id="7924873">e</span><span class="op" id="7924874">,</span>&nbsp;<span class="ident" id="7924876">g</span>&nbsp;<span class="op" id="7924878">:=</span>&nbsp;<span class="string" id="7924881">&#34;http://foo.com/&#34;</span><span class="op" id="7924898">,</span>&nbsp;<span class="ident" id="7924900">rec</span><span class="op" id="7924903">.</span><span class="ident" id="7924904">Header</span><span class="op" id="7924910">(</span><span class="op" id="7924911">)</span><span class="op" id="7924912">.</span><span class="ident" id="7924913">Get</span><span class="op" id="7924916">(</span><span class="string" id="7924917">&#34;Location&#34;</span><span class="op" id="7924927">)</span><span class="op" id="7924928">;</span>&nbsp;<span class="ident" id="7924930">e</span>&nbsp;<span class="op" id="7924932">!=</span>&nbsp;<span class="ident" id="7924935">g</span>&nbsp;<span class="op" id="7924937">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7924941">t</span><span class="op" id="7924942">.</span><span class="ident" id="7924943">Errorf</span><span class="op" id="7924949">(</span><span class="string" id="7924950">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7924990">,</span>&nbsp;<span class="ident" id="7924992">e</span><span class="op" id="7924993">,</span>&nbsp;<span class="ident" id="7924995">g</span><span class="op" id="7924996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7924999">}</span><br>
<span class="lineno"></span><span class="op" id="7925001">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7925004">func</span>&nbsp;<span class="ident" id="7925009">TestInternalRedirect</span><span class="op" id="7925029">(</span><span class="ident" id="7925030">t</span>&nbsp;<span class="op" id="7925032">*</span><span class="ident" id="7925033">testing</span><span class="op" id="7925040">.</span><span class="ident" id="7925041">T</span><span class="op" id="7925042">)</span>&nbsp;<span class="op" id="7925044">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925047">check</span><span class="op" id="7925052">(</span><span class="ident" id="7925053">t</span><span class="op" id="7925054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925057">baseHandler</span>&nbsp;<span class="op" id="7925069">:=</span>&nbsp;<span class="ident" id="7925072">http</span><span class="op" id="7925076">.</span><span class="ident" id="7925077">HandlerFunc</span><span class="op" id="7925088">(</span><span class="keyword" id="7925089">func</span><span class="op" id="7925093">(</span><span class="ident" id="7925094">rw</span>&nbsp;<span class="ident" id="7925097">http</span><span class="op" id="7925101">.</span><span class="ident" id="7925102">ResponseWriter</span><span class="op" id="7925116">,</span>&nbsp;<span class="ident" id="7925118">req</span>&nbsp;<span class="op" id="7925122">*</span><span class="ident" id="7925123">http</span><span class="op" id="7925127">.</span><span class="ident" id="7925128">Request</span><span class="op" id="7925135">)</span>&nbsp;<span class="op" id="7925137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925141">fmt</span><span class="op" id="7925144">.</span><span class="ident" id="7925145">Fprintf</span><span class="op" id="7925152">(</span><span class="ident" id="7925153">rw</span><span class="op" id="7925155">,</span>&nbsp;<span class="string" id="7925157">&#34;basepath=%s\n&#34;</span><span class="op" id="7925172">,</span>&nbsp;<span class="ident" id="7925174">req</span><span class="op" id="7925177">.</span><span class="ident" id="7925178">URL</span><span class="op" id="7925181">.</span><span class="ident" id="7925182">Path</span><span class="op" id="7925186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925190">fmt</span><span class="op" id="7925193">.</span><span class="ident" id="7925194">Fprintf</span><span class="op" id="7925201">(</span><span class="ident" id="7925202">rw</span><span class="op" id="7925204">,</span>&nbsp;<span class="string" id="7925206">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="7925223">,</span>&nbsp;<span class="ident" id="7925225">req</span><span class="op" id="7925228">.</span><span class="ident" id="7925229">RemoteAddr</span><span class="op" id="7925239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7925242">}</span><span class="op" id="7925243">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925246">h</span>&nbsp;<span class="op" id="7925248">:=</span>&nbsp;<span class="op" id="7925251">&amp;</span><span class="ident" id="7925252">Handler</span><span class="op" id="7925259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925263">Path</span><span class="op" id="7925267">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7925284">&#34;testdata/test.cgi&#34;</span><span class="op" id="7925303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925307">Root</span><span class="op" id="7925311">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7925328">&#34;/test.cgi&#34;</span><span class="op" id="7925339">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925343">PathLocationHandler</span><span class="op" id="7925362">:</span>&nbsp;<span class="ident" id="7925364">baseHandler</span><span class="op" id="7925375">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7925378">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925381">expectedMap</span>&nbsp;<span class="op" id="7925393">:=</span>&nbsp;<span class="keyword" id="7925396">map</span><span class="op" id="7925399">[</span><span class="builtintype" id="7925400">string</span><span class="op" id="7925406">]</span><span class="builtintype" id="7925407">string</span><span class="op" id="7925413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7925417">&#34;basepath&#34;</span><span class="op" id="7925427">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7925431">&#34;/foo&#34;</span><span class="op" id="7925437">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7925441">&#34;remoteaddr&#34;</span><span class="op" id="7925453">:</span>&nbsp;<span class="string" id="7925455">&#34;1.2.3.4&#34;</span><span class="op" id="7925464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7925467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925470">runCgiTest</span><span class="op" id="7925480">(</span><span class="ident" id="7925481">t</span><span class="op" id="7925482">,</span>&nbsp;<span class="ident" id="7925484">h</span><span class="op" id="7925485">,</span>&nbsp;<span class="string" id="7925487">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7925543">,</span>&nbsp;<span class="ident" id="7925545">expectedMap</span><span class="op" id="7925556">)</span><br>
<span class="lineno">295</span><span class="op" id="7925558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7925561">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="7925637">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="7925700">func</span>&nbsp;<span class="ident" id="7925705">TestCopyError</span><span class="op" id="7925718">(</span><span class="ident" id="7925719">t</span>&nbsp;<span class="op" id="7925721">*</span><span class="ident" id="7925722">testing</span><span class="op" id="7925729">.</span><span class="ident" id="7925730">T</span><span class="op" id="7925731">)</span>&nbsp;<span class="op" id="7925733">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925736">check</span><span class="op" id="7925741">(</span><span class="ident" id="7925742">t</span><span class="op" id="7925743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7925746">if</span>&nbsp;<span class="ident" id="7925749">runtime</span><span class="op" id="7925756">.</span><span class="ident" id="7925757">GOOS</span>&nbsp;<span class="op" id="7925762">==</span>&nbsp;<span class="string" id="7925765">&#34;windows&#34;</span>&nbsp;<span class="op" id="7925775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925779">t</span><span class="op" id="7925780">.</span><span class="ident" id="7925781">Skipf</span><span class="op" id="7925786">(</span><span class="string" id="7925787">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7925808">,</span>&nbsp;<span class="ident" id="7925810">runtime</span><span class="op" id="7925817">.</span><span class="ident" id="7925818">GOOS</span><span class="op" id="7925822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7925825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925828">h</span>&nbsp;<span class="op" id="7925830">:=</span>&nbsp;<span class="op" id="7925833">&amp;</span><span class="ident" id="7925834">Handler</span><span class="op" id="7925841">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925845">Path</span><span class="op" id="7925849">:</span>&nbsp;<span class="string" id="7925851">&#34;testdata/test.cgi&#34;</span><span class="op" id="7925870">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925874">Root</span><span class="op" id="7925878">:</span>&nbsp;<span class="string" id="7925880">&#34;/test.cgi&#34;</span><span class="op" id="7925891">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7925894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925897">ts</span>&nbsp;<span class="op" id="7925900">:=</span>&nbsp;<span class="ident" id="7925903">httptest</span><span class="op" id="7925911">.</span><span class="ident" id="7925912">NewServer</span><span class="op" id="7925921">(</span><span class="ident" id="7925922">h</span><span class="op" id="7925923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7925926">defer</span>&nbsp;<span class="ident" id="7925932">ts</span><span class="op" id="7925934">.</span><span class="ident" id="7925935">Close</span><span class="op" id="7925940">(</span><span class="op" id="7925941">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7925945">conn</span><span class="op" id="7925949">,</span>&nbsp;<span class="ident" id="7925951">err</span>&nbsp;<span class="op" id="7925955">:=</span>&nbsp;<span class="ident" id="7925958">net</span><span class="op" id="7925961">.</span><span class="ident" id="7925962">Dial</span><span class="op" id="7925966">(</span><span class="string" id="7925967">&#34;tcp&#34;</span><span class="op" id="7925972">,</span>&nbsp;<span class="ident" id="7925974">ts</span><span class="op" id="7925976">.</span><span class="ident" id="7925977">Listener</span><span class="op" id="7925985">.</span><span class="ident" id="7925986">Addr</span><span class="op" id="7925990">(</span><span class="op" id="7925991">)</span><span class="op" id="7925992">.</span><span class="ident" id="7925993">String</span><span class="op" id="7925999">(</span><span class="op" id="7926000">)</span><span class="op" id="7926001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7926004">if</span>&nbsp;<span class="ident" id="7926007">err</span>&nbsp;<span class="op" id="7926011">!=</span>&nbsp;<span class="builtintype" id="7926014">nil</span>&nbsp;<span class="op" id="7926018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926022">t</span><span class="op" id="7926023">.</span><span class="ident" id="7926024">Fatal</span><span class="op" id="7926029">(</span><span class="ident" id="7926030">err</span><span class="op" id="7926033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7926036">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926039">req</span><span class="op" id="7926042">,</span>&nbsp;<span class="ident" id="7926044">_</span>&nbsp;<span class="op" id="7926046">:=</span>&nbsp;<span class="ident" id="7926049">http</span><span class="op" id="7926053">.</span><span class="ident" id="7926054">NewRequest</span><span class="op" id="7926064">(</span><span class="string" id="7926065">&#34;GET&#34;</span><span class="op" id="7926070">,</span>&nbsp;<span class="string" id="7926072">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="7926115">,</span>&nbsp;<span class="builtintype" id="7926117">nil</span><span class="op" id="7926120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926123">err</span>&nbsp;<span class="op" id="7926127">=</span>&nbsp;<span class="ident" id="7926129">req</span><span class="op" id="7926132">.</span><span class="ident" id="7926133">Write</span><span class="op" id="7926138">(</span><span class="ident" id="7926139">conn</span><span class="op" id="7926143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7926146">if</span>&nbsp;<span class="ident" id="7926149">err</span>&nbsp;<span class="op" id="7926153">!=</span>&nbsp;<span class="builtintype" id="7926156">nil</span>&nbsp;<span class="op" id="7926160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926164">t</span><span class="op" id="7926165">.</span><span class="ident" id="7926166">Fatalf</span><span class="op" id="7926172">(</span><span class="string" id="7926173">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="7926184">,</span>&nbsp;<span class="ident" id="7926186">err</span><span class="op" id="7926189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7926192">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926196">res</span><span class="op" id="7926199">,</span>&nbsp;<span class="ident" id="7926201">err</span>&nbsp;<span class="op" id="7926205">:=</span>&nbsp;<span class="ident" id="7926208">http</span><span class="op" id="7926212">.</span><span class="ident" id="7926213">ReadResponse</span><span class="op" id="7926225">(</span><span class="ident" id="7926226">bufio</span><span class="op" id="7926231">.</span><span class="ident" id="7926232">NewReader</span><span class="op" id="7926241">(</span><span class="ident" id="7926242">conn</span><span class="op" id="7926246">)</span><span class="op" id="7926247">,</span>&nbsp;<span class="ident" id="7926249">req</span><span class="op" id="7926252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7926255">if</span>&nbsp;<span class="ident" id="7926258">err</span>&nbsp;<span class="op" id="7926262">!=</span>&nbsp;<span class="builtintype" id="7926265">nil</span>&nbsp;<span class="op" id="7926269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926273">t</span><span class="op" id="7926274">.</span><span class="ident" id="7926275">Fatalf</span><span class="op" id="7926281">(</span><span class="string" id="7926282">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="7926300">,</span>&nbsp;<span class="ident" id="7926302">err</span><span class="op" id="7926305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7926308">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926312">pidstr</span>&nbsp;<span class="op" id="7926319">:=</span>&nbsp;<span class="ident" id="7926322">res</span><span class="op" id="7926325">.</span><span class="ident" id="7926326">Header</span><span class="op" id="7926332">.</span><span class="ident" id="7926333">Get</span><span class="op" id="7926336">(</span><span class="string" id="7926337">&#34;X-CGI-Pid&#34;</span><span class="op" id="7926348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7926351">if</span>&nbsp;<span class="ident" id="7926354">pidstr</span>&nbsp;<span class="op" id="7926361">==</span>&nbsp;<span class="string" id="7926364">&#34;&#34;</span>&nbsp;<span class="op" id="7926367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926371">t</span><span class="op" id="7926372">.</span><span class="ident" id="7926373">Fatalf</span><span class="op" id="7926379">(</span><span class="string" id="7926380">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="7926422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7926425">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926428">pid</span><span class="op" id="7926431">,</span>&nbsp;<span class="ident" id="7926433">err</span>&nbsp;<span class="op" id="7926437">:=</span>&nbsp;<span class="ident" id="7926440">strconv</span><span class="op" id="7926447">.</span><span class="ident" id="7926448">Atoi</span><span class="op" id="7926452">(</span><span class="ident" id="7926453">pidstr</span><span class="op" id="7926459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7926462">if</span>&nbsp;<span class="ident" id="7926465">err</span>&nbsp;<span class="op" id="7926469">!=</span>&nbsp;<span class="builtintype" id="7926472">nil</span>&nbsp;<span class="op" id="7926476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926480">t</span><span class="op" id="7926481">.</span><span class="ident" id="7926482">Fatalf</span><span class="op" id="7926488">(</span><span class="string" id="7926489">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="7926514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7926517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7926521">var</span>&nbsp;<span class="ident" id="7926525">buf</span>&nbsp;<span class="op" id="7926529">[</span><span class="num" id="7926530">5000</span><span class="op" id="7926534">]</span><span class="builtintype" id="7926535">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926541">n</span><span class="op" id="7926542">,</span>&nbsp;<span class="ident" id="7926544">err</span>&nbsp;<span class="op" id="7926548">:=</span>&nbsp;<span class="ident" id="7926551">io</span><span class="op" id="7926553">.</span><span class="ident" id="7926554">ReadFull</span><span class="op" id="7926562">(</span><span class="ident" id="7926563">res</span><span class="op" id="7926566">.</span><span class="ident" id="7926567">Body</span><span class="op" id="7926571">,</span>&nbsp;<span class="ident" id="7926573">buf</span><span class="op" id="7926576">[</span><span class="op" id="7926577">:</span><span class="op" id="7926578">]</span><span class="op" id="7926579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7926582">if</span>&nbsp;<span class="ident" id="7926585">err</span>&nbsp;<span class="op" id="7926589">!=</span>&nbsp;<span class="builtintype" id="7926592">nil</span>&nbsp;<span class="op" id="7926596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926600">t</span><span class="op" id="7926601">.</span><span class="ident" id="7926602">Fatalf</span><span class="op" id="7926608">(</span><span class="string" id="7926609">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="7926633">,</span>&nbsp;<span class="ident" id="7926635">n</span><span class="op" id="7926636">,</span>&nbsp;<span class="ident" id="7926638">err</span><span class="op" id="7926641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7926644">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926648">childRunning</span>&nbsp;<span class="op" id="7926661">:=</span>&nbsp;<span class="keyword" id="7926664">func</span><span class="op" id="7926668">(</span><span class="op" id="7926669">)</span>&nbsp;<span class="builtintype" id="7926671">bool</span>&nbsp;<span class="op" id="7926676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7926680">return</span>&nbsp;<span class="ident" id="7926687">isProcessRunning</span><span class="op" id="7926703">(</span><span class="ident" id="7926704">t</span><span class="op" id="7926705">,</span>&nbsp;<span class="ident" id="7926707">pid</span><span class="op" id="7926710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7926713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7926717">if</span>&nbsp;<span class="op" id="7926720">!</span><span class="ident" id="7926721">childRunning</span><span class="op" id="7926733">(</span><span class="op" id="7926734">)</span>&nbsp;<span class="op" id="7926736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926740">t</span><span class="op" id="7926741">.</span><span class="ident" id="7926742">Fatalf</span><span class="op" id="7926748">(</span><span class="string" id="7926749">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="7926795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7926798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926801">conn</span><span class="op" id="7926805">.</span><span class="ident" id="7926806">Close</span><span class="op" id="7926811">(</span><span class="op" id="7926812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926816">tries</span>&nbsp;<span class="op" id="7926822">:=</span>&nbsp;<span class="num" id="7926825">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7926828">for</span>&nbsp;<span class="ident" id="7926832">tries</span>&nbsp;<span class="op" id="7926838">&lt;</span>&nbsp;<span class="num" id="7926840">25</span>&nbsp;<span class="op" id="7926843">&amp;&amp;</span>&nbsp;<span class="ident" id="7926846">childRunning</span><span class="op" id="7926858">(</span><span class="op" id="7926859">)</span>&nbsp;<span class="op" id="7926861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926865">time</span><span class="op" id="7926869">.</span><span class="ident" id="7926870">Sleep</span><span class="op" id="7926875">(</span><span class="num" id="7926876">50</span>&nbsp;<span class="op" id="7926879">*</span>&nbsp;<span class="ident" id="7926881">time</span><span class="op" id="7926885">.</span><span class="ident" id="7926886">Millisecond</span>&nbsp;<span class="op" id="7926898">*</span>&nbsp;<span class="ident" id="7926900">time</span><span class="op" id="7926904">.</span><span class="ident" id="7926905">Duration</span><span class="op" id="7926913">(</span><span class="ident" id="7926914">tries</span><span class="op" id="7926919">)</span><span class="op" id="7926920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926924">tries</span><span class="op" id="7926929">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7926933">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7926936">if</span>&nbsp;<span class="ident" id="7926939">childRunning</span><span class="op" id="7926951">(</span><span class="op" id="7926952">)</span>&nbsp;<span class="op" id="7926954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7926958">t</span><span class="op" id="7926959">.</span><span class="ident" id="7926960">Fatalf</span><span class="op" id="7926966">(</span><span class="string" id="7926967">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="7927011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7927014">}</span><br>
<span class="lineno"></span><span class="op" id="7927016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="7927019">func</span>&nbsp;<span class="ident" id="7927024">TestDirUnix</span><span class="op" id="7927035">(</span><span class="ident" id="7927036">t</span>&nbsp;<span class="op" id="7927038">*</span><span class="ident" id="7927039">testing</span><span class="op" id="7927046">.</span><span class="ident" id="7927047">T</span><span class="op" id="7927048">)</span>&nbsp;<span class="op" id="7927050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927053">check</span><span class="op" id="7927058">(</span><span class="ident" id="7927059">t</span><span class="op" id="7927060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7927063">if</span>&nbsp;<span class="ident" id="7927066">runtime</span><span class="op" id="7927073">.</span><span class="ident" id="7927074">GOOS</span>&nbsp;<span class="op" id="7927079">==</span>&nbsp;<span class="string" id="7927082">&#34;windows&#34;</span>&nbsp;<span class="op" id="7927092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927096">t</span><span class="op" id="7927097">.</span><span class="ident" id="7927098">Skipf</span><span class="op" id="7927103">(</span><span class="string" id="7927104">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7927125">,</span>&nbsp;<span class="ident" id="7927127">runtime</span><span class="op" id="7927134">.</span><span class="ident" id="7927135">GOOS</span><span class="op" id="7927139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7927142">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927145">cwd</span><span class="op" id="7927148">,</span>&nbsp;<span class="ident" id="7927150">_</span>&nbsp;<span class="op" id="7927152">:=</span>&nbsp;<span class="ident" id="7927155">os</span><span class="op" id="7927157">.</span><span class="ident" id="7927158">Getwd</span><span class="op" id="7927163">(</span><span class="op" id="7927164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927167">h</span>&nbsp;<span class="op" id="7927169">:=</span>&nbsp;<span class="op" id="7927172">&amp;</span><span class="ident" id="7927173">Handler</span><span class="op" id="7927180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927184">Path</span><span class="op" id="7927188">:</span>&nbsp;<span class="string" id="7927190">&#34;testdata/test.cgi&#34;</span><span class="op" id="7927209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927213">Root</span><span class="op" id="7927217">:</span>&nbsp;<span class="string" id="7927219">&#34;/test.cgi&#34;</span><span class="op" id="7927230">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927234">Dir</span><span class="op" id="7927237">:</span>&nbsp;&nbsp;<span class="ident" id="7927240">cwd</span><span class="op" id="7927243">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7927246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927249">expectedMap</span>&nbsp;<span class="op" id="7927261">:=</span>&nbsp;<span class="keyword" id="7927264">map</span><span class="op" id="7927267">[</span><span class="builtintype" id="7927268">string</span><span class="op" id="7927274">]</span><span class="builtintype" id="7927275">string</span><span class="op" id="7927281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7927285">&#34;cwd&#34;</span><span class="op" id="7927290">:</span>&nbsp;<span class="ident" id="7927292">cwd</span><span class="op" id="7927295">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7927298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927301">runCgiTest</span><span class="op" id="7927311">(</span><span class="ident" id="7927312">t</span><span class="op" id="7927313">,</span>&nbsp;<span class="ident" id="7927315">h</span><span class="op" id="7927316">,</span>&nbsp;<span class="string" id="7927318">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7927365">,</span>&nbsp;<span class="ident" id="7927367">expectedMap</span><span class="op" id="7927378">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927382">cwd</span><span class="op" id="7927385">,</span>&nbsp;<span class="ident" id="7927387">_</span>&nbsp;<span class="op" id="7927389">=</span>&nbsp;<span class="ident" id="7927391">os</span><span class="op" id="7927393">.</span><span class="ident" id="7927394">Getwd</span><span class="op" id="7927399">(</span><span class="op" id="7927400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927403">cwd</span>&nbsp;<span class="op" id="7927407">=</span>&nbsp;<span class="ident" id="7927409">filepath</span><span class="op" id="7927417">.</span><span class="ident" id="7927418">Join</span><span class="op" id="7927422">(</span><span class="ident" id="7927423">cwd</span><span class="op" id="7927426">,</span>&nbsp;<span class="string" id="7927428">&#34;testdata&#34;</span><span class="op" id="7927438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927441">h</span>&nbsp;<span class="op" id="7927443">=</span>&nbsp;<span class="op" id="7927445">&amp;</span><span class="ident" id="7927446">Handler</span><span class="op" id="7927453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927457">Path</span><span class="op" id="7927461">:</span>&nbsp;<span class="string" id="7927463">&#34;testdata/test.cgi&#34;</span><span class="op" id="7927482">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927486">Root</span><span class="op" id="7927490">:</span>&nbsp;<span class="string" id="7927492">&#34;/test.cgi&#34;</span><span class="op" id="7927503">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7927506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927509">expectedMap</span>&nbsp;<span class="op" id="7927521">=</span>&nbsp;<span class="keyword" id="7927523">map</span><span class="op" id="7927526">[</span><span class="builtintype" id="7927527">string</span><span class="op" id="7927533">]</span><span class="builtintype" id="7927534">string</span><span class="op" id="7927540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7927544">&#34;cwd&#34;</span><span class="op" id="7927549">:</span>&nbsp;<span class="ident" id="7927551">cwd</span><span class="op" id="7927554">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7927557">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927560">runCgiTest</span><span class="op" id="7927570">(</span><span class="ident" id="7927571">t</span><span class="op" id="7927572">,</span>&nbsp;<span class="ident" id="7927574">h</span><span class="op" id="7927575">,</span>&nbsp;<span class="string" id="7927577">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7927624">,</span>&nbsp;<span class="ident" id="7927626">expectedMap</span><span class="op" id="7927637">)</span><br>
<span class="lineno"></span><span class="op" id="7927639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7927642">func</span>&nbsp;<span class="ident" id="7927647">TestDirWindows</span><span class="op" id="7927661">(</span><span class="ident" id="7927662">t</span>&nbsp;<span class="op" id="7927664">*</span><span class="ident" id="7927665">testing</span><span class="op" id="7927672">.</span><span class="ident" id="7927673">T</span><span class="op" id="7927674">)</span>&nbsp;<span class="op" id="7927676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7927679">if</span>&nbsp;<span class="ident" id="7927682">runtime</span><span class="op" id="7927689">.</span><span class="ident" id="7927690">GOOS</span>&nbsp;<span class="op" id="7927695">!=</span>&nbsp;<span class="string" id="7927698">&#34;windows&#34;</span>&nbsp;<span class="op" id="7927708">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927712">t</span><span class="op" id="7927713">.</span><span class="ident" id="7927714">Skip</span><span class="op" id="7927718">(</span><span class="string" id="7927719">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="7927752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7927755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927759">cgifile</span><span class="op" id="7927766">,</span>&nbsp;<span class="ident" id="7927768">_</span>&nbsp;<span class="op" id="7927770">:=</span>&nbsp;<span class="ident" id="7927773">filepath</span><span class="op" id="7927781">.</span><span class="ident" id="7927782">Abs</span><span class="op" id="7927785">(</span><span class="string" id="7927786">&#34;testdata/test.cgi&#34;</span><span class="op" id="7927805">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7927809">var</span>&nbsp;<span class="ident" id="7927813">perl</span>&nbsp;<span class="builtintype" id="7927818">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7927826">var</span>&nbsp;<span class="ident" id="7927830">err</span>&nbsp;<span class="builtintype" id="7927834">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927841">perl</span><span class="op" id="7927845">,</span>&nbsp;<span class="ident" id="7927847">err</span>&nbsp;<span class="op" id="7927851">=</span>&nbsp;<span class="ident" id="7927853">exec</span><span class="op" id="7927857">.</span><span class="ident" id="7927858">LookPath</span><span class="op" id="7927866">(</span><span class="string" id="7927867">&#34;perl&#34;</span><span class="op" id="7927873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7927876">if</span>&nbsp;<span class="ident" id="7927879">err</span>&nbsp;<span class="op" id="7927883">!=</span>&nbsp;<span class="builtintype" id="7927886">nil</span>&nbsp;<span class="op" id="7927890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927894">t</span><span class="op" id="7927895">.</span><span class="ident" id="7927896">Skip</span><span class="op" id="7927900">(</span><span class="string" id="7927901">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7927933">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7927936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927939">perl</span><span class="op" id="7927943">,</span>&nbsp;<span class="ident" id="7927945">_</span>&nbsp;<span class="op" id="7927947">=</span>&nbsp;<span class="ident" id="7927949">filepath</span><span class="op" id="7927957">.</span><span class="ident" id="7927958">Abs</span><span class="op" id="7927961">(</span><span class="ident" id="7927962">perl</span><span class="op" id="7927966">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927970">cwd</span><span class="op" id="7927973">,</span>&nbsp;<span class="ident" id="7927975">_</span>&nbsp;<span class="op" id="7927977">:=</span>&nbsp;<span class="ident" id="7927980">os</span><span class="op" id="7927982">.</span><span class="ident" id="7927983">Getwd</span><span class="op" id="7927988">(</span><span class="op" id="7927989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7927992">h</span>&nbsp;<span class="op" id="7927994">:=</span>&nbsp;<span class="op" id="7927997">&amp;</span><span class="ident" id="7927998">Handler</span><span class="op" id="7928005">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928009">Path</span><span class="op" id="7928013">:</span>&nbsp;<span class="ident" id="7928015">perl</span><span class="op" id="7928019">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928023">Root</span><span class="op" id="7928027">:</span>&nbsp;<span class="string" id="7928029">&#34;/test.cgi&#34;</span><span class="op" id="7928040">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928044">Dir</span><span class="op" id="7928047">:</span>&nbsp;&nbsp;<span class="ident" id="7928050">cwd</span><span class="op" id="7928053">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928057">Args</span><span class="op" id="7928061">:</span>&nbsp;<span class="op" id="7928063">[</span><span class="op" id="7928064">]</span><span class="builtintype" id="7928065">string</span><span class="op" id="7928071">{</span><span class="ident" id="7928072">cgifile</span><span class="op" id="7928079">}</span><span class="op" id="7928080">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928084">Env</span><span class="op" id="7928087">:</span>&nbsp;&nbsp;<span class="op" id="7928090">[</span><span class="op" id="7928091">]</span><span class="builtintype" id="7928092">string</span><span class="op" id="7928098">{</span><span class="string" id="7928099">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7928118">+</span>&nbsp;<span class="ident" id="7928120">cgifile</span><span class="op" id="7928127">}</span><span class="op" id="7928128">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7928131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928134">expectedMap</span>&nbsp;<span class="op" id="7928146">:=</span>&nbsp;<span class="keyword" id="7928149">map</span><span class="op" id="7928152">[</span><span class="builtintype" id="7928153">string</span><span class="op" id="7928159">]</span><span class="builtintype" id="7928160">string</span><span class="op" id="7928166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7928170">&#34;cwd&#34;</span><span class="op" id="7928175">:</span>&nbsp;<span class="ident" id="7928177">cwd</span><span class="op" id="7928180">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7928183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928186">runCgiTest</span><span class="op" id="7928196">(</span><span class="ident" id="7928197">t</span><span class="op" id="7928198">,</span>&nbsp;<span class="ident" id="7928200">h</span><span class="op" id="7928201">,</span>&nbsp;<span class="string" id="7928203">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7928250">,</span>&nbsp;<span class="ident" id="7928252">expectedMap</span><span class="op" id="7928263">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7928267">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7928330">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928358">cwd</span><span class="op" id="7928361">,</span>&nbsp;<span class="ident" id="7928363">_</span>&nbsp;<span class="op" id="7928365">=</span>&nbsp;<span class="ident" id="7928367">filepath</span><span class="op" id="7928375">.</span><span class="ident" id="7928376">Split</span><span class="op" id="7928381">(</span><span class="ident" id="7928382">perl</span><span class="op" id="7928386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7928389">if</span>&nbsp;<span class="ident" id="7928392">cwd</span>&nbsp;<span class="op" id="7928396">!=</span>&nbsp;<span class="string" id="7928399">&#34;&#34;</span>&nbsp;<span class="op" id="7928402">&amp;&amp;</span>&nbsp;<span class="ident" id="7928405">cwd</span><span class="op" id="7928408">[</span><span class="builtinfunc" id="7928409">len</span><span class="op" id="7928412">(</span><span class="ident" id="7928413">cwd</span><span class="op" id="7928416">)</span><span class="op" id="7928417">-</span><span class="num" id="7928418">1</span><span class="op" id="7928419">]</span>&nbsp;<span class="op" id="7928421">==</span>&nbsp;<span class="ident" id="7928424">filepath</span><span class="op" id="7928432">.</span><span class="ident" id="7928433">Separator</span>&nbsp;<span class="op" id="7928443">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928447">cwd</span>&nbsp;<span class="op" id="7928451">=</span>&nbsp;<span class="ident" id="7928453">cwd</span><span class="op" id="7928456">[</span><span class="op" id="7928457">:</span><span class="builtinfunc" id="7928458">len</span><span class="op" id="7928461">(</span><span class="ident" id="7928462">cwd</span><span class="op" id="7928465">)</span><span class="op" id="7928466">-</span><span class="num" id="7928467">1</span><span class="op" id="7928468">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7928471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928474">h</span>&nbsp;<span class="op" id="7928476">=</span>&nbsp;<span class="op" id="7928478">&amp;</span><span class="ident" id="7928479">Handler</span><span class="op" id="7928486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928490">Path</span><span class="op" id="7928494">:</span>&nbsp;<span class="ident" id="7928496">perl</span><span class="op" id="7928500">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928504">Root</span><span class="op" id="7928508">:</span>&nbsp;<span class="string" id="7928510">&#34;/test.cgi&#34;</span><span class="op" id="7928521">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928525">Args</span><span class="op" id="7928529">:</span>&nbsp;<span class="op" id="7928531">[</span><span class="op" id="7928532">]</span><span class="builtintype" id="7928533">string</span><span class="op" id="7928539">{</span><span class="ident" id="7928540">cgifile</span><span class="op" id="7928547">}</span><span class="op" id="7928548">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928552">Env</span><span class="op" id="7928555">:</span>&nbsp;&nbsp;<span class="op" id="7928558">[</span><span class="op" id="7928559">]</span><span class="builtintype" id="7928560">string</span><span class="op" id="7928566">{</span><span class="string" id="7928567">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7928586">+</span>&nbsp;<span class="ident" id="7928588">cgifile</span><span class="op" id="7928595">}</span><span class="op" id="7928596">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7928599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928602">expectedMap</span>&nbsp;<span class="op" id="7928614">=</span>&nbsp;<span class="keyword" id="7928616">map</span><span class="op" id="7928619">[</span><span class="builtintype" id="7928620">string</span><span class="op" id="7928626">]</span><span class="builtintype" id="7928627">string</span><span class="op" id="7928633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7928637">&#34;cwd&#34;</span><span class="op" id="7928642">:</span>&nbsp;<span class="ident" id="7928644">cwd</span><span class="op" id="7928647">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7928650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928653">runCgiTest</span><span class="op" id="7928663">(</span><span class="ident" id="7928664">t</span><span class="op" id="7928665">,</span>&nbsp;<span class="ident" id="7928667">h</span><span class="op" id="7928668">,</span>&nbsp;<span class="string" id="7928670">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7928717">,</span>&nbsp;<span class="ident" id="7928719">expectedMap</span><span class="op" id="7928730">)</span><br>
<span class="lineno"></span><span class="op" id="7928732">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7928735">func</span>&nbsp;<span class="ident" id="7928740">TestEnvOverride</span><span class="op" id="7928755">(</span><span class="ident" id="7928756">t</span>&nbsp;<span class="op" id="7928758">*</span><span class="ident" id="7928759">testing</span><span class="op" id="7928766">.</span><span class="ident" id="7928767">T</span><span class="op" id="7928768">)</span>&nbsp;<span class="op" id="7928770">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928773">cgifile</span><span class="op" id="7928780">,</span>&nbsp;<span class="ident" id="7928782">_</span>&nbsp;<span class="op" id="7928784">:=</span>&nbsp;<span class="ident" id="7928787">filepath</span><span class="op" id="7928795">.</span><span class="ident" id="7928796">Abs</span><span class="op" id="7928799">(</span><span class="string" id="7928800">&#34;testdata/test.cgi&#34;</span><span class="op" id="7928819">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7928823">var</span>&nbsp;<span class="ident" id="7928827">perl</span>&nbsp;<span class="builtintype" id="7928832">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7928840">var</span>&nbsp;<span class="ident" id="7928844">err</span>&nbsp;<span class="builtintype" id="7928848">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928855">perl</span><span class="op" id="7928859">,</span>&nbsp;<span class="ident" id="7928861">err</span>&nbsp;<span class="op" id="7928865">=</span>&nbsp;<span class="ident" id="7928867">exec</span><span class="op" id="7928871">.</span><span class="ident" id="7928872">LookPath</span><span class="op" id="7928880">(</span><span class="string" id="7928881">&#34;perl&#34;</span><span class="op" id="7928887">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7928890">if</span>&nbsp;<span class="ident" id="7928893">err</span>&nbsp;<span class="op" id="7928897">!=</span>&nbsp;<span class="builtintype" id="7928900">nil</span>&nbsp;<span class="op" id="7928904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928908">t</span><span class="op" id="7928909">.</span><span class="ident" id="7928910">Skipf</span><span class="op" id="7928915">(</span><span class="string" id="7928916">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="7928948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7928951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928954">perl</span><span class="op" id="7928958">,</span>&nbsp;<span class="ident" id="7928960">_</span>&nbsp;<span class="op" id="7928962">=</span>&nbsp;<span class="ident" id="7928964">filepath</span><span class="op" id="7928972">.</span><span class="ident" id="7928973">Abs</span><span class="op" id="7928976">(</span><span class="ident" id="7928977">perl</span><span class="op" id="7928981">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7928985">cwd</span><span class="op" id="7928988">,</span>&nbsp;<span class="ident" id="7928990">_</span>&nbsp;<span class="op" id="7928992">:=</span>&nbsp;<span class="ident" id="7928995">os</span><span class="op" id="7928997">.</span><span class="ident" id="7928998">Getwd</span><span class="op" id="7929003">(</span><span class="op" id="7929004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7929007">h</span>&nbsp;<span class="op" id="7929009">:=</span>&nbsp;<span class="op" id="7929012">&amp;</span><span class="ident" id="7929013">Handler</span><span class="op" id="7929020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7929024">Path</span><span class="op" id="7929028">:</span>&nbsp;<span class="ident" id="7929030">perl</span><span class="op" id="7929034">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7929038">Root</span><span class="op" id="7929042">:</span>&nbsp;<span class="string" id="7929044">&#34;/test.cgi&#34;</span><span class="op" id="7929055">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7929059">Dir</span><span class="op" id="7929062">:</span>&nbsp;&nbsp;<span class="ident" id="7929065">cwd</span><span class="op" id="7929068">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7929072">Args</span><span class="op" id="7929076">:</span>&nbsp;<span class="op" id="7929078">[</span><span class="op" id="7929079">]</span><span class="builtintype" id="7929080">string</span><span class="op" id="7929086">{</span><span class="ident" id="7929087">cgifile</span><span class="op" id="7929094">}</span><span class="op" id="7929095">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7929099">Env</span><span class="op" id="7929102">:</span>&nbsp;<span class="op" id="7929104">[</span><span class="op" id="7929105">]</span><span class="builtintype" id="7929106">string</span><span class="op" id="7929112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929117">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="7929136">+</span>&nbsp;<span class="ident" id="7929138">cgifile</span><span class="op" id="7929145">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929150">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="7929172">}</span><span class="op" id="7929173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7929176">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7929179">expectedMap</span>&nbsp;<span class="op" id="7929191">:=</span>&nbsp;<span class="keyword" id="7929194">map</span><span class="op" id="7929197">[</span><span class="builtintype" id="7929198">string</span><span class="op" id="7929204">]</span><span class="builtintype" id="7929205">string</span><span class="op" id="7929211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929215">&#34;cwd&#34;</span><span class="op" id="7929220">:</span>&nbsp;<span class="ident" id="7929222">cwd</span><span class="op" id="7929225">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929229">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7929250">:</span>&nbsp;<span class="ident" id="7929252">cgifile</span><span class="op" id="7929259">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929263">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7929280">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7929286">&#34;/foo/bar&#34;</span><span class="op" id="7929296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7929299">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7929302">runCgiTest</span><span class="op" id="7929312">(</span><span class="ident" id="7929313">t</span><span class="op" id="7929314">,</span>&nbsp;<span class="ident" id="7929316">h</span><span class="op" id="7929317">,</span>&nbsp;<span class="string" id="7929319">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7929366">,</span>&nbsp;<span class="ident" id="7929368">expectedMap</span><span class="op" id="7929379">)</span><br>
<span class="lineno"></span><span class="op" id="7929381">}</span>
</div>
</body>
</html>
