<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4984002">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4984057">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4984111">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4984162">package</span>&nbsp;<span class="ident" id="4984170">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4984176">import</span>&nbsp;<span class="op" id="4984183">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984186">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984195">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984204">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984214">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984221">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984227">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984240">&#34;net/http/internal&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984261">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984278">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984286">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984297">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4984308">&#34;sync&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4984315">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4984318">//&nbsp;ErrLineTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;request&nbsp;or&nbsp;response&nbsp;bodies</span><br>
<span class="lineno"></span><span class="comment" id="4984388">//&nbsp;with&nbsp;malformed&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword" id="4984424">var</span>&nbsp;<span class="ident" id="4984428">ErrLineTooLong</span>&nbsp;<span class="op" id="4984443">=</span>&nbsp;<span class="ident" id="4984445">internal</span><span class="op" id="4984453">.</span><span class="ident" id="4984454">ErrLineTooLong</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="4984470">type</span>&nbsp;<span class="ident" id="4984475">errorReader</span>&nbsp;<span class="keyword" id="4984487">struct</span>&nbsp;<span class="op" id="4984494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4984497">err</span>&nbsp;<span class="builtintype" id="4984501">error</span><br>
<span class="lineno"></span><span class="op" id="4984507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="4984510">func</span>&nbsp;<span class="op" id="4984515">(</span><span class="ident" id="4984516">r</span>&nbsp;<span class="op" id="4984518">*</span><span class="ident" id="4984519">errorReader</span><span class="op" id="4984530">)</span>&nbsp;<span class="ident" id="4984532">Read</span><span class="op" id="4984536">(</span><span class="ident" id="4984537">p</span>&nbsp;<span class="op" id="4984539">[</span><span class="op" id="4984540">]</span><span class="builtintype" id="4984541">byte</span><span class="op" id="4984545">)</span>&nbsp;<span class="op" id="4984547">(</span><span class="ident" id="4984548">n</span>&nbsp;<span class="builtintype" id="4984550">int</span><span class="op" id="4984553">,</span>&nbsp;<span class="ident" id="4984555">err</span>&nbsp;<span class="builtintype" id="4984559">error</span><span class="op" id="4984564">)</span>&nbsp;<span class="op" id="4984566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4984569">return</span>&nbsp;<span class="num" id="4984576">0</span><span class="op" id="4984577">,</span>&nbsp;<span class="ident" id="4984579">r</span><span class="op" id="4984580">.</span><span class="ident" id="4984581">err</span><br>
<span class="lineno"></span><span class="op" id="4984585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4984588">//&nbsp;transferWriter&nbsp;inspects&nbsp;the&nbsp;fields&nbsp;of&nbsp;a&nbsp;user-supplied&nbsp;Request&nbsp;or&nbsp;Response,</span><br>
<span class="lineno">35</span><span class="comment" id="4984666">//&nbsp;sanitizes&nbsp;them&nbsp;without&nbsp;changing&nbsp;the&nbsp;user&nbsp;object&nbsp;and&nbsp;provides&nbsp;methods&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4984742">//&nbsp;writing&nbsp;the&nbsp;respective&nbsp;header,&nbsp;body&nbsp;and&nbsp;trailer&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="4984809">type</span>&nbsp;<span class="ident" id="4984814">transferWriter</span>&nbsp;<span class="keyword" id="4984829">struct</span>&nbsp;<span class="op" id="4984836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4984839">Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4984856">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4984864">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984881">io</span><span class="op" id="4984883">.</span><span class="ident" id="4984884">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4984892">BodyCloser</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984909">io</span><span class="op" id="4984911">.</span><span class="ident" id="4984912">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4984920">ResponseToHEAD</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4984937">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4984943">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4984960">int64</span>&nbsp;<span class="comment" id="4984966">//&nbsp;-1&nbsp;means&nbsp;unknown,&nbsp;0&nbsp;means&nbsp;exactly&nbsp;none</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985009">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4985026">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985032">TransferEncoding</span>&nbsp;<span class="op" id="4985049">[</span><span class="op" id="4985050">]</span><span class="builtintype" id="4985051">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985059">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4985076">Header</span><br>
<span class="lineno"></span><span class="op" id="4985083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4985086">func</span>&nbsp;<span class="ident" id="4985091">newTransferWriter</span><span class="op" id="4985108">(</span><span class="ident" id="4985109">r</span>&nbsp;<span class="keyword" id="4985111">interface</span><span class="op" id="4985120">{</span><span class="op" id="4985121">}</span><span class="op" id="4985122">)</span>&nbsp;<span class="op" id="4985124">(</span><span class="ident" id="4985125">t</span>&nbsp;<span class="op" id="4985127">*</span><span class="ident" id="4985128">transferWriter</span><span class="op" id="4985142">,</span>&nbsp;<span class="ident" id="4985144">err</span>&nbsp;<span class="builtintype" id="4985148">error</span><span class="op" id="4985153">)</span>&nbsp;<span class="op" id="4985155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985158">t</span>&nbsp;<span class="op" id="4985160">=</span>&nbsp;<span class="op" id="4985162">&amp;</span><span class="ident" id="4985163">transferWriter</span><span class="op" id="4985177">{</span><span class="op" id="4985178">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4985182">//&nbsp;Extract&nbsp;relevant&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985210">atLeastHTTP11</span>&nbsp;<span class="op" id="4985224">:=</span>&nbsp;<span class="builtintype" id="4985227">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985234">switch</span>&nbsp;<span class="ident" id="4985241">rr</span>&nbsp;<span class="op" id="4985244">:=</span>&nbsp;<span class="ident" id="4985247">r</span><span class="op" id="4985248">.</span><span class="op" id="4985249">(</span><span class="keyword" id="4985250">type</span><span class="op" id="4985254">)</span>&nbsp;<span class="op" id="4985256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985259">case</span>&nbsp;<span class="op" id="4985264">*</span><span class="ident" id="4985265">Request</span><span class="op" id="4985272">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985276">if</span>&nbsp;<span class="ident" id="4985279">rr</span><span class="op" id="4985281">.</span><span class="ident" id="4985282">ContentLength</span>&nbsp;<span class="op" id="4985296">!=</span>&nbsp;<span class="num" id="4985299">0</span>&nbsp;<span class="op" id="4985301">&amp;&amp;</span>&nbsp;<span class="ident" id="4985304">rr</span><span class="op" id="4985306">.</span><span class="ident" id="4985307">Body</span>&nbsp;<span class="op" id="4985312">==</span>&nbsp;<span class="ident" id="4985315">nil</span>&nbsp;<span class="op" id="4985319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985324">return</span>&nbsp;<span class="ident" id="4985331">nil</span><span class="op" id="4985334">,</span>&nbsp;<span class="ident" id="4985336">fmt</span><span class="op" id="4985339">.</span><span class="ident" id="4985340">Errorf</span><span class="op" id="4985346">(</span><span class="string" id="4985347">&#34;http:&nbsp;Request.ContentLength=%d&nbsp;with&nbsp;nil&nbsp;Body&#34;</span><span class="op" id="4985393">,</span>&nbsp;<span class="ident" id="4985395">rr</span><span class="op" id="4985397">.</span><span class="ident" id="4985398">ContentLength</span><span class="op" id="4985411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4985415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985419">t</span><span class="op" id="4985420">.</span><span class="ident" id="4985421">Method</span>&nbsp;<span class="op" id="4985428">=</span>&nbsp;<span class="ident" id="4985430">rr</span><span class="op" id="4985432">.</span><span class="ident" id="4985433">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985442">t</span><span class="op" id="4985443">.</span><span class="ident" id="4985444">Body</span>&nbsp;<span class="op" id="4985449">=</span>&nbsp;<span class="ident" id="4985451">rr</span><span class="op" id="4985453">.</span><span class="ident" id="4985454">Body</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985461">t</span><span class="op" id="4985462">.</span><span class="ident" id="4985463">BodyCloser</span>&nbsp;<span class="op" id="4985474">=</span>&nbsp;<span class="ident" id="4985476">rr</span><span class="op" id="4985478">.</span><span class="ident" id="4985479">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985486">t</span><span class="op" id="4985487">.</span><span class="ident" id="4985488">ContentLength</span>&nbsp;<span class="op" id="4985502">=</span>&nbsp;<span class="ident" id="4985504">rr</span><span class="op" id="4985506">.</span><span class="ident" id="4985507">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985523">t</span><span class="op" id="4985524">.</span><span class="ident" id="4985525">Close</span>&nbsp;<span class="op" id="4985531">=</span>&nbsp;<span class="ident" id="4985533">rr</span><span class="op" id="4985535">.</span><span class="ident" id="4985536">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985544">t</span><span class="op" id="4985545">.</span><span class="ident" id="4985546">TransferEncoding</span>&nbsp;<span class="op" id="4985563">=</span>&nbsp;<span class="ident" id="4985565">rr</span><span class="op" id="4985567">.</span><span class="ident" id="4985568">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985587">t</span><span class="op" id="4985588">.</span><span class="ident" id="4985589">Trailer</span>&nbsp;<span class="op" id="4985597">=</span>&nbsp;<span class="ident" id="4985599">rr</span><span class="op" id="4985601">.</span><span class="ident" id="4985602">Trailer</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985612">atLeastHTTP11</span>&nbsp;<span class="op" id="4985626">=</span>&nbsp;<span class="ident" id="4985628">rr</span><span class="op" id="4985630">.</span><span class="ident" id="4985631">ProtoAtLeast</span><span class="op" id="4985643">(</span><span class="num" id="4985644">1</span><span class="op" id="4985645">,</span>&nbsp;<span class="num" id="4985647">1</span><span class="op" id="4985648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985652">if</span>&nbsp;<span class="ident" id="4985655">t</span><span class="op" id="4985656">.</span><span class="ident" id="4985657">Body</span>&nbsp;<span class="op" id="4985662">!=</span>&nbsp;<span class="ident" id="4985665">nil</span>&nbsp;<span class="op" id="4985669">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4985672">len</span><span class="op" id="4985675">(</span><span class="ident" id="4985676">t</span><span class="op" id="4985677">.</span><span class="ident" id="4985678">TransferEncoding</span><span class="op" id="4985694">)</span>&nbsp;<span class="op" id="4985696">==</span>&nbsp;<span class="num" id="4985699">0</span>&nbsp;<span class="op" id="4985701">&amp;&amp;</span>&nbsp;<span class="ident" id="4985704">atLeastHTTP11</span>&nbsp;<span class="op" id="4985718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985723">if</span>&nbsp;<span class="ident" id="4985726">t</span><span class="op" id="4985727">.</span><span class="ident" id="4985728">ContentLength</span>&nbsp;<span class="op" id="4985742">==</span>&nbsp;<span class="num" id="4985745">0</span>&nbsp;<span class="op" id="4985747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4985753">//&nbsp;Test&nbsp;to&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;actually&nbsp;zero&nbsp;or&nbsp;just&nbsp;unset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985809">var</span>&nbsp;<span class="ident" id="4985813">buf</span>&nbsp;<span class="op" id="4985817">[</span><span class="num" id="4985818">1</span><span class="op" id="4985819">]</span><span class="builtintype" id="4985820">byte</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985829">n</span><span class="op" id="4985830">,</span>&nbsp;<span class="ident" id="4985832">rerr</span>&nbsp;<span class="op" id="4985837">:=</span>&nbsp;<span class="ident" id="4985840">io</span><span class="op" id="4985842">.</span><span class="ident" id="4985843">ReadFull</span><span class="op" id="4985851">(</span><span class="ident" id="4985852">t</span><span class="op" id="4985853">.</span><span class="ident" id="4985854">Body</span><span class="op" id="4985858">,</span>&nbsp;<span class="ident" id="4985860">buf</span><span class="op" id="4985863">[</span><span class="op" id="4985864">:</span><span class="op" id="4985865">]</span><span class="op" id="4985866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4985872">if</span>&nbsp;<span class="ident" id="4985875">rerr</span>&nbsp;<span class="op" id="4985880">!=</span>&nbsp;<span class="ident" id="4985883">nil</span>&nbsp;<span class="op" id="4985887">&amp;&amp;</span>&nbsp;<span class="ident" id="4985890">rerr</span>&nbsp;<span class="op" id="4985895">!=</span>&nbsp;<span class="ident" id="4985898">io</span><span class="op" id="4985900">.</span><span class="ident" id="4985901">EOF</span>&nbsp;<span class="op" id="4985905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985912">t</span><span class="op" id="4985913">.</span><span class="ident" id="4985914">ContentLength</span>&nbsp;<span class="op" id="4985928">=</span>&nbsp;<span class="op" id="4985930">-</span><span class="num" id="4985931">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4985938">t</span><span class="op" id="4985939">.</span><span class="ident" id="4985940">Body</span>&nbsp;<span class="op" id="4985945">=</span>&nbsp;<span class="op" id="4985947">&amp;</span><span class="ident" id="4985948">errorReader</span><span class="op" id="4985959">{</span><span class="ident" id="4985960">rerr</span><span class="op" id="4985964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4985970">}</span>&nbsp;<span class="keyword" id="4985972">else</span>&nbsp;<span class="keyword" id="4985977">if</span>&nbsp;<span class="ident" id="4985980">n</span>&nbsp;<span class="op" id="4985982">==</span>&nbsp;<span class="num" id="4985985">1</span>&nbsp;<span class="op" id="4985987">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4985994">//&nbsp;Oh,&nbsp;guess&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;this&nbsp;Body&nbsp;Reader&nbsp;after&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4986057">//&nbsp;The&nbsp;ContentLength&nbsp;field&nbsp;just&nbsp;wasn&#39;t&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4986106">//&nbsp;Stich&nbsp;the&nbsp;Body&nbsp;back&nbsp;together&nbsp;again,&nbsp;re-attaching&nbsp;our</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4986167">//&nbsp;consumed&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986190">t</span><span class="op" id="4986191">.</span><span class="ident" id="4986192">ContentLength</span>&nbsp;<span class="op" id="4986206">=</span>&nbsp;<span class="op" id="4986208">-</span><span class="num" id="4986209">1</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986216">t</span><span class="op" id="4986217">.</span><span class="ident" id="4986218">Body</span>&nbsp;<span class="op" id="4986223">=</span>&nbsp;<span class="ident" id="4986225">io</span><span class="op" id="4986227">.</span><span class="ident" id="4986228">MultiReader</span><span class="op" id="4986239">(</span><span class="ident" id="4986240">bytes</span><span class="op" id="4986245">.</span><span class="ident" id="4986246">NewReader</span><span class="op" id="4986255">(</span><span class="ident" id="4986256">buf</span><span class="op" id="4986259">[</span><span class="op" id="4986260">:</span><span class="op" id="4986261">]</span><span class="op" id="4986262">)</span><span class="op" id="4986263">,</span>&nbsp;<span class="ident" id="4986265">t</span><span class="op" id="4986266">.</span><span class="ident" id="4986267">Body</span><span class="op" id="4986271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986277">}</span>&nbsp;<span class="keyword" id="4986279">else</span>&nbsp;<span class="op" id="4986284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4986291">//&nbsp;Body&nbsp;is&nbsp;actually&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986323">t</span><span class="op" id="4986324">.</span><span class="ident" id="4986325">Body</span>&nbsp;<span class="op" id="4986330">=</span>&nbsp;<span class="ident" id="4986332">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986341">t</span><span class="op" id="4986342">.</span><span class="ident" id="4986343">BodyCloser</span>&nbsp;<span class="op" id="4986354">=</span>&nbsp;<span class="ident" id="4986356">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4986374">if</span>&nbsp;<span class="ident" id="4986377">t</span><span class="op" id="4986378">.</span><span class="ident" id="4986379">ContentLength</span>&nbsp;<span class="op" id="4986393">&lt;</span>&nbsp;<span class="num" id="4986395">0</span>&nbsp;<span class="op" id="4986397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986403">t</span><span class="op" id="4986404">.</span><span class="ident" id="4986405">TransferEncoding</span>&nbsp;<span class="op" id="4986422">=</span>&nbsp;<span class="op" id="4986424">[</span><span class="op" id="4986425">]</span><span class="builtintype" id="4986426">string</span><span class="op" id="4986432">{</span><span class="string" id="4986433">&#34;chunked&#34;</span><span class="op" id="4986442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986447">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4986454">case</span>&nbsp;<span class="op" id="4986459">*</span><span class="ident" id="4986460">Response</span><span class="op" id="4986468">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4986472">if</span>&nbsp;<span class="ident" id="4986475">rr</span><span class="op" id="4986477">.</span><span class="ident" id="4986478">Request</span>&nbsp;<span class="op" id="4986486">!=</span>&nbsp;<span class="ident" id="4986489">nil</span>&nbsp;<span class="op" id="4986493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986498">t</span><span class="op" id="4986499">.</span><span class="ident" id="4986500">Method</span>&nbsp;<span class="op" id="4986507">=</span>&nbsp;<span class="ident" id="4986509">rr</span><span class="op" id="4986511">.</span><span class="ident" id="4986512">Request</span><span class="op" id="4986519">.</span><span class="ident" id="4986520">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986529">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986533">t</span><span class="op" id="4986534">.</span><span class="ident" id="4986535">Body</span>&nbsp;<span class="op" id="4986540">=</span>&nbsp;<span class="ident" id="4986542">rr</span><span class="op" id="4986544">.</span><span class="ident" id="4986545">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986552">t</span><span class="op" id="4986553">.</span><span class="ident" id="4986554">BodyCloser</span>&nbsp;<span class="op" id="4986565">=</span>&nbsp;<span class="ident" id="4986567">rr</span><span class="op" id="4986569">.</span><span class="ident" id="4986570">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986577">t</span><span class="op" id="4986578">.</span><span class="ident" id="4986579">ContentLength</span>&nbsp;<span class="op" id="4986593">=</span>&nbsp;<span class="ident" id="4986595">rr</span><span class="op" id="4986597">.</span><span class="ident" id="4986598">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986614">t</span><span class="op" id="4986615">.</span><span class="ident" id="4986616">Close</span>&nbsp;<span class="op" id="4986622">=</span>&nbsp;<span class="ident" id="4986624">rr</span><span class="op" id="4986626">.</span><span class="ident" id="4986627">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986635">t</span><span class="op" id="4986636">.</span><span class="ident" id="4986637">TransferEncoding</span>&nbsp;<span class="op" id="4986654">=</span>&nbsp;<span class="ident" id="4986656">rr</span><span class="op" id="4986658">.</span><span class="ident" id="4986659">TransferEncoding</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986678">t</span><span class="op" id="4986679">.</span><span class="ident" id="4986680">Trailer</span>&nbsp;<span class="op" id="4986688">=</span>&nbsp;<span class="ident" id="4986690">rr</span><span class="op" id="4986692">.</span><span class="ident" id="4986693">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986703">atLeastHTTP11</span>&nbsp;<span class="op" id="4986717">=</span>&nbsp;<span class="ident" id="4986719">rr</span><span class="op" id="4986721">.</span><span class="ident" id="4986722">ProtoAtLeast</span><span class="op" id="4986734">(</span><span class="num" id="4986735">1</span><span class="op" id="4986736">,</span>&nbsp;<span class="num" id="4986738">1</span><span class="op" id="4986739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986743">t</span><span class="op" id="4986744">.</span><span class="ident" id="4986745">ResponseToHEAD</span>&nbsp;<span class="op" id="4986760">=</span>&nbsp;<span class="ident" id="4986762">noBodyExpected</span><span class="op" id="4986776">(</span><span class="ident" id="4986777">t</span><span class="op" id="4986778">.</span><span class="ident" id="4986779">Method</span><span class="op" id="4986785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4986792">//&nbsp;Sanitize&nbsp;Body,ContentLength,TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4986841">if</span>&nbsp;<span class="ident" id="4986844">t</span><span class="op" id="4986845">.</span><span class="ident" id="4986846">ResponseToHEAD</span>&nbsp;<span class="op" id="4986861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986865">t</span><span class="op" id="4986866">.</span><span class="ident" id="4986867">Body</span>&nbsp;<span class="op" id="4986872">=</span>&nbsp;<span class="ident" id="4986874">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4986880">if</span>&nbsp;<span class="ident" id="4986883">chunked</span><span class="op" id="4986890">(</span><span class="ident" id="4986891">t</span><span class="op" id="4986892">.</span><span class="ident" id="4986893">TransferEncoding</span><span class="op" id="4986909">)</span>&nbsp;<span class="op" id="4986911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986916">t</span><span class="op" id="4986917">.</span><span class="ident" id="4986918">ContentLength</span>&nbsp;<span class="op" id="4986932">=</span>&nbsp;<span class="op" id="4986934">-</span><span class="num" id="4986935">1</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4986942">}</span>&nbsp;<span class="keyword" id="4986944">else</span>&nbsp;<span class="op" id="4986949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4986953">if</span>&nbsp;<span class="op" id="4986956">!</span><span class="ident" id="4986957">atLeastHTTP11</span>&nbsp;<span class="op" id="4986971">||</span>&nbsp;<span class="ident" id="4986974">t</span><span class="op" id="4986975">.</span><span class="ident" id="4986976">Body</span>&nbsp;<span class="op" id="4986981">==</span>&nbsp;<span class="ident" id="4986984">nil</span>&nbsp;<span class="op" id="4986988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4986993">t</span><span class="op" id="4986994">.</span><span class="ident" id="4986995">TransferEncoding</span>&nbsp;<span class="op" id="4987012">=</span>&nbsp;<span class="ident" id="4987014">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987020">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987024">if</span>&nbsp;<span class="ident" id="4987027">chunked</span><span class="op" id="4987034">(</span><span class="ident" id="4987035">t</span><span class="op" id="4987036">.</span><span class="ident" id="4987037">TransferEncoding</span><span class="op" id="4987053">)</span>&nbsp;<span class="op" id="4987055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4987060">t</span><span class="op" id="4987061">.</span><span class="ident" id="4987062">ContentLength</span>&nbsp;<span class="op" id="4987076">=</span>&nbsp;<span class="op" id="4987078">-</span><span class="num" id="4987079">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987083">}</span>&nbsp;<span class="keyword" id="4987085">else</span>&nbsp;<span class="keyword" id="4987090">if</span>&nbsp;<span class="ident" id="4987093">t</span><span class="op" id="4987094">.</span><span class="ident" id="4987095">Body</span>&nbsp;<span class="op" id="4987100">==</span>&nbsp;<span class="ident" id="4987103">nil</span>&nbsp;<span class="op" id="4987107">{</span>&nbsp;<span class="comment" id="4987109">//&nbsp;no&nbsp;chunking,&nbsp;no&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4987136">t</span><span class="op" id="4987137">.</span><span class="ident" id="4987138">ContentLength</span>&nbsp;<span class="op" id="4987152">=</span>&nbsp;<span class="num" id="4987154">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987158">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4987165">//&nbsp;Sanitize&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987186">if</span>&nbsp;<span class="op" id="4987189">!</span><span class="ident" id="4987190">chunked</span><span class="op" id="4987197">(</span><span class="ident" id="4987198">t</span><span class="op" id="4987199">.</span><span class="ident" id="4987200">TransferEncoding</span><span class="op" id="4987216">)</span>&nbsp;<span class="op" id="4987218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4987222">t</span><span class="op" id="4987223">.</span><span class="ident" id="4987224">Trailer</span>&nbsp;<span class="op" id="4987232">=</span>&nbsp;<span class="ident" id="4987234">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987243">return</span>&nbsp;<span class="ident" id="4987250">t</span><span class="op" id="4987251">,</span>&nbsp;<span class="ident" id="4987253">nil</span><br>
<span class="lineno"></span><span class="op" id="4987257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="4987260">func</span>&nbsp;<span class="ident" id="4987265">noBodyExpected</span><span class="op" id="4987279">(</span><span class="ident" id="4987280">requestMethod</span>&nbsp;<span class="builtintype" id="4987294">string</span><span class="op" id="4987300">)</span>&nbsp;<span class="builtintype" id="4987302">bool</span>&nbsp;<span class="op" id="4987307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987310">return</span>&nbsp;<span class="ident" id="4987317">requestMethod</span>&nbsp;<span class="op" id="4987331">==</span>&nbsp;<span class="string" id="4987334">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><span class="op" id="4987341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4987344">func</span>&nbsp;<span class="op" id="4987349">(</span><span class="ident" id="4987350">t</span>&nbsp;<span class="op" id="4987352">*</span><span class="ident" id="4987353">transferWriter</span><span class="op" id="4987367">)</span>&nbsp;<span class="ident" id="4987369">shouldSendContentLength</span><span class="op" id="4987392">(</span><span class="op" id="4987393">)</span>&nbsp;<span class="builtintype" id="4987395">bool</span>&nbsp;<span class="op" id="4987400">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987403">if</span>&nbsp;<span class="ident" id="4987406">chunked</span><span class="op" id="4987413">(</span><span class="ident" id="4987414">t</span><span class="op" id="4987415">.</span><span class="ident" id="4987416">TransferEncoding</span><span class="op" id="4987432">)</span>&nbsp;<span class="op" id="4987434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987438">return</span>&nbsp;<span class="builtintype" id="4987445">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987455">if</span>&nbsp;<span class="ident" id="4987458">t</span><span class="op" id="4987459">.</span><span class="ident" id="4987460">ContentLength</span>&nbsp;<span class="op" id="4987474">&gt;</span>&nbsp;<span class="num" id="4987476">0</span>&nbsp;<span class="op" id="4987478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987482">return</span>&nbsp;<span class="builtintype" id="4987489">true</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4987498">//&nbsp;Many&nbsp;servers&nbsp;expect&nbsp;a&nbsp;Content-Length&nbsp;for&nbsp;these&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987557">if</span>&nbsp;<span class="ident" id="4987560">t</span><span class="op" id="4987561">.</span><span class="ident" id="4987562">Method</span>&nbsp;<span class="op" id="4987569">==</span>&nbsp;<span class="string" id="4987572">&#34;POST&#34;</span>&nbsp;<span class="op" id="4987579">||</span>&nbsp;<span class="ident" id="4987582">t</span><span class="op" id="4987583">.</span><span class="ident" id="4987584">Method</span>&nbsp;<span class="op" id="4987591">==</span>&nbsp;<span class="string" id="4987594">&#34;PUT&#34;</span>&nbsp;<span class="op" id="4987600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987604">return</span>&nbsp;<span class="builtintype" id="4987611">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987617">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987620">if</span>&nbsp;<span class="ident" id="4987623">t</span><span class="op" id="4987624">.</span><span class="ident" id="4987625">ContentLength</span>&nbsp;<span class="op" id="4987639">==</span>&nbsp;<span class="num" id="4987642">0</span>&nbsp;<span class="op" id="4987644">&amp;&amp;</span>&nbsp;<span class="ident" id="4987647">isIdentity</span><span class="op" id="4987657">(</span><span class="ident" id="4987658">t</span><span class="op" id="4987659">.</span><span class="ident" id="4987660">TransferEncoding</span><span class="op" id="4987676">)</span>&nbsp;<span class="op" id="4987678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987682">return</span>&nbsp;<span class="builtintype" id="4987689">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987699">return</span>&nbsp;<span class="builtintype" id="4987706">false</span><br>
<span class="lineno">150</span><span class="op" id="4987712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4987715">func</span>&nbsp;<span class="op" id="4987720">(</span><span class="ident" id="4987721">t</span>&nbsp;<span class="op" id="4987723">*</span><span class="ident" id="4987724">transferWriter</span><span class="op" id="4987738">)</span>&nbsp;<span class="ident" id="4987740">WriteHeader</span><span class="op" id="4987751">(</span><span class="ident" id="4987752">w</span>&nbsp;<span class="ident" id="4987754">io</span><span class="op" id="4987756">.</span><span class="ident" id="4987757">Writer</span><span class="op" id="4987763">)</span>&nbsp;<span class="builtintype" id="4987765">error</span>&nbsp;<span class="op" id="4987771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987774">if</span>&nbsp;<span class="ident" id="4987777">t</span><span class="op" id="4987778">.</span><span class="ident" id="4987779">Close</span>&nbsp;<span class="op" id="4987785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987789">if</span>&nbsp;<span class="ident" id="4987792">_</span><span class="op" id="4987793">,</span>&nbsp;<span class="ident" id="4987795">err</span>&nbsp;<span class="op" id="4987799">:=</span>&nbsp;<span class="ident" id="4987802">io</span><span class="op" id="4987804">.</span><span class="ident" id="4987805">WriteString</span><span class="op" id="4987816">(</span><span class="ident" id="4987817">w</span><span class="op" id="4987818">,</span>&nbsp;<span class="string" id="4987820">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="4987843">)</span><span class="op" id="4987844">;</span>&nbsp;<span class="ident" id="4987846">err</span>&nbsp;<span class="op" id="4987850">!=</span>&nbsp;<span class="ident" id="4987853">nil</span>&nbsp;<span class="op" id="4987857">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4987862">return</span>&nbsp;<span class="ident" id="4987869">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4987878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4987882">//&nbsp;Write&nbsp;Content-Length&nbsp;and/or&nbsp;Transfer-Encoding&nbsp;whose&nbsp;values&nbsp;are&nbsp;a</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4987951">//&nbsp;function&nbsp;of&nbsp;the&nbsp;sanitized&nbsp;field&nbsp;triple&nbsp;(Body,&nbsp;ContentLength,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4988016">//&nbsp;TransferEncoding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988038">if</span>&nbsp;<span class="ident" id="4988041">t</span><span class="op" id="4988042">.</span><span class="ident" id="4988043">shouldSendContentLength</span><span class="op" id="4988066">(</span><span class="op" id="4988067">)</span>&nbsp;<span class="op" id="4988069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988073">if</span>&nbsp;<span class="ident" id="4988076">_</span><span class="op" id="4988077">,</span>&nbsp;<span class="ident" id="4988079">err</span>&nbsp;<span class="op" id="4988083">:=</span>&nbsp;<span class="ident" id="4988086">io</span><span class="op" id="4988088">.</span><span class="ident" id="4988089">WriteString</span><span class="op" id="4988100">(</span><span class="ident" id="4988101">w</span><span class="op" id="4988102">,</span>&nbsp;<span class="string" id="4988104">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="4988122">)</span><span class="op" id="4988123">;</span>&nbsp;<span class="ident" id="4988125">err</span>&nbsp;<span class="op" id="4988129">!=</span>&nbsp;<span class="ident" id="4988132">nil</span>&nbsp;<span class="op" id="4988136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988141">return</span>&nbsp;<span class="ident" id="4988148">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4988154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988158">if</span>&nbsp;<span class="ident" id="4988161">_</span><span class="op" id="4988162">,</span>&nbsp;<span class="ident" id="4988164">err</span>&nbsp;<span class="op" id="4988168">:=</span>&nbsp;<span class="ident" id="4988171">io</span><span class="op" id="4988173">.</span><span class="ident" id="4988174">WriteString</span><span class="op" id="4988185">(</span><span class="ident" id="4988186">w</span><span class="op" id="4988187">,</span>&nbsp;<span class="ident" id="4988189">strconv</span><span class="op" id="4988196">.</span><span class="ident" id="4988197">FormatInt</span><span class="op" id="4988206">(</span><span class="ident" id="4988207">t</span><span class="op" id="4988208">.</span><span class="ident" id="4988209">ContentLength</span><span class="op" id="4988222">,</span>&nbsp;<span class="num" id="4988224">10</span><span class="op" id="4988226">)</span><span class="op" id="4988227">+</span><span class="string" id="4988228">&#34;\r\n&#34;</span><span class="op" id="4988234">)</span><span class="op" id="4988235">;</span>&nbsp;<span class="ident" id="4988237">err</span>&nbsp;<span class="op" id="4988241">!=</span>&nbsp;<span class="ident" id="4988244">nil</span>&nbsp;<span class="op" id="4988248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988253">return</span>&nbsp;<span class="ident" id="4988260">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4988266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4988269">}</span>&nbsp;<span class="keyword" id="4988271">else</span>&nbsp;<span class="keyword" id="4988276">if</span>&nbsp;<span class="ident" id="4988279">chunked</span><span class="op" id="4988286">(</span><span class="ident" id="4988287">t</span><span class="op" id="4988288">.</span><span class="ident" id="4988289">TransferEncoding</span><span class="op" id="4988305">)</span>&nbsp;<span class="op" id="4988307">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988311">if</span>&nbsp;<span class="ident" id="4988314">_</span><span class="op" id="4988315">,</span>&nbsp;<span class="ident" id="4988317">err</span>&nbsp;<span class="op" id="4988321">:=</span>&nbsp;<span class="ident" id="4988324">io</span><span class="op" id="4988326">.</span><span class="ident" id="4988327">WriteString</span><span class="op" id="4988338">(</span><span class="ident" id="4988339">w</span><span class="op" id="4988340">,</span>&nbsp;<span class="string" id="4988342">&#34;Transfer-Encoding:&nbsp;chunked\r\n&#34;</span><span class="op" id="4988374">)</span><span class="op" id="4988375">;</span>&nbsp;<span class="ident" id="4988377">err</span>&nbsp;<span class="op" id="4988381">!=</span>&nbsp;<span class="ident" id="4988384">nil</span>&nbsp;<span class="op" id="4988388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988393">return</span>&nbsp;<span class="ident" id="4988400">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4988406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4988409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4988413">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988438">if</span>&nbsp;<span class="ident" id="4988441">t</span><span class="op" id="4988442">.</span><span class="ident" id="4988443">Trailer</span>&nbsp;<span class="op" id="4988451">!=</span>&nbsp;<span class="ident" id="4988454">nil</span>&nbsp;<span class="op" id="4988458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4988462">keys</span>&nbsp;<span class="op" id="4988467">:=</span>&nbsp;<span class="builtinfunc" id="4988470">make</span><span class="op" id="4988474">(</span><span class="op" id="4988475">[</span><span class="op" id="4988476">]</span><span class="builtintype" id="4988477">string</span><span class="op" id="4988483">,</span>&nbsp;<span class="num" id="4988485">0</span><span class="op" id="4988486">,</span>&nbsp;<span class="builtinfunc" id="4988488">len</span><span class="op" id="4988491">(</span><span class="ident" id="4988492">t</span><span class="op" id="4988493">.</span><span class="ident" id="4988494">Trailer</span><span class="op" id="4988501">)</span><span class="op" id="4988502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988506">for</span>&nbsp;<span class="ident" id="4988510">k</span>&nbsp;<span class="op" id="4988512">:=</span>&nbsp;<span class="keyword" id="4988515">range</span>&nbsp;<span class="ident" id="4988521">t</span><span class="op" id="4988522">.</span><span class="ident" id="4988523">Trailer</span>&nbsp;<span class="op" id="4988531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4988536">k</span>&nbsp;<span class="op" id="4988538">=</span>&nbsp;<span class="ident" id="4988540">CanonicalHeaderKey</span><span class="op" id="4988558">(</span><span class="ident" id="4988559">k</span><span class="op" id="4988560">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988565">switch</span>&nbsp;<span class="ident" id="4988572">k</span>&nbsp;<span class="op" id="4988574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988579">case</span>&nbsp;<span class="string" id="4988584">&#34;Transfer-Encoding&#34;</span><span class="op" id="4988603">,</span>&nbsp;<span class="string" id="4988605">&#34;Trailer&#34;</span><span class="op" id="4988614">,</span>&nbsp;<span class="string" id="4988616">&#34;Content-Length&#34;</span><span class="op" id="4988632">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988638">return</span>&nbsp;<span class="op" id="4988645">&amp;</span><span class="ident" id="4988646">badStringError</span><span class="op" id="4988660">{</span><span class="string" id="4988661">&#34;invalid&nbsp;Trailer&nbsp;key&#34;</span><span class="op" id="4988682">,</span>&nbsp;<span class="ident" id="4988684">k</span><span class="op" id="4988685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4988690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4988695">keys</span>&nbsp;<span class="op" id="4988700">=</span>&nbsp;<span class="builtinfunc" id="4988702">append</span><span class="op" id="4988708">(</span><span class="ident" id="4988709">keys</span><span class="op" id="4988713">,</span>&nbsp;<span class="ident" id="4988715">k</span><span class="op" id="4988716">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4988720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988724">if</span>&nbsp;<span class="builtinfunc" id="4988727">len</span><span class="op" id="4988730">(</span><span class="ident" id="4988731">keys</span><span class="op" id="4988735">)</span>&nbsp;<span class="op" id="4988737">&gt;</span>&nbsp;<span class="num" id="4988739">0</span>&nbsp;<span class="op" id="4988741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4988746">sort</span><span class="op" id="4988750">.</span><span class="ident" id="4988751">Strings</span><span class="op" id="4988758">(</span><span class="ident" id="4988759">keys</span><span class="op" id="4988763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4988768">//&nbsp;TODO:&nbsp;could&nbsp;do&nbsp;better&nbsp;allocation-wise&nbsp;here,&nbsp;but&nbsp;trailers&nbsp;are&nbsp;rare,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4988841">//&nbsp;so&nbsp;being&nbsp;lazy&nbsp;for&nbsp;now.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988870">if</span>&nbsp;<span class="ident" id="4988873">_</span><span class="op" id="4988874">,</span>&nbsp;<span class="ident" id="4988876">err</span>&nbsp;<span class="op" id="4988880">:=</span>&nbsp;<span class="ident" id="4988883">io</span><span class="op" id="4988885">.</span><span class="ident" id="4988886">WriteString</span><span class="op" id="4988897">(</span><span class="ident" id="4988898">w</span><span class="op" id="4988899">,</span>&nbsp;<span class="string" id="4988901">&#34;Trailer:&nbsp;&#34;</span><span class="op" id="4988912">+</span><span class="ident" id="4988913">strings</span><span class="op" id="4988920">.</span><span class="ident" id="4988921">Join</span><span class="op" id="4988925">(</span><span class="ident" id="4988926">keys</span><span class="op" id="4988930">,</span>&nbsp;<span class="string" id="4988932">&#34;,&#34;</span><span class="op" id="4988935">)</span><span class="op" id="4988936">+</span><span class="string" id="4988937">&#34;\r\n&#34;</span><span class="op" id="4988943">)</span><span class="op" id="4988944">;</span>&nbsp;<span class="ident" id="4988946">err</span>&nbsp;<span class="op" id="4988950">!=</span>&nbsp;<span class="ident" id="4988953">nil</span>&nbsp;<span class="op" id="4988957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988963">return</span>&nbsp;<span class="ident" id="4988970">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4988977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4988981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4988984">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4988988">return</span>&nbsp;<span class="ident" id="4988995">nil</span><br>
<span class="lineno"></span><span class="op" id="4988999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4989002">func</span>&nbsp;<span class="op" id="4989007">(</span><span class="ident" id="4989008">t</span>&nbsp;<span class="op" id="4989010">*</span><span class="ident" id="4989011">transferWriter</span><span class="op" id="4989025">)</span>&nbsp;<span class="ident" id="4989027">WriteBody</span><span class="op" id="4989036">(</span><span class="ident" id="4989037">w</span>&nbsp;<span class="ident" id="4989039">io</span><span class="op" id="4989041">.</span><span class="ident" id="4989042">Writer</span><span class="op" id="4989048">)</span>&nbsp;<span class="builtintype" id="4989050">error</span>&nbsp;<span class="op" id="4989056">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989059">var</span>&nbsp;<span class="ident" id="4989063">err</span>&nbsp;<span class="builtintype" id="4989067">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989074">var</span>&nbsp;<span class="ident" id="4989078">ncopy</span>&nbsp;<span class="ident" id="4989084">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4989092">//&nbsp;Write&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989107">if</span>&nbsp;<span class="ident" id="4989110">t</span><span class="op" id="4989111">.</span><span class="ident" id="4989112">Body</span>&nbsp;<span class="op" id="4989117">!=</span>&nbsp;<span class="ident" id="4989120">nil</span>&nbsp;<span class="op" id="4989124">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989128">if</span>&nbsp;<span class="ident" id="4989131">chunked</span><span class="op" id="4989138">(</span><span class="ident" id="4989139">t</span><span class="op" id="4989140">.</span><span class="ident" id="4989141">TransferEncoding</span><span class="op" id="4989157">)</span>&nbsp;<span class="op" id="4989159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989164">cw</span>&nbsp;<span class="op" id="4989167">:=</span>&nbsp;<span class="ident" id="4989170">internal</span><span class="op" id="4989178">.</span><span class="ident" id="4989179">NewChunkedWriter</span><span class="op" id="4989195">(</span><span class="ident" id="4989196">w</span><span class="op" id="4989197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989202">_</span><span class="op" id="4989203">,</span>&nbsp;<span class="ident" id="4989205">err</span>&nbsp;<span class="op" id="4989209">=</span>&nbsp;<span class="ident" id="4989211">io</span><span class="op" id="4989213">.</span><span class="ident" id="4989214">Copy</span><span class="op" id="4989218">(</span><span class="ident" id="4989219">cw</span><span class="op" id="4989221">,</span>&nbsp;<span class="ident" id="4989223">t</span><span class="op" id="4989224">.</span><span class="ident" id="4989225">Body</span><span class="op" id="4989229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989234">if</span>&nbsp;<span class="ident" id="4989237">err</span>&nbsp;<span class="op" id="4989241">==</span>&nbsp;<span class="ident" id="4989244">nil</span>&nbsp;<span class="op" id="4989248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989254">err</span>&nbsp;<span class="op" id="4989258">=</span>&nbsp;<span class="ident" id="4989260">cw</span><span class="op" id="4989262">.</span><span class="ident" id="4989263">Close</span><span class="op" id="4989268">(</span><span class="op" id="4989269">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4989274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4989278">}</span>&nbsp;<span class="keyword" id="4989280">else</span>&nbsp;<span class="keyword" id="4989285">if</span>&nbsp;<span class="ident" id="4989288">t</span><span class="op" id="4989289">.</span><span class="ident" id="4989290">ContentLength</span>&nbsp;<span class="op" id="4989304">==</span>&nbsp;<span class="op" id="4989307">-</span><span class="num" id="4989308">1</span>&nbsp;<span class="op" id="4989310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989315">ncopy</span><span class="op" id="4989320">,</span>&nbsp;<span class="ident" id="4989322">err</span>&nbsp;<span class="op" id="4989326">=</span>&nbsp;<span class="ident" id="4989328">io</span><span class="op" id="4989330">.</span><span class="ident" id="4989331">Copy</span><span class="op" id="4989335">(</span><span class="ident" id="4989336">w</span><span class="op" id="4989337">,</span>&nbsp;<span class="ident" id="4989339">t</span><span class="op" id="4989340">.</span><span class="ident" id="4989341">Body</span><span class="op" id="4989345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4989349">}</span>&nbsp;<span class="keyword" id="4989351">else</span>&nbsp;<span class="op" id="4989356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989361">ncopy</span><span class="op" id="4989366">,</span>&nbsp;<span class="ident" id="4989368">err</span>&nbsp;<span class="op" id="4989372">=</span>&nbsp;<span class="ident" id="4989374">io</span><span class="op" id="4989376">.</span><span class="ident" id="4989377">Copy</span><span class="op" id="4989381">(</span><span class="ident" id="4989382">w</span><span class="op" id="4989383">,</span>&nbsp;<span class="ident" id="4989385">io</span><span class="op" id="4989387">.</span><span class="ident" id="4989388">LimitReader</span><span class="op" id="4989399">(</span><span class="ident" id="4989400">t</span><span class="op" id="4989401">.</span><span class="ident" id="4989402">Body</span><span class="op" id="4989406">,</span>&nbsp;<span class="ident" id="4989408">t</span><span class="op" id="4989409">.</span><span class="ident" id="4989410">ContentLength</span><span class="op" id="4989423">)</span><span class="op" id="4989424">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989429">if</span>&nbsp;<span class="ident" id="4989432">err</span>&nbsp;<span class="op" id="4989436">!=</span>&nbsp;<span class="ident" id="4989439">nil</span>&nbsp;<span class="op" id="4989443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989449">return</span>&nbsp;<span class="ident" id="4989456">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4989463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989468">var</span>&nbsp;<span class="ident" id="4989472">nextra</span>&nbsp;<span class="ident" id="4989479">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989488">nextra</span><span class="op" id="4989494">,</span>&nbsp;<span class="ident" id="4989496">err</span>&nbsp;<span class="op" id="4989500">=</span>&nbsp;<span class="ident" id="4989502">io</span><span class="op" id="4989504">.</span><span class="ident" id="4989505">Copy</span><span class="op" id="4989509">(</span><span class="ident" id="4989510">ioutil</span><span class="op" id="4989516">.</span><span class="ident" id="4989517">Discard</span><span class="op" id="4989524">,</span>&nbsp;<span class="ident" id="4989526">t</span><span class="op" id="4989527">.</span><span class="ident" id="4989528">Body</span><span class="op" id="4989532">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989537">ncopy</span>&nbsp;<span class="op" id="4989543">+=</span>&nbsp;<span class="ident" id="4989546">nextra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4989555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989559">if</span>&nbsp;<span class="ident" id="4989562">err</span>&nbsp;<span class="op" id="4989566">!=</span>&nbsp;<span class="ident" id="4989569">nil</span>&nbsp;<span class="op" id="4989573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989578">return</span>&nbsp;<span class="ident" id="4989585">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4989591">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989595">if</span>&nbsp;<span class="ident" id="4989598">err</span>&nbsp;<span class="op" id="4989602">=</span>&nbsp;<span class="ident" id="4989604">t</span><span class="op" id="4989605">.</span><span class="ident" id="4989606">BodyCloser</span><span class="op" id="4989616">.</span><span class="ident" id="4989617">Close</span><span class="op" id="4989622">(</span><span class="op" id="4989623">)</span><span class="op" id="4989624">;</span>&nbsp;<span class="ident" id="4989626">err</span>&nbsp;<span class="op" id="4989630">!=</span>&nbsp;<span class="ident" id="4989633">nil</span>&nbsp;<span class="op" id="4989637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989642">return</span>&nbsp;<span class="ident" id="4989649">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4989655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4989658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989662">if</span>&nbsp;<span class="op" id="4989665">!</span><span class="ident" id="4989666">t</span><span class="op" id="4989667">.</span><span class="ident" id="4989668">ResponseToHEAD</span>&nbsp;<span class="op" id="4989683">&amp;&amp;</span>&nbsp;<span class="ident" id="4989686">t</span><span class="op" id="4989687">.</span><span class="ident" id="4989688">ContentLength</span>&nbsp;<span class="op" id="4989702">!=</span>&nbsp;<span class="op" id="4989705">-</span><span class="num" id="4989706">1</span>&nbsp;<span class="op" id="4989708">&amp;&amp;</span>&nbsp;<span class="ident" id="4989711">t</span><span class="op" id="4989712">.</span><span class="ident" id="4989713">ContentLength</span>&nbsp;<span class="op" id="4989727">!=</span>&nbsp;<span class="ident" id="4989730">ncopy</span>&nbsp;<span class="op" id="4989736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989740">return</span>&nbsp;<span class="ident" id="4989747">fmt</span><span class="op" id="4989750">.</span><span class="ident" id="4989751">Errorf</span><span class="op" id="4989757">(</span><span class="string" id="4989758">&#34;http:&nbsp;ContentLength=%d&nbsp;with&nbsp;Body&nbsp;length&nbsp;%d&#34;</span><span class="op" id="4989802">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4989807">t</span><span class="op" id="4989808">.</span><span class="ident" id="4989809">ContentLength</span><span class="op" id="4989822">,</span>&nbsp;<span class="ident" id="4989824">ncopy</span><span class="op" id="4989829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4989832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4989836">//&nbsp;TODO(petar):&nbsp;Place&nbsp;trailer&nbsp;writer&nbsp;code&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989885">if</span>&nbsp;<span class="ident" id="4989888">chunked</span><span class="op" id="4989895">(</span><span class="ident" id="4989896">t</span><span class="op" id="4989897">.</span><span class="ident" id="4989898">TransferEncoding</span><span class="op" id="4989914">)</span>&nbsp;<span class="op" id="4989916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4989920">//&nbsp;Write&nbsp;Trailer&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989946">if</span>&nbsp;<span class="ident" id="4989949">t</span><span class="op" id="4989950">.</span><span class="ident" id="4989951">Trailer</span>&nbsp;<span class="op" id="4989959">!=</span>&nbsp;<span class="ident" id="4989962">nil</span>&nbsp;<span class="op" id="4989966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4989971">if</span>&nbsp;<span class="ident" id="4989974">err</span>&nbsp;<span class="op" id="4989978">:=</span>&nbsp;<span class="ident" id="4989981">t</span><span class="op" id="4989982">.</span><span class="ident" id="4989983">Trailer</span><span class="op" id="4989990">.</span><span class="ident" id="4989991">Write</span><span class="op" id="4989996">(</span><span class="ident" id="4989997">w</span><span class="op" id="4989998">)</span><span class="op" id="4989999">;</span>&nbsp;<span class="ident" id="4990001">err</span>&nbsp;<span class="op" id="4990005">!=</span>&nbsp;<span class="ident" id="4990008">nil</span>&nbsp;<span class="op" id="4990012">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990018">return</span>&nbsp;<span class="ident" id="4990025">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4990032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4990036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4990040">//&nbsp;Last&nbsp;chunk,&nbsp;empty&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990071">_</span><span class="op" id="4990072">,</span>&nbsp;<span class="ident" id="4990074">err</span>&nbsp;<span class="op" id="4990078">=</span>&nbsp;<span class="ident" id="4990080">io</span><span class="op" id="4990082">.</span><span class="ident" id="4990083">WriteString</span><span class="op" id="4990094">(</span><span class="ident" id="4990095">w</span><span class="op" id="4990096">,</span>&nbsp;<span class="string" id="4990098">&#34;\r\n&#34;</span><span class="op" id="4990104">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4990107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990110">return</span>&nbsp;<span class="ident" id="4990117">err</span><br>
<span class="lineno"></span><span class="op" id="4990121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4990124">type</span>&nbsp;<span class="ident" id="4990129">transferReader</span>&nbsp;<span class="keyword" id="4990144">struct</span>&nbsp;<span class="op" id="4990151">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4990154">//&nbsp;Input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990164">Header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990178">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990186">StatusCode</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4990200">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990205">RequestMethod</span>&nbsp;<span class="builtintype" id="4990219">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990227">ProtoMajor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4990241">int</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990246">ProtoMinor</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4990260">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4990265">//&nbsp;Output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990276">Body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990293">io</span><span class="op" id="4990295">.</span><span class="ident" id="4990296">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990308">ContentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990325">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990332">TransferEncoding</span>&nbsp;<span class="op" id="4990349">[</span><span class="op" id="4990350">]</span><span class="builtintype" id="4990351">string</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990359">Close</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4990376">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990382">Trailer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4990399">Header</span><br>
<span class="lineno"></span><span class="op" id="4990406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4990409">//&nbsp;bodyAllowedForStatus&nbsp;reports&nbsp;whether&nbsp;a&nbsp;given&nbsp;response&nbsp;status&nbsp;code</span><br>
<span class="lineno">265</span><span class="comment" id="4990478">//&nbsp;permits&nbsp;a&nbsp;body.&nbsp;&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span><span class="keyword" id="4990524">func</span>&nbsp;<span class="ident" id="4990529">bodyAllowedForStatus</span><span class="op" id="4990549">(</span><span class="ident" id="4990550">status</span>&nbsp;<span class="builtintype" id="4990557">int</span><span class="op" id="4990560">)</span>&nbsp;<span class="builtintype" id="4990562">bool</span>&nbsp;<span class="op" id="4990567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990570">switch</span>&nbsp;<span class="op" id="4990577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990580">case</span>&nbsp;<span class="ident" id="4990585">status</span>&nbsp;<span class="op" id="4990592">&gt;=</span>&nbsp;<span class="num" id="4990595">100</span>&nbsp;<span class="op" id="4990599">&amp;&amp;</span>&nbsp;<span class="ident" id="4990602">status</span>&nbsp;<span class="op" id="4990609">&lt;=</span>&nbsp;<span class="num" id="4990612">199</span><span class="op" id="4990615">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990619">return</span>&nbsp;<span class="builtintype" id="4990626">false</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990633">case</span>&nbsp;<span class="ident" id="4990638">status</span>&nbsp;<span class="op" id="4990645">==</span>&nbsp;<span class="num" id="4990648">204</span><span class="op" id="4990651">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990655">return</span>&nbsp;<span class="builtintype" id="4990662">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990669">case</span>&nbsp;<span class="ident" id="4990674">status</span>&nbsp;<span class="op" id="4990681">==</span>&nbsp;<span class="num" id="4990684">304</span><span class="op" id="4990687">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990691">return</span>&nbsp;<span class="builtintype" id="4990698">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4990705">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990708">return</span>&nbsp;<span class="builtintype" id="4990715">true</span><br>
<span class="lineno"></span><span class="op" id="4990720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4990723">var</span>&nbsp;<span class="op" id="4990727">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990730">suppressedHeaders304</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4990754">=</span>&nbsp;<span class="op" id="4990756">[</span><span class="op" id="4990757">]</span><span class="builtintype" id="4990758">string</span><span class="op" id="4990764">{</span><span class="string" id="4990765">&#34;Content-Type&#34;</span><span class="op" id="4990779">,</span>&nbsp;<span class="string" id="4990781">&#34;Content-Length&#34;</span><span class="op" id="4990797">,</span>&nbsp;<span class="string" id="4990799">&#34;Transfer-Encoding&#34;</span><span class="op" id="4990818">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4990821">suppressedHeadersNoBody</span>&nbsp;<span class="op" id="4990845">=</span>&nbsp;<span class="op" id="4990847">[</span><span class="op" id="4990848">]</span><span class="builtintype" id="4990849">string</span><span class="op" id="4990855">{</span><span class="string" id="4990856">&#34;Content-Length&#34;</span><span class="op" id="4990872">,</span>&nbsp;<span class="string" id="4990874">&#34;Transfer-Encoding&#34;</span><span class="op" id="4990893">}</span><br>
<span class="lineno"></span><span class="op" id="4990895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4990898">func</span>&nbsp;<span class="ident" id="4990903">suppressedHeaders</span><span class="op" id="4990920">(</span><span class="ident" id="4990921">status</span>&nbsp;<span class="builtintype" id="4990928">int</span><span class="op" id="4990931">)</span>&nbsp;<span class="op" id="4990933">[</span><span class="op" id="4990934">]</span><span class="builtintype" id="4990935">string</span>&nbsp;<span class="op" id="4990942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990945">switch</span>&nbsp;<span class="op" id="4990952">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4990955">case</span>&nbsp;<span class="ident" id="4990960">status</span>&nbsp;<span class="op" id="4990967">==</span>&nbsp;<span class="num" id="4990970">304</span><span class="op" id="4990973">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4990977">//&nbsp;RFC&nbsp;2616&nbsp;section&nbsp;10.3.5:&nbsp;&#34;the&nbsp;response&nbsp;MUST&nbsp;NOT&nbsp;include&nbsp;other&nbsp;entity-headers&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991060">return</span>&nbsp;<span class="ident" id="4991067">suppressedHeaders304</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991089">case</span>&nbsp;<span class="op" id="4991094">!</span><span class="ident" id="4991095">bodyAllowedForStatus</span><span class="op" id="4991115">(</span><span class="ident" id="4991116">status</span><span class="op" id="4991122">)</span><span class="op" id="4991123">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991127">return</span>&nbsp;<span class="ident" id="4991134">suppressedHeadersNoBody</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4991159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991162">return</span>&nbsp;<span class="ident" id="4991169">nil</span><br>
<span class="lineno"></span><span class="op" id="4991173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4991176">//&nbsp;msg&nbsp;is&nbsp;*Request&nbsp;or&nbsp;*Response.</span><br>
<span class="lineno">295</span><span class="keyword" id="4991209">func</span>&nbsp;<span class="ident" id="4991214">readTransfer</span><span class="op" id="4991226">(</span><span class="ident" id="4991227">msg</span>&nbsp;<span class="keyword" id="4991231">interface</span><span class="op" id="4991240">{</span><span class="op" id="4991241">}</span><span class="op" id="4991242">,</span>&nbsp;<span class="ident" id="4991244">r</span>&nbsp;<span class="op" id="4991246">*</span><span class="ident" id="4991247">bufio</span><span class="op" id="4991252">.</span><span class="ident" id="4991253">Reader</span><span class="op" id="4991259">)</span>&nbsp;<span class="op" id="4991261">(</span><span class="ident" id="4991262">err</span>&nbsp;<span class="builtintype" id="4991266">error</span><span class="op" id="4991271">)</span>&nbsp;<span class="op" id="4991273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991276">t</span>&nbsp;<span class="op" id="4991278">:=</span>&nbsp;<span class="op" id="4991281">&amp;</span><span class="ident" id="4991282">transferReader</span><span class="op" id="4991296">{</span><span class="ident" id="4991297">RequestMethod</span><span class="op" id="4991310">:</span>&nbsp;<span class="string" id="4991312">&#34;GET&#34;</span><span class="op" id="4991317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4991321">//&nbsp;Unify&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991337">isResponse</span>&nbsp;<span class="op" id="4991348">:=</span>&nbsp;<span class="builtintype" id="4991351">false</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991358">switch</span>&nbsp;<span class="ident" id="4991365">rr</span>&nbsp;<span class="op" id="4991368">:=</span>&nbsp;<span class="ident" id="4991371">msg</span><span class="op" id="4991374">.</span><span class="op" id="4991375">(</span><span class="keyword" id="4991376">type</span><span class="op" id="4991380">)</span>&nbsp;<span class="op" id="4991382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991385">case</span>&nbsp;<span class="op" id="4991390">*</span><span class="ident" id="4991391">Response</span><span class="op" id="4991399">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991403">t</span><span class="op" id="4991404">.</span><span class="ident" id="4991405">Header</span>&nbsp;<span class="op" id="4991412">=</span>&nbsp;<span class="ident" id="4991414">rr</span><span class="op" id="4991416">.</span><span class="ident" id="4991417">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991426">t</span><span class="op" id="4991427">.</span><span class="ident" id="4991428">StatusCode</span>&nbsp;<span class="op" id="4991439">=</span>&nbsp;<span class="ident" id="4991441">rr</span><span class="op" id="4991443">.</span><span class="ident" id="4991444">StatusCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991457">t</span><span class="op" id="4991458">.</span><span class="ident" id="4991459">ProtoMajor</span>&nbsp;<span class="op" id="4991470">=</span>&nbsp;<span class="ident" id="4991472">rr</span><span class="op" id="4991474">.</span><span class="ident" id="4991475">ProtoMajor</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991488">t</span><span class="op" id="4991489">.</span><span class="ident" id="4991490">ProtoMinor</span>&nbsp;<span class="op" id="4991501">=</span>&nbsp;<span class="ident" id="4991503">rr</span><span class="op" id="4991505">.</span><span class="ident" id="4991506">ProtoMinor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991519">t</span><span class="op" id="4991520">.</span><span class="ident" id="4991521">Close</span>&nbsp;<span class="op" id="4991527">=</span>&nbsp;<span class="ident" id="4991529">shouldClose</span><span class="op" id="4991540">(</span><span class="ident" id="4991541">t</span><span class="op" id="4991542">.</span><span class="ident" id="4991543">ProtoMajor</span><span class="op" id="4991553">,</span>&nbsp;<span class="ident" id="4991555">t</span><span class="op" id="4991556">.</span><span class="ident" id="4991557">ProtoMinor</span><span class="op" id="4991567">,</span>&nbsp;<span class="ident" id="4991569">t</span><span class="op" id="4991570">.</span><span class="ident" id="4991571">Header</span><span class="op" id="4991577">,</span>&nbsp;<span class="builtintype" id="4991579">true</span><span class="op" id="4991583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991587">isResponse</span>&nbsp;<span class="op" id="4991598">=</span>&nbsp;<span class="builtintype" id="4991600">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991607">if</span>&nbsp;<span class="ident" id="4991610">rr</span><span class="op" id="4991612">.</span><span class="ident" id="4991613">Request</span>&nbsp;<span class="op" id="4991621">!=</span>&nbsp;<span class="ident" id="4991624">nil</span>&nbsp;<span class="op" id="4991628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991633">t</span><span class="op" id="4991634">.</span><span class="ident" id="4991635">RequestMethod</span>&nbsp;<span class="op" id="4991649">=</span>&nbsp;<span class="ident" id="4991651">rr</span><span class="op" id="4991653">.</span><span class="ident" id="4991654">Request</span><span class="op" id="4991661">.</span><span class="ident" id="4991662">Method</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4991671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991674">case</span>&nbsp;<span class="op" id="4991679">*</span><span class="ident" id="4991680">Request</span><span class="op" id="4991687">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991691">t</span><span class="op" id="4991692">.</span><span class="ident" id="4991693">Header</span>&nbsp;<span class="op" id="4991700">=</span>&nbsp;<span class="ident" id="4991702">rr</span><span class="op" id="4991704">.</span><span class="ident" id="4991705">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991714">t</span><span class="op" id="4991715">.</span><span class="ident" id="4991716">ProtoMajor</span>&nbsp;<span class="op" id="4991727">=</span>&nbsp;<span class="ident" id="4991729">rr</span><span class="op" id="4991731">.</span><span class="ident" id="4991732">ProtoMajor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991745">t</span><span class="op" id="4991746">.</span><span class="ident" id="4991747">ProtoMinor</span>&nbsp;<span class="op" id="4991758">=</span>&nbsp;<span class="ident" id="4991760">rr</span><span class="op" id="4991762">.</span><span class="ident" id="4991763">ProtoMinor</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4991776">//&nbsp;Transfer&nbsp;semantics&nbsp;for&nbsp;Requests&nbsp;are&nbsp;exactly&nbsp;like&nbsp;those&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4991840">//&nbsp;Responses&nbsp;with&nbsp;status&nbsp;code&nbsp;200,&nbsp;responding&nbsp;to&nbsp;a&nbsp;GET&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4991904">t</span><span class="op" id="4991905">.</span><span class="ident" id="4991906">StatusCode</span>&nbsp;<span class="op" id="4991917">=</span>&nbsp;<span class="num" id="4991919">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991924">default</span><span class="op" id="4991931">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4991935">panic</span><span class="op" id="4991940">(</span><span class="string" id="4991941">&#34;unexpected&nbsp;type&#34;</span><span class="op" id="4991958">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4991961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4991965">//&nbsp;Default&nbsp;to&nbsp;HTTP/1.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4991989">if</span>&nbsp;<span class="ident" id="4991992">t</span><span class="op" id="4991993">.</span><span class="ident" id="4991994">ProtoMajor</span>&nbsp;<span class="op" id="4992005">==</span>&nbsp;<span class="num" id="4992008">0</span>&nbsp;<span class="op" id="4992010">&amp;&amp;</span>&nbsp;<span class="ident" id="4992013">t</span><span class="op" id="4992014">.</span><span class="ident" id="4992015">ProtoMinor</span>&nbsp;<span class="op" id="4992026">==</span>&nbsp;<span class="num" id="4992029">0</span>&nbsp;<span class="op" id="4992031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992035">t</span><span class="op" id="4992036">.</span><span class="ident" id="4992037">ProtoMajor</span><span class="op" id="4992047">,</span>&nbsp;<span class="ident" id="4992049">t</span><span class="op" id="4992050">.</span><span class="ident" id="4992051">ProtoMinor</span>&nbsp;<span class="op" id="4992062">=</span>&nbsp;<span class="num" id="4992064">1</span><span class="op" id="4992065">,</span>&nbsp;<span class="num" id="4992067">1</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992074">//&nbsp;Transfer&nbsp;encoding,&nbsp;content&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992112">t</span><span class="op" id="4992113">.</span><span class="ident" id="4992114">TransferEncoding</span><span class="op" id="4992130">,</span>&nbsp;<span class="ident" id="4992132">err</span>&nbsp;<span class="op" id="4992136">=</span>&nbsp;<span class="ident" id="4992138">fixTransferEncoding</span><span class="op" id="4992157">(</span><span class="ident" id="4992158">t</span><span class="op" id="4992159">.</span><span class="ident" id="4992160">RequestMethod</span><span class="op" id="4992173">,</span>&nbsp;<span class="ident" id="4992175">t</span><span class="op" id="4992176">.</span><span class="ident" id="4992177">Header</span><span class="op" id="4992183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992186">if</span>&nbsp;<span class="ident" id="4992189">err</span>&nbsp;<span class="op" id="4992193">!=</span>&nbsp;<span class="ident" id="4992196">nil</span>&nbsp;<span class="op" id="4992200">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992204">return</span>&nbsp;<span class="ident" id="4992211">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992220">realLength</span><span class="op" id="4992230">,</span>&nbsp;<span class="ident" id="4992232">err</span>&nbsp;<span class="op" id="4992236">:=</span>&nbsp;<span class="ident" id="4992239">fixLength</span><span class="op" id="4992248">(</span><span class="ident" id="4992249">isResponse</span><span class="op" id="4992259">,</span>&nbsp;<span class="ident" id="4992261">t</span><span class="op" id="4992262">.</span><span class="ident" id="4992263">StatusCode</span><span class="op" id="4992273">,</span>&nbsp;<span class="ident" id="4992275">t</span><span class="op" id="4992276">.</span><span class="ident" id="4992277">RequestMethod</span><span class="op" id="4992290">,</span>&nbsp;<span class="ident" id="4992292">t</span><span class="op" id="4992293">.</span><span class="ident" id="4992294">Header</span><span class="op" id="4992300">,</span>&nbsp;<span class="ident" id="4992302">t</span><span class="op" id="4992303">.</span><span class="ident" id="4992304">TransferEncoding</span><span class="op" id="4992320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992323">if</span>&nbsp;<span class="ident" id="4992326">err</span>&nbsp;<span class="op" id="4992330">!=</span>&nbsp;<span class="ident" id="4992333">nil</span>&nbsp;<span class="op" id="4992337">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992341">return</span>&nbsp;<span class="ident" id="4992348">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992356">if</span>&nbsp;<span class="ident" id="4992359">isResponse</span>&nbsp;<span class="op" id="4992370">&amp;&amp;</span>&nbsp;<span class="ident" id="4992373">t</span><span class="op" id="4992374">.</span><span class="ident" id="4992375">RequestMethod</span>&nbsp;<span class="op" id="4992389">==</span>&nbsp;<span class="string" id="4992392">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4992399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992403">if</span>&nbsp;<span class="ident" id="4992406">n</span><span class="op" id="4992407">,</span>&nbsp;<span class="ident" id="4992409">err</span>&nbsp;<span class="op" id="4992413">:=</span>&nbsp;<span class="ident" id="4992416">parseContentLength</span><span class="op" id="4992434">(</span><span class="ident" id="4992435">t</span><span class="op" id="4992436">.</span><span class="ident" id="4992437">Header</span><span class="op" id="4992443">.</span><span class="ident" id="4992444">get</span><span class="op" id="4992447">(</span><span class="string" id="4992448">&#34;Content-Length&#34;</span><span class="op" id="4992464">)</span><span class="op" id="4992465">)</span><span class="op" id="4992466">;</span>&nbsp;<span class="ident" id="4992468">err</span>&nbsp;<span class="op" id="4992472">!=</span>&nbsp;<span class="ident" id="4992475">nil</span>&nbsp;<span class="op" id="4992479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992484">return</span>&nbsp;<span class="ident" id="4992491">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992497">}</span>&nbsp;<span class="keyword" id="4992499">else</span>&nbsp;<span class="op" id="4992504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992509">t</span><span class="op" id="4992510">.</span><span class="ident" id="4992511">ContentLength</span>&nbsp;<span class="op" id="4992525">=</span>&nbsp;<span class="ident" id="4992527">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992534">}</span>&nbsp;<span class="keyword" id="4992536">else</span>&nbsp;<span class="op" id="4992541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992545">t</span><span class="op" id="4992546">.</span><span class="ident" id="4992547">ContentLength</span>&nbsp;<span class="op" id="4992561">=</span>&nbsp;<span class="ident" id="4992563">realLength</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992579">//&nbsp;Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992591">t</span><span class="op" id="4992592">.</span><span class="ident" id="4992593">Trailer</span><span class="op" id="4992600">,</span>&nbsp;<span class="ident" id="4992602">err</span>&nbsp;<span class="op" id="4992606">=</span>&nbsp;<span class="ident" id="4992608">fixTrailer</span><span class="op" id="4992618">(</span><span class="ident" id="4992619">t</span><span class="op" id="4992620">.</span><span class="ident" id="4992621">Header</span><span class="op" id="4992627">,</span>&nbsp;<span class="ident" id="4992629">t</span><span class="op" id="4992630">.</span><span class="ident" id="4992631">TransferEncoding</span><span class="op" id="4992647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992650">if</span>&nbsp;<span class="ident" id="4992653">err</span>&nbsp;<span class="op" id="4992657">!=</span>&nbsp;<span class="ident" id="4992660">nil</span>&nbsp;<span class="op" id="4992664">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992668">return</span>&nbsp;<span class="ident" id="4992675">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992684">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;Content-Length&nbsp;or&nbsp;chunked&nbsp;Transfer-Encoding&nbsp;on&nbsp;a&nbsp;*Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992762">//&nbsp;and&nbsp;the&nbsp;status&nbsp;is&nbsp;not&nbsp;1xx,&nbsp;204&nbsp;or&nbsp;304,&nbsp;then&nbsp;the&nbsp;body&nbsp;is&nbsp;unbounded.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4992833">//&nbsp;See&nbsp;RFC2616,&nbsp;section&nbsp;4.4.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992863">switch</span>&nbsp;<span class="ident" id="4992870">msg</span><span class="op" id="4992873">.</span><span class="op" id="4992874">(</span><span class="keyword" id="4992875">type</span><span class="op" id="4992879">)</span>&nbsp;<span class="op" id="4992881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992884">case</span>&nbsp;<span class="op" id="4992889">*</span><span class="ident" id="4992890">Response</span><span class="op" id="4992898">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4992902">if</span>&nbsp;<span class="ident" id="4992905">realLength</span>&nbsp;<span class="op" id="4992916">==</span>&nbsp;<span class="op" id="4992919">-</span><span class="num" id="4992920">1</span>&nbsp;<span class="op" id="4992922">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4992928">!</span><span class="ident" id="4992929">chunked</span><span class="op" id="4992936">(</span><span class="ident" id="4992937">t</span><span class="op" id="4992938">.</span><span class="ident" id="4992939">TransferEncoding</span><span class="op" id="4992955">)</span>&nbsp;<span class="op" id="4992957">&amp;&amp;</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4992963">bodyAllowedForStatus</span><span class="op" id="4992983">(</span><span class="ident" id="4992984">t</span><span class="op" id="4992985">.</span><span class="ident" id="4992986">StatusCode</span><span class="op" id="4992996">)</span>&nbsp;<span class="op" id="4992998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993003">//&nbsp;Unbounded&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993025">t</span><span class="op" id="4993026">.</span><span class="ident" id="4993027">Close</span>&nbsp;<span class="op" id="4993033">=</span>&nbsp;<span class="builtintype" id="4993035">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993045">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993049">//&nbsp;Prepare&nbsp;body&nbsp;reader.&nbsp;&nbsp;ContentLength&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;chunked&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993116">//&nbsp;or&nbsp;close&nbsp;connection&nbsp;when&nbsp;finished,&nbsp;since&nbsp;multipart&nbsp;is&nbsp;not&nbsp;supported&nbsp;yet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993192">switch</span>&nbsp;<span class="op" id="4993199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993202">case</span>&nbsp;<span class="ident" id="4993207">chunked</span><span class="op" id="4993214">(</span><span class="ident" id="4993215">t</span><span class="op" id="4993216">.</span><span class="ident" id="4993217">TransferEncoding</span><span class="op" id="4993233">)</span><span class="op" id="4993234">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993238">if</span>&nbsp;<span class="ident" id="4993241">noBodyExpected</span><span class="op" id="4993255">(</span><span class="ident" id="4993256">t</span><span class="op" id="4993257">.</span><span class="ident" id="4993258">RequestMethod</span><span class="op" id="4993271">)</span>&nbsp;<span class="op" id="4993273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993278">t</span><span class="op" id="4993279">.</span><span class="ident" id="4993280">Body</span>&nbsp;<span class="op" id="4993285">=</span>&nbsp;<span class="ident" id="4993287">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993299">}</span>&nbsp;<span class="keyword" id="4993301">else</span>&nbsp;<span class="op" id="4993306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993311">t</span><span class="op" id="4993312">.</span><span class="ident" id="4993313">Body</span>&nbsp;<span class="op" id="4993318">=</span>&nbsp;<span class="op" id="4993320">&amp;</span><span class="ident" id="4993321">body</span><span class="op" id="4993325">{</span><span class="ident" id="4993326">src</span><span class="op" id="4993329">:</span>&nbsp;<span class="ident" id="4993331">internal</span><span class="op" id="4993339">.</span><span class="ident" id="4993340">NewChunkedReader</span><span class="op" id="4993356">(</span><span class="ident" id="4993357">r</span><span class="op" id="4993358">)</span><span class="op" id="4993359">,</span>&nbsp;<span class="ident" id="4993361">hdr</span><span class="op" id="4993364">:</span>&nbsp;<span class="ident" id="4993366">msg</span><span class="op" id="4993369">,</span>&nbsp;<span class="ident" id="4993371">r</span><span class="op" id="4993372">:</span>&nbsp;<span class="ident" id="4993374">r</span><span class="op" id="4993375">,</span>&nbsp;<span class="ident" id="4993377">closing</span><span class="op" id="4993384">:</span>&nbsp;<span class="ident" id="4993386">t</span><span class="op" id="4993387">.</span><span class="ident" id="4993388">Close</span><span class="op" id="4993393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993397">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993400">case</span>&nbsp;<span class="ident" id="4993405">realLength</span>&nbsp;<span class="op" id="4993416">==</span>&nbsp;<span class="num" id="4993419">0</span><span class="op" id="4993420">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993424">t</span><span class="op" id="4993425">.</span><span class="ident" id="4993426">Body</span>&nbsp;<span class="op" id="4993431">=</span>&nbsp;<span class="ident" id="4993433">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993444">case</span>&nbsp;<span class="ident" id="4993449">realLength</span>&nbsp;<span class="op" id="4993460">&gt;</span>&nbsp;<span class="num" id="4993462">0</span><span class="op" id="4993463">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993467">t</span><span class="op" id="4993468">.</span><span class="ident" id="4993469">Body</span>&nbsp;<span class="op" id="4993474">=</span>&nbsp;<span class="op" id="4993476">&amp;</span><span class="ident" id="4993477">body</span><span class="op" id="4993481">{</span><span class="ident" id="4993482">src</span><span class="op" id="4993485">:</span>&nbsp;<span class="ident" id="4993487">io</span><span class="op" id="4993489">.</span><span class="ident" id="4993490">LimitReader</span><span class="op" id="4993501">(</span><span class="ident" id="4993502">r</span><span class="op" id="4993503">,</span>&nbsp;<span class="ident" id="4993505">realLength</span><span class="op" id="4993515">)</span><span class="op" id="4993516">,</span>&nbsp;<span class="ident" id="4993518">closing</span><span class="op" id="4993525">:</span>&nbsp;<span class="ident" id="4993527">t</span><span class="op" id="4993528">.</span><span class="ident" id="4993529">Close</span><span class="op" id="4993534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993537">default</span><span class="op" id="4993544">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993548">//&nbsp;realLength&nbsp;&lt;&nbsp;0,&nbsp;i.e.&nbsp;&#34;Content-Length&#34;&nbsp;not&nbsp;mentioned&nbsp;in&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993615">if</span>&nbsp;<span class="ident" id="4993618">t</span><span class="op" id="4993619">.</span><span class="ident" id="4993620">Close</span>&nbsp;<span class="op" id="4993626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993631">//&nbsp;Close&nbsp;semantics&nbsp;(i.e.&nbsp;HTTP/1.0)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993669">t</span><span class="op" id="4993670">.</span><span class="ident" id="4993671">Body</span>&nbsp;<span class="op" id="4993676">=</span>&nbsp;<span class="op" id="4993678">&amp;</span><span class="ident" id="4993679">body</span><span class="op" id="4993683">{</span><span class="ident" id="4993684">src</span><span class="op" id="4993687">:</span>&nbsp;<span class="ident" id="4993689">r</span><span class="op" id="4993690">,</span>&nbsp;<span class="ident" id="4993692">closing</span><span class="op" id="4993699">:</span>&nbsp;<span class="ident" id="4993701">t</span><span class="op" id="4993702">.</span><span class="ident" id="4993703">Close</span><span class="op" id="4993708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993712">}</span>&nbsp;<span class="keyword" id="4993714">else</span>&nbsp;<span class="op" id="4993719">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993724">//&nbsp;Persistent&nbsp;connection&nbsp;(i.e.&nbsp;HTTP/1.1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993768">t</span><span class="op" id="4993769">.</span><span class="ident" id="4993770">Body</span>&nbsp;<span class="op" id="4993775">=</span>&nbsp;<span class="ident" id="4993777">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993789">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4993792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4993796">//&nbsp;Unify&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993813">switch</span>&nbsp;<span class="ident" id="4993820">rr</span>&nbsp;<span class="op" id="4993823">:=</span>&nbsp;<span class="ident" id="4993826">msg</span><span class="op" id="4993829">.</span><span class="op" id="4993830">(</span><span class="keyword" id="4993831">type</span><span class="op" id="4993835">)</span>&nbsp;<span class="op" id="4993837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4993840">case</span>&nbsp;<span class="op" id="4993845">*</span><span class="ident" id="4993846">Request</span><span class="op" id="4993853">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993857">rr</span><span class="op" id="4993859">.</span><span class="ident" id="4993860">Body</span>&nbsp;<span class="op" id="4993865">=</span>&nbsp;<span class="ident" id="4993867">t</span><span class="op" id="4993868">.</span><span class="ident" id="4993869">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993876">rr</span><span class="op" id="4993878">.</span><span class="ident" id="4993879">ContentLength</span>&nbsp;<span class="op" id="4993893">=</span>&nbsp;<span class="ident" id="4993895">t</span><span class="op" id="4993896">.</span><span class="ident" id="4993897">ContentLength</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993913">rr</span><span class="op" id="4993915">.</span><span class="ident" id="4993916">TransferEncoding</span>&nbsp;<span class="op" id="4993933">=</span>&nbsp;<span class="ident" id="4993935">t</span><span class="op" id="4993936">.</span><span class="ident" id="4993937">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993956">rr</span><span class="op" id="4993958">.</span><span class="ident" id="4993959">Close</span>&nbsp;<span class="op" id="4993965">=</span>&nbsp;<span class="ident" id="4993967">t</span><span class="op" id="4993968">.</span><span class="ident" id="4993969">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4993977">rr</span><span class="op" id="4993979">.</span><span class="ident" id="4993980">Trailer</span>&nbsp;<span class="op" id="4993988">=</span>&nbsp;<span class="ident" id="4993990">t</span><span class="op" id="4993991">.</span><span class="ident" id="4993992">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994001">case</span>&nbsp;<span class="op" id="4994006">*</span><span class="ident" id="4994007">Response</span><span class="op" id="4994015">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994019">rr</span><span class="op" id="4994021">.</span><span class="ident" id="4994022">Body</span>&nbsp;<span class="op" id="4994027">=</span>&nbsp;<span class="ident" id="4994029">t</span><span class="op" id="4994030">.</span><span class="ident" id="4994031">Body</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994038">rr</span><span class="op" id="4994040">.</span><span class="ident" id="4994041">ContentLength</span>&nbsp;<span class="op" id="4994055">=</span>&nbsp;<span class="ident" id="4994057">t</span><span class="op" id="4994058">.</span><span class="ident" id="4994059">ContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994075">rr</span><span class="op" id="4994077">.</span><span class="ident" id="4994078">TransferEncoding</span>&nbsp;<span class="op" id="4994095">=</span>&nbsp;<span class="ident" id="4994097">t</span><span class="op" id="4994098">.</span><span class="ident" id="4994099">TransferEncoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994118">rr</span><span class="op" id="4994120">.</span><span class="ident" id="4994121">Close</span>&nbsp;<span class="op" id="4994127">=</span>&nbsp;<span class="ident" id="4994129">t</span><span class="op" id="4994130">.</span><span class="ident" id="4994131">Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994139">rr</span><span class="op" id="4994141">.</span><span class="ident" id="4994142">Trailer</span>&nbsp;<span class="op" id="4994150">=</span>&nbsp;<span class="ident" id="4994152">t</span><span class="op" id="4994153">.</span><span class="ident" id="4994154">Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994163">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994167">return</span>&nbsp;<span class="ident" id="4994174">nil</span><br>
<span class="lineno"></span><span class="op" id="4994178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4994181">//&nbsp;Checks&nbsp;whether&nbsp;chunked&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;encodings&nbsp;stack</span><br>
<span class="lineno">410</span><span class="keyword" id="4994238">func</span>&nbsp;<span class="ident" id="4994243">chunked</span><span class="op" id="4994250">(</span><span class="ident" id="4994251">te</span>&nbsp;<span class="op" id="4994254">[</span><span class="op" id="4994255">]</span><span class="builtintype" id="4994256">string</span><span class="op" id="4994262">)</span>&nbsp;<span class="builtintype" id="4994264">bool</span>&nbsp;<span class="op" id="4994269">{</span>&nbsp;<span class="keyword" id="4994271">return</span>&nbsp;<span class="builtinfunc" id="4994278">len</span><span class="op" id="4994281">(</span><span class="ident" id="4994282">te</span><span class="op" id="4994284">)</span>&nbsp;<span class="op" id="4994286">&gt;</span>&nbsp;<span class="num" id="4994288">0</span>&nbsp;<span class="op" id="4994290">&amp;&amp;</span>&nbsp;<span class="ident" id="4994293">te</span><span class="op" id="4994295">[</span><span class="num" id="4994296">0</span><span class="op" id="4994297">]</span>&nbsp;<span class="op" id="4994299">==</span>&nbsp;<span class="string" id="4994302">&#34;chunked&#34;</span>&nbsp;<span class="op" id="4994312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4994315">//&nbsp;Checks&nbsp;whether&nbsp;the&nbsp;encoding&nbsp;is&nbsp;explicitly&nbsp;&#34;identity&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4994372">func</span>&nbsp;<span class="ident" id="4994377">isIdentity</span><span class="op" id="4994387">(</span><span class="ident" id="4994388">te</span>&nbsp;<span class="op" id="4994391">[</span><span class="op" id="4994392">]</span><span class="builtintype" id="4994393">string</span><span class="op" id="4994399">)</span>&nbsp;<span class="builtintype" id="4994401">bool</span>&nbsp;<span class="op" id="4994406">{</span>&nbsp;<span class="keyword" id="4994408">return</span>&nbsp;<span class="builtinfunc" id="4994415">len</span><span class="op" id="4994418">(</span><span class="ident" id="4994419">te</span><span class="op" id="4994421">)</span>&nbsp;<span class="op" id="4994423">==</span>&nbsp;<span class="num" id="4994426">1</span>&nbsp;<span class="op" id="4994428">&amp;&amp;</span>&nbsp;<span class="ident" id="4994431">te</span><span class="op" id="4994433">[</span><span class="num" id="4994434">0</span><span class="op" id="4994435">]</span>&nbsp;<span class="op" id="4994437">==</span>&nbsp;<span class="string" id="4994440">&#34;identity&#34;</span>&nbsp;<span class="op" id="4994451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="4994454">//&nbsp;Sanitize&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno"></span><span class="keyword" id="4994484">func</span>&nbsp;<span class="ident" id="4994489">fixTransferEncoding</span><span class="op" id="4994508">(</span><span class="ident" id="4994509">requestMethod</span>&nbsp;<span class="builtintype" id="4994523">string</span><span class="op" id="4994529">,</span>&nbsp;<span class="ident" id="4994531">header</span>&nbsp;<span class="ident" id="4994538">Header</span><span class="op" id="4994544">)</span>&nbsp;<span class="op" id="4994546">(</span><span class="op" id="4994547">[</span><span class="op" id="4994548">]</span><span class="builtintype" id="4994549">string</span><span class="op" id="4994555">,</span>&nbsp;<span class="builtintype" id="4994557">error</span><span class="op" id="4994562">)</span>&nbsp;<span class="op" id="4994564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994567">raw</span><span class="op" id="4994570">,</span>&nbsp;<span class="ident" id="4994572">present</span>&nbsp;<span class="op" id="4994580">:=</span>&nbsp;<span class="ident" id="4994583">header</span><span class="op" id="4994589">[</span><span class="string" id="4994590">&#34;Transfer-Encoding&#34;</span><span class="op" id="4994609">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994612">if</span>&nbsp;<span class="op" id="4994615">!</span><span class="ident" id="4994616">present</span>&nbsp;<span class="op" id="4994624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994628">return</span>&nbsp;<span class="ident" id="4994635">nil</span><span class="op" id="4994638">,</span>&nbsp;<span class="ident" id="4994640">nil</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4994645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4994649">delete</span><span class="op" id="4994655">(</span><span class="ident" id="4994656">header</span><span class="op" id="4994662">,</span>&nbsp;<span class="string" id="4994664">&#34;Transfer-Encoding&#34;</span><span class="op" id="4994683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994687">encodings</span>&nbsp;<span class="op" id="4994697">:=</span>&nbsp;<span class="ident" id="4994700">strings</span><span class="op" id="4994707">.</span><span class="ident" id="4994708">Split</span><span class="op" id="4994713">(</span><span class="ident" id="4994714">raw</span><span class="op" id="4994717">[</span><span class="num" id="4994718">0</span><span class="op" id="4994719">]</span><span class="op" id="4994720">,</span>&nbsp;<span class="string" id="4994722">&#34;,&#34;</span><span class="op" id="4994725">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4994728">te</span>&nbsp;<span class="op" id="4994731">:=</span>&nbsp;<span class="builtinfunc" id="4994734">make</span><span class="op" id="4994738">(</span><span class="op" id="4994739">[</span><span class="op" id="4994740">]</span><span class="builtintype" id="4994741">string</span><span class="op" id="4994747">,</span>&nbsp;<span class="num" id="4994749">0</span><span class="op" id="4994750">,</span>&nbsp;<span class="builtinfunc" id="4994752">len</span><span class="op" id="4994755">(</span><span class="ident" id="4994756">encodings</span><span class="op" id="4994765">)</span><span class="op" id="4994766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4994769">//&nbsp;TODO:&nbsp;Even&nbsp;though&nbsp;we&nbsp;only&nbsp;support&nbsp;&#34;identity&#34;&nbsp;and&nbsp;&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4994832">//&nbsp;encodings,&nbsp;the&nbsp;loop&nbsp;below&nbsp;is&nbsp;designed&nbsp;with&nbsp;foresight.&nbsp;One</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4994894">//&nbsp;invariant&nbsp;that&nbsp;must&nbsp;be&nbsp;maintained&nbsp;is&nbsp;that,&nbsp;if&nbsp;present,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4994953">//&nbsp;chunked&nbsp;encoding&nbsp;must&nbsp;always&nbsp;come&nbsp;first.</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4994998">for</span>&nbsp;<span class="ident" id="4995002">_</span><span class="op" id="4995003">,</span>&nbsp;<span class="ident" id="4995005">encoding</span>&nbsp;<span class="op" id="4995014">:=</span>&nbsp;<span class="keyword" id="4995017">range</span>&nbsp;<span class="ident" id="4995023">encodings</span>&nbsp;<span class="op" id="4995033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995037">encoding</span>&nbsp;<span class="op" id="4995046">=</span>&nbsp;<span class="ident" id="4995048">strings</span><span class="op" id="4995055">.</span><span class="ident" id="4995056">ToLower</span><span class="op" id="4995063">(</span><span class="ident" id="4995064">strings</span><span class="op" id="4995071">.</span><span class="ident" id="4995072">TrimSpace</span><span class="op" id="4995081">(</span><span class="ident" id="4995082">encoding</span><span class="op" id="4995090">)</span><span class="op" id="4995091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995095">//&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;not&nbsp;recorded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995136">if</span>&nbsp;<span class="ident" id="4995139">encoding</span>&nbsp;<span class="op" id="4995148">==</span>&nbsp;<span class="string" id="4995151">&#34;identity&#34;</span>&nbsp;<span class="op" id="4995162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995167">break</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995179">if</span>&nbsp;<span class="ident" id="4995182">encoding</span>&nbsp;<span class="op" id="4995191">!=</span>&nbsp;<span class="string" id="4995194">&#34;chunked&#34;</span>&nbsp;<span class="op" id="4995204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995209">return</span>&nbsp;<span class="ident" id="4995216">nil</span><span class="op" id="4995219">,</span>&nbsp;<span class="op" id="4995221">&amp;</span><span class="ident" id="4995222">badStringError</span><span class="op" id="4995236">{</span><span class="string" id="4995237">&#34;unsupported&nbsp;transfer&nbsp;encoding&#34;</span><span class="op" id="4995268">,</span>&nbsp;<span class="ident" id="4995270">encoding</span><span class="op" id="4995278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995286">te</span>&nbsp;<span class="op" id="4995289">=</span>&nbsp;<span class="ident" id="4995291">te</span><span class="op" id="4995293">[</span><span class="num" id="4995294">0</span>&nbsp;<span class="op" id="4995296">:</span>&nbsp;<span class="builtinfunc" id="4995298">len</span><span class="op" id="4995301">(</span><span class="ident" id="4995302">te</span><span class="op" id="4995304">)</span><span class="op" id="4995305">+</span><span class="num" id="4995306">1</span><span class="op" id="4995307">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4995311">te</span><span class="op" id="4995313">[</span><span class="builtinfunc" id="4995314">len</span><span class="op" id="4995317">(</span><span class="ident" id="4995318">te</span><span class="op" id="4995320">)</span><span class="op" id="4995321">-</span><span class="num" id="4995322">1</span><span class="op" id="4995323">]</span>&nbsp;<span class="op" id="4995325">=</span>&nbsp;<span class="ident" id="4995327">encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995340">if</span>&nbsp;<span class="builtinfunc" id="4995343">len</span><span class="op" id="4995346">(</span><span class="ident" id="4995347">te</span><span class="op" id="4995349">)</span>&nbsp;<span class="op" id="4995351">&gt;</span>&nbsp;<span class="num" id="4995353">1</span>&nbsp;<span class="op" id="4995355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995359">return</span>&nbsp;<span class="ident" id="4995366">nil</span><span class="op" id="4995369">,</span>&nbsp;<span class="op" id="4995371">&amp;</span><span class="ident" id="4995372">badStringError</span><span class="op" id="4995386">{</span><span class="string" id="4995387">&#34;too&nbsp;many&nbsp;transfer&nbsp;encodings&#34;</span><span class="op" id="4995416">,</span>&nbsp;<span class="ident" id="4995418">strings</span><span class="op" id="4995425">.</span><span class="ident" id="4995426">Join</span><span class="op" id="4995430">(</span><span class="ident" id="4995431">te</span><span class="op" id="4995433">,</span>&nbsp;<span class="string" id="4995435">&#34;,&#34;</span><span class="op" id="4995438">)</span><span class="op" id="4995439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995442">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995445">if</span>&nbsp;<span class="builtinfunc" id="4995448">len</span><span class="op" id="4995451">(</span><span class="ident" id="4995452">te</span><span class="op" id="4995454">)</span>&nbsp;<span class="op" id="4995456">&gt;</span>&nbsp;<span class="num" id="4995458">0</span>&nbsp;<span class="op" id="4995460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995464">//&nbsp;Chunked&nbsp;encoding&nbsp;trumps&nbsp;Content-Length.&nbsp;See&nbsp;RFC&nbsp;2616</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995522">//&nbsp;Section&nbsp;4.4.&nbsp;Currently&nbsp;len(te)&nbsp;&gt;&nbsp;0&nbsp;implies&nbsp;chunked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995578">//&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4995593">delete</span><span class="op" id="4995599">(</span><span class="ident" id="4995600">header</span><span class="op" id="4995606">,</span>&nbsp;<span class="string" id="4995608">&#34;Content-Length&#34;</span><span class="op" id="4995624">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995628">return</span>&nbsp;<span class="ident" id="4995635">te</span><span class="op" id="4995637">,</span>&nbsp;<span class="ident" id="4995639">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4995644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995648">return</span>&nbsp;<span class="ident" id="4995655">nil</span><span class="op" id="4995658">,</span>&nbsp;<span class="ident" id="4995660">nil</span><br>
<span class="lineno"></span><span class="op" id="4995664">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="4995667">//&nbsp;Determine&nbsp;the&nbsp;expected&nbsp;body&nbsp;length,&nbsp;using&nbsp;RFC&nbsp;2616&nbsp;Section&nbsp;4.4.&nbsp;This</span><br>
<span class="lineno"></span><span class="comment" id="4995739">//&nbsp;function&nbsp;is&nbsp;not&nbsp;a&nbsp;method,&nbsp;because&nbsp;ultimately&nbsp;it&nbsp;should&nbsp;be&nbsp;shared&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4995810">//&nbsp;ReadResponse&nbsp;and&nbsp;ReadRequest.</span><br>
<span class="lineno"></span><span class="keyword" id="4995843">func</span>&nbsp;<span class="ident" id="4995848">fixLength</span><span class="op" id="4995857">(</span><span class="ident" id="4995858">isResponse</span>&nbsp;<span class="builtintype" id="4995869">bool</span><span class="op" id="4995873">,</span>&nbsp;<span class="ident" id="4995875">status</span>&nbsp;<span class="builtintype" id="4995882">int</span><span class="op" id="4995885">,</span>&nbsp;<span class="ident" id="4995887">requestMethod</span>&nbsp;<span class="builtintype" id="4995901">string</span><span class="op" id="4995907">,</span>&nbsp;<span class="ident" id="4995909">header</span>&nbsp;<span class="ident" id="4995916">Header</span><span class="op" id="4995922">,</span>&nbsp;<span class="ident" id="4995924">te</span>&nbsp;<span class="op" id="4995927">[</span><span class="op" id="4995928">]</span><span class="builtintype" id="4995929">string</span><span class="op" id="4995935">)</span>&nbsp;<span class="op" id="4995937">(</span><span class="ident" id="4995938">int64</span><span class="op" id="4995943">,</span>&nbsp;<span class="builtintype" id="4995945">error</span><span class="op" id="4995950">)</span>&nbsp;<span class="op" id="4995952">{</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4995956">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;response&nbsp;type&nbsp;or&nbsp;status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4995999">if</span>&nbsp;<span class="ident" id="4996002">noBodyExpected</span><span class="op" id="4996016">(</span><span class="ident" id="4996017">requestMethod</span><span class="op" id="4996030">)</span>&nbsp;<span class="op" id="4996032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996036">return</span>&nbsp;<span class="num" id="4996043">0</span><span class="op" id="4996044">,</span>&nbsp;<span class="ident" id="4996046">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996051">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996054">if</span>&nbsp;<span class="ident" id="4996057">status</span><span class="op" id="4996063">/</span><span class="num" id="4996064">100</span>&nbsp;<span class="op" id="4996068">==</span>&nbsp;<span class="num" id="4996071">1</span>&nbsp;<span class="op" id="4996073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996077">return</span>&nbsp;<span class="num" id="4996084">0</span><span class="op" id="4996085">,</span>&nbsp;<span class="ident" id="4996087">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996095">switch</span>&nbsp;<span class="ident" id="4996102">status</span>&nbsp;<span class="op" id="4996109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996112">case</span>&nbsp;<span class="num" id="4996117">204</span><span class="op" id="4996120">,</span>&nbsp;<span class="num" id="4996122">304</span><span class="op" id="4996125">:</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996129">return</span>&nbsp;<span class="num" id="4996136">0</span><span class="op" id="4996137">,</span>&nbsp;<span class="ident" id="4996139">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996148">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996185">if</span>&nbsp;<span class="ident" id="4996188">chunked</span><span class="op" id="4996195">(</span><span class="ident" id="4996196">te</span><span class="op" id="4996198">)</span>&nbsp;<span class="op" id="4996200">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996204">return</span>&nbsp;<span class="op" id="4996211">-</span><span class="num" id="4996212">1</span><span class="op" id="4996213">,</span>&nbsp;<span class="ident" id="4996215">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996224">//&nbsp;Logic&nbsp;based&nbsp;on&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996258">cl</span>&nbsp;<span class="op" id="4996261">:=</span>&nbsp;<span class="ident" id="4996264">strings</span><span class="op" id="4996271">.</span><span class="ident" id="4996272">TrimSpace</span><span class="op" id="4996281">(</span><span class="ident" id="4996282">header</span><span class="op" id="4996288">.</span><span class="ident" id="4996289">get</span><span class="op" id="4996292">(</span><span class="string" id="4996293">&#34;Content-Length&#34;</span><span class="op" id="4996309">)</span><span class="op" id="4996310">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996313">if</span>&nbsp;<span class="ident" id="4996316">cl</span>&nbsp;<span class="op" id="4996319">!=</span>&nbsp;<span class="string" id="4996322">&#34;&#34;</span>&nbsp;<span class="op" id="4996325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996329">n</span><span class="op" id="4996330">,</span>&nbsp;<span class="ident" id="4996332">err</span>&nbsp;<span class="op" id="4996336">:=</span>&nbsp;<span class="ident" id="4996339">parseContentLength</span><span class="op" id="4996357">(</span><span class="ident" id="4996358">cl</span><span class="op" id="4996360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996364">if</span>&nbsp;<span class="ident" id="4996367">err</span>&nbsp;<span class="op" id="4996371">!=</span>&nbsp;<span class="ident" id="4996374">nil</span>&nbsp;<span class="op" id="4996378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996383">return</span>&nbsp;<span class="op" id="4996390">-</span><span class="num" id="4996391">1</span><span class="op" id="4996392">,</span>&nbsp;<span class="ident" id="4996394">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996400">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996404">return</span>&nbsp;<span class="ident" id="4996411">n</span><span class="op" id="4996412">,</span>&nbsp;<span class="ident" id="4996414">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996419">}</span>&nbsp;<span class="keyword" id="4996421">else</span>&nbsp;<span class="op" id="4996426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4996430">header</span><span class="op" id="4996436">.</span><span class="ident" id="4996437">Del</span><span class="op" id="4996440">(</span><span class="string" id="4996441">&#34;Content-Length&#34;</span><span class="op" id="4996457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996464">if</span>&nbsp;<span class="op" id="4996467">!</span><span class="ident" id="4996468">isResponse</span>&nbsp;<span class="op" id="4996479">&amp;&amp;</span>&nbsp;<span class="ident" id="4996482">requestMethod</span>&nbsp;<span class="op" id="4996496">==</span>&nbsp;<span class="string" id="4996499">&#34;GET&#34;</span>&nbsp;<span class="op" id="4996505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996509">//&nbsp;RFC&nbsp;2616&nbsp;doesn&#39;t&nbsp;explicitly&nbsp;permit&nbsp;nor&nbsp;forbid&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996563">//&nbsp;entity-body&nbsp;on&nbsp;a&nbsp;GET&nbsp;request&nbsp;so&nbsp;we&nbsp;permit&nbsp;one&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996617">//&nbsp;declared,&nbsp;but&nbsp;we&nbsp;default&nbsp;to&nbsp;0&nbsp;here&nbsp;(not&nbsp;-1&nbsp;below)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996672">//&nbsp;if&nbsp;there&#39;s&nbsp;no&nbsp;mention&nbsp;of&nbsp;a&nbsp;body.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996710">return</span>&nbsp;<span class="num" id="4996717">0</span><span class="op" id="4996718">,</span>&nbsp;<span class="ident" id="4996720">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4996725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4996729">//&nbsp;Body-EOF&nbsp;logic&nbsp;based&nbsp;on&nbsp;other&nbsp;methods&nbsp;(like&nbsp;closing,&nbsp;or&nbsp;chunked&nbsp;coding)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4996805">return</span>&nbsp;<span class="op" id="4996812">-</span><span class="num" id="4996813">1</span><span class="op" id="4996814">,</span>&nbsp;<span class="ident" id="4996816">nil</span><br>
<span class="lineno">500</span><span class="op" id="4996820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4996823">//&nbsp;Determine&nbsp;whether&nbsp;to&nbsp;hang&nbsp;up&nbsp;after&nbsp;sending&nbsp;a&nbsp;request&nbsp;and&nbsp;body,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4996892">//&nbsp;receiving&nbsp;a&nbsp;response&nbsp;and&nbsp;body</span><br>
<span class="lineno"></span><span class="comment" id="4996925">//&nbsp;&#39;header&#39;&nbsp;is&nbsp;the&nbsp;request&nbsp;headers</span><br>
<span class="lineno">505</span><span class="keyword" id="4996960">func</span>&nbsp;<span class="ident" id="4996965">shouldClose</span><span class="op" id="4996976">(</span><span class="ident" id="4996977">major</span><span class="op" id="4996982">,</span>&nbsp;<span class="ident" id="4996984">minor</span>&nbsp;<span class="builtintype" id="4996990">int</span><span class="op" id="4996993">,</span>&nbsp;<span class="ident" id="4996995">header</span>&nbsp;<span class="ident" id="4997002">Header</span><span class="op" id="4997008">,</span>&nbsp;<span class="ident" id="4997010">removeCloseHeader</span>&nbsp;<span class="builtintype" id="4997028">bool</span><span class="op" id="4997032">)</span>&nbsp;<span class="builtintype" id="4997034">bool</span>&nbsp;<span class="op" id="4997039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997042">if</span>&nbsp;<span class="ident" id="4997045">major</span>&nbsp;<span class="op" id="4997051">&lt;</span>&nbsp;<span class="num" id="4997053">1</span>&nbsp;<span class="op" id="4997055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997059">return</span>&nbsp;<span class="builtintype" id="4997066">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997072">}</span>&nbsp;<span class="keyword" id="4997074">else</span>&nbsp;<span class="keyword" id="4997079">if</span>&nbsp;<span class="ident" id="4997082">major</span>&nbsp;<span class="op" id="4997088">==</span>&nbsp;<span class="num" id="4997091">1</span>&nbsp;<span class="op" id="4997093">&amp;&amp;</span>&nbsp;<span class="ident" id="4997096">minor</span>&nbsp;<span class="op" id="4997102">==</span>&nbsp;<span class="num" id="4997105">0</span>&nbsp;<span class="op" id="4997107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997111">if</span>&nbsp;<span class="op" id="4997114">!</span><span class="ident" id="4997115">strings</span><span class="op" id="4997122">.</span><span class="ident" id="4997123">Contains</span><span class="op" id="4997131">(</span><span class="ident" id="4997132">strings</span><span class="op" id="4997139">.</span><span class="ident" id="4997140">ToLower</span><span class="op" id="4997147">(</span><span class="ident" id="4997148">header</span><span class="op" id="4997154">.</span><span class="ident" id="4997155">get</span><span class="op" id="4997158">(</span><span class="string" id="4997159">&#34;Connection&#34;</span><span class="op" id="4997171">)</span><span class="op" id="4997172">)</span><span class="op" id="4997173">,</span>&nbsp;<span class="string" id="4997175">&#34;keep-alive&#34;</span><span class="op" id="4997187">)</span>&nbsp;<span class="op" id="4997189">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997194">return</span>&nbsp;<span class="builtintype" id="4997201">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997212">return</span>&nbsp;<span class="builtintype" id="4997219">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997226">}</span>&nbsp;<span class="keyword" id="4997228">else</span>&nbsp;<span class="op" id="4997233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997237">//&nbsp;TODO:&nbsp;Should&nbsp;split&nbsp;on&nbsp;commas,&nbsp;toss&nbsp;surrounding&nbsp;white&nbsp;space,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4997302">//&nbsp;and&nbsp;check&nbsp;each&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997329">if</span>&nbsp;<span class="ident" id="4997332">strings</span><span class="op" id="4997339">.</span><span class="ident" id="4997340">ToLower</span><span class="op" id="4997347">(</span><span class="ident" id="4997348">header</span><span class="op" id="4997354">.</span><span class="ident" id="4997355">get</span><span class="op" id="4997358">(</span><span class="string" id="4997359">&#34;Connection&#34;</span><span class="op" id="4997371">)</span><span class="op" id="4997372">)</span>&nbsp;<span class="op" id="4997374">==</span>&nbsp;<span class="string" id="4997377">&#34;close&#34;</span>&nbsp;<span class="op" id="4997385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997390">if</span>&nbsp;<span class="ident" id="4997393">removeCloseHeader</span>&nbsp;<span class="op" id="4997411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997417">header</span><span class="op" id="4997423">.</span><span class="ident" id="4997424">Del</span><span class="op" id="4997427">(</span><span class="string" id="4997428">&#34;Connection&#34;</span><span class="op" id="4997440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997445">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997450">return</span>&nbsp;<span class="builtintype" id="4997457">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997470">return</span>&nbsp;<span class="builtintype" id="4997477">false</span><br>
<span class="lineno"></span><span class="op" id="4997483">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="comment" id="4997486">//&nbsp;Parse&nbsp;the&nbsp;trailer&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="4997514">func</span>&nbsp;<span class="ident" id="4997519">fixTrailer</span><span class="op" id="4997529">(</span><span class="ident" id="4997530">header</span>&nbsp;<span class="ident" id="4997537">Header</span><span class="op" id="4997543">,</span>&nbsp;<span class="ident" id="4997545">te</span>&nbsp;<span class="op" id="4997548">[</span><span class="op" id="4997549">]</span><span class="builtintype" id="4997550">string</span><span class="op" id="4997556">)</span>&nbsp;<span class="op" id="4997558">(</span><span class="ident" id="4997559">Header</span><span class="op" id="4997565">,</span>&nbsp;<span class="builtintype" id="4997567">error</span><span class="op" id="4997572">)</span>&nbsp;<span class="op" id="4997574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997577">raw</span>&nbsp;<span class="op" id="4997581">:=</span>&nbsp;<span class="ident" id="4997584">header</span><span class="op" id="4997590">.</span><span class="ident" id="4997591">get</span><span class="op" id="4997594">(</span><span class="string" id="4997595">&#34;Trailer&#34;</span><span class="op" id="4997604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997607">if</span>&nbsp;<span class="ident" id="4997610">raw</span>&nbsp;<span class="op" id="4997614">==</span>&nbsp;<span class="string" id="4997617">&#34;&#34;</span>&nbsp;<span class="op" id="4997620">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997624">return</span>&nbsp;<span class="ident" id="4997631">nil</span><span class="op" id="4997634">,</span>&nbsp;<span class="ident" id="4997636">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997645">header</span><span class="op" id="4997651">.</span><span class="ident" id="4997652">Del</span><span class="op" id="4997655">(</span><span class="string" id="4997656">&#34;Trailer&#34;</span><span class="op" id="4997665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997668">trailer</span>&nbsp;<span class="op" id="4997676">:=</span>&nbsp;<span class="builtinfunc" id="4997679">make</span><span class="op" id="4997683">(</span><span class="ident" id="4997684">Header</span><span class="op" id="4997690">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997693">keys</span>&nbsp;<span class="op" id="4997698">:=</span>&nbsp;<span class="ident" id="4997701">strings</span><span class="op" id="4997708">.</span><span class="ident" id="4997709">Split</span><span class="op" id="4997714">(</span><span class="ident" id="4997715">raw</span><span class="op" id="4997718">,</span>&nbsp;<span class="string" id="4997720">&#34;,&#34;</span><span class="op" id="4997723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997726">for</span>&nbsp;<span class="ident" id="4997730">_</span><span class="op" id="4997731">,</span>&nbsp;<span class="ident" id="4997733">key</span>&nbsp;<span class="op" id="4997737">:=</span>&nbsp;<span class="keyword" id="4997740">range</span>&nbsp;<span class="ident" id="4997746">keys</span>&nbsp;<span class="op" id="4997751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997755">key</span>&nbsp;<span class="op" id="4997759">=</span>&nbsp;<span class="ident" id="4997761">CanonicalHeaderKey</span><span class="op" id="4997779">(</span><span class="ident" id="4997780">strings</span><span class="op" id="4997787">.</span><span class="ident" id="4997788">TrimSpace</span><span class="op" id="4997797">(</span><span class="ident" id="4997798">key</span><span class="op" id="4997801">)</span><span class="op" id="4997802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997806">switch</span>&nbsp;<span class="ident" id="4997813">key</span>&nbsp;<span class="op" id="4997817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997821">case</span>&nbsp;<span class="string" id="4997826">&#34;Transfer-Encoding&#34;</span><span class="op" id="4997845">,</span>&nbsp;<span class="string" id="4997847">&#34;Trailer&#34;</span><span class="op" id="4997856">,</span>&nbsp;<span class="string" id="4997858">&#34;Content-Length&#34;</span><span class="op" id="4997874">:</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997879">return</span>&nbsp;<span class="ident" id="4997886">nil</span><span class="op" id="4997889">,</span>&nbsp;<span class="op" id="4997891">&amp;</span><span class="ident" id="4997892">badStringError</span><span class="op" id="4997906">{</span><span class="string" id="4997907">&#34;bad&nbsp;trailer&nbsp;key&#34;</span><span class="op" id="4997924">,</span>&nbsp;<span class="ident" id="4997926">key</span><span class="op" id="4997929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4997937">trailer</span><span class="op" id="4997944">[</span><span class="ident" id="4997945">key</span><span class="op" id="4997948">]</span>&nbsp;<span class="op" id="4997950">=</span>&nbsp;<span class="ident" id="4997952">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4997957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997960">if</span>&nbsp;<span class="builtinfunc" id="4997963">len</span><span class="op" id="4997966">(</span><span class="ident" id="4997967">trailer</span><span class="op" id="4997974">)</span>&nbsp;<span class="op" id="4997976">==</span>&nbsp;<span class="num" id="4997979">0</span>&nbsp;<span class="op" id="4997981">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4997985">return</span>&nbsp;<span class="ident" id="4997992">nil</span><span class="op" id="4997995">,</span>&nbsp;<span class="ident" id="4997997">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998005">if</span>&nbsp;<span class="op" id="4998008">!</span><span class="ident" id="4998009">chunked</span><span class="op" id="4998016">(</span><span class="ident" id="4998017">te</span><span class="op" id="4998019">)</span>&nbsp;<span class="op" id="4998021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4998025">//&nbsp;Trailer&nbsp;and&nbsp;no&nbsp;chunking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998054">return</span>&nbsp;<span class="ident" id="4998061">nil</span><span class="op" id="4998064">,</span>&nbsp;<span class="ident" id="4998066">ErrUnexpectedTrailer</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4998088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998091">return</span>&nbsp;<span class="ident" id="4998098">trailer</span><span class="op" id="4998105">,</span>&nbsp;<span class="ident" id="4998107">nil</span><br>
<span class="lineno"></span><span class="op" id="4998111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4998114">//&nbsp;body&nbsp;turns&nbsp;a&nbsp;Reader&nbsp;into&nbsp;a&nbsp;ReadCloser.</span><br>
<span class="lineno">555</span><span class="comment" id="4998156">//&nbsp;Close&nbsp;ensures&nbsp;that&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;fully&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="4998207">//&nbsp;and&nbsp;then&nbsp;reads&nbsp;the&nbsp;trailer&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4998251">type</span>&nbsp;<span class="ident" id="4998256">body</span>&nbsp;<span class="keyword" id="4998261">struct</span>&nbsp;<span class="op" id="4998268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998271">src</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998279">io</span><span class="op" id="4998281">.</span><span class="ident" id="4998282">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998290">hdr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4998298">interface</span><span class="op" id="4998307">{</span><span class="op" id="4998308">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4998312">//&nbsp;non-nil&nbsp;(Response&nbsp;or&nbsp;Request)&nbsp;value&nbsp;means&nbsp;read&nbsp;trailer</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998371">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4998379">*</span><span class="ident" id="4998380">bufio</span><span class="op" id="4998385">.</span><span class="ident" id="4998386">Reader</span>&nbsp;<span class="comment" id="4998393">//&nbsp;underlying&nbsp;wire-format&nbsp;reader&nbsp;for&nbsp;the&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998443">closing</span>&nbsp;<span class="builtintype" id="4998451">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4998465">//&nbsp;is&nbsp;the&nbsp;connection&nbsp;to&nbsp;be&nbsp;closed&nbsp;after&nbsp;reading&nbsp;body?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998521">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4998528">sync</span><span class="op" id="4998532">.</span><span class="ident" id="4998533">Mutex</span>&nbsp;<span class="comment" id="4998539">//&nbsp;guards&nbsp;closed,&nbsp;and&nbsp;calls&nbsp;to&nbsp;Read&nbsp;and&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998586">closed</span>&nbsp;<span class="builtintype" id="4998593">bool</span><br>
<span class="lineno">565</span><span class="op" id="4998598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4998601">//&nbsp;ErrBodyReadAfterClose&nbsp;is&nbsp;returned&nbsp;when&nbsp;reading&nbsp;a&nbsp;Request&nbsp;or&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="4998673">//&nbsp;Body&nbsp;after&nbsp;the&nbsp;body&nbsp;has&nbsp;been&nbsp;closed.&nbsp;This&nbsp;typically&nbsp;happens&nbsp;when&nbsp;the&nbsp;body&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4998753">//&nbsp;read&nbsp;after&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;calls&nbsp;WriteHeader&nbsp;or&nbsp;Write&nbsp;on&nbsp;its</span><br>
<span class="lineno">570</span><span class="comment" id="4998817">//&nbsp;ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4998836">var</span>&nbsp;<span class="ident" id="4998840">ErrBodyReadAfterClose</span>&nbsp;<span class="op" id="4998862">=</span>&nbsp;<span class="ident" id="4998864">errors</span><span class="op" id="4998870">.</span><span class="ident" id="4998871">New</span><span class="op" id="4998874">(</span><span class="string" id="4998875">&#34;http:&nbsp;invalid&nbsp;Read&nbsp;on&nbsp;closed&nbsp;Body&#34;</span><span class="op" id="4998910">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4998913">func</span>&nbsp;<span class="op" id="4998918">(</span><span class="ident" id="4998919">b</span>&nbsp;<span class="op" id="4998921">*</span><span class="ident" id="4998922">body</span><span class="op" id="4998926">)</span>&nbsp;<span class="ident" id="4998928">Read</span><span class="op" id="4998932">(</span><span class="ident" id="4998933">p</span>&nbsp;<span class="op" id="4998935">[</span><span class="op" id="4998936">]</span><span class="builtintype" id="4998937">byte</span><span class="op" id="4998941">)</span>&nbsp;<span class="op" id="4998943">(</span><span class="ident" id="4998944">n</span>&nbsp;<span class="builtintype" id="4998946">int</span><span class="op" id="4998949">,</span>&nbsp;<span class="ident" id="4998951">err</span>&nbsp;<span class="builtintype" id="4998955">error</span><span class="op" id="4998960">)</span>&nbsp;<span class="op" id="4998962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4998965">b</span><span class="op" id="4998966">.</span><span class="ident" id="4998967">mu</span><span class="op" id="4998969">.</span><span class="ident" id="4998970">Lock</span><span class="op" id="4998974">(</span><span class="op" id="4998975">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998978">defer</span>&nbsp;<span class="ident" id="4998984">b</span><span class="op" id="4998985">.</span><span class="ident" id="4998986">mu</span><span class="op" id="4998988">.</span><span class="ident" id="4998989">Unlock</span><span class="op" id="4998995">(</span><span class="op" id="4998996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4998999">if</span>&nbsp;<span class="ident" id="4999002">b</span><span class="op" id="4999003">.</span><span class="ident" id="4999004">closed</span>&nbsp;<span class="op" id="4999011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999015">return</span>&nbsp;<span class="num" id="4999022">0</span><span class="op" id="4999023">,</span>&nbsp;<span class="ident" id="4999025">ErrBodyReadAfterClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999051">return</span>&nbsp;<span class="ident" id="4999058">b</span><span class="op" id="4999059">.</span><span class="ident" id="4999060">readLocked</span><span class="op" id="4999070">(</span><span class="ident" id="4999071">p</span><span class="op" id="4999072">)</span><br>
<span class="lineno">580</span><span class="op" id="4999074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4999077">//&nbsp;Must&nbsp;hold&nbsp;b.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="4999096">func</span>&nbsp;<span class="op" id="4999101">(</span><span class="ident" id="4999102">b</span>&nbsp;<span class="op" id="4999104">*</span><span class="ident" id="4999105">body</span><span class="op" id="4999109">)</span>&nbsp;<span class="ident" id="4999111">readLocked</span><span class="op" id="4999121">(</span><span class="ident" id="4999122">p</span>&nbsp;<span class="op" id="4999124">[</span><span class="op" id="4999125">]</span><span class="builtintype" id="4999126">byte</span><span class="op" id="4999130">)</span>&nbsp;<span class="op" id="4999132">(</span><span class="ident" id="4999133">n</span>&nbsp;<span class="builtintype" id="4999135">int</span><span class="op" id="4999138">,</span>&nbsp;<span class="ident" id="4999140">err</span>&nbsp;<span class="builtintype" id="4999144">error</span><span class="op" id="4999149">)</span>&nbsp;<span class="op" id="4999151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999154">n</span><span class="op" id="4999155">,</span>&nbsp;<span class="ident" id="4999157">err</span>&nbsp;<span class="op" id="4999161">=</span>&nbsp;<span class="ident" id="4999163">b</span><span class="op" id="4999164">.</span><span class="ident" id="4999165">src</span><span class="op" id="4999168">.</span><span class="ident" id="4999169">Read</span><span class="op" id="4999173">(</span><span class="ident" id="4999174">p</span><span class="op" id="4999175">)</span><br>
<span class="lineno">585</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999179">if</span>&nbsp;<span class="ident" id="4999182">err</span>&nbsp;<span class="op" id="4999186">==</span>&nbsp;<span class="ident" id="4999189">io</span><span class="op" id="4999191">.</span><span class="ident" id="4999192">EOF</span>&nbsp;<span class="op" id="4999196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999200">//&nbsp;Chunked&nbsp;case.&nbsp;Read&nbsp;the&nbsp;trailer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999237">if</span>&nbsp;<span class="ident" id="4999240">b</span><span class="op" id="4999241">.</span><span class="ident" id="4999242">hdr</span>&nbsp;<span class="op" id="4999246">!=</span>&nbsp;<span class="ident" id="4999249">nil</span>&nbsp;<span class="op" id="4999253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999258">if</span>&nbsp;<span class="ident" id="4999261">e</span>&nbsp;<span class="op" id="4999263">:=</span>&nbsp;<span class="ident" id="4999266">b</span><span class="op" id="4999267">.</span><span class="ident" id="4999268">readTrailer</span><span class="op" id="4999279">(</span><span class="op" id="4999280">)</span><span class="op" id="4999281">;</span>&nbsp;<span class="ident" id="4999283">e</span>&nbsp;<span class="op" id="4999285">!=</span>&nbsp;<span class="ident" id="4999288">nil</span>&nbsp;<span class="op" id="4999292">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999298">err</span>&nbsp;<span class="op" id="4999302">=</span>&nbsp;<span class="ident" id="4999304">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999314">b</span><span class="op" id="4999315">.</span><span class="ident" id="4999316">hdr</span>&nbsp;<span class="op" id="4999320">=</span>&nbsp;<span class="ident" id="4999322">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999328">}</span>&nbsp;<span class="keyword" id="4999330">else</span>&nbsp;<span class="op" id="4999335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999340">//&nbsp;If&nbsp;the&nbsp;server&nbsp;declared&nbsp;the&nbsp;Content-Length,&nbsp;our&nbsp;body&nbsp;is&nbsp;a&nbsp;LimitedReader</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999417">//&nbsp;and&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;whether&nbsp;this&nbsp;EOF&nbsp;arrived&nbsp;early.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999476">if</span>&nbsp;<span class="ident" id="4999479">lr</span><span class="op" id="4999481">,</span>&nbsp;<span class="ident" id="4999483">ok</span>&nbsp;<span class="op" id="4999486">:=</span>&nbsp;<span class="ident" id="4999489">b</span><span class="op" id="4999490">.</span><span class="ident" id="4999491">src</span><span class="op" id="4999494">.</span><span class="op" id="4999495">(</span><span class="op" id="4999496">*</span><span class="ident" id="4999497">io</span><span class="op" id="4999499">.</span><span class="ident" id="4999500">LimitedReader</span><span class="op" id="4999513">)</span><span class="op" id="4999514">;</span>&nbsp;<span class="ident" id="4999516">ok</span>&nbsp;<span class="op" id="4999519">&amp;&amp;</span>&nbsp;<span class="ident" id="4999522">lr</span><span class="op" id="4999524">.</span><span class="ident" id="4999525">N</span>&nbsp;<span class="op" id="4999527">&gt;</span>&nbsp;<span class="num" id="4999529">0</span>&nbsp;<span class="op" id="4999531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999537">err</span>&nbsp;<span class="op" id="4999541">=</span>&nbsp;<span class="ident" id="4999543">io</span><span class="op" id="4999545">.</span><span class="ident" id="4999546">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999570">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999577">//&nbsp;If&nbsp;we&nbsp;can&nbsp;return&nbsp;an&nbsp;EOF&nbsp;here&nbsp;along&nbsp;with&nbsp;the&nbsp;read&nbsp;data,&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999639">//&nbsp;so.&nbsp;This&nbsp;is&nbsp;optional&nbsp;per&nbsp;the&nbsp;io.Reader&nbsp;contract,&nbsp;but&nbsp;doing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999702">//&nbsp;so&nbsp;helps&nbsp;the&nbsp;HTTP&nbsp;transport&nbsp;code&nbsp;recycle&nbsp;its&nbsp;connection</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999762">//&nbsp;earlier&nbsp;(since&nbsp;it&nbsp;will&nbsp;see&nbsp;this&nbsp;EOF&nbsp;itself),&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4999823">//&nbsp;client&nbsp;doesn&#39;t&nbsp;do&nbsp;future&nbsp;reads&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999868">if</span>&nbsp;<span class="ident" id="4999871">err</span>&nbsp;<span class="op" id="4999875">==</span>&nbsp;<span class="ident" id="4999878">nil</span>&nbsp;<span class="op" id="4999882">&amp;&amp;</span>&nbsp;<span class="ident" id="4999885">n</span>&nbsp;<span class="op" id="4999887">&gt;</span>&nbsp;<span class="num" id="4999889">0</span>&nbsp;<span class="op" id="4999891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999895">if</span>&nbsp;<span class="ident" id="4999898">lr</span><span class="op" id="4999900">,</span>&nbsp;<span class="ident" id="4999902">ok</span>&nbsp;<span class="op" id="4999905">:=</span>&nbsp;<span class="ident" id="4999908">b</span><span class="op" id="4999909">.</span><span class="ident" id="4999910">src</span><span class="op" id="4999913">.</span><span class="op" id="4999914">(</span><span class="op" id="4999915">*</span><span class="ident" id="4999916">io</span><span class="op" id="4999918">.</span><span class="ident" id="4999919">LimitedReader</span><span class="op" id="4999932">)</span><span class="op" id="4999933">;</span>&nbsp;<span class="ident" id="4999935">ok</span>&nbsp;<span class="op" id="4999938">&amp;&amp;</span>&nbsp;<span class="ident" id="4999941">lr</span><span class="op" id="4999943">.</span><span class="ident" id="4999944">N</span>&nbsp;<span class="op" id="4999946">==</span>&nbsp;<span class="num" id="4999949">0</span>&nbsp;<span class="op" id="4999951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4999956">err</span>&nbsp;<span class="op" id="4999960">=</span>&nbsp;<span class="ident" id="4999962">io</span><span class="op" id="4999964">.</span><span class="ident" id="4999965">EOF</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4999974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4999978">return</span>&nbsp;<span class="ident" id="4999985">n</span><span class="op" id="4999986">,</span>&nbsp;<span class="ident" id="4999988">err</span><br>
<span class="lineno"></span><span class="op" id="4999992">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="keyword" id="4999995">var</span>&nbsp;<span class="op" id="4999999">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000002">singleCRLF</span>&nbsp;<span class="op" id="5000013">=</span>&nbsp;<span class="op" id="5000015">[</span><span class="op" id="5000016">]</span><span class="builtintype" id="5000017">byte</span><span class="op" id="5000021">(</span><span class="string" id="5000022">&#34;\r\n&#34;</span><span class="op" id="5000028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000031">doubleCRLF</span>&nbsp;<span class="op" id="5000042">=</span>&nbsp;<span class="op" id="5000044">[</span><span class="op" id="5000045">]</span><span class="builtintype" id="5000046">byte</span><span class="op" id="5000050">(</span><span class="string" id="5000051">&#34;\r\n\r\n&#34;</span><span class="op" id="5000061">)</span><br>
<span class="lineno"></span><span class="op" id="5000063">)</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="5000066">func</span>&nbsp;<span class="ident" id="5000071">seeUpcomingDoubleCRLF</span><span class="op" id="5000092">(</span><span class="ident" id="5000093">r</span>&nbsp;<span class="op" id="5000095">*</span><span class="ident" id="5000096">bufio</span><span class="op" id="5000101">.</span><span class="ident" id="5000102">Reader</span><span class="op" id="5000108">)</span>&nbsp;<span class="builtintype" id="5000110">bool</span>&nbsp;<span class="op" id="5000115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000118">for</span>&nbsp;<span class="ident" id="5000122">peekSize</span>&nbsp;<span class="op" id="5000131">:=</span>&nbsp;<span class="num" id="5000134">4</span><span class="op" id="5000135">;</span>&nbsp;<span class="op" id="5000137">;</span>&nbsp;<span class="ident" id="5000139">peekSize</span><span class="op" id="5000147">++</span>&nbsp;<span class="op" id="5000150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000154">//&nbsp;This&nbsp;loop&nbsp;stops&nbsp;when&nbsp;Peek&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000203">//&nbsp;which&nbsp;it&nbsp;does&nbsp;when&nbsp;r&#39;s&nbsp;buffer&nbsp;has&nbsp;been&nbsp;filled.</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000255">buf</span><span class="op" id="5000258">,</span>&nbsp;<span class="ident" id="5000260">err</span>&nbsp;<span class="op" id="5000264">:=</span>&nbsp;<span class="ident" id="5000267">r</span><span class="op" id="5000268">.</span><span class="ident" id="5000269">Peek</span><span class="op" id="5000273">(</span><span class="ident" id="5000274">peekSize</span><span class="op" id="5000282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000286">if</span>&nbsp;<span class="ident" id="5000289">bytes</span><span class="op" id="5000294">.</span><span class="ident" id="5000295">HasSuffix</span><span class="op" id="5000304">(</span><span class="ident" id="5000305">buf</span><span class="op" id="5000308">,</span>&nbsp;<span class="ident" id="5000310">doubleCRLF</span><span class="op" id="5000320">)</span>&nbsp;<span class="op" id="5000322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000327">return</span>&nbsp;<span class="builtintype" id="5000334">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000345">if</span>&nbsp;<span class="ident" id="5000348">err</span>&nbsp;<span class="op" id="5000352">!=</span>&nbsp;<span class="ident" id="5000355">nil</span>&nbsp;<span class="op" id="5000359">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000364">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000378">return</span>&nbsp;<span class="builtintype" id="5000385">false</span><br>
<span class="lineno"></span><span class="op" id="5000391">}</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span><span class="keyword" id="5000394">var</span>&nbsp;<span class="ident" id="5000398">errTrailerEOF</span>&nbsp;<span class="op" id="5000412">=</span>&nbsp;<span class="ident" id="5000414">errors</span><span class="op" id="5000420">.</span><span class="ident" id="5000421">New</span><span class="op" id="5000424">(</span><span class="string" id="5000425">&#34;http:&nbsp;unexpected&nbsp;EOF&nbsp;reading&nbsp;trailer&#34;</span><span class="op" id="5000463">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5000466">func</span>&nbsp;<span class="op" id="5000471">(</span><span class="ident" id="5000472">b</span>&nbsp;<span class="op" id="5000474">*</span><span class="ident" id="5000475">body</span><span class="op" id="5000479">)</span>&nbsp;<span class="ident" id="5000481">readTrailer</span><span class="op" id="5000492">(</span><span class="op" id="5000493">)</span>&nbsp;<span class="builtintype" id="5000495">error</span>&nbsp;<span class="op" id="5000501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000504">//&nbsp;The&nbsp;common&nbsp;case,&nbsp;since&nbsp;nobody&nbsp;uses&nbsp;trailers.</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000553">buf</span><span class="op" id="5000556">,</span>&nbsp;<span class="ident" id="5000558">err</span>&nbsp;<span class="op" id="5000562">:=</span>&nbsp;<span class="ident" id="5000565">b</span><span class="op" id="5000566">.</span><span class="ident" id="5000567">r</span><span class="op" id="5000568">.</span><span class="ident" id="5000569">Peek</span><span class="op" id="5000573">(</span><span class="num" id="5000574">2</span><span class="op" id="5000575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000578">if</span>&nbsp;<span class="ident" id="5000581">bytes</span><span class="op" id="5000586">.</span><span class="ident" id="5000587">Equal</span><span class="op" id="5000592">(</span><span class="ident" id="5000593">buf</span><span class="op" id="5000596">,</span>&nbsp;<span class="ident" id="5000598">singleCRLF</span><span class="op" id="5000608">)</span>&nbsp;<span class="op" id="5000610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000614">b</span><span class="op" id="5000615">.</span><span class="ident" id="5000616">r</span><span class="op" id="5000617">.</span><span class="ident" id="5000618">ReadByte</span><span class="op" id="5000626">(</span><span class="op" id="5000627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5000631">b</span><span class="op" id="5000632">.</span><span class="ident" id="5000633">r</span><span class="op" id="5000634">.</span><span class="ident" id="5000635">ReadByte</span><span class="op" id="5000643">(</span><span class="op" id="5000644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000648">return</span>&nbsp;<span class="ident" id="5000655">nil</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000663">if</span>&nbsp;<span class="builtinfunc" id="5000666">len</span><span class="op" id="5000669">(</span><span class="ident" id="5000670">buf</span><span class="op" id="5000673">)</span>&nbsp;<span class="op" id="5000675">&lt;</span>&nbsp;<span class="num" id="5000677">2</span>&nbsp;<span class="op" id="5000679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000683">return</span>&nbsp;<span class="ident" id="5000690">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000708">if</span>&nbsp;<span class="ident" id="5000711">err</span>&nbsp;<span class="op" id="5000715">!=</span>&nbsp;<span class="ident" id="5000718">nil</span>&nbsp;<span class="op" id="5000722">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5000726">return</span>&nbsp;<span class="ident" id="5000733">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5000738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000742">//&nbsp;Make&nbsp;sure&nbsp;there&#39;s&nbsp;a&nbsp;header&nbsp;terminator&nbsp;coming&nbsp;up,&nbsp;to&nbsp;prevent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000806">//&nbsp;a&nbsp;DoS&nbsp;with&nbsp;an&nbsp;unbounded&nbsp;size&nbsp;Trailer.&nbsp;&nbsp;It&#39;s&nbsp;not&nbsp;easy&nbsp;to</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000866">//&nbsp;slip&nbsp;in&nbsp;a&nbsp;LimitReader&nbsp;here,&nbsp;as&nbsp;textproto.NewReader&nbsp;requires</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000930">//&nbsp;a&nbsp;concrete&nbsp;*bufio.Reader.&nbsp;&nbsp;Also,&nbsp;we&nbsp;can&#39;t&nbsp;get&nbsp;all&nbsp;the&nbsp;way</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5000992">//&nbsp;back&nbsp;up&nbsp;to&nbsp;our&nbsp;conn&#39;s&nbsp;LimitedReader&nbsp;that&nbsp;*might*&nbsp;be&nbsp;backing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001056">//&nbsp;this&nbsp;bufio.Reader.&nbsp;&nbsp;Instead,&nbsp;a&nbsp;hack:&nbsp;we&nbsp;iteratively&nbsp;Peek&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001120">//&nbsp;to&nbsp;the&nbsp;bufio.Reader&#39;s&nbsp;max&nbsp;size,&nbsp;looking&nbsp;for&nbsp;a&nbsp;double&nbsp;CRLF.</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001183">//&nbsp;This&nbsp;limits&nbsp;the&nbsp;trailer&nbsp;to&nbsp;the&nbsp;underlying&nbsp;buffer&nbsp;size,&nbsp;typically&nbsp;4kB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001257">if</span>&nbsp;<span class="op" id="5001260">!</span><span class="ident" id="5001261">seeUpcomingDoubleCRLF</span><span class="op" id="5001282">(</span><span class="ident" id="5001283">b</span><span class="op" id="5001284">.</span><span class="ident" id="5001285">r</span><span class="op" id="5001286">)</span>&nbsp;<span class="op" id="5001288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001292">return</span>&nbsp;<span class="ident" id="5001299">errors</span><span class="op" id="5001305">.</span><span class="ident" id="5001306">New</span><span class="op" id="5001309">(</span><span class="string" id="5001310">&#34;http:&nbsp;suspiciously&nbsp;long&nbsp;trailer&nbsp;after&nbsp;chunked&nbsp;body&#34;</span><span class="op" id="5001362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001369">hdr</span><span class="op" id="5001372">,</span>&nbsp;<span class="ident" id="5001374">err</span>&nbsp;<span class="op" id="5001378">:=</span>&nbsp;<span class="ident" id="5001381">textproto</span><span class="op" id="5001390">.</span><span class="ident" id="5001391">NewReader</span><span class="op" id="5001400">(</span><span class="ident" id="5001401">b</span><span class="op" id="5001402">.</span><span class="ident" id="5001403">r</span><span class="op" id="5001404">)</span><span class="op" id="5001405">.</span><span class="ident" id="5001406">ReadMIMEHeader</span><span class="op" id="5001420">(</span><span class="op" id="5001421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001424">if</span>&nbsp;<span class="ident" id="5001427">err</span>&nbsp;<span class="op" id="5001431">!=</span>&nbsp;<span class="ident" id="5001434">nil</span>&nbsp;<span class="op" id="5001438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001442">if</span>&nbsp;<span class="ident" id="5001445">err</span>&nbsp;<span class="op" id="5001449">==</span>&nbsp;<span class="ident" id="5001452">io</span><span class="op" id="5001454">.</span><span class="ident" id="5001455">EOF</span>&nbsp;<span class="op" id="5001459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001464">return</span>&nbsp;<span class="ident" id="5001471">errTrailerEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001487">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001491">return</span>&nbsp;<span class="ident" id="5001498">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001506">switch</span>&nbsp;<span class="ident" id="5001513">rr</span>&nbsp;<span class="op" id="5001516">:=</span>&nbsp;<span class="ident" id="5001519">b</span><span class="op" id="5001520">.</span><span class="ident" id="5001521">hdr</span><span class="op" id="5001524">.</span><span class="op" id="5001525">(</span><span class="keyword" id="5001526">type</span><span class="op" id="5001530">)</span>&nbsp;<span class="op" id="5001532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001535">case</span>&nbsp;<span class="op" id="5001540">*</span><span class="ident" id="5001541">Request</span><span class="op" id="5001548">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001552">mergeSetHeader</span><span class="op" id="5001566">(</span><span class="op" id="5001567">&amp;</span><span class="ident" id="5001568">rr</span><span class="op" id="5001570">.</span><span class="ident" id="5001571">Trailer</span><span class="op" id="5001578">,</span>&nbsp;<span class="ident" id="5001580">Header</span><span class="op" id="5001586">(</span><span class="ident" id="5001587">hdr</span><span class="op" id="5001590">)</span><span class="op" id="5001591">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001594">case</span>&nbsp;<span class="op" id="5001599">*</span><span class="ident" id="5001600">Response</span><span class="op" id="5001608">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001612">mergeSetHeader</span><span class="op" id="5001626">(</span><span class="op" id="5001627">&amp;</span><span class="ident" id="5001628">rr</span><span class="op" id="5001630">.</span><span class="ident" id="5001631">Trailer</span><span class="op" id="5001638">,</span>&nbsp;<span class="ident" id="5001640">Header</span><span class="op" id="5001646">(</span><span class="ident" id="5001647">hdr</span><span class="op" id="5001650">)</span><span class="op" id="5001651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001657">return</span>&nbsp;<span class="ident" id="5001664">nil</span><br>
<span class="lineno"></span><span class="op" id="5001668">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="5001671">func</span>&nbsp;<span class="ident" id="5001676">mergeSetHeader</span><span class="op" id="5001690">(</span><span class="ident" id="5001691">dst</span>&nbsp;<span class="op" id="5001695">*</span><span class="ident" id="5001696">Header</span><span class="op" id="5001702">,</span>&nbsp;<span class="ident" id="5001704">src</span>&nbsp;<span class="ident" id="5001708">Header</span><span class="op" id="5001714">)</span>&nbsp;<span class="op" id="5001716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001719">if</span>&nbsp;<span class="op" id="5001722">*</span><span class="ident" id="5001723">dst</span>&nbsp;<span class="op" id="5001727">==</span>&nbsp;<span class="ident" id="5001730">nil</span>&nbsp;<span class="op" id="5001734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001738">*</span><span class="ident" id="5001739">dst</span>&nbsp;<span class="op" id="5001743">=</span>&nbsp;<span class="ident" id="5001745">src</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001751">return</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001762">for</span>&nbsp;<span class="ident" id="5001766">k</span><span class="op" id="5001767">,</span>&nbsp;<span class="ident" id="5001769">vv</span>&nbsp;<span class="op" id="5001772">:=</span>&nbsp;<span class="keyword" id="5001775">range</span>&nbsp;<span class="ident" id="5001781">src</span>&nbsp;<span class="op" id="5001785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001789">(</span><span class="op" id="5001790">*</span><span class="ident" id="5001791">dst</span><span class="op" id="5001794">)</span><span class="op" id="5001795">[</span><span class="ident" id="5001796">k</span><span class="op" id="5001797">]</span>&nbsp;<span class="op" id="5001799">=</span>&nbsp;<span class="ident" id="5001801">vv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001805">}</span><br>
<span class="lineno"></span><span class="op" id="5001807">}</span><br>
<span class="lineno">690</span><br>
<span class="lineno"></span><span class="keyword" id="5001810">func</span>&nbsp;<span class="op" id="5001815">(</span><span class="ident" id="5001816">b</span>&nbsp;<span class="op" id="5001818">*</span><span class="ident" id="5001819">body</span><span class="op" id="5001823">)</span>&nbsp;<span class="ident" id="5001825">Close</span><span class="op" id="5001830">(</span><span class="op" id="5001831">)</span>&nbsp;<span class="builtintype" id="5001833">error</span>&nbsp;<span class="op" id="5001839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5001842">b</span><span class="op" id="5001843">.</span><span class="ident" id="5001844">mu</span><span class="op" id="5001846">.</span><span class="ident" id="5001847">Lock</span><span class="op" id="5001851">(</span><span class="op" id="5001852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001855">defer</span>&nbsp;<span class="ident" id="5001861">b</span><span class="op" id="5001862">.</span><span class="ident" id="5001863">mu</span><span class="op" id="5001865">.</span><span class="ident" id="5001866">Unlock</span><span class="op" id="5001872">(</span><span class="op" id="5001873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001876">if</span>&nbsp;<span class="ident" id="5001879">b</span><span class="op" id="5001880">.</span><span class="ident" id="5001881">closed</span>&nbsp;<span class="op" id="5001888">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001892">return</span>&nbsp;<span class="ident" id="5001899">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5001904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001907">var</span>&nbsp;<span class="ident" id="5001911">err</span>&nbsp;<span class="builtintype" id="5001915">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001922">switch</span>&nbsp;<span class="op" id="5001929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5001932">case</span>&nbsp;<span class="ident" id="5001937">b</span><span class="op" id="5001938">.</span><span class="ident" id="5001939">hdr</span>&nbsp;<span class="op" id="5001943">==</span>&nbsp;<span class="ident" id="5001946">nil</span>&nbsp;<span class="op" id="5001950">&amp;&amp;</span>&nbsp;<span class="ident" id="5001953">b</span><span class="op" id="5001954">.</span><span class="ident" id="5001955">closing</span><span class="op" id="5001962">:</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5001966">//&nbsp;no&nbsp;trailer&nbsp;and&nbsp;closing&nbsp;the&nbsp;connection&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5002015">//&nbsp;no&nbsp;point&nbsp;in&nbsp;reading&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002047">default</span><span class="op" id="5002054">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5002058">//&nbsp;Fully&nbsp;consume&nbsp;the&nbsp;body,&nbsp;which&nbsp;will&nbsp;also&nbsp;lead&nbsp;to&nbsp;us&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5002122">//&nbsp;the&nbsp;trailer&nbsp;headers&nbsp;after&nbsp;the&nbsp;body,&nbsp;if&nbsp;present.</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002175">_</span><span class="op" id="5002176">,</span>&nbsp;<span class="ident" id="5002178">err</span>&nbsp;<span class="op" id="5002182">=</span>&nbsp;<span class="ident" id="5002184">io</span><span class="op" id="5002186">.</span><span class="ident" id="5002187">Copy</span><span class="op" id="5002191">(</span><span class="ident" id="5002192">ioutil</span><span class="op" id="5002198">.</span><span class="ident" id="5002199">Discard</span><span class="op" id="5002206">,</span>&nbsp;<span class="ident" id="5002208">bodyLocked</span><span class="op" id="5002218">{</span><span class="ident" id="5002219">b</span><span class="op" id="5002220">}</span><span class="op" id="5002221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002227">b</span><span class="op" id="5002228">.</span><span class="ident" id="5002229">closed</span>&nbsp;<span class="op" id="5002236">=</span>&nbsp;<span class="builtintype" id="5002238">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002244">return</span>&nbsp;<span class="ident" id="5002251">err</span><br>
<span class="lineno"></span><span class="op" id="5002255">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="5002258">//&nbsp;bodyLocked&nbsp;is&nbsp;a&nbsp;io.Reader&nbsp;reading&nbsp;from&nbsp;a&nbsp;*body&nbsp;when&nbsp;its&nbsp;mutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5002326">//&nbsp;already&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="5002343">type</span>&nbsp;<span class="ident" id="5002348">bodyLocked</span>&nbsp;<span class="keyword" id="5002359">struct</span>&nbsp;<span class="op" id="5002366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002369">b</span>&nbsp;<span class="op" id="5002371">*</span><span class="ident" id="5002372">body</span><br>
<span class="lineno">715</span><span class="op" id="5002377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5002380">func</span>&nbsp;<span class="op" id="5002385">(</span><span class="ident" id="5002386">bl</span>&nbsp;<span class="ident" id="5002389">bodyLocked</span><span class="op" id="5002399">)</span>&nbsp;<span class="ident" id="5002401">Read</span><span class="op" id="5002405">(</span><span class="ident" id="5002406">p</span>&nbsp;<span class="op" id="5002408">[</span><span class="op" id="5002409">]</span><span class="builtintype" id="5002410">byte</span><span class="op" id="5002414">)</span>&nbsp;<span class="op" id="5002416">(</span><span class="ident" id="5002417">n</span>&nbsp;<span class="builtintype" id="5002419">int</span><span class="op" id="5002422">,</span>&nbsp;<span class="ident" id="5002424">err</span>&nbsp;<span class="builtintype" id="5002428">error</span><span class="op" id="5002433">)</span>&nbsp;<span class="op" id="5002435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002438">if</span>&nbsp;<span class="ident" id="5002441">bl</span><span class="op" id="5002443">.</span><span class="ident" id="5002444">b</span><span class="op" id="5002445">.</span><span class="ident" id="5002446">closed</span>&nbsp;<span class="op" id="5002453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002457">return</span>&nbsp;<span class="num" id="5002464">0</span><span class="op" id="5002465">,</span>&nbsp;<span class="ident" id="5002467">ErrBodyReadAfterClose</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002493">return</span>&nbsp;<span class="ident" id="5002500">bl</span><span class="op" id="5002502">.</span><span class="ident" id="5002503">b</span><span class="op" id="5002504">.</span><span class="ident" id="5002505">readLocked</span><span class="op" id="5002515">(</span><span class="ident" id="5002516">p</span><span class="op" id="5002517">)</span><br>
<span class="lineno"></span><span class="op" id="5002519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5002522">//&nbsp;parseContentLength&nbsp;trims&nbsp;whitespace&nbsp;from&nbsp;s&nbsp;and&nbsp;returns&nbsp;-1&nbsp;if&nbsp;no&nbsp;value</span><br>
<span class="lineno">725</span><span class="comment" id="5002595">//&nbsp;is&nbsp;set,&nbsp;or&nbsp;the&nbsp;value&nbsp;if&nbsp;it&#39;s&nbsp;&gt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="5002633">func</span>&nbsp;<span class="ident" id="5002638">parseContentLength</span><span class="op" id="5002656">(</span><span class="ident" id="5002657">cl</span>&nbsp;<span class="builtintype" id="5002660">string</span><span class="op" id="5002666">)</span>&nbsp;<span class="op" id="5002668">(</span><span class="ident" id="5002669">int64</span><span class="op" id="5002674">,</span>&nbsp;<span class="builtintype" id="5002676">error</span><span class="op" id="5002681">)</span>&nbsp;<span class="op" id="5002683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002686">cl</span>&nbsp;<span class="op" id="5002689">=</span>&nbsp;<span class="ident" id="5002691">strings</span><span class="op" id="5002698">.</span><span class="ident" id="5002699">TrimSpace</span><span class="op" id="5002708">(</span><span class="ident" id="5002709">cl</span><span class="op" id="5002711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002714">if</span>&nbsp;<span class="ident" id="5002717">cl</span>&nbsp;<span class="op" id="5002720">==</span>&nbsp;<span class="string" id="5002723">&#34;&#34;</span>&nbsp;<span class="op" id="5002726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002730">return</span>&nbsp;<span class="op" id="5002737">-</span><span class="num" id="5002738">1</span><span class="op" id="5002739">,</span>&nbsp;<span class="ident" id="5002741">nil</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5002749">n</span><span class="op" id="5002750">,</span>&nbsp;<span class="ident" id="5002752">err</span>&nbsp;<span class="op" id="5002756">:=</span>&nbsp;<span class="ident" id="5002759">strconv</span><span class="op" id="5002766">.</span><span class="ident" id="5002767">ParseInt</span><span class="op" id="5002775">(</span><span class="ident" id="5002776">cl</span><span class="op" id="5002778">,</span>&nbsp;<span class="num" id="5002780">10</span><span class="op" id="5002782">,</span>&nbsp;<span class="num" id="5002784">64</span><span class="op" id="5002786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002789">if</span>&nbsp;<span class="ident" id="5002792">err</span>&nbsp;<span class="op" id="5002796">!=</span>&nbsp;<span class="ident" id="5002799">nil</span>&nbsp;<span class="op" id="5002803">||</span>&nbsp;<span class="ident" id="5002806">n</span>&nbsp;<span class="op" id="5002808">&lt;</span>&nbsp;<span class="num" id="5002810">0</span>&nbsp;<span class="op" id="5002812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002816">return</span>&nbsp;<span class="num" id="5002823">0</span><span class="op" id="5002824">,</span>&nbsp;<span class="op" id="5002826">&amp;</span><span class="ident" id="5002827">badStringError</span><span class="op" id="5002841">{</span><span class="string" id="5002842">&#34;bad&nbsp;Content-Length&#34;</span><span class="op" id="5002862">,</span>&nbsp;<span class="ident" id="5002864">cl</span><span class="op" id="5002866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5002869">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5002872">return</span>&nbsp;<span class="ident" id="5002879">n</span><span class="op" id="5002880">,</span>&nbsp;<span class="ident" id="5002882">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="5002887">}</span>
</div>
</body>
</html>
