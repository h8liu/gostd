<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html" class="current">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6159916">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6159972">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6160026">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6160077">package</span>&nbsp;<span class="ident" id="6160085">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6160094">import</span>&nbsp;<span class="op" id="6160101">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6160104">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6160121">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6160131">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6160137">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6160148">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6160155">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="6160158">var</span>&nbsp;<span class="ident" id="6160162">errMissingParams</span>&nbsp;<span class="op" id="6160179">=</span>&nbsp;<span class="ident" id="6160181">errors</span><span class="op" id="6160187">.</span><span class="ident" id="6160188">New</span><span class="op" id="6160191">(</span><span class="string" id="6160192">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="6160230">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6160233">type</span>&nbsp;<span class="ident" id="6160238">serverCodec</span>&nbsp;<span class="keyword" id="6160250">struct</span>&nbsp;<span class="op" id="6160257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6160260">dec</span>&nbsp;<span class="op" id="6160264">*</span><span class="ident" id="6160265">json</span><span class="op" id="6160269">.</span><span class="ident" id="6160270">Decoder</span>&nbsp;<span class="comment" id="6160278">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6160306">enc</span>&nbsp;<span class="op" id="6160310">*</span><span class="ident" id="6160311">json</span><span class="op" id="6160315">.</span><span class="ident" id="6160316">Encoder</span>&nbsp;<span class="comment" id="6160324">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6160352">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6160356">io</span><span class="op" id="6160358">.</span><span class="ident" id="6160359">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6160368">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6160393">req</span>&nbsp;<span class="ident" id="6160397">serverRequest</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6160413">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6160480">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6160524">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6160583">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6160640">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6160693">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6160743">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6160751">sync</span><span class="op" id="6160755">.</span><span class="ident" id="6160756">Mutex</span>&nbsp;<span class="comment" id="6160762">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6160788">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6160796">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6160804">pending</span>&nbsp;<span class="keyword" id="6160812">map</span><span class="op" id="6160815">[</span><span class="builtintype" id="6160816">uint64</span><span class="op" id="6160822">]</span><span class="op" id="6160823">*</span><span class="ident" id="6160824">json</span><span class="op" id="6160828">.</span><span class="ident" id="6160829">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="6160840">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="6160843">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="6160915">func</span>&nbsp;<span class="ident" id="6160920">NewServerCodec</span><span class="op" id="6160934">(</span><span class="ident" id="6160935">conn</span>&nbsp;<span class="ident" id="6160940">io</span><span class="op" id="6160942">.</span><span class="ident" id="6160943">ReadWriteCloser</span><span class="op" id="6160958">)</span>&nbsp;<span class="ident" id="6160960">rpc</span><span class="op" id="6160963">.</span><span class="ident" id="6160964">ServerCodec</span>&nbsp;<span class="op" id="6160976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6160979">return</span>&nbsp;<span class="op" id="6160986">&amp;</span><span class="ident" id="6160987">serverCodec</span><span class="op" id="6160998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161002">dec</span><span class="op" id="6161005">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161011">json</span><span class="op" id="6161015">.</span><span class="ident" id="6161016">NewDecoder</span><span class="op" id="6161026">(</span><span class="ident" id="6161027">conn</span><span class="op" id="6161031">)</span><span class="op" id="6161032">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161036">enc</span><span class="op" id="6161039">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161045">json</span><span class="op" id="6161049">.</span><span class="ident" id="6161050">NewEncoder</span><span class="op" id="6161060">(</span><span class="ident" id="6161061">conn</span><span class="op" id="6161065">)</span><span class="op" id="6161066">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161070">c</span><span class="op" id="6161071">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161079">conn</span><span class="op" id="6161083">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161087">pending</span><span class="op" id="6161094">:</span>&nbsp;<span class="builtinfunc" id="6161096">make</span><span class="op" id="6161100">(</span><span class="keyword" id="6161101">map</span><span class="op" id="6161104">[</span><span class="builtintype" id="6161105">uint64</span><span class="op" id="6161111">]</span><span class="op" id="6161112">*</span><span class="ident" id="6161113">json</span><span class="op" id="6161117">.</span><span class="ident" id="6161118">RawMessage</span><span class="op" id="6161128">)</span><span class="op" id="6161129">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6161132">}</span><br>
<span class="lineno"></span><span class="op" id="6161134">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="6161137">type</span>&nbsp;<span class="ident" id="6161142">serverRequest</span>&nbsp;<span class="keyword" id="6161156">struct</span>&nbsp;<span class="op" id="6161163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161166">Method</span>&nbsp;<span class="builtintype" id="6161173">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6161190">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161207">Params</span>&nbsp;<span class="op" id="6161214">*</span><span class="ident" id="6161215">json</span><span class="op" id="6161219">.</span><span class="ident" id="6161220">RawMessage</span>&nbsp;<span class="string" id="6161231">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161248">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6161255">*</span><span class="ident" id="6161256">json</span><span class="op" id="6161260">.</span><span class="ident" id="6161261">RawMessage</span>&nbsp;<span class="string" id="6161272">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="6161284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6161287">func</span>&nbsp;<span class="op" id="6161292">(</span><span class="ident" id="6161293">r</span>&nbsp;<span class="op" id="6161295">*</span><span class="ident" id="6161296">serverRequest</span><span class="op" id="6161309">)</span>&nbsp;<span class="ident" id="6161311">reset</span><span class="op" id="6161316">(</span><span class="op" id="6161317">)</span>&nbsp;<span class="op" id="6161319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161322">r</span><span class="op" id="6161323">.</span><span class="ident" id="6161324">Method</span>&nbsp;<span class="op" id="6161331">=</span>&nbsp;<span class="string" id="6161333">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161337">r</span><span class="op" id="6161338">.</span><span class="ident" id="6161339">Params</span>&nbsp;<span class="op" id="6161346">=</span>&nbsp;<span class="builtintype" id="6161348">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161353">r</span><span class="op" id="6161354">.</span><span class="ident" id="6161355">Id</span>&nbsp;<span class="op" id="6161358">=</span>&nbsp;<span class="builtintype" id="6161360">nil</span><br>
<span class="lineno"></span><span class="op" id="6161364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6161367">type</span>&nbsp;<span class="ident" id="6161372">serverResponse</span>&nbsp;<span class="keyword" id="6161387">struct</span>&nbsp;<span class="op" id="6161394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161397">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6161404">*</span><span class="ident" id="6161405">json</span><span class="op" id="6161409">.</span><span class="ident" id="6161410">RawMessage</span>&nbsp;<span class="string" id="6161421">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161434">Result</span>&nbsp;<span class="keyword" id="6161441">interface</span><span class="op" id="6161450">{</span><span class="op" id="6161451">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6161458">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161475">Error</span>&nbsp;&nbsp;<span class="keyword" id="6161482">interface</span><span class="op" id="6161491">{</span><span class="op" id="6161492">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6161499">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="6161514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6161517">func</span>&nbsp;<span class="op" id="6161522">(</span><span class="ident" id="6161523">c</span>&nbsp;<span class="op" id="6161525">*</span><span class="ident" id="6161526">serverCodec</span><span class="op" id="6161537">)</span>&nbsp;<span class="ident" id="6161539">ReadRequestHeader</span><span class="op" id="6161556">(</span><span class="ident" id="6161557">r</span>&nbsp;<span class="op" id="6161559">*</span><span class="ident" id="6161560">rpc</span><span class="op" id="6161563">.</span><span class="ident" id="6161564">Request</span><span class="op" id="6161571">)</span>&nbsp;<span class="builtintype" id="6161573">error</span>&nbsp;<span class="op" id="6161579">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161582">c</span><span class="op" id="6161583">.</span><span class="ident" id="6161584">req</span><span class="op" id="6161587">.</span><span class="ident" id="6161588">reset</span><span class="op" id="6161593">(</span><span class="op" id="6161594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6161597">if</span>&nbsp;<span class="ident" id="6161600">err</span>&nbsp;<span class="op" id="6161604">:=</span>&nbsp;<span class="ident" id="6161607">c</span><span class="op" id="6161608">.</span><span class="ident" id="6161609">dec</span><span class="op" id="6161612">.</span><span class="ident" id="6161613">Decode</span><span class="op" id="6161619">(</span><span class="op" id="6161620">&amp;</span><span class="ident" id="6161621">c</span><span class="op" id="6161622">.</span><span class="ident" id="6161623">req</span><span class="op" id="6161626">)</span><span class="op" id="6161627">;</span>&nbsp;<span class="ident" id="6161629">err</span>&nbsp;<span class="op" id="6161633">!=</span>&nbsp;<span class="builtintype" id="6161636">nil</span>&nbsp;<span class="op" id="6161640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6161644">return</span>&nbsp;<span class="ident" id="6161651">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6161656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161659">r</span><span class="op" id="6161660">.</span><span class="ident" id="6161661">ServiceMethod</span>&nbsp;<span class="op" id="6161675">=</span>&nbsp;<span class="ident" id="6161677">c</span><span class="op" id="6161678">.</span><span class="ident" id="6161679">req</span><span class="op" id="6161682">.</span><span class="ident" id="6161683">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6161692">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6161735">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6161781">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161828">c</span><span class="op" id="6161829">.</span><span class="ident" id="6161830">mutex</span><span class="op" id="6161835">.</span><span class="ident" id="6161836">Lock</span><span class="op" id="6161840">(</span><span class="op" id="6161841">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161844">c</span><span class="op" id="6161845">.</span><span class="ident" id="6161846">seq</span><span class="op" id="6161849">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161853">c</span><span class="op" id="6161854">.</span><span class="ident" id="6161855">pending</span><span class="op" id="6161862">[</span><span class="ident" id="6161863">c</span><span class="op" id="6161864">.</span><span class="ident" id="6161865">seq</span><span class="op" id="6161868">]</span>&nbsp;<span class="op" id="6161870">=</span>&nbsp;<span class="ident" id="6161872">c</span><span class="op" id="6161873">.</span><span class="ident" id="6161874">req</span><span class="op" id="6161877">.</span><span class="ident" id="6161878">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161882">c</span><span class="op" id="6161883">.</span><span class="ident" id="6161884">req</span><span class="op" id="6161887">.</span><span class="ident" id="6161888">Id</span>&nbsp;<span class="op" id="6161891">=</span>&nbsp;<span class="builtintype" id="6161893">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161898">r</span><span class="op" id="6161899">.</span><span class="ident" id="6161900">Seq</span>&nbsp;<span class="op" id="6161904">=</span>&nbsp;<span class="ident" id="6161906">c</span><span class="op" id="6161907">.</span><span class="ident" id="6161908">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6161913">c</span><span class="op" id="6161914">.</span><span class="ident" id="6161915">mutex</span><span class="op" id="6161920">.</span><span class="ident" id="6161921">Unlock</span><span class="op" id="6161927">(</span><span class="op" id="6161928">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6161932">return</span>&nbsp;<span class="builtintype" id="6161939">nil</span><br>
<span class="lineno"></span><span class="op" id="6161943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6161946">func</span>&nbsp;<span class="op" id="6161951">(</span><span class="ident" id="6161952">c</span>&nbsp;<span class="op" id="6161954">*</span><span class="ident" id="6161955">serverCodec</span><span class="op" id="6161966">)</span>&nbsp;<span class="ident" id="6161968">ReadRequestBody</span><span class="op" id="6161983">(</span><span class="ident" id="6161984">x</span>&nbsp;<span class="keyword" id="6161986">interface</span><span class="op" id="6161995">{</span><span class="op" id="6161996">}</span><span class="op" id="6161997">)</span>&nbsp;<span class="builtintype" id="6161999">error</span>&nbsp;<span class="op" id="6162005">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162008">if</span>&nbsp;<span class="ident" id="6162011">x</span>&nbsp;<span class="op" id="6162013">==</span>&nbsp;<span class="builtintype" id="6162016">nil</span>&nbsp;<span class="op" id="6162020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162024">return</span>&nbsp;<span class="builtintype" id="6162031">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6162036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162039">if</span>&nbsp;<span class="ident" id="6162042">c</span><span class="op" id="6162043">.</span><span class="ident" id="6162044">req</span><span class="op" id="6162047">.</span><span class="ident" id="6162048">Params</span>&nbsp;<span class="op" id="6162055">==</span>&nbsp;<span class="builtintype" id="6162058">nil</span>&nbsp;<span class="op" id="6162062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162066">return</span>&nbsp;<span class="ident" id="6162073">errMissingParams</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6162091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6162094">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6162126">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6162152">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6162204">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162252">var</span>&nbsp;<span class="ident" id="6162256">params</span>&nbsp;<span class="op" id="6162263">[</span><span class="num" id="6162264">1</span><span class="op" id="6162265">]</span><span class="keyword" id="6162266">interface</span><span class="op" id="6162275">{</span><span class="op" id="6162276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6162279">params</span><span class="op" id="6162285">[</span><span class="num" id="6162286">0</span><span class="op" id="6162287">]</span>&nbsp;<span class="op" id="6162289">=</span>&nbsp;<span class="ident" id="6162291">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162294">return</span>&nbsp;<span class="ident" id="6162301">json</span><span class="op" id="6162305">.</span><span class="ident" id="6162306">Unmarshal</span><span class="op" id="6162315">(</span><span class="op" id="6162316">*</span><span class="ident" id="6162317">c</span><span class="op" id="6162318">.</span><span class="ident" id="6162319">req</span><span class="op" id="6162322">.</span><span class="ident" id="6162323">Params</span><span class="op" id="6162329">,</span>&nbsp;<span class="op" id="6162331">&amp;</span><span class="ident" id="6162332">params</span><span class="op" id="6162338">)</span><br>
<span class="lineno"></span><span class="op" id="6162340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="6162343">var</span>&nbsp;<span class="ident" id="6162347">null</span>&nbsp;<span class="op" id="6162352">=</span>&nbsp;<span class="ident" id="6162354">json</span><span class="op" id="6162358">.</span><span class="ident" id="6162359">RawMessage</span><span class="op" id="6162369">(</span><span class="op" id="6162370">[</span><span class="op" id="6162371">]</span><span class="builtintype" id="6162372">byte</span><span class="op" id="6162376">(</span><span class="string" id="6162377">&#34;null&#34;</span><span class="op" id="6162383">)</span><span class="op" id="6162384">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6162387">func</span>&nbsp;<span class="op" id="6162392">(</span><span class="ident" id="6162393">c</span>&nbsp;<span class="op" id="6162395">*</span><span class="ident" id="6162396">serverCodec</span><span class="op" id="6162407">)</span>&nbsp;<span class="ident" id="6162409">WriteResponse</span><span class="op" id="6162422">(</span><span class="ident" id="6162423">r</span>&nbsp;<span class="op" id="6162425">*</span><span class="ident" id="6162426">rpc</span><span class="op" id="6162429">.</span><span class="ident" id="6162430">Response</span><span class="op" id="6162438">,</span>&nbsp;<span class="ident" id="6162440">x</span>&nbsp;<span class="keyword" id="6162442">interface</span><span class="op" id="6162451">{</span><span class="op" id="6162452">}</span><span class="op" id="6162453">)</span>&nbsp;<span class="builtintype" id="6162455">error</span>&nbsp;<span class="op" id="6162461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6162464">c</span><span class="op" id="6162465">.</span><span class="ident" id="6162466">mutex</span><span class="op" id="6162471">.</span><span class="ident" id="6162472">Lock</span><span class="op" id="6162476">(</span><span class="op" id="6162477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6162480">b</span><span class="op" id="6162481">,</span>&nbsp;<span class="ident" id="6162483">ok</span>&nbsp;<span class="op" id="6162486">:=</span>&nbsp;<span class="ident" id="6162489">c</span><span class="op" id="6162490">.</span><span class="ident" id="6162491">pending</span><span class="op" id="6162498">[</span><span class="ident" id="6162499">r</span><span class="op" id="6162500">.</span><span class="ident" id="6162501">Seq</span><span class="op" id="6162504">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162507">if</span>&nbsp;<span class="op" id="6162510">!</span><span class="ident" id="6162511">ok</span>&nbsp;<span class="op" id="6162514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6162518">c</span><span class="op" id="6162519">.</span><span class="ident" id="6162520">mutex</span><span class="op" id="6162525">.</span><span class="ident" id="6162526">Unlock</span><span class="op" id="6162532">(</span><span class="op" id="6162533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162537">return</span>&nbsp;<span class="ident" id="6162544">errors</span><span class="op" id="6162550">.</span><span class="ident" id="6162551">New</span><span class="op" id="6162554">(</span><span class="string" id="6162555">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="6162592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6162595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6162598">delete</span><span class="op" id="6162604">(</span><span class="ident" id="6162605">c</span><span class="op" id="6162606">.</span><span class="ident" id="6162607">pending</span><span class="op" id="6162614">,</span>&nbsp;<span class="ident" id="6162616">r</span><span class="op" id="6162617">.</span><span class="ident" id="6162618">Seq</span><span class="op" id="6162621">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6162624">c</span><span class="op" id="6162625">.</span><span class="ident" id="6162626">mutex</span><span class="op" id="6162631">.</span><span class="ident" id="6162632">Unlock</span><span class="op" id="6162638">(</span><span class="op" id="6162639">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162643">if</span>&nbsp;<span class="ident" id="6162646">b</span>&nbsp;<span class="op" id="6162648">==</span>&nbsp;<span class="builtintype" id="6162651">nil</span>&nbsp;<span class="op" id="6162655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6162659">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6162706">b</span>&nbsp;<span class="op" id="6162708">=</span>&nbsp;<span class="op" id="6162710">&amp;</span><span class="ident" id="6162711">null</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6162717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6162720">resp</span>&nbsp;<span class="op" id="6162725">:=</span>&nbsp;<span class="ident" id="6162728">serverResponse</span><span class="op" id="6162742">{</span><span class="ident" id="6162743">Id</span><span class="op" id="6162745">:</span>&nbsp;<span class="ident" id="6162747">b</span><span class="op" id="6162748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162751">if</span>&nbsp;<span class="ident" id="6162754">r</span><span class="op" id="6162755">.</span><span class="ident" id="6162756">Error</span>&nbsp;<span class="op" id="6162762">==</span>&nbsp;<span class="string" id="6162765">&#34;&#34;</span>&nbsp;<span class="op" id="6162768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6162772">resp</span><span class="op" id="6162776">.</span><span class="ident" id="6162777">Result</span>&nbsp;<span class="op" id="6162784">=</span>&nbsp;<span class="ident" id="6162786">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6162789">}</span>&nbsp;<span class="keyword" id="6162791">else</span>&nbsp;<span class="op" id="6162796">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6162800">resp</span><span class="op" id="6162804">.</span><span class="ident" id="6162805">Error</span>&nbsp;<span class="op" id="6162811">=</span>&nbsp;<span class="ident" id="6162813">r</span><span class="op" id="6162814">.</span><span class="ident" id="6162815">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6162822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162825">return</span>&nbsp;<span class="ident" id="6162832">c</span><span class="op" id="6162833">.</span><span class="ident" id="6162834">enc</span><span class="op" id="6162837">.</span><span class="ident" id="6162838">Encode</span><span class="op" id="6162844">(</span><span class="ident" id="6162845">resp</span><span class="op" id="6162849">)</span><br>
<span class="lineno"></span><span class="op" id="6162851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="6162854">func</span>&nbsp;<span class="op" id="6162859">(</span><span class="ident" id="6162860">c</span>&nbsp;<span class="op" id="6162862">*</span><span class="ident" id="6162863">serverCodec</span><span class="op" id="6162874">)</span>&nbsp;<span class="ident" id="6162876">Close</span><span class="op" id="6162881">(</span><span class="op" id="6162882">)</span>&nbsp;<span class="builtintype" id="6162884">error</span>&nbsp;<span class="op" id="6162890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6162893">return</span>&nbsp;<span class="ident" id="6162900">c</span><span class="op" id="6162901">.</span><span class="ident" id="6162902">c</span><span class="op" id="6162903">.</span><span class="ident" id="6162904">Close</span><span class="op" id="6162909">(</span><span class="op" id="6162910">)</span><br>
<span class="lineno"></span><span class="op" id="6162912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6162915">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="6162977">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="6163048">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="6163109">func</span>&nbsp;<span class="ident" id="6163114">ServeConn</span><span class="op" id="6163123">(</span><span class="ident" id="6163124">conn</span>&nbsp;<span class="ident" id="6163129">io</span><span class="op" id="6163131">.</span><span class="ident" id="6163132">ReadWriteCloser</span><span class="op" id="6163147">)</span>&nbsp;<span class="op" id="6163149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6163152">rpc</span><span class="op" id="6163155">.</span><span class="ident" id="6163156">ServeCodec</span><span class="op" id="6163166">(</span><span class="ident" id="6163167">NewServerCodec</span><span class="op" id="6163181">(</span><span class="ident" id="6163182">conn</span><span class="op" id="6163186">)</span><span class="op" id="6163187">)</span><br>
<span class="lineno"></span><span class="op" id="6163189">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
