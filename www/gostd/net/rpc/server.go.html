<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5797878">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5797933">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5797987">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5798038">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Package&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;network&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;methods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Only&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;other&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;These&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;second&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;sees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;typically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;listener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;NewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;both&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Client&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;call,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;parameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;launches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;structure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;Unless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;transport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Here&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Quo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;At&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;Then&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;or<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;divCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;client.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5801867">package</span>&nbsp;<span class="ident" id="5801875">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5801880">import</span>&nbsp;<span class="op" id="5801887">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801890">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801899">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801915">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801925">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801931">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801938">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801945">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801957">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801968">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801979">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801987">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5801998">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5802013">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5802016">const</span>&nbsp;<span class="op" id="5802022">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5802025">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802057">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5802074">=</span>&nbsp;<span class="string" id="5802076">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802088">DefaultDebugPath</span>&nbsp;<span class="op" id="5802105">=</span>&nbsp;<span class="string" id="5802107">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="5802120">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="5802123">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5802191">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="5802260">var</span>&nbsp;<span class="ident" id="5802264">typeOfError</span>&nbsp;<span class="op" id="5802276">=</span>&nbsp;<span class="ident" id="5802278">reflect</span><span class="op" id="5802285">.</span><span class="ident" id="5802286">TypeOf</span><span class="op" id="5802292">(</span><span class="op" id="5802293">(</span><span class="op" id="5802294">*</span><span class="builtintype" id="5802295">error</span><span class="op" id="5802300">)</span><span class="op" id="5802301">(</span><span class="builtintype" id="5802302">nil</span><span class="op" id="5802305">)</span><span class="op" id="5802306">)</span><span class="op" id="5802307">.</span><span class="ident" id="5802308">Elem</span><span class="op" id="5802312">(</span><span class="op" id="5802313">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5802316">type</span>&nbsp;<span class="ident" id="5802321">methodType</span>&nbsp;<span class="keyword" id="5802332">struct</span>&nbsp;<span class="op" id="5802339">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802342">sync</span><span class="op" id="5802346">.</span><span class="ident" id="5802347">Mutex</span>&nbsp;<span class="comment" id="5802353">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802375">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802386">reflect</span><span class="op" id="5802393">.</span><span class="ident" id="5802394">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802402">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802413">reflect</span><span class="op" id="5802420">.</span><span class="ident" id="5802421">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802427">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="5802438">reflect</span><span class="op" id="5802445">.</span><span class="ident" id="5802446">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802452">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5802463">uint</span><br>
<span class="lineno">155</span><span class="op" id="5802468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5802471">type</span>&nbsp;<span class="ident" id="5802476">service</span>&nbsp;<span class="keyword" id="5802484">struct</span>&nbsp;<span class="op" id="5802491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802494">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5802501">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5802524">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802544">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5802551">reflect</span><span class="op" id="5802558">.</span><span class="ident" id="5802559">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5802574">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802614">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802621">reflect</span><span class="op" id="5802628">.</span><span class="ident" id="5802629">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5802644">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802669">method</span>&nbsp;<span class="keyword" id="5802676">map</span><span class="op" id="5802679">[</span><span class="builtintype" id="5802680">string</span><span class="op" id="5802686">]</span><span class="op" id="5802687">*</span><span class="ident" id="5802688">methodType</span>&nbsp;<span class="comment" id="5802699">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="5802721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5802724">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="5802801">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="5802871">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5802891">type</span>&nbsp;<span class="ident" id="5802896">Request</span>&nbsp;<span class="keyword" id="5802904">struct</span>&nbsp;<span class="op" id="5802911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802914">ServiceMethod</span>&nbsp;<span class="builtintype" id="5802928">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5802937">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802966">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5802980">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5802989">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803026">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5803040">*</span><span class="ident" id="5803041">Request</span>&nbsp;<span class="comment" id="5803049">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5803076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5803079">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="5803159">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="5803229">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5803249">type</span>&nbsp;<span class="ident" id="5803254">Response</span>&nbsp;<span class="keyword" id="5803263">struct</span>&nbsp;<span class="op" id="5803270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803273">ServiceMethod</span>&nbsp;<span class="builtintype" id="5803287">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5803297">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803328">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803342">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5803352">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803383">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5803397">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5803407">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803426">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5803440">*</span><span class="ident" id="5803441">Response</span>&nbsp;<span class="comment" id="5803450">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5803477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5803480">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5803516">type</span>&nbsp;<span class="ident" id="5803521">Server</span>&nbsp;<span class="keyword" id="5803528">struct</span>&nbsp;<span class="op" id="5803535">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803538">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803549">sync</span><span class="op" id="5803553">.</span><span class="ident" id="5803554">RWMutex</span>&nbsp;<span class="comment" id="5803562">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803590">serviceMap</span>&nbsp;<span class="keyword" id="5803601">map</span><span class="op" id="5803604">[</span><span class="builtintype" id="5803605">string</span><span class="op" id="5803611">]</span><span class="op" id="5803612">*</span><span class="ident" id="5803613">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803622">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803633">sync</span><span class="op" id="5803637">.</span><span class="ident" id="5803638">Mutex</span>&nbsp;<span class="comment" id="5803644">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803665">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5803676">*</span><span class="ident" id="5803677">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803686">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5803697">sync</span><span class="op" id="5803701">.</span><span class="ident" id="5803702">Mutex</span>&nbsp;<span class="comment" id="5803708">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5803730">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5803741">*</span><span class="ident" id="5803742">Response</span><br>
<span class="lineno"></span><span class="op" id="5803751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5803754">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5803789">func</span>&nbsp;<span class="ident" id="5803794">NewServer</span><span class="op" id="5803803">(</span><span class="op" id="5803804">)</span>&nbsp;<span class="op" id="5803806">*</span><span class="ident" id="5803807">Server</span>&nbsp;<span class="op" id="5803814">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5803817">return</span>&nbsp;<span class="op" id="5803824">&amp;</span><span class="ident" id="5803825">Server</span><span class="op" id="5803831">{</span><span class="ident" id="5803832">serviceMap</span><span class="op" id="5803842">:</span>&nbsp;<span class="builtinfunc" id="5803844">make</span><span class="op" id="5803848">(</span><span class="keyword" id="5803849">map</span><span class="op" id="5803852">[</span><span class="builtintype" id="5803853">string</span><span class="op" id="5803859">]</span><span class="op" id="5803860">*</span><span class="ident" id="5803861">service</span><span class="op" id="5803868">)</span><span class="op" id="5803869">}</span><br>
<span class="lineno"></span><span class="op" id="5803871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5803874">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5803927">var</span>&nbsp;<span class="ident" id="5803931">DefaultServer</span>&nbsp;<span class="op" id="5803945">=</span>&nbsp;<span class="ident" id="5803947">NewServer</span><span class="op" id="5803956">(</span><span class="op" id="5803957">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5803960">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="5804004">func</span>&nbsp;<span class="ident" id="5804009">isExported</span><span class="op" id="5804019">(</span><span class="ident" id="5804020">name</span>&nbsp;<span class="builtintype" id="5804025">string</span><span class="op" id="5804031">)</span>&nbsp;<span class="builtintype" id="5804033">bool</span>&nbsp;<span class="op" id="5804038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5804041">rune</span><span class="op" id="5804045">,</span>&nbsp;<span class="ident" id="5804047">_</span>&nbsp;<span class="op" id="5804049">:=</span>&nbsp;<span class="ident" id="5804052">utf8</span><span class="op" id="5804056">.</span><span class="ident" id="5804057">DecodeRuneInString</span><span class="op" id="5804075">(</span><span class="ident" id="5804076">name</span><span class="op" id="5804080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5804083">return</span>&nbsp;<span class="ident" id="5804090">unicode</span><span class="op" id="5804097">.</span><span class="ident" id="5804098">IsUpper</span><span class="op" id="5804105">(</span><span class="builtintype" id="5804106">rune</span><span class="op" id="5804110">)</span><br>
<span class="lineno">205</span><span class="op" id="5804112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5804115">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="5804154">func</span>&nbsp;<span class="ident" id="5804159">isExportedOrBuiltinType</span><span class="op" id="5804182">(</span><span class="ident" id="5804183">t</span>&nbsp;<span class="ident" id="5804185">reflect</span><span class="op" id="5804192">.</span><span class="ident" id="5804193">Type</span><span class="op" id="5804197">)</span>&nbsp;<span class="builtintype" id="5804199">bool</span>&nbsp;<span class="op" id="5804204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5804207">for</span>&nbsp;<span class="ident" id="5804211">t</span><span class="op" id="5804212">.</span><span class="ident" id="5804213">Kind</span><span class="op" id="5804217">(</span><span class="op" id="5804218">)</span>&nbsp;<span class="op" id="5804220">==</span>&nbsp;<span class="ident" id="5804223">reflect</span><span class="op" id="5804230">.</span><span class="ident" id="5804231">Ptr</span>&nbsp;<span class="op" id="5804235">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5804239">t</span>&nbsp;<span class="op" id="5804241">=</span>&nbsp;<span class="ident" id="5804243">t</span><span class="op" id="5804244">.</span><span class="ident" id="5804245">Elem</span><span class="op" id="5804249">(</span><span class="op" id="5804250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5804253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5804256">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5804313">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5804360">return</span>&nbsp;<span class="ident" id="5804367">isExported</span><span class="op" id="5804377">(</span><span class="ident" id="5804378">t</span><span class="op" id="5804379">.</span><span class="ident" id="5804380">Name</span><span class="op" id="5804384">(</span><span class="op" id="5804385">)</span><span class="op" id="5804386">)</span>&nbsp;<span class="op" id="5804388">||</span>&nbsp;<span class="ident" id="5804391">t</span><span class="op" id="5804392">.</span><span class="ident" id="5804393">PkgPath</span><span class="op" id="5804400">(</span><span class="op" id="5804401">)</span>&nbsp;<span class="op" id="5804403">==</span>&nbsp;<span class="string" id="5804406">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="5804409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5804412">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5804474">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="5804531">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="5804552">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5804594">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="5804632">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5804669">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5804739">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="5804805">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5804882">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5804929">func</span>&nbsp;<span class="op" id="5804934">(</span><span class="ident" id="5804935">server</span>&nbsp;<span class="op" id="5804942">*</span><span class="ident" id="5804943">Server</span><span class="op" id="5804949">)</span>&nbsp;<span class="ident" id="5804951">Register</span><span class="op" id="5804959">(</span><span class="ident" id="5804960">rcvr</span>&nbsp;<span class="keyword" id="5804965">interface</span><span class="op" id="5804974">{</span><span class="op" id="5804975">}</span><span class="op" id="5804976">)</span>&nbsp;<span class="builtintype" id="5804978">error</span>&nbsp;<span class="op" id="5804984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5804987">return</span>&nbsp;<span class="ident" id="5804994">server</span><span class="op" id="5805000">.</span><span class="ident" id="5805001">register</span><span class="op" id="5805009">(</span><span class="ident" id="5805010">rcvr</span><span class="op" id="5805014">,</span>&nbsp;<span class="string" id="5805016">&#34;&#34;</span><span class="op" id="5805018">,</span>&nbsp;<span class="builtintype" id="5805020">false</span><span class="op" id="5805025">)</span><br>
<span class="lineno"></span><span class="op" id="5805027">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5805030">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5805103">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5805147">func</span>&nbsp;<span class="op" id="5805152">(</span><span class="ident" id="5805153">server</span>&nbsp;<span class="op" id="5805160">*</span><span class="ident" id="5805161">Server</span><span class="op" id="5805167">)</span>&nbsp;<span class="ident" id="5805169">RegisterName</span><span class="op" id="5805181">(</span><span class="ident" id="5805182">name</span>&nbsp;<span class="builtintype" id="5805187">string</span><span class="op" id="5805193">,</span>&nbsp;<span class="ident" id="5805195">rcvr</span>&nbsp;<span class="keyword" id="5805200">interface</span><span class="op" id="5805209">{</span><span class="op" id="5805210">}</span><span class="op" id="5805211">)</span>&nbsp;<span class="builtintype" id="5805213">error</span>&nbsp;<span class="op" id="5805219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5805222">return</span>&nbsp;<span class="ident" id="5805229">server</span><span class="op" id="5805235">.</span><span class="ident" id="5805236">register</span><span class="op" id="5805244">(</span><span class="ident" id="5805245">rcvr</span><span class="op" id="5805249">,</span>&nbsp;<span class="ident" id="5805251">name</span><span class="op" id="5805255">,</span>&nbsp;<span class="builtintype" id="5805257">true</span><span class="op" id="5805261">)</span><br>
<span class="lineno">235</span><span class="op" id="5805263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5805266">func</span>&nbsp;<span class="op" id="5805271">(</span><span class="ident" id="5805272">server</span>&nbsp;<span class="op" id="5805279">*</span><span class="ident" id="5805280">Server</span><span class="op" id="5805286">)</span>&nbsp;<span class="ident" id="5805288">register</span><span class="op" id="5805296">(</span><span class="ident" id="5805297">rcvr</span>&nbsp;<span class="keyword" id="5805302">interface</span><span class="op" id="5805311">{</span><span class="op" id="5805312">}</span><span class="op" id="5805313">,</span>&nbsp;<span class="ident" id="5805315">name</span>&nbsp;<span class="builtintype" id="5805320">string</span><span class="op" id="5805326">,</span>&nbsp;<span class="ident" id="5805328">useName</span>&nbsp;<span class="builtintype" id="5805336">bool</span><span class="op" id="5805340">)</span>&nbsp;<span class="builtintype" id="5805342">error</span>&nbsp;<span class="op" id="5805348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805351">server</span><span class="op" id="5805357">.</span><span class="ident" id="5805358">mu</span><span class="op" id="5805360">.</span><span class="ident" id="5805361">Lock</span><span class="op" id="5805365">(</span><span class="op" id="5805366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5805369">defer</span>&nbsp;<span class="ident" id="5805375">server</span><span class="op" id="5805381">.</span><span class="ident" id="5805382">mu</span><span class="op" id="5805384">.</span><span class="ident" id="5805385">Unlock</span><span class="op" id="5805391">(</span><span class="op" id="5805392">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5805395">if</span>&nbsp;<span class="ident" id="5805398">server</span><span class="op" id="5805404">.</span><span class="ident" id="5805405">serviceMap</span>&nbsp;<span class="op" id="5805416">==</span>&nbsp;<span class="builtintype" id="5805419">nil</span>&nbsp;<span class="op" id="5805423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805427">server</span><span class="op" id="5805433">.</span><span class="ident" id="5805434">serviceMap</span>&nbsp;<span class="op" id="5805445">=</span>&nbsp;<span class="builtinfunc" id="5805447">make</span><span class="op" id="5805451">(</span><span class="keyword" id="5805452">map</span><span class="op" id="5805455">[</span><span class="builtintype" id="5805456">string</span><span class="op" id="5805462">]</span><span class="op" id="5805463">*</span><span class="ident" id="5805464">service</span><span class="op" id="5805471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5805474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805477">s</span>&nbsp;<span class="op" id="5805479">:=</span>&nbsp;<span class="builtinfunc" id="5805482">new</span><span class="op" id="5805485">(</span><span class="ident" id="5805486">service</span><span class="op" id="5805493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805496">s</span><span class="op" id="5805497">.</span><span class="ident" id="5805498">typ</span>&nbsp;<span class="op" id="5805502">=</span>&nbsp;<span class="ident" id="5805504">reflect</span><span class="op" id="5805511">.</span><span class="ident" id="5805512">TypeOf</span><span class="op" id="5805518">(</span><span class="ident" id="5805519">rcvr</span><span class="op" id="5805523">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805526">s</span><span class="op" id="5805527">.</span><span class="ident" id="5805528">rcvr</span>&nbsp;<span class="op" id="5805533">=</span>&nbsp;<span class="ident" id="5805535">reflect</span><span class="op" id="5805542">.</span><span class="ident" id="5805543">ValueOf</span><span class="op" id="5805550">(</span><span class="ident" id="5805551">rcvr</span><span class="op" id="5805555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805558">sname</span>&nbsp;<span class="op" id="5805564">:=</span>&nbsp;<span class="ident" id="5805567">reflect</span><span class="op" id="5805574">.</span><span class="ident" id="5805575">Indirect</span><span class="op" id="5805583">(</span><span class="ident" id="5805584">s</span><span class="op" id="5805585">.</span><span class="ident" id="5805586">rcvr</span><span class="op" id="5805590">)</span><span class="op" id="5805591">.</span><span class="ident" id="5805592">Type</span><span class="op" id="5805596">(</span><span class="op" id="5805597">)</span><span class="op" id="5805598">.</span><span class="ident" id="5805599">Name</span><span class="op" id="5805603">(</span><span class="op" id="5805604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5805607">if</span>&nbsp;<span class="ident" id="5805610">useName</span>&nbsp;<span class="op" id="5805618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805622">sname</span>&nbsp;<span class="op" id="5805628">=</span>&nbsp;<span class="ident" id="5805630">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5805636">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5805639">if</span>&nbsp;<span class="ident" id="5805642">sname</span>&nbsp;<span class="op" id="5805648">==</span>&nbsp;<span class="string" id="5805651">&#34;&#34;</span>&nbsp;<span class="op" id="5805654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805658">s</span>&nbsp;<span class="op" id="5805660">:=</span>&nbsp;<span class="string" id="5805663">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5805705">+</span>&nbsp;<span class="ident" id="5805707">s</span><span class="op" id="5805708">.</span><span class="ident" id="5805709">typ</span><span class="op" id="5805712">.</span><span class="ident" id="5805713">String</span><span class="op" id="5805719">(</span><span class="op" id="5805720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805724">log</span><span class="op" id="5805727">.</span><span class="ident" id="5805728">Print</span><span class="op" id="5805733">(</span><span class="ident" id="5805734">s</span><span class="op" id="5805735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5805739">return</span>&nbsp;<span class="ident" id="5805746">errors</span><span class="op" id="5805752">.</span><span class="ident" id="5805753">New</span><span class="op" id="5805756">(</span><span class="ident" id="5805757">s</span><span class="op" id="5805758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5805761">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5805764">if</span>&nbsp;<span class="op" id="5805767">!</span><span class="ident" id="5805768">isExported</span><span class="op" id="5805778">(</span><span class="ident" id="5805779">sname</span><span class="op" id="5805784">)</span>&nbsp;<span class="op" id="5805786">&amp;&amp;</span>&nbsp;<span class="op" id="5805789">!</span><span class="ident" id="5805790">useName</span>&nbsp;<span class="op" id="5805798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805802">s</span>&nbsp;<span class="op" id="5805804">:=</span>&nbsp;<span class="string" id="5805807">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5805829">+</span>&nbsp;<span class="ident" id="5805831">sname</span>&nbsp;<span class="op" id="5805837">+</span>&nbsp;<span class="string" id="5805839">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5805860">log</span><span class="op" id="5805863">.</span><span class="ident" id="5805864">Print</span><span class="op" id="5805869">(</span><span class="ident" id="5805870">s</span><span class="op" id="5805871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5805875">return</span>&nbsp;<span class="ident" id="5805882">errors</span><span class="op" id="5805888">.</span><span class="ident" id="5805889">New</span><span class="op" id="5805892">(</span><span class="ident" id="5805893">s</span><span class="op" id="5805894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5805897">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5805900">if</span>&nbsp;<span class="ident" id="5805903">_</span><span class="op" id="5805904">,</span>&nbsp;<span class="ident" id="5805906">present</span>&nbsp;<span class="op" id="5805914">:=</span>&nbsp;<span class="ident" id="5805917">server</span><span class="op" id="5805923">.</span><span class="ident" id="5805924">serviceMap</span><span class="op" id="5805934">[</span><span class="ident" id="5805935">sname</span><span class="op" id="5805940">]</span><span class="op" id="5805941">;</span>&nbsp;<span class="ident" id="5805943">present</span>&nbsp;<span class="op" id="5805951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5805955">return</span>&nbsp;<span class="ident" id="5805962">errors</span><span class="op" id="5805968">.</span><span class="ident" id="5805969">New</span><span class="op" id="5805972">(</span><span class="string" id="5805973">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="5806006">+</span>&nbsp;<span class="ident" id="5806008">sname</span><span class="op" id="5806013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5806016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806019">s</span><span class="op" id="5806020">.</span><span class="ident" id="5806021">name</span>&nbsp;<span class="op" id="5806026">=</span>&nbsp;<span class="ident" id="5806028">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5806036">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806060">s</span><span class="op" id="5806061">.</span><span class="ident" id="5806062">method</span>&nbsp;<span class="op" id="5806069">=</span>&nbsp;<span class="ident" id="5806071">suitableMethods</span><span class="op" id="5806086">(</span><span class="ident" id="5806087">s</span><span class="op" id="5806088">.</span><span class="ident" id="5806089">typ</span><span class="op" id="5806092">,</span>&nbsp;<span class="builtintype" id="5806094">true</span><span class="op" id="5806098">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5806102">if</span>&nbsp;<span class="builtinfunc" id="5806105">len</span><span class="op" id="5806108">(</span><span class="ident" id="5806109">s</span><span class="op" id="5806110">.</span><span class="ident" id="5806111">method</span><span class="op" id="5806117">)</span>&nbsp;<span class="op" id="5806119">==</span>&nbsp;<span class="num" id="5806122">0</span>&nbsp;<span class="op" id="5806124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806128">str</span>&nbsp;<span class="op" id="5806132">:=</span>&nbsp;<span class="string" id="5806135">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5806141">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806202">method</span>&nbsp;<span class="op" id="5806209">:=</span>&nbsp;<span class="ident" id="5806212">suitableMethods</span><span class="op" id="5806227">(</span><span class="ident" id="5806228">reflect</span><span class="op" id="5806235">.</span><span class="ident" id="5806236">PtrTo</span><span class="op" id="5806241">(</span><span class="ident" id="5806242">s</span><span class="op" id="5806243">.</span><span class="ident" id="5806244">typ</span><span class="op" id="5806247">)</span><span class="op" id="5806248">,</span>&nbsp;<span class="builtintype" id="5806250">false</span><span class="op" id="5806255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5806259">if</span>&nbsp;<span class="builtinfunc" id="5806262">len</span><span class="op" id="5806265">(</span><span class="ident" id="5806266">method</span><span class="op" id="5806272">)</span>&nbsp;<span class="op" id="5806274">!=</span>&nbsp;<span class="num" id="5806277">0</span>&nbsp;<span class="op" id="5806279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806284">str</span>&nbsp;<span class="op" id="5806288">=</span>&nbsp;<span class="string" id="5806290">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5806312">+</span>&nbsp;<span class="ident" id="5806314">sname</span>&nbsp;<span class="op" id="5806320">+</span>&nbsp;<span class="string" id="5806322">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5806413">}</span>&nbsp;<span class="keyword" id="5806415">else</span>&nbsp;<span class="op" id="5806420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806425">str</span>&nbsp;<span class="op" id="5806429">=</span>&nbsp;<span class="string" id="5806431">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5806453">+</span>&nbsp;<span class="ident" id="5806455">sname</span>&nbsp;<span class="op" id="5806461">+</span>&nbsp;<span class="string" id="5806463">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5806509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806513">log</span><span class="op" id="5806516">.</span><span class="ident" id="5806517">Print</span><span class="op" id="5806522">(</span><span class="ident" id="5806523">str</span><span class="op" id="5806526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5806530">return</span>&nbsp;<span class="ident" id="5806537">errors</span><span class="op" id="5806543">.</span><span class="ident" id="5806544">New</span><span class="op" id="5806547">(</span><span class="ident" id="5806548">str</span><span class="op" id="5806551">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5806554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806557">server</span><span class="op" id="5806563">.</span><span class="ident" id="5806564">serviceMap</span><span class="op" id="5806574">[</span><span class="ident" id="5806575">s</span><span class="op" id="5806576">.</span><span class="ident" id="5806577">name</span><span class="op" id="5806581">]</span>&nbsp;<span class="op" id="5806583">=</span>&nbsp;<span class="ident" id="5806585">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5806588">return</span>&nbsp;<span class="builtintype" id="5806595">nil</span><br>
<span class="lineno"></span><span class="op" id="5806599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5806602">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="5806673">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5806714">func</span>&nbsp;<span class="ident" id="5806719">suitableMethods</span><span class="op" id="5806734">(</span><span class="ident" id="5806735">typ</span>&nbsp;<span class="ident" id="5806739">reflect</span><span class="op" id="5806746">.</span><span class="ident" id="5806747">Type</span><span class="op" id="5806751">,</span>&nbsp;<span class="ident" id="5806753">reportErr</span>&nbsp;<span class="builtintype" id="5806763">bool</span><span class="op" id="5806767">)</span>&nbsp;<span class="keyword" id="5806769">map</span><span class="op" id="5806772">[</span><span class="builtintype" id="5806773">string</span><span class="op" id="5806779">]</span><span class="op" id="5806780">*</span><span class="ident" id="5806781">methodType</span>&nbsp;<span class="op" id="5806792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806795">methods</span>&nbsp;<span class="op" id="5806803">:=</span>&nbsp;<span class="builtinfunc" id="5806806">make</span><span class="op" id="5806810">(</span><span class="keyword" id="5806811">map</span><span class="op" id="5806814">[</span><span class="builtintype" id="5806815">string</span><span class="op" id="5806821">]</span><span class="op" id="5806822">*</span><span class="ident" id="5806823">methodType</span><span class="op" id="5806833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5806836">for</span>&nbsp;<span class="ident" id="5806840">m</span>&nbsp;<span class="op" id="5806842">:=</span>&nbsp;<span class="num" id="5806845">0</span><span class="op" id="5806846">;</span>&nbsp;<span class="ident" id="5806848">m</span>&nbsp;<span class="op" id="5806850">&lt;</span>&nbsp;<span class="ident" id="5806852">typ</span><span class="op" id="5806855">.</span><span class="ident" id="5806856">NumMethod</span><span class="op" id="5806865">(</span><span class="op" id="5806866">)</span><span class="op" id="5806867">;</span>&nbsp;<span class="ident" id="5806869">m</span><span class="op" id="5806870">++</span>&nbsp;<span class="op" id="5806873">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806877">method</span>&nbsp;<span class="op" id="5806884">:=</span>&nbsp;<span class="ident" id="5806887">typ</span><span class="op" id="5806890">.</span><span class="ident" id="5806891">Method</span><span class="op" id="5806897">(</span><span class="ident" id="5806898">m</span><span class="op" id="5806899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806903">mtype</span>&nbsp;<span class="op" id="5806909">:=</span>&nbsp;<span class="ident" id="5806912">method</span><span class="op" id="5806918">.</span><span class="ident" id="5806919">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5806926">mname</span>&nbsp;<span class="op" id="5806932">:=</span>&nbsp;<span class="ident" id="5806935">method</span><span class="op" id="5806941">.</span><span class="ident" id="5806942">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5806949">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5806979">if</span>&nbsp;<span class="ident" id="5806982">method</span><span class="op" id="5806988">.</span><span class="ident" id="5806989">PkgPath</span>&nbsp;<span class="op" id="5806997">!=</span>&nbsp;<span class="string" id="5807000">&#34;&#34;</span>&nbsp;<span class="op" id="5807003">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807008">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5807019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5807023">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807077">if</span>&nbsp;<span class="ident" id="5807080">mtype</span><span class="op" id="5807085">.</span><span class="ident" id="5807086">NumIn</span><span class="op" id="5807091">(</span><span class="op" id="5807092">)</span>&nbsp;<span class="op" id="5807094">!=</span>&nbsp;<span class="num" id="5807097">3</span>&nbsp;<span class="op" id="5807099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807104">if</span>&nbsp;<span class="ident" id="5807107">reportErr</span>&nbsp;<span class="op" id="5807117">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5807123">log</span><span class="op" id="5807126">.</span><span class="ident" id="5807127">Println</span><span class="op" id="5807134">(</span><span class="string" id="5807135">&#34;method&#34;</span><span class="op" id="5807143">,</span>&nbsp;<span class="ident" id="5807145">mname</span><span class="op" id="5807150">,</span>&nbsp;<span class="string" id="5807152">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="5807178">,</span>&nbsp;<span class="ident" id="5807180">mtype</span><span class="op" id="5807185">.</span><span class="ident" id="5807186">NumIn</span><span class="op" id="5807191">(</span><span class="op" id="5807192">)</span><span class="op" id="5807193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5807198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807203">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5807214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5807218">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5807256">argType</span>&nbsp;<span class="op" id="5807264">:=</span>&nbsp;<span class="ident" id="5807267">mtype</span><span class="op" id="5807272">.</span><span class="ident" id="5807273">In</span><span class="op" id="5807275">(</span><span class="num" id="5807276">1</span><span class="op" id="5807277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807281">if</span>&nbsp;<span class="op" id="5807284">!</span><span class="ident" id="5807285">isExportedOrBuiltinType</span><span class="op" id="5807308">(</span><span class="ident" id="5807309">argType</span><span class="op" id="5807316">)</span>&nbsp;<span class="op" id="5807318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807323">if</span>&nbsp;<span class="ident" id="5807326">reportErr</span>&nbsp;<span class="op" id="5807336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5807342">log</span><span class="op" id="5807345">.</span><span class="ident" id="5807346">Println</span><span class="op" id="5807353">(</span><span class="ident" id="5807354">mname</span><span class="op" id="5807359">,</span>&nbsp;<span class="string" id="5807361">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5807390">,</span>&nbsp;<span class="ident" id="5807392">argType</span><span class="op" id="5807399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5807404">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807409">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5807420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5807424">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5807459">replyType</span>&nbsp;<span class="op" id="5807469">:=</span>&nbsp;<span class="ident" id="5807472">mtype</span><span class="op" id="5807477">.</span><span class="ident" id="5807478">In</span><span class="op" id="5807480">(</span><span class="num" id="5807481">2</span><span class="op" id="5807482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807486">if</span>&nbsp;<span class="ident" id="5807489">replyType</span><span class="op" id="5807498">.</span><span class="ident" id="5807499">Kind</span><span class="op" id="5807503">(</span><span class="op" id="5807504">)</span>&nbsp;<span class="op" id="5807506">!=</span>&nbsp;<span class="ident" id="5807509">reflect</span><span class="op" id="5807516">.</span><span class="ident" id="5807517">Ptr</span>&nbsp;<span class="op" id="5807521">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807526">if</span>&nbsp;<span class="ident" id="5807529">reportErr</span>&nbsp;<span class="op" id="5807539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5807545">log</span><span class="op" id="5807548">.</span><span class="ident" id="5807549">Println</span><span class="op" id="5807556">(</span><span class="string" id="5807557">&#34;method&#34;</span><span class="op" id="5807565">,</span>&nbsp;<span class="ident" id="5807567">mname</span><span class="op" id="5807572">,</span>&nbsp;<span class="string" id="5807574">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="5807601">,</span>&nbsp;<span class="ident" id="5807603">replyType</span><span class="op" id="5807612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5807617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807622">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5807633">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5807637">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807671">if</span>&nbsp;<span class="op" id="5807674">!</span><span class="ident" id="5807675">isExportedOrBuiltinType</span><span class="op" id="5807698">(</span><span class="ident" id="5807699">replyType</span><span class="op" id="5807708">)</span>&nbsp;<span class="op" id="5807710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807715">if</span>&nbsp;<span class="ident" id="5807718">reportErr</span>&nbsp;<span class="op" id="5807728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5807734">log</span><span class="op" id="5807737">.</span><span class="ident" id="5807738">Println</span><span class="op" id="5807745">(</span><span class="string" id="5807746">&#34;method&#34;</span><span class="op" id="5807754">,</span>&nbsp;<span class="ident" id="5807756">mname</span><span class="op" id="5807761">,</span>&nbsp;<span class="string" id="5807763">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5807789">,</span>&nbsp;<span class="ident" id="5807791">replyType</span><span class="op" id="5807800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5807805">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807810">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5807821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5807825">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807852">if</span>&nbsp;<span class="ident" id="5807855">mtype</span><span class="op" id="5807860">.</span><span class="ident" id="5807861">NumOut</span><span class="op" id="5807867">(</span><span class="op" id="5807868">)</span>&nbsp;<span class="op" id="5807870">!=</span>&nbsp;<span class="num" id="5807873">1</span>&nbsp;<span class="op" id="5807875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807880">if</span>&nbsp;<span class="ident" id="5807883">reportErr</span>&nbsp;<span class="op" id="5807893">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5807899">log</span><span class="op" id="5807902">.</span><span class="ident" id="5807903">Println</span><span class="op" id="5807910">(</span><span class="string" id="5807911">&#34;method&#34;</span><span class="op" id="5807919">,</span>&nbsp;<span class="ident" id="5807921">mname</span><span class="op" id="5807926">,</span>&nbsp;<span class="string" id="5807928">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="5807955">,</span>&nbsp;<span class="ident" id="5807957">mtype</span><span class="op" id="5807962">.</span><span class="ident" id="5807963">NumOut</span><span class="op" id="5807969">(</span><span class="op" id="5807970">)</span><span class="op" id="5807971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5807976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5807981">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5807992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5807996">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5808046">if</span>&nbsp;<span class="ident" id="5808049">returnType</span>&nbsp;<span class="op" id="5808060">:=</span>&nbsp;<span class="ident" id="5808063">mtype</span><span class="op" id="5808068">.</span><span class="ident" id="5808069">Out</span><span class="op" id="5808072">(</span><span class="num" id="5808073">0</span><span class="op" id="5808074">)</span><span class="op" id="5808075">;</span>&nbsp;<span class="ident" id="5808077">returnType</span>&nbsp;<span class="op" id="5808088">!=</span>&nbsp;<span class="ident" id="5808091">typeOfError</span>&nbsp;<span class="op" id="5808103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5808108">if</span>&nbsp;<span class="ident" id="5808111">reportErr</span>&nbsp;<span class="op" id="5808121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5808127">log</span><span class="op" id="5808130">.</span><span class="ident" id="5808131">Println</span><span class="op" id="5808138">(</span><span class="string" id="5808139">&#34;method&#34;</span><span class="op" id="5808147">,</span>&nbsp;<span class="ident" id="5808149">mname</span><span class="op" id="5808154">,</span>&nbsp;<span class="string" id="5808156">&#34;returns&#34;</span><span class="op" id="5808165">,</span>&nbsp;<span class="ident" id="5808167">returnType</span><span class="op" id="5808177">.</span><span class="ident" id="5808178">String</span><span class="op" id="5808184">(</span><span class="op" id="5808185">)</span><span class="op" id="5808186">,</span>&nbsp;<span class="string" id="5808188">&#34;not&nbsp;error&#34;</span><span class="op" id="5808199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5808204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5808209">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5808220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5808224">methods</span><span class="op" id="5808231">[</span><span class="ident" id="5808232">mname</span><span class="op" id="5808237">]</span>&nbsp;<span class="op" id="5808239">=</span>&nbsp;<span class="op" id="5808241">&amp;</span><span class="ident" id="5808242">methodType</span><span class="op" id="5808252">{</span><span class="ident" id="5808253">method</span><span class="op" id="5808259">:</span>&nbsp;<span class="ident" id="5808261">method</span><span class="op" id="5808267">,</span>&nbsp;<span class="ident" id="5808269">ArgType</span><span class="op" id="5808276">:</span>&nbsp;<span class="ident" id="5808278">argType</span><span class="op" id="5808285">,</span>&nbsp;<span class="ident" id="5808287">ReplyType</span><span class="op" id="5808296">:</span>&nbsp;<span class="ident" id="5808298">replyType</span><span class="op" id="5808307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5808310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5808313">return</span>&nbsp;<span class="ident" id="5808320">methods</span><br>
<span class="lineno"></span><span class="op" id="5808328">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="5808331">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="5808412">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="5808497">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5808535">var</span>&nbsp;<span class="ident" id="5808539">invalidRequest</span>&nbsp;<span class="op" id="5808554">=</span>&nbsp;<span class="keyword" id="5808556">struct</span><span class="op" id="5808562">{</span><span class="op" id="5808563">}</span><span class="op" id="5808564">{</span><span class="op" id="5808565">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="5808568">func</span>&nbsp;<span class="op" id="5808573">(</span><span class="ident" id="5808574">server</span>&nbsp;<span class="op" id="5808581">*</span><span class="ident" id="5808582">Server</span><span class="op" id="5808588">)</span>&nbsp;<span class="ident" id="5808590">sendResponse</span><span class="op" id="5808602">(</span><span class="ident" id="5808603">sending</span>&nbsp;<span class="op" id="5808611">*</span><span class="ident" id="5808612">sync</span><span class="op" id="5808616">.</span><span class="ident" id="5808617">Mutex</span><span class="op" id="5808622">,</span>&nbsp;<span class="ident" id="5808624">req</span>&nbsp;<span class="op" id="5808628">*</span><span class="ident" id="5808629">Request</span><span class="op" id="5808636">,</span>&nbsp;<span class="ident" id="5808638">reply</span>&nbsp;<span class="keyword" id="5808644">interface</span><span class="op" id="5808653">{</span><span class="op" id="5808654">}</span><span class="op" id="5808655">,</span>&nbsp;<span class="ident" id="5808657">codec</span>&nbsp;<span class="ident" id="5808663">ServerCodec</span><span class="op" id="5808674">,</span>&nbsp;<span class="ident" id="5808676">errmsg</span>&nbsp;<span class="builtintype" id="5808683">string</span><span class="op" id="5808689">)</span>&nbsp;<span class="op" id="5808691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5808694">resp</span>&nbsp;<span class="op" id="5808699">:=</span>&nbsp;<span class="ident" id="5808702">server</span><span class="op" id="5808708">.</span><span class="ident" id="5808709">getResponse</span><span class="op" id="5808720">(</span><span class="op" id="5808721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5808724">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5808755">resp</span><span class="op" id="5808759">.</span><span class="ident" id="5808760">ServiceMethod</span>&nbsp;<span class="op" id="5808774">=</span>&nbsp;<span class="ident" id="5808776">req</span><span class="op" id="5808779">.</span><span class="ident" id="5808780">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5808795">if</span>&nbsp;<span class="ident" id="5808798">errmsg</span>&nbsp;<span class="op" id="5808805">!=</span>&nbsp;<span class="string" id="5808808">&#34;&#34;</span>&nbsp;<span class="op" id="5808811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5808815">resp</span><span class="op" id="5808819">.</span><span class="ident" id="5808820">Error</span>&nbsp;<span class="op" id="5808826">=</span>&nbsp;<span class="ident" id="5808828">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5808837">reply</span>&nbsp;<span class="op" id="5808843">=</span>&nbsp;<span class="ident" id="5808845">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5808861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5808864">resp</span><span class="op" id="5808868">.</span><span class="ident" id="5808869">Seq</span>&nbsp;<span class="op" id="5808873">=</span>&nbsp;<span class="ident" id="5808875">req</span><span class="op" id="5808878">.</span><span class="ident" id="5808879">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5808884">sending</span><span class="op" id="5808891">.</span><span class="ident" id="5808892">Lock</span><span class="op" id="5808896">(</span><span class="op" id="5808897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5808900">err</span>&nbsp;<span class="op" id="5808904">:=</span>&nbsp;<span class="ident" id="5808907">codec</span><span class="op" id="5808912">.</span><span class="ident" id="5808913">WriteResponse</span><span class="op" id="5808926">(</span><span class="ident" id="5808927">resp</span><span class="op" id="5808931">,</span>&nbsp;<span class="ident" id="5808933">reply</span><span class="op" id="5808938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5808941">if</span>&nbsp;<span class="ident" id="5808944">debugLog</span>&nbsp;<span class="op" id="5808953">&amp;&amp;</span>&nbsp;<span class="ident" id="5808956">err</span>&nbsp;<span class="op" id="5808960">!=</span>&nbsp;<span class="builtintype" id="5808963">nil</span>&nbsp;<span class="op" id="5808967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5808971">log</span><span class="op" id="5808974">.</span><span class="ident" id="5808975">Println</span><span class="op" id="5808982">(</span><span class="string" id="5808983">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="5809007">,</span>&nbsp;<span class="ident" id="5809009">err</span><span class="op" id="5809012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5809015">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809018">sending</span><span class="op" id="5809025">.</span><span class="ident" id="5809026">Unlock</span><span class="op" id="5809032">(</span><span class="op" id="5809033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809036">server</span><span class="op" id="5809042">.</span><span class="ident" id="5809043">freeResponse</span><span class="op" id="5809055">(</span><span class="ident" id="5809056">resp</span><span class="op" id="5809060">)</span><br>
<span class="lineno"></span><span class="op" id="5809062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5809065">func</span>&nbsp;<span class="op" id="5809070">(</span><span class="ident" id="5809071">m</span>&nbsp;<span class="op" id="5809073">*</span><span class="ident" id="5809074">methodType</span><span class="op" id="5809084">)</span>&nbsp;<span class="ident" id="5809086">NumCalls</span><span class="op" id="5809094">(</span><span class="op" id="5809095">)</span>&nbsp;<span class="op" id="5809097">(</span><span class="ident" id="5809098">n</span>&nbsp;<span class="builtintype" id="5809100">uint</span><span class="op" id="5809104">)</span>&nbsp;<span class="op" id="5809106">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809109">m</span><span class="op" id="5809110">.</span><span class="ident" id="5809111">Lock</span><span class="op" id="5809115">(</span><span class="op" id="5809116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809119">n</span>&nbsp;<span class="op" id="5809121">=</span>&nbsp;<span class="ident" id="5809123">m</span><span class="op" id="5809124">.</span><span class="ident" id="5809125">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809135">m</span><span class="op" id="5809136">.</span><span class="ident" id="5809137">Unlock</span><span class="op" id="5809143">(</span><span class="op" id="5809144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5809147">return</span>&nbsp;<span class="ident" id="5809154">n</span><br>
<span class="lineno"></span><span class="op" id="5809156">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="5809159">func</span>&nbsp;<span class="op" id="5809164">(</span><span class="ident" id="5809165">s</span>&nbsp;<span class="op" id="5809167">*</span><span class="ident" id="5809168">service</span><span class="op" id="5809175">)</span>&nbsp;<span class="ident" id="5809177">call</span><span class="op" id="5809181">(</span><span class="ident" id="5809182">server</span>&nbsp;<span class="op" id="5809189">*</span><span class="ident" id="5809190">Server</span><span class="op" id="5809196">,</span>&nbsp;<span class="ident" id="5809198">sending</span>&nbsp;<span class="op" id="5809206">*</span><span class="ident" id="5809207">sync</span><span class="op" id="5809211">.</span><span class="ident" id="5809212">Mutex</span><span class="op" id="5809217">,</span>&nbsp;<span class="ident" id="5809219">mtype</span>&nbsp;<span class="op" id="5809225">*</span><span class="ident" id="5809226">methodType</span><span class="op" id="5809236">,</span>&nbsp;<span class="ident" id="5809238">req</span>&nbsp;<span class="op" id="5809242">*</span><span class="ident" id="5809243">Request</span><span class="op" id="5809250">,</span>&nbsp;<span class="ident" id="5809252">argv</span><span class="op" id="5809256">,</span>&nbsp;<span class="ident" id="5809258">replyv</span>&nbsp;<span class="ident" id="5809265">reflect</span><span class="op" id="5809272">.</span><span class="ident" id="5809273">Value</span><span class="op" id="5809278">,</span>&nbsp;<span class="ident" id="5809280">codec</span>&nbsp;<span class="ident" id="5809286">ServerCodec</span><span class="op" id="5809297">)</span>&nbsp;<span class="op" id="5809299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809302">mtype</span><span class="op" id="5809307">.</span><span class="ident" id="5809308">Lock</span><span class="op" id="5809312">(</span><span class="op" id="5809313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809316">mtype</span><span class="op" id="5809321">.</span><span class="ident" id="5809322">numCalls</span><span class="op" id="5809330">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809334">mtype</span><span class="op" id="5809339">.</span><span class="ident" id="5809340">Unlock</span><span class="op" id="5809346">(</span><span class="op" id="5809347">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809350">function</span>&nbsp;<span class="op" id="5809359">:=</span>&nbsp;<span class="ident" id="5809362">mtype</span><span class="op" id="5809367">.</span><span class="ident" id="5809368">method</span><span class="op" id="5809374">.</span><span class="ident" id="5809375">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5809381">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809441">returnValues</span>&nbsp;<span class="op" id="5809454">:=</span>&nbsp;<span class="ident" id="5809457">function</span><span class="op" id="5809465">.</span><span class="ident" id="5809466">Call</span><span class="op" id="5809470">(</span><span class="op" id="5809471">[</span><span class="op" id="5809472">]</span><span class="ident" id="5809473">reflect</span><span class="op" id="5809480">.</span><span class="ident" id="5809481">Value</span><span class="op" id="5809486">{</span><span class="ident" id="5809487">s</span><span class="op" id="5809488">.</span><span class="ident" id="5809489">rcvr</span><span class="op" id="5809493">,</span>&nbsp;<span class="ident" id="5809495">argv</span><span class="op" id="5809499">,</span>&nbsp;<span class="ident" id="5809501">replyv</span><span class="op" id="5809507">}</span><span class="op" id="5809508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5809511">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809560">errInter</span>&nbsp;<span class="op" id="5809569">:=</span>&nbsp;<span class="ident" id="5809572">returnValues</span><span class="op" id="5809584">[</span><span class="num" id="5809585">0</span><span class="op" id="5809586">]</span><span class="op" id="5809587">.</span><span class="ident" id="5809588">Interface</span><span class="op" id="5809597">(</span><span class="op" id="5809598">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809601">errmsg</span>&nbsp;<span class="op" id="5809608">:=</span>&nbsp;<span class="string" id="5809611">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5809615">if</span>&nbsp;<span class="ident" id="5809618">errInter</span>&nbsp;<span class="op" id="5809627">!=</span>&nbsp;<span class="builtintype" id="5809630">nil</span>&nbsp;<span class="op" id="5809634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809638">errmsg</span>&nbsp;<span class="op" id="5809645">=</span>&nbsp;<span class="ident" id="5809647">errInter</span><span class="op" id="5809655">.</span><span class="op" id="5809656">(</span><span class="builtintype" id="5809657">error</span><span class="op" id="5809662">)</span><span class="op" id="5809663">.</span><span class="ident" id="5809664">Error</span><span class="op" id="5809669">(</span><span class="op" id="5809670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5809673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809676">server</span><span class="op" id="5809682">.</span><span class="ident" id="5809683">sendResponse</span><span class="op" id="5809695">(</span><span class="ident" id="5809696">sending</span><span class="op" id="5809703">,</span>&nbsp;<span class="ident" id="5809705">req</span><span class="op" id="5809708">,</span>&nbsp;<span class="ident" id="5809710">replyv</span><span class="op" id="5809716">.</span><span class="ident" id="5809717">Interface</span><span class="op" id="5809726">(</span><span class="op" id="5809727">)</span><span class="op" id="5809728">,</span>&nbsp;<span class="ident" id="5809730">codec</span><span class="op" id="5809735">,</span>&nbsp;<span class="ident" id="5809737">errmsg</span><span class="op" id="5809743">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809746">server</span><span class="op" id="5809752">.</span><span class="ident" id="5809753">freeRequest</span><span class="op" id="5809764">(</span><span class="ident" id="5809765">req</span><span class="op" id="5809768">)</span><br>
<span class="lineno"></span><span class="op" id="5809770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5809773">type</span>&nbsp;<span class="ident" id="5809778">gobServerCodec</span>&nbsp;<span class="keyword" id="5809793">struct</span>&nbsp;<span class="op" id="5809800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809803">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809810">io</span><span class="op" id="5809812">.</span><span class="ident" id="5809813">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809830">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5809837">*</span><span class="ident" id="5809838">gob</span><span class="op" id="5809841">.</span><span class="ident" id="5809842">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809851">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5809858">*</span><span class="ident" id="5809859">gob</span><span class="op" id="5809862">.</span><span class="ident" id="5809863">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809872">encBuf</span>&nbsp;<span class="op" id="5809879">*</span><span class="ident" id="5809880">bufio</span><span class="op" id="5809885">.</span><span class="ident" id="5809886">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5809894">closed</span>&nbsp;<span class="builtintype" id="5809901">bool</span><br>
<span class="lineno"></span><span class="op" id="5809906">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="5809909">func</span>&nbsp;<span class="op" id="5809914">(</span><span class="ident" id="5809915">c</span>&nbsp;<span class="op" id="5809917">*</span><span class="ident" id="5809918">gobServerCodec</span><span class="op" id="5809932">)</span>&nbsp;<span class="ident" id="5809934">ReadRequestHeader</span><span class="op" id="5809951">(</span><span class="ident" id="5809952">r</span>&nbsp;<span class="op" id="5809954">*</span><span class="ident" id="5809955">Request</span><span class="op" id="5809962">)</span>&nbsp;<span class="builtintype" id="5809964">error</span>&nbsp;<span class="op" id="5809970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5809973">return</span>&nbsp;<span class="ident" id="5809980">c</span><span class="op" id="5809981">.</span><span class="ident" id="5809982">dec</span><span class="op" id="5809985">.</span><span class="ident" id="5809986">Decode</span><span class="op" id="5809992">(</span><span class="ident" id="5809993">r</span><span class="op" id="5809994">)</span><br>
<span class="lineno"></span><span class="op" id="5809996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="5809999">func</span>&nbsp;<span class="op" id="5810004">(</span><span class="ident" id="5810005">c</span>&nbsp;<span class="op" id="5810007">*</span><span class="ident" id="5810008">gobServerCodec</span><span class="op" id="5810022">)</span>&nbsp;<span class="ident" id="5810024">ReadRequestBody</span><span class="op" id="5810039">(</span><span class="ident" id="5810040">body</span>&nbsp;<span class="keyword" id="5810045">interface</span><span class="op" id="5810054">{</span><span class="op" id="5810055">}</span><span class="op" id="5810056">)</span>&nbsp;<span class="builtintype" id="5810058">error</span>&nbsp;<span class="op" id="5810064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5810067">return</span>&nbsp;<span class="ident" id="5810074">c</span><span class="op" id="5810075">.</span><span class="ident" id="5810076">dec</span><span class="op" id="5810079">.</span><span class="ident" id="5810080">Decode</span><span class="op" id="5810086">(</span><span class="ident" id="5810087">body</span><span class="op" id="5810091">)</span><br>
<span class="lineno"></span><span class="op" id="5810093">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5810096">func</span>&nbsp;<span class="op" id="5810101">(</span><span class="ident" id="5810102">c</span>&nbsp;<span class="op" id="5810104">*</span><span class="ident" id="5810105">gobServerCodec</span><span class="op" id="5810119">)</span>&nbsp;<span class="ident" id="5810121">WriteResponse</span><span class="op" id="5810134">(</span><span class="ident" id="5810135">r</span>&nbsp;<span class="op" id="5810137">*</span><span class="ident" id="5810138">Response</span><span class="op" id="5810146">,</span>&nbsp;<span class="ident" id="5810148">body</span>&nbsp;<span class="keyword" id="5810153">interface</span><span class="op" id="5810162">{</span><span class="op" id="5810163">}</span><span class="op" id="5810164">)</span>&nbsp;<span class="op" id="5810166">(</span><span class="ident" id="5810167">err</span>&nbsp;<span class="builtintype" id="5810171">error</span><span class="op" id="5810176">)</span>&nbsp;<span class="op" id="5810178">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5810181">if</span>&nbsp;<span class="ident" id="5810184">err</span>&nbsp;<span class="op" id="5810188">=</span>&nbsp;<span class="ident" id="5810190">c</span><span class="op" id="5810191">.</span><span class="ident" id="5810192">enc</span><span class="op" id="5810195">.</span><span class="ident" id="5810196">Encode</span><span class="op" id="5810202">(</span><span class="ident" id="5810203">r</span><span class="op" id="5810204">)</span><span class="op" id="5810205">;</span>&nbsp;<span class="ident" id="5810207">err</span>&nbsp;<span class="op" id="5810211">!=</span>&nbsp;<span class="builtintype" id="5810214">nil</span>&nbsp;<span class="op" id="5810218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5810222">if</span>&nbsp;<span class="ident" id="5810225">c</span><span class="op" id="5810226">.</span><span class="ident" id="5810227">encBuf</span><span class="op" id="5810233">.</span><span class="ident" id="5810234">Flush</span><span class="op" id="5810239">(</span><span class="op" id="5810240">)</span>&nbsp;<span class="op" id="5810242">==</span>&nbsp;<span class="builtintype" id="5810245">nil</span>&nbsp;<span class="op" id="5810249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5810254">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5810326">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5810398">log</span><span class="op" id="5810401">.</span><span class="ident" id="5810402">Println</span><span class="op" id="5810409">(</span><span class="string" id="5810410">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="5810445">,</span>&nbsp;<span class="ident" id="5810447">err</span><span class="op" id="5810450">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5810455">c</span><span class="op" id="5810456">.</span><span class="ident" id="5810457">Close</span><span class="op" id="5810462">(</span><span class="op" id="5810463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5810467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5810471">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5810479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5810482">if</span>&nbsp;<span class="ident" id="5810485">err</span>&nbsp;<span class="op" id="5810489">=</span>&nbsp;<span class="ident" id="5810491">c</span><span class="op" id="5810492">.</span><span class="ident" id="5810493">enc</span><span class="op" id="5810496">.</span><span class="ident" id="5810497">Encode</span><span class="op" id="5810503">(</span><span class="ident" id="5810504">body</span><span class="op" id="5810508">)</span><span class="op" id="5810509">;</span>&nbsp;<span class="ident" id="5810511">err</span>&nbsp;<span class="op" id="5810515">!=</span>&nbsp;<span class="builtintype" id="5810518">nil</span>&nbsp;<span class="op" id="5810522">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5810526">if</span>&nbsp;<span class="ident" id="5810529">c</span><span class="op" id="5810530">.</span><span class="ident" id="5810531">encBuf</span><span class="op" id="5810537">.</span><span class="ident" id="5810538">Flush</span><span class="op" id="5810543">(</span><span class="op" id="5810544">)</span>&nbsp;<span class="op" id="5810546">==</span>&nbsp;<span class="builtintype" id="5810549">nil</span>&nbsp;<span class="op" id="5810553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5810558">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5810633">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5810705">log</span><span class="op" id="5810708">.</span><span class="ident" id="5810709">Println</span><span class="op" id="5810716">(</span><span class="string" id="5810717">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="5810748">,</span>&nbsp;<span class="ident" id="5810750">err</span><span class="op" id="5810753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5810758">c</span><span class="op" id="5810759">.</span><span class="ident" id="5810760">Close</span><span class="op" id="5810765">(</span><span class="op" id="5810766">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5810770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5810774">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5810782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5810785">return</span>&nbsp;<span class="ident" id="5810792">c</span><span class="op" id="5810793">.</span><span class="ident" id="5810794">encBuf</span><span class="op" id="5810800">.</span><span class="ident" id="5810801">Flush</span><span class="op" id="5810806">(</span><span class="op" id="5810807">)</span><br>
<span class="lineno"></span><span class="op" id="5810809">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5810812">func</span>&nbsp;<span class="op" id="5810817">(</span><span class="ident" id="5810818">c</span>&nbsp;<span class="op" id="5810820">*</span><span class="ident" id="5810821">gobServerCodec</span><span class="op" id="5810835">)</span>&nbsp;<span class="ident" id="5810837">Close</span><span class="op" id="5810842">(</span><span class="op" id="5810843">)</span>&nbsp;<span class="builtintype" id="5810845">error</span>&nbsp;<span class="op" id="5810851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5810854">if</span>&nbsp;<span class="ident" id="5810857">c</span><span class="op" id="5810858">.</span><span class="ident" id="5810859">closed</span>&nbsp;<span class="op" id="5810866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5810870">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5810942">return</span>&nbsp;<span class="builtintype" id="5810949">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5810954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5810957">c</span><span class="op" id="5810958">.</span><span class="ident" id="5810959">closed</span>&nbsp;<span class="op" id="5810966">=</span>&nbsp;<span class="builtintype" id="5810968">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5810974">return</span>&nbsp;<span class="ident" id="5810981">c</span><span class="op" id="5810982">.</span><span class="ident" id="5810983">rwc</span><span class="op" id="5810986">.</span><span class="ident" id="5810987">Close</span><span class="op" id="5810992">(</span><span class="op" id="5810993">)</span><br>
<span class="lineno"></span><span class="op" id="5810995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="5810998">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5811051">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5811122">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5811183">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5811246">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="5811305">func</span>&nbsp;<span class="op" id="5811310">(</span><span class="ident" id="5811311">server</span>&nbsp;<span class="op" id="5811318">*</span><span class="ident" id="5811319">Server</span><span class="op" id="5811325">)</span>&nbsp;<span class="ident" id="5811327">ServeConn</span><span class="op" id="5811336">(</span><span class="ident" id="5811337">conn</span>&nbsp;<span class="ident" id="5811342">io</span><span class="op" id="5811344">.</span><span class="ident" id="5811345">ReadWriteCloser</span><span class="op" id="5811360">)</span>&nbsp;<span class="op" id="5811362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811365">buf</span>&nbsp;<span class="op" id="5811369">:=</span>&nbsp;<span class="ident" id="5811372">bufio</span><span class="op" id="5811377">.</span><span class="ident" id="5811378">NewWriter</span><span class="op" id="5811387">(</span><span class="ident" id="5811388">conn</span><span class="op" id="5811392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811395">srv</span>&nbsp;<span class="op" id="5811399">:=</span>&nbsp;<span class="op" id="5811402">&amp;</span><span class="ident" id="5811403">gobServerCodec</span><span class="op" id="5811417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811421">rwc</span><span class="op" id="5811424">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811429">conn</span><span class="op" id="5811433">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811437">dec</span><span class="op" id="5811440">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811445">gob</span><span class="op" id="5811448">.</span><span class="ident" id="5811449">NewDecoder</span><span class="op" id="5811459">(</span><span class="ident" id="5811460">conn</span><span class="op" id="5811464">)</span><span class="op" id="5811465">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811469">enc</span><span class="op" id="5811472">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811477">gob</span><span class="op" id="5811480">.</span><span class="ident" id="5811481">NewEncoder</span><span class="op" id="5811491">(</span><span class="ident" id="5811492">buf</span><span class="op" id="5811495">)</span><span class="op" id="5811496">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811500">encBuf</span><span class="op" id="5811506">:</span>&nbsp;<span class="ident" id="5811508">buf</span><span class="op" id="5811511">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5811514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811517">server</span><span class="op" id="5811523">.</span><span class="ident" id="5811524">ServeCodec</span><span class="op" id="5811534">(</span><span class="ident" id="5811535">srv</span><span class="op" id="5811538">)</span><br>
<span class="lineno"></span><span class="op" id="5811540">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5811543">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5811607">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5811648">func</span>&nbsp;<span class="op" id="5811653">(</span><span class="ident" id="5811654">server</span>&nbsp;<span class="op" id="5811661">*</span><span class="ident" id="5811662">Server</span><span class="op" id="5811668">)</span>&nbsp;<span class="ident" id="5811670">ServeCodec</span><span class="op" id="5811680">(</span><span class="ident" id="5811681">codec</span>&nbsp;<span class="ident" id="5811687">ServerCodec</span><span class="op" id="5811698">)</span>&nbsp;<span class="op" id="5811700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811703">sending</span>&nbsp;<span class="op" id="5811711">:=</span>&nbsp;<span class="builtinfunc" id="5811714">new</span><span class="op" id="5811717">(</span><span class="ident" id="5811718">sync</span><span class="op" id="5811722">.</span><span class="ident" id="5811723">Mutex</span><span class="op" id="5811728">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5811731">for</span>&nbsp;<span class="op" id="5811735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811739">service</span><span class="op" id="5811746">,</span>&nbsp;<span class="ident" id="5811748">mtype</span><span class="op" id="5811753">,</span>&nbsp;<span class="ident" id="5811755">req</span><span class="op" id="5811758">,</span>&nbsp;<span class="ident" id="5811760">argv</span><span class="op" id="5811764">,</span>&nbsp;<span class="ident" id="5811766">replyv</span><span class="op" id="5811772">,</span>&nbsp;<span class="ident" id="5811774">keepReading</span><span class="op" id="5811785">,</span>&nbsp;<span class="ident" id="5811787">err</span>&nbsp;<span class="op" id="5811791">:=</span>&nbsp;<span class="ident" id="5811794">server</span><span class="op" id="5811800">.</span><span class="ident" id="5811801">readRequest</span><span class="op" id="5811812">(</span><span class="ident" id="5811813">codec</span><span class="op" id="5811818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5811822">if</span>&nbsp;<span class="ident" id="5811825">err</span>&nbsp;<span class="op" id="5811829">!=</span>&nbsp;<span class="builtintype" id="5811832">nil</span>&nbsp;<span class="op" id="5811836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5811841">if</span>&nbsp;<span class="ident" id="5811844">debugLog</span>&nbsp;<span class="op" id="5811853">&amp;&amp;</span>&nbsp;<span class="ident" id="5811856">err</span>&nbsp;<span class="op" id="5811860">!=</span>&nbsp;<span class="ident" id="5811863">io</span><span class="op" id="5811865">.</span><span class="ident" id="5811866">EOF</span>&nbsp;<span class="op" id="5811870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5811876">log</span><span class="op" id="5811879">.</span><span class="ident" id="5811880">Println</span><span class="op" id="5811887">(</span><span class="string" id="5811888">&#34;rpc:&#34;</span><span class="op" id="5811894">,</span>&nbsp;<span class="ident" id="5811896">err</span><span class="op" id="5811899">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5811904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5811909">if</span>&nbsp;<span class="op" id="5811912">!</span><span class="ident" id="5811913">keepReading</span>&nbsp;<span class="op" id="5811925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5811931">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5811940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5811945">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5812008">if</span>&nbsp;<span class="ident" id="5812011">req</span>&nbsp;<span class="op" id="5812015">!=</span>&nbsp;<span class="builtintype" id="5812018">nil</span>&nbsp;<span class="op" id="5812022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812028">server</span><span class="op" id="5812034">.</span><span class="ident" id="5812035">sendResponse</span><span class="op" id="5812047">(</span><span class="ident" id="5812048">sending</span><span class="op" id="5812055">,</span>&nbsp;<span class="ident" id="5812057">req</span><span class="op" id="5812060">,</span>&nbsp;<span class="ident" id="5812062">invalidRequest</span><span class="op" id="5812076">,</span>&nbsp;<span class="ident" id="5812078">codec</span><span class="op" id="5812083">,</span>&nbsp;<span class="ident" id="5812085">err</span><span class="op" id="5812088">.</span><span class="ident" id="5812089">Error</span><span class="op" id="5812094">(</span><span class="op" id="5812095">)</span><span class="op" id="5812096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812102">server</span><span class="op" id="5812108">.</span><span class="ident" id="5812109">freeRequest</span><span class="op" id="5812120">(</span><span class="ident" id="5812121">req</span><span class="op" id="5812124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5812129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5812134">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5812145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5812149">go</span>&nbsp;<span class="ident" id="5812152">service</span><span class="op" id="5812159">.</span><span class="ident" id="5812160">call</span><span class="op" id="5812164">(</span><span class="ident" id="5812165">server</span><span class="op" id="5812171">,</span>&nbsp;<span class="ident" id="5812173">sending</span><span class="op" id="5812180">,</span>&nbsp;<span class="ident" id="5812182">mtype</span><span class="op" id="5812187">,</span>&nbsp;<span class="ident" id="5812189">req</span><span class="op" id="5812192">,</span>&nbsp;<span class="ident" id="5812194">argv</span><span class="op" id="5812198">,</span>&nbsp;<span class="ident" id="5812200">replyv</span><span class="op" id="5812206">,</span>&nbsp;<span class="ident" id="5812208">codec</span><span class="op" id="5812213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5812216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812219">codec</span><span class="op" id="5812224">.</span><span class="ident" id="5812225">Close</span><span class="op" id="5812230">(</span><span class="op" id="5812231">)</span><br>
<span class="lineno"></span><span class="op" id="5812233">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5812236">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5812314">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5812362">func</span>&nbsp;<span class="op" id="5812367">(</span><span class="ident" id="5812368">server</span>&nbsp;<span class="op" id="5812375">*</span><span class="ident" id="5812376">Server</span><span class="op" id="5812382">)</span>&nbsp;<span class="ident" id="5812384">ServeRequest</span><span class="op" id="5812396">(</span><span class="ident" id="5812397">codec</span>&nbsp;<span class="ident" id="5812403">ServerCodec</span><span class="op" id="5812414">)</span>&nbsp;<span class="builtintype" id="5812416">error</span>&nbsp;<span class="op" id="5812422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812425">sending</span>&nbsp;<span class="op" id="5812433">:=</span>&nbsp;<span class="builtinfunc" id="5812436">new</span><span class="op" id="5812439">(</span><span class="ident" id="5812440">sync</span><span class="op" id="5812444">.</span><span class="ident" id="5812445">Mutex</span><span class="op" id="5812450">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812453">service</span><span class="op" id="5812460">,</span>&nbsp;<span class="ident" id="5812462">mtype</span><span class="op" id="5812467">,</span>&nbsp;<span class="ident" id="5812469">req</span><span class="op" id="5812472">,</span>&nbsp;<span class="ident" id="5812474">argv</span><span class="op" id="5812478">,</span>&nbsp;<span class="ident" id="5812480">replyv</span><span class="op" id="5812486">,</span>&nbsp;<span class="ident" id="5812488">keepReading</span><span class="op" id="5812499">,</span>&nbsp;<span class="ident" id="5812501">err</span>&nbsp;<span class="op" id="5812505">:=</span>&nbsp;<span class="ident" id="5812508">server</span><span class="op" id="5812514">.</span><span class="ident" id="5812515">readRequest</span><span class="op" id="5812526">(</span><span class="ident" id="5812527">codec</span><span class="op" id="5812532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5812535">if</span>&nbsp;<span class="ident" id="5812538">err</span>&nbsp;<span class="op" id="5812542">!=</span>&nbsp;<span class="builtintype" id="5812545">nil</span>&nbsp;<span class="op" id="5812549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5812553">if</span>&nbsp;<span class="op" id="5812556">!</span><span class="ident" id="5812557">keepReading</span>&nbsp;<span class="op" id="5812569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5812574">return</span>&nbsp;<span class="ident" id="5812581">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5812587">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5812591">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5812653">if</span>&nbsp;<span class="ident" id="5812656">req</span>&nbsp;<span class="op" id="5812660">!=</span>&nbsp;<span class="builtintype" id="5812663">nil</span>&nbsp;<span class="op" id="5812667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812672">server</span><span class="op" id="5812678">.</span><span class="ident" id="5812679">sendResponse</span><span class="op" id="5812691">(</span><span class="ident" id="5812692">sending</span><span class="op" id="5812699">,</span>&nbsp;<span class="ident" id="5812701">req</span><span class="op" id="5812704">,</span>&nbsp;<span class="ident" id="5812706">invalidRequest</span><span class="op" id="5812720">,</span>&nbsp;<span class="ident" id="5812722">codec</span><span class="op" id="5812727">,</span>&nbsp;<span class="ident" id="5812729">err</span><span class="op" id="5812732">.</span><span class="ident" id="5812733">Error</span><span class="op" id="5812738">(</span><span class="op" id="5812739">)</span><span class="op" id="5812740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812745">server</span><span class="op" id="5812751">.</span><span class="ident" id="5812752">freeRequest</span><span class="op" id="5812763">(</span><span class="ident" id="5812764">req</span><span class="op" id="5812767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5812771">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5812775">return</span>&nbsp;<span class="ident" id="5812782">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5812787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812790">service</span><span class="op" id="5812797">.</span><span class="ident" id="5812798">call</span><span class="op" id="5812802">(</span><span class="ident" id="5812803">server</span><span class="op" id="5812809">,</span>&nbsp;<span class="ident" id="5812811">sending</span><span class="op" id="5812818">,</span>&nbsp;<span class="ident" id="5812820">mtype</span><span class="op" id="5812825">,</span>&nbsp;<span class="ident" id="5812827">req</span><span class="op" id="5812830">,</span>&nbsp;<span class="ident" id="5812832">argv</span><span class="op" id="5812836">,</span>&nbsp;<span class="ident" id="5812838">replyv</span><span class="op" id="5812844">,</span>&nbsp;<span class="ident" id="5812846">codec</span><span class="op" id="5812851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5812854">return</span>&nbsp;<span class="builtintype" id="5812861">nil</span><br>
<span class="lineno"></span><span class="op" id="5812865">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5812868">func</span>&nbsp;<span class="op" id="5812873">(</span><span class="ident" id="5812874">server</span>&nbsp;<span class="op" id="5812881">*</span><span class="ident" id="5812882">Server</span><span class="op" id="5812888">)</span>&nbsp;<span class="ident" id="5812890">getRequest</span><span class="op" id="5812900">(</span><span class="op" id="5812901">)</span>&nbsp;<span class="op" id="5812903">*</span><span class="ident" id="5812904">Request</span>&nbsp;<span class="op" id="5812912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812915">server</span><span class="op" id="5812921">.</span><span class="ident" id="5812922">reqLock</span><span class="op" id="5812929">.</span><span class="ident" id="5812930">Lock</span><span class="op" id="5812934">(</span><span class="op" id="5812935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812938">req</span>&nbsp;<span class="op" id="5812942">:=</span>&nbsp;<span class="ident" id="5812945">server</span><span class="op" id="5812951">.</span><span class="ident" id="5812952">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5812961">if</span>&nbsp;<span class="ident" id="5812964">req</span>&nbsp;<span class="op" id="5812968">==</span>&nbsp;<span class="builtintype" id="5812971">nil</span>&nbsp;<span class="op" id="5812975">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5812979">req</span>&nbsp;<span class="op" id="5812983">=</span>&nbsp;<span class="builtinfunc" id="5812985">new</span><span class="op" id="5812988">(</span><span class="ident" id="5812989">Request</span><span class="op" id="5812996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5812999">}</span>&nbsp;<span class="keyword" id="5813001">else</span>&nbsp;<span class="op" id="5813006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813010">server</span><span class="op" id="5813016">.</span><span class="ident" id="5813017">freeReq</span>&nbsp;<span class="op" id="5813025">=</span>&nbsp;<span class="ident" id="5813027">req</span><span class="op" id="5813030">.</span><span class="ident" id="5813031">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5813038">*</span><span class="ident" id="5813039">req</span>&nbsp;<span class="op" id="5813043">=</span>&nbsp;<span class="ident" id="5813045">Request</span><span class="op" id="5813052">{</span><span class="op" id="5813053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5813056">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813059">server</span><span class="op" id="5813065">.</span><span class="ident" id="5813066">reqLock</span><span class="op" id="5813073">.</span><span class="ident" id="5813074">Unlock</span><span class="op" id="5813080">(</span><span class="op" id="5813081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5813084">return</span>&nbsp;<span class="ident" id="5813091">req</span><br>
<span class="lineno"></span><span class="op" id="5813095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5813098">func</span>&nbsp;<span class="op" id="5813103">(</span><span class="ident" id="5813104">server</span>&nbsp;<span class="op" id="5813111">*</span><span class="ident" id="5813112">Server</span><span class="op" id="5813118">)</span>&nbsp;<span class="ident" id="5813120">freeRequest</span><span class="op" id="5813131">(</span><span class="ident" id="5813132">req</span>&nbsp;<span class="op" id="5813136">*</span><span class="ident" id="5813137">Request</span><span class="op" id="5813144">)</span>&nbsp;<span class="op" id="5813146">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813149">server</span><span class="op" id="5813155">.</span><span class="ident" id="5813156">reqLock</span><span class="op" id="5813163">.</span><span class="ident" id="5813164">Lock</span><span class="op" id="5813168">(</span><span class="op" id="5813169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813172">req</span><span class="op" id="5813175">.</span><span class="ident" id="5813176">next</span>&nbsp;<span class="op" id="5813181">=</span>&nbsp;<span class="ident" id="5813183">server</span><span class="op" id="5813189">.</span><span class="ident" id="5813190">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813199">server</span><span class="op" id="5813205">.</span><span class="ident" id="5813206">freeReq</span>&nbsp;<span class="op" id="5813214">=</span>&nbsp;<span class="ident" id="5813216">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813221">server</span><span class="op" id="5813227">.</span><span class="ident" id="5813228">reqLock</span><span class="op" id="5813235">.</span><span class="ident" id="5813236">Unlock</span><span class="op" id="5813242">(</span><span class="op" id="5813243">)</span><br>
<span class="lineno"></span><span class="op" id="5813245">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="5813248">func</span>&nbsp;<span class="op" id="5813253">(</span><span class="ident" id="5813254">server</span>&nbsp;<span class="op" id="5813261">*</span><span class="ident" id="5813262">Server</span><span class="op" id="5813268">)</span>&nbsp;<span class="ident" id="5813270">getResponse</span><span class="op" id="5813281">(</span><span class="op" id="5813282">)</span>&nbsp;<span class="op" id="5813284">*</span><span class="ident" id="5813285">Response</span>&nbsp;<span class="op" id="5813294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813297">server</span><span class="op" id="5813303">.</span><span class="ident" id="5813304">respLock</span><span class="op" id="5813312">.</span><span class="ident" id="5813313">Lock</span><span class="op" id="5813317">(</span><span class="op" id="5813318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813321">resp</span>&nbsp;<span class="op" id="5813326">:=</span>&nbsp;<span class="ident" id="5813329">server</span><span class="op" id="5813335">.</span><span class="ident" id="5813336">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5813346">if</span>&nbsp;<span class="ident" id="5813349">resp</span>&nbsp;<span class="op" id="5813354">==</span>&nbsp;<span class="builtintype" id="5813357">nil</span>&nbsp;<span class="op" id="5813361">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813365">resp</span>&nbsp;<span class="op" id="5813370">=</span>&nbsp;<span class="builtinfunc" id="5813372">new</span><span class="op" id="5813375">(</span><span class="ident" id="5813376">Response</span><span class="op" id="5813384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5813387">}</span>&nbsp;<span class="keyword" id="5813389">else</span>&nbsp;<span class="op" id="5813394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813398">server</span><span class="op" id="5813404">.</span><span class="ident" id="5813405">freeResp</span>&nbsp;<span class="op" id="5813414">=</span>&nbsp;<span class="ident" id="5813416">resp</span><span class="op" id="5813420">.</span><span class="ident" id="5813421">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5813428">*</span><span class="ident" id="5813429">resp</span>&nbsp;<span class="op" id="5813434">=</span>&nbsp;<span class="ident" id="5813436">Response</span><span class="op" id="5813444">{</span><span class="op" id="5813445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5813448">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813451">server</span><span class="op" id="5813457">.</span><span class="ident" id="5813458">respLock</span><span class="op" id="5813466">.</span><span class="ident" id="5813467">Unlock</span><span class="op" id="5813473">(</span><span class="op" id="5813474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5813477">return</span>&nbsp;<span class="ident" id="5813484">resp</span><br>
<span class="lineno"></span><span class="op" id="5813489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5813492">func</span>&nbsp;<span class="op" id="5813497">(</span><span class="ident" id="5813498">server</span>&nbsp;<span class="op" id="5813505">*</span><span class="ident" id="5813506">Server</span><span class="op" id="5813512">)</span>&nbsp;<span class="ident" id="5813514">freeResponse</span><span class="op" id="5813526">(</span><span class="ident" id="5813527">resp</span>&nbsp;<span class="op" id="5813532">*</span><span class="ident" id="5813533">Response</span><span class="op" id="5813541">)</span>&nbsp;<span class="op" id="5813543">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813546">server</span><span class="op" id="5813552">.</span><span class="ident" id="5813553">respLock</span><span class="op" id="5813561">.</span><span class="ident" id="5813562">Lock</span><span class="op" id="5813566">(</span><span class="op" id="5813567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813570">resp</span><span class="op" id="5813574">.</span><span class="ident" id="5813575">next</span>&nbsp;<span class="op" id="5813580">=</span>&nbsp;<span class="ident" id="5813582">server</span><span class="op" id="5813588">.</span><span class="ident" id="5813589">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813599">server</span><span class="op" id="5813605">.</span><span class="ident" id="5813606">freeResp</span>&nbsp;<span class="op" id="5813615">=</span>&nbsp;<span class="ident" id="5813617">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813623">server</span><span class="op" id="5813629">.</span><span class="ident" id="5813630">respLock</span><span class="op" id="5813638">.</span><span class="ident" id="5813639">Unlock</span><span class="op" id="5813645">(</span><span class="op" id="5813646">)</span><br>
<span class="lineno"></span><span class="op" id="5813648">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="5813651">func</span>&nbsp;<span class="op" id="5813656">(</span><span class="ident" id="5813657">server</span>&nbsp;<span class="op" id="5813664">*</span><span class="ident" id="5813665">Server</span><span class="op" id="5813671">)</span>&nbsp;<span class="ident" id="5813673">readRequest</span><span class="op" id="5813684">(</span><span class="ident" id="5813685">codec</span>&nbsp;<span class="ident" id="5813691">ServerCodec</span><span class="op" id="5813702">)</span>&nbsp;<span class="op" id="5813704">(</span><span class="ident" id="5813705">service</span>&nbsp;<span class="op" id="5813713">*</span><span class="ident" id="5813714">service</span><span class="op" id="5813721">,</span>&nbsp;<span class="ident" id="5813723">mtype</span>&nbsp;<span class="op" id="5813729">*</span><span class="ident" id="5813730">methodType</span><span class="op" id="5813740">,</span>&nbsp;<span class="ident" id="5813742">req</span>&nbsp;<span class="op" id="5813746">*</span><span class="ident" id="5813747">Request</span><span class="op" id="5813754">,</span>&nbsp;<span class="ident" id="5813756">argv</span><span class="op" id="5813760">,</span>&nbsp;<span class="ident" id="5813762">replyv</span>&nbsp;<span class="ident" id="5813769">reflect</span><span class="op" id="5813776">.</span><span class="ident" id="5813777">Value</span><span class="op" id="5813782">,</span>&nbsp;<span class="ident" id="5813784">keepReading</span>&nbsp;<span class="builtintype" id="5813796">bool</span><span class="op" id="5813800">,</span>&nbsp;<span class="ident" id="5813802">err</span>&nbsp;<span class="builtintype" id="5813806">error</span><span class="op" id="5813811">)</span>&nbsp;<span class="op" id="5813813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813816">service</span><span class="op" id="5813823">,</span>&nbsp;<span class="ident" id="5813825">mtype</span><span class="op" id="5813830">,</span>&nbsp;<span class="ident" id="5813832">req</span><span class="op" id="5813835">,</span>&nbsp;<span class="ident" id="5813837">keepReading</span><span class="op" id="5813848">,</span>&nbsp;<span class="ident" id="5813850">err</span>&nbsp;<span class="op" id="5813854">=</span>&nbsp;<span class="ident" id="5813856">server</span><span class="op" id="5813862">.</span><span class="ident" id="5813863">readRequestHeader</span><span class="op" id="5813880">(</span><span class="ident" id="5813881">codec</span><span class="op" id="5813886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5813889">if</span>&nbsp;<span class="ident" id="5813892">err</span>&nbsp;<span class="op" id="5813896">!=</span>&nbsp;<span class="builtintype" id="5813899">nil</span>&nbsp;<span class="op" id="5813903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5813907">if</span>&nbsp;<span class="op" id="5813910">!</span><span class="ident" id="5813911">keepReading</span>&nbsp;<span class="op" id="5813923">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5813928">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5813937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5813941">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5813959">codec</span><span class="op" id="5813964">.</span><span class="ident" id="5813965">ReadRequestBody</span><span class="op" id="5813980">(</span><span class="builtintype" id="5813981">nil</span><span class="op" id="5813984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5813988">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5813996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5814000">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5814031">argIsValue</span>&nbsp;<span class="op" id="5814042">:=</span>&nbsp;<span class="builtintype" id="5814045">false</span>&nbsp;<span class="comment" id="5814051">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5814097">if</span>&nbsp;<span class="ident" id="5814100">mtype</span><span class="op" id="5814105">.</span><span class="ident" id="5814106">ArgType</span><span class="op" id="5814113">.</span><span class="ident" id="5814114">Kind</span><span class="op" id="5814118">(</span><span class="op" id="5814119">)</span>&nbsp;<span class="op" id="5814121">==</span>&nbsp;<span class="ident" id="5814124">reflect</span><span class="op" id="5814131">.</span><span class="ident" id="5814132">Ptr</span>&nbsp;<span class="op" id="5814136">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5814140">argv</span>&nbsp;<span class="op" id="5814145">=</span>&nbsp;<span class="ident" id="5814147">reflect</span><span class="op" id="5814154">.</span><span class="ident" id="5814155">New</span><span class="op" id="5814158">(</span><span class="ident" id="5814159">mtype</span><span class="op" id="5814164">.</span><span class="ident" id="5814165">ArgType</span><span class="op" id="5814172">.</span><span class="ident" id="5814173">Elem</span><span class="op" id="5814177">(</span><span class="op" id="5814178">)</span><span class="op" id="5814179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5814182">}</span>&nbsp;<span class="keyword" id="5814184">else</span>&nbsp;<span class="op" id="5814189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5814193">argv</span>&nbsp;<span class="op" id="5814198">=</span>&nbsp;<span class="ident" id="5814200">reflect</span><span class="op" id="5814207">.</span><span class="ident" id="5814208">New</span><span class="op" id="5814211">(</span><span class="ident" id="5814212">mtype</span><span class="op" id="5814217">.</span><span class="ident" id="5814218">ArgType</span><span class="op" id="5814225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5814229">argIsValue</span>&nbsp;<span class="op" id="5814240">=</span>&nbsp;<span class="builtintype" id="5814242">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5814248">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5814251">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5814292">if</span>&nbsp;<span class="ident" id="5814295">err</span>&nbsp;<span class="op" id="5814299">=</span>&nbsp;<span class="ident" id="5814301">codec</span><span class="op" id="5814306">.</span><span class="ident" id="5814307">ReadRequestBody</span><span class="op" id="5814322">(</span><span class="ident" id="5814323">argv</span><span class="op" id="5814327">.</span><span class="ident" id="5814328">Interface</span><span class="op" id="5814337">(</span><span class="op" id="5814338">)</span><span class="op" id="5814339">)</span><span class="op" id="5814340">;</span>&nbsp;<span class="ident" id="5814342">err</span>&nbsp;<span class="op" id="5814346">!=</span>&nbsp;<span class="builtintype" id="5814349">nil</span>&nbsp;<span class="op" id="5814353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5814357">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5814365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5814368">if</span>&nbsp;<span class="ident" id="5814371">argIsValue</span>&nbsp;<span class="op" id="5814382">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5814386">argv</span>&nbsp;<span class="op" id="5814391">=</span>&nbsp;<span class="ident" id="5814393">argv</span><span class="op" id="5814397">.</span><span class="ident" id="5814398">Elem</span><span class="op" id="5814402">(</span><span class="op" id="5814403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5814406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5814410">replyv</span>&nbsp;<span class="op" id="5814417">=</span>&nbsp;<span class="ident" id="5814419">reflect</span><span class="op" id="5814426">.</span><span class="ident" id="5814427">New</span><span class="op" id="5814430">(</span><span class="ident" id="5814431">mtype</span><span class="op" id="5814436">.</span><span class="ident" id="5814437">ReplyType</span><span class="op" id="5814446">.</span><span class="ident" id="5814447">Elem</span><span class="op" id="5814451">(</span><span class="op" id="5814452">)</span><span class="op" id="5814453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5814456">return</span><br>
<span class="lineno">570</span><span class="op" id="5814463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5814466">func</span>&nbsp;<span class="op" id="5814471">(</span><span class="ident" id="5814472">server</span>&nbsp;<span class="op" id="5814479">*</span><span class="ident" id="5814480">Server</span><span class="op" id="5814486">)</span>&nbsp;<span class="ident" id="5814488">readRequestHeader</span><span class="op" id="5814505">(</span><span class="ident" id="5814506">codec</span>&nbsp;<span class="ident" id="5814512">ServerCodec</span><span class="op" id="5814523">)</span>&nbsp;<span class="op" id="5814525">(</span><span class="ident" id="5814526">service</span>&nbsp;<span class="op" id="5814534">*</span><span class="ident" id="5814535">service</span><span class="op" id="5814542">,</span>&nbsp;<span class="ident" id="5814544">mtype</span>&nbsp;<span class="op" id="5814550">*</span><span class="ident" id="5814551">methodType</span><span class="op" id="5814561">,</span>&nbsp;<span class="ident" id="5814563">req</span>&nbsp;<span class="op" id="5814567">*</span><span class="ident" id="5814568">Request</span><span class="op" id="5814575">,</span>&nbsp;<span class="ident" id="5814577">keepReading</span>&nbsp;<span class="builtintype" id="5814589">bool</span><span class="op" id="5814593">,</span>&nbsp;<span class="ident" id="5814595">err</span>&nbsp;<span class="builtintype" id="5814599">error</span><span class="op" id="5814604">)</span>&nbsp;<span class="op" id="5814606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5814609">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5814638">req</span>&nbsp;<span class="op" id="5814642">=</span>&nbsp;<span class="ident" id="5814644">server</span><span class="op" id="5814650">.</span><span class="ident" id="5814651">getRequest</span><span class="op" id="5814661">(</span><span class="op" id="5814662">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5814665">err</span>&nbsp;<span class="op" id="5814669">=</span>&nbsp;<span class="ident" id="5814671">codec</span><span class="op" id="5814676">.</span><span class="ident" id="5814677">ReadRequestHeader</span><span class="op" id="5814694">(</span><span class="ident" id="5814695">req</span><span class="op" id="5814698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5814701">if</span>&nbsp;<span class="ident" id="5814704">err</span>&nbsp;<span class="op" id="5814708">!=</span>&nbsp;<span class="builtintype" id="5814711">nil</span>&nbsp;<span class="op" id="5814715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5814719">req</span>&nbsp;<span class="op" id="5814723">=</span>&nbsp;<span class="builtintype" id="5814725">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5814731">if</span>&nbsp;<span class="ident" id="5814734">err</span>&nbsp;<span class="op" id="5814738">==</span>&nbsp;<span class="ident" id="5814741">io</span><span class="op" id="5814743">.</span><span class="ident" id="5814744">EOF</span>&nbsp;<span class="op" id="5814748">||</span>&nbsp;<span class="ident" id="5814751">err</span>&nbsp;<span class="op" id="5814755">==</span>&nbsp;<span class="ident" id="5814758">io</span><span class="op" id="5814760">.</span><span class="ident" id="5814761">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5814778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5814783">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5814792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5814796">err</span>&nbsp;<span class="op" id="5814800">=</span>&nbsp;<span class="ident" id="5814802">errors</span><span class="op" id="5814808">.</span><span class="ident" id="5814809">New</span><span class="op" id="5814812">(</span><span class="string" id="5814813">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="5814851">+</span>&nbsp;<span class="ident" id="5814853">err</span><span class="op" id="5814856">.</span><span class="ident" id="5814857">Error</span><span class="op" id="5814862">(</span><span class="op" id="5814863">)</span><span class="op" id="5814864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5814868">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5814876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5814880">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5814942">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815000">keepReading</span>&nbsp;<span class="op" id="5815012">=</span>&nbsp;<span class="builtintype" id="5815014">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815021">dot</span>&nbsp;<span class="op" id="5815025">:=</span>&nbsp;<span class="ident" id="5815028">strings</span><span class="op" id="5815035">.</span><span class="ident" id="5815036">LastIndex</span><span class="op" id="5815045">(</span><span class="ident" id="5815046">req</span><span class="op" id="5815049">.</span><span class="ident" id="5815050">ServiceMethod</span><span class="op" id="5815063">,</span>&nbsp;<span class="string" id="5815065">&#34;.&#34;</span><span class="op" id="5815068">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5815071">if</span>&nbsp;<span class="ident" id="5815074">dot</span>&nbsp;<span class="op" id="5815078">&lt;</span>&nbsp;<span class="num" id="5815080">0</span>&nbsp;<span class="op" id="5815082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815086">err</span>&nbsp;<span class="op" id="5815090">=</span>&nbsp;<span class="ident" id="5815092">errors</span><span class="op" id="5815098">.</span><span class="ident" id="5815099">New</span><span class="op" id="5815102">(</span><span class="string" id="5815103">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="5815146">+</span>&nbsp;<span class="ident" id="5815148">req</span><span class="op" id="5815151">.</span><span class="ident" id="5815152">ServiceMethod</span><span class="op" id="5815165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5815169">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5815177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815180">serviceName</span>&nbsp;<span class="op" id="5815192">:=</span>&nbsp;<span class="ident" id="5815195">req</span><span class="op" id="5815198">.</span><span class="ident" id="5815199">ServiceMethod</span><span class="op" id="5815212">[</span><span class="op" id="5815213">:</span><span class="ident" id="5815214">dot</span><span class="op" id="5815217">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815220">methodName</span>&nbsp;<span class="op" id="5815231">:=</span>&nbsp;<span class="ident" id="5815234">req</span><span class="op" id="5815237">.</span><span class="ident" id="5815238">ServiceMethod</span><span class="op" id="5815251">[</span><span class="ident" id="5815252">dot</span><span class="op" id="5815255">+</span><span class="num" id="5815256">1</span><span class="op" id="5815257">:</span><span class="op" id="5815258">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5815262">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815287">server</span><span class="op" id="5815293">.</span><span class="ident" id="5815294">mu</span><span class="op" id="5815296">.</span><span class="ident" id="5815297">RLock</span><span class="op" id="5815302">(</span><span class="op" id="5815303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815306">service</span>&nbsp;<span class="op" id="5815314">=</span>&nbsp;<span class="ident" id="5815316">server</span><span class="op" id="5815322">.</span><span class="ident" id="5815323">serviceMap</span><span class="op" id="5815333">[</span><span class="ident" id="5815334">serviceName</span><span class="op" id="5815345">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815348">server</span><span class="op" id="5815354">.</span><span class="ident" id="5815355">mu</span><span class="op" id="5815357">.</span><span class="ident" id="5815358">RUnlock</span><span class="op" id="5815365">(</span><span class="op" id="5815366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5815369">if</span>&nbsp;<span class="ident" id="5815372">service</span>&nbsp;<span class="op" id="5815380">==</span>&nbsp;<span class="builtintype" id="5815383">nil</span>&nbsp;<span class="op" id="5815387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815391">err</span>&nbsp;<span class="op" id="5815395">=</span>&nbsp;<span class="ident" id="5815397">errors</span><span class="op" id="5815403">.</span><span class="ident" id="5815404">New</span><span class="op" id="5815407">(</span><span class="string" id="5815408">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="5815435">+</span>&nbsp;<span class="ident" id="5815437">req</span><span class="op" id="5815440">.</span><span class="ident" id="5815441">ServiceMethod</span><span class="op" id="5815454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5815458">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5815466">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815469">mtype</span>&nbsp;<span class="op" id="5815475">=</span>&nbsp;<span class="ident" id="5815477">service</span><span class="op" id="5815484">.</span><span class="ident" id="5815485">method</span><span class="op" id="5815491">[</span><span class="ident" id="5815492">methodName</span><span class="op" id="5815502">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5815505">if</span>&nbsp;<span class="ident" id="5815508">mtype</span>&nbsp;<span class="op" id="5815514">==</span>&nbsp;<span class="builtintype" id="5815517">nil</span>&nbsp;<span class="op" id="5815521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815525">err</span>&nbsp;<span class="op" id="5815529">=</span>&nbsp;<span class="ident" id="5815531">errors</span><span class="op" id="5815537">.</span><span class="ident" id="5815538">New</span><span class="op" id="5815541">(</span><span class="string" id="5815542">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="5815568">+</span>&nbsp;<span class="ident" id="5815570">req</span><span class="op" id="5815573">.</span><span class="ident" id="5815574">ServiceMethod</span><span class="op" id="5815587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5815590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5815593">return</span><br>
<span class="lineno">610</span><span class="op" id="5815600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5815603">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5815669">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="5815739">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="5815772">func</span>&nbsp;<span class="op" id="5815777">(</span><span class="ident" id="5815778">server</span>&nbsp;<span class="op" id="5815785">*</span><span class="ident" id="5815786">Server</span><span class="op" id="5815792">)</span>&nbsp;<span class="ident" id="5815794">Accept</span><span class="op" id="5815800">(</span><span class="ident" id="5815801">lis</span>&nbsp;<span class="ident" id="5815805">net</span><span class="op" id="5815808">.</span><span class="ident" id="5815809">Listener</span><span class="op" id="5815817">)</span>&nbsp;<span class="op" id="5815819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5815822">for</span>&nbsp;<span class="op" id="5815826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815830">conn</span><span class="op" id="5815834">,</span>&nbsp;<span class="ident" id="5815836">err</span>&nbsp;<span class="op" id="5815840">:=</span>&nbsp;<span class="ident" id="5815843">lis</span><span class="op" id="5815846">.</span><span class="ident" id="5815847">Accept</span><span class="op" id="5815853">(</span><span class="op" id="5815854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5815858">if</span>&nbsp;<span class="ident" id="5815861">err</span>&nbsp;<span class="op" id="5815865">!=</span>&nbsp;<span class="builtintype" id="5815868">nil</span>&nbsp;<span class="op" id="5815872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5815877">log</span><span class="op" id="5815880">.</span><span class="ident" id="5815881">Fatal</span><span class="op" id="5815886">(</span><span class="string" id="5815887">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="5815907">,</span>&nbsp;<span class="ident" id="5815909">err</span><span class="op" id="5815912">.</span><span class="ident" id="5815913">Error</span><span class="op" id="5815918">(</span><span class="op" id="5815919">)</span><span class="op" id="5815920">)</span>&nbsp;<span class="comment" id="5815922">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5815942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5815946">go</span>&nbsp;<span class="ident" id="5815949">server</span><span class="op" id="5815955">.</span><span class="ident" id="5815956">ServeConn</span><span class="op" id="5815965">(</span><span class="ident" id="5815966">conn</span><span class="op" id="5815970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5815973">}</span><br>
<span class="lineno"></span><span class="op" id="5815975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="5815978">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5816045">func</span>&nbsp;<span class="ident" id="5816050">Register</span><span class="op" id="5816058">(</span><span class="ident" id="5816059">rcvr</span>&nbsp;<span class="keyword" id="5816064">interface</span><span class="op" id="5816073">{</span><span class="op" id="5816074">}</span><span class="op" id="5816075">)</span>&nbsp;<span class="builtintype" id="5816077">error</span>&nbsp;<span class="op" id="5816083">{</span>&nbsp;<span class="keyword" id="5816085">return</span>&nbsp;<span class="ident" id="5816092">DefaultServer</span><span class="op" id="5816105">.</span><span class="ident" id="5816106">Register</span><span class="op" id="5816114">(</span><span class="ident" id="5816115">rcvr</span><span class="op" id="5816119">)</span>&nbsp;<span class="op" id="5816121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5816124">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5816197">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="5816241">func</span>&nbsp;<span class="ident" id="5816246">RegisterName</span><span class="op" id="5816258">(</span><span class="ident" id="5816259">name</span>&nbsp;<span class="builtintype" id="5816264">string</span><span class="op" id="5816270">,</span>&nbsp;<span class="ident" id="5816272">rcvr</span>&nbsp;<span class="keyword" id="5816277">interface</span><span class="op" id="5816286">{</span><span class="op" id="5816287">}</span><span class="op" id="5816288">)</span>&nbsp;<span class="builtintype" id="5816290">error</span>&nbsp;<span class="op" id="5816296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5816299">return</span>&nbsp;<span class="ident" id="5816306">DefaultServer</span><span class="op" id="5816319">.</span><span class="ident" id="5816320">RegisterName</span><span class="op" id="5816332">(</span><span class="ident" id="5816333">name</span><span class="op" id="5816337">,</span>&nbsp;<span class="ident" id="5816339">rcvr</span><span class="op" id="5816343">)</span><br>
<span class="lineno"></span><span class="op" id="5816345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5816348">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="5816415">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="5816471">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="5816538">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5816609">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5816682">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="5816738">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5816809">type</span>&nbsp;<span class="ident" id="5816814">ServerCodec</span>&nbsp;<span class="keyword" id="5816826">interface</span>&nbsp;<span class="op" id="5816836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5816839">ReadRequestHeader</span><span class="op" id="5816856">(</span><span class="op" id="5816857">*</span><span class="ident" id="5816858">Request</span><span class="op" id="5816865">)</span>&nbsp;<span class="builtintype" id="5816867">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5816874">ReadRequestBody</span><span class="op" id="5816889">(</span><span class="keyword" id="5816890">interface</span><span class="op" id="5816899">{</span><span class="op" id="5816900">}</span><span class="op" id="5816901">)</span>&nbsp;<span class="builtintype" id="5816903">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5816910">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5816984">WriteResponse</span><span class="op" id="5816997">(</span><span class="op" id="5816998">*</span><span class="ident" id="5816999">Response</span><span class="op" id="5817007">,</span>&nbsp;<span class="keyword" id="5817009">interface</span><span class="op" id="5817018">{</span><span class="op" id="5817019">}</span><span class="op" id="5817020">)</span>&nbsp;<span class="builtintype" id="5817022">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5817030">Close</span><span class="op" id="5817035">(</span><span class="op" id="5817036">)</span>&nbsp;<span class="builtintype" id="5817038">error</span><br>
<span class="lineno"></span><span class="op" id="5817044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="5817047">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5817107">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5817178">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5817239">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5817302">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="5817361">func</span>&nbsp;<span class="ident" id="5817366">ServeConn</span><span class="op" id="5817375">(</span><span class="ident" id="5817376">conn</span>&nbsp;<span class="ident" id="5817381">io</span><span class="op" id="5817383">.</span><span class="ident" id="5817384">ReadWriteCloser</span><span class="op" id="5817399">)</span>&nbsp;<span class="op" id="5817401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5817404">DefaultServer</span><span class="op" id="5817417">.</span><span class="ident" id="5817418">ServeConn</span><span class="op" id="5817427">(</span><span class="ident" id="5817428">conn</span><span class="op" id="5817432">)</span><br>
<span class="lineno"></span><span class="op" id="5817434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5817437">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="5817501">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5817542">func</span>&nbsp;<span class="ident" id="5817547">ServeCodec</span><span class="op" id="5817557">(</span><span class="ident" id="5817558">codec</span>&nbsp;<span class="ident" id="5817564">ServerCodec</span><span class="op" id="5817575">)</span>&nbsp;<span class="op" id="5817577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5817580">DefaultServer</span><span class="op" id="5817593">.</span><span class="ident" id="5817594">ServeCodec</span><span class="op" id="5817604">(</span><span class="ident" id="5817605">codec</span><span class="op" id="5817610">)</span><br>
<span class="lineno"></span><span class="op" id="5817612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="5817615">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5817693">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5817741">func</span>&nbsp;<span class="ident" id="5817746">ServeRequest</span><span class="op" id="5817758">(</span><span class="ident" id="5817759">codec</span>&nbsp;<span class="ident" id="5817765">ServerCodec</span><span class="op" id="5817776">)</span>&nbsp;<span class="builtintype" id="5817778">error</span>&nbsp;<span class="op" id="5817784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5817787">return</span>&nbsp;<span class="ident" id="5817794">DefaultServer</span><span class="op" id="5817807">.</span><span class="ident" id="5817808">ServeRequest</span><span class="op" id="5817820">(</span><span class="ident" id="5817821">codec</span><span class="op" id="5817826">)</span><br>
<span class="lineno"></span><span class="op" id="5817828">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="5817831">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5817897">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5817947">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5818016">func</span>&nbsp;<span class="ident" id="5818021">Accept</span><span class="op" id="5818027">(</span><span class="ident" id="5818028">lis</span>&nbsp;<span class="ident" id="5818032">net</span><span class="op" id="5818035">.</span><span class="ident" id="5818036">Listener</span><span class="op" id="5818044">)</span>&nbsp;<span class="op" id="5818046">{</span>&nbsp;<span class="ident" id="5818048">DefaultServer</span><span class="op" id="5818061">.</span><span class="ident" id="5818062">Accept</span><span class="op" id="5818068">(</span><span class="ident" id="5818069">lis</span><span class="op" id="5818072">)</span>&nbsp;<span class="op" id="5818074">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="5818077">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="5818138">var</span>&nbsp;<span class="ident" id="5818142">connected</span>&nbsp;<span class="op" id="5818152">=</span>&nbsp;<span class="string" id="5818154">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5818181">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="5818248">func</span>&nbsp;<span class="op" id="5818253">(</span><span class="ident" id="5818254">server</span>&nbsp;<span class="op" id="5818261">*</span><span class="ident" id="5818262">Server</span><span class="op" id="5818268">)</span>&nbsp;<span class="ident" id="5818270">ServeHTTP</span><span class="op" id="5818279">(</span><span class="ident" id="5818280">w</span>&nbsp;<span class="ident" id="5818282">http</span><span class="op" id="5818286">.</span><span class="ident" id="5818287">ResponseWriter</span><span class="op" id="5818301">,</span>&nbsp;<span class="ident" id="5818303">req</span>&nbsp;<span class="op" id="5818307">*</span><span class="ident" id="5818308">http</span><span class="op" id="5818312">.</span><span class="ident" id="5818313">Request</span><span class="op" id="5818320">)</span>&nbsp;<span class="op" id="5818322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5818325">if</span>&nbsp;<span class="ident" id="5818328">req</span><span class="op" id="5818331">.</span><span class="ident" id="5818332">Method</span>&nbsp;<span class="op" id="5818339">!=</span>&nbsp;<span class="string" id="5818342">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="5818352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5818356">w</span><span class="op" id="5818357">.</span><span class="ident" id="5818358">Header</span><span class="op" id="5818364">(</span><span class="op" id="5818365">)</span><span class="op" id="5818366">.</span><span class="ident" id="5818367">Set</span><span class="op" id="5818370">(</span><span class="string" id="5818371">&#34;Content-Type&#34;</span><span class="op" id="5818385">,</span>&nbsp;<span class="string" id="5818387">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="5818414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5818418">w</span><span class="op" id="5818419">.</span><span class="ident" id="5818420">WriteHeader</span><span class="op" id="5818431">(</span><span class="ident" id="5818432">http</span><span class="op" id="5818436">.</span><span class="ident" id="5818437">StatusMethodNotAllowed</span><span class="op" id="5818459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5818463">io</span><span class="op" id="5818465">.</span><span class="ident" id="5818466">WriteString</span><span class="op" id="5818477">(</span><span class="ident" id="5818478">w</span><span class="op" id="5818479">,</span>&nbsp;<span class="string" id="5818481">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="5818501">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5818505">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5818513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5818516">conn</span><span class="op" id="5818520">,</span>&nbsp;<span class="ident" id="5818522">_</span><span class="op" id="5818523">,</span>&nbsp;<span class="ident" id="5818525">err</span>&nbsp;<span class="op" id="5818529">:=</span>&nbsp;<span class="ident" id="5818532">w</span><span class="op" id="5818533">.</span><span class="op" id="5818534">(</span><span class="ident" id="5818535">http</span><span class="op" id="5818539">.</span><span class="ident" id="5818540">Hijacker</span><span class="op" id="5818548">)</span><span class="op" id="5818549">.</span><span class="ident" id="5818550">Hijack</span><span class="op" id="5818556">(</span><span class="op" id="5818557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5818560">if</span>&nbsp;<span class="ident" id="5818563">err</span>&nbsp;<span class="op" id="5818567">!=</span>&nbsp;<span class="builtintype" id="5818570">nil</span>&nbsp;<span class="op" id="5818574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5818578">log</span><span class="op" id="5818581">.</span><span class="ident" id="5818582">Print</span><span class="op" id="5818587">(</span><span class="string" id="5818588">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="5818604">,</span>&nbsp;<span class="ident" id="5818606">req</span><span class="op" id="5818609">.</span><span class="ident" id="5818610">RemoteAddr</span><span class="op" id="5818620">,</span>&nbsp;<span class="string" id="5818622">&#34;:&nbsp;&#34;</span><span class="op" id="5818626">,</span>&nbsp;<span class="ident" id="5818628">err</span><span class="op" id="5818631">.</span><span class="ident" id="5818632">Error</span><span class="op" id="5818637">(</span><span class="op" id="5818638">)</span><span class="op" id="5818639">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5818643">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5818651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5818654">io</span><span class="op" id="5818656">.</span><span class="ident" id="5818657">WriteString</span><span class="op" id="5818668">(</span><span class="ident" id="5818669">conn</span><span class="op" id="5818673">,</span>&nbsp;<span class="string" id="5818675">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="5818686">+</span><span class="ident" id="5818687">connected</span><span class="op" id="5818696">+</span><span class="string" id="5818697">&#34;\n\n&#34;</span><span class="op" id="5818703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5818706">server</span><span class="op" id="5818712">.</span><span class="ident" id="5818713">ServeConn</span><span class="op" id="5818722">(</span><span class="ident" id="5818723">conn</span><span class="op" id="5818727">)</span><br>
<span class="lineno"></span><span class="op" id="5818729">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="5818732">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="5818801">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5818842">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5818920">func</span>&nbsp;<span class="op" id="5818925">(</span><span class="ident" id="5818926">server</span>&nbsp;<span class="op" id="5818933">*</span><span class="ident" id="5818934">Server</span><span class="op" id="5818940">)</span>&nbsp;<span class="ident" id="5818942">HandleHTTP</span><span class="op" id="5818952">(</span><span class="ident" id="5818953">rpcPath</span><span class="op" id="5818960">,</span>&nbsp;<span class="ident" id="5818962">debugPath</span>&nbsp;<span class="builtintype" id="5818972">string</span><span class="op" id="5818978">)</span>&nbsp;<span class="op" id="5818980">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5818983">http</span><span class="op" id="5818987">.</span><span class="ident" id="5818988">Handle</span><span class="op" id="5818994">(</span><span class="ident" id="5818995">rpcPath</span><span class="op" id="5819002">,</span>&nbsp;<span class="ident" id="5819004">server</span><span class="op" id="5819010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5819013">http</span><span class="op" id="5819017">.</span><span class="ident" id="5819018">Handle</span><span class="op" id="5819024">(</span><span class="ident" id="5819025">debugPath</span><span class="op" id="5819034">,</span>&nbsp;<span class="ident" id="5819036">debugHTTP</span><span class="op" id="5819045">{</span><span class="ident" id="5819046">server</span><span class="op" id="5819052">}</span><span class="op" id="5819053">)</span><br>
<span class="lineno"></span><span class="op" id="5819055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5819058">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="5819132">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5819198">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5819276">func</span>&nbsp;<span class="ident" id="5819281">HandleHTTP</span><span class="op" id="5819291">(</span><span class="op" id="5819292">)</span>&nbsp;<span class="op" id="5819294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5819297">DefaultServer</span><span class="op" id="5819310">.</span><span class="ident" id="5819311">HandleHTTP</span><span class="op" id="5819321">(</span><span class="ident" id="5819322">DefaultRPCPath</span><span class="op" id="5819336">,</span>&nbsp;<span class="ident" id="5819338">DefaultDebugPath</span><span class="op" id="5819354">)</span><br>
<span class="lineno"></span><span class="op" id="5819356">}</span>
</div>
</body>
</html>
