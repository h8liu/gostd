<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2372152">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2372207">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2372261">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2372312">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2372377">//&nbsp;Fork,&nbsp;exec,&nbsp;wait,&nbsp;etc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2372404">package</span>&nbsp;<span class="ident" id="2372412">syscall</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="2372421">import</span>&nbsp;<span class="op" id="2372428">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2372431">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2372442">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2372450">&#34;unsafe&#34;</span><br>
<span class="lineno">15</span><span class="op" id="2372459">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2372462">//&nbsp;Lock&nbsp;synchronizing&nbsp;creation&nbsp;of&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;with&nbsp;fork.</span><br>
<span class="lineno"></span><span class="comment" id="2372528">//</span><br>
<span class="lineno"></span><span class="comment" id="2372531">//&nbsp;We&nbsp;want&nbsp;the&nbsp;child&nbsp;in&nbsp;a&nbsp;fork/exec&nbsp;sequence&nbsp;to&nbsp;inherit&nbsp;only&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="2372596">//&nbsp;file&nbsp;descriptors&nbsp;we&nbsp;intend.&nbsp;&nbsp;To&nbsp;do&nbsp;that,&nbsp;we&nbsp;mark&nbsp;all&nbsp;file</span><br>
<span class="lineno"></span><span class="comment" id="2372657">//&nbsp;descriptors&nbsp;close-on-exec&nbsp;and&nbsp;then,&nbsp;in&nbsp;the&nbsp;child,&nbsp;explicitly</span><br>
<span class="lineno"></span><span class="comment" id="2372721">//&nbsp;unmark&nbsp;the&nbsp;ones&nbsp;we&nbsp;want&nbsp;the&nbsp;exec&#39;ed&nbsp;program&nbsp;to&nbsp;keep.</span><br>
<span class="lineno"></span><span class="comment" id="2372777">//&nbsp;Unix&nbsp;doesn&#39;t&nbsp;make&nbsp;this&nbsp;easy:&nbsp;there&nbsp;is,&nbsp;in&nbsp;general,&nbsp;no&nbsp;way&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2372841">//&nbsp;allocate&nbsp;a&nbsp;new&nbsp;file&nbsp;descriptor&nbsp;close-on-exec.&nbsp;&nbsp;Instead&nbsp;you</span><br>
<span class="lineno">25</span><span class="comment" id="2372903">//&nbsp;have&nbsp;to&nbsp;allocate&nbsp;the&nbsp;descriptor&nbsp;and&nbsp;then&nbsp;mark&nbsp;it&nbsp;close-on-exec.</span><br>
<span class="lineno"></span><span class="comment" id="2372970">//&nbsp;If&nbsp;a&nbsp;fork&nbsp;happens&nbsp;between&nbsp;those&nbsp;two&nbsp;events,&nbsp;the&nbsp;child&#39;s&nbsp;exec</span><br>
<span class="lineno"></span><span class="comment" id="2373034">//&nbsp;will&nbsp;inherit&nbsp;an&nbsp;unwanted&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="comment" id="2373079">//</span><br>
<span class="lineno"></span><span class="comment" id="2373082">//&nbsp;This&nbsp;lock&nbsp;solves&nbsp;that&nbsp;race:&nbsp;the&nbsp;create&nbsp;new&nbsp;fd/mark&nbsp;close-on-exec</span><br>
<span class="lineno">30</span><span class="comment" id="2373150">//&nbsp;operation&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;reading,&nbsp;and&nbsp;the&nbsp;fork&nbsp;itself</span><br>
<span class="lineno"></span><span class="comment" id="2373221">//&nbsp;is&nbsp;done&nbsp;holding&nbsp;ForkLock&nbsp;for&nbsp;writing.&nbsp;&nbsp;At&nbsp;least,&nbsp;that&#39;s&nbsp;the&nbsp;idea.</span><br>
<span class="lineno"></span><span class="comment" id="2373290">//&nbsp;There&nbsp;are&nbsp;some&nbsp;complications.</span><br>
<span class="lineno"></span><span class="comment" id="2373323">//</span><br>
<span class="lineno"></span><span class="comment" id="2373326">//&nbsp;Some&nbsp;system&nbsp;calls&nbsp;that&nbsp;create&nbsp;new&nbsp;file&nbsp;descriptors&nbsp;can&nbsp;block</span><br>
<span class="lineno">35</span><span class="comment" id="2373390">//&nbsp;for&nbsp;arbitrarily&nbsp;long&nbsp;times:&nbsp;open&nbsp;on&nbsp;a&nbsp;hung&nbsp;NFS&nbsp;server&nbsp;or&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="2373456">//&nbsp;pipe,&nbsp;accept&nbsp;on&nbsp;a&nbsp;socket,&nbsp;and&nbsp;so&nbsp;on.&nbsp;&nbsp;We&nbsp;can&#39;t&nbsp;reasonably&nbsp;grab</span><br>
<span class="lineno"></span><span class="comment" id="2373522">//&nbsp;the&nbsp;lock&nbsp;across&nbsp;those&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="2373559">//</span><br>
<span class="lineno"></span><span class="comment" id="2373562">//&nbsp;It&nbsp;is&nbsp;worse&nbsp;to&nbsp;inherit&nbsp;some&nbsp;file&nbsp;descriptors&nbsp;than&nbsp;others.</span><br>
<span class="lineno">40</span><span class="comment" id="2373623">//&nbsp;If&nbsp;a&nbsp;non-malicious&nbsp;child&nbsp;accidentally&nbsp;inherits&nbsp;an&nbsp;open&nbsp;ordinary&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="2373696">//&nbsp;that&#39;s&nbsp;not&nbsp;a&nbsp;big&nbsp;deal.&nbsp;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;if&nbsp;a&nbsp;long-lived&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="2373764">//&nbsp;accidentally&nbsp;inherits&nbsp;the&nbsp;write&nbsp;end&nbsp;of&nbsp;a&nbsp;pipe,&nbsp;then&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span><span class="comment" id="2373830">//&nbsp;of&nbsp;that&nbsp;pipe&nbsp;will&nbsp;not&nbsp;see&nbsp;EOF&nbsp;until&nbsp;that&nbsp;child&nbsp;exits,&nbsp;potentially</span><br>
<span class="lineno"></span><span class="comment" id="2373899">//&nbsp;causing&nbsp;the&nbsp;parent&nbsp;program&nbsp;to&nbsp;hang.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;common&nbsp;problem</span><br>
<span class="lineno">45</span><span class="comment" id="2373964">//&nbsp;in&nbsp;threaded&nbsp;C&nbsp;programs&nbsp;that&nbsp;use&nbsp;popen.</span><br>
<span class="lineno"></span><span class="comment" id="2374006">//</span><br>
<span class="lineno"></span><span class="comment" id="2374009">//&nbsp;Luckily,&nbsp;the&nbsp;file&nbsp;descriptors&nbsp;that&nbsp;are&nbsp;most&nbsp;important&nbsp;not&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2374073">//&nbsp;inherit&nbsp;are&nbsp;not&nbsp;the&nbsp;ones&nbsp;that&nbsp;can&nbsp;take&nbsp;an&nbsp;arbitrarily&nbsp;long&nbsp;time</span><br>
<span class="lineno"></span><span class="comment" id="2374140">//&nbsp;to&nbsp;create:&nbsp;pipe&nbsp;returns&nbsp;instantly,&nbsp;and&nbsp;the&nbsp;net&nbsp;package&nbsp;uses</span><br>
<span class="lineno">50</span><span class="comment" id="2374203">//&nbsp;non-blocking&nbsp;I/O&nbsp;to&nbsp;accept&nbsp;on&nbsp;a&nbsp;listening&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="2374256">//&nbsp;The&nbsp;rules&nbsp;for&nbsp;which&nbsp;file&nbsp;descriptor-creating&nbsp;operations&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2374323">//&nbsp;ForkLock&nbsp;are&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="2374351">//</span><br>
<span class="lineno"></span><span class="comment" id="2374354">//&nbsp;1)&nbsp;Pipe.&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno">55</span><span class="comment" id="2374404">//&nbsp;2)&nbsp;Socket.&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2374454">//&nbsp;3)&nbsp;Accept.&nbsp;&nbsp;If&nbsp;using&nbsp;non-blocking&nbsp;mode,&nbsp;use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2374515">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno"></span><span class="comment" id="2374561">//&nbsp;4)&nbsp;Open.&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;block.&nbsp;&nbsp;Use&nbsp;O_CLOEXEC&nbsp;if&nbsp;available&nbsp;(Linux).</span><br>
<span class="lineno"></span><span class="comment" id="2374624">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise,&nbsp;live&nbsp;with&nbsp;the&nbsp;race.</span><br>
<span class="lineno">60</span><span class="comment" id="2374670">//&nbsp;5)&nbsp;Dup.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Does&nbsp;not&nbsp;block.&nbsp;&nbsp;Use&nbsp;the&nbsp;ForkLock.</span><br>
<span class="lineno"></span><span class="comment" id="2374720">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;Linux,&nbsp;could&nbsp;use&nbsp;fcntl&nbsp;F_DUPFD_CLOEXEC</span><br>
<span class="lineno"></span><span class="comment" id="2374777">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;instead&nbsp;of&nbsp;the&nbsp;ForkLock,&nbsp;but&nbsp;only&nbsp;for&nbsp;dup(fd,&nbsp;-1).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2374844">var</span>&nbsp;<span class="ident" id="2374848">ForkLock</span>&nbsp;<span class="ident" id="2374857">sync</span><span class="op" id="2374861">.</span><span class="ident" id="2374862">RWMutex</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="2374871">//&nbsp;StringSlicePtr&nbsp;is&nbsp;deprecated.&nbsp;Use&nbsp;SlicePtrFromStrings&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="2374937">//&nbsp;If&nbsp;any&nbsp;string&nbsp;contains&nbsp;a&nbsp;NUL&nbsp;byte&nbsp;this&nbsp;function&nbsp;panics&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="2375003">//&nbsp;of&nbsp;returning&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="2375029">func</span>&nbsp;<span class="ident" id="2375034">StringSlicePtr</span><span class="op" id="2375048">(</span><span class="ident" id="2375049">ss</span>&nbsp;<span class="op" id="2375052">[</span><span class="op" id="2375053">]</span><span class="builtintype" id="2375054">string</span><span class="op" id="2375060">)</span>&nbsp;<span class="op" id="2375062">[</span><span class="op" id="2375063">]</span><span class="op" id="2375064">*</span><span class="builtintype" id="2375065">byte</span>&nbsp;<span class="op" id="2375070">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375073">bb</span>&nbsp;<span class="op" id="2375076">:=</span>&nbsp;<span class="builtinfunc" id="2375079">make</span><span class="op" id="2375083">(</span><span class="op" id="2375084">[</span><span class="op" id="2375085">]</span><span class="op" id="2375086">*</span><span class="builtintype" id="2375087">byte</span><span class="op" id="2375091">,</span>&nbsp;<span class="builtinfunc" id="2375093">len</span><span class="op" id="2375096">(</span><span class="ident" id="2375097">ss</span><span class="op" id="2375099">)</span><span class="op" id="2375100">+</span><span class="num" id="2375101">1</span><span class="op" id="2375102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375105">for</span>&nbsp;<span class="ident" id="2375109">i</span>&nbsp;<span class="op" id="2375111">:=</span>&nbsp;<span class="num" id="2375114">0</span><span class="op" id="2375115">;</span>&nbsp;<span class="ident" id="2375117">i</span>&nbsp;<span class="op" id="2375119">&lt;</span>&nbsp;<span class="builtinfunc" id="2375121">len</span><span class="op" id="2375124">(</span><span class="ident" id="2375125">ss</span><span class="op" id="2375127">)</span><span class="op" id="2375128">;</span>&nbsp;<span class="ident" id="2375130">i</span><span class="op" id="2375131">++</span>&nbsp;<span class="op" id="2375134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375138">bb</span><span class="op" id="2375140">[</span><span class="ident" id="2375141">i</span><span class="op" id="2375142">]</span>&nbsp;<span class="op" id="2375144">=</span>&nbsp;<span class="ident" id="2375146">StringBytePtr</span><span class="op" id="2375159">(</span><span class="ident" id="2375160">ss</span><span class="op" id="2375162">[</span><span class="ident" id="2375163">i</span><span class="op" id="2375164">]</span><span class="op" id="2375165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375171">bb</span><span class="op" id="2375173">[</span><span class="builtinfunc" id="2375174">len</span><span class="op" id="2375177">(</span><span class="ident" id="2375178">ss</span><span class="op" id="2375180">)</span><span class="op" id="2375181">]</span>&nbsp;<span class="op" id="2375183">=</span>&nbsp;<span class="ident" id="2375185">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375190">return</span>&nbsp;<span class="ident" id="2375197">bb</span><br>
<span class="lineno"></span><span class="op" id="2375200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2375203">//&nbsp;SlicePtrFromStrings&nbsp;converts&nbsp;a&nbsp;slice&nbsp;of&nbsp;strings&nbsp;to&nbsp;a&nbsp;slice&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2375268">//&nbsp;pointers&nbsp;to&nbsp;NUL-terminated&nbsp;byte&nbsp;slices.&nbsp;If&nbsp;any&nbsp;string&nbsp;contains</span><br>
<span class="lineno">80</span><span class="comment" id="2375334">//&nbsp;a&nbsp;NUL&nbsp;byte,&nbsp;it&nbsp;returns&nbsp;(nil,&nbsp;EINVAL).</span><br>
<span class="lineno"></span><span class="keyword" id="2375375">func</span>&nbsp;<span class="ident" id="2375380">SlicePtrFromStrings</span><span class="op" id="2375399">(</span><span class="ident" id="2375400">ss</span>&nbsp;<span class="op" id="2375403">[</span><span class="op" id="2375404">]</span><span class="builtintype" id="2375405">string</span><span class="op" id="2375411">)</span>&nbsp;<span class="op" id="2375413">(</span><span class="op" id="2375414">[</span><span class="op" id="2375415">]</span><span class="op" id="2375416">*</span><span class="builtintype" id="2375417">byte</span><span class="op" id="2375421">,</span>&nbsp;<span class="builtintype" id="2375423">error</span><span class="op" id="2375428">)</span>&nbsp;<span class="op" id="2375430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375433">var</span>&nbsp;<span class="ident" id="2375437">err</span>&nbsp;<span class="builtintype" id="2375441">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375448">bb</span>&nbsp;<span class="op" id="2375451">:=</span>&nbsp;<span class="builtinfunc" id="2375454">make</span><span class="op" id="2375458">(</span><span class="op" id="2375459">[</span><span class="op" id="2375460">]</span><span class="op" id="2375461">*</span><span class="builtintype" id="2375462">byte</span><span class="op" id="2375466">,</span>&nbsp;<span class="builtinfunc" id="2375468">len</span><span class="op" id="2375471">(</span><span class="ident" id="2375472">ss</span><span class="op" id="2375474">)</span><span class="op" id="2375475">+</span><span class="num" id="2375476">1</span><span class="op" id="2375477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375480">for</span>&nbsp;<span class="ident" id="2375484">i</span>&nbsp;<span class="op" id="2375486">:=</span>&nbsp;<span class="num" id="2375489">0</span><span class="op" id="2375490">;</span>&nbsp;<span class="ident" id="2375492">i</span>&nbsp;<span class="op" id="2375494">&lt;</span>&nbsp;<span class="builtinfunc" id="2375496">len</span><span class="op" id="2375499">(</span><span class="ident" id="2375500">ss</span><span class="op" id="2375502">)</span><span class="op" id="2375503">;</span>&nbsp;<span class="ident" id="2375505">i</span><span class="op" id="2375506">++</span>&nbsp;<span class="op" id="2375509">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375513">bb</span><span class="op" id="2375515">[</span><span class="ident" id="2375516">i</span><span class="op" id="2375517">]</span><span class="op" id="2375518">,</span>&nbsp;<span class="ident" id="2375520">err</span>&nbsp;<span class="op" id="2375524">=</span>&nbsp;<span class="ident" id="2375526">BytePtrFromString</span><span class="op" id="2375543">(</span><span class="ident" id="2375544">ss</span><span class="op" id="2375546">[</span><span class="ident" id="2375547">i</span><span class="op" id="2375548">]</span><span class="op" id="2375549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375553">if</span>&nbsp;<span class="ident" id="2375556">err</span>&nbsp;<span class="op" id="2375560">!=</span>&nbsp;<span class="ident" id="2375563">nil</span>&nbsp;<span class="op" id="2375567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375572">return</span>&nbsp;<span class="ident" id="2375579">nil</span><span class="op" id="2375582">,</span>&nbsp;<span class="ident" id="2375584">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375593">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375596">bb</span><span class="op" id="2375598">[</span><span class="builtinfunc" id="2375599">len</span><span class="op" id="2375602">(</span><span class="ident" id="2375603">ss</span><span class="op" id="2375605">)</span><span class="op" id="2375606">]</span>&nbsp;<span class="op" id="2375608">=</span>&nbsp;<span class="ident" id="2375610">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375615">return</span>&nbsp;<span class="ident" id="2375622">bb</span><span class="op" id="2375624">,</span>&nbsp;<span class="ident" id="2375626">nil</span><br>
<span class="lineno"></span><span class="op" id="2375630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2375633">func</span>&nbsp;<span class="ident" id="2375638">CloseOnExec</span><span class="op" id="2375649">(</span><span class="ident" id="2375650">fd</span>&nbsp;<span class="builtintype" id="2375653">int</span><span class="op" id="2375656">)</span>&nbsp;<span class="op" id="2375658">{</span>&nbsp;<span class="ident" id="2375660">fcntl</span><span class="op" id="2375665">(</span><span class="ident" id="2375666">fd</span><span class="op" id="2375668">,</span>&nbsp;<span class="ident" id="2375670">F_SETFD</span><span class="op" id="2375677">,</span>&nbsp;<span class="ident" id="2375679">FD_CLOEXEC</span><span class="op" id="2375689">)</span>&nbsp;<span class="op" id="2375691">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="2375694">func</span>&nbsp;<span class="ident" id="2375699">SetNonblock</span><span class="op" id="2375710">(</span><span class="ident" id="2375711">fd</span>&nbsp;<span class="builtintype" id="2375714">int</span><span class="op" id="2375717">,</span>&nbsp;<span class="ident" id="2375719">nonblocking</span>&nbsp;<span class="builtintype" id="2375731">bool</span><span class="op" id="2375735">)</span>&nbsp;<span class="op" id="2375737">(</span><span class="ident" id="2375738">err</span>&nbsp;<span class="builtintype" id="2375742">error</span><span class="op" id="2375747">)</span>&nbsp;<span class="op" id="2375749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375752">flag</span><span class="op" id="2375756">,</span>&nbsp;<span class="ident" id="2375758">err</span>&nbsp;<span class="op" id="2375762">:=</span>&nbsp;<span class="ident" id="2375765">fcntl</span><span class="op" id="2375770">(</span><span class="ident" id="2375771">fd</span><span class="op" id="2375773">,</span>&nbsp;<span class="ident" id="2375775">F_GETFL</span><span class="op" id="2375782">,</span>&nbsp;<span class="num" id="2375784">0</span><span class="op" id="2375785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375788">if</span>&nbsp;<span class="ident" id="2375791">err</span>&nbsp;<span class="op" id="2375795">!=</span>&nbsp;<span class="ident" id="2375798">nil</span>&nbsp;<span class="op" id="2375802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375806">return</span>&nbsp;<span class="ident" id="2375813">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375821">if</span>&nbsp;<span class="ident" id="2375824">nonblocking</span>&nbsp;<span class="op" id="2375836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375840">flag</span>&nbsp;<span class="op" id="2375845">|=</span>&nbsp;<span class="ident" id="2375848">O_NONBLOCK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375860">}</span>&nbsp;<span class="keyword" id="2375862">else</span>&nbsp;<span class="op" id="2375867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375871">flag</span>&nbsp;<span class="op" id="2375876">&amp;=</span>&nbsp;<span class="op" id="2375879">^</span><span class="ident" id="2375880">O_NONBLOCK</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2375892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2375895">_</span><span class="op" id="2375896">,</span>&nbsp;<span class="ident" id="2375898">err</span>&nbsp;<span class="op" id="2375902">=</span>&nbsp;<span class="ident" id="2375904">fcntl</span><span class="op" id="2375909">(</span><span class="ident" id="2375910">fd</span><span class="op" id="2375912">,</span>&nbsp;<span class="ident" id="2375914">F_SETFL</span><span class="op" id="2375921">,</span>&nbsp;<span class="ident" id="2375923">flag</span><span class="op" id="2375927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2375930">return</span>&nbsp;<span class="ident" id="2375937">err</span><br>
<span class="lineno"></span><span class="op" id="2375941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="2375944">//&nbsp;Credential&nbsp;holds&nbsp;user&nbsp;and&nbsp;group&nbsp;identities&nbsp;to&nbsp;be&nbsp;assumed</span><br>
<span class="lineno"></span><span class="comment" id="2376004">//&nbsp;by&nbsp;a&nbsp;child&nbsp;process&nbsp;started&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno"></span><span class="keyword" id="2376051">type</span>&nbsp;<span class="ident" id="2376056">Credential</span>&nbsp;<span class="keyword" id="2376067">struct</span>&nbsp;<span class="op" id="2376074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376077">Uid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2376084">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2376093">//&nbsp;User&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376106">Gid</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2376113">uint32</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="2376122">//&nbsp;Group&nbsp;ID.</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376136">Groups</span>&nbsp;<span class="op" id="2376143">[</span><span class="op" id="2376144">]</span><span class="builtintype" id="2376145">uint32</span>&nbsp;<span class="comment" id="2376152">//&nbsp;Supplementary&nbsp;group&nbsp;IDs.</span><br>
<span class="lineno"></span><span class="op" id="2376180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2376183">//&nbsp;ProcAttr&nbsp;holds&nbsp;attributes&nbsp;that&nbsp;will&nbsp;be&nbsp;applied&nbsp;to&nbsp;a&nbsp;new&nbsp;process&nbsp;started</span><br>
<span class="lineno"></span><span class="comment" id="2376258">//&nbsp;by&nbsp;StartProcess.</span><br>
<span class="lineno">120</span><span class="keyword" id="2376278">type</span>&nbsp;<span class="ident" id="2376283">ProcAttr</span>&nbsp;<span class="keyword" id="2376292">struct</span>&nbsp;<span class="op" id="2376299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376302">Dir</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2376308">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2376318">//&nbsp;Current&nbsp;working&nbsp;directory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376349">Env</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2376355">[</span><span class="op" id="2376356">]</span><span class="builtintype" id="2376357">string</span>&nbsp;&nbsp;<span class="comment" id="2376365">//&nbsp;Environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376382">Files</span>&nbsp;<span class="op" id="2376388">[</span><span class="op" id="2376389">]</span><span class="builtintype" id="2376390">uintptr</span>&nbsp;<span class="comment" id="2376398">//&nbsp;File&nbsp;descriptors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376420">Sys</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2376426">*</span><span class="ident" id="2376427">SysProcAttr</span><br>
<span class="lineno">125</span><span class="op" id="2376439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2376442">var</span>&nbsp;<span class="ident" id="2376446">zeroProcAttr</span>&nbsp;<span class="ident" id="2376459">ProcAttr</span><br>
<span class="lineno"></span><span class="keyword" id="2376468">var</span>&nbsp;<span class="ident" id="2376472">zeroSysProcAttr</span>&nbsp;<span class="ident" id="2376488">SysProcAttr</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="2376501">func</span>&nbsp;<span class="ident" id="2376506">forkExec</span><span class="op" id="2376514">(</span><span class="ident" id="2376515">argv0</span>&nbsp;<span class="builtintype" id="2376521">string</span><span class="op" id="2376527">,</span>&nbsp;<span class="ident" id="2376529">argv</span>&nbsp;<span class="op" id="2376534">[</span><span class="op" id="2376535">]</span><span class="builtintype" id="2376536">string</span><span class="op" id="2376542">,</span>&nbsp;<span class="ident" id="2376544">attr</span>&nbsp;<span class="op" id="2376549">*</span><span class="ident" id="2376550">ProcAttr</span><span class="op" id="2376558">)</span>&nbsp;<span class="op" id="2376560">(</span><span class="ident" id="2376561">pid</span>&nbsp;<span class="builtintype" id="2376565">int</span><span class="op" id="2376568">,</span>&nbsp;<span class="ident" id="2376570">err</span>&nbsp;<span class="builtintype" id="2376574">error</span><span class="op" id="2376579">)</span>&nbsp;<span class="op" id="2376581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376584">var</span>&nbsp;<span class="ident" id="2376588">p</span>&nbsp;<span class="op" id="2376590">[</span><span class="num" id="2376591">2</span><span class="op" id="2376592">]</span><span class="builtintype" id="2376593">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376598">var</span>&nbsp;<span class="ident" id="2376602">n</span>&nbsp;<span class="builtintype" id="2376604">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376609">var</span>&nbsp;<span class="ident" id="2376613">err1</span>&nbsp;<span class="ident" id="2376618">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376625">var</span>&nbsp;<span class="ident" id="2376629">wstatus</span>&nbsp;<span class="ident" id="2376637">WaitStatus</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376650">if</span>&nbsp;<span class="ident" id="2376653">attr</span>&nbsp;<span class="op" id="2376658">==</span>&nbsp;<span class="ident" id="2376661">nil</span>&nbsp;<span class="op" id="2376665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376669">attr</span>&nbsp;<span class="op" id="2376674">=</span>&nbsp;<span class="op" id="2376676">&amp;</span><span class="ident" id="2376677">zeroProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376694">sys</span>&nbsp;<span class="op" id="2376698">:=</span>&nbsp;<span class="ident" id="2376701">attr</span><span class="op" id="2376705">.</span><span class="ident" id="2376706">Sys</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376711">if</span>&nbsp;<span class="ident" id="2376714">sys</span>&nbsp;<span class="op" id="2376718">==</span>&nbsp;<span class="ident" id="2376721">nil</span>&nbsp;<span class="op" id="2376725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376729">sys</span>&nbsp;<span class="op" id="2376733">=</span>&nbsp;<span class="op" id="2376735">&amp;</span><span class="ident" id="2376736">zeroSysProcAttr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376757">p</span><span class="op" id="2376758">[</span><span class="num" id="2376759">0</span><span class="op" id="2376760">]</span>&nbsp;<span class="op" id="2376762">=</span>&nbsp;<span class="op" id="2376764">-</span><span class="num" id="2376765">1</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376768">p</span><span class="op" id="2376769">[</span><span class="num" id="2376770">1</span><span class="op" id="2376771">]</span>&nbsp;<span class="op" id="2376773">=</span>&nbsp;<span class="op" id="2376775">-</span><span class="num" id="2376776">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2376780">//&nbsp;Convert&nbsp;args&nbsp;to&nbsp;C&nbsp;form.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376808">argv0p</span><span class="op" id="2376814">,</span>&nbsp;<span class="ident" id="2376816">err</span>&nbsp;<span class="op" id="2376820">:=</span>&nbsp;<span class="ident" id="2376823">BytePtrFromString</span><span class="op" id="2376840">(</span><span class="ident" id="2376841">argv0</span><span class="op" id="2376846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376849">if</span>&nbsp;<span class="ident" id="2376852">err</span>&nbsp;<span class="op" id="2376856">!=</span>&nbsp;<span class="ident" id="2376859">nil</span>&nbsp;<span class="op" id="2376863">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376867">return</span>&nbsp;<span class="num" id="2376874">0</span><span class="op" id="2376875">,</span>&nbsp;<span class="ident" id="2376877">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376885">argvp</span><span class="op" id="2376890">,</span>&nbsp;<span class="ident" id="2376892">err</span>&nbsp;<span class="op" id="2376896">:=</span>&nbsp;<span class="ident" id="2376899">SlicePtrFromStrings</span><span class="op" id="2376918">(</span><span class="ident" id="2376919">argv</span><span class="op" id="2376923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376926">if</span>&nbsp;<span class="ident" id="2376929">err</span>&nbsp;<span class="op" id="2376933">!=</span>&nbsp;<span class="ident" id="2376936">nil</span>&nbsp;<span class="op" id="2376940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2376944">return</span>&nbsp;<span class="num" id="2376951">0</span><span class="op" id="2376952">,</span>&nbsp;<span class="ident" id="2376954">err</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2376959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2376962">envvp</span><span class="op" id="2376967">,</span>&nbsp;<span class="ident" id="2376969">err</span>&nbsp;<span class="op" id="2376973">:=</span>&nbsp;<span class="ident" id="2376976">SlicePtrFromStrings</span><span class="op" id="2376995">(</span><span class="ident" id="2376996">attr</span><span class="op" id="2377000">.</span><span class="ident" id="2377001">Env</span><span class="op" id="2377004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377007">if</span>&nbsp;<span class="ident" id="2377010">err</span>&nbsp;<span class="op" id="2377014">!=</span>&nbsp;<span class="ident" id="2377017">nil</span>&nbsp;<span class="op" id="2377021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377025">return</span>&nbsp;<span class="num" id="2377032">0</span><span class="op" id="2377033">,</span>&nbsp;<span class="ident" id="2377035">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377040">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377044">if</span>&nbsp;<span class="op" id="2377047">(</span><span class="ident" id="2377048">runtime</span><span class="op" id="2377055">.</span><span class="ident" id="2377056">GOOS</span>&nbsp;<span class="op" id="2377061">==</span>&nbsp;<span class="string" id="2377064">&#34;freebsd&#34;</span>&nbsp;<span class="op" id="2377074">||</span>&nbsp;<span class="ident" id="2377077">runtime</span><span class="op" id="2377084">.</span><span class="ident" id="2377085">GOOS</span>&nbsp;<span class="op" id="2377090">==</span>&nbsp;<span class="string" id="2377093">&#34;dragonfly&#34;</span><span class="op" id="2377104">)</span>&nbsp;<span class="op" id="2377106">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2377109">len</span><span class="op" id="2377112">(</span><span class="ident" id="2377113">argv</span><span class="op" id="2377117">[</span><span class="num" id="2377118">0</span><span class="op" id="2377119">]</span><span class="op" id="2377120">)</span>&nbsp;<span class="op" id="2377122">&gt;</span>&nbsp;<span class="builtinfunc" id="2377124">len</span><span class="op" id="2377127">(</span><span class="ident" id="2377128">argv0</span><span class="op" id="2377133">)</span>&nbsp;<span class="op" id="2377135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377139">argvp</span><span class="op" id="2377144">[</span><span class="num" id="2377145">0</span><span class="op" id="2377146">]</span>&nbsp;<span class="op" id="2377148">=</span>&nbsp;<span class="ident" id="2377150">argv0p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377162">var</span>&nbsp;<span class="ident" id="2377166">chroot</span>&nbsp;<span class="op" id="2377173">*</span><span class="builtintype" id="2377174">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377180">if</span>&nbsp;<span class="ident" id="2377183">sys</span><span class="op" id="2377186">.</span><span class="ident" id="2377187">Chroot</span>&nbsp;<span class="op" id="2377194">!=</span>&nbsp;<span class="string" id="2377197">&#34;&#34;</span>&nbsp;<span class="op" id="2377200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377204">chroot</span><span class="op" id="2377210">,</span>&nbsp;<span class="ident" id="2377212">err</span>&nbsp;<span class="op" id="2377216">=</span>&nbsp;<span class="ident" id="2377218">BytePtrFromString</span><span class="op" id="2377235">(</span><span class="ident" id="2377236">sys</span><span class="op" id="2377239">.</span><span class="ident" id="2377240">Chroot</span><span class="op" id="2377246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377250">if</span>&nbsp;<span class="ident" id="2377253">err</span>&nbsp;<span class="op" id="2377257">!=</span>&nbsp;<span class="ident" id="2377260">nil</span>&nbsp;<span class="op" id="2377264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377269">return</span>&nbsp;<span class="num" id="2377276">0</span><span class="op" id="2377277">,</span>&nbsp;<span class="ident" id="2377279">err</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377291">var</span>&nbsp;<span class="ident" id="2377295">dir</span>&nbsp;<span class="op" id="2377299">*</span><span class="builtintype" id="2377300">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377306">if</span>&nbsp;<span class="ident" id="2377309">attr</span><span class="op" id="2377313">.</span><span class="ident" id="2377314">Dir</span>&nbsp;<span class="op" id="2377318">!=</span>&nbsp;<span class="string" id="2377321">&#34;&#34;</span>&nbsp;<span class="op" id="2377324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377328">dir</span><span class="op" id="2377331">,</span>&nbsp;<span class="ident" id="2377333">err</span>&nbsp;<span class="op" id="2377337">=</span>&nbsp;<span class="ident" id="2377339">BytePtrFromString</span><span class="op" id="2377356">(</span><span class="ident" id="2377357">attr</span><span class="op" id="2377361">.</span><span class="ident" id="2377362">Dir</span><span class="op" id="2377365">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377369">if</span>&nbsp;<span class="ident" id="2377372">err</span>&nbsp;<span class="op" id="2377376">!=</span>&nbsp;<span class="ident" id="2377379">nil</span>&nbsp;<span class="op" id="2377383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377388">return</span>&nbsp;<span class="num" id="2377395">0</span><span class="op" id="2377396">,</span>&nbsp;<span class="ident" id="2377398">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2377411">//&nbsp;Acquire&nbsp;the&nbsp;fork&nbsp;lock&nbsp;so&nbsp;that&nbsp;no&nbsp;other&nbsp;threads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2377462">//&nbsp;create&nbsp;new&nbsp;fds&nbsp;that&nbsp;are&nbsp;not&nbsp;yet&nbsp;close-on-exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2377512">//&nbsp;before&nbsp;we&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377532">ForkLock</span><span class="op" id="2377540">.</span><span class="ident" id="2377541">Lock</span><span class="op" id="2377545">(</span><span class="op" id="2377546">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2377550">//&nbsp;Allocate&nbsp;child&nbsp;status&nbsp;pipe&nbsp;close&nbsp;on&nbsp;exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377596">if</span>&nbsp;<span class="ident" id="2377599">err</span>&nbsp;<span class="op" id="2377603">=</span>&nbsp;<span class="ident" id="2377605">forkExecPipe</span><span class="op" id="2377617">(</span><span class="ident" id="2377618">p</span><span class="op" id="2377619">[</span><span class="op" id="2377620">:</span><span class="op" id="2377621">]</span><span class="op" id="2377622">)</span><span class="op" id="2377623">;</span>&nbsp;<span class="ident" id="2377625">err</span>&nbsp;<span class="op" id="2377629">!=</span>&nbsp;<span class="ident" id="2377632">nil</span>&nbsp;<span class="op" id="2377636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377640">goto</span>&nbsp;<span class="builtintype" id="2377645">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2377656">//&nbsp;Kick&nbsp;off&nbsp;child.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377676">pid</span><span class="op" id="2377679">,</span>&nbsp;<span class="ident" id="2377681">err1</span>&nbsp;<span class="op" id="2377686">=</span>&nbsp;<span class="ident" id="2377688">forkAndExecInChild</span><span class="op" id="2377706">(</span><span class="ident" id="2377707">argv0p</span><span class="op" id="2377713">,</span>&nbsp;<span class="ident" id="2377715">argvp</span><span class="op" id="2377720">,</span>&nbsp;<span class="ident" id="2377722">envvp</span><span class="op" id="2377727">,</span>&nbsp;<span class="ident" id="2377729">chroot</span><span class="op" id="2377735">,</span>&nbsp;<span class="ident" id="2377737">dir</span><span class="op" id="2377740">,</span>&nbsp;<span class="ident" id="2377742">attr</span><span class="op" id="2377746">,</span>&nbsp;<span class="ident" id="2377748">sys</span><span class="op" id="2377751">,</span>&nbsp;<span class="ident" id="2377753">p</span><span class="op" id="2377754">[</span><span class="num" id="2377755">1</span><span class="op" id="2377756">]</span><span class="op" id="2377757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377760">if</span>&nbsp;<span class="ident" id="2377763">err1</span>&nbsp;<span class="op" id="2377768">!=</span>&nbsp;<span class="num" id="2377771">0</span>&nbsp;<span class="op" id="2377773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377777">err</span>&nbsp;<span class="op" id="2377781">=</span>&nbsp;<span class="ident" id="2377783">Errno</span><span class="op" id="2377788">(</span><span class="ident" id="2377789">err1</span><span class="op" id="2377793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377797">goto</span>&nbsp;<span class="builtintype" id="2377802">error</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2377809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377812">ForkLock</span><span class="op" id="2377820">.</span><span class="ident" id="2377821">Unlock</span><span class="op" id="2377827">(</span><span class="op" id="2377828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2377832">//&nbsp;Read&nbsp;child&nbsp;error&nbsp;status&nbsp;from&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377871">Close</span><span class="op" id="2377876">(</span><span class="ident" id="2377877">p</span><span class="op" id="2377878">[</span><span class="num" id="2377879">1</span><span class="op" id="2377880">]</span><span class="op" id="2377881">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377884">n</span><span class="op" id="2377885">,</span>&nbsp;<span class="ident" id="2377887">err</span>&nbsp;<span class="op" id="2377891">=</span>&nbsp;<span class="ident" id="2377893">readlen</span><span class="op" id="2377900">(</span><span class="ident" id="2377901">p</span><span class="op" id="2377902">[</span><span class="num" id="2377903">0</span><span class="op" id="2377904">]</span><span class="op" id="2377905">,</span>&nbsp;<span class="op" id="2377907">(</span><span class="op" id="2377908">*</span><span class="builtintype" id="2377909">byte</span><span class="op" id="2377913">)</span><span class="op" id="2377914">(</span><span class="ident" id="2377915">unsafe</span><span class="op" id="2377921">.</span><span class="ident" id="2377922">Pointer</span><span class="op" id="2377929">(</span><span class="op" id="2377930">&amp;</span><span class="ident" id="2377931">err1</span><span class="op" id="2377935">)</span><span class="op" id="2377936">)</span><span class="op" id="2377937">,</span>&nbsp;<span class="builtintype" id="2377939">int</span><span class="op" id="2377942">(</span><span class="ident" id="2377943">unsafe</span><span class="op" id="2377949">.</span><span class="ident" id="2377950">Sizeof</span><span class="op" id="2377956">(</span><span class="ident" id="2377957">err1</span><span class="op" id="2377961">)</span><span class="op" id="2377962">)</span><span class="op" id="2377963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2377966">Close</span><span class="op" id="2377971">(</span><span class="ident" id="2377972">p</span><span class="op" id="2377973">[</span><span class="num" id="2377974">0</span><span class="op" id="2377975">]</span><span class="op" id="2377976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2377979">if</span>&nbsp;<span class="ident" id="2377982">err</span>&nbsp;<span class="op" id="2377986">!=</span>&nbsp;<span class="ident" id="2377989">nil</span>&nbsp;<span class="op" id="2377993">||</span>&nbsp;<span class="ident" id="2377996">n</span>&nbsp;<span class="op" id="2377998">!=</span>&nbsp;<span class="num" id="2378001">0</span>&nbsp;<span class="op" id="2378003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378007">if</span>&nbsp;<span class="ident" id="2378010">n</span>&nbsp;<span class="op" id="2378012">==</span>&nbsp;<span class="builtintype" id="2378015">int</span><span class="op" id="2378018">(</span><span class="ident" id="2378019">unsafe</span><span class="op" id="2378025">.</span><span class="ident" id="2378026">Sizeof</span><span class="op" id="2378032">(</span><span class="ident" id="2378033">err1</span><span class="op" id="2378037">)</span><span class="op" id="2378038">)</span>&nbsp;<span class="op" id="2378040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378045">err</span>&nbsp;<span class="op" id="2378049">=</span>&nbsp;<span class="ident" id="2378051">Errno</span><span class="op" id="2378056">(</span><span class="ident" id="2378057">err1</span><span class="op" id="2378061">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378069">if</span>&nbsp;<span class="ident" id="2378072">err</span>&nbsp;<span class="op" id="2378076">==</span>&nbsp;<span class="ident" id="2378079">nil</span>&nbsp;<span class="op" id="2378083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378088">err</span>&nbsp;<span class="op" id="2378092">=</span>&nbsp;<span class="ident" id="2378094">EPIPE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2378107">//&nbsp;Child&nbsp;failed;&nbsp;wait&nbsp;for&nbsp;it&nbsp;to&nbsp;exit,&nbsp;to&nbsp;make&nbsp;sure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2378160">//&nbsp;the&nbsp;zombies&nbsp;don&#39;t&nbsp;accumulate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378195">_</span><span class="op" id="2378196">,</span>&nbsp;<span class="ident" id="2378198">err1</span>&nbsp;<span class="op" id="2378203">:=</span>&nbsp;<span class="ident" id="2378206">Wait4</span><span class="op" id="2378211">(</span><span class="ident" id="2378212">pid</span><span class="op" id="2378215">,</span>&nbsp;<span class="op" id="2378217">&amp;</span><span class="ident" id="2378218">wstatus</span><span class="op" id="2378225">,</span>&nbsp;<span class="num" id="2378227">0</span><span class="op" id="2378228">,</span>&nbsp;<span class="ident" id="2378230">nil</span><span class="op" id="2378233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378237">for</span>&nbsp;<span class="ident" id="2378241">err1</span>&nbsp;<span class="op" id="2378246">==</span>&nbsp;<span class="ident" id="2378249">EINTR</span>&nbsp;<span class="op" id="2378255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378260">_</span><span class="op" id="2378261">,</span>&nbsp;<span class="ident" id="2378263">err1</span>&nbsp;<span class="op" id="2378268">=</span>&nbsp;<span class="ident" id="2378270">Wait4</span><span class="op" id="2378275">(</span><span class="ident" id="2378276">pid</span><span class="op" id="2378279">,</span>&nbsp;<span class="op" id="2378281">&amp;</span><span class="ident" id="2378282">wstatus</span><span class="op" id="2378289">,</span>&nbsp;<span class="num" id="2378291">0</span><span class="op" id="2378292">,</span>&nbsp;<span class="ident" id="2378294">nil</span><span class="op" id="2378297">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378305">return</span>&nbsp;<span class="num" id="2378312">0</span><span class="op" id="2378313">,</span>&nbsp;<span class="ident" id="2378315">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2378324">//&nbsp;Read&nbsp;got&nbsp;EOF,&nbsp;so&nbsp;pipe&nbsp;closed&nbsp;on&nbsp;exec,&nbsp;so&nbsp;exec&nbsp;succeeded.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378385">return</span>&nbsp;<span class="ident" id="2378392">pid</span><span class="op" id="2378395">,</span>&nbsp;<span class="ident" id="2378397">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="builtintype" id="2378402">error</span><span class="op" id="2378407">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378410">if</span>&nbsp;<span class="ident" id="2378413">p</span><span class="op" id="2378414">[</span><span class="num" id="2378415">0</span><span class="op" id="2378416">]</span>&nbsp;<span class="op" id="2378418">&gt;=</span>&nbsp;<span class="num" id="2378421">0</span>&nbsp;<span class="op" id="2378423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378427">Close</span><span class="op" id="2378432">(</span><span class="ident" id="2378433">p</span><span class="op" id="2378434">[</span><span class="num" id="2378435">0</span><span class="op" id="2378436">]</span><span class="op" id="2378437">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378441">Close</span><span class="op" id="2378446">(</span><span class="ident" id="2378447">p</span><span class="op" id="2378448">[</span><span class="num" id="2378449">1</span><span class="op" id="2378450">]</span><span class="op" id="2378451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2378454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378457">ForkLock</span><span class="op" id="2378465">.</span><span class="ident" id="2378466">Unlock</span><span class="op" id="2378472">(</span><span class="op" id="2378473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378476">return</span>&nbsp;<span class="num" id="2378483">0</span><span class="op" id="2378484">,</span>&nbsp;<span class="ident" id="2378486">err</span><br>
<span class="lineno"></span><span class="op" id="2378490">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="2378493">//&nbsp;Combination&nbsp;of&nbsp;fork&nbsp;and&nbsp;exec,&nbsp;careful&nbsp;to&nbsp;be&nbsp;thread&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="2378553">func</span>&nbsp;<span class="ident" id="2378558">ForkExec</span><span class="op" id="2378566">(</span><span class="ident" id="2378567">argv0</span>&nbsp;<span class="builtintype" id="2378573">string</span><span class="op" id="2378579">,</span>&nbsp;<span class="ident" id="2378581">argv</span>&nbsp;<span class="op" id="2378586">[</span><span class="op" id="2378587">]</span><span class="builtintype" id="2378588">string</span><span class="op" id="2378594">,</span>&nbsp;<span class="ident" id="2378596">attr</span>&nbsp;<span class="op" id="2378601">*</span><span class="ident" id="2378602">ProcAttr</span><span class="op" id="2378610">)</span>&nbsp;<span class="op" id="2378612">(</span><span class="ident" id="2378613">pid</span>&nbsp;<span class="builtintype" id="2378617">int</span><span class="op" id="2378620">,</span>&nbsp;<span class="ident" id="2378622">err</span>&nbsp;<span class="builtintype" id="2378626">error</span><span class="op" id="2378631">)</span>&nbsp;<span class="op" id="2378633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378636">return</span>&nbsp;<span class="ident" id="2378643">forkExec</span><span class="op" id="2378651">(</span><span class="ident" id="2378652">argv0</span><span class="op" id="2378657">,</span>&nbsp;<span class="ident" id="2378659">argv</span><span class="op" id="2378663">,</span>&nbsp;<span class="ident" id="2378665">attr</span><span class="op" id="2378669">)</span><br>
<span class="lineno"></span><span class="op" id="2378671">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="2378674">//&nbsp;StartProcess&nbsp;wraps&nbsp;ForkExec&nbsp;for&nbsp;package&nbsp;os.</span><br>
<span class="lineno"></span><span class="keyword" id="2378721">func</span>&nbsp;<span class="ident" id="2378726">StartProcess</span><span class="op" id="2378738">(</span><span class="ident" id="2378739">argv0</span>&nbsp;<span class="builtintype" id="2378745">string</span><span class="op" id="2378751">,</span>&nbsp;<span class="ident" id="2378753">argv</span>&nbsp;<span class="op" id="2378758">[</span><span class="op" id="2378759">]</span><span class="builtintype" id="2378760">string</span><span class="op" id="2378766">,</span>&nbsp;<span class="ident" id="2378768">attr</span>&nbsp;<span class="op" id="2378773">*</span><span class="ident" id="2378774">ProcAttr</span><span class="op" id="2378782">)</span>&nbsp;<span class="op" id="2378784">(</span><span class="ident" id="2378785">pid</span>&nbsp;<span class="builtintype" id="2378789">int</span><span class="op" id="2378792">,</span>&nbsp;<span class="ident" id="2378794">handle</span>&nbsp;<span class="builtintype" id="2378801">uintptr</span><span class="op" id="2378808">,</span>&nbsp;<span class="ident" id="2378810">err</span>&nbsp;<span class="builtintype" id="2378814">error</span><span class="op" id="2378819">)</span>&nbsp;<span class="op" id="2378821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378824">pid</span><span class="op" id="2378827">,</span>&nbsp;<span class="ident" id="2378829">err</span>&nbsp;<span class="op" id="2378833">=</span>&nbsp;<span class="ident" id="2378835">forkExec</span><span class="op" id="2378843">(</span><span class="ident" id="2378844">argv0</span><span class="op" id="2378849">,</span>&nbsp;<span class="ident" id="2378851">argv</span><span class="op" id="2378855">,</span>&nbsp;<span class="ident" id="2378857">attr</span><span class="op" id="2378861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2378864">return</span>&nbsp;<span class="ident" id="2378871">pid</span><span class="op" id="2378874">,</span>&nbsp;<span class="num" id="2378876">0</span><span class="op" id="2378877">,</span>&nbsp;<span class="ident" id="2378879">err</span><br>
<span class="lineno">240</span><span class="op" id="2378883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2378886">//&nbsp;Ordinary&nbsp;exec.</span><br>
<span class="lineno"></span><span class="keyword" id="2378904">func</span>&nbsp;<span class="ident" id="2378909">Exec</span><span class="op" id="2378913">(</span><span class="ident" id="2378914">argv0</span>&nbsp;<span class="builtintype" id="2378920">string</span><span class="op" id="2378926">,</span>&nbsp;<span class="ident" id="2378928">argv</span>&nbsp;<span class="op" id="2378933">[</span><span class="op" id="2378934">]</span><span class="builtintype" id="2378935">string</span><span class="op" id="2378941">,</span>&nbsp;<span class="ident" id="2378943">envv</span>&nbsp;<span class="op" id="2378948">[</span><span class="op" id="2378949">]</span><span class="builtintype" id="2378950">string</span><span class="op" id="2378956">)</span>&nbsp;<span class="op" id="2378958">(</span><span class="ident" id="2378959">err</span>&nbsp;<span class="builtintype" id="2378963">error</span><span class="op" id="2378968">)</span>&nbsp;<span class="op" id="2378970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2378973">argv0p</span><span class="op" id="2378979">,</span>&nbsp;<span class="ident" id="2378981">err</span>&nbsp;<span class="op" id="2378985">:=</span>&nbsp;<span class="ident" id="2378988">BytePtrFromString</span><span class="op" id="2379005">(</span><span class="ident" id="2379006">argv0</span><span class="op" id="2379011">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379014">if</span>&nbsp;<span class="ident" id="2379017">err</span>&nbsp;<span class="op" id="2379021">!=</span>&nbsp;<span class="ident" id="2379024">nil</span>&nbsp;<span class="op" id="2379028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379032">return</span>&nbsp;<span class="ident" id="2379039">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379047">argvp</span><span class="op" id="2379052">,</span>&nbsp;<span class="ident" id="2379054">err</span>&nbsp;<span class="op" id="2379058">:=</span>&nbsp;<span class="ident" id="2379061">SlicePtrFromStrings</span><span class="op" id="2379080">(</span><span class="ident" id="2379081">argv</span><span class="op" id="2379085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379088">if</span>&nbsp;<span class="ident" id="2379091">err</span>&nbsp;<span class="op" id="2379095">!=</span>&nbsp;<span class="ident" id="2379098">nil</span>&nbsp;<span class="op" id="2379102">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379106">return</span>&nbsp;<span class="ident" id="2379113">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379121">envvp</span><span class="op" id="2379126">,</span>&nbsp;<span class="ident" id="2379128">err</span>&nbsp;<span class="op" id="2379132">:=</span>&nbsp;<span class="ident" id="2379135">SlicePtrFromStrings</span><span class="op" id="2379154">(</span><span class="ident" id="2379155">envv</span><span class="op" id="2379159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379162">if</span>&nbsp;<span class="ident" id="2379165">err</span>&nbsp;<span class="op" id="2379169">!=</span>&nbsp;<span class="ident" id="2379172">nil</span>&nbsp;<span class="op" id="2379176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379180">return</span>&nbsp;<span class="ident" id="2379187">err</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2379192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2379195">_</span><span class="op" id="2379196">,</span>&nbsp;<span class="ident" id="2379198">_</span><span class="op" id="2379199">,</span>&nbsp;<span class="ident" id="2379201">err1</span>&nbsp;<span class="op" id="2379206">:=</span>&nbsp;<span class="ident" id="2379209">RawSyscall</span><span class="op" id="2379219">(</span><span class="ident" id="2379220">SYS_EXECVE</span><span class="op" id="2379230">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2379234">uintptr</span><span class="op" id="2379241">(</span><span class="ident" id="2379242">unsafe</span><span class="op" id="2379248">.</span><span class="ident" id="2379249">Pointer</span><span class="op" id="2379256">(</span><span class="ident" id="2379257">argv0p</span><span class="op" id="2379263">)</span><span class="op" id="2379264">)</span><span class="op" id="2379265">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2379269">uintptr</span><span class="op" id="2379276">(</span><span class="ident" id="2379277">unsafe</span><span class="op" id="2379283">.</span><span class="ident" id="2379284">Pointer</span><span class="op" id="2379291">(</span><span class="op" id="2379292">&amp;</span><span class="ident" id="2379293">argvp</span><span class="op" id="2379298">[</span><span class="num" id="2379299">0</span><span class="op" id="2379300">]</span><span class="op" id="2379301">)</span><span class="op" id="2379302">)</span><span class="op" id="2379303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="2379307">uintptr</span><span class="op" id="2379314">(</span><span class="ident" id="2379315">unsafe</span><span class="op" id="2379321">.</span><span class="ident" id="2379322">Pointer</span><span class="op" id="2379329">(</span><span class="op" id="2379330">&amp;</span><span class="ident" id="2379331">envvp</span><span class="op" id="2379336">[</span><span class="num" id="2379337">0</span><span class="op" id="2379338">]</span><span class="op" id="2379339">)</span><span class="op" id="2379340">)</span><span class="op" id="2379341">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2379344">return</span>&nbsp;<span class="ident" id="2379351">Errno</span><span class="op" id="2379356">(</span><span class="ident" id="2379357">err1</span><span class="op" id="2379361">)</span><br>
<span class="lineno"></span><span class="op" id="2379363">}</span>
</div>
</body>
</html>
