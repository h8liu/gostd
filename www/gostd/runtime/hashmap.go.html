<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1455405">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1455460">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1455514">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1455565">package</span>&nbsp;<span class="ident" id="1455573">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1455582">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&#39;s&nbsp;map&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="1455641">//</span><br>
<span class="lineno"></span><span class="comment" id="1455644">//&nbsp;A&nbsp;map&nbsp;is&nbsp;just&nbsp;a&nbsp;hash&nbsp;table.&nbsp;&nbsp;The&nbsp;data&nbsp;is&nbsp;arranged</span><br>
<span class="lineno">10</span><span class="comment" id="1455697">//&nbsp;into&nbsp;an&nbsp;array&nbsp;of&nbsp;buckets.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;up&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1455754">//&nbsp;8&nbsp;key/value&nbsp;pairs.&nbsp;&nbsp;The&nbsp;low-order&nbsp;bits&nbsp;of&nbsp;the&nbsp;hash&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1455812">//&nbsp;used&nbsp;to&nbsp;select&nbsp;a&nbsp;bucket.&nbsp;&nbsp;Each&nbsp;bucket&nbsp;contains&nbsp;a&nbsp;few</span><br>
<span class="lineno"></span><span class="comment" id="1455868">//&nbsp;high-order&nbsp;bits&nbsp;of&nbsp;each&nbsp;hash&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;entries</span><br>
<span class="lineno"></span><span class="comment" id="1455927">//&nbsp;within&nbsp;a&nbsp;single&nbsp;bucket.</span><br>
<span class="lineno">15</span><span class="comment" id="1455954">//</span><br>
<span class="lineno"></span><span class="comment" id="1455957">//&nbsp;If&nbsp;more&nbsp;than&nbsp;8&nbsp;keys&nbsp;hash&nbsp;to&nbsp;a&nbsp;bucket,&nbsp;we&nbsp;chain&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="1456010">//&nbsp;extra&nbsp;buckets.</span><br>
<span class="lineno"></span><span class="comment" id="1456028">//</span><br>
<span class="lineno"></span><span class="comment" id="1456031">//&nbsp;When&nbsp;the&nbsp;hashtable&nbsp;grows,&nbsp;we&nbsp;allocate&nbsp;a&nbsp;new&nbsp;array</span><br>
<span class="lineno">20</span><span class="comment" id="1456084">//&nbsp;of&nbsp;buckets&nbsp;twice&nbsp;as&nbsp;big.&nbsp;&nbsp;Buckets&nbsp;are&nbsp;incrementally</span><br>
<span class="lineno"></span><span class="comment" id="1456139">//&nbsp;copied&nbsp;from&nbsp;the&nbsp;old&nbsp;bucket&nbsp;array&nbsp;to&nbsp;the&nbsp;new&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span><span class="comment" id="1456200">//</span><br>
<span class="lineno"></span><span class="comment" id="1456203">//&nbsp;Map&nbsp;iterators&nbsp;walk&nbsp;through&nbsp;the&nbsp;array&nbsp;of&nbsp;buckets&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1456258">//&nbsp;return&nbsp;the&nbsp;keys&nbsp;in&nbsp;walk&nbsp;order&nbsp;(bucket&nbsp;#,&nbsp;then&nbsp;overflow</span><br>
<span class="lineno">25</span><span class="comment" id="1456316">//&nbsp;chain&nbsp;order,&nbsp;then&nbsp;bucket&nbsp;index).&nbsp;&nbsp;To&nbsp;maintain&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="1456375">//&nbsp;semantics,&nbsp;we&nbsp;never&nbsp;move&nbsp;keys&nbsp;within&nbsp;their&nbsp;bucket&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="1456432">//&nbsp;we&nbsp;did,&nbsp;keys&nbsp;might&nbsp;be&nbsp;returned&nbsp;0&nbsp;or&nbsp;2&nbsp;times).&nbsp;&nbsp;When</span><br>
<span class="lineno"></span><span class="comment" id="1456487">//&nbsp;growing&nbsp;the&nbsp;table,&nbsp;iterators&nbsp;remain&nbsp;iterating&nbsp;through&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1456548">//&nbsp;old&nbsp;table&nbsp;and&nbsp;must&nbsp;check&nbsp;the&nbsp;new&nbsp;table&nbsp;if&nbsp;the&nbsp;bucket</span><br>
<span class="lineno">30</span><span class="comment" id="1456604">//&nbsp;they&nbsp;are&nbsp;iterating&nbsp;through&nbsp;has&nbsp;been&nbsp;moved&nbsp;(&#34;evacuated&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="1456663">//&nbsp;to&nbsp;the&nbsp;new&nbsp;table.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1456685">//&nbsp;Picking&nbsp;loadFactor:&nbsp;too&nbsp;large&nbsp;and&nbsp;we&nbsp;have&nbsp;lots&nbsp;of&nbsp;overflow</span><br>
<span class="lineno"></span><span class="comment" id="1456747">//&nbsp;buckets,&nbsp;too&nbsp;small&nbsp;and&nbsp;we&nbsp;waste&nbsp;a&nbsp;lot&nbsp;of&nbsp;space.&nbsp;&nbsp;I&nbsp;wrote</span><br>
<span class="lineno">35</span><span class="comment" id="1456807">//&nbsp;a&nbsp;simple&nbsp;program&nbsp;to&nbsp;check&nbsp;some&nbsp;stats&nbsp;for&nbsp;different&nbsp;loads:</span><br>
<span class="lineno"></span><span class="comment" id="1456868">//&nbsp;(64-bit,&nbsp;8&nbsp;byte&nbsp;keys&nbsp;and&nbsp;values)</span><br>
<span class="lineno"></span><span class="comment" id="1456904">//&nbsp;&nbsp;loadFactor&nbsp;&nbsp;&nbsp;&nbsp;%overflow&nbsp;&nbsp;bytes/entry&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;missprobe</span><br>
<span class="lineno"></span><span class="comment" id="1456971">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00</span><br>
<span class="lineno"></span><span class="comment" id="1457038">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17.30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50</span><br>
<span class="lineno">40</span><span class="comment" id="1457105">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.85&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;14.77&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00</span><br>
<span class="lineno"></span><span class="comment" id="1457172">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12.94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.50</span><br>
<span class="lineno"></span><span class="comment" id="1457239">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15.27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;11.67&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.00</span><br>
<span class="lineno"></span><span class="comment" id="1457306">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20.90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.79&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6.50</span><br>
<span class="lineno"></span><span class="comment" id="1457373">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27.14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10.15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.00</span><br>
<span class="lineno">45</span><span class="comment" id="1457440">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;34.03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.73&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.75&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.50</span><br>
<span class="lineno"></span><span class="comment" id="1457507">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;41.10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;9.40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5.00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8.00</span><br>
<span class="lineno"></span><span class="comment" id="1457574">//</span><br>
<span class="lineno"></span><span class="comment" id="1457577">//&nbsp;%overflow&nbsp;&nbsp;&nbsp;=&nbsp;percentage&nbsp;of&nbsp;buckets&nbsp;which&nbsp;have&nbsp;an&nbsp;overflow&nbsp;bucket</span><br>
<span class="lineno"></span><span class="comment" id="1457646">//&nbsp;bytes/entry&nbsp;=&nbsp;overhead&nbsp;bytes&nbsp;used&nbsp;per&nbsp;key/value&nbsp;pair</span><br>
<span class="lineno">50</span><span class="comment" id="1457702">//&nbsp;hitprobe&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;present&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1457771">//&nbsp;missprobe&nbsp;&nbsp;&nbsp;=&nbsp;#&nbsp;of&nbsp;entries&nbsp;to&nbsp;check&nbsp;when&nbsp;looking&nbsp;up&nbsp;an&nbsp;absent&nbsp;key</span><br>
<span class="lineno"></span><span class="comment" id="1457840">//</span><br>
<span class="lineno"></span><span class="comment" id="1457843">//&nbsp;Keep&nbsp;in&nbsp;mind&nbsp;this&nbsp;data&nbsp;is&nbsp;for&nbsp;maximally&nbsp;loaded&nbsp;tables,&nbsp;i.e.&nbsp;just</span><br>
<span class="lineno"></span><span class="comment" id="1457911">//&nbsp;before&nbsp;the&nbsp;table&nbsp;grows.&nbsp;&nbsp;Typical&nbsp;tables&nbsp;will&nbsp;be&nbsp;somewhat&nbsp;less&nbsp;loaded.</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="1457985">import</span>&nbsp;<span class="op" id="1457992">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1457995">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1458004">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="1458007">const</span>&nbsp;<span class="op" id="1458013">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458016">//&nbsp;Maximum&nbsp;number&nbsp;of&nbsp;key/value&nbsp;pairs&nbsp;a&nbsp;bucket&nbsp;can&nbsp;hold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458073">bucketCntBits</span>&nbsp;<span class="op" id="1458087">=</span>&nbsp;<span class="num" id="1458089">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458092">bucketCnt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1458106">=</span>&nbsp;<span class="num" id="1458108">1</span>&nbsp;<span class="op" id="1458110">&lt;&lt;</span>&nbsp;<span class="ident" id="1458113">bucketCntBits</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458129">//&nbsp;Maximum&nbsp;average&nbsp;load&nbsp;of&nbsp;a&nbsp;bucket&nbsp;that&nbsp;triggers&nbsp;growth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458188">loadFactor</span>&nbsp;<span class="op" id="1458199">=</span>&nbsp;<span class="num" id="1458201">6.5</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458207">//&nbsp;Maximum&nbsp;key&nbsp;or&nbsp;value&nbsp;size&nbsp;to&nbsp;keep&nbsp;inline&nbsp;(instead&nbsp;of&nbsp;mallocing&nbsp;per&nbsp;element).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458288">//&nbsp;Must&nbsp;fit&nbsp;in&nbsp;a&nbsp;uint8.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458313">//&nbsp;Fast&nbsp;versions&nbsp;cannot&nbsp;handle&nbsp;big&nbsp;values&nbsp;-&nbsp;the&nbsp;cutoff&nbsp;size&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458378">//&nbsp;fast&nbsp;versions&nbsp;in&nbsp;../../cmd/gc/walk.c&nbsp;must&nbsp;be&nbsp;at&nbsp;most&nbsp;this&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458447">maxKeySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1458460">=</span>&nbsp;<span class="num" id="1458462">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458467">maxValueSize</span>&nbsp;<span class="op" id="1458480">=</span>&nbsp;<span class="num" id="1458482">128</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458488">//&nbsp;data&nbsp;offset&nbsp;should&nbsp;be&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;bmap&nbsp;struct,&nbsp;but&nbsp;needs&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458559">//&nbsp;aligned&nbsp;correctly.&nbsp;&nbsp;For&nbsp;amd64p32&nbsp;this&nbsp;means&nbsp;64-bit&nbsp;alignment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458624">//&nbsp;even&nbsp;though&nbsp;pointers&nbsp;are&nbsp;32&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458661">dataOffset</span>&nbsp;<span class="op" id="1458672">=</span>&nbsp;<span class="ident" id="1458674">unsafe</span><span class="op" id="1458680">.</span><span class="ident" id="1458681">Offsetof</span><span class="op" id="1458689">(</span><span class="keyword" id="1458690">struct</span>&nbsp;<span class="op" id="1458697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458701">b</span>&nbsp;<span class="ident" id="1458703">bmap</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1458710">v</span>&nbsp;<span class="ident" id="1458712">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1458719">}</span><span class="op" id="1458720">{</span><span class="op" id="1458721">}</span><span class="op" id="1458722">.</span><span class="ident" id="1458723">v</span><span class="op" id="1458724">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458728">//&nbsp;Possible&nbsp;tophash&nbsp;values.&nbsp;&nbsp;We&nbsp;reserve&nbsp;a&nbsp;few&nbsp;possibilities&nbsp;for&nbsp;special&nbsp;marks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458808">//&nbsp;Each&nbsp;bucket&nbsp;(including&nbsp;its&nbsp;overflow&nbsp;buckets,&nbsp;if&nbsp;any)&nbsp;will&nbsp;have&nbsp;either&nbsp;all&nbsp;or&nbsp;none&nbsp;of&nbsp;its</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458901">//&nbsp;entries&nbsp;in&nbsp;the&nbsp;evacuated*&nbsp;states&nbsp;(except&nbsp;during&nbsp;the&nbsp;evacuate()&nbsp;method,&nbsp;which&nbsp;only&nbsp;happens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1458995">//&nbsp;during&nbsp;map&nbsp;writes&nbsp;and&nbsp;thus&nbsp;no&nbsp;one&nbsp;else&nbsp;can&nbsp;observe&nbsp;the&nbsp;map&nbsp;during&nbsp;that&nbsp;time).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459077">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459092">=</span>&nbsp;<span class="num" id="1459094">0</span>&nbsp;<span class="comment" id="1459096">//&nbsp;cell&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459114">evacuatedEmpty</span>&nbsp;<span class="op" id="1459129">=</span>&nbsp;<span class="num" id="1459131">1</span>&nbsp;<span class="comment" id="1459133">//&nbsp;cell&nbsp;is&nbsp;empty,&nbsp;bucket&nbsp;is&nbsp;evacuated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459173">evacuatedX</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459188">=</span>&nbsp;<span class="num" id="1459190">2</span>&nbsp;<span class="comment" id="1459192">//&nbsp;key/value&nbsp;is&nbsp;valid.&nbsp;&nbsp;Entry&nbsp;has&nbsp;been&nbsp;evacuated&nbsp;to&nbsp;first&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459273">evacuatedY</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459288">=</span>&nbsp;<span class="num" id="1459290">3</span>&nbsp;<span class="comment" id="1459292">//&nbsp;same&nbsp;as&nbsp;above,&nbsp;but&nbsp;evacuated&nbsp;to&nbsp;second&nbsp;half&nbsp;of&nbsp;larger&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459357">minTopHash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459372">=</span>&nbsp;<span class="num" id="1459374">4</span>&nbsp;<span class="comment" id="1459376">//&nbsp;minimum&nbsp;tophash&nbsp;for&nbsp;a&nbsp;normal&nbsp;filled&nbsp;cell.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459423">//&nbsp;flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459433">iterator</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1459445">=</span>&nbsp;<span class="num" id="1459447">1</span>&nbsp;<span class="comment" id="1459449">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;buckets</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459492">oldIterator</span>&nbsp;<span class="op" id="1459504">=</span>&nbsp;<span class="num" id="1459506">2</span>&nbsp;<span class="comment" id="1459508">//&nbsp;there&nbsp;may&nbsp;be&nbsp;an&nbsp;iterator&nbsp;using&nbsp;oldbuckets</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459555">//&nbsp;sentinel&nbsp;bucket&nbsp;ID&nbsp;for&nbsp;iterator&nbsp;checks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459598">noCheck</span>&nbsp;<span class="op" id="1459606">=</span>&nbsp;<span class="num" id="1459608">1</span><span class="op" id="1459609">&lt;&lt;</span><span class="op" id="1459611">(</span><span class="num" id="1459612">8</span><span class="op" id="1459613">*</span><span class="ident" id="1459614">ptrSize</span><span class="op" id="1459621">)</span>&nbsp;<span class="op" id="1459623">-</span>&nbsp;<span class="num" id="1459625">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459629">//&nbsp;trigger&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;at&nbsp;every&nbsp;alloc&nbsp;called&nbsp;from&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459699">checkgc</span>&nbsp;<span class="op" id="1459707">=</span>&nbsp;<span class="builtintype" id="1459709">false</span><br>
<span class="lineno"></span><span class="op" id="1459715">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1459718">//&nbsp;A&nbsp;header&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno">105</span><span class="keyword" id="1459744">type</span>&nbsp;<span class="ident" id="1459749">hmap</span>&nbsp;<span class="keyword" id="1459754">struct</span>&nbsp;<span class="op" id="1459761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459764">//&nbsp;Note:&nbsp;the&nbsp;format&nbsp;of&nbsp;the&nbsp;Hmap&nbsp;is&nbsp;encoded&nbsp;in&nbsp;../../cmd/gc/reflect.c&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1459838">//&nbsp;../reflect/type.go.&nbsp;&nbsp;Don&#39;t&nbsp;change&nbsp;this&nbsp;structure&nbsp;without&nbsp;also&nbsp;changing&nbsp;that&nbsp;code!</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1459924">count</span>&nbsp;<span class="builtintype" id="1459930">int</span>&nbsp;<span class="comment" id="1459934">//&nbsp;#&nbsp;live&nbsp;cells&nbsp;==&nbsp;size&nbsp;of&nbsp;map.&nbsp;&nbsp;Must&nbsp;be&nbsp;first&nbsp;(used&nbsp;by&nbsp;len()&nbsp;builtin)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460006">flags</span>&nbsp;<span class="builtintype" id="1460012">uint32</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460020">hash0</span>&nbsp;<span class="builtintype" id="1460026">uint32</span>&nbsp;<span class="comment" id="1460033">//&nbsp;hash&nbsp;seed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460047">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1460053">uint8</span>&nbsp;&nbsp;<span class="comment" id="1460060">//&nbsp;log_2&nbsp;of&nbsp;#&nbsp;of&nbsp;buckets&nbsp;(can&nbsp;hold&nbsp;up&nbsp;to&nbsp;loadFactor&nbsp;*&nbsp;2^B&nbsp;items)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460127">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460138">unsafe</span><span class="op" id="1460144">.</span><span class="ident" id="1460145">Pointer</span>&nbsp;<span class="comment" id="1460153">//&nbsp;array&nbsp;of&nbsp;2^B&nbsp;Buckets.&nbsp;may&nbsp;be&nbsp;nil&nbsp;if&nbsp;count==0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460203">oldbuckets</span>&nbsp;<span class="ident" id="1460214">unsafe</span><span class="op" id="1460220">.</span><span class="ident" id="1460221">Pointer</span>&nbsp;<span class="comment" id="1460229">//&nbsp;previous&nbsp;bucket&nbsp;array&nbsp;of&nbsp;half&nbsp;the&nbsp;size,&nbsp;non-nil&nbsp;only&nbsp;when&nbsp;growing</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460299">nevacuate</span>&nbsp;&nbsp;<span class="builtintype" id="1460310">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1460325">//&nbsp;progress&nbsp;counter&nbsp;for&nbsp;evacuation&nbsp;(buckets&nbsp;less&nbsp;than&nbsp;this&nbsp;have&nbsp;been&nbsp;evacuated)</span><br>
<span class="lineno"></span><span class="op" id="1460405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1460408">//&nbsp;A&nbsp;bucket&nbsp;for&nbsp;a&nbsp;Go&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="1460434">type</span>&nbsp;<span class="ident" id="1460439">bmap</span>&nbsp;<span class="keyword" id="1460444">struct</span>&nbsp;<span class="op" id="1460451">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460454">tophash</span>&nbsp;&nbsp;<span class="op" id="1460463">[</span><span class="ident" id="1460464">bucketCnt</span><span class="op" id="1460473">]</span><span class="builtintype" id="1460474">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460481">overflow</span>&nbsp;<span class="op" id="1460490">*</span><span class="ident" id="1460491">bmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1460497">//&nbsp;Followed&nbsp;by&nbsp;bucketCnt&nbsp;keys&nbsp;and&nbsp;then&nbsp;bucketCnt&nbsp;values.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1460555">//&nbsp;NOTE:&nbsp;packing&nbsp;all&nbsp;the&nbsp;keys&nbsp;together&nbsp;and&nbsp;then&nbsp;all&nbsp;the&nbsp;values&nbsp;together&nbsp;makes&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1460638">//&nbsp;code&nbsp;a&nbsp;bit&nbsp;more&nbsp;complicated&nbsp;than&nbsp;alternating&nbsp;key/value/key/value/...&nbsp;but&nbsp;it&nbsp;allows</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1460725">//&nbsp;us&nbsp;to&nbsp;eliminate&nbsp;padding&nbsp;which&nbsp;would&nbsp;be&nbsp;needed&nbsp;for,&nbsp;e.g.,&nbsp;map[int64]int8.</span><br>
<span class="lineno"></span><span class="op" id="1460801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1460804">//&nbsp;A&nbsp;hash&nbsp;iteration&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="1460835">//&nbsp;If&nbsp;you&nbsp;modify&nbsp;hiter,&nbsp;also&nbsp;change&nbsp;cmd/gc/reflect.c&nbsp;to&nbsp;indicate</span><br>
<span class="lineno">130</span><span class="comment" id="1460900">//&nbsp;the&nbsp;layout&nbsp;of&nbsp;this&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="1460933">type</span>&nbsp;<span class="ident" id="1460938">hiter</span>&nbsp;<span class="keyword" id="1460944">struct</span>&nbsp;<span class="op" id="1460951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1460954">key</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1460966">unsafe</span><span class="op" id="1460972">.</span><span class="ident" id="1460973">Pointer</span>&nbsp;<span class="comment" id="1460981">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;first&nbsp;position.&nbsp;&nbsp;Write&nbsp;nil&nbsp;to&nbsp;indicate&nbsp;iteration&nbsp;end&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461071">value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461083">unsafe</span><span class="op" id="1461089">.</span><span class="ident" id="1461090">Pointer</span>&nbsp;<span class="comment" id="1461098">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;second&nbsp;position&nbsp;(see&nbsp;cmd/gc/range.c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461151">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461163">*</span><span class="ident" id="1461164">maptype</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461173">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461185">*</span><span class="ident" id="1461186">hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461192">buckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1461204">unsafe</span><span class="op" id="1461210">.</span><span class="ident" id="1461211">Pointer</span>&nbsp;<span class="comment" id="1461219">//&nbsp;bucket&nbsp;ptr&nbsp;at&nbsp;hash_iter&nbsp;initialization&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461267">bptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1461279">*</span><span class="ident" id="1461280">bmap</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461294">//&nbsp;current&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461313">startBucket</span>&nbsp;<span class="builtintype" id="1461325">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461340">//&nbsp;bucket&nbsp;iteration&nbsp;started&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461372">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1461384">uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461399">//&nbsp;intra-bucket&nbsp;offset&nbsp;to&nbsp;start&nbsp;from&nbsp;during&nbsp;iteration&nbsp;(should&nbsp;be&nbsp;big&nbsp;enough&nbsp;to&nbsp;hold&nbsp;bucketCnt-1)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461497">wrapped</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1461509">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1461524">//&nbsp;already&nbsp;wrapped&nbsp;around&nbsp;from&nbsp;end&nbsp;of&nbsp;bucket&nbsp;array&nbsp;to&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461589">B</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1461601">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461608">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1461620">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461627">bucket</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1461639">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461648">checkBucket</span>&nbsp;<span class="builtintype" id="1461660">uintptr</span><br>
<span class="lineno">145</span><span class="op" id="1461668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1461671">func</span>&nbsp;<span class="ident" id="1461676">evacuated</span><span class="op" id="1461685">(</span><span class="ident" id="1461686">b</span>&nbsp;<span class="op" id="1461688">*</span><span class="ident" id="1461689">bmap</span><span class="op" id="1461693">)</span>&nbsp;<span class="builtintype" id="1461695">bool</span>&nbsp;<span class="op" id="1461700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461703">h</span>&nbsp;<span class="op" id="1461705">:=</span>&nbsp;<span class="ident" id="1461708">b</span><span class="op" id="1461709">.</span><span class="ident" id="1461710">tophash</span><span class="op" id="1461717">[</span><span class="num" id="1461718">0</span><span class="op" id="1461719">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461722">return</span>&nbsp;<span class="ident" id="1461729">h</span>&nbsp;<span class="op" id="1461731">&gt;</span>&nbsp;<span class="ident" id="1461733">empty</span>&nbsp;<span class="op" id="1461739">&amp;&amp;</span>&nbsp;<span class="ident" id="1461742">h</span>&nbsp;<span class="op" id="1461744">&lt;</span>&nbsp;<span class="ident" id="1461746">minTopHash</span><br>
<span class="lineno">150</span><span class="op" id="1461757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1461760">func</span>&nbsp;<span class="ident" id="1461765">makemap</span><span class="op" id="1461772">(</span><span class="ident" id="1461773">t</span>&nbsp;<span class="op" id="1461775">*</span><span class="ident" id="1461776">maptype</span><span class="op" id="1461783">,</span>&nbsp;<span class="ident" id="1461785">hint</span>&nbsp;<span class="ident" id="1461790">int64</span><span class="op" id="1461795">)</span>&nbsp;<span class="op" id="1461797">*</span><span class="ident" id="1461798">hmap</span>&nbsp;<span class="op" id="1461803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461806">if</span>&nbsp;<span class="ident" id="1461809">sz</span>&nbsp;<span class="op" id="1461812">:=</span>&nbsp;<span class="ident" id="1461815">unsafe</span><span class="op" id="1461821">.</span><span class="ident" id="1461822">Sizeof</span><span class="op" id="1461828">(</span><span class="ident" id="1461829">hmap</span><span class="op" id="1461833">{</span><span class="op" id="1461834">}</span><span class="op" id="1461835">)</span><span class="op" id="1461836">;</span>&nbsp;<span class="ident" id="1461838">sz</span>&nbsp;<span class="op" id="1461841">&gt;</span>&nbsp;<span class="num" id="1461843">48</span>&nbsp;<span class="op" id="1461846">||</span>&nbsp;<span class="ident" id="1461849">sz</span>&nbsp;<span class="op" id="1461852">!=</span>&nbsp;<span class="builtintype" id="1461855">uintptr</span><span class="op" id="1461862">(</span><span class="ident" id="1461863">t</span><span class="op" id="1461864">.</span><span class="ident" id="1461865">hmap</span><span class="op" id="1461869">.</span><span class="ident" id="1461870">size</span><span class="op" id="1461874">)</span>&nbsp;<span class="op" id="1461876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1461880">gothrow</span><span class="op" id="1461887">(</span><span class="string" id="1461888">&#34;bad&nbsp;hmap&nbsp;size&#34;</span><span class="op" id="1461903">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1461906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1461910">if</span>&nbsp;<span class="ident" id="1461913">hint</span>&nbsp;<span class="op" id="1461918">&lt;</span>&nbsp;<span class="num" id="1461920">0</span>&nbsp;<span class="op" id="1461922">||</span>&nbsp;<span class="ident" id="1461925">int64</span><span class="op" id="1461930">(</span><span class="builtintype" id="1461931">int32</span><span class="op" id="1461936">(</span><span class="ident" id="1461937">hint</span><span class="op" id="1461941">)</span><span class="op" id="1461942">)</span>&nbsp;<span class="op" id="1461944">!=</span>&nbsp;<span class="ident" id="1461947">hint</span>&nbsp;<span class="op" id="1461952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1461956">panic</span><span class="op" id="1461961">(</span><span class="string" id="1461962">&#34;makemap:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1461990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1461994">//&nbsp;TODO:&nbsp;make&nbsp;hint&nbsp;an&nbsp;int,&nbsp;then&nbsp;none&nbsp;of&nbsp;this&nbsp;nonsense</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462053">if</span>&nbsp;<span class="op" id="1462056">!</span><span class="ident" id="1462057">ismapkey</span><span class="op" id="1462065">(</span><span class="ident" id="1462066">t</span><span class="op" id="1462067">.</span><span class="ident" id="1462068">key</span><span class="op" id="1462071">)</span>&nbsp;<span class="op" id="1462073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462077">gothrow</span><span class="op" id="1462084">(</span><span class="string" id="1462085">&#34;runtime.makemap:&nbsp;unsupported&nbsp;map&nbsp;key&nbsp;type&#34;</span><span class="op" id="1462128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462131">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1462135">//&nbsp;check&nbsp;compiler&#39;s&nbsp;and&nbsp;reflect&#39;s&nbsp;math</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462175">if</span>&nbsp;<span class="ident" id="1462178">t</span><span class="op" id="1462179">.</span><span class="ident" id="1462180">key</span><span class="op" id="1462183">.</span><span class="ident" id="1462184">size</span>&nbsp;<span class="op" id="1462189">&gt;</span>&nbsp;<span class="ident" id="1462191">maxKeySize</span>&nbsp;<span class="op" id="1462202">&amp;&amp;</span>&nbsp;<span class="op" id="1462205">(</span><span class="op" id="1462206">!</span><span class="ident" id="1462207">t</span><span class="op" id="1462208">.</span><span class="ident" id="1462209">indirectkey</span>&nbsp;<span class="op" id="1462221">||</span>&nbsp;<span class="ident" id="1462224">t</span><span class="op" id="1462225">.</span><span class="ident" id="1462226">keysize</span>&nbsp;<span class="op" id="1462234">!=</span>&nbsp;<span class="builtintype" id="1462237">uint8</span><span class="op" id="1462242">(</span><span class="ident" id="1462243">ptrSize</span><span class="op" id="1462250">)</span><span class="op" id="1462251">)</span>&nbsp;<span class="op" id="1462253">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462258">t</span><span class="op" id="1462259">.</span><span class="ident" id="1462260">key</span><span class="op" id="1462263">.</span><span class="ident" id="1462264">size</span>&nbsp;<span class="op" id="1462269">&lt;=</span>&nbsp;<span class="ident" id="1462272">maxKeySize</span>&nbsp;<span class="op" id="1462283">&amp;&amp;</span>&nbsp;<span class="op" id="1462286">(</span><span class="ident" id="1462287">t</span><span class="op" id="1462288">.</span><span class="ident" id="1462289">indirectkey</span>&nbsp;<span class="op" id="1462301">||</span>&nbsp;<span class="ident" id="1462304">t</span><span class="op" id="1462305">.</span><span class="ident" id="1462306">keysize</span>&nbsp;<span class="op" id="1462314">!=</span>&nbsp;<span class="builtintype" id="1462317">uint8</span><span class="op" id="1462322">(</span><span class="ident" id="1462323">t</span><span class="op" id="1462324">.</span><span class="ident" id="1462325">key</span><span class="op" id="1462328">.</span><span class="ident" id="1462329">size</span><span class="op" id="1462333">)</span><span class="op" id="1462334">)</span>&nbsp;<span class="op" id="1462336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462340">gothrow</span><span class="op" id="1462347">(</span><span class="string" id="1462348">&#34;key&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1462364">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462370">if</span>&nbsp;<span class="ident" id="1462373">t</span><span class="op" id="1462374">.</span><span class="ident" id="1462375">elem</span><span class="op" id="1462379">.</span><span class="ident" id="1462380">size</span>&nbsp;<span class="op" id="1462385">&gt;</span>&nbsp;<span class="ident" id="1462387">maxValueSize</span>&nbsp;<span class="op" id="1462400">&amp;&amp;</span>&nbsp;<span class="op" id="1462403">(</span><span class="op" id="1462404">!</span><span class="ident" id="1462405">t</span><span class="op" id="1462406">.</span><span class="ident" id="1462407">indirectvalue</span>&nbsp;<span class="op" id="1462421">||</span>&nbsp;<span class="ident" id="1462424">t</span><span class="op" id="1462425">.</span><span class="ident" id="1462426">valuesize</span>&nbsp;<span class="op" id="1462436">!=</span>&nbsp;<span class="builtintype" id="1462439">uint8</span><span class="op" id="1462444">(</span><span class="ident" id="1462445">ptrSize</span><span class="op" id="1462452">)</span><span class="op" id="1462453">)</span>&nbsp;<span class="op" id="1462455">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462460">t</span><span class="op" id="1462461">.</span><span class="ident" id="1462462">elem</span><span class="op" id="1462466">.</span><span class="ident" id="1462467">size</span>&nbsp;<span class="op" id="1462472">&lt;=</span>&nbsp;<span class="ident" id="1462475">maxValueSize</span>&nbsp;<span class="op" id="1462488">&amp;&amp;</span>&nbsp;<span class="op" id="1462491">(</span><span class="ident" id="1462492">t</span><span class="op" id="1462493">.</span><span class="ident" id="1462494">indirectvalue</span>&nbsp;<span class="op" id="1462508">||</span>&nbsp;<span class="ident" id="1462511">t</span><span class="op" id="1462512">.</span><span class="ident" id="1462513">valuesize</span>&nbsp;<span class="op" id="1462523">!=</span>&nbsp;<span class="builtintype" id="1462526">uint8</span><span class="op" id="1462531">(</span><span class="ident" id="1462532">t</span><span class="op" id="1462533">.</span><span class="ident" id="1462534">elem</span><span class="op" id="1462538">.</span><span class="ident" id="1462539">size</span><span class="op" id="1462543">)</span><span class="op" id="1462544">)</span>&nbsp;<span class="op" id="1462546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462550">gothrow</span><span class="op" id="1462557">(</span><span class="string" id="1462558">&#34;value&nbsp;size&nbsp;wrong&#34;</span><span class="op" id="1462576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462579">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1462583">//&nbsp;invariants&nbsp;we&nbsp;depend&nbsp;on.&nbsp;&nbsp;We&nbsp;should&nbsp;probably&nbsp;check&nbsp;these&nbsp;at&nbsp;compile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1462660">//&nbsp;somewhere,&nbsp;but&nbsp;for&nbsp;now&nbsp;we&#39;ll&nbsp;do&nbsp;it&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462705">if</span>&nbsp;<span class="ident" id="1462708">t</span><span class="op" id="1462709">.</span><span class="ident" id="1462710">key</span><span class="op" id="1462713">.</span><span class="ident" id="1462714">align</span>&nbsp;<span class="op" id="1462720">&gt;</span>&nbsp;<span class="ident" id="1462722">bucketCnt</span>&nbsp;<span class="op" id="1462732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462736">gothrow</span><span class="op" id="1462743">(</span><span class="string" id="1462744">&#34;key&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1462763">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462769">if</span>&nbsp;<span class="ident" id="1462772">t</span><span class="op" id="1462773">.</span><span class="ident" id="1462774">elem</span><span class="op" id="1462778">.</span><span class="ident" id="1462779">align</span>&nbsp;<span class="op" id="1462785">&gt;</span>&nbsp;<span class="ident" id="1462787">bucketCnt</span>&nbsp;<span class="op" id="1462797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462801">gothrow</span><span class="op" id="1462808">(</span><span class="string" id="1462809">&#34;value&nbsp;align&nbsp;too&nbsp;big&#34;</span><span class="op" id="1462830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462836">if</span>&nbsp;<span class="builtintype" id="1462839">uintptr</span><span class="op" id="1462846">(</span><span class="ident" id="1462847">t</span><span class="op" id="1462848">.</span><span class="ident" id="1462849">key</span><span class="op" id="1462852">.</span><span class="ident" id="1462853">size</span><span class="op" id="1462857">)</span><span class="op" id="1462858">%</span><span class="builtintype" id="1462859">uintptr</span><span class="op" id="1462866">(</span><span class="ident" id="1462867">t</span><span class="op" id="1462868">.</span><span class="ident" id="1462869">key</span><span class="op" id="1462872">.</span><span class="ident" id="1462873">align</span><span class="op" id="1462878">)</span>&nbsp;<span class="op" id="1462880">!=</span>&nbsp;<span class="num" id="1462883">0</span>&nbsp;<span class="op" id="1462885">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462889">gothrow</span><span class="op" id="1462896">(</span><span class="string" id="1462897">&#34;key&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;key&nbsp;align&#34;</span><span class="op" id="1462935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1462938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1462941">if</span>&nbsp;<span class="builtintype" id="1462944">uintptr</span><span class="op" id="1462951">(</span><span class="ident" id="1462952">t</span><span class="op" id="1462953">.</span><span class="ident" id="1462954">elem</span><span class="op" id="1462958">.</span><span class="ident" id="1462959">size</span><span class="op" id="1462963">)</span><span class="op" id="1462964">%</span><span class="builtintype" id="1462965">uintptr</span><span class="op" id="1462972">(</span><span class="ident" id="1462973">t</span><span class="op" id="1462974">.</span><span class="ident" id="1462975">elem</span><span class="op" id="1462979">.</span><span class="ident" id="1462980">align</span><span class="op" id="1462985">)</span>&nbsp;<span class="op" id="1462987">!=</span>&nbsp;<span class="num" id="1462990">0</span>&nbsp;<span class="op" id="1462992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1462996">gothrow</span><span class="op" id="1463003">(</span><span class="string" id="1463004">&#34;value&nbsp;size&nbsp;not&nbsp;a&nbsp;multiple&nbsp;of&nbsp;value&nbsp;align&#34;</span><span class="op" id="1463046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463049">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463052">if</span>&nbsp;<span class="ident" id="1463055">bucketCnt</span>&nbsp;<span class="op" id="1463065">&lt;</span>&nbsp;<span class="num" id="1463067">8</span>&nbsp;<span class="op" id="1463069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463073">gothrow</span><span class="op" id="1463080">(</span><span class="string" id="1463081">&#34;bucketsize&nbsp;too&nbsp;small&nbsp;for&nbsp;proper&nbsp;alignment&#34;</span><span class="op" id="1463124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463130">if</span>&nbsp;<span class="ident" id="1463133">dataOffset</span><span class="op" id="1463143">%</span><span class="builtintype" id="1463144">uintptr</span><span class="op" id="1463151">(</span><span class="ident" id="1463152">t</span><span class="op" id="1463153">.</span><span class="ident" id="1463154">key</span><span class="op" id="1463157">.</span><span class="ident" id="1463158">align</span><span class="op" id="1463163">)</span>&nbsp;<span class="op" id="1463165">!=</span>&nbsp;<span class="num" id="1463168">0</span>&nbsp;<span class="op" id="1463170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463174">gothrow</span><span class="op" id="1463181">(</span><span class="string" id="1463182">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(key)&#34;</span><span class="op" id="1463212">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463218">if</span>&nbsp;<span class="ident" id="1463221">dataOffset</span><span class="op" id="1463231">%</span><span class="builtintype" id="1463232">uintptr</span><span class="op" id="1463239">(</span><span class="ident" id="1463240">t</span><span class="op" id="1463241">.</span><span class="ident" id="1463242">elem</span><span class="op" id="1463246">.</span><span class="ident" id="1463247">align</span><span class="op" id="1463252">)</span>&nbsp;<span class="op" id="1463254">!=</span>&nbsp;<span class="num" id="1463257">0</span>&nbsp;<span class="op" id="1463259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463263">gothrow</span><span class="op" id="1463270">(</span><span class="string" id="1463271">&#34;need&nbsp;padding&nbsp;in&nbsp;bucket&nbsp;(value)&#34;</span><span class="op" id="1463303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1463310">//&nbsp;find&nbsp;size&nbsp;parameter&nbsp;which&nbsp;will&nbsp;hold&nbsp;the&nbsp;requested&nbsp;#&nbsp;of&nbsp;elements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463378">B</span>&nbsp;<span class="op" id="1463380">:=</span>&nbsp;<span class="builtintype" id="1463383">uint8</span><span class="op" id="1463388">(</span><span class="num" id="1463389">0</span><span class="op" id="1463390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463393">for</span>&nbsp;<span class="op" id="1463397">;</span>&nbsp;<span class="ident" id="1463399">hint</span>&nbsp;<span class="op" id="1463404">&gt;</span>&nbsp;<span class="ident" id="1463406">bucketCnt</span>&nbsp;<span class="op" id="1463416">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1463419">float32</span><span class="op" id="1463426">(</span><span class="ident" id="1463427">hint</span><span class="op" id="1463431">)</span>&nbsp;<span class="op" id="1463433">&gt;</span>&nbsp;<span class="ident" id="1463435">loadFactor</span><span class="op" id="1463445">*</span><span class="builtintype" id="1463446">float32</span><span class="op" id="1463453">(</span><span class="builtintype" id="1463454">uintptr</span><span class="op" id="1463461">(</span><span class="num" id="1463462">1</span><span class="op" id="1463463">)</span><span class="op" id="1463464">&lt;&lt;</span><span class="ident" id="1463466">B</span><span class="op" id="1463467">)</span><span class="op" id="1463468">;</span>&nbsp;<span class="ident" id="1463470">B</span><span class="op" id="1463471">++</span>&nbsp;<span class="op" id="1463474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1463481">//&nbsp;allocate&nbsp;initial&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1463513">//&nbsp;if&nbsp;B&nbsp;==&nbsp;0,&nbsp;the&nbsp;buckets&nbsp;field&nbsp;is&nbsp;allocated&nbsp;lazily&nbsp;later&nbsp;(in&nbsp;mapassign)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1463587">//&nbsp;If&nbsp;hint&nbsp;is&nbsp;large&nbsp;zeroing&nbsp;this&nbsp;memory&nbsp;could&nbsp;take&nbsp;a&nbsp;while.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463648">var</span>&nbsp;<span class="ident" id="1463652">buckets</span>&nbsp;<span class="ident" id="1463660">unsafe</span><span class="op" id="1463666">.</span><span class="ident" id="1463667">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463676">if</span>&nbsp;<span class="ident" id="1463679">B</span>&nbsp;<span class="op" id="1463681">!=</span>&nbsp;<span class="num" id="1463684">0</span>&nbsp;<span class="op" id="1463686">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463690">if</span>&nbsp;<span class="ident" id="1463693">checkgc</span>&nbsp;<span class="op" id="1463701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463706">memstats</span><span class="op" id="1463714">.</span><span class="ident" id="1463715">next_gc</span>&nbsp;<span class="op" id="1463723">=</span>&nbsp;<span class="ident" id="1463725">memstats</span><span class="op" id="1463733">.</span><span class="ident" id="1463734">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463751">buckets</span>&nbsp;<span class="op" id="1463759">=</span>&nbsp;<span class="ident" id="1463761">newarray</span><span class="op" id="1463769">(</span><span class="ident" id="1463770">t</span><span class="op" id="1463771">.</span><span class="ident" id="1463772">bucket</span><span class="op" id="1463778">,</span>&nbsp;<span class="builtintype" id="1463780">uintptr</span><span class="op" id="1463787">(</span><span class="num" id="1463788">1</span><span class="op" id="1463789">)</span><span class="op" id="1463790">&lt;&lt;</span><span class="ident" id="1463792">B</span><span class="op" id="1463793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463796">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1463800">//&nbsp;initialize&nbsp;Hmap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1463820">if</span>&nbsp;<span class="ident" id="1463823">checkgc</span>&nbsp;<span class="op" id="1463831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463835">memstats</span><span class="op" id="1463843">.</span><span class="ident" id="1463844">next_gc</span>&nbsp;<span class="op" id="1463852">=</span>&nbsp;<span class="ident" id="1463854">memstats</span><span class="op" id="1463862">.</span><span class="ident" id="1463863">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1463875">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463878">h</span>&nbsp;<span class="op" id="1463880">:=</span>&nbsp;<span class="op" id="1463883">(</span><span class="op" id="1463884">*</span><span class="ident" id="1463885">hmap</span><span class="op" id="1463889">)</span><span class="op" id="1463890">(</span><span class="ident" id="1463891">newobject</span><span class="op" id="1463900">(</span><span class="ident" id="1463901">t</span><span class="op" id="1463902">.</span><span class="ident" id="1463903">hmap</span><span class="op" id="1463907">)</span><span class="op" id="1463908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463911">h</span><span class="op" id="1463912">.</span><span class="ident" id="1463913">count</span>&nbsp;<span class="op" id="1463919">=</span>&nbsp;<span class="num" id="1463921">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463924">h</span><span class="op" id="1463925">.</span><span class="ident" id="1463926">B</span>&nbsp;<span class="op" id="1463928">=</span>&nbsp;<span class="ident" id="1463930">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463933">h</span><span class="op" id="1463934">.</span><span class="ident" id="1463935">flags</span>&nbsp;<span class="op" id="1463941">=</span>&nbsp;<span class="num" id="1463943">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463946">h</span><span class="op" id="1463947">.</span><span class="ident" id="1463948">hash0</span>&nbsp;<span class="op" id="1463954">=</span>&nbsp;<span class="ident" id="1463956">fastrand1</span><span class="op" id="1463965">(</span><span class="op" id="1463966">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463969">h</span><span class="op" id="1463970">.</span><span class="ident" id="1463971">buckets</span>&nbsp;<span class="op" id="1463979">=</span>&nbsp;<span class="ident" id="1463981">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1463990">h</span><span class="op" id="1463991">.</span><span class="ident" id="1463992">oldbuckets</span>&nbsp;<span class="op" id="1464003">=</span>&nbsp;<span class="ident" id="1464005">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464010">h</span><span class="op" id="1464011">.</span><span class="ident" id="1464012">nevacuate</span>&nbsp;<span class="op" id="1464022">=</span>&nbsp;<span class="num" id="1464024">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464028">return</span>&nbsp;<span class="ident" id="1464035">h</span><br>
<span class="lineno">230</span><span class="op" id="1464037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1464040">//&nbsp;mapaccess1&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;h[key].&nbsp;&nbsp;Never&nbsp;returns&nbsp;nil,&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1464111">//&nbsp;it&nbsp;will&nbsp;return&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;zero&nbsp;object&nbsp;for&nbsp;the&nbsp;value&nbsp;type&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="1464182">//&nbsp;the&nbsp;key&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">235</span><span class="comment" id="1464212">//&nbsp;NOTE:&nbsp;The&nbsp;returned&nbsp;pointer&nbsp;may&nbsp;keep&nbsp;the&nbsp;whole&nbsp;map&nbsp;live,&nbsp;so&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1464280">//&nbsp;hold&nbsp;onto&nbsp;it&nbsp;for&nbsp;very&nbsp;long.</span><br>
<span class="lineno"></span><span class="keyword" id="1464311">func</span>&nbsp;<span class="ident" id="1464316">mapaccess1</span><span class="op" id="1464326">(</span><span class="ident" id="1464327">t</span>&nbsp;<span class="op" id="1464329">*</span><span class="ident" id="1464330">maptype</span><span class="op" id="1464337">,</span>&nbsp;<span class="ident" id="1464339">h</span>&nbsp;<span class="op" id="1464341">*</span><span class="ident" id="1464342">hmap</span><span class="op" id="1464346">,</span>&nbsp;<span class="ident" id="1464348">key</span>&nbsp;<span class="ident" id="1464352">unsafe</span><span class="op" id="1464358">.</span><span class="ident" id="1464359">Pointer</span><span class="op" id="1464366">)</span>&nbsp;<span class="ident" id="1464368">unsafe</span><span class="op" id="1464374">.</span><span class="ident" id="1464375">Pointer</span>&nbsp;<span class="op" id="1464383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464386">if</span>&nbsp;<span class="ident" id="1464389">raceenabled</span>&nbsp;<span class="op" id="1464401">&amp;&amp;</span>&nbsp;<span class="ident" id="1464404">h</span>&nbsp;<span class="op" id="1464406">!=</span>&nbsp;<span class="ident" id="1464409">nil</span>&nbsp;<span class="op" id="1464413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464417">callerpc</span>&nbsp;<span class="op" id="1464426">:=</span>&nbsp;<span class="ident" id="1464429">getcallerpc</span><span class="op" id="1464440">(</span><span class="ident" id="1464441">unsafe</span><span class="op" id="1464447">.</span><span class="ident" id="1464448">Pointer</span><span class="op" id="1464455">(</span><span class="op" id="1464456">&amp;</span><span class="ident" id="1464457">t</span><span class="op" id="1464458">)</span><span class="op" id="1464459">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464463">pc</span>&nbsp;<span class="op" id="1464466">:=</span>&nbsp;<span class="ident" id="1464469">funcPC</span><span class="op" id="1464475">(</span><span class="ident" id="1464476">mapaccess1</span><span class="op" id="1464486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464490">racereadpc</span><span class="op" id="1464500">(</span><span class="ident" id="1464501">unsafe</span><span class="op" id="1464507">.</span><span class="ident" id="1464508">Pointer</span><span class="op" id="1464515">(</span><span class="ident" id="1464516">h</span><span class="op" id="1464517">)</span><span class="op" id="1464518">,</span>&nbsp;<span class="ident" id="1464520">callerpc</span><span class="op" id="1464528">,</span>&nbsp;<span class="ident" id="1464530">pc</span><span class="op" id="1464532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464536">raceReadObjectPC</span><span class="op" id="1464552">(</span><span class="ident" id="1464553">t</span><span class="op" id="1464554">.</span><span class="ident" id="1464555">key</span><span class="op" id="1464558">,</span>&nbsp;<span class="ident" id="1464560">key</span><span class="op" id="1464563">,</span>&nbsp;<span class="ident" id="1464565">callerpc</span><span class="op" id="1464573">,</span>&nbsp;<span class="ident" id="1464575">pc</span><span class="op" id="1464577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1464580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464583">if</span>&nbsp;<span class="ident" id="1464586">h</span>&nbsp;<span class="op" id="1464588">==</span>&nbsp;<span class="ident" id="1464591">nil</span>&nbsp;<span class="op" id="1464595">||</span>&nbsp;<span class="ident" id="1464598">h</span><span class="op" id="1464599">.</span><span class="ident" id="1464600">count</span>&nbsp;<span class="op" id="1464606">==</span>&nbsp;<span class="num" id="1464609">0</span>&nbsp;<span class="op" id="1464611">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464615">return</span>&nbsp;<span class="ident" id="1464622">unsafe</span><span class="op" id="1464628">.</span><span class="ident" id="1464629">Pointer</span><span class="op" id="1464636">(</span><span class="ident" id="1464637">t</span><span class="op" id="1464638">.</span><span class="ident" id="1464639">elem</span><span class="op" id="1464643">.</span><span class="ident" id="1464644">zero</span><span class="op" id="1464648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1464651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464654">alg</span>&nbsp;<span class="op" id="1464658">:=</span>&nbsp;<span class="ident" id="1464661">goalg</span><span class="op" id="1464666">(</span><span class="ident" id="1464667">t</span><span class="op" id="1464668">.</span><span class="ident" id="1464669">key</span><span class="op" id="1464672">.</span><span class="ident" id="1464673">alg</span><span class="op" id="1464676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464679">hash</span>&nbsp;<span class="op" id="1464684">:=</span>&nbsp;<span class="ident" id="1464687">alg</span><span class="op" id="1464690">.</span><span class="ident" id="1464691">hash</span><span class="op" id="1464695">(</span><span class="ident" id="1464696">key</span><span class="op" id="1464699">,</span>&nbsp;<span class="builtintype" id="1464701">uintptr</span><span class="op" id="1464708">(</span><span class="ident" id="1464709">t</span><span class="op" id="1464710">.</span><span class="ident" id="1464711">key</span><span class="op" id="1464714">.</span><span class="ident" id="1464715">size</span><span class="op" id="1464719">)</span><span class="op" id="1464720">,</span>&nbsp;<span class="builtintype" id="1464722">uintptr</span><span class="op" id="1464729">(</span><span class="ident" id="1464730">h</span><span class="op" id="1464731">.</span><span class="ident" id="1464732">hash0</span><span class="op" id="1464737">)</span><span class="op" id="1464738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464741">m</span>&nbsp;<span class="op" id="1464743">:=</span>&nbsp;<span class="builtintype" id="1464746">uintptr</span><span class="op" id="1464753">(</span><span class="num" id="1464754">1</span><span class="op" id="1464755">)</span><span class="op" id="1464756">&lt;&lt;</span><span class="ident" id="1464758">h</span><span class="op" id="1464759">.</span><span class="ident" id="1464760">B</span>&nbsp;<span class="op" id="1464762">-</span>&nbsp;<span class="num" id="1464764">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464767">b</span>&nbsp;<span class="op" id="1464769">:=</span>&nbsp;<span class="op" id="1464772">(</span><span class="op" id="1464773">*</span><span class="ident" id="1464774">bmap</span><span class="op" id="1464778">)</span><span class="op" id="1464779">(</span><span class="ident" id="1464780">add</span><span class="op" id="1464783">(</span><span class="ident" id="1464784">h</span><span class="op" id="1464785">.</span><span class="ident" id="1464786">buckets</span><span class="op" id="1464793">,</span>&nbsp;<span class="op" id="1464795">(</span><span class="ident" id="1464796">hash</span><span class="op" id="1464800">&amp;</span><span class="ident" id="1464801">m</span><span class="op" id="1464802">)</span><span class="op" id="1464803">*</span><span class="builtintype" id="1464804">uintptr</span><span class="op" id="1464811">(</span><span class="ident" id="1464812">t</span><span class="op" id="1464813">.</span><span class="ident" id="1464814">bucketsize</span><span class="op" id="1464824">)</span><span class="op" id="1464825">)</span><span class="op" id="1464826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464829">if</span>&nbsp;<span class="ident" id="1464832">c</span>&nbsp;<span class="op" id="1464834">:=</span>&nbsp;<span class="ident" id="1464837">h</span><span class="op" id="1464838">.</span><span class="ident" id="1464839">oldbuckets</span><span class="op" id="1464849">;</span>&nbsp;<span class="ident" id="1464851">c</span>&nbsp;<span class="op" id="1464853">!=</span>&nbsp;<span class="ident" id="1464856">nil</span>&nbsp;<span class="op" id="1464860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464864">oldb</span>&nbsp;<span class="op" id="1464869">:=</span>&nbsp;<span class="op" id="1464872">(</span><span class="op" id="1464873">*</span><span class="ident" id="1464874">bmap</span><span class="op" id="1464878">)</span><span class="op" id="1464879">(</span><span class="ident" id="1464880">add</span><span class="op" id="1464883">(</span><span class="ident" id="1464884">c</span><span class="op" id="1464885">,</span>&nbsp;<span class="op" id="1464887">(</span><span class="ident" id="1464888">hash</span><span class="op" id="1464892">&amp;</span><span class="op" id="1464893">(</span><span class="ident" id="1464894">m</span><span class="op" id="1464895">&gt;&gt;</span><span class="num" id="1464897">1</span><span class="op" id="1464898">)</span><span class="op" id="1464899">)</span><span class="op" id="1464900">*</span><span class="builtintype" id="1464901">uintptr</span><span class="op" id="1464908">(</span><span class="ident" id="1464909">t</span><span class="op" id="1464910">.</span><span class="ident" id="1464911">bucketsize</span><span class="op" id="1464921">)</span><span class="op" id="1464922">)</span><span class="op" id="1464923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1464927">if</span>&nbsp;<span class="op" id="1464930">!</span><span class="ident" id="1464931">evacuated</span><span class="op" id="1464940">(</span><span class="ident" id="1464941">oldb</span><span class="op" id="1464945">)</span>&nbsp;<span class="op" id="1464947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464952">b</span>&nbsp;<span class="op" id="1464954">=</span>&nbsp;<span class="ident" id="1464956">oldb</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1464963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1464966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1464969">top</span>&nbsp;<span class="op" id="1464973">:=</span>&nbsp;<span class="builtintype" id="1464976">uint8</span><span class="op" id="1464981">(</span><span class="ident" id="1464982">hash</span>&nbsp;<span class="op" id="1464987">&gt;&gt;</span>&nbsp;<span class="op" id="1464990">(</span><span class="ident" id="1464991">ptrSize</span><span class="op" id="1464998">*</span><span class="num" id="1464999">8</span>&nbsp;<span class="op" id="1465001">-</span>&nbsp;<span class="num" id="1465003">8</span><span class="op" id="1465004">)</span><span class="op" id="1465005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465008">if</span>&nbsp;<span class="ident" id="1465011">top</span>&nbsp;<span class="op" id="1465015">&lt;</span>&nbsp;<span class="ident" id="1465017">minTopHash</span>&nbsp;<span class="op" id="1465028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465032">top</span>&nbsp;<span class="op" id="1465036">+=</span>&nbsp;<span class="ident" id="1465039">minTopHash</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1465051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465054">for</span>&nbsp;<span class="op" id="1465058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465062">for</span>&nbsp;<span class="ident" id="1465066">i</span>&nbsp;<span class="op" id="1465068">:=</span>&nbsp;<span class="builtintype" id="1465071">uintptr</span><span class="op" id="1465078">(</span><span class="num" id="1465079">0</span><span class="op" id="1465080">)</span><span class="op" id="1465081">;</span>&nbsp;<span class="ident" id="1465083">i</span>&nbsp;<span class="op" id="1465085">&lt;</span>&nbsp;<span class="ident" id="1465087">bucketCnt</span><span class="op" id="1465096">;</span>&nbsp;<span class="ident" id="1465098">i</span><span class="op" id="1465099">++</span>&nbsp;<span class="op" id="1465102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465107">if</span>&nbsp;<span class="ident" id="1465110">b</span><span class="op" id="1465111">.</span><span class="ident" id="1465112">tophash</span><span class="op" id="1465119">[</span><span class="ident" id="1465120">i</span><span class="op" id="1465121">]</span>&nbsp;<span class="op" id="1465123">!=</span>&nbsp;<span class="ident" id="1465126">top</span>&nbsp;<span class="op" id="1465130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465136">continue</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1465148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465153">k</span>&nbsp;<span class="op" id="1465155">:=</span>&nbsp;<span class="ident" id="1465158">add</span><span class="op" id="1465161">(</span><span class="ident" id="1465162">unsafe</span><span class="op" id="1465168">.</span><span class="ident" id="1465169">Pointer</span><span class="op" id="1465176">(</span><span class="ident" id="1465177">b</span><span class="op" id="1465178">)</span><span class="op" id="1465179">,</span>&nbsp;<span class="ident" id="1465181">dataOffset</span><span class="op" id="1465191">+</span><span class="ident" id="1465192">i</span><span class="op" id="1465193">*</span><span class="builtintype" id="1465194">uintptr</span><span class="op" id="1465201">(</span><span class="ident" id="1465202">t</span><span class="op" id="1465203">.</span><span class="ident" id="1465204">keysize</span><span class="op" id="1465211">)</span><span class="op" id="1465212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465217">if</span>&nbsp;<span class="ident" id="1465220">t</span><span class="op" id="1465221">.</span><span class="ident" id="1465222">indirectkey</span>&nbsp;<span class="op" id="1465234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465240">k</span>&nbsp;<span class="op" id="1465242">=</span>&nbsp;<span class="op" id="1465244">*</span><span class="op" id="1465245">(</span><span class="op" id="1465246">(</span><span class="op" id="1465247">*</span><span class="ident" id="1465248">unsafe</span><span class="op" id="1465254">.</span><span class="ident" id="1465255">Pointer</span><span class="op" id="1465262">)</span><span class="op" id="1465263">(</span><span class="ident" id="1465264">k</span><span class="op" id="1465265">)</span><span class="op" id="1465266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1465271">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465276">if</span>&nbsp;<span class="ident" id="1465279">alg</span><span class="op" id="1465282">.</span><span class="ident" id="1465283">equal</span><span class="op" id="1465288">(</span><span class="ident" id="1465289">key</span><span class="op" id="1465292">,</span>&nbsp;<span class="ident" id="1465294">k</span><span class="op" id="1465295">,</span>&nbsp;<span class="builtintype" id="1465297">uintptr</span><span class="op" id="1465304">(</span><span class="ident" id="1465305">t</span><span class="op" id="1465306">.</span><span class="ident" id="1465307">key</span><span class="op" id="1465310">.</span><span class="ident" id="1465311">size</span><span class="op" id="1465315">)</span><span class="op" id="1465316">)</span>&nbsp;<span class="op" id="1465318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465324">v</span>&nbsp;<span class="op" id="1465326">:=</span>&nbsp;<span class="ident" id="1465329">add</span><span class="op" id="1465332">(</span><span class="ident" id="1465333">unsafe</span><span class="op" id="1465339">.</span><span class="ident" id="1465340">Pointer</span><span class="op" id="1465347">(</span><span class="ident" id="1465348">b</span><span class="op" id="1465349">)</span><span class="op" id="1465350">,</span>&nbsp;<span class="ident" id="1465352">dataOffset</span><span class="op" id="1465362">+</span><span class="ident" id="1465363">bucketCnt</span><span class="op" id="1465372">*</span><span class="builtintype" id="1465373">uintptr</span><span class="op" id="1465380">(</span><span class="ident" id="1465381">t</span><span class="op" id="1465382">.</span><span class="ident" id="1465383">keysize</span><span class="op" id="1465390">)</span><span class="op" id="1465391">+</span><span class="ident" id="1465392">i</span><span class="op" id="1465393">*</span><span class="builtintype" id="1465394">uintptr</span><span class="op" id="1465401">(</span><span class="ident" id="1465402">t</span><span class="op" id="1465403">.</span><span class="ident" id="1465404">valuesize</span><span class="op" id="1465413">)</span><span class="op" id="1465414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465420">if</span>&nbsp;<span class="ident" id="1465423">t</span><span class="op" id="1465424">.</span><span class="ident" id="1465425">indirectvalue</span>&nbsp;<span class="op" id="1465439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465446">v</span>&nbsp;<span class="op" id="1465448">=</span>&nbsp;<span class="op" id="1465450">*</span><span class="op" id="1465451">(</span><span class="op" id="1465452">(</span><span class="op" id="1465453">*</span><span class="ident" id="1465454">unsafe</span><span class="op" id="1465460">.</span><span class="ident" id="1465461">Pointer</span><span class="op" id="1465468">)</span><span class="op" id="1465469">(</span><span class="ident" id="1465470">v</span><span class="op" id="1465471">)</span><span class="op" id="1465472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1465478">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465484">return</span>&nbsp;<span class="ident" id="1465491">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1465496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1465500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465504">b</span>&nbsp;<span class="op" id="1465506">=</span>&nbsp;<span class="ident" id="1465508">b</span><span class="op" id="1465509">.</span><span class="ident" id="1465510">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465521">if</span>&nbsp;<span class="ident" id="1465524">b</span>&nbsp;<span class="op" id="1465526">==</span>&nbsp;<span class="ident" id="1465529">nil</span>&nbsp;<span class="op" id="1465533">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465538">return</span>&nbsp;<span class="ident" id="1465545">unsafe</span><span class="op" id="1465551">.</span><span class="ident" id="1465552">Pointer</span><span class="op" id="1465559">(</span><span class="ident" id="1465560">t</span><span class="op" id="1465561">.</span><span class="ident" id="1465562">elem</span><span class="op" id="1465566">.</span><span class="ident" id="1465567">zero</span><span class="op" id="1465571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1465575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1465578">}</span><br>
<span class="lineno"></span><span class="op" id="1465580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="1465583">func</span>&nbsp;<span class="ident" id="1465588">mapaccess2</span><span class="op" id="1465598">(</span><span class="ident" id="1465599">t</span>&nbsp;<span class="op" id="1465601">*</span><span class="ident" id="1465602">maptype</span><span class="op" id="1465609">,</span>&nbsp;<span class="ident" id="1465611">h</span>&nbsp;<span class="op" id="1465613">*</span><span class="ident" id="1465614">hmap</span><span class="op" id="1465618">,</span>&nbsp;<span class="ident" id="1465620">key</span>&nbsp;<span class="ident" id="1465624">unsafe</span><span class="op" id="1465630">.</span><span class="ident" id="1465631">Pointer</span><span class="op" id="1465638">)</span>&nbsp;<span class="op" id="1465640">(</span><span class="ident" id="1465641">unsafe</span><span class="op" id="1465647">.</span><span class="ident" id="1465648">Pointer</span><span class="op" id="1465655">,</span>&nbsp;<span class="builtintype" id="1465657">bool</span><span class="op" id="1465661">)</span>&nbsp;<span class="op" id="1465663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465666">if</span>&nbsp;<span class="ident" id="1465669">raceenabled</span>&nbsp;<span class="op" id="1465681">&amp;&amp;</span>&nbsp;<span class="ident" id="1465684">h</span>&nbsp;<span class="op" id="1465686">!=</span>&nbsp;<span class="ident" id="1465689">nil</span>&nbsp;<span class="op" id="1465693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465697">callerpc</span>&nbsp;<span class="op" id="1465706">:=</span>&nbsp;<span class="ident" id="1465709">getcallerpc</span><span class="op" id="1465720">(</span><span class="ident" id="1465721">unsafe</span><span class="op" id="1465727">.</span><span class="ident" id="1465728">Pointer</span><span class="op" id="1465735">(</span><span class="op" id="1465736">&amp;</span><span class="ident" id="1465737">t</span><span class="op" id="1465738">)</span><span class="op" id="1465739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465743">pc</span>&nbsp;<span class="op" id="1465746">:=</span>&nbsp;<span class="ident" id="1465749">funcPC</span><span class="op" id="1465755">(</span><span class="ident" id="1465756">mapaccess2</span><span class="op" id="1465766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465770">racereadpc</span><span class="op" id="1465780">(</span><span class="ident" id="1465781">unsafe</span><span class="op" id="1465787">.</span><span class="ident" id="1465788">Pointer</span><span class="op" id="1465795">(</span><span class="ident" id="1465796">h</span><span class="op" id="1465797">)</span><span class="op" id="1465798">,</span>&nbsp;<span class="ident" id="1465800">callerpc</span><span class="op" id="1465808">,</span>&nbsp;<span class="ident" id="1465810">pc</span><span class="op" id="1465812">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465816">raceReadObjectPC</span><span class="op" id="1465832">(</span><span class="ident" id="1465833">t</span><span class="op" id="1465834">.</span><span class="ident" id="1465835">key</span><span class="op" id="1465838">,</span>&nbsp;<span class="ident" id="1465840">key</span><span class="op" id="1465843">,</span>&nbsp;<span class="ident" id="1465845">callerpc</span><span class="op" id="1465853">,</span>&nbsp;<span class="ident" id="1465855">pc</span><span class="op" id="1465857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1465860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465863">if</span>&nbsp;<span class="ident" id="1465866">h</span>&nbsp;<span class="op" id="1465868">==</span>&nbsp;<span class="ident" id="1465871">nil</span>&nbsp;<span class="op" id="1465875">||</span>&nbsp;<span class="ident" id="1465878">h</span><span class="op" id="1465879">.</span><span class="ident" id="1465880">count</span>&nbsp;<span class="op" id="1465886">==</span>&nbsp;<span class="num" id="1465889">0</span>&nbsp;<span class="op" id="1465891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1465895">return</span>&nbsp;<span class="ident" id="1465902">unsafe</span><span class="op" id="1465908">.</span><span class="ident" id="1465909">Pointer</span><span class="op" id="1465916">(</span><span class="ident" id="1465917">t</span><span class="op" id="1465918">.</span><span class="ident" id="1465919">elem</span><span class="op" id="1465923">.</span><span class="ident" id="1465924">zero</span><span class="op" id="1465928">)</span><span class="op" id="1465929">,</span>&nbsp;<span class="builtintype" id="1465931">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1465938">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465941">alg</span>&nbsp;<span class="op" id="1465945">:=</span>&nbsp;<span class="ident" id="1465948">goalg</span><span class="op" id="1465953">(</span><span class="ident" id="1465954">t</span><span class="op" id="1465955">.</span><span class="ident" id="1465956">key</span><span class="op" id="1465959">.</span><span class="ident" id="1465960">alg</span><span class="op" id="1465963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1465966">hash</span>&nbsp;<span class="op" id="1465971">:=</span>&nbsp;<span class="ident" id="1465974">alg</span><span class="op" id="1465977">.</span><span class="ident" id="1465978">hash</span><span class="op" id="1465982">(</span><span class="ident" id="1465983">key</span><span class="op" id="1465986">,</span>&nbsp;<span class="builtintype" id="1465988">uintptr</span><span class="op" id="1465995">(</span><span class="ident" id="1465996">t</span><span class="op" id="1465997">.</span><span class="ident" id="1465998">key</span><span class="op" id="1466001">.</span><span class="ident" id="1466002">size</span><span class="op" id="1466006">)</span><span class="op" id="1466007">,</span>&nbsp;<span class="builtintype" id="1466009">uintptr</span><span class="op" id="1466016">(</span><span class="ident" id="1466017">h</span><span class="op" id="1466018">.</span><span class="ident" id="1466019">hash0</span><span class="op" id="1466024">)</span><span class="op" id="1466025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466028">m</span>&nbsp;<span class="op" id="1466030">:=</span>&nbsp;<span class="builtintype" id="1466033">uintptr</span><span class="op" id="1466040">(</span><span class="num" id="1466041">1</span><span class="op" id="1466042">)</span><span class="op" id="1466043">&lt;&lt;</span><span class="ident" id="1466045">h</span><span class="op" id="1466046">.</span><span class="ident" id="1466047">B</span>&nbsp;<span class="op" id="1466049">-</span>&nbsp;<span class="num" id="1466051">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466054">b</span>&nbsp;<span class="op" id="1466056">:=</span>&nbsp;<span class="op" id="1466059">(</span><span class="op" id="1466060">*</span><span class="ident" id="1466061">bmap</span><span class="op" id="1466065">)</span><span class="op" id="1466066">(</span><span class="ident" id="1466067">unsafe</span><span class="op" id="1466073">.</span><span class="ident" id="1466074">Pointer</span><span class="op" id="1466081">(</span><span class="builtintype" id="1466082">uintptr</span><span class="op" id="1466089">(</span><span class="ident" id="1466090">h</span><span class="op" id="1466091">.</span><span class="ident" id="1466092">buckets</span><span class="op" id="1466099">)</span>&nbsp;<span class="op" id="1466101">+</span>&nbsp;<span class="op" id="1466103">(</span><span class="ident" id="1466104">hash</span><span class="op" id="1466108">&amp;</span><span class="ident" id="1466109">m</span><span class="op" id="1466110">)</span><span class="op" id="1466111">*</span><span class="builtintype" id="1466112">uintptr</span><span class="op" id="1466119">(</span><span class="ident" id="1466120">t</span><span class="op" id="1466121">.</span><span class="ident" id="1466122">bucketsize</span><span class="op" id="1466132">)</span><span class="op" id="1466133">)</span><span class="op" id="1466134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466137">if</span>&nbsp;<span class="ident" id="1466140">c</span>&nbsp;<span class="op" id="1466142">:=</span>&nbsp;<span class="ident" id="1466145">h</span><span class="op" id="1466146">.</span><span class="ident" id="1466147">oldbuckets</span><span class="op" id="1466157">;</span>&nbsp;<span class="ident" id="1466159">c</span>&nbsp;<span class="op" id="1466161">!=</span>&nbsp;<span class="ident" id="1466164">nil</span>&nbsp;<span class="op" id="1466168">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466172">oldb</span>&nbsp;<span class="op" id="1466177">:=</span>&nbsp;<span class="op" id="1466180">(</span><span class="op" id="1466181">*</span><span class="ident" id="1466182">bmap</span><span class="op" id="1466186">)</span><span class="op" id="1466187">(</span><span class="ident" id="1466188">unsafe</span><span class="op" id="1466194">.</span><span class="ident" id="1466195">Pointer</span><span class="op" id="1466202">(</span><span class="builtintype" id="1466203">uintptr</span><span class="op" id="1466210">(</span><span class="ident" id="1466211">c</span><span class="op" id="1466212">)</span>&nbsp;<span class="op" id="1466214">+</span>&nbsp;<span class="op" id="1466216">(</span><span class="ident" id="1466217">hash</span><span class="op" id="1466221">&amp;</span><span class="op" id="1466222">(</span><span class="ident" id="1466223">m</span><span class="op" id="1466224">&gt;&gt;</span><span class="num" id="1466226">1</span><span class="op" id="1466227">)</span><span class="op" id="1466228">)</span><span class="op" id="1466229">*</span><span class="builtintype" id="1466230">uintptr</span><span class="op" id="1466237">(</span><span class="ident" id="1466238">t</span><span class="op" id="1466239">.</span><span class="ident" id="1466240">bucketsize</span><span class="op" id="1466250">)</span><span class="op" id="1466251">)</span><span class="op" id="1466252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466256">if</span>&nbsp;<span class="op" id="1466259">!</span><span class="ident" id="1466260">evacuated</span><span class="op" id="1466269">(</span><span class="ident" id="1466270">oldb</span><span class="op" id="1466274">)</span>&nbsp;<span class="op" id="1466276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466281">b</span>&nbsp;<span class="op" id="1466283">=</span>&nbsp;<span class="ident" id="1466285">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1466292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1466295">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466298">top</span>&nbsp;<span class="op" id="1466302">:=</span>&nbsp;<span class="builtintype" id="1466305">uint8</span><span class="op" id="1466310">(</span><span class="ident" id="1466311">hash</span>&nbsp;<span class="op" id="1466316">&gt;&gt;</span>&nbsp;<span class="op" id="1466319">(</span><span class="ident" id="1466320">ptrSize</span><span class="op" id="1466327">*</span><span class="num" id="1466328">8</span>&nbsp;<span class="op" id="1466330">-</span>&nbsp;<span class="num" id="1466332">8</span><span class="op" id="1466333">)</span><span class="op" id="1466334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466337">if</span>&nbsp;<span class="ident" id="1466340">top</span>&nbsp;<span class="op" id="1466344">&lt;</span>&nbsp;<span class="ident" id="1466346">minTopHash</span>&nbsp;<span class="op" id="1466357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466361">top</span>&nbsp;<span class="op" id="1466365">+=</span>&nbsp;<span class="ident" id="1466368">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1466380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466383">for</span>&nbsp;<span class="op" id="1466387">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466391">for</span>&nbsp;<span class="ident" id="1466395">i</span>&nbsp;<span class="op" id="1466397">:=</span>&nbsp;<span class="builtintype" id="1466400">uintptr</span><span class="op" id="1466407">(</span><span class="num" id="1466408">0</span><span class="op" id="1466409">)</span><span class="op" id="1466410">;</span>&nbsp;<span class="ident" id="1466412">i</span>&nbsp;<span class="op" id="1466414">&lt;</span>&nbsp;<span class="ident" id="1466416">bucketCnt</span><span class="op" id="1466425">;</span>&nbsp;<span class="ident" id="1466427">i</span><span class="op" id="1466428">++</span>&nbsp;<span class="op" id="1466431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466436">if</span>&nbsp;<span class="ident" id="1466439">b</span><span class="op" id="1466440">.</span><span class="ident" id="1466441">tophash</span><span class="op" id="1466448">[</span><span class="ident" id="1466449">i</span><span class="op" id="1466450">]</span>&nbsp;<span class="op" id="1466452">!=</span>&nbsp;<span class="ident" id="1466455">top</span>&nbsp;<span class="op" id="1466459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466465">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1466477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466482">k</span>&nbsp;<span class="op" id="1466484">:=</span>&nbsp;<span class="ident" id="1466487">add</span><span class="op" id="1466490">(</span><span class="ident" id="1466491">unsafe</span><span class="op" id="1466497">.</span><span class="ident" id="1466498">Pointer</span><span class="op" id="1466505">(</span><span class="ident" id="1466506">b</span><span class="op" id="1466507">)</span><span class="op" id="1466508">,</span>&nbsp;<span class="ident" id="1466510">dataOffset</span><span class="op" id="1466520">+</span><span class="ident" id="1466521">i</span><span class="op" id="1466522">*</span><span class="builtintype" id="1466523">uintptr</span><span class="op" id="1466530">(</span><span class="ident" id="1466531">t</span><span class="op" id="1466532">.</span><span class="ident" id="1466533">keysize</span><span class="op" id="1466540">)</span><span class="op" id="1466541">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466546">if</span>&nbsp;<span class="ident" id="1466549">t</span><span class="op" id="1466550">.</span><span class="ident" id="1466551">indirectkey</span>&nbsp;<span class="op" id="1466563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466569">k</span>&nbsp;<span class="op" id="1466571">=</span>&nbsp;<span class="op" id="1466573">*</span><span class="op" id="1466574">(</span><span class="op" id="1466575">(</span><span class="op" id="1466576">*</span><span class="ident" id="1466577">unsafe</span><span class="op" id="1466583">.</span><span class="ident" id="1466584">Pointer</span><span class="op" id="1466591">)</span><span class="op" id="1466592">(</span><span class="ident" id="1466593">k</span><span class="op" id="1466594">)</span><span class="op" id="1466595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1466600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466605">if</span>&nbsp;<span class="ident" id="1466608">alg</span><span class="op" id="1466611">.</span><span class="ident" id="1466612">equal</span><span class="op" id="1466617">(</span><span class="ident" id="1466618">key</span><span class="op" id="1466621">,</span>&nbsp;<span class="ident" id="1466623">k</span><span class="op" id="1466624">,</span>&nbsp;<span class="builtintype" id="1466626">uintptr</span><span class="op" id="1466633">(</span><span class="ident" id="1466634">t</span><span class="op" id="1466635">.</span><span class="ident" id="1466636">key</span><span class="op" id="1466639">.</span><span class="ident" id="1466640">size</span><span class="op" id="1466644">)</span><span class="op" id="1466645">)</span>&nbsp;<span class="op" id="1466647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466653">v</span>&nbsp;<span class="op" id="1466655">:=</span>&nbsp;<span class="ident" id="1466658">add</span><span class="op" id="1466661">(</span><span class="ident" id="1466662">unsafe</span><span class="op" id="1466668">.</span><span class="ident" id="1466669">Pointer</span><span class="op" id="1466676">(</span><span class="ident" id="1466677">b</span><span class="op" id="1466678">)</span><span class="op" id="1466679">,</span>&nbsp;<span class="ident" id="1466681">dataOffset</span><span class="op" id="1466691">+</span><span class="ident" id="1466692">bucketCnt</span><span class="op" id="1466701">*</span><span class="builtintype" id="1466702">uintptr</span><span class="op" id="1466709">(</span><span class="ident" id="1466710">t</span><span class="op" id="1466711">.</span><span class="ident" id="1466712">keysize</span><span class="op" id="1466719">)</span><span class="op" id="1466720">+</span><span class="ident" id="1466721">i</span><span class="op" id="1466722">*</span><span class="builtintype" id="1466723">uintptr</span><span class="op" id="1466730">(</span><span class="ident" id="1466731">t</span><span class="op" id="1466732">.</span><span class="ident" id="1466733">valuesize</span><span class="op" id="1466742">)</span><span class="op" id="1466743">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466749">if</span>&nbsp;<span class="ident" id="1466752">t</span><span class="op" id="1466753">.</span><span class="ident" id="1466754">indirectvalue</span>&nbsp;<span class="op" id="1466768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466775">v</span>&nbsp;<span class="op" id="1466777">=</span>&nbsp;<span class="op" id="1466779">*</span><span class="op" id="1466780">(</span><span class="op" id="1466781">(</span><span class="op" id="1466782">*</span><span class="ident" id="1466783">unsafe</span><span class="op" id="1466789">.</span><span class="ident" id="1466790">Pointer</span><span class="op" id="1466797">)</span><span class="op" id="1466798">(</span><span class="ident" id="1466799">v</span><span class="op" id="1466800">)</span><span class="op" id="1466801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1466807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466813">return</span>&nbsp;<span class="ident" id="1466820">v</span><span class="op" id="1466821">,</span>&nbsp;<span class="builtintype" id="1466823">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1466831">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1466835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1466839">b</span>&nbsp;<span class="op" id="1466841">=</span>&nbsp;<span class="ident" id="1466843">b</span><span class="op" id="1466844">.</span><span class="ident" id="1466845">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466856">if</span>&nbsp;<span class="ident" id="1466859">b</span>&nbsp;<span class="op" id="1466861">==</span>&nbsp;<span class="ident" id="1466864">nil</span>&nbsp;<span class="op" id="1466868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1466873">return</span>&nbsp;<span class="ident" id="1466880">unsafe</span><span class="op" id="1466886">.</span><span class="ident" id="1466887">Pointer</span><span class="op" id="1466894">(</span><span class="ident" id="1466895">t</span><span class="op" id="1466896">.</span><span class="ident" id="1466897">elem</span><span class="op" id="1466901">.</span><span class="ident" id="1466902">zero</span><span class="op" id="1466906">)</span><span class="op" id="1466907">,</span>&nbsp;<span class="builtintype" id="1466909">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1466917">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1466920">}</span><br>
<span class="lineno"></span><span class="op" id="1466922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1466925">//&nbsp;returns&nbsp;both&nbsp;key&nbsp;and&nbsp;value.&nbsp;&nbsp;Used&nbsp;by&nbsp;map&nbsp;iterator</span><br>
<span class="lineno"></span><span class="keyword" id="1466978">func</span>&nbsp;<span class="ident" id="1466983">mapaccessK</span><span class="op" id="1466993">(</span><span class="ident" id="1466994">t</span>&nbsp;<span class="op" id="1466996">*</span><span class="ident" id="1466997">maptype</span><span class="op" id="1467004">,</span>&nbsp;<span class="ident" id="1467006">h</span>&nbsp;<span class="op" id="1467008">*</span><span class="ident" id="1467009">hmap</span><span class="op" id="1467013">,</span>&nbsp;<span class="ident" id="1467015">key</span>&nbsp;<span class="ident" id="1467019">unsafe</span><span class="op" id="1467025">.</span><span class="ident" id="1467026">Pointer</span><span class="op" id="1467033">)</span>&nbsp;<span class="op" id="1467035">(</span><span class="ident" id="1467036">unsafe</span><span class="op" id="1467042">.</span><span class="ident" id="1467043">Pointer</span><span class="op" id="1467050">,</span>&nbsp;<span class="ident" id="1467052">unsafe</span><span class="op" id="1467058">.</span><span class="ident" id="1467059">Pointer</span><span class="op" id="1467066">)</span>&nbsp;<span class="op" id="1467068">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467071">if</span>&nbsp;<span class="ident" id="1467074">h</span>&nbsp;<span class="op" id="1467076">==</span>&nbsp;<span class="ident" id="1467079">nil</span>&nbsp;<span class="op" id="1467083">||</span>&nbsp;<span class="ident" id="1467086">h</span><span class="op" id="1467087">.</span><span class="ident" id="1467088">count</span>&nbsp;<span class="op" id="1467094">==</span>&nbsp;<span class="num" id="1467097">0</span>&nbsp;<span class="op" id="1467099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467103">return</span>&nbsp;<span class="ident" id="1467110">nil</span><span class="op" id="1467113">,</span>&nbsp;<span class="ident" id="1467115">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1467120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467123">alg</span>&nbsp;<span class="op" id="1467127">:=</span>&nbsp;<span class="ident" id="1467130">goalg</span><span class="op" id="1467135">(</span><span class="ident" id="1467136">t</span><span class="op" id="1467137">.</span><span class="ident" id="1467138">key</span><span class="op" id="1467141">.</span><span class="ident" id="1467142">alg</span><span class="op" id="1467145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467148">hash</span>&nbsp;<span class="op" id="1467153">:=</span>&nbsp;<span class="ident" id="1467156">alg</span><span class="op" id="1467159">.</span><span class="ident" id="1467160">hash</span><span class="op" id="1467164">(</span><span class="ident" id="1467165">key</span><span class="op" id="1467168">,</span>&nbsp;<span class="builtintype" id="1467170">uintptr</span><span class="op" id="1467177">(</span><span class="ident" id="1467178">t</span><span class="op" id="1467179">.</span><span class="ident" id="1467180">key</span><span class="op" id="1467183">.</span><span class="ident" id="1467184">size</span><span class="op" id="1467188">)</span><span class="op" id="1467189">,</span>&nbsp;<span class="builtintype" id="1467191">uintptr</span><span class="op" id="1467198">(</span><span class="ident" id="1467199">h</span><span class="op" id="1467200">.</span><span class="ident" id="1467201">hash0</span><span class="op" id="1467206">)</span><span class="op" id="1467207">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467210">m</span>&nbsp;<span class="op" id="1467212">:=</span>&nbsp;<span class="builtintype" id="1467215">uintptr</span><span class="op" id="1467222">(</span><span class="num" id="1467223">1</span><span class="op" id="1467224">)</span><span class="op" id="1467225">&lt;&lt;</span><span class="ident" id="1467227">h</span><span class="op" id="1467228">.</span><span class="ident" id="1467229">B</span>&nbsp;<span class="op" id="1467231">-</span>&nbsp;<span class="num" id="1467233">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467236">b</span>&nbsp;<span class="op" id="1467238">:=</span>&nbsp;<span class="op" id="1467241">(</span><span class="op" id="1467242">*</span><span class="ident" id="1467243">bmap</span><span class="op" id="1467247">)</span><span class="op" id="1467248">(</span><span class="ident" id="1467249">unsafe</span><span class="op" id="1467255">.</span><span class="ident" id="1467256">Pointer</span><span class="op" id="1467263">(</span><span class="builtintype" id="1467264">uintptr</span><span class="op" id="1467271">(</span><span class="ident" id="1467272">h</span><span class="op" id="1467273">.</span><span class="ident" id="1467274">buckets</span><span class="op" id="1467281">)</span>&nbsp;<span class="op" id="1467283">+</span>&nbsp;<span class="op" id="1467285">(</span><span class="ident" id="1467286">hash</span><span class="op" id="1467290">&amp;</span><span class="ident" id="1467291">m</span><span class="op" id="1467292">)</span><span class="op" id="1467293">*</span><span class="builtintype" id="1467294">uintptr</span><span class="op" id="1467301">(</span><span class="ident" id="1467302">t</span><span class="op" id="1467303">.</span><span class="ident" id="1467304">bucketsize</span><span class="op" id="1467314">)</span><span class="op" id="1467315">)</span><span class="op" id="1467316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467319">if</span>&nbsp;<span class="ident" id="1467322">c</span>&nbsp;<span class="op" id="1467324">:=</span>&nbsp;<span class="ident" id="1467327">h</span><span class="op" id="1467328">.</span><span class="ident" id="1467329">oldbuckets</span><span class="op" id="1467339">;</span>&nbsp;<span class="ident" id="1467341">c</span>&nbsp;<span class="op" id="1467343">!=</span>&nbsp;<span class="ident" id="1467346">nil</span>&nbsp;<span class="op" id="1467350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467354">oldb</span>&nbsp;<span class="op" id="1467359">:=</span>&nbsp;<span class="op" id="1467362">(</span><span class="op" id="1467363">*</span><span class="ident" id="1467364">bmap</span><span class="op" id="1467368">)</span><span class="op" id="1467369">(</span><span class="ident" id="1467370">unsafe</span><span class="op" id="1467376">.</span><span class="ident" id="1467377">Pointer</span><span class="op" id="1467384">(</span><span class="builtintype" id="1467385">uintptr</span><span class="op" id="1467392">(</span><span class="ident" id="1467393">c</span><span class="op" id="1467394">)</span>&nbsp;<span class="op" id="1467396">+</span>&nbsp;<span class="op" id="1467398">(</span><span class="ident" id="1467399">hash</span><span class="op" id="1467403">&amp;</span><span class="op" id="1467404">(</span><span class="ident" id="1467405">m</span><span class="op" id="1467406">&gt;&gt;</span><span class="num" id="1467408">1</span><span class="op" id="1467409">)</span><span class="op" id="1467410">)</span><span class="op" id="1467411">*</span><span class="builtintype" id="1467412">uintptr</span><span class="op" id="1467419">(</span><span class="ident" id="1467420">t</span><span class="op" id="1467421">.</span><span class="ident" id="1467422">bucketsize</span><span class="op" id="1467432">)</span><span class="op" id="1467433">)</span><span class="op" id="1467434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467438">if</span>&nbsp;<span class="op" id="1467441">!</span><span class="ident" id="1467442">evacuated</span><span class="op" id="1467451">(</span><span class="ident" id="1467452">oldb</span><span class="op" id="1467456">)</span>&nbsp;<span class="op" id="1467458">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467463">b</span>&nbsp;<span class="op" id="1467465">=</span>&nbsp;<span class="ident" id="1467467">oldb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1467474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1467477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467480">top</span>&nbsp;<span class="op" id="1467484">:=</span>&nbsp;<span class="builtintype" id="1467487">uint8</span><span class="op" id="1467492">(</span><span class="ident" id="1467493">hash</span>&nbsp;<span class="op" id="1467498">&gt;&gt;</span>&nbsp;<span class="op" id="1467501">(</span><span class="ident" id="1467502">ptrSize</span><span class="op" id="1467509">*</span><span class="num" id="1467510">8</span>&nbsp;<span class="op" id="1467512">-</span>&nbsp;<span class="num" id="1467514">8</span><span class="op" id="1467515">)</span><span class="op" id="1467516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467519">if</span>&nbsp;<span class="ident" id="1467522">top</span>&nbsp;<span class="op" id="1467526">&lt;</span>&nbsp;<span class="ident" id="1467528">minTopHash</span>&nbsp;<span class="op" id="1467539">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467543">top</span>&nbsp;<span class="op" id="1467547">+=</span>&nbsp;<span class="ident" id="1467550">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1467562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467565">for</span>&nbsp;<span class="op" id="1467569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467573">for</span>&nbsp;<span class="ident" id="1467577">i</span>&nbsp;<span class="op" id="1467579">:=</span>&nbsp;<span class="builtintype" id="1467582">uintptr</span><span class="op" id="1467589">(</span><span class="num" id="1467590">0</span><span class="op" id="1467591">)</span><span class="op" id="1467592">;</span>&nbsp;<span class="ident" id="1467594">i</span>&nbsp;<span class="op" id="1467596">&lt;</span>&nbsp;<span class="ident" id="1467598">bucketCnt</span><span class="op" id="1467607">;</span>&nbsp;<span class="ident" id="1467609">i</span><span class="op" id="1467610">++</span>&nbsp;<span class="op" id="1467613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467618">if</span>&nbsp;<span class="ident" id="1467621">b</span><span class="op" id="1467622">.</span><span class="ident" id="1467623">tophash</span><span class="op" id="1467630">[</span><span class="ident" id="1467631">i</span><span class="op" id="1467632">]</span>&nbsp;<span class="op" id="1467634">!=</span>&nbsp;<span class="ident" id="1467637">top</span>&nbsp;<span class="op" id="1467641">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467647">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1467659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467664">k</span>&nbsp;<span class="op" id="1467666">:=</span>&nbsp;<span class="ident" id="1467669">add</span><span class="op" id="1467672">(</span><span class="ident" id="1467673">unsafe</span><span class="op" id="1467679">.</span><span class="ident" id="1467680">Pointer</span><span class="op" id="1467687">(</span><span class="ident" id="1467688">b</span><span class="op" id="1467689">)</span><span class="op" id="1467690">,</span>&nbsp;<span class="ident" id="1467692">dataOffset</span><span class="op" id="1467702">+</span><span class="ident" id="1467703">i</span><span class="op" id="1467704">*</span><span class="builtintype" id="1467705">uintptr</span><span class="op" id="1467712">(</span><span class="ident" id="1467713">t</span><span class="op" id="1467714">.</span><span class="ident" id="1467715">keysize</span><span class="op" id="1467722">)</span><span class="op" id="1467723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467728">if</span>&nbsp;<span class="ident" id="1467731">t</span><span class="op" id="1467732">.</span><span class="ident" id="1467733">indirectkey</span>&nbsp;<span class="op" id="1467745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467751">k</span>&nbsp;<span class="op" id="1467753">=</span>&nbsp;<span class="op" id="1467755">*</span><span class="op" id="1467756">(</span><span class="op" id="1467757">(</span><span class="op" id="1467758">*</span><span class="ident" id="1467759">unsafe</span><span class="op" id="1467765">.</span><span class="ident" id="1467766">Pointer</span><span class="op" id="1467773">)</span><span class="op" id="1467774">(</span><span class="ident" id="1467775">k</span><span class="op" id="1467776">)</span><span class="op" id="1467777">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1467782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467787">if</span>&nbsp;<span class="ident" id="1467790">alg</span><span class="op" id="1467793">.</span><span class="ident" id="1467794">equal</span><span class="op" id="1467799">(</span><span class="ident" id="1467800">key</span><span class="op" id="1467803">,</span>&nbsp;<span class="ident" id="1467805">k</span><span class="op" id="1467806">,</span>&nbsp;<span class="builtintype" id="1467808">uintptr</span><span class="op" id="1467815">(</span><span class="ident" id="1467816">t</span><span class="op" id="1467817">.</span><span class="ident" id="1467818">key</span><span class="op" id="1467821">.</span><span class="ident" id="1467822">size</span><span class="op" id="1467826">)</span><span class="op" id="1467827">)</span>&nbsp;<span class="op" id="1467829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467835">v</span>&nbsp;<span class="op" id="1467837">:=</span>&nbsp;<span class="ident" id="1467840">add</span><span class="op" id="1467843">(</span><span class="ident" id="1467844">unsafe</span><span class="op" id="1467850">.</span><span class="ident" id="1467851">Pointer</span><span class="op" id="1467858">(</span><span class="ident" id="1467859">b</span><span class="op" id="1467860">)</span><span class="op" id="1467861">,</span>&nbsp;<span class="ident" id="1467863">dataOffset</span><span class="op" id="1467873">+</span><span class="ident" id="1467874">bucketCnt</span><span class="op" id="1467883">*</span><span class="builtintype" id="1467884">uintptr</span><span class="op" id="1467891">(</span><span class="ident" id="1467892">t</span><span class="op" id="1467893">.</span><span class="ident" id="1467894">keysize</span><span class="op" id="1467901">)</span><span class="op" id="1467902">+</span><span class="ident" id="1467903">i</span><span class="op" id="1467904">*</span><span class="builtintype" id="1467905">uintptr</span><span class="op" id="1467912">(</span><span class="ident" id="1467913">t</span><span class="op" id="1467914">.</span><span class="ident" id="1467915">valuesize</span><span class="op" id="1467924">)</span><span class="op" id="1467925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467931">if</span>&nbsp;<span class="ident" id="1467934">t</span><span class="op" id="1467935">.</span><span class="ident" id="1467936">indirectvalue</span>&nbsp;<span class="op" id="1467950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1467957">v</span>&nbsp;<span class="op" id="1467959">=</span>&nbsp;<span class="op" id="1467961">*</span><span class="op" id="1467962">(</span><span class="op" id="1467963">(</span><span class="op" id="1467964">*</span><span class="ident" id="1467965">unsafe</span><span class="op" id="1467971">.</span><span class="ident" id="1467972">Pointer</span><span class="op" id="1467979">)</span><span class="op" id="1467980">(</span><span class="ident" id="1467981">v</span><span class="op" id="1467982">)</span><span class="op" id="1467983">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1467989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1467995">return</span>&nbsp;<span class="ident" id="1468002">k</span><span class="op" id="1468003">,</span>&nbsp;<span class="ident" id="1468005">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1468010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1468014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468018">b</span>&nbsp;<span class="op" id="1468020">=</span>&nbsp;<span class="ident" id="1468022">b</span><span class="op" id="1468023">.</span><span class="ident" id="1468024">overflow</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1468035">if</span>&nbsp;<span class="ident" id="1468038">b</span>&nbsp;<span class="op" id="1468040">==</span>&nbsp;<span class="ident" id="1468043">nil</span>&nbsp;<span class="op" id="1468047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1468052">return</span>&nbsp;<span class="ident" id="1468059">nil</span><span class="op" id="1468062">,</span>&nbsp;<span class="ident" id="1468064">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1468070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1468073">}</span><br>
<span class="lineno"></span><span class="op" id="1468075">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="1468078">func</span>&nbsp;<span class="ident" id="1468083">mapassign1</span><span class="op" id="1468093">(</span><span class="ident" id="1468094">t</span>&nbsp;<span class="op" id="1468096">*</span><span class="ident" id="1468097">maptype</span><span class="op" id="1468104">,</span>&nbsp;<span class="ident" id="1468106">h</span>&nbsp;<span class="op" id="1468108">*</span><span class="ident" id="1468109">hmap</span><span class="op" id="1468113">,</span>&nbsp;<span class="ident" id="1468115">key</span>&nbsp;<span class="ident" id="1468119">unsafe</span><span class="op" id="1468125">.</span><span class="ident" id="1468126">Pointer</span><span class="op" id="1468133">,</span>&nbsp;<span class="ident" id="1468135">val</span>&nbsp;<span class="ident" id="1468139">unsafe</span><span class="op" id="1468145">.</span><span class="ident" id="1468146">Pointer</span><span class="op" id="1468153">)</span>&nbsp;<span class="op" id="1468155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1468158">if</span>&nbsp;<span class="ident" id="1468161">h</span>&nbsp;<span class="op" id="1468163">==</span>&nbsp;<span class="ident" id="1468166">nil</span>&nbsp;<span class="op" id="1468170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1468174">panic</span><span class="op" id="1468179">(</span><span class="string" id="1468180">&#34;assignment&nbsp;to&nbsp;entry&nbsp;in&nbsp;nil&nbsp;map&#34;</span><span class="op" id="1468212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1468215">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1468218">if</span>&nbsp;<span class="ident" id="1468221">raceenabled</span>&nbsp;<span class="op" id="1468233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468237">callerpc</span>&nbsp;<span class="op" id="1468246">:=</span>&nbsp;<span class="ident" id="1468249">getcallerpc</span><span class="op" id="1468260">(</span><span class="ident" id="1468261">unsafe</span><span class="op" id="1468267">.</span><span class="ident" id="1468268">Pointer</span><span class="op" id="1468275">(</span><span class="op" id="1468276">&amp;</span><span class="ident" id="1468277">t</span><span class="op" id="1468278">)</span><span class="op" id="1468279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468283">pc</span>&nbsp;<span class="op" id="1468286">:=</span>&nbsp;<span class="ident" id="1468289">funcPC</span><span class="op" id="1468295">(</span><span class="ident" id="1468296">mapassign1</span><span class="op" id="1468306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468310">racewritepc</span><span class="op" id="1468321">(</span><span class="ident" id="1468322">unsafe</span><span class="op" id="1468328">.</span><span class="ident" id="1468329">Pointer</span><span class="op" id="1468336">(</span><span class="ident" id="1468337">h</span><span class="op" id="1468338">)</span><span class="op" id="1468339">,</span>&nbsp;<span class="ident" id="1468341">callerpc</span><span class="op" id="1468349">,</span>&nbsp;<span class="ident" id="1468351">pc</span><span class="op" id="1468353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468357">raceReadObjectPC</span><span class="op" id="1468373">(</span><span class="ident" id="1468374">t</span><span class="op" id="1468375">.</span><span class="ident" id="1468376">key</span><span class="op" id="1468379">,</span>&nbsp;<span class="ident" id="1468381">key</span><span class="op" id="1468384">,</span>&nbsp;<span class="ident" id="1468386">callerpc</span><span class="op" id="1468394">,</span>&nbsp;<span class="ident" id="1468396">pc</span><span class="op" id="1468398">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468402">raceReadObjectPC</span><span class="op" id="1468418">(</span><span class="ident" id="1468419">t</span><span class="op" id="1468420">.</span><span class="ident" id="1468421">elem</span><span class="op" id="1468425">,</span>&nbsp;<span class="ident" id="1468427">val</span><span class="op" id="1468430">,</span>&nbsp;<span class="ident" id="1468432">callerpc</span><span class="op" id="1468440">,</span>&nbsp;<span class="ident" id="1468442">pc</span><span class="op" id="1468444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1468447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468451">alg</span>&nbsp;<span class="op" id="1468455">:=</span>&nbsp;<span class="ident" id="1468458">goalg</span><span class="op" id="1468463">(</span><span class="ident" id="1468464">t</span><span class="op" id="1468465">.</span><span class="ident" id="1468466">key</span><span class="op" id="1468469">.</span><span class="ident" id="1468470">alg</span><span class="op" id="1468473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468476">hash</span>&nbsp;<span class="op" id="1468481">:=</span>&nbsp;<span class="ident" id="1468484">alg</span><span class="op" id="1468487">.</span><span class="ident" id="1468488">hash</span><span class="op" id="1468492">(</span><span class="ident" id="1468493">key</span><span class="op" id="1468496">,</span>&nbsp;<span class="builtintype" id="1468498">uintptr</span><span class="op" id="1468505">(</span><span class="ident" id="1468506">t</span><span class="op" id="1468507">.</span><span class="ident" id="1468508">key</span><span class="op" id="1468511">.</span><span class="ident" id="1468512">size</span><span class="op" id="1468516">)</span><span class="op" id="1468517">,</span>&nbsp;<span class="builtintype" id="1468519">uintptr</span><span class="op" id="1468526">(</span><span class="ident" id="1468527">h</span><span class="op" id="1468528">.</span><span class="ident" id="1468529">hash0</span><span class="op" id="1468534">)</span><span class="op" id="1468535">)</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1468539">if</span>&nbsp;<span class="ident" id="1468542">h</span><span class="op" id="1468543">.</span><span class="ident" id="1468544">buckets</span>&nbsp;<span class="op" id="1468552">==</span>&nbsp;<span class="ident" id="1468555">nil</span>&nbsp;<span class="op" id="1468559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1468563">if</span>&nbsp;<span class="ident" id="1468566">checkgc</span>&nbsp;<span class="op" id="1468574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468579">memstats</span><span class="op" id="1468587">.</span><span class="ident" id="1468588">next_gc</span>&nbsp;<span class="op" id="1468596">=</span>&nbsp;<span class="ident" id="1468598">memstats</span><span class="op" id="1468606">.</span><span class="ident" id="1468607">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1468620">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468624">h</span><span class="op" id="1468625">.</span><span class="ident" id="1468626">buckets</span>&nbsp;<span class="op" id="1468634">=</span>&nbsp;<span class="ident" id="1468636">newarray</span><span class="op" id="1468644">(</span><span class="ident" id="1468645">t</span><span class="op" id="1468646">.</span><span class="ident" id="1468647">bucket</span><span class="op" id="1468653">,</span>&nbsp;<span class="num" id="1468655">1</span><span class="op" id="1468656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1468659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1468662">again</span><span class="op" id="1468667">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468670">bucket</span>&nbsp;<span class="op" id="1468677">:=</span>&nbsp;<span class="ident" id="1468680">hash</span>&nbsp;<span class="op" id="1468685">&amp;</span>&nbsp;<span class="op" id="1468687">(</span><span class="builtintype" id="1468688">uintptr</span><span class="op" id="1468695">(</span><span class="num" id="1468696">1</span><span class="op" id="1468697">)</span><span class="op" id="1468698">&lt;&lt;</span><span class="ident" id="1468700">h</span><span class="op" id="1468701">.</span><span class="ident" id="1468702">B</span>&nbsp;<span class="op" id="1468704">-</span>&nbsp;<span class="num" id="1468706">1</span><span class="op" id="1468707">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1468710">if</span>&nbsp;<span class="ident" id="1468713">h</span><span class="op" id="1468714">.</span><span class="ident" id="1468715">oldbuckets</span>&nbsp;<span class="op" id="1468726">!=</span>&nbsp;<span class="ident" id="1468729">nil</span>&nbsp;<span class="op" id="1468733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468737">growWork</span><span class="op" id="1468745">(</span><span class="ident" id="1468746">t</span><span class="op" id="1468747">,</span>&nbsp;<span class="ident" id="1468749">h</span><span class="op" id="1468750">,</span>&nbsp;<span class="ident" id="1468752">bucket</span><span class="op" id="1468758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1468761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468764">b</span>&nbsp;<span class="op" id="1468766">:=</span>&nbsp;<span class="op" id="1468769">(</span><span class="op" id="1468770">*</span><span class="ident" id="1468771">bmap</span><span class="op" id="1468775">)</span><span class="op" id="1468776">(</span><span class="ident" id="1468777">unsafe</span><span class="op" id="1468783">.</span><span class="ident" id="1468784">Pointer</span><span class="op" id="1468791">(</span><span class="builtintype" id="1468792">uintptr</span><span class="op" id="1468799">(</span><span class="ident" id="1468800">h</span><span class="op" id="1468801">.</span><span class="ident" id="1468802">buckets</span><span class="op" id="1468809">)</span>&nbsp;<span class="op" id="1468811">+</span>&nbsp;<span class="ident" id="1468813">bucket</span><span class="op" id="1468819">*</span><span class="builtintype" id="1468820">uintptr</span><span class="op" id="1468827">(</span><span class="ident" id="1468828">t</span><span class="op" id="1468829">.</span><span class="ident" id="1468830">bucketsize</span><span class="op" id="1468840">)</span><span class="op" id="1468841">)</span><span class="op" id="1468842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468845">top</span>&nbsp;<span class="op" id="1468849">:=</span>&nbsp;<span class="builtintype" id="1468852">uint8</span><span class="op" id="1468857">(</span><span class="ident" id="1468858">hash</span>&nbsp;<span class="op" id="1468863">&gt;&gt;</span>&nbsp;<span class="op" id="1468866">(</span><span class="ident" id="1468867">ptrSize</span><span class="op" id="1468874">*</span><span class="num" id="1468875">8</span>&nbsp;<span class="op" id="1468877">-</span>&nbsp;<span class="num" id="1468879">8</span><span class="op" id="1468880">)</span><span class="op" id="1468881">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1468884">if</span>&nbsp;<span class="ident" id="1468887">top</span>&nbsp;<span class="op" id="1468891">&lt;</span>&nbsp;<span class="ident" id="1468893">minTopHash</span>&nbsp;<span class="op" id="1468904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1468908">top</span>&nbsp;<span class="op" id="1468912">+=</span>&nbsp;<span class="ident" id="1468915">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1468927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1468931">var</span>&nbsp;<span class="ident" id="1468935">inserti</span>&nbsp;<span class="op" id="1468943">*</span><span class="builtintype" id="1468944">uint8</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1468951">var</span>&nbsp;<span class="ident" id="1468955">insertk</span>&nbsp;<span class="ident" id="1468963">unsafe</span><span class="op" id="1468969">.</span><span class="ident" id="1468970">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1468979">var</span>&nbsp;<span class="ident" id="1468983">insertv</span>&nbsp;<span class="ident" id="1468991">unsafe</span><span class="op" id="1468997">.</span><span class="ident" id="1468998">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469007">for</span>&nbsp;<span class="op" id="1469011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469015">for</span>&nbsp;<span class="ident" id="1469019">i</span>&nbsp;<span class="op" id="1469021">:=</span>&nbsp;<span class="builtintype" id="1469024">uintptr</span><span class="op" id="1469031">(</span><span class="num" id="1469032">0</span><span class="op" id="1469033">)</span><span class="op" id="1469034">;</span>&nbsp;<span class="ident" id="1469036">i</span>&nbsp;<span class="op" id="1469038">&lt;</span>&nbsp;<span class="ident" id="1469040">bucketCnt</span><span class="op" id="1469049">;</span>&nbsp;<span class="ident" id="1469051">i</span><span class="op" id="1469052">++</span>&nbsp;<span class="op" id="1469055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469060">if</span>&nbsp;<span class="ident" id="1469063">b</span><span class="op" id="1469064">.</span><span class="ident" id="1469065">tophash</span><span class="op" id="1469072">[</span><span class="ident" id="1469073">i</span><span class="op" id="1469074">]</span>&nbsp;<span class="op" id="1469076">!=</span>&nbsp;<span class="ident" id="1469079">top</span>&nbsp;<span class="op" id="1469083">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469089">if</span>&nbsp;<span class="ident" id="1469092">b</span><span class="op" id="1469093">.</span><span class="ident" id="1469094">tophash</span><span class="op" id="1469101">[</span><span class="ident" id="1469102">i</span><span class="op" id="1469103">]</span>&nbsp;<span class="op" id="1469105">==</span>&nbsp;<span class="ident" id="1469108">empty</span>&nbsp;<span class="op" id="1469114">&amp;&amp;</span>&nbsp;<span class="ident" id="1469117">inserti</span>&nbsp;<span class="op" id="1469125">==</span>&nbsp;<span class="ident" id="1469128">nil</span>&nbsp;<span class="op" id="1469132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469139">inserti</span>&nbsp;<span class="op" id="1469147">=</span>&nbsp;<span class="op" id="1469149">&amp;</span><span class="ident" id="1469150">b</span><span class="op" id="1469151">.</span><span class="ident" id="1469152">tophash</span><span class="op" id="1469159">[</span><span class="ident" id="1469160">i</span><span class="op" id="1469161">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469168">insertk</span>&nbsp;<span class="op" id="1469176">=</span>&nbsp;<span class="ident" id="1469178">add</span><span class="op" id="1469181">(</span><span class="ident" id="1469182">unsafe</span><span class="op" id="1469188">.</span><span class="ident" id="1469189">Pointer</span><span class="op" id="1469196">(</span><span class="ident" id="1469197">b</span><span class="op" id="1469198">)</span><span class="op" id="1469199">,</span>&nbsp;<span class="ident" id="1469201">dataOffset</span><span class="op" id="1469211">+</span><span class="ident" id="1469212">i</span><span class="op" id="1469213">*</span><span class="builtintype" id="1469214">uintptr</span><span class="op" id="1469221">(</span><span class="ident" id="1469222">t</span><span class="op" id="1469223">.</span><span class="ident" id="1469224">keysize</span><span class="op" id="1469231">)</span><span class="op" id="1469232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469239">insertv</span>&nbsp;<span class="op" id="1469247">=</span>&nbsp;<span class="ident" id="1469249">add</span><span class="op" id="1469252">(</span><span class="ident" id="1469253">unsafe</span><span class="op" id="1469259">.</span><span class="ident" id="1469260">Pointer</span><span class="op" id="1469267">(</span><span class="ident" id="1469268">b</span><span class="op" id="1469269">)</span><span class="op" id="1469270">,</span>&nbsp;<span class="ident" id="1469272">dataOffset</span><span class="op" id="1469282">+</span><span class="ident" id="1469283">bucketCnt</span><span class="op" id="1469292">*</span><span class="builtintype" id="1469293">uintptr</span><span class="op" id="1469300">(</span><span class="ident" id="1469301">t</span><span class="op" id="1469302">.</span><span class="ident" id="1469303">keysize</span><span class="op" id="1469310">)</span><span class="op" id="1469311">+</span><span class="ident" id="1469312">i</span><span class="op" id="1469313">*</span><span class="builtintype" id="1469314">uintptr</span><span class="op" id="1469321">(</span><span class="ident" id="1469322">t</span><span class="op" id="1469323">.</span><span class="ident" id="1469324">valuesize</span><span class="op" id="1469333">)</span><span class="op" id="1469334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469340">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469346">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469363">k</span>&nbsp;<span class="op" id="1469365">:=</span>&nbsp;<span class="ident" id="1469368">add</span><span class="op" id="1469371">(</span><span class="ident" id="1469372">unsafe</span><span class="op" id="1469378">.</span><span class="ident" id="1469379">Pointer</span><span class="op" id="1469386">(</span><span class="ident" id="1469387">b</span><span class="op" id="1469388">)</span><span class="op" id="1469389">,</span>&nbsp;<span class="ident" id="1469391">dataOffset</span><span class="op" id="1469401">+</span><span class="ident" id="1469402">i</span><span class="op" id="1469403">*</span><span class="builtintype" id="1469404">uintptr</span><span class="op" id="1469411">(</span><span class="ident" id="1469412">t</span><span class="op" id="1469413">.</span><span class="ident" id="1469414">keysize</span><span class="op" id="1469421">)</span><span class="op" id="1469422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469427">k2</span>&nbsp;<span class="op" id="1469430">:=</span>&nbsp;<span class="ident" id="1469433">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469438">if</span>&nbsp;<span class="ident" id="1469441">t</span><span class="op" id="1469442">.</span><span class="ident" id="1469443">indirectkey</span>&nbsp;<span class="op" id="1469455">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469461">k2</span>&nbsp;<span class="op" id="1469464">=</span>&nbsp;<span class="op" id="1469466">*</span><span class="op" id="1469467">(</span><span class="op" id="1469468">(</span><span class="op" id="1469469">*</span><span class="ident" id="1469470">unsafe</span><span class="op" id="1469476">.</span><span class="ident" id="1469477">Pointer</span><span class="op" id="1469484">)</span><span class="op" id="1469485">(</span><span class="ident" id="1469486">k2</span><span class="op" id="1469488">)</span><span class="op" id="1469489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469499">if</span>&nbsp;<span class="op" id="1469502">!</span><span class="ident" id="1469503">alg</span><span class="op" id="1469506">.</span><span class="ident" id="1469507">equal</span><span class="op" id="1469512">(</span><span class="ident" id="1469513">key</span><span class="op" id="1469516">,</span>&nbsp;<span class="ident" id="1469518">k2</span><span class="op" id="1469520">,</span>&nbsp;<span class="builtintype" id="1469522">uintptr</span><span class="op" id="1469529">(</span><span class="ident" id="1469530">t</span><span class="op" id="1469531">.</span><span class="ident" id="1469532">key</span><span class="op" id="1469535">.</span><span class="ident" id="1469536">size</span><span class="op" id="1469540">)</span><span class="op" id="1469541">)</span>&nbsp;<span class="op" id="1469543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469549">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469561">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1469566">//&nbsp;already&nbsp;have&nbsp;a&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Update&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469616">memmove</span><span class="op" id="1469623">(</span><span class="ident" id="1469624">k2</span><span class="op" id="1469626">,</span>&nbsp;<span class="ident" id="1469628">key</span><span class="op" id="1469631">,</span>&nbsp;<span class="builtintype" id="1469633">uintptr</span><span class="op" id="1469640">(</span><span class="ident" id="1469641">t</span><span class="op" id="1469642">.</span><span class="ident" id="1469643">key</span><span class="op" id="1469646">.</span><span class="ident" id="1469647">size</span><span class="op" id="1469651">)</span><span class="op" id="1469652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469657">v</span>&nbsp;<span class="op" id="1469659">:=</span>&nbsp;<span class="ident" id="1469662">add</span><span class="op" id="1469665">(</span><span class="ident" id="1469666">unsafe</span><span class="op" id="1469672">.</span><span class="ident" id="1469673">Pointer</span><span class="op" id="1469680">(</span><span class="ident" id="1469681">b</span><span class="op" id="1469682">)</span><span class="op" id="1469683">,</span>&nbsp;<span class="ident" id="1469685">dataOffset</span><span class="op" id="1469695">+</span><span class="ident" id="1469696">bucketCnt</span><span class="op" id="1469705">*</span><span class="builtintype" id="1469706">uintptr</span><span class="op" id="1469713">(</span><span class="ident" id="1469714">t</span><span class="op" id="1469715">.</span><span class="ident" id="1469716">keysize</span><span class="op" id="1469723">)</span><span class="op" id="1469724">+</span><span class="ident" id="1469725">i</span><span class="op" id="1469726">*</span><span class="builtintype" id="1469727">uintptr</span><span class="op" id="1469734">(</span><span class="ident" id="1469735">t</span><span class="op" id="1469736">.</span><span class="ident" id="1469737">valuesize</span><span class="op" id="1469746">)</span><span class="op" id="1469747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469752">v2</span>&nbsp;<span class="op" id="1469755">:=</span>&nbsp;<span class="ident" id="1469758">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469763">if</span>&nbsp;<span class="ident" id="1469766">t</span><span class="op" id="1469767">.</span><span class="ident" id="1469768">indirectvalue</span>&nbsp;<span class="op" id="1469782">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469788">v2</span>&nbsp;<span class="op" id="1469791">=</span>&nbsp;<span class="op" id="1469793">*</span><span class="op" id="1469794">(</span><span class="op" id="1469795">(</span><span class="op" id="1469796">*</span><span class="ident" id="1469797">unsafe</span><span class="op" id="1469803">.</span><span class="ident" id="1469804">Pointer</span><span class="op" id="1469811">)</span><span class="op" id="1469812">(</span><span class="ident" id="1469813">v2</span><span class="op" id="1469815">)</span><span class="op" id="1469816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469826">memmove</span><span class="op" id="1469833">(</span><span class="ident" id="1469834">v2</span><span class="op" id="1469836">,</span>&nbsp;<span class="ident" id="1469838">val</span><span class="op" id="1469841">,</span>&nbsp;<span class="builtintype" id="1469843">uintptr</span><span class="op" id="1469850">(</span><span class="ident" id="1469851">t</span><span class="op" id="1469852">.</span><span class="ident" id="1469853">elem</span><span class="op" id="1469857">.</span><span class="ident" id="1469858">size</span><span class="op" id="1469862">)</span><span class="op" id="1469863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469868">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469877">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469881">if</span>&nbsp;<span class="ident" id="1469884">b</span><span class="op" id="1469885">.</span><span class="ident" id="1469886">overflow</span>&nbsp;<span class="op" id="1469895">==</span>&nbsp;<span class="ident" id="1469898">nil</span>&nbsp;<span class="op" id="1469902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1469907">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1469919">b</span>&nbsp;<span class="op" id="1469921">=</span>&nbsp;<span class="ident" id="1469923">b</span><span class="op" id="1469924">.</span><span class="ident" id="1469925">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1469935">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1469939">//&nbsp;did&nbsp;not&nbsp;find&nbsp;mapping&nbsp;for&nbsp;key.&nbsp;&nbsp;Allocate&nbsp;new&nbsp;cell&nbsp;&amp;&nbsp;add&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470005">if</span>&nbsp;<span class="builtintype" id="1470008">float32</span><span class="op" id="1470015">(</span><span class="ident" id="1470016">h</span><span class="op" id="1470017">.</span><span class="ident" id="1470018">count</span><span class="op" id="1470023">)</span>&nbsp;<span class="op" id="1470025">&gt;=</span>&nbsp;<span class="ident" id="1470028">loadFactor</span><span class="op" id="1470038">*</span><span class="builtintype" id="1470039">float32</span><span class="op" id="1470046">(</span><span class="op" id="1470047">(</span><span class="builtintype" id="1470048">uintptr</span><span class="op" id="1470055">(</span><span class="num" id="1470056">1</span><span class="op" id="1470057">)</span><span class="op" id="1470058">&lt;&lt;</span><span class="ident" id="1470060">h</span><span class="op" id="1470061">.</span><span class="ident" id="1470062">B</span><span class="op" id="1470063">)</span><span class="op" id="1470064">)</span>&nbsp;<span class="op" id="1470066">&amp;&amp;</span>&nbsp;<span class="ident" id="1470069">h</span><span class="op" id="1470070">.</span><span class="ident" id="1470071">count</span>&nbsp;<span class="op" id="1470077">&gt;=</span>&nbsp;<span class="ident" id="1470080">bucketCnt</span>&nbsp;<span class="op" id="1470090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470094">hashGrow</span><span class="op" id="1470102">(</span><span class="ident" id="1470103">t</span><span class="op" id="1470104">,</span>&nbsp;<span class="ident" id="1470106">h</span><span class="op" id="1470107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470111">goto</span>&nbsp;<span class="ident" id="1470116">again</span>&nbsp;<span class="comment" id="1470122">//&nbsp;Growing&nbsp;the&nbsp;table&nbsp;invalidates&nbsp;everything,&nbsp;so&nbsp;try&nbsp;again</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470185">if</span>&nbsp;<span class="ident" id="1470188">inserti</span>&nbsp;<span class="op" id="1470196">==</span>&nbsp;<span class="ident" id="1470199">nil</span>&nbsp;<span class="op" id="1470203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1470207">//&nbsp;all&nbsp;current&nbsp;buckets&nbsp;are&nbsp;full,&nbsp;allocate&nbsp;a&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470262">if</span>&nbsp;<span class="ident" id="1470265">checkgc</span>&nbsp;<span class="op" id="1470273">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470278">memstats</span><span class="op" id="1470286">.</span><span class="ident" id="1470287">next_gc</span>&nbsp;<span class="op" id="1470295">=</span>&nbsp;<span class="ident" id="1470297">memstats</span><span class="op" id="1470305">.</span><span class="ident" id="1470306">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470323">newb</span>&nbsp;<span class="op" id="1470328">:=</span>&nbsp;<span class="op" id="1470331">(</span><span class="op" id="1470332">*</span><span class="ident" id="1470333">bmap</span><span class="op" id="1470337">)</span><span class="op" id="1470338">(</span><span class="ident" id="1470339">newobject</span><span class="op" id="1470348">(</span><span class="ident" id="1470349">t</span><span class="op" id="1470350">.</span><span class="ident" id="1470351">bucket</span><span class="op" id="1470357">)</span><span class="op" id="1470358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470362">b</span><span class="op" id="1470363">.</span><span class="ident" id="1470364">overflow</span>&nbsp;<span class="op" id="1470373">=</span>&nbsp;<span class="ident" id="1470375">newb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470382">inserti</span>&nbsp;<span class="op" id="1470390">=</span>&nbsp;<span class="op" id="1470392">&amp;</span><span class="ident" id="1470393">newb</span><span class="op" id="1470397">.</span><span class="ident" id="1470398">tophash</span><span class="op" id="1470405">[</span><span class="num" id="1470406">0</span><span class="op" id="1470407">]</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470411">insertk</span>&nbsp;<span class="op" id="1470419">=</span>&nbsp;<span class="ident" id="1470421">add</span><span class="op" id="1470424">(</span><span class="ident" id="1470425">unsafe</span><span class="op" id="1470431">.</span><span class="ident" id="1470432">Pointer</span><span class="op" id="1470439">(</span><span class="ident" id="1470440">newb</span><span class="op" id="1470444">)</span><span class="op" id="1470445">,</span>&nbsp;<span class="ident" id="1470447">dataOffset</span><span class="op" id="1470457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470461">insertv</span>&nbsp;<span class="op" id="1470469">=</span>&nbsp;<span class="ident" id="1470471">add</span><span class="op" id="1470474">(</span><span class="ident" id="1470475">insertk</span><span class="op" id="1470482">,</span>&nbsp;<span class="ident" id="1470484">bucketCnt</span><span class="op" id="1470493">*</span><span class="builtintype" id="1470494">uintptr</span><span class="op" id="1470501">(</span><span class="ident" id="1470502">t</span><span class="op" id="1470503">.</span><span class="ident" id="1470504">keysize</span><span class="op" id="1470511">)</span><span class="op" id="1470512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1470519">//&nbsp;store&nbsp;new&nbsp;key/value&nbsp;at&nbsp;insert&nbsp;position</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470562">if</span>&nbsp;<span class="ident" id="1470565">t</span><span class="op" id="1470566">.</span><span class="ident" id="1470567">indirectkey</span>&nbsp;<span class="op" id="1470579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470583">if</span>&nbsp;<span class="ident" id="1470586">checkgc</span>&nbsp;<span class="op" id="1470594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470599">memstats</span><span class="op" id="1470607">.</span><span class="ident" id="1470608">next_gc</span>&nbsp;<span class="op" id="1470616">=</span>&nbsp;<span class="ident" id="1470618">memstats</span><span class="op" id="1470626">.</span><span class="ident" id="1470627">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470644">kmem</span>&nbsp;<span class="op" id="1470649">:=</span>&nbsp;<span class="ident" id="1470652">newobject</span><span class="op" id="1470661">(</span><span class="ident" id="1470662">t</span><span class="op" id="1470663">.</span><span class="ident" id="1470664">key</span><span class="op" id="1470667">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470671">*</span><span class="op" id="1470672">(</span><span class="op" id="1470673">*</span><span class="ident" id="1470674">unsafe</span><span class="op" id="1470680">.</span><span class="ident" id="1470681">Pointer</span><span class="op" id="1470688">)</span><span class="op" id="1470689">(</span><span class="ident" id="1470690">insertk</span><span class="op" id="1470697">)</span>&nbsp;<span class="op" id="1470699">=</span>&nbsp;<span class="ident" id="1470701">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470708">insertk</span>&nbsp;<span class="op" id="1470716">=</span>&nbsp;<span class="ident" id="1470718">kmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470727">if</span>&nbsp;<span class="ident" id="1470730">t</span><span class="op" id="1470731">.</span><span class="ident" id="1470732">indirectvalue</span>&nbsp;<span class="op" id="1470746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1470750">if</span>&nbsp;<span class="ident" id="1470753">checkgc</span>&nbsp;<span class="op" id="1470761">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470766">memstats</span><span class="op" id="1470774">.</span><span class="ident" id="1470775">next_gc</span>&nbsp;<span class="op" id="1470783">=</span>&nbsp;<span class="ident" id="1470785">memstats</span><span class="op" id="1470793">.</span><span class="ident" id="1470794">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470811">vmem</span>&nbsp;<span class="op" id="1470816">:=</span>&nbsp;<span class="ident" id="1470819">newobject</span><span class="op" id="1470828">(</span><span class="ident" id="1470829">t</span><span class="op" id="1470830">.</span><span class="ident" id="1470831">elem</span><span class="op" id="1470835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470839">*</span><span class="op" id="1470840">(</span><span class="op" id="1470841">*</span><span class="ident" id="1470842">unsafe</span><span class="op" id="1470848">.</span><span class="ident" id="1470849">Pointer</span><span class="op" id="1470856">)</span><span class="op" id="1470857">(</span><span class="ident" id="1470858">insertv</span><span class="op" id="1470865">)</span>&nbsp;<span class="op" id="1470867">=</span>&nbsp;<span class="ident" id="1470869">vmem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470876">insertv</span>&nbsp;<span class="op" id="1470884">=</span>&nbsp;<span class="ident" id="1470886">vmem</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470895">memmove</span><span class="op" id="1470902">(</span><span class="ident" id="1470903">insertk</span><span class="op" id="1470910">,</span>&nbsp;<span class="ident" id="1470912">key</span><span class="op" id="1470915">,</span>&nbsp;<span class="builtintype" id="1470917">uintptr</span><span class="op" id="1470924">(</span><span class="ident" id="1470925">t</span><span class="op" id="1470926">.</span><span class="ident" id="1470927">key</span><span class="op" id="1470930">.</span><span class="ident" id="1470931">size</span><span class="op" id="1470935">)</span><span class="op" id="1470936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1470939">memmove</span><span class="op" id="1470946">(</span><span class="ident" id="1470947">insertv</span><span class="op" id="1470954">,</span>&nbsp;<span class="ident" id="1470956">val</span><span class="op" id="1470959">,</span>&nbsp;<span class="builtintype" id="1470961">uintptr</span><span class="op" id="1470968">(</span><span class="ident" id="1470969">t</span><span class="op" id="1470970">.</span><span class="ident" id="1470971">elem</span><span class="op" id="1470975">.</span><span class="ident" id="1470976">size</span><span class="op" id="1470980">)</span><span class="op" id="1470981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1470984">*</span><span class="ident" id="1470985">inserti</span>&nbsp;<span class="op" id="1470993">=</span>&nbsp;<span class="ident" id="1470995">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471000">h</span><span class="op" id="1471001">.</span><span class="ident" id="1471002">count</span><span class="op" id="1471007">++</span><br>
<span class="lineno">485</span><span class="op" id="1471010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1471013">func</span>&nbsp;<span class="ident" id="1471018">mapdelete</span><span class="op" id="1471027">(</span><span class="ident" id="1471028">t</span>&nbsp;<span class="op" id="1471030">*</span><span class="ident" id="1471031">maptype</span><span class="op" id="1471038">,</span>&nbsp;<span class="ident" id="1471040">h</span>&nbsp;<span class="op" id="1471042">*</span><span class="ident" id="1471043">hmap</span><span class="op" id="1471047">,</span>&nbsp;<span class="ident" id="1471049">key</span>&nbsp;<span class="ident" id="1471053">unsafe</span><span class="op" id="1471059">.</span><span class="ident" id="1471060">Pointer</span><span class="op" id="1471067">)</span>&nbsp;<span class="op" id="1471069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471072">if</span>&nbsp;<span class="ident" id="1471075">raceenabled</span>&nbsp;<span class="op" id="1471087">&amp;&amp;</span>&nbsp;<span class="ident" id="1471090">h</span>&nbsp;<span class="op" id="1471092">!=</span>&nbsp;<span class="ident" id="1471095">nil</span>&nbsp;<span class="op" id="1471099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471103">callerpc</span>&nbsp;<span class="op" id="1471112">:=</span>&nbsp;<span class="ident" id="1471115">getcallerpc</span><span class="op" id="1471126">(</span><span class="ident" id="1471127">unsafe</span><span class="op" id="1471133">.</span><span class="ident" id="1471134">Pointer</span><span class="op" id="1471141">(</span><span class="op" id="1471142">&amp;</span><span class="ident" id="1471143">t</span><span class="op" id="1471144">)</span><span class="op" id="1471145">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471149">pc</span>&nbsp;<span class="op" id="1471152">:=</span>&nbsp;<span class="ident" id="1471155">funcPC</span><span class="op" id="1471161">(</span><span class="ident" id="1471162">mapdelete</span><span class="op" id="1471171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471175">racewritepc</span><span class="op" id="1471186">(</span><span class="ident" id="1471187">unsafe</span><span class="op" id="1471193">.</span><span class="ident" id="1471194">Pointer</span><span class="op" id="1471201">(</span><span class="ident" id="1471202">h</span><span class="op" id="1471203">)</span><span class="op" id="1471204">,</span>&nbsp;<span class="ident" id="1471206">callerpc</span><span class="op" id="1471214">,</span>&nbsp;<span class="ident" id="1471216">pc</span><span class="op" id="1471218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471222">raceReadObjectPC</span><span class="op" id="1471238">(</span><span class="ident" id="1471239">t</span><span class="op" id="1471240">.</span><span class="ident" id="1471241">key</span><span class="op" id="1471244">,</span>&nbsp;<span class="ident" id="1471246">key</span><span class="op" id="1471249">,</span>&nbsp;<span class="ident" id="1471251">callerpc</span><span class="op" id="1471259">,</span>&nbsp;<span class="ident" id="1471261">pc</span><span class="op" id="1471263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471269">if</span>&nbsp;<span class="ident" id="1471272">h</span>&nbsp;<span class="op" id="1471274">==</span>&nbsp;<span class="ident" id="1471277">nil</span>&nbsp;<span class="op" id="1471281">||</span>&nbsp;<span class="ident" id="1471284">h</span><span class="op" id="1471285">.</span><span class="ident" id="1471286">count</span>&nbsp;<span class="op" id="1471292">==</span>&nbsp;<span class="num" id="1471295">0</span>&nbsp;<span class="op" id="1471297">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471301">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471312">alg</span>&nbsp;<span class="op" id="1471316">:=</span>&nbsp;<span class="ident" id="1471319">goalg</span><span class="op" id="1471324">(</span><span class="ident" id="1471325">t</span><span class="op" id="1471326">.</span><span class="ident" id="1471327">key</span><span class="op" id="1471330">.</span><span class="ident" id="1471331">alg</span><span class="op" id="1471334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471337">hash</span>&nbsp;<span class="op" id="1471342">:=</span>&nbsp;<span class="ident" id="1471345">alg</span><span class="op" id="1471348">.</span><span class="ident" id="1471349">hash</span><span class="op" id="1471353">(</span><span class="ident" id="1471354">key</span><span class="op" id="1471357">,</span>&nbsp;<span class="builtintype" id="1471359">uintptr</span><span class="op" id="1471366">(</span><span class="ident" id="1471367">t</span><span class="op" id="1471368">.</span><span class="ident" id="1471369">key</span><span class="op" id="1471372">.</span><span class="ident" id="1471373">size</span><span class="op" id="1471377">)</span><span class="op" id="1471378">,</span>&nbsp;<span class="builtintype" id="1471380">uintptr</span><span class="op" id="1471387">(</span><span class="ident" id="1471388">h</span><span class="op" id="1471389">.</span><span class="ident" id="1471390">hash0</span><span class="op" id="1471395">)</span><span class="op" id="1471396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471399">bucket</span>&nbsp;<span class="op" id="1471406">:=</span>&nbsp;<span class="ident" id="1471409">hash</span>&nbsp;<span class="op" id="1471414">&amp;</span>&nbsp;<span class="op" id="1471416">(</span><span class="builtintype" id="1471417">uintptr</span><span class="op" id="1471424">(</span><span class="num" id="1471425">1</span><span class="op" id="1471426">)</span><span class="op" id="1471427">&lt;&lt;</span><span class="ident" id="1471429">h</span><span class="op" id="1471430">.</span><span class="ident" id="1471431">B</span>&nbsp;<span class="op" id="1471433">-</span>&nbsp;<span class="num" id="1471435">1</span><span class="op" id="1471436">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471439">if</span>&nbsp;<span class="ident" id="1471442">h</span><span class="op" id="1471443">.</span><span class="ident" id="1471444">oldbuckets</span>&nbsp;<span class="op" id="1471455">!=</span>&nbsp;<span class="ident" id="1471458">nil</span>&nbsp;<span class="op" id="1471462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471466">growWork</span><span class="op" id="1471474">(</span><span class="ident" id="1471475">t</span><span class="op" id="1471476">,</span>&nbsp;<span class="ident" id="1471478">h</span><span class="op" id="1471479">,</span>&nbsp;<span class="ident" id="1471481">bucket</span><span class="op" id="1471487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471493">b</span>&nbsp;<span class="op" id="1471495">:=</span>&nbsp;<span class="op" id="1471498">(</span><span class="op" id="1471499">*</span><span class="ident" id="1471500">bmap</span><span class="op" id="1471504">)</span><span class="op" id="1471505">(</span><span class="ident" id="1471506">unsafe</span><span class="op" id="1471512">.</span><span class="ident" id="1471513">Pointer</span><span class="op" id="1471520">(</span><span class="builtintype" id="1471521">uintptr</span><span class="op" id="1471528">(</span><span class="ident" id="1471529">h</span><span class="op" id="1471530">.</span><span class="ident" id="1471531">buckets</span><span class="op" id="1471538">)</span>&nbsp;<span class="op" id="1471540">+</span>&nbsp;<span class="ident" id="1471542">bucket</span><span class="op" id="1471548">*</span><span class="builtintype" id="1471549">uintptr</span><span class="op" id="1471556">(</span><span class="ident" id="1471557">t</span><span class="op" id="1471558">.</span><span class="ident" id="1471559">bucketsize</span><span class="op" id="1471569">)</span><span class="op" id="1471570">)</span><span class="op" id="1471571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471574">top</span>&nbsp;<span class="op" id="1471578">:=</span>&nbsp;<span class="builtintype" id="1471581">uint8</span><span class="op" id="1471586">(</span><span class="ident" id="1471587">hash</span>&nbsp;<span class="op" id="1471592">&gt;&gt;</span>&nbsp;<span class="op" id="1471595">(</span><span class="ident" id="1471596">ptrSize</span><span class="op" id="1471603">*</span><span class="num" id="1471604">8</span>&nbsp;<span class="op" id="1471606">-</span>&nbsp;<span class="num" id="1471608">8</span><span class="op" id="1471609">)</span><span class="op" id="1471610">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471613">if</span>&nbsp;<span class="ident" id="1471616">top</span>&nbsp;<span class="op" id="1471620">&lt;</span>&nbsp;<span class="ident" id="1471622">minTopHash</span>&nbsp;<span class="op" id="1471633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471637">top</span>&nbsp;<span class="op" id="1471641">+=</span>&nbsp;<span class="ident" id="1471644">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471659">for</span>&nbsp;<span class="op" id="1471663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471667">for</span>&nbsp;<span class="ident" id="1471671">i</span>&nbsp;<span class="op" id="1471673">:=</span>&nbsp;<span class="builtintype" id="1471676">uintptr</span><span class="op" id="1471683">(</span><span class="num" id="1471684">0</span><span class="op" id="1471685">)</span><span class="op" id="1471686">;</span>&nbsp;<span class="ident" id="1471688">i</span>&nbsp;<span class="op" id="1471690">&lt;</span>&nbsp;<span class="ident" id="1471692">bucketCnt</span><span class="op" id="1471701">;</span>&nbsp;<span class="ident" id="1471703">i</span><span class="op" id="1471704">++</span>&nbsp;<span class="op" id="1471707">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471712">if</span>&nbsp;<span class="ident" id="1471715">b</span><span class="op" id="1471716">.</span><span class="ident" id="1471717">tophash</span><span class="op" id="1471724">[</span><span class="ident" id="1471725">i</span><span class="op" id="1471726">]</span>&nbsp;<span class="op" id="1471728">!=</span>&nbsp;<span class="ident" id="1471731">top</span>&nbsp;<span class="op" id="1471735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471741">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471758">k</span>&nbsp;<span class="op" id="1471760">:=</span>&nbsp;<span class="ident" id="1471763">add</span><span class="op" id="1471766">(</span><span class="ident" id="1471767">unsafe</span><span class="op" id="1471773">.</span><span class="ident" id="1471774">Pointer</span><span class="op" id="1471781">(</span><span class="ident" id="1471782">b</span><span class="op" id="1471783">)</span><span class="op" id="1471784">,</span>&nbsp;<span class="ident" id="1471786">dataOffset</span><span class="op" id="1471796">+</span><span class="ident" id="1471797">i</span><span class="op" id="1471798">*</span><span class="builtintype" id="1471799">uintptr</span><span class="op" id="1471806">(</span><span class="ident" id="1471807">t</span><span class="op" id="1471808">.</span><span class="ident" id="1471809">keysize</span><span class="op" id="1471816">)</span><span class="op" id="1471817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471822">k2</span>&nbsp;<span class="op" id="1471825">:=</span>&nbsp;<span class="ident" id="1471828">k</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471833">if</span>&nbsp;<span class="ident" id="1471836">t</span><span class="op" id="1471837">.</span><span class="ident" id="1471838">indirectkey</span>&nbsp;<span class="op" id="1471850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471856">k2</span>&nbsp;<span class="op" id="1471859">=</span>&nbsp;<span class="op" id="1471861">*</span><span class="op" id="1471862">(</span><span class="op" id="1471863">(</span><span class="op" id="1471864">*</span><span class="ident" id="1471865">unsafe</span><span class="op" id="1471871">.</span><span class="ident" id="1471872">Pointer</span><span class="op" id="1471879">)</span><span class="op" id="1471880">(</span><span class="ident" id="1471881">k2</span><span class="op" id="1471883">)</span><span class="op" id="1471884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471894">if</span>&nbsp;<span class="op" id="1471897">!</span><span class="ident" id="1471898">alg</span><span class="op" id="1471901">.</span><span class="ident" id="1471902">equal</span><span class="op" id="1471907">(</span><span class="ident" id="1471908">key</span><span class="op" id="1471911">,</span>&nbsp;<span class="ident" id="1471913">k2</span><span class="op" id="1471915">,</span>&nbsp;<span class="builtintype" id="1471917">uintptr</span><span class="op" id="1471924">(</span><span class="ident" id="1471925">t</span><span class="op" id="1471926">.</span><span class="ident" id="1471927">key</span><span class="op" id="1471930">.</span><span class="ident" id="1471931">size</span><span class="op" id="1471935">)</span><span class="op" id="1471936">)</span>&nbsp;<span class="op" id="1471938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1471944">continue</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1471956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471961">memclr</span><span class="op" id="1471967">(</span><span class="ident" id="1471968">k</span><span class="op" id="1471969">,</span>&nbsp;<span class="builtintype" id="1471971">uintptr</span><span class="op" id="1471978">(</span><span class="ident" id="1471979">t</span><span class="op" id="1471980">.</span><span class="ident" id="1471981">keysize</span><span class="op" id="1471988">)</span><span class="op" id="1471989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1471994">v</span>&nbsp;<span class="op" id="1471996">:=</span>&nbsp;<span class="ident" id="1471999">unsafe</span><span class="op" id="1472005">.</span><span class="ident" id="1472006">Pointer</span><span class="op" id="1472013">(</span><span class="builtintype" id="1472014">uintptr</span><span class="op" id="1472021">(</span><span class="ident" id="1472022">unsafe</span><span class="op" id="1472028">.</span><span class="ident" id="1472029">Pointer</span><span class="op" id="1472036">(</span><span class="ident" id="1472037">b</span><span class="op" id="1472038">)</span><span class="op" id="1472039">)</span>&nbsp;<span class="op" id="1472041">+</span>&nbsp;<span class="ident" id="1472043">dataOffset</span>&nbsp;<span class="op" id="1472054">+</span>&nbsp;<span class="ident" id="1472056">bucketCnt</span><span class="op" id="1472065">*</span><span class="builtintype" id="1472066">uintptr</span><span class="op" id="1472073">(</span><span class="ident" id="1472074">t</span><span class="op" id="1472075">.</span><span class="ident" id="1472076">keysize</span><span class="op" id="1472083">)</span>&nbsp;<span class="op" id="1472085">+</span>&nbsp;<span class="ident" id="1472087">i</span><span class="op" id="1472088">*</span><span class="builtintype" id="1472089">uintptr</span><span class="op" id="1472096">(</span><span class="ident" id="1472097">t</span><span class="op" id="1472098">.</span><span class="ident" id="1472099">valuesize</span><span class="op" id="1472108">)</span><span class="op" id="1472109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472114">memclr</span><span class="op" id="1472120">(</span><span class="ident" id="1472121">v</span><span class="op" id="1472122">,</span>&nbsp;<span class="builtintype" id="1472124">uintptr</span><span class="op" id="1472131">(</span><span class="ident" id="1472132">t</span><span class="op" id="1472133">.</span><span class="ident" id="1472134">valuesize</span><span class="op" id="1472143">)</span><span class="op" id="1472144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472149">b</span><span class="op" id="1472150">.</span><span class="ident" id="1472151">tophash</span><span class="op" id="1472158">[</span><span class="ident" id="1472159">i</span><span class="op" id="1472160">]</span>&nbsp;<span class="op" id="1472162">=</span>&nbsp;<span class="ident" id="1472164">empty</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472173">h</span><span class="op" id="1472174">.</span><span class="ident" id="1472175">count</span><span class="op" id="1472180">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472186">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1472195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472199">b</span>&nbsp;<span class="op" id="1472201">=</span>&nbsp;<span class="ident" id="1472203">b</span><span class="op" id="1472204">.</span><span class="ident" id="1472205">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472216">if</span>&nbsp;<span class="ident" id="1472219">b</span>&nbsp;<span class="op" id="1472221">==</span>&nbsp;<span class="ident" id="1472224">nil</span>&nbsp;<span class="op" id="1472228">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472233">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1472242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1472245">}</span><br>
<span class="lineno"></span><span class="op" id="1472247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="1472250">func</span>&nbsp;<span class="ident" id="1472255">mapiterinit</span><span class="op" id="1472266">(</span><span class="ident" id="1472267">t</span>&nbsp;<span class="op" id="1472269">*</span><span class="ident" id="1472270">maptype</span><span class="op" id="1472277">,</span>&nbsp;<span class="ident" id="1472279">h</span>&nbsp;<span class="op" id="1472281">*</span><span class="ident" id="1472282">hmap</span><span class="op" id="1472286">,</span>&nbsp;<span class="ident" id="1472288">it</span>&nbsp;<span class="op" id="1472291">*</span><span class="ident" id="1472292">hiter</span><span class="op" id="1472297">)</span>&nbsp;<span class="op" id="1472299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1472302">//&nbsp;Clear&nbsp;pointer&nbsp;fields&nbsp;so&nbsp;garbage&nbsp;collector&nbsp;does&nbsp;not&nbsp;complain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472367">it</span><span class="op" id="1472369">.</span><span class="ident" id="1472370">key</span>&nbsp;<span class="op" id="1472374">=</span>&nbsp;<span class="ident" id="1472376">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472381">it</span><span class="op" id="1472383">.</span><span class="ident" id="1472384">value</span>&nbsp;<span class="op" id="1472390">=</span>&nbsp;<span class="ident" id="1472392">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472397">it</span><span class="op" id="1472399">.</span><span class="ident" id="1472400">t</span>&nbsp;<span class="op" id="1472402">=</span>&nbsp;<span class="ident" id="1472404">nil</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472409">it</span><span class="op" id="1472411">.</span><span class="ident" id="1472412">h</span>&nbsp;<span class="op" id="1472414">=</span>&nbsp;<span class="ident" id="1472416">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472421">it</span><span class="op" id="1472423">.</span><span class="ident" id="1472424">buckets</span>&nbsp;<span class="op" id="1472432">=</span>&nbsp;<span class="ident" id="1472434">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472439">it</span><span class="op" id="1472441">.</span><span class="ident" id="1472442">bptr</span>&nbsp;<span class="op" id="1472447">=</span>&nbsp;<span class="ident" id="1472449">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472455">if</span>&nbsp;<span class="ident" id="1472458">raceenabled</span>&nbsp;<span class="op" id="1472470">&amp;&amp;</span>&nbsp;<span class="ident" id="1472473">h</span>&nbsp;<span class="op" id="1472475">!=</span>&nbsp;<span class="ident" id="1472478">nil</span>&nbsp;<span class="op" id="1472482">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472486">callerpc</span>&nbsp;<span class="op" id="1472495">:=</span>&nbsp;<span class="ident" id="1472498">getcallerpc</span><span class="op" id="1472509">(</span><span class="ident" id="1472510">unsafe</span><span class="op" id="1472516">.</span><span class="ident" id="1472517">Pointer</span><span class="op" id="1472524">(</span><span class="op" id="1472525">&amp;</span><span class="ident" id="1472526">t</span><span class="op" id="1472527">)</span><span class="op" id="1472528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472532">racereadpc</span><span class="op" id="1472542">(</span><span class="ident" id="1472543">unsafe</span><span class="op" id="1472549">.</span><span class="ident" id="1472550">Pointer</span><span class="op" id="1472557">(</span><span class="ident" id="1472558">h</span><span class="op" id="1472559">)</span><span class="op" id="1472560">,</span>&nbsp;<span class="ident" id="1472562">callerpc</span><span class="op" id="1472570">,</span>&nbsp;<span class="ident" id="1472572">funcPC</span><span class="op" id="1472578">(</span><span class="ident" id="1472579">mapiterinit</span><span class="op" id="1472590">)</span><span class="op" id="1472591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1472594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472598">if</span>&nbsp;<span class="ident" id="1472601">h</span>&nbsp;<span class="op" id="1472603">==</span>&nbsp;<span class="ident" id="1472606">nil</span>&nbsp;<span class="op" id="1472610">||</span>&nbsp;<span class="ident" id="1472613">h</span><span class="op" id="1472614">.</span><span class="ident" id="1472615">count</span>&nbsp;<span class="op" id="1472621">==</span>&nbsp;<span class="num" id="1472624">0</span>&nbsp;<span class="op" id="1472626">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472630">it</span><span class="op" id="1472632">.</span><span class="ident" id="1472633">key</span>&nbsp;<span class="op" id="1472637">=</span>&nbsp;<span class="ident" id="1472639">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472645">it</span><span class="op" id="1472647">.</span><span class="ident" id="1472648">value</span>&nbsp;<span class="op" id="1472654">=</span>&nbsp;<span class="ident" id="1472656">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472662">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1472670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472674">if</span>&nbsp;<span class="ident" id="1472677">unsafe</span><span class="op" id="1472683">.</span><span class="ident" id="1472684">Sizeof</span><span class="op" id="1472690">(</span><span class="ident" id="1472691">hiter</span><span class="op" id="1472696">{</span><span class="op" id="1472697">}</span><span class="op" id="1472698">)</span><span class="op" id="1472699">/</span><span class="ident" id="1472700">ptrSize</span>&nbsp;<span class="op" id="1472708">!=</span>&nbsp;<span class="num" id="1472711">10</span>&nbsp;<span class="op" id="1472714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472718">gothrow</span><span class="op" id="1472725">(</span><span class="string" id="1472726">&#34;hash_iter&nbsp;size&nbsp;incorrect&#34;</span><span class="op" id="1472752">)</span>&nbsp;<span class="comment" id="1472754">//&nbsp;see&nbsp;../../cmd/gc/reflect.c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1472785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472788">it</span><span class="op" id="1472790">.</span><span class="ident" id="1472791">t</span>&nbsp;<span class="op" id="1472793">=</span>&nbsp;<span class="ident" id="1472795">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472798">it</span><span class="op" id="1472800">.</span><span class="ident" id="1472801">h</span>&nbsp;<span class="op" id="1472803">=</span>&nbsp;<span class="ident" id="1472805">h</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1472809">//&nbsp;grab&nbsp;snapshot&nbsp;of&nbsp;bucket&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472843">it</span><span class="op" id="1472845">.</span><span class="ident" id="1472846">B</span>&nbsp;<span class="op" id="1472848">=</span>&nbsp;<span class="ident" id="1472850">h</span><span class="op" id="1472851">.</span><span class="ident" id="1472852">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472855">it</span><span class="op" id="1472857">.</span><span class="ident" id="1472858">buckets</span>&nbsp;<span class="op" id="1472866">=</span>&nbsp;<span class="ident" id="1472868">h</span><span class="op" id="1472869">.</span><span class="ident" id="1472870">buckets</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1472880">//&nbsp;decide&nbsp;where&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472906">r</span>&nbsp;<span class="op" id="1472908">:=</span>&nbsp;<span class="builtintype" id="1472911">uintptr</span><span class="op" id="1472918">(</span><span class="ident" id="1472919">fastrand1</span><span class="op" id="1472928">(</span><span class="op" id="1472929">)</span><span class="op" id="1472930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1472933">if</span>&nbsp;<span class="ident" id="1472936">h</span><span class="op" id="1472937">.</span><span class="ident" id="1472938">B</span>&nbsp;<span class="op" id="1472940">&gt;</span>&nbsp;<span class="num" id="1472942">31</span><span class="op" id="1472944">-</span><span class="ident" id="1472945">bucketCntBits</span>&nbsp;<span class="op" id="1472959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472963">r</span>&nbsp;<span class="op" id="1472965">+=</span>&nbsp;<span class="builtintype" id="1472968">uintptr</span><span class="op" id="1472975">(</span><span class="ident" id="1472976">fastrand1</span><span class="op" id="1472985">(</span><span class="op" id="1472986">)</span><span class="op" id="1472987">)</span>&nbsp;<span class="op" id="1472989">&lt;&lt;</span>&nbsp;<span class="num" id="1472992">31</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1472996">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1472999">it</span><span class="op" id="1473001">.</span><span class="ident" id="1473002">startBucket</span>&nbsp;<span class="op" id="1473014">=</span>&nbsp;<span class="ident" id="1473016">r</span>&nbsp;<span class="op" id="1473018">&amp;</span>&nbsp;<span class="op" id="1473020">(</span><span class="builtintype" id="1473021">uintptr</span><span class="op" id="1473028">(</span><span class="num" id="1473029">1</span><span class="op" id="1473030">)</span><span class="op" id="1473031">&lt;&lt;</span><span class="ident" id="1473033">h</span><span class="op" id="1473034">.</span><span class="ident" id="1473035">B</span>&nbsp;<span class="op" id="1473037">-</span>&nbsp;<span class="num" id="1473039">1</span><span class="op" id="1473040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473043">it</span><span class="op" id="1473045">.</span><span class="ident" id="1473046">offset</span>&nbsp;<span class="op" id="1473053">=</span>&nbsp;<span class="builtintype" id="1473055">uint8</span><span class="op" id="1473060">(</span><span class="ident" id="1473061">r</span>&nbsp;<span class="op" id="1473063">&gt;&gt;</span>&nbsp;<span class="ident" id="1473066">h</span><span class="op" id="1473067">.</span><span class="ident" id="1473068">B</span>&nbsp;<span class="op" id="1473070">&amp;</span>&nbsp;<span class="op" id="1473072">(</span><span class="ident" id="1473073">bucketCnt</span>&nbsp;<span class="op" id="1473083">-</span>&nbsp;<span class="num" id="1473085">1</span><span class="op" id="1473086">)</span><span class="op" id="1473087">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1473091">//&nbsp;iterator&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473110">it</span><span class="op" id="1473112">.</span><span class="ident" id="1473113">bucket</span>&nbsp;<span class="op" id="1473120">=</span>&nbsp;<span class="ident" id="1473122">it</span><span class="op" id="1473124">.</span><span class="ident" id="1473125">startBucket</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473138">it</span><span class="op" id="1473140">.</span><span class="ident" id="1473141">wrapped</span>&nbsp;<span class="op" id="1473149">=</span>&nbsp;<span class="builtintype" id="1473151">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473158">it</span><span class="op" id="1473160">.</span><span class="ident" id="1473161">bptr</span>&nbsp;<span class="op" id="1473166">=</span>&nbsp;<span class="ident" id="1473168">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1473174">//&nbsp;Remember&nbsp;we&nbsp;have&nbsp;an&nbsp;iterator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1473208">//&nbsp;Can&nbsp;run&nbsp;concurrently&nbsp;with&nbsp;another&nbsp;hash_iter_init().</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473264">for</span>&nbsp;<span class="op" id="1473268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473272">old</span>&nbsp;<span class="op" id="1473276">:=</span>&nbsp;<span class="ident" id="1473279">h</span><span class="op" id="1473280">.</span><span class="ident" id="1473281">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473289">if</span>&nbsp;<span class="ident" id="1473292">old</span>&nbsp;<span class="op" id="1473296">==</span>&nbsp;<span class="ident" id="1473299">old</span><span class="op" id="1473302">|</span><span class="ident" id="1473303">iterator</span><span class="op" id="1473311">|</span><span class="ident" id="1473312">oldIterator</span>&nbsp;<span class="op" id="1473324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473329">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1473337">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473341">if</span>&nbsp;<span class="ident" id="1473344">cas</span><span class="op" id="1473347">(</span><span class="op" id="1473348">&amp;</span><span class="ident" id="1473349">h</span><span class="op" id="1473350">.</span><span class="ident" id="1473351">flags</span><span class="op" id="1473356">,</span>&nbsp;<span class="ident" id="1473358">old</span><span class="op" id="1473361">,</span>&nbsp;<span class="ident" id="1473363">old</span><span class="op" id="1473366">|</span><span class="ident" id="1473367">iterator</span><span class="op" id="1473375">|</span><span class="ident" id="1473376">oldIterator</span><span class="op" id="1473387">)</span>&nbsp;<span class="op" id="1473389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473394">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1473402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1473405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473409">mapiternext</span><span class="op" id="1473420">(</span><span class="ident" id="1473421">it</span><span class="op" id="1473423">)</span><br>
<span class="lineno"></span><span class="op" id="1473425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1473428">func</span>&nbsp;<span class="ident" id="1473433">mapiternext</span><span class="op" id="1473444">(</span><span class="ident" id="1473445">it</span>&nbsp;<span class="op" id="1473448">*</span><span class="ident" id="1473449">hiter</span><span class="op" id="1473454">)</span>&nbsp;<span class="op" id="1473456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473459">h</span>&nbsp;<span class="op" id="1473461">:=</span>&nbsp;<span class="ident" id="1473464">it</span><span class="op" id="1473466">.</span><span class="ident" id="1473467">h</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473470">if</span>&nbsp;<span class="ident" id="1473473">raceenabled</span>&nbsp;<span class="op" id="1473485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473489">callerpc</span>&nbsp;<span class="op" id="1473498">:=</span>&nbsp;<span class="ident" id="1473501">getcallerpc</span><span class="op" id="1473512">(</span><span class="ident" id="1473513">unsafe</span><span class="op" id="1473519">.</span><span class="ident" id="1473520">Pointer</span><span class="op" id="1473527">(</span><span class="op" id="1473528">&amp;</span><span class="ident" id="1473529">it</span><span class="op" id="1473531">)</span><span class="op" id="1473532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473536">racereadpc</span><span class="op" id="1473546">(</span><span class="ident" id="1473547">unsafe</span><span class="op" id="1473553">.</span><span class="ident" id="1473554">Pointer</span><span class="op" id="1473561">(</span><span class="ident" id="1473562">h</span><span class="op" id="1473563">)</span><span class="op" id="1473564">,</span>&nbsp;<span class="ident" id="1473566">callerpc</span><span class="op" id="1473574">,</span>&nbsp;<span class="ident" id="1473576">funcPC</span><span class="op" id="1473582">(</span><span class="ident" id="1473583">mapiternext</span><span class="op" id="1473594">)</span><span class="op" id="1473595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1473598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473601">t</span>&nbsp;<span class="op" id="1473603">:=</span>&nbsp;<span class="ident" id="1473606">it</span><span class="op" id="1473608">.</span><span class="ident" id="1473609">t</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473612">bucket</span>&nbsp;<span class="op" id="1473619">:=</span>&nbsp;<span class="ident" id="1473622">it</span><span class="op" id="1473624">.</span><span class="ident" id="1473625">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473633">b</span>&nbsp;<span class="op" id="1473635">:=</span>&nbsp;<span class="ident" id="1473638">it</span><span class="op" id="1473640">.</span><span class="ident" id="1473641">bptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473647">i</span>&nbsp;<span class="op" id="1473649">:=</span>&nbsp;<span class="ident" id="1473652">it</span><span class="op" id="1473654">.</span><span class="ident" id="1473655">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473658">checkBucket</span>&nbsp;<span class="op" id="1473670">:=</span>&nbsp;<span class="ident" id="1473673">it</span><span class="op" id="1473675">.</span><span class="ident" id="1473676">checkBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473689">alg</span>&nbsp;<span class="op" id="1473693">:=</span>&nbsp;<span class="ident" id="1473696">goalg</span><span class="op" id="1473701">(</span><span class="ident" id="1473702">t</span><span class="op" id="1473703">.</span><span class="ident" id="1473704">key</span><span class="op" id="1473707">.</span><span class="ident" id="1473708">alg</span><span class="op" id="1473711">)</span><br>
<span class="lineno">605</span><br>
<span class="lineno"></span><span class="ident" id="1473714">next</span><span class="op" id="1473718">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473721">if</span>&nbsp;<span class="ident" id="1473724">b</span>&nbsp;<span class="op" id="1473726">==</span>&nbsp;<span class="ident" id="1473729">nil</span>&nbsp;<span class="op" id="1473733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473737">if</span>&nbsp;<span class="ident" id="1473740">bucket</span>&nbsp;<span class="op" id="1473747">==</span>&nbsp;<span class="ident" id="1473750">it</span><span class="op" id="1473752">.</span><span class="ident" id="1473753">startBucket</span>&nbsp;<span class="op" id="1473765">&amp;&amp;</span>&nbsp;<span class="ident" id="1473768">it</span><span class="op" id="1473770">.</span><span class="ident" id="1473771">wrapped</span>&nbsp;<span class="op" id="1473779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1473784">//&nbsp;end&nbsp;of&nbsp;iteration</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473807">it</span><span class="op" id="1473809">.</span><span class="ident" id="1473810">key</span>&nbsp;<span class="op" id="1473814">=</span>&nbsp;<span class="ident" id="1473816">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1473823">it</span><span class="op" id="1473825">.</span><span class="ident" id="1473826">value</span>&nbsp;<span class="op" id="1473832">=</span>&nbsp;<span class="ident" id="1473834">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473841">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1473850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1473854">if</span>&nbsp;<span class="ident" id="1473857">h</span><span class="op" id="1473858">.</span><span class="ident" id="1473859">oldbuckets</span>&nbsp;<span class="op" id="1473870">!=</span>&nbsp;<span class="ident" id="1473873">nil</span>&nbsp;<span class="op" id="1473877">&amp;&amp;</span>&nbsp;<span class="ident" id="1473880">it</span><span class="op" id="1473882">.</span><span class="ident" id="1473883">B</span>&nbsp;<span class="op" id="1473885">==</span>&nbsp;<span class="ident" id="1473888">h</span><span class="op" id="1473889">.</span><span class="ident" id="1473890">B</span>&nbsp;<span class="op" id="1473892">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1473897">//&nbsp;Iterator&nbsp;was&nbsp;started&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;a&nbsp;grow,&nbsp;and&nbsp;the&nbsp;grow&nbsp;isn&#39;t&nbsp;done&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1473978">//&nbsp;If&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;looking&nbsp;at&nbsp;hasn&#39;t&nbsp;been&nbsp;filled&nbsp;in&nbsp;yet&nbsp;(i.e.&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1474055">//&nbsp;bucket&nbsp;hasn&#39;t&nbsp;been&nbsp;evacuated)&nbsp;then&nbsp;we&nbsp;need&nbsp;to&nbsp;iterate&nbsp;through&nbsp;the&nbsp;old</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1474131">//&nbsp;bucket&nbsp;and&nbsp;only&nbsp;return&nbsp;the&nbsp;ones&nbsp;that&nbsp;will&nbsp;be&nbsp;migrated&nbsp;to&nbsp;this&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474207">oldbucket</span>&nbsp;<span class="op" id="1474217">:=</span>&nbsp;<span class="ident" id="1474220">bucket</span>&nbsp;<span class="op" id="1474227">&amp;</span>&nbsp;<span class="op" id="1474229">(</span><span class="builtintype" id="1474230">uintptr</span><span class="op" id="1474237">(</span><span class="num" id="1474238">1</span><span class="op" id="1474239">)</span><span class="op" id="1474240">&lt;&lt;</span><span class="op" id="1474242">(</span><span class="ident" id="1474243">it</span><span class="op" id="1474245">.</span><span class="ident" id="1474246">B</span><span class="op" id="1474247">-</span><span class="num" id="1474248">1</span><span class="op" id="1474249">)</span>&nbsp;<span class="op" id="1474251">-</span>&nbsp;<span class="num" id="1474253">1</span><span class="op" id="1474254">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474259">b</span>&nbsp;<span class="op" id="1474261">=</span>&nbsp;<span class="op" id="1474263">(</span><span class="op" id="1474264">*</span><span class="ident" id="1474265">bmap</span><span class="op" id="1474269">)</span><span class="op" id="1474270">(</span><span class="ident" id="1474271">add</span><span class="op" id="1474274">(</span><span class="ident" id="1474275">h</span><span class="op" id="1474276">.</span><span class="ident" id="1474277">oldbuckets</span><span class="op" id="1474287">,</span>&nbsp;<span class="ident" id="1474289">oldbucket</span><span class="op" id="1474298">*</span><span class="builtintype" id="1474299">uintptr</span><span class="op" id="1474306">(</span><span class="ident" id="1474307">t</span><span class="op" id="1474308">.</span><span class="ident" id="1474309">bucketsize</span><span class="op" id="1474319">)</span><span class="op" id="1474320">)</span><span class="op" id="1474321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474326">if</span>&nbsp;<span class="op" id="1474329">!</span><span class="ident" id="1474330">evacuated</span><span class="op" id="1474339">(</span><span class="ident" id="1474340">b</span><span class="op" id="1474341">)</span>&nbsp;<span class="op" id="1474343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474349">checkBucket</span>&nbsp;<span class="op" id="1474361">=</span>&nbsp;<span class="ident" id="1474363">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474373">}</span>&nbsp;<span class="keyword" id="1474375">else</span>&nbsp;<span class="op" id="1474380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474386">b</span>&nbsp;<span class="op" id="1474388">=</span>&nbsp;<span class="op" id="1474390">(</span><span class="op" id="1474391">*</span><span class="ident" id="1474392">bmap</span><span class="op" id="1474396">)</span><span class="op" id="1474397">(</span><span class="ident" id="1474398">add</span><span class="op" id="1474401">(</span><span class="ident" id="1474402">it</span><span class="op" id="1474404">.</span><span class="ident" id="1474405">buckets</span><span class="op" id="1474412">,</span>&nbsp;<span class="ident" id="1474414">bucket</span><span class="op" id="1474420">*</span><span class="builtintype" id="1474421">uintptr</span><span class="op" id="1474428">(</span><span class="ident" id="1474429">t</span><span class="op" id="1474430">.</span><span class="ident" id="1474431">bucketsize</span><span class="op" id="1474441">)</span><span class="op" id="1474442">)</span><span class="op" id="1474443">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474449">checkBucket</span>&nbsp;<span class="op" id="1474461">=</span>&nbsp;<span class="ident" id="1474463">noCheck</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474478">}</span>&nbsp;<span class="keyword" id="1474480">else</span>&nbsp;<span class="op" id="1474485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474490">b</span>&nbsp;<span class="op" id="1474492">=</span>&nbsp;<span class="op" id="1474494">(</span><span class="op" id="1474495">*</span><span class="ident" id="1474496">bmap</span><span class="op" id="1474500">)</span><span class="op" id="1474501">(</span><span class="ident" id="1474502">add</span><span class="op" id="1474505">(</span><span class="ident" id="1474506">it</span><span class="op" id="1474508">.</span><span class="ident" id="1474509">buckets</span><span class="op" id="1474516">,</span>&nbsp;<span class="ident" id="1474518">bucket</span><span class="op" id="1474524">*</span><span class="builtintype" id="1474525">uintptr</span><span class="op" id="1474532">(</span><span class="ident" id="1474533">t</span><span class="op" id="1474534">.</span><span class="ident" id="1474535">bucketsize</span><span class="op" id="1474545">)</span><span class="op" id="1474546">)</span><span class="op" id="1474547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474552">checkBucket</span>&nbsp;<span class="op" id="1474564">=</span>&nbsp;<span class="ident" id="1474566">noCheck</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474580">bucket</span><span class="op" id="1474586">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474591">if</span>&nbsp;<span class="ident" id="1474594">bucket</span>&nbsp;<span class="op" id="1474601">==</span>&nbsp;<span class="builtintype" id="1474604">uintptr</span><span class="op" id="1474611">(</span><span class="num" id="1474612">1</span><span class="op" id="1474613">)</span><span class="op" id="1474614">&lt;&lt;</span><span class="ident" id="1474616">it</span><span class="op" id="1474618">.</span><span class="ident" id="1474619">B</span>&nbsp;<span class="op" id="1474621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474626">bucket</span>&nbsp;<span class="op" id="1474633">=</span>&nbsp;<span class="num" id="1474635">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474640">it</span><span class="op" id="1474642">.</span><span class="ident" id="1474643">wrapped</span>&nbsp;<span class="op" id="1474651">=</span>&nbsp;<span class="builtintype" id="1474653">true</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474664">i</span>&nbsp;<span class="op" id="1474666">=</span>&nbsp;<span class="num" id="1474668">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1474671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474674">for</span>&nbsp;<span class="op" id="1474678">;</span>&nbsp;<span class="ident" id="1474680">i</span>&nbsp;<span class="op" id="1474682">&lt;</span>&nbsp;<span class="ident" id="1474684">bucketCnt</span><span class="op" id="1474693">;</span>&nbsp;<span class="ident" id="1474695">i</span><span class="op" id="1474696">++</span>&nbsp;<span class="op" id="1474699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474703">offi</span>&nbsp;<span class="op" id="1474708">:=</span>&nbsp;<span class="op" id="1474711">(</span><span class="ident" id="1474712">i</span>&nbsp;<span class="op" id="1474714">+</span>&nbsp;<span class="ident" id="1474716">it</span><span class="op" id="1474718">.</span><span class="ident" id="1474719">offset</span><span class="op" id="1474725">)</span>&nbsp;<span class="op" id="1474727">&amp;</span>&nbsp;<span class="op" id="1474729">(</span><span class="ident" id="1474730">bucketCnt</span>&nbsp;<span class="op" id="1474740">-</span>&nbsp;<span class="num" id="1474742">1</span><span class="op" id="1474743">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474747">k</span>&nbsp;<span class="op" id="1474749">:=</span>&nbsp;<span class="ident" id="1474752">add</span><span class="op" id="1474755">(</span><span class="ident" id="1474756">unsafe</span><span class="op" id="1474762">.</span><span class="ident" id="1474763">Pointer</span><span class="op" id="1474770">(</span><span class="ident" id="1474771">b</span><span class="op" id="1474772">)</span><span class="op" id="1474773">,</span>&nbsp;<span class="ident" id="1474775">dataOffset</span><span class="op" id="1474785">+</span><span class="builtintype" id="1474786">uintptr</span><span class="op" id="1474793">(</span><span class="ident" id="1474794">offi</span><span class="op" id="1474798">)</span><span class="op" id="1474799">*</span><span class="builtintype" id="1474800">uintptr</span><span class="op" id="1474807">(</span><span class="ident" id="1474808">t</span><span class="op" id="1474809">.</span><span class="ident" id="1474810">keysize</span><span class="op" id="1474817">)</span><span class="op" id="1474818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1474822">v</span>&nbsp;<span class="op" id="1474824">:=</span>&nbsp;<span class="ident" id="1474827">add</span><span class="op" id="1474830">(</span><span class="ident" id="1474831">unsafe</span><span class="op" id="1474837">.</span><span class="ident" id="1474838">Pointer</span><span class="op" id="1474845">(</span><span class="ident" id="1474846">b</span><span class="op" id="1474847">)</span><span class="op" id="1474848">,</span>&nbsp;<span class="ident" id="1474850">dataOffset</span><span class="op" id="1474860">+</span><span class="ident" id="1474861">bucketCnt</span><span class="op" id="1474870">*</span><span class="builtintype" id="1474871">uintptr</span><span class="op" id="1474878">(</span><span class="ident" id="1474879">t</span><span class="op" id="1474880">.</span><span class="ident" id="1474881">keysize</span><span class="op" id="1474888">)</span><span class="op" id="1474889">+</span><span class="builtintype" id="1474890">uintptr</span><span class="op" id="1474897">(</span><span class="ident" id="1474898">offi</span><span class="op" id="1474902">)</span><span class="op" id="1474903">*</span><span class="builtintype" id="1474904">uintptr</span><span class="op" id="1474911">(</span><span class="ident" id="1474912">t</span><span class="op" id="1474913">.</span><span class="ident" id="1474914">valuesize</span><span class="op" id="1474923">)</span><span class="op" id="1474924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474928">if</span>&nbsp;<span class="ident" id="1474931">b</span><span class="op" id="1474932">.</span><span class="ident" id="1474933">tophash</span><span class="op" id="1474940">[</span><span class="ident" id="1474941">offi</span><span class="op" id="1474945">]</span>&nbsp;<span class="op" id="1474947">!=</span>&nbsp;<span class="ident" id="1474950">empty</span>&nbsp;<span class="op" id="1474956">&amp;&amp;</span>&nbsp;<span class="ident" id="1474959">b</span><span class="op" id="1474960">.</span><span class="ident" id="1474961">tophash</span><span class="op" id="1474968">[</span><span class="ident" id="1474969">offi</span><span class="op" id="1474973">]</span>&nbsp;<span class="op" id="1474975">!=</span>&nbsp;<span class="ident" id="1474978">evacuatedEmpty</span>&nbsp;<span class="op" id="1474993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1474998">if</span>&nbsp;<span class="ident" id="1475001">checkBucket</span>&nbsp;<span class="op" id="1475013">!=</span>&nbsp;<span class="ident" id="1475016">noCheck</span>&nbsp;<span class="op" id="1475024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475030">//&nbsp;Special&nbsp;case:&nbsp;iterator&nbsp;was&nbsp;started&nbsp;during&nbsp;a&nbsp;grow&nbsp;and&nbsp;the</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475094">//&nbsp;grow&nbsp;is&nbsp;not&nbsp;done&nbsp;yet.&nbsp;&nbsp;We&#39;re&nbsp;working&nbsp;on&nbsp;a&nbsp;bucket&nbsp;whose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475156">//&nbsp;oldbucket&nbsp;has&nbsp;not&nbsp;been&nbsp;evacuated&nbsp;yet.&nbsp;&nbsp;Or&nbsp;at&nbsp;least,&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475225">//&nbsp;evacuated&nbsp;when&nbsp;we&nbsp;started&nbsp;the&nbsp;bucket.&nbsp;&nbsp;So&nbsp;we&#39;re&nbsp;iterating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475290">//&nbsp;through&nbsp;the&nbsp;oldbucket,&nbsp;skipping&nbsp;any&nbsp;keys&nbsp;that&nbsp;will&nbsp;go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475351">//&nbsp;to&nbsp;the&nbsp;other&nbsp;new&nbsp;bucket&nbsp;(each&nbsp;oldbucket&nbsp;expands&nbsp;to&nbsp;two</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475413">//&nbsp;buckets&nbsp;during&nbsp;a&nbsp;grow).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475444">k2</span>&nbsp;<span class="op" id="1475447">:=</span>&nbsp;<span class="ident" id="1475450">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475456">if</span>&nbsp;<span class="ident" id="1475459">t</span><span class="op" id="1475460">.</span><span class="ident" id="1475461">indirectkey</span>&nbsp;<span class="op" id="1475473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475480">k2</span>&nbsp;<span class="op" id="1475483">=</span>&nbsp;<span class="op" id="1475485">*</span><span class="op" id="1475486">(</span><span class="op" id="1475487">(</span><span class="op" id="1475488">*</span><span class="ident" id="1475489">unsafe</span><span class="op" id="1475495">.</span><span class="ident" id="1475496">Pointer</span><span class="op" id="1475503">)</span><span class="op" id="1475504">(</span><span class="ident" id="1475505">k2</span><span class="op" id="1475507">)</span><span class="op" id="1475508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1475514">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475520">if</span>&nbsp;<span class="ident" id="1475523">alg</span><span class="op" id="1475526">.</span><span class="ident" id="1475527">equal</span><span class="op" id="1475532">(</span><span class="ident" id="1475533">k2</span><span class="op" id="1475535">,</span>&nbsp;<span class="ident" id="1475537">k2</span><span class="op" id="1475539">,</span>&nbsp;<span class="builtintype" id="1475541">uintptr</span><span class="op" id="1475548">(</span><span class="ident" id="1475549">t</span><span class="op" id="1475550">.</span><span class="ident" id="1475551">key</span><span class="op" id="1475554">.</span><span class="ident" id="1475555">size</span><span class="op" id="1475559">)</span><span class="op" id="1475560">)</span>&nbsp;<span class="op" id="1475562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475569">//&nbsp;If&nbsp;the&nbsp;item&nbsp;in&nbsp;the&nbsp;oldbucket&nbsp;is&nbsp;not&nbsp;destined&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475626">//&nbsp;the&nbsp;current&nbsp;new&nbsp;bucket&nbsp;in&nbsp;the&nbsp;iteration,&nbsp;skip&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1475684">hash</span>&nbsp;<span class="op" id="1475689">:=</span>&nbsp;<span class="ident" id="1475692">alg</span><span class="op" id="1475695">.</span><span class="ident" id="1475696">hash</span><span class="op" id="1475700">(</span><span class="ident" id="1475701">k2</span><span class="op" id="1475703">,</span>&nbsp;<span class="builtintype" id="1475705">uintptr</span><span class="op" id="1475712">(</span><span class="ident" id="1475713">t</span><span class="op" id="1475714">.</span><span class="ident" id="1475715">key</span><span class="op" id="1475718">.</span><span class="ident" id="1475719">size</span><span class="op" id="1475723">)</span><span class="op" id="1475724">,</span>&nbsp;<span class="builtintype" id="1475726">uintptr</span><span class="op" id="1475733">(</span><span class="ident" id="1475734">h</span><span class="op" id="1475735">.</span><span class="ident" id="1475736">hash0</span><span class="op" id="1475741">)</span><span class="op" id="1475742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475749">if</span>&nbsp;<span class="ident" id="1475752">hash</span><span class="op" id="1475756">&amp;</span><span class="op" id="1475757">(</span><span class="builtintype" id="1475758">uintptr</span><span class="op" id="1475765">(</span><span class="num" id="1475766">1</span><span class="op" id="1475767">)</span><span class="op" id="1475768">&lt;&lt;</span><span class="ident" id="1475770">it</span><span class="op" id="1475772">.</span><span class="ident" id="1475773">B</span><span class="op" id="1475774">-</span><span class="num" id="1475775">1</span><span class="op" id="1475776">)</span>&nbsp;<span class="op" id="1475778">!=</span>&nbsp;<span class="ident" id="1475781">checkBucket</span>&nbsp;<span class="op" id="1475793">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1475801">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1475815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1475821">}</span>&nbsp;<span class="keyword" id="1475823">else</span>&nbsp;<span class="op" id="1475828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475835">//&nbsp;Hash&nbsp;isn&#39;t&nbsp;repeatable&nbsp;if&nbsp;k&nbsp;!=&nbsp;k&nbsp;(NaNs).&nbsp;&nbsp;We&nbsp;need&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475894">//&nbsp;repeatable&nbsp;and&nbsp;randomish&nbsp;choice&nbsp;of&nbsp;which&nbsp;direction</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1475953">//&nbsp;to&nbsp;send&nbsp;NaNs&nbsp;during&nbsp;evacuation.&nbsp;&nbsp;We&#39;ll&nbsp;use&nbsp;the&nbsp;low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1476012">//&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;to&nbsp;decide&nbsp;which&nbsp;way&nbsp;NaNs&nbsp;go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1476064">//&nbsp;NOTE:&nbsp;this&nbsp;case&nbsp;is&nbsp;why&nbsp;we&nbsp;need&nbsp;two&nbsp;evacuate&nbsp;tophash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1476124">//&nbsp;values,&nbsp;evacuatedX&nbsp;and&nbsp;evacuatedY,&nbsp;that&nbsp;differ&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1476182">//&nbsp;their&nbsp;low&nbsp;bit.</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476205">if</span>&nbsp;<span class="ident" id="1476208">checkBucket</span><span class="op" id="1476219">&gt;&gt;</span><span class="op" id="1476221">(</span><span class="ident" id="1476222">it</span><span class="op" id="1476224">.</span><span class="ident" id="1476225">B</span><span class="op" id="1476226">-</span><span class="num" id="1476227">1</span><span class="op" id="1476228">)</span>&nbsp;<span class="op" id="1476230">!=</span>&nbsp;<span class="builtintype" id="1476233">uintptr</span><span class="op" id="1476240">(</span><span class="ident" id="1476241">b</span><span class="op" id="1476242">.</span><span class="ident" id="1476243">tophash</span><span class="op" id="1476250">[</span><span class="ident" id="1476251">offi</span><span class="op" id="1476255">]</span><span class="op" id="1476256">&amp;</span><span class="num" id="1476257">1</span><span class="op" id="1476258">)</span>&nbsp;<span class="op" id="1476260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476268">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476293">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476298">if</span>&nbsp;<span class="ident" id="1476301">b</span><span class="op" id="1476302">.</span><span class="ident" id="1476303">tophash</span><span class="op" id="1476310">[</span><span class="ident" id="1476311">offi</span><span class="op" id="1476315">]</span>&nbsp;<span class="op" id="1476317">!=</span>&nbsp;<span class="ident" id="1476320">evacuatedX</span>&nbsp;<span class="op" id="1476331">&amp;&amp;</span>&nbsp;<span class="ident" id="1476334">b</span><span class="op" id="1476335">.</span><span class="ident" id="1476336">tophash</span><span class="op" id="1476343">[</span><span class="ident" id="1476344">offi</span><span class="op" id="1476348">]</span>&nbsp;<span class="op" id="1476350">!=</span>&nbsp;<span class="ident" id="1476353">evacuatedY</span>&nbsp;<span class="op" id="1476364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1476370">//&nbsp;this&nbsp;is&nbsp;the&nbsp;golden&nbsp;data,&nbsp;we&nbsp;can&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476420">if</span>&nbsp;<span class="ident" id="1476423">t</span><span class="op" id="1476424">.</span><span class="ident" id="1476425">indirectkey</span>&nbsp;<span class="op" id="1476437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476444">k</span>&nbsp;<span class="op" id="1476446">=</span>&nbsp;<span class="op" id="1476448">*</span><span class="op" id="1476449">(</span><span class="op" id="1476450">(</span><span class="op" id="1476451">*</span><span class="ident" id="1476452">unsafe</span><span class="op" id="1476458">.</span><span class="ident" id="1476459">Pointer</span><span class="op" id="1476466">)</span><span class="op" id="1476467">(</span><span class="ident" id="1476468">k</span><span class="op" id="1476469">)</span><span class="op" id="1476470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476476">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476482">it</span><span class="op" id="1476484">.</span><span class="ident" id="1476485">key</span>&nbsp;<span class="op" id="1476489">=</span>&nbsp;<span class="ident" id="1476491">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476497">if</span>&nbsp;<span class="ident" id="1476500">t</span><span class="op" id="1476501">.</span><span class="ident" id="1476502">indirectvalue</span>&nbsp;<span class="op" id="1476516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476523">v</span>&nbsp;<span class="op" id="1476525">=</span>&nbsp;<span class="op" id="1476527">*</span><span class="op" id="1476528">(</span><span class="op" id="1476529">(</span><span class="op" id="1476530">*</span><span class="ident" id="1476531">unsafe</span><span class="op" id="1476537">.</span><span class="ident" id="1476538">Pointer</span><span class="op" id="1476545">)</span><span class="op" id="1476546">(</span><span class="ident" id="1476547">v</span><span class="op" id="1476548">)</span><span class="op" id="1476549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476561">it</span><span class="op" id="1476563">.</span><span class="ident" id="1476564">value</span>&nbsp;<span class="op" id="1476570">=</span>&nbsp;<span class="ident" id="1476572">v</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476577">}</span>&nbsp;<span class="keyword" id="1476579">else</span>&nbsp;<span class="op" id="1476584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1476590">//&nbsp;The&nbsp;hash&nbsp;table&nbsp;has&nbsp;grown&nbsp;since&nbsp;the&nbsp;iterator&nbsp;was&nbsp;started.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1476654">//&nbsp;The&nbsp;golden&nbsp;data&nbsp;for&nbsp;this&nbsp;key&nbsp;is&nbsp;now&nbsp;somewhere&nbsp;else.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476713">k2</span>&nbsp;<span class="op" id="1476716">:=</span>&nbsp;<span class="ident" id="1476719">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476725">if</span>&nbsp;<span class="ident" id="1476728">t</span><span class="op" id="1476729">.</span><span class="ident" id="1476730">indirectkey</span>&nbsp;<span class="op" id="1476742">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1476749">k2</span>&nbsp;<span class="op" id="1476752">=</span>&nbsp;<span class="op" id="1476754">*</span><span class="op" id="1476755">(</span><span class="op" id="1476756">(</span><span class="op" id="1476757">*</span><span class="ident" id="1476758">unsafe</span><span class="op" id="1476764">.</span><span class="ident" id="1476765">Pointer</span><span class="op" id="1476772">)</span><span class="op" id="1476773">(</span><span class="ident" id="1476774">k2</span><span class="op" id="1476776">)</span><span class="op" id="1476777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1476783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1476789">if</span>&nbsp;<span class="ident" id="1476792">alg</span><span class="op" id="1476795">.</span><span class="ident" id="1476796">equal</span><span class="op" id="1476801">(</span><span class="ident" id="1476802">k2</span><span class="op" id="1476804">,</span>&nbsp;<span class="ident" id="1476806">k2</span><span class="op" id="1476808">,</span>&nbsp;<span class="builtintype" id="1476810">uintptr</span><span class="op" id="1476817">(</span><span class="ident" id="1476818">t</span><span class="op" id="1476819">.</span><span class="ident" id="1476820">key</span><span class="op" id="1476823">.</span><span class="ident" id="1476824">size</span><span class="op" id="1476828">)</span><span class="op" id="1476829">)</span>&nbsp;<span class="op" id="1476831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1476838">//&nbsp;Check&nbsp;the&nbsp;current&nbsp;hash&nbsp;table&nbsp;for&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1476889">//&nbsp;This&nbsp;code&nbsp;handles&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;key</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1476938">//&nbsp;has&nbsp;been&nbsp;deleted,&nbsp;updated,&nbsp;or&nbsp;deleted&nbsp;and&nbsp;reinserted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1477000">//&nbsp;NOTE:&nbsp;we&nbsp;need&nbsp;to&nbsp;regrab&nbsp;the&nbsp;key&nbsp;as&nbsp;it&nbsp;has&nbsp;potentially&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1477067">//&nbsp;updated&nbsp;to&nbsp;an&nbsp;equal()&nbsp;but&nbsp;not&nbsp;identical&nbsp;key&nbsp;(e.g.&nbsp;+0.0&nbsp;vs&nbsp;-0.0).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477140">rk</span><span class="op" id="1477142">,</span>&nbsp;<span class="ident" id="1477144">rv</span>&nbsp;<span class="op" id="1477147">:=</span>&nbsp;<span class="ident" id="1477150">mapaccessK</span><span class="op" id="1477160">(</span><span class="ident" id="1477161">t</span><span class="op" id="1477162">,</span>&nbsp;<span class="ident" id="1477164">h</span><span class="op" id="1477165">,</span>&nbsp;<span class="ident" id="1477167">k2</span><span class="op" id="1477169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1477176">if</span>&nbsp;<span class="ident" id="1477179">rk</span>&nbsp;<span class="op" id="1477182">==</span>&nbsp;<span class="ident" id="1477185">nil</span>&nbsp;<span class="op" id="1477189">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1477197">continue</span>&nbsp;<span class="comment" id="1477206">//&nbsp;key&nbsp;has&nbsp;been&nbsp;deleted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1477235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477242">it</span><span class="op" id="1477244">.</span><span class="ident" id="1477245">key</span>&nbsp;<span class="op" id="1477249">=</span>&nbsp;<span class="ident" id="1477251">rk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477259">it</span><span class="op" id="1477261">.</span><span class="ident" id="1477262">value</span>&nbsp;<span class="op" id="1477268">=</span>&nbsp;<span class="ident" id="1477270">rv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1477277">}</span>&nbsp;<span class="keyword" id="1477279">else</span>&nbsp;<span class="op" id="1477284">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1477291">//&nbsp;if&nbsp;key!=key&nbsp;then&nbsp;the&nbsp;entry&nbsp;can&#39;t&nbsp;be&nbsp;deleted&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1477346">//&nbsp;updated,&nbsp;so&nbsp;we&nbsp;can&nbsp;just&nbsp;return&nbsp;it.&nbsp;&nbsp;That&#39;s&nbsp;lucky&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1477407">//&nbsp;us&nbsp;because&nbsp;when&nbsp;key!=key&nbsp;we&nbsp;can&#39;t&nbsp;look&nbsp;it&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1477460">//&nbsp;successfully&nbsp;in&nbsp;the&nbsp;current&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477503">it</span><span class="op" id="1477505">.</span><span class="ident" id="1477506">key</span>&nbsp;<span class="op" id="1477510">=</span>&nbsp;<span class="ident" id="1477512">k2</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1477520">if</span>&nbsp;<span class="ident" id="1477523">t</span><span class="op" id="1477524">.</span><span class="ident" id="1477525">indirectvalue</span>&nbsp;<span class="op" id="1477539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477547">v</span>&nbsp;<span class="op" id="1477549">=</span>&nbsp;<span class="op" id="1477551">*</span><span class="op" id="1477552">(</span><span class="op" id="1477553">(</span><span class="op" id="1477554">*</span><span class="ident" id="1477555">unsafe</span><span class="op" id="1477561">.</span><span class="ident" id="1477562">Pointer</span><span class="op" id="1477569">)</span><span class="op" id="1477570">(</span><span class="ident" id="1477571">v</span><span class="op" id="1477572">)</span><span class="op" id="1477573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1477580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477587">it</span><span class="op" id="1477589">.</span><span class="ident" id="1477590">value</span>&nbsp;<span class="op" id="1477596">=</span>&nbsp;<span class="ident" id="1477598">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1477604">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1477609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477614">it</span><span class="op" id="1477616">.</span><span class="ident" id="1477617">bucket</span>&nbsp;<span class="op" id="1477624">=</span>&nbsp;<span class="ident" id="1477626">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477636">it</span><span class="op" id="1477638">.</span><span class="ident" id="1477639">bptr</span>&nbsp;<span class="op" id="1477644">=</span>&nbsp;<span class="ident" id="1477646">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477651">it</span><span class="op" id="1477653">.</span><span class="ident" id="1477654">i</span>&nbsp;<span class="op" id="1477656">=</span>&nbsp;<span class="ident" id="1477658">i</span>&nbsp;<span class="op" id="1477660">+</span>&nbsp;<span class="num" id="1477662">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477667">it</span><span class="op" id="1477669">.</span><span class="ident" id="1477670">checkBucket</span>&nbsp;<span class="op" id="1477682">=</span>&nbsp;<span class="ident" id="1477684">checkBucket</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1477699">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1477708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1477711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477714">b</span>&nbsp;<span class="op" id="1477716">=</span>&nbsp;<span class="ident" id="1477718">b</span><span class="op" id="1477719">.</span><span class="ident" id="1477720">overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477730">i</span>&nbsp;<span class="op" id="1477732">=</span>&nbsp;<span class="num" id="1477734">0</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1477737">goto</span>&nbsp;<span class="ident" id="1477742">next</span><br>
<span class="lineno"></span><span class="op" id="1477747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1477750">func</span>&nbsp;<span class="ident" id="1477755">hashGrow</span><span class="op" id="1477763">(</span><span class="ident" id="1477764">t</span>&nbsp;<span class="op" id="1477766">*</span><span class="ident" id="1477767">maptype</span><span class="op" id="1477774">,</span>&nbsp;<span class="ident" id="1477776">h</span>&nbsp;<span class="op" id="1477778">*</span><span class="ident" id="1477779">hmap</span><span class="op" id="1477783">)</span>&nbsp;<span class="op" id="1477785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1477788">if</span>&nbsp;<span class="ident" id="1477791">h</span><span class="op" id="1477792">.</span><span class="ident" id="1477793">oldbuckets</span>&nbsp;<span class="op" id="1477804">!=</span>&nbsp;<span class="ident" id="1477807">nil</span>&nbsp;<span class="op" id="1477811">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477815">gothrow</span><span class="op" id="1477822">(</span><span class="string" id="1477823">&#34;evacuation&nbsp;not&nbsp;done&nbsp;in&nbsp;time&#34;</span><span class="op" id="1477852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1477855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477858">oldbuckets</span>&nbsp;<span class="op" id="1477869">:=</span>&nbsp;<span class="ident" id="1477872">h</span><span class="op" id="1477873">.</span><span class="ident" id="1477874">buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1477883">if</span>&nbsp;<span class="ident" id="1477886">checkgc</span>&nbsp;<span class="op" id="1477894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477898">memstats</span><span class="op" id="1477906">.</span><span class="ident" id="1477907">next_gc</span>&nbsp;<span class="op" id="1477915">=</span>&nbsp;<span class="ident" id="1477917">memstats</span><span class="op" id="1477925">.</span><span class="ident" id="1477926">heap_alloc</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1477938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477941">newbuckets</span>&nbsp;<span class="op" id="1477952">:=</span>&nbsp;<span class="ident" id="1477955">newarray</span><span class="op" id="1477963">(</span><span class="ident" id="1477964">t</span><span class="op" id="1477965">.</span><span class="ident" id="1477966">bucket</span><span class="op" id="1477972">,</span>&nbsp;<span class="builtintype" id="1477974">uintptr</span><span class="op" id="1477981">(</span><span class="num" id="1477982">1</span><span class="op" id="1477983">)</span><span class="op" id="1477984">&lt;&lt;</span><span class="op" id="1477986">(</span><span class="ident" id="1477987">h</span><span class="op" id="1477988">.</span><span class="ident" id="1477989">B</span><span class="op" id="1477990">+</span><span class="num" id="1477991">1</span><span class="op" id="1477992">)</span><span class="op" id="1477993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1477996">flags</span>&nbsp;<span class="op" id="1478002">:=</span>&nbsp;<span class="ident" id="1478005">h</span><span class="op" id="1478006">.</span><span class="ident" id="1478007">flags</span>&nbsp;<span class="op" id="1478013">&amp;^</span>&nbsp;<span class="op" id="1478016">(</span><span class="ident" id="1478017">iterator</span>&nbsp;<span class="op" id="1478026">|</span>&nbsp;<span class="ident" id="1478028">oldIterator</span><span class="op" id="1478039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1478042">if</span>&nbsp;<span class="ident" id="1478045">h</span><span class="op" id="1478046">.</span><span class="ident" id="1478047">flags</span><span class="op" id="1478052">&amp;</span><span class="ident" id="1478053">iterator</span>&nbsp;<span class="op" id="1478062">!=</span>&nbsp;<span class="num" id="1478065">0</span>&nbsp;<span class="op" id="1478067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478071">flags</span>&nbsp;<span class="op" id="1478077">|=</span>&nbsp;<span class="ident" id="1478080">oldIterator</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1478093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1478096">//&nbsp;commit&nbsp;the&nbsp;grow&nbsp;(atomic&nbsp;wrt&nbsp;gc)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478132">h</span><span class="op" id="1478133">.</span><span class="ident" id="1478134">B</span><span class="op" id="1478135">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478139">h</span><span class="op" id="1478140">.</span><span class="ident" id="1478141">flags</span>&nbsp;<span class="op" id="1478147">=</span>&nbsp;<span class="ident" id="1478149">flags</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478156">h</span><span class="op" id="1478157">.</span><span class="ident" id="1478158">oldbuckets</span>&nbsp;<span class="op" id="1478169">=</span>&nbsp;<span class="ident" id="1478171">oldbuckets</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478183">h</span><span class="op" id="1478184">.</span><span class="ident" id="1478185">buckets</span>&nbsp;<span class="op" id="1478193">=</span>&nbsp;<span class="ident" id="1478195">newbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478207">h</span><span class="op" id="1478208">.</span><span class="ident" id="1478209">nevacuate</span>&nbsp;<span class="op" id="1478219">=</span>&nbsp;<span class="num" id="1478221">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1478225">//&nbsp;the&nbsp;actual&nbsp;copying&nbsp;of&nbsp;the&nbsp;hash&nbsp;table&nbsp;data&nbsp;is&nbsp;done&nbsp;incrementally</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1478293">//&nbsp;by&nbsp;growWork()&nbsp;and&nbsp;evacuate().</span><br>
<span class="lineno">750</span><span class="op" id="1478326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1478329">func</span>&nbsp;<span class="ident" id="1478334">growWork</span><span class="op" id="1478342">(</span><span class="ident" id="1478343">t</span>&nbsp;<span class="op" id="1478345">*</span><span class="ident" id="1478346">maptype</span><span class="op" id="1478353">,</span>&nbsp;<span class="ident" id="1478355">h</span>&nbsp;<span class="op" id="1478357">*</span><span class="ident" id="1478358">hmap</span><span class="op" id="1478362">,</span>&nbsp;<span class="ident" id="1478364">bucket</span>&nbsp;<span class="builtintype" id="1478371">uintptr</span><span class="op" id="1478378">)</span>&nbsp;<span class="op" id="1478380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478383">noldbuckets</span>&nbsp;<span class="op" id="1478395">:=</span>&nbsp;<span class="builtintype" id="1478398">uintptr</span><span class="op" id="1478405">(</span><span class="num" id="1478406">1</span><span class="op" id="1478407">)</span>&nbsp;<span class="op" id="1478409">&lt;&lt;</span>&nbsp;<span class="op" id="1478412">(</span><span class="ident" id="1478413">h</span><span class="op" id="1478414">.</span><span class="ident" id="1478415">B</span>&nbsp;<span class="op" id="1478417">-</span>&nbsp;<span class="num" id="1478419">1</span><span class="op" id="1478420">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1478424">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;evacuate&nbsp;the&nbsp;oldbucket&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1478478">//&nbsp;to&nbsp;the&nbsp;bucket&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478515">evacuate</span><span class="op" id="1478523">(</span><span class="ident" id="1478524">t</span><span class="op" id="1478525">,</span>&nbsp;<span class="ident" id="1478527">h</span><span class="op" id="1478528">,</span>&nbsp;<span class="ident" id="1478530">bucket</span><span class="op" id="1478536">&amp;</span><span class="op" id="1478537">(</span><span class="ident" id="1478538">noldbuckets</span><span class="op" id="1478549">-</span><span class="num" id="1478550">1</span><span class="op" id="1478551">)</span><span class="op" id="1478552">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1478556">//&nbsp;evacuate&nbsp;one&nbsp;more&nbsp;oldbucket&nbsp;to&nbsp;make&nbsp;progress&nbsp;on&nbsp;growing</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1478616">if</span>&nbsp;<span class="ident" id="1478619">h</span><span class="op" id="1478620">.</span><span class="ident" id="1478621">oldbuckets</span>&nbsp;<span class="op" id="1478632">!=</span>&nbsp;<span class="ident" id="1478635">nil</span>&nbsp;<span class="op" id="1478639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478643">evacuate</span><span class="op" id="1478651">(</span><span class="ident" id="1478652">t</span><span class="op" id="1478653">,</span>&nbsp;<span class="ident" id="1478655">h</span><span class="op" id="1478656">,</span>&nbsp;<span class="ident" id="1478658">h</span><span class="op" id="1478659">.</span><span class="ident" id="1478660">nevacuate</span><span class="op" id="1478669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1478672">}</span><br>
<span class="lineno"></span><span class="op" id="1478674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="1478677">func</span>&nbsp;<span class="ident" id="1478682">evacuate</span><span class="op" id="1478690">(</span><span class="ident" id="1478691">t</span>&nbsp;<span class="op" id="1478693">*</span><span class="ident" id="1478694">maptype</span><span class="op" id="1478701">,</span>&nbsp;<span class="ident" id="1478703">h</span>&nbsp;<span class="op" id="1478705">*</span><span class="ident" id="1478706">hmap</span><span class="op" id="1478710">,</span>&nbsp;<span class="ident" id="1478712">oldbucket</span>&nbsp;<span class="builtintype" id="1478722">uintptr</span><span class="op" id="1478729">)</span>&nbsp;<span class="op" id="1478731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478734">b</span>&nbsp;<span class="op" id="1478736">:=</span>&nbsp;<span class="op" id="1478739">(</span><span class="op" id="1478740">*</span><span class="ident" id="1478741">bmap</span><span class="op" id="1478745">)</span><span class="op" id="1478746">(</span><span class="ident" id="1478747">add</span><span class="op" id="1478750">(</span><span class="ident" id="1478751">h</span><span class="op" id="1478752">.</span><span class="ident" id="1478753">oldbuckets</span><span class="op" id="1478763">,</span>&nbsp;<span class="ident" id="1478765">oldbucket</span><span class="op" id="1478774">*</span><span class="builtintype" id="1478775">uintptr</span><span class="op" id="1478782">(</span><span class="ident" id="1478783">t</span><span class="op" id="1478784">.</span><span class="ident" id="1478785">bucketsize</span><span class="op" id="1478795">)</span><span class="op" id="1478796">)</span><span class="op" id="1478797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478800">newbit</span>&nbsp;<span class="op" id="1478807">:=</span>&nbsp;<span class="builtintype" id="1478810">uintptr</span><span class="op" id="1478817">(</span><span class="num" id="1478818">1</span><span class="op" id="1478819">)</span>&nbsp;<span class="op" id="1478821">&lt;&lt;</span>&nbsp;<span class="op" id="1478824">(</span><span class="ident" id="1478825">h</span><span class="op" id="1478826">.</span><span class="ident" id="1478827">B</span>&nbsp;<span class="op" id="1478829">-</span>&nbsp;<span class="num" id="1478831">1</span><span class="op" id="1478832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1478835">alg</span>&nbsp;<span class="op" id="1478839">:=</span>&nbsp;<span class="ident" id="1478842">goalg</span><span class="op" id="1478847">(</span><span class="ident" id="1478848">t</span><span class="op" id="1478849">.</span><span class="ident" id="1478850">key</span><span class="op" id="1478853">.</span><span class="ident" id="1478854">alg</span><span class="op" id="1478857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1478860">if</span>&nbsp;<span class="op" id="1478863">!</span><span class="ident" id="1478864">evacuated</span><span class="op" id="1478873">(</span><span class="ident" id="1478874">b</span><span class="op" id="1478875">)</span>&nbsp;<span class="op" id="1478877">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1478881">//&nbsp;TODO:&nbsp;reuse&nbsp;overflow&nbsp;buckets&nbsp;instead&nbsp;of&nbsp;using&nbsp;new&nbsp;ones,&nbsp;if&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1478951">//&nbsp;is&nbsp;no&nbsp;iterator&nbsp;using&nbsp;the&nbsp;old&nbsp;buckets.&nbsp;&nbsp;(If&nbsp;!oldIterator.)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479015">x</span>&nbsp;<span class="op" id="1479017">:=</span>&nbsp;<span class="op" id="1479020">(</span><span class="op" id="1479021">*</span><span class="ident" id="1479022">bmap</span><span class="op" id="1479026">)</span><span class="op" id="1479027">(</span><span class="ident" id="1479028">add</span><span class="op" id="1479031">(</span><span class="ident" id="1479032">h</span><span class="op" id="1479033">.</span><span class="ident" id="1479034">buckets</span><span class="op" id="1479041">,</span>&nbsp;<span class="ident" id="1479043">oldbucket</span><span class="op" id="1479052">*</span><span class="builtintype" id="1479053">uintptr</span><span class="op" id="1479060">(</span><span class="ident" id="1479061">t</span><span class="op" id="1479062">.</span><span class="ident" id="1479063">bucketsize</span><span class="op" id="1479073">)</span><span class="op" id="1479074">)</span><span class="op" id="1479075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479079">y</span>&nbsp;<span class="op" id="1479081">:=</span>&nbsp;<span class="op" id="1479084">(</span><span class="op" id="1479085">*</span><span class="ident" id="1479086">bmap</span><span class="op" id="1479090">)</span><span class="op" id="1479091">(</span><span class="ident" id="1479092">add</span><span class="op" id="1479095">(</span><span class="ident" id="1479096">h</span><span class="op" id="1479097">.</span><span class="ident" id="1479098">buckets</span><span class="op" id="1479105">,</span>&nbsp;<span class="op" id="1479107">(</span><span class="ident" id="1479108">oldbucket</span><span class="op" id="1479117">+</span><span class="ident" id="1479118">newbit</span><span class="op" id="1479124">)</span><span class="op" id="1479125">*</span><span class="builtintype" id="1479126">uintptr</span><span class="op" id="1479133">(</span><span class="ident" id="1479134">t</span><span class="op" id="1479135">.</span><span class="ident" id="1479136">bucketsize</span><span class="op" id="1479146">)</span><span class="op" id="1479147">)</span><span class="op" id="1479148">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479152">xi</span>&nbsp;<span class="op" id="1479155">:=</span>&nbsp;<span class="num" id="1479158">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479162">yi</span>&nbsp;<span class="op" id="1479165">:=</span>&nbsp;<span class="num" id="1479168">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479172">xk</span>&nbsp;<span class="op" id="1479175">:=</span>&nbsp;<span class="ident" id="1479178">add</span><span class="op" id="1479181">(</span><span class="ident" id="1479182">unsafe</span><span class="op" id="1479188">.</span><span class="ident" id="1479189">Pointer</span><span class="op" id="1479196">(</span><span class="ident" id="1479197">x</span><span class="op" id="1479198">)</span><span class="op" id="1479199">,</span>&nbsp;<span class="ident" id="1479201">dataOffset</span><span class="op" id="1479211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479215">yk</span>&nbsp;<span class="op" id="1479218">:=</span>&nbsp;<span class="ident" id="1479221">add</span><span class="op" id="1479224">(</span><span class="ident" id="1479225">unsafe</span><span class="op" id="1479231">.</span><span class="ident" id="1479232">Pointer</span><span class="op" id="1479239">(</span><span class="ident" id="1479240">y</span><span class="op" id="1479241">)</span><span class="op" id="1479242">,</span>&nbsp;<span class="ident" id="1479244">dataOffset</span><span class="op" id="1479254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479258">xv</span>&nbsp;<span class="op" id="1479261">:=</span>&nbsp;<span class="ident" id="1479264">add</span><span class="op" id="1479267">(</span><span class="ident" id="1479268">xk</span><span class="op" id="1479270">,</span>&nbsp;<span class="ident" id="1479272">bucketCnt</span><span class="op" id="1479281">*</span><span class="builtintype" id="1479282">uintptr</span><span class="op" id="1479289">(</span><span class="ident" id="1479290">t</span><span class="op" id="1479291">.</span><span class="ident" id="1479292">keysize</span><span class="op" id="1479299">)</span><span class="op" id="1479300">)</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479304">yv</span>&nbsp;<span class="op" id="1479307">:=</span>&nbsp;<span class="ident" id="1479310">add</span><span class="op" id="1479313">(</span><span class="ident" id="1479314">yk</span><span class="op" id="1479316">,</span>&nbsp;<span class="ident" id="1479318">bucketCnt</span><span class="op" id="1479327">*</span><span class="builtintype" id="1479328">uintptr</span><span class="op" id="1479335">(</span><span class="ident" id="1479336">t</span><span class="op" id="1479337">.</span><span class="ident" id="1479338">keysize</span><span class="op" id="1479345">)</span><span class="op" id="1479346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479350">for</span>&nbsp;<span class="op" id="1479354">;</span>&nbsp;<span class="ident" id="1479356">b</span>&nbsp;<span class="op" id="1479358">!=</span>&nbsp;<span class="ident" id="1479361">nil</span><span class="op" id="1479364">;</span>&nbsp;<span class="ident" id="1479366">b</span>&nbsp;<span class="op" id="1479368">=</span>&nbsp;<span class="ident" id="1479370">b</span><span class="op" id="1479371">.</span><span class="ident" id="1479372">overflow</span>&nbsp;<span class="op" id="1479381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479386">k</span>&nbsp;<span class="op" id="1479388">:=</span>&nbsp;<span class="ident" id="1479391">add</span><span class="op" id="1479394">(</span><span class="ident" id="1479395">unsafe</span><span class="op" id="1479401">.</span><span class="ident" id="1479402">Pointer</span><span class="op" id="1479409">(</span><span class="ident" id="1479410">b</span><span class="op" id="1479411">)</span><span class="op" id="1479412">,</span>&nbsp;<span class="ident" id="1479414">dataOffset</span><span class="op" id="1479424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479429">v</span>&nbsp;<span class="op" id="1479431">:=</span>&nbsp;<span class="ident" id="1479434">add</span><span class="op" id="1479437">(</span><span class="ident" id="1479438">k</span><span class="op" id="1479439">,</span>&nbsp;<span class="ident" id="1479441">bucketCnt</span><span class="op" id="1479450">*</span><span class="builtintype" id="1479451">uintptr</span><span class="op" id="1479458">(</span><span class="ident" id="1479459">t</span><span class="op" id="1479460">.</span><span class="ident" id="1479461">keysize</span><span class="op" id="1479468">)</span><span class="op" id="1479469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479474">for</span>&nbsp;<span class="ident" id="1479478">i</span>&nbsp;<span class="op" id="1479480">:=</span>&nbsp;<span class="num" id="1479483">0</span><span class="op" id="1479484">;</span>&nbsp;<span class="ident" id="1479486">i</span>&nbsp;<span class="op" id="1479488">&lt;</span>&nbsp;<span class="ident" id="1479490">bucketCnt</span><span class="op" id="1479499">;</span>&nbsp;<span class="ident" id="1479501">i</span><span class="op" id="1479502">,</span>&nbsp;<span class="ident" id="1479504">k</span><span class="op" id="1479505">,</span>&nbsp;<span class="ident" id="1479507">v</span>&nbsp;<span class="op" id="1479509">=</span>&nbsp;<span class="ident" id="1479511">i</span><span class="op" id="1479512">+</span><span class="num" id="1479513">1</span><span class="op" id="1479514">,</span>&nbsp;<span class="ident" id="1479516">add</span><span class="op" id="1479519">(</span><span class="ident" id="1479520">k</span><span class="op" id="1479521">,</span>&nbsp;<span class="builtintype" id="1479523">uintptr</span><span class="op" id="1479530">(</span><span class="ident" id="1479531">t</span><span class="op" id="1479532">.</span><span class="ident" id="1479533">keysize</span><span class="op" id="1479540">)</span><span class="op" id="1479541">)</span><span class="op" id="1479542">,</span>&nbsp;<span class="ident" id="1479544">add</span><span class="op" id="1479547">(</span><span class="ident" id="1479548">v</span><span class="op" id="1479549">,</span>&nbsp;<span class="builtintype" id="1479551">uintptr</span><span class="op" id="1479558">(</span><span class="ident" id="1479559">t</span><span class="op" id="1479560">.</span><span class="ident" id="1479561">valuesize</span><span class="op" id="1479570">)</span><span class="op" id="1479571">)</span>&nbsp;<span class="op" id="1479573">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479579">top</span>&nbsp;<span class="op" id="1479583">:=</span>&nbsp;<span class="ident" id="1479586">b</span><span class="op" id="1479587">.</span><span class="ident" id="1479588">tophash</span><span class="op" id="1479595">[</span><span class="ident" id="1479596">i</span><span class="op" id="1479597">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479603">if</span>&nbsp;<span class="ident" id="1479606">top</span>&nbsp;<span class="op" id="1479610">==</span>&nbsp;<span class="ident" id="1479613">empty</span>&nbsp;<span class="op" id="1479619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479626">b</span><span class="op" id="1479627">.</span><span class="ident" id="1479628">tophash</span><span class="op" id="1479635">[</span><span class="ident" id="1479636">i</span><span class="op" id="1479637">]</span>&nbsp;<span class="op" id="1479639">=</span>&nbsp;<span class="ident" id="1479641">evacuatedEmpty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479661">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1479674">}</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479680">if</span>&nbsp;<span class="ident" id="1479683">top</span>&nbsp;<span class="op" id="1479687">&lt;</span>&nbsp;<span class="ident" id="1479689">minTopHash</span>&nbsp;<span class="op" id="1479700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479707">gothrow</span><span class="op" id="1479714">(</span><span class="string" id="1479715">&#34;bad&nbsp;map&nbsp;state&#34;</span><span class="op" id="1479730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1479736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479742">k2</span>&nbsp;<span class="op" id="1479745">:=</span>&nbsp;<span class="ident" id="1479748">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1479754">if</span>&nbsp;<span class="ident" id="1479757">t</span><span class="op" id="1479758">.</span><span class="ident" id="1479759">indirectkey</span>&nbsp;<span class="op" id="1479771">{</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479778">k2</span>&nbsp;<span class="op" id="1479781">=</span>&nbsp;<span class="op" id="1479783">*</span><span class="op" id="1479784">(</span><span class="op" id="1479785">(</span><span class="op" id="1479786">*</span><span class="ident" id="1479787">unsafe</span><span class="op" id="1479793">.</span><span class="ident" id="1479794">Pointer</span><span class="op" id="1479801">)</span><span class="op" id="1479802">(</span><span class="ident" id="1479803">k2</span><span class="op" id="1479805">)</span><span class="op" id="1479806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1479812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1479818">//&nbsp;Compute&nbsp;hash&nbsp;to&nbsp;make&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;(whether&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1479887">//&nbsp;to&nbsp;send&nbsp;this&nbsp;key/value&nbsp;to&nbsp;bucket&nbsp;x&nbsp;or&nbsp;bucket&nbsp;y).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1479943">hash</span>&nbsp;<span class="op" id="1479948">:=</span>&nbsp;<span class="ident" id="1479951">alg</span><span class="op" id="1479954">.</span><span class="ident" id="1479955">hash</span><span class="op" id="1479959">(</span><span class="ident" id="1479960">k2</span><span class="op" id="1479962">,</span>&nbsp;<span class="builtintype" id="1479964">uintptr</span><span class="op" id="1479971">(</span><span class="ident" id="1479972">t</span><span class="op" id="1479973">.</span><span class="ident" id="1479974">key</span><span class="op" id="1479977">.</span><span class="ident" id="1479978">size</span><span class="op" id="1479982">)</span><span class="op" id="1479983">,</span>&nbsp;<span class="builtintype" id="1479985">uintptr</span><span class="op" id="1479992">(</span><span class="ident" id="1479993">h</span><span class="op" id="1479994">.</span><span class="ident" id="1479995">hash0</span><span class="op" id="1480000">)</span><span class="op" id="1480001">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1480007">if</span>&nbsp;<span class="ident" id="1480010">h</span><span class="op" id="1480011">.</span><span class="ident" id="1480012">flags</span><span class="op" id="1480017">&amp;</span><span class="ident" id="1480018">iterator</span>&nbsp;<span class="op" id="1480027">!=</span>&nbsp;<span class="num" id="1480030">0</span>&nbsp;<span class="op" id="1480032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1480039">if</span>&nbsp;<span class="op" id="1480042">!</span><span class="ident" id="1480043">alg</span><span class="op" id="1480046">.</span><span class="ident" id="1480047">equal</span><span class="op" id="1480052">(</span><span class="ident" id="1480053">k2</span><span class="op" id="1480055">,</span>&nbsp;<span class="ident" id="1480057">k2</span><span class="op" id="1480059">,</span>&nbsp;<span class="builtintype" id="1480061">uintptr</span><span class="op" id="1480068">(</span><span class="ident" id="1480069">t</span><span class="op" id="1480070">.</span><span class="ident" id="1480071">key</span><span class="op" id="1480074">.</span><span class="ident" id="1480075">size</span><span class="op" id="1480079">)</span><span class="op" id="1480080">)</span>&nbsp;<span class="op" id="1480082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480090">//&nbsp;If&nbsp;key&nbsp;!=&nbsp;key&nbsp;(NaNs),&nbsp;then&nbsp;the&nbsp;hash&nbsp;could&nbsp;be&nbsp;(and&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480158">//&nbsp;will&nbsp;be)&nbsp;entirely&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;hash.&nbsp;&nbsp;Moreover,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480225">//&nbsp;it&nbsp;isn&#39;t&nbsp;reproducible.&nbsp;&nbsp;Reproducibility&nbsp;is&nbsp;required&nbsp;in&nbsp;the</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480293">//&nbsp;presence&nbsp;of&nbsp;iterators,&nbsp;as&nbsp;our&nbsp;evacuation&nbsp;decision&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480357">//&nbsp;match&nbsp;whatever&nbsp;decision&nbsp;the&nbsp;iterator&nbsp;made.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480409">//&nbsp;Fortunately,&nbsp;we&nbsp;have&nbsp;the&nbsp;freedom&nbsp;to&nbsp;send&nbsp;these&nbsp;keys&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480477">//&nbsp;way.&nbsp;&nbsp;Also,&nbsp;tophash&nbsp;is&nbsp;meaningless&nbsp;for&nbsp;these&nbsp;kinds&nbsp;of&nbsp;keys.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480546">//&nbsp;We&nbsp;let&nbsp;the&nbsp;low&nbsp;bit&nbsp;of&nbsp;tophash&nbsp;drive&nbsp;the&nbsp;evacuation&nbsp;decision.</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480616">//&nbsp;We&nbsp;recompute&nbsp;a&nbsp;new&nbsp;random&nbsp;tophash&nbsp;for&nbsp;the&nbsp;next&nbsp;level&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480681">//&nbsp;these&nbsp;keys&nbsp;will&nbsp;get&nbsp;evenly&nbsp;distributed&nbsp;across&nbsp;all&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1480748">//&nbsp;after&nbsp;multiple&nbsp;grows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1480779">if</span>&nbsp;<span class="op" id="1480782">(</span><span class="ident" id="1480783">top</span>&nbsp;<span class="op" id="1480787">&amp;</span>&nbsp;<span class="num" id="1480789">1</span><span class="op" id="1480790">)</span>&nbsp;<span class="op" id="1480792">!=</span>&nbsp;<span class="num" id="1480795">0</span>&nbsp;<span class="op" id="1480797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480806">hash</span>&nbsp;<span class="op" id="1480811">|=</span>&nbsp;<span class="ident" id="1480814">newbit</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1480827">}</span>&nbsp;<span class="keyword" id="1480829">else</span>&nbsp;<span class="op" id="1480834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480843">hash</span>&nbsp;<span class="op" id="1480848">&amp;^=</span>&nbsp;<span class="ident" id="1480852">newbit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1480865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480873">top</span>&nbsp;<span class="op" id="1480877">=</span>&nbsp;<span class="builtintype" id="1480879">uint8</span><span class="op" id="1480884">(</span><span class="ident" id="1480885">hash</span>&nbsp;<span class="op" id="1480890">&gt;&gt;</span>&nbsp;<span class="op" id="1480893">(</span><span class="ident" id="1480894">ptrSize</span><span class="op" id="1480901">*</span><span class="num" id="1480902">8</span>&nbsp;<span class="op" id="1480904">-</span>&nbsp;<span class="num" id="1480906">8</span><span class="op" id="1480907">)</span><span class="op" id="1480908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1480916">if</span>&nbsp;<span class="ident" id="1480919">top</span>&nbsp;<span class="op" id="1480923">&lt;</span>&nbsp;<span class="ident" id="1480925">minTopHash</span>&nbsp;<span class="op" id="1480936">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1480945">top</span>&nbsp;<span class="op" id="1480949">+=</span>&nbsp;<span class="ident" id="1480952">minTopHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1480969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1480976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1480982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1480988">if</span>&nbsp;<span class="op" id="1480991">(</span><span class="ident" id="1480992">hash</span>&nbsp;<span class="op" id="1480997">&amp;</span>&nbsp;<span class="ident" id="1480999">newbit</span><span class="op" id="1481005">)</span>&nbsp;<span class="op" id="1481007">==</span>&nbsp;<span class="num" id="1481010">0</span>&nbsp;<span class="op" id="1481012">{</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481019">b</span><span class="op" id="1481020">.</span><span class="ident" id="1481021">tophash</span><span class="op" id="1481028">[</span><span class="ident" id="1481029">i</span><span class="op" id="1481030">]</span>&nbsp;<span class="op" id="1481032">=</span>&nbsp;<span class="ident" id="1481034">evacuatedX</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481050">if</span>&nbsp;<span class="ident" id="1481053">xi</span>&nbsp;<span class="op" id="1481056">==</span>&nbsp;<span class="ident" id="1481059">bucketCnt</span>&nbsp;<span class="op" id="1481069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481077">if</span>&nbsp;<span class="ident" id="1481080">checkgc</span>&nbsp;<span class="op" id="1481088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481097">memstats</span><span class="op" id="1481105">.</span><span class="ident" id="1481106">next_gc</span>&nbsp;<span class="op" id="1481114">=</span>&nbsp;<span class="ident" id="1481116">memstats</span><span class="op" id="1481124">.</span><span class="ident" id="1481125">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481142">}</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481150">newx</span>&nbsp;<span class="op" id="1481155">:=</span>&nbsp;<span class="op" id="1481158">(</span><span class="op" id="1481159">*</span><span class="ident" id="1481160">bmap</span><span class="op" id="1481164">)</span><span class="op" id="1481165">(</span><span class="ident" id="1481166">newobject</span><span class="op" id="1481175">(</span><span class="ident" id="1481176">t</span><span class="op" id="1481177">.</span><span class="ident" id="1481178">bucket</span><span class="op" id="1481184">)</span><span class="op" id="1481185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481193">x</span><span class="op" id="1481194">.</span><span class="ident" id="1481195">overflow</span>&nbsp;<span class="op" id="1481204">=</span>&nbsp;<span class="ident" id="1481206">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481217">x</span>&nbsp;<span class="op" id="1481219">=</span>&nbsp;<span class="ident" id="1481221">newx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481232">xi</span>&nbsp;<span class="op" id="1481235">=</span>&nbsp;<span class="num" id="1481237">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481245">xk</span>&nbsp;<span class="op" id="1481248">=</span>&nbsp;<span class="ident" id="1481250">add</span><span class="op" id="1481253">(</span><span class="ident" id="1481254">unsafe</span><span class="op" id="1481260">.</span><span class="ident" id="1481261">Pointer</span><span class="op" id="1481268">(</span><span class="ident" id="1481269">x</span><span class="op" id="1481270">)</span><span class="op" id="1481271">,</span>&nbsp;<span class="ident" id="1481273">dataOffset</span><span class="op" id="1481283">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481291">xv</span>&nbsp;<span class="op" id="1481294">=</span>&nbsp;<span class="ident" id="1481296">add</span><span class="op" id="1481299">(</span><span class="ident" id="1481300">xk</span><span class="op" id="1481302">,</span>&nbsp;<span class="ident" id="1481304">bucketCnt</span><span class="op" id="1481313">*</span><span class="builtintype" id="1481314">uintptr</span><span class="op" id="1481321">(</span><span class="ident" id="1481322">t</span><span class="op" id="1481323">.</span><span class="ident" id="1481324">keysize</span><span class="op" id="1481331">)</span><span class="op" id="1481332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481346">x</span><span class="op" id="1481347">.</span><span class="ident" id="1481348">tophash</span><span class="op" id="1481355">[</span><span class="ident" id="1481356">xi</span><span class="op" id="1481358">]</span>&nbsp;<span class="op" id="1481360">=</span>&nbsp;<span class="ident" id="1481362">top</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481371">if</span>&nbsp;<span class="ident" id="1481374">t</span><span class="op" id="1481375">.</span><span class="ident" id="1481376">indirectkey</span>&nbsp;<span class="op" id="1481388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481396">*</span><span class="op" id="1481397">(</span><span class="op" id="1481398">*</span><span class="ident" id="1481399">unsafe</span><span class="op" id="1481405">.</span><span class="ident" id="1481406">Pointer</span><span class="op" id="1481413">)</span><span class="op" id="1481414">(</span><span class="ident" id="1481415">xk</span><span class="op" id="1481417">)</span>&nbsp;<span class="op" id="1481419">=</span>&nbsp;<span class="ident" id="1481421">k2</span>&nbsp;<span class="comment" id="1481424">//&nbsp;copy&nbsp;pointer</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481445">}</span>&nbsp;<span class="keyword" id="1481447">else</span>&nbsp;<span class="op" id="1481452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481460">memmove</span><span class="op" id="1481467">(</span><span class="ident" id="1481468">xk</span><span class="op" id="1481470">,</span>&nbsp;<span class="ident" id="1481472">k</span><span class="op" id="1481473">,</span>&nbsp;<span class="builtintype" id="1481475">uintptr</span><span class="op" id="1481482">(</span><span class="ident" id="1481483">t</span><span class="op" id="1481484">.</span><span class="ident" id="1481485">key</span><span class="op" id="1481488">.</span><span class="ident" id="1481489">size</span><span class="op" id="1481493">)</span><span class="op" id="1481494">)</span>&nbsp;<span class="comment" id="1481496">//&nbsp;copy&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481522">if</span>&nbsp;<span class="ident" id="1481525">t</span><span class="op" id="1481526">.</span><span class="ident" id="1481527">indirectvalue</span>&nbsp;<span class="op" id="1481541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481549">*</span><span class="op" id="1481550">(</span><span class="op" id="1481551">*</span><span class="ident" id="1481552">unsafe</span><span class="op" id="1481558">.</span><span class="ident" id="1481559">Pointer</span><span class="op" id="1481566">)</span><span class="op" id="1481567">(</span><span class="ident" id="1481568">xv</span><span class="op" id="1481570">)</span>&nbsp;<span class="op" id="1481572">=</span>&nbsp;<span class="op" id="1481574">*</span><span class="op" id="1481575">(</span><span class="op" id="1481576">*</span><span class="ident" id="1481577">unsafe</span><span class="op" id="1481583">.</span><span class="ident" id="1481584">Pointer</span><span class="op" id="1481591">)</span><span class="op" id="1481592">(</span><span class="ident" id="1481593">v</span><span class="op" id="1481594">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481601">}</span>&nbsp;<span class="keyword" id="1481603">else</span>&nbsp;<span class="op" id="1481608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481616">memmove</span><span class="op" id="1481623">(</span><span class="ident" id="1481624">xv</span><span class="op" id="1481626">,</span>&nbsp;<span class="ident" id="1481628">v</span><span class="op" id="1481629">,</span>&nbsp;<span class="builtintype" id="1481631">uintptr</span><span class="op" id="1481638">(</span><span class="ident" id="1481639">t</span><span class="op" id="1481640">.</span><span class="ident" id="1481641">elem</span><span class="op" id="1481645">.</span><span class="ident" id="1481646">size</span><span class="op" id="1481650">)</span><span class="op" id="1481651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481665">xi</span><span class="op" id="1481667">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481675">xk</span>&nbsp;<span class="op" id="1481678">=</span>&nbsp;<span class="ident" id="1481680">add</span><span class="op" id="1481683">(</span><span class="ident" id="1481684">xk</span><span class="op" id="1481686">,</span>&nbsp;<span class="builtintype" id="1481688">uintptr</span><span class="op" id="1481695">(</span><span class="ident" id="1481696">t</span><span class="op" id="1481697">.</span><span class="ident" id="1481698">keysize</span><span class="op" id="1481705">)</span><span class="op" id="1481706">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481713">xv</span>&nbsp;<span class="op" id="1481716">=</span>&nbsp;<span class="ident" id="1481718">add</span><span class="op" id="1481721">(</span><span class="ident" id="1481722">xv</span><span class="op" id="1481724">,</span>&nbsp;<span class="builtintype" id="1481726">uintptr</span><span class="op" id="1481733">(</span><span class="ident" id="1481734">t</span><span class="op" id="1481735">.</span><span class="ident" id="1481736">valuesize</span><span class="op" id="1481745">)</span><span class="op" id="1481746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481752">}</span>&nbsp;<span class="keyword" id="1481754">else</span>&nbsp;<span class="op" id="1481759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481766">b</span><span class="op" id="1481767">.</span><span class="ident" id="1481768">tophash</span><span class="op" id="1481775">[</span><span class="ident" id="1481776">i</span><span class="op" id="1481777">]</span>&nbsp;<span class="op" id="1481779">=</span>&nbsp;<span class="ident" id="1481781">evacuatedY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481797">if</span>&nbsp;<span class="ident" id="1481800">yi</span>&nbsp;<span class="op" id="1481803">==</span>&nbsp;<span class="ident" id="1481806">bucketCnt</span>&nbsp;<span class="op" id="1481816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1481824">if</span>&nbsp;<span class="ident" id="1481827">checkgc</span>&nbsp;<span class="op" id="1481835">{</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481844">memstats</span><span class="op" id="1481852">.</span><span class="ident" id="1481853">next_gc</span>&nbsp;<span class="op" id="1481861">=</span>&nbsp;<span class="ident" id="1481863">memstats</span><span class="op" id="1481871">.</span><span class="ident" id="1481872">heap_alloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1481889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481897">newy</span>&nbsp;<span class="op" id="1481902">:=</span>&nbsp;<span class="op" id="1481905">(</span><span class="op" id="1481906">*</span><span class="ident" id="1481907">bmap</span><span class="op" id="1481911">)</span><span class="op" id="1481912">(</span><span class="ident" id="1481913">newobject</span><span class="op" id="1481922">(</span><span class="ident" id="1481923">t</span><span class="op" id="1481924">.</span><span class="ident" id="1481925">bucket</span><span class="op" id="1481931">)</span><span class="op" id="1481932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481940">y</span><span class="op" id="1481941">.</span><span class="ident" id="1481942">overflow</span>&nbsp;<span class="op" id="1481951">=</span>&nbsp;<span class="ident" id="1481953">newy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481964">y</span>&nbsp;<span class="op" id="1481966">=</span>&nbsp;<span class="ident" id="1481968">newy</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481979">yi</span>&nbsp;<span class="op" id="1481982">=</span>&nbsp;<span class="num" id="1481984">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1481992">yk</span>&nbsp;<span class="op" id="1481995">=</span>&nbsp;<span class="ident" id="1481997">add</span><span class="op" id="1482000">(</span><span class="ident" id="1482001">unsafe</span><span class="op" id="1482007">.</span><span class="ident" id="1482008">Pointer</span><span class="op" id="1482015">(</span><span class="ident" id="1482016">y</span><span class="op" id="1482017">)</span><span class="op" id="1482018">,</span>&nbsp;<span class="ident" id="1482020">dataOffset</span><span class="op" id="1482030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482038">yv</span>&nbsp;<span class="op" id="1482041">=</span>&nbsp;<span class="ident" id="1482043">add</span><span class="op" id="1482046">(</span><span class="ident" id="1482047">yk</span><span class="op" id="1482049">,</span>&nbsp;<span class="ident" id="1482051">bucketCnt</span><span class="op" id="1482060">*</span><span class="builtintype" id="1482061">uintptr</span><span class="op" id="1482068">(</span><span class="ident" id="1482069">t</span><span class="op" id="1482070">.</span><span class="ident" id="1482071">keysize</span><span class="op" id="1482078">)</span><span class="op" id="1482079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482093">y</span><span class="op" id="1482094">.</span><span class="ident" id="1482095">tophash</span><span class="op" id="1482102">[</span><span class="ident" id="1482103">yi</span><span class="op" id="1482105">]</span>&nbsp;<span class="op" id="1482107">=</span>&nbsp;<span class="ident" id="1482109">top</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482118">if</span>&nbsp;<span class="ident" id="1482121">t</span><span class="op" id="1482122">.</span><span class="ident" id="1482123">indirectkey</span>&nbsp;<span class="op" id="1482135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482143">*</span><span class="op" id="1482144">(</span><span class="op" id="1482145">*</span><span class="ident" id="1482146">unsafe</span><span class="op" id="1482152">.</span><span class="ident" id="1482153">Pointer</span><span class="op" id="1482160">)</span><span class="op" id="1482161">(</span><span class="ident" id="1482162">yk</span><span class="op" id="1482164">)</span>&nbsp;<span class="op" id="1482166">=</span>&nbsp;<span class="ident" id="1482168">k2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482176">}</span>&nbsp;<span class="keyword" id="1482178">else</span>&nbsp;<span class="op" id="1482183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482191">memmove</span><span class="op" id="1482198">(</span><span class="ident" id="1482199">yk</span><span class="op" id="1482201">,</span>&nbsp;<span class="ident" id="1482203">k</span><span class="op" id="1482204">,</span>&nbsp;<span class="builtintype" id="1482206">uintptr</span><span class="op" id="1482213">(</span><span class="ident" id="1482214">t</span><span class="op" id="1482215">.</span><span class="ident" id="1482216">key</span><span class="op" id="1482219">.</span><span class="ident" id="1482220">size</span><span class="op" id="1482224">)</span><span class="op" id="1482225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482232">}</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482239">if</span>&nbsp;<span class="ident" id="1482242">t</span><span class="op" id="1482243">.</span><span class="ident" id="1482244">indirectvalue</span>&nbsp;<span class="op" id="1482258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482266">*</span><span class="op" id="1482267">(</span><span class="op" id="1482268">*</span><span class="ident" id="1482269">unsafe</span><span class="op" id="1482275">.</span><span class="ident" id="1482276">Pointer</span><span class="op" id="1482283">)</span><span class="op" id="1482284">(</span><span class="ident" id="1482285">yv</span><span class="op" id="1482287">)</span>&nbsp;<span class="op" id="1482289">=</span>&nbsp;<span class="op" id="1482291">*</span><span class="op" id="1482292">(</span><span class="op" id="1482293">*</span><span class="ident" id="1482294">unsafe</span><span class="op" id="1482300">.</span><span class="ident" id="1482301">Pointer</span><span class="op" id="1482308">)</span><span class="op" id="1482309">(</span><span class="ident" id="1482310">v</span><span class="op" id="1482311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482318">}</span>&nbsp;<span class="keyword" id="1482320">else</span>&nbsp;<span class="op" id="1482325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482333">memmove</span><span class="op" id="1482340">(</span><span class="ident" id="1482341">yv</span><span class="op" id="1482343">,</span>&nbsp;<span class="ident" id="1482345">v</span><span class="op" id="1482346">,</span>&nbsp;<span class="builtintype" id="1482348">uintptr</span><span class="op" id="1482355">(</span><span class="ident" id="1482356">t</span><span class="op" id="1482357">.</span><span class="ident" id="1482358">elem</span><span class="op" id="1482362">.</span><span class="ident" id="1482363">size</span><span class="op" id="1482367">)</span><span class="op" id="1482368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482375">}</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482382">yi</span><span class="op" id="1482384">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482392">yk</span>&nbsp;<span class="op" id="1482395">=</span>&nbsp;<span class="ident" id="1482397">add</span><span class="op" id="1482400">(</span><span class="ident" id="1482401">yk</span><span class="op" id="1482403">,</span>&nbsp;<span class="builtintype" id="1482405">uintptr</span><span class="op" id="1482412">(</span><span class="ident" id="1482413">t</span><span class="op" id="1482414">.</span><span class="ident" id="1482415">keysize</span><span class="op" id="1482422">)</span><span class="op" id="1482423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482430">yv</span>&nbsp;<span class="op" id="1482433">=</span>&nbsp;<span class="ident" id="1482435">add</span><span class="op" id="1482438">(</span><span class="ident" id="1482439">yv</span><span class="op" id="1482441">,</span>&nbsp;<span class="builtintype" id="1482443">uintptr</span><span class="op" id="1482450">(</span><span class="ident" id="1482451">t</span><span class="op" id="1482452">.</span><span class="ident" id="1482453">valuesize</span><span class="op" id="1482462">)</span><span class="op" id="1482463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482474">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482482">//&nbsp;Unlink&nbsp;the&nbsp;overflow&nbsp;buckets&nbsp;&amp;&nbsp;clear&nbsp;key/value&nbsp;to&nbsp;help&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482545">if</span>&nbsp;<span class="ident" id="1482548">h</span><span class="op" id="1482549">.</span><span class="ident" id="1482550">flags</span><span class="op" id="1482555">&amp;</span><span class="ident" id="1482556">oldIterator</span>&nbsp;<span class="op" id="1482568">==</span>&nbsp;<span class="num" id="1482571">0</span>&nbsp;<span class="op" id="1482573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482578">b</span>&nbsp;<span class="op" id="1482580">=</span>&nbsp;<span class="op" id="1482582">(</span><span class="op" id="1482583">*</span><span class="ident" id="1482584">bmap</span><span class="op" id="1482588">)</span><span class="op" id="1482589">(</span><span class="ident" id="1482590">add</span><span class="op" id="1482593">(</span><span class="ident" id="1482594">h</span><span class="op" id="1482595">.</span><span class="ident" id="1482596">oldbuckets</span><span class="op" id="1482606">,</span>&nbsp;<span class="ident" id="1482608">oldbucket</span><span class="op" id="1482617">*</span><span class="builtintype" id="1482618">uintptr</span><span class="op" id="1482625">(</span><span class="ident" id="1482626">t</span><span class="op" id="1482627">.</span><span class="ident" id="1482628">bucketsize</span><span class="op" id="1482638">)</span><span class="op" id="1482639">)</span><span class="op" id="1482640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482645">b</span><span class="op" id="1482646">.</span><span class="ident" id="1482647">overflow</span>&nbsp;<span class="op" id="1482656">=</span>&nbsp;<span class="ident" id="1482658">nil</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482665">memclr</span><span class="op" id="1482671">(</span><span class="ident" id="1482672">add</span><span class="op" id="1482675">(</span><span class="ident" id="1482676">unsafe</span><span class="op" id="1482682">.</span><span class="ident" id="1482683">Pointer</span><span class="op" id="1482690">(</span><span class="ident" id="1482691">b</span><span class="op" id="1482692">)</span><span class="op" id="1482693">,</span>&nbsp;<span class="ident" id="1482695">dataOffset</span><span class="op" id="1482705">)</span><span class="op" id="1482706">,</span>&nbsp;<span class="builtintype" id="1482708">uintptr</span><span class="op" id="1482715">(</span><span class="ident" id="1482716">t</span><span class="op" id="1482717">.</span><span class="ident" id="1482718">bucketsize</span><span class="op" id="1482728">)</span><span class="op" id="1482729">-</span><span class="ident" id="1482730">dataOffset</span><span class="op" id="1482740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482751">//&nbsp;Advance&nbsp;evacuation&nbsp;mark</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482779">if</span>&nbsp;<span class="ident" id="1482782">oldbucket</span>&nbsp;<span class="op" id="1482792">==</span>&nbsp;<span class="ident" id="1482795">h</span><span class="op" id="1482796">.</span><span class="ident" id="1482797">nevacuate</span>&nbsp;<span class="op" id="1482807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482811">h</span><span class="op" id="1482812">.</span><span class="ident" id="1482813">nevacuate</span>&nbsp;<span class="op" id="1482823">=</span>&nbsp;<span class="ident" id="1482825">oldbucket</span>&nbsp;<span class="op" id="1482835">+</span>&nbsp;<span class="num" id="1482837">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1482841">if</span>&nbsp;<span class="ident" id="1482844">oldbucket</span><span class="op" id="1482853">+</span><span class="num" id="1482854">1</span>&nbsp;<span class="op" id="1482856">==</span>&nbsp;<span class="ident" id="1482859">newbit</span>&nbsp;<span class="op" id="1482866">{</span>&nbsp;<span class="comment" id="1482868">//&nbsp;newbit&nbsp;==&nbsp;#&nbsp;of&nbsp;oldbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1482900">//&nbsp;Growing&nbsp;is&nbsp;all&nbsp;done.&nbsp;&nbsp;Free&nbsp;old&nbsp;main&nbsp;bucket&nbsp;array.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1482956">h</span><span class="op" id="1482957">.</span><span class="ident" id="1482958">oldbuckets</span>&nbsp;<span class="op" id="1482969">=</span>&nbsp;<span class="ident" id="1482971">nil</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1482980">}</span><br>
<span class="lineno"></span><span class="op" id="1482982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1482985">func</span>&nbsp;<span class="ident" id="1482990">ismapkey</span><span class="op" id="1482998">(</span><span class="ident" id="1482999">t</span>&nbsp;<span class="op" id="1483001">*</span><span class="ident" id="1483002">_type</span><span class="op" id="1483007">)</span>&nbsp;<span class="builtintype" id="1483009">bool</span>&nbsp;<span class="op" id="1483014">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483017">return</span>&nbsp;<span class="ident" id="1483024">goalg</span><span class="op" id="1483029">(</span><span class="ident" id="1483030">t</span><span class="op" id="1483031">.</span><span class="ident" id="1483032">alg</span><span class="op" id="1483035">)</span><span class="op" id="1483036">.</span><span class="ident" id="1483037">hash</span>&nbsp;<span class="op" id="1483042">!=</span>&nbsp;<span class="ident" id="1483045">nil</span><br>
<span class="lineno"></span><span class="op" id="1483049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1483052">//&nbsp;Reflect&nbsp;stubs.&nbsp;&nbsp;Called&nbsp;from&nbsp;../reflect/asm_*.s</span><br>
<span class="lineno"></span><br>
<span class="lineno">905</span><span class="keyword" id="1483103">func</span>&nbsp;<span class="ident" id="1483108">reflect_makemap</span><span class="op" id="1483123">(</span><span class="ident" id="1483124">t</span>&nbsp;<span class="op" id="1483126">*</span><span class="ident" id="1483127">maptype</span><span class="op" id="1483134">)</span>&nbsp;<span class="op" id="1483136">*</span><span class="ident" id="1483137">hmap</span>&nbsp;<span class="op" id="1483142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483145">return</span>&nbsp;<span class="ident" id="1483152">makemap</span><span class="op" id="1483159">(</span><span class="ident" id="1483160">t</span><span class="op" id="1483161">,</span>&nbsp;<span class="num" id="1483163">0</span><span class="op" id="1483164">)</span><br>
<span class="lineno"></span><span class="op" id="1483166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1483169">func</span>&nbsp;<span class="ident" id="1483174">reflect_mapaccess</span><span class="op" id="1483191">(</span><span class="ident" id="1483192">t</span>&nbsp;<span class="op" id="1483194">*</span><span class="ident" id="1483195">maptype</span><span class="op" id="1483202">,</span>&nbsp;<span class="ident" id="1483204">h</span>&nbsp;<span class="op" id="1483206">*</span><span class="ident" id="1483207">hmap</span><span class="op" id="1483211">,</span>&nbsp;<span class="ident" id="1483213">key</span>&nbsp;<span class="ident" id="1483217">unsafe</span><span class="op" id="1483223">.</span><span class="ident" id="1483224">Pointer</span><span class="op" id="1483231">)</span>&nbsp;<span class="ident" id="1483233">unsafe</span><span class="op" id="1483239">.</span><span class="ident" id="1483240">Pointer</span>&nbsp;<span class="op" id="1483248">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483251">val</span><span class="op" id="1483254">,</span>&nbsp;<span class="ident" id="1483256">ok</span>&nbsp;<span class="op" id="1483259">:=</span>&nbsp;<span class="ident" id="1483262">mapaccess2</span><span class="op" id="1483272">(</span><span class="ident" id="1483273">t</span><span class="op" id="1483274">,</span>&nbsp;<span class="ident" id="1483276">h</span><span class="op" id="1483277">,</span>&nbsp;<span class="ident" id="1483279">key</span><span class="op" id="1483282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483285">if</span>&nbsp;<span class="op" id="1483288">!</span><span class="ident" id="1483289">ok</span>&nbsp;<span class="op" id="1483292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1483296">//&nbsp;reflect&nbsp;wants&nbsp;nil&nbsp;for&nbsp;a&nbsp;missing&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483341">val</span>&nbsp;<span class="op" id="1483345">=</span>&nbsp;<span class="ident" id="1483347">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483352">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483355">return</span>&nbsp;<span class="ident" id="1483362">val</span><br>
<span class="lineno"></span><span class="op" id="1483366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1483369">func</span>&nbsp;<span class="ident" id="1483374">reflect_mapassign</span><span class="op" id="1483391">(</span><span class="ident" id="1483392">t</span>&nbsp;<span class="op" id="1483394">*</span><span class="ident" id="1483395">maptype</span><span class="op" id="1483402">,</span>&nbsp;<span class="ident" id="1483404">h</span>&nbsp;<span class="op" id="1483406">*</span><span class="ident" id="1483407">hmap</span><span class="op" id="1483411">,</span>&nbsp;<span class="ident" id="1483413">key</span>&nbsp;<span class="ident" id="1483417">unsafe</span><span class="op" id="1483423">.</span><span class="ident" id="1483424">Pointer</span><span class="op" id="1483431">,</span>&nbsp;<span class="ident" id="1483433">val</span>&nbsp;<span class="ident" id="1483437">unsafe</span><span class="op" id="1483443">.</span><span class="ident" id="1483444">Pointer</span><span class="op" id="1483451">)</span>&nbsp;<span class="op" id="1483453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483456">mapassign1</span><span class="op" id="1483466">(</span><span class="ident" id="1483467">t</span><span class="op" id="1483468">,</span>&nbsp;<span class="ident" id="1483470">h</span><span class="op" id="1483471">,</span>&nbsp;<span class="ident" id="1483473">key</span><span class="op" id="1483476">,</span>&nbsp;<span class="ident" id="1483478">val</span><span class="op" id="1483481">)</span><br>
<span class="lineno">920</span><span class="op" id="1483483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1483486">func</span>&nbsp;<span class="ident" id="1483491">reflect_mapdelete</span><span class="op" id="1483508">(</span><span class="ident" id="1483509">t</span>&nbsp;<span class="op" id="1483511">*</span><span class="ident" id="1483512">maptype</span><span class="op" id="1483519">,</span>&nbsp;<span class="ident" id="1483521">h</span>&nbsp;<span class="op" id="1483523">*</span><span class="ident" id="1483524">hmap</span><span class="op" id="1483528">,</span>&nbsp;<span class="ident" id="1483530">key</span>&nbsp;<span class="ident" id="1483534">unsafe</span><span class="op" id="1483540">.</span><span class="ident" id="1483541">Pointer</span><span class="op" id="1483548">)</span>&nbsp;<span class="op" id="1483550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483553">mapdelete</span><span class="op" id="1483562">(</span><span class="ident" id="1483563">t</span><span class="op" id="1483564">,</span>&nbsp;<span class="ident" id="1483566">h</span><span class="op" id="1483567">,</span>&nbsp;<span class="ident" id="1483569">key</span><span class="op" id="1483572">)</span><br>
<span class="lineno"></span><span class="op" id="1483574">}</span><br>
<span class="lineno">925</span><br>
<span class="lineno"></span><span class="keyword" id="1483577">func</span>&nbsp;<span class="ident" id="1483582">reflect_mapiterinit</span><span class="op" id="1483601">(</span><span class="ident" id="1483602">t</span>&nbsp;<span class="op" id="1483604">*</span><span class="ident" id="1483605">maptype</span><span class="op" id="1483612">,</span>&nbsp;<span class="ident" id="1483614">h</span>&nbsp;<span class="op" id="1483616">*</span><span class="ident" id="1483617">hmap</span><span class="op" id="1483621">)</span>&nbsp;<span class="op" id="1483623">*</span><span class="ident" id="1483624">hiter</span>&nbsp;<span class="op" id="1483630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483633">it</span>&nbsp;<span class="op" id="1483636">:=</span>&nbsp;<span class="builtinfunc" id="1483639">new</span><span class="op" id="1483642">(</span><span class="ident" id="1483643">hiter</span><span class="op" id="1483648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483651">mapiterinit</span><span class="op" id="1483662">(</span><span class="ident" id="1483663">t</span><span class="op" id="1483664">,</span>&nbsp;<span class="ident" id="1483666">h</span><span class="op" id="1483667">,</span>&nbsp;<span class="ident" id="1483669">it</span><span class="op" id="1483671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483674">return</span>&nbsp;<span class="ident" id="1483681">it</span><br>
<span class="lineno">930</span><span class="op" id="1483684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1483687">func</span>&nbsp;<span class="ident" id="1483692">reflect_mapiternext</span><span class="op" id="1483711">(</span><span class="ident" id="1483712">it</span>&nbsp;<span class="op" id="1483715">*</span><span class="ident" id="1483716">hiter</span><span class="op" id="1483721">)</span>&nbsp;<span class="op" id="1483723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483726">mapiternext</span><span class="op" id="1483737">(</span><span class="ident" id="1483738">it</span><span class="op" id="1483740">)</span><br>
<span class="lineno"></span><span class="op" id="1483742">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="keyword" id="1483745">func</span>&nbsp;<span class="ident" id="1483750">reflect_mapiterkey</span><span class="op" id="1483768">(</span><span class="ident" id="1483769">it</span>&nbsp;<span class="op" id="1483772">*</span><span class="ident" id="1483773">hiter</span><span class="op" id="1483778">)</span>&nbsp;<span class="ident" id="1483780">unsafe</span><span class="op" id="1483786">.</span><span class="ident" id="1483787">Pointer</span>&nbsp;<span class="op" id="1483795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483798">return</span>&nbsp;<span class="ident" id="1483805">it</span><span class="op" id="1483807">.</span><span class="ident" id="1483808">key</span><br>
<span class="lineno"></span><span class="op" id="1483812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">940</span><span class="keyword" id="1483815">func</span>&nbsp;<span class="ident" id="1483820">reflect_maplen</span><span class="op" id="1483834">(</span><span class="ident" id="1483835">h</span>&nbsp;<span class="op" id="1483837">*</span><span class="ident" id="1483838">hmap</span><span class="op" id="1483842">)</span>&nbsp;<span class="builtintype" id="1483844">int</span>&nbsp;<span class="op" id="1483848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483851">if</span>&nbsp;<span class="ident" id="1483854">h</span>&nbsp;<span class="op" id="1483856">==</span>&nbsp;<span class="ident" id="1483859">nil</span>&nbsp;<span class="op" id="1483863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483867">return</span>&nbsp;<span class="num" id="1483874">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1483877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1483880">if</span>&nbsp;<span class="ident" id="1483883">raceenabled</span>&nbsp;<span class="op" id="1483895">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483899">callerpc</span>&nbsp;<span class="op" id="1483908">:=</span>&nbsp;<span class="ident" id="1483911">getcallerpc</span><span class="op" id="1483922">(</span><span class="ident" id="1483923">unsafe</span><span class="op" id="1483929">.</span><span class="ident" id="1483930">Pointer</span><span class="op" id="1483937">(</span><span class="op" id="1483938">&amp;</span><span class="ident" id="1483939">h</span><span class="op" id="1483940">)</span><span class="op" id="1483941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1483945">racereadpc</span><span class="op" id="1483955">(</span><span class="ident" id="1483956">unsafe</span><span class="op" id="1483962">.</span><span class="ident" id="1483963">Pointer</span><span class="op" id="1483970">(</span><span class="ident" id="1483971">h</span><span class="op" id="1483972">)</span><span class="op" id="1483973">,</span>&nbsp;<span class="ident" id="1483975">callerpc</span><span class="op" id="1483983">,</span>&nbsp;<span class="ident" id="1483985">funcPC</span><span class="op" id="1483991">(</span><span class="ident" id="1483992">reflect_maplen</span><span class="op" id="1484006">)</span><span class="op" id="1484007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1484010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484013">return</span>&nbsp;<span class="ident" id="1484020">h</span><span class="op" id="1484021">.</span><span class="ident" id="1484022">count</span><br>
<span class="lineno"></span><span class="op" id="1484028">}</span><br>
<span class="lineno">950</span><br>
<span class="lineno"></span><span class="keyword" id="1484031">func</span>&nbsp;<span class="ident" id="1484036">reflect_ismapkey</span><span class="op" id="1484052">(</span><span class="ident" id="1484053">t</span>&nbsp;<span class="op" id="1484055">*</span><span class="ident" id="1484056">_type</span><span class="op" id="1484061">)</span>&nbsp;<span class="builtintype" id="1484063">bool</span>&nbsp;<span class="op" id="1484068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1484071">return</span>&nbsp;<span class="ident" id="1484078">ismapkey</span><span class="op" id="1484086">(</span><span class="ident" id="1484087">t</span><span class="op" id="1484088">)</span><br>
<span class="lineno"></span><span class="op" id="1484090">}</span>
</div>
</body>
</html>
