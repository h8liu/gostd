<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3841811">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3841866">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3841920">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3841971">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3842017">package</span>&nbsp;<span class="ident" id="3842025">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3842030">import</span>&nbsp;<span class="op" id="3842037">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842040">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842049">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842066">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842083">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842098">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842108">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842115">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842121">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842128">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3842136">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3842143">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3842146">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3842189">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3842230">type</span>&nbsp;<span class="ident" id="3842235">Conn</span>&nbsp;<span class="keyword" id="3842240">struct</span>&nbsp;<span class="op" id="3842247">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3842250">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842263">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3842272"><a href="/crypto/tls/conn.go.html#3842121">net</a></span><span class="op" id="3842275">.</span><span class="ident" id="3842276">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842282">isClient</span>&nbsp;<span class="builtintype" id="3842291">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3842298">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842356">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3842374"><a href="/crypto/tls/conn.go.html#3842128">sync</a></span><span class="op" id="3842378">.</span><span class="ident" id="3842379">Mutex</span>&nbsp;<span class="comment" id="3842385">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842436">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3842454">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3842465">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842500">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3842518">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3842529">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842545">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3842563">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3842574">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842606">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3842624">*</span><span class="ident" id="3842625"><a href="/crypto/tls/common.go.html#3830813">Config</a></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3842635">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842675">handshakeComplete</span>&nbsp;<span class="builtintype" id="3842693">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842699">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3842717">bool</span>&nbsp;<span class="comment" id="3842722">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842775">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3842793">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842801">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3842819">[</span><span class="op" id="3842820">]</span><span class="builtintype" id="3842821">byte</span>&nbsp;<span class="comment" id="3842826">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842852">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="3842870">[</span><span class="op" id="3842871">]</span><span class="op" id="3842872">*</span><span class="ident" id="3842873"><a href="/crypto/tls/conn.go.html#3842083">x509</a></span><span class="op" id="3842877">.</span><span class="ident" id="3842878">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3842891">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3842960">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843009">verifiedChains</span>&nbsp;<span class="op" id="3843024">[</span><span class="op" id="3843025">]</span><span class="op" id="3843026">[</span><span class="op" id="3843027">]</span><span class="op" id="3843028">*</span><span class="ident" id="3843029"><a href="/crypto/tls/conn.go.html#3842083">x509</a></span><span class="op" id="3843033">.</span><span class="ident" id="3843034">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3843047">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843120">serverName</span>&nbsp;<span class="builtintype" id="3843131">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3843139">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3843206">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843269">firstFinished</span>&nbsp;<span class="op" id="3843283">[</span><span class="num" id="3843284">12</span><span class="op" id="3843286">]</span><span class="builtintype" id="3843287">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843294">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3843317">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843325">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="3843348">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3843355">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843372">in</span><span class="op" id="3843374">,</span>&nbsp;<span class="ident" id="3843376">out</span>&nbsp;&nbsp;<span class="ident" id="3843381"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3843394">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843419">rawInput</span>&nbsp;<span class="op" id="3843428">*</span><span class="ident" id="3843429"><a href="/crypto/tls/conn.go.html#3853853">block</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3843441">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843475">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3843484">*</span><span class="ident" id="3843485"><a href="/crypto/tls/conn.go.html#3853853">block</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3843497">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843537">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3843546"><a href="/crypto/tls/conn.go.html#3842040">bytes</a></span><span class="op" id="3843551">.</span><span class="ident" id="3843552">Buffer</span>&nbsp;<span class="comment" id="3843559">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843598">tmp</span>&nbsp;<span class="op" id="3843602">[</span><span class="num" id="3843603">16</span><span class="op" id="3843605">]</span><span class="builtintype" id="3843606">byte</span><br>
<span class="lineno"></span><span class="op" id="3843611">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3843614">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="3843645">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="3843694">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3843727">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3843775">func</span>&nbsp;<span class="op" id="3843780">(</span><span class="ident" id="3843781">c</span>&nbsp;<span class="op" id="3843783">*</span><span class="ident" id="3843784"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3843788">)</span>&nbsp;<span class="ident" id="3843790">LocalAddr</span><span class="op" id="3843799">(</span><span class="op" id="3843800">)</span>&nbsp;<span class="ident" id="3843802"><a href="/crypto/tls/conn.go.html#3842121">net</a></span><span class="op" id="3843805">.</span><span class="ident" id="3843806">Addr</span>&nbsp;<span class="op" id="3843811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843814">return</span>&nbsp;<span class="ident" id="3843821"><a href="/crypto/tls/conn.go.html#3843781">c</a></span><span class="op" id="3843822">.</span><span class="ident" id="3843823">conn</span><span class="op" id="3843827">.</span><span class="ident" id="3843828">LocalAddr</span><span class="op" id="3843837">(</span><span class="op" id="3843838">)</span><br>
<span class="lineno"></span><span class="op" id="3843840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="3843843">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3843893">func</span>&nbsp;<span class="op" id="3843898">(</span><span class="ident" id="3843899">c</span>&nbsp;<span class="op" id="3843901">*</span><span class="ident" id="3843902"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3843906">)</span>&nbsp;<span class="ident" id="3843908">RemoteAddr</span><span class="op" id="3843918">(</span><span class="op" id="3843919">)</span>&nbsp;<span class="ident" id="3843921"><a href="/crypto/tls/conn.go.html#3842121">net</a></span><span class="op" id="3843924">.</span><span class="ident" id="3843925">Addr</span>&nbsp;<span class="op" id="3843930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843933">return</span>&nbsp;<span class="ident" id="3843940"><a href="/crypto/tls/conn.go.html#3843899">c</a></span><span class="op" id="3843941">.</span><span class="ident" id="3843942">conn</span><span class="op" id="3843946">.</span><span class="ident" id="3843947">RemoteAddr</span><span class="op" id="3843957">(</span><span class="op" id="3843958">)</span><br>
<span class="lineno"></span><span class="op" id="3843960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3843963">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3844044">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3844106">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3844213">func</span>&nbsp;<span class="op" id="3844218">(</span><span class="ident" id="3844219">c</span>&nbsp;<span class="op" id="3844221">*</span><span class="ident" id="3844222"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3844226">)</span>&nbsp;<span class="ident" id="3844228">SetDeadline</span><span class="op" id="3844239">(</span><span class="ident" id="3844240">t</span>&nbsp;<span class="ident" id="3844242"><a href="/crypto/tls/conn.go.html#3842136">time</a></span><span class="op" id="3844246">.</span><span class="ident" id="3844247">Time</span><span class="op" id="3844251">)</span>&nbsp;<span class="builtintype" id="3844253">error</span>&nbsp;<span class="op" id="3844259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844262">return</span>&nbsp;<span class="ident" id="3844269"><a href="/crypto/tls/conn.go.html#3844219">c</a></span><span class="op" id="3844270">.</span><span class="ident" id="3844271">conn</span><span class="op" id="3844275">.</span><span class="ident" id="3844276">SetDeadline</span><span class="op" id="3844287">(</span><span class="ident" id="3844288"><a href="/crypto/tls/conn.go.html#3844240">t</a></span><span class="op" id="3844289">)</span><br>
<span class="lineno">80</span><span class="op" id="3844291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3844294">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3844366">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3844418">func</span>&nbsp;<span class="op" id="3844423">(</span><span class="ident" id="3844424">c</span>&nbsp;<span class="op" id="3844426">*</span><span class="ident" id="3844427"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3844431">)</span>&nbsp;<span class="ident" id="3844433">SetReadDeadline</span><span class="op" id="3844448">(</span><span class="ident" id="3844449">t</span>&nbsp;<span class="ident" id="3844451"><a href="/crypto/tls/conn.go.html#3842136">time</a></span><span class="op" id="3844455">.</span><span class="ident" id="3844456">Time</span><span class="op" id="3844460">)</span>&nbsp;<span class="builtintype" id="3844462">error</span>&nbsp;<span class="op" id="3844468">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844471">return</span>&nbsp;<span class="ident" id="3844478"><a href="/crypto/tls/conn.go.html#3844424">c</a></span><span class="op" id="3844479">.</span><span class="ident" id="3844480">conn</span><span class="op" id="3844484">.</span><span class="ident" id="3844485">SetReadDeadline</span><span class="op" id="3844500">(</span><span class="ident" id="3844501"><a href="/crypto/tls/conn.go.html#3844449">t</a></span><span class="op" id="3844502">)</span><br>
<span class="lineno"></span><span class="op" id="3844504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3844507">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3844581">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="3844634">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3844741">func</span>&nbsp;<span class="op" id="3844746">(</span><span class="ident" id="3844747">c</span>&nbsp;<span class="op" id="3844749">*</span><span class="ident" id="3844750"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3844754">)</span>&nbsp;<span class="ident" id="3844756">SetWriteDeadline</span><span class="op" id="3844772">(</span><span class="ident" id="3844773">t</span>&nbsp;<span class="ident" id="3844775"><a href="/crypto/tls/conn.go.html#3842136">time</a></span><span class="op" id="3844779">.</span><span class="ident" id="3844780">Time</span><span class="op" id="3844784">)</span>&nbsp;<span class="builtintype" id="3844786">error</span>&nbsp;<span class="op" id="3844792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844795">return</span>&nbsp;<span class="ident" id="3844802"><a href="/crypto/tls/conn.go.html#3844747">c</a></span><span class="op" id="3844803">.</span><span class="ident" id="3844804">conn</span><span class="op" id="3844808">.</span><span class="ident" id="3844809">SetWriteDeadline</span><span class="op" id="3844825">(</span><span class="ident" id="3844826"><a href="/crypto/tls/conn.go.html#3844773">t</a></span><span class="op" id="3844827">)</span><br>
<span class="lineno"></span><span class="op" id="3844829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3844832">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="3844891">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="3844935">type</span>&nbsp;<span class="ident" id="3844940">halfConn</span>&nbsp;<span class="keyword" id="3844949">struct</span>&nbsp;<span class="op" id="3844956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844959"><a href="/crypto/tls/conn.go.html#3842128">sync</a></span><span class="op" id="3844963">.</span><span class="ident" id="3844964">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844972">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3844980">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3844992">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845018">version</span>&nbsp;<span class="builtintype" id="3845026">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3845038">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845059">cipher</span>&nbsp;&nbsp;<span class="keyword" id="3845067">interface</span><span class="op" id="3845076">{</span><span class="op" id="3845077">}</span>&nbsp;<span class="comment" id="3845079">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845100">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3845108"><a href="/crypto/tls/cipher_suites.go.html#3817704">macFunction</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845121">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3845129">[</span><span class="num" id="3845130">8</span><span class="op" id="3845131">]</span><span class="builtintype" id="3845132">byte</span>&nbsp;<span class="comment" id="3845137">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845164">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3845172">*</span><span class="ident" id="3845173"><a href="/crypto/tls/conn.go.html#3853853">block</a></span>&nbsp;&nbsp;<span class="comment" id="3845180">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845205">nextCipher</span>&nbsp;<span class="keyword" id="3845216">interface</span><span class="op" id="3845225">{</span><span class="op" id="3845226">}</span>&nbsp;<span class="comment" id="3845228">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845254">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3845265"><a href="/crypto/tls/cipher_suites.go.html#3817704">macFunction</a></span>&nbsp;<span class="comment" id="3845277">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845301">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845356">inDigestBuf</span><span class="op" id="3845367">,</span>&nbsp;<span class="ident" id="3845369">outDigestBuf</span>&nbsp;<span class="op" id="3845382">[</span><span class="op" id="3845383">]</span><span class="builtintype" id="3845384">byte</span><br>
<span class="lineno"></span><span class="op" id="3845389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3845392">func</span>&nbsp;<span class="op" id="3845397">(</span><span class="ident" id="3845398">hc</span>&nbsp;<span class="op" id="3845401">*</span><span class="ident" id="3845402"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span><span class="op" id="3845410">)</span>&nbsp;<span class="ident" id="3845412">setErrorLocked</span><span class="op" id="3845426">(</span><span class="ident" id="3845427">err</span>&nbsp;<span class="builtintype" id="3845431">error</span><span class="op" id="3845436">)</span>&nbsp;<span class="builtintype" id="3845438">error</span>&nbsp;<span class="op" id="3845444">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845447"><a href="/crypto/tls/conn.go.html#3845398">hc</a></span><span class="op" id="3845449">.</span><span class="ident" id="3845450">err</span>&nbsp;<span class="op" id="3845454">=</span>&nbsp;<span class="ident" id="3845456"><a href="/crypto/tls/conn.go.html#3845427">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845461">return</span>&nbsp;<span class="ident" id="3845468"><a href="/crypto/tls/conn.go.html#3845427">err</a></span><br>
<span class="lineno"></span><span class="op" id="3845472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3845475">func</span>&nbsp;<span class="op" id="3845480">(</span><span class="ident" id="3845481">hc</span>&nbsp;<span class="op" id="3845484">*</span><span class="ident" id="3845485"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span><span class="op" id="3845493">)</span>&nbsp;<span class="builtintype" id="3845495">error</span><span class="op" id="3845500">(</span><span class="op" id="3845501">)</span>&nbsp;<span class="builtintype" id="3845503">error</span>&nbsp;<span class="op" id="3845509">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845512"><a href="/crypto/tls/conn.go.html#3845481">hc</a></span><span class="op" id="3845514">.</span><span class="ident" id="3845515">Lock</span><span class="op" id="3845519">(</span><span class="op" id="3845520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845523">err</span>&nbsp;<span class="op" id="3845527">:=</span>&nbsp;<span class="ident" id="3845530"><a href="/crypto/tls/conn.go.html#3845481">hc</a></span><span class="op" id="3845532">.</span><span class="ident" id="3845533">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845538"><a href="/crypto/tls/conn.go.html#3845481">hc</a></span><span class="op" id="3845540">.</span><span class="ident" id="3845541">Unlock</span><span class="op" id="3845547">(</span><span class="op" id="3845548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845551">return</span>&nbsp;<span class="ident" id="3845558"><a href="/crypto/tls/conn.go.html#3845523">err</a></span><br>
<span class="lineno"></span><span class="op" id="3845562">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="3845565">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="3845621">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3845669">func</span>&nbsp;<span class="op" id="3845674">(</span><span class="ident" id="3845675">hc</span>&nbsp;<span class="op" id="3845678">*</span><span class="ident" id="3845679"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span><span class="op" id="3845687">)</span>&nbsp;<span class="ident" id="3845689">prepareCipherSpec</span><span class="op" id="3845706">(</span><span class="ident" id="3845707">version</span>&nbsp;<span class="builtintype" id="3845715">uint16</span><span class="op" id="3845721">,</span>&nbsp;<span class="ident" id="3845723">cipher</span>&nbsp;<span class="keyword" id="3845730">interface</span><span class="op" id="3845739">{</span><span class="op" id="3845740">}</span><span class="op" id="3845741">,</span>&nbsp;<span class="ident" id="3845743">mac</span>&nbsp;<span class="ident" id="3845747"><a href="/crypto/tls/cipher_suites.go.html#3817704">macFunction</a></span><span class="op" id="3845758">)</span>&nbsp;<span class="op" id="3845760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845763"><a href="/crypto/tls/conn.go.html#3845675">hc</a></span><span class="op" id="3845765">.</span><span class="ident" id="3845766">version</span>&nbsp;<span class="op" id="3845774">=</span>&nbsp;<span class="ident" id="3845776"><a href="/crypto/tls/conn.go.html#3845707">version</a></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845785"><a href="/crypto/tls/conn.go.html#3845675">hc</a></span><span class="op" id="3845787">.</span><span class="ident" id="3845788">nextCipher</span>&nbsp;<span class="op" id="3845799">=</span>&nbsp;<span class="ident" id="3845801"><a href="/crypto/tls/conn.go.html#3845723">cipher</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845809"><a href="/crypto/tls/conn.go.html#3845675">hc</a></span><span class="op" id="3845811">.</span><span class="ident" id="3845812">nextMac</span>&nbsp;<span class="op" id="3845820">=</span>&nbsp;<span class="ident" id="3845822"><a href="/crypto/tls/conn.go.html#3845743">mac</a></span><br>
<span class="lineno"></span><span class="op" id="3845826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3845829">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="3845887">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="3845942">func</span>&nbsp;<span class="op" id="3845947">(</span><span class="ident" id="3845948">hc</span>&nbsp;<span class="op" id="3845951">*</span><span class="ident" id="3845952"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span><span class="op" id="3845960">)</span>&nbsp;<span class="ident" id="3845962">changeCipherSpec</span><span class="op" id="3845978">(</span><span class="op" id="3845979">)</span>&nbsp;<span class="builtintype" id="3845981">error</span>&nbsp;<span class="op" id="3845987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845990">if</span>&nbsp;<span class="ident" id="3845993"><a href="/crypto/tls/conn.go.html#3845948">hc</a></span><span class="op" id="3845995">.</span><span class="ident" id="3845996">nextCipher</span>&nbsp;<span class="op" id="3846007">==</span>&nbsp;<span class="ident" id="3846010">nil</span>&nbsp;<span class="op" id="3846014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846018">return</span>&nbsp;<span class="ident" id="3846025"><a href="/crypto/tls/alert.go.html#3811348">alertInternalError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846045">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846048"><a href="/crypto/tls/conn.go.html#3845948">hc</a></span><span class="op" id="3846050">.</span><span class="ident" id="3846051">cipher</span>&nbsp;<span class="op" id="3846058">=</span>&nbsp;<span class="ident" id="3846060"><a href="/crypto/tls/conn.go.html#3845948">hc</a></span><span class="op" id="3846062">.</span><span class="ident" id="3846063">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846075"><a href="/crypto/tls/conn.go.html#3845948">hc</a></span><span class="op" id="3846077">.</span><span class="ident" id="3846078">mac</span>&nbsp;<span class="op" id="3846082">=</span>&nbsp;<span class="ident" id="3846084"><a href="/crypto/tls/conn.go.html#3845948">hc</a></span><span class="op" id="3846086">.</span><span class="ident" id="3846087">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846096"><a href="/crypto/tls/conn.go.html#3845948">hc</a></span><span class="op" id="3846098">.</span><span class="ident" id="3846099">nextCipher</span>&nbsp;<span class="op" id="3846110">=</span>&nbsp;<span class="ident" id="3846112">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846117"><a href="/crypto/tls/conn.go.html#3845948">hc</a></span><span class="op" id="3846119">.</span><span class="ident" id="3846120">nextMac</span>&nbsp;<span class="op" id="3846128">=</span>&nbsp;<span class="ident" id="3846130">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846135">for</span>&nbsp;<span class="ident" id="3846139">i</span>&nbsp;<span class="op" id="3846141">:=</span>&nbsp;<span class="keyword" id="3846144">range</span>&nbsp;<span class="ident" id="3846150"><a href="/crypto/tls/conn.go.html#3845948">hc</a></span><span class="op" id="3846152">.</span><span class="ident" id="3846153">seq</span>&nbsp;<span class="op" id="3846157">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846161"><a href="/crypto/tls/conn.go.html#3845948">hc</a></span><span class="op" id="3846163">.</span><span class="ident" id="3846164">seq</span><span class="op" id="3846167">[</span><span class="ident" id="3846168"><a href="/crypto/tls/conn.go.html#3846139">i</a></span><span class="op" id="3846169">]</span>&nbsp;<span class="op" id="3846171">=</span>&nbsp;<span class="num" id="3846173">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846179">return</span>&nbsp;<span class="ident" id="3846186">nil</span><br>
<span class="lineno"></span><span class="op" id="3846190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="3846193">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="3846235">func</span>&nbsp;<span class="op" id="3846240">(</span><span class="ident" id="3846241">hc</span>&nbsp;<span class="op" id="3846244">*</span><span class="ident" id="3846245"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span><span class="op" id="3846253">)</span>&nbsp;<span class="ident" id="3846255">incSeq</span><span class="op" id="3846261">(</span><span class="op" id="3846262">)</span>&nbsp;<span class="op" id="3846264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846267">for</span>&nbsp;<span class="ident" id="3846271">i</span>&nbsp;<span class="op" id="3846273">:=</span>&nbsp;<span class="num" id="3846276">7</span><span class="op" id="3846277">;</span>&nbsp;<span class="ident" id="3846279"><a href="/crypto/tls/conn.go.html#3846271">i</a></span>&nbsp;<span class="op" id="3846281">&gt;=</span>&nbsp;<span class="num" id="3846284">0</span><span class="op" id="3846285">;</span>&nbsp;<span class="ident" id="3846287"><a href="/crypto/tls/conn.go.html#3846271">i</a></span><span class="op" id="3846288">--</span>&nbsp;<span class="op" id="3846291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846295"><a href="/crypto/tls/conn.go.html#3846241">hc</a></span><span class="op" id="3846297">.</span><span class="ident" id="3846298">seq</span><span class="op" id="3846301">[</span><span class="ident" id="3846302"><a href="/crypto/tls/conn.go.html#3846271">i</a></span><span class="op" id="3846303">]</span><span class="op" id="3846304">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846309">if</span>&nbsp;<span class="ident" id="3846312"><a href="/crypto/tls/conn.go.html#3846241">hc</a></span><span class="op" id="3846314">.</span><span class="ident" id="3846315">seq</span><span class="op" id="3846318">[</span><span class="ident" id="3846319"><a href="/crypto/tls/conn.go.html#3846271">i</a></span><span class="op" id="3846320">]</span>&nbsp;<span class="op" id="3846322">!=</span>&nbsp;<span class="num" id="3846325">0</span>&nbsp;<span class="op" id="3846327">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846332">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846344">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846348">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846393">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846439">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3846472">panic</span><span class="op" id="3846477">(</span><span class="string" id="3846478">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="3846511">)</span><br>
<span class="lineno"></span><span class="op" id="3846513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3846516">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="3846564">func</span>&nbsp;<span class="op" id="3846569">(</span><span class="ident" id="3846570">hc</span>&nbsp;<span class="op" id="3846573">*</span><span class="ident" id="3846574"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span><span class="op" id="3846582">)</span>&nbsp;<span class="ident" id="3846584">resetSeq</span><span class="op" id="3846592">(</span><span class="op" id="3846593">)</span>&nbsp;<span class="op" id="3846595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846598">for</span>&nbsp;<span class="ident" id="3846602">i</span>&nbsp;<span class="op" id="3846604">:=</span>&nbsp;<span class="keyword" id="3846607">range</span>&nbsp;<span class="ident" id="3846613"><a href="/crypto/tls/conn.go.html#3846570">hc</a></span><span class="op" id="3846615">.</span><span class="ident" id="3846616">seq</span>&nbsp;<span class="op" id="3846620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846624"><a href="/crypto/tls/conn.go.html#3846570">hc</a></span><span class="op" id="3846626">.</span><span class="ident" id="3846627">seq</span><span class="op" id="3846630">[</span><span class="ident" id="3846631"><a href="/crypto/tls/conn.go.html#3846602">i</a></span><span class="op" id="3846632">]</span>&nbsp;<span class="op" id="3846634">=</span>&nbsp;<span class="num" id="3846636">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846639">}</span><br>
<span class="lineno">170</span><span class="op" id="3846641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3846644">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="3846724">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3846801">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="3846861">func</span>&nbsp;<span class="ident" id="3846866">removePadding</span><span class="op" id="3846879">(</span><span class="ident" id="3846880">payload</span>&nbsp;<span class="op" id="3846888">[</span><span class="op" id="3846889">]</span><span class="builtintype" id="3846890">byte</span><span class="op" id="3846894">)</span>&nbsp;<span class="op" id="3846896">(</span><span class="op" id="3846897">[</span><span class="op" id="3846898">]</span><span class="builtintype" id="3846899">byte</span><span class="op" id="3846903">,</span>&nbsp;<span class="builtintype" id="3846905">byte</span><span class="op" id="3846909">)</span>&nbsp;<span class="op" id="3846911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846914">if</span>&nbsp;<span class="builtinfunc" id="3846917">len</span><span class="op" id="3846920">(</span><span class="ident" id="3846921"><a href="/crypto/tls/conn.go.html#3846880">payload</a></span><span class="op" id="3846928">)</span>&nbsp;<span class="op" id="3846930">&lt;</span>&nbsp;<span class="num" id="3846932">1</span>&nbsp;<span class="op" id="3846934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846938">return</span>&nbsp;<span class="ident" id="3846945"><a href="/crypto/tls/conn.go.html#3846880">payload</a></span><span class="op" id="3846952">,</span>&nbsp;<span class="num" id="3846954">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846961">paddingLen</span>&nbsp;<span class="op" id="3846972">:=</span>&nbsp;<span class="ident" id="3846975"><a href="/crypto/tls/conn.go.html#3846880">payload</a></span><span class="op" id="3846982">[</span><span class="builtinfunc" id="3846983">len</span><span class="op" id="3846986">(</span><span class="ident" id="3846987"><a href="/crypto/tls/conn.go.html#3846880">payload</a></span><span class="op" id="3846994">)</span><span class="op" id="3846995">-</span><span class="num" id="3846996">1</span><span class="op" id="3846997">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847000">t</span>&nbsp;<span class="op" id="3847002">:=</span>&nbsp;<span class="builtintype" id="3847005">uint</span><span class="op" id="3847009">(</span><span class="builtinfunc" id="3847010">len</span><span class="op" id="3847013">(</span><span class="ident" id="3847014"><a href="/crypto/tls/conn.go.html#3846880">payload</a></span><span class="op" id="3847021">)</span><span class="op" id="3847022">-</span><span class="num" id="3847023">1</span><span class="op" id="3847024">)</span>&nbsp;<span class="op" id="3847026">-</span>&nbsp;<span class="builtintype" id="3847028">uint</span><span class="op" id="3847032">(</span><span class="ident" id="3847033"><a href="/crypto/tls/conn.go.html#3846961">paddingLen</a></span><span class="op" id="3847043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847046">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847112">good</span>&nbsp;<span class="op" id="3847117">:=</span>&nbsp;<span class="builtintype" id="3847120">byte</span><span class="op" id="3847124">(</span><span class="builtintype" id="3847125">int32</span><span class="op" id="3847130">(</span><span class="op" id="3847131">^</span><span class="ident" id="3847132"><a href="/crypto/tls/conn.go.html#3847000">t</a></span><span class="op" id="3847133">)</span>&nbsp;<span class="op" id="3847135">&gt;&gt;</span>&nbsp;<span class="num" id="3847138">31</span><span class="op" id="3847140">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847144">toCheck</span>&nbsp;<span class="op" id="3847152">:=</span>&nbsp;<span class="num" id="3847155">255</span>&nbsp;<span class="comment" id="3847159">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847199">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847269">if</span>&nbsp;<span class="ident" id="3847272"><a href="/crypto/tls/conn.go.html#3847144">toCheck</a></span><span class="op" id="3847279">+</span><span class="num" id="3847280">1</span>&nbsp;<span class="op" id="3847282">&gt;</span>&nbsp;<span class="builtinfunc" id="3847284">len</span><span class="op" id="3847287">(</span><span class="ident" id="3847288"><a href="/crypto/tls/conn.go.html#3846880">payload</a></span><span class="op" id="3847295">)</span>&nbsp;<span class="op" id="3847297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847301"><a href="/crypto/tls/conn.go.html#3847144">toCheck</a></span>&nbsp;<span class="op" id="3847309">=</span>&nbsp;<span class="builtinfunc" id="3847311">len</span><span class="op" id="3847314">(</span><span class="ident" id="3847315"><a href="/crypto/tls/conn.go.html#3846880">payload</a></span><span class="op" id="3847322">)</span>&nbsp;<span class="op" id="3847324">-</span>&nbsp;<span class="num" id="3847326">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847329">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847333">for</span>&nbsp;<span class="ident" id="3847337">i</span>&nbsp;<span class="op" id="3847339">:=</span>&nbsp;<span class="num" id="3847342">0</span><span class="op" id="3847343">;</span>&nbsp;<span class="ident" id="3847345"><a href="/crypto/tls/conn.go.html#3847337">i</a></span>&nbsp;<span class="op" id="3847347">&lt;</span>&nbsp;<span class="ident" id="3847349"><a href="/crypto/tls/conn.go.html#3847144">toCheck</a></span><span class="op" id="3847356">;</span>&nbsp;<span class="ident" id="3847358"><a href="/crypto/tls/conn.go.html#3847337">i</a></span><span class="op" id="3847359">++</span>&nbsp;<span class="op" id="3847362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847366">t</span>&nbsp;<span class="op" id="3847368">:=</span>&nbsp;<span class="builtintype" id="3847371">uint</span><span class="op" id="3847375">(</span><span class="ident" id="3847376"><a href="/crypto/tls/conn.go.html#3846961">paddingLen</a></span><span class="op" id="3847386">)</span>&nbsp;<span class="op" id="3847388">-</span>&nbsp;<span class="builtintype" id="3847390">uint</span><span class="op" id="3847394">(</span><span class="ident" id="3847395"><a href="/crypto/tls/conn.go.html#3847337">i</a></span><span class="op" id="3847396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847400">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847450">mask</span>&nbsp;<span class="op" id="3847455">:=</span>&nbsp;<span class="builtintype" id="3847458">byte</span><span class="op" id="3847462">(</span><span class="builtintype" id="3847463">int32</span><span class="op" id="3847468">(</span><span class="op" id="3847469">^</span><span class="ident" id="3847470"><a href="/crypto/tls/conn.go.html#3847366">t</a></span><span class="op" id="3847471">)</span>&nbsp;<span class="op" id="3847473">&gt;&gt;</span>&nbsp;<span class="num" id="3847476">31</span><span class="op" id="3847478">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847482">b</span>&nbsp;<span class="op" id="3847484">:=</span>&nbsp;<span class="ident" id="3847487"><a href="/crypto/tls/conn.go.html#3846880">payload</a></span><span class="op" id="3847494">[</span><span class="builtinfunc" id="3847495">len</span><span class="op" id="3847498">(</span><span class="ident" id="3847499"><a href="/crypto/tls/conn.go.html#3846880">payload</a></span><span class="op" id="3847506">)</span><span class="op" id="3847507">-</span><span class="num" id="3847508">1</span><span class="op" id="3847509">-</span><span class="ident" id="3847510"><a href="/crypto/tls/conn.go.html#3847337">i</a></span><span class="op" id="3847511">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847515"><a href="/crypto/tls/conn.go.html#3847112">good</a></span>&nbsp;<span class="op" id="3847520">&amp;^=</span>&nbsp;<span class="ident" id="3847524"><a href="/crypto/tls/conn.go.html#3847450">mask</a></span><span class="op" id="3847528">&amp;</span><span class="ident" id="3847529"><a href="/crypto/tls/conn.go.html#3846961">paddingLen</a></span>&nbsp;<span class="op" id="3847540">^</span>&nbsp;<span class="ident" id="3847542"><a href="/crypto/tls/conn.go.html#3847450">mask</a></span><span class="op" id="3847546">&amp;</span><span class="ident" id="3847547"><a href="/crypto/tls/conn.go.html#3847482">b</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847554">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847623">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847641"><a href="/crypto/tls/conn.go.html#3847112">good</a></span>&nbsp;<span class="op" id="3847646">&amp;=</span>&nbsp;<span class="ident" id="3847649"><a href="/crypto/tls/conn.go.html#3847112">good</a></span>&nbsp;<span class="op" id="3847654">&lt;&lt;</span>&nbsp;<span class="num" id="3847657">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847660"><a href="/crypto/tls/conn.go.html#3847112">good</a></span>&nbsp;<span class="op" id="3847665">&amp;=</span>&nbsp;<span class="ident" id="3847668"><a href="/crypto/tls/conn.go.html#3847112">good</a></span>&nbsp;<span class="op" id="3847673">&lt;&lt;</span>&nbsp;<span class="num" id="3847676">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847679"><a href="/crypto/tls/conn.go.html#3847112">good</a></span>&nbsp;<span class="op" id="3847684">&amp;=</span>&nbsp;<span class="ident" id="3847687"><a href="/crypto/tls/conn.go.html#3847112">good</a></span>&nbsp;<span class="op" id="3847692">&lt;&lt;</span>&nbsp;<span class="num" id="3847695">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847698"><a href="/crypto/tls/conn.go.html#3847112">good</a></span>&nbsp;<span class="op" id="3847703">=</span>&nbsp;<span class="builtintype" id="3847705">uint8</span><span class="op" id="3847710">(</span><span class="builtintype" id="3847711">int8</span><span class="op" id="3847715">(</span><span class="ident" id="3847716"><a href="/crypto/tls/conn.go.html#3847112">good</a></span><span class="op" id="3847720">)</span>&nbsp;<span class="op" id="3847722">&gt;&gt;</span>&nbsp;<span class="num" id="3847725">7</span><span class="op" id="3847726">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847730">toRemove</span>&nbsp;<span class="op" id="3847739">:=</span>&nbsp;<span class="ident" id="3847742"><a href="/crypto/tls/conn.go.html#3847112">good</a></span><span class="op" id="3847746">&amp;</span><span class="ident" id="3847747"><a href="/crypto/tls/conn.go.html#3846961">paddingLen</a></span>&nbsp;<span class="op" id="3847758">+</span>&nbsp;<span class="num" id="3847760">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847763">return</span>&nbsp;<span class="ident" id="3847770"><a href="/crypto/tls/conn.go.html#3846880">payload</a></span><span class="op" id="3847777">[</span><span class="op" id="3847778">:</span><span class="builtinfunc" id="3847779">len</span><span class="op" id="3847782">(</span><span class="ident" id="3847783"><a href="/crypto/tls/conn.go.html#3846880">payload</a></span><span class="op" id="3847790">)</span><span class="op" id="3847791">-</span><span class="builtintype" id="3847792">int</span><span class="op" id="3847795">(</span><span class="ident" id="3847796"><a href="/crypto/tls/conn.go.html#3847730">toRemove</a></span><span class="op" id="3847804">)</span><span class="op" id="3847805">]</span><span class="op" id="3847806">,</span>&nbsp;<span class="ident" id="3847808"><a href="/crypto/tls/conn.go.html#3847112">good</a></span><br>
<span class="lineno"></span><span class="op" id="3847813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="3847816">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3847894">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3847969">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="3848006">func</span>&nbsp;<span class="ident" id="3848011">removePaddingSSL30</span><span class="op" id="3848029">(</span><span class="ident" id="3848030">payload</span>&nbsp;<span class="op" id="3848038">[</span><span class="op" id="3848039">]</span><span class="builtintype" id="3848040">byte</span><span class="op" id="3848044">)</span>&nbsp;<span class="op" id="3848046">(</span><span class="op" id="3848047">[</span><span class="op" id="3848048">]</span><span class="builtintype" id="3848049">byte</span><span class="op" id="3848053">,</span>&nbsp;<span class="builtintype" id="3848055">byte</span><span class="op" id="3848059">)</span>&nbsp;<span class="op" id="3848061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848064">if</span>&nbsp;<span class="builtinfunc" id="3848067">len</span><span class="op" id="3848070">(</span><span class="ident" id="3848071"><a href="/crypto/tls/conn.go.html#3848030">payload</a></span><span class="op" id="3848078">)</span>&nbsp;<span class="op" id="3848080">&lt;</span>&nbsp;<span class="num" id="3848082">1</span>&nbsp;<span class="op" id="3848084">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848088">return</span>&nbsp;<span class="ident" id="3848095"><a href="/crypto/tls/conn.go.html#3848030">payload</a></span><span class="op" id="3848102">,</span>&nbsp;<span class="num" id="3848104">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848111">paddingLen</span>&nbsp;<span class="op" id="3848122">:=</span>&nbsp;<span class="builtintype" id="3848125">int</span><span class="op" id="3848128">(</span><span class="ident" id="3848129"><a href="/crypto/tls/conn.go.html#3848030">payload</a></span><span class="op" id="3848136">[</span><span class="builtinfunc" id="3848137">len</span><span class="op" id="3848140">(</span><span class="ident" id="3848141"><a href="/crypto/tls/conn.go.html#3848030">payload</a></span><span class="op" id="3848148">)</span><span class="op" id="3848149">-</span><span class="num" id="3848150">1</span><span class="op" id="3848151">]</span><span class="op" id="3848152">)</span>&nbsp;<span class="op" id="3848154">+</span>&nbsp;<span class="num" id="3848156">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848159">if</span>&nbsp;<span class="ident" id="3848162"><a href="/crypto/tls/conn.go.html#3848111">paddingLen</a></span>&nbsp;<span class="op" id="3848173">&gt;</span>&nbsp;<span class="builtinfunc" id="3848175">len</span><span class="op" id="3848178">(</span><span class="ident" id="3848179"><a href="/crypto/tls/conn.go.html#3848030">payload</a></span><span class="op" id="3848186">)</span>&nbsp;<span class="op" id="3848188">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848192">return</span>&nbsp;<span class="ident" id="3848199"><a href="/crypto/tls/conn.go.html#3848030">payload</a></span><span class="op" id="3848206">,</span>&nbsp;<span class="num" id="3848208">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848215">return</span>&nbsp;<span class="ident" id="3848222"><a href="/crypto/tls/conn.go.html#3848030">payload</a></span><span class="op" id="3848229">[</span><span class="op" id="3848230">:</span><span class="builtinfunc" id="3848231">len</span><span class="op" id="3848234">(</span><span class="ident" id="3848235"><a href="/crypto/tls/conn.go.html#3848030">payload</a></span><span class="op" id="3848242">)</span><span class="op" id="3848243">-</span><span class="ident" id="3848244"><a href="/crypto/tls/conn.go.html#3848111">paddingLen</a></span><span class="op" id="3848254">]</span><span class="op" id="3848255">,</span>&nbsp;<span class="num" id="3848257">255</span><br>
<span class="lineno"></span><span class="op" id="3848261">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="3848264">func</span>&nbsp;<span class="ident" id="3848269">roundUp</span><span class="op" id="3848276">(</span><span class="ident" id="3848277">a</span><span class="op" id="3848278">,</span>&nbsp;<span class="ident" id="3848280">b</span>&nbsp;<span class="builtintype" id="3848282">int</span><span class="op" id="3848285">)</span>&nbsp;<span class="builtintype" id="3848287">int</span>&nbsp;<span class="op" id="3848291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848294">return</span>&nbsp;<span class="ident" id="3848301"><a href="/crypto/tls/conn.go.html#3848277">a</a></span>&nbsp;<span class="op" id="3848303">+</span>&nbsp;<span class="op" id="3848305">(</span><span class="ident" id="3848306"><a href="/crypto/tls/conn.go.html#3848280">b</a></span><span class="op" id="3848307">-</span><span class="ident" id="3848308"><a href="/crypto/tls/conn.go.html#3848277">a</a></span><span class="op" id="3848309">%</span><span class="ident" id="3848310"><a href="/crypto/tls/conn.go.html#3848280">b</a></span><span class="op" id="3848311">)</span><span class="op" id="3848312">%</span><span class="ident" id="3848313"><a href="/crypto/tls/conn.go.html#3848280">b</a></span><br>
<span class="lineno"></span><span class="op" id="3848315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="3848318">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="3848392">type</span>&nbsp;<span class="ident" id="3848397">cbcMode</span>&nbsp;<span class="keyword" id="3848405">interface</span>&nbsp;<span class="op" id="3848415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848418"><a href="/crypto/tls/conn.go.html#3842049">cipher</a></span><span class="op" id="3848424">.</span><span class="ident" id="3848425">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848436">SetIV</span><span class="op" id="3848441">(</span><span class="op" id="3848442">[</span><span class="op" id="3848443">]</span><span class="builtintype" id="3848444">byte</span><span class="op" id="3848448">)</span><br>
<span class="lineno"></span><span class="op" id="3848450">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3848453">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3848528">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3848608">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3848678">func</span>&nbsp;<span class="op" id="3848683">(</span><span class="ident" id="3848684">hc</span>&nbsp;<span class="op" id="3848687">*</span><span class="ident" id="3848688"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span><span class="op" id="3848696">)</span>&nbsp;<span class="ident" id="3848698">decrypt</span><span class="op" id="3848705">(</span><span class="ident" id="3848706">b</span>&nbsp;<span class="op" id="3848708">*</span><span class="ident" id="3848709"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><span class="op" id="3848714">)</span>&nbsp;<span class="op" id="3848716">(</span><span class="ident" id="3848717">ok</span>&nbsp;<span class="builtintype" id="3848720">bool</span><span class="op" id="3848724">,</span>&nbsp;<span class="ident" id="3848726">prefixLen</span>&nbsp;<span class="builtintype" id="3848736">int</span><span class="op" id="3848739">,</span>&nbsp;<span class="ident" id="3848741">alertValue</span>&nbsp;<span class="ident" id="3848752"><a href="/crypto/tls/alert.go.html#3810494">alert</a></span><span class="op" id="3848757">)</span>&nbsp;<span class="op" id="3848759">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848762">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848783">payload</span>&nbsp;<span class="op" id="3848791">:=</span>&nbsp;<span class="ident" id="3848794"><a href="/crypto/tls/conn.go.html#3848706">b</a></span><span class="op" id="3848795">.</span><span class="ident" id="3848796">data</span><span class="op" id="3848800">[</span><span class="ident" id="3848801"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3848816">:</span><span class="op" id="3848817">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848821">macSize</span>&nbsp;<span class="op" id="3848829">:=</span>&nbsp;<span class="num" id="3848832">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848835">if</span>&nbsp;<span class="ident" id="3848838"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3848840">.</span><span class="ident" id="3848841">mac</span>&nbsp;<span class="op" id="3848845">!=</span>&nbsp;<span class="ident" id="3848848">nil</span>&nbsp;<span class="op" id="3848852">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848856"><a href="/crypto/tls/conn.go.html#3848821">macSize</a></span>&nbsp;<span class="op" id="3848864">=</span>&nbsp;<span class="ident" id="3848866"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3848868">.</span><span class="ident" id="3848869">mac</span><span class="op" id="3848872">.</span><span class="ident" id="3848873">Size</span><span class="op" id="3848877">(</span><span class="op" id="3848878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848885">paddingGood</span>&nbsp;<span class="op" id="3848897">:=</span>&nbsp;<span class="builtintype" id="3848900">byte</span><span class="op" id="3848904">(</span><span class="num" id="3848905">255</span><span class="op" id="3848908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848911">explicitIVLen</span>&nbsp;<span class="op" id="3848925">:=</span>&nbsp;<span class="num" id="3848928">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848932">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848944">if</span>&nbsp;<span class="ident" id="3848947"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3848949">.</span><span class="ident" id="3848950">cipher</span>&nbsp;<span class="op" id="3848957">!=</span>&nbsp;<span class="ident" id="3848960">nil</span>&nbsp;<span class="op" id="3848964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848968">switch</span>&nbsp;<span class="ident" id="3848975">c</span>&nbsp;<span class="op" id="3848977">:=</span>&nbsp;<span class="ident" id="3848980"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3848982">.</span><span class="ident" id="3848983">cipher</span><span class="op" id="3848989">.</span><span class="op" id="3848990">(</span><span class="keyword" id="3848991">type</span><span class="op" id="3848995">)</span>&nbsp;<span class="op" id="3848997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849001">case</span>&nbsp;<span class="ident" id="3849006"><a href="/crypto/tls/conn.go.html#3842049">cipher</a></span><span class="op" id="3849012">.</span><span class="ident" id="3849013">Stream</span><span class="op" id="3849019">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849024"><a href="/crypto/tls/conn.go.html#3848975">c</a></span><span class="op" id="3849025">.</span><span class="ident" id="3849026">XORKeyStream</span><span class="op" id="3849038">(</span><span class="ident" id="3849039"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849046">,</span>&nbsp;<span class="ident" id="3849048"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849059">case</span>&nbsp;<span class="ident" id="3849064"><a href="/crypto/tls/conn.go.html#3842049">cipher</a></span><span class="op" id="3849070">.</span><span class="ident" id="3849071">AEAD</span><span class="op" id="3849075">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849080"><a href="/crypto/tls/conn.go.html#3848911">explicitIVLen</a></span>&nbsp;<span class="op" id="3849094">=</span>&nbsp;<span class="num" id="3849096">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849101">if</span>&nbsp;<span class="builtinfunc" id="3849104">len</span><span class="op" id="3849107">(</span><span class="ident" id="3849108"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849115">)</span>&nbsp;<span class="op" id="3849117">&lt;</span>&nbsp;<span class="ident" id="3849119"><a href="/crypto/tls/conn.go.html#3848911">explicitIVLen</a></span>&nbsp;<span class="op" id="3849133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849139">return</span>&nbsp;<span class="builtintype" id="3849146">false</span><span class="op" id="3849151">,</span>&nbsp;<span class="num" id="3849153">0</span><span class="op" id="3849154">,</span>&nbsp;<span class="ident" id="3849156"><a href="/crypto/tls/alert.go.html#3810668">alertBadRecordMAC</a></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849182">nonce</span>&nbsp;<span class="op" id="3849188">:=</span>&nbsp;<span class="ident" id="3849191"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849198">[</span><span class="op" id="3849199">:</span><span class="num" id="3849200">8</span><span class="op" id="3849201">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849206"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span>&nbsp;<span class="op" id="3849214">=</span>&nbsp;<span class="ident" id="3849216"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849223">[</span><span class="num" id="3849224">8</span><span class="op" id="3849225">:</span><span class="op" id="3849226">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849232">var</span>&nbsp;<span class="ident" id="3849236">additionalData</span>&nbsp;<span class="op" id="3849251">[</span><span class="num" id="3849252">13</span><span class="op" id="3849254">]</span><span class="builtintype" id="3849255">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3849263">copy</span><span class="op" id="3849267">(</span><span class="ident" id="3849268"><a href="/crypto/tls/conn.go.html#3849236">additionalData</a></span><span class="op" id="3849282">[</span><span class="op" id="3849283">:</span><span class="op" id="3849284">]</span><span class="op" id="3849285">,</span>&nbsp;<span class="ident" id="3849287"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3849289">.</span><span class="ident" id="3849290">seq</span><span class="op" id="3849293">[</span><span class="op" id="3849294">:</span><span class="op" id="3849295">]</span><span class="op" id="3849296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3849301">copy</span><span class="op" id="3849305">(</span><span class="ident" id="3849306"><a href="/crypto/tls/conn.go.html#3849236">additionalData</a></span><span class="op" id="3849320">[</span><span class="num" id="3849321">8</span><span class="op" id="3849322">:</span><span class="op" id="3849323">]</span><span class="op" id="3849324">,</span>&nbsp;<span class="ident" id="3849326"><a href="/crypto/tls/conn.go.html#3848706">b</a></span><span class="op" id="3849327">.</span><span class="ident" id="3849328">data</span><span class="op" id="3849332">[</span><span class="op" id="3849333">:</span><span class="num" id="3849334">3</span><span class="op" id="3849335">]</span><span class="op" id="3849336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849341">n</span>&nbsp;<span class="op" id="3849343">:=</span>&nbsp;<span class="builtinfunc" id="3849346">len</span><span class="op" id="3849349">(</span><span class="ident" id="3849350"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849357">)</span>&nbsp;<span class="op" id="3849359">-</span>&nbsp;<span class="ident" id="3849361"><a href="/crypto/tls/conn.go.html#3848975">c</a></span><span class="op" id="3849362">.</span><span class="ident" id="3849363">Overhead</span><span class="op" id="3849371">(</span><span class="op" id="3849372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849377"><a href="/crypto/tls/conn.go.html#3849236">additionalData</a></span><span class="op" id="3849391">[</span><span class="num" id="3849392">11</span><span class="op" id="3849394">]</span>&nbsp;<span class="op" id="3849396">=</span>&nbsp;<span class="builtintype" id="3849398">byte</span><span class="op" id="3849402">(</span><span class="ident" id="3849403"><a href="/crypto/tls/conn.go.html#3849341">n</a></span>&nbsp;<span class="op" id="3849405">&gt;&gt;</span>&nbsp;<span class="num" id="3849408">8</span><span class="op" id="3849409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849414"><a href="/crypto/tls/conn.go.html#3849236">additionalData</a></span><span class="op" id="3849428">[</span><span class="num" id="3849429">12</span><span class="op" id="3849431">]</span>&nbsp;<span class="op" id="3849433">=</span>&nbsp;<span class="builtintype" id="3849435">byte</span><span class="op" id="3849439">(</span><span class="ident" id="3849440"><a href="/crypto/tls/conn.go.html#3849341">n</a></span><span class="op" id="3849441">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849446">var</span>&nbsp;<span class="ident" id="3849450">err</span>&nbsp;<span class="builtintype" id="3849454">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849463"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849470">,</span>&nbsp;<span class="ident" id="3849472"><a href="/crypto/tls/conn.go.html#3849450">err</a></span>&nbsp;<span class="op" id="3849476">=</span>&nbsp;<span class="ident" id="3849478"><a href="/crypto/tls/conn.go.html#3848975">c</a></span><span class="op" id="3849479">.</span><span class="ident" id="3849480">Open</span><span class="op" id="3849484">(</span><span class="ident" id="3849485"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849492">[</span><span class="op" id="3849493">:</span><span class="num" id="3849494">0</span><span class="op" id="3849495">]</span><span class="op" id="3849496">,</span>&nbsp;<span class="ident" id="3849498"><a href="/crypto/tls/conn.go.html#3849182">nonce</a></span><span class="op" id="3849503">,</span>&nbsp;<span class="ident" id="3849505"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849512">,</span>&nbsp;<span class="ident" id="3849514"><a href="/crypto/tls/conn.go.html#3849236">additionalData</a></span><span class="op" id="3849528">[</span><span class="op" id="3849529">:</span><span class="op" id="3849530">]</span><span class="op" id="3849531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849536">if</span>&nbsp;<span class="ident" id="3849539"><a href="/crypto/tls/conn.go.html#3849450">err</a></span>&nbsp;<span class="op" id="3849543">!=</span>&nbsp;<span class="ident" id="3849546">nil</span>&nbsp;<span class="op" id="3849550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849556">return</span>&nbsp;<span class="builtintype" id="3849563">false</span><span class="op" id="3849568">,</span>&nbsp;<span class="num" id="3849570">0</span><span class="op" id="3849571">,</span>&nbsp;<span class="ident" id="3849573"><a href="/crypto/tls/alert.go.html#3810668">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849594">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849599"><a href="/crypto/tls/conn.go.html#3848706">b</a></span><span class="op" id="3849600">.</span><span class="ident" id="3849601">resize</span><span class="op" id="3849607">(</span><span class="ident" id="3849608"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span>&nbsp;<span class="op" id="3849624">+</span>&nbsp;<span class="ident" id="3849626"><a href="/crypto/tls/conn.go.html#3848911">explicitIVLen</a></span>&nbsp;<span class="op" id="3849640">+</span>&nbsp;<span class="builtinfunc" id="3849642">len</span><span class="op" id="3849645">(</span><span class="ident" id="3849646"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849653">)</span><span class="op" id="3849654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849658">case</span>&nbsp;<span class="ident" id="3849663"><a href="/crypto/tls/conn.go.html#3848397">cbcMode</a></span><span class="op" id="3849670">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849675">blockSize</span>&nbsp;<span class="op" id="3849685">:=</span>&nbsp;<span class="ident" id="3849688"><a href="/crypto/tls/conn.go.html#3848975">c</a></span><span class="op" id="3849689">.</span><span class="ident" id="3849690">BlockSize</span><span class="op" id="3849699">(</span><span class="op" id="3849700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849705">if</span>&nbsp;<span class="ident" id="3849708"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3849710">.</span><span class="ident" id="3849711">version</span>&nbsp;<span class="op" id="3849719">&gt;=</span>&nbsp;<span class="ident" id="3849722"><a href="/crypto/tls/common.go.html#3822818">VersionTLS11</a></span>&nbsp;<span class="op" id="3849735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849741"><a href="/crypto/tls/conn.go.html#3848911">explicitIVLen</a></span>&nbsp;<span class="op" id="3849755">=</span>&nbsp;<span class="ident" id="3849757"><a href="/crypto/tls/conn.go.html#3849675">blockSize</a></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849776">if</span>&nbsp;<span class="builtinfunc" id="3849779">len</span><span class="op" id="3849782">(</span><span class="ident" id="3849783"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849790">)</span><span class="op" id="3849791">%</span><span class="ident" id="3849792"><a href="/crypto/tls/conn.go.html#3849675">blockSize</a></span>&nbsp;<span class="op" id="3849802">!=</span>&nbsp;<span class="num" id="3849805">0</span>&nbsp;<span class="op" id="3849807">||</span>&nbsp;<span class="builtinfunc" id="3849810">len</span><span class="op" id="3849813">(</span><span class="ident" id="3849814"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849821">)</span>&nbsp;<span class="op" id="3849823">&lt;</span>&nbsp;<span class="ident" id="3849825"><a href="/crypto/tls/conn.go.html#3848269">roundUp</a></span><span class="op" id="3849832">(</span><span class="ident" id="3849833"><a href="/crypto/tls/conn.go.html#3848911">explicitIVLen</a></span><span class="op" id="3849846">+</span><span class="ident" id="3849847"><a href="/crypto/tls/conn.go.html#3848821">macSize</a></span><span class="op" id="3849854">+</span><span class="num" id="3849855">1</span><span class="op" id="3849856">,</span>&nbsp;<span class="ident" id="3849858"><a href="/crypto/tls/conn.go.html#3849675">blockSize</a></span><span class="op" id="3849867">)</span>&nbsp;<span class="op" id="3849869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849875">return</span>&nbsp;<span class="builtintype" id="3849882">false</span><span class="op" id="3849887">,</span>&nbsp;<span class="num" id="3849889">0</span><span class="op" id="3849890">,</span>&nbsp;<span class="ident" id="3849892"><a href="/crypto/tls/alert.go.html#3810668">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849913">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849919">if</span>&nbsp;<span class="ident" id="3849922"><a href="/crypto/tls/conn.go.html#3848911">explicitIVLen</a></span>&nbsp;<span class="op" id="3849936">&gt;</span>&nbsp;<span class="num" id="3849938">0</span>&nbsp;<span class="op" id="3849940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849946"><a href="/crypto/tls/conn.go.html#3848975">c</a></span><span class="op" id="3849947">.</span><span class="ident" id="3849948">SetIV</span><span class="op" id="3849953">(</span><span class="ident" id="3849954"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3849961">[</span><span class="op" id="3849962">:</span><span class="ident" id="3849963"><a href="/crypto/tls/conn.go.html#3848911">explicitIVLen</a></span><span class="op" id="3849976">]</span><span class="op" id="3849977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849983"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span>&nbsp;<span class="op" id="3849991">=</span>&nbsp;<span class="ident" id="3849993"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3850000">[</span><span class="ident" id="3850001"><a href="/crypto/tls/conn.go.html#3848911">explicitIVLen</a></span><span class="op" id="3850014">:</span><span class="op" id="3850015">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850020">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850025"><a href="/crypto/tls/conn.go.html#3848975">c</a></span><span class="op" id="3850026">.</span><span class="ident" id="3850027">CryptBlocks</span><span class="op" id="3850038">(</span><span class="ident" id="3850039"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3850046">,</span>&nbsp;<span class="ident" id="3850048"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3850055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850060">if</span>&nbsp;<span class="ident" id="3850063"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3850065">.</span><span class="ident" id="3850066">version</span>&nbsp;<span class="op" id="3850074">==</span>&nbsp;<span class="ident" id="3850077"><a href="/crypto/tls/common.go.html#3822772">VersionSSL30</a></span>&nbsp;<span class="op" id="3850090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850096"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3850103">,</span>&nbsp;<span class="ident" id="3850105"><a href="/crypto/tls/conn.go.html#3848885">paddingGood</a></span>&nbsp;<span class="op" id="3850117">=</span>&nbsp;<span class="ident" id="3850119"><a href="/crypto/tls/conn.go.html#3848011">removePaddingSSL30</a></span><span class="op" id="3850137">(</span><span class="ident" id="3850138"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3850145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850150">}</span>&nbsp;<span class="keyword" id="3850152">else</span>&nbsp;<span class="op" id="3850157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850163"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3850170">,</span>&nbsp;<span class="ident" id="3850172"><a href="/crypto/tls/conn.go.html#3848885">paddingGood</a></span>&nbsp;<span class="op" id="3850184">=</span>&nbsp;<span class="ident" id="3850186"><a href="/crypto/tls/conn.go.html#3846866">removePadding</a></span><span class="op" id="3850199">(</span><span class="ident" id="3850200"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3850207">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850217"><a href="/crypto/tls/conn.go.html#3848706">b</a></span><span class="op" id="3850218">.</span><span class="ident" id="3850219">resize</span><span class="op" id="3850225">(</span><span class="ident" id="3850226"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span>&nbsp;<span class="op" id="3850242">+</span>&nbsp;<span class="ident" id="3850244"><a href="/crypto/tls/conn.go.html#3848911">explicitIVLen</a></span>&nbsp;<span class="op" id="3850258">+</span>&nbsp;<span class="builtinfunc" id="3850260">len</span><span class="op" id="3850263">(</span><span class="ident" id="3850264"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3850271">)</span><span class="op" id="3850272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850278">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850337">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850394">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850451">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850507">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850557">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850615">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850635">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850641">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850697">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850727">default</span><span class="op" id="3850734">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3850739">panic</span><span class="op" id="3850744">(</span><span class="string" id="3850745">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3850766">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850777">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850798">if</span>&nbsp;<span class="ident" id="3850801"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3850803">.</span><span class="ident" id="3850804">mac</span>&nbsp;<span class="op" id="3850808">!=</span>&nbsp;<span class="ident" id="3850811">nil</span>&nbsp;<span class="op" id="3850815">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850819">if</span>&nbsp;<span class="builtinfunc" id="3850822">len</span><span class="op" id="3850825">(</span><span class="ident" id="3850826"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3850833">)</span>&nbsp;<span class="op" id="3850835">&lt;</span>&nbsp;<span class="ident" id="3850837"><a href="/crypto/tls/conn.go.html#3848821">macSize</a></span>&nbsp;<span class="op" id="3850845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850850">return</span>&nbsp;<span class="builtintype" id="3850857">false</span><span class="op" id="3850862">,</span>&nbsp;<span class="num" id="3850864">0</span><span class="op" id="3850865">,</span>&nbsp;<span class="ident" id="3850867"><a href="/crypto/tls/alert.go.html#3810668">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850892">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850927">n</span>&nbsp;<span class="op" id="3850929">:=</span>&nbsp;<span class="builtinfunc" id="3850932">len</span><span class="op" id="3850935">(</span><span class="ident" id="3850936"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3850943">)</span>&nbsp;<span class="op" id="3850945">-</span>&nbsp;<span class="ident" id="3850947"><a href="/crypto/tls/conn.go.html#3848821">macSize</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850957"><a href="/crypto/tls/conn.go.html#3848706">b</a></span><span class="op" id="3850958">.</span><span class="ident" id="3850959">data</span><span class="op" id="3850963">[</span><span class="num" id="3850964">3</span><span class="op" id="3850965">]</span>&nbsp;<span class="op" id="3850967">=</span>&nbsp;<span class="builtintype" id="3850969">byte</span><span class="op" id="3850973">(</span><span class="ident" id="3850974"><a href="/crypto/tls/conn.go.html#3850927">n</a></span>&nbsp;<span class="op" id="3850976">&gt;&gt;</span>&nbsp;<span class="num" id="3850979">8</span><span class="op" id="3850980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850984"><a href="/crypto/tls/conn.go.html#3848706">b</a></span><span class="op" id="3850985">.</span><span class="ident" id="3850986">data</span><span class="op" id="3850990">[</span><span class="num" id="3850991">4</span><span class="op" id="3850992">]</span>&nbsp;<span class="op" id="3850994">=</span>&nbsp;<span class="builtintype" id="3850996">byte</span><span class="op" id="3851000">(</span><span class="ident" id="3851001"><a href="/crypto/tls/conn.go.html#3850927">n</a></span><span class="op" id="3851002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851006"><a href="/crypto/tls/conn.go.html#3848706">b</a></span><span class="op" id="3851007">.</span><span class="ident" id="3851008">resize</span><span class="op" id="3851014">(</span><span class="ident" id="3851015"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span>&nbsp;<span class="op" id="3851031">+</span>&nbsp;<span class="ident" id="3851033"><a href="/crypto/tls/conn.go.html#3848911">explicitIVLen</a></span>&nbsp;<span class="op" id="3851047">+</span>&nbsp;<span class="ident" id="3851049"><a href="/crypto/tls/conn.go.html#3850927">n</a></span><span class="op" id="3851050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851054">remoteMAC</span>&nbsp;<span class="op" id="3851064">:=</span>&nbsp;<span class="ident" id="3851067"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3851074">[</span><span class="ident" id="3851075"><a href="/crypto/tls/conn.go.html#3850927">n</a></span><span class="op" id="3851076">:</span><span class="op" id="3851077">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851081">localMAC</span>&nbsp;<span class="op" id="3851090">:=</span>&nbsp;<span class="ident" id="3851093"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3851095">.</span><span class="ident" id="3851096">mac</span><span class="op" id="3851099">.</span><span class="ident" id="3851100">MAC</span><span class="op" id="3851103">(</span><span class="ident" id="3851104"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3851106">.</span><span class="ident" id="3851107">inDigestBuf</span><span class="op" id="3851118">,</span>&nbsp;<span class="ident" id="3851120"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3851122">.</span><span class="ident" id="3851123">seq</span><span class="op" id="3851126">[</span><span class="num" id="3851127">0</span><span class="op" id="3851128">:</span><span class="op" id="3851129">]</span><span class="op" id="3851130">,</span>&nbsp;<span class="ident" id="3851132"><a href="/crypto/tls/conn.go.html#3848706">b</a></span><span class="op" id="3851133">.</span><span class="ident" id="3851134">data</span><span class="op" id="3851138">[</span><span class="op" id="3851139">:</span><span class="ident" id="3851140"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3851155">]</span><span class="op" id="3851156">,</span>&nbsp;<span class="ident" id="3851158"><a href="/crypto/tls/conn.go.html#3848783">payload</a></span><span class="op" id="3851165">[</span><span class="op" id="3851166">:</span><span class="ident" id="3851167"><a href="/crypto/tls/conn.go.html#3850927">n</a></span><span class="op" id="3851168">]</span><span class="op" id="3851169">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851174">if</span>&nbsp;<span class="ident" id="3851177"><a href="/crypto/tls/conn.go.html#3842066">subtle</a></span><span class="op" id="3851183">.</span><span class="ident" id="3851184">ConstantTimeCompare</span><span class="op" id="3851203">(</span><span class="ident" id="3851204"><a href="/crypto/tls/conn.go.html#3851081">localMAC</a></span><span class="op" id="3851212">,</span>&nbsp;<span class="ident" id="3851214"><a href="/crypto/tls/conn.go.html#3851054">remoteMAC</a></span><span class="op" id="3851223">)</span>&nbsp;<span class="op" id="3851225">!=</span>&nbsp;<span class="num" id="3851228">1</span>&nbsp;<span class="op" id="3851230">||</span>&nbsp;<span class="ident" id="3851233"><a href="/crypto/tls/conn.go.html#3848885">paddingGood</a></span>&nbsp;<span class="op" id="3851245">!=</span>&nbsp;<span class="num" id="3851248">255</span>&nbsp;<span class="op" id="3851252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851257">return</span>&nbsp;<span class="builtintype" id="3851264">false</span><span class="op" id="3851269">,</span>&nbsp;<span class="num" id="3851271">0</span><span class="op" id="3851272">,</span>&nbsp;<span class="ident" id="3851274"><a href="/crypto/tls/alert.go.html#3810668">alertBadRecordMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851294">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851298"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3851300">.</span><span class="ident" id="3851301">inDigestBuf</span>&nbsp;<span class="op" id="3851313">=</span>&nbsp;<span class="ident" id="3851315"><a href="/crypto/tls/conn.go.html#3851081">localMAC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851328"><a href="/crypto/tls/conn.go.html#3848684">hc</a></span><span class="op" id="3851330">.</span><span class="ident" id="3851331">incSeq</span><span class="op" id="3851337">(</span><span class="op" id="3851338">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851342">return</span>&nbsp;<span class="builtintype" id="3851349">true</span><span class="op" id="3851353">,</span>&nbsp;<span class="ident" id="3851355"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span>&nbsp;<span class="op" id="3851371">+</span>&nbsp;<span class="ident" id="3851373"><a href="/crypto/tls/conn.go.html#3848911">explicitIVLen</a></span><span class="op" id="3851386">,</span>&nbsp;<span class="num" id="3851388">0</span><br>
<span class="lineno">335</span><span class="op" id="3851390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3851393">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="3851471">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="3851546">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="3851626">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3851702">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="3851717">func</span>&nbsp;<span class="ident" id="3851722">padToBlockSize</span><span class="op" id="3851736">(</span><span class="ident" id="3851737">payload</span>&nbsp;<span class="op" id="3851745">[</span><span class="op" id="3851746">]</span><span class="builtintype" id="3851747">byte</span><span class="op" id="3851751">,</span>&nbsp;<span class="ident" id="3851753">blockSize</span>&nbsp;<span class="builtintype" id="3851763">int</span><span class="op" id="3851766">)</span>&nbsp;<span class="op" id="3851768">(</span><span class="ident" id="3851769">prefix</span><span class="op" id="3851775">,</span>&nbsp;<span class="ident" id="3851777">finalBlock</span>&nbsp;<span class="op" id="3851788">[</span><span class="op" id="3851789">]</span><span class="builtintype" id="3851790">byte</span><span class="op" id="3851794">)</span>&nbsp;<span class="op" id="3851796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851799">overrun</span>&nbsp;<span class="op" id="3851807">:=</span>&nbsp;<span class="builtinfunc" id="3851810">len</span><span class="op" id="3851813">(</span><span class="ident" id="3851814"><a href="/crypto/tls/conn.go.html#3851737">payload</a></span><span class="op" id="3851821">)</span>&nbsp;<span class="op" id="3851823">%</span>&nbsp;<span class="ident" id="3851825"><a href="/crypto/tls/conn.go.html#3851753">blockSize</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851836">paddingLen</span>&nbsp;<span class="op" id="3851847">:=</span>&nbsp;<span class="ident" id="3851850"><a href="/crypto/tls/conn.go.html#3851753">blockSize</a></span>&nbsp;<span class="op" id="3851860">-</span>&nbsp;<span class="ident" id="3851862"><a href="/crypto/tls/conn.go.html#3851799">overrun</a></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851871"><a href="/crypto/tls/conn.go.html#3851769">prefix</a></span>&nbsp;<span class="op" id="3851878">=</span>&nbsp;<span class="ident" id="3851880"><a href="/crypto/tls/conn.go.html#3851737">payload</a></span><span class="op" id="3851887">[</span><span class="op" id="3851888">:</span><span class="builtinfunc" id="3851889">len</span><span class="op" id="3851892">(</span><span class="ident" id="3851893"><a href="/crypto/tls/conn.go.html#3851737">payload</a></span><span class="op" id="3851900">)</span><span class="op" id="3851901">-</span><span class="ident" id="3851902"><a href="/crypto/tls/conn.go.html#3851799">overrun</a></span><span class="op" id="3851909">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851912"><a href="/crypto/tls/conn.go.html#3851777">finalBlock</a></span>&nbsp;<span class="op" id="3851923">=</span>&nbsp;<span class="builtinfunc" id="3851925">make</span><span class="op" id="3851929">(</span><span class="op" id="3851930">[</span><span class="op" id="3851931">]</span><span class="builtintype" id="3851932">byte</span><span class="op" id="3851936">,</span>&nbsp;<span class="ident" id="3851938"><a href="/crypto/tls/conn.go.html#3851753">blockSize</a></span><span class="op" id="3851947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3851950">copy</span><span class="op" id="3851954">(</span><span class="ident" id="3851955"><a href="/crypto/tls/conn.go.html#3851777">finalBlock</a></span><span class="op" id="3851965">,</span>&nbsp;<span class="ident" id="3851967"><a href="/crypto/tls/conn.go.html#3851737">payload</a></span><span class="op" id="3851974">[</span><span class="builtinfunc" id="3851975">len</span><span class="op" id="3851978">(</span><span class="ident" id="3851979"><a href="/crypto/tls/conn.go.html#3851737">payload</a></span><span class="op" id="3851986">)</span><span class="op" id="3851987">-</span><span class="ident" id="3851988"><a href="/crypto/tls/conn.go.html#3851799">overrun</a></span><span class="op" id="3851995">:</span><span class="op" id="3851996">]</span><span class="op" id="3851997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852000">for</span>&nbsp;<span class="ident" id="3852004">i</span>&nbsp;<span class="op" id="3852006">:=</span>&nbsp;<span class="ident" id="3852009"><a href="/crypto/tls/conn.go.html#3851799">overrun</a></span><span class="op" id="3852016">;</span>&nbsp;<span class="ident" id="3852018"><a href="/crypto/tls/conn.go.html#3852004">i</a></span>&nbsp;<span class="op" id="3852020">&lt;</span>&nbsp;<span class="ident" id="3852022"><a href="/crypto/tls/conn.go.html#3851753">blockSize</a></span><span class="op" id="3852031">;</span>&nbsp;<span class="ident" id="3852033"><a href="/crypto/tls/conn.go.html#3852004">i</a></span><span class="op" id="3852034">++</span>&nbsp;<span class="op" id="3852037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852041"><a href="/crypto/tls/conn.go.html#3851777">finalBlock</a></span><span class="op" id="3852051">[</span><span class="ident" id="3852052"><a href="/crypto/tls/conn.go.html#3852004">i</a></span><span class="op" id="3852053">]</span>&nbsp;<span class="op" id="3852055">=</span>&nbsp;<span class="builtintype" id="3852057">byte</span><span class="op" id="3852061">(</span><span class="ident" id="3852062"><a href="/crypto/tls/conn.go.html#3851836">paddingLen</a></span>&nbsp;<span class="op" id="3852073">-</span>&nbsp;<span class="num" id="3852075">1</span><span class="op" id="3852076">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852082">return</span><br>
<span class="lineno"></span><span class="op" id="3852089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3852092">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="3852136">func</span>&nbsp;<span class="op" id="3852141">(</span><span class="ident" id="3852142">hc</span>&nbsp;<span class="op" id="3852145">*</span><span class="ident" id="3852146"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span><span class="op" id="3852154">)</span>&nbsp;<span class="ident" id="3852156">encrypt</span><span class="op" id="3852163">(</span><span class="ident" id="3852164">b</span>&nbsp;<span class="op" id="3852166">*</span><span class="ident" id="3852167"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><span class="op" id="3852172">,</span>&nbsp;<span class="ident" id="3852174">explicitIVLen</span>&nbsp;<span class="builtintype" id="3852188">int</span><span class="op" id="3852191">)</span>&nbsp;<span class="op" id="3852193">(</span><span class="builtintype" id="3852194">bool</span><span class="op" id="3852198">,</span>&nbsp;<span class="ident" id="3852200"><a href="/crypto/tls/alert.go.html#3810494">alert</a></span><span class="op" id="3852205">)</span>&nbsp;<span class="op" id="3852207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3852210">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852218">if</span>&nbsp;<span class="ident" id="3852221"><a href="/crypto/tls/conn.go.html#3852142">hc</a></span><span class="op" id="3852223">.</span><span class="ident" id="3852224">mac</span>&nbsp;<span class="op" id="3852228">!=</span>&nbsp;<span class="ident" id="3852231">nil</span>&nbsp;<span class="op" id="3852235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852239">mac</span>&nbsp;<span class="op" id="3852243">:=</span>&nbsp;<span class="ident" id="3852246"><a href="/crypto/tls/conn.go.html#3852142">hc</a></span><span class="op" id="3852248">.</span><span class="ident" id="3852249">mac</span><span class="op" id="3852252">.</span><span class="ident" id="3852253">MAC</span><span class="op" id="3852256">(</span><span class="ident" id="3852257"><a href="/crypto/tls/conn.go.html#3852142">hc</a></span><span class="op" id="3852259">.</span><span class="ident" id="3852260">outDigestBuf</span><span class="op" id="3852272">,</span>&nbsp;<span class="ident" id="3852274"><a href="/crypto/tls/conn.go.html#3852142">hc</a></span><span class="op" id="3852276">.</span><span class="ident" id="3852277">seq</span><span class="op" id="3852280">[</span><span class="num" id="3852281">0</span><span class="op" id="3852282">:</span><span class="op" id="3852283">]</span><span class="op" id="3852284">,</span>&nbsp;<span class="ident" id="3852286"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852287">.</span><span class="ident" id="3852288">data</span><span class="op" id="3852292">[</span><span class="op" id="3852293">:</span><span class="ident" id="3852294"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3852309">]</span><span class="op" id="3852310">,</span>&nbsp;<span class="ident" id="3852312"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852313">.</span><span class="ident" id="3852314">data</span><span class="op" id="3852318">[</span><span class="ident" id="3852319"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3852334">+</span><span class="ident" id="3852335"><a href="/crypto/tls/conn.go.html#3852174">explicitIVLen</a></span><span class="op" id="3852348">:</span><span class="op" id="3852349">]</span><span class="op" id="3852350">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852355">n</span>&nbsp;<span class="op" id="3852357">:=</span>&nbsp;<span class="builtinfunc" id="3852360">len</span><span class="op" id="3852363">(</span><span class="ident" id="3852364"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852365">.</span><span class="ident" id="3852366">data</span><span class="op" id="3852370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852374"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852375">.</span><span class="ident" id="3852376">resize</span><span class="op" id="3852382">(</span><span class="ident" id="3852383"><a href="/crypto/tls/conn.go.html#3852355">n</a></span>&nbsp;<span class="op" id="3852385">+</span>&nbsp;<span class="builtinfunc" id="3852387">len</span><span class="op" id="3852390">(</span><span class="ident" id="3852391"><a href="/crypto/tls/conn.go.html#3852239">mac</a></span><span class="op" id="3852394">)</span><span class="op" id="3852395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3852399">copy</span><span class="op" id="3852403">(</span><span class="ident" id="3852404"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852405">.</span><span class="ident" id="3852406">data</span><span class="op" id="3852410">[</span><span class="ident" id="3852411"><a href="/crypto/tls/conn.go.html#3852355">n</a></span><span class="op" id="3852412">:</span><span class="op" id="3852413">]</span><span class="op" id="3852414">,</span>&nbsp;<span class="ident" id="3852416"><a href="/crypto/tls/conn.go.html#3852239">mac</a></span><span class="op" id="3852419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852423"><a href="/crypto/tls/conn.go.html#3852142">hc</a></span><span class="op" id="3852425">.</span><span class="ident" id="3852426">outDigestBuf</span>&nbsp;<span class="op" id="3852439">=</span>&nbsp;<span class="ident" id="3852441"><a href="/crypto/tls/conn.go.html#3852239">mac</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3852446">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852450">payload</span>&nbsp;<span class="op" id="3852458">:=</span>&nbsp;<span class="ident" id="3852461"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852462">.</span><span class="ident" id="3852463">data</span><span class="op" id="3852467">[</span><span class="ident" id="3852468"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3852483">:</span><span class="op" id="3852484">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3852488">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852500">if</span>&nbsp;<span class="ident" id="3852503"><a href="/crypto/tls/conn.go.html#3852142">hc</a></span><span class="op" id="3852505">.</span><span class="ident" id="3852506">cipher</span>&nbsp;<span class="op" id="3852513">!=</span>&nbsp;<span class="ident" id="3852516">nil</span>&nbsp;<span class="op" id="3852520">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852524">switch</span>&nbsp;<span class="ident" id="3852531">c</span>&nbsp;<span class="op" id="3852533">:=</span>&nbsp;<span class="ident" id="3852536"><a href="/crypto/tls/conn.go.html#3852142">hc</a></span><span class="op" id="3852538">.</span><span class="ident" id="3852539">cipher</span><span class="op" id="3852545">.</span><span class="op" id="3852546">(</span><span class="keyword" id="3852547">type</span><span class="op" id="3852551">)</span>&nbsp;<span class="op" id="3852553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852557">case</span>&nbsp;<span class="ident" id="3852562"><a href="/crypto/tls/conn.go.html#3842049">cipher</a></span><span class="op" id="3852568">.</span><span class="ident" id="3852569">Stream</span><span class="op" id="3852575">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852580"><a href="/crypto/tls/conn.go.html#3852531">c</a></span><span class="op" id="3852581">.</span><span class="ident" id="3852582">XORKeyStream</span><span class="op" id="3852594">(</span><span class="ident" id="3852595"><a href="/crypto/tls/conn.go.html#3852450">payload</a></span><span class="op" id="3852602">,</span>&nbsp;<span class="ident" id="3852604"><a href="/crypto/tls/conn.go.html#3852450">payload</a></span><span class="op" id="3852611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852615">case</span>&nbsp;<span class="ident" id="3852620"><a href="/crypto/tls/conn.go.html#3842049">cipher</a></span><span class="op" id="3852626">.</span><span class="ident" id="3852627">AEAD</span><span class="op" id="3852631">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852636">payloadLen</span>&nbsp;<span class="op" id="3852647">:=</span>&nbsp;<span class="builtinfunc" id="3852650">len</span><span class="op" id="3852653">(</span><span class="ident" id="3852654"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852655">.</span><span class="ident" id="3852656">data</span><span class="op" id="3852660">)</span>&nbsp;<span class="op" id="3852662">-</span>&nbsp;<span class="ident" id="3852664"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span>&nbsp;<span class="op" id="3852680">-</span>&nbsp;<span class="ident" id="3852682"><a href="/crypto/tls/conn.go.html#3852174">explicitIVLen</a></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852699"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852700">.</span><span class="ident" id="3852701">resize</span><span class="op" id="3852707">(</span><span class="builtinfunc" id="3852708">len</span><span class="op" id="3852711">(</span><span class="ident" id="3852712"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852713">.</span><span class="ident" id="3852714">data</span><span class="op" id="3852718">)</span>&nbsp;<span class="op" id="3852720">+</span>&nbsp;<span class="ident" id="3852722"><a href="/crypto/tls/conn.go.html#3852531">c</a></span><span class="op" id="3852723">.</span><span class="ident" id="3852724">Overhead</span><span class="op" id="3852732">(</span><span class="op" id="3852733">)</span><span class="op" id="3852734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852739">nonce</span>&nbsp;<span class="op" id="3852745">:=</span>&nbsp;<span class="ident" id="3852748"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852749">.</span><span class="ident" id="3852750">data</span><span class="op" id="3852754">[</span><span class="ident" id="3852755"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span>&nbsp;<span class="op" id="3852771">:</span>&nbsp;<span class="ident" id="3852773"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3852788">+</span><span class="ident" id="3852789"><a href="/crypto/tls/conn.go.html#3852174">explicitIVLen</a></span><span class="op" id="3852802">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852807">payload</span>&nbsp;<span class="op" id="3852815">:=</span>&nbsp;<span class="ident" id="3852818"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852819">.</span><span class="ident" id="3852820">data</span><span class="op" id="3852824">[</span><span class="ident" id="3852825"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3852840">+</span><span class="ident" id="3852841"><a href="/crypto/tls/conn.go.html#3852174">explicitIVLen</a></span><span class="op" id="3852854">:</span><span class="op" id="3852855">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3852860"><a href="/crypto/tls/conn.go.html#3852807">payload</a></span>&nbsp;<span class="op" id="3852868">=</span>&nbsp;<span class="ident" id="3852870"><a href="/crypto/tls/conn.go.html#3852807">payload</a></span><span class="op" id="3852877">[</span><span class="op" id="3852878">:</span><span class="ident" id="3852879"><a href="/crypto/tls/conn.go.html#3852636">payloadLen</a></span><span class="op" id="3852889">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3852895">var</span>&nbsp;<span class="ident" id="3852899">additionalData</span>&nbsp;<span class="op" id="3852914">[</span><span class="num" id="3852915">13</span><span class="op" id="3852917">]</span><span class="builtintype" id="3852918">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3852926">copy</span><span class="op" id="3852930">(</span><span class="ident" id="3852931"><a href="/crypto/tls/conn.go.html#3852899">additionalData</a></span><span class="op" id="3852945">[</span><span class="op" id="3852946">:</span><span class="op" id="3852947">]</span><span class="op" id="3852948">,</span>&nbsp;<span class="ident" id="3852950"><a href="/crypto/tls/conn.go.html#3852142">hc</a></span><span class="op" id="3852952">.</span><span class="ident" id="3852953">seq</span><span class="op" id="3852956">[</span><span class="op" id="3852957">:</span><span class="op" id="3852958">]</span><span class="op" id="3852959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3852964">copy</span><span class="op" id="3852968">(</span><span class="ident" id="3852969"><a href="/crypto/tls/conn.go.html#3852899">additionalData</a></span><span class="op" id="3852983">[</span><span class="num" id="3852984">8</span><span class="op" id="3852985">:</span><span class="op" id="3852986">]</span><span class="op" id="3852987">,</span>&nbsp;<span class="ident" id="3852989"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3852990">.</span><span class="ident" id="3852991">data</span><span class="op" id="3852995">[</span><span class="op" id="3852996">:</span><span class="num" id="3852997">3</span><span class="op" id="3852998">]</span><span class="op" id="3852999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853004"><a href="/crypto/tls/conn.go.html#3852899">additionalData</a></span><span class="op" id="3853018">[</span><span class="num" id="3853019">11</span><span class="op" id="3853021">]</span>&nbsp;<span class="op" id="3853023">=</span>&nbsp;<span class="builtintype" id="3853025">byte</span><span class="op" id="3853029">(</span><span class="ident" id="3853030"><a href="/crypto/tls/conn.go.html#3852636">payloadLen</a></span>&nbsp;<span class="op" id="3853041">&gt;&gt;</span>&nbsp;<span class="num" id="3853044">8</span><span class="op" id="3853045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853050"><a href="/crypto/tls/conn.go.html#3852899">additionalData</a></span><span class="op" id="3853064">[</span><span class="num" id="3853065">12</span><span class="op" id="3853067">]</span>&nbsp;<span class="op" id="3853069">=</span>&nbsp;<span class="builtintype" id="3853071">byte</span><span class="op" id="3853075">(</span><span class="ident" id="3853076"><a href="/crypto/tls/conn.go.html#3852636">payloadLen</a></span><span class="op" id="3853086">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853092"><a href="/crypto/tls/conn.go.html#3852531">c</a></span><span class="op" id="3853093">.</span><span class="ident" id="3853094">Seal</span><span class="op" id="3853098">(</span><span class="ident" id="3853099"><a href="/crypto/tls/conn.go.html#3852807">payload</a></span><span class="op" id="3853106">[</span><span class="op" id="3853107">:</span><span class="num" id="3853108">0</span><span class="op" id="3853109">]</span><span class="op" id="3853110">,</span>&nbsp;<span class="ident" id="3853112"><a href="/crypto/tls/conn.go.html#3852739">nonce</a></span><span class="op" id="3853117">,</span>&nbsp;<span class="ident" id="3853119"><a href="/crypto/tls/conn.go.html#3852807">payload</a></span><span class="op" id="3853126">,</span>&nbsp;<span class="ident" id="3853128"><a href="/crypto/tls/conn.go.html#3852899">additionalData</a></span><span class="op" id="3853142">[</span><span class="op" id="3853143">:</span><span class="op" id="3853144">]</span><span class="op" id="3853145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853149">case</span>&nbsp;<span class="ident" id="3853154"><a href="/crypto/tls/conn.go.html#3848397">cbcMode</a></span><span class="op" id="3853161">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853166">blockSize</span>&nbsp;<span class="op" id="3853176">:=</span>&nbsp;<span class="ident" id="3853179"><a href="/crypto/tls/conn.go.html#3852531">c</a></span><span class="op" id="3853180">.</span><span class="ident" id="3853181">BlockSize</span><span class="op" id="3853190">(</span><span class="op" id="3853191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853196">if</span>&nbsp;<span class="ident" id="3853199"><a href="/crypto/tls/conn.go.html#3852174">explicitIVLen</a></span>&nbsp;<span class="op" id="3853213">&gt;</span>&nbsp;<span class="num" id="3853215">0</span>&nbsp;<span class="op" id="3853217">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853223"><a href="/crypto/tls/conn.go.html#3852531">c</a></span><span class="op" id="3853224">.</span><span class="ident" id="3853225">SetIV</span><span class="op" id="3853230">(</span><span class="ident" id="3853231"><a href="/crypto/tls/conn.go.html#3852450">payload</a></span><span class="op" id="3853238">[</span><span class="op" id="3853239">:</span><span class="ident" id="3853240"><a href="/crypto/tls/conn.go.html#3852174">explicitIVLen</a></span><span class="op" id="3853253">]</span><span class="op" id="3853254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853260"><a href="/crypto/tls/conn.go.html#3852450">payload</a></span>&nbsp;<span class="op" id="3853268">=</span>&nbsp;<span class="ident" id="3853270"><a href="/crypto/tls/conn.go.html#3852450">payload</a></span><span class="op" id="3853277">[</span><span class="ident" id="3853278"><a href="/crypto/tls/conn.go.html#3852174">explicitIVLen</a></span><span class="op" id="3853291">:</span><span class="op" id="3853292">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853302">prefix</span><span class="op" id="3853308">,</span>&nbsp;<span class="ident" id="3853310">finalBlock</span>&nbsp;<span class="op" id="3853321">:=</span>&nbsp;<span class="ident" id="3853324"><a href="/crypto/tls/conn.go.html#3851722">padToBlockSize</a></span><span class="op" id="3853338">(</span><span class="ident" id="3853339"><a href="/crypto/tls/conn.go.html#3852450">payload</a></span><span class="op" id="3853346">,</span>&nbsp;<span class="ident" id="3853348"><a href="/crypto/tls/conn.go.html#3853166">blockSize</a></span><span class="op" id="3853357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853362"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3853363">.</span><span class="ident" id="3853364">resize</span><span class="op" id="3853370">(</span><span class="ident" id="3853371"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span>&nbsp;<span class="op" id="3853387">+</span>&nbsp;<span class="ident" id="3853389"><a href="/crypto/tls/conn.go.html#3852174">explicitIVLen</a></span>&nbsp;<span class="op" id="3853403">+</span>&nbsp;<span class="builtinfunc" id="3853405">len</span><span class="op" id="3853408">(</span><span class="ident" id="3853409"><a href="/crypto/tls/conn.go.html#3853302">prefix</a></span><span class="op" id="3853415">)</span>&nbsp;<span class="op" id="3853417">+</span>&nbsp;<span class="builtinfunc" id="3853419">len</span><span class="op" id="3853422">(</span><span class="ident" id="3853423"><a href="/crypto/tls/conn.go.html#3853310">finalBlock</a></span><span class="op" id="3853433">)</span><span class="op" id="3853434">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853439"><a href="/crypto/tls/conn.go.html#3852531">c</a></span><span class="op" id="3853440">.</span><span class="ident" id="3853441">CryptBlocks</span><span class="op" id="3853452">(</span><span class="ident" id="3853453"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3853454">.</span><span class="ident" id="3853455">data</span><span class="op" id="3853459">[</span><span class="ident" id="3853460"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3853475">+</span><span class="ident" id="3853476"><a href="/crypto/tls/conn.go.html#3852174">explicitIVLen</a></span><span class="op" id="3853489">:</span><span class="op" id="3853490">]</span><span class="op" id="3853491">,</span>&nbsp;<span class="ident" id="3853493"><a href="/crypto/tls/conn.go.html#3853302">prefix</a></span><span class="op" id="3853499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853504"><a href="/crypto/tls/conn.go.html#3852531">c</a></span><span class="op" id="3853505">.</span><span class="ident" id="3853506">CryptBlocks</span><span class="op" id="3853517">(</span><span class="ident" id="3853518"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3853519">.</span><span class="ident" id="3853520">data</span><span class="op" id="3853524">[</span><span class="ident" id="3853525"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3853540">+</span><span class="ident" id="3853541"><a href="/crypto/tls/conn.go.html#3852174">explicitIVLen</a></span><span class="op" id="3853554">+</span><span class="builtinfunc" id="3853555">len</span><span class="op" id="3853558">(</span><span class="ident" id="3853559"><a href="/crypto/tls/conn.go.html#3853302">prefix</a></span><span class="op" id="3853565">)</span><span class="op" id="3853566">:</span><span class="op" id="3853567">]</span><span class="op" id="3853568">,</span>&nbsp;<span class="ident" id="3853570"><a href="/crypto/tls/conn.go.html#3853310">finalBlock</a></span><span class="op" id="3853580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853584">default</span><span class="op" id="3853591">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3853596">panic</span><span class="op" id="3853601">(</span><span class="string" id="3853602">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3853623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853627">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3853634">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853697">n</span>&nbsp;<span class="op" id="3853699">:=</span>&nbsp;<span class="builtinfunc" id="3853702">len</span><span class="op" id="3853705">(</span><span class="ident" id="3853706"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3853707">.</span><span class="ident" id="3853708">data</span><span class="op" id="3853712">)</span>&nbsp;<span class="op" id="3853714">-</span>&nbsp;<span class="ident" id="3853716"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853733"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3853734">.</span><span class="ident" id="3853735">data</span><span class="op" id="3853739">[</span><span class="num" id="3853740">3</span><span class="op" id="3853741">]</span>&nbsp;<span class="op" id="3853743">=</span>&nbsp;<span class="builtintype" id="3853745">byte</span><span class="op" id="3853749">(</span><span class="ident" id="3853750"><a href="/crypto/tls/conn.go.html#3853697">n</a></span>&nbsp;<span class="op" id="3853752">&gt;&gt;</span>&nbsp;<span class="num" id="3853755">8</span><span class="op" id="3853756">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853759"><a href="/crypto/tls/conn.go.html#3852164">b</a></span><span class="op" id="3853760">.</span><span class="ident" id="3853761">data</span><span class="op" id="3853765">[</span><span class="num" id="3853766">4</span><span class="op" id="3853767">]</span>&nbsp;<span class="op" id="3853769">=</span>&nbsp;<span class="builtintype" id="3853771">byte</span><span class="op" id="3853775">(</span><span class="ident" id="3853776"><a href="/crypto/tls/conn.go.html#3853697">n</a></span><span class="op" id="3853777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853780"><a href="/crypto/tls/conn.go.html#3852142">hc</a></span><span class="op" id="3853782">.</span><span class="ident" id="3853783">incSeq</span><span class="op" id="3853789">(</span><span class="op" id="3853790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853794">return</span>&nbsp;<span class="builtintype" id="3853801">true</span><span class="op" id="3853805">,</span>&nbsp;<span class="num" id="3853807">0</span><br>
<span class="lineno"></span><span class="op" id="3853809">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="3853812">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3853848">type</span>&nbsp;<span class="ident" id="3853853">block</span>&nbsp;<span class="keyword" id="3853859">struct</span>&nbsp;<span class="op" id="3853866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853869">data</span>&nbsp;<span class="op" id="3853874">[</span><span class="op" id="3853875">]</span><span class="builtintype" id="3853876">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853882">off</span>&nbsp;&nbsp;<span class="builtintype" id="3853887">int</span>&nbsp;<span class="comment" id="3853891">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853910">link</span>&nbsp;<span class="op" id="3853915">*</span><span class="ident" id="3853916"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><br>
<span class="lineno"></span><span class="op" id="3853922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3853925">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3853986">func</span>&nbsp;<span class="op" id="3853991">(</span><span class="ident" id="3853992">b</span>&nbsp;<span class="op" id="3853994">*</span><span class="ident" id="3853995"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><span class="op" id="3854000">)</span>&nbsp;<span class="ident" id="3854002">resize</span><span class="op" id="3854008">(</span><span class="ident" id="3854009">n</span>&nbsp;<span class="builtintype" id="3854011">int</span><span class="op" id="3854014">)</span>&nbsp;<span class="op" id="3854016">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854019">if</span>&nbsp;<span class="ident" id="3854022"><a href="/crypto/tls/conn.go.html#3854009">n</a></span>&nbsp;<span class="op" id="3854024">&gt;</span>&nbsp;<span class="builtinfunc" id="3854026">cap</span><span class="op" id="3854029">(</span><span class="ident" id="3854030"><a href="/crypto/tls/conn.go.html#3853992">b</a></span><span class="op" id="3854031">.</span><span class="ident" id="3854032">data</span><span class="op" id="3854036">)</span>&nbsp;<span class="op" id="3854038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854042"><a href="/crypto/tls/conn.go.html#3853992">b</a></span><span class="op" id="3854043">.</span><span class="ident" id="3854044">reserve</span><span class="op" id="3854051">(</span><span class="ident" id="3854052"><a href="/crypto/tls/conn.go.html#3854009">n</a></span><span class="op" id="3854053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854059"><a href="/crypto/tls/conn.go.html#3853992">b</a></span><span class="op" id="3854060">.</span><span class="ident" id="3854061">data</span>&nbsp;<span class="op" id="3854066">=</span>&nbsp;<span class="ident" id="3854068"><a href="/crypto/tls/conn.go.html#3853992">b</a></span><span class="op" id="3854069">.</span><span class="ident" id="3854070">data</span><span class="op" id="3854074">[</span><span class="num" id="3854075">0</span><span class="op" id="3854076">:</span><span class="ident" id="3854077"><a href="/crypto/tls/conn.go.html#3854009">n</a></span><span class="op" id="3854078">]</span><br>
<span class="lineno"></span><span class="op" id="3854080">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="3854083">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3854157">func</span>&nbsp;<span class="op" id="3854162">(</span><span class="ident" id="3854163">b</span>&nbsp;<span class="op" id="3854165">*</span><span class="ident" id="3854166"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><span class="op" id="3854171">)</span>&nbsp;<span class="ident" id="3854173">reserve</span><span class="op" id="3854180">(</span><span class="ident" id="3854181">n</span>&nbsp;<span class="builtintype" id="3854183">int</span><span class="op" id="3854186">)</span>&nbsp;<span class="op" id="3854188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854191">if</span>&nbsp;<span class="builtinfunc" id="3854194">cap</span><span class="op" id="3854197">(</span><span class="ident" id="3854198"><a href="/crypto/tls/conn.go.html#3854163">b</a></span><span class="op" id="3854199">.</span><span class="ident" id="3854200">data</span><span class="op" id="3854204">)</span>&nbsp;<span class="op" id="3854206">&gt;=</span>&nbsp;<span class="ident" id="3854209"><a href="/crypto/tls/conn.go.html#3854181">n</a></span>&nbsp;<span class="op" id="3854211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854215">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854226">m</span>&nbsp;<span class="op" id="3854228">:=</span>&nbsp;<span class="builtinfunc" id="3854231">cap</span><span class="op" id="3854234">(</span><span class="ident" id="3854235"><a href="/crypto/tls/conn.go.html#3854163">b</a></span><span class="op" id="3854236">.</span><span class="ident" id="3854237">data</span><span class="op" id="3854241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854244">if</span>&nbsp;<span class="ident" id="3854247"><a href="/crypto/tls/conn.go.html#3854226">m</a></span>&nbsp;<span class="op" id="3854249">==</span>&nbsp;<span class="num" id="3854252">0</span>&nbsp;<span class="op" id="3854254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854258"><a href="/crypto/tls/conn.go.html#3854226">m</a></span>&nbsp;<span class="op" id="3854260">=</span>&nbsp;<span class="num" id="3854262">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854268">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854271">for</span>&nbsp;<span class="ident" id="3854275"><a href="/crypto/tls/conn.go.html#3854226">m</a></span>&nbsp;<span class="op" id="3854277">&lt;</span>&nbsp;<span class="ident" id="3854279"><a href="/crypto/tls/conn.go.html#3854181">n</a></span>&nbsp;<span class="op" id="3854281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854285"><a href="/crypto/tls/conn.go.html#3854226">m</a></span>&nbsp;<span class="op" id="3854287">*=</span>&nbsp;<span class="num" id="3854290">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854296">data</span>&nbsp;<span class="op" id="3854301">:=</span>&nbsp;<span class="builtinfunc" id="3854304">make</span><span class="op" id="3854308">(</span><span class="op" id="3854309">[</span><span class="op" id="3854310">]</span><span class="builtintype" id="3854311">byte</span><span class="op" id="3854315">,</span>&nbsp;<span class="builtinfunc" id="3854317">len</span><span class="op" id="3854320">(</span><span class="ident" id="3854321"><a href="/crypto/tls/conn.go.html#3854163">b</a></span><span class="op" id="3854322">.</span><span class="ident" id="3854323">data</span><span class="op" id="3854327">)</span><span class="op" id="3854328">,</span>&nbsp;<span class="ident" id="3854330"><a href="/crypto/tls/conn.go.html#3854226">m</a></span><span class="op" id="3854331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3854334">copy</span><span class="op" id="3854338">(</span><span class="ident" id="3854339"><a href="/crypto/tls/conn.go.html#3854296">data</a></span><span class="op" id="3854343">,</span>&nbsp;<span class="ident" id="3854345"><a href="/crypto/tls/conn.go.html#3854163">b</a></span><span class="op" id="3854346">.</span><span class="ident" id="3854347">data</span><span class="op" id="3854351">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854354"><a href="/crypto/tls/conn.go.html#3854163">b</a></span><span class="op" id="3854355">.</span><span class="ident" id="3854356">data</span>&nbsp;<span class="op" id="3854361">=</span>&nbsp;<span class="ident" id="3854363"><a href="/crypto/tls/conn.go.html#3854296">data</a></span><br>
<span class="lineno"></span><span class="op" id="3854368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3854371">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="3854442">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="3854471">func</span>&nbsp;<span class="op" id="3854476">(</span><span class="ident" id="3854477">b</span>&nbsp;<span class="op" id="3854479">*</span><span class="ident" id="3854480"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><span class="op" id="3854485">)</span>&nbsp;<span class="ident" id="3854487">readFromUntil</span><span class="op" id="3854500">(</span><span class="ident" id="3854501">r</span>&nbsp;<span class="ident" id="3854503"><a href="/crypto/tls/conn.go.html#3842115">io</a></span><span class="op" id="3854505">.</span><span class="ident" id="3854506">Reader</span><span class="op" id="3854512">,</span>&nbsp;<span class="ident" id="3854514">n</span>&nbsp;<span class="builtintype" id="3854516">int</span><span class="op" id="3854519">)</span>&nbsp;<span class="builtintype" id="3854521">error</span>&nbsp;<span class="op" id="3854527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854530">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854545">if</span>&nbsp;<span class="builtinfunc" id="3854548">len</span><span class="op" id="3854551">(</span><span class="ident" id="3854552"><a href="/crypto/tls/conn.go.html#3854477">b</a></span><span class="op" id="3854553">.</span><span class="ident" id="3854554">data</span><span class="op" id="3854558">)</span>&nbsp;<span class="op" id="3854560">&gt;=</span>&nbsp;<span class="ident" id="3854563"><a href="/crypto/tls/conn.go.html#3854514">n</a></span>&nbsp;<span class="op" id="3854565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854569">return</span>&nbsp;<span class="ident" id="3854576">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854581">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854585">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854613"><a href="/crypto/tls/conn.go.html#3854477">b</a></span><span class="op" id="3854614">.</span><span class="ident" id="3854615">reserve</span><span class="op" id="3854622">(</span><span class="ident" id="3854623"><a href="/crypto/tls/conn.go.html#3854514">n</a></span><span class="op" id="3854624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854627">for</span>&nbsp;<span class="op" id="3854631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854635">m</span><span class="op" id="3854636">,</span>&nbsp;<span class="ident" id="3854638">err</span>&nbsp;<span class="op" id="3854642">:=</span>&nbsp;<span class="ident" id="3854645"><a href="/crypto/tls/conn.go.html#3854501">r</a></span><span class="op" id="3854646">.</span><span class="ident" id="3854647">Read</span><span class="op" id="3854651">(</span><span class="ident" id="3854652"><a href="/crypto/tls/conn.go.html#3854477">b</a></span><span class="op" id="3854653">.</span><span class="ident" id="3854654">data</span><span class="op" id="3854658">[</span><span class="builtinfunc" id="3854659">len</span><span class="op" id="3854662">(</span><span class="ident" id="3854663"><a href="/crypto/tls/conn.go.html#3854477">b</a></span><span class="op" id="3854664">.</span><span class="ident" id="3854665">data</span><span class="op" id="3854669">)</span><span class="op" id="3854670">:</span><span class="builtinfunc" id="3854671">cap</span><span class="op" id="3854674">(</span><span class="ident" id="3854675"><a href="/crypto/tls/conn.go.html#3854477">b</a></span><span class="op" id="3854676">.</span><span class="ident" id="3854677">data</span><span class="op" id="3854681">)</span><span class="op" id="3854682">]</span><span class="op" id="3854683">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854687"><a href="/crypto/tls/conn.go.html#3854477">b</a></span><span class="op" id="3854688">.</span><span class="ident" id="3854689">data</span>&nbsp;<span class="op" id="3854694">=</span>&nbsp;<span class="ident" id="3854696"><a href="/crypto/tls/conn.go.html#3854477">b</a></span><span class="op" id="3854697">.</span><span class="ident" id="3854698">data</span><span class="op" id="3854702">[</span><span class="num" id="3854703">0</span>&nbsp;<span class="op" id="3854705">:</span>&nbsp;<span class="builtinfunc" id="3854707">len</span><span class="op" id="3854710">(</span><span class="ident" id="3854711"><a href="/crypto/tls/conn.go.html#3854477">b</a></span><span class="op" id="3854712">.</span><span class="ident" id="3854713">data</span><span class="op" id="3854717">)</span><span class="op" id="3854718">+</span><span class="ident" id="3854719"><a href="/crypto/tls/conn.go.html#3854635">m</a></span><span class="op" id="3854720">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854724">if</span>&nbsp;<span class="builtinfunc" id="3854727">len</span><span class="op" id="3854730">(</span><span class="ident" id="3854731"><a href="/crypto/tls/conn.go.html#3854477">b</a></span><span class="op" id="3854732">.</span><span class="ident" id="3854733">data</span><span class="op" id="3854737">)</span>&nbsp;<span class="op" id="3854739">&gt;=</span>&nbsp;<span class="ident" id="3854742"><a href="/crypto/tls/conn.go.html#3854514">n</a></span>&nbsp;<span class="op" id="3854744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854749">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854795">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854845">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854857">if</span>&nbsp;<span class="ident" id="3854860"><a href="/crypto/tls/conn.go.html#3854638">err</a></span>&nbsp;<span class="op" id="3854864">!=</span>&nbsp;<span class="ident" id="3854867">nil</span>&nbsp;<span class="op" id="3854871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854876">return</span>&nbsp;<span class="ident" id="3854883"><a href="/crypto/tls/conn.go.html#3854638">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854892">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854895">return</span>&nbsp;<span class="ident" id="3854902">nil</span><br>
<span class="lineno"></span><span class="op" id="3854906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3854909">func</span>&nbsp;<span class="op" id="3854914">(</span><span class="ident" id="3854915">b</span>&nbsp;<span class="op" id="3854917">*</span><span class="ident" id="3854918"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><span class="op" id="3854923">)</span>&nbsp;<span class="ident" id="3854925">Read</span><span class="op" id="3854929">(</span><span class="ident" id="3854930">p</span>&nbsp;<span class="op" id="3854932">[</span><span class="op" id="3854933">]</span><span class="builtintype" id="3854934">byte</span><span class="op" id="3854938">)</span>&nbsp;<span class="op" id="3854940">(</span><span class="ident" id="3854941">n</span>&nbsp;<span class="builtintype" id="3854943">int</span><span class="op" id="3854946">,</span>&nbsp;<span class="ident" id="3854948">err</span>&nbsp;<span class="builtintype" id="3854952">error</span><span class="op" id="3854957">)</span>&nbsp;<span class="op" id="3854959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854962"><a href="/crypto/tls/conn.go.html#3854941">n</a></span>&nbsp;<span class="op" id="3854964">=</span>&nbsp;<span class="builtinfunc" id="3854966">copy</span><span class="op" id="3854970">(</span><span class="ident" id="3854971"><a href="/crypto/tls/conn.go.html#3854930">p</a></span><span class="op" id="3854972">,</span>&nbsp;<span class="ident" id="3854974"><a href="/crypto/tls/conn.go.html#3854915">b</a></span><span class="op" id="3854975">.</span><span class="ident" id="3854976">data</span><span class="op" id="3854980">[</span><span class="ident" id="3854981"><a href="/crypto/tls/conn.go.html#3854915">b</a></span><span class="op" id="3854982">.</span><span class="ident" id="3854983">off</span><span class="op" id="3854986">:</span><span class="op" id="3854987">]</span><span class="op" id="3854988">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854991"><a href="/crypto/tls/conn.go.html#3854915">b</a></span><span class="op" id="3854992">.</span><span class="ident" id="3854993">off</span>&nbsp;<span class="op" id="3854997">+=</span>&nbsp;<span class="ident" id="3855000"><a href="/crypto/tls/conn.go.html#3854941">n</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855003">return</span><br>
<span class="lineno"></span><span class="op" id="3855010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3855013">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="3855081">func</span>&nbsp;<span class="op" id="3855086">(</span><span class="ident" id="3855087">hc</span>&nbsp;<span class="op" id="3855090">*</span><span class="ident" id="3855091"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span><span class="op" id="3855099">)</span>&nbsp;<span class="ident" id="3855101">newBlock</span><span class="op" id="3855109">(</span><span class="op" id="3855110">)</span>&nbsp;<span class="op" id="3855112">*</span><span class="ident" id="3855113"><a href="/crypto/tls/conn.go.html#3853853">block</a></span>&nbsp;<span class="op" id="3855119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855122">b</span>&nbsp;<span class="op" id="3855124">:=</span>&nbsp;<span class="ident" id="3855127"><a href="/crypto/tls/conn.go.html#3855087">hc</a></span><span class="op" id="3855129">.</span><span class="ident" id="3855130">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855137">if</span>&nbsp;<span class="ident" id="3855140"><a href="/crypto/tls/conn.go.html#3855122">b</a></span>&nbsp;<span class="op" id="3855142">==</span>&nbsp;<span class="ident" id="3855145">nil</span>&nbsp;<span class="op" id="3855149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855153">return</span>&nbsp;<span class="builtinfunc" id="3855160">new</span><span class="op" id="3855163">(</span><span class="ident" id="3855164"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><span class="op" id="3855169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855172">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855175"><a href="/crypto/tls/conn.go.html#3855087">hc</a></span><span class="op" id="3855177">.</span><span class="ident" id="3855178">bfree</span>&nbsp;<span class="op" id="3855184">=</span>&nbsp;<span class="ident" id="3855186"><a href="/crypto/tls/conn.go.html#3855122">b</a></span><span class="op" id="3855187">.</span><span class="ident" id="3855188">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855194"><a href="/crypto/tls/conn.go.html#3855122">b</a></span><span class="op" id="3855195">.</span><span class="ident" id="3855196">link</span>&nbsp;<span class="op" id="3855201">=</span>&nbsp;<span class="ident" id="3855203">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855208"><a href="/crypto/tls/conn.go.html#3855122">b</a></span><span class="op" id="3855209">.</span><span class="ident" id="3855210">resize</span><span class="op" id="3855216">(</span><span class="num" id="3855217">0</span><span class="op" id="3855218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855221">return</span>&nbsp;<span class="ident" id="3855228"><a href="/crypto/tls/conn.go.html#3855122">b</a></span><br>
<span class="lineno"></span><span class="op" id="3855230">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="3855233">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="3855281">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3855347">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="3855409">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="3855436">func</span>&nbsp;<span class="op" id="3855441">(</span><span class="ident" id="3855442">hc</span>&nbsp;<span class="op" id="3855445">*</span><span class="ident" id="3855446"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span><span class="op" id="3855454">)</span>&nbsp;<span class="ident" id="3855456">freeBlock</span><span class="op" id="3855465">(</span><span class="ident" id="3855466">b</span>&nbsp;<span class="op" id="3855468">*</span><span class="ident" id="3855469"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><span class="op" id="3855474">)</span>&nbsp;<span class="op" id="3855476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855479"><a href="/crypto/tls/conn.go.html#3855466">b</a></span><span class="op" id="3855480">.</span><span class="ident" id="3855481">link</span>&nbsp;<span class="op" id="3855486">=</span>&nbsp;<span class="ident" id="3855488"><a href="/crypto/tls/conn.go.html#3855442">hc</a></span><span class="op" id="3855490">.</span><span class="ident" id="3855491">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855498"><a href="/crypto/tls/conn.go.html#3855442">hc</a></span><span class="op" id="3855500">.</span><span class="ident" id="3855501">bfree</span>&nbsp;<span class="op" id="3855507">=</span>&nbsp;<span class="ident" id="3855509"><a href="/crypto/tls/conn.go.html#3855466">b</a></span><br>
<span class="lineno"></span><span class="op" id="3855511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="3855514">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="3855568">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3855614">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3855667">func</span>&nbsp;<span class="op" id="3855672">(</span><span class="ident" id="3855673">hc</span>&nbsp;<span class="op" id="3855676">*</span><span class="ident" id="3855677"><a href="/crypto/tls/conn.go.html#3844940">halfConn</a></span><span class="op" id="3855685">)</span>&nbsp;<span class="ident" id="3855687">splitBlock</span><span class="op" id="3855697">(</span><span class="ident" id="3855698">b</span>&nbsp;<span class="op" id="3855700">*</span><span class="ident" id="3855701"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><span class="op" id="3855706">,</span>&nbsp;<span class="ident" id="3855708">n</span>&nbsp;<span class="builtintype" id="3855710">int</span><span class="op" id="3855713">)</span>&nbsp;<span class="op" id="3855715">(</span><span class="op" id="3855716">*</span><span class="ident" id="3855717"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><span class="op" id="3855722">,</span>&nbsp;<span class="op" id="3855724">*</span><span class="ident" id="3855725"><a href="/crypto/tls/conn.go.html#3853853">block</a></span><span class="op" id="3855730">)</span>&nbsp;<span class="op" id="3855732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855735">if</span>&nbsp;<span class="builtinfunc" id="3855738">len</span><span class="op" id="3855741">(</span><span class="ident" id="3855742"><a href="/crypto/tls/conn.go.html#3855698">b</a></span><span class="op" id="3855743">.</span><span class="ident" id="3855744">data</span><span class="op" id="3855748">)</span>&nbsp;<span class="op" id="3855750">&lt;=</span>&nbsp;<span class="ident" id="3855753"><a href="/crypto/tls/conn.go.html#3855708">n</a></span>&nbsp;<span class="op" id="3855755">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855759">return</span>&nbsp;<span class="ident" id="3855766"><a href="/crypto/tls/conn.go.html#3855698">b</a></span><span class="op" id="3855767">,</span>&nbsp;<span class="ident" id="3855769">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855777">bb</span>&nbsp;<span class="op" id="3855780">:=</span>&nbsp;<span class="ident" id="3855783"><a href="/crypto/tls/conn.go.html#3855673">hc</a></span><span class="op" id="3855785">.</span><span class="ident" id="3855786">newBlock</span><span class="op" id="3855794">(</span><span class="op" id="3855795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855798"><a href="/crypto/tls/conn.go.html#3855777">bb</a></span><span class="op" id="3855800">.</span><span class="ident" id="3855801">resize</span><span class="op" id="3855807">(</span><span class="builtinfunc" id="3855808">len</span><span class="op" id="3855811">(</span><span class="ident" id="3855812"><a href="/crypto/tls/conn.go.html#3855698">b</a></span><span class="op" id="3855813">.</span><span class="ident" id="3855814">data</span><span class="op" id="3855818">)</span>&nbsp;<span class="op" id="3855820">-</span>&nbsp;<span class="ident" id="3855822"><a href="/crypto/tls/conn.go.html#3855708">n</a></span><span class="op" id="3855823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3855826">copy</span><span class="op" id="3855830">(</span><span class="ident" id="3855831"><a href="/crypto/tls/conn.go.html#3855777">bb</a></span><span class="op" id="3855833">.</span><span class="ident" id="3855834">data</span><span class="op" id="3855838">,</span>&nbsp;<span class="ident" id="3855840"><a href="/crypto/tls/conn.go.html#3855698">b</a></span><span class="op" id="3855841">.</span><span class="ident" id="3855842">data</span><span class="op" id="3855846">[</span><span class="ident" id="3855847"><a href="/crypto/tls/conn.go.html#3855708">n</a></span><span class="op" id="3855848">:</span><span class="op" id="3855849">]</span><span class="op" id="3855850">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855853"><a href="/crypto/tls/conn.go.html#3855698">b</a></span><span class="op" id="3855854">.</span><span class="ident" id="3855855">data</span>&nbsp;<span class="op" id="3855860">=</span>&nbsp;<span class="ident" id="3855862"><a href="/crypto/tls/conn.go.html#3855698">b</a></span><span class="op" id="3855863">.</span><span class="ident" id="3855864">data</span><span class="op" id="3855868">[</span><span class="num" id="3855869">0</span><span class="op" id="3855870">:</span><span class="ident" id="3855871"><a href="/crypto/tls/conn.go.html#3855708">n</a></span><span class="op" id="3855872">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855875">return</span>&nbsp;<span class="ident" id="3855882"><a href="/crypto/tls/conn.go.html#3855698">b</a></span><span class="op" id="3855883">,</span>&nbsp;<span class="ident" id="3855885"><a href="/crypto/tls/conn.go.html#3855777">bb</a></span><br>
<span class="lineno"></span><span class="op" id="3855888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3855891">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="3855951">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3855990">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3856026">func</span>&nbsp;<span class="op" id="3856031">(</span><span class="ident" id="3856032">c</span>&nbsp;<span class="op" id="3856034">*</span><span class="ident" id="3856035"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3856039">)</span>&nbsp;<span class="ident" id="3856041">readRecord</span><span class="op" id="3856051">(</span><span class="ident" id="3856052">want</span>&nbsp;<span class="ident" id="3856057"><a href="/crypto/tls/common.go.html#3823239">recordType</a></span><span class="op" id="3856067">)</span>&nbsp;<span class="builtintype" id="3856069">error</span>&nbsp;<span class="op" id="3856075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3856078">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3856122">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3856173">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856235">switch</span>&nbsp;<span class="ident" id="3856242"><a href="/crypto/tls/conn.go.html#3856052">want</a></span>&nbsp;<span class="op" id="3856247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856250">default</span><span class="op" id="3856257">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856261"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856262">.</span><span class="ident" id="3856263">sendAlert</span><span class="op" id="3856272">(</span><span class="ident" id="3856273"><a href="/crypto/tls/alert.go.html#3811348">alertInternalError</a></span><span class="op" id="3856291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856295">return</span>&nbsp;<span class="ident" id="3856302"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856303">.</span><span class="ident" id="3856304">in</span><span class="op" id="3856306">.</span><span class="ident" id="3856307">setErrorLocked</span><span class="op" id="3856321">(</span><span class="ident" id="3856322"><a href="/crypto/tls/conn.go.html#3842098">errors</a></span><span class="op" id="3856328">.</span><span class="ident" id="3856329">New</span><span class="op" id="3856332">(</span><span class="string" id="3856333">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="3856369">)</span><span class="op" id="3856370">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856373">case</span>&nbsp;<span class="ident" id="3856378"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3856397">,</span>&nbsp;<span class="ident" id="3856399"><a href="/crypto/tls/common.go.html#3823266">recordTypeChangeCipherSpec</a></span><span class="op" id="3856425">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856429">if</span>&nbsp;<span class="ident" id="3856432"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856433">.</span><span class="ident" id="3856434">handshakeComplete</span>&nbsp;<span class="op" id="3856452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856457"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856458">.</span><span class="ident" id="3856459">sendAlert</span><span class="op" id="3856468">(</span><span class="ident" id="3856469"><a href="/crypto/tls/alert.go.html#3811348">alertInternalError</a></span><span class="op" id="3856487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856492">return</span>&nbsp;<span class="ident" id="3856499"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856500">.</span><span class="ident" id="3856501">in</span><span class="op" id="3856503">.</span><span class="ident" id="3856504">setErrorLocked</span><span class="op" id="3856518">(</span><span class="ident" id="3856519"><a href="/crypto/tls/conn.go.html#3842098">errors</a></span><span class="op" id="3856525">.</span><span class="ident" id="3856526">New</span><span class="op" id="3856529">(</span><span class="string" id="3856530">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3856601">)</span><span class="op" id="3856602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856606">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856609">case</span>&nbsp;<span class="ident" id="3856614"><a href="/crypto/tls/common.go.html#3823398">recordTypeApplicationData</a></span><span class="op" id="3856639">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856643">if</span>&nbsp;<span class="op" id="3856646">!</span><span class="ident" id="3856647"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856648">.</span><span class="ident" id="3856649">handshakeComplete</span>&nbsp;<span class="op" id="3856667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856672"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856673">.</span><span class="ident" id="3856674">sendAlert</span><span class="op" id="3856683">(</span><span class="ident" id="3856684"><a href="/crypto/tls/alert.go.html#3811348">alertInternalError</a></span><span class="op" id="3856702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856707">return</span>&nbsp;<span class="ident" id="3856714"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856715">.</span><span class="ident" id="3856716">in</span><span class="op" id="3856718">.</span><span class="ident" id="3856719">setErrorLocked</span><span class="op" id="3856733">(</span><span class="ident" id="3856734"><a href="/crypto/tls/conn.go.html#3842098">errors</a></span><span class="op" id="3856740">.</span><span class="ident" id="3856741">New</span><span class="op" id="3856744">(</span><span class="string" id="3856745">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3856811">)</span><span class="op" id="3856812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856816">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3856822">Again</span><span class="op" id="3856827">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856830">if</span>&nbsp;<span class="ident" id="3856833"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856834">.</span><span class="ident" id="3856835">rawInput</span>&nbsp;<span class="op" id="3856844">==</span>&nbsp;<span class="ident" id="3856847">nil</span>&nbsp;<span class="op" id="3856851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856855"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856856">.</span><span class="ident" id="3856857">rawInput</span>&nbsp;<span class="op" id="3856866">=</span>&nbsp;<span class="ident" id="3856868"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856869">.</span><span class="ident" id="3856870">in</span><span class="op" id="3856872">.</span><span class="ident" id="3856873">newBlock</span><span class="op" id="3856881">(</span><span class="op" id="3856882">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856888">b</span>&nbsp;<span class="op" id="3856890">:=</span>&nbsp;<span class="ident" id="3856893"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856894">.</span><span class="ident" id="3856895">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3856906">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856932">if</span>&nbsp;<span class="ident" id="3856935">err</span>&nbsp;<span class="op" id="3856939">:=</span>&nbsp;<span class="ident" id="3856942"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3856943">.</span><span class="ident" id="3856944">readFromUntil</span><span class="op" id="3856957">(</span><span class="ident" id="3856958"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3856959">.</span><span class="ident" id="3856960">conn</span><span class="op" id="3856964">,</span>&nbsp;<span class="ident" id="3856966"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3856981">)</span><span class="op" id="3856982">;</span>&nbsp;<span class="ident" id="3856984"><a href="/crypto/tls/conn.go.html#3856935">err</a></span>&nbsp;<span class="op" id="3856988">!=</span>&nbsp;<span class="ident" id="3856991">nil</span>&nbsp;<span class="op" id="3856995">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3856999">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3857057">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3857111">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3857146">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3857170">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3857202">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857209">if</span>&nbsp;<span class="ident" id="3857212">e</span><span class="op" id="3857213">,</span>&nbsp;<span class="ident" id="3857215">ok</span>&nbsp;<span class="op" id="3857218">:=</span>&nbsp;<span class="ident" id="3857221"><a href="/crypto/tls/conn.go.html#3856935">err</a></span><span class="op" id="3857224">.</span><span class="op" id="3857225">(</span><span class="ident" id="3857226"><a href="/crypto/tls/conn.go.html#3842121">net</a></span><span class="op" id="3857229">.</span><span class="ident" id="3857230">Error</span><span class="op" id="3857235">)</span><span class="op" id="3857236">;</span>&nbsp;<span class="op" id="3857238">!</span><span class="ident" id="3857239"><a href="/crypto/tls/conn.go.html#3857215">ok</a></span>&nbsp;<span class="op" id="3857242">||</span>&nbsp;<span class="op" id="3857245">!</span><span class="ident" id="3857246"><a href="/crypto/tls/conn.go.html#3857212">e</a></span><span class="op" id="3857247">.</span><span class="ident" id="3857248">Temporary</span><span class="op" id="3857257">(</span><span class="op" id="3857258">)</span>&nbsp;<span class="op" id="3857260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857265"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3857266">.</span><span class="ident" id="3857267">in</span><span class="op" id="3857269">.</span><span class="ident" id="3857270">setErrorLocked</span><span class="op" id="3857284">(</span><span class="ident" id="3857285"><a href="/crypto/tls/conn.go.html#3856935">err</a></span><span class="op" id="3857288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857296">return</span>&nbsp;<span class="ident" id="3857303"><a href="/crypto/tls/conn.go.html#3856935">err</a></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857311">typ</span>&nbsp;<span class="op" id="3857315">:=</span>&nbsp;<span class="ident" id="3857318"><a href="/crypto/tls/common.go.html#3823239">recordType</a></span><span class="op" id="3857328">(</span><span class="ident" id="3857329"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3857330">.</span><span class="ident" id="3857331">data</span><span class="op" id="3857335">[</span><span class="num" id="3857336">0</span><span class="op" id="3857337">]</span><span class="op" id="3857338">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3857342">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3857411">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3857484">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3857556">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857577">if</span>&nbsp;<span class="ident" id="3857580"><a href="/crypto/tls/conn.go.html#3856052">want</a></span>&nbsp;<span class="op" id="3857585">==</span>&nbsp;<span class="ident" id="3857588"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span>&nbsp;<span class="op" id="3857608">&amp;&amp;</span>&nbsp;<span class="ident" id="3857611"><a href="/crypto/tls/conn.go.html#3857311">typ</a></span>&nbsp;<span class="op" id="3857615">==</span>&nbsp;<span class="num" id="3857618">0x80</span>&nbsp;<span class="op" id="3857623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857627"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3857628">.</span><span class="ident" id="3857629">sendAlert</span><span class="op" id="3857638">(</span><span class="ident" id="3857639"><a href="/crypto/tls/alert.go.html#3811268">alertProtocolVersion</a></span><span class="op" id="3857659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857663">return</span>&nbsp;<span class="ident" id="3857670"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3857671">.</span><span class="ident" id="3857672">in</span><span class="op" id="3857674">.</span><span class="ident" id="3857675">setErrorLocked</span><span class="op" id="3857689">(</span><span class="ident" id="3857690"><a href="/crypto/tls/conn.go.html#3842098">errors</a></span><span class="op" id="3857696">.</span><span class="ident" id="3857697">New</span><span class="op" id="3857700">(</span><span class="string" id="3857701">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="3857744">)</span><span class="op" id="3857745">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857752">vers</span>&nbsp;<span class="op" id="3857757">:=</span>&nbsp;<span class="builtintype" id="3857760">uint16</span><span class="op" id="3857766">(</span><span class="ident" id="3857767"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3857768">.</span><span class="ident" id="3857769">data</span><span class="op" id="3857773">[</span><span class="num" id="3857774">1</span><span class="op" id="3857775">]</span><span class="op" id="3857776">)</span><span class="op" id="3857777">&lt;&lt;</span><span class="num" id="3857779">8</span>&nbsp;<span class="op" id="3857781">|</span>&nbsp;<span class="builtintype" id="3857783">uint16</span><span class="op" id="3857789">(</span><span class="ident" id="3857790"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3857791">.</span><span class="ident" id="3857792">data</span><span class="op" id="3857796">[</span><span class="num" id="3857797">2</span><span class="op" id="3857798">]</span><span class="op" id="3857799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857802">n</span>&nbsp;<span class="op" id="3857804">:=</span>&nbsp;<span class="builtintype" id="3857807">int</span><span class="op" id="3857810">(</span><span class="ident" id="3857811"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3857812">.</span><span class="ident" id="3857813">data</span><span class="op" id="3857817">[</span><span class="num" id="3857818">3</span><span class="op" id="3857819">]</span><span class="op" id="3857820">)</span><span class="op" id="3857821">&lt;&lt;</span><span class="num" id="3857823">8</span>&nbsp;<span class="op" id="3857825">|</span>&nbsp;<span class="builtintype" id="3857827">int</span><span class="op" id="3857830">(</span><span class="ident" id="3857831"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3857832">.</span><span class="ident" id="3857833">data</span><span class="op" id="3857837">[</span><span class="num" id="3857838">4</span><span class="op" id="3857839">]</span><span class="op" id="3857840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857843">if</span>&nbsp;<span class="ident" id="3857846"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3857847">.</span><span class="ident" id="3857848">haveVers</span>&nbsp;<span class="op" id="3857857">&amp;&amp;</span>&nbsp;<span class="ident" id="3857860"><a href="/crypto/tls/conn.go.html#3857752">vers</a></span>&nbsp;<span class="op" id="3857865">!=</span>&nbsp;<span class="ident" id="3857868"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3857869">.</span><span class="ident" id="3857870">vers</span>&nbsp;<span class="op" id="3857875">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857879"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3857880">.</span><span class="ident" id="3857881">sendAlert</span><span class="op" id="3857890">(</span><span class="ident" id="3857891"><a href="/crypto/tls/alert.go.html#3811268">alertProtocolVersion</a></span><span class="op" id="3857911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857915">return</span>&nbsp;<span class="ident" id="3857922"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3857923">.</span><span class="ident" id="3857924">in</span><span class="op" id="3857926">.</span><span class="ident" id="3857927">setErrorLocked</span><span class="op" id="3857941">(</span><span class="ident" id="3857942"><a href="/crypto/tls/conn.go.html#3842108">fmt</a></span><span class="op" id="3857945">.</span><span class="ident" id="3857946">Errorf</span><span class="op" id="3857952">(</span><span class="string" id="3857953">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3858017">,</span>&nbsp;<span class="ident" id="3858019"><a href="/crypto/tls/conn.go.html#3857752">vers</a></span><span class="op" id="3858023">,</span>&nbsp;<span class="ident" id="3858025"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3858026">.</span><span class="ident" id="3858027">vers</span><span class="op" id="3858031">)</span><span class="op" id="3858032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858038">if</span>&nbsp;<span class="ident" id="3858041"><a href="/crypto/tls/conn.go.html#3857802">n</a></span>&nbsp;<span class="op" id="3858043">&gt;</span>&nbsp;<span class="ident" id="3858045"><a href="/crypto/tls/common.go.html#3822943">maxCiphertext</a></span>&nbsp;<span class="op" id="3858059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858063"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3858064">.</span><span class="ident" id="3858065">sendAlert</span><span class="op" id="3858074">(</span><span class="ident" id="3858075"><a href="/crypto/tls/alert.go.html#3810748">alertRecordOverflow</a></span><span class="op" id="3858094">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858098">return</span>&nbsp;<span class="ident" id="3858105"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3858106">.</span><span class="ident" id="3858107">in</span><span class="op" id="3858109">.</span><span class="ident" id="3858110">setErrorLocked</span><span class="op" id="3858124">(</span><span class="ident" id="3858125"><a href="/crypto/tls/conn.go.html#3842108">fmt</a></span><span class="op" id="3858128">.</span><span class="ident" id="3858129">Errorf</span><span class="op" id="3858135">(</span><span class="string" id="3858136">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3858183">,</span>&nbsp;<span class="ident" id="3858185"><a href="/crypto/tls/conn.go.html#3857802">n</a></span><span class="op" id="3858186">)</span><span class="op" id="3858187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858193">if</span>&nbsp;<span class="op" id="3858196">!</span><span class="ident" id="3858197"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3858198">.</span><span class="ident" id="3858199">haveVers</span>&nbsp;<span class="op" id="3858208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858212">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858253">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858290">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858347">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858384">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858440">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858489">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858545">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858574">if</span>&nbsp;<span class="op" id="3858577">(</span><span class="ident" id="3858578"><a href="/crypto/tls/conn.go.html#3857311">typ</a></span>&nbsp;<span class="op" id="3858582">!=</span>&nbsp;<span class="ident" id="3858585"><a href="/crypto/tls/common.go.html#3823310">recordTypeAlert</a></span>&nbsp;<span class="op" id="3858601">&amp;&amp;</span>&nbsp;<span class="ident" id="3858604"><a href="/crypto/tls/conn.go.html#3857311">typ</a></span>&nbsp;<span class="op" id="3858608">!=</span>&nbsp;<span class="ident" id="3858611"><a href="/crypto/tls/conn.go.html#3856052">want</a></span><span class="op" id="3858615">)</span>&nbsp;<span class="op" id="3858617">||</span>&nbsp;<span class="ident" id="3858620"><a href="/crypto/tls/conn.go.html#3857752">vers</a></span>&nbsp;<span class="op" id="3858625">&gt;=</span>&nbsp;<span class="num" id="3858628">0x1000</span>&nbsp;<span class="op" id="3858635">||</span>&nbsp;<span class="ident" id="3858638"><a href="/crypto/tls/conn.go.html#3857802">n</a></span>&nbsp;<span class="op" id="3858640">&gt;=</span>&nbsp;<span class="num" id="3858643">0x3000</span>&nbsp;<span class="op" id="3858650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858655"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3858656">.</span><span class="ident" id="3858657">sendAlert</span><span class="op" id="3858666">(</span><span class="ident" id="3858667"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3858689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858694">return</span>&nbsp;<span class="ident" id="3858701"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3858702">.</span><span class="ident" id="3858703">in</span><span class="op" id="3858705">.</span><span class="ident" id="3858706">setErrorLocked</span><span class="op" id="3858720">(</span><span class="ident" id="3858721"><a href="/crypto/tls/conn.go.html#3842108">fmt</a></span><span class="op" id="3858724">.</span><span class="ident" id="3858725">Errorf</span><span class="op" id="3858731">(</span><span class="string" id="3858732">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="3858786">)</span><span class="op" id="3858787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858791">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858797">if</span>&nbsp;<span class="ident" id="3858800">err</span>&nbsp;<span class="op" id="3858804">:=</span>&nbsp;<span class="ident" id="3858807"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3858808">.</span><span class="ident" id="3858809">readFromUntil</span><span class="op" id="3858822">(</span><span class="ident" id="3858823"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3858824">.</span><span class="ident" id="3858825">conn</span><span class="op" id="3858829">,</span>&nbsp;<span class="ident" id="3858831"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3858846">+</span><span class="ident" id="3858847"><a href="/crypto/tls/conn.go.html#3857802">n</a></span><span class="op" id="3858848">)</span><span class="op" id="3858849">;</span>&nbsp;<span class="ident" id="3858851"><a href="/crypto/tls/conn.go.html#3858800">err</a></span>&nbsp;<span class="op" id="3858855">!=</span>&nbsp;<span class="ident" id="3858858">nil</span>&nbsp;<span class="op" id="3858862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858866">if</span>&nbsp;<span class="ident" id="3858869"><a href="/crypto/tls/conn.go.html#3858800">err</a></span>&nbsp;<span class="op" id="3858873">==</span>&nbsp;<span class="ident" id="3858876"><a href="/crypto/tls/conn.go.html#3842115">io</a></span><span class="op" id="3858878">.</span><span class="ident" id="3858879">EOF</span>&nbsp;<span class="op" id="3858883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858888"><a href="/crypto/tls/conn.go.html#3858800">err</a></span>&nbsp;<span class="op" id="3858892">=</span>&nbsp;<span class="ident" id="3858894"><a href="/crypto/tls/conn.go.html#3842115">io</a></span><span class="op" id="3858896">.</span><span class="ident" id="3858897">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858916">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858920">if</span>&nbsp;<span class="ident" id="3858923">e</span><span class="op" id="3858924">,</span>&nbsp;<span class="ident" id="3858926">ok</span>&nbsp;<span class="op" id="3858929">:=</span>&nbsp;<span class="ident" id="3858932"><a href="/crypto/tls/conn.go.html#3858800">err</a></span><span class="op" id="3858935">.</span><span class="op" id="3858936">(</span><span class="ident" id="3858937"><a href="/crypto/tls/conn.go.html#3842121">net</a></span><span class="op" id="3858940">.</span><span class="ident" id="3858941">Error</span><span class="op" id="3858946">)</span><span class="op" id="3858947">;</span>&nbsp;<span class="op" id="3858949">!</span><span class="ident" id="3858950"><a href="/crypto/tls/conn.go.html#3858926">ok</a></span>&nbsp;<span class="op" id="3858953">||</span>&nbsp;<span class="op" id="3858956">!</span><span class="ident" id="3858957"><a href="/crypto/tls/conn.go.html#3858923">e</a></span><span class="op" id="3858958">.</span><span class="ident" id="3858959">Temporary</span><span class="op" id="3858968">(</span><span class="op" id="3858969">)</span>&nbsp;<span class="op" id="3858971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858976"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3858977">.</span><span class="ident" id="3858978">in</span><span class="op" id="3858980">.</span><span class="ident" id="3858981">setErrorLocked</span><span class="op" id="3858995">(</span><span class="ident" id="3858996"><a href="/crypto/tls/conn.go.html#3858800">err</a></span><span class="op" id="3858999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859007">return</span>&nbsp;<span class="ident" id="3859014"><a href="/crypto/tls/conn.go.html#3858800">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859019">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859023">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859044"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3859045">,</span>&nbsp;<span class="ident" id="3859047"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859048">.</span><span class="ident" id="3859049">rawInput</span>&nbsp;<span class="op" id="3859058">=</span>&nbsp;<span class="ident" id="3859060"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859061">.</span><span class="ident" id="3859062">in</span><span class="op" id="3859064">.</span><span class="ident" id="3859065">splitBlock</span><span class="op" id="3859075">(</span><span class="ident" id="3859076"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3859077">,</span>&nbsp;<span class="ident" id="3859079"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3859094">+</span><span class="ident" id="3859095"><a href="/crypto/tls/conn.go.html#3857802">n</a></span><span class="op" id="3859096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859099">ok</span><span class="op" id="3859101">,</span>&nbsp;<span class="ident" id="3859103">off</span><span class="op" id="3859106">,</span>&nbsp;<span class="ident" id="3859108">err</span>&nbsp;<span class="op" id="3859112">:=</span>&nbsp;<span class="ident" id="3859115"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859116">.</span><span class="ident" id="3859117">in</span><span class="op" id="3859119">.</span><span class="ident" id="3859120">decrypt</span><span class="op" id="3859127">(</span><span class="ident" id="3859128"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3859129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859132">if</span>&nbsp;<span class="op" id="3859135">!</span><span class="ident" id="3859136"><a href="/crypto/tls/conn.go.html#3859099">ok</a></span>&nbsp;<span class="op" id="3859139">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859143"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859144">.</span><span class="ident" id="3859145">in</span><span class="op" id="3859147">.</span><span class="ident" id="3859148">setErrorLocked</span><span class="op" id="3859162">(</span><span class="ident" id="3859163"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859164">.</span><span class="ident" id="3859165">sendAlert</span><span class="op" id="3859174">(</span><span class="ident" id="3859175"><a href="/crypto/tls/conn.go.html#3859108">err</a></span><span class="op" id="3859178">)</span><span class="op" id="3859179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859185"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3859186">.</span><span class="ident" id="3859187">off</span>&nbsp;<span class="op" id="3859191">=</span>&nbsp;<span class="ident" id="3859193"><a href="/crypto/tls/conn.go.html#3859103">off</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859198">data</span>&nbsp;<span class="op" id="3859203">:=</span>&nbsp;<span class="ident" id="3859206"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3859207">.</span><span class="ident" id="3859208">data</span><span class="op" id="3859212">[</span><span class="ident" id="3859213"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3859214">.</span><span class="ident" id="3859215">off</span><span class="op" id="3859218">:</span><span class="op" id="3859219">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859222">if</span>&nbsp;<span class="builtinfunc" id="3859225">len</span><span class="op" id="3859228">(</span><span class="ident" id="3859229"><a href="/crypto/tls/conn.go.html#3859198">data</a></span><span class="op" id="3859233">)</span>&nbsp;<span class="op" id="3859235">&gt;</span>&nbsp;<span class="ident" id="3859237"><a href="/crypto/tls/common.go.html#3822875">maxPlaintext</a></span>&nbsp;<span class="op" id="3859250">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859254">err</span>&nbsp;<span class="op" id="3859258">:=</span>&nbsp;<span class="ident" id="3859261"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859262">.</span><span class="ident" id="3859263">sendAlert</span><span class="op" id="3859272">(</span><span class="ident" id="3859273"><a href="/crypto/tls/alert.go.html#3810748">alertRecordOverflow</a></span><span class="op" id="3859292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859296"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859297">.</span><span class="ident" id="3859298">in</span><span class="op" id="3859300">.</span><span class="ident" id="3859301">freeBlock</span><span class="op" id="3859310">(</span><span class="ident" id="3859311"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3859312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859316">return</span>&nbsp;<span class="ident" id="3859323"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859324">.</span><span class="ident" id="3859325">in</span><span class="op" id="3859327">.</span><span class="ident" id="3859328">setErrorLocked</span><span class="op" id="3859342">(</span><span class="ident" id="3859343"><a href="/crypto/tls/conn.go.html#3859254">err</a></span><span class="op" id="3859346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859353">switch</span>&nbsp;<span class="ident" id="3859360"><a href="/crypto/tls/conn.go.html#3857311">typ</a></span>&nbsp;<span class="op" id="3859364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859367">default</span><span class="op" id="3859374">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859378"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859379">.</span><span class="ident" id="3859380">in</span><span class="op" id="3859382">.</span><span class="ident" id="3859383">setErrorLocked</span><span class="op" id="3859397">(</span><span class="ident" id="3859398"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859399">.</span><span class="ident" id="3859400">sendAlert</span><span class="op" id="3859409">(</span><span class="ident" id="3859410"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3859432">)</span><span class="op" id="3859433">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859437">case</span>&nbsp;<span class="ident" id="3859442"><a href="/crypto/tls/common.go.html#3823310">recordTypeAlert</a></span><span class="op" id="3859457">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859461">if</span>&nbsp;<span class="builtinfunc" id="3859464">len</span><span class="op" id="3859467">(</span><span class="ident" id="3859468"><a href="/crypto/tls/conn.go.html#3859198">data</a></span><span class="op" id="3859472">)</span>&nbsp;<span class="op" id="3859474">!=</span>&nbsp;<span class="num" id="3859477">2</span>&nbsp;<span class="op" id="3859479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859484"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859485">.</span><span class="ident" id="3859486">in</span><span class="op" id="3859488">.</span><span class="ident" id="3859489">setErrorLocked</span><span class="op" id="3859503">(</span><span class="ident" id="3859504"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859505">.</span><span class="ident" id="3859506">sendAlert</span><span class="op" id="3859515">(</span><span class="ident" id="3859516"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3859538">)</span><span class="op" id="3859539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859544">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859556">if</span>&nbsp;<span class="ident" id="3859559"><a href="/crypto/tls/alert.go.html#3810494">alert</a></span><span class="op" id="3859564">(</span><span class="ident" id="3859565"><a href="/crypto/tls/conn.go.html#3859198">data</a></span><span class="op" id="3859569">[</span><span class="num" id="3859570">1</span><span class="op" id="3859571">]</span><span class="op" id="3859572">)</span>&nbsp;<span class="op" id="3859574">==</span>&nbsp;<span class="ident" id="3859577"><a href="/crypto/tls/alert.go.html#3810589">alertCloseNotify</a></span>&nbsp;<span class="op" id="3859594">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859599"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859600">.</span><span class="ident" id="3859601">in</span><span class="op" id="3859603">.</span><span class="ident" id="3859604">setErrorLocked</span><span class="op" id="3859618">(</span><span class="ident" id="3859619"><a href="/crypto/tls/conn.go.html#3842115">io</a></span><span class="op" id="3859621">.</span><span class="ident" id="3859622">EOF</span><span class="op" id="3859625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859630">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859642">switch</span>&nbsp;<span class="ident" id="3859649"><a href="/crypto/tls/conn.go.html#3859198">data</a></span><span class="op" id="3859653">[</span><span class="num" id="3859654">0</span><span class="op" id="3859655">]</span>&nbsp;<span class="op" id="3859657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859661">case</span>&nbsp;<span class="ident" id="3859666"><a href="/crypto/tls/alert.go.html#3810532">alertLevelWarning</a></span><span class="op" id="3859683">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859688">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859712"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859713">.</span><span class="ident" id="3859714">in</span><span class="op" id="3859716">.</span><span class="ident" id="3859717">freeBlock</span><span class="op" id="3859726">(</span><span class="ident" id="3859727"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3859728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859733">goto</span>&nbsp;<span class="ident" id="3859738">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859746">case</span>&nbsp;<span class="ident" id="3859751"><a href="/crypto/tls/alert.go.html#3810555">alertLevelError</a></span><span class="op" id="3859766">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859771"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859772">.</span><span class="ident" id="3859773">in</span><span class="op" id="3859775">.</span><span class="ident" id="3859776">setErrorLocked</span><span class="op" id="3859790">(</span><span class="op" id="3859791">&amp;</span><span class="ident" id="3859792"><a href="/crypto/tls/conn.go.html#3842121">net</a></span><span class="op" id="3859795">.</span><span class="ident" id="3859796">OpError</span><span class="op" id="3859803">{</span><span class="ident" id="3859804">Op</span><span class="op" id="3859806">:</span>&nbsp;<span class="string" id="3859808">&#34;remote&nbsp;error&#34;</span><span class="op" id="3859822">,</span>&nbsp;<span class="ident" id="3859824">Err</span><span class="op" id="3859827">:</span>&nbsp;<span class="ident" id="3859829"><a href="/crypto/tls/alert.go.html#3810494">alert</a></span><span class="op" id="3859834">(</span><span class="ident" id="3859835"><a href="/crypto/tls/conn.go.html#3859198">data</a></span><span class="op" id="3859839">[</span><span class="num" id="3859840">1</span><span class="op" id="3859841">]</span><span class="op" id="3859842">)</span><span class="op" id="3859843">}</span><span class="op" id="3859844">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859848">default</span><span class="op" id="3859855">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859860"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859861">.</span><span class="ident" id="3859862">in</span><span class="op" id="3859864">.</span><span class="ident" id="3859865">setErrorLocked</span><span class="op" id="3859879">(</span><span class="ident" id="3859880"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3859881">.</span><span class="ident" id="3859882">sendAlert</span><span class="op" id="3859891">(</span><span class="ident" id="3859892"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3859914">)</span><span class="op" id="3859915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859923">case</span>&nbsp;<span class="ident" id="3859928"><a href="/crypto/tls/common.go.html#3823266">recordTypeChangeCipherSpec</a></span><span class="op" id="3859954">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859958">if</span>&nbsp;<span class="ident" id="3859961"><a href="/crypto/tls/conn.go.html#3857311">typ</a></span>&nbsp;<span class="op" id="3859965">!=</span>&nbsp;<span class="ident" id="3859968"><a href="/crypto/tls/conn.go.html#3856052">want</a></span>&nbsp;<span class="op" id="3859973">||</span>&nbsp;<span class="builtinfunc" id="3859976">len</span><span class="op" id="3859979">(</span><span class="ident" id="3859980"><a href="/crypto/tls/conn.go.html#3859198">data</a></span><span class="op" id="3859984">)</span>&nbsp;<span class="op" id="3859986">!=</span>&nbsp;<span class="num" id="3859989">1</span>&nbsp;<span class="op" id="3859991">||</span>&nbsp;<span class="ident" id="3859994"><a href="/crypto/tls/conn.go.html#3859198">data</a></span><span class="op" id="3859998">[</span><span class="num" id="3859999">0</span><span class="op" id="3860000">]</span>&nbsp;<span class="op" id="3860002">!=</span>&nbsp;<span class="num" id="3860005">1</span>&nbsp;<span class="op" id="3860007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860012"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860013">.</span><span class="ident" id="3860014">in</span><span class="op" id="3860016">.</span><span class="ident" id="3860017">setErrorLocked</span><span class="op" id="3860031">(</span><span class="ident" id="3860032"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860033">.</span><span class="ident" id="3860034">sendAlert</span><span class="op" id="3860043">(</span><span class="ident" id="3860044"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3860066">)</span><span class="op" id="3860067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860072">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860084">err</span>&nbsp;<span class="op" id="3860088">:=</span>&nbsp;<span class="ident" id="3860091"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860092">.</span><span class="ident" id="3860093">in</span><span class="op" id="3860095">.</span><span class="ident" id="3860096">changeCipherSpec</span><span class="op" id="3860112">(</span><span class="op" id="3860113">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860117">if</span>&nbsp;<span class="ident" id="3860120"><a href="/crypto/tls/conn.go.html#3860084">err</a></span>&nbsp;<span class="op" id="3860124">!=</span>&nbsp;<span class="ident" id="3860127">nil</span>&nbsp;<span class="op" id="3860131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860136"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860137">.</span><span class="ident" id="3860138">in</span><span class="op" id="3860140">.</span><span class="ident" id="3860141">setErrorLocked</span><span class="op" id="3860155">(</span><span class="ident" id="3860156"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860157">.</span><span class="ident" id="3860158">sendAlert</span><span class="op" id="3860167">(</span><span class="ident" id="3860168"><a href="/crypto/tls/conn.go.html#3860084">err</a></span><span class="op" id="3860171">.</span><span class="op" id="3860172">(</span><span class="ident" id="3860173"><a href="/crypto/tls/alert.go.html#3810494">alert</a></span><span class="op" id="3860178">)</span><span class="op" id="3860179">)</span><span class="op" id="3860180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860188">case</span>&nbsp;<span class="ident" id="3860193"><a href="/crypto/tls/common.go.html#3823398">recordTypeApplicationData</a></span><span class="op" id="3860218">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860222">if</span>&nbsp;<span class="ident" id="3860225"><a href="/crypto/tls/conn.go.html#3857311">typ</a></span>&nbsp;<span class="op" id="3860229">!=</span>&nbsp;<span class="ident" id="3860232"><a href="/crypto/tls/conn.go.html#3856052">want</a></span>&nbsp;<span class="op" id="3860237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860242"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860243">.</span><span class="ident" id="3860244">in</span><span class="op" id="3860246">.</span><span class="ident" id="3860247">setErrorLocked</span><span class="op" id="3860261">(</span><span class="ident" id="3860262"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860263">.</span><span class="ident" id="3860264">sendAlert</span><span class="op" id="3860273">(</span><span class="ident" id="3860274"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3860296">)</span><span class="op" id="3860297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860302">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860314"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860315">.</span><span class="ident" id="3860316">input</span>&nbsp;<span class="op" id="3860322">=</span>&nbsp;<span class="ident" id="3860324"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860328"><a href="/crypto/tls/conn.go.html#3856888">b</a></span>&nbsp;<span class="op" id="3860330">=</span>&nbsp;<span class="ident" id="3860332">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860338">case</span>&nbsp;<span class="ident" id="3860343"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3860362">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860366">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860425">if</span>&nbsp;<span class="ident" id="3860428"><a href="/crypto/tls/conn.go.html#3857311">typ</a></span>&nbsp;<span class="op" id="3860432">!=</span>&nbsp;<span class="ident" id="3860435"><a href="/crypto/tls/conn.go.html#3856052">want</a></span>&nbsp;<span class="op" id="3860440">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860445">return</span>&nbsp;<span class="ident" id="3860452"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860453">.</span><span class="ident" id="3860454">in</span><span class="op" id="3860456">.</span><span class="ident" id="3860457">setErrorLocked</span><span class="op" id="3860471">(</span><span class="ident" id="3860472"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860473">.</span><span class="ident" id="3860474">sendAlert</span><span class="op" id="3860483">(</span><span class="ident" id="3860484"><a href="/crypto/tls/alert.go.html#3811468">alertNoRenegotiation</a></span><span class="op" id="3860504">)</span><span class="op" id="3860505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860513"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860514">.</span><span class="ident" id="3860515">hand</span><span class="op" id="3860519">.</span><span class="ident" id="3860520">Write</span><span class="op" id="3860525">(</span><span class="ident" id="3860526"><a href="/crypto/tls/conn.go.html#3859198">data</a></span><span class="op" id="3860530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860537">if</span>&nbsp;<span class="ident" id="3860540"><a href="/crypto/tls/conn.go.html#3856888">b</a></span>&nbsp;<span class="op" id="3860542">!=</span>&nbsp;<span class="ident" id="3860545">nil</span>&nbsp;<span class="op" id="3860549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860553"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860554">.</span><span class="ident" id="3860555">in</span><span class="op" id="3860557">.</span><span class="ident" id="3860558">freeBlock</span><span class="op" id="3860567">(</span><span class="ident" id="3860568"><a href="/crypto/tls/conn.go.html#3856888">b</a></span><span class="op" id="3860569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860575">return</span>&nbsp;<span class="ident" id="3860582"><a href="/crypto/tls/conn.go.html#3856032">c</a></span><span class="op" id="3860583">.</span><span class="ident" id="3860584">in</span><span class="op" id="3860586">.</span><span class="ident" id="3860587">err</span><br>
<span class="lineno"></span><span class="op" id="3860591">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3860594">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="3860634">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3860655">func</span>&nbsp;<span class="op" id="3860660">(</span><span class="ident" id="3860661">c</span>&nbsp;<span class="op" id="3860663">*</span><span class="ident" id="3860664"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3860668">)</span>&nbsp;<span class="ident" id="3860670">sendAlertLocked</span><span class="op" id="3860685">(</span><span class="ident" id="3860686">err</span>&nbsp;<span class="ident" id="3860690"><a href="/crypto/tls/alert.go.html#3810494">alert</a></span><span class="op" id="3860695">)</span>&nbsp;<span class="builtintype" id="3860697">error</span>&nbsp;<span class="op" id="3860703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860706">switch</span>&nbsp;<span class="ident" id="3860713"><a href="/crypto/tls/conn.go.html#3860686">err</a></span>&nbsp;<span class="op" id="3860717">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860720">case</span>&nbsp;<span class="ident" id="3860725"><a href="/crypto/tls/alert.go.html#3811468">alertNoRenegotiation</a></span><span class="op" id="3860745">,</span>&nbsp;<span class="ident" id="3860747"><a href="/crypto/tls/alert.go.html#3810589">alertCloseNotify</a></span><span class="op" id="3860763">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860767"><a href="/crypto/tls/conn.go.html#3860661">c</a></span><span class="op" id="3860768">.</span><span class="ident" id="3860769">tmp</span><span class="op" id="3860772">[</span><span class="num" id="3860773">0</span><span class="op" id="3860774">]</span>&nbsp;<span class="op" id="3860776">=</span>&nbsp;<span class="ident" id="3860778"><a href="/crypto/tls/alert.go.html#3810532">alertLevelWarning</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860797">default</span><span class="op" id="3860804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860808"><a href="/crypto/tls/conn.go.html#3860661">c</a></span><span class="op" id="3860809">.</span><span class="ident" id="3860810">tmp</span><span class="op" id="3860813">[</span><span class="num" id="3860814">0</span><span class="op" id="3860815">]</span>&nbsp;<span class="op" id="3860817">=</span>&nbsp;<span class="ident" id="3860819"><a href="/crypto/tls/alert.go.html#3810555">alertLevelError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860836">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860839"><a href="/crypto/tls/conn.go.html#3860661">c</a></span><span class="op" id="3860840">.</span><span class="ident" id="3860841">tmp</span><span class="op" id="3860844">[</span><span class="num" id="3860845">1</span><span class="op" id="3860846">]</span>&nbsp;<span class="op" id="3860848">=</span>&nbsp;<span class="builtintype" id="3860850">byte</span><span class="op" id="3860854">(</span><span class="ident" id="3860855"><a href="/crypto/tls/conn.go.html#3860686">err</a></span><span class="op" id="3860858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860861"><a href="/crypto/tls/conn.go.html#3860661">c</a></span><span class="op" id="3860862">.</span><span class="ident" id="3860863">writeRecord</span><span class="op" id="3860874">(</span><span class="ident" id="3860875"><a href="/crypto/tls/common.go.html#3823310">recordTypeAlert</a></span><span class="op" id="3860890">,</span>&nbsp;<span class="ident" id="3860892"><a href="/crypto/tls/conn.go.html#3860661">c</a></span><span class="op" id="3860893">.</span><span class="ident" id="3860894">tmp</span><span class="op" id="3860897">[</span><span class="num" id="3860898">0</span><span class="op" id="3860899">:</span><span class="num" id="3860900">2</span><span class="op" id="3860901">]</span><span class="op" id="3860902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860905">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860966">if</span>&nbsp;<span class="ident" id="3860969"><a href="/crypto/tls/conn.go.html#3860686">err</a></span>&nbsp;<span class="op" id="3860973">!=</span>&nbsp;<span class="ident" id="3860976"><a href="/crypto/tls/alert.go.html#3810589">alertCloseNotify</a></span>&nbsp;<span class="op" id="3860993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860997">return</span>&nbsp;<span class="ident" id="3861004"><a href="/crypto/tls/conn.go.html#3860661">c</a></span><span class="op" id="3861005">.</span><span class="ident" id="3861006">out</span><span class="op" id="3861009">.</span><span class="ident" id="3861010">setErrorLocked</span><span class="op" id="3861024">(</span><span class="op" id="3861025">&amp;</span><span class="ident" id="3861026"><a href="/crypto/tls/conn.go.html#3842121">net</a></span><span class="op" id="3861029">.</span><span class="ident" id="3861030">OpError</span><span class="op" id="3861037">{</span><span class="ident" id="3861038">Op</span><span class="op" id="3861040">:</span>&nbsp;<span class="string" id="3861042">&#34;local&nbsp;error&#34;</span><span class="op" id="3861055">,</span>&nbsp;<span class="ident" id="3861057">Err</span><span class="op" id="3861060">:</span>&nbsp;<span class="ident" id="3861062"><a href="/crypto/tls/conn.go.html#3860686">err</a></span><span class="op" id="3861065">}</span><span class="op" id="3861066">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861072">return</span>&nbsp;<span class="ident" id="3861079">nil</span><br>
<span class="lineno"></span><span class="op" id="3861083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3861086">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="3861126">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="3861146">func</span>&nbsp;<span class="op" id="3861151">(</span><span class="ident" id="3861152">c</span>&nbsp;<span class="op" id="3861154">*</span><span class="ident" id="3861155"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3861159">)</span>&nbsp;<span class="ident" id="3861161">sendAlert</span><span class="op" id="3861170">(</span><span class="ident" id="3861171">err</span>&nbsp;<span class="ident" id="3861175"><a href="/crypto/tls/alert.go.html#3810494">alert</a></span><span class="op" id="3861180">)</span>&nbsp;<span class="builtintype" id="3861182">error</span>&nbsp;<span class="op" id="3861188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861191"><a href="/crypto/tls/conn.go.html#3861152">c</a></span><span class="op" id="3861192">.</span><span class="ident" id="3861193">out</span><span class="op" id="3861196">.</span><span class="ident" id="3861197">Lock</span><span class="op" id="3861201">(</span><span class="op" id="3861202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861205">defer</span>&nbsp;<span class="ident" id="3861211"><a href="/crypto/tls/conn.go.html#3861152">c</a></span><span class="op" id="3861212">.</span><span class="ident" id="3861213">out</span><span class="op" id="3861216">.</span><span class="ident" id="3861217">Unlock</span><span class="op" id="3861223">(</span><span class="op" id="3861224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861227">return</span>&nbsp;<span class="ident" id="3861234"><a href="/crypto/tls/conn.go.html#3861152">c</a></span><span class="op" id="3861235">.</span><span class="ident" id="3861236">sendAlertLocked</span><span class="op" id="3861251">(</span><span class="ident" id="3861252"><a href="/crypto/tls/conn.go.html#3861171">err</a></span><span class="op" id="3861255">)</span><br>
<span class="lineno">690</span><span class="op" id="3861257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3861260">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="3861327">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3861384">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="3861405">func</span>&nbsp;<span class="op" id="3861410">(</span><span class="ident" id="3861411">c</span>&nbsp;<span class="op" id="3861413">*</span><span class="ident" id="3861414"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3861418">)</span>&nbsp;<span class="ident" id="3861420">writeRecord</span><span class="op" id="3861431">(</span><span class="ident" id="3861432">typ</span>&nbsp;<span class="ident" id="3861436"><a href="/crypto/tls/common.go.html#3823239">recordType</a></span><span class="op" id="3861446">,</span>&nbsp;<span class="ident" id="3861448">data</span>&nbsp;<span class="op" id="3861453">[</span><span class="op" id="3861454">]</span><span class="builtintype" id="3861455">byte</span><span class="op" id="3861459">)</span>&nbsp;<span class="op" id="3861461">(</span><span class="ident" id="3861462">n</span>&nbsp;<span class="builtintype" id="3861464">int</span><span class="op" id="3861467">,</span>&nbsp;<span class="ident" id="3861469">err</span>&nbsp;<span class="builtintype" id="3861473">error</span><span class="op" id="3861478">)</span>&nbsp;<span class="op" id="3861480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861483">b</span>&nbsp;<span class="op" id="3861485">:=</span>&nbsp;<span class="ident" id="3861488"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3861489">.</span><span class="ident" id="3861490">out</span><span class="op" id="3861493">.</span><span class="ident" id="3861494">newBlock</span><span class="op" id="3861502">(</span><span class="op" id="3861503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861506">for</span>&nbsp;<span class="builtinfunc" id="3861510">len</span><span class="op" id="3861513">(</span><span class="ident" id="3861514"><a href="/crypto/tls/conn.go.html#3861448">data</a></span><span class="op" id="3861518">)</span>&nbsp;<span class="op" id="3861520">&gt;</span>&nbsp;<span class="num" id="3861522">0</span>&nbsp;<span class="op" id="3861524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861528">m</span>&nbsp;<span class="op" id="3861530">:=</span>&nbsp;<span class="builtinfunc" id="3861533">len</span><span class="op" id="3861536">(</span><span class="ident" id="3861537"><a href="/crypto/tls/conn.go.html#3861448">data</a></span><span class="op" id="3861541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861545">if</span>&nbsp;<span class="ident" id="3861548"><a href="/crypto/tls/conn.go.html#3861528">m</a></span>&nbsp;<span class="op" id="3861550">&gt;</span>&nbsp;<span class="ident" id="3861552"><a href="/crypto/tls/common.go.html#3822875">maxPlaintext</a></span>&nbsp;<span class="op" id="3861565">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861570"><a href="/crypto/tls/conn.go.html#3861528">m</a></span>&nbsp;<span class="op" id="3861572">=</span>&nbsp;<span class="ident" id="3861574"><a href="/crypto/tls/common.go.html#3822875">maxPlaintext</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861593">explicitIVLen</span>&nbsp;<span class="op" id="3861607">:=</span>&nbsp;<span class="num" id="3861610">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861614">explicitIVIsSeq</span>&nbsp;<span class="op" id="3861630">:=</span>&nbsp;<span class="builtintype" id="3861633">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861642">var</span>&nbsp;<span class="ident" id="3861646">cbc</span>&nbsp;<span class="ident" id="3861650"><a href="/crypto/tls/conn.go.html#3848397">cbcMode</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861660">if</span>&nbsp;<span class="ident" id="3861663"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3861664">.</span><span class="ident" id="3861665">out</span><span class="op" id="3861668">.</span><span class="ident" id="3861669">version</span>&nbsp;<span class="op" id="3861677">&gt;=</span>&nbsp;<span class="ident" id="3861680"><a href="/crypto/tls/common.go.html#3822818">VersionTLS11</a></span>&nbsp;<span class="op" id="3861693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861698">var</span>&nbsp;<span class="ident" id="3861702">ok</span>&nbsp;<span class="builtintype" id="3861705">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861713">if</span>&nbsp;<span class="ident" id="3861716"><a href="/crypto/tls/conn.go.html#3861646">cbc</a></span><span class="op" id="3861719">,</span>&nbsp;<span class="ident" id="3861721"><a href="/crypto/tls/conn.go.html#3861702">ok</a></span>&nbsp;<span class="op" id="3861724">=</span>&nbsp;<span class="ident" id="3861726"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3861727">.</span><span class="ident" id="3861728">out</span><span class="op" id="3861731">.</span><span class="ident" id="3861732">cipher</span><span class="op" id="3861738">.</span><span class="op" id="3861739">(</span><span class="ident" id="3861740"><a href="/crypto/tls/conn.go.html#3848397">cbcMode</a></span><span class="op" id="3861747">)</span><span class="op" id="3861748">;</span>&nbsp;<span class="ident" id="3861750"><a href="/crypto/tls/conn.go.html#3861702">ok</a></span>&nbsp;<span class="op" id="3861753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861759"><a href="/crypto/tls/conn.go.html#3861593">explicitIVLen</a></span>&nbsp;<span class="op" id="3861773">=</span>&nbsp;<span class="ident" id="3861775"><a href="/crypto/tls/conn.go.html#3861646">cbc</a></span><span class="op" id="3861778">.</span><span class="ident" id="3861779">BlockSize</span><span class="op" id="3861788">(</span><span class="op" id="3861789">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861802">if</span>&nbsp;<span class="ident" id="3861805"><a href="/crypto/tls/conn.go.html#3861593">explicitIVLen</a></span>&nbsp;<span class="op" id="3861819">==</span>&nbsp;<span class="num" id="3861822">0</span>&nbsp;<span class="op" id="3861824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861829">if</span>&nbsp;<span class="ident" id="3861832">_</span><span class="op" id="3861833">,</span>&nbsp;<span class="ident" id="3861835">ok</span>&nbsp;<span class="op" id="3861838">:=</span>&nbsp;<span class="ident" id="3861841"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3861842">.</span><span class="ident" id="3861843">out</span><span class="op" id="3861846">.</span><span class="ident" id="3861847">cipher</span><span class="op" id="3861853">.</span><span class="op" id="3861854">(</span><span class="ident" id="3861855"><a href="/crypto/tls/conn.go.html#3842049">cipher</a></span><span class="op" id="3861861">.</span><span class="ident" id="3861862">AEAD</span><span class="op" id="3861866">)</span><span class="op" id="3861867">;</span>&nbsp;<span class="ident" id="3861869"><a href="/crypto/tls/conn.go.html#3861835">ok</a></span>&nbsp;<span class="op" id="3861872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861878"><a href="/crypto/tls/conn.go.html#3861593">explicitIVLen</a></span>&nbsp;<span class="op" id="3861892">=</span>&nbsp;<span class="num" id="3861894">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3861900">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3861946">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3861993">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862043">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862090">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862141">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862162"><a href="/crypto/tls/conn.go.html#3861614">explicitIVIsSeq</a></span>&nbsp;<span class="op" id="3862178">=</span>&nbsp;<span class="builtintype" id="3862180">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862196"><a href="/crypto/tls/conn.go.html#3861483">b</a></span><span class="op" id="3862197">.</span><span class="ident" id="3862198">resize</span><span class="op" id="3862204">(</span><span class="ident" id="3862205"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span>&nbsp;<span class="op" id="3862221">+</span>&nbsp;<span class="ident" id="3862223"><a href="/crypto/tls/conn.go.html#3861593">explicitIVLen</a></span>&nbsp;<span class="op" id="3862237">+</span>&nbsp;<span class="ident" id="3862239"><a href="/crypto/tls/conn.go.html#3861528">m</a></span><span class="op" id="3862240">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862244"><a href="/crypto/tls/conn.go.html#3861483">b</a></span><span class="op" id="3862245">.</span><span class="ident" id="3862246">data</span><span class="op" id="3862250">[</span><span class="num" id="3862251">0</span><span class="op" id="3862252">]</span>&nbsp;<span class="op" id="3862254">=</span>&nbsp;<span class="builtintype" id="3862256">byte</span><span class="op" id="3862260">(</span><span class="ident" id="3862261"><a href="/crypto/tls/conn.go.html#3861432">typ</a></span><span class="op" id="3862264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862268">vers</span>&nbsp;<span class="op" id="3862273">:=</span>&nbsp;<span class="ident" id="3862276"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3862277">.</span><span class="ident" id="3862278">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862285">if</span>&nbsp;<span class="ident" id="3862288"><a href="/crypto/tls/conn.go.html#3862268">vers</a></span>&nbsp;<span class="op" id="3862293">==</span>&nbsp;<span class="num" id="3862296">0</span>&nbsp;<span class="op" id="3862298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862303">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862356">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862412"><a href="/crypto/tls/conn.go.html#3862268">vers</a></span>&nbsp;<span class="op" id="3862417">=</span>&nbsp;<span class="ident" id="3862419"><a href="/crypto/tls/common.go.html#3822795">VersionTLS10</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862438"><a href="/crypto/tls/conn.go.html#3861483">b</a></span><span class="op" id="3862439">.</span><span class="ident" id="3862440">data</span><span class="op" id="3862444">[</span><span class="num" id="3862445">1</span><span class="op" id="3862446">]</span>&nbsp;<span class="op" id="3862448">=</span>&nbsp;<span class="builtintype" id="3862450">byte</span><span class="op" id="3862454">(</span><span class="ident" id="3862455"><a href="/crypto/tls/conn.go.html#3862268">vers</a></span>&nbsp;<span class="op" id="3862460">&gt;&gt;</span>&nbsp;<span class="num" id="3862463">8</span><span class="op" id="3862464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862468"><a href="/crypto/tls/conn.go.html#3861483">b</a></span><span class="op" id="3862469">.</span><span class="ident" id="3862470">data</span><span class="op" id="3862474">[</span><span class="num" id="3862475">2</span><span class="op" id="3862476">]</span>&nbsp;<span class="op" id="3862478">=</span>&nbsp;<span class="builtintype" id="3862480">byte</span><span class="op" id="3862484">(</span><span class="ident" id="3862485"><a href="/crypto/tls/conn.go.html#3862268">vers</a></span><span class="op" id="3862489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862493"><a href="/crypto/tls/conn.go.html#3861483">b</a></span><span class="op" id="3862494">.</span><span class="ident" id="3862495">data</span><span class="op" id="3862499">[</span><span class="num" id="3862500">3</span><span class="op" id="3862501">]</span>&nbsp;<span class="op" id="3862503">=</span>&nbsp;<span class="builtintype" id="3862505">byte</span><span class="op" id="3862509">(</span><span class="ident" id="3862510"><a href="/crypto/tls/conn.go.html#3861528">m</a></span>&nbsp;<span class="op" id="3862512">&gt;&gt;</span>&nbsp;<span class="num" id="3862515">8</span><span class="op" id="3862516">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862520"><a href="/crypto/tls/conn.go.html#3861483">b</a></span><span class="op" id="3862521">.</span><span class="ident" id="3862522">data</span><span class="op" id="3862526">[</span><span class="num" id="3862527">4</span><span class="op" id="3862528">]</span>&nbsp;<span class="op" id="3862530">=</span>&nbsp;<span class="builtintype" id="3862532">byte</span><span class="op" id="3862536">(</span><span class="ident" id="3862537"><a href="/crypto/tls/conn.go.html#3861528">m</a></span><span class="op" id="3862538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862542">if</span>&nbsp;<span class="ident" id="3862545"><a href="/crypto/tls/conn.go.html#3861593">explicitIVLen</a></span>&nbsp;<span class="op" id="3862559">&gt;</span>&nbsp;<span class="num" id="3862561">0</span>&nbsp;<span class="op" id="3862563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862568">explicitIV</span>&nbsp;<span class="op" id="3862579">:=</span>&nbsp;<span class="ident" id="3862582"><a href="/crypto/tls/conn.go.html#3861483">b</a></span><span class="op" id="3862583">.</span><span class="ident" id="3862584">data</span><span class="op" id="3862588">[</span><span class="ident" id="3862589"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span>&nbsp;<span class="op" id="3862605">:</span>&nbsp;<span class="ident" id="3862607"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3862622">+</span><span class="ident" id="3862623"><a href="/crypto/tls/conn.go.html#3861593">explicitIVLen</a></span><span class="op" id="3862636">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862641">if</span>&nbsp;<span class="ident" id="3862644"><a href="/crypto/tls/conn.go.html#3861614">explicitIVIsSeq</a></span>&nbsp;<span class="op" id="3862660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3862666">copy</span><span class="op" id="3862670">(</span><span class="ident" id="3862671"><a href="/crypto/tls/conn.go.html#3862568">explicitIV</a></span><span class="op" id="3862681">,</span>&nbsp;<span class="ident" id="3862683"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3862684">.</span><span class="ident" id="3862685">out</span><span class="op" id="3862688">.</span><span class="ident" id="3862689">seq</span><span class="op" id="3862692">[</span><span class="op" id="3862693">:</span><span class="op" id="3862694">]</span><span class="op" id="3862695">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862700">}</span>&nbsp;<span class="keyword" id="3862702">else</span>&nbsp;<span class="op" id="3862707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862713">if</span>&nbsp;<span class="ident" id="3862716">_</span><span class="op" id="3862717">,</span>&nbsp;<span class="ident" id="3862719"><a href="/crypto/tls/conn.go.html#3861469">err</a></span>&nbsp;<span class="op" id="3862723">=</span>&nbsp;<span class="ident" id="3862725"><a href="/crypto/tls/conn.go.html#3842115">io</a></span><span class="op" id="3862727">.</span><span class="ident" id="3862728">ReadFull</span><span class="op" id="3862736">(</span><span class="ident" id="3862737"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3862738">.</span><span class="ident" id="3862739">config</span><span class="op" id="3862745">.</span><span class="ident" id="3862746">rand</span><span class="op" id="3862750">(</span><span class="op" id="3862751">)</span><span class="op" id="3862752">,</span>&nbsp;<span class="ident" id="3862754"><a href="/crypto/tls/conn.go.html#3862568">explicitIV</a></span><span class="op" id="3862764">)</span><span class="op" id="3862765">;</span>&nbsp;<span class="ident" id="3862767"><a href="/crypto/tls/conn.go.html#3861469">err</a></span>&nbsp;<span class="op" id="3862771">!=</span>&nbsp;<span class="ident" id="3862774">nil</span>&nbsp;<span class="op" id="3862778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862785">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862800">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3862808">copy</span><span class="op" id="3862812">(</span><span class="ident" id="3862813"><a href="/crypto/tls/conn.go.html#3861483">b</a></span><span class="op" id="3862814">.</span><span class="ident" id="3862815">data</span><span class="op" id="3862819">[</span><span class="ident" id="3862820"><a href="/crypto/tls/common.go.html#3823012">recordHeaderLen</a></span><span class="op" id="3862835">+</span><span class="ident" id="3862836"><a href="/crypto/tls/conn.go.html#3861593">explicitIVLen</a></span><span class="op" id="3862849">:</span><span class="op" id="3862850">]</span><span class="op" id="3862851">,</span>&nbsp;<span class="ident" id="3862853"><a href="/crypto/tls/conn.go.html#3861448">data</a></span><span class="op" id="3862857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862861"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3862862">.</span><span class="ident" id="3862863">out</span><span class="op" id="3862866">.</span><span class="ident" id="3862867">encrypt</span><span class="op" id="3862874">(</span><span class="ident" id="3862875"><a href="/crypto/tls/conn.go.html#3861483">b</a></span><span class="op" id="3862876">,</span>&nbsp;<span class="ident" id="3862878"><a href="/crypto/tls/conn.go.html#3861593">explicitIVLen</a></span><span class="op" id="3862891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862895">_</span><span class="op" id="3862896">,</span>&nbsp;<span class="ident" id="3862898"><a href="/crypto/tls/conn.go.html#3861469">err</a></span>&nbsp;<span class="op" id="3862902">=</span>&nbsp;<span class="ident" id="3862904"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3862905">.</span><span class="ident" id="3862906">conn</span><span class="op" id="3862910">.</span><span class="ident" id="3862911">Write</span><span class="op" id="3862916">(</span><span class="ident" id="3862917"><a href="/crypto/tls/conn.go.html#3861483">b</a></span><span class="op" id="3862918">.</span><span class="ident" id="3862919">data</span><span class="op" id="3862923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862927">if</span>&nbsp;<span class="ident" id="3862930"><a href="/crypto/tls/conn.go.html#3861469">err</a></span>&nbsp;<span class="op" id="3862934">!=</span>&nbsp;<span class="ident" id="3862937">nil</span>&nbsp;<span class="op" id="3862941">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862946">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862958"><a href="/crypto/tls/conn.go.html#3861462">n</a></span>&nbsp;<span class="op" id="3862960">+=</span>&nbsp;<span class="ident" id="3862963"><a href="/crypto/tls/conn.go.html#3861528">m</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862967"><a href="/crypto/tls/conn.go.html#3861448">data</a></span>&nbsp;<span class="op" id="3862972">=</span>&nbsp;<span class="ident" id="3862974"><a href="/crypto/tls/conn.go.html#3861448">data</a></span><span class="op" id="3862978">[</span><span class="ident" id="3862979"><a href="/crypto/tls/conn.go.html#3861528">m</a></span><span class="op" id="3862980">:</span><span class="op" id="3862981">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862984">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862987"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3862988">.</span><span class="ident" id="3862989">out</span><span class="op" id="3862992">.</span><span class="ident" id="3862993">freeBlock</span><span class="op" id="3863002">(</span><span class="ident" id="3863003"><a href="/crypto/tls/conn.go.html#3861483">b</a></span><span class="op" id="3863004">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863008">if</span>&nbsp;<span class="ident" id="3863011"><a href="/crypto/tls/conn.go.html#3861432">typ</a></span>&nbsp;<span class="op" id="3863015">==</span>&nbsp;<span class="ident" id="3863018"><a href="/crypto/tls/common.go.html#3823266">recordTypeChangeCipherSpec</a></span>&nbsp;<span class="op" id="3863045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863049"><a href="/crypto/tls/conn.go.html#3861469">err</a></span>&nbsp;<span class="op" id="3863053">=</span>&nbsp;<span class="ident" id="3863055"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3863056">.</span><span class="ident" id="3863057">out</span><span class="op" id="3863060">.</span><span class="ident" id="3863061">changeCipherSpec</span><span class="op" id="3863077">(</span><span class="op" id="3863078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863082">if</span>&nbsp;<span class="ident" id="3863085"><a href="/crypto/tls/conn.go.html#3861469">err</a></span>&nbsp;<span class="op" id="3863089">!=</span>&nbsp;<span class="ident" id="3863092">nil</span>&nbsp;<span class="op" id="3863096">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863101">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863139">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863182"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3863183">.</span><span class="ident" id="3863184">tmp</span><span class="op" id="3863187">[</span><span class="num" id="3863188">0</span><span class="op" id="3863189">]</span>&nbsp;<span class="op" id="3863191">=</span>&nbsp;<span class="ident" id="3863193"><a href="/crypto/tls/alert.go.html#3810555">alertLevelError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863212"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3863213">.</span><span class="ident" id="3863214">tmp</span><span class="op" id="3863217">[</span><span class="num" id="3863218">1</span><span class="op" id="3863219">]</span>&nbsp;<span class="op" id="3863221">=</span>&nbsp;<span class="builtintype" id="3863223">byte</span><span class="op" id="3863227">(</span><span class="ident" id="3863228"><a href="/crypto/tls/conn.go.html#3861469">err</a></span><span class="op" id="3863231">.</span><span class="op" id="3863232">(</span><span class="ident" id="3863233"><a href="/crypto/tls/alert.go.html#3810494">alert</a></span><span class="op" id="3863238">)</span><span class="op" id="3863239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863244"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3863245">.</span><span class="ident" id="3863246">writeRecord</span><span class="op" id="3863257">(</span><span class="ident" id="3863258"><a href="/crypto/tls/common.go.html#3823310">recordTypeAlert</a></span><span class="op" id="3863273">,</span>&nbsp;<span class="ident" id="3863275"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3863276">.</span><span class="ident" id="3863277">tmp</span><span class="op" id="3863280">[</span><span class="num" id="3863281">0</span><span class="op" id="3863282">:</span><span class="num" id="3863283">2</span><span class="op" id="3863284">]</span><span class="op" id="3863285">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863290">return</span>&nbsp;<span class="ident" id="3863297"><a href="/crypto/tls/conn.go.html#3861462">n</a></span><span class="op" id="3863298">,</span>&nbsp;<span class="ident" id="3863300"><a href="/crypto/tls/conn.go.html#3861411">c</a></span><span class="op" id="3863301">.</span><span class="ident" id="3863302">out</span><span class="op" id="3863305">.</span><span class="ident" id="3863306">setErrorLocked</span><span class="op" id="3863320">(</span><span class="op" id="3863321">&amp;</span><span class="ident" id="3863322"><a href="/crypto/tls/conn.go.html#3842121">net</a></span><span class="op" id="3863325">.</span><span class="ident" id="3863326">OpError</span><span class="op" id="3863333">{</span><span class="ident" id="3863334">Op</span><span class="op" id="3863336">:</span>&nbsp;<span class="string" id="3863338">&#34;local&nbsp;error&#34;</span><span class="op" id="3863351">,</span>&nbsp;<span class="ident" id="3863353">Err</span><span class="op" id="3863356">:</span>&nbsp;<span class="ident" id="3863358"><a href="/crypto/tls/conn.go.html#3861469">err</a></span><span class="op" id="3863361">}</span><span class="op" id="3863362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863372">return</span><br>
<span class="lineno"></span><span class="op" id="3863379">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="3863382">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3863437">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="3863458">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3863494">func</span>&nbsp;<span class="op" id="3863499">(</span><span class="ident" id="3863500">c</span>&nbsp;<span class="op" id="3863502">*</span><span class="ident" id="3863503"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3863507">)</span>&nbsp;<span class="ident" id="3863509">readHandshake</span><span class="op" id="3863522">(</span><span class="op" id="3863523">)</span>&nbsp;<span class="op" id="3863525">(</span><span class="keyword" id="3863526">interface</span><span class="op" id="3863535">{</span><span class="op" id="3863536">}</span><span class="op" id="3863537">,</span>&nbsp;<span class="builtintype" id="3863539">error</span><span class="op" id="3863544">)</span>&nbsp;<span class="op" id="3863546">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863549">for</span>&nbsp;<span class="ident" id="3863553"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3863554">.</span><span class="ident" id="3863555">hand</span><span class="op" id="3863559">.</span><span class="ident" id="3863560">Len</span><span class="op" id="3863563">(</span><span class="op" id="3863564">)</span>&nbsp;<span class="op" id="3863566">&lt;</span>&nbsp;<span class="num" id="3863568">4</span>&nbsp;<span class="op" id="3863570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863574">if</span>&nbsp;<span class="ident" id="3863577">err</span>&nbsp;<span class="op" id="3863581">:=</span>&nbsp;<span class="ident" id="3863584"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3863585">.</span><span class="ident" id="3863586">in</span><span class="op" id="3863588">.</span><span class="ident" id="3863589">err</span><span class="op" id="3863592">;</span>&nbsp;<span class="ident" id="3863594"><a href="/crypto/tls/conn.go.html#3863577">err</a></span>&nbsp;<span class="op" id="3863598">!=</span>&nbsp;<span class="ident" id="3863601">nil</span>&nbsp;<span class="op" id="3863605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863610">return</span>&nbsp;<span class="ident" id="3863617">nil</span><span class="op" id="3863620">,</span>&nbsp;<span class="ident" id="3863622"><a href="/crypto/tls/conn.go.html#3863577">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863632">if</span>&nbsp;<span class="ident" id="3863635">err</span>&nbsp;<span class="op" id="3863639">:=</span>&nbsp;<span class="ident" id="3863642"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3863643">.</span><span class="ident" id="3863644">readRecord</span><span class="op" id="3863654">(</span><span class="ident" id="3863655"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3863674">)</span><span class="op" id="3863675">;</span>&nbsp;<span class="ident" id="3863677"><a href="/crypto/tls/conn.go.html#3863635">err</a></span>&nbsp;<span class="op" id="3863681">!=</span>&nbsp;<span class="ident" id="3863684">nil</span>&nbsp;<span class="op" id="3863688">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863693">return</span>&nbsp;<span class="ident" id="3863700">nil</span><span class="op" id="3863703">,</span>&nbsp;<span class="ident" id="3863705"><a href="/crypto/tls/conn.go.html#3863635">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863718">data</span>&nbsp;<span class="op" id="3863723">:=</span>&nbsp;<span class="ident" id="3863726"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3863727">.</span><span class="ident" id="3863728">hand</span><span class="op" id="3863732">.</span><span class="ident" id="3863733">Bytes</span><span class="op" id="3863738">(</span><span class="op" id="3863739">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863742">n</span>&nbsp;<span class="op" id="3863744">:=</span>&nbsp;<span class="builtintype" id="3863747">int</span><span class="op" id="3863750">(</span><span class="ident" id="3863751"><a href="/crypto/tls/conn.go.html#3863718">data</a></span><span class="op" id="3863755">[</span><span class="num" id="3863756">1</span><span class="op" id="3863757">]</span><span class="op" id="3863758">)</span><span class="op" id="3863759">&lt;&lt;</span><span class="num" id="3863761">16</span>&nbsp;<span class="op" id="3863764">|</span>&nbsp;<span class="builtintype" id="3863766">int</span><span class="op" id="3863769">(</span><span class="ident" id="3863770"><a href="/crypto/tls/conn.go.html#3863718">data</a></span><span class="op" id="3863774">[</span><span class="num" id="3863775">2</span><span class="op" id="3863776">]</span><span class="op" id="3863777">)</span><span class="op" id="3863778">&lt;&lt;</span><span class="num" id="3863780">8</span>&nbsp;<span class="op" id="3863782">|</span>&nbsp;<span class="builtintype" id="3863784">int</span><span class="op" id="3863787">(</span><span class="ident" id="3863788"><a href="/crypto/tls/conn.go.html#3863718">data</a></span><span class="op" id="3863792">[</span><span class="num" id="3863793">3</span><span class="op" id="3863794">]</span><span class="op" id="3863795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863798">if</span>&nbsp;<span class="ident" id="3863801"><a href="/crypto/tls/conn.go.html#3863742">n</a></span>&nbsp;<span class="op" id="3863803">&gt;</span>&nbsp;<span class="ident" id="3863805"><a href="/crypto/tls/common.go.html#3823068">maxHandshake</a></span>&nbsp;<span class="op" id="3863818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863822">return</span>&nbsp;<span class="ident" id="3863829">nil</span><span class="op" id="3863832">,</span>&nbsp;<span class="ident" id="3863834"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3863835">.</span><span class="ident" id="3863836">in</span><span class="op" id="3863838">.</span><span class="ident" id="3863839">setErrorLocked</span><span class="op" id="3863853">(</span><span class="ident" id="3863854"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3863855">.</span><span class="ident" id="3863856">sendAlert</span><span class="op" id="3863865">(</span><span class="ident" id="3863866"><a href="/crypto/tls/alert.go.html#3811348">alertInternalError</a></span><span class="op" id="3863884">)</span><span class="op" id="3863885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863891">for</span>&nbsp;<span class="ident" id="3863895"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3863896">.</span><span class="ident" id="3863897">hand</span><span class="op" id="3863901">.</span><span class="ident" id="3863902">Len</span><span class="op" id="3863905">(</span><span class="op" id="3863906">)</span>&nbsp;<span class="op" id="3863908">&lt;</span>&nbsp;<span class="num" id="3863910">4</span><span class="op" id="3863911">+</span><span class="ident" id="3863912"><a href="/crypto/tls/conn.go.html#3863742">n</a></span>&nbsp;<span class="op" id="3863914">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863918">if</span>&nbsp;<span class="ident" id="3863921">err</span>&nbsp;<span class="op" id="3863925">:=</span>&nbsp;<span class="ident" id="3863928"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3863929">.</span><span class="ident" id="3863930">in</span><span class="op" id="3863932">.</span><span class="ident" id="3863933">err</span><span class="op" id="3863936">;</span>&nbsp;<span class="ident" id="3863938"><a href="/crypto/tls/conn.go.html#3863921">err</a></span>&nbsp;<span class="op" id="3863942">!=</span>&nbsp;<span class="ident" id="3863945">nil</span>&nbsp;<span class="op" id="3863949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863954">return</span>&nbsp;<span class="ident" id="3863961">nil</span><span class="op" id="3863964">,</span>&nbsp;<span class="ident" id="3863966"><a href="/crypto/tls/conn.go.html#3863921">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863976">if</span>&nbsp;<span class="ident" id="3863979">err</span>&nbsp;<span class="op" id="3863983">:=</span>&nbsp;<span class="ident" id="3863986"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3863987">.</span><span class="ident" id="3863988">readRecord</span><span class="op" id="3863998">(</span><span class="ident" id="3863999"><a href="/crypto/tls/common.go.html#3823354">recordTypeHandshake</a></span><span class="op" id="3864018">)</span><span class="op" id="3864019">;</span>&nbsp;<span class="ident" id="3864021"><a href="/crypto/tls/conn.go.html#3863979">err</a></span>&nbsp;<span class="op" id="3864025">!=</span>&nbsp;<span class="ident" id="3864028">nil</span>&nbsp;<span class="op" id="3864032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864037">return</span>&nbsp;<span class="ident" id="3864044">nil</span><span class="op" id="3864047">,</span>&nbsp;<span class="ident" id="3864049"><a href="/crypto/tls/conn.go.html#3863979">err</a></span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864061"><a href="/crypto/tls/conn.go.html#3863718">data</a></span>&nbsp;<span class="op" id="3864066">=</span>&nbsp;<span class="ident" id="3864068"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3864069">.</span><span class="ident" id="3864070">hand</span><span class="op" id="3864074">.</span><span class="ident" id="3864075">Next</span><span class="op" id="3864079">(</span><span class="num" id="3864080">4</span>&nbsp;<span class="op" id="3864082">+</span>&nbsp;<span class="ident" id="3864084"><a href="/crypto/tls/conn.go.html#3863742">n</a></span><span class="op" id="3864085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864088">var</span>&nbsp;<span class="ident" id="3864092">m</span>&nbsp;<span class="ident" id="3864094"><a href="/crypto/tls/common.go.html#3839208">handshakeMessage</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864112">switch</span>&nbsp;<span class="ident" id="3864119"><a href="/crypto/tls/conn.go.html#3863718">data</a></span><span class="op" id="3864123">[</span><span class="num" id="3864124">0</span><span class="op" id="3864125">]</span>&nbsp;<span class="op" id="3864127">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864130">case</span>&nbsp;<span class="ident" id="3864135"><a href="/crypto/tls/common.go.html#3823485">typeClientHello</a></span><span class="op" id="3864150">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864154"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864156">=</span>&nbsp;<span class="builtinfunc" id="3864158">new</span><span class="op" id="3864161">(</span><span class="ident" id="3864162"><a href="/crypto/tls/handshake_messages.go.html#3888598">clientHelloMsg</a></span><span class="op" id="3864176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864179">case</span>&nbsp;<span class="ident" id="3864184"><a href="/crypto/tls/common.go.html#3823519">typeServerHello</a></span><span class="op" id="3864199">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864203"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864205">=</span>&nbsp;<span class="builtinfunc" id="3864207">new</span><span class="op" id="3864210">(</span><span class="ident" id="3864211"><a href="/crypto/tls/handshake_messages.go.html#3899714">serverHelloMsg</a></span><span class="op" id="3864225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864228">case</span>&nbsp;<span class="ident" id="3864233"><a href="/crypto/tls/common.go.html#3823553">typeNewSessionTicket</a></span><span class="op" id="3864253">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864257"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864259">=</span>&nbsp;<span class="builtinfunc" id="3864261">new</span><span class="op" id="3864264">(</span><span class="ident" id="3864265"><a href="/crypto/tls/handshake_messages.go.html#3916789">newSessionTicketMsg</a></span><span class="op" id="3864284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864287">case</span>&nbsp;<span class="ident" id="3864292"><a href="/crypto/tls/common.go.html#3823587">typeCertificate</a></span><span class="op" id="3864307">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864311"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864313">=</span>&nbsp;<span class="builtinfunc" id="3864315">new</span><span class="op" id="3864318">(</span><span class="ident" id="3864319"><a href="/crypto/tls/handshake_messages.go.html#3905092">certificateMsg</a></span><span class="op" id="3864333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864336">case</span>&nbsp;<span class="ident" id="3864341"><a href="/crypto/tls/common.go.html#3823657">typeCertificateRequest</a></span><span class="op" id="3864363">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864367"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864369">=</span>&nbsp;<span class="op" id="3864371">&amp;</span><span class="ident" id="3864372"><a href="/crypto/tls/handshake_messages.go.html#3911637">certificateRequestMsg</a></span><span class="op" id="3864393">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864398">hasSignatureAndHash</span><span class="op" id="3864417">:</span>&nbsp;<span class="ident" id="3864419"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3864420">.</span><span class="ident" id="3864421">vers</span>&nbsp;<span class="op" id="3864426">&gt;=</span>&nbsp;<span class="ident" id="3864429"><a href="/crypto/tls/common.go.html#3822841">VersionTLS12</a></span><span class="op" id="3864441">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864448">case</span>&nbsp;<span class="ident" id="3864453"><a href="/crypto/tls/common.go.html#3823832">typeCertificateStatus</a></span><span class="op" id="3864474">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864478"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864480">=</span>&nbsp;<span class="builtinfunc" id="3864482">new</span><span class="op" id="3864485">(</span><span class="ident" id="3864486"><a href="/crypto/tls/handshake_messages.go.html#3907489">certificateStatusMsg</a></span><span class="op" id="3864506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864509">case</span>&nbsp;<span class="ident" id="3864514"><a href="/crypto/tls/common.go.html#3823622">typeServerKeyExchange</a></span><span class="op" id="3864535">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864539"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864541">=</span>&nbsp;<span class="builtinfunc" id="3864543">new</span><span class="op" id="3864546">(</span><span class="ident" id="3864547"><a href="/crypto/tls/handshake_messages.go.html#3906795">serverKeyExchangeMsg</a></span><span class="op" id="3864567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864570">case</span>&nbsp;<span class="ident" id="3864575"><a href="/crypto/tls/common.go.html#3823692">typeServerHelloDone</a></span><span class="op" id="3864594">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864598"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864600">=</span>&nbsp;<span class="builtinfunc" id="3864602">new</span><span class="op" id="3864605">(</span><span class="ident" id="3864606"><a href="/crypto/tls/handshake_messages.go.html#3908750">serverHelloDoneMsg</a></span><span class="op" id="3864624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864627">case</span>&nbsp;<span class="ident" id="3864632"><a href="/crypto/tls/common.go.html#3823762">typeClientKeyExchange</a></span><span class="op" id="3864653">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864657"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864659">=</span>&nbsp;<span class="builtinfunc" id="3864661">new</span><span class="op" id="3864664">(</span><span class="ident" id="3864665"><a href="/crypto/tls/handshake_messages.go.html#3909085">clientKeyExchangeMsg</a></span><span class="op" id="3864685">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864688">case</span>&nbsp;<span class="ident" id="3864693"><a href="/crypto/tls/common.go.html#3823727">typeCertificateVerify</a></span><span class="op" id="3864714">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864718"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864720">=</span>&nbsp;<span class="op" id="3864722">&amp;</span><span class="ident" id="3864723"><a href="/crypto/tls/handshake_messages.go.html#3915062">certificateVerifyMsg</a></span><span class="op" id="3864743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864748">hasSignatureAndHash</span><span class="op" id="3864767">:</span>&nbsp;<span class="ident" id="3864769"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3864770">.</span><span class="ident" id="3864771">vers</span>&nbsp;<span class="op" id="3864776">&gt;=</span>&nbsp;<span class="ident" id="3864779"><a href="/crypto/tls/common.go.html#3822841">VersionTLS12</a></span><span class="op" id="3864791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864798">case</span>&nbsp;<span class="ident" id="3864803"><a href="/crypto/tls/common.go.html#3823867">typeNextProtocol</a></span><span class="op" id="3864819">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864823"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864825">=</span>&nbsp;<span class="builtinfunc" id="3864827">new</span><span class="op" id="3864830">(</span><span class="ident" id="3864831"><a href="/crypto/tls/handshake_messages.go.html#3910552">nextProtoMsg</a></span><span class="op" id="3864843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864846">case</span>&nbsp;<span class="ident" id="3864851"><a href="/crypto/tls/common.go.html#3823797">typeFinished</a></span><span class="op" id="3864863">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864867"><a href="/crypto/tls/conn.go.html#3864092">m</a></span>&nbsp;<span class="op" id="3864869">=</span>&nbsp;<span class="builtinfunc" id="3864871">new</span><span class="op" id="3864874">(</span><span class="ident" id="3864875"><a href="/crypto/tls/handshake_messages.go.html#3909925">finishedMsg</a></span><span class="op" id="3864886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864889">default</span><span class="op" id="3864896">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864900">return</span>&nbsp;<span class="ident" id="3864907">nil</span><span class="op" id="3864910">,</span>&nbsp;<span class="ident" id="3864912"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3864913">.</span><span class="ident" id="3864914">in</span><span class="op" id="3864916">.</span><span class="ident" id="3864917">setErrorLocked</span><span class="op" id="3864931">(</span><span class="ident" id="3864932"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3864933">.</span><span class="ident" id="3864934">sendAlert</span><span class="op" id="3864943">(</span><span class="ident" id="3864944"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3864966">)</span><span class="op" id="3864967">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864974">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865014">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865064">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865119"><a href="/crypto/tls/conn.go.html#3863718">data</a></span>&nbsp;<span class="op" id="3865124">=</span>&nbsp;<span class="builtinfunc" id="3865126">append</span><span class="op" id="3865132">(</span><span class="op" id="3865133">[</span><span class="op" id="3865134">]</span><span class="builtintype" id="3865135">byte</span><span class="op" id="3865139">(</span><span class="ident" id="3865140">nil</span><span class="op" id="3865143">)</span><span class="op" id="3865144">,</span>&nbsp;<span class="ident" id="3865146"><a href="/crypto/tls/conn.go.html#3863718">data</a></span><span class="op" id="3865150">...</span><span class="op" id="3865153">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865157">if</span>&nbsp;<span class="op" id="3865160">!</span><span class="ident" id="3865161"><a href="/crypto/tls/conn.go.html#3864092">m</a></span><span class="op" id="3865162">.</span><span class="ident" id="3865163">unmarshal</span><span class="op" id="3865172">(</span><span class="ident" id="3865173"><a href="/crypto/tls/conn.go.html#3863718">data</a></span><span class="op" id="3865177">)</span>&nbsp;<span class="op" id="3865179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865183">return</span>&nbsp;<span class="ident" id="3865190">nil</span><span class="op" id="3865193">,</span>&nbsp;<span class="ident" id="3865195"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3865196">.</span><span class="ident" id="3865197">in</span><span class="op" id="3865199">.</span><span class="ident" id="3865200">setErrorLocked</span><span class="op" id="3865214">(</span><span class="ident" id="3865215"><a href="/crypto/tls/conn.go.html#3863500">c</a></span><span class="op" id="3865216">.</span><span class="ident" id="3865217">sendAlert</span><span class="op" id="3865226">(</span><span class="ident" id="3865227"><a href="/crypto/tls/alert.go.html#3810628">alertUnexpectedMessage</a></span><span class="op" id="3865249">)</span><span class="op" id="3865250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865253">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865256">return</span>&nbsp;<span class="ident" id="3865263"><a href="/crypto/tls/conn.go.html#3864092">m</a></span><span class="op" id="3865264">,</span>&nbsp;<span class="ident" id="3865266">nil</span><br>
<span class="lineno"></span><span class="op" id="3865270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3865273">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3865313">func</span>&nbsp;<span class="op" id="3865318">(</span><span class="ident" id="3865319">c</span>&nbsp;<span class="op" id="3865321">*</span><span class="ident" id="3865322"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3865326">)</span>&nbsp;<span class="ident" id="3865328">Write</span><span class="op" id="3865333">(</span><span class="ident" id="3865334">b</span>&nbsp;<span class="op" id="3865336">[</span><span class="op" id="3865337">]</span><span class="builtintype" id="3865338">byte</span><span class="op" id="3865342">)</span>&nbsp;<span class="op" id="3865344">(</span><span class="builtintype" id="3865345">int</span><span class="op" id="3865348">,</span>&nbsp;<span class="builtintype" id="3865350">error</span><span class="op" id="3865355">)</span>&nbsp;<span class="op" id="3865357">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865360">if</span>&nbsp;<span class="ident" id="3865363">err</span>&nbsp;<span class="op" id="3865367">:=</span>&nbsp;<span class="ident" id="3865370"><a href="/crypto/tls/conn.go.html#3865319">c</a></span><span class="op" id="3865371">.</span><span class="ident" id="3865372">Handshake</span><span class="op" id="3865381">(</span><span class="op" id="3865382">)</span><span class="op" id="3865383">;</span>&nbsp;<span class="ident" id="3865385"><a href="/crypto/tls/conn.go.html#3865363">err</a></span>&nbsp;<span class="op" id="3865389">!=</span>&nbsp;<span class="ident" id="3865392">nil</span>&nbsp;<span class="op" id="3865396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865400">return</span>&nbsp;<span class="num" id="3865407">0</span><span class="op" id="3865408">,</span>&nbsp;<span class="ident" id="3865410"><a href="/crypto/tls/conn.go.html#3865363">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865419"><a href="/crypto/tls/conn.go.html#3865319">c</a></span><span class="op" id="3865420">.</span><span class="ident" id="3865421">out</span><span class="op" id="3865424">.</span><span class="ident" id="3865425">Lock</span><span class="op" id="3865429">(</span><span class="op" id="3865430">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865433">defer</span>&nbsp;<span class="ident" id="3865439"><a href="/crypto/tls/conn.go.html#3865319">c</a></span><span class="op" id="3865440">.</span><span class="ident" id="3865441">out</span><span class="op" id="3865444">.</span><span class="ident" id="3865445">Unlock</span><span class="op" id="3865451">(</span><span class="op" id="3865452">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865456">if</span>&nbsp;<span class="ident" id="3865459">err</span>&nbsp;<span class="op" id="3865463">:=</span>&nbsp;<span class="ident" id="3865466"><a href="/crypto/tls/conn.go.html#3865319">c</a></span><span class="op" id="3865467">.</span><span class="ident" id="3865468">out</span><span class="op" id="3865471">.</span><span class="ident" id="3865472">err</span><span class="op" id="3865475">;</span>&nbsp;<span class="ident" id="3865477"><a href="/crypto/tls/conn.go.html#3865459">err</a></span>&nbsp;<span class="op" id="3865481">!=</span>&nbsp;<span class="ident" id="3865484">nil</span>&nbsp;<span class="op" id="3865488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865492">return</span>&nbsp;<span class="num" id="3865499">0</span><span class="op" id="3865500">,</span>&nbsp;<span class="ident" id="3865502"><a href="/crypto/tls/conn.go.html#3865459">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865507">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865511">if</span>&nbsp;<span class="op" id="3865514">!</span><span class="ident" id="3865515"><a href="/crypto/tls/conn.go.html#3865319">c</a></span><span class="op" id="3865516">.</span><span class="ident" id="3865517">handshakeComplete</span>&nbsp;<span class="op" id="3865535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865539">return</span>&nbsp;<span class="num" id="3865546">0</span><span class="op" id="3865547">,</span>&nbsp;<span class="ident" id="3865549"><a href="/crypto/tls/alert.go.html#3811348">alertInternalError</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865573">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865635">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865700">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865761">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865822">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865826">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865871">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865927">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865992">var</span>&nbsp;<span class="ident" id="3865996">m</span>&nbsp;<span class="builtintype" id="3865998">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866003">if</span>&nbsp;<span class="builtinfunc" id="3866006">len</span><span class="op" id="3866009">(</span><span class="ident" id="3866010"><a href="/crypto/tls/conn.go.html#3865334">b</a></span><span class="op" id="3866011">)</span>&nbsp;<span class="op" id="3866013">&gt;</span>&nbsp;<span class="num" id="3866015">1</span>&nbsp;<span class="op" id="3866017">&amp;&amp;</span>&nbsp;<span class="ident" id="3866020"><a href="/crypto/tls/conn.go.html#3865319">c</a></span><span class="op" id="3866021">.</span><span class="ident" id="3866022">vers</span>&nbsp;<span class="op" id="3866027">&lt;=</span>&nbsp;<span class="ident" id="3866030"><a href="/crypto/tls/common.go.html#3822795">VersionTLS10</a></span>&nbsp;<span class="op" id="3866043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866047">if</span>&nbsp;<span class="ident" id="3866050">_</span><span class="op" id="3866051">,</span>&nbsp;<span class="ident" id="3866053">ok</span>&nbsp;<span class="op" id="3866056">:=</span>&nbsp;<span class="ident" id="3866059"><a href="/crypto/tls/conn.go.html#3865319">c</a></span><span class="op" id="3866060">.</span><span class="ident" id="3866061">out</span><span class="op" id="3866064">.</span><span class="ident" id="3866065">cipher</span><span class="op" id="3866071">.</span><span class="op" id="3866072">(</span><span class="ident" id="3866073"><a href="/crypto/tls/conn.go.html#3842049">cipher</a></span><span class="op" id="3866079">.</span><span class="ident" id="3866080">BlockMode</span><span class="op" id="3866089">)</span><span class="op" id="3866090">;</span>&nbsp;<span class="ident" id="3866092"><a href="/crypto/tls/conn.go.html#3866053">ok</a></span>&nbsp;<span class="op" id="3866095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866100">n</span><span class="op" id="3866101">,</span>&nbsp;<span class="ident" id="3866103">err</span>&nbsp;<span class="op" id="3866107">:=</span>&nbsp;<span class="ident" id="3866110"><a href="/crypto/tls/conn.go.html#3865319">c</a></span><span class="op" id="3866111">.</span><span class="ident" id="3866112">writeRecord</span><span class="op" id="3866123">(</span><span class="ident" id="3866124"><a href="/crypto/tls/common.go.html#3823398">recordTypeApplicationData</a></span><span class="op" id="3866149">,</span>&nbsp;<span class="ident" id="3866151"><a href="/crypto/tls/conn.go.html#3865334">b</a></span><span class="op" id="3866152">[</span><span class="op" id="3866153">:</span><span class="num" id="3866154">1</span><span class="op" id="3866155">]</span><span class="op" id="3866156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866161">if</span>&nbsp;<span class="ident" id="3866164"><a href="/crypto/tls/conn.go.html#3866103">err</a></span>&nbsp;<span class="op" id="3866168">!=</span>&nbsp;<span class="ident" id="3866171">nil</span>&nbsp;<span class="op" id="3866175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866181">return</span>&nbsp;<span class="ident" id="3866188"><a href="/crypto/tls/conn.go.html#3866100">n</a></span><span class="op" id="3866189">,</span>&nbsp;<span class="ident" id="3866191"><a href="/crypto/tls/conn.go.html#3865319">c</a></span><span class="op" id="3866192">.</span><span class="ident" id="3866193">out</span><span class="op" id="3866196">.</span><span class="ident" id="3866197">setErrorLocked</span><span class="op" id="3866211">(</span><span class="ident" id="3866212"><a href="/crypto/tls/conn.go.html#3866103">err</a></span><span class="op" id="3866215">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866225"><a href="/crypto/tls/conn.go.html#3865996">m</a></span><span class="op" id="3866226">,</span>&nbsp;<span class="ident" id="3866228"><a href="/crypto/tls/conn.go.html#3865334">b</a></span>&nbsp;<span class="op" id="3866230">=</span>&nbsp;<span class="num" id="3866232">1</span><span class="op" id="3866233">,</span>&nbsp;<span class="ident" id="3866235"><a href="/crypto/tls/conn.go.html#3865334">b</a></span><span class="op" id="3866236">[</span><span class="num" id="3866237">1</span><span class="op" id="3866238">:</span><span class="op" id="3866239">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866250">n</span><span class="op" id="3866251">,</span>&nbsp;<span class="ident" id="3866253">err</span>&nbsp;<span class="op" id="3866257">:=</span>&nbsp;<span class="ident" id="3866260"><a href="/crypto/tls/conn.go.html#3865319">c</a></span><span class="op" id="3866261">.</span><span class="ident" id="3866262">writeRecord</span><span class="op" id="3866273">(</span><span class="ident" id="3866274"><a href="/crypto/tls/common.go.html#3823398">recordTypeApplicationData</a></span><span class="op" id="3866299">,</span>&nbsp;<span class="ident" id="3866301"><a href="/crypto/tls/conn.go.html#3865334">b</a></span><span class="op" id="3866302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866305">return</span>&nbsp;<span class="ident" id="3866312"><a href="/crypto/tls/conn.go.html#3866250">n</a></span>&nbsp;<span class="op" id="3866314">+</span>&nbsp;<span class="ident" id="3866316"><a href="/crypto/tls/conn.go.html#3865996">m</a></span><span class="op" id="3866317">,</span>&nbsp;<span class="ident" id="3866319"><a href="/crypto/tls/conn.go.html#3865319">c</a></span><span class="op" id="3866320">.</span><span class="ident" id="3866321">out</span><span class="op" id="3866324">.</span><span class="ident" id="3866325">setErrorLocked</span><span class="op" id="3866339">(</span><span class="ident" id="3866340"><a href="/crypto/tls/conn.go.html#3866253">err</a></span><span class="op" id="3866343">)</span><br>
<span class="lineno"></span><span class="op" id="3866345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3866348">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="3866426">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="3866492">func</span>&nbsp;<span class="op" id="3866497">(</span><span class="ident" id="3866498">c</span>&nbsp;<span class="op" id="3866500">*</span><span class="ident" id="3866501"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3866505">)</span>&nbsp;<span class="ident" id="3866507">Read</span><span class="op" id="3866511">(</span><span class="ident" id="3866512">b</span>&nbsp;<span class="op" id="3866514">[</span><span class="op" id="3866515">]</span><span class="builtintype" id="3866516">byte</span><span class="op" id="3866520">)</span>&nbsp;<span class="op" id="3866522">(</span><span class="ident" id="3866523">n</span>&nbsp;<span class="builtintype" id="3866525">int</span><span class="op" id="3866528">,</span>&nbsp;<span class="ident" id="3866530">err</span>&nbsp;<span class="builtintype" id="3866534">error</span><span class="op" id="3866539">)</span>&nbsp;<span class="op" id="3866541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866544">if</span>&nbsp;<span class="ident" id="3866547"><a href="/crypto/tls/conn.go.html#3866530">err</a></span>&nbsp;<span class="op" id="3866551">=</span>&nbsp;<span class="ident" id="3866553"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3866554">.</span><span class="ident" id="3866555">Handshake</span><span class="op" id="3866564">(</span><span class="op" id="3866565">)</span><span class="op" id="3866566">;</span>&nbsp;<span class="ident" id="3866568"><a href="/crypto/tls/conn.go.html#3866530">err</a></span>&nbsp;<span class="op" id="3866572">!=</span>&nbsp;<span class="ident" id="3866575">nil</span>&nbsp;<span class="op" id="3866579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866583">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866591">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866594">if</span>&nbsp;<span class="builtinfunc" id="3866597">len</span><span class="op" id="3866600">(</span><span class="ident" id="3866601"><a href="/crypto/tls/conn.go.html#3866512">b</a></span><span class="op" id="3866602">)</span>&nbsp;<span class="op" id="3866604">==</span>&nbsp;<span class="num" id="3866607">0</span>&nbsp;<span class="op" id="3866609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3866613">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3866672">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866725">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866733">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866737"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3866738">.</span><span class="ident" id="3866739">in</span><span class="op" id="3866741">.</span><span class="ident" id="3866742">Lock</span><span class="op" id="3866746">(</span><span class="op" id="3866747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866750">defer</span>&nbsp;<span class="ident" id="3866756"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3866757">.</span><span class="ident" id="3866758">in</span><span class="op" id="3866760">.</span><span class="ident" id="3866761">Unlock</span><span class="op" id="3866767">(</span><span class="op" id="3866768">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3866772">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3866842">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866910">const</span>&nbsp;<span class="ident" id="3866916">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="3866943">=</span>&nbsp;<span class="num" id="3866945">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866950">for</span>&nbsp;<span class="ident" id="3866954">emptyRecordCount</span>&nbsp;<span class="op" id="3866971">:=</span>&nbsp;<span class="num" id="3866974">0</span><span class="op" id="3866975">;</span>&nbsp;<span class="ident" id="3866977"><a href="/crypto/tls/conn.go.html#3866954">emptyRecordCount</a></span>&nbsp;<span class="op" id="3866994">&lt;=</span>&nbsp;<span class="ident" id="3866997"><a href="/crypto/tls/conn.go.html#3866916">maxConsecutiveEmptyRecords</a></span><span class="op" id="3867023">;</span>&nbsp;<span class="ident" id="3867025"><a href="/crypto/tls/conn.go.html#3866954">emptyRecordCount</a></span><span class="op" id="3867041">++</span>&nbsp;<span class="op" id="3867044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867048">for</span>&nbsp;<span class="ident" id="3867052"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867053">.</span><span class="ident" id="3867054">input</span>&nbsp;<span class="op" id="3867060">==</span>&nbsp;<span class="ident" id="3867063">nil</span>&nbsp;<span class="op" id="3867067">&amp;&amp;</span>&nbsp;<span class="ident" id="3867070"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867071">.</span><span class="ident" id="3867072">in</span><span class="op" id="3867074">.</span><span class="ident" id="3867075">err</span>&nbsp;<span class="op" id="3867079">==</span>&nbsp;<span class="ident" id="3867082">nil</span>&nbsp;<span class="op" id="3867086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867091">if</span>&nbsp;<span class="ident" id="3867094">err</span>&nbsp;<span class="op" id="3867098">:=</span>&nbsp;<span class="ident" id="3867101"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867102">.</span><span class="ident" id="3867103">readRecord</span><span class="op" id="3867113">(</span><span class="ident" id="3867114"><a href="/crypto/tls/common.go.html#3823398">recordTypeApplicationData</a></span><span class="op" id="3867139">)</span><span class="op" id="3867140">;</span>&nbsp;<span class="ident" id="3867142"><a href="/crypto/tls/conn.go.html#3867094">err</a></span>&nbsp;<span class="op" id="3867146">!=</span>&nbsp;<span class="ident" id="3867149">nil</span>&nbsp;<span class="op" id="3867153">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867159">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867190">return</span>&nbsp;<span class="num" id="3867197">0</span><span class="op" id="3867198">,</span>&nbsp;<span class="ident" id="3867200"><a href="/crypto/tls/conn.go.html#3867094">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867215">if</span>&nbsp;<span class="ident" id="3867218">err</span>&nbsp;<span class="op" id="3867222">:=</span>&nbsp;<span class="ident" id="3867225"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867226">.</span><span class="ident" id="3867227">in</span><span class="op" id="3867229">.</span><span class="ident" id="3867230">err</span><span class="op" id="3867233">;</span>&nbsp;<span class="ident" id="3867235"><a href="/crypto/tls/conn.go.html#3867218">err</a></span>&nbsp;<span class="op" id="3867239">!=</span>&nbsp;<span class="ident" id="3867242">nil</span>&nbsp;<span class="op" id="3867246">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867251">return</span>&nbsp;<span class="num" id="3867258">0</span><span class="op" id="3867259">,</span>&nbsp;<span class="ident" id="3867261"><a href="/crypto/tls/conn.go.html#3867218">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867272"><a href="/crypto/tls/conn.go.html#3866523">n</a></span><span class="op" id="3867273">,</span>&nbsp;<span class="ident" id="3867275"><a href="/crypto/tls/conn.go.html#3866530">err</a></span>&nbsp;<span class="op" id="3867279">=</span>&nbsp;<span class="ident" id="3867281"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867282">.</span><span class="ident" id="3867283">input</span><span class="op" id="3867288">.</span><span class="ident" id="3867289">Read</span><span class="op" id="3867293">(</span><span class="ident" id="3867294"><a href="/crypto/tls/conn.go.html#3866512">b</a></span><span class="op" id="3867295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867299">if</span>&nbsp;<span class="ident" id="3867302"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867303">.</span><span class="ident" id="3867304">input</span><span class="op" id="3867309">.</span><span class="ident" id="3867310">off</span>&nbsp;<span class="op" id="3867314">&gt;=</span>&nbsp;<span class="builtinfunc" id="3867317">len</span><span class="op" id="3867320">(</span><span class="ident" id="3867321"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867322">.</span><span class="ident" id="3867323">input</span><span class="op" id="3867328">.</span><span class="ident" id="3867329">data</span><span class="op" id="3867333">)</span>&nbsp;<span class="op" id="3867335">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867340"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867341">.</span><span class="ident" id="3867342">in</span><span class="op" id="3867344">.</span><span class="ident" id="3867345">freeBlock</span><span class="op" id="3867354">(</span><span class="ident" id="3867355"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867356">.</span><span class="ident" id="3867357">input</span><span class="op" id="3867362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867367"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867368">.</span><span class="ident" id="3867369">input</span>&nbsp;<span class="op" id="3867375">=</span>&nbsp;<span class="ident" id="3867377">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867388">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867445">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867504">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867557">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867611">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867664">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867720">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867777">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867827">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867841">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867890">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867928">if</span>&nbsp;<span class="ident" id="3867931">ri</span>&nbsp;<span class="op" id="3867934">:=</span>&nbsp;<span class="ident" id="3867937"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867938">.</span><span class="ident" id="3867939">rawInput</span><span class="op" id="3867947">;</span>&nbsp;<span class="ident" id="3867949"><a href="/crypto/tls/conn.go.html#3867931">ri</a></span>&nbsp;<span class="op" id="3867952">!=</span>&nbsp;<span class="ident" id="3867955">nil</span>&nbsp;<span class="op" id="3867959">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867965"><a href="/crypto/tls/conn.go.html#3866523">n</a></span>&nbsp;<span class="op" id="3867967">!=</span>&nbsp;<span class="num" id="3867970">0</span>&nbsp;<span class="op" id="3867972">&amp;&amp;</span>&nbsp;<span class="ident" id="3867975"><a href="/crypto/tls/conn.go.html#3866530">err</a></span>&nbsp;<span class="op" id="3867979">==</span>&nbsp;<span class="ident" id="3867982">nil</span>&nbsp;<span class="op" id="3867986">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867992"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3867993">.</span><span class="ident" id="3867994">input</span>&nbsp;<span class="op" id="3868000">==</span>&nbsp;<span class="ident" id="3868003">nil</span>&nbsp;<span class="op" id="3868007">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3868010">len</span><span class="op" id="3868013">(</span><span class="ident" id="3868014"><a href="/crypto/tls/conn.go.html#3867931">ri</a></span><span class="op" id="3868016">.</span><span class="ident" id="3868017">data</span><span class="op" id="3868021">)</span>&nbsp;<span class="op" id="3868023">&gt;</span>&nbsp;<span class="num" id="3868025">0</span>&nbsp;<span class="op" id="3868027">&amp;&amp;</span>&nbsp;<span class="ident" id="3868030"><a href="/crypto/tls/common.go.html#3823239">recordType</a></span><span class="op" id="3868040">(</span><span class="ident" id="3868041"><a href="/crypto/tls/conn.go.html#3867931">ri</a></span><span class="op" id="3868043">.</span><span class="ident" id="3868044">data</span><span class="op" id="3868048">[</span><span class="num" id="3868049">0</span><span class="op" id="3868050">]</span><span class="op" id="3868051">)</span>&nbsp;<span class="op" id="3868053">==</span>&nbsp;<span class="ident" id="3868056"><a href="/crypto/tls/common.go.html#3823310">recordTypeAlert</a></span>&nbsp;<span class="op" id="3868072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868077">if</span>&nbsp;<span class="ident" id="3868080">recErr</span>&nbsp;<span class="op" id="3868087">:=</span>&nbsp;<span class="ident" id="3868090"><a href="/crypto/tls/conn.go.html#3866498">c</a></span><span class="op" id="3868091">.</span><span class="ident" id="3868092">readRecord</span><span class="op" id="3868102">(</span><span class="ident" id="3868103"><a href="/crypto/tls/common.go.html#3823398">recordTypeApplicationData</a></span><span class="op" id="3868128">)</span><span class="op" id="3868129">;</span>&nbsp;<span class="ident" id="3868131"><a href="/crypto/tls/conn.go.html#3868080">recErr</a></span>&nbsp;<span class="op" id="3868138">!=</span>&nbsp;<span class="ident" id="3868141">nil</span>&nbsp;<span class="op" id="3868145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868151"><a href="/crypto/tls/conn.go.html#3866530">err</a></span>&nbsp;<span class="op" id="3868155">=</span>&nbsp;<span class="ident" id="3868157"><a href="/crypto/tls/conn.go.html#3868080">recErr</a></span>&nbsp;<span class="comment" id="3868164">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868209">if</span>&nbsp;<span class="ident" id="3868212"><a href="/crypto/tls/conn.go.html#3866523">n</a></span>&nbsp;<span class="op" id="3868214">!=</span>&nbsp;<span class="num" id="3868217">0</span>&nbsp;<span class="op" id="3868219">||</span>&nbsp;<span class="ident" id="3868222"><a href="/crypto/tls/conn.go.html#3866530">err</a></span>&nbsp;<span class="op" id="3868226">!=</span>&nbsp;<span class="ident" id="3868229">nil</span>&nbsp;<span class="op" id="3868233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868238">return</span>&nbsp;<span class="ident" id="3868245"><a href="/crypto/tls/conn.go.html#3866523">n</a></span><span class="op" id="3868246">,</span>&nbsp;<span class="ident" id="3868248"><a href="/crypto/tls/conn.go.html#3866530">err</a></span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868261">return</span>&nbsp;<span class="num" id="3868268">0</span><span class="op" id="3868269">,</span>&nbsp;<span class="ident" id="3868271"><a href="/crypto/tls/conn.go.html#3842115">io</a></span><span class="op" id="3868273">.</span><span class="ident" id="3868274">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="3868288">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="3868291">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3868323">func</span>&nbsp;<span class="op" id="3868328">(</span><span class="ident" id="3868329">c</span>&nbsp;<span class="op" id="3868331">*</span><span class="ident" id="3868332"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3868336">)</span>&nbsp;<span class="ident" id="3868338">Close</span><span class="op" id="3868343">(</span><span class="op" id="3868344">)</span>&nbsp;<span class="builtintype" id="3868346">error</span>&nbsp;<span class="op" id="3868352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868355">var</span>&nbsp;<span class="ident" id="3868359">alertErr</span>&nbsp;<span class="builtintype" id="3868368">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868376"><a href="/crypto/tls/conn.go.html#3868329">c</a></span><span class="op" id="3868377">.</span><span class="ident" id="3868378">handshakeMutex</span><span class="op" id="3868392">.</span><span class="ident" id="3868393">Lock</span><span class="op" id="3868397">(</span><span class="op" id="3868398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868401">defer</span>&nbsp;<span class="ident" id="3868407"><a href="/crypto/tls/conn.go.html#3868329">c</a></span><span class="op" id="3868408">.</span><span class="ident" id="3868409">handshakeMutex</span><span class="op" id="3868423">.</span><span class="ident" id="3868424">Unlock</span><span class="op" id="3868430">(</span><span class="op" id="3868431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868434">if</span>&nbsp;<span class="ident" id="3868437"><a href="/crypto/tls/conn.go.html#3868329">c</a></span><span class="op" id="3868438">.</span><span class="ident" id="3868439">handshakeComplete</span>&nbsp;<span class="op" id="3868457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868461"><a href="/crypto/tls/conn.go.html#3868359">alertErr</a></span>&nbsp;<span class="op" id="3868470">=</span>&nbsp;<span class="ident" id="3868472"><a href="/crypto/tls/conn.go.html#3868329">c</a></span><span class="op" id="3868473">.</span><span class="ident" id="3868474">sendAlert</span><span class="op" id="3868483">(</span><span class="ident" id="3868484"><a href="/crypto/tls/alert.go.html#3810589">alertCloseNotify</a></span><span class="op" id="3868500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868503">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868507">if</span>&nbsp;<span class="ident" id="3868510">err</span>&nbsp;<span class="op" id="3868514">:=</span>&nbsp;<span class="ident" id="3868517"><a href="/crypto/tls/conn.go.html#3868329">c</a></span><span class="op" id="3868518">.</span><span class="ident" id="3868519">conn</span><span class="op" id="3868523">.</span><span class="ident" id="3868524">Close</span><span class="op" id="3868529">(</span><span class="op" id="3868530">)</span><span class="op" id="3868531">;</span>&nbsp;<span class="ident" id="3868533"><a href="/crypto/tls/conn.go.html#3868510">err</a></span>&nbsp;<span class="op" id="3868537">!=</span>&nbsp;<span class="ident" id="3868540">nil</span>&nbsp;<span class="op" id="3868544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868548">return</span>&nbsp;<span class="ident" id="3868555"><a href="/crypto/tls/conn.go.html#3868510">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868563">return</span>&nbsp;<span class="ident" id="3868570"><a href="/crypto/tls/conn.go.html#3868359">alertErr</a></span><br>
<span class="lineno">960</span><span class="op" id="3868579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3868582">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="3868631">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="3868671">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="3868724">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="3868791">func</span>&nbsp;<span class="op" id="3868796">(</span><span class="ident" id="3868797">c</span>&nbsp;<span class="op" id="3868799">*</span><span class="ident" id="3868800"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3868804">)</span>&nbsp;<span class="ident" id="3868806">Handshake</span><span class="op" id="3868815">(</span><span class="op" id="3868816">)</span>&nbsp;<span class="builtintype" id="3868818">error</span>&nbsp;<span class="op" id="3868824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868827"><a href="/crypto/tls/conn.go.html#3868797">c</a></span><span class="op" id="3868828">.</span><span class="ident" id="3868829">handshakeMutex</span><span class="op" id="3868843">.</span><span class="ident" id="3868844">Lock</span><span class="op" id="3868848">(</span><span class="op" id="3868849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868852">defer</span>&nbsp;<span class="ident" id="3868858"><a href="/crypto/tls/conn.go.html#3868797">c</a></span><span class="op" id="3868859">.</span><span class="ident" id="3868860">handshakeMutex</span><span class="op" id="3868874">.</span><span class="ident" id="3868875">Unlock</span><span class="op" id="3868881">(</span><span class="op" id="3868882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868885">if</span>&nbsp;<span class="ident" id="3868888">err</span>&nbsp;<span class="op" id="3868892">:=</span>&nbsp;<span class="ident" id="3868895"><a href="/crypto/tls/conn.go.html#3868797">c</a></span><span class="op" id="3868896">.</span><span class="ident" id="3868897">handshakeErr</span><span class="op" id="3868909">;</span>&nbsp;<span class="ident" id="3868911"><a href="/crypto/tls/conn.go.html#3868888">err</a></span>&nbsp;<span class="op" id="3868915">!=</span>&nbsp;<span class="ident" id="3868918">nil</span>&nbsp;<span class="op" id="3868922">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868926">return</span>&nbsp;<span class="ident" id="3868933"><a href="/crypto/tls/conn.go.html#3868888">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868941">if</span>&nbsp;<span class="ident" id="3868944"><a href="/crypto/tls/conn.go.html#3868797">c</a></span><span class="op" id="3868945">.</span><span class="ident" id="3868946">handshakeComplete</span>&nbsp;<span class="op" id="3868964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868968">return</span>&nbsp;<span class="ident" id="3868975">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868980">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868984">if</span>&nbsp;<span class="ident" id="3868987"><a href="/crypto/tls/conn.go.html#3868797">c</a></span><span class="op" id="3868988">.</span><span class="ident" id="3868989">isClient</span>&nbsp;<span class="op" id="3868998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869002"><a href="/crypto/tls/conn.go.html#3868797">c</a></span><span class="op" id="3869003">.</span><span class="ident" id="3869004">handshakeErr</span>&nbsp;<span class="op" id="3869017">=</span>&nbsp;<span class="ident" id="3869019"><a href="/crypto/tls/conn.go.html#3868797">c</a></span><span class="op" id="3869020">.</span><span class="ident" id="3869021">clientHandshake</span><span class="op" id="3869036">(</span><span class="op" id="3869037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869040">}</span>&nbsp;<span class="keyword" id="3869042">else</span>&nbsp;<span class="op" id="3869047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869051"><a href="/crypto/tls/conn.go.html#3868797">c</a></span><span class="op" id="3869052">.</span><span class="ident" id="3869053">handshakeErr</span>&nbsp;<span class="op" id="3869066">=</span>&nbsp;<span class="ident" id="3869068"><a href="/crypto/tls/conn.go.html#3868797">c</a></span><span class="op" id="3869069">.</span><span class="ident" id="3869070">serverHandshake</span><span class="op" id="3869085">(</span><span class="op" id="3869086">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869092">return</span>&nbsp;<span class="ident" id="3869099"><a href="/crypto/tls/conn.go.html#3868797">c</a></span><span class="op" id="3869100">.</span><span class="ident" id="3869101">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="3869114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3869117">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="3869184">func</span>&nbsp;<span class="op" id="3869189">(</span><span class="ident" id="3869190">c</span>&nbsp;<span class="op" id="3869192">*</span><span class="ident" id="3869193"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3869197">)</span>&nbsp;<span class="ident" id="3869199">ConnectionState</span><span class="op" id="3869214">(</span><span class="op" id="3869215">)</span>&nbsp;<span class="ident" id="3869217"><a href="/crypto/tls/common.go.html#3826826">ConnectionState</a></span>&nbsp;<span class="op" id="3869233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869236"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869237">.</span><span class="ident" id="3869238">handshakeMutex</span><span class="op" id="3869252">.</span><span class="ident" id="3869253">Lock</span><span class="op" id="3869257">(</span><span class="op" id="3869258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869261">defer</span>&nbsp;<span class="ident" id="3869267"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869268">.</span><span class="ident" id="3869269">handshakeMutex</span><span class="op" id="3869283">.</span><span class="ident" id="3869284">Unlock</span><span class="op" id="3869290">(</span><span class="op" id="3869291">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869295">var</span>&nbsp;<span class="ident" id="3869299">state</span>&nbsp;<span class="ident" id="3869305"><a href="/crypto/tls/common.go.html#3826826">ConnectionState</a></span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869322"><a href="/crypto/tls/conn.go.html#3869299">state</a></span><span class="op" id="3869327">.</span><span class="ident" id="3869328">HandshakeComplete</span>&nbsp;<span class="op" id="3869346">=</span>&nbsp;<span class="ident" id="3869348"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869349">.</span><span class="ident" id="3869350">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869369">if</span>&nbsp;<span class="ident" id="3869372"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869373">.</span><span class="ident" id="3869374">handshakeComplete</span>&nbsp;<span class="op" id="3869392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869396"><a href="/crypto/tls/conn.go.html#3869299">state</a></span><span class="op" id="3869401">.</span><span class="ident" id="3869402">Version</span>&nbsp;<span class="op" id="3869410">=</span>&nbsp;<span class="ident" id="3869412"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869413">.</span><span class="ident" id="3869414">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869421"><a href="/crypto/tls/conn.go.html#3869299">state</a></span><span class="op" id="3869426">.</span><span class="ident" id="3869427">NegotiatedProtocol</span>&nbsp;<span class="op" id="3869446">=</span>&nbsp;<span class="ident" id="3869448"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869449">.</span><span class="ident" id="3869450">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869467"><a href="/crypto/tls/conn.go.html#3869299">state</a></span><span class="op" id="3869472">.</span><span class="ident" id="3869473">DidResume</span>&nbsp;<span class="op" id="3869483">=</span>&nbsp;<span class="ident" id="3869485"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869486">.</span><span class="ident" id="3869487">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869499"><a href="/crypto/tls/conn.go.html#3869299">state</a></span><span class="op" id="3869504">.</span><span class="ident" id="3869505">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="3869532">=</span>&nbsp;<span class="op" id="3869534">!</span><span class="ident" id="3869535"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869536">.</span><span class="ident" id="3869537">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869562"><a href="/crypto/tls/conn.go.html#3869299">state</a></span><span class="op" id="3869567">.</span><span class="ident" id="3869568">CipherSuite</span>&nbsp;<span class="op" id="3869580">=</span>&nbsp;<span class="ident" id="3869582"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869583">.</span><span class="ident" id="3869584">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869598"><a href="/crypto/tls/conn.go.html#3869299">state</a></span><span class="op" id="3869603">.</span><span class="ident" id="3869604">PeerCertificates</span>&nbsp;<span class="op" id="3869621">=</span>&nbsp;<span class="ident" id="3869623"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869624">.</span><span class="ident" id="3869625">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869644"><a href="/crypto/tls/conn.go.html#3869299">state</a></span><span class="op" id="3869649">.</span><span class="ident" id="3869650">VerifiedChains</span>&nbsp;<span class="op" id="3869665">=</span>&nbsp;<span class="ident" id="3869667"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869668">.</span><span class="ident" id="3869669">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869686"><a href="/crypto/tls/conn.go.html#3869299">state</a></span><span class="op" id="3869691">.</span><span class="ident" id="3869692">ServerName</span>&nbsp;<span class="op" id="3869703">=</span>&nbsp;<span class="ident" id="3869705"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869706">.</span><span class="ident" id="3869707">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869720">if</span>&nbsp;<span class="op" id="3869723">!</span><span class="ident" id="3869724"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869725">.</span><span class="ident" id="3869726">didResume</span>&nbsp;<span class="op" id="3869736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869741"><a href="/crypto/tls/conn.go.html#3869299">state</a></span><span class="op" id="3869746">.</span><span class="ident" id="3869747">TLSUnique</span>&nbsp;<span class="op" id="3869757">=</span>&nbsp;<span class="ident" id="3869759"><a href="/crypto/tls/conn.go.html#3869190">c</a></span><span class="op" id="3869760">.</span><span class="ident" id="3869761">firstFinished</span><span class="op" id="3869774">[</span><span class="op" id="3869775">:</span><span class="op" id="3869776">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869787">return</span>&nbsp;<span class="ident" id="3869794"><a href="/crypto/tls/conn.go.html#3869299">state</a></span><br>
<span class="lineno"></span><span class="op" id="3869800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3869803">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="3869877">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="3869922">func</span>&nbsp;<span class="op" id="3869927">(</span><span class="ident" id="3869928">c</span>&nbsp;<span class="op" id="3869930">*</span><span class="ident" id="3869931"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3869935">)</span>&nbsp;<span class="ident" id="3869937">OCSPResponse</span><span class="op" id="3869949">(</span><span class="op" id="3869950">)</span>&nbsp;<span class="op" id="3869952">[</span><span class="op" id="3869953">]</span><span class="builtintype" id="3869954">byte</span>&nbsp;<span class="op" id="3869959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869962"><a href="/crypto/tls/conn.go.html#3869928">c</a></span><span class="op" id="3869963">.</span><span class="ident" id="3869964">handshakeMutex</span><span class="op" id="3869978">.</span><span class="ident" id="3869979">Lock</span><span class="op" id="3869983">(</span><span class="op" id="3869984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869987">defer</span>&nbsp;<span class="ident" id="3869993"><a href="/crypto/tls/conn.go.html#3869928">c</a></span><span class="op" id="3869994">.</span><span class="ident" id="3869995">handshakeMutex</span><span class="op" id="3870009">.</span><span class="ident" id="3870010">Unlock</span><span class="op" id="3870016">(</span><span class="op" id="3870017">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870021">return</span>&nbsp;<span class="ident" id="3870028"><a href="/crypto/tls/conn.go.html#3869928">c</a></span><span class="op" id="3870029">.</span><span class="ident" id="3870030">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="3870043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3870046">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3870116">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3870191">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="3870218">func</span>&nbsp;<span class="op" id="3870223">(</span><span class="ident" id="3870224">c</span>&nbsp;<span class="op" id="3870226">*</span><span class="ident" id="3870227"><a href="/crypto/tls/conn.go.html#3842235">Conn</a></span><span class="op" id="3870231">)</span>&nbsp;<span class="ident" id="3870233">VerifyHostname</span><span class="op" id="3870247">(</span><span class="ident" id="3870248">host</span>&nbsp;<span class="builtintype" id="3870253">string</span><span class="op" id="3870259">)</span>&nbsp;<span class="builtintype" id="3870261">error</span>&nbsp;<span class="op" id="3870267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870270"><a href="/crypto/tls/conn.go.html#3870224">c</a></span><span class="op" id="3870271">.</span><span class="ident" id="3870272">handshakeMutex</span><span class="op" id="3870286">.</span><span class="ident" id="3870287">Lock</span><span class="op" id="3870291">(</span><span class="op" id="3870292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870295">defer</span>&nbsp;<span class="ident" id="3870301"><a href="/crypto/tls/conn.go.html#3870224">c</a></span><span class="op" id="3870302">.</span><span class="ident" id="3870303">handshakeMutex</span><span class="op" id="3870317">.</span><span class="ident" id="3870318">Unlock</span><span class="op" id="3870324">(</span><span class="op" id="3870325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870328">if</span>&nbsp;<span class="op" id="3870331">!</span><span class="ident" id="3870332"><a href="/crypto/tls/conn.go.html#3870224">c</a></span><span class="op" id="3870333">.</span><span class="ident" id="3870334">isClient</span>&nbsp;<span class="op" id="3870343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870347">return</span>&nbsp;<span class="ident" id="3870354"><a href="/crypto/tls/conn.go.html#3842098">errors</a></span><span class="op" id="3870360">.</span><span class="ident" id="3870361">New</span><span class="op" id="3870364">(</span><span class="string" id="3870365">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="3870418">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870424">if</span>&nbsp;<span class="op" id="3870427">!</span><span class="ident" id="3870428"><a href="/crypto/tls/conn.go.html#3870224">c</a></span><span class="op" id="3870429">.</span><span class="ident" id="3870430">handshakeComplete</span>&nbsp;<span class="op" id="3870448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870452">return</span>&nbsp;<span class="ident" id="3870459"><a href="/crypto/tls/conn.go.html#3842098">errors</a></span><span class="op" id="3870465">.</span><span class="ident" id="3870466">New</span><span class="op" id="3870469">(</span><span class="string" id="3870470">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="3870513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870519">return</span>&nbsp;<span class="ident" id="3870526"><a href="/crypto/tls/conn.go.html#3870224">c</a></span><span class="op" id="3870527">.</span><span class="ident" id="3870528">peerCertificates</span><span class="op" id="3870544">[</span><span class="num" id="3870545">0</span><span class="op" id="3870546">]</span><span class="op" id="3870547">.</span><span class="ident" id="3870548">VerifyHostname</span><span class="op" id="3870562">(</span><span class="ident" id="3870563"><a href="/crypto/tls/conn.go.html#3870248">host</a></span><span class="op" id="3870567">)</span><br>
<span class="lineno">1030</span><span class="op" id="3870569">}</span>
</div>
</body>
</html>
