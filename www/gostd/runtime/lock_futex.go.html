<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1916892">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1916947">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1917001">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1917052">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1917087">package</span>&nbsp;<span class="ident" id="1917095">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1917104">import</span>&nbsp;<span class="string" id="1917111">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1917121">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1917186">//</span><br>
<span class="lineno"></span><span class="comment" id="1917189">//&nbsp;&nbsp;&nbsp;&nbspruntime·futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1917248">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspAtomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1917264">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1917292">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspMight&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1917342">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspDon&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1917396">//</span><br>
<span class="lineno"></span><span class="comment" id="1917399">//&nbsp;&nbsp;&nbsp;&nbspruntime·futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1917449">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1917510">const</span>&nbsp;<span class="op" id="1917516">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1917519">mutex_unlocked</span>&nbsp;<span class="op" id="1917534">=</span>&nbsp;<span class="num" id="1917536">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1917539">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1917554">=</span>&nbsp;<span class="num" id="1917556">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1917559">mutex_sleeping</span>&nbsp;<span class="op" id="1917574">=</span>&nbsp;<span class="num" id="1917576">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1917580">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1917596">=</span>&nbsp;<span class="num" id="1917598">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1917601">active_spin_cnt</span>&nbsp;<span class="op" id="1917617">=</span>&nbsp;<span class="num" id="1917619">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1917623">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1917639">=</span>&nbsp;<span class="num" id="1917641">1</span><br>
<span class="lineno">30</span><span class="op" id="1917643">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1917646">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1917723">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1917802">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1917877">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1917903">func</span>&nbsp;<span class="ident" id="1917908">futexsleep</span><span class="op" id="1917918">(</span><span class="ident" id="1917919">addr</span>&nbsp;<span class="op" id="1917924">*</span><span class="builtintype" id="1917925">uint32</span><span class="op" id="1917931">,</span>&nbsp;<span class="ident" id="1917933">val</span>&nbsp;<span class="builtintype" id="1917937">uint32</span><span class="op" id="1917943">,</span>&nbsp;<span class="ident" id="1917945">ns</span>&nbsp;<span class="ident" id="1917948">int64</span><span class="op" id="1917953">)</span><br>
<span class="lineno"></span><span class="keyword" id="1917955">func</span>&nbsp;<span class="ident" id="1917960">futexwakeup</span><span class="op" id="1917971">(</span><span class="ident" id="1917972">addr</span>&nbsp;<span class="op" id="1917977">*</span><span class="builtintype" id="1917978">uint32</span><span class="op" id="1917984">,</span>&nbsp;<span class="ident" id="1917986">cnt</span>&nbsp;<span class="builtintype" id="1917990">uint32</span><span class="op" id="1917996">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1917999">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1918057">func</span>&nbsp;<span class="ident" id="1918062">key32</span><span class="op" id="1918067">(</span><span class="ident" id="1918068">p</span>&nbsp;<span class="op" id="1918070">*</span><span class="builtintype" id="1918071">uintptr</span><span class="op" id="1918078">)</span>&nbsp;<span class="op" id="1918080">*</span><span class="builtintype" id="1918081">uint32</span>&nbsp;<span class="op" id="1918088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1918091">return</span>&nbsp;<span class="op" id="1918098">(</span><span class="op" id="1918099">*</span><span class="builtintype" id="1918100">uint32</span><span class="op" id="1918106">)</span><span class="op" id="1918107">(</span><span class="ident" id="1918108">unsafe</span><span class="op" id="1918114">.</span><span class="ident" id="1918115">Pointer</span><span class="op" id="1918122">(</span><span class="ident" id="1918123">p</span><span class="op" id="1918124">)</span><span class="op" id="1918125">)</span><br>
<span class="lineno"></span><span class="op" id="1918127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1918130">func</span>&nbsp;<span class="ident" id="1918135">lock</span><span class="op" id="1918139">(</span><span class="ident" id="1918140">l</span>&nbsp;<span class="op" id="1918142">*</span><span class="ident" id="1918143">mutex</span><span class="op" id="1918148">)</span>&nbsp;<span class="op" id="1918150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1918153">gp</span>&nbsp;<span class="op" id="1918156">:=</span>&nbsp;<span class="ident" id="1918159">getg</span><span class="op" id="1918163">(</span><span class="op" id="1918164">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1918168">if</span>&nbsp;<span class="ident" id="1918171">gp</span><span class="op" id="1918173">.</span><span class="ident" id="1918174">m</span><span class="op" id="1918175">.</span><span class="ident" id="1918176">locks</span>&nbsp;<span class="op" id="1918182">&lt;</span>&nbsp;<span class="num" id="1918184">0</span>&nbsp;<span class="op" id="1918186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1918190">gothrow</span><span class="op" id="1918197">(</span><span class="string" id="1918198">&#34;runtime·lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1918225">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1918228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1918231">gp</span><span class="op" id="1918233">.</span><span class="ident" id="1918234">m</span><span class="op" id="1918235">.</span><span class="ident" id="1918236">locks</span><span class="op" id="1918241">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1918246">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1918277">v</span>&nbsp;<span class="op" id="1918279">:=</span>&nbsp;<span class="ident" id="1918282">xchg</span><span class="op" id="1918286">(</span><span class="ident" id="1918287">key32</span><span class="op" id="1918292">(</span><span class="op" id="1918293">&amp;</span><span class="ident" id="1918294">l</span><span class="op" id="1918295">.</span><span class="ident" id="1918296">key</span><span class="op" id="1918299">)</span><span class="op" id="1918300">,</span>&nbsp;<span class="ident" id="1918302">mutex_locked</span><span class="op" id="1918314">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1918317">if</span>&nbsp;<span class="ident" id="1918320">v</span>&nbsp;<span class="op" id="1918322">==</span>&nbsp;<span class="ident" id="1918325">mutex_unlocked</span>&nbsp;<span class="op" id="1918340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1918344">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1918352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1918356">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1918406">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1918458">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1918508">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1918559">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1918614">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1918669">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1918690">wait</span>&nbsp;<span class="op" id="1918695">:=</span>&nbsp;<span class="ident" id="1918698">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1918702">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1918743">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1918798">spin</span>&nbsp;<span class="op" id="1918803">:=</span>&nbsp;<span class="num" id="1918806">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1918809">if</span>&nbsp;<span class="ident" id="1918812">ncpu</span>&nbsp;<span class="op" id="1918817">&gt;</span>&nbsp;<span class="num" id="1918819">1</span>&nbsp;<span class="op" id="1918821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1918825">spin</span>&nbsp;<span class="op" id="1918830">=</span>&nbsp;<span class="ident" id="1918832">active_spin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1918845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1918848">for</span>&nbsp;<span class="op" id="1918852">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1918856">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1918885">for</span>&nbsp;<span class="ident" id="1918889">i</span>&nbsp;<span class="op" id="1918891">:=</span>&nbsp;<span class="num" id="1918894">0</span><span class="op" id="1918895">;</span>&nbsp;<span class="ident" id="1918897">i</span>&nbsp;<span class="op" id="1918899">&lt;</span>&nbsp;<span class="ident" id="1918901">spin</span><span class="op" id="1918905">;</span>&nbsp;<span class="ident" id="1918907">i</span><span class="op" id="1918908">++</span>&nbsp;<span class="op" id="1918911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1918916">for</span>&nbsp;<span class="ident" id="1918920">l</span><span class="op" id="1918921">.</span><span class="ident" id="1918922">key</span>&nbsp;<span class="op" id="1918926">==</span>&nbsp;<span class="ident" id="1918929">mutex_unlocked</span>&nbsp;<span class="op" id="1918944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1918950">if</span>&nbsp;<span class="ident" id="1918953">cas</span><span class="op" id="1918956">(</span><span class="ident" id="1918957">key32</span><span class="op" id="1918962">(</span><span class="op" id="1918963">&amp;</span><span class="ident" id="1918964">l</span><span class="op" id="1918965">.</span><span class="ident" id="1918966">key</span><span class="op" id="1918969">)</span><span class="op" id="1918970">,</span>&nbsp;<span class="ident" id="1918972">mutex_unlocked</span><span class="op" id="1918986">,</span>&nbsp;<span class="ident" id="1918988">wait</span><span class="op" id="1918992">)</span>&nbsp;<span class="op" id="1918994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919001">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919022">procyield</span><span class="op" id="1919031">(</span><span class="ident" id="1919032">active_spin_cnt</span><span class="op" id="1919047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1919056">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919089">for</span>&nbsp;<span class="ident" id="1919093">i</span>&nbsp;<span class="op" id="1919095">:=</span>&nbsp;<span class="num" id="1919098">0</span><span class="op" id="1919099">;</span>&nbsp;<span class="ident" id="1919101">i</span>&nbsp;<span class="op" id="1919103">&lt;</span>&nbsp;<span class="ident" id="1919105">passive_spin</span><span class="op" id="1919117">;</span>&nbsp;<span class="ident" id="1919119">i</span><span class="op" id="1919120">++</span>&nbsp;<span class="op" id="1919123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919128">for</span>&nbsp;<span class="ident" id="1919132">l</span><span class="op" id="1919133">.</span><span class="ident" id="1919134">key</span>&nbsp;<span class="op" id="1919138">==</span>&nbsp;<span class="ident" id="1919141">mutex_unlocked</span>&nbsp;<span class="op" id="1919156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919162">if</span>&nbsp;<span class="ident" id="1919165">cas</span><span class="op" id="1919168">(</span><span class="ident" id="1919169">key32</span><span class="op" id="1919174">(</span><span class="op" id="1919175">&amp;</span><span class="ident" id="1919176">l</span><span class="op" id="1919177">.</span><span class="ident" id="1919178">key</span><span class="op" id="1919181">)</span><span class="op" id="1919182">,</span>&nbsp;<span class="ident" id="1919184">mutex_unlocked</span><span class="op" id="1919198">,</span>&nbsp;<span class="ident" id="1919200">wait</span><span class="op" id="1919204">)</span>&nbsp;<span class="op" id="1919206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919213">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919234">osyield</span><span class="op" id="1919241">(</span><span class="op" id="1919242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1919251">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919263">v</span>&nbsp;<span class="op" id="1919265">=</span>&nbsp;<span class="ident" id="1919267">xchg</span><span class="op" id="1919271">(</span><span class="ident" id="1919272">key32</span><span class="op" id="1919277">(</span><span class="op" id="1919278">&amp;</span><span class="ident" id="1919279">l</span><span class="op" id="1919280">.</span><span class="ident" id="1919281">key</span><span class="op" id="1919284">)</span><span class="op" id="1919285">,</span>&nbsp;<span class="ident" id="1919287">mutex_sleeping</span><span class="op" id="1919301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919305">if</span>&nbsp;<span class="ident" id="1919308">v</span>&nbsp;<span class="op" id="1919310">==</span>&nbsp;<span class="ident" id="1919313">mutex_unlocked</span>&nbsp;<span class="op" id="1919328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919333">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919342">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919346">wait</span>&nbsp;<span class="op" id="1919351">=</span>&nbsp;<span class="ident" id="1919353">mutex_sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919370">futexsleep</span><span class="op" id="1919380">(</span><span class="ident" id="1919381">key32</span><span class="op" id="1919386">(</span><span class="op" id="1919387">&amp;</span><span class="ident" id="1919388">l</span><span class="op" id="1919389">.</span><span class="ident" id="1919390">key</span><span class="op" id="1919393">)</span><span class="op" id="1919394">,</span>&nbsp;<span class="ident" id="1919396">mutex_sleeping</span><span class="op" id="1919410">,</span>&nbsp;<span class="op" id="1919412">-</span><span class="num" id="1919413">1</span><span class="op" id="1919414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919417">}</span><br>
<span class="lineno"></span><span class="op" id="1919419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1919422">func</span>&nbsp;<span class="ident" id="1919427">unlock</span><span class="op" id="1919433">(</span><span class="ident" id="1919434">l</span>&nbsp;<span class="op" id="1919436">*</span><span class="ident" id="1919437">mutex</span><span class="op" id="1919442">)</span>&nbsp;<span class="op" id="1919444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919447">v</span>&nbsp;<span class="op" id="1919449">:=</span>&nbsp;<span class="ident" id="1919452">xchg</span><span class="op" id="1919456">(</span><span class="ident" id="1919457">key32</span><span class="op" id="1919462">(</span><span class="op" id="1919463">&amp;</span><span class="ident" id="1919464">l</span><span class="op" id="1919465">.</span><span class="ident" id="1919466">key</span><span class="op" id="1919469">)</span><span class="op" id="1919470">,</span>&nbsp;<span class="ident" id="1919472">mutex_unlocked</span><span class="op" id="1919486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919489">if</span>&nbsp;<span class="ident" id="1919492">v</span>&nbsp;<span class="op" id="1919494">==</span>&nbsp;<span class="ident" id="1919497">mutex_unlocked</span>&nbsp;<span class="op" id="1919512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919516">gothrow</span><span class="op" id="1919523">(</span><span class="string" id="1919524">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1919549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919552">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919555">if</span>&nbsp;<span class="ident" id="1919558">v</span>&nbsp;<span class="op" id="1919560">==</span>&nbsp;<span class="ident" id="1919563">mutex_sleeping</span>&nbsp;<span class="op" id="1919578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919582">futexwakeup</span><span class="op" id="1919593">(</span><span class="ident" id="1919594">key32</span><span class="op" id="1919599">(</span><span class="op" id="1919600">&amp;</span><span class="ident" id="1919601">l</span><span class="op" id="1919602">.</span><span class="ident" id="1919603">key</span><span class="op" id="1919606">)</span><span class="op" id="1919607">,</span>&nbsp;<span class="num" id="1919609">1</span><span class="op" id="1919610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919617">gp</span>&nbsp;<span class="op" id="1919620">:=</span>&nbsp;<span class="ident" id="1919623">getg</span><span class="op" id="1919627">(</span><span class="op" id="1919628">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919631">gp</span><span class="op" id="1919633">.</span><span class="ident" id="1919634">m</span><span class="op" id="1919635">.</span><span class="ident" id="1919636">locks</span><span class="op" id="1919641">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919645">if</span>&nbsp;<span class="ident" id="1919648">gp</span><span class="op" id="1919650">.</span><span class="ident" id="1919651">m</span><span class="op" id="1919652">.</span><span class="ident" id="1919653">locks</span>&nbsp;<span class="op" id="1919659">&lt;</span>&nbsp;<span class="num" id="1919661">0</span>&nbsp;<span class="op" id="1919663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919667">gothrow</span><span class="op" id="1919674">(</span><span class="string" id="1919675">&#34;runtime·unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1919704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919710">if</span>&nbsp;<span class="ident" id="1919713">gp</span><span class="op" id="1919715">.</span><span class="ident" id="1919716">m</span><span class="op" id="1919717">.</span><span class="ident" id="1919718">locks</span>&nbsp;<span class="op" id="1919724">==</span>&nbsp;<span class="num" id="1919727">0</span>&nbsp;<span class="op" id="1919729">&amp;&amp;</span>&nbsp;<span class="ident" id="1919732">gp</span><span class="op" id="1919734">.</span><span class="ident" id="1919735">preempt</span>&nbsp;<span class="op" id="1919743">{</span>&nbsp;<span class="comment" id="1919745">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919818">gp</span><span class="op" id="1919820">.</span><span class="ident" id="1919821">stackguard0</span>&nbsp;<span class="op" id="1919833">=</span>&nbsp;<span class="ident" id="1919835">stackPreempt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1919849">}</span><br>
<span class="lineno"></span><span class="op" id="1919851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1919854">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1919881">func</span>&nbsp;<span class="ident" id="1919886">noteclear</span><span class="op" id="1919895">(</span><span class="ident" id="1919896">n</span>&nbsp;<span class="op" id="1919898">*</span><span class="ident" id="1919899">note</span><span class="op" id="1919903">)</span>&nbsp;<span class="op" id="1919905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919908">n</span><span class="op" id="1919909">.</span><span class="ident" id="1919910">key</span>&nbsp;<span class="op" id="1919914">=</span>&nbsp;<span class="num" id="1919916">0</span><br>
<span class="lineno"></span><span class="op" id="1919918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1919921">func</span>&nbsp;<span class="ident" id="1919926">notewakeup</span><span class="op" id="1919936">(</span><span class="ident" id="1919937">n</span>&nbsp;<span class="op" id="1919939">*</span><span class="ident" id="1919940">note</span><span class="op" id="1919944">)</span>&nbsp;<span class="op" id="1919946">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1919949">old</span>&nbsp;<span class="op" id="1919953">:=</span>&nbsp;<span class="ident" id="1919956">xchg</span><span class="op" id="1919960">(</span><span class="ident" id="1919961">key32</span><span class="op" id="1919966">(</span><span class="op" id="1919967">&amp;</span><span class="ident" id="1919968">n</span><span class="op" id="1919969">.</span><span class="ident" id="1919970">key</span><span class="op" id="1919973">)</span><span class="op" id="1919974">,</span>&nbsp;<span class="num" id="1919976">1</span><span class="op" id="1919977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1919980">if</span>&nbsp;<span class="ident" id="1919983">old</span>&nbsp;<span class="op" id="1919987">!=</span>&nbsp;<span class="num" id="1919990">0</span>&nbsp;<span class="op" id="1919992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1919996">print</span><span class="op" id="1920001">(</span><span class="string" id="1920002">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1920032">,</span>&nbsp;<span class="ident" id="1920034">old</span><span class="op" id="1920037">,</span>&nbsp;<span class="string" id="1920039">&#34;)\n&#34;</span><span class="op" id="1920044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920048">gothrow</span><span class="op" id="1920055">(</span><span class="string" id="1920056">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1920084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1920087">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920090">futexwakeup</span><span class="op" id="1920101">(</span><span class="ident" id="1920102">key32</span><span class="op" id="1920107">(</span><span class="op" id="1920108">&amp;</span><span class="ident" id="1920109">n</span><span class="op" id="1920110">.</span><span class="ident" id="1920111">key</span><span class="op" id="1920114">)</span><span class="op" id="1920115">,</span>&nbsp;<span class="num" id="1920117">1</span><span class="op" id="1920118">)</span><br>
<span class="lineno"></span><span class="op" id="1920120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1920123">func</span>&nbsp;<span class="ident" id="1920128">notesleep</span><span class="op" id="1920137">(</span><span class="ident" id="1920138">n</span>&nbsp;<span class="op" id="1920140">*</span><span class="ident" id="1920141">note</span><span class="op" id="1920145">)</span>&nbsp;<span class="op" id="1920147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920150">gp</span>&nbsp;<span class="op" id="1920153">:=</span>&nbsp;<span class="ident" id="1920156">getg</span><span class="op" id="1920160">(</span><span class="op" id="1920161">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920164">if</span>&nbsp;<span class="ident" id="1920167">gp</span>&nbsp;<span class="op" id="1920170">!=</span>&nbsp;<span class="ident" id="1920173">gp</span><span class="op" id="1920175">.</span><span class="ident" id="1920176">m</span><span class="op" id="1920177">.</span><span class="ident" id="1920178">g0</span>&nbsp;<span class="op" id="1920181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920185">gothrow</span><span class="op" id="1920192">(</span><span class="string" id="1920193">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1920214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1920217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920220">for</span>&nbsp;<span class="ident" id="1920224">atomicload</span><span class="op" id="1920234">(</span><span class="ident" id="1920235">key32</span><span class="op" id="1920240">(</span><span class="op" id="1920241">&amp;</span><span class="ident" id="1920242">n</span><span class="op" id="1920243">.</span><span class="ident" id="1920244">key</span><span class="op" id="1920247">)</span><span class="op" id="1920248">)</span>&nbsp;<span class="op" id="1920250">==</span>&nbsp;<span class="num" id="1920253">0</span>&nbsp;<span class="op" id="1920255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920259">gp</span><span class="op" id="1920261">.</span><span class="ident" id="1920262">m</span><span class="op" id="1920263">.</span><span class="ident" id="1920264">blocked</span>&nbsp;<span class="op" id="1920272">=</span>&nbsp;<span class="builtintype" id="1920274">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920281">futexsleep</span><span class="op" id="1920291">(</span><span class="ident" id="1920292">key32</span><span class="op" id="1920297">(</span><span class="op" id="1920298">&amp;</span><span class="ident" id="1920299">n</span><span class="op" id="1920300">.</span><span class="ident" id="1920301">key</span><span class="op" id="1920304">)</span><span class="op" id="1920305">,</span>&nbsp;<span class="num" id="1920307">0</span><span class="op" id="1920308">,</span>&nbsp;<span class="op" id="1920310">-</span><span class="num" id="1920311">1</span><span class="op" id="1920312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920316">gp</span><span class="op" id="1920318">.</span><span class="ident" id="1920319">m</span><span class="op" id="1920320">.</span><span class="ident" id="1920321">blocked</span>&nbsp;<span class="op" id="1920329">=</span>&nbsp;<span class="builtintype" id="1920331">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1920338">}</span><br>
<span class="lineno"></span><span class="op" id="1920340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1920343">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1920356">func</span>&nbsp;<span class="ident" id="1920361">notetsleep_internal</span><span class="op" id="1920380">(</span><span class="ident" id="1920381">n</span>&nbsp;<span class="op" id="1920383">*</span><span class="ident" id="1920384">note</span><span class="op" id="1920388">,</span>&nbsp;<span class="ident" id="1920390">ns</span>&nbsp;<span class="ident" id="1920393">int64</span><span class="op" id="1920398">)</span>&nbsp;<span class="builtintype" id="1920400">bool</span>&nbsp;<span class="op" id="1920405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920408">gp</span>&nbsp;<span class="op" id="1920411">:=</span>&nbsp;<span class="ident" id="1920414">getg</span><span class="op" id="1920418">(</span><span class="op" id="1920419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920423">if</span>&nbsp;<span class="ident" id="1920426">ns</span>&nbsp;<span class="op" id="1920429">&lt;</span>&nbsp;<span class="num" id="1920431">0</span>&nbsp;<span class="op" id="1920433">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920437">for</span>&nbsp;<span class="ident" id="1920441">atomicload</span><span class="op" id="1920451">(</span><span class="ident" id="1920452">key32</span><span class="op" id="1920457">(</span><span class="op" id="1920458">&amp;</span><span class="ident" id="1920459">n</span><span class="op" id="1920460">.</span><span class="ident" id="1920461">key</span><span class="op" id="1920464">)</span><span class="op" id="1920465">)</span>&nbsp;<span class="op" id="1920467">==</span>&nbsp;<span class="num" id="1920470">0</span>&nbsp;<span class="op" id="1920472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920477">gp</span><span class="op" id="1920479">.</span><span class="ident" id="1920480">m</span><span class="op" id="1920481">.</span><span class="ident" id="1920482">blocked</span>&nbsp;<span class="op" id="1920490">=</span>&nbsp;<span class="builtintype" id="1920492">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920500">futexsleep</span><span class="op" id="1920510">(</span><span class="ident" id="1920511">key32</span><span class="op" id="1920516">(</span><span class="op" id="1920517">&amp;</span><span class="ident" id="1920518">n</span><span class="op" id="1920519">.</span><span class="ident" id="1920520">key</span><span class="op" id="1920523">)</span><span class="op" id="1920524">,</span>&nbsp;<span class="num" id="1920526">0</span><span class="op" id="1920527">,</span>&nbsp;<span class="op" id="1920529">-</span><span class="num" id="1920530">1</span><span class="op" id="1920531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920536">gp</span><span class="op" id="1920538">.</span><span class="ident" id="1920539">m</span><span class="op" id="1920540">.</span><span class="ident" id="1920541">blocked</span>&nbsp;<span class="op" id="1920549">=</span>&nbsp;<span class="builtintype" id="1920551">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1920559">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920563">return</span>&nbsp;<span class="builtintype" id="1920570">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1920576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920580">if</span>&nbsp;<span class="ident" id="1920583">atomicload</span><span class="op" id="1920593">(</span><span class="ident" id="1920594">key32</span><span class="op" id="1920599">(</span><span class="op" id="1920600">&amp;</span><span class="ident" id="1920601">n</span><span class="op" id="1920602">.</span><span class="ident" id="1920603">key</span><span class="op" id="1920606">)</span><span class="op" id="1920607">)</span>&nbsp;<span class="op" id="1920609">!=</span>&nbsp;<span class="num" id="1920612">0</span>&nbsp;<span class="op" id="1920614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920618">return</span>&nbsp;<span class="builtintype" id="1920625">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1920631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920635">deadline</span>&nbsp;<span class="op" id="1920644">:=</span>&nbsp;<span class="ident" id="1920647">nanotime</span><span class="op" id="1920655">(</span><span class="op" id="1920656">)</span>&nbsp;<span class="op" id="1920658">+</span>&nbsp;<span class="ident" id="1920660">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920664">for</span>&nbsp;<span class="op" id="1920668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920672">gp</span><span class="op" id="1920674">.</span><span class="ident" id="1920675">m</span><span class="op" id="1920676">.</span><span class="ident" id="1920677">blocked</span>&nbsp;<span class="op" id="1920685">=</span>&nbsp;<span class="builtintype" id="1920687">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920694">futexsleep</span><span class="op" id="1920704">(</span><span class="ident" id="1920705">key32</span><span class="op" id="1920710">(</span><span class="op" id="1920711">&amp;</span><span class="ident" id="1920712">n</span><span class="op" id="1920713">.</span><span class="ident" id="1920714">key</span><span class="op" id="1920717">)</span><span class="op" id="1920718">,</span>&nbsp;<span class="num" id="1920720">0</span><span class="op" id="1920721">,</span>&nbsp;<span class="ident" id="1920723">ns</span><span class="op" id="1920725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920729">gp</span><span class="op" id="1920731">.</span><span class="ident" id="1920732">m</span><span class="op" id="1920733">.</span><span class="ident" id="1920734">blocked</span>&nbsp;<span class="op" id="1920742">=</span>&nbsp;<span class="builtintype" id="1920744">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920752">if</span>&nbsp;<span class="ident" id="1920755">atomicload</span><span class="op" id="1920765">(</span><span class="ident" id="1920766">key32</span><span class="op" id="1920771">(</span><span class="op" id="1920772">&amp;</span><span class="ident" id="1920773">n</span><span class="op" id="1920774">.</span><span class="ident" id="1920775">key</span><span class="op" id="1920778">)</span><span class="op" id="1920779">)</span>&nbsp;<span class="op" id="1920781">!=</span>&nbsp;<span class="num" id="1920784">0</span>&nbsp;<span class="op" id="1920786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920791">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1920799">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920803">now</span>&nbsp;<span class="op" id="1920807">:=</span>&nbsp;<span class="ident" id="1920810">nanotime</span><span class="op" id="1920818">(</span><span class="op" id="1920819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920823">if</span>&nbsp;<span class="ident" id="1920826">now</span>&nbsp;<span class="op" id="1920830">&gt;=</span>&nbsp;<span class="ident" id="1920833">deadline</span>&nbsp;<span class="op" id="1920842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920847">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1920855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920859">ns</span>&nbsp;<span class="op" id="1920862">=</span>&nbsp;<span class="ident" id="1920864">deadline</span>&nbsp;<span class="op" id="1920873">-</span>&nbsp;<span class="ident" id="1920875">now</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1920880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920883">return</span>&nbsp;<span class="ident" id="1920890">atomicload</span><span class="op" id="1920900">(</span><span class="ident" id="1920901">key32</span><span class="op" id="1920906">(</span><span class="op" id="1920907">&amp;</span><span class="ident" id="1920908">n</span><span class="op" id="1920909">.</span><span class="ident" id="1920910">key</span><span class="op" id="1920913">)</span><span class="op" id="1920914">)</span>&nbsp;<span class="op" id="1920916">!=</span>&nbsp;<span class="num" id="1920919">0</span><br>
<span class="lineno"></span><span class="op" id="1920921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1920924">func</span>&nbsp;<span class="ident" id="1920929">notetsleep</span><span class="op" id="1920939">(</span><span class="ident" id="1920940">n</span>&nbsp;<span class="op" id="1920942">*</span><span class="ident" id="1920943">note</span><span class="op" id="1920947">,</span>&nbsp;<span class="ident" id="1920949">ns</span>&nbsp;<span class="ident" id="1920952">int64</span><span class="op" id="1920957">)</span>&nbsp;<span class="builtintype" id="1920959">bool</span>&nbsp;<span class="op" id="1920964">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1920967">gp</span>&nbsp;<span class="op" id="1920970">:=</span>&nbsp;<span class="ident" id="1920973">getg</span><span class="op" id="1920977">(</span><span class="op" id="1920978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1920981">if</span>&nbsp;<span class="ident" id="1920984">gp</span>&nbsp;<span class="op" id="1920987">!=</span>&nbsp;<span class="ident" id="1920990">gp</span><span class="op" id="1920992">.</span><span class="ident" id="1920993">m</span><span class="op" id="1920994">.</span><span class="ident" id="1920995">g0</span>&nbsp;<span class="op" id="1920998">&amp;&amp;</span>&nbsp;<span class="ident" id="1921001">gp</span><span class="op" id="1921003">.</span><span class="ident" id="1921004">m</span><span class="op" id="1921005">.</span><span class="ident" id="1921006">gcing</span>&nbsp;<span class="op" id="1921012">==</span>&nbsp;<span class="num" id="1921015">0</span>&nbsp;<span class="op" id="1921017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921021">gothrow</span><span class="op" id="1921028">(</span><span class="string" id="1921029">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1921051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1921054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1921058">return</span>&nbsp;<span class="ident" id="1921065">notetsleep_internal</span><span class="op" id="1921084">(</span><span class="ident" id="1921085">n</span><span class="op" id="1921086">,</span>&nbsp;<span class="ident" id="1921088">ns</span><span class="op" id="1921090">)</span><br>
<span class="lineno"></span><span class="op" id="1921092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1921095">//&nbsp;same&nbsp;as&nbsp;runtime·notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1921157">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1921227">func</span>&nbsp;<span class="ident" id="1921232">notetsleepg</span><span class="op" id="1921243">(</span><span class="ident" id="1921244">n</span>&nbsp;<span class="op" id="1921246">*</span><span class="ident" id="1921247">note</span><span class="op" id="1921251">,</span>&nbsp;<span class="ident" id="1921253">ns</span>&nbsp;<span class="ident" id="1921256">int64</span><span class="op" id="1921261">)</span>&nbsp;<span class="builtintype" id="1921263">bool</span>&nbsp;<span class="op" id="1921268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921271">gp</span>&nbsp;<span class="op" id="1921274">:=</span>&nbsp;<span class="ident" id="1921277">getg</span><span class="op" id="1921281">(</span><span class="op" id="1921282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1921285">if</span>&nbsp;<span class="ident" id="1921288">gp</span>&nbsp;<span class="op" id="1921291">==</span>&nbsp;<span class="ident" id="1921294">gp</span><span class="op" id="1921296">.</span><span class="ident" id="1921297">m</span><span class="op" id="1921298">.</span><span class="ident" id="1921299">g0</span>&nbsp;<span class="op" id="1921302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921306">gothrow</span><span class="op" id="1921313">(</span><span class="string" id="1921314">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1921333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1921336">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921340">entersyscallblock</span><span class="op" id="1921357">(</span><span class="op" id="1921358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921361">ok</span>&nbsp;<span class="op" id="1921364">:=</span>&nbsp;<span class="ident" id="1921367">notetsleep_internal</span><span class="op" id="1921386">(</span><span class="ident" id="1921387">n</span><span class="op" id="1921388">,</span>&nbsp;<span class="ident" id="1921390">ns</span><span class="op" id="1921392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1921395">exitsyscall</span><span class="op" id="1921406">(</span><span class="op" id="1921407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1921410">return</span>&nbsp;<span class="ident" id="1921417">ok</span><br>
<span class="lineno">205</span><span class="op" id="1921420">}</span>
</div>
</body>
</html>
