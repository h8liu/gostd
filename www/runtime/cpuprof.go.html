<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1738199">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1738255">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1738309">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1738360">//&nbsp;CPU&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1738378">//&nbsp;Based&nbsp;on&nbsp;algorithms&nbsp;and&nbsp;data&nbsp;structures&nbsp;used&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1738429">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="comment" id="1738476">//</span><br>
<span class="lineno"></span><span class="comment" id="1738479">//&nbsp;The&nbsp;main&nbsp;difference&nbsp;between&nbsp;this&nbsp;code&nbsp;and&nbsp;the&nbsp;google-perftools</span><br>
<span class="lineno">10</span><span class="comment" id="1738545">//&nbsp;code&nbsp;is&nbsp;that&nbsp;this&nbsp;code&nbsp;is&nbsp;written&nbsp;to&nbsp;allow&nbsp;copying&nbsp;the&nbsp;profile&nbsp;data</span><br>
<span class="lineno"></span><span class="comment" id="1738616">//&nbsp;to&nbsp;an&nbsp;arbitrary&nbsp;io.Writer,&nbsp;while&nbsp;the&nbsp;google-perftools&nbsp;code&nbsp;always</span><br>
<span class="lineno"></span><span class="comment" id="1738685">//&nbsp;writes&nbsp;to&nbsp;an&nbsp;operating&nbsp;system&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="1738724">//</span><br>
<span class="lineno"></span><span class="comment" id="1738727">//&nbsp;The&nbsp;signal&nbsp;handler&nbsp;for&nbsp;the&nbsp;profiling&nbsp;clock&nbsp;tick&nbsp;adds&nbsp;a&nbsp;new&nbsp;stack&nbsp;trace</span><br>
<span class="lineno">15</span><span class="comment" id="1738801">//&nbsp;to&nbsp;a&nbsp;hash&nbsp;table&nbsp;tracking&nbsp;counts&nbsp;for&nbsp;recent&nbsp;traces.&nbsp;&nbsp;Most&nbsp;clock&nbsp;ticks</span><br>
<span class="lineno"></span><span class="comment" id="1738873">//&nbsp;hit&nbsp;in&nbsp;the&nbsp;cache.&nbsp;&nbsp;In&nbsp;the&nbsp;event&nbsp;of&nbsp;a&nbsp;cache&nbsp;miss,&nbsp;an&nbsp;entry&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1738942">//&nbsp;evicted&nbsp;from&nbsp;the&nbsp;hash&nbsp;table,&nbsp;copied&nbsp;to&nbsp;a&nbsp;log&nbsp;that&nbsp;will&nbsp;eventually&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1739014">//&nbsp;written&nbsp;as&nbsp;profile&nbsp;data.&nbsp;&nbsp;The&nbsp;google-perftools&nbsp;code&nbsp;flushed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1739081">//&nbsp;log&nbsp;itself&nbsp;during&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;This&nbsp;code&nbsp;cannot&nbsp;do&nbsp;that,&nbsp;because</span><br>
<span class="lineno">20</span><span class="comment" id="1739157">//&nbsp;the&nbsp;io.Writer&nbsp;might&nbsp;block&nbsp;or&nbsp;need&nbsp;system&nbsp;calls&nbsp;or&nbsp;locks&nbsp;that&nbsp;are&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1739229">//&nbsp;safe&nbsp;to&nbsp;use&nbsp;from&nbsp;within&nbsp;the&nbsp;signal&nbsp;handler.&nbsp;&nbsp;Instead,&nbsp;we&nbsp;split&nbsp;the&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1739303">//&nbsp;into&nbsp;two&nbsp;halves&nbsp;and&nbsp;let&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fill&nbsp;one&nbsp;half&nbsp;while&nbsp;a&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1739381">//&nbsp;is&nbsp;writing&nbsp;out&nbsp;the&nbsp;other&nbsp;half.&nbsp;&nbsp;When&nbsp;the&nbsp;signal&nbsp;handler&nbsp;fills&nbsp;its&nbsp;half,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="1739459">//&nbsp;offers&nbsp;to&nbsp;swap&nbsp;with&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;If&nbsp;the&nbsp;writer&nbsp;is&nbsp;not&nbsp;done&nbsp;with&nbsp;its&nbsp;half,</span><br>
<span class="lineno">25</span><span class="comment" id="1739539">//&nbsp;we&nbsp;lose&nbsp;the&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;clock&nbsp;tick&nbsp;(and&nbsp;record&nbsp;that&nbsp;loss).</span><br>
<span class="lineno"></span><span class="comment" id="1739610">//&nbsp;The&nbsp;goroutine&nbsp;interacts&nbsp;with&nbsp;the&nbsp;signal&nbsp;handler&nbsp;by&nbsp;calling&nbsp;getprofile()&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1739688">//&nbsp;get&nbsp;the&nbsp;next&nbsp;log&nbsp;piece&nbsp;to&nbsp;write,&nbsp;implicitly&nbsp;handing&nbsp;back&nbsp;the&nbsp;last&nbsp;log</span><br>
<span class="lineno"></span><span class="comment" id="1739761">//&nbsp;piece&nbsp;it&nbsp;obtained.</span><br>
<span class="lineno"></span><span class="comment" id="1739783">//</span><br>
<span class="lineno">30</span><span class="comment" id="1739786">//&nbsp;The&nbsp;state&nbsp;of&nbsp;this&nbsp;dance&nbsp;between&nbsp;the&nbsp;signal&nbsp;handler&nbsp;and&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1739858">//&nbsp;is&nbsp;encoded&nbsp;in&nbsp;the&nbsp;Profile.handoff&nbsp;field.&nbsp;&nbsp;If&nbsp;handoff&nbsp;==&nbsp;0,&nbsp;then&nbsp;the&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1739939">//&nbsp;is&nbsp;not&nbsp;using&nbsp;either&nbsp;log&nbsp;half&nbsp;and&nbsp;is&nbsp;waiting&nbsp;(or&nbsp;will&nbsp;soon&nbsp;be&nbsp;waiting)&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="1740016">//&nbsp;a&nbsp;new&nbsp;piece&nbsp;by&nbsp;calling&nbsp;notesleep(&amp;p-&gt;wait).&nbsp;&nbsp;If&nbsp;the&nbsp;signal&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="1740086">//&nbsp;changes&nbsp;handoff&nbsp;from&nbsp;0&nbsp;to&nbsp;non-zero,&nbsp;it&nbsp;must&nbsp;call&nbsp;notewakeup(&amp;p-&gt;wait)</span><br>
<span class="lineno">35</span><span class="comment" id="1740159">//&nbsp;to&nbsp;wake&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;The&nbsp;value&nbsp;indicates&nbsp;the&nbsp;number&nbsp;of&nbsp;entries&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1740235">//&nbsp;log&nbsp;half&nbsp;being&nbsp;handed&nbsp;off.&nbsp;&nbsp;The&nbsp;goroutine&nbsp;leaves&nbsp;the&nbsp;non-zero&nbsp;value&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1740309">//&nbsp;place&nbsp;until&nbsp;it&nbsp;has&nbsp;finished&nbsp;processing&nbsp;the&nbsp;log&nbsp;half&nbsp;and&nbsp;then&nbsp;flips&nbsp;the&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="1740390">//&nbsp;back&nbsp;to&nbsp;zero.&nbsp;&nbsp;Setting&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;handoff&nbsp;means&nbsp;that&nbsp;the&nbsp;profiling&nbsp;is&nbsp;over,</span><br>
<span class="lineno"></span><span class="comment" id="1740474">//&nbsp;and&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;now&nbsp;in&nbsp;charge&nbsp;of&nbsp;flushing&nbsp;the&nbsp;data&nbsp;left&nbsp;in&nbsp;the&nbsp;hash&nbsp;table</span><br>
<span class="lineno">40</span><span class="comment" id="1740556">//&nbsp;to&nbsp;the&nbsp;log&nbsp;and&nbsp;returning&nbsp;that&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1740595">//</span><br>
<span class="lineno"></span><span class="comment" id="1740598">//&nbsp;The&nbsp;handoff&nbsp;field&nbsp;is&nbsp;manipulated&nbsp;using&nbsp;atomic&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="1740659">//&nbsp;For&nbsp;the&nbsp;most&nbsp;part,&nbsp;the&nbsp;manipulation&nbsp;of&nbsp;handoff&nbsp;is&nbsp;orderly:&nbsp;if&nbsp;handoff&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="1740737">//&nbsp;then&nbsp;the&nbsp;signal&nbsp;handler&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;non-zero.</span><br>
<span class="lineno">45</span><span class="comment" id="1740803">//&nbsp;If&nbsp;handoff&nbsp;!=&nbsp;0&nbsp;then&nbsp;the&nbsp;goroutine&nbsp;owns&nbsp;it&nbsp;and&nbsp;can&nbsp;change&nbsp;it&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="comment" id="1740876">//&nbsp;If&nbsp;that&nbsp;were&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;story&nbsp;then&nbsp;we&nbsp;would&nbsp;not&nbsp;need&nbsp;to&nbsp;manipulate</span><br>
<span class="lineno"></span><span class="comment" id="1740950">//&nbsp;handoff&nbsp;using&nbsp;atomic&nbsp;operations.&nbsp;&nbsp;The&nbsp;operations&nbsp;are&nbsp;needed,&nbsp;however,</span><br>
<span class="lineno"></span><span class="comment" id="1741023">//&nbsp;in&nbsp;order&nbsp;to&nbsp;let&nbsp;the&nbsp;log&nbsp;closer&nbsp;set&nbsp;the&nbsp;high&nbsp;bit&nbsp;to&nbsp;indicate&nbsp;&#34;EOF&#34;&nbsp;safely</span><br>
<span class="lineno"></span><span class="comment" id="1741099">//&nbsp;in&nbsp;the&nbsp;situation&nbsp;when&nbsp;normally&nbsp;the&nbsp;goroutine&nbsp;&#34;owns&#34;&nbsp;handoff.</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="1741164">package</span>&nbsp;<span class="ident" id="1741172">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1741181">import</span>&nbsp;<span class="string" id="1741188">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="1741198">const</span>&nbsp;<span class="op" id="1741204">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741207">numBuckets</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1741223">=</span>&nbsp;<span class="num" id="1741225">1</span>&nbsp;<span class="op" id="1741227">&lt;&lt;</span>&nbsp;<span class="num" id="1741230">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741234">logSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1741250">=</span>&nbsp;<span class="num" id="1741252">1</span>&nbsp;<span class="op" id="1741254">&lt;&lt;</span>&nbsp;<span class="num" id="1741257">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741261">assoc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1741277">=</span>&nbsp;<span class="num" id="1741279">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741282">maxCPUProfStack</span>&nbsp;<span class="op" id="1741298">=</span>&nbsp;<span class="num" id="1741300">64</span><br>
<span class="lineno">60</span><span class="op" id="1741303">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1741306">type</span>&nbsp;<span class="ident" id="1741311">cpuprofEntry</span>&nbsp;<span class="keyword" id="1741324">struct</span>&nbsp;<span class="op" id="1741331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741334">count</span>&nbsp;<span class="builtintype" id="1741340">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741349">depth</span>&nbsp;<span class="builtintype" id="1741355">uintptr</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741364">stack</span>&nbsp;<span class="op" id="1741370">[</span><span class="ident" id="1741371"><a href="/runtime/cpuprof.go.html#1741282">maxCPUProfStack</a></span><span class="op" id="1741386">]</span><span class="builtintype" id="1741387">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1741395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1741398">type</span>&nbsp;<span class="ident" id="1741403">cpuProfile</span>&nbsp;<span class="keyword" id="1741414">struct</span>&nbsp;<span class="op" id="1741421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741424">on</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1741431">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1741439">//&nbsp;profiling&nbsp;is&nbsp;on</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741459">wait</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1741466"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016211">note</a></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1741474">//&nbsp;goroutine&nbsp;waits&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741499">count</span>&nbsp;&nbsp;<span class="builtintype" id="1741506">uintptr</span>&nbsp;<span class="comment" id="1741514">//&nbsp;tick&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741529">evicts</span>&nbsp;<span class="builtintype" id="1741536">uintptr</span>&nbsp;<span class="comment" id="1741544">//&nbsp;eviction&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741563">lost</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1741570">uintptr</span>&nbsp;<span class="comment" id="1741578">//&nbsp;lost&nbsp;ticks&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;logged</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1741617">//&nbsp;Active&nbsp;recent&nbsp;stack&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741649">hash</span>&nbsp;<span class="op" id="1741654">[</span><span class="ident" id="1741655"><a href="/runtime/cpuprof.go.html#1741207">numBuckets</a></span><span class="op" id="1741665">]</span><span class="keyword" id="1741666">struct</span>&nbsp;<span class="op" id="1741673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741677">entry</span>&nbsp;<span class="op" id="1741683">[</span><span class="ident" id="1741684"><a href="/runtime/cpuprof.go.html#1741261">assoc</a></span><span class="op" id="1741689">]</span><span class="ident" id="1741690"><a href="/runtime/cpuprof.go.html#1741311">cpuprofEntry</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1741704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1741708">//&nbsp;Log&nbsp;of&nbsp;traces&nbsp;evicted&nbsp;from&nbsp;hash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1741745">//&nbsp;Signal&nbsp;handler&nbsp;has&nbsp;filled&nbsp;log[toggle][:nlog].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1741795">//&nbsp;Goroutine&nbsp;is&nbsp;writing&nbsp;log[1-toggle][:handoff].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741845">log</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1741853">[</span><span class="num" id="1741854">2</span><span class="op" id="1741855">]</span><span class="op" id="1741856">[</span><span class="ident" id="1741857"><a href="/runtime/cpuprof.go.html#1741234">logSize</a></span>&nbsp;<span class="op" id="1741865">/</span>&nbsp;<span class="num" id="1741867">2</span><span class="op" id="1741868">]</span><span class="builtintype" id="1741869">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741878">nlog</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1741886">uintptr</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741895">toggle</span>&nbsp;&nbsp;<span class="builtintype" id="1741903">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1741910">handoff</span>&nbsp;<span class="builtintype" id="1741918">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1741927">//&nbsp;Writer&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1741945">//&nbsp;Writer&nbsp;maintains&nbsp;its&nbsp;own&nbsp;toggle&nbsp;to&nbsp;avoid&nbsp;races</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1741996">//&nbsp;looking&nbsp;at&nbsp;signal&nbsp;handler&#39;s&nbsp;toggle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1742036">wtoggle</span>&nbsp;&nbsp;<span class="builtintype" id="1742045">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1742053">wholding</span>&nbsp;<span class="builtintype" id="1742062">bool</span>&nbsp;<span class="comment" id="1742067">//&nbsp;holding&nbsp;&amp;&nbsp;need&nbsp;to&nbsp;release&nbsp;a&nbsp;log&nbsp;half</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1742108">flushing</span>&nbsp;<span class="builtintype" id="1742117">bool</span>&nbsp;<span class="comment" id="1742122">//&nbsp;flushing&nbsp;hash&nbsp;table&nbsp;-&nbsp;profile&nbsp;is&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1742164">eodSent</span>&nbsp;&nbsp;<span class="builtintype" id="1742173">bool</span>&nbsp;<span class="comment" id="1742178">//&nbsp;special&nbsp;end-of-data&nbsp;record&nbsp;sent;&nbsp;=&gt;&nbsp;flushing</span><br>
<span class="lineno">95</span><span class="op" id="1742226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1742229">var</span>&nbsp;<span class="op" id="1742233">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1742236">cpuprofLock</span>&nbsp;<span class="ident" id="1742248"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016175">mutex</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1742255">cpuprof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1742267">*</span><span class="ident" id="1742268"><a href="/runtime/cpuprof.go.html#1741403">cpuProfile</a></span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1742281">eod</span>&nbsp;<span class="op" id="1742285">=</span>&nbsp;<span class="op" id="1742287">[</span><span class="num" id="1742288">3</span><span class="op" id="1742289">]</span><span class="builtintype" id="1742290">uintptr</span><span class="op" id="1742297">{</span><span class="num" id="1742298">0</span><span class="op" id="1742299">,</span>&nbsp;<span class="num" id="1742301">1</span><span class="op" id="1742302">,</span>&nbsp;<span class="num" id="1742304">0</span><span class="op" id="1742305">}</span><br>
<span class="lineno"></span><span class="op" id="1742307">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1742310">func</span>&nbsp;<span class="ident" id="1742315">setcpuprofilerate_m</span><span class="op" id="1742334">(</span><span class="op" id="1742335">)</span>&nbsp;<span class="comment" id="1742337">//&nbsp;proc.c</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="1742348">func</span>&nbsp;<span class="ident" id="1742353">setcpuprofilerate</span><span class="op" id="1742370">(</span><span class="ident" id="1742371">hz</span>&nbsp;<span class="builtintype" id="1742374">int32</span><span class="op" id="1742379">)</span>&nbsp;<span class="op" id="1742381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1742384">g</span>&nbsp;<span class="op" id="1742386">:=</span>&nbsp;<span class="ident" id="1742389"><a href="/runtime/stubs.go.html#1968886">getg</a></span><span class="op" id="1742393">(</span><span class="op" id="1742394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1742397"><a href="/runtime/cpuprof.go.html#1742384">g</a></span><span class="op" id="1742398">.</span><span class="ident" id="1742399">m</span><span class="op" id="1742400">.</span><span class="ident" id="1742401">scalararg</span><span class="op" id="1742410">[</span><span class="num" id="1742411">0</span><span class="op" id="1742412">]</span>&nbsp;<span class="op" id="1742414">=</span>&nbsp;<span class="builtintype" id="1742416">uintptr</span><span class="op" id="1742423">(</span><span class="ident" id="1742424"><a href="/runtime/cpuprof.go.html#1742371">hz</a></span><span class="op" id="1742426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1742429"><a href="/runtime/stubs.go.html#1971002">onM</a></span><span class="op" id="1742432">(</span><span class="ident" id="1742433"><a href="/runtime/cpuprof.go.html#1742315">setcpuprofilerate_m</a></span><span class="op" id="1742452">)</span><br>
<span class="lineno">110</span><span class="op" id="1742454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1742457">//&nbsp;lostProfileData&nbsp;is&nbsp;a&nbsp;no-op&nbsp;function&nbsp;used&nbsp;in&nbsp;profiles</span><br>
<span class="lineno"></span><span class="comment" id="1742513">//&nbsp;to&nbsp;mark&nbsp;the&nbsp;number&nbsp;of&nbsp;profiling&nbsp;stack&nbsp;traces&nbsp;that&nbsp;were</span><br>
<span class="lineno"></span><span class="comment" id="1742571">//&nbsp;discarded&nbsp;due&nbsp;to&nbsp;slow&nbsp;data&nbsp;writers.</span><br>
<span class="lineno">115</span><span class="keyword" id="1742610">func</span>&nbsp;<span class="ident" id="1742615">lostProfileData</span><span class="op" id="1742630">(</span><span class="op" id="1742631">)</span>&nbsp;<span class="op" id="1742633">{</span><span class="op" id="1742634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1742637">//&nbsp;SetCPUProfileRate&nbsp;sets&nbsp;the&nbsp;CPU&nbsp;profiling&nbsp;rate&nbsp;to&nbsp;hz&nbsp;samples&nbsp;per&nbsp;second.</span><br>
<span class="lineno"></span><span class="comment" id="1742712">//&nbsp;If&nbsp;hz&nbsp;&lt;=&nbsp;0,&nbsp;SetCPUProfileRate&nbsp;turns&nbsp;off&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1742766">//&nbsp;If&nbsp;the&nbsp;profiler&nbsp;is&nbsp;on,&nbsp;the&nbsp;rate&nbsp;cannot&nbsp;be&nbsp;changed&nbsp;without&nbsp;first&nbsp;turning&nbsp;it&nbsp;off.</span><br>
<span class="lineno">120</span><span class="comment" id="1742849">//</span><br>
<span class="lineno"></span><span class="comment" id="1742852">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1742908">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1742974">//&nbsp;SetCPUProfileRate&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1743005">func</span>&nbsp;<span class="ident" id="1743010">SetCPUProfileRate</span><span class="op" id="1743027">(</span><span class="ident" id="1743028">hz</span>&nbsp;<span class="builtintype" id="1743031">int</span><span class="op" id="1743034">)</span>&nbsp;<span class="op" id="1743036">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1743039">//&nbsp;Clamp&nbsp;hz&nbsp;to&nbsp;something&nbsp;reasonable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1743077">if</span>&nbsp;<span class="ident" id="1743080"><a href="/runtime/cpuprof.go.html#1743028">hz</a></span>&nbsp;<span class="op" id="1743083">&lt;</span>&nbsp;<span class="num" id="1743085">0</span>&nbsp;<span class="op" id="1743087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743091"><a href="/runtime/cpuprof.go.html#1743028">hz</a></span>&nbsp;<span class="op" id="1743094">=</span>&nbsp;<span class="num" id="1743096">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1743099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1743102">if</span>&nbsp;<span class="ident" id="1743105"><a href="/runtime/cpuprof.go.html#1743028">hz</a></span>&nbsp;<span class="op" id="1743108">&gt;</span>&nbsp;<span class="num" id="1743110">1000000</span>&nbsp;<span class="op" id="1743118">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743122"><a href="/runtime/cpuprof.go.html#1743028">hz</a></span>&nbsp;<span class="op" id="1743125">=</span>&nbsp;<span class="num" id="1743127">1000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1743136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743140"><a href="/runtime/lock_futex.go.html#1815304">lock</a></span><span class="op" id="1743144">(</span><span class="op" id="1743145">&amp;</span><span class="ident" id="1743146"><a href="/runtime/cpuprof.go.html#1742236">cpuprofLock</a></span><span class="op" id="1743157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1743160">if</span>&nbsp;<span class="ident" id="1743163"><a href="/runtime/cpuprof.go.html#1743028">hz</a></span>&nbsp;<span class="op" id="1743166">&gt;</span>&nbsp;<span class="num" id="1743168">0</span>&nbsp;<span class="op" id="1743170">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1743174">if</span>&nbsp;<span class="ident" id="1743177"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span>&nbsp;<span class="op" id="1743185">==</span>&nbsp;<span class="ident" id="1743188">nil</span>&nbsp;<span class="op" id="1743192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743197"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span>&nbsp;<span class="op" id="1743205">=</span>&nbsp;<span class="op" id="1743207">(</span><span class="op" id="1743208">*</span><span class="ident" id="1743209"><a href="/runtime/cpuprof.go.html#1741403">cpuProfile</a></span><span class="op" id="1743219">)</span><span class="op" id="1743220">(</span><span class="ident" id="1743221"><a href="/runtime/mprof.go.html#1854275">sysAlloc</a></span><span class="op" id="1743229">(</span><span class="ident" id="1743230"><a href="/runtime/cpuprof.go.html#1741188">unsafe</a></span><span class="op" id="1743236">.</span><span class="ident" id="1743237">Sizeof</span><span class="op" id="1743243">(</span><span class="ident" id="1743244"><a href="/runtime/cpuprof.go.html#1741403">cpuProfile</a></span><span class="op" id="1743254">{</span><span class="op" id="1743255">}</span><span class="op" id="1743256">)</span><span class="op" id="1743257">,</span>&nbsp;<span class="op" id="1743259">&amp;</span><span class="ident" id="1743260"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2023037">memstats</a></span><span class="op" id="1743268">.</span><span class="ident" id="1743269">other_sys</span><span class="op" id="1743278">)</span><span class="op" id="1743279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1743284">if</span>&nbsp;<span class="ident" id="1743287"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span>&nbsp;<span class="op" id="1743295">==</span>&nbsp;<span class="ident" id="1743298">nil</span>&nbsp;<span class="op" id="1743302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1743308">print</span><span class="op" id="1743313">(</span><span class="string" id="1743314">&#34;runtime:&nbsp;cpu&nbsp;profiling&nbsp;cannot&nbsp;allocate&nbsp;memory\n&#34;</span><span class="op" id="1743363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743369"><a href="/runtime/lock_futex.go.html#1816596">unlock</a></span><span class="op" id="1743375">(</span><span class="op" id="1743376">&amp;</span><span class="ident" id="1743377"><a href="/runtime/cpuprof.go.html#1742236">cpuprofLock</a></span><span class="op" id="1743388">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1743394">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1743404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1743408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1743412">if</span>&nbsp;<span class="ident" id="1743415"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1743422">.</span><span class="ident" id="1743423">on</span>&nbsp;<span class="op" id="1743426">||</span>&nbsp;<span class="ident" id="1743429"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1743436">.</span><span class="ident" id="1743437">handoff</span>&nbsp;<span class="op" id="1743445">!=</span>&nbsp;<span class="num" id="1743448">0</span>&nbsp;<span class="op" id="1743450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1743455">print</span><span class="op" id="1743460">(</span><span class="string" id="1743461">&#34;runtime:&nbsp;cannot&nbsp;set&nbsp;cpu&nbsp;profile&nbsp;rate&nbsp;until&nbsp;previous&nbsp;profile&nbsp;has&nbsp;finished.\n&#34;</span><span class="op" id="1743538">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743543"><a href="/runtime/lock_futex.go.html#1816596">unlock</a></span><span class="op" id="1743549">(</span><span class="op" id="1743550">&amp;</span><span class="ident" id="1743551"><a href="/runtime/cpuprof.go.html#1742236">cpuprofLock</a></span><span class="op" id="1743562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1743567">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1743576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743581"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1743588">.</span><span class="ident" id="1743589">on</span>&nbsp;<span class="op" id="1743592">=</span>&nbsp;<span class="ident" id="1743594">true</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1743601">//&nbsp;pprof&nbsp;binary&nbsp;header&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1743634">//&nbsp;http://code.google.com/p/google-perftools/source/browse/trunk/src/profiledata.cc#117</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743724">p</span>&nbsp;<span class="op" id="1743726">:=</span>&nbsp;<span class="op" id="1743729">&amp;</span><span class="ident" id="1743730"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1743737">.</span><span class="ident" id="1743738">log</span><span class="op" id="1743741">[</span><span class="num" id="1743742">0</span><span class="op" id="1743743">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743747"><a href="/runtime/cpuprof.go.html#1743724">p</a></span><span class="op" id="1743748">[</span><span class="num" id="1743749">0</span><span class="op" id="1743750">]</span>&nbsp;<span class="op" id="1743752">=</span>&nbsp;<span class="num" id="1743754">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1743772">//&nbsp;count&nbsp;for&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743794"><a href="/runtime/cpuprof.go.html#1743724">p</a></span><span class="op" id="1743795">[</span><span class="num" id="1743796">1</span><span class="op" id="1743797">]</span>&nbsp;<span class="op" id="1743799">=</span>&nbsp;<span class="num" id="1743801">3</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1743819">//&nbsp;depth&nbsp;for&nbsp;header</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743841"><a href="/runtime/cpuprof.go.html#1743724">p</a></span><span class="op" id="1743842">[</span><span class="num" id="1743843">2</span><span class="op" id="1743844">]</span>&nbsp;<span class="op" id="1743846">=</span>&nbsp;<span class="num" id="1743848">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1743866">//&nbsp;version&nbsp;number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743886"><a href="/runtime/cpuprof.go.html#1743724">p</a></span><span class="op" id="1743887">[</span><span class="num" id="1743888">3</span><span class="op" id="1743889">]</span>&nbsp;<span class="op" id="1743891">=</span>&nbsp;<span class="builtintype" id="1743893">uintptr</span><span class="op" id="1743900">(</span><span class="num" id="1743901">1e6</span>&nbsp;<span class="op" id="1743905">/</span>&nbsp;<span class="ident" id="1743907"><a href="/runtime/cpuprof.go.html#1743028">hz</a></span><span class="op" id="1743909">)</span>&nbsp;<span class="comment" id="1743911">//&nbsp;period&nbsp;(microseconds)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743938"><a href="/runtime/cpuprof.go.html#1743724">p</a></span><span class="op" id="1743939">[</span><span class="num" id="1743940">4</span><span class="op" id="1743941">]</span>&nbsp;<span class="op" id="1743943">=</span>&nbsp;<span class="num" id="1743945">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743949"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1743956">.</span><span class="ident" id="1743957">nlog</span>&nbsp;<span class="op" id="1743962">=</span>&nbsp;<span class="num" id="1743964">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743968"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1743975">.</span><span class="ident" id="1743976">toggle</span>&nbsp;<span class="op" id="1743983">=</span>&nbsp;<span class="num" id="1743985">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1743989"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1743996">.</span><span class="ident" id="1743997">wholding</span>&nbsp;<span class="op" id="1744006">=</span>&nbsp;<span class="ident" id="1744008">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744016"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1744023">.</span><span class="ident" id="1744024">wtoggle</span>&nbsp;<span class="op" id="1744032">=</span>&nbsp;<span class="num" id="1744034">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744038"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1744045">.</span><span class="ident" id="1744046">flushing</span>&nbsp;<span class="op" id="1744055">=</span>&nbsp;<span class="ident" id="1744057">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744065"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1744072">.</span><span class="ident" id="1744073">eodSent</span>&nbsp;<span class="op" id="1744081">=</span>&nbsp;<span class="ident" id="1744083">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744091"><a href="/runtime/lock_futex.go.html#1817055">noteclear</a></span><span class="op" id="1744100">(</span><span class="op" id="1744101">&amp;</span><span class="ident" id="1744102"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1744109">.</span><span class="ident" id="1744110">wait</span><span class="op" id="1744114">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744119"><a href="/runtime/cpuprof.go.html#1742353">setcpuprofilerate</a></span><span class="op" id="1744136">(</span><span class="builtintype" id="1744137">int32</span><span class="op" id="1744142">(</span><span class="ident" id="1744143"><a href="/runtime/cpuprof.go.html#1743028">hz</a></span><span class="op" id="1744145">)</span><span class="op" id="1744146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1744149">}</span>&nbsp;<span class="keyword" id="1744151">else</span>&nbsp;<span class="keyword" id="1744156">if</span>&nbsp;<span class="ident" id="1744159"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span>&nbsp;<span class="op" id="1744167">!=</span>&nbsp;<span class="ident" id="1744170">nil</span>&nbsp;<span class="op" id="1744174">&amp;&amp;</span>&nbsp;<span class="ident" id="1744177"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1744184">.</span><span class="ident" id="1744185">on</span>&nbsp;<span class="op" id="1744188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744192"><a href="/runtime/cpuprof.go.html#1742353">setcpuprofilerate</a></span><span class="op" id="1744209">(</span><span class="num" id="1744210">0</span><span class="op" id="1744211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744215"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1744222">.</span><span class="ident" id="1744223">on</span>&nbsp;<span class="op" id="1744226">=</span>&nbsp;<span class="ident" id="1744228">false</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1744237">//&nbsp;Now&nbsp;add&nbsp;is&nbsp;not&nbsp;running&nbsp;anymore,&nbsp;and&nbsp;getprofile&nbsp;owns&nbsp;the&nbsp;entire&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1744310">//&nbsp;Set&nbsp;the&nbsp;high&nbsp;bit&nbsp;in&nbsp;prof-&gt;handoff&nbsp;to&nbsp;tell&nbsp;getprofile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1744369">for</span>&nbsp;<span class="op" id="1744373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744378">n</span>&nbsp;<span class="op" id="1744380">:=</span>&nbsp;<span class="ident" id="1744383"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1744390">.</span><span class="ident" id="1744391">handoff</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1744402">if</span>&nbsp;<span class="ident" id="1744405"><a href="/runtime/cpuprof.go.html#1744378">n</a></span><span class="op" id="1744406">&amp;</span><span class="num" id="1744407">0x80000000</span>&nbsp;<span class="op" id="1744418">!=</span>&nbsp;<span class="num" id="1744421">0</span>&nbsp;<span class="op" id="1744423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1744429">print</span><span class="op" id="1744434">(</span><span class="string" id="1744435">&#34;runtime:&nbsp;setcpuprofile(off)&nbsp;twice\n&#34;</span><span class="op" id="1744472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1744477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1744482">if</span>&nbsp;<span class="ident" id="1744485"><a href="/runtime/stubs.go.html#1974711">cas</a></span><span class="op" id="1744488">(</span><span class="op" id="1744489">&amp;</span><span class="ident" id="1744490"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1744497">.</span><span class="ident" id="1744498">handoff</span><span class="op" id="1744505">,</span>&nbsp;<span class="ident" id="1744507"><a href="/runtime/cpuprof.go.html#1744378">n</a></span><span class="op" id="1744508">,</span>&nbsp;<span class="ident" id="1744510"><a href="/runtime/cpuprof.go.html#1744378">n</a></span><span class="op" id="1744511">|</span><span class="num" id="1744512">0x80000000</span><span class="op" id="1744522">)</span>&nbsp;<span class="op" id="1744524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1744530">if</span>&nbsp;<span class="ident" id="1744533"><a href="/runtime/cpuprof.go.html#1744378">n</a></span>&nbsp;<span class="op" id="1744535">==</span>&nbsp;<span class="num" id="1744538">0</span>&nbsp;<span class="op" id="1744540">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1744547">//&nbsp;we&nbsp;did&nbsp;the&nbsp;transition&nbsp;from&nbsp;0&nbsp;-&gt;&nbsp;nonzero&nbsp;so&nbsp;we&nbsp;wake&nbsp;getprofile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744617"><a href="/runtime/lock_futex.go.html#1817095">notewakeup</a></span><span class="op" id="1744627">(</span><span class="op" id="1744628">&amp;</span><span class="ident" id="1744629"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1744636">.</span><span class="ident" id="1744637">wait</span><span class="op" id="1744641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1744647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1744653">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1744662">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1744666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1744669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744672"><a href="/runtime/lock_futex.go.html#1816596">unlock</a></span><span class="op" id="1744678">(</span><span class="op" id="1744679">&amp;</span><span class="ident" id="1744680"><a href="/runtime/cpuprof.go.html#1742236">cpuprofLock</a></span><span class="op" id="1744691">)</span><br>
<span class="lineno"></span><span class="op" id="1744693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span><span class="keyword" id="1744696">func</span>&nbsp;<span class="ident" id="1744701">cpuproftick</span><span class="op" id="1744712">(</span><span class="ident" id="1744713">pc</span>&nbsp;<span class="op" id="1744716">*</span><span class="builtintype" id="1744717">uintptr</span><span class="op" id="1744724">,</span>&nbsp;<span class="ident" id="1744726">n</span>&nbsp;<span class="builtintype" id="1744728">int32</span><span class="op" id="1744733">)</span>&nbsp;<span class="op" id="1744735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1744738">if</span>&nbsp;<span class="ident" id="1744741"><a href="/runtime/cpuprof.go.html#1744726">n</a></span>&nbsp;<span class="op" id="1744743">&gt;</span>&nbsp;<span class="ident" id="1744745"><a href="/runtime/cpuprof.go.html#1741282">maxCPUProfStack</a></span>&nbsp;<span class="op" id="1744761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744765"><a href="/runtime/cpuprof.go.html#1744726">n</a></span>&nbsp;<span class="op" id="1744767">=</span>&nbsp;<span class="ident" id="1744769"><a href="/runtime/cpuprof.go.html#1741282">maxCPUProfStack</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1744786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744789">s</span>&nbsp;<span class="op" id="1744791">:=</span>&nbsp;<span class="op" id="1744794">(</span><span class="op" id="1744795">*</span><span class="op" id="1744796">[</span><span class="ident" id="1744797"><a href="/runtime/cpuprof.go.html#1741282">maxCPUProfStack</a></span><span class="op" id="1744812">]</span><span class="builtintype" id="1744813">uintptr</span><span class="op" id="1744820">)</span><span class="op" id="1744821">(</span><span class="ident" id="1744822"><a href="/runtime/cpuprof.go.html#1741188">unsafe</a></span><span class="op" id="1744828">.</span><span class="ident" id="1744829">Pointer</span><span class="op" id="1744836">(</span><span class="ident" id="1744837"><a href="/runtime/cpuprof.go.html#1744713">pc</a></span><span class="op" id="1744839">)</span><span class="op" id="1744840">)</span><span class="op" id="1744841">[</span><span class="op" id="1744842">:</span><span class="ident" id="1744843"><a href="/runtime/cpuprof.go.html#1744726">n</a></span><span class="op" id="1744844">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1744847"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1744854">.</span><span class="ident" id="1744855">add</span><span class="op" id="1744858">(</span><span class="ident" id="1744859"><a href="/runtime/cpuprof.go.html#1744789">s</a></span><span class="op" id="1744860">)</span><br>
<span class="lineno"></span><span class="op" id="1744862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1744865">//&nbsp;add&nbsp;adds&nbsp;the&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1744909">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;signal&nbsp;handlers&nbsp;and&nbsp;other&nbsp;limited&nbsp;environments</span><br>
<span class="lineno">200</span><span class="comment" id="1744977">//&nbsp;and&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;acquire&nbsp;locks&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1745038">//&nbsp;held&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;signal,&nbsp;nor&nbsp;can&nbsp;it&nbsp;use&nbsp;substantial&nbsp;amounts</span><br>
<span class="lineno"></span><span class="comment" id="1745108">//&nbsp;of&nbsp;stack.&nbsp;&nbsp;It&nbsp;is&nbsp;allowed&nbsp;to&nbsp;call&nbsp;evict.</span><br>
<span class="lineno"></span><span class="keyword" id="1745151">func</span>&nbsp;<span class="op" id="1745156">(</span><span class="ident" id="1745157">p</span>&nbsp;<span class="op" id="1745159">*</span><span class="ident" id="1745160"><a href="/runtime/cpuprof.go.html#1741403">cpuProfile</a></span><span class="op" id="1745170">)</span>&nbsp;<span class="ident" id="1745172">add</span><span class="op" id="1745175">(</span><span class="ident" id="1745176">pc</span>&nbsp;<span class="op" id="1745179">[</span><span class="op" id="1745180">]</span><span class="builtintype" id="1745181">uintptr</span><span class="op" id="1745188">)</span>&nbsp;<span class="op" id="1745190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1745193">//&nbsp;Compute&nbsp;hash.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745211">h</span>&nbsp;<span class="op" id="1745213">:=</span>&nbsp;<span class="builtintype" id="1745216">uintptr</span><span class="op" id="1745223">(</span><span class="num" id="1745224">0</span><span class="op" id="1745225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745228">for</span>&nbsp;<span class="ident" id="1745232">_</span><span class="op" id="1745233">,</span>&nbsp;<span class="ident" id="1745235">x</span>&nbsp;<span class="op" id="1745237">:=</span>&nbsp;<span class="keyword" id="1745240">range</span>&nbsp;<span class="ident" id="1745246"><a href="/runtime/cpuprof.go.html#1745176">pc</a></span>&nbsp;<span class="op" id="1745249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745253"><a href="/runtime/cpuprof.go.html#1745211">h</a></span>&nbsp;<span class="op" id="1745255">=</span>&nbsp;<span class="ident" id="1745257"><a href="/runtime/cpuprof.go.html#1745211">h</a></span><span class="op" id="1745258">&lt;&lt;</span><span class="num" id="1745260">8</span>&nbsp;<span class="op" id="1745262">|</span>&nbsp;<span class="op" id="1745264">(</span><span class="ident" id="1745265"><a href="/runtime/cpuprof.go.html#1745211">h</a></span>&nbsp;<span class="op" id="1745267">&gt;&gt;</span>&nbsp;<span class="op" id="1745270">(</span><span class="num" id="1745271">8</span>&nbsp;<span class="op" id="1745273">*</span>&nbsp;<span class="op" id="1745275">(</span><span class="ident" id="1745276"><a href="/runtime/cpuprof.go.html#1741188">unsafe</a></span><span class="op" id="1745282">.</span><span class="ident" id="1745283">Sizeof</span><span class="op" id="1745289">(</span><span class="ident" id="1745290"><a href="/runtime/cpuprof.go.html#1745211">h</a></span><span class="op" id="1745291">)</span>&nbsp;<span class="op" id="1745293">-</span>&nbsp;<span class="num" id="1745295">1</span><span class="op" id="1745296">)</span><span class="op" id="1745297">)</span><span class="op" id="1745298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745302"><a href="/runtime/cpuprof.go.html#1745211">h</a></span>&nbsp;<span class="op" id="1745304">+=</span>&nbsp;<span class="ident" id="1745307"><a href="/runtime/cpuprof.go.html#1745235">x</a></span><span class="op" id="1745308">*</span><span class="num" id="1745309">31</span>&nbsp;<span class="op" id="1745312">+</span>&nbsp;<span class="ident" id="1745314"><a href="/runtime/cpuprof.go.html#1745235">x</a></span><span class="op" id="1745315">*</span><span class="num" id="1745316">7</span>&nbsp;<span class="op" id="1745318">+</span>&nbsp;<span class="ident" id="1745320"><a href="/runtime/cpuprof.go.html#1745235">x</a></span><span class="op" id="1745321">*</span><span class="num" id="1745322">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1745325">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745328"><a href="/runtime/cpuprof.go.html#1745157">p</a></span><span class="op" id="1745329">.</span><span class="ident" id="1745330">count</span><span class="op" id="1745335">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1745340">//&nbsp;Add&nbsp;to&nbsp;entry&nbsp;count&nbsp;if&nbsp;already&nbsp;present&nbsp;in&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745392">b</span>&nbsp;<span class="op" id="1745394">:=</span>&nbsp;<span class="op" id="1745397">&amp;</span><span class="ident" id="1745398"><a href="/runtime/cpuprof.go.html#1745157">p</a></span><span class="op" id="1745399">.</span><span class="ident" id="1745400">hash</span><span class="op" id="1745404">[</span><span class="ident" id="1745405"><a href="/runtime/cpuprof.go.html#1745211">h</a></span><span class="op" id="1745406">%</span><span class="ident" id="1745407"><a href="/runtime/cpuprof.go.html#1741207">numBuckets</a></span><span class="op" id="1745417">]</span><br>
<span class="lineno"></span><span class="ident" id="1745419">Assoc</span><span class="op" id="1745424">:</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745427">for</span>&nbsp;<span class="ident" id="1745431">i</span>&nbsp;<span class="op" id="1745433">:=</span>&nbsp;<span class="keyword" id="1745436">range</span>&nbsp;<span class="ident" id="1745442"><a href="/runtime/cpuprof.go.html#1745392">b</a></span><span class="op" id="1745443">.</span><span class="ident" id="1745444">entry</span>&nbsp;<span class="op" id="1745450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745454">e</span>&nbsp;<span class="op" id="1745456">:=</span>&nbsp;<span class="op" id="1745459">&amp;</span><span class="ident" id="1745460"><a href="/runtime/cpuprof.go.html#1745392">b</a></span><span class="op" id="1745461">.</span><span class="ident" id="1745462">entry</span><span class="op" id="1745467">[</span><span class="ident" id="1745468"><a href="/runtime/cpuprof.go.html#1745431">i</a></span><span class="op" id="1745469">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745473">if</span>&nbsp;<span class="ident" id="1745476"><a href="/runtime/cpuprof.go.html#1745454">e</a></span><span class="op" id="1745477">.</span><span class="ident" id="1745478">depth</span>&nbsp;<span class="op" id="1745484">!=</span>&nbsp;<span class="builtintype" id="1745487">uintptr</span><span class="op" id="1745494">(</span><span class="builtinfunc" id="1745495">len</span><span class="op" id="1745498">(</span><span class="ident" id="1745499"><a href="/runtime/cpuprof.go.html#1745176">pc</a></span><span class="op" id="1745501">)</span><span class="op" id="1745502">)</span>&nbsp;<span class="op" id="1745504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745509">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1745520">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745524">for</span>&nbsp;<span class="ident" id="1745528">j</span>&nbsp;<span class="op" id="1745530">:=</span>&nbsp;<span class="keyword" id="1745533">range</span>&nbsp;<span class="ident" id="1745539"><a href="/runtime/cpuprof.go.html#1745176">pc</a></span>&nbsp;<span class="op" id="1745542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745547">if</span>&nbsp;<span class="ident" id="1745550"><a href="/runtime/cpuprof.go.html#1745454">e</a></span><span class="op" id="1745551">.</span><span class="ident" id="1745552">stack</span><span class="op" id="1745557">[</span><span class="ident" id="1745558"><a href="/runtime/cpuprof.go.html#1745528">j</a></span><span class="op" id="1745559">]</span>&nbsp;<span class="op" id="1745561">!=</span>&nbsp;<span class="ident" id="1745564"><a href="/runtime/cpuprof.go.html#1745176">pc</a></span><span class="op" id="1745566">[</span><span class="ident" id="1745567"><a href="/runtime/cpuprof.go.html#1745528">j</a></span><span class="op" id="1745568">]</span>&nbsp;<span class="op" id="1745570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745576">continue</span>&nbsp;<span class="ident" id="1745585">Assoc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1745594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1745598">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745602"><a href="/runtime/cpuprof.go.html#1745454">e</a></span><span class="op" id="1745603">.</span><span class="ident" id="1745604">count</span><span class="op" id="1745609">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745614">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1745622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1745626">//&nbsp;Evict&nbsp;entry&nbsp;with&nbsp;smallest&nbsp;count.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745663">var</span>&nbsp;<span class="ident" id="1745667">e</span>&nbsp;<span class="op" id="1745669">*</span><span class="ident" id="1745670"><a href="/runtime/cpuprof.go.html#1741311">cpuprofEntry</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745684">for</span>&nbsp;<span class="ident" id="1745688">i</span>&nbsp;<span class="op" id="1745690">:=</span>&nbsp;<span class="keyword" id="1745693">range</span>&nbsp;<span class="ident" id="1745699"><a href="/runtime/cpuprof.go.html#1745392">b</a></span><span class="op" id="1745700">.</span><span class="ident" id="1745701">entry</span>&nbsp;<span class="op" id="1745707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745711">if</span>&nbsp;<span class="ident" id="1745714"><a href="/runtime/cpuprof.go.html#1745667">e</a></span>&nbsp;<span class="op" id="1745716">==</span>&nbsp;<span class="ident" id="1745719">nil</span>&nbsp;<span class="op" id="1745723">||</span>&nbsp;<span class="ident" id="1745726"><a href="/runtime/cpuprof.go.html#1745392">b</a></span><span class="op" id="1745727">.</span><span class="ident" id="1745728">entry</span><span class="op" id="1745733">[</span><span class="ident" id="1745734"><a href="/runtime/cpuprof.go.html#1745688">i</a></span><span class="op" id="1745735">]</span><span class="op" id="1745736">.</span><span class="ident" id="1745737">count</span>&nbsp;<span class="op" id="1745743">&lt;</span>&nbsp;<span class="ident" id="1745745"><a href="/runtime/cpuprof.go.html#1745667">e</a></span><span class="op" id="1745746">.</span><span class="ident" id="1745747">count</span>&nbsp;<span class="op" id="1745753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745758"><a href="/runtime/cpuprof.go.html#1745667">e</a></span>&nbsp;<span class="op" id="1745760">=</span>&nbsp;<span class="op" id="1745762">&amp;</span><span class="ident" id="1745763"><a href="/runtime/cpuprof.go.html#1745392">b</a></span><span class="op" id="1745764">.</span><span class="ident" id="1745765">entry</span><span class="op" id="1745770">[</span><span class="ident" id="1745771"><a href="/runtime/cpuprof.go.html#1745688">i</a></span><span class="op" id="1745772">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1745776">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1745779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745782">if</span>&nbsp;<span class="ident" id="1745785"><a href="/runtime/cpuprof.go.html#1745667">e</a></span><span class="op" id="1745786">.</span><span class="ident" id="1745787">count</span>&nbsp;<span class="op" id="1745793">&gt;</span>&nbsp;<span class="num" id="1745795">0</span>&nbsp;<span class="op" id="1745797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745801">if</span>&nbsp;<span class="op" id="1745804">!</span><span class="ident" id="1745805"><a href="/runtime/cpuprof.go.html#1745157">p</a></span><span class="op" id="1745806">.</span><span class="ident" id="1745807">evict</span><span class="op" id="1745812">(</span><span class="ident" id="1745813"><a href="/runtime/cpuprof.go.html#1745667">e</a></span><span class="op" id="1745814">)</span>&nbsp;<span class="op" id="1745816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1745821">//&nbsp;Could&nbsp;not&nbsp;evict&nbsp;entry.&nbsp;&nbsp;Record&nbsp;lost&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745870"><a href="/runtime/cpuprof.go.html#1745157">p</a></span><span class="op" id="1745871">.</span><span class="ident" id="1745872">lost</span><span class="op" id="1745876">++</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1745882">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1745891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745895"><a href="/runtime/cpuprof.go.html#1745157">p</a></span><span class="op" id="1745896">.</span><span class="ident" id="1745897">evicts</span><span class="op" id="1745903">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1745907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1745911">//&nbsp;Reuse&nbsp;the&nbsp;newly&nbsp;evicted&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745946"><a href="/runtime/cpuprof.go.html#1745667">e</a></span><span class="op" id="1745947">.</span><span class="ident" id="1745948">depth</span>&nbsp;<span class="op" id="1745954">=</span>&nbsp;<span class="builtintype" id="1745956">uintptr</span><span class="op" id="1745963">(</span><span class="builtinfunc" id="1745964">len</span><span class="op" id="1745967">(</span><span class="ident" id="1745968"><a href="/runtime/cpuprof.go.html#1745176">pc</a></span><span class="op" id="1745970">)</span><span class="op" id="1745971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1745974"><a href="/runtime/cpuprof.go.html#1745667">e</a></span><span class="op" id="1745975">.</span><span class="ident" id="1745976">count</span>&nbsp;<span class="op" id="1745982">=</span>&nbsp;<span class="num" id="1745984">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1745987">copy</span><span class="op" id="1745991">(</span><span class="ident" id="1745992"><a href="/runtime/cpuprof.go.html#1745667">e</a></span><span class="op" id="1745993">.</span><span class="ident" id="1745994">stack</span><span class="op" id="1745999">[</span><span class="op" id="1746000">:</span><span class="op" id="1746001">]</span><span class="op" id="1746002">,</span>&nbsp;<span class="ident" id="1746004"><a href="/runtime/cpuprof.go.html#1745176">pc</a></span><span class="op" id="1746006">)</span><br>
<span class="lineno"></span><span class="op" id="1746008">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="1746011">//&nbsp;evict&nbsp;copies&nbsp;the&nbsp;given&nbsp;entry&#39;s&nbsp;data&nbsp;into&nbsp;the&nbsp;log,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1746072">//&nbsp;the&nbsp;entry&nbsp;can&nbsp;be&nbsp;reused.&nbsp;&nbsp;evict&nbsp;is&nbsp;called&nbsp;from&nbsp;add,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="1746133">//&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;profiling&nbsp;signal&nbsp;handler,&nbsp;so&nbsp;it&nbsp;must&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="1746196">//&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;flushlog.</span><br>
<span class="lineno">255</span><span class="comment" id="1746255">//&nbsp;evict&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;entry&nbsp;was&nbsp;copied&nbsp;to&nbsp;the&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="1746313">//&nbsp;false&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;room&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1746354">func</span>&nbsp;<span class="op" id="1746359">(</span><span class="ident" id="1746360">p</span>&nbsp;<span class="op" id="1746362">*</span><span class="ident" id="1746363"><a href="/runtime/cpuprof.go.html#1741403">cpuProfile</a></span><span class="op" id="1746373">)</span>&nbsp;<span class="ident" id="1746375">evict</span><span class="op" id="1746380">(</span><span class="ident" id="1746381">e</span>&nbsp;<span class="op" id="1746383">*</span><span class="ident" id="1746384"><a href="/runtime/cpuprof.go.html#1741311">cpuprofEntry</a></span><span class="op" id="1746396">)</span>&nbsp;<span class="builtintype" id="1746398">bool</span>&nbsp;<span class="op" id="1746403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746406">d</span>&nbsp;<span class="op" id="1746408">:=</span>&nbsp;<span class="ident" id="1746411"><a href="/runtime/cpuprof.go.html#1746381">e</a></span><span class="op" id="1746412">.</span><span class="ident" id="1746413">depth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746420">nslot</span>&nbsp;<span class="op" id="1746426">:=</span>&nbsp;<span class="ident" id="1746429"><a href="/runtime/cpuprof.go.html#1746406">d</a></span>&nbsp;<span class="op" id="1746431">+</span>&nbsp;<span class="num" id="1746433">2</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746436">log</span>&nbsp;<span class="op" id="1746440">:=</span>&nbsp;<span class="op" id="1746443">&amp;</span><span class="ident" id="1746444"><a href="/runtime/cpuprof.go.html#1746360">p</a></span><span class="op" id="1746445">.</span><span class="ident" id="1746446">log</span><span class="op" id="1746449">[</span><span class="ident" id="1746450"><a href="/runtime/cpuprof.go.html#1746360">p</a></span><span class="op" id="1746451">.</span><span class="ident" id="1746452">toggle</span><span class="op" id="1746458">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1746461">if</span>&nbsp;<span class="ident" id="1746464"><a href="/runtime/cpuprof.go.html#1746360">p</a></span><span class="op" id="1746465">.</span><span class="ident" id="1746466">nlog</span><span class="op" id="1746470">+</span><span class="ident" id="1746471"><a href="/runtime/cpuprof.go.html#1746420">nslot</a></span>&nbsp;<span class="op" id="1746477">&gt;</span>&nbsp;<span class="builtintype" id="1746479">uintptr</span><span class="op" id="1746486">(</span><span class="builtinfunc" id="1746487">len</span><span class="op" id="1746490">(</span><span class="ident" id="1746491"><a href="/runtime/cpuprof.go.html#1746360">p</a></span><span class="op" id="1746492">.</span><span class="ident" id="1746493">log</span><span class="op" id="1746496">[</span><span class="num" id="1746497">0</span><span class="op" id="1746498">]</span><span class="op" id="1746499">)</span><span class="op" id="1746500">)</span>&nbsp;<span class="op" id="1746502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1746506">if</span>&nbsp;<span class="op" id="1746509">!</span><span class="ident" id="1746510"><a href="/runtime/cpuprof.go.html#1746360">p</a></span><span class="op" id="1746511">.</span><span class="ident" id="1746512">flushlog</span><span class="op" id="1746520">(</span><span class="op" id="1746521">)</span>&nbsp;<span class="op" id="1746523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1746528">return</span>&nbsp;<span class="ident" id="1746535">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1746543">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746547"><a href="/runtime/cpuprof.go.html#1746436">log</a></span>&nbsp;<span class="op" id="1746551">=</span>&nbsp;<span class="op" id="1746553">&amp;</span><span class="ident" id="1746554"><a href="/runtime/cpuprof.go.html#1746360">p</a></span><span class="op" id="1746555">.</span><span class="ident" id="1746556">log</span><span class="op" id="1746559">[</span><span class="ident" id="1746560"><a href="/runtime/cpuprof.go.html#1746360">p</a></span><span class="op" id="1746561">.</span><span class="ident" id="1746562">toggle</span><span class="op" id="1746568">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1746571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746575">q</span>&nbsp;<span class="op" id="1746577">:=</span>&nbsp;<span class="ident" id="1746580"><a href="/runtime/cpuprof.go.html#1746360">p</a></span><span class="op" id="1746581">.</span><span class="ident" id="1746582">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746588"><a href="/runtime/cpuprof.go.html#1746436">log</a></span><span class="op" id="1746591">[</span><span class="ident" id="1746592"><a href="/runtime/cpuprof.go.html#1746575">q</a></span><span class="op" id="1746593">]</span>&nbsp;<span class="op" id="1746595">=</span>&nbsp;<span class="ident" id="1746597"><a href="/runtime/cpuprof.go.html#1746381">e</a></span><span class="op" id="1746598">.</span><span class="ident" id="1746599">count</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746606"><a href="/runtime/cpuprof.go.html#1746575">q</a></span><span class="op" id="1746607">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746611"><a href="/runtime/cpuprof.go.html#1746436">log</a></span><span class="op" id="1746614">[</span><span class="ident" id="1746615"><a href="/runtime/cpuprof.go.html#1746575">q</a></span><span class="op" id="1746616">]</span>&nbsp;<span class="op" id="1746618">=</span>&nbsp;<span class="ident" id="1746620"><a href="/runtime/cpuprof.go.html#1746406">d</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746623"><a href="/runtime/cpuprof.go.html#1746575">q</a></span><span class="op" id="1746624">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1746628">copy</span><span class="op" id="1746632">(</span><span class="ident" id="1746633"><a href="/runtime/cpuprof.go.html#1746436">log</a></span><span class="op" id="1746636">[</span><span class="ident" id="1746637"><a href="/runtime/cpuprof.go.html#1746575">q</a></span><span class="op" id="1746638">:</span><span class="op" id="1746639">]</span><span class="op" id="1746640">,</span>&nbsp;<span class="ident" id="1746642"><a href="/runtime/cpuprof.go.html#1746381">e</a></span><span class="op" id="1746643">.</span><span class="ident" id="1746644">stack</span><span class="op" id="1746649">[</span><span class="op" id="1746650">:</span><span class="ident" id="1746651"><a href="/runtime/cpuprof.go.html#1746406">d</a></span><span class="op" id="1746652">]</span><span class="op" id="1746653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746656"><a href="/runtime/cpuprof.go.html#1746575">q</a></span>&nbsp;<span class="op" id="1746658">+=</span>&nbsp;<span class="ident" id="1746661"><a href="/runtime/cpuprof.go.html#1746406">d</a></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746664"><a href="/runtime/cpuprof.go.html#1746360">p</a></span><span class="op" id="1746665">.</span><span class="ident" id="1746666">nlog</span>&nbsp;<span class="op" id="1746671">=</span>&nbsp;<span class="ident" id="1746673"><a href="/runtime/cpuprof.go.html#1746575">q</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1746676"><a href="/runtime/cpuprof.go.html#1746381">e</a></span><span class="op" id="1746677">.</span><span class="ident" id="1746678">count</span>&nbsp;<span class="op" id="1746684">=</span>&nbsp;<span class="num" id="1746686">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1746689">return</span>&nbsp;<span class="ident" id="1746696">true</span><br>
<span class="lineno"></span><span class="op" id="1746701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="1746704">//&nbsp;flushlog&nbsp;tries&nbsp;to&nbsp;flush&nbsp;the&nbsp;current&nbsp;log&nbsp;and&nbsp;switch&nbsp;to&nbsp;the&nbsp;other&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1746776">//&nbsp;flushlog&nbsp;is&nbsp;called&nbsp;from&nbsp;evict,&nbsp;called&nbsp;from&nbsp;add,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler,</span><br>
<span class="lineno"></span><span class="comment" id="1746859">//&nbsp;so&nbsp;it&nbsp;cannot&nbsp;allocate&nbsp;memory&nbsp;or&nbsp;block.&nbsp;&nbsp;It&nbsp;can&nbsp;try&nbsp;to&nbsp;swap&nbsp;logs&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1746931">//&nbsp;the&nbsp;writing&nbsp;goroutine,&nbsp;as&nbsp;explained&nbsp;in&nbsp;the&nbsp;comment&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;this&nbsp;file.</span><br>
<span class="lineno"></span><span class="keyword" id="1747010">func</span>&nbsp;<span class="op" id="1747015">(</span><span class="ident" id="1747016">p</span>&nbsp;<span class="op" id="1747018">*</span><span class="ident" id="1747019"><a href="/runtime/cpuprof.go.html#1741403">cpuProfile</a></span><span class="op" id="1747029">)</span>&nbsp;<span class="ident" id="1747031">flushlog</span><span class="op" id="1747039">(</span><span class="op" id="1747040">)</span>&nbsp;<span class="builtintype" id="1747042">bool</span>&nbsp;<span class="op" id="1747047">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747050">if</span>&nbsp;<span class="op" id="1747053">!</span><span class="ident" id="1747054"><a href="/runtime/stubs.go.html#1974711">cas</a></span><span class="op" id="1747057">(</span><span class="op" id="1747058">&amp;</span><span class="ident" id="1747059"><a href="/runtime/cpuprof.go.html#1747016">p</a></span><span class="op" id="1747060">.</span><span class="ident" id="1747061">handoff</span><span class="op" id="1747068">,</span>&nbsp;<span class="num" id="1747070">0</span><span class="op" id="1747071">,</span>&nbsp;<span class="builtintype" id="1747073">uint32</span><span class="op" id="1747079">(</span><span class="ident" id="1747080"><a href="/runtime/cpuprof.go.html#1747016">p</a></span><span class="op" id="1747081">.</span><span class="ident" id="1747082">nlog</span><span class="op" id="1747086">)</span><span class="op" id="1747087">)</span>&nbsp;<span class="op" id="1747089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747093">return</span>&nbsp;<span class="ident" id="1747100">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747110"><a href="/runtime/lock_futex.go.html#1817095">notewakeup</a></span><span class="op" id="1747120">(</span><span class="op" id="1747121">&amp;</span><span class="ident" id="1747122"><a href="/runtime/cpuprof.go.html#1747016">p</a></span><span class="op" id="1747123">.</span><span class="ident" id="1747124">wait</span><span class="op" id="1747128">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747132"><a href="/runtime/cpuprof.go.html#1747016">p</a></span><span class="op" id="1747133">.</span><span class="ident" id="1747134">toggle</span>&nbsp;<span class="op" id="1747141">=</span>&nbsp;<span class="num" id="1747143">1</span>&nbsp;<span class="op" id="1747145">-</span>&nbsp;<span class="ident" id="1747147"><a href="/runtime/cpuprof.go.html#1747016">p</a></span><span class="op" id="1747148">.</span><span class="ident" id="1747149">toggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747157">log</span>&nbsp;<span class="op" id="1747161">:=</span>&nbsp;<span class="op" id="1747164">&amp;</span><span class="ident" id="1747165"><a href="/runtime/cpuprof.go.html#1747016">p</a></span><span class="op" id="1747166">.</span><span class="ident" id="1747167">log</span><span class="op" id="1747170">[</span><span class="ident" id="1747171"><a href="/runtime/cpuprof.go.html#1747016">p</a></span><span class="op" id="1747172">.</span><span class="ident" id="1747173">toggle</span><span class="op" id="1747179">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747182">q</span>&nbsp;<span class="op" id="1747184">:=</span>&nbsp;<span class="builtintype" id="1747187">uintptr</span><span class="op" id="1747194">(</span><span class="num" id="1747195">0</span><span class="op" id="1747196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747199">if</span>&nbsp;<span class="ident" id="1747202"><a href="/runtime/cpuprof.go.html#1747016">p</a></span><span class="op" id="1747203">.</span><span class="ident" id="1747204">lost</span>&nbsp;<span class="op" id="1747209">&gt;</span>&nbsp;<span class="num" id="1747211">0</span>&nbsp;<span class="op" id="1747213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747217">lostPC</span>&nbsp;<span class="op" id="1747224">:=</span>&nbsp;<span class="ident" id="1747227"><a href="/runtime/proc.go.html#1905425">funcPC</a></span><span class="op" id="1747233">(</span><span class="ident" id="1747234"><a href="/runtime/cpuprof.go.html#1742615">lostProfileData</a></span><span class="op" id="1747249">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747253"><a href="/runtime/cpuprof.go.html#1747157">log</a></span><span class="op" id="1747256">[</span><span class="num" id="1747257">0</span><span class="op" id="1747258">]</span>&nbsp;<span class="op" id="1747260">=</span>&nbsp;<span class="ident" id="1747262"><a href="/runtime/cpuprof.go.html#1747016">p</a></span><span class="op" id="1747263">.</span><span class="ident" id="1747264">lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747271"><a href="/runtime/cpuprof.go.html#1747157">log</a></span><span class="op" id="1747274">[</span><span class="num" id="1747275">1</span><span class="op" id="1747276">]</span>&nbsp;<span class="op" id="1747278">=</span>&nbsp;<span class="num" id="1747280">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747284"><a href="/runtime/cpuprof.go.html#1747157">log</a></span><span class="op" id="1747287">[</span><span class="num" id="1747288">2</span><span class="op" id="1747289">]</span>&nbsp;<span class="op" id="1747291">=</span>&nbsp;<span class="ident" id="1747293"><a href="/runtime/cpuprof.go.html#1747217">lostPC</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747302"><a href="/runtime/cpuprof.go.html#1747182">q</a></span>&nbsp;<span class="op" id="1747304">=</span>&nbsp;<span class="num" id="1747306">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747310"><a href="/runtime/cpuprof.go.html#1747016">p</a></span><span class="op" id="1747311">.</span><span class="ident" id="1747312">lost</span>&nbsp;<span class="op" id="1747317">=</span>&nbsp;<span class="num" id="1747319">0</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747325"><a href="/runtime/cpuprof.go.html#1747016">p</a></span><span class="op" id="1747326">.</span><span class="ident" id="1747327">nlog</span>&nbsp;<span class="op" id="1747332">=</span>&nbsp;<span class="ident" id="1747334"><a href="/runtime/cpuprof.go.html#1747182">q</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747337">return</span>&nbsp;<span class="ident" id="1747344">true</span><br>
<span class="lineno"></span><span class="op" id="1747349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="comment" id="1747352">//&nbsp;getprofile&nbsp;blocks&nbsp;until&nbsp;the&nbsp;next&nbsp;block&nbsp;of&nbsp;profiling&nbsp;data&nbsp;is&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="1747425">//&nbsp;and&nbsp;returns&nbsp;it&nbsp;as&nbsp;a&nbsp;[]byte.&nbsp;&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;writing&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1747498">func</span>&nbsp;<span class="op" id="1747503">(</span><span class="ident" id="1747504">p</span>&nbsp;<span class="op" id="1747506">*</span><span class="ident" id="1747507"><a href="/runtime/cpuprof.go.html#1741403">cpuProfile</a></span><span class="op" id="1747517">)</span>&nbsp;<span class="ident" id="1747519">getprofile</span><span class="op" id="1747529">(</span><span class="op" id="1747530">)</span>&nbsp;<span class="op" id="1747532">[</span><span class="op" id="1747533">]</span><span class="builtintype" id="1747534">byte</span>&nbsp;<span class="op" id="1747539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747542">if</span>&nbsp;<span class="ident" id="1747545"><a href="/runtime/cpuprof.go.html#1747504">p</a></span>&nbsp;<span class="op" id="1747547">==</span>&nbsp;<span class="ident" id="1747550">nil</span>&nbsp;<span class="op" id="1747554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747558">return</span>&nbsp;<span class="ident" id="1747565">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747574">if</span>&nbsp;<span class="ident" id="1747577"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1747578">.</span><span class="ident" id="1747579">wholding</span>&nbsp;<span class="op" id="1747588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1747592">//&nbsp;Release&nbsp;previous&nbsp;log&nbsp;to&nbsp;signal&nbsp;handling&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1747643">//&nbsp;Loop&nbsp;because&nbsp;we&nbsp;are&nbsp;racing&nbsp;against&nbsp;SetCPUProfileRate(0).</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747705">for</span>&nbsp;<span class="op" id="1747709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747714">n</span>&nbsp;<span class="op" id="1747716">:=</span>&nbsp;<span class="ident" id="1747719"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1747720">.</span><span class="ident" id="1747721">handoff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747732">if</span>&nbsp;<span class="ident" id="1747735"><a href="/runtime/cpuprof.go.html#1747714">n</a></span>&nbsp;<span class="op" id="1747737">==</span>&nbsp;<span class="num" id="1747740">0</span>&nbsp;<span class="op" id="1747742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1747748">print</span><span class="op" id="1747753">(</span><span class="string" id="1747754">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;handoff\n&#34;</span><span class="op" id="1747805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747811">return</span>&nbsp;<span class="ident" id="1747818">nil</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747830">if</span>&nbsp;<span class="ident" id="1747833"><a href="/runtime/cpuprof.go.html#1747714">n</a></span><span class="op" id="1747834">&amp;</span><span class="num" id="1747835">0x80000000</span>&nbsp;<span class="op" id="1747846">!=</span>&nbsp;<span class="num" id="1747849">0</span>&nbsp;<span class="op" id="1747851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747857"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1747858">.</span><span class="ident" id="1747859">wtoggle</span>&nbsp;<span class="op" id="1747867">=</span>&nbsp;<span class="num" id="1747869">1</span>&nbsp;<span class="op" id="1747871">-</span>&nbsp;<span class="ident" id="1747873"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1747874">.</span><span class="ident" id="1747875">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747887"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1747888">.</span><span class="ident" id="1747889">wholding</span>&nbsp;<span class="op" id="1747898">=</span>&nbsp;<span class="ident" id="1747900">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747910"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1747911">.</span><span class="ident" id="1747912">flushing</span>&nbsp;<span class="op" id="1747921">=</span>&nbsp;<span class="ident" id="1747923">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747932">goto</span>&nbsp;<span class="ident" id="1747937">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747951">if</span>&nbsp;<span class="ident" id="1747954"><a href="/runtime/stubs.go.html#1974711">cas</a></span><span class="op" id="1747957">(</span><span class="op" id="1747958">&amp;</span><span class="ident" id="1747959"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1747960">.</span><span class="ident" id="1747961">handoff</span><span class="op" id="1747968">,</span>&nbsp;<span class="ident" id="1747970"><a href="/runtime/cpuprof.go.html#1747714">n</a></span><span class="op" id="1747971">,</span>&nbsp;<span class="num" id="1747973">0</span><span class="op" id="1747974">)</span>&nbsp;<span class="op" id="1747976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1747982">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747991">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1747995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1747999"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748000">.</span><span class="ident" id="1748001">wtoggle</span>&nbsp;<span class="op" id="1748009">=</span>&nbsp;<span class="num" id="1748011">1</span>&nbsp;<span class="op" id="1748013">-</span>&nbsp;<span class="ident" id="1748015"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748016">.</span><span class="ident" id="1748017">wtoggle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748027"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748028">.</span><span class="ident" id="1748029">wholding</span>&nbsp;<span class="op" id="1748038">=</span>&nbsp;<span class="ident" id="1748040">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748051">if</span>&nbsp;<span class="ident" id="1748054"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748055">.</span><span class="ident" id="1748056">flushing</span>&nbsp;<span class="op" id="1748065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748069">goto</span>&nbsp;<span class="ident" id="1748074">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748085">if</span>&nbsp;<span class="op" id="1748088">!</span><span class="ident" id="1748089"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748090">.</span><span class="ident" id="1748091">on</span>&nbsp;<span class="op" id="1748094">&amp;&amp;</span>&nbsp;<span class="ident" id="1748097"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748098">.</span><span class="ident" id="1748099">handoff</span>&nbsp;<span class="op" id="1748107">==</span>&nbsp;<span class="num" id="1748110">0</span>&nbsp;<span class="op" id="1748112">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748116">return</span>&nbsp;<span class="ident" id="1748123">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748132">//&nbsp;Wait&nbsp;for&nbsp;new&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748154"><a href="/runtime/lock_futex.go.html#1818401">notetsleepg</a></span><span class="op" id="1748165">(</span><span class="op" id="1748166">&amp;</span><span class="ident" id="1748167"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748168">.</span><span class="ident" id="1748169">wait</span><span class="op" id="1748173">,</span>&nbsp;<span class="op" id="1748175">-</span><span class="num" id="1748176">1</span><span class="op" id="1748177">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748180"><a href="/runtime/lock_futex.go.html#1817055">noteclear</a></span><span class="op" id="1748189">(</span><span class="op" id="1748190">&amp;</span><span class="ident" id="1748191"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748192">.</span><span class="ident" id="1748193">wait</span><span class="op" id="1748197">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748201">switch</span>&nbsp;<span class="ident" id="1748208">n</span>&nbsp;<span class="op" id="1748210">:=</span>&nbsp;<span class="ident" id="1748213"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748214">.</span><span class="ident" id="1748215">handoff</span><span class="op" id="1748222">;</span>&nbsp;<span class="op" id="1748224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748227">case</span>&nbsp;<span class="ident" id="1748232"><a href="/runtime/cpuprof.go.html#1748208">n</a></span>&nbsp;<span class="op" id="1748234">==</span>&nbsp;<span class="num" id="1748237">0</span><span class="op" id="1748238">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1748242">print</span><span class="op" id="1748247">(</span><span class="string" id="1748248">&#34;runtime:&nbsp;phase&nbsp;error&nbsp;during&nbsp;cpu&nbsp;profile&nbsp;wait\n&#34;</span><span class="op" id="1748296">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748300">return</span>&nbsp;<span class="ident" id="1748307">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748312">case</span>&nbsp;<span class="ident" id="1748317"><a href="/runtime/cpuprof.go.html#1748208">n</a></span>&nbsp;<span class="op" id="1748319">==</span>&nbsp;<span class="num" id="1748322">0x80000000</span><span class="op" id="1748332">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748336"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748337">.</span><span class="ident" id="1748338">flushing</span>&nbsp;<span class="op" id="1748347">=</span>&nbsp;<span class="ident" id="1748349">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748356">goto</span>&nbsp;<span class="ident" id="1748361">Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748368">default</span><span class="op" id="1748375">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748379"><a href="/runtime/cpuprof.go.html#1748208">n</a></span>&nbsp;<span class="op" id="1748381">&amp;^=</span>&nbsp;<span class="num" id="1748385">0x80000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748399">//&nbsp;Return&nbsp;new&nbsp;log&nbsp;to&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748430"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748431">.</span><span class="ident" id="1748432">wholding</span>&nbsp;<span class="op" id="1748441">=</span>&nbsp;<span class="ident" id="1748443">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748451">return</span>&nbsp;<span class="ident" id="1748458"><a href="/runtime/cpuprof.go.html#1749578">uintptrBytes</a></span><span class="op" id="1748470">(</span><span class="ident" id="1748471"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748472">.</span><span class="ident" id="1748473">log</span><span class="op" id="1748476">[</span><span class="ident" id="1748477"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748478">.</span><span class="ident" id="1748479">wtoggle</span><span class="op" id="1748486">]</span><span class="op" id="1748487">[</span><span class="op" id="1748488">:</span><span class="ident" id="1748489"><a href="/runtime/cpuprof.go.html#1748208">n</a></span><span class="op" id="1748490">]</span><span class="op" id="1748491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748498">//&nbsp;In&nbsp;flush&nbsp;mode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748517">//&nbsp;Add&nbsp;is&nbsp;no&nbsp;longer&nbsp;being&nbsp;called.&nbsp;&nbsp;We&nbsp;own&nbsp;the&nbsp;log.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748569">//&nbsp;Also,&nbsp;p-&gt;handoff&nbsp;is&nbsp;non-zero,&nbsp;so&nbsp;flushlog&nbsp;will&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748634">//&nbsp;Evict&nbsp;the&nbsp;hash&nbsp;table&nbsp;into&nbsp;the&nbsp;log&nbsp;and&nbsp;return&nbsp;it.</span><br>
<span class="lineno"></span><span class="ident" id="1748686">Flush</span><span class="op" id="1748691">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748694">for</span>&nbsp;<span class="ident" id="1748698">i</span>&nbsp;<span class="op" id="1748700">:=</span>&nbsp;<span class="keyword" id="1748703">range</span>&nbsp;<span class="ident" id="1748709"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748710">.</span><span class="ident" id="1748711">hash</span>&nbsp;<span class="op" id="1748716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748720">b</span>&nbsp;<span class="op" id="1748722">:=</span>&nbsp;<span class="op" id="1748725">&amp;</span><span class="ident" id="1748726"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748727">.</span><span class="ident" id="1748728">hash</span><span class="op" id="1748732">[</span><span class="ident" id="1748733"><a href="/runtime/cpuprof.go.html#1748698">i</a></span><span class="op" id="1748734">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748738">for</span>&nbsp;<span class="ident" id="1748742">j</span>&nbsp;<span class="op" id="1748744">:=</span>&nbsp;<span class="keyword" id="1748747">range</span>&nbsp;<span class="ident" id="1748753"><a href="/runtime/cpuprof.go.html#1748720">b</a></span><span class="op" id="1748754">.</span><span class="ident" id="1748755">entry</span>&nbsp;<span class="op" id="1748761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1748766">e</span>&nbsp;<span class="op" id="1748768">:=</span>&nbsp;<span class="op" id="1748771">&amp;</span><span class="ident" id="1748772"><a href="/runtime/cpuprof.go.html#1748720">b</a></span><span class="op" id="1748773">.</span><span class="ident" id="1748774">entry</span><span class="op" id="1748779">[</span><span class="ident" id="1748780"><a href="/runtime/cpuprof.go.html#1748742">j</a></span><span class="op" id="1748781">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748786">if</span>&nbsp;<span class="ident" id="1748789"><a href="/runtime/cpuprof.go.html#1748766">e</a></span><span class="op" id="1748790">.</span><span class="ident" id="1748791">count</span>&nbsp;<span class="op" id="1748797">&gt;</span>&nbsp;<span class="num" id="1748799">0</span>&nbsp;<span class="op" id="1748801">&amp;&amp;</span>&nbsp;<span class="op" id="1748804">!</span><span class="ident" id="1748805"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748806">.</span><span class="ident" id="1748807">evict</span><span class="op" id="1748812">(</span><span class="ident" id="1748813"><a href="/runtime/cpuprof.go.html#1748766">e</a></span><span class="op" id="1748814">)</span>&nbsp;<span class="op" id="1748816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748822">//&nbsp;Filled&nbsp;the&nbsp;log.&nbsp;&nbsp;Stop&nbsp;the&nbsp;loop&nbsp;and&nbsp;return&nbsp;what&nbsp;we&#39;ve&nbsp;got.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748887">break</span>&nbsp;<span class="ident" id="1748893">Flush</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1748909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748913">//&nbsp;Return&nbsp;pending&nbsp;log&nbsp;data.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1748942">if</span>&nbsp;<span class="ident" id="1748945"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1748946">.</span><span class="ident" id="1748947">nlog</span>&nbsp;<span class="op" id="1748952">&gt;</span>&nbsp;<span class="num" id="1748954">0</span>&nbsp;<span class="op" id="1748956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1748960">//&nbsp;Note&nbsp;that&nbsp;we&#39;re&nbsp;using&nbsp;toggle&nbsp;now,&nbsp;not&nbsp;wtoggle,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1749012">//&nbsp;because&nbsp;we&#39;re&nbsp;working&nbsp;on&nbsp;the&nbsp;log&nbsp;directly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749060">n</span>&nbsp;<span class="op" id="1749062">:=</span>&nbsp;<span class="ident" id="1749065"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1749066">.</span><span class="ident" id="1749067">nlog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749074"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1749075">.</span><span class="ident" id="1749076">nlog</span>&nbsp;<span class="op" id="1749081">=</span>&nbsp;<span class="num" id="1749083">0</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749087">return</span>&nbsp;<span class="ident" id="1749094"><a href="/runtime/cpuprof.go.html#1749578">uintptrBytes</a></span><span class="op" id="1749106">(</span><span class="ident" id="1749107"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1749108">.</span><span class="ident" id="1749109">log</span><span class="op" id="1749112">[</span><span class="ident" id="1749113"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1749114">.</span><span class="ident" id="1749115">toggle</span><span class="op" id="1749121">]</span><span class="op" id="1749122">[</span><span class="op" id="1749123">:</span><span class="ident" id="1749124"><a href="/runtime/cpuprof.go.html#1749060">n</a></span><span class="op" id="1749125">]</span><span class="op" id="1749126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1749133">//&nbsp;Made&nbsp;it&nbsp;through&nbsp;the&nbsp;table&nbsp;without&nbsp;finding&nbsp;anything&nbsp;to&nbsp;log.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749196">if</span>&nbsp;<span class="op" id="1749199">!</span><span class="ident" id="1749200"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1749201">.</span><span class="ident" id="1749202">eodSent</span>&nbsp;<span class="op" id="1749210">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1749214">//&nbsp;We&nbsp;may&nbsp;not&nbsp;have&nbsp;space&nbsp;to&nbsp;append&nbsp;this&nbsp;to&nbsp;the&nbsp;partial&nbsp;log&nbsp;buf,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1749280">//&nbsp;so&nbsp;we&nbsp;always&nbsp;return&nbsp;a&nbsp;new&nbsp;slice&nbsp;for&nbsp;the&nbsp;end-of-data&nbsp;marker.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749345"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1749346">.</span><span class="ident" id="1749347">eodSent</span>&nbsp;<span class="op" id="1749355">=</span>&nbsp;<span class="ident" id="1749357">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749364">return</span>&nbsp;<span class="ident" id="1749371"><a href="/runtime/cpuprof.go.html#1749578">uintptrBytes</a></span><span class="op" id="1749383">(</span><span class="ident" id="1749384"><a href="/runtime/cpuprof.go.html#1742281">eod</a></span><span class="op" id="1749387">[</span><span class="op" id="1749388">:</span><span class="op" id="1749389">]</span><span class="op" id="1749390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749393">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1749397">//&nbsp;Finally&nbsp;done.&nbsp;&nbsp;Clean&nbsp;up&nbsp;and&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749441"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1749442">.</span><span class="ident" id="1749443">flushing</span>&nbsp;<span class="op" id="1749452">=</span>&nbsp;<span class="ident" id="1749454">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749461">if</span>&nbsp;<span class="op" id="1749464">!</span><span class="ident" id="1749465"><a href="/runtime/stubs.go.html#1974711">cas</a></span><span class="op" id="1749468">(</span><span class="op" id="1749469">&amp;</span><span class="ident" id="1749470"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1749471">.</span><span class="ident" id="1749472">handoff</span><span class="op" id="1749479">,</span>&nbsp;<span class="ident" id="1749481"><a href="/runtime/cpuprof.go.html#1747504">p</a></span><span class="op" id="1749482">.</span><span class="ident" id="1749483">handoff</span><span class="op" id="1749490">,</span>&nbsp;<span class="num" id="1749492">0</span><span class="op" id="1749493">)</span>&nbsp;<span class="op" id="1749495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1749499">print</span><span class="op" id="1749504">(</span><span class="string" id="1749505">&#34;runtime:&nbsp;profile&nbsp;flush&nbsp;racing&nbsp;with&nbsp;something\n&#34;</span><span class="op" id="1749553">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1749556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749559">return</span>&nbsp;<span class="ident" id="1749566">nil</span><br>
<span class="lineno"></span><span class="op" id="1749570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1749573">func</span>&nbsp;<span class="ident" id="1749578">uintptrBytes</span><span class="op" id="1749590">(</span><span class="ident" id="1749591">p</span>&nbsp;<span class="op" id="1749593">[</span><span class="op" id="1749594">]</span><span class="builtintype" id="1749595">uintptr</span><span class="op" id="1749602">)</span>&nbsp;<span class="op" id="1749604">(</span><span class="ident" id="1749605">ret</span>&nbsp;<span class="op" id="1749609">[</span><span class="op" id="1749610">]</span><span class="builtintype" id="1749611">byte</span><span class="op" id="1749615">)</span>&nbsp;<span class="op" id="1749617">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749620">pp</span>&nbsp;<span class="op" id="1749623">:=</span>&nbsp;<span class="op" id="1749626">(</span><span class="op" id="1749627">*</span><span class="ident" id="1749628"><a href="/runtime/slice.go.html#1943323">sliceStruct</a></span><span class="op" id="1749639">)</span><span class="op" id="1749640">(</span><span class="ident" id="1749641"><a href="/runtime/cpuprof.go.html#1741188">unsafe</a></span><span class="op" id="1749647">.</span><span class="ident" id="1749648">Pointer</span><span class="op" id="1749655">(</span><span class="op" id="1749656">&amp;</span><span class="ident" id="1749657"><a href="/runtime/cpuprof.go.html#1749591">p</a></span><span class="op" id="1749658">)</span><span class="op" id="1749659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749662">rp</span>&nbsp;<span class="op" id="1749665">:=</span>&nbsp;<span class="op" id="1749668">(</span><span class="op" id="1749669">*</span><span class="ident" id="1749670"><a href="/runtime/slice.go.html#1943323">sliceStruct</a></span><span class="op" id="1749681">)</span><span class="op" id="1749682">(</span><span class="ident" id="1749683"><a href="/runtime/cpuprof.go.html#1741188">unsafe</a></span><span class="op" id="1749689">.</span><span class="ident" id="1749690">Pointer</span><span class="op" id="1749697">(</span><span class="op" id="1749698">&amp;</span><span class="ident" id="1749699"><a href="/runtime/cpuprof.go.html#1749605">ret</a></span><span class="op" id="1749702">)</span><span class="op" id="1749703">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749707"><a href="/runtime/cpuprof.go.html#1749662">rp</a></span><span class="op" id="1749709">.</span><span class="ident" id="1749710">array</span>&nbsp;<span class="op" id="1749716">=</span>&nbsp;<span class="ident" id="1749718"><a href="/runtime/cpuprof.go.html#1749620">pp</a></span><span class="op" id="1749720">.</span><span class="ident" id="1749721">array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749728"><a href="/runtime/cpuprof.go.html#1749662">rp</a></span><span class="op" id="1749730">.</span><span class="builtinfunc" id="1749731">len</span>&nbsp;<span class="op" id="1749735">=</span>&nbsp;<span class="ident" id="1749737"><a href="/runtime/cpuprof.go.html#1749620">pp</a></span><span class="op" id="1749739">.</span><span class="builtinfunc" id="1749740">len</span>&nbsp;<span class="op" id="1749744">*</span>&nbsp;<span class="builtintype" id="1749746">int</span><span class="op" id="1749749">(</span><span class="ident" id="1749750"><a href="/runtime/cpuprof.go.html#1741188">unsafe</a></span><span class="op" id="1749756">.</span><span class="ident" id="1749757">Sizeof</span><span class="op" id="1749763">(</span><span class="ident" id="1749764"><a href="/runtime/cpuprof.go.html#1749591">p</a></span><span class="op" id="1749765">[</span><span class="num" id="1749766">0</span><span class="op" id="1749767">]</span><span class="op" id="1749768">)</span><span class="op" id="1749769">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1749772"><a href="/runtime/cpuprof.go.html#1749662">rp</a></span><span class="op" id="1749774">.</span><span class="builtinfunc" id="1749775">cap</span>&nbsp;<span class="op" id="1749779">=</span>&nbsp;<span class="ident" id="1749781"><a href="/runtime/cpuprof.go.html#1749662">rp</a></span><span class="op" id="1749783">.</span><span class="builtinfunc" id="1749784">len</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1749790">return</span><br>
<span class="lineno"></span><span class="op" id="1749797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="1749800">//&nbsp;CPUProfile&nbsp;returns&nbsp;the&nbsp;next&nbsp;chunk&nbsp;of&nbsp;binary&nbsp;CPU&nbsp;profiling&nbsp;stack&nbsp;trace&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="1749879">//&nbsp;blocking&nbsp;until&nbsp;data&nbsp;is&nbsp;available.&nbsp;&nbsp;If&nbsp;profiling&nbsp;is&nbsp;turned&nbsp;off&nbsp;and&nbsp;all&nbsp;the&nbsp;profile</span><br>
<span class="lineno"></span><span class="comment" id="1749964">//&nbsp;data&nbsp;accumulated&nbsp;while&nbsp;it&nbsp;was&nbsp;on&nbsp;has&nbsp;been&nbsp;returned,&nbsp;CPUProfile&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1750043">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;save&nbsp;the&nbsp;returned&nbsp;data&nbsp;before&nbsp;calling&nbsp;CPUProfile&nbsp;again.</span><br>
<span class="lineno"></span><span class="comment" id="1750118">//</span><br>
<span class="lineno">420</span><span class="comment" id="1750121">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1750177">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.cpuprofile&nbsp;flag&nbsp;instead&nbsp;of&nbsp;calling</span><br>
<span class="lineno"></span><span class="comment" id="1750243">//&nbsp;CPUProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1750267">func</span>&nbsp;<span class="ident" id="1750272">CPUProfile</span><span class="op" id="1750282">(</span><span class="op" id="1750283">)</span>&nbsp;<span class="op" id="1750285">[</span><span class="op" id="1750286">]</span><span class="builtintype" id="1750287">byte</span>&nbsp;<span class="op" id="1750292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1750295">return</span>&nbsp;<span class="ident" id="1750302"><a href="/runtime/cpuprof.go.html#1742255">cpuprof</a></span><span class="op" id="1750309">.</span><span class="ident" id="1750310">getprofile</span><span class="op" id="1750320">(</span><span class="op" id="1750321">)</span><br>
<span class="lineno">425</span><span class="op" id="1750323">}</span>
</div>
</body>
</html>
