<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html" class="current">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6033089">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6033144">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6033198">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6033249">package</span>&nbsp;<span class="ident" id="6033257">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6033263">import</span>&nbsp;<span class="op" id="6033270">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6033273">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6033278">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="6033281">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="6033359">const</span>&nbsp;<span class="ident" id="6033365">maxCodeLength</span>&nbsp;<span class="op" id="6033379">=</span>&nbsp;<span class="num" id="6033381">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6033385">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="6033460">const</span>&nbsp;<span class="ident" id="6033466">maxNCodes</span>&nbsp;<span class="op" id="6033476">=</span>&nbsp;<span class="num" id="6033478">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6033483">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="6033552">const</span>&nbsp;<span class="ident" id="6033558">lutSize</span>&nbsp;<span class="op" id="6033566">=</span>&nbsp;<span class="num" id="6033568">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6033571">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="6033628">type</span>&nbsp;<span class="ident" id="6033633">huffman</span>&nbsp;<span class="keyword" id="6033641">struct</span>&nbsp;<span class="op" id="6033648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6033651">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033698">nCodes</span>&nbsp;<span class="builtintype" id="6033705">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6033712">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6033786">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6033858">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6033931">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6033949">lut</span>&nbsp;<span class="op" id="6033953">[</span><span class="num" id="6033954">1</span>&nbsp;<span class="op" id="6033956">&lt;&lt;</span>&nbsp;<span class="ident" id="6033959">lutSize</span><span class="op" id="6033966">]</span><span class="builtintype" id="6033967">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6033975">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034034">vals</span>&nbsp;<span class="op" id="6034039">[</span><span class="ident" id="6034040">maxNCodes</span><span class="op" id="6034049">]</span><span class="builtintype" id="6034050">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6034057">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6034128">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034154">minCodes</span>&nbsp;<span class="op" id="6034163">[</span><span class="ident" id="6034164">maxCodeLength</span><span class="op" id="6034177">]</span><span class="builtintype" id="6034178">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6034185">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6034256">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034282">maxCodes</span>&nbsp;<span class="op" id="6034291">[</span><span class="ident" id="6034292">maxCodeLength</span><span class="op" id="6034305">]</span><span class="builtintype" id="6034306">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6034313">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034371">valsIndices</span>&nbsp;<span class="op" id="6034383">[</span><span class="ident" id="6034384">maxCodeLength</span><span class="op" id="6034397">]</span><span class="builtintype" id="6034398">int32</span><br>
<span class="lineno"></span><span class="op" id="6034404">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="6034407">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="6034483">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6034500">var</span>&nbsp;<span class="ident" id="6034504">errShortHuffmanData</span>&nbsp;<span class="op" id="6034524">=</span>&nbsp;<span class="ident" id="6034526">FormatError</span><span class="op" id="6034537">(</span><span class="string" id="6034538">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="6034558">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6034561">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6034639">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="6034716">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="6034791">func</span>&nbsp;<span class="op" id="6034796">(</span><span class="ident" id="6034797">d</span>&nbsp;<span class="op" id="6034799">*</span><span class="ident" id="6034800">decoder</span><span class="op" id="6034807">)</span>&nbsp;<span class="ident" id="6034809">ensureNBits</span><span class="op" id="6034820">(</span><span class="ident" id="6034821">n</span>&nbsp;<span class="builtintype" id="6034823">int32</span><span class="op" id="6034828">)</span>&nbsp;<span class="builtintype" id="6034830">error</span>&nbsp;<span class="op" id="6034836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034839">for</span>&nbsp;<span class="op" id="6034843">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034847">c</span><span class="op" id="6034848">,</span>&nbsp;<span class="ident" id="6034850">err</span>&nbsp;<span class="op" id="6034854">:=</span>&nbsp;<span class="ident" id="6034857">d</span><span class="op" id="6034858">.</span><span class="ident" id="6034859">readByteStuffedByte</span><span class="op" id="6034878">(</span><span class="op" id="6034879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034883">if</span>&nbsp;<span class="ident" id="6034886">err</span>&nbsp;<span class="op" id="6034890">!=</span>&nbsp;<span class="ident" id="6034893">nil</span>&nbsp;<span class="op" id="6034897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034902">if</span>&nbsp;<span class="ident" id="6034905">err</span>&nbsp;<span class="op" id="6034909">==</span>&nbsp;<span class="ident" id="6034912">io</span><span class="op" id="6034914">.</span><span class="ident" id="6034915">EOF</span>&nbsp;<span class="op" id="6034919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034925">return</span>&nbsp;<span class="ident" id="6034932">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6034955">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6034960">return</span>&nbsp;<span class="ident" id="6034967">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6034973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6034977">d</span><span class="op" id="6034978">.</span><span class="ident" id="6034979">bits</span><span class="op" id="6034983">.</span><span class="ident" id="6034984">a</span>&nbsp;<span class="op" id="6034986">=</span>&nbsp;<span class="ident" id="6034988">d</span><span class="op" id="6034989">.</span><span class="ident" id="6034990">bits</span><span class="op" id="6034994">.</span><span class="ident" id="6034995">a</span><span class="op" id="6034996">&lt;&lt;</span><span class="num" id="6034998">8</span>&nbsp;<span class="op" id="6035000">|</span>&nbsp;<span class="builtintype" id="6035002">uint32</span><span class="op" id="6035008">(</span><span class="ident" id="6035009">c</span><span class="op" id="6035010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035014">d</span><span class="op" id="6035015">.</span><span class="ident" id="6035016">bits</span><span class="op" id="6035020">.</span><span class="ident" id="6035021">n</span>&nbsp;<span class="op" id="6035023">+=</span>&nbsp;<span class="num" id="6035026">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035030">if</span>&nbsp;<span class="ident" id="6035033">d</span><span class="op" id="6035034">.</span><span class="ident" id="6035035">bits</span><span class="op" id="6035039">.</span><span class="ident" id="6035040">m</span>&nbsp;<span class="op" id="6035042">==</span>&nbsp;<span class="num" id="6035045">0</span>&nbsp;<span class="op" id="6035047">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035052">d</span><span class="op" id="6035053">.</span><span class="ident" id="6035054">bits</span><span class="op" id="6035058">.</span><span class="ident" id="6035059">m</span>&nbsp;<span class="op" id="6035061">=</span>&nbsp;<span class="num" id="6035063">1</span>&nbsp;<span class="op" id="6035065">&lt;&lt;</span>&nbsp;<span class="num" id="6035068">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6035072">}</span>&nbsp;<span class="keyword" id="6035074">else</span>&nbsp;<span class="op" id="6035079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035084">d</span><span class="op" id="6035085">.</span><span class="ident" id="6035086">bits</span><span class="op" id="6035090">.</span><span class="ident" id="6035091">m</span>&nbsp;<span class="op" id="6035093">&lt;&lt;=</span>&nbsp;<span class="num" id="6035097">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6035101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035105">if</span>&nbsp;<span class="ident" id="6035108">d</span><span class="op" id="6035109">.</span><span class="ident" id="6035110">bits</span><span class="op" id="6035114">.</span><span class="ident" id="6035115">n</span>&nbsp;<span class="op" id="6035117">&gt;=</span>&nbsp;<span class="ident" id="6035120">n</span>&nbsp;<span class="op" id="6035122">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035127">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6035135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6035138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035141">return</span>&nbsp;<span class="ident" id="6035148">nil</span><br>
<span class="lineno"></span><span class="op" id="6035152">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="6035155">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="6035235">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="6035247">func</span>&nbsp;<span class="op" id="6035252">(</span><span class="ident" id="6035253">d</span>&nbsp;<span class="op" id="6035255">*</span><span class="ident" id="6035256">decoder</span><span class="op" id="6035263">)</span>&nbsp;<span class="ident" id="6035265">receiveExtend</span><span class="op" id="6035278">(</span><span class="ident" id="6035279">t</span>&nbsp;<span class="builtintype" id="6035281">uint8</span><span class="op" id="6035286">)</span>&nbsp;<span class="op" id="6035288">(</span><span class="builtintype" id="6035289">int32</span><span class="op" id="6035294">,</span>&nbsp;<span class="builtintype" id="6035296">error</span><span class="op" id="6035301">)</span>&nbsp;<span class="op" id="6035303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035306">if</span>&nbsp;<span class="ident" id="6035309">d</span><span class="op" id="6035310">.</span><span class="ident" id="6035311">bits</span><span class="op" id="6035315">.</span><span class="ident" id="6035316">n</span>&nbsp;<span class="op" id="6035318">&lt;</span>&nbsp;<span class="builtintype" id="6035320">int32</span><span class="op" id="6035325">(</span><span class="ident" id="6035326">t</span><span class="op" id="6035327">)</span>&nbsp;<span class="op" id="6035329">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035333">if</span>&nbsp;<span class="ident" id="6035336">err</span>&nbsp;<span class="op" id="6035340">:=</span>&nbsp;<span class="ident" id="6035343">d</span><span class="op" id="6035344">.</span><span class="ident" id="6035345">ensureNBits</span><span class="op" id="6035356">(</span><span class="builtintype" id="6035357">int32</span><span class="op" id="6035362">(</span><span class="ident" id="6035363">t</span><span class="op" id="6035364">)</span><span class="op" id="6035365">)</span><span class="op" id="6035366">;</span>&nbsp;<span class="ident" id="6035368">err</span>&nbsp;<span class="op" id="6035372">!=</span>&nbsp;<span class="ident" id="6035375">nil</span>&nbsp;<span class="op" id="6035379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035384">return</span>&nbsp;<span class="num" id="6035391">0</span><span class="op" id="6035392">,</span>&nbsp;<span class="ident" id="6035394">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6035400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6035403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035406">d</span><span class="op" id="6035407">.</span><span class="ident" id="6035408">bits</span><span class="op" id="6035412">.</span><span class="ident" id="6035413">n</span>&nbsp;<span class="op" id="6035415">-=</span>&nbsp;<span class="builtintype" id="6035418">int32</span><span class="op" id="6035423">(</span><span class="ident" id="6035424">t</span><span class="op" id="6035425">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035428">d</span><span class="op" id="6035429">.</span><span class="ident" id="6035430">bits</span><span class="op" id="6035434">.</span><span class="ident" id="6035435">m</span>&nbsp;<span class="op" id="6035437">&gt;&gt;=</span>&nbsp;<span class="ident" id="6035441">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035444">s</span>&nbsp;<span class="op" id="6035446">:=</span>&nbsp;<span class="builtintype" id="6035449">int32</span><span class="op" id="6035454">(</span><span class="num" id="6035455">1</span><span class="op" id="6035456">)</span>&nbsp;<span class="op" id="6035458">&lt;&lt;</span>&nbsp;<span class="ident" id="6035461">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035464">x</span>&nbsp;<span class="op" id="6035466">:=</span>&nbsp;<span class="builtintype" id="6035469">int32</span><span class="op" id="6035474">(</span><span class="ident" id="6035475">d</span><span class="op" id="6035476">.</span><span class="ident" id="6035477">bits</span><span class="op" id="6035481">.</span><span class="ident" id="6035482">a</span><span class="op" id="6035483">&gt;&gt;</span><span class="builtintype" id="6035485">uint8</span><span class="op" id="6035490">(</span><span class="ident" id="6035491">d</span><span class="op" id="6035492">.</span><span class="ident" id="6035493">bits</span><span class="op" id="6035497">.</span><span class="ident" id="6035498">n</span><span class="op" id="6035499">)</span><span class="op" id="6035500">)</span>&nbsp;<span class="op" id="6035502">&amp;</span>&nbsp;<span class="op" id="6035504">(</span><span class="ident" id="6035505">s</span>&nbsp;<span class="op" id="6035507">-</span>&nbsp;<span class="num" id="6035509">1</span><span class="op" id="6035510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035513">if</span>&nbsp;<span class="ident" id="6035516">x</span>&nbsp;<span class="op" id="6035518">&lt;</span>&nbsp;<span class="ident" id="6035520">s</span><span class="op" id="6035521">&gt;&gt;</span><span class="num" id="6035523">1</span>&nbsp;<span class="op" id="6035525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035529">x</span>&nbsp;<span class="op" id="6035531">+=</span>&nbsp;<span class="op" id="6035534">(</span><span class="op" id="6035535">(</span><span class="op" id="6035536">-</span><span class="num" id="6035537">1</span><span class="op" id="6035538">)</span>&nbsp;<span class="op" id="6035540">&lt;&lt;</span>&nbsp;<span class="ident" id="6035543">t</span><span class="op" id="6035544">)</span>&nbsp;<span class="op" id="6035546">+</span>&nbsp;<span class="num" id="6035548">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6035551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035554">return</span>&nbsp;<span class="ident" id="6035561">x</span><span class="op" id="6035562">,</span>&nbsp;<span class="ident" id="6035564">nil</span><br>
<span class="lineno"></span><span class="op" id="6035568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6035571">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="6035652">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="6035711">func</span>&nbsp;<span class="op" id="6035716">(</span><span class="ident" id="6035717">d</span>&nbsp;<span class="op" id="6035719">*</span><span class="ident" id="6035720">decoder</span><span class="op" id="6035727">)</span>&nbsp;<span class="ident" id="6035729">processDHT</span><span class="op" id="6035739">(</span><span class="ident" id="6035740">n</span>&nbsp;<span class="builtintype" id="6035742">int</span><span class="op" id="6035745">)</span>&nbsp;<span class="builtintype" id="6035747">error</span>&nbsp;<span class="op" id="6035753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035756">for</span>&nbsp;<span class="ident" id="6035760">n</span>&nbsp;<span class="op" id="6035762">&gt;</span>&nbsp;<span class="num" id="6035764">0</span>&nbsp;<span class="op" id="6035766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035770">if</span>&nbsp;<span class="ident" id="6035773">n</span>&nbsp;<span class="op" id="6035775">&lt;</span>&nbsp;<span class="num" id="6035777">17</span>&nbsp;<span class="op" id="6035780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035785">return</span>&nbsp;<span class="ident" id="6035792">FormatError</span><span class="op" id="6035803">(</span><span class="string" id="6035804">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6035826">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6035830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035834">if</span>&nbsp;<span class="ident" id="6035837">err</span>&nbsp;<span class="op" id="6035841">:=</span>&nbsp;<span class="ident" id="6035844">d</span><span class="op" id="6035845">.</span><span class="ident" id="6035846">readFull</span><span class="op" id="6035854">(</span><span class="ident" id="6035855">d</span><span class="op" id="6035856">.</span><span class="ident" id="6035857">tmp</span><span class="op" id="6035860">[</span><span class="op" id="6035861">:</span><span class="num" id="6035862">17</span><span class="op" id="6035864">]</span><span class="op" id="6035865">)</span><span class="op" id="6035866">;</span>&nbsp;<span class="ident" id="6035868">err</span>&nbsp;<span class="op" id="6035872">!=</span>&nbsp;<span class="ident" id="6035875">nil</span>&nbsp;<span class="op" id="6035879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035884">return</span>&nbsp;<span class="ident" id="6035891">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6035897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035901">tc</span>&nbsp;<span class="op" id="6035904">:=</span>&nbsp;<span class="ident" id="6035907">d</span><span class="op" id="6035908">.</span><span class="ident" id="6035909">tmp</span><span class="op" id="6035912">[</span><span class="num" id="6035913">0</span><span class="op" id="6035914">]</span>&nbsp;<span class="op" id="6035916">&gt;&gt;</span>&nbsp;<span class="num" id="6035919">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035923">if</span>&nbsp;<span class="ident" id="6035926">tc</span>&nbsp;<span class="op" id="6035929">&gt;</span>&nbsp;<span class="ident" id="6035931">maxTc</span>&nbsp;<span class="op" id="6035937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6035942">return</span>&nbsp;<span class="ident" id="6035949">FormatError</span><span class="op" id="6035960">(</span><span class="string" id="6035961">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="6035975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6035979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6035983">th</span>&nbsp;<span class="op" id="6035986">:=</span>&nbsp;<span class="ident" id="6035989">d</span><span class="op" id="6035990">.</span><span class="ident" id="6035991">tmp</span><span class="op" id="6035994">[</span><span class="num" id="6035995">0</span><span class="op" id="6035996">]</span>&nbsp;<span class="op" id="6035998">&amp;</span>&nbsp;<span class="num" id="6036000">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036007">if</span>&nbsp;<span class="ident" id="6036010">th</span>&nbsp;<span class="op" id="6036013">&gt;</span>&nbsp;<span class="ident" id="6036015">maxTh</span>&nbsp;<span class="op" id="6036021">||</span>&nbsp;<span class="op" id="6036024">!</span><span class="ident" id="6036025">d</span><span class="op" id="6036026">.</span><span class="ident" id="6036027">progressive</span>&nbsp;<span class="op" id="6036039">&amp;&amp;</span>&nbsp;<span class="ident" id="6036042">th</span>&nbsp;<span class="op" id="6036045">&gt;</span>&nbsp;<span class="num" id="6036047">1</span>&nbsp;<span class="op" id="6036049">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036054">return</span>&nbsp;<span class="ident" id="6036061">FormatError</span><span class="op" id="6036072">(</span><span class="string" id="6036073">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="6036087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6036091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036095">h</span>&nbsp;<span class="op" id="6036097">:=</span>&nbsp;<span class="op" id="6036100">&amp;</span><span class="ident" id="6036101">d</span><span class="op" id="6036102">.</span><span class="ident" id="6036103">huff</span><span class="op" id="6036107">[</span><span class="ident" id="6036108">tc</span><span class="op" id="6036110">]</span><span class="op" id="6036111">[</span><span class="ident" id="6036112">th</span><span class="op" id="6036114">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036119">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036170">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036228">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036272">h</span><span class="op" id="6036273">.</span><span class="ident" id="6036274">nCodes</span>&nbsp;<span class="op" id="6036281">=</span>&nbsp;<span class="num" id="6036283">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036287">var</span>&nbsp;<span class="ident" id="6036291">nCodes</span>&nbsp;<span class="op" id="6036298">[</span><span class="ident" id="6036299">maxCodeLength</span><span class="op" id="6036312">]</span><span class="builtintype" id="6036313">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036321">for</span>&nbsp;<span class="ident" id="6036325">i</span>&nbsp;<span class="op" id="6036327">:=</span>&nbsp;<span class="keyword" id="6036330">range</span>&nbsp;<span class="ident" id="6036336">nCodes</span>&nbsp;<span class="op" id="6036343">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036348">nCodes</span><span class="op" id="6036354">[</span><span class="ident" id="6036355">i</span><span class="op" id="6036356">]</span>&nbsp;<span class="op" id="6036358">=</span>&nbsp;<span class="builtintype" id="6036360">int32</span><span class="op" id="6036365">(</span><span class="ident" id="6036366">d</span><span class="op" id="6036367">.</span><span class="ident" id="6036368">tmp</span><span class="op" id="6036371">[</span><span class="ident" id="6036372">i</span><span class="op" id="6036373">+</span><span class="num" id="6036374">1</span><span class="op" id="6036375">]</span><span class="op" id="6036376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036381">h</span><span class="op" id="6036382">.</span><span class="ident" id="6036383">nCodes</span>&nbsp;<span class="op" id="6036390">+=</span>&nbsp;<span class="ident" id="6036393">nCodes</span><span class="op" id="6036399">[</span><span class="ident" id="6036400">i</span><span class="op" id="6036401">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6036405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036409">if</span>&nbsp;<span class="ident" id="6036412">h</span><span class="op" id="6036413">.</span><span class="ident" id="6036414">nCodes</span>&nbsp;<span class="op" id="6036421">==</span>&nbsp;<span class="num" id="6036424">0</span>&nbsp;<span class="op" id="6036426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036431">return</span>&nbsp;<span class="ident" id="6036438">FormatError</span><span class="op" id="6036449">(</span><span class="string" id="6036450">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="6036481">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6036485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036489">if</span>&nbsp;<span class="ident" id="6036492">h</span><span class="op" id="6036493">.</span><span class="ident" id="6036494">nCodes</span>&nbsp;<span class="op" id="6036501">&gt;</span>&nbsp;<span class="ident" id="6036503">maxNCodes</span>&nbsp;<span class="op" id="6036513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036518">return</span>&nbsp;<span class="ident" id="6036525">FormatError</span><span class="op" id="6036536">(</span><span class="string" id="6036537">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="6036573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6036577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036581">n</span>&nbsp;<span class="op" id="6036583">-=</span>&nbsp;<span class="builtintype" id="6036586">int</span><span class="op" id="6036589">(</span><span class="ident" id="6036590">h</span><span class="op" id="6036591">.</span><span class="ident" id="6036592">nCodes</span><span class="op" id="6036598">)</span>&nbsp;<span class="op" id="6036600">+</span>&nbsp;<span class="num" id="6036602">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036607">if</span>&nbsp;<span class="ident" id="6036610">n</span>&nbsp;<span class="op" id="6036612">&lt;</span>&nbsp;<span class="num" id="6036614">0</span>&nbsp;<span class="op" id="6036616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036621">return</span>&nbsp;<span class="ident" id="6036628">FormatError</span><span class="op" id="6036639">(</span><span class="string" id="6036640">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="6036662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6036666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036670">if</span>&nbsp;<span class="ident" id="6036673">err</span>&nbsp;<span class="op" id="6036677">:=</span>&nbsp;<span class="ident" id="6036680">d</span><span class="op" id="6036681">.</span><span class="ident" id="6036682">readFull</span><span class="op" id="6036690">(</span><span class="ident" id="6036691">h</span><span class="op" id="6036692">.</span><span class="ident" id="6036693">vals</span><span class="op" id="6036697">[</span><span class="op" id="6036698">:</span><span class="ident" id="6036699">h</span><span class="op" id="6036700">.</span><span class="ident" id="6036701">nCodes</span><span class="op" id="6036707">]</span><span class="op" id="6036708">)</span><span class="op" id="6036709">;</span>&nbsp;<span class="ident" id="6036711">err</span>&nbsp;<span class="op" id="6036715">!=</span>&nbsp;<span class="ident" id="6036718">nil</span>&nbsp;<span class="op" id="6036722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036727">return</span>&nbsp;<span class="ident" id="6036734">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6036740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036745">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036776">for</span>&nbsp;<span class="ident" id="6036780">i</span>&nbsp;<span class="op" id="6036782">:=</span>&nbsp;<span class="keyword" id="6036785">range</span>&nbsp;<span class="ident" id="6036791">h</span><span class="op" id="6036792">.</span><span class="ident" id="6036793">lut</span>&nbsp;<span class="op" id="6036797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036802">h</span><span class="op" id="6036803">.</span><span class="ident" id="6036804">lut</span><span class="op" id="6036807">[</span><span class="ident" id="6036808">i</span><span class="op" id="6036809">]</span>&nbsp;<span class="op" id="6036811">=</span>&nbsp;<span class="num" id="6036813">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6036817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036821">var</span>&nbsp;<span class="ident" id="6036825">x</span><span class="op" id="6036826">,</span>&nbsp;<span class="ident" id="6036828">code</span>&nbsp;<span class="builtintype" id="6036833">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036842">for</span>&nbsp;<span class="ident" id="6036846">i</span>&nbsp;<span class="op" id="6036848">:=</span>&nbsp;<span class="builtintype" id="6036851">uint32</span><span class="op" id="6036857">(</span><span class="num" id="6036858">0</span><span class="op" id="6036859">)</span><span class="op" id="6036860">;</span>&nbsp;<span class="ident" id="6036862">i</span>&nbsp;<span class="op" id="6036864">&lt;</span>&nbsp;<span class="ident" id="6036866">lutSize</span><span class="op" id="6036873">;</span>&nbsp;<span class="ident" id="6036875">i</span><span class="op" id="6036876">++</span>&nbsp;<span class="op" id="6036879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6036884">code</span>&nbsp;<span class="op" id="6036889">&lt;&lt;=</span>&nbsp;<span class="num" id="6036893">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6036898">for</span>&nbsp;<span class="ident" id="6036902">j</span>&nbsp;<span class="op" id="6036904">:=</span>&nbsp;<span class="builtintype" id="6036907">int32</span><span class="op" id="6036912">(</span><span class="num" id="6036913">0</span><span class="op" id="6036914">)</span><span class="op" id="6036915">;</span>&nbsp;<span class="ident" id="6036917">j</span>&nbsp;<span class="op" id="6036919">&lt;</span>&nbsp;<span class="ident" id="6036921">nCodes</span><span class="op" id="6036927">[</span><span class="ident" id="6036928">i</span><span class="op" id="6036929">]</span><span class="op" id="6036930">;</span>&nbsp;<span class="ident" id="6036932">j</span><span class="op" id="6036933">++</span>&nbsp;<span class="op" id="6036936">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6036942">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6037000">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6037056">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6037106">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6037164">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037213">base</span>&nbsp;<span class="op" id="6037218">:=</span>&nbsp;<span class="builtintype" id="6037221">uint8</span><span class="op" id="6037226">(</span><span class="ident" id="6037227">code</span>&nbsp;<span class="op" id="6037232">&lt;&lt;</span>&nbsp;<span class="op" id="6037235">(</span><span class="num" id="6037236">7</span>&nbsp;<span class="op" id="6037238">-</span>&nbsp;<span class="ident" id="6037240">i</span><span class="op" id="6037241">)</span><span class="op" id="6037242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037248">lutValue</span>&nbsp;<span class="op" id="6037257">:=</span>&nbsp;<span class="builtintype" id="6037260">uint16</span><span class="op" id="6037266">(</span><span class="ident" id="6037267">h</span><span class="op" id="6037268">.</span><span class="ident" id="6037269">vals</span><span class="op" id="6037273">[</span><span class="ident" id="6037274">x</span><span class="op" id="6037275">]</span><span class="op" id="6037276">)</span><span class="op" id="6037277">&lt;&lt;</span><span class="num" id="6037279">8</span>&nbsp;<span class="op" id="6037281">|</span>&nbsp;<span class="builtintype" id="6037283">uint16</span><span class="op" id="6037289">(</span><span class="num" id="6037290">2</span><span class="op" id="6037291">+</span><span class="ident" id="6037292">i</span><span class="op" id="6037293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037299">for</span>&nbsp;<span class="ident" id="6037303">k</span>&nbsp;<span class="op" id="6037305">:=</span>&nbsp;<span class="builtintype" id="6037308">uint8</span><span class="op" id="6037313">(</span><span class="num" id="6037314">0</span><span class="op" id="6037315">)</span><span class="op" id="6037316">;</span>&nbsp;<span class="ident" id="6037318">k</span>&nbsp;<span class="op" id="6037320">&lt;</span>&nbsp;<span class="num" id="6037322">1</span><span class="op" id="6037323">&lt;&lt;</span><span class="op" id="6037325">(</span><span class="num" id="6037326">7</span><span class="op" id="6037327">-</span><span class="ident" id="6037328">i</span><span class="op" id="6037329">)</span><span class="op" id="6037330">;</span>&nbsp;<span class="ident" id="6037332">k</span><span class="op" id="6037333">++</span>&nbsp;<span class="op" id="6037336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037343">h</span><span class="op" id="6037344">.</span><span class="ident" id="6037345">lut</span><span class="op" id="6037348">[</span><span class="ident" id="6037349">base</span><span class="op" id="6037353">|</span><span class="ident" id="6037354">k</span><span class="op" id="6037355">]</span>&nbsp;<span class="op" id="6037357">=</span>&nbsp;<span class="ident" id="6037359">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037372">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037378">code</span><span class="op" id="6037382">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037389">x</span><span class="op" id="6037390">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6037405">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037454">var</span>&nbsp;<span class="ident" id="6037458">c</span><span class="op" id="6037459">,</span>&nbsp;<span class="ident" id="6037461">index</span>&nbsp;<span class="builtintype" id="6037467">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037475">for</span>&nbsp;<span class="ident" id="6037479">i</span><span class="op" id="6037480">,</span>&nbsp;<span class="ident" id="6037482">n</span>&nbsp;<span class="op" id="6037484">:=</span>&nbsp;<span class="keyword" id="6037487">range</span>&nbsp;<span class="ident" id="6037493">nCodes</span>&nbsp;<span class="op" id="6037500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037505">if</span>&nbsp;<span class="ident" id="6037508">n</span>&nbsp;<span class="op" id="6037510">==</span>&nbsp;<span class="num" id="6037513">0</span>&nbsp;<span class="op" id="6037515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037521">h</span><span class="op" id="6037522">.</span><span class="ident" id="6037523">minCodes</span><span class="op" id="6037531">[</span><span class="ident" id="6037532">i</span><span class="op" id="6037533">]</span>&nbsp;<span class="op" id="6037535">=</span>&nbsp;<span class="op" id="6037537">-</span><span class="num" id="6037538">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037544">h</span><span class="op" id="6037545">.</span><span class="ident" id="6037546">maxCodes</span><span class="op" id="6037554">[</span><span class="ident" id="6037555">i</span><span class="op" id="6037556">]</span>&nbsp;<span class="op" id="6037558">=</span>&nbsp;<span class="op" id="6037560">-</span><span class="num" id="6037561">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037567">h</span><span class="op" id="6037568">.</span><span class="ident" id="6037569">valsIndices</span><span class="op" id="6037580">[</span><span class="ident" id="6037581">i</span><span class="op" id="6037582">]</span>&nbsp;<span class="op" id="6037584">=</span>&nbsp;<span class="op" id="6037586">-</span><span class="num" id="6037587">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037592">}</span>&nbsp;<span class="keyword" id="6037594">else</span>&nbsp;<span class="op" id="6037599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037605">h</span><span class="op" id="6037606">.</span><span class="ident" id="6037607">minCodes</span><span class="op" id="6037615">[</span><span class="ident" id="6037616">i</span><span class="op" id="6037617">]</span>&nbsp;<span class="op" id="6037619">=</span>&nbsp;<span class="ident" id="6037621">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037627">h</span><span class="op" id="6037628">.</span><span class="ident" id="6037629">maxCodes</span><span class="op" id="6037637">[</span><span class="ident" id="6037638">i</span><span class="op" id="6037639">]</span>&nbsp;<span class="op" id="6037641">=</span>&nbsp;<span class="ident" id="6037643">c</span>&nbsp;<span class="op" id="6037645">+</span>&nbsp;<span class="ident" id="6037647">n</span>&nbsp;<span class="op" id="6037649">-</span>&nbsp;<span class="num" id="6037651">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037657">h</span><span class="op" id="6037658">.</span><span class="ident" id="6037659">valsIndices</span><span class="op" id="6037670">[</span><span class="ident" id="6037671">i</span><span class="op" id="6037672">]</span>&nbsp;<span class="op" id="6037674">=</span>&nbsp;<span class="ident" id="6037676">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037686">c</span>&nbsp;<span class="op" id="6037688">+=</span>&nbsp;<span class="ident" id="6037691">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037697">index</span>&nbsp;<span class="op" id="6037703">+=</span>&nbsp;<span class="ident" id="6037706">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6037716">c</span>&nbsp;<span class="op" id="6037718">&lt;&lt;=</span>&nbsp;<span class="num" id="6037722">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037732">return</span>&nbsp;<span class="ident" id="6037739">nil</span><br>
<span class="lineno"></span><span class="op" id="6037743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="6037746">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="6037821">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="6037848">func</span>&nbsp;<span class="op" id="6037853">(</span><span class="ident" id="6037854">d</span>&nbsp;<span class="op" id="6037856">*</span><span class="ident" id="6037857">decoder</span><span class="op" id="6037864">)</span>&nbsp;<span class="ident" id="6037866">decodeHuffman</span><span class="op" id="6037879">(</span><span class="ident" id="6037880">h</span>&nbsp;<span class="op" id="6037882">*</span><span class="ident" id="6037883">huffman</span><span class="op" id="6037890">)</span>&nbsp;<span class="op" id="6037892">(</span><span class="builtintype" id="6037893">uint8</span><span class="op" id="6037898">,</span>&nbsp;<span class="builtintype" id="6037900">error</span><span class="op" id="6037905">)</span>&nbsp;<span class="op" id="6037907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037910">if</span>&nbsp;<span class="ident" id="6037913">h</span><span class="op" id="6037914">.</span><span class="ident" id="6037915">nCodes</span>&nbsp;<span class="op" id="6037922">==</span>&nbsp;<span class="num" id="6037925">0</span>&nbsp;<span class="op" id="6037927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037931">return</span>&nbsp;<span class="num" id="6037938">0</span><span class="op" id="6037939">,</span>&nbsp;<span class="ident" id="6037941">FormatError</span><span class="op" id="6037952">(</span><span class="string" id="6037953">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="6037982">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6037985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6037989">if</span>&nbsp;<span class="ident" id="6037992">d</span><span class="op" id="6037993">.</span><span class="ident" id="6037994">bits</span><span class="op" id="6037998">.</span><span class="ident" id="6037999">n</span>&nbsp;<span class="op" id="6038001">&lt;</span>&nbsp;<span class="num" id="6038003">8</span>&nbsp;<span class="op" id="6038005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038009">if</span>&nbsp;<span class="ident" id="6038012">err</span>&nbsp;<span class="op" id="6038016">:=</span>&nbsp;<span class="ident" id="6038019">d</span><span class="op" id="6038020">.</span><span class="ident" id="6038021">ensureNBits</span><span class="op" id="6038032">(</span><span class="num" id="6038033">8</span><span class="op" id="6038034">)</span><span class="op" id="6038035">;</span>&nbsp;<span class="ident" id="6038037">err</span>&nbsp;<span class="op" id="6038041">!=</span>&nbsp;<span class="ident" id="6038044">nil</span>&nbsp;<span class="op" id="6038048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038053">if</span>&nbsp;<span class="ident" id="6038056">err</span>&nbsp;<span class="op" id="6038060">!=</span>&nbsp;<span class="ident" id="6038063">errMissingFF00</span>&nbsp;<span class="op" id="6038078">&amp;&amp;</span>&nbsp;<span class="ident" id="6038081">err</span>&nbsp;<span class="op" id="6038085">!=</span>&nbsp;<span class="ident" id="6038088">errShortHuffmanData</span>&nbsp;<span class="op" id="6038108">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038114">return</span>&nbsp;<span class="num" id="6038121">0</span><span class="op" id="6038122">,</span>&nbsp;<span class="ident" id="6038124">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6038136">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6038208">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6038279">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038342">d</span><span class="op" id="6038343">.</span><span class="ident" id="6038344">unreadByteStuffedByte</span><span class="op" id="6038365">(</span><span class="op" id="6038366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038371">goto</span>&nbsp;<span class="ident" id="6038376">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038393">if</span>&nbsp;<span class="ident" id="6038396">v</span>&nbsp;<span class="op" id="6038398">:=</span>&nbsp;<span class="ident" id="6038401">h</span><span class="op" id="6038402">.</span><span class="ident" id="6038403">lut</span><span class="op" id="6038406">[</span><span class="op" id="6038407">(</span><span class="ident" id="6038408">d</span><span class="op" id="6038409">.</span><span class="ident" id="6038410">bits</span><span class="op" id="6038414">.</span><span class="ident" id="6038415">a</span><span class="op" id="6038416">&gt;&gt;</span><span class="builtintype" id="6038418">uint32</span><span class="op" id="6038424">(</span><span class="ident" id="6038425">d</span><span class="op" id="6038426">.</span><span class="ident" id="6038427">bits</span><span class="op" id="6038431">.</span><span class="ident" id="6038432">n</span><span class="op" id="6038433">-</span><span class="ident" id="6038434">lutSize</span><span class="op" id="6038441">)</span><span class="op" id="6038442">)</span><span class="op" id="6038443">&amp;</span><span class="num" id="6038444">0xff</span><span class="op" id="6038448">]</span><span class="op" id="6038449">;</span>&nbsp;<span class="ident" id="6038451">v</span>&nbsp;<span class="op" id="6038453">!=</span>&nbsp;<span class="num" id="6038456">0</span>&nbsp;<span class="op" id="6038458">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038462">n</span>&nbsp;<span class="op" id="6038464">:=</span>&nbsp;<span class="op" id="6038467">(</span><span class="ident" id="6038468">v</span>&nbsp;<span class="op" id="6038470">&amp;</span>&nbsp;<span class="num" id="6038472">0xff</span><span class="op" id="6038476">)</span>&nbsp;<span class="op" id="6038478">-</span>&nbsp;<span class="num" id="6038480">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038484">d</span><span class="op" id="6038485">.</span><span class="ident" id="6038486">bits</span><span class="op" id="6038490">.</span><span class="ident" id="6038491">n</span>&nbsp;<span class="op" id="6038493">-=</span>&nbsp;<span class="builtintype" id="6038496">int32</span><span class="op" id="6038501">(</span><span class="ident" id="6038502">n</span><span class="op" id="6038503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038507">d</span><span class="op" id="6038508">.</span><span class="ident" id="6038509">bits</span><span class="op" id="6038513">.</span><span class="ident" id="6038514">m</span>&nbsp;<span class="op" id="6038516">&gt;&gt;=</span>&nbsp;<span class="ident" id="6038520">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038524">return</span>&nbsp;<span class="builtintype" id="6038531">uint8</span><span class="op" id="6038536">(</span><span class="ident" id="6038537">v</span>&nbsp;<span class="op" id="6038539">&gt;&gt;</span>&nbsp;<span class="num" id="6038542">8</span><span class="op" id="6038543">)</span><span class="op" id="6038544">,</span>&nbsp;<span class="ident" id="6038546">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038551">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="6038554">slowPath</span><span class="op" id="6038562">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038565">for</span>&nbsp;<span class="ident" id="6038569">i</span><span class="op" id="6038570">,</span>&nbsp;<span class="ident" id="6038572">code</span>&nbsp;<span class="op" id="6038577">:=</span>&nbsp;<span class="num" id="6038580">0</span><span class="op" id="6038581">,</span>&nbsp;<span class="builtintype" id="6038583">int32</span><span class="op" id="6038588">(</span><span class="num" id="6038589">0</span><span class="op" id="6038590">)</span><span class="op" id="6038591">;</span>&nbsp;<span class="ident" id="6038593">i</span>&nbsp;<span class="op" id="6038595">&lt;</span>&nbsp;<span class="ident" id="6038597">maxCodeLength</span><span class="op" id="6038610">;</span>&nbsp;<span class="ident" id="6038612">i</span><span class="op" id="6038613">++</span>&nbsp;<span class="op" id="6038616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038620">if</span>&nbsp;<span class="ident" id="6038623">d</span><span class="op" id="6038624">.</span><span class="ident" id="6038625">bits</span><span class="op" id="6038629">.</span><span class="ident" id="6038630">n</span>&nbsp;<span class="op" id="6038632">==</span>&nbsp;<span class="num" id="6038635">0</span>&nbsp;<span class="op" id="6038637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038642">if</span>&nbsp;<span class="ident" id="6038645">err</span>&nbsp;<span class="op" id="6038649">:=</span>&nbsp;<span class="ident" id="6038652">d</span><span class="op" id="6038653">.</span><span class="ident" id="6038654">ensureNBits</span><span class="op" id="6038665">(</span><span class="num" id="6038666">1</span><span class="op" id="6038667">)</span><span class="op" id="6038668">;</span>&nbsp;<span class="ident" id="6038670">err</span>&nbsp;<span class="op" id="6038674">!=</span>&nbsp;<span class="ident" id="6038677">nil</span>&nbsp;<span class="op" id="6038681">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038687">return</span>&nbsp;<span class="num" id="6038694">0</span><span class="op" id="6038695">,</span>&nbsp;<span class="ident" id="6038697">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038712">if</span>&nbsp;<span class="ident" id="6038715">d</span><span class="op" id="6038716">.</span><span class="ident" id="6038717">bits</span><span class="op" id="6038721">.</span><span class="ident" id="6038722">a</span><span class="op" id="6038723">&amp;</span><span class="ident" id="6038724">d</span><span class="op" id="6038725">.</span><span class="ident" id="6038726">bits</span><span class="op" id="6038730">.</span><span class="ident" id="6038731">m</span>&nbsp;<span class="op" id="6038733">!=</span>&nbsp;<span class="num" id="6038736">0</span>&nbsp;<span class="op" id="6038738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038743">code</span>&nbsp;<span class="op" id="6038748">|=</span>&nbsp;<span class="num" id="6038751">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038759">d</span><span class="op" id="6038760">.</span><span class="ident" id="6038761">bits</span><span class="op" id="6038765">.</span><span class="ident" id="6038766">n</span><span class="op" id="6038767">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038772">d</span><span class="op" id="6038773">.</span><span class="ident" id="6038774">bits</span><span class="op" id="6038778">.</span><span class="ident" id="6038779">m</span>&nbsp;<span class="op" id="6038781">&gt;&gt;=</span>&nbsp;<span class="num" id="6038785">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038789">if</span>&nbsp;<span class="ident" id="6038792">code</span>&nbsp;<span class="op" id="6038797">&lt;=</span>&nbsp;<span class="ident" id="6038800">h</span><span class="op" id="6038801">.</span><span class="ident" id="6038802">maxCodes</span><span class="op" id="6038810">[</span><span class="ident" id="6038811">i</span><span class="op" id="6038812">]</span>&nbsp;<span class="op" id="6038814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038819">return</span>&nbsp;<span class="ident" id="6038826">h</span><span class="op" id="6038827">.</span><span class="ident" id="6038828">vals</span><span class="op" id="6038832">[</span><span class="ident" id="6038833">h</span><span class="op" id="6038834">.</span><span class="ident" id="6038835">valsIndices</span><span class="op" id="6038846">[</span><span class="ident" id="6038847">i</span><span class="op" id="6038848">]</span><span class="op" id="6038849">+</span><span class="ident" id="6038850">code</span><span class="op" id="6038854">-</span><span class="ident" id="6038855">h</span><span class="op" id="6038856">.</span><span class="ident" id="6038857">minCodes</span><span class="op" id="6038865">[</span><span class="ident" id="6038866">i</span><span class="op" id="6038867">]</span><span class="op" id="6038868">]</span><span class="op" id="6038869">,</span>&nbsp;<span class="ident" id="6038871">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6038881">code</span>&nbsp;<span class="op" id="6038886">&lt;&lt;=</span>&nbsp;<span class="num" id="6038890">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6038893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038896">return</span>&nbsp;<span class="num" id="6038903">0</span><span class="op" id="6038904">,</span>&nbsp;<span class="ident" id="6038906">FormatError</span><span class="op" id="6038917">(</span><span class="string" id="6038918">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="6038936">)</span><br>
<span class="lineno"></span><span class="op" id="6038938">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="6038941">func</span>&nbsp;<span class="op" id="6038946">(</span><span class="ident" id="6038947">d</span>&nbsp;<span class="op" id="6038949">*</span><span class="ident" id="6038950">decoder</span><span class="op" id="6038957">)</span>&nbsp;<span class="ident" id="6038959">decodeBit</span><span class="op" id="6038968">(</span><span class="op" id="6038969">)</span>&nbsp;<span class="op" id="6038971">(</span><span class="builtintype" id="6038972">bool</span><span class="op" id="6038976">,</span>&nbsp;<span class="builtintype" id="6038978">error</span><span class="op" id="6038983">)</span>&nbsp;<span class="op" id="6038985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6038988">if</span>&nbsp;<span class="ident" id="6038991">d</span><span class="op" id="6038992">.</span><span class="ident" id="6038993">bits</span><span class="op" id="6038997">.</span><span class="ident" id="6038998">n</span>&nbsp;<span class="op" id="6039000">==</span>&nbsp;<span class="num" id="6039003">0</span>&nbsp;<span class="op" id="6039005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039009">if</span>&nbsp;<span class="ident" id="6039012">err</span>&nbsp;<span class="op" id="6039016">:=</span>&nbsp;<span class="ident" id="6039019">d</span><span class="op" id="6039020">.</span><span class="ident" id="6039021">ensureNBits</span><span class="op" id="6039032">(</span><span class="num" id="6039033">1</span><span class="op" id="6039034">)</span><span class="op" id="6039035">;</span>&nbsp;<span class="ident" id="6039037">err</span>&nbsp;<span class="op" id="6039041">!=</span>&nbsp;<span class="ident" id="6039044">nil</span>&nbsp;<span class="op" id="6039048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039053">return</span>&nbsp;<span class="builtintype" id="6039060">false</span><span class="op" id="6039065">,</span>&nbsp;<span class="ident" id="6039067">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039079">ret</span>&nbsp;<span class="op" id="6039083">:=</span>&nbsp;<span class="ident" id="6039086">d</span><span class="op" id="6039087">.</span><span class="ident" id="6039088">bits</span><span class="op" id="6039092">.</span><span class="ident" id="6039093">a</span><span class="op" id="6039094">&amp;</span><span class="ident" id="6039095">d</span><span class="op" id="6039096">.</span><span class="ident" id="6039097">bits</span><span class="op" id="6039101">.</span><span class="ident" id="6039102">m</span>&nbsp;<span class="op" id="6039104">!=</span>&nbsp;<span class="num" id="6039107">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039110">d</span><span class="op" id="6039111">.</span><span class="ident" id="6039112">bits</span><span class="op" id="6039116">.</span><span class="ident" id="6039117">n</span><span class="op" id="6039118">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039122">d</span><span class="op" id="6039123">.</span><span class="ident" id="6039124">bits</span><span class="op" id="6039128">.</span><span class="ident" id="6039129">m</span>&nbsp;<span class="op" id="6039131">&gt;&gt;=</span>&nbsp;<span class="num" id="6039135">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039138">return</span>&nbsp;<span class="ident" id="6039145">ret</span><span class="op" id="6039148">,</span>&nbsp;<span class="ident" id="6039150">nil</span><br>
<span class="lineno"></span><span class="op" id="6039154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6039157">func</span>&nbsp;<span class="op" id="6039162">(</span><span class="ident" id="6039163">d</span>&nbsp;<span class="op" id="6039165">*</span><span class="ident" id="6039166">decoder</span><span class="op" id="6039173">)</span>&nbsp;<span class="ident" id="6039175">decodeBits</span><span class="op" id="6039185">(</span><span class="ident" id="6039186">n</span>&nbsp;<span class="builtintype" id="6039188">int32</span><span class="op" id="6039193">)</span>&nbsp;<span class="op" id="6039195">(</span><span class="builtintype" id="6039196">uint32</span><span class="op" id="6039202">,</span>&nbsp;<span class="builtintype" id="6039204">error</span><span class="op" id="6039209">)</span>&nbsp;<span class="op" id="6039211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039214">if</span>&nbsp;<span class="ident" id="6039217">d</span><span class="op" id="6039218">.</span><span class="ident" id="6039219">bits</span><span class="op" id="6039223">.</span><span class="ident" id="6039224">n</span>&nbsp;<span class="op" id="6039226">&lt;</span>&nbsp;<span class="ident" id="6039228">n</span>&nbsp;<span class="op" id="6039230">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039234">if</span>&nbsp;<span class="ident" id="6039237">err</span>&nbsp;<span class="op" id="6039241">:=</span>&nbsp;<span class="ident" id="6039244">d</span><span class="op" id="6039245">.</span><span class="ident" id="6039246">ensureNBits</span><span class="op" id="6039257">(</span><span class="ident" id="6039258">n</span><span class="op" id="6039259">)</span><span class="op" id="6039260">;</span>&nbsp;<span class="ident" id="6039262">err</span>&nbsp;<span class="op" id="6039266">!=</span>&nbsp;<span class="ident" id="6039269">nil</span>&nbsp;<span class="op" id="6039273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039278">return</span>&nbsp;<span class="num" id="6039285">0</span><span class="op" id="6039286">,</span>&nbsp;<span class="ident" id="6039288">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6039297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039300">ret</span>&nbsp;<span class="op" id="6039304">:=</span>&nbsp;<span class="ident" id="6039307">d</span><span class="op" id="6039308">.</span><span class="ident" id="6039309">bits</span><span class="op" id="6039313">.</span><span class="ident" id="6039314">a</span>&nbsp;<span class="op" id="6039316">&gt;&gt;</span>&nbsp;<span class="builtintype" id="6039319">uint32</span><span class="op" id="6039325">(</span><span class="ident" id="6039326">d</span><span class="op" id="6039327">.</span><span class="ident" id="6039328">bits</span><span class="op" id="6039332">.</span><span class="ident" id="6039333">n</span><span class="op" id="6039334">-</span><span class="ident" id="6039335">n</span><span class="op" id="6039336">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039339">ret</span>&nbsp;<span class="op" id="6039343">&amp;=</span>&nbsp;<span class="op" id="6039346">(</span><span class="num" id="6039347">1</span>&nbsp;<span class="op" id="6039349">&lt;&lt;</span>&nbsp;<span class="builtintype" id="6039352">uint32</span><span class="op" id="6039358">(</span><span class="ident" id="6039359">n</span><span class="op" id="6039360">)</span><span class="op" id="6039361">)</span>&nbsp;<span class="op" id="6039363">-</span>&nbsp;<span class="num" id="6039365">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039368">d</span><span class="op" id="6039369">.</span><span class="ident" id="6039370">bits</span><span class="op" id="6039374">.</span><span class="ident" id="6039375">n</span>&nbsp;<span class="op" id="6039377">-=</span>&nbsp;<span class="ident" id="6039380">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6039383">d</span><span class="op" id="6039384">.</span><span class="ident" id="6039385">bits</span><span class="op" id="6039389">.</span><span class="ident" id="6039390">m</span>&nbsp;<span class="op" id="6039392">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="6039396">uint32</span><span class="op" id="6039402">(</span><span class="ident" id="6039403">n</span><span class="op" id="6039404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6039407">return</span>&nbsp;<span class="ident" id="6039414">ret</span><span class="op" id="6039417">,</span>&nbsp;<span class="ident" id="6039419">nil</span><br>
<span class="lineno"></span><span class="op" id="6039423">}</span>
</div>
</body>
</html>
