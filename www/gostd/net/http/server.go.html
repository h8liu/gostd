<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3876878">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3876933">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3876987">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3877038">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3877070">package</span>&nbsp;<span class="ident" id="3877078">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3877084">import</span>&nbsp;<span class="op" id="3877091">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877094">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877103">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877117">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877127">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877134">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877140">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877153">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877160">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877167">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877178">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877184">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877192">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877203">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877214">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877225">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877233">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3877248">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3877255">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3877258">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="3877299">var</span>&nbsp;<span class="op" id="3877303">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877306">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="3877325">=</span>&nbsp;<span class="ident" id="3877327">errors</span><span class="op" id="3877333">.</span><span class="ident" id="3877334">New</span><span class="op" id="3877337">(</span><span class="string" id="3877338">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="3877369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877372">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="3877391">=</span>&nbsp;<span class="ident" id="3877393">errors</span><span class="op" id="3877399">.</span><span class="ident" id="3877400">New</span><span class="op" id="3877403">(</span><span class="string" id="3877404">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="3877470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877473">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3877492">=</span>&nbsp;<span class="ident" id="3877494">errors</span><span class="op" id="3877500">.</span><span class="ident" id="3877501">New</span><span class="op" id="3877504">(</span><span class="string" id="3877505">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="3877529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877532">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3877551">=</span>&nbsp;<span class="ident" id="3877553">errors</span><span class="op" id="3877559">.</span><span class="ident" id="3877560">New</span><span class="op" id="3877563">(</span><span class="string" id="3877564">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="3877620">)</span><br>
<span class="lineno">35</span><span class="op" id="3877622">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3877625">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3877678">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="3877730">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="3877753">//</span><br>
<span class="lineno"></span><span class="comment" id="3877756">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3877827">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3877895">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3877958">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="3877977">//</span><br>
<span class="lineno"></span><span class="comment" id="3877980">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="3878049">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3878117">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="3878187">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="3878219">//</span><br>
<span class="lineno"></span><span class="keyword" id="3878222">type</span>&nbsp;<span class="ident" id="3878227">Handler</span>&nbsp;<span class="keyword" id="3878235">interface</span>&nbsp;<span class="op" id="3878245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878248">ServeHTTP</span><span class="op" id="3878257">(</span><span class="ident" id="3878258">ResponseWriter</span><span class="op" id="3878272">,</span>&nbsp;<span class="op" id="3878274">*</span><span class="ident" id="3878275">Request</span><span class="op" id="3878282">)</span><br>
<span class="lineno"></span><span class="op" id="3878284">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3878287">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3878347">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3878378">type</span>&nbsp;<span class="ident" id="3878383">ResponseWriter</span>&nbsp;<span class="keyword" id="3878398">interface</span>&nbsp;<span class="op" id="3878408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878411">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878479">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878546">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878561">Header</span><span class="op" id="3878567">(</span><span class="op" id="3878568">)</span>&nbsp;<span class="ident" id="3878570">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878579">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878649">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878732">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878795">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878873">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878937">Write</span><span class="op" id="3878942">(</span><span class="op" id="3878943">[</span><span class="op" id="3878944">]</span><span class="builtintype" id="3878945">byte</span><span class="op" id="3878949">)</span>&nbsp;<span class="op" id="3878951">(</span><span class="builtintype" id="3878952">int</span><span class="op" id="3878955">,</span>&nbsp;<span class="builtintype" id="3878957">error</span><span class="op" id="3878962">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878966">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879030">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879099">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879156">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879214">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879236">WriteHeader</span><span class="op" id="3879247">(</span><span class="builtintype" id="3879248">int</span><span class="op" id="3879251">)</span><br>
<span class="lineno"></span><span class="op" id="3879253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3879256">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3879326">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="3879383">//</span><br>
<span class="lineno"></span><span class="comment" id="3879386">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="3879444">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3879497">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3879562">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="3879576">type</span>&nbsp;<span class="ident" id="3879581">Flusher</span>&nbsp;<span class="keyword" id="3879589">interface</span>&nbsp;<span class="op" id="3879599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879602">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879651">Flush</span><span class="op" id="3879656">(</span><span class="op" id="3879657">)</span><br>
<span class="lineno"></span><span class="op" id="3879659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="3879662">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3879733">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3879781">type</span>&nbsp;<span class="ident" id="3879786">Hijacker</span>&nbsp;<span class="keyword" id="3879795">interface</span>&nbsp;<span class="op" id="3879805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879808">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879861">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879915">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3879966">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3880019">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880049">Hijack</span><span class="op" id="3880055">(</span><span class="op" id="3880056">)</span>&nbsp;<span class="op" id="3880058">(</span><span class="ident" id="3880059">net</span><span class="op" id="3880062">.</span><span class="ident" id="3880063">Conn</span><span class="op" id="3880067">,</span>&nbsp;<span class="op" id="3880069">*</span><span class="ident" id="3880070">bufio</span><span class="op" id="3880075">.</span><span class="ident" id="3880076">ReadWriter</span><span class="op" id="3880086">,</span>&nbsp;<span class="builtintype" id="3880088">error</span><span class="op" id="3880093">)</span><br>
<span class="lineno"></span><span class="op" id="3880095">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="3880098">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3880169">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="3880234">//</span><br>
<span class="lineno"></span><span class="comment" id="3880237">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="3880307">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3880371">type</span>&nbsp;<span class="ident" id="3880376">CloseNotifier</span>&nbsp;<span class="keyword" id="3880390">interface</span>&nbsp;<span class="op" id="3880400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3880403">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3880466">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880512">CloseNotify</span><span class="op" id="3880523">(</span><span class="op" id="3880524">)</span>&nbsp;<span class="op" id="3880526">&lt;-</span><span class="keyword" id="3880528">chan</span>&nbsp;<span class="builtintype" id="3880533">bool</span><br>
<span class="lineno">110</span><span class="op" id="3880538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3880541">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3880601">type</span>&nbsp;<span class="ident" id="3880606">conn</span>&nbsp;<span class="keyword" id="3880611">struct</span>&nbsp;<span class="op" id="3880618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880621">remoteAddr</span>&nbsp;<span class="builtintype" id="3880632">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3880653">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880688">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3880699">*</span><span class="ident" id="3880700">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3880720">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880767">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3880778">net</span><span class="op" id="3880781">.</span><span class="ident" id="3880782">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3880799">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880818">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3880829">io</span><span class="op" id="3880831">.</span><span class="ident" id="3880832">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3880850">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880911">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3880922">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3880943">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880971">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3880982">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3881003">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881057">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3881068">*</span><span class="ident" id="3881069">io</span><span class="op" id="3881071">.</span><span class="ident" id="3881072">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3881089">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881112">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3881123">*</span><span class="ident" id="3881124">bufio</span><span class="op" id="3881129">.</span><span class="ident" id="3881130">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3881144">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881207">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3881218">*</span><span class="ident" id="3881219">tls</span><span class="op" id="3881222">.</span><span class="ident" id="3881223">ConnectionState</span>&nbsp;<span class="comment" id="3881239">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881270">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3881283">sync</span><span class="op" id="3881287">.</span><span class="ident" id="3881288">Mutex</span>&nbsp;<span class="comment" id="3881294">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881319">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3881332">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3881343">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881386">closeNotifyc</span>&nbsp;<span class="keyword" id="3881399">chan</span>&nbsp;<span class="builtintype" id="3881404">bool</span>&nbsp;&nbsp;<span class="comment" id="3881410">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881426">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3881439">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3881450">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="3881493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3881496">func</span>&nbsp;<span class="op" id="3881501">(</span><span class="ident" id="3881502">c</span>&nbsp;<span class="op" id="3881504">*</span><span class="ident" id="3881505">conn</span><span class="op" id="3881509">)</span>&nbsp;<span class="ident" id="3881511">hijacked</span><span class="op" id="3881519">(</span><span class="op" id="3881520">)</span>&nbsp;<span class="builtintype" id="3881522">bool</span>&nbsp;<span class="op" id="3881527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881530">c</span><span class="op" id="3881531">.</span><span class="ident" id="3881532">mu</span><span class="op" id="3881534">.</span><span class="ident" id="3881535">Lock</span><span class="op" id="3881539">(</span><span class="op" id="3881540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881543">defer</span>&nbsp;<span class="ident" id="3881549">c</span><span class="op" id="3881550">.</span><span class="ident" id="3881551">mu</span><span class="op" id="3881553">.</span><span class="ident" id="3881554">Unlock</span><span class="op" id="3881560">(</span><span class="op" id="3881561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881564">return</span>&nbsp;<span class="ident" id="3881571">c</span><span class="op" id="3881572">.</span><span class="ident" id="3881573">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="3881583">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="3881586">func</span>&nbsp;<span class="op" id="3881591">(</span><span class="ident" id="3881592">c</span>&nbsp;<span class="op" id="3881594">*</span><span class="ident" id="3881595">conn</span><span class="op" id="3881599">)</span>&nbsp;<span class="ident" id="3881601">hijack</span><span class="op" id="3881607">(</span><span class="op" id="3881608">)</span>&nbsp;<span class="op" id="3881610">(</span><span class="ident" id="3881611">rwc</span>&nbsp;<span class="ident" id="3881615">net</span><span class="op" id="3881618">.</span><span class="ident" id="3881619">Conn</span><span class="op" id="3881623">,</span>&nbsp;<span class="ident" id="3881625">buf</span>&nbsp;<span class="op" id="3881629">*</span><span class="ident" id="3881630">bufio</span><span class="op" id="3881635">.</span><span class="ident" id="3881636">ReadWriter</span><span class="op" id="3881646">,</span>&nbsp;<span class="ident" id="3881648">err</span>&nbsp;<span class="builtintype" id="3881652">error</span><span class="op" id="3881657">)</span>&nbsp;<span class="op" id="3881659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881662">c</span><span class="op" id="3881663">.</span><span class="ident" id="3881664">mu</span><span class="op" id="3881666">.</span><span class="ident" id="3881667">Lock</span><span class="op" id="3881671">(</span><span class="op" id="3881672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881675">defer</span>&nbsp;<span class="ident" id="3881681">c</span><span class="op" id="3881682">.</span><span class="ident" id="3881683">mu</span><span class="op" id="3881685">.</span><span class="ident" id="3881686">Unlock</span><span class="op" id="3881692">(</span><span class="op" id="3881693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881696">if</span>&nbsp;<span class="ident" id="3881699">c</span><span class="op" id="3881700">.</span><span class="ident" id="3881701">hijackedv</span>&nbsp;<span class="op" id="3881711">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881715">return</span>&nbsp;<span class="ident" id="3881722">nil</span><span class="op" id="3881725">,</span>&nbsp;<span class="ident" id="3881727">nil</span><span class="op" id="3881730">,</span>&nbsp;<span class="ident" id="3881732">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3881745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881748">if</span>&nbsp;<span class="ident" id="3881751">c</span><span class="op" id="3881752">.</span><span class="ident" id="3881753">closeNotifyc</span>&nbsp;<span class="op" id="3881766">!=</span>&nbsp;<span class="ident" id="3881769">nil</span>&nbsp;<span class="op" id="3881773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881777">return</span>&nbsp;<span class="ident" id="3881784">nil</span><span class="op" id="3881787">,</span>&nbsp;<span class="ident" id="3881789">nil</span><span class="op" id="3881792">,</span>&nbsp;<span class="ident" id="3881794">errors</span><span class="op" id="3881800">.</span><span class="ident" id="3881801">New</span><span class="op" id="3881804">(</span><span class="string" id="3881805">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="3881861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3881864">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881867">c</span><span class="op" id="3881868">.</span><span class="ident" id="3881869">hijackedv</span>&nbsp;<span class="op" id="3881879">=</span>&nbsp;<span class="builtintype" id="3881881">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881887">rwc</span>&nbsp;<span class="op" id="3881891">=</span>&nbsp;<span class="ident" id="3881893">c</span><span class="op" id="3881894">.</span><span class="ident" id="3881895">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881900">buf</span>&nbsp;<span class="op" id="3881904">=</span>&nbsp;<span class="ident" id="3881906">c</span><span class="op" id="3881907">.</span><span class="ident" id="3881908">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881913">c</span><span class="op" id="3881914">.</span><span class="ident" id="3881915">rwc</span>&nbsp;<span class="op" id="3881919">=</span>&nbsp;<span class="ident" id="3881921">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881926">c</span><span class="op" id="3881927">.</span><span class="ident" id="3881928">buf</span>&nbsp;<span class="op" id="3881932">=</span>&nbsp;<span class="ident" id="3881934">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881939">c</span><span class="op" id="3881940">.</span><span class="ident" id="3881941">setState</span><span class="op" id="3881949">(</span><span class="ident" id="3881950">rwc</span><span class="op" id="3881953">,</span>&nbsp;<span class="ident" id="3881955">StateHijacked</span><span class="op" id="3881968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881971">return</span><br>
<span class="lineno"></span><span class="op" id="3881978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3881981">func</span>&nbsp;<span class="op" id="3881986">(</span><span class="ident" id="3881987">c</span>&nbsp;<span class="op" id="3881989">*</span><span class="ident" id="3881990">conn</span><span class="op" id="3881994">)</span>&nbsp;<span class="ident" id="3881996">closeNotify</span><span class="op" id="3882007">(</span><span class="op" id="3882008">)</span>&nbsp;<span class="op" id="3882010">&lt;-</span><span class="keyword" id="3882012">chan</span>&nbsp;<span class="builtintype" id="3882017">bool</span>&nbsp;<span class="op" id="3882022">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882025">c</span><span class="op" id="3882026">.</span><span class="ident" id="3882027">mu</span><span class="op" id="3882029">.</span><span class="ident" id="3882030">Lock</span><span class="op" id="3882034">(</span><span class="op" id="3882035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882038">defer</span>&nbsp;<span class="ident" id="3882044">c</span><span class="op" id="3882045">.</span><span class="ident" id="3882046">mu</span><span class="op" id="3882048">.</span><span class="ident" id="3882049">Unlock</span><span class="op" id="3882055">(</span><span class="op" id="3882056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882059">if</span>&nbsp;<span class="ident" id="3882062">c</span><span class="op" id="3882063">.</span><span class="ident" id="3882064">closeNotifyc</span>&nbsp;<span class="op" id="3882077">==</span>&nbsp;<span class="ident" id="3882080">nil</span>&nbsp;<span class="op" id="3882084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882088">c</span><span class="op" id="3882089">.</span><span class="ident" id="3882090">closeNotifyc</span>&nbsp;<span class="op" id="3882103">=</span>&nbsp;<span class="builtinfunc" id="3882105">make</span><span class="op" id="3882109">(</span><span class="keyword" id="3882110">chan</span>&nbsp;<span class="builtintype" id="3882115">bool</span><span class="op" id="3882119">,</span>&nbsp;<span class="num" id="3882121">1</span><span class="op" id="3882122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882126">if</span>&nbsp;<span class="ident" id="3882129">c</span><span class="op" id="3882130">.</span><span class="ident" id="3882131">hijackedv</span>&nbsp;<span class="op" id="3882141">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3882146">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3882196">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882231">return</span>&nbsp;<span class="ident" id="3882238">c</span><span class="op" id="3882239">.</span><span class="ident" id="3882240">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882259">pr</span><span class="op" id="3882261">,</span>&nbsp;<span class="ident" id="3882263">pw</span>&nbsp;<span class="op" id="3882266">:=</span>&nbsp;<span class="ident" id="3882269">io</span><span class="op" id="3882271">.</span><span class="ident" id="3882272">Pipe</span><span class="op" id="3882276">(</span><span class="op" id="3882277">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882282">readSource</span>&nbsp;<span class="op" id="3882293">:=</span>&nbsp;<span class="ident" id="3882296">c</span><span class="op" id="3882297">.</span><span class="ident" id="3882298">sr</span><span class="op" id="3882300">.</span><span class="ident" id="3882301">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882305">c</span><span class="op" id="3882306">.</span><span class="ident" id="3882307">sr</span><span class="op" id="3882309">.</span><span class="ident" id="3882310">Lock</span><span class="op" id="3882314">(</span><span class="op" id="3882315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882319">c</span><span class="op" id="3882320">.</span><span class="ident" id="3882321">sr</span><span class="op" id="3882323">.</span><span class="ident" id="3882324">r</span>&nbsp;<span class="op" id="3882326">=</span>&nbsp;<span class="ident" id="3882328">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882333">c</span><span class="op" id="3882334">.</span><span class="ident" id="3882335">sr</span><span class="op" id="3882337">.</span><span class="ident" id="3882338">Unlock</span><span class="op" id="3882344">(</span><span class="op" id="3882345">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882349">go</span>&nbsp;<span class="keyword" id="3882352">func</span><span class="op" id="3882356">(</span><span class="op" id="3882357">)</span>&nbsp;<span class="op" id="3882359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882364">_</span><span class="op" id="3882365">,</span>&nbsp;<span class="ident" id="3882367">err</span>&nbsp;<span class="op" id="3882371">:=</span>&nbsp;<span class="ident" id="3882374">io</span><span class="op" id="3882376">.</span><span class="ident" id="3882377">Copy</span><span class="op" id="3882381">(</span><span class="ident" id="3882382">pw</span><span class="op" id="3882384">,</span>&nbsp;<span class="ident" id="3882386">readSource</span><span class="op" id="3882396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882401">if</span>&nbsp;<span class="ident" id="3882404">err</span>&nbsp;<span class="op" id="3882408">==</span>&nbsp;<span class="ident" id="3882411">nil</span>&nbsp;<span class="op" id="3882415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882421">err</span>&nbsp;<span class="op" id="3882425">=</span>&nbsp;<span class="ident" id="3882427">io</span><span class="op" id="3882429">.</span><span class="ident" id="3882430">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882437">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882442">pw</span><span class="op" id="3882444">.</span><span class="ident" id="3882445">CloseWithError</span><span class="op" id="3882459">(</span><span class="ident" id="3882460">err</span><span class="op" id="3882463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882468">c</span><span class="op" id="3882469">.</span><span class="ident" id="3882470">noteClientGone</span><span class="op" id="3882484">(</span><span class="op" id="3882485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882489">}</span><span class="op" id="3882490">(</span><span class="op" id="3882491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882497">return</span>&nbsp;<span class="ident" id="3882504">c</span><span class="op" id="3882505">.</span><span class="ident" id="3882506">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="3882519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3882522">func</span>&nbsp;<span class="op" id="3882527">(</span><span class="ident" id="3882528">c</span>&nbsp;<span class="op" id="3882530">*</span><span class="ident" id="3882531">conn</span><span class="op" id="3882535">)</span>&nbsp;<span class="ident" id="3882537">noteClientGone</span><span class="op" id="3882551">(</span><span class="op" id="3882552">)</span>&nbsp;<span class="op" id="3882554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882557">c</span><span class="op" id="3882558">.</span><span class="ident" id="3882559">mu</span><span class="op" id="3882561">.</span><span class="ident" id="3882562">Lock</span><span class="op" id="3882566">(</span><span class="op" id="3882567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882570">defer</span>&nbsp;<span class="ident" id="3882576">c</span><span class="op" id="3882577">.</span><span class="ident" id="3882578">mu</span><span class="op" id="3882580">.</span><span class="ident" id="3882581">Unlock</span><span class="op" id="3882587">(</span><span class="op" id="3882588">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882591">if</span>&nbsp;<span class="ident" id="3882594">c</span><span class="op" id="3882595">.</span><span class="ident" id="3882596">closeNotifyc</span>&nbsp;<span class="op" id="3882609">!=</span>&nbsp;<span class="ident" id="3882612">nil</span>&nbsp;<span class="op" id="3882616">&amp;&amp;</span>&nbsp;<span class="op" id="3882619">!</span><span class="ident" id="3882620">c</span><span class="op" id="3882621">.</span><span class="ident" id="3882622">clientGone</span>&nbsp;<span class="op" id="3882633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882637">c</span><span class="op" id="3882638">.</span><span class="ident" id="3882639">closeNotifyc</span>&nbsp;<span class="op" id="3882652">&lt;-</span>&nbsp;<span class="builtintype" id="3882655">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882664">c</span><span class="op" id="3882665">.</span><span class="ident" id="3882666">clientGone</span>&nbsp;<span class="op" id="3882677">=</span>&nbsp;<span class="builtintype" id="3882679">true</span><br>
<span class="lineno"></span><span class="op" id="3882684">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3882687">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3882745">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3882797">type</span>&nbsp;<span class="ident" id="3882802">switchReader</span>&nbsp;<span class="keyword" id="3882815">struct</span>&nbsp;<span class="op" id="3882822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882825">io</span><span class="op" id="3882827">.</span><span class="ident" id="3882828">Reader</span><br>
<span class="lineno">195</span><span class="op" id="3882835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3882838">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3882896">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3882949">type</span>&nbsp;<span class="ident" id="3882954">switchWriter</span>&nbsp;<span class="keyword" id="3882967">struct</span>&nbsp;<span class="op" id="3882974">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882977">io</span><span class="op" id="3882979">.</span><span class="ident" id="3882980">Writer</span><br>
<span class="lineno"></span><span class="op" id="3882987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3882990">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="3883057">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="3883102">type</span>&nbsp;<span class="ident" id="3883107">liveSwitchReader</span>&nbsp;<span class="keyword" id="3883124">struct</span>&nbsp;<span class="op" id="3883131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883134">sync</span><span class="op" id="3883138">.</span><span class="ident" id="3883139">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883146">r</span>&nbsp;<span class="ident" id="3883148">io</span><span class="op" id="3883150">.</span><span class="ident" id="3883151">Reader</span><br>
<span class="lineno"></span><span class="op" id="3883158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="3883161">func</span>&nbsp;<span class="op" id="3883166">(</span><span class="ident" id="3883167">sr</span>&nbsp;<span class="op" id="3883170">*</span><span class="ident" id="3883171">liveSwitchReader</span><span class="op" id="3883187">)</span>&nbsp;<span class="ident" id="3883189">Read</span><span class="op" id="3883193">(</span><span class="ident" id="3883194">p</span>&nbsp;<span class="op" id="3883196">[</span><span class="op" id="3883197">]</span><span class="builtintype" id="3883198">byte</span><span class="op" id="3883202">)</span>&nbsp;<span class="op" id="3883204">(</span><span class="ident" id="3883205">n</span>&nbsp;<span class="builtintype" id="3883207">int</span><span class="op" id="3883210">,</span>&nbsp;<span class="ident" id="3883212">err</span>&nbsp;<span class="builtintype" id="3883216">error</span><span class="op" id="3883221">)</span>&nbsp;<span class="op" id="3883223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883226">sr</span><span class="op" id="3883228">.</span><span class="ident" id="3883229">Lock</span><span class="op" id="3883233">(</span><span class="op" id="3883234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883237">r</span>&nbsp;<span class="op" id="3883239">:=</span>&nbsp;<span class="ident" id="3883242">sr</span><span class="op" id="3883244">.</span><span class="ident" id="3883245">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883248">sr</span><span class="op" id="3883250">.</span><span class="ident" id="3883251">Unlock</span><span class="op" id="3883257">(</span><span class="op" id="3883258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883261">return</span>&nbsp;<span class="ident" id="3883268">r</span><span class="op" id="3883269">.</span><span class="ident" id="3883270">Read</span><span class="op" id="3883274">(</span><span class="ident" id="3883275">p</span><span class="op" id="3883276">)</span><br>
<span class="lineno">215</span><span class="op" id="3883278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3883281">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="3883335">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="3883377">const</span>&nbsp;<span class="ident" id="3883383">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="3883408">=</span>&nbsp;<span class="num" id="3883410">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3883416">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="3883485">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="3883534">//</span><br>
<span class="lineno"></span><span class="comment" id="3883537">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="3883609">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="3883680">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3883752">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="3883826">//</span><br>
<span class="lineno"></span><span class="comment" id="3883829">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="3883899">type</span>&nbsp;<span class="ident" id="3883904">chunkWriter</span>&nbsp;<span class="keyword" id="3883916">struct</span>&nbsp;<span class="op" id="3883923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883926">res</span>&nbsp;<span class="op" id="3883930">*</span><span class="ident" id="3883931">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3883942">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3884004">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3884062">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3884120">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884160">header</span>&nbsp;<span class="ident" id="3884167">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3884176">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3884240">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3884290">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3884351">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884374">wroteHeader</span>&nbsp;<span class="builtintype" id="3884386">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3884393">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884428">chunking</span>&nbsp;<span class="builtintype" id="3884437">bool</span>&nbsp;<span class="comment" id="3884442">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="3884492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3884495">var</span>&nbsp;<span class="op" id="3884499">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884502">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3884513">=</span>&nbsp;<span class="op" id="3884515">[</span><span class="op" id="3884516">]</span><span class="builtintype" id="3884517">byte</span><span class="op" id="3884521">(</span><span class="string" id="3884522">&#34;\r\n&#34;</span><span class="op" id="3884528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884531">colonSpace</span>&nbsp;<span class="op" id="3884542">=</span>&nbsp;<span class="op" id="3884544">[</span><span class="op" id="3884545">]</span><span class="builtintype" id="3884546">byte</span><span class="op" id="3884550">(</span><span class="string" id="3884551">&#34;:&nbsp;&#34;</span><span class="op" id="3884555">)</span><br>
<span class="lineno"></span><span class="op" id="3884557">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3884560">func</span>&nbsp;<span class="op" id="3884565">(</span><span class="ident" id="3884566">cw</span>&nbsp;<span class="op" id="3884569">*</span><span class="ident" id="3884570">chunkWriter</span><span class="op" id="3884581">)</span>&nbsp;<span class="ident" id="3884583">Write</span><span class="op" id="3884588">(</span><span class="ident" id="3884589">p</span>&nbsp;<span class="op" id="3884591">[</span><span class="op" id="3884592">]</span><span class="builtintype" id="3884593">byte</span><span class="op" id="3884597">)</span>&nbsp;<span class="op" id="3884599">(</span><span class="ident" id="3884600">n</span>&nbsp;<span class="builtintype" id="3884602">int</span><span class="op" id="3884605">,</span>&nbsp;<span class="ident" id="3884607">err</span>&nbsp;<span class="builtintype" id="3884611">error</span><span class="op" id="3884616">)</span>&nbsp;<span class="op" id="3884618">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884621">if</span>&nbsp;<span class="op" id="3884624">!</span><span class="ident" id="3884625">cw</span><span class="op" id="3884627">.</span><span class="ident" id="3884628">wroteHeader</span>&nbsp;<span class="op" id="3884640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884644">cw</span><span class="op" id="3884646">.</span><span class="ident" id="3884647">writeHeader</span><span class="op" id="3884658">(</span><span class="ident" id="3884659">p</span><span class="op" id="3884660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884666">if</span>&nbsp;<span class="ident" id="3884669">cw</span><span class="op" id="3884671">.</span><span class="ident" id="3884672">res</span><span class="op" id="3884675">.</span><span class="ident" id="3884676">req</span><span class="op" id="3884679">.</span><span class="ident" id="3884680">Method</span>&nbsp;<span class="op" id="3884687">==</span>&nbsp;<span class="string" id="3884690">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3884697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3884701">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884718">return</span>&nbsp;<span class="builtinfunc" id="3884725">len</span><span class="op" id="3884728">(</span><span class="ident" id="3884729">p</span><span class="op" id="3884730">)</span><span class="op" id="3884731">,</span>&nbsp;<span class="ident" id="3884733">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884741">if</span>&nbsp;<span class="ident" id="3884744">cw</span><span class="op" id="3884746">.</span><span class="ident" id="3884747">chunking</span>&nbsp;<span class="op" id="3884756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884760">_</span><span class="op" id="3884761">,</span>&nbsp;<span class="ident" id="3884763">err</span>&nbsp;<span class="op" id="3884767">=</span>&nbsp;<span class="ident" id="3884769">fmt</span><span class="op" id="3884772">.</span><span class="ident" id="3884773">Fprintf</span><span class="op" id="3884780">(</span><span class="ident" id="3884781">cw</span><span class="op" id="3884783">.</span><span class="ident" id="3884784">res</span><span class="op" id="3884787">.</span><span class="ident" id="3884788">conn</span><span class="op" id="3884792">.</span><span class="ident" id="3884793">buf</span><span class="op" id="3884796">,</span>&nbsp;<span class="string" id="3884798">&#34;%x\r\n&#34;</span><span class="op" id="3884806">,</span>&nbsp;<span class="builtinfunc" id="3884808">len</span><span class="op" id="3884811">(</span><span class="ident" id="3884812">p</span><span class="op" id="3884813">)</span><span class="op" id="3884814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884818">if</span>&nbsp;<span class="ident" id="3884821">err</span>&nbsp;<span class="op" id="3884825">!=</span>&nbsp;<span class="ident" id="3884828">nil</span>&nbsp;<span class="op" id="3884832">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884837">cw</span><span class="op" id="3884839">.</span><span class="ident" id="3884840">res</span><span class="op" id="3884843">.</span><span class="ident" id="3884844">conn</span><span class="op" id="3884848">.</span><span class="ident" id="3884849">rwc</span><span class="op" id="3884852">.</span><span class="ident" id="3884853">Close</span><span class="op" id="3884858">(</span><span class="op" id="3884859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884864">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884879">n</span><span class="op" id="3884880">,</span>&nbsp;<span class="ident" id="3884882">err</span>&nbsp;<span class="op" id="3884886">=</span>&nbsp;<span class="ident" id="3884888">cw</span><span class="op" id="3884890">.</span><span class="ident" id="3884891">res</span><span class="op" id="3884894">.</span><span class="ident" id="3884895">conn</span><span class="op" id="3884899">.</span><span class="ident" id="3884900">buf</span><span class="op" id="3884903">.</span><span class="ident" id="3884904">Write</span><span class="op" id="3884909">(</span><span class="ident" id="3884910">p</span><span class="op" id="3884911">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884914">if</span>&nbsp;<span class="ident" id="3884917">cw</span><span class="op" id="3884919">.</span><span class="ident" id="3884920">chunking</span>&nbsp;<span class="op" id="3884929">&amp;&amp;</span>&nbsp;<span class="ident" id="3884932">err</span>&nbsp;<span class="op" id="3884936">==</span>&nbsp;<span class="ident" id="3884939">nil</span>&nbsp;<span class="op" id="3884943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884947">_</span><span class="op" id="3884948">,</span>&nbsp;<span class="ident" id="3884950">err</span>&nbsp;<span class="op" id="3884954">=</span>&nbsp;<span class="ident" id="3884956">cw</span><span class="op" id="3884958">.</span><span class="ident" id="3884959">res</span><span class="op" id="3884962">.</span><span class="ident" id="3884963">conn</span><span class="op" id="3884967">.</span><span class="ident" id="3884968">buf</span><span class="op" id="3884971">.</span><span class="ident" id="3884972">Write</span><span class="op" id="3884977">(</span><span class="ident" id="3884978">crlf</span><span class="op" id="3884982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884988">if</span>&nbsp;<span class="ident" id="3884991">err</span>&nbsp;<span class="op" id="3884995">!=</span>&nbsp;<span class="ident" id="3884998">nil</span>&nbsp;<span class="op" id="3885002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885006">cw</span><span class="op" id="3885008">.</span><span class="ident" id="3885009">res</span><span class="op" id="3885012">.</span><span class="ident" id="3885013">conn</span><span class="op" id="3885017">.</span><span class="ident" id="3885018">rwc</span><span class="op" id="3885021">.</span><span class="ident" id="3885022">Close</span><span class="op" id="3885027">(</span><span class="op" id="3885028">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3885031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885034">return</span><br>
<span class="lineno"></span><span class="op" id="3885041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3885044">func</span>&nbsp;<span class="op" id="3885049">(</span><span class="ident" id="3885050">cw</span>&nbsp;<span class="op" id="3885053">*</span><span class="ident" id="3885054">chunkWriter</span><span class="op" id="3885065">)</span>&nbsp;<span class="ident" id="3885067">flush</span><span class="op" id="3885072">(</span><span class="op" id="3885073">)</span>&nbsp;<span class="op" id="3885075">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885078">if</span>&nbsp;<span class="op" id="3885081">!</span><span class="ident" id="3885082">cw</span><span class="op" id="3885084">.</span><span class="ident" id="3885085">wroteHeader</span>&nbsp;<span class="op" id="3885097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885101">cw</span><span class="op" id="3885103">.</span><span class="ident" id="3885104">writeHeader</span><span class="op" id="3885115">(</span><span class="ident" id="3885116">nil</span><span class="op" id="3885119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3885122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885125">cw</span><span class="op" id="3885127">.</span><span class="ident" id="3885128">res</span><span class="op" id="3885131">.</span><span class="ident" id="3885132">conn</span><span class="op" id="3885136">.</span><span class="ident" id="3885137">buf</span><span class="op" id="3885140">.</span><span class="ident" id="3885141">Flush</span><span class="op" id="3885146">(</span><span class="op" id="3885147">)</span><br>
<span class="lineno"></span><span class="op" id="3885149">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="3885152">func</span>&nbsp;<span class="op" id="3885157">(</span><span class="ident" id="3885158">cw</span>&nbsp;<span class="op" id="3885161">*</span><span class="ident" id="3885162">chunkWriter</span><span class="op" id="3885173">)</span>&nbsp;<span class="builtinfunc" id="3885175">close</span><span class="op" id="3885180">(</span><span class="op" id="3885181">)</span>&nbsp;<span class="op" id="3885183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885186">if</span>&nbsp;<span class="op" id="3885189">!</span><span class="ident" id="3885190">cw</span><span class="op" id="3885192">.</span><span class="ident" id="3885193">wroteHeader</span>&nbsp;<span class="op" id="3885205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885209">cw</span><span class="op" id="3885211">.</span><span class="ident" id="3885212">writeHeader</span><span class="op" id="3885223">(</span><span class="ident" id="3885224">nil</span><span class="op" id="3885227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3885230">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885233">if</span>&nbsp;<span class="ident" id="3885236">cw</span><span class="op" id="3885238">.</span><span class="ident" id="3885239">chunking</span>&nbsp;<span class="op" id="3885248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885252">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885308">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885362">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885373">cw</span><span class="op" id="3885375">.</span><span class="ident" id="3885376">res</span><span class="op" id="3885379">.</span><span class="ident" id="3885380">conn</span><span class="op" id="3885384">.</span><span class="ident" id="3885385">buf</span><span class="op" id="3885388">.</span><span class="ident" id="3885389">WriteString</span><span class="op" id="3885400">(</span><span class="string" id="3885401">&#34;0\r\n\r\n&#34;</span><span class="op" id="3885412">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3885415">}</span><br>
<span class="lineno"></span><span class="op" id="3885417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3885420">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3885482">type</span>&nbsp;<span class="ident" id="3885487">response</span>&nbsp;<span class="keyword" id="3885496">struct</span>&nbsp;<span class="op" id="3885503">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885506">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3885520">*</span><span class="ident" id="3885521">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885527">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3885541">*</span><span class="ident" id="3885542">Request</span>&nbsp;<span class="comment" id="3885550">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885580">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3885594">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3885603">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885649">wroteContinue</span>&nbsp;<span class="builtintype" id="3885663">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3885672">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885711">w</span>&nbsp;&nbsp;<span class="op" id="3885714">*</span><span class="ident" id="3885715">bufio</span><span class="op" id="3885720">.</span><span class="ident" id="3885721">Writer</span>&nbsp;<span class="comment" id="3885728">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885772">cw</span>&nbsp;<span class="ident" id="3885775">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885788">sw</span>&nbsp;<span class="op" id="3885791">*</span><span class="ident" id="3885792">switchWriter</span>&nbsp;<span class="comment" id="3885805">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885860">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885921">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3885983">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886041">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886085">handlerHeader</span>&nbsp;<span class="ident" id="3886099">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886107">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="3886121">bool</span>&nbsp;<span class="comment" id="3886126">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886173">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886187">int64</span>&nbsp;<span class="comment" id="3886193">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886229">contentLength</span>&nbsp;<span class="ident" id="3886243">int64</span>&nbsp;<span class="comment" id="3886249">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886295">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3886309">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3886315">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886354">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886413">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886466">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886517">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886537">closeAfterReply</span>&nbsp;<span class="builtintype" id="3886553">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886560">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886615">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886670">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886721">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886783">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886839">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886899">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886918">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="3886938">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886945">handlerDone</span>&nbsp;<span class="builtintype" id="3886957">bool</span>&nbsp;<span class="comment" id="3886962">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3886999">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887039">dateBuf</span>&nbsp;<span class="op" id="3887047">[</span><span class="builtinfunc" id="3887048">len</span><span class="op" id="3887051">(</span><span class="ident" id="3887052">TimeFormat</span><span class="op" id="3887062">)</span><span class="op" id="3887063">]</span><span class="builtintype" id="3887064">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887070">clenBuf</span>&nbsp;<span class="op" id="3887078">[</span><span class="num" id="3887079">10</span><span class="op" id="3887081">]</span><span class="builtintype" id="3887082">byte</span><br>
<span class="lineno">340</span><span class="op" id="3887087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3887090">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="3887161">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3887191">func</span>&nbsp;<span class="op" id="3887196">(</span><span class="ident" id="3887197">w</span>&nbsp;<span class="op" id="3887199">*</span><span class="ident" id="3887200">response</span><span class="op" id="3887208">)</span>&nbsp;<span class="ident" id="3887210">requestTooLarge</span><span class="op" id="3887225">(</span><span class="op" id="3887226">)</span>&nbsp;<span class="op" id="3887228">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887231">w</span><span class="op" id="3887232">.</span><span class="ident" id="3887233">closeAfterReply</span>&nbsp;<span class="op" id="3887249">=</span>&nbsp;<span class="builtintype" id="3887251">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887257">w</span><span class="op" id="3887258">.</span><span class="ident" id="3887259">requestBodyLimitHit</span>&nbsp;<span class="op" id="3887279">=</span>&nbsp;<span class="builtintype" id="3887281">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887287">if</span>&nbsp;<span class="op" id="3887290">!</span><span class="ident" id="3887291">w</span><span class="op" id="3887292">.</span><span class="ident" id="3887293">wroteHeader</span>&nbsp;<span class="op" id="3887305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887309">w</span><span class="op" id="3887310">.</span><span class="ident" id="3887311">Header</span><span class="op" id="3887317">(</span><span class="op" id="3887318">)</span><span class="op" id="3887319">.</span><span class="ident" id="3887320">Set</span><span class="op" id="3887323">(</span><span class="string" id="3887324">&#34;Connection&#34;</span><span class="op" id="3887336">,</span>&nbsp;<span class="string" id="3887338">&#34;close&#34;</span><span class="op" id="3887345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3887348">}</span><br>
<span class="lineno">350</span><span class="op" id="3887350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3887353">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="3887425">func</span>&nbsp;<span class="op" id="3887430">(</span><span class="ident" id="3887431">w</span>&nbsp;<span class="op" id="3887433">*</span><span class="ident" id="3887434">response</span><span class="op" id="3887442">)</span>&nbsp;<span class="ident" id="3887444">needsSniff</span><span class="op" id="3887454">(</span><span class="op" id="3887455">)</span>&nbsp;<span class="builtintype" id="3887457">bool</span>&nbsp;<span class="op" id="3887462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887465">_</span><span class="op" id="3887466">,</span>&nbsp;<span class="ident" id="3887468">haveType</span>&nbsp;<span class="op" id="3887477">:=</span>&nbsp;<span class="ident" id="3887480">w</span><span class="op" id="3887481">.</span><span class="ident" id="3887482">handlerHeader</span><span class="op" id="3887495">[</span><span class="string" id="3887496">&#34;Content-Type&#34;</span><span class="op" id="3887510">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887513">return</span>&nbsp;<span class="op" id="3887520">!</span><span class="ident" id="3887521">w</span><span class="op" id="3887522">.</span><span class="ident" id="3887523">cw</span><span class="op" id="3887525">.</span><span class="ident" id="3887526">wroteHeader</span>&nbsp;<span class="op" id="3887538">&amp;&amp;</span>&nbsp;<span class="op" id="3887541">!</span><span class="ident" id="3887542">haveType</span>&nbsp;<span class="op" id="3887551">&amp;&amp;</span>&nbsp;<span class="ident" id="3887554">w</span><span class="op" id="3887555">.</span><span class="ident" id="3887556">written</span>&nbsp;<span class="op" id="3887564">&lt;</span>&nbsp;<span class="ident" id="3887566">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="3887575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3887578">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3887644">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="3887661">type</span>&nbsp;<span class="ident" id="3887666">writerOnly</span>&nbsp;<span class="keyword" id="3887677">struct</span>&nbsp;<span class="op" id="3887684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887687">io</span><span class="op" id="3887689">.</span><span class="ident" id="3887690">Writer</span><br>
<span class="lineno"></span><span class="op" id="3887697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3887700">func</span>&nbsp;<span class="ident" id="3887705">srcIsRegularFile</span><span class="op" id="3887721">(</span><span class="ident" id="3887722">src</span>&nbsp;<span class="ident" id="3887726">io</span><span class="op" id="3887728">.</span><span class="ident" id="3887729">Reader</span><span class="op" id="3887735">)</span>&nbsp;<span class="op" id="3887737">(</span><span class="ident" id="3887738">isRegular</span>&nbsp;<span class="builtintype" id="3887748">bool</span><span class="op" id="3887752">,</span>&nbsp;<span class="ident" id="3887754">err</span>&nbsp;<span class="builtintype" id="3887758">error</span><span class="op" id="3887763">)</span>&nbsp;<span class="op" id="3887765">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887768">switch</span>&nbsp;<span class="ident" id="3887775">v</span>&nbsp;<span class="op" id="3887777">:=</span>&nbsp;<span class="ident" id="3887780">src</span><span class="op" id="3887783">.</span><span class="op" id="3887784">(</span><span class="keyword" id="3887785">type</span><span class="op" id="3887789">)</span>&nbsp;<span class="op" id="3887791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887794">case</span>&nbsp;<span class="op" id="3887799">*</span><span class="ident" id="3887800">os</span><span class="op" id="3887802">.</span><span class="ident" id="3887803">File</span><span class="op" id="3887807">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3887811">fi</span><span class="op" id="3887813">,</span>&nbsp;<span class="ident" id="3887815">err</span>&nbsp;<span class="op" id="3887819">:=</span>&nbsp;<span class="ident" id="3887822">v</span><span class="op" id="3887823">.</span><span class="ident" id="3887824">Stat</span><span class="op" id="3887828">(</span><span class="op" id="3887829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887833">if</span>&nbsp;<span class="ident" id="3887836">err</span>&nbsp;<span class="op" id="3887840">!=</span>&nbsp;<span class="ident" id="3887843">nil</span>&nbsp;<span class="op" id="3887847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887852">return</span>&nbsp;<span class="builtintype" id="3887859">false</span><span class="op" id="3887864">,</span>&nbsp;<span class="ident" id="3887866">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3887872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887876">return</span>&nbsp;<span class="ident" id="3887883">fi</span><span class="op" id="3887885">.</span><span class="ident" id="3887886">Mode</span><span class="op" id="3887890">(</span><span class="op" id="3887891">)</span><span class="op" id="3887892">.</span><span class="ident" id="3887893">IsRegular</span><span class="op" id="3887902">(</span><span class="op" id="3887903">)</span><span class="op" id="3887904">,</span>&nbsp;<span class="ident" id="3887906">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887911">case</span>&nbsp;<span class="op" id="3887916">*</span><span class="ident" id="3887917">io</span><span class="op" id="3887919">.</span><span class="ident" id="3887920">LimitedReader</span><span class="op" id="3887933">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887937">return</span>&nbsp;<span class="ident" id="3887944">srcIsRegularFile</span><span class="op" id="3887960">(</span><span class="ident" id="3887961">v</span><span class="op" id="3887962">.</span><span class="ident" id="3887963">R</span><span class="op" id="3887964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887967">default</span><span class="op" id="3887974">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3887978">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3887986">}</span><br>
<span class="lineno"></span><span class="op" id="3887988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3887991">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="3888061">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="3888097">func</span>&nbsp;<span class="op" id="3888102">(</span><span class="ident" id="3888103">w</span>&nbsp;<span class="op" id="3888105">*</span><span class="ident" id="3888106">response</span><span class="op" id="3888114">)</span>&nbsp;<span class="ident" id="3888116">ReadFrom</span><span class="op" id="3888124">(</span><span class="ident" id="3888125">src</span>&nbsp;<span class="ident" id="3888129">io</span><span class="op" id="3888131">.</span><span class="ident" id="3888132">Reader</span><span class="op" id="3888138">)</span>&nbsp;<span class="op" id="3888140">(</span><span class="ident" id="3888141">n</span>&nbsp;<span class="ident" id="3888143">int64</span><span class="op" id="3888148">,</span>&nbsp;<span class="ident" id="3888150">err</span>&nbsp;<span class="builtintype" id="3888154">error</span><span class="op" id="3888159">)</span>&nbsp;<span class="op" id="3888161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3888164">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3888226">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3888290">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888342">rf</span><span class="op" id="3888344">,</span>&nbsp;<span class="ident" id="3888346">ok</span>&nbsp;<span class="op" id="3888349">:=</span>&nbsp;<span class="ident" id="3888352">w</span><span class="op" id="3888353">.</span><span class="ident" id="3888354">conn</span><span class="op" id="3888358">.</span><span class="ident" id="3888359">rwc</span><span class="op" id="3888362">.</span><span class="op" id="3888363">(</span><span class="ident" id="3888364">io</span><span class="op" id="3888366">.</span><span class="ident" id="3888367">ReaderFrom</span><span class="op" id="3888377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888380">regFile</span><span class="op" id="3888387">,</span>&nbsp;<span class="ident" id="3888389">err</span>&nbsp;<span class="op" id="3888393">:=</span>&nbsp;<span class="ident" id="3888396">srcIsRegularFile</span><span class="op" id="3888412">(</span><span class="ident" id="3888413">src</span><span class="op" id="3888416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888419">if</span>&nbsp;<span class="ident" id="3888422">err</span>&nbsp;<span class="op" id="3888426">!=</span>&nbsp;<span class="ident" id="3888429">nil</span>&nbsp;<span class="op" id="3888433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888437">return</span>&nbsp;<span class="num" id="3888444">0</span><span class="op" id="3888445">,</span>&nbsp;<span class="ident" id="3888447">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888452">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888455">if</span>&nbsp;<span class="op" id="3888458">!</span><span class="ident" id="3888459">ok</span>&nbsp;<span class="op" id="3888462">||</span>&nbsp;<span class="op" id="3888465">!</span><span class="ident" id="3888466">regFile</span>&nbsp;<span class="op" id="3888474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888478">return</span>&nbsp;<span class="ident" id="3888485">io</span><span class="op" id="3888487">.</span><span class="ident" id="3888488">Copy</span><span class="op" id="3888492">(</span><span class="ident" id="3888493">writerOnly</span><span class="op" id="3888503">{</span><span class="ident" id="3888504">w</span><span class="op" id="3888505">}</span><span class="op" id="3888506">,</span>&nbsp;<span class="ident" id="3888508">src</span><span class="op" id="3888511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3888518">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888538">if</span>&nbsp;<span class="op" id="3888541">!</span><span class="ident" id="3888542">w</span><span class="op" id="3888543">.</span><span class="ident" id="3888544">wroteHeader</span>&nbsp;<span class="op" id="3888556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888560">w</span><span class="op" id="3888561">.</span><span class="ident" id="3888562">WriteHeader</span><span class="op" id="3888573">(</span><span class="ident" id="3888574">StatusOK</span><span class="op" id="3888582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888589">if</span>&nbsp;<span class="ident" id="3888592">w</span><span class="op" id="3888593">.</span><span class="ident" id="3888594">needsSniff</span><span class="op" id="3888604">(</span><span class="op" id="3888605">)</span>&nbsp;<span class="op" id="3888607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888611">n0</span><span class="op" id="3888613">,</span>&nbsp;<span class="ident" id="3888615">err</span>&nbsp;<span class="op" id="3888619">:=</span>&nbsp;<span class="ident" id="3888622">io</span><span class="op" id="3888624">.</span><span class="ident" id="3888625">Copy</span><span class="op" id="3888629">(</span><span class="ident" id="3888630">writerOnly</span><span class="op" id="3888640">{</span><span class="ident" id="3888641">w</span><span class="op" id="3888642">}</span><span class="op" id="3888643">,</span>&nbsp;<span class="ident" id="3888645">io</span><span class="op" id="3888647">.</span><span class="ident" id="3888648">LimitReader</span><span class="op" id="3888659">(</span><span class="ident" id="3888660">src</span><span class="op" id="3888663">,</span>&nbsp;<span class="ident" id="3888665">sniffLen</span><span class="op" id="3888673">)</span><span class="op" id="3888674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888678">n</span>&nbsp;<span class="op" id="3888680">+=</span>&nbsp;<span class="ident" id="3888683">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888688">if</span>&nbsp;<span class="ident" id="3888691">err</span>&nbsp;<span class="op" id="3888695">!=</span>&nbsp;<span class="ident" id="3888698">nil</span>&nbsp;<span class="op" id="3888702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888707">return</span>&nbsp;<span class="ident" id="3888714">n</span><span class="op" id="3888715">,</span>&nbsp;<span class="ident" id="3888717">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3888726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888730">w</span><span class="op" id="3888731">.</span><span class="ident" id="3888732">w</span><span class="op" id="3888733">.</span><span class="ident" id="3888734">Flush</span><span class="op" id="3888739">(</span><span class="op" id="3888740">)</span>&nbsp;&nbsp;<span class="comment" id="3888743">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888778">w</span><span class="op" id="3888779">.</span><span class="ident" id="3888780">cw</span><span class="op" id="3888782">.</span><span class="ident" id="3888783">flush</span><span class="op" id="3888788">(</span><span class="op" id="3888789">)</span>&nbsp;<span class="comment" id="3888791">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3888843">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3888923">if</span>&nbsp;<span class="op" id="3888926">!</span><span class="ident" id="3888927">w</span><span class="op" id="3888928">.</span><span class="ident" id="3888929">cw</span><span class="op" id="3888931">.</span><span class="ident" id="3888932">chunking</span>&nbsp;<span class="op" id="3888941">&amp;&amp;</span>&nbsp;<span class="ident" id="3888944">w</span><span class="op" id="3888945">.</span><span class="ident" id="3888946">bodyAllowed</span><span class="op" id="3888957">(</span><span class="op" id="3888958">)</span>&nbsp;<span class="op" id="3888960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888964">n0</span><span class="op" id="3888966">,</span>&nbsp;<span class="ident" id="3888968">err</span>&nbsp;<span class="op" id="3888972">:=</span>&nbsp;<span class="ident" id="3888975">rf</span><span class="op" id="3888977">.</span><span class="ident" id="3888978">ReadFrom</span><span class="op" id="3888986">(</span><span class="ident" id="3888987">src</span><span class="op" id="3888990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3888994">n</span>&nbsp;<span class="op" id="3888996">+=</span>&nbsp;<span class="ident" id="3888999">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889004">w</span><span class="op" id="3889005">.</span><span class="ident" id="3889006">written</span>&nbsp;<span class="op" id="3889014">+=</span>&nbsp;<span class="ident" id="3889017">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889022">return</span>&nbsp;<span class="ident" id="3889029">n</span><span class="op" id="3889030">,</span>&nbsp;<span class="ident" id="3889032">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3889037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889041">n0</span><span class="op" id="3889043">,</span>&nbsp;<span class="ident" id="3889045">err</span>&nbsp;<span class="op" id="3889049">:=</span>&nbsp;<span class="ident" id="3889052">io</span><span class="op" id="3889054">.</span><span class="ident" id="3889055">Copy</span><span class="op" id="3889059">(</span><span class="ident" id="3889060">writerOnly</span><span class="op" id="3889070">{</span><span class="ident" id="3889071">w</span><span class="op" id="3889072">}</span><span class="op" id="3889073">,</span>&nbsp;<span class="ident" id="3889075">src</span><span class="op" id="3889078">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889081">n</span>&nbsp;<span class="op" id="3889083">+=</span>&nbsp;<span class="ident" id="3889086">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889090">return</span>&nbsp;<span class="ident" id="3889097">n</span><span class="op" id="3889098">,</span>&nbsp;<span class="ident" id="3889100">err</span><br>
<span class="lineno"></span><span class="op" id="3889104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3889107">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="3889176">const</span>&nbsp;<span class="ident" id="3889182">noLimit</span>&nbsp;<span class="ident" id="3889190">int64</span>&nbsp;<span class="op" id="3889196">=</span>&nbsp;<span class="op" id="3889198">(</span><span class="num" id="3889199">1</span>&nbsp;<span class="op" id="3889201">&lt;&lt;</span>&nbsp;<span class="num" id="3889204">63</span><span class="op" id="3889206">)</span>&nbsp;<span class="op" id="3889208">-</span>&nbsp;<span class="num" id="3889210">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3889213">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="3889291">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="3889326">const</span>&nbsp;<span class="ident" id="3889332">debugServerConnections</span>&nbsp;<span class="op" id="3889355">=</span>&nbsp;<span class="builtintype" id="3889357">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="3889364">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="3889399">func</span>&nbsp;<span class="op" id="3889404">(</span><span class="ident" id="3889405">srv</span>&nbsp;<span class="op" id="3889409">*</span><span class="ident" id="3889410">Server</span><span class="op" id="3889416">)</span>&nbsp;<span class="ident" id="3889418">newConn</span><span class="op" id="3889425">(</span><span class="ident" id="3889426">rwc</span>&nbsp;<span class="ident" id="3889430">net</span><span class="op" id="3889433">.</span><span class="ident" id="3889434">Conn</span><span class="op" id="3889438">)</span>&nbsp;<span class="op" id="3889440">(</span><span class="ident" id="3889441">c</span>&nbsp;<span class="op" id="3889443">*</span><span class="ident" id="3889444">conn</span><span class="op" id="3889448">,</span>&nbsp;<span class="ident" id="3889450">err</span>&nbsp;<span class="builtintype" id="3889454">error</span><span class="op" id="3889459">)</span>&nbsp;<span class="op" id="3889461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889464">c</span>&nbsp;<span class="op" id="3889466">=</span>&nbsp;<span class="builtinfunc" id="3889468">new</span><span class="op" id="3889471">(</span><span class="ident" id="3889472">conn</span><span class="op" id="3889476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889479">c</span><span class="op" id="3889480">.</span><span class="ident" id="3889481">remoteAddr</span>&nbsp;<span class="op" id="3889492">=</span>&nbsp;<span class="ident" id="3889494">rwc</span><span class="op" id="3889497">.</span><span class="ident" id="3889498">RemoteAddr</span><span class="op" id="3889508">(</span><span class="op" id="3889509">)</span><span class="op" id="3889510">.</span><span class="ident" id="3889511">String</span><span class="op" id="3889517">(</span><span class="op" id="3889518">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889521">c</span><span class="op" id="3889522">.</span><span class="ident" id="3889523">server</span>&nbsp;<span class="op" id="3889530">=</span>&nbsp;<span class="ident" id="3889532">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889537">c</span><span class="op" id="3889538">.</span><span class="ident" id="3889539">rwc</span>&nbsp;<span class="op" id="3889543">=</span>&nbsp;<span class="ident" id="3889545">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889550">c</span><span class="op" id="3889551">.</span><span class="ident" id="3889552">w</span>&nbsp;<span class="op" id="3889554">=</span>&nbsp;<span class="ident" id="3889556">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889561">if</span>&nbsp;<span class="ident" id="3889564">debugServerConnections</span>&nbsp;<span class="op" id="3889587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889591">c</span><span class="op" id="3889592">.</span><span class="ident" id="3889593">rwc</span>&nbsp;<span class="op" id="3889597">=</span>&nbsp;<span class="ident" id="3889599">newLoggingConn</span><span class="op" id="3889613">(</span><span class="string" id="3889614">&#34;server&#34;</span><span class="op" id="3889622">,</span>&nbsp;<span class="ident" id="3889624">c</span><span class="op" id="3889625">.</span><span class="ident" id="3889626">rwc</span><span class="op" id="3889629">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3889632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889635">c</span><span class="op" id="3889636">.</span><span class="ident" id="3889637">sr</span>&nbsp;<span class="op" id="3889640">=</span>&nbsp;<span class="ident" id="3889642">liveSwitchReader</span><span class="op" id="3889658">{</span><span class="ident" id="3889659">r</span><span class="op" id="3889660">:</span>&nbsp;<span class="ident" id="3889662">c</span><span class="op" id="3889663">.</span><span class="ident" id="3889664">rwc</span><span class="op" id="3889667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889670">c</span><span class="op" id="3889671">.</span><span class="ident" id="3889672">lr</span>&nbsp;<span class="op" id="3889675">=</span>&nbsp;<span class="ident" id="3889677">io</span><span class="op" id="3889679">.</span><span class="ident" id="3889680">LimitReader</span><span class="op" id="3889691">(</span><span class="op" id="3889692">&amp;</span><span class="ident" id="3889693">c</span><span class="op" id="3889694">.</span><span class="ident" id="3889695">sr</span><span class="op" id="3889697">,</span>&nbsp;<span class="ident" id="3889699">noLimit</span><span class="op" id="3889706">)</span><span class="op" id="3889707">.</span><span class="op" id="3889708">(</span><span class="op" id="3889709">*</span><span class="ident" id="3889710">io</span><span class="op" id="3889712">.</span><span class="ident" id="3889713">LimitedReader</span><span class="op" id="3889726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889729">br</span>&nbsp;<span class="op" id="3889732">:=</span>&nbsp;<span class="ident" id="3889735">newBufioReader</span><span class="op" id="3889749">(</span><span class="ident" id="3889750">c</span><span class="op" id="3889751">.</span><span class="ident" id="3889752">lr</span><span class="op" id="3889754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889757">bw</span>&nbsp;<span class="op" id="3889760">:=</span>&nbsp;<span class="ident" id="3889763">newBufioWriterSize</span><span class="op" id="3889781">(</span><span class="ident" id="3889782">checkConnErrorWriter</span><span class="op" id="3889802">{</span><span class="ident" id="3889803">c</span><span class="op" id="3889804">}</span><span class="op" id="3889805">,</span>&nbsp;<span class="num" id="3889807">4</span><span class="op" id="3889808">&lt;&lt;</span><span class="num" id="3889810">10</span><span class="op" id="3889812">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889815">c</span><span class="op" id="3889816">.</span><span class="ident" id="3889817">buf</span>&nbsp;<span class="op" id="3889821">=</span>&nbsp;<span class="ident" id="3889823">bufio</span><span class="op" id="3889828">.</span><span class="ident" id="3889829">NewReadWriter</span><span class="op" id="3889842">(</span><span class="ident" id="3889843">br</span><span class="op" id="3889845">,</span>&nbsp;<span class="ident" id="3889847">bw</span><span class="op" id="3889849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3889852">return</span>&nbsp;<span class="ident" id="3889859">c</span><span class="op" id="3889860">,</span>&nbsp;<span class="ident" id="3889862">nil</span><br>
<span class="lineno"></span><span class="op" id="3889866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3889869">var</span>&nbsp;<span class="op" id="3889873">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889876">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3889894">sync</span><span class="op" id="3889898">.</span><span class="ident" id="3889899">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889905">bufioWriter2kPool</span>&nbsp;<span class="ident" id="3889923">sync</span><span class="op" id="3889927">.</span><span class="ident" id="3889928">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3889934">bufioWriter4kPool</span>&nbsp;<span class="ident" id="3889952">sync</span><span class="op" id="3889956">.</span><span class="ident" id="3889957">Pool</span><br>
<span class="lineno"></span><span class="op" id="3889962">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="3889965">func</span>&nbsp;<span class="ident" id="3889970">bufioWriterPool</span><span class="op" id="3889985">(</span><span class="ident" id="3889986">size</span>&nbsp;<span class="builtintype" id="3889991">int</span><span class="op" id="3889994">)</span>&nbsp;<span class="op" id="3889996">*</span><span class="ident" id="3889997">sync</span><span class="op" id="3890001">.</span><span class="ident" id="3890002">Pool</span>&nbsp;<span class="op" id="3890007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890010">switch</span>&nbsp;<span class="ident" id="3890017">size</span>&nbsp;<span class="op" id="3890022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890025">case</span>&nbsp;<span class="num" id="3890030">2</span>&nbsp;<span class="op" id="3890032">&lt;&lt;</span>&nbsp;<span class="num" id="3890035">10</span><span class="op" id="3890037">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890041">return</span>&nbsp;<span class="op" id="3890048">&amp;</span><span class="ident" id="3890049">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890068">case</span>&nbsp;<span class="num" id="3890073">4</span>&nbsp;<span class="op" id="3890075">&lt;&lt;</span>&nbsp;<span class="num" id="3890078">10</span><span class="op" id="3890080">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890084">return</span>&nbsp;<span class="op" id="3890091">&amp;</span><span class="ident" id="3890092">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890114">return</span>&nbsp;<span class="ident" id="3890121">nil</span><br>
<span class="lineno"></span><span class="op" id="3890125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="3890128">func</span>&nbsp;<span class="ident" id="3890133">newBufioReader</span><span class="op" id="3890147">(</span><span class="ident" id="3890148">r</span>&nbsp;<span class="ident" id="3890150">io</span><span class="op" id="3890152">.</span><span class="ident" id="3890153">Reader</span><span class="op" id="3890159">)</span>&nbsp;<span class="op" id="3890161">*</span><span class="ident" id="3890162">bufio</span><span class="op" id="3890167">.</span><span class="ident" id="3890168">Reader</span>&nbsp;<span class="op" id="3890175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890178">if</span>&nbsp;<span class="ident" id="3890181">v</span>&nbsp;<span class="op" id="3890183">:=</span>&nbsp;<span class="ident" id="3890186">bufioReaderPool</span><span class="op" id="3890201">.</span><span class="ident" id="3890202">Get</span><span class="op" id="3890205">(</span><span class="op" id="3890206">)</span><span class="op" id="3890207">;</span>&nbsp;<span class="ident" id="3890209">v</span>&nbsp;<span class="op" id="3890211">!=</span>&nbsp;<span class="ident" id="3890214">nil</span>&nbsp;<span class="op" id="3890218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890222">br</span>&nbsp;<span class="op" id="3890225">:=</span>&nbsp;<span class="ident" id="3890228">v</span><span class="op" id="3890229">.</span><span class="op" id="3890230">(</span><span class="op" id="3890231">*</span><span class="ident" id="3890232">bufio</span><span class="op" id="3890237">.</span><span class="ident" id="3890238">Reader</span><span class="op" id="3890244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890248">br</span><span class="op" id="3890250">.</span><span class="ident" id="3890251">Reset</span><span class="op" id="3890256">(</span><span class="ident" id="3890257">r</span><span class="op" id="3890258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890262">return</span>&nbsp;<span class="ident" id="3890269">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890276">return</span>&nbsp;<span class="ident" id="3890283">bufio</span><span class="op" id="3890288">.</span><span class="ident" id="3890289">NewReader</span><span class="op" id="3890298">(</span><span class="ident" id="3890299">r</span><span class="op" id="3890300">)</span><br>
<span class="lineno"></span><span class="op" id="3890302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3890305">func</span>&nbsp;<span class="ident" id="3890310">putBufioReader</span><span class="op" id="3890324">(</span><span class="ident" id="3890325">br</span>&nbsp;<span class="op" id="3890328">*</span><span class="ident" id="3890329">bufio</span><span class="op" id="3890334">.</span><span class="ident" id="3890335">Reader</span><span class="op" id="3890341">)</span>&nbsp;<span class="op" id="3890343">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890346">br</span><span class="op" id="3890348">.</span><span class="ident" id="3890349">Reset</span><span class="op" id="3890354">(</span><span class="ident" id="3890355">nil</span><span class="op" id="3890358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890361">bufioReaderPool</span><span class="op" id="3890376">.</span><span class="ident" id="3890377">Put</span><span class="op" id="3890380">(</span><span class="ident" id="3890381">br</span><span class="op" id="3890383">)</span><br>
<span class="lineno"></span><span class="op" id="3890385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3890388">func</span>&nbsp;<span class="ident" id="3890393">newBufioWriterSize</span><span class="op" id="3890411">(</span><span class="ident" id="3890412">w</span>&nbsp;<span class="ident" id="3890414">io</span><span class="op" id="3890416">.</span><span class="ident" id="3890417">Writer</span><span class="op" id="3890423">,</span>&nbsp;<span class="ident" id="3890425">size</span>&nbsp;<span class="builtintype" id="3890430">int</span><span class="op" id="3890433">)</span>&nbsp;<span class="op" id="3890435">*</span><span class="ident" id="3890436">bufio</span><span class="op" id="3890441">.</span><span class="ident" id="3890442">Writer</span>&nbsp;<span class="op" id="3890449">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890452">pool</span>&nbsp;<span class="op" id="3890457">:=</span>&nbsp;<span class="ident" id="3890460">bufioWriterPool</span><span class="op" id="3890475">(</span><span class="ident" id="3890476">size</span><span class="op" id="3890480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890483">if</span>&nbsp;<span class="ident" id="3890486">pool</span>&nbsp;<span class="op" id="3890491">!=</span>&nbsp;<span class="ident" id="3890494">nil</span>&nbsp;<span class="op" id="3890498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890502">if</span>&nbsp;<span class="ident" id="3890505">v</span>&nbsp;<span class="op" id="3890507">:=</span>&nbsp;<span class="ident" id="3890510">pool</span><span class="op" id="3890514">.</span><span class="ident" id="3890515">Get</span><span class="op" id="3890518">(</span><span class="op" id="3890519">)</span><span class="op" id="3890520">;</span>&nbsp;<span class="ident" id="3890522">v</span>&nbsp;<span class="op" id="3890524">!=</span>&nbsp;<span class="ident" id="3890527">nil</span>&nbsp;<span class="op" id="3890531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890536">bw</span>&nbsp;<span class="op" id="3890539">:=</span>&nbsp;<span class="ident" id="3890542">v</span><span class="op" id="3890543">.</span><span class="op" id="3890544">(</span><span class="op" id="3890545">*</span><span class="ident" id="3890546">bufio</span><span class="op" id="3890551">.</span><span class="ident" id="3890552">Writer</span><span class="op" id="3890558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890563">bw</span><span class="op" id="3890565">.</span><span class="ident" id="3890566">Reset</span><span class="op" id="3890571">(</span><span class="ident" id="3890572">w</span><span class="op" id="3890573">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890578">return</span>&nbsp;<span class="ident" id="3890585">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890596">return</span>&nbsp;<span class="ident" id="3890603">bufio</span><span class="op" id="3890608">.</span><span class="ident" id="3890609">NewWriterSize</span><span class="op" id="3890622">(</span><span class="ident" id="3890623">w</span><span class="op" id="3890624">,</span>&nbsp;<span class="ident" id="3890626">size</span><span class="op" id="3890630">)</span><br>
<span class="lineno"></span><span class="op" id="3890632">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="3890635">func</span>&nbsp;<span class="ident" id="3890640">putBufioWriter</span><span class="op" id="3890654">(</span><span class="ident" id="3890655">bw</span>&nbsp;<span class="op" id="3890658">*</span><span class="ident" id="3890659">bufio</span><span class="op" id="3890664">.</span><span class="ident" id="3890665">Writer</span><span class="op" id="3890671">)</span>&nbsp;<span class="op" id="3890673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890676">bw</span><span class="op" id="3890678">.</span><span class="ident" id="3890679">Reset</span><span class="op" id="3890684">(</span><span class="ident" id="3890685">nil</span><span class="op" id="3890688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3890691">if</span>&nbsp;<span class="ident" id="3890694">pool</span>&nbsp;<span class="op" id="3890699">:=</span>&nbsp;<span class="ident" id="3890702">bufioWriterPool</span><span class="op" id="3890717">(</span><span class="ident" id="3890718">bw</span><span class="op" id="3890720">.</span><span class="ident" id="3890721">Available</span><span class="op" id="3890730">(</span><span class="op" id="3890731">)</span><span class="op" id="3890732">)</span><span class="op" id="3890733">;</span>&nbsp;<span class="ident" id="3890735">pool</span>&nbsp;<span class="op" id="3890740">!=</span>&nbsp;<span class="ident" id="3890743">nil</span>&nbsp;<span class="op" id="3890747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3890751">pool</span><span class="op" id="3890755">.</span><span class="ident" id="3890756">Put</span><span class="op" id="3890759">(</span><span class="ident" id="3890760">bw</span><span class="op" id="3890762">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3890765">}</span><br>
<span class="lineno"></span><span class="op" id="3890767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3890770">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="3890840">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="3890863">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3890923">const</span>&nbsp;<span class="ident" id="3890929">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="3890951">=</span>&nbsp;<span class="num" id="3890953">1</span>&nbsp;<span class="op" id="3890955">&lt;&lt;</span>&nbsp;<span class="num" id="3890958">20</span>&nbsp;<span class="comment" id="3890961">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3890970">func</span>&nbsp;<span class="op" id="3890975">(</span><span class="ident" id="3890976">srv</span>&nbsp;<span class="op" id="3890980">*</span><span class="ident" id="3890981">Server</span><span class="op" id="3890987">)</span>&nbsp;<span class="ident" id="3890989">maxHeaderBytes</span><span class="op" id="3891003">(</span><span class="op" id="3891004">)</span>&nbsp;<span class="builtintype" id="3891006">int</span>&nbsp;<span class="op" id="3891010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3891013">if</span>&nbsp;<span class="ident" id="3891016">srv</span><span class="op" id="3891019">.</span><span class="ident" id="3891020">MaxHeaderBytes</span>&nbsp;<span class="op" id="3891035">&gt;</span>&nbsp;<span class="num" id="3891037">0</span>&nbsp;<span class="op" id="3891039">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3891043">return</span>&nbsp;<span class="ident" id="3891050">srv</span><span class="op" id="3891053">.</span><span class="ident" id="3891054">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3891070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3891073">return</span>&nbsp;<span class="ident" id="3891080">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="3891102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3891105">func</span>&nbsp;<span class="op" id="3891110">(</span><span class="ident" id="3891111">srv</span>&nbsp;<span class="op" id="3891115">*</span><span class="ident" id="3891116">Server</span><span class="op" id="3891122">)</span>&nbsp;<span class="ident" id="3891124">initialLimitedReaderSize</span><span class="op" id="3891148">(</span><span class="op" id="3891149">)</span>&nbsp;<span class="ident" id="3891151">int64</span>&nbsp;<span class="op" id="3891157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3891160">return</span>&nbsp;<span class="ident" id="3891167">int64</span><span class="op" id="3891172">(</span><span class="ident" id="3891173">srv</span><span class="op" id="3891176">.</span><span class="ident" id="3891177">maxHeaderBytes</span><span class="op" id="3891191">(</span><span class="op" id="3891192">)</span><span class="op" id="3891193">)</span>&nbsp;<span class="op" id="3891195">+</span>&nbsp;<span class="num" id="3891197">4096</span>&nbsp;<span class="comment" id="3891202">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="3891216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3891219">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="3891283">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3891315">type</span>&nbsp;<span class="ident" id="3891320">expectContinueReader</span>&nbsp;<span class="keyword" id="3891341">struct</span>&nbsp;<span class="op" id="3891348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3891351">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3891362">*</span><span class="ident" id="3891363">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3891373">readCloser</span>&nbsp;<span class="ident" id="3891384">io</span><span class="op" id="3891386">.</span><span class="ident" id="3891387">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3891399">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3891410">bool</span><br>
<span class="lineno">520</span><span class="op" id="3891415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3891418">func</span>&nbsp;<span class="op" id="3891423">(</span><span class="ident" id="3891424">ecr</span>&nbsp;<span class="op" id="3891428">*</span><span class="ident" id="3891429">expectContinueReader</span><span class="op" id="3891449">)</span>&nbsp;<span class="ident" id="3891451">Read</span><span class="op" id="3891455">(</span><span class="ident" id="3891456">p</span>&nbsp;<span class="op" id="3891458">[</span><span class="op" id="3891459">]</span><span class="builtintype" id="3891460">byte</span><span class="op" id="3891464">)</span>&nbsp;<span class="op" id="3891466">(</span><span class="ident" id="3891467">n</span>&nbsp;<span class="builtintype" id="3891469">int</span><span class="op" id="3891472">,</span>&nbsp;<span class="ident" id="3891474">err</span>&nbsp;<span class="builtintype" id="3891478">error</span><span class="op" id="3891483">)</span>&nbsp;<span class="op" id="3891485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3891488">if</span>&nbsp;<span class="ident" id="3891491">ecr</span><span class="op" id="3891494">.</span><span class="ident" id="3891495">closed</span>&nbsp;<span class="op" id="3891502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3891506">return</span>&nbsp;<span class="num" id="3891513">0</span><span class="op" id="3891514">,</span>&nbsp;<span class="ident" id="3891516">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3891539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3891542">if</span>&nbsp;<span class="op" id="3891545">!</span><span class="ident" id="3891546">ecr</span><span class="op" id="3891549">.</span><span class="ident" id="3891550">resp</span><span class="op" id="3891554">.</span><span class="ident" id="3891555">wroteContinue</span>&nbsp;<span class="op" id="3891569">&amp;&amp;</span>&nbsp;<span class="op" id="3891572">!</span><span class="ident" id="3891573">ecr</span><span class="op" id="3891576">.</span><span class="ident" id="3891577">resp</span><span class="op" id="3891581">.</span><span class="ident" id="3891582">conn</span><span class="op" id="3891586">.</span><span class="ident" id="3891587">hijacked</span><span class="op" id="3891595">(</span><span class="op" id="3891596">)</span>&nbsp;<span class="op" id="3891598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3891602">ecr</span><span class="op" id="3891605">.</span><span class="ident" id="3891606">resp</span><span class="op" id="3891610">.</span><span class="ident" id="3891611">wroteContinue</span>&nbsp;<span class="op" id="3891625">=</span>&nbsp;<span class="builtintype" id="3891627">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3891634">ecr</span><span class="op" id="3891637">.</span><span class="ident" id="3891638">resp</span><span class="op" id="3891642">.</span><span class="ident" id="3891643">conn</span><span class="op" id="3891647">.</span><span class="ident" id="3891648">buf</span><span class="op" id="3891651">.</span><span class="ident" id="3891652">WriteString</span><span class="op" id="3891663">(</span><span class="string" id="3891664">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="3891695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3891699">ecr</span><span class="op" id="3891702">.</span><span class="ident" id="3891703">resp</span><span class="op" id="3891707">.</span><span class="ident" id="3891708">conn</span><span class="op" id="3891712">.</span><span class="ident" id="3891713">buf</span><span class="op" id="3891716">.</span><span class="ident" id="3891717">Flush</span><span class="op" id="3891722">(</span><span class="op" id="3891723">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3891726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3891729">return</span>&nbsp;<span class="ident" id="3891736">ecr</span><span class="op" id="3891739">.</span><span class="ident" id="3891740">readCloser</span><span class="op" id="3891750">.</span><span class="ident" id="3891751">Read</span><span class="op" id="3891755">(</span><span class="ident" id="3891756">p</span><span class="op" id="3891757">)</span><br>
<span class="lineno"></span><span class="op" id="3891759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3891762">func</span>&nbsp;<span class="op" id="3891767">(</span><span class="ident" id="3891768">ecr</span>&nbsp;<span class="op" id="3891772">*</span><span class="ident" id="3891773">expectContinueReader</span><span class="op" id="3891793">)</span>&nbsp;<span class="ident" id="3891795">Close</span><span class="op" id="3891800">(</span><span class="op" id="3891801">)</span>&nbsp;<span class="builtintype" id="3891803">error</span>&nbsp;<span class="op" id="3891809">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3891812">ecr</span><span class="op" id="3891815">.</span><span class="ident" id="3891816">closed</span>&nbsp;<span class="op" id="3891823">=</span>&nbsp;<span class="builtintype" id="3891825">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3891831">return</span>&nbsp;<span class="ident" id="3891838">ecr</span><span class="op" id="3891841">.</span><span class="ident" id="3891842">readCloser</span><span class="op" id="3891852">.</span><span class="ident" id="3891853">Close</span><span class="op" id="3891858">(</span><span class="op" id="3891859">)</span><br>
<span class="lineno"></span><span class="op" id="3891861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3891864">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="3891909">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="3891957">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="3891997">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="3892061">const</span>&nbsp;<span class="ident" id="3892067">TimeFormat</span>&nbsp;<span class="op" id="3892078">=</span>&nbsp;<span class="string" id="3892080">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="3892113">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="3892193">func</span>&nbsp;<span class="ident" id="3892198">appendTime</span><span class="op" id="3892208">(</span><span class="ident" id="3892209">b</span>&nbsp;<span class="op" id="3892211">[</span><span class="op" id="3892212">]</span><span class="builtintype" id="3892213">byte</span><span class="op" id="3892217">,</span>&nbsp;<span class="ident" id="3892219">t</span>&nbsp;<span class="ident" id="3892221">time</span><span class="op" id="3892225">.</span><span class="ident" id="3892226">Time</span><span class="op" id="3892230">)</span>&nbsp;<span class="op" id="3892232">[</span><span class="op" id="3892233">]</span><span class="builtintype" id="3892234">byte</span>&nbsp;<span class="op" id="3892239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3892242">const</span>&nbsp;<span class="ident" id="3892248">days</span>&nbsp;<span class="op" id="3892253">=</span>&nbsp;<span class="string" id="3892255">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3892280">const</span>&nbsp;<span class="ident" id="3892286">months</span>&nbsp;<span class="op" id="3892293">=</span>&nbsp;<span class="string" id="3892295">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3892336">t</span>&nbsp;<span class="op" id="3892338">=</span>&nbsp;<span class="ident" id="3892340">t</span><span class="op" id="3892341">.</span><span class="ident" id="3892342">UTC</span><span class="op" id="3892345">(</span><span class="op" id="3892346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3892349">yy</span><span class="op" id="3892351">,</span>&nbsp;<span class="ident" id="3892353">mm</span><span class="op" id="3892355">,</span>&nbsp;<span class="ident" id="3892357">dd</span>&nbsp;<span class="op" id="3892360">:=</span>&nbsp;<span class="ident" id="3892363">t</span><span class="op" id="3892364">.</span><span class="ident" id="3892365">Date</span><span class="op" id="3892369">(</span><span class="op" id="3892370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3892373">hh</span><span class="op" id="3892375">,</span>&nbsp;<span class="ident" id="3892377">mn</span><span class="op" id="3892379">,</span>&nbsp;<span class="ident" id="3892381">ss</span>&nbsp;<span class="op" id="3892384">:=</span>&nbsp;<span class="ident" id="3892387">t</span><span class="op" id="3892388">.</span><span class="ident" id="3892389">Clock</span><span class="op" id="3892394">(</span><span class="op" id="3892395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3892398">day</span>&nbsp;<span class="op" id="3892402">:=</span>&nbsp;<span class="ident" id="3892405">days</span><span class="op" id="3892409">[</span><span class="num" id="3892410">3</span><span class="op" id="3892411">*</span><span class="ident" id="3892412">t</span><span class="op" id="3892413">.</span><span class="ident" id="3892414">Weekday</span><span class="op" id="3892421">(</span><span class="op" id="3892422">)</span><span class="op" id="3892423">:</span><span class="op" id="3892424">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3892427">mon</span>&nbsp;<span class="op" id="3892431">:=</span>&nbsp;<span class="ident" id="3892434">months</span><span class="op" id="3892440">[</span><span class="num" id="3892441">3</span><span class="op" id="3892442">*</span><span class="op" id="3892443">(</span><span class="ident" id="3892444">mm</span><span class="op" id="3892446">-</span><span class="num" id="3892447">1</span><span class="op" id="3892448">)</span><span class="op" id="3892449">:</span><span class="op" id="3892450">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3892454">return</span>&nbsp;<span class="builtinfunc" id="3892461">append</span><span class="op" id="3892467">(</span><span class="ident" id="3892468">b</span><span class="op" id="3892469">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3892473">day</span><span class="op" id="3892476">[</span><span class="num" id="3892477">0</span><span class="op" id="3892478">]</span><span class="op" id="3892479">,</span>&nbsp;<span class="ident" id="3892481">day</span><span class="op" id="3892484">[</span><span class="num" id="3892485">1</span><span class="op" id="3892486">]</span><span class="op" id="3892487">,</span>&nbsp;<span class="ident" id="3892489">day</span><span class="op" id="3892492">[</span><span class="num" id="3892493">2</span><span class="op" id="3892494">]</span><span class="op" id="3892495">,</span>&nbsp;<span class="string" id="3892497">&#39;,&#39;</span><span class="op" id="3892500">,</span>&nbsp;<span class="string" id="3892502">&#39;&nbsp;&#39;</span><span class="op" id="3892505">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3892509">byte</span><span class="op" id="3892513">(</span><span class="string" id="3892514">&#39;0&#39;</span><span class="op" id="3892517">+</span><span class="ident" id="3892518">dd</span><span class="op" id="3892520">/</span><span class="num" id="3892521">10</span><span class="op" id="3892523">)</span><span class="op" id="3892524">,</span>&nbsp;<span class="builtintype" id="3892526">byte</span><span class="op" id="3892530">(</span><span class="string" id="3892531">&#39;0&#39;</span><span class="op" id="3892534">+</span><span class="ident" id="3892535">dd</span><span class="op" id="3892537">%</span><span class="num" id="3892538">10</span><span class="op" id="3892540">)</span><span class="op" id="3892541">,</span>&nbsp;<span class="string" id="3892543">&#39;&nbsp;&#39;</span><span class="op" id="3892546">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3892550">mon</span><span class="op" id="3892553">[</span><span class="num" id="3892554">0</span><span class="op" id="3892555">]</span><span class="op" id="3892556">,</span>&nbsp;<span class="ident" id="3892558">mon</span><span class="op" id="3892561">[</span><span class="num" id="3892562">1</span><span class="op" id="3892563">]</span><span class="op" id="3892564">,</span>&nbsp;<span class="ident" id="3892566">mon</span><span class="op" id="3892569">[</span><span class="num" id="3892570">2</span><span class="op" id="3892571">]</span><span class="op" id="3892572">,</span>&nbsp;<span class="string" id="3892574">&#39;&nbsp;&#39;</span><span class="op" id="3892577">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3892581">byte</span><span class="op" id="3892585">(</span><span class="string" id="3892586">&#39;0&#39;</span><span class="op" id="3892589">+</span><span class="ident" id="3892590">yy</span><span class="op" id="3892592">/</span><span class="num" id="3892593">1000</span><span class="op" id="3892597">)</span><span class="op" id="3892598">,</span>&nbsp;<span class="builtintype" id="3892600">byte</span><span class="op" id="3892604">(</span><span class="string" id="3892605">&#39;0&#39;</span><span class="op" id="3892608">+</span><span class="op" id="3892609">(</span><span class="ident" id="3892610">yy</span><span class="op" id="3892612">/</span><span class="num" id="3892613">100</span><span class="op" id="3892616">)</span><span class="op" id="3892617">%</span><span class="num" id="3892618">10</span><span class="op" id="3892620">)</span><span class="op" id="3892621">,</span>&nbsp;<span class="builtintype" id="3892623">byte</span><span class="op" id="3892627">(</span><span class="string" id="3892628">&#39;0&#39;</span><span class="op" id="3892631">+</span><span class="op" id="3892632">(</span><span class="ident" id="3892633">yy</span><span class="op" id="3892635">/</span><span class="num" id="3892636">10</span><span class="op" id="3892638">)</span><span class="op" id="3892639">%</span><span class="num" id="3892640">10</span><span class="op" id="3892642">)</span><span class="op" id="3892643">,</span>&nbsp;<span class="builtintype" id="3892645">byte</span><span class="op" id="3892649">(</span><span class="string" id="3892650">&#39;0&#39;</span><span class="op" id="3892653">+</span><span class="ident" id="3892654">yy</span><span class="op" id="3892656">%</span><span class="num" id="3892657">10</span><span class="op" id="3892659">)</span><span class="op" id="3892660">,</span>&nbsp;<span class="string" id="3892662">&#39;&nbsp;&#39;</span><span class="op" id="3892665">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3892669">byte</span><span class="op" id="3892673">(</span><span class="string" id="3892674">&#39;0&#39;</span><span class="op" id="3892677">+</span><span class="ident" id="3892678">hh</span><span class="op" id="3892680">/</span><span class="num" id="3892681">10</span><span class="op" id="3892683">)</span><span class="op" id="3892684">,</span>&nbsp;<span class="builtintype" id="3892686">byte</span><span class="op" id="3892690">(</span><span class="string" id="3892691">&#39;0&#39;</span><span class="op" id="3892694">+</span><span class="ident" id="3892695">hh</span><span class="op" id="3892697">%</span><span class="num" id="3892698">10</span><span class="op" id="3892700">)</span><span class="op" id="3892701">,</span>&nbsp;<span class="string" id="3892703">&#39;:&#39;</span><span class="op" id="3892706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3892710">byte</span><span class="op" id="3892714">(</span><span class="string" id="3892715">&#39;0&#39;</span><span class="op" id="3892718">+</span><span class="ident" id="3892719">mn</span><span class="op" id="3892721">/</span><span class="num" id="3892722">10</span><span class="op" id="3892724">)</span><span class="op" id="3892725">,</span>&nbsp;<span class="builtintype" id="3892727">byte</span><span class="op" id="3892731">(</span><span class="string" id="3892732">&#39;0&#39;</span><span class="op" id="3892735">+</span><span class="ident" id="3892736">mn</span><span class="op" id="3892738">%</span><span class="num" id="3892739">10</span><span class="op" id="3892741">)</span><span class="op" id="3892742">,</span>&nbsp;<span class="string" id="3892744">&#39;:&#39;</span><span class="op" id="3892747">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3892751">byte</span><span class="op" id="3892755">(</span><span class="string" id="3892756">&#39;0&#39;</span><span class="op" id="3892759">+</span><span class="ident" id="3892760">ss</span><span class="op" id="3892762">/</span><span class="num" id="3892763">10</span><span class="op" id="3892765">)</span><span class="op" id="3892766">,</span>&nbsp;<span class="builtintype" id="3892768">byte</span><span class="op" id="3892772">(</span><span class="string" id="3892773">&#39;0&#39;</span><span class="op" id="3892776">+</span><span class="ident" id="3892777">ss</span><span class="op" id="3892779">%</span><span class="num" id="3892780">10</span><span class="op" id="3892782">)</span><span class="op" id="3892783">,</span>&nbsp;<span class="string" id="3892785">&#39;&nbsp;&#39;</span><span class="op" id="3892788">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3892792">&#39;G&#39;</span><span class="op" id="3892795">,</span>&nbsp;<span class="string" id="3892797">&#39;M&#39;</span><span class="op" id="3892800">,</span>&nbsp;<span class="string" id="3892802">&#39;T&#39;</span><span class="op" id="3892805">)</span><br>
<span class="lineno">565</span><span class="op" id="3892807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3892810">var</span>&nbsp;<span class="ident" id="3892814">errTooLarge</span>&nbsp;<span class="op" id="3892826">=</span>&nbsp;<span class="ident" id="3892828">errors</span><span class="op" id="3892834">.</span><span class="ident" id="3892835">New</span><span class="op" id="3892838">(</span><span class="string" id="3892839">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="3892864">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3892867">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="3892905">func</span>&nbsp;<span class="op" id="3892910">(</span><span class="ident" id="3892911">c</span>&nbsp;<span class="op" id="3892913">*</span><span class="ident" id="3892914">conn</span><span class="op" id="3892918">)</span>&nbsp;<span class="ident" id="3892920">readRequest</span><span class="op" id="3892931">(</span><span class="op" id="3892932">)</span>&nbsp;<span class="op" id="3892934">(</span><span class="ident" id="3892935">w</span>&nbsp;<span class="op" id="3892937">*</span><span class="ident" id="3892938">response</span><span class="op" id="3892946">,</span>&nbsp;<span class="ident" id="3892948">err</span>&nbsp;<span class="builtintype" id="3892952">error</span><span class="op" id="3892957">)</span>&nbsp;<span class="op" id="3892959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3892962">if</span>&nbsp;<span class="ident" id="3892965">c</span><span class="op" id="3892966">.</span><span class="ident" id="3892967">hijacked</span><span class="op" id="3892975">(</span><span class="op" id="3892976">)</span>&nbsp;<span class="op" id="3892978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3892982">return</span>&nbsp;<span class="ident" id="3892989">nil</span><span class="op" id="3892992">,</span>&nbsp;<span class="ident" id="3892994">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3893007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3893011">if</span>&nbsp;<span class="ident" id="3893014">d</span>&nbsp;<span class="op" id="3893016">:=</span>&nbsp;<span class="ident" id="3893019">c</span><span class="op" id="3893020">.</span><span class="ident" id="3893021">server</span><span class="op" id="3893027">.</span><span class="ident" id="3893028">ReadTimeout</span><span class="op" id="3893039">;</span>&nbsp;<span class="ident" id="3893041">d</span>&nbsp;<span class="op" id="3893043">!=</span>&nbsp;<span class="num" id="3893046">0</span>&nbsp;<span class="op" id="3893048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893052">c</span><span class="op" id="3893053">.</span><span class="ident" id="3893054">rwc</span><span class="op" id="3893057">.</span><span class="ident" id="3893058">SetReadDeadline</span><span class="op" id="3893073">(</span><span class="ident" id="3893074">time</span><span class="op" id="3893078">.</span><span class="ident" id="3893079">Now</span><span class="op" id="3893082">(</span><span class="op" id="3893083">)</span><span class="op" id="3893084">.</span><span class="ident" id="3893085">Add</span><span class="op" id="3893088">(</span><span class="ident" id="3893089">d</span><span class="op" id="3893090">)</span><span class="op" id="3893091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3893094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3893097">if</span>&nbsp;<span class="ident" id="3893100">d</span>&nbsp;<span class="op" id="3893102">:=</span>&nbsp;<span class="ident" id="3893105">c</span><span class="op" id="3893106">.</span><span class="ident" id="3893107">server</span><span class="op" id="3893113">.</span><span class="ident" id="3893114">WriteTimeout</span><span class="op" id="3893126">;</span>&nbsp;<span class="ident" id="3893128">d</span>&nbsp;<span class="op" id="3893130">!=</span>&nbsp;<span class="num" id="3893133">0</span>&nbsp;<span class="op" id="3893135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3893139">defer</span>&nbsp;<span class="keyword" id="3893145">func</span><span class="op" id="3893149">(</span><span class="op" id="3893150">)</span>&nbsp;<span class="op" id="3893152">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893157">c</span><span class="op" id="3893158">.</span><span class="ident" id="3893159">rwc</span><span class="op" id="3893162">.</span><span class="ident" id="3893163">SetWriteDeadline</span><span class="op" id="3893179">(</span><span class="ident" id="3893180">time</span><span class="op" id="3893184">.</span><span class="ident" id="3893185">Now</span><span class="op" id="3893188">(</span><span class="op" id="3893189">)</span><span class="op" id="3893190">.</span><span class="ident" id="3893191">Add</span><span class="op" id="3893194">(</span><span class="ident" id="3893195">d</span><span class="op" id="3893196">)</span><span class="op" id="3893197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3893201">}</span><span class="op" id="3893202">(</span><span class="op" id="3893203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3893206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893210">c</span><span class="op" id="3893211">.</span><span class="ident" id="3893212">lr</span><span class="op" id="3893214">.</span><span class="ident" id="3893215">N</span>&nbsp;<span class="op" id="3893217">=</span>&nbsp;<span class="ident" id="3893219">c</span><span class="op" id="3893220">.</span><span class="ident" id="3893221">server</span><span class="op" id="3893227">.</span><span class="ident" id="3893228">initialLimitedReaderSize</span><span class="op" id="3893252">(</span><span class="op" id="3893253">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3893256">var</span>&nbsp;<span class="ident" id="3893260">req</span>&nbsp;<span class="op" id="3893264">*</span><span class="ident" id="3893265">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3893274">if</span>&nbsp;<span class="ident" id="3893277">req</span><span class="op" id="3893280">,</span>&nbsp;<span class="ident" id="3893282">err</span>&nbsp;<span class="op" id="3893286">=</span>&nbsp;<span class="ident" id="3893288">ReadRequest</span><span class="op" id="3893299">(</span><span class="ident" id="3893300">c</span><span class="op" id="3893301">.</span><span class="ident" id="3893302">buf</span><span class="op" id="3893305">.</span><span class="ident" id="3893306">Reader</span><span class="op" id="3893312">)</span><span class="op" id="3893313">;</span>&nbsp;<span class="ident" id="3893315">err</span>&nbsp;<span class="op" id="3893319">!=</span>&nbsp;<span class="ident" id="3893322">nil</span>&nbsp;<span class="op" id="3893326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3893330">if</span>&nbsp;<span class="ident" id="3893333">c</span><span class="op" id="3893334">.</span><span class="ident" id="3893335">lr</span><span class="op" id="3893337">.</span><span class="ident" id="3893338">N</span>&nbsp;<span class="op" id="3893340">==</span>&nbsp;<span class="num" id="3893343">0</span>&nbsp;<span class="op" id="3893345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3893350">return</span>&nbsp;<span class="ident" id="3893357">nil</span><span class="op" id="3893360">,</span>&nbsp;<span class="ident" id="3893362">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3893376">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3893380">return</span>&nbsp;<span class="ident" id="3893387">nil</span><span class="op" id="3893390">,</span>&nbsp;<span class="ident" id="3893392">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3893397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893400">c</span><span class="op" id="3893401">.</span><span class="ident" id="3893402">lr</span><span class="op" id="3893404">.</span><span class="ident" id="3893405">N</span>&nbsp;<span class="op" id="3893407">=</span>&nbsp;<span class="ident" id="3893409">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893419">req</span><span class="op" id="3893422">.</span><span class="ident" id="3893423">RemoteAddr</span>&nbsp;<span class="op" id="3893434">=</span>&nbsp;<span class="ident" id="3893436">c</span><span class="op" id="3893437">.</span><span class="ident" id="3893438">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893450">req</span><span class="op" id="3893453">.</span><span class="ident" id="3893454">TLS</span>&nbsp;<span class="op" id="3893458">=</span>&nbsp;<span class="ident" id="3893460">c</span><span class="op" id="3893461">.</span><span class="ident" id="3893462">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893473">w</span>&nbsp;<span class="op" id="3893475">=</span>&nbsp;<span class="op" id="3893477">&amp;</span><span class="ident" id="3893478">response</span><span class="op" id="3893486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893490">conn</span><span class="op" id="3893494">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893505">c</span><span class="op" id="3893506">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893510">req</span><span class="op" id="3893513">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893525">req</span><span class="op" id="3893528">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893532">handlerHeader</span><span class="op" id="3893545">:</span>&nbsp;<span class="builtinfunc" id="3893547">make</span><span class="op" id="3893551">(</span><span class="ident" id="3893552">Header</span><span class="op" id="3893558">)</span><span class="op" id="3893559">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893563">contentLength</span><span class="op" id="3893576">:</span>&nbsp;<span class="op" id="3893578">-</span><span class="num" id="3893579">1</span><span class="op" id="3893580">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3893583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893586">w</span><span class="op" id="3893587">.</span><span class="ident" id="3893588">cw</span><span class="op" id="3893590">.</span><span class="ident" id="3893591">res</span>&nbsp;<span class="op" id="3893595">=</span>&nbsp;<span class="ident" id="3893597">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893600">w</span><span class="op" id="3893601">.</span><span class="ident" id="3893602">w</span>&nbsp;<span class="op" id="3893604">=</span>&nbsp;<span class="ident" id="3893606">newBufioWriterSize</span><span class="op" id="3893624">(</span><span class="op" id="3893625">&amp;</span><span class="ident" id="3893626">w</span><span class="op" id="3893627">.</span><span class="ident" id="3893628">cw</span><span class="op" id="3893630">,</span>&nbsp;<span class="ident" id="3893632">bufferBeforeChunkingSize</span><span class="op" id="3893656">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3893659">return</span>&nbsp;<span class="ident" id="3893666">w</span><span class="op" id="3893667">,</span>&nbsp;<span class="ident" id="3893669">nil</span><br>
<span class="lineno"></span><span class="op" id="3893673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3893676">func</span>&nbsp;<span class="op" id="3893681">(</span><span class="ident" id="3893682">w</span>&nbsp;<span class="op" id="3893684">*</span><span class="ident" id="3893685">response</span><span class="op" id="3893693">)</span>&nbsp;<span class="ident" id="3893695">Header</span><span class="op" id="3893701">(</span><span class="op" id="3893702">)</span>&nbsp;<span class="ident" id="3893704">Header</span>&nbsp;<span class="op" id="3893711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3893714">if</span>&nbsp;<span class="ident" id="3893717">w</span><span class="op" id="3893718">.</span><span class="ident" id="3893719">cw</span><span class="op" id="3893721">.</span><span class="ident" id="3893722">header</span>&nbsp;<span class="op" id="3893729">==</span>&nbsp;<span class="ident" id="3893732">nil</span>&nbsp;<span class="op" id="3893736">&amp;&amp;</span>&nbsp;<span class="ident" id="3893739">w</span><span class="op" id="3893740">.</span><span class="ident" id="3893741">wroteHeader</span>&nbsp;<span class="op" id="3893753">&amp;&amp;</span>&nbsp;<span class="op" id="3893756">!</span><span class="ident" id="3893757">w</span><span class="op" id="3893758">.</span><span class="ident" id="3893759">cw</span><span class="op" id="3893761">.</span><span class="ident" id="3893762">wroteHeader</span>&nbsp;<span class="op" id="3893774">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3893778">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3893833">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3893890">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893944">w</span><span class="op" id="3893945">.</span><span class="ident" id="3893946">cw</span><span class="op" id="3893948">.</span><span class="ident" id="3893949">header</span>&nbsp;<span class="op" id="3893956">=</span>&nbsp;<span class="ident" id="3893958">w</span><span class="op" id="3893959">.</span><span class="ident" id="3893960">handlerHeader</span><span class="op" id="3893973">.</span><span class="ident" id="3893974">clone</span><span class="op" id="3893979">(</span><span class="op" id="3893980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3893983">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3893986">w</span><span class="op" id="3893987">.</span><span class="ident" id="3893988">calledHeader</span>&nbsp;<span class="op" id="3894001">=</span>&nbsp;<span class="builtintype" id="3894003">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3894009">return</span>&nbsp;<span class="ident" id="3894016">w</span><span class="op" id="3894017">.</span><span class="ident" id="3894018">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="3894032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3894035">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="3894106">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3894173">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="3894243">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="3894311">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3894331">//</span><br>
<span class="lineno">625</span><span class="comment" id="3894334">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3894402">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3894472">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="3894491">const</span>&nbsp;<span class="ident" id="3894497">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3894521">=</span>&nbsp;<span class="num" id="3894523">256</span>&nbsp;<span class="op" id="3894527">&lt;&lt;</span>&nbsp;<span class="num" id="3894530">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="3894534">func</span>&nbsp;<span class="op" id="3894539">(</span><span class="ident" id="3894540">w</span>&nbsp;<span class="op" id="3894542">*</span><span class="ident" id="3894543">response</span><span class="op" id="3894551">)</span>&nbsp;<span class="ident" id="3894553">WriteHeader</span><span class="op" id="3894564">(</span><span class="ident" id="3894565">code</span>&nbsp;<span class="builtintype" id="3894570">int</span><span class="op" id="3894573">)</span>&nbsp;<span class="op" id="3894575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3894578">if</span>&nbsp;<span class="ident" id="3894581">w</span><span class="op" id="3894582">.</span><span class="ident" id="3894583">conn</span><span class="op" id="3894587">.</span><span class="ident" id="3894588">hijacked</span><span class="op" id="3894596">(</span><span class="op" id="3894597">)</span>&nbsp;<span class="op" id="3894599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3894603">w</span><span class="op" id="3894604">.</span><span class="ident" id="3894605">conn</span><span class="op" id="3894609">.</span><span class="ident" id="3894610">server</span><span class="op" id="3894616">.</span><span class="ident" id="3894617">logf</span><span class="op" id="3894621">(</span><span class="string" id="3894622">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3894673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3894677">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3894685">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3894688">if</span>&nbsp;<span class="ident" id="3894691">w</span><span class="op" id="3894692">.</span><span class="ident" id="3894693">wroteHeader</span>&nbsp;<span class="op" id="3894705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3894709">w</span><span class="op" id="3894710">.</span><span class="ident" id="3894711">conn</span><span class="op" id="3894715">.</span><span class="ident" id="3894716">server</span><span class="op" id="3894722">.</span><span class="ident" id="3894723">logf</span><span class="op" id="3894727">(</span><span class="string" id="3894728">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="3894771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3894775">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3894783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3894786">w</span><span class="op" id="3894787">.</span><span class="ident" id="3894788">wroteHeader</span>&nbsp;<span class="op" id="3894800">=</span>&nbsp;<span class="builtintype" id="3894802">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3894808">w</span><span class="op" id="3894809">.</span><span class="ident" id="3894810">status</span>&nbsp;<span class="op" id="3894817">=</span>&nbsp;<span class="ident" id="3894819">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3894826">if</span>&nbsp;<span class="ident" id="3894829">w</span><span class="op" id="3894830">.</span><span class="ident" id="3894831">calledHeader</span>&nbsp;<span class="op" id="3894844">&amp;&amp;</span>&nbsp;<span class="ident" id="3894847">w</span><span class="op" id="3894848">.</span><span class="ident" id="3894849">cw</span><span class="op" id="3894851">.</span><span class="ident" id="3894852">header</span>&nbsp;<span class="op" id="3894859">==</span>&nbsp;<span class="ident" id="3894862">nil</span>&nbsp;<span class="op" id="3894866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3894870">w</span><span class="op" id="3894871">.</span><span class="ident" id="3894872">cw</span><span class="op" id="3894874">.</span><span class="ident" id="3894875">header</span>&nbsp;<span class="op" id="3894882">=</span>&nbsp;<span class="ident" id="3894884">w</span><span class="op" id="3894885">.</span><span class="ident" id="3894886">handlerHeader</span><span class="op" id="3894899">.</span><span class="ident" id="3894900">clone</span><span class="op" id="3894905">(</span><span class="op" id="3894906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3894909">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3894913">if</span>&nbsp;<span class="ident" id="3894916">cl</span>&nbsp;<span class="op" id="3894919">:=</span>&nbsp;<span class="ident" id="3894922">w</span><span class="op" id="3894923">.</span><span class="ident" id="3894924">handlerHeader</span><span class="op" id="3894937">.</span><span class="ident" id="3894938">get</span><span class="op" id="3894941">(</span><span class="string" id="3894942">&#34;Content-Length&#34;</span><span class="op" id="3894958">)</span><span class="op" id="3894959">;</span>&nbsp;<span class="ident" id="3894961">cl</span>&nbsp;<span class="op" id="3894964">!=</span>&nbsp;<span class="string" id="3894967">&#34;&#34;</span>&nbsp;<span class="op" id="3894970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3894974">v</span><span class="op" id="3894975">,</span>&nbsp;<span class="ident" id="3894977">err</span>&nbsp;<span class="op" id="3894981">:=</span>&nbsp;<span class="ident" id="3894984">strconv</span><span class="op" id="3894991">.</span><span class="ident" id="3894992">ParseInt</span><span class="op" id="3895000">(</span><span class="ident" id="3895001">cl</span><span class="op" id="3895003">,</span>&nbsp;<span class="num" id="3895005">10</span><span class="op" id="3895007">,</span>&nbsp;<span class="num" id="3895009">64</span><span class="op" id="3895011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3895015">if</span>&nbsp;<span class="ident" id="3895018">err</span>&nbsp;<span class="op" id="3895022">==</span>&nbsp;<span class="ident" id="3895025">nil</span>&nbsp;<span class="op" id="3895029">&amp;&amp;</span>&nbsp;<span class="ident" id="3895032">v</span>&nbsp;<span class="op" id="3895034">&gt;=</span>&nbsp;<span class="num" id="3895037">0</span>&nbsp;<span class="op" id="3895039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3895044">w</span><span class="op" id="3895045">.</span><span class="ident" id="3895046">contentLength</span>&nbsp;<span class="op" id="3895060">=</span>&nbsp;<span class="ident" id="3895062">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3895066">}</span>&nbsp;<span class="keyword" id="3895068">else</span>&nbsp;<span class="op" id="3895073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3895078">w</span><span class="op" id="3895079">.</span><span class="ident" id="3895080">conn</span><span class="op" id="3895084">.</span><span class="ident" id="3895085">server</span><span class="op" id="3895091">.</span><span class="ident" id="3895092">logf</span><span class="op" id="3895096">(</span><span class="string" id="3895097">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="3895133">,</span>&nbsp;<span class="ident" id="3895135">cl</span><span class="op" id="3895137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3895142">w</span><span class="op" id="3895143">.</span><span class="ident" id="3895144">handlerHeader</span><span class="op" id="3895157">.</span><span class="ident" id="3895158">Del</span><span class="op" id="3895161">(</span><span class="string" id="3895162">&#34;Content-Length&#34;</span><span class="op" id="3895178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3895182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3895185">}</span><br>
<span class="lineno">655</span><span class="op" id="3895187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3895190">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="3895271">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="3895350">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="3895407">type</span>&nbsp;<span class="ident" id="3895412">extraHeader</span>&nbsp;<span class="keyword" id="3895424">struct</span>&nbsp;<span class="op" id="3895431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3895434">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3895451">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3895459">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3895476">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3895484">transferEncoding</span>&nbsp;<span class="builtintype" id="3895501">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3895509">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3895526">[</span><span class="op" id="3895527">]</span><span class="builtintype" id="3895528">byte</span>&nbsp;<span class="comment" id="3895533">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3895556">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3895573">[</span><span class="op" id="3895574">]</span><span class="builtintype" id="3895575">byte</span>&nbsp;<span class="comment" id="3895580">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3895602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3895605">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="3895653">var</span>&nbsp;<span class="ident" id="3895657">extraHeaderKeys</span>&nbsp;<span class="op" id="3895673">=</span>&nbsp;<span class="op" id="3895675">[</span><span class="op" id="3895676">]</span><span class="op" id="3895677">[</span><span class="op" id="3895678">]</span><span class="builtintype" id="3895679">byte</span><span class="op" id="3895683">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3895686">[</span><span class="op" id="3895687">]</span><span class="builtintype" id="3895688">byte</span><span class="op" id="3895692">(</span><span class="string" id="3895693">&#34;Content-Type&#34;</span><span class="op" id="3895707">)</span><span class="op" id="3895708">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3895711">[</span><span class="op" id="3895712">]</span><span class="builtintype" id="3895713">byte</span><span class="op" id="3895717">(</span><span class="string" id="3895718">&#34;Connection&#34;</span><span class="op" id="3895730">)</span><span class="op" id="3895731">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3895734">[</span><span class="op" id="3895735">]</span><span class="builtintype" id="3895736">byte</span><span class="op" id="3895740">(</span><span class="string" id="3895741">&#34;Transfer-Encoding&#34;</span><span class="op" id="3895760">)</span><span class="op" id="3895761">,</span><br>
<span class="lineno"></span><span class="op" id="3895763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="3895766">var</span>&nbsp;<span class="op" id="3895770">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3895773">headerContentLength</span>&nbsp;<span class="op" id="3895793">=</span>&nbsp;<span class="op" id="3895795">[</span><span class="op" id="3895796">]</span><span class="builtintype" id="3895797">byte</span><span class="op" id="3895801">(</span><span class="string" id="3895802">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3895820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3895823">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3895843">=</span>&nbsp;<span class="op" id="3895845">[</span><span class="op" id="3895846">]</span><span class="builtintype" id="3895847">byte</span><span class="op" id="3895851">(</span><span class="string" id="3895852">&#34;Date:&nbsp;&#34;</span><span class="op" id="3895860">)</span><br>
<span class="lineno"></span><span class="op" id="3895862">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="3895865">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="3895914">//</span><br>
<span class="lineno"></span><span class="comment" id="3895917">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="3895986">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3896056">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="3896115">func</span>&nbsp;<span class="op" id="3896120">(</span><span class="ident" id="3896121">h</span>&nbsp;<span class="ident" id="3896123">extraHeader</span><span class="op" id="3896134">)</span>&nbsp;<span class="ident" id="3896136">Write</span><span class="op" id="3896141">(</span><span class="ident" id="3896142">w</span>&nbsp;<span class="op" id="3896144">*</span><span class="ident" id="3896145">bufio</span><span class="op" id="3896150">.</span><span class="ident" id="3896151">Writer</span><span class="op" id="3896157">)</span>&nbsp;<span class="op" id="3896159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3896162">if</span>&nbsp;<span class="ident" id="3896165">h</span><span class="op" id="3896166">.</span><span class="ident" id="3896167">date</span>&nbsp;<span class="op" id="3896172">!=</span>&nbsp;<span class="ident" id="3896175">nil</span>&nbsp;<span class="op" id="3896179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3896183">w</span><span class="op" id="3896184">.</span><span class="ident" id="3896185">Write</span><span class="op" id="3896190">(</span><span class="ident" id="3896191">headerDate</span><span class="op" id="3896201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3896205">w</span><span class="op" id="3896206">.</span><span class="ident" id="3896207">Write</span><span class="op" id="3896212">(</span><span class="ident" id="3896213">h</span><span class="op" id="3896214">.</span><span class="ident" id="3896215">date</span><span class="op" id="3896219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3896223">w</span><span class="op" id="3896224">.</span><span class="ident" id="3896225">Write</span><span class="op" id="3896230">(</span><span class="ident" id="3896231">crlf</span><span class="op" id="3896235">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3896238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3896241">if</span>&nbsp;<span class="ident" id="3896244">h</span><span class="op" id="3896245">.</span><span class="ident" id="3896246">contentLength</span>&nbsp;<span class="op" id="3896260">!=</span>&nbsp;<span class="ident" id="3896263">nil</span>&nbsp;<span class="op" id="3896267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3896271">w</span><span class="op" id="3896272">.</span><span class="ident" id="3896273">Write</span><span class="op" id="3896278">(</span><span class="ident" id="3896279">headerContentLength</span><span class="op" id="3896298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3896302">w</span><span class="op" id="3896303">.</span><span class="ident" id="3896304">Write</span><span class="op" id="3896309">(</span><span class="ident" id="3896310">h</span><span class="op" id="3896311">.</span><span class="ident" id="3896312">contentLength</span><span class="op" id="3896325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3896329">w</span><span class="op" id="3896330">.</span><span class="ident" id="3896331">Write</span><span class="op" id="3896336">(</span><span class="ident" id="3896337">crlf</span><span class="op" id="3896341">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3896344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3896347">for</span>&nbsp;<span class="ident" id="3896351">i</span><span class="op" id="3896352">,</span>&nbsp;<span class="ident" id="3896354">v</span>&nbsp;<span class="op" id="3896356">:=</span>&nbsp;<span class="keyword" id="3896359">range</span>&nbsp;<span class="op" id="3896365">[</span><span class="op" id="3896366">]</span><span class="builtintype" id="3896367">string</span><span class="op" id="3896373">{</span><span class="ident" id="3896374">h</span><span class="op" id="3896375">.</span><span class="ident" id="3896376">contentType</span><span class="op" id="3896387">,</span>&nbsp;<span class="ident" id="3896389">h</span><span class="op" id="3896390">.</span><span class="ident" id="3896391">connection</span><span class="op" id="3896401">,</span>&nbsp;<span class="ident" id="3896403">h</span><span class="op" id="3896404">.</span><span class="ident" id="3896405">transferEncoding</span><span class="op" id="3896421">}</span>&nbsp;<span class="op" id="3896423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3896427">if</span>&nbsp;<span class="ident" id="3896430">v</span>&nbsp;<span class="op" id="3896432">!=</span>&nbsp;<span class="string" id="3896435">&#34;&#34;</span>&nbsp;<span class="op" id="3896438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3896443">w</span><span class="op" id="3896444">.</span><span class="ident" id="3896445">Write</span><span class="op" id="3896450">(</span><span class="ident" id="3896451">extraHeaderKeys</span><span class="op" id="3896466">[</span><span class="ident" id="3896467">i</span><span class="op" id="3896468">]</span><span class="op" id="3896469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3896474">w</span><span class="op" id="3896475">.</span><span class="ident" id="3896476">Write</span><span class="op" id="3896481">(</span><span class="ident" id="3896482">colonSpace</span><span class="op" id="3896492">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3896497">w</span><span class="op" id="3896498">.</span><span class="ident" id="3896499">WriteString</span><span class="op" id="3896510">(</span><span class="ident" id="3896511">v</span><span class="op" id="3896512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3896517">w</span><span class="op" id="3896518">.</span><span class="ident" id="3896519">Write</span><span class="op" id="3896524">(</span><span class="ident" id="3896525">crlf</span><span class="op" id="3896529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3896533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3896536">}</span><br>
<span class="lineno"></span><span class="op" id="3896538">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="3896541">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3896610">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="3896633">//</span><br>
<span class="lineno"></span><span class="comment" id="3896636">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="3896707">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3896777">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3896846">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3896912">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="3896924">func</span>&nbsp;<span class="op" id="3896929">(</span><span class="ident" id="3896930">cw</span>&nbsp;<span class="op" id="3896933">*</span><span class="ident" id="3896934">chunkWriter</span><span class="op" id="3896945">)</span>&nbsp;<span class="ident" id="3896947">writeHeader</span><span class="op" id="3896958">(</span><span class="ident" id="3896959">p</span>&nbsp;<span class="op" id="3896961">[</span><span class="op" id="3896962">]</span><span class="builtintype" id="3896963">byte</span><span class="op" id="3896967">)</span>&nbsp;<span class="op" id="3896969">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3896972">if</span>&nbsp;<span class="ident" id="3896975">cw</span><span class="op" id="3896977">.</span><span class="ident" id="3896978">wroteHeader</span>&nbsp;<span class="op" id="3896990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3896994">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3897002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3897005">cw</span><span class="op" id="3897007">.</span><span class="ident" id="3897008">wroteHeader</span>&nbsp;<span class="op" id="3897020">=</span>&nbsp;<span class="builtintype" id="3897022">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3897029">w</span>&nbsp;<span class="op" id="3897031">:=</span>&nbsp;<span class="ident" id="3897034">cw</span><span class="op" id="3897036">.</span><span class="ident" id="3897037">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3897042">keepAlivesEnabled</span>&nbsp;<span class="op" id="3897060">:=</span>&nbsp;<span class="ident" id="3897063">w</span><span class="op" id="3897064">.</span><span class="ident" id="3897065">conn</span><span class="op" id="3897069">.</span><span class="ident" id="3897070">server</span><span class="op" id="3897076">.</span><span class="ident" id="3897077">doKeepAlives</span><span class="op" id="3897089">(</span><span class="op" id="3897090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3897093">isHEAD</span>&nbsp;<span class="op" id="3897100">:=</span>&nbsp;<span class="ident" id="3897103">w</span><span class="op" id="3897104">.</span><span class="ident" id="3897105">req</span><span class="op" id="3897108">.</span><span class="ident" id="3897109">Method</span>&nbsp;<span class="op" id="3897116">==</span>&nbsp;<span class="string" id="3897119">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3897128">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3897192">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3897254">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3897310">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3897372">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3897400">header</span>&nbsp;<span class="op" id="3897407">:=</span>&nbsp;<span class="ident" id="3897410">cw</span><span class="op" id="3897412">.</span><span class="ident" id="3897413">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3897421">owned</span>&nbsp;<span class="op" id="3897427">:=</span>&nbsp;<span class="ident" id="3897430">header</span>&nbsp;<span class="op" id="3897437">!=</span>&nbsp;<span class="ident" id="3897440">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3897445">if</span>&nbsp;<span class="op" id="3897448">!</span><span class="ident" id="3897449">owned</span>&nbsp;<span class="op" id="3897455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3897459">header</span>&nbsp;<span class="op" id="3897466">=</span>&nbsp;<span class="ident" id="3897468">w</span><span class="op" id="3897469">.</span><span class="ident" id="3897470">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3897485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3897488">var</span>&nbsp;<span class="ident" id="3897492">excludeHeader</span>&nbsp;<span class="keyword" id="3897506">map</span><span class="op" id="3897509">[</span><span class="builtintype" id="3897510">string</span><span class="op" id="3897516">]</span><span class="builtintype" id="3897517">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3897523">delHeader</span>&nbsp;<span class="op" id="3897533">:=</span>&nbsp;<span class="keyword" id="3897536">func</span><span class="op" id="3897540">(</span><span class="ident" id="3897541">key</span>&nbsp;<span class="builtintype" id="3897545">string</span><span class="op" id="3897551">)</span>&nbsp;<span class="op" id="3897553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3897557">if</span>&nbsp;<span class="ident" id="3897560">owned</span>&nbsp;<span class="op" id="3897566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3897571">header</span><span class="op" id="3897577">.</span><span class="ident" id="3897578">Del</span><span class="op" id="3897581">(</span><span class="ident" id="3897582">key</span><span class="op" id="3897585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3897590">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3897599">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3897603">if</span>&nbsp;<span class="ident" id="3897606">_</span><span class="op" id="3897607">,</span>&nbsp;<span class="ident" id="3897609">ok</span>&nbsp;<span class="op" id="3897612">:=</span>&nbsp;<span class="ident" id="3897615">header</span><span class="op" id="3897621">[</span><span class="ident" id="3897622">key</span><span class="op" id="3897625">]</span><span class="op" id="3897626">;</span>&nbsp;<span class="op" id="3897628">!</span><span class="ident" id="3897629">ok</span>&nbsp;<span class="op" id="3897632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3897637">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3897646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3897650">if</span>&nbsp;<span class="ident" id="3897653">excludeHeader</span>&nbsp;<span class="op" id="3897667">==</span>&nbsp;<span class="ident" id="3897670">nil</span>&nbsp;<span class="op" id="3897674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3897679">excludeHeader</span>&nbsp;<span class="op" id="3897693">=</span>&nbsp;<span class="builtinfunc" id="3897695">make</span><span class="op" id="3897699">(</span><span class="keyword" id="3897700">map</span><span class="op" id="3897703">[</span><span class="builtintype" id="3897704">string</span><span class="op" id="3897710">]</span><span class="builtintype" id="3897711">bool</span><span class="op" id="3897715">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3897719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3897723">excludeHeader</span><span class="op" id="3897736">[</span><span class="ident" id="3897737">key</span><span class="op" id="3897740">]</span>&nbsp;<span class="op" id="3897742">=</span>&nbsp;<span class="builtintype" id="3897744">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3897750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3897753">var</span>&nbsp;<span class="ident" id="3897757">setHeader</span>&nbsp;<span class="ident" id="3897767">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3897781">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3897840">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3897904">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3897965">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3898001">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3898072">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3898136">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3898198">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3898262">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3898326">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3898386">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3898448">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3898482">if</span>&nbsp;<span class="ident" id="3898485">w</span><span class="op" id="3898486">.</span><span class="ident" id="3898487">handlerDone</span>&nbsp;<span class="op" id="3898499">&amp;&amp;</span>&nbsp;<span class="ident" id="3898502">bodyAllowedForStatus</span><span class="op" id="3898522">(</span><span class="ident" id="3898523">w</span><span class="op" id="3898524">.</span><span class="ident" id="3898525">status</span><span class="op" id="3898531">)</span>&nbsp;<span class="op" id="3898533">&amp;&amp;</span>&nbsp;<span class="ident" id="3898536">header</span><span class="op" id="3898542">.</span><span class="ident" id="3898543">get</span><span class="op" id="3898546">(</span><span class="string" id="3898547">&#34;Content-Length&#34;</span><span class="op" id="3898563">)</span>&nbsp;<span class="op" id="3898565">==</span>&nbsp;<span class="string" id="3898568">&#34;&#34;</span>&nbsp;<span class="op" id="3898571">&amp;&amp;</span>&nbsp;<span class="op" id="3898574">(</span><span class="op" id="3898575">!</span><span class="ident" id="3898576">isHEAD</span>&nbsp;<span class="op" id="3898583">||</span>&nbsp;<span class="builtinfunc" id="3898586">len</span><span class="op" id="3898589">(</span><span class="ident" id="3898590">p</span><span class="op" id="3898591">)</span>&nbsp;<span class="op" id="3898593">&gt;</span>&nbsp;<span class="num" id="3898595">0</span><span class="op" id="3898596">)</span>&nbsp;<span class="op" id="3898598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3898602">w</span><span class="op" id="3898603">.</span><span class="ident" id="3898604">contentLength</span>&nbsp;<span class="op" id="3898618">=</span>&nbsp;<span class="ident" id="3898620">int64</span><span class="op" id="3898625">(</span><span class="builtinfunc" id="3898626">len</span><span class="op" id="3898629">(</span><span class="ident" id="3898630">p</span><span class="op" id="3898631">)</span><span class="op" id="3898632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3898636">setHeader</span><span class="op" id="3898645">.</span><span class="ident" id="3898646">contentLength</span>&nbsp;<span class="op" id="3898660">=</span>&nbsp;<span class="ident" id="3898662">strconv</span><span class="op" id="3898669">.</span><span class="ident" id="3898670">AppendInt</span><span class="op" id="3898679">(</span><span class="ident" id="3898680">cw</span><span class="op" id="3898682">.</span><span class="ident" id="3898683">res</span><span class="op" id="3898686">.</span><span class="ident" id="3898687">clenBuf</span><span class="op" id="3898694">[</span><span class="op" id="3898695">:</span><span class="num" id="3898696">0</span><span class="op" id="3898697">]</span><span class="op" id="3898698">,</span>&nbsp;<span class="ident" id="3898700">int64</span><span class="op" id="3898705">(</span><span class="builtinfunc" id="3898706">len</span><span class="op" id="3898709">(</span><span class="ident" id="3898710">p</span><span class="op" id="3898711">)</span><span class="op" id="3898712">)</span><span class="op" id="3898713">,</span>&nbsp;<span class="num" id="3898715">10</span><span class="op" id="3898717">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3898720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3898724">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3898790">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3898858">if</span>&nbsp;<span class="ident" id="3898861">w</span><span class="op" id="3898862">.</span><span class="ident" id="3898863">req</span><span class="op" id="3898866">.</span><span class="ident" id="3898867">wantsHttp10KeepAlive</span><span class="op" id="3898887">(</span><span class="op" id="3898888">)</span>&nbsp;<span class="op" id="3898890">&amp;&amp;</span>&nbsp;<span class="ident" id="3898893">keepAlivesEnabled</span>&nbsp;<span class="op" id="3898911">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3898915">sentLength</span>&nbsp;<span class="op" id="3898926">:=</span>&nbsp;<span class="ident" id="3898929">header</span><span class="op" id="3898935">.</span><span class="ident" id="3898936">get</span><span class="op" id="3898939">(</span><span class="string" id="3898940">&#34;Content-Length&#34;</span><span class="op" id="3898956">)</span>&nbsp;<span class="op" id="3898958">!=</span>&nbsp;<span class="string" id="3898961">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3898966">if</span>&nbsp;<span class="ident" id="3898969">sentLength</span>&nbsp;<span class="op" id="3898980">&amp;&amp;</span>&nbsp;<span class="ident" id="3898983">header</span><span class="op" id="3898989">.</span><span class="ident" id="3898990">get</span><span class="op" id="3898993">(</span><span class="string" id="3898994">&#34;Connection&#34;</span><span class="op" id="3899006">)</span>&nbsp;<span class="op" id="3899008">==</span>&nbsp;<span class="string" id="3899011">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="3899024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3899029">w</span><span class="op" id="3899030">.</span><span class="ident" id="3899031">closeAfterReply</span>&nbsp;<span class="op" id="3899047">=</span>&nbsp;<span class="builtintype" id="3899049">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3899057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3899060">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3899064">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3899124">hasCL</span>&nbsp;<span class="op" id="3899130">:=</span>&nbsp;<span class="ident" id="3899133">w</span><span class="op" id="3899134">.</span><span class="ident" id="3899135">contentLength</span>&nbsp;<span class="op" id="3899149">!=</span>&nbsp;<span class="op" id="3899152">-</span><span class="num" id="3899153">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3899157">if</span>&nbsp;<span class="ident" id="3899160">w</span><span class="op" id="3899161">.</span><span class="ident" id="3899162">req</span><span class="op" id="3899165">.</span><span class="ident" id="3899166">wantsHttp10KeepAlive</span><span class="op" id="3899186">(</span><span class="op" id="3899187">)</span>&nbsp;<span class="op" id="3899189">&amp;&amp;</span>&nbsp;<span class="op" id="3899192">(</span><span class="ident" id="3899193">isHEAD</span>&nbsp;<span class="op" id="3899200">||</span>&nbsp;<span class="ident" id="3899203">hasCL</span><span class="op" id="3899208">)</span>&nbsp;<span class="op" id="3899210">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3899214">_</span><span class="op" id="3899215">,</span>&nbsp;<span class="ident" id="3899217">connectionHeaderSet</span>&nbsp;<span class="op" id="3899237">:=</span>&nbsp;<span class="ident" id="3899240">header</span><span class="op" id="3899246">[</span><span class="string" id="3899247">&#34;Connection&#34;</span><span class="op" id="3899259">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3899263">if</span>&nbsp;<span class="op" id="3899266">!</span><span class="ident" id="3899267">connectionHeaderSet</span>&nbsp;<span class="op" id="3899287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3899292">setHeader</span><span class="op" id="3899301">.</span><span class="ident" id="3899302">connection</span>&nbsp;<span class="op" id="3899313">=</span>&nbsp;<span class="string" id="3899315">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3899330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3899333">}</span>&nbsp;<span class="keyword" id="3899335">else</span>&nbsp;<span class="keyword" id="3899340">if</span>&nbsp;<span class="op" id="3899343">!</span><span class="ident" id="3899344">w</span><span class="op" id="3899345">.</span><span class="ident" id="3899346">req</span><span class="op" id="3899349">.</span><span class="ident" id="3899350">ProtoAtLeast</span><span class="op" id="3899362">(</span><span class="num" id="3899363">1</span><span class="op" id="3899364">,</span>&nbsp;<span class="num" id="3899366">1</span><span class="op" id="3899367">)</span>&nbsp;<span class="op" id="3899369">||</span>&nbsp;<span class="ident" id="3899372">w</span><span class="op" id="3899373">.</span><span class="ident" id="3899374">req</span><span class="op" id="3899377">.</span><span class="ident" id="3899378">wantsClose</span><span class="op" id="3899388">(</span><span class="op" id="3899389">)</span>&nbsp;<span class="op" id="3899391">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3899395">w</span><span class="op" id="3899396">.</span><span class="ident" id="3899397">closeAfterReply</span>&nbsp;<span class="op" id="3899413">=</span>&nbsp;<span class="builtintype" id="3899415">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3899421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3899425">if</span>&nbsp;<span class="ident" id="3899428">header</span><span class="op" id="3899434">.</span><span class="ident" id="3899435">get</span><span class="op" id="3899438">(</span><span class="string" id="3899439">&#34;Connection&#34;</span><span class="op" id="3899451">)</span>&nbsp;<span class="op" id="3899453">==</span>&nbsp;<span class="string" id="3899456">&#34;close&#34;</span>&nbsp;<span class="op" id="3899464">||</span>&nbsp;<span class="op" id="3899467">!</span><span class="ident" id="3899468">keepAlivesEnabled</span>&nbsp;<span class="op" id="3899486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3899490">w</span><span class="op" id="3899491">.</span><span class="ident" id="3899492">closeAfterReply</span>&nbsp;<span class="op" id="3899508">=</span>&nbsp;<span class="builtintype" id="3899510">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3899516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3899520">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3899580">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3899641">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3899702">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3899753">if</span>&nbsp;<span class="ident" id="3899756">w</span><span class="op" id="3899757">.</span><span class="ident" id="3899758">req</span><span class="op" id="3899761">.</span><span class="ident" id="3899762">ContentLength</span>&nbsp;<span class="op" id="3899776">!=</span>&nbsp;<span class="num" id="3899779">0</span>&nbsp;<span class="op" id="3899781">&amp;&amp;</span>&nbsp;<span class="op" id="3899784">!</span><span class="ident" id="3899785">w</span><span class="op" id="3899786">.</span><span class="ident" id="3899787">closeAfterReply</span>&nbsp;<span class="op" id="3899803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3899807">ecr</span><span class="op" id="3899810">,</span>&nbsp;<span class="ident" id="3899812">isExpecter</span>&nbsp;<span class="op" id="3899823">:=</span>&nbsp;<span class="ident" id="3899826">w</span><span class="op" id="3899827">.</span><span class="ident" id="3899828">req</span><span class="op" id="3899831">.</span><span class="ident" id="3899832">Body</span><span class="op" id="3899836">.</span><span class="op" id="3899837">(</span><span class="op" id="3899838">*</span><span class="ident" id="3899839">expectContinueReader</span><span class="op" id="3899859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3899863">if</span>&nbsp;<span class="op" id="3899866">!</span><span class="ident" id="3899867">isExpecter</span>&nbsp;<span class="op" id="3899878">||</span>&nbsp;<span class="ident" id="3899881">ecr</span><span class="op" id="3899884">.</span><span class="ident" id="3899885">resp</span><span class="op" id="3899889">.</span><span class="ident" id="3899890">wroteContinue</span>&nbsp;<span class="op" id="3899904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3899909">n</span><span class="op" id="3899910">,</span>&nbsp;<span class="ident" id="3899912">_</span>&nbsp;<span class="op" id="3899914">:=</span>&nbsp;<span class="ident" id="3899917">io</span><span class="op" id="3899919">.</span><span class="ident" id="3899920">CopyN</span><span class="op" id="3899925">(</span><span class="ident" id="3899926">ioutil</span><span class="op" id="3899932">.</span><span class="ident" id="3899933">Discard</span><span class="op" id="3899940">,</span>&nbsp;<span class="ident" id="3899942">w</span><span class="op" id="3899943">.</span><span class="ident" id="3899944">req</span><span class="op" id="3899947">.</span><span class="ident" id="3899948">Body</span><span class="op" id="3899952">,</span>&nbsp;<span class="ident" id="3899954">maxPostHandlerReadBytes</span><span class="op" id="3899977">+</span><span class="num" id="3899978">1</span><span class="op" id="3899979">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3899984">if</span>&nbsp;<span class="ident" id="3899987">n</span>&nbsp;<span class="op" id="3899989">&gt;=</span>&nbsp;<span class="ident" id="3899992">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3900016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900022">w</span><span class="op" id="3900023">.</span><span class="ident" id="3900024">requestTooLarge</span><span class="op" id="3900039">(</span><span class="op" id="3900040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900046">delHeader</span><span class="op" id="3900055">(</span><span class="string" id="3900056">&#34;Connection&#34;</span><span class="op" id="3900068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900074">setHeader</span><span class="op" id="3900083">.</span><span class="ident" id="3900084">connection</span>&nbsp;<span class="op" id="3900095">=</span>&nbsp;<span class="string" id="3900097">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900108">}</span>&nbsp;<span class="keyword" id="3900110">else</span>&nbsp;<span class="op" id="3900115">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900121">w</span><span class="op" id="3900122">.</span><span class="ident" id="3900123">req</span><span class="op" id="3900126">.</span><span class="ident" id="3900127">Body</span><span class="op" id="3900131">.</span><span class="ident" id="3900132">Close</span><span class="op" id="3900137">(</span><span class="op" id="3900138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900154">code</span>&nbsp;<span class="op" id="3900159">:=</span>&nbsp;<span class="ident" id="3900162">w</span><span class="op" id="3900163">.</span><span class="ident" id="3900164">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900172">if</span>&nbsp;<span class="ident" id="3900175">bodyAllowedForStatus</span><span class="op" id="3900195">(</span><span class="ident" id="3900196">code</span><span class="op" id="3900200">)</span>&nbsp;<span class="op" id="3900202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3900206">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900265">_</span><span class="op" id="3900266">,</span>&nbsp;<span class="ident" id="3900268">haveType</span>&nbsp;<span class="op" id="3900277">:=</span>&nbsp;<span class="ident" id="3900280">header</span><span class="op" id="3900286">[</span><span class="string" id="3900287">&#34;Content-Type&#34;</span><span class="op" id="3900301">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900305">if</span>&nbsp;<span class="op" id="3900308">!</span><span class="ident" id="3900309">haveType</span>&nbsp;<span class="op" id="3900318">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900323">setHeader</span><span class="op" id="3900332">.</span><span class="ident" id="3900333">contentType</span>&nbsp;<span class="op" id="3900345">=</span>&nbsp;<span class="ident" id="3900347">DetectContentType</span><span class="op" id="3900364">(</span><span class="ident" id="3900365">p</span><span class="op" id="3900366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900373">}</span>&nbsp;<span class="keyword" id="3900375">else</span>&nbsp;<span class="op" id="3900380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900384">for</span>&nbsp;<span class="ident" id="3900388">_</span><span class="op" id="3900389">,</span>&nbsp;<span class="ident" id="3900391">k</span>&nbsp;<span class="op" id="3900393">:=</span>&nbsp;<span class="keyword" id="3900396">range</span>&nbsp;<span class="ident" id="3900402">suppressedHeaders</span><span class="op" id="3900419">(</span><span class="ident" id="3900420">code</span><span class="op" id="3900424">)</span>&nbsp;<span class="op" id="3900426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900431">delHeader</span><span class="op" id="3900440">(</span><span class="ident" id="3900441">k</span><span class="op" id="3900442">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900453">if</span>&nbsp;<span class="ident" id="3900456">_</span><span class="op" id="3900457">,</span>&nbsp;<span class="ident" id="3900459">ok</span>&nbsp;<span class="op" id="3900462">:=</span>&nbsp;<span class="ident" id="3900465">header</span><span class="op" id="3900471">[</span><span class="string" id="3900472">&#34;Date&#34;</span><span class="op" id="3900478">]</span><span class="op" id="3900479">;</span>&nbsp;<span class="op" id="3900481">!</span><span class="ident" id="3900482">ok</span>&nbsp;<span class="op" id="3900485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900489">setHeader</span><span class="op" id="3900498">.</span><span class="ident" id="3900499">date</span>&nbsp;<span class="op" id="3900504">=</span>&nbsp;<span class="ident" id="3900506">appendTime</span><span class="op" id="3900516">(</span><span class="ident" id="3900517">cw</span><span class="op" id="3900519">.</span><span class="ident" id="3900520">res</span><span class="op" id="3900523">.</span><span class="ident" id="3900524">dateBuf</span><span class="op" id="3900531">[</span><span class="op" id="3900532">:</span><span class="num" id="3900533">0</span><span class="op" id="3900534">]</span><span class="op" id="3900535">,</span>&nbsp;<span class="ident" id="3900537">time</span><span class="op" id="3900541">.</span><span class="ident" id="3900542">Now</span><span class="op" id="3900545">(</span><span class="op" id="3900546">)</span><span class="op" id="3900547">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900554">te</span>&nbsp;<span class="op" id="3900557">:=</span>&nbsp;<span class="ident" id="3900560">header</span><span class="op" id="3900566">.</span><span class="ident" id="3900567">get</span><span class="op" id="3900570">(</span><span class="string" id="3900571">&#34;Transfer-Encoding&#34;</span><span class="op" id="3900590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900593">hasTE</span>&nbsp;<span class="op" id="3900599">:=</span>&nbsp;<span class="ident" id="3900602">te</span>&nbsp;<span class="op" id="3900605">!=</span>&nbsp;<span class="string" id="3900608">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900612">if</span>&nbsp;<span class="ident" id="3900615">hasCL</span>&nbsp;<span class="op" id="3900621">&amp;&amp;</span>&nbsp;<span class="ident" id="3900624">hasTE</span>&nbsp;<span class="op" id="3900630">&amp;&amp;</span>&nbsp;<span class="ident" id="3900633">te</span>&nbsp;<span class="op" id="3900636">!=</span>&nbsp;<span class="string" id="3900639">&#34;identity&#34;</span>&nbsp;<span class="op" id="3900650">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3900654">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3900720">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900765">w</span><span class="op" id="3900766">.</span><span class="ident" id="3900767">conn</span><span class="op" id="3900771">.</span><span class="ident" id="3900772">server</span><span class="op" id="3900778">.</span><span class="ident" id="3900779">logf</span><span class="op" id="3900783">(</span><span class="string" id="3900784">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="3900871">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900876">te</span><span class="op" id="3900878">,</span>&nbsp;<span class="ident" id="3900880">w</span><span class="op" id="3900881">.</span><span class="ident" id="3900882">contentLength</span><span class="op" id="3900895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900899">delHeader</span><span class="op" id="3900908">(</span><span class="string" id="3900909">&#34;Content-Length&#34;</span><span class="op" id="3900925">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3900929">hasCL</span>&nbsp;<span class="op" id="3900935">=</span>&nbsp;<span class="builtintype" id="3900937">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3900944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3900948">if</span>&nbsp;<span class="ident" id="3900951">w</span><span class="op" id="3900952">.</span><span class="ident" id="3900953">req</span><span class="op" id="3900956">.</span><span class="ident" id="3900957">Method</span>&nbsp;<span class="op" id="3900964">==</span>&nbsp;<span class="string" id="3900967">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3900974">||</span>&nbsp;<span class="op" id="3900977">!</span><span class="ident" id="3900978">bodyAllowedForStatus</span><span class="op" id="3900998">(</span><span class="ident" id="3900999">code</span><span class="op" id="3901003">)</span>&nbsp;<span class="op" id="3901005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3901009">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3901024">}</span>&nbsp;<span class="keyword" id="3901026">else</span>&nbsp;<span class="keyword" id="3901031">if</span>&nbsp;<span class="ident" id="3901034">code</span>&nbsp;<span class="op" id="3901039">==</span>&nbsp;<span class="ident" id="3901042">StatusNoContent</span>&nbsp;<span class="op" id="3901058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901062">delHeader</span><span class="op" id="3901071">(</span><span class="string" id="3901072">&#34;Transfer-Encoding&#34;</span><span class="op" id="3901091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3901094">}</span>&nbsp;<span class="keyword" id="3901096">else</span>&nbsp;<span class="keyword" id="3901101">if</span>&nbsp;<span class="ident" id="3901104">hasCL</span>&nbsp;<span class="op" id="3901110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901114">delHeader</span><span class="op" id="3901123">(</span><span class="string" id="3901124">&#34;Transfer-Encoding&#34;</span><span class="op" id="3901143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3901146">}</span>&nbsp;<span class="keyword" id="3901148">else</span>&nbsp;<span class="keyword" id="3901153">if</span>&nbsp;<span class="ident" id="3901156">w</span><span class="op" id="3901157">.</span><span class="ident" id="3901158">req</span><span class="op" id="3901161">.</span><span class="ident" id="3901162">ProtoAtLeast</span><span class="op" id="3901174">(</span><span class="num" id="3901175">1</span><span class="op" id="3901176">,</span>&nbsp;<span class="num" id="3901178">1</span><span class="op" id="3901179">)</span>&nbsp;<span class="op" id="3901181">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3901185">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3901263">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3901342">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3901414">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3901486">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3901502">if</span>&nbsp;<span class="ident" id="3901505">hasTE</span>&nbsp;<span class="op" id="3901511">&amp;&amp;</span>&nbsp;<span class="ident" id="3901514">te</span>&nbsp;<span class="op" id="3901517">==</span>&nbsp;<span class="string" id="3901520">&#34;identity&#34;</span>&nbsp;<span class="op" id="3901531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901536">cw</span><span class="op" id="3901538">.</span><span class="ident" id="3901539">chunking</span>&nbsp;<span class="op" id="3901548">=</span>&nbsp;<span class="builtintype" id="3901550">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901559">w</span><span class="op" id="3901560">.</span><span class="ident" id="3901561">closeAfterReply</span>&nbsp;<span class="op" id="3901577">=</span>&nbsp;<span class="builtintype" id="3901579">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3901586">}</span>&nbsp;<span class="keyword" id="3901588">else</span>&nbsp;<span class="op" id="3901593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3901598">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3901655">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901701">cw</span><span class="op" id="3901703">.</span><span class="ident" id="3901704">chunking</span>&nbsp;<span class="op" id="3901713">=</span>&nbsp;<span class="builtintype" id="3901715">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901723">setHeader</span><span class="op" id="3901732">.</span><span class="ident" id="3901733">transferEncoding</span>&nbsp;<span class="op" id="3901750">=</span>&nbsp;<span class="string" id="3901752">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3901764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3901767">}</span>&nbsp;<span class="keyword" id="3901769">else</span>&nbsp;<span class="op" id="3901774">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3901778">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3901830">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3901884">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901923">w</span><span class="op" id="3901924">.</span><span class="ident" id="3901925">closeAfterReply</span>&nbsp;<span class="op" id="3901941">=</span>&nbsp;<span class="builtintype" id="3901943">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3901950">delHeader</span><span class="op" id="3901959">(</span><span class="string" id="3901960">&#34;Transfer-Encoding&#34;</span><span class="op" id="3901979">)</span>&nbsp;<span class="comment" id="3901981">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3902009">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902076">if</span>&nbsp;<span class="ident" id="3902079">cw</span><span class="op" id="3902081">.</span><span class="ident" id="3902082">chunking</span>&nbsp;<span class="op" id="3902091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902095">delHeader</span><span class="op" id="3902104">(</span><span class="string" id="3902105">&#34;Content-Length&#34;</span><span class="op" id="3902121">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902127">if</span>&nbsp;<span class="op" id="3902130">!</span><span class="ident" id="3902131">w</span><span class="op" id="3902132">.</span><span class="ident" id="3902133">req</span><span class="op" id="3902136">.</span><span class="ident" id="3902137">ProtoAtLeast</span><span class="op" id="3902149">(</span><span class="num" id="3902150">1</span><span class="op" id="3902151">,</span>&nbsp;<span class="num" id="3902153">0</span><span class="op" id="3902154">)</span>&nbsp;<span class="op" id="3902156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902160">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902172">if</span>&nbsp;<span class="ident" id="3902175">w</span><span class="op" id="3902176">.</span><span class="ident" id="3902177">closeAfterReply</span>&nbsp;<span class="op" id="3902193">&amp;&amp;</span>&nbsp;<span class="op" id="3902196">(</span><span class="op" id="3902197">!</span><span class="ident" id="3902198">keepAlivesEnabled</span>&nbsp;<span class="op" id="3902216">||</span>&nbsp;<span class="op" id="3902219">!</span><span class="ident" id="3902220">hasToken</span><span class="op" id="3902228">(</span><span class="ident" id="3902229">cw</span><span class="op" id="3902231">.</span><span class="ident" id="3902232">header</span><span class="op" id="3902238">.</span><span class="ident" id="3902239">get</span><span class="op" id="3902242">(</span><span class="string" id="3902243">&#34;Connection&#34;</span><span class="op" id="3902255">)</span><span class="op" id="3902256">,</span>&nbsp;<span class="string" id="3902258">&#34;close&#34;</span><span class="op" id="3902265">)</span><span class="op" id="3902266">)</span>&nbsp;<span class="op" id="3902268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902272">delHeader</span><span class="op" id="3902281">(</span><span class="string" id="3902282">&#34;Connection&#34;</span><span class="op" id="3902294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3902298">if</span>&nbsp;<span class="ident" id="3902301">w</span><span class="op" id="3902302">.</span><span class="ident" id="3902303">req</span><span class="op" id="3902306">.</span><span class="ident" id="3902307">ProtoAtLeast</span><span class="op" id="3902319">(</span><span class="num" id="3902320">1</span><span class="op" id="3902321">,</span>&nbsp;<span class="num" id="3902323">1</span><span class="op" id="3902324">)</span>&nbsp;<span class="op" id="3902326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902331">setHeader</span><span class="op" id="3902340">.</span><span class="ident" id="3902341">connection</span>&nbsp;<span class="op" id="3902352">=</span>&nbsp;<span class="string" id="3902354">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902364">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3902367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902371">w</span><span class="op" id="3902372">.</span><span class="ident" id="3902373">conn</span><span class="op" id="3902377">.</span><span class="ident" id="3902378">buf</span><span class="op" id="3902381">.</span><span class="ident" id="3902382">WriteString</span><span class="op" id="3902393">(</span><span class="ident" id="3902394">statusLine</span><span class="op" id="3902404">(</span><span class="ident" id="3902405">w</span><span class="op" id="3902406">.</span><span class="ident" id="3902407">req</span><span class="op" id="3902410">,</span>&nbsp;<span class="ident" id="3902412">code</span><span class="op" id="3902416">)</span><span class="op" id="3902417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902420">cw</span><span class="op" id="3902422">.</span><span class="ident" id="3902423">header</span><span class="op" id="3902429">.</span><span class="ident" id="3902430">WriteSubset</span><span class="op" id="3902441">(</span><span class="ident" id="3902442">w</span><span class="op" id="3902443">.</span><span class="ident" id="3902444">conn</span><span class="op" id="3902448">.</span><span class="ident" id="3902449">buf</span><span class="op" id="3902452">,</span>&nbsp;<span class="ident" id="3902454">excludeHeader</span><span class="op" id="3902467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902470">setHeader</span><span class="op" id="3902479">.</span><span class="ident" id="3902480">Write</span><span class="op" id="3902485">(</span><span class="ident" id="3902486">w</span><span class="op" id="3902487">.</span><span class="ident" id="3902488">conn</span><span class="op" id="3902492">.</span><span class="ident" id="3902493">buf</span><span class="op" id="3902496">.</span><span class="ident" id="3902497">Writer</span><span class="op" id="3902503">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902506">w</span><span class="op" id="3902507">.</span><span class="ident" id="3902508">conn</span><span class="op" id="3902512">.</span><span class="ident" id="3902513">buf</span><span class="op" id="3902516">.</span><span class="ident" id="3902517">Write</span><span class="op" id="3902522">(</span><span class="ident" id="3902523">crlf</span><span class="op" id="3902527">)</span><br>
<span class="lineno"></span><span class="op" id="3902529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3902532">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="3902601">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="3902669">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="3902738">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="3902806">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="3902844">var</span>&nbsp;<span class="op" id="3902848">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902851">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902863">sync</span><span class="op" id="3902867">.</span><span class="ident" id="3902868">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902877">statusLines</span>&nbsp;<span class="op" id="3902889">=</span>&nbsp;<span class="builtinfunc" id="3902891">make</span><span class="op" id="3902895">(</span><span class="keyword" id="3902896">map</span><span class="op" id="3902899">[</span><span class="builtintype" id="3902900">int</span><span class="op" id="3902903">]</span><span class="builtintype" id="3902904">string</span><span class="op" id="3902910">)</span><br>
<span class="lineno"></span><span class="op" id="3902912">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3902915">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="3902983">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="3903034">func</span>&nbsp;<span class="ident" id="3903039">statusLine</span><span class="op" id="3903049">(</span><span class="ident" id="3903050">req</span>&nbsp;<span class="op" id="3903054">*</span><span class="ident" id="3903055">Request</span><span class="op" id="3903062">,</span>&nbsp;<span class="ident" id="3903064">code</span>&nbsp;<span class="builtintype" id="3903069">int</span><span class="op" id="3903072">)</span>&nbsp;<span class="builtintype" id="3903074">string</span>&nbsp;<span class="op" id="3903081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3903084">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903099">key</span>&nbsp;<span class="op" id="3903103">:=</span>&nbsp;<span class="ident" id="3903106">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903112">proto11</span>&nbsp;<span class="op" id="3903120">:=</span>&nbsp;<span class="ident" id="3903123">req</span><span class="op" id="3903126">.</span><span class="ident" id="3903127">ProtoAtLeast</span><span class="op" id="3903139">(</span><span class="num" id="3903140">1</span><span class="op" id="3903141">,</span>&nbsp;<span class="num" id="3903143">1</span><span class="op" id="3903144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903147">if</span>&nbsp;<span class="op" id="3903150">!</span><span class="ident" id="3903151">proto11</span>&nbsp;<span class="op" id="3903159">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903163">key</span>&nbsp;<span class="op" id="3903167">=</span>&nbsp;<span class="op" id="3903169">-</span><span class="ident" id="3903170">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3903175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903178">statusMu</span><span class="op" id="3903186">.</span><span class="ident" id="3903187">RLock</span><span class="op" id="3903192">(</span><span class="op" id="3903193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903196">line</span><span class="op" id="3903200">,</span>&nbsp;<span class="ident" id="3903202">ok</span>&nbsp;<span class="op" id="3903205">:=</span>&nbsp;<span class="ident" id="3903208">statusLines</span><span class="op" id="3903219">[</span><span class="ident" id="3903220">key</span><span class="op" id="3903223">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903226">statusMu</span><span class="op" id="3903234">.</span><span class="ident" id="3903235">RUnlock</span><span class="op" id="3903242">(</span><span class="op" id="3903243">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903246">if</span>&nbsp;<span class="ident" id="3903249">ok</span>&nbsp;<span class="op" id="3903252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903256">return</span>&nbsp;<span class="ident" id="3903263">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3903269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3903273">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903288">proto</span>&nbsp;<span class="op" id="3903294">:=</span>&nbsp;<span class="string" id="3903297">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903309">if</span>&nbsp;<span class="ident" id="3903312">proto11</span>&nbsp;<span class="op" id="3903320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903324">proto</span>&nbsp;<span class="op" id="3903330">=</span>&nbsp;<span class="string" id="3903332">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3903344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903347">codestring</span>&nbsp;<span class="op" id="3903358">:=</span>&nbsp;<span class="ident" id="3903361">strconv</span><span class="op" id="3903368">.</span><span class="ident" id="3903369">Itoa</span><span class="op" id="3903373">(</span><span class="ident" id="3903374">code</span><span class="op" id="3903378">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903381">text</span><span class="op" id="3903385">,</span>&nbsp;<span class="ident" id="3903387">ok</span>&nbsp;<span class="op" id="3903390">:=</span>&nbsp;<span class="ident" id="3903393">statusText</span><span class="op" id="3903403">[</span><span class="ident" id="3903404">code</span><span class="op" id="3903408">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903411">if</span>&nbsp;<span class="op" id="3903414">!</span><span class="ident" id="3903415">ok</span>&nbsp;<span class="op" id="3903418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903422">text</span>&nbsp;<span class="op" id="3903427">=</span>&nbsp;<span class="string" id="3903429">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3903444">+</span>&nbsp;<span class="ident" id="3903446">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3903458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903461">line</span>&nbsp;<span class="op" id="3903466">=</span>&nbsp;<span class="ident" id="3903468">proto</span>&nbsp;<span class="op" id="3903474">+</span>&nbsp;<span class="string" id="3903476">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3903480">+</span>&nbsp;<span class="ident" id="3903482">codestring</span>&nbsp;<span class="op" id="3903493">+</span>&nbsp;<span class="string" id="3903495">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3903499">+</span>&nbsp;<span class="ident" id="3903501">text</span>&nbsp;<span class="op" id="3903506">+</span>&nbsp;<span class="string" id="3903508">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903516">if</span>&nbsp;<span class="ident" id="3903519">ok</span>&nbsp;<span class="op" id="3903522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903526">statusMu</span><span class="op" id="3903534">.</span><span class="ident" id="3903535">Lock</span><span class="op" id="3903539">(</span><span class="op" id="3903540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903544">defer</span>&nbsp;<span class="ident" id="3903550">statusMu</span><span class="op" id="3903558">.</span><span class="ident" id="3903559">Unlock</span><span class="op" id="3903565">(</span><span class="op" id="3903566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903570">statusLines</span><span class="op" id="3903581">[</span><span class="ident" id="3903582">key</span><span class="op" id="3903585">]</span>&nbsp;<span class="op" id="3903587">=</span>&nbsp;<span class="ident" id="3903589">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3903595">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903598">return</span>&nbsp;<span class="ident" id="3903605">line</span><br>
<span class="lineno"></span><span class="op" id="3903610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3903613">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3903687">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="3903752">func</span>&nbsp;<span class="op" id="3903757">(</span><span class="ident" id="3903758">w</span>&nbsp;<span class="op" id="3903760">*</span><span class="ident" id="3903761">response</span><span class="op" id="3903769">)</span>&nbsp;<span class="ident" id="3903771">bodyAllowed</span><span class="op" id="3903782">(</span><span class="op" id="3903783">)</span>&nbsp;<span class="builtintype" id="3903785">bool</span>&nbsp;<span class="op" id="3903790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903793">if</span>&nbsp;<span class="op" id="3903796">!</span><span class="ident" id="3903797">w</span><span class="op" id="3903798">.</span><span class="ident" id="3903799">wroteHeader</span>&nbsp;<span class="op" id="3903811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3903815">panic</span><span class="op" id="3903820">(</span><span class="string" id="3903821">&#34;&#34;</span><span class="op" id="3903823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3903826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3903829">return</span>&nbsp;<span class="ident" id="3903836">bodyAllowedForStatus</span><span class="op" id="3903856">(</span><span class="ident" id="3903857">w</span><span class="op" id="3903858">.</span><span class="ident" id="3903859">status</span><span class="op" id="3903865">)</span><br>
<span class="lineno">940</span><span class="op" id="3903867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3903870">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="3903907">//</span><br>
<span class="lineno"></span><span class="comment" id="3903910">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="3903977">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="3904052">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3904096">//</span><br>
<span class="lineno"></span><span class="comment" id="3904099">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="3904169">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="3904237">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3904308">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="3904334">//</span><br>
<span class="lineno"></span><span class="comment" id="3904337">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3904406">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="3904443">//</span><br>
<span class="lineno"></span><span class="comment" id="3904446">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="3904486">//</span><br>
<span class="lineno"></span><span class="comment" id="3904489">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3904529">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="3904600">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="3904675">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="3904728">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3904797">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="3904867">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="3904934">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="3904963">//</span><br>
<span class="lineno"></span><span class="comment" id="3904966">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3905030">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="3905097">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="3905165">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3905230">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3905300">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3905369">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3905440">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="3905511">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="3905533">func</span>&nbsp;<span class="op" id="3905538">(</span><span class="ident" id="3905539">w</span>&nbsp;<span class="op" id="3905541">*</span><span class="ident" id="3905542">response</span><span class="op" id="3905550">)</span>&nbsp;<span class="ident" id="3905552">Write</span><span class="op" id="3905557">(</span><span class="ident" id="3905558">data</span>&nbsp;<span class="op" id="3905563">[</span><span class="op" id="3905564">]</span><span class="builtintype" id="3905565">byte</span><span class="op" id="3905569">)</span>&nbsp;<span class="op" id="3905571">(</span><span class="ident" id="3905572">n</span>&nbsp;<span class="builtintype" id="3905574">int</span><span class="op" id="3905577">,</span>&nbsp;<span class="ident" id="3905579">err</span>&nbsp;<span class="builtintype" id="3905583">error</span><span class="op" id="3905588">)</span>&nbsp;<span class="op" id="3905590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905593">return</span>&nbsp;<span class="ident" id="3905600">w</span><span class="op" id="3905601">.</span><span class="ident" id="3905602">write</span><span class="op" id="3905607">(</span><span class="builtinfunc" id="3905608">len</span><span class="op" id="3905611">(</span><span class="ident" id="3905612">data</span><span class="op" id="3905616">)</span><span class="op" id="3905617">,</span>&nbsp;<span class="ident" id="3905619">data</span><span class="op" id="3905623">,</span>&nbsp;<span class="string" id="3905625">&#34;&#34;</span><span class="op" id="3905627">)</span><br>
<span class="lineno"></span><span class="op" id="3905629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3905632">func</span>&nbsp;<span class="op" id="3905637">(</span><span class="ident" id="3905638">w</span>&nbsp;<span class="op" id="3905640">*</span><span class="ident" id="3905641">response</span><span class="op" id="3905649">)</span>&nbsp;<span class="ident" id="3905651">WriteString</span><span class="op" id="3905662">(</span><span class="ident" id="3905663">data</span>&nbsp;<span class="builtintype" id="3905668">string</span><span class="op" id="3905674">)</span>&nbsp;<span class="op" id="3905676">(</span><span class="ident" id="3905677">n</span>&nbsp;<span class="builtintype" id="3905679">int</span><span class="op" id="3905682">,</span>&nbsp;<span class="ident" id="3905684">err</span>&nbsp;<span class="builtintype" id="3905688">error</span><span class="op" id="3905693">)</span>&nbsp;<span class="op" id="3905695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905698">return</span>&nbsp;<span class="ident" id="3905705">w</span><span class="op" id="3905706">.</span><span class="ident" id="3905707">write</span><span class="op" id="3905712">(</span><span class="builtinfunc" id="3905713">len</span><span class="op" id="3905716">(</span><span class="ident" id="3905717">data</span><span class="op" id="3905721">)</span><span class="op" id="3905722">,</span>&nbsp;<span class="ident" id="3905724">nil</span><span class="op" id="3905727">,</span>&nbsp;<span class="ident" id="3905729">data</span><span class="op" id="3905733">)</span><br>
<span class="lineno"></span><span class="op" id="3905735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3905738">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="3905776">func</span>&nbsp;<span class="op" id="3905781">(</span><span class="ident" id="3905782">w</span>&nbsp;<span class="op" id="3905784">*</span><span class="ident" id="3905785">response</span><span class="op" id="3905793">)</span>&nbsp;<span class="ident" id="3905795">write</span><span class="op" id="3905800">(</span><span class="ident" id="3905801">lenData</span>&nbsp;<span class="builtintype" id="3905809">int</span><span class="op" id="3905812">,</span>&nbsp;<span class="ident" id="3905814">dataB</span>&nbsp;<span class="op" id="3905820">[</span><span class="op" id="3905821">]</span><span class="builtintype" id="3905822">byte</span><span class="op" id="3905826">,</span>&nbsp;<span class="ident" id="3905828">dataS</span>&nbsp;<span class="builtintype" id="3905834">string</span><span class="op" id="3905840">)</span>&nbsp;<span class="op" id="3905842">(</span><span class="ident" id="3905843">n</span>&nbsp;<span class="builtintype" id="3905845">int</span><span class="op" id="3905848">,</span>&nbsp;<span class="ident" id="3905850">err</span>&nbsp;<span class="builtintype" id="3905854">error</span><span class="op" id="3905859">)</span>&nbsp;<span class="op" id="3905861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905864">if</span>&nbsp;<span class="ident" id="3905867">w</span><span class="op" id="3905868">.</span><span class="ident" id="3905869">conn</span><span class="op" id="3905873">.</span><span class="ident" id="3905874">hijacked</span><span class="op" id="3905882">(</span><span class="op" id="3905883">)</span>&nbsp;<span class="op" id="3905885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905889">w</span><span class="op" id="3905890">.</span><span class="ident" id="3905891">conn</span><span class="op" id="3905895">.</span><span class="ident" id="3905896">server</span><span class="op" id="3905902">.</span><span class="ident" id="3905903">logf</span><span class="op" id="3905907">(</span><span class="string" id="3905908">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3905953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905957">return</span>&nbsp;<span class="num" id="3905964">0</span><span class="op" id="3905965">,</span>&nbsp;<span class="ident" id="3905967">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3905980">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905983">if</span>&nbsp;<span class="op" id="3905986">!</span><span class="ident" id="3905987">w</span><span class="op" id="3905988">.</span><span class="ident" id="3905989">wroteHeader</span>&nbsp;<span class="op" id="3906001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906005">w</span><span class="op" id="3906006">.</span><span class="ident" id="3906007">WriteHeader</span><span class="op" id="3906018">(</span><span class="ident" id="3906019">StatusOK</span><span class="op" id="3906027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906030">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906033">if</span>&nbsp;<span class="ident" id="3906036">lenData</span>&nbsp;<span class="op" id="3906044">==</span>&nbsp;<span class="num" id="3906047">0</span>&nbsp;<span class="op" id="3906049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906053">return</span>&nbsp;<span class="num" id="3906060">0</span><span class="op" id="3906061">,</span>&nbsp;<span class="ident" id="3906063">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906071">if</span>&nbsp;<span class="op" id="3906074">!</span><span class="ident" id="3906075">w</span><span class="op" id="3906076">.</span><span class="ident" id="3906077">bodyAllowed</span><span class="op" id="3906088">(</span><span class="op" id="3906089">)</span>&nbsp;<span class="op" id="3906091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906095">return</span>&nbsp;<span class="num" id="3906102">0</span><span class="op" id="3906103">,</span>&nbsp;<span class="ident" id="3906105">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906128">w</span><span class="op" id="3906129">.</span><span class="ident" id="3906130">written</span>&nbsp;<span class="op" id="3906138">+=</span>&nbsp;<span class="ident" id="3906141">int64</span><span class="op" id="3906146">(</span><span class="ident" id="3906147">lenData</span><span class="op" id="3906154">)</span>&nbsp;<span class="comment" id="3906156">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906193">if</span>&nbsp;<span class="ident" id="3906196">w</span><span class="op" id="3906197">.</span><span class="ident" id="3906198">contentLength</span>&nbsp;<span class="op" id="3906212">!=</span>&nbsp;<span class="op" id="3906215">-</span><span class="num" id="3906216">1</span>&nbsp;<span class="op" id="3906218">&amp;&amp;</span>&nbsp;<span class="ident" id="3906221">w</span><span class="op" id="3906222">.</span><span class="ident" id="3906223">written</span>&nbsp;<span class="op" id="3906231">&gt;</span>&nbsp;<span class="ident" id="3906233">w</span><span class="op" id="3906234">.</span><span class="ident" id="3906235">contentLength</span>&nbsp;<span class="op" id="3906249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906253">return</span>&nbsp;<span class="num" id="3906260">0</span><span class="op" id="3906261">,</span>&nbsp;<span class="ident" id="3906263">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906284">if</span>&nbsp;<span class="ident" id="3906287">dataB</span>&nbsp;<span class="op" id="3906293">!=</span>&nbsp;<span class="ident" id="3906296">nil</span>&nbsp;<span class="op" id="3906300">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906304">return</span>&nbsp;<span class="ident" id="3906311">w</span><span class="op" id="3906312">.</span><span class="ident" id="3906313">w</span><span class="op" id="3906314">.</span><span class="ident" id="3906315">Write</span><span class="op" id="3906320">(</span><span class="ident" id="3906321">dataB</span><span class="op" id="3906326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906329">}</span>&nbsp;<span class="keyword" id="3906331">else</span>&nbsp;<span class="op" id="3906336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906340">return</span>&nbsp;<span class="ident" id="3906347">w</span><span class="op" id="3906348">.</span><span class="ident" id="3906349">w</span><span class="op" id="3906350">.</span><span class="ident" id="3906351">WriteString</span><span class="op" id="3906362">(</span><span class="ident" id="3906363">dataS</span><span class="op" id="3906368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906371">}</span><br>
<span class="lineno"></span><span class="op" id="3906373">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="3906376">func</span>&nbsp;<span class="op" id="3906381">(</span><span class="ident" id="3906382">w</span>&nbsp;<span class="op" id="3906384">*</span><span class="ident" id="3906385">response</span><span class="op" id="3906393">)</span>&nbsp;<span class="ident" id="3906395">finishRequest</span><span class="op" id="3906408">(</span><span class="op" id="3906409">)</span>&nbsp;<span class="op" id="3906411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906414">w</span><span class="op" id="3906415">.</span><span class="ident" id="3906416">handlerDone</span>&nbsp;<span class="op" id="3906428">=</span>&nbsp;<span class="builtintype" id="3906430">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906437">if</span>&nbsp;<span class="op" id="3906440">!</span><span class="ident" id="3906441">w</span><span class="op" id="3906442">.</span><span class="ident" id="3906443">wroteHeader</span>&nbsp;<span class="op" id="3906455">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906459">w</span><span class="op" id="3906460">.</span><span class="ident" id="3906461">WriteHeader</span><span class="op" id="3906472">(</span><span class="ident" id="3906473">StatusOK</span><span class="op" id="3906481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906488">w</span><span class="op" id="3906489">.</span><span class="ident" id="3906490">w</span><span class="op" id="3906491">.</span><span class="ident" id="3906492">Flush</span><span class="op" id="3906497">(</span><span class="op" id="3906498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906501">putBufioWriter</span><span class="op" id="3906515">(</span><span class="ident" id="3906516">w</span><span class="op" id="3906517">.</span><span class="ident" id="3906518">w</span><span class="op" id="3906519">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906522">w</span><span class="op" id="3906523">.</span><span class="ident" id="3906524">cw</span><span class="op" id="3906526">.</span><span class="builtinfunc" id="3906527">close</span><span class="op" id="3906532">(</span><span class="op" id="3906533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906536">w</span><span class="op" id="3906537">.</span><span class="ident" id="3906538">conn</span><span class="op" id="3906542">.</span><span class="ident" id="3906543">buf</span><span class="op" id="3906546">.</span><span class="ident" id="3906547">Flush</span><span class="op" id="3906552">(</span><span class="op" id="3906553">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3906557">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3906620">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906662">w</span><span class="op" id="3906663">.</span><span class="ident" id="3906664">req</span><span class="op" id="3906667">.</span><span class="ident" id="3906668">Body</span><span class="op" id="3906672">.</span><span class="ident" id="3906673">Close</span><span class="op" id="3906678">(</span><span class="op" id="3906679">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906683">if</span>&nbsp;<span class="ident" id="3906686">w</span><span class="op" id="3906687">.</span><span class="ident" id="3906688">req</span><span class="op" id="3906691">.</span><span class="ident" id="3906692">MultipartForm</span>&nbsp;<span class="op" id="3906706">!=</span>&nbsp;<span class="ident" id="3906709">nil</span>&nbsp;<span class="op" id="3906713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906717">w</span><span class="op" id="3906718">.</span><span class="ident" id="3906719">req</span><span class="op" id="3906722">.</span><span class="ident" id="3906723">MultipartForm</span><span class="op" id="3906736">.</span><span class="ident" id="3906737">RemoveAll</span><span class="op" id="3906746">(</span><span class="op" id="3906747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906750">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906754">if</span>&nbsp;<span class="ident" id="3906757">w</span><span class="op" id="3906758">.</span><span class="ident" id="3906759">req</span><span class="op" id="3906762">.</span><span class="ident" id="3906763">Method</span>&nbsp;<span class="op" id="3906770">!=</span>&nbsp;<span class="string" id="3906773">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3906780">&amp;&amp;</span>&nbsp;<span class="ident" id="3906783">w</span><span class="op" id="3906784">.</span><span class="ident" id="3906785">contentLength</span>&nbsp;<span class="op" id="3906799">!=</span>&nbsp;<span class="op" id="3906802">-</span><span class="num" id="3906803">1</span>&nbsp;<span class="op" id="3906805">&amp;&amp;</span>&nbsp;<span class="ident" id="3906808">w</span><span class="op" id="3906809">.</span><span class="ident" id="3906810">bodyAllowed</span><span class="op" id="3906821">(</span><span class="op" id="3906822">)</span>&nbsp;<span class="op" id="3906824">&amp;&amp;</span>&nbsp;<span class="ident" id="3906827">w</span><span class="op" id="3906828">.</span><span class="ident" id="3906829">contentLength</span>&nbsp;<span class="op" id="3906843">!=</span>&nbsp;<span class="ident" id="3906846">w</span><span class="op" id="3906847">.</span><span class="ident" id="3906848">written</span>&nbsp;<span class="op" id="3906856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3906860">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906914">w</span><span class="op" id="3906915">.</span><span class="ident" id="3906916">closeAfterReply</span>&nbsp;<span class="op" id="3906932">=</span>&nbsp;<span class="builtintype" id="3906934">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906940">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3906944">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907006">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907057">if</span>&nbsp;<span class="ident" id="3907060">w</span><span class="op" id="3907061">.</span><span class="ident" id="3907062">conn</span><span class="op" id="3907066">.</span><span class="ident" id="3907067">werr</span>&nbsp;<span class="op" id="3907072">!=</span>&nbsp;<span class="ident" id="3907075">nil</span>&nbsp;<span class="op" id="3907079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907083">w</span><span class="op" id="3907084">.</span><span class="ident" id="3907085">closeAfterReply</span>&nbsp;<span class="op" id="3907101">=</span>&nbsp;<span class="builtintype" id="3907103">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907109">}</span><br>
<span class="lineno"></span><span class="op" id="3907111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3907114">func</span>&nbsp;<span class="op" id="3907119">(</span><span class="ident" id="3907120">w</span>&nbsp;<span class="op" id="3907122">*</span><span class="ident" id="3907123">response</span><span class="op" id="3907131">)</span>&nbsp;<span class="ident" id="3907133">Flush</span><span class="op" id="3907138">(</span><span class="op" id="3907139">)</span>&nbsp;<span class="op" id="3907141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907144">if</span>&nbsp;<span class="op" id="3907147">!</span><span class="ident" id="3907148">w</span><span class="op" id="3907149">.</span><span class="ident" id="3907150">wroteHeader</span>&nbsp;<span class="op" id="3907162">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907166">w</span><span class="op" id="3907167">.</span><span class="ident" id="3907168">WriteHeader</span><span class="op" id="3907179">(</span><span class="ident" id="3907180">StatusOK</span><span class="op" id="3907188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907194">w</span><span class="op" id="3907195">.</span><span class="ident" id="3907196">w</span><span class="op" id="3907197">.</span><span class="ident" id="3907198">Flush</span><span class="op" id="3907203">(</span><span class="op" id="3907204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907207">w</span><span class="op" id="3907208">.</span><span class="ident" id="3907209">cw</span><span class="op" id="3907211">.</span><span class="ident" id="3907212">flush</span><span class="op" id="3907217">(</span><span class="op" id="3907218">)</span><br>
<span class="lineno"></span><span class="op" id="3907220">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="3907223">func</span>&nbsp;<span class="op" id="3907228">(</span><span class="ident" id="3907229">c</span>&nbsp;<span class="op" id="3907231">*</span><span class="ident" id="3907232">conn</span><span class="op" id="3907236">)</span>&nbsp;<span class="ident" id="3907238">finalFlush</span><span class="op" id="3907248">(</span><span class="op" id="3907249">)</span>&nbsp;<span class="op" id="3907251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907254">if</span>&nbsp;<span class="ident" id="3907257">c</span><span class="op" id="3907258">.</span><span class="ident" id="3907259">buf</span>&nbsp;<span class="op" id="3907263">!=</span>&nbsp;<span class="ident" id="3907266">nil</span>&nbsp;<span class="op" id="3907270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907274">c</span><span class="op" id="3907275">.</span><span class="ident" id="3907276">buf</span><span class="op" id="3907279">.</span><span class="ident" id="3907280">Flush</span><span class="op" id="3907285">(</span><span class="op" id="3907286">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907291">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907361">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907398">putBufioReader</span><span class="op" id="3907412">(</span><span class="ident" id="3907413">c</span><span class="op" id="3907414">.</span><span class="ident" id="3907415">buf</span><span class="op" id="3907418">.</span><span class="ident" id="3907419">Reader</span><span class="op" id="3907425">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907430">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907500">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907537">putBufioWriter</span><span class="op" id="3907551">(</span><span class="ident" id="3907552">c</span><span class="op" id="3907553">.</span><span class="ident" id="3907554">buf</span><span class="op" id="3907557">.</span><span class="ident" id="3907558">Writer</span><span class="op" id="3907564">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907569">c</span><span class="op" id="3907570">.</span><span class="ident" id="3907571">buf</span>&nbsp;<span class="op" id="3907575">=</span>&nbsp;<span class="ident" id="3907577">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907582">}</span><br>
<span class="lineno">1065</span><span class="op" id="3907584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3907587">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3907612">func</span>&nbsp;<span class="op" id="3907617">(</span><span class="ident" id="3907618">c</span>&nbsp;<span class="op" id="3907620">*</span><span class="ident" id="3907621">conn</span><span class="op" id="3907625">)</span>&nbsp;<span class="builtinfunc" id="3907627">close</span><span class="op" id="3907632">(</span><span class="op" id="3907633">)</span>&nbsp;<span class="op" id="3907635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907638">c</span><span class="op" id="3907639">.</span><span class="ident" id="3907640">finalFlush</span><span class="op" id="3907650">(</span><span class="op" id="3907651">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907654">if</span>&nbsp;<span class="ident" id="3907657">c</span><span class="op" id="3907658">.</span><span class="ident" id="3907659">rwc</span>&nbsp;<span class="op" id="3907663">!=</span>&nbsp;<span class="ident" id="3907666">nil</span>&nbsp;<span class="op" id="3907670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907674">c</span><span class="op" id="3907675">.</span><span class="ident" id="3907676">rwc</span><span class="op" id="3907679">.</span><span class="ident" id="3907680">Close</span><span class="op" id="3907685">(</span><span class="op" id="3907686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907690">c</span><span class="op" id="3907691">.</span><span class="ident" id="3907692">rwc</span>&nbsp;<span class="op" id="3907696">=</span>&nbsp;<span class="ident" id="3907698">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907703">}</span><br>
<span class="lineno"></span><span class="op" id="3907705">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="3907708">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3907778">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="3907846">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="3907915">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="3907986">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3908039">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="3908104">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="3908172">const</span>&nbsp;<span class="ident" id="3908178">rstAvoidanceDelay</span>&nbsp;<span class="op" id="3908196">=</span>&nbsp;<span class="num" id="3908198">500</span>&nbsp;<span class="op" id="3908202">*</span>&nbsp;<span class="ident" id="3908204">time</span><span class="op" id="3908208">.</span><span class="ident" id="3908209">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="3908222">type</span>&nbsp;<span class="ident" id="3908227">closeWriter</span>&nbsp;<span class="keyword" id="3908239">interface</span>&nbsp;<span class="op" id="3908249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908252">CloseWrite</span><span class="op" id="3908262">(</span><span class="op" id="3908263">)</span>&nbsp;<span class="builtintype" id="3908265">error</span><br>
<span class="lineno"></span><span class="op" id="3908271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3908274">var</span>&nbsp;<span class="ident" id="3908278">_</span>&nbsp;<span class="ident" id="3908280">closeWriter</span>&nbsp;<span class="op" id="3908292">=</span>&nbsp;<span class="op" id="3908294">(</span><span class="op" id="3908295">*</span><span class="ident" id="3908296">net</span><span class="op" id="3908299">.</span><span class="ident" id="3908300">TCPConn</span><span class="op" id="3908307">)</span><span class="op" id="3908308">(</span><span class="ident" id="3908309">nil</span><span class="op" id="3908312">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="3908315">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="3908385">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3908455">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3908517">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="3908536">//</span><br>
<span class="lineno"></span><span class="comment" id="3908539">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="3908575">func</span>&nbsp;<span class="op" id="3908580">(</span><span class="ident" id="3908581">c</span>&nbsp;<span class="op" id="3908583">*</span><span class="ident" id="3908584">conn</span><span class="op" id="3908588">)</span>&nbsp;<span class="ident" id="3908590">closeWriteAndWait</span><span class="op" id="3908607">(</span><span class="op" id="3908608">)</span>&nbsp;<span class="op" id="3908610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908613">c</span><span class="op" id="3908614">.</span><span class="ident" id="3908615">finalFlush</span><span class="op" id="3908625">(</span><span class="op" id="3908626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908629">if</span>&nbsp;<span class="ident" id="3908632">tcp</span><span class="op" id="3908635">,</span>&nbsp;<span class="ident" id="3908637">ok</span>&nbsp;<span class="op" id="3908640">:=</span>&nbsp;<span class="ident" id="3908643">c</span><span class="op" id="3908644">.</span><span class="ident" id="3908645">rwc</span><span class="op" id="3908648">.</span><span class="op" id="3908649">(</span><span class="ident" id="3908650">closeWriter</span><span class="op" id="3908661">)</span><span class="op" id="3908662">;</span>&nbsp;<span class="ident" id="3908664">ok</span>&nbsp;<span class="op" id="3908667">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908671">tcp</span><span class="op" id="3908674">.</span><span class="ident" id="3908675">CloseWrite</span><span class="op" id="3908685">(</span><span class="op" id="3908686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908692">time</span><span class="op" id="3908696">.</span><span class="ident" id="3908697">Sleep</span><span class="op" id="3908702">(</span><span class="ident" id="3908703">rstAvoidanceDelay</span><span class="op" id="3908720">)</span><br>
<span class="lineno"></span><span class="op" id="3908722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="3908725">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="3908789">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="3908858">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="3908916">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="3908936">func</span>&nbsp;<span class="ident" id="3908941">validNPN</span><span class="op" id="3908949">(</span><span class="ident" id="3908950">proto</span>&nbsp;<span class="builtintype" id="3908956">string</span><span class="op" id="3908962">)</span>&nbsp;<span class="builtintype" id="3908964">bool</span>&nbsp;<span class="op" id="3908969">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908972">switch</span>&nbsp;<span class="ident" id="3908979">proto</span>&nbsp;<span class="op" id="3908985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908988">case</span>&nbsp;<span class="string" id="3908993">&#34;&#34;</span><span class="op" id="3908995">,</span>&nbsp;<span class="string" id="3908997">&#34;http/1.1&#34;</span><span class="op" id="3909007">,</span>&nbsp;<span class="string" id="3909009">&#34;http/1.0&#34;</span><span class="op" id="3909019">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909023">return</span>&nbsp;<span class="builtintype" id="3909030">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909040">return</span>&nbsp;<span class="builtintype" id="3909047">true</span><br>
<span class="lineno">1115</span><span class="op" id="3909052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3909055">func</span>&nbsp;<span class="op" id="3909060">(</span><span class="ident" id="3909061">c</span>&nbsp;<span class="op" id="3909063">*</span><span class="ident" id="3909064">conn</span><span class="op" id="3909068">)</span>&nbsp;<span class="ident" id="3909070">setState</span><span class="op" id="3909078">(</span><span class="ident" id="3909079">nc</span>&nbsp;<span class="ident" id="3909082">net</span><span class="op" id="3909085">.</span><span class="ident" id="3909086">Conn</span><span class="op" id="3909090">,</span>&nbsp;<span class="ident" id="3909092">state</span>&nbsp;<span class="ident" id="3909098">ConnState</span><span class="op" id="3909107">)</span>&nbsp;<span class="op" id="3909109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909112">if</span>&nbsp;<span class="ident" id="3909115">hook</span>&nbsp;<span class="op" id="3909120">:=</span>&nbsp;<span class="ident" id="3909123">c</span><span class="op" id="3909124">.</span><span class="ident" id="3909125">server</span><span class="op" id="3909131">.</span><span class="ident" id="3909132">ConnState</span><span class="op" id="3909141">;</span>&nbsp;<span class="ident" id="3909143">hook</span>&nbsp;<span class="op" id="3909148">!=</span>&nbsp;<span class="ident" id="3909151">nil</span>&nbsp;<span class="op" id="3909155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909159">hook</span><span class="op" id="3909163">(</span><span class="ident" id="3909164">nc</span><span class="op" id="3909166">,</span>&nbsp;<span class="ident" id="3909168">state</span><span class="op" id="3909173">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909176">}</span><br>
<span class="lineno"></span><span class="op" id="3909178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3909181">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3909208">func</span>&nbsp;<span class="op" id="3909213">(</span><span class="ident" id="3909214">c</span>&nbsp;<span class="op" id="3909216">*</span><span class="ident" id="3909217">conn</span><span class="op" id="3909221">)</span>&nbsp;<span class="ident" id="3909223">serve</span><span class="op" id="3909228">(</span><span class="op" id="3909229">)</span>&nbsp;<span class="op" id="3909231">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909234">origConn</span>&nbsp;<span class="op" id="3909243">:=</span>&nbsp;<span class="ident" id="3909246">c</span><span class="op" id="3909247">.</span><span class="ident" id="3909248">rwc</span>&nbsp;<span class="comment" id="3909252">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909303">defer</span>&nbsp;<span class="keyword" id="3909309">func</span><span class="op" id="3909313">(</span><span class="op" id="3909314">)</span>&nbsp;<span class="op" id="3909316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909320">if</span>&nbsp;<span class="ident" id="3909323">err</span>&nbsp;<span class="op" id="3909327">:=</span>&nbsp;<span class="builtinfunc" id="3909330">recover</span><span class="op" id="3909337">(</span><span class="op" id="3909338">)</span><span class="op" id="3909339">;</span>&nbsp;<span class="ident" id="3909341">err</span>&nbsp;<span class="op" id="3909345">!=</span>&nbsp;<span class="ident" id="3909348">nil</span>&nbsp;<span class="op" id="3909352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909357">const</span>&nbsp;<span class="ident" id="3909363">size</span>&nbsp;<span class="op" id="3909368">=</span>&nbsp;<span class="num" id="3909370">64</span>&nbsp;<span class="op" id="3909373">&lt;&lt;</span>&nbsp;<span class="num" id="3909376">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909382">buf</span>&nbsp;<span class="op" id="3909386">:=</span>&nbsp;<span class="builtinfunc" id="3909389">make</span><span class="op" id="3909393">(</span><span class="op" id="3909394">[</span><span class="op" id="3909395">]</span><span class="builtintype" id="3909396">byte</span><span class="op" id="3909400">,</span>&nbsp;<span class="ident" id="3909402">size</span><span class="op" id="3909406">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909411">buf</span>&nbsp;<span class="op" id="3909415">=</span>&nbsp;<span class="ident" id="3909417">buf</span><span class="op" id="3909420">[</span><span class="op" id="3909421">:</span><span class="ident" id="3909422">runtime</span><span class="op" id="3909429">.</span><span class="ident" id="3909430">Stack</span><span class="op" id="3909435">(</span><span class="ident" id="3909436">buf</span><span class="op" id="3909439">,</span>&nbsp;<span class="builtintype" id="3909441">false</span><span class="op" id="3909446">)</span><span class="op" id="3909447">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909452">c</span><span class="op" id="3909453">.</span><span class="ident" id="3909454">server</span><span class="op" id="3909460">.</span><span class="ident" id="3909461">logf</span><span class="op" id="3909465">(</span><span class="string" id="3909466">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="3909498">,</span>&nbsp;<span class="ident" id="3909500">c</span><span class="op" id="3909501">.</span><span class="ident" id="3909502">remoteAddr</span><span class="op" id="3909512">,</span>&nbsp;<span class="ident" id="3909514">err</span><span class="op" id="3909517">,</span>&nbsp;<span class="ident" id="3909519">buf</span><span class="op" id="3909522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909530">if</span>&nbsp;<span class="op" id="3909533">!</span><span class="ident" id="3909534">c</span><span class="op" id="3909535">.</span><span class="ident" id="3909536">hijacked</span><span class="op" id="3909544">(</span><span class="op" id="3909545">)</span>&nbsp;<span class="op" id="3909547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909552">c</span><span class="op" id="3909553">.</span><span class="builtinfunc" id="3909554">close</span><span class="op" id="3909559">(</span><span class="op" id="3909560">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909565">c</span><span class="op" id="3909566">.</span><span class="ident" id="3909567">setState</span><span class="op" id="3909575">(</span><span class="ident" id="3909576">origConn</span><span class="op" id="3909584">,</span>&nbsp;<span class="ident" id="3909586">StateClosed</span><span class="op" id="3909597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909604">}</span><span class="op" id="3909605">(</span><span class="op" id="3909606">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909610">if</span>&nbsp;<span class="ident" id="3909613">tlsConn</span><span class="op" id="3909620">,</span>&nbsp;<span class="ident" id="3909622">ok</span>&nbsp;<span class="op" id="3909625">:=</span>&nbsp;<span class="ident" id="3909628">c</span><span class="op" id="3909629">.</span><span class="ident" id="3909630">rwc</span><span class="op" id="3909633">.</span><span class="op" id="3909634">(</span><span class="op" id="3909635">*</span><span class="ident" id="3909636">tls</span><span class="op" id="3909639">.</span><span class="ident" id="3909640">Conn</span><span class="op" id="3909644">)</span><span class="op" id="3909645">;</span>&nbsp;<span class="ident" id="3909647">ok</span>&nbsp;<span class="op" id="3909650">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909654">if</span>&nbsp;<span class="ident" id="3909657">d</span>&nbsp;<span class="op" id="3909659">:=</span>&nbsp;<span class="ident" id="3909662">c</span><span class="op" id="3909663">.</span><span class="ident" id="3909664">server</span><span class="op" id="3909670">.</span><span class="ident" id="3909671">ReadTimeout</span><span class="op" id="3909682">;</span>&nbsp;<span class="ident" id="3909684">d</span>&nbsp;<span class="op" id="3909686">!=</span>&nbsp;<span class="num" id="3909689">0</span>&nbsp;<span class="op" id="3909691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909696">c</span><span class="op" id="3909697">.</span><span class="ident" id="3909698">rwc</span><span class="op" id="3909701">.</span><span class="ident" id="3909702">SetReadDeadline</span><span class="op" id="3909717">(</span><span class="ident" id="3909718">time</span><span class="op" id="3909722">.</span><span class="ident" id="3909723">Now</span><span class="op" id="3909726">(</span><span class="op" id="3909727">)</span><span class="op" id="3909728">.</span><span class="ident" id="3909729">Add</span><span class="op" id="3909732">(</span><span class="ident" id="3909733">d</span><span class="op" id="3909734">)</span><span class="op" id="3909735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909743">if</span>&nbsp;<span class="ident" id="3909746">d</span>&nbsp;<span class="op" id="3909748">:=</span>&nbsp;<span class="ident" id="3909751">c</span><span class="op" id="3909752">.</span><span class="ident" id="3909753">server</span><span class="op" id="3909759">.</span><span class="ident" id="3909760">WriteTimeout</span><span class="op" id="3909772">;</span>&nbsp;<span class="ident" id="3909774">d</span>&nbsp;<span class="op" id="3909776">!=</span>&nbsp;<span class="num" id="3909779">0</span>&nbsp;<span class="op" id="3909781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909786">c</span><span class="op" id="3909787">.</span><span class="ident" id="3909788">rwc</span><span class="op" id="3909791">.</span><span class="ident" id="3909792">SetWriteDeadline</span><span class="op" id="3909808">(</span><span class="ident" id="3909809">time</span><span class="op" id="3909813">.</span><span class="ident" id="3909814">Now</span><span class="op" id="3909817">(</span><span class="op" id="3909818">)</span><span class="op" id="3909819">.</span><span class="ident" id="3909820">Add</span><span class="op" id="3909823">(</span><span class="ident" id="3909824">d</span><span class="op" id="3909825">)</span><span class="op" id="3909826">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909834">if</span>&nbsp;<span class="ident" id="3909837">err</span>&nbsp;<span class="op" id="3909841">:=</span>&nbsp;<span class="ident" id="3909844">tlsConn</span><span class="op" id="3909851">.</span><span class="ident" id="3909852">Handshake</span><span class="op" id="3909861">(</span><span class="op" id="3909862">)</span><span class="op" id="3909863">;</span>&nbsp;<span class="ident" id="3909865">err</span>&nbsp;<span class="op" id="3909869">!=</span>&nbsp;<span class="ident" id="3909872">nil</span>&nbsp;<span class="op" id="3909876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909881">c</span><span class="op" id="3909882">.</span><span class="ident" id="3909883">server</span><span class="op" id="3909889">.</span><span class="ident" id="3909890">logf</span><span class="op" id="3909894">(</span><span class="string" id="3909895">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3909934">,</span>&nbsp;<span class="ident" id="3909936">c</span><span class="op" id="3909937">.</span><span class="ident" id="3909938">rwc</span><span class="op" id="3909941">.</span><span class="ident" id="3909942">RemoteAddr</span><span class="op" id="3909952">(</span><span class="op" id="3909953">)</span><span class="op" id="3909954">,</span>&nbsp;<span class="ident" id="3909956">err</span><span class="op" id="3909959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909964">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909973">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909977">c</span><span class="op" id="3909978">.</span><span class="ident" id="3909979">tlsState</span>&nbsp;<span class="op" id="3909988">=</span>&nbsp;<span class="builtinfunc" id="3909990">new</span><span class="op" id="3909993">(</span><span class="ident" id="3909994">tls</span><span class="op" id="3909997">.</span><span class="ident" id="3909998">ConnectionState</span><span class="op" id="3910013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910017">*</span><span class="ident" id="3910018">c</span><span class="op" id="3910019">.</span><span class="ident" id="3910020">tlsState</span>&nbsp;<span class="op" id="3910029">=</span>&nbsp;<span class="ident" id="3910031">tlsConn</span><span class="op" id="3910038">.</span><span class="ident" id="3910039">ConnectionState</span><span class="op" id="3910054">(</span><span class="op" id="3910055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910059">if</span>&nbsp;<span class="ident" id="3910062">proto</span>&nbsp;<span class="op" id="3910068">:=</span>&nbsp;<span class="ident" id="3910071">c</span><span class="op" id="3910072">.</span><span class="ident" id="3910073">tlsState</span><span class="op" id="3910081">.</span><span class="ident" id="3910082">NegotiatedProtocol</span><span class="op" id="3910100">;</span>&nbsp;<span class="ident" id="3910102">validNPN</span><span class="op" id="3910110">(</span><span class="ident" id="3910111">proto</span><span class="op" id="3910116">)</span>&nbsp;<span class="op" id="3910118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910123">if</span>&nbsp;<span class="ident" id="3910126">fn</span>&nbsp;<span class="op" id="3910129">:=</span>&nbsp;<span class="ident" id="3910132">c</span><span class="op" id="3910133">.</span><span class="ident" id="3910134">server</span><span class="op" id="3910140">.</span><span class="ident" id="3910141">TLSNextProto</span><span class="op" id="3910153">[</span><span class="ident" id="3910154">proto</span><span class="op" id="3910159">]</span><span class="op" id="3910160">;</span>&nbsp;<span class="ident" id="3910162">fn</span>&nbsp;<span class="op" id="3910165">!=</span>&nbsp;<span class="ident" id="3910168">nil</span>&nbsp;<span class="op" id="3910172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910178">h</span>&nbsp;<span class="op" id="3910180">:=</span>&nbsp;<span class="ident" id="3910183">initNPNRequest</span><span class="op" id="3910197">{</span><span class="ident" id="3910198">tlsConn</span><span class="op" id="3910205">,</span>&nbsp;<span class="ident" id="3910207">serverHandler</span><span class="op" id="3910220">{</span><span class="ident" id="3910221">c</span><span class="op" id="3910222">.</span><span class="ident" id="3910223">server</span><span class="op" id="3910229">}</span><span class="op" id="3910230">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910236">fn</span><span class="op" id="3910238">(</span><span class="ident" id="3910239">c</span><span class="op" id="3910240">.</span><span class="ident" id="3910241">server</span><span class="op" id="3910247">,</span>&nbsp;<span class="ident" id="3910249">tlsConn</span><span class="op" id="3910256">,</span>&nbsp;<span class="ident" id="3910258">h</span><span class="op" id="3910259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910269">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910281">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910285">for</span>&nbsp;<span class="op" id="3910289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910293">w</span><span class="op" id="3910294">,</span>&nbsp;<span class="ident" id="3910296">err</span>&nbsp;<span class="op" id="3910300">:=</span>&nbsp;<span class="ident" id="3910303">c</span><span class="op" id="3910304">.</span><span class="ident" id="3910305">readRequest</span><span class="op" id="3910316">(</span><span class="op" id="3910317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910321">if</span>&nbsp;<span class="ident" id="3910324">c</span><span class="op" id="3910325">.</span><span class="ident" id="3910326">lr</span><span class="op" id="3910328">.</span><span class="ident" id="3910329">N</span>&nbsp;<span class="op" id="3910331">!=</span>&nbsp;<span class="ident" id="3910334">c</span><span class="op" id="3910335">.</span><span class="ident" id="3910336">server</span><span class="op" id="3910342">.</span><span class="ident" id="3910343">initialLimitedReaderSize</span><span class="op" id="3910367">(</span><span class="op" id="3910368">)</span>&nbsp;<span class="op" id="3910370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910375">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910430">c</span><span class="op" id="3910431">.</span><span class="ident" id="3910432">setState</span><span class="op" id="3910440">(</span><span class="ident" id="3910441">c</span><span class="op" id="3910442">.</span><span class="ident" id="3910443">rwc</span><span class="op" id="3910446">,</span>&nbsp;<span class="ident" id="3910448">StateActive</span><span class="op" id="3910459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910467">if</span>&nbsp;<span class="ident" id="3910470">err</span>&nbsp;<span class="op" id="3910474">!=</span>&nbsp;<span class="ident" id="3910477">nil</span>&nbsp;<span class="op" id="3910481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910486">if</span>&nbsp;<span class="ident" id="3910489">err</span>&nbsp;<span class="op" id="3910493">==</span>&nbsp;<span class="ident" id="3910496">errTooLarge</span>&nbsp;<span class="op" id="3910508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910514">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910557">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910591">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910632">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910673">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910710">io</span><span class="op" id="3910712">.</span><span class="ident" id="3910713">WriteString</span><span class="op" id="3910724">(</span><span class="ident" id="3910725">c</span><span class="op" id="3910726">.</span><span class="ident" id="3910727">rwc</span><span class="op" id="3910730">,</span>&nbsp;<span class="string" id="3910732">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="3910779">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910785">c</span><span class="op" id="3910786">.</span><span class="ident" id="3910787">closeWriteAndWait</span><span class="op" id="3910804">(</span><span class="op" id="3910805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910811">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910820">}</span>&nbsp;<span class="keyword" id="3910822">else</span>&nbsp;<span class="keyword" id="3910827">if</span>&nbsp;<span class="ident" id="3910830">err</span>&nbsp;<span class="op" id="3910834">==</span>&nbsp;<span class="ident" id="3910837">io</span><span class="op" id="3910839">.</span><span class="ident" id="3910840">EOF</span>&nbsp;<span class="op" id="3910844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910850">break</span>&nbsp;<span class="comment" id="3910856">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910874">}</span>&nbsp;<span class="keyword" id="3910876">else</span>&nbsp;<span class="keyword" id="3910881">if</span>&nbsp;<span class="ident" id="3910884">neterr</span><span class="op" id="3910890">,</span>&nbsp;<span class="ident" id="3910892">ok</span>&nbsp;<span class="op" id="3910895">:=</span>&nbsp;<span class="ident" id="3910898">err</span><span class="op" id="3910901">.</span><span class="op" id="3910902">(</span><span class="ident" id="3910903">net</span><span class="op" id="3910906">.</span><span class="ident" id="3910907">Error</span><span class="op" id="3910912">)</span><span class="op" id="3910913">;</span>&nbsp;<span class="ident" id="3910915">ok</span>&nbsp;<span class="op" id="3910918">&amp;&amp;</span>&nbsp;<span class="ident" id="3910921">neterr</span><span class="op" id="3910927">.</span><span class="ident" id="3910928">Timeout</span><span class="op" id="3910935">(</span><span class="op" id="3910936">)</span>&nbsp;<span class="op" id="3910938">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910944">break</span>&nbsp;<span class="comment" id="3910950">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910973">io</span><span class="op" id="3910975">.</span><span class="ident" id="3910976">WriteString</span><span class="op" id="3910987">(</span><span class="ident" id="3910988">c</span><span class="op" id="3910989">.</span><span class="ident" id="3910990">rwc</span><span class="op" id="3910993">,</span>&nbsp;<span class="string" id="3910995">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="3911029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911034">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911042">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3911047">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911080">req</span>&nbsp;<span class="op" id="3911084">:=</span>&nbsp;<span class="ident" id="3911087">w</span><span class="op" id="3911088">.</span><span class="ident" id="3911089">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911095">if</span>&nbsp;<span class="ident" id="3911098">req</span><span class="op" id="3911101">.</span><span class="ident" id="3911102">expectsContinue</span><span class="op" id="3911117">(</span><span class="op" id="3911118">)</span>&nbsp;<span class="op" id="3911120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911125">if</span>&nbsp;<span class="ident" id="3911128">req</span><span class="op" id="3911131">.</span><span class="ident" id="3911132">ProtoAtLeast</span><span class="op" id="3911144">(</span><span class="num" id="3911145">1</span><span class="op" id="3911146">,</span>&nbsp;<span class="num" id="3911148">1</span><span class="op" id="3911149">)</span>&nbsp;<span class="op" id="3911151">&amp;&amp;</span>&nbsp;<span class="ident" id="3911154">req</span><span class="op" id="3911157">.</span><span class="ident" id="3911158">ContentLength</span>&nbsp;<span class="op" id="3911172">!=</span>&nbsp;<span class="num" id="3911175">0</span>&nbsp;<span class="op" id="3911177">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3911183">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911251">req</span><span class="op" id="3911254">.</span><span class="ident" id="3911255">Body</span>&nbsp;<span class="op" id="3911260">=</span>&nbsp;<span class="op" id="3911262">&amp;</span><span class="ident" id="3911263">expectContinueReader</span><span class="op" id="3911283">{</span><span class="ident" id="3911284">readCloser</span><span class="op" id="3911294">:</span>&nbsp;<span class="ident" id="3911296">req</span><span class="op" id="3911299">.</span><span class="ident" id="3911300">Body</span><span class="op" id="3911304">,</span>&nbsp;<span class="ident" id="3911306">resp</span><span class="op" id="3911310">:</span>&nbsp;<span class="ident" id="3911312">w</span><span class="op" id="3911313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911323">req</span><span class="op" id="3911326">.</span><span class="ident" id="3911327">Header</span><span class="op" id="3911333">.</span><span class="ident" id="3911334">Del</span><span class="op" id="3911337">(</span><span class="string" id="3911338">&#34;Expect&#34;</span><span class="op" id="3911346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911350">}</span>&nbsp;<span class="keyword" id="3911352">else</span>&nbsp;<span class="keyword" id="3911357">if</span>&nbsp;<span class="ident" id="3911360">req</span><span class="op" id="3911363">.</span><span class="ident" id="3911364">Header</span><span class="op" id="3911370">.</span><span class="ident" id="3911371">get</span><span class="op" id="3911374">(</span><span class="string" id="3911375">&#34;Expect&#34;</span><span class="op" id="3911383">)</span>&nbsp;<span class="op" id="3911385">!=</span>&nbsp;<span class="string" id="3911388">&#34;&#34;</span>&nbsp;<span class="op" id="3911391">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911396">w</span><span class="op" id="3911397">.</span><span class="ident" id="3911398">sendExpectationFailed</span><span class="op" id="3911419">(</span><span class="op" id="3911420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911425">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3911438">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3911502">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3911572">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3911632">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3911708">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911772">serverHandler</span><span class="op" id="3911785">{</span><span class="ident" id="3911786">c</span><span class="op" id="3911787">.</span><span class="ident" id="3911788">server</span><span class="op" id="3911794">}</span><span class="op" id="3911795">.</span><span class="ident" id="3911796">ServeHTTP</span><span class="op" id="3911805">(</span><span class="ident" id="3911806">w</span><span class="op" id="3911807">,</span>&nbsp;<span class="ident" id="3911809">w</span><span class="op" id="3911810">.</span><span class="ident" id="3911811">req</span><span class="op" id="3911814">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911818">if</span>&nbsp;<span class="ident" id="3911821">c</span><span class="op" id="3911822">.</span><span class="ident" id="3911823">hijacked</span><span class="op" id="3911831">(</span><span class="op" id="3911832">)</span>&nbsp;<span class="op" id="3911834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911839">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911852">w</span><span class="op" id="3911853">.</span><span class="ident" id="3911854">finishRequest</span><span class="op" id="3911867">(</span><span class="op" id="3911868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911872">if</span>&nbsp;<span class="ident" id="3911875">w</span><span class="op" id="3911876">.</span><span class="ident" id="3911877">closeAfterReply</span>&nbsp;<span class="op" id="3911893">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911898">if</span>&nbsp;<span class="ident" id="3911901">w</span><span class="op" id="3911902">.</span><span class="ident" id="3911903">requestBodyLimitHit</span>&nbsp;<span class="op" id="3911923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911929">c</span><span class="op" id="3911930">.</span><span class="ident" id="3911931">closeWriteAndWait</span><span class="op" id="3911948">(</span><span class="op" id="3911949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911959">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911967">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911971">c</span><span class="op" id="3911972">.</span><span class="ident" id="3911973">setState</span><span class="op" id="3911981">(</span><span class="ident" id="3911982">c</span><span class="op" id="3911983">.</span><span class="ident" id="3911984">rwc</span><span class="op" id="3911987">,</span>&nbsp;<span class="ident" id="3911989">StateIdle</span><span class="op" id="3911998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3912001">}</span><br>
<span class="lineno"></span><span class="op" id="3912003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3912006">func</span>&nbsp;<span class="op" id="3912011">(</span><span class="ident" id="3912012">w</span>&nbsp;<span class="op" id="3912014">*</span><span class="ident" id="3912015">response</span><span class="op" id="3912023">)</span>&nbsp;<span class="ident" id="3912025">sendExpectationFailed</span><span class="op" id="3912046">(</span><span class="op" id="3912047">)</span>&nbsp;<span class="op" id="3912049">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912052">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912102">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912155">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912205">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912255">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912295">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912339">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912343">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912397">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912447">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912494">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912542">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912595">w</span><span class="op" id="3912596">.</span><span class="ident" id="3912597">Header</span><span class="op" id="3912603">(</span><span class="op" id="3912604">)</span><span class="op" id="3912605">.</span><span class="ident" id="3912606">Set</span><span class="op" id="3912609">(</span><span class="string" id="3912610">&#34;Connection&#34;</span><span class="op" id="3912622">,</span>&nbsp;<span class="string" id="3912624">&#34;close&#34;</span><span class="op" id="3912631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912634">w</span><span class="op" id="3912635">.</span><span class="ident" id="3912636">WriteHeader</span><span class="op" id="3912647">(</span><span class="ident" id="3912648">StatusExpectationFailed</span><span class="op" id="3912671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912674">w</span><span class="op" id="3912675">.</span><span class="ident" id="3912676">finishRequest</span><span class="op" id="3912689">(</span><span class="op" id="3912690">)</span><br>
<span class="lineno">1235</span><span class="op" id="3912692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3912695">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3912782">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="3912801">func</span>&nbsp;<span class="op" id="3912806">(</span><span class="ident" id="3912807">w</span>&nbsp;<span class="op" id="3912809">*</span><span class="ident" id="3912810">response</span><span class="op" id="3912818">)</span>&nbsp;<span class="ident" id="3912820">Hijack</span><span class="op" id="3912826">(</span><span class="op" id="3912827">)</span>&nbsp;<span class="op" id="3912829">(</span><span class="ident" id="3912830">rwc</span>&nbsp;<span class="ident" id="3912834">net</span><span class="op" id="3912837">.</span><span class="ident" id="3912838">Conn</span><span class="op" id="3912842">,</span>&nbsp;<span class="ident" id="3912844">buf</span>&nbsp;<span class="op" id="3912848">*</span><span class="ident" id="3912849">bufio</span><span class="op" id="3912854">.</span><span class="ident" id="3912855">ReadWriter</span><span class="op" id="3912865">,</span>&nbsp;<span class="ident" id="3912867">err</span>&nbsp;<span class="builtintype" id="3912871">error</span><span class="op" id="3912876">)</span>&nbsp;<span class="op" id="3912878">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912881">if</span>&nbsp;<span class="ident" id="3912884">w</span><span class="op" id="3912885">.</span><span class="ident" id="3912886">wroteHeader</span>&nbsp;<span class="op" id="3912898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912902">w</span><span class="op" id="3912903">.</span><span class="ident" id="3912904">cw</span><span class="op" id="3912906">.</span><span class="ident" id="3912907">flush</span><span class="op" id="3912912">(</span><span class="op" id="3912913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3912916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912919">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912990">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913037">rwc</span><span class="op" id="3913040">,</span>&nbsp;<span class="ident" id="3913042">buf</span><span class="op" id="3913045">,</span>&nbsp;<span class="ident" id="3913047">err</span>&nbsp;<span class="op" id="3913051">=</span>&nbsp;<span class="ident" id="3913053">w</span><span class="op" id="3913054">.</span><span class="ident" id="3913055">conn</span><span class="op" id="3913059">.</span><span class="ident" id="3913060">hijack</span><span class="op" id="3913066">(</span><span class="op" id="3913067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3913070">if</span>&nbsp;<span class="ident" id="3913073">err</span>&nbsp;<span class="op" id="3913077">==</span>&nbsp;<span class="ident" id="3913080">nil</span>&nbsp;<span class="op" id="3913084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913088">putBufioWriter</span><span class="op" id="3913102">(</span><span class="ident" id="3913103">w</span><span class="op" id="3913104">.</span><span class="ident" id="3913105">w</span><span class="op" id="3913106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913110">w</span><span class="op" id="3913111">.</span><span class="ident" id="3913112">w</span>&nbsp;<span class="op" id="3913114">=</span>&nbsp;<span class="ident" id="3913116">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3913121">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3913124">return</span>&nbsp;<span class="ident" id="3913131">rwc</span><span class="op" id="3913134">,</span>&nbsp;<span class="ident" id="3913136">buf</span><span class="op" id="3913139">,</span>&nbsp;<span class="ident" id="3913141">err</span><br>
<span class="lineno"></span><span class="op" id="3913145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3913148">func</span>&nbsp;<span class="op" id="3913153">(</span><span class="ident" id="3913154">w</span>&nbsp;<span class="op" id="3913156">*</span><span class="ident" id="3913157">response</span><span class="op" id="3913165">)</span>&nbsp;<span class="ident" id="3913167">CloseNotify</span><span class="op" id="3913178">(</span><span class="op" id="3913179">)</span>&nbsp;<span class="op" id="3913181">&lt;-</span><span class="keyword" id="3913183">chan</span>&nbsp;<span class="builtintype" id="3913188">bool</span>&nbsp;<span class="op" id="3913193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3913196">return</span>&nbsp;<span class="ident" id="3913203">w</span><span class="op" id="3913204">.</span><span class="ident" id="3913205">conn</span><span class="op" id="3913209">.</span><span class="ident" id="3913210">closeNotify</span><span class="op" id="3913221">(</span><span class="op" id="3913222">)</span><br>
<span class="lineno">1255</span><span class="op" id="3913224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3913227">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3913285">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="3913345">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="3913400">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="3913432">type</span>&nbsp;<span class="ident" id="3913437">HandlerFunc</span>&nbsp;<span class="keyword" id="3913449">func</span><span class="op" id="3913453">(</span><span class="ident" id="3913454">ResponseWriter</span><span class="op" id="3913468">,</span>&nbsp;<span class="op" id="3913470">*</span><span class="ident" id="3913471">Request</span><span class="op" id="3913478">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3913481">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="3913509">func</span>&nbsp;<span class="op" id="3913514">(</span><span class="ident" id="3913515">f</span>&nbsp;<span class="ident" id="3913517">HandlerFunc</span><span class="op" id="3913528">)</span>&nbsp;<span class="ident" id="3913530">ServeHTTP</span><span class="op" id="3913539">(</span><span class="ident" id="3913540">w</span>&nbsp;<span class="ident" id="3913542">ResponseWriter</span><span class="op" id="3913556">,</span>&nbsp;<span class="ident" id="3913558">r</span>&nbsp;<span class="op" id="3913560">*</span><span class="ident" id="3913561">Request</span><span class="op" id="3913568">)</span>&nbsp;<span class="op" id="3913570">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913573">f</span><span class="op" id="3913574">(</span><span class="ident" id="3913575">w</span><span class="op" id="3913576">,</span>&nbsp;<span class="ident" id="3913578">r</span><span class="op" id="3913579">)</span><br>
<span class="lineno"></span><span class="op" id="3913581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3913584">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="3913604">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="3913684">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="3913727">func</span>&nbsp;<span class="ident" id="3913732">Error</span><span class="op" id="3913737">(</span><span class="ident" id="3913738">w</span>&nbsp;<span class="ident" id="3913740">ResponseWriter</span><span class="op" id="3913754">,</span>&nbsp;<span class="builtintype" id="3913756">error</span>&nbsp;<span class="builtintype" id="3913762">string</span><span class="op" id="3913768">,</span>&nbsp;<span class="ident" id="3913770">code</span>&nbsp;<span class="builtintype" id="3913775">int</span><span class="op" id="3913778">)</span>&nbsp;<span class="op" id="3913780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913783">w</span><span class="op" id="3913784">.</span><span class="ident" id="3913785">Header</span><span class="op" id="3913791">(</span><span class="op" id="3913792">)</span><span class="op" id="3913793">.</span><span class="ident" id="3913794">Set</span><span class="op" id="3913797">(</span><span class="string" id="3913798">&#34;Content-Type&#34;</span><span class="op" id="3913812">,</span>&nbsp;<span class="string" id="3913814">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="3913841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913844">w</span><span class="op" id="3913845">.</span><span class="ident" id="3913846">WriteHeader</span><span class="op" id="3913857">(</span><span class="ident" id="3913858">code</span><span class="op" id="3913862">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913865">fmt</span><span class="op" id="3913868">.</span><span class="ident" id="3913869">Fprintln</span><span class="op" id="3913877">(</span><span class="ident" id="3913878">w</span><span class="op" id="3913879">,</span>&nbsp;<span class="builtintype" id="3913881">error</span><span class="op" id="3913886">)</span><br>
<span class="lineno"></span><span class="op" id="3913888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3913891">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3913960">func</span>&nbsp;<span class="ident" id="3913965">NotFound</span><span class="op" id="3913973">(</span><span class="ident" id="3913974">w</span>&nbsp;<span class="ident" id="3913976">ResponseWriter</span><span class="op" id="3913990">,</span>&nbsp;<span class="ident" id="3913992">r</span>&nbsp;<span class="op" id="3913994">*</span><span class="ident" id="3913995">Request</span><span class="op" id="3914002">)</span>&nbsp;<span class="op" id="3914004">{</span>&nbsp;<span class="ident" id="3914006">Error</span><span class="op" id="3914011">(</span><span class="ident" id="3914012">w</span><span class="op" id="3914013">,</span>&nbsp;<span class="string" id="3914015">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="3914035">,</span>&nbsp;<span class="ident" id="3914037">StatusNotFound</span><span class="op" id="3914051">)</span>&nbsp;<span class="op" id="3914053">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="3914056">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="3914108">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3914177">func</span>&nbsp;<span class="ident" id="3914182">NotFoundHandler</span><span class="op" id="3914197">(</span><span class="op" id="3914198">)</span>&nbsp;<span class="ident" id="3914200">Handler</span>&nbsp;<span class="op" id="3914208">{</span>&nbsp;<span class="keyword" id="3914210">return</span>&nbsp;<span class="ident" id="3914217">HandlerFunc</span><span class="op" id="3914228">(</span><span class="ident" id="3914229">NotFound</span><span class="op" id="3914237">)</span>&nbsp;<span class="op" id="3914239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="3914242">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3914301">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="3914361">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3914414">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3914470">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="3914516">func</span>&nbsp;<span class="ident" id="3914521">StripPrefix</span><span class="op" id="3914532">(</span><span class="ident" id="3914533">prefix</span>&nbsp;<span class="builtintype" id="3914540">string</span><span class="op" id="3914546">,</span>&nbsp;<span class="ident" id="3914548">h</span>&nbsp;<span class="ident" id="3914550">Handler</span><span class="op" id="3914557">)</span>&nbsp;<span class="ident" id="3914559">Handler</span>&nbsp;<span class="op" id="3914567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914570">if</span>&nbsp;<span class="ident" id="3914573">prefix</span>&nbsp;<span class="op" id="3914580">==</span>&nbsp;<span class="string" id="3914583">&#34;&#34;</span>&nbsp;<span class="op" id="3914586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914590">return</span>&nbsp;<span class="ident" id="3914597">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914603">return</span>&nbsp;<span class="ident" id="3914610">HandlerFunc</span><span class="op" id="3914621">(</span><span class="keyword" id="3914622">func</span><span class="op" id="3914626">(</span><span class="ident" id="3914627">w</span>&nbsp;<span class="ident" id="3914629">ResponseWriter</span><span class="op" id="3914643">,</span>&nbsp;<span class="ident" id="3914645">r</span>&nbsp;<span class="op" id="3914647">*</span><span class="ident" id="3914648">Request</span><span class="op" id="3914655">)</span>&nbsp;<span class="op" id="3914657">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914661">if</span>&nbsp;<span class="ident" id="3914664">p</span>&nbsp;<span class="op" id="3914666">:=</span>&nbsp;<span class="ident" id="3914669">strings</span><span class="op" id="3914676">.</span><span class="ident" id="3914677">TrimPrefix</span><span class="op" id="3914687">(</span><span class="ident" id="3914688">r</span><span class="op" id="3914689">.</span><span class="ident" id="3914690">URL</span><span class="op" id="3914693">.</span><span class="ident" id="3914694">Path</span><span class="op" id="3914698">,</span>&nbsp;<span class="ident" id="3914700">prefix</span><span class="op" id="3914706">)</span><span class="op" id="3914707">;</span>&nbsp;<span class="builtinfunc" id="3914709">len</span><span class="op" id="3914712">(</span><span class="ident" id="3914713">p</span><span class="op" id="3914714">)</span>&nbsp;<span class="op" id="3914716">&lt;</span>&nbsp;<span class="builtinfunc" id="3914718">len</span><span class="op" id="3914721">(</span><span class="ident" id="3914722">r</span><span class="op" id="3914723">.</span><span class="ident" id="3914724">URL</span><span class="op" id="3914727">.</span><span class="ident" id="3914728">Path</span><span class="op" id="3914732">)</span>&nbsp;<span class="op" id="3914734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914739">r</span><span class="op" id="3914740">.</span><span class="ident" id="3914741">URL</span><span class="op" id="3914744">.</span><span class="ident" id="3914745">Path</span>&nbsp;<span class="op" id="3914750">=</span>&nbsp;<span class="ident" id="3914752">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914757">h</span><span class="op" id="3914758">.</span><span class="ident" id="3914759">ServeHTTP</span><span class="op" id="3914768">(</span><span class="ident" id="3914769">w</span><span class="op" id="3914770">,</span>&nbsp;<span class="ident" id="3914772">r</span><span class="op" id="3914773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914777">}</span>&nbsp;<span class="keyword" id="3914779">else</span>&nbsp;<span class="op" id="3914784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914789">NotFound</span><span class="op" id="3914797">(</span><span class="ident" id="3914798">w</span><span class="op" id="3914799">,</span>&nbsp;<span class="ident" id="3914801">r</span><span class="op" id="3914802">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914809">}</span><span class="op" id="3914810">)</span><br>
<span class="lineno"></span><span class="op" id="3914812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3914815">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="3914874">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="3914927">func</span>&nbsp;<span class="ident" id="3914932">Redirect</span><span class="op" id="3914940">(</span><span class="ident" id="3914941">w</span>&nbsp;<span class="ident" id="3914943">ResponseWriter</span><span class="op" id="3914957">,</span>&nbsp;<span class="ident" id="3914959">r</span>&nbsp;<span class="op" id="3914961">*</span><span class="ident" id="3914962">Request</span><span class="op" id="3914969">,</span>&nbsp;<span class="ident" id="3914971">urlStr</span>&nbsp;<span class="builtintype" id="3914978">string</span><span class="op" id="3914984">,</span>&nbsp;<span class="ident" id="3914986">code</span>&nbsp;<span class="builtintype" id="3914991">int</span><span class="op" id="3914994">)</span>&nbsp;<span class="op" id="3914996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914999">if</span>&nbsp;<span class="ident" id="3915002">u</span><span class="op" id="3915003">,</span>&nbsp;<span class="ident" id="3915005">err</span>&nbsp;<span class="op" id="3915009">:=</span>&nbsp;<span class="ident" id="3915012">url</span><span class="op" id="3915015">.</span><span class="ident" id="3915016">Parse</span><span class="op" id="3915021">(</span><span class="ident" id="3915022">urlStr</span><span class="op" id="3915028">)</span><span class="op" id="3915029">;</span>&nbsp;<span class="ident" id="3915031">err</span>&nbsp;<span class="op" id="3915035">==</span>&nbsp;<span class="ident" id="3915038">nil</span>&nbsp;<span class="op" id="3915042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915046">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915089">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915123">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915171">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915218">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915266">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915306">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915346">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915381">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915423">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915468">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915516">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915563">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915615">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915668">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915683">oldpath</span>&nbsp;<span class="op" id="3915691">:=</span>&nbsp;<span class="ident" id="3915694">r</span><span class="op" id="3915695">.</span><span class="ident" id="3915696">URL</span><span class="op" id="3915699">.</span><span class="ident" id="3915700">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915707">if</span>&nbsp;<span class="ident" id="3915710">oldpath</span>&nbsp;<span class="op" id="3915718">==</span>&nbsp;<span class="string" id="3915721">&#34;&#34;</span>&nbsp;<span class="op" id="3915724">{</span>&nbsp;<span class="comment" id="3915726">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915780">oldpath</span>&nbsp;<span class="op" id="3915788">=</span>&nbsp;<span class="string" id="3915790">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3915796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915800">if</span>&nbsp;<span class="ident" id="3915803">u</span><span class="op" id="3915804">.</span><span class="ident" id="3915805">Scheme</span>&nbsp;<span class="op" id="3915812">==</span>&nbsp;<span class="string" id="3915815">&#34;&#34;</span>&nbsp;<span class="op" id="3915818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915823">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915854">if</span>&nbsp;<span class="ident" id="3915857">urlStr</span>&nbsp;<span class="op" id="3915864">==</span>&nbsp;<span class="string" id="3915867">&#34;&#34;</span>&nbsp;<span class="op" id="3915870">||</span>&nbsp;<span class="ident" id="3915873">urlStr</span><span class="op" id="3915879">[</span><span class="num" id="3915880">0</span><span class="op" id="3915881">]</span>&nbsp;<span class="op" id="3915883">!=</span>&nbsp;<span class="string" id="3915886">&#39;/&#39;</span>&nbsp;<span class="op" id="3915890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915896">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915931">olddir</span><span class="op" id="3915937">,</span>&nbsp;<span class="ident" id="3915939">_</span>&nbsp;<span class="op" id="3915941">:=</span>&nbsp;<span class="ident" id="3915944">path</span><span class="op" id="3915948">.</span><span class="ident" id="3915949">Split</span><span class="op" id="3915954">(</span><span class="ident" id="3915955">oldpath</span><span class="op" id="3915962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915968">urlStr</span>&nbsp;<span class="op" id="3915975">=</span>&nbsp;<span class="ident" id="3915977">olddir</span>&nbsp;<span class="op" id="3915984">+</span>&nbsp;<span class="ident" id="3915986">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3915996">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916002">var</span>&nbsp;<span class="ident" id="3916006">query</span>&nbsp;<span class="builtintype" id="3916012">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916022">if</span>&nbsp;<span class="ident" id="3916025">i</span>&nbsp;<span class="op" id="3916027">:=</span>&nbsp;<span class="ident" id="3916030">strings</span><span class="op" id="3916037">.</span><span class="ident" id="3916038">Index</span><span class="op" id="3916043">(</span><span class="ident" id="3916044">urlStr</span><span class="op" id="3916050">,</span>&nbsp;<span class="string" id="3916052">&#34;?&#34;</span><span class="op" id="3916055">)</span><span class="op" id="3916056">;</span>&nbsp;<span class="ident" id="3916058">i</span>&nbsp;<span class="op" id="3916060">!=</span>&nbsp;<span class="op" id="3916063">-</span><span class="num" id="3916064">1</span>&nbsp;<span class="op" id="3916066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916072">urlStr</span><span class="op" id="3916078">,</span>&nbsp;<span class="ident" id="3916080">query</span>&nbsp;<span class="op" id="3916086">=</span>&nbsp;<span class="ident" id="3916088">urlStr</span><span class="op" id="3916094">[</span><span class="op" id="3916095">:</span><span class="ident" id="3916096">i</span><span class="op" id="3916097">]</span><span class="op" id="3916098">,</span>&nbsp;<span class="ident" id="3916100">urlStr</span><span class="op" id="3916106">[</span><span class="ident" id="3916107">i</span><span class="op" id="3916108">:</span><span class="op" id="3916109">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3916114">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916120">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916163">trailing</span>&nbsp;<span class="op" id="3916172">:=</span>&nbsp;<span class="ident" id="3916175">strings</span><span class="op" id="3916182">.</span><span class="ident" id="3916183">HasSuffix</span><span class="op" id="3916192">(</span><span class="ident" id="3916193">urlStr</span><span class="op" id="3916199">,</span>&nbsp;<span class="string" id="3916201">&#34;/&#34;</span><span class="op" id="3916204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916209">urlStr</span>&nbsp;<span class="op" id="3916216">=</span>&nbsp;<span class="ident" id="3916218">path</span><span class="op" id="3916222">.</span><span class="ident" id="3916223">Clean</span><span class="op" id="3916228">(</span><span class="ident" id="3916229">urlStr</span><span class="op" id="3916235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916240">if</span>&nbsp;<span class="ident" id="3916243">trailing</span>&nbsp;<span class="op" id="3916252">&amp;&amp;</span>&nbsp;<span class="op" id="3916255">!</span><span class="ident" id="3916256">strings</span><span class="op" id="3916263">.</span><span class="ident" id="3916264">HasSuffix</span><span class="op" id="3916273">(</span><span class="ident" id="3916274">urlStr</span><span class="op" id="3916280">,</span>&nbsp;<span class="string" id="3916282">&#34;/&#34;</span><span class="op" id="3916285">)</span>&nbsp;<span class="op" id="3916287">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916293">urlStr</span>&nbsp;<span class="op" id="3916300">+=</span>&nbsp;<span class="string" id="3916303">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3916310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916315">urlStr</span>&nbsp;<span class="op" id="3916322">+=</span>&nbsp;<span class="ident" id="3916325">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3916333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3916336">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916340">w</span><span class="op" id="3916341">.</span><span class="ident" id="3916342">Header</span><span class="op" id="3916348">(</span><span class="op" id="3916349">)</span><span class="op" id="3916350">.</span><span class="ident" id="3916351">Set</span><span class="op" id="3916354">(</span><span class="string" id="3916355">&#34;Location&#34;</span><span class="op" id="3916365">,</span>&nbsp;<span class="ident" id="3916367">urlStr</span><span class="op" id="3916373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916376">w</span><span class="op" id="3916377">.</span><span class="ident" id="3916378">WriteHeader</span><span class="op" id="3916389">(</span><span class="ident" id="3916390">code</span><span class="op" id="3916394">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916398">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916467">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916534">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916601">if</span>&nbsp;<span class="ident" id="3916604">r</span><span class="op" id="3916605">.</span><span class="ident" id="3916606">Method</span>&nbsp;<span class="op" id="3916613">==</span>&nbsp;<span class="string" id="3916616">&#34;GET&#34;</span>&nbsp;<span class="op" id="3916622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916626">note</span>&nbsp;<span class="op" id="3916631">:=</span>&nbsp;<span class="string" id="3916634">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="3916647">+</span>&nbsp;<span class="ident" id="3916649">htmlEscape</span><span class="op" id="3916659">(</span><span class="ident" id="3916660">urlStr</span><span class="op" id="3916666">)</span>&nbsp;<span class="op" id="3916668">+</span>&nbsp;<span class="string" id="3916670">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="3916676">+</span>&nbsp;<span class="ident" id="3916678">statusText</span><span class="op" id="3916688">[</span><span class="ident" id="3916689">code</span><span class="op" id="3916693">]</span>&nbsp;<span class="op" id="3916695">+</span>&nbsp;<span class="string" id="3916697">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916709">fmt</span><span class="op" id="3916712">.</span><span class="ident" id="3916713">Fprintln</span><span class="op" id="3916721">(</span><span class="ident" id="3916722">w</span><span class="op" id="3916723">,</span>&nbsp;<span class="ident" id="3916725">note</span><span class="op" id="3916729">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3916732">}</span><br>
<span class="lineno"></span><span class="op" id="3916734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3916737">var</span>&nbsp;<span class="ident" id="3916741">htmlReplacer</span>&nbsp;<span class="op" id="3916754">=</span>&nbsp;<span class="ident" id="3916756">strings</span><span class="op" id="3916763">.</span><span class="ident" id="3916764">NewReplacer</span><span class="op" id="3916775">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3916778">&#34;&amp;&#34;</span><span class="op" id="3916781">,</span>&nbsp;<span class="string" id="3916783">&#34;&amp;amp;&#34;</span><span class="op" id="3916790">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3916793">&#34;&lt;&#34;</span><span class="op" id="3916796">,</span>&nbsp;<span class="string" id="3916798">&#34;&amp;lt;&#34;</span><span class="op" id="3916804">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3916807">&#34;&gt;&#34;</span><span class="op" id="3916810">,</span>&nbsp;<span class="string" id="3916812">&#34;&amp;gt;&#34;</span><span class="op" id="3916818">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916821">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3916859">`&#34;`</span><span class="op" id="3916862">,</span>&nbsp;<span class="string" id="3916864">&#34;&amp;#34;&#34;</span><span class="op" id="3916871">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916874">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3916949">&#34;&#39;&#34;</span><span class="op" id="3916952">,</span>&nbsp;<span class="string" id="3916954">&#34;&amp;#39;&#34;</span><span class="op" id="3916961">,</span><br>
<span class="lineno"></span><span class="op" id="3916963">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3916966">func</span>&nbsp;<span class="ident" id="3916971">htmlEscape</span><span class="op" id="3916981">(</span><span class="ident" id="3916982">s</span>&nbsp;<span class="builtintype" id="3916984">string</span><span class="op" id="3916990">)</span>&nbsp;<span class="builtintype" id="3916992">string</span>&nbsp;<span class="op" id="3916999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917002">return</span>&nbsp;<span class="ident" id="3917009">htmlReplacer</span><span class="op" id="3917021">.</span><span class="ident" id="3917022">Replace</span><span class="op" id="3917029">(</span><span class="ident" id="3917030">s</span><span class="op" id="3917031">)</span><br>
<span class="lineno">1375</span><span class="op" id="3917033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3917036">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="3917063">type</span>&nbsp;<span class="ident" id="3917068">redirectHandler</span>&nbsp;<span class="keyword" id="3917084">struct</span>&nbsp;<span class="op" id="3917091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917094">url</span>&nbsp;&nbsp;<span class="builtintype" id="3917099">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917107">code</span>&nbsp;<span class="builtintype" id="3917112">int</span><br>
<span class="lineno"></span><span class="op" id="3917116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3917119">func</span>&nbsp;<span class="op" id="3917124">(</span><span class="ident" id="3917125">rh</span>&nbsp;<span class="op" id="3917128">*</span><span class="ident" id="3917129">redirectHandler</span><span class="op" id="3917144">)</span>&nbsp;<span class="ident" id="3917146">ServeHTTP</span><span class="op" id="3917155">(</span><span class="ident" id="3917156">w</span>&nbsp;<span class="ident" id="3917158">ResponseWriter</span><span class="op" id="3917172">,</span>&nbsp;<span class="ident" id="3917174">r</span>&nbsp;<span class="op" id="3917176">*</span><span class="ident" id="3917177">Request</span><span class="op" id="3917184">)</span>&nbsp;<span class="op" id="3917186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917189">Redirect</span><span class="op" id="3917197">(</span><span class="ident" id="3917198">w</span><span class="op" id="3917199">,</span>&nbsp;<span class="ident" id="3917201">r</span><span class="op" id="3917202">,</span>&nbsp;<span class="ident" id="3917204">rh</span><span class="op" id="3917206">.</span><span class="ident" id="3917207">url</span><span class="op" id="3917210">,</span>&nbsp;<span class="ident" id="3917212">rh</span><span class="op" id="3917214">.</span><span class="ident" id="3917215">code</span><span class="op" id="3917219">)</span><br>
<span class="lineno">1385</span><span class="op" id="3917221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3917224">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="3917284">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="3917345">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="3917361">func</span>&nbsp;<span class="ident" id="3917366">RedirectHandler</span><span class="op" id="3917381">(</span><span class="ident" id="3917382">url</span>&nbsp;<span class="builtintype" id="3917386">string</span><span class="op" id="3917392">,</span>&nbsp;<span class="ident" id="3917394">code</span>&nbsp;<span class="builtintype" id="3917399">int</span><span class="op" id="3917402">)</span>&nbsp;<span class="ident" id="3917404">Handler</span>&nbsp;<span class="op" id="3917412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917415">return</span>&nbsp;<span class="op" id="3917422">&amp;</span><span class="ident" id="3917423">redirectHandler</span><span class="op" id="3917438">{</span><span class="ident" id="3917439">url</span><span class="op" id="3917442">,</span>&nbsp;<span class="ident" id="3917444">code</span><span class="op" id="3917448">}</span><br>
<span class="lineno"></span><span class="op" id="3917450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3917453">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="3917497">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="3917573">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3917628">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="3917661">//</span><br>
<span class="lineno"></span><span class="comment" id="3917664">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="3917723">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="3917789">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3917851">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3917907">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3917964">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="3918024">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3918083">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="3918106">//</span><br>
<span class="lineno"></span><span class="comment" id="3918109">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="3918180">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="3918249">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3918297">//</span><br>
<span class="lineno"></span><span class="comment" id="3918300">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3918374">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3918446">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="3918521">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3918592">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3918634">//</span><br>
<span class="lineno"></span><span class="comment" id="3918637">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="3918701">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="3918762">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3918796">type</span>&nbsp;<span class="ident" id="3918801">ServeMux</span>&nbsp;<span class="keyword" id="3918810">struct</span>&nbsp;<span class="op" id="3918817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918820">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3918826">sync</span><span class="op" id="3918830">.</span><span class="ident" id="3918831">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918840">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3918846">map</span><span class="op" id="3918849">[</span><span class="builtintype" id="3918850">string</span><span class="op" id="3918856">]</span><span class="ident" id="3918857">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918867">hosts</span>&nbsp;<span class="builtintype" id="3918873">bool</span>&nbsp;<span class="comment" id="3918878">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="3918920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3918923">type</span>&nbsp;<span class="ident" id="3918928">muxEntry</span>&nbsp;<span class="keyword" id="3918937">struct</span>&nbsp;<span class="op" id="3918944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918947">explicit</span>&nbsp;<span class="builtintype" id="3918956">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918962">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3918971">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918980">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="3918989">string</span><br>
<span class="lineno"></span><span class="op" id="3918996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3918999">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="3919052">func</span>&nbsp;<span class="ident" id="3919057">NewServeMux</span><span class="op" id="3919068">(</span><span class="op" id="3919069">)</span>&nbsp;<span class="op" id="3919071">*</span><span class="ident" id="3919072">ServeMux</span>&nbsp;<span class="op" id="3919081">{</span>&nbsp;<span class="keyword" id="3919083">return</span>&nbsp;<span class="op" id="3919090">&amp;</span><span class="ident" id="3919091">ServeMux</span><span class="op" id="3919099">{</span><span class="ident" id="3919100">m</span><span class="op" id="3919101">:</span>&nbsp;<span class="builtinfunc" id="3919103">make</span><span class="op" id="3919107">(</span><span class="keyword" id="3919108">map</span><span class="op" id="3919111">[</span><span class="builtintype" id="3919112">string</span><span class="op" id="3919118">]</span><span class="ident" id="3919119">muxEntry</span><span class="op" id="3919127">)</span><span class="op" id="3919128">}</span>&nbsp;<span class="op" id="3919130">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="3919133">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="3919191">var</span>&nbsp;<span class="ident" id="3919195">DefaultServeMux</span>&nbsp;<span class="op" id="3919211">=</span>&nbsp;<span class="ident" id="3919213">NewServeMux</span><span class="op" id="3919224">(</span><span class="op" id="3919225">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3919228">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="3919256">func</span>&nbsp;<span class="ident" id="3919261">pathMatch</span><span class="op" id="3919270">(</span><span class="ident" id="3919271">pattern</span><span class="op" id="3919278">,</span>&nbsp;<span class="ident" id="3919280">path</span>&nbsp;<span class="builtintype" id="3919285">string</span><span class="op" id="3919291">)</span>&nbsp;<span class="builtintype" id="3919293">bool</span>&nbsp;<span class="op" id="3919298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919301">if</span>&nbsp;<span class="builtinfunc" id="3919304">len</span><span class="op" id="3919307">(</span><span class="ident" id="3919308">pattern</span><span class="op" id="3919315">)</span>&nbsp;<span class="op" id="3919317">==</span>&nbsp;<span class="num" id="3919320">0</span>&nbsp;<span class="op" id="3919322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3919326">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919349">return</span>&nbsp;<span class="builtintype" id="3919356">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919363">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919366">n</span>&nbsp;<span class="op" id="3919368">:=</span>&nbsp;<span class="builtinfunc" id="3919371">len</span><span class="op" id="3919374">(</span><span class="ident" id="3919375">pattern</span><span class="op" id="3919382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919385">if</span>&nbsp;<span class="ident" id="3919388">pattern</span><span class="op" id="3919395">[</span><span class="ident" id="3919396">n</span><span class="op" id="3919397">-</span><span class="num" id="3919398">1</span><span class="op" id="3919399">]</span>&nbsp;<span class="op" id="3919401">!=</span>&nbsp;<span class="string" id="3919404">&#39;/&#39;</span>&nbsp;<span class="op" id="3919408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919412">return</span>&nbsp;<span class="ident" id="3919419">pattern</span>&nbsp;<span class="op" id="3919427">==</span>&nbsp;<span class="ident" id="3919430">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919439">return</span>&nbsp;<span class="builtinfunc" id="3919446">len</span><span class="op" id="3919449">(</span><span class="ident" id="3919450">path</span><span class="op" id="3919454">)</span>&nbsp;<span class="op" id="3919456">&gt;=</span>&nbsp;<span class="ident" id="3919459">n</span>&nbsp;<span class="op" id="3919461">&amp;&amp;</span>&nbsp;<span class="ident" id="3919464">path</span><span class="op" id="3919468">[</span><span class="num" id="3919469">0</span><span class="op" id="3919470">:</span><span class="ident" id="3919471">n</span><span class="op" id="3919472">]</span>&nbsp;<span class="op" id="3919474">==</span>&nbsp;<span class="ident" id="3919477">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="3919485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3919488">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="3919555">func</span>&nbsp;<span class="ident" id="3919560">cleanPath</span><span class="op" id="3919569">(</span><span class="ident" id="3919570">p</span>&nbsp;<span class="builtintype" id="3919572">string</span><span class="op" id="3919578">)</span>&nbsp;<span class="builtintype" id="3919580">string</span>&nbsp;<span class="op" id="3919587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919590">if</span>&nbsp;<span class="ident" id="3919593">p</span>&nbsp;<span class="op" id="3919595">==</span>&nbsp;<span class="string" id="3919598">&#34;&#34;</span>&nbsp;<span class="op" id="3919601">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919605">return</span>&nbsp;<span class="string" id="3919612">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919620">if</span>&nbsp;<span class="ident" id="3919623">p</span><span class="op" id="3919624">[</span><span class="num" id="3919625">0</span><span class="op" id="3919626">]</span>&nbsp;<span class="op" id="3919628">!=</span>&nbsp;<span class="string" id="3919631">&#39;/&#39;</span>&nbsp;<span class="op" id="3919635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919639">p</span>&nbsp;<span class="op" id="3919641">=</span>&nbsp;<span class="string" id="3919643">&#34;/&#34;</span>&nbsp;<span class="op" id="3919647">+</span>&nbsp;<span class="ident" id="3919649">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919652">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919655">np</span>&nbsp;<span class="op" id="3919658">:=</span>&nbsp;<span class="ident" id="3919661">path</span><span class="op" id="3919665">.</span><span class="ident" id="3919666">Clean</span><span class="op" id="3919671">(</span><span class="ident" id="3919672">p</span><span class="op" id="3919673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3919676">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3919731">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919777">if</span>&nbsp;<span class="ident" id="3919780">p</span><span class="op" id="3919781">[</span><span class="builtinfunc" id="3919782">len</span><span class="op" id="3919785">(</span><span class="ident" id="3919786">p</span><span class="op" id="3919787">)</span><span class="op" id="3919788">-</span><span class="num" id="3919789">1</span><span class="op" id="3919790">]</span>&nbsp;<span class="op" id="3919792">==</span>&nbsp;<span class="string" id="3919795">&#39;/&#39;</span>&nbsp;<span class="op" id="3919799">&amp;&amp;</span>&nbsp;<span class="ident" id="3919802">np</span>&nbsp;<span class="op" id="3919805">!=</span>&nbsp;<span class="string" id="3919808">&#34;/&#34;</span>&nbsp;<span class="op" id="3919812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919816">np</span>&nbsp;<span class="op" id="3919819">+=</span>&nbsp;<span class="string" id="3919822">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919830">return</span>&nbsp;<span class="ident" id="3919837">np</span><br>
<span class="lineno"></span><span class="op" id="3919840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3919843">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="3919898">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="3919938">func</span>&nbsp;<span class="op" id="3919943">(</span><span class="ident" id="3919944">mux</span>&nbsp;<span class="op" id="3919948">*</span><span class="ident" id="3919949">ServeMux</span><span class="op" id="3919957">)</span>&nbsp;<span class="ident" id="3919959">match</span><span class="op" id="3919964">(</span><span class="ident" id="3919965">path</span>&nbsp;<span class="builtintype" id="3919970">string</span><span class="op" id="3919976">)</span>&nbsp;<span class="op" id="3919978">(</span><span class="ident" id="3919979">h</span>&nbsp;<span class="ident" id="3919981">Handler</span><span class="op" id="3919988">,</span>&nbsp;<span class="ident" id="3919990">pattern</span>&nbsp;<span class="builtintype" id="3919998">string</span><span class="op" id="3920004">)</span>&nbsp;<span class="op" id="3920006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920009">var</span>&nbsp;<span class="ident" id="3920013">n</span>&nbsp;<span class="op" id="3920015">=</span>&nbsp;<span class="num" id="3920017">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920020">for</span>&nbsp;<span class="ident" id="3920024">k</span><span class="op" id="3920025">,</span>&nbsp;<span class="ident" id="3920027">v</span>&nbsp;<span class="op" id="3920029">:=</span>&nbsp;<span class="keyword" id="3920032">range</span>&nbsp;<span class="ident" id="3920038">mux</span><span class="op" id="3920041">.</span><span class="ident" id="3920042">m</span>&nbsp;<span class="op" id="3920044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920048">if</span>&nbsp;<span class="op" id="3920051">!</span><span class="ident" id="3920052">pathMatch</span><span class="op" id="3920061">(</span><span class="ident" id="3920062">k</span><span class="op" id="3920063">,</span>&nbsp;<span class="ident" id="3920065">path</span><span class="op" id="3920069">)</span>&nbsp;<span class="op" id="3920071">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920076">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920091">if</span>&nbsp;<span class="ident" id="3920094">h</span>&nbsp;<span class="op" id="3920096">==</span>&nbsp;<span class="ident" id="3920099">nil</span>&nbsp;<span class="op" id="3920103">||</span>&nbsp;<span class="builtinfunc" id="3920106">len</span><span class="op" id="3920109">(</span><span class="ident" id="3920110">k</span><span class="op" id="3920111">)</span>&nbsp;<span class="op" id="3920113">&gt;</span>&nbsp;<span class="ident" id="3920115">n</span>&nbsp;<span class="op" id="3920117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920122">n</span>&nbsp;<span class="op" id="3920124">=</span>&nbsp;<span class="builtinfunc" id="3920126">len</span><span class="op" id="3920129">(</span><span class="ident" id="3920130">k</span><span class="op" id="3920131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920136">h</span>&nbsp;<span class="op" id="3920138">=</span>&nbsp;<span class="ident" id="3920140">v</span><span class="op" id="3920141">.</span><span class="ident" id="3920142">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920147">pattern</span>&nbsp;<span class="op" id="3920155">=</span>&nbsp;<span class="ident" id="3920157">v</span><span class="op" id="3920158">.</span><span class="ident" id="3920159">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920175">return</span><br>
<span class="lineno"></span><span class="op" id="3920182">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="3920185">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3920246">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3920312">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3920380">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="3920446">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="3920472">//</span><br>
<span class="lineno"></span><span class="comment" id="3920475">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3920539">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="3920601">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="3920662">//</span><br>
<span class="lineno"></span><span class="comment" id="3920665">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3920731">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3920801">func</span>&nbsp;<span class="op" id="3920806">(</span><span class="ident" id="3920807">mux</span>&nbsp;<span class="op" id="3920811">*</span><span class="ident" id="3920812">ServeMux</span><span class="op" id="3920820">)</span>&nbsp;<span class="ident" id="3920822">Handler</span><span class="op" id="3920829">(</span><span class="ident" id="3920830">r</span>&nbsp;<span class="op" id="3920832">*</span><span class="ident" id="3920833">Request</span><span class="op" id="3920840">)</span>&nbsp;<span class="op" id="3920842">(</span><span class="ident" id="3920843">h</span>&nbsp;<span class="ident" id="3920845">Handler</span><span class="op" id="3920852">,</span>&nbsp;<span class="ident" id="3920854">pattern</span>&nbsp;<span class="builtintype" id="3920862">string</span><span class="op" id="3920868">)</span>&nbsp;<span class="op" id="3920870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920873">if</span>&nbsp;<span class="ident" id="3920876">r</span><span class="op" id="3920877">.</span><span class="ident" id="3920878">Method</span>&nbsp;<span class="op" id="3920885">!=</span>&nbsp;<span class="string" id="3920888">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="3920898">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920902">if</span>&nbsp;<span class="ident" id="3920905">p</span>&nbsp;<span class="op" id="3920907">:=</span>&nbsp;<span class="ident" id="3920910">cleanPath</span><span class="op" id="3920919">(</span><span class="ident" id="3920920">r</span><span class="op" id="3920921">.</span><span class="ident" id="3920922">URL</span><span class="op" id="3920925">.</span><span class="ident" id="3920926">Path</span><span class="op" id="3920930">)</span><span class="op" id="3920931">;</span>&nbsp;<span class="ident" id="3920933">p</span>&nbsp;<span class="op" id="3920935">!=</span>&nbsp;<span class="ident" id="3920938">r</span><span class="op" id="3920939">.</span><span class="ident" id="3920940">URL</span><span class="op" id="3920943">.</span><span class="ident" id="3920944">Path</span>&nbsp;<span class="op" id="3920949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920954">_</span><span class="op" id="3920955">,</span>&nbsp;<span class="ident" id="3920957">pattern</span>&nbsp;<span class="op" id="3920965">=</span>&nbsp;<span class="ident" id="3920967">mux</span><span class="op" id="3920970">.</span><span class="ident" id="3920971">handler</span><span class="op" id="3920978">(</span><span class="ident" id="3920979">r</span><span class="op" id="3920980">.</span><span class="ident" id="3920981">Host</span><span class="op" id="3920985">,</span>&nbsp;<span class="ident" id="3920987">p</span><span class="op" id="3920988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920993">url</span>&nbsp;<span class="op" id="3920997">:=</span>&nbsp;<span class="op" id="3921000">*</span><span class="ident" id="3921001">r</span><span class="op" id="3921002">.</span><span class="ident" id="3921003">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921010">url</span><span class="op" id="3921013">.</span><span class="ident" id="3921014">Path</span>&nbsp;<span class="op" id="3921019">=</span>&nbsp;<span class="ident" id="3921021">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921026">return</span>&nbsp;<span class="ident" id="3921033">RedirectHandler</span><span class="op" id="3921048">(</span><span class="ident" id="3921049">url</span><span class="op" id="3921052">.</span><span class="ident" id="3921053">String</span><span class="op" id="3921059">(</span><span class="op" id="3921060">)</span><span class="op" id="3921061">,</span>&nbsp;<span class="ident" id="3921063">StatusMovedPermanently</span><span class="op" id="3921085">)</span><span class="op" id="3921086">,</span>&nbsp;<span class="ident" id="3921088">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921105">return</span>&nbsp;<span class="ident" id="3921112">mux</span><span class="op" id="3921115">.</span><span class="ident" id="3921116">handler</span><span class="op" id="3921123">(</span><span class="ident" id="3921124">r</span><span class="op" id="3921125">.</span><span class="ident" id="3921126">Host</span><span class="op" id="3921130">,</span>&nbsp;<span class="ident" id="3921132">r</span><span class="op" id="3921133">.</span><span class="ident" id="3921134">URL</span><span class="op" id="3921137">.</span><span class="ident" id="3921138">Path</span><span class="op" id="3921142">)</span><br>
<span class="lineno"></span><span class="op" id="3921144">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="3921147">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="3921197">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="3921271">func</span>&nbsp;<span class="op" id="3921276">(</span><span class="ident" id="3921277">mux</span>&nbsp;<span class="op" id="3921281">*</span><span class="ident" id="3921282">ServeMux</span><span class="op" id="3921290">)</span>&nbsp;<span class="ident" id="3921292">handler</span><span class="op" id="3921299">(</span><span class="ident" id="3921300">host</span><span class="op" id="3921304">,</span>&nbsp;<span class="ident" id="3921306">path</span>&nbsp;<span class="builtintype" id="3921311">string</span><span class="op" id="3921317">)</span>&nbsp;<span class="op" id="3921319">(</span><span class="ident" id="3921320">h</span>&nbsp;<span class="ident" id="3921322">Handler</span><span class="op" id="3921329">,</span>&nbsp;<span class="ident" id="3921331">pattern</span>&nbsp;<span class="builtintype" id="3921339">string</span><span class="op" id="3921345">)</span>&nbsp;<span class="op" id="3921347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921350">mux</span><span class="op" id="3921353">.</span><span class="ident" id="3921354">mu</span><span class="op" id="3921356">.</span><span class="ident" id="3921357">RLock</span><span class="op" id="3921362">(</span><span class="op" id="3921363">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921366">defer</span>&nbsp;<span class="ident" id="3921372">mux</span><span class="op" id="3921375">.</span><span class="ident" id="3921376">mu</span><span class="op" id="3921378">.</span><span class="ident" id="3921379">RUnlock</span><span class="op" id="3921386">(</span><span class="op" id="3921387">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3921391">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921452">if</span>&nbsp;<span class="ident" id="3921455">mux</span><span class="op" id="3921458">.</span><span class="ident" id="3921459">hosts</span>&nbsp;<span class="op" id="3921465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921469">h</span><span class="op" id="3921470">,</span>&nbsp;<span class="ident" id="3921472">pattern</span>&nbsp;<span class="op" id="3921480">=</span>&nbsp;<span class="ident" id="3921482">mux</span><span class="op" id="3921485">.</span><span class="ident" id="3921486">match</span><span class="op" id="3921491">(</span><span class="ident" id="3921492">host</span>&nbsp;<span class="op" id="3921497">+</span>&nbsp;<span class="ident" id="3921499">path</span><span class="op" id="3921503">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921509">if</span>&nbsp;<span class="ident" id="3921512">h</span>&nbsp;<span class="op" id="3921514">==</span>&nbsp;<span class="ident" id="3921517">nil</span>&nbsp;<span class="op" id="3921521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921525">h</span><span class="op" id="3921526">,</span>&nbsp;<span class="ident" id="3921528">pattern</span>&nbsp;<span class="op" id="3921536">=</span>&nbsp;<span class="ident" id="3921538">mux</span><span class="op" id="3921541">.</span><span class="ident" id="3921542">match</span><span class="op" id="3921547">(</span><span class="ident" id="3921548">path</span><span class="op" id="3921552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921558">if</span>&nbsp;<span class="ident" id="3921561">h</span>&nbsp;<span class="op" id="3921563">==</span>&nbsp;<span class="ident" id="3921566">nil</span>&nbsp;<span class="op" id="3921570">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921574">h</span><span class="op" id="3921575">,</span>&nbsp;<span class="ident" id="3921577">pattern</span>&nbsp;<span class="op" id="3921585">=</span>&nbsp;<span class="ident" id="3921587">NotFoundHandler</span><span class="op" id="3921602">(</span><span class="op" id="3921603">)</span><span class="op" id="3921604">,</span>&nbsp;<span class="string" id="3921606">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921613">return</span><br>
<span class="lineno"></span><span class="op" id="3921620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="3921623">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="3921680">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3921729">func</span>&nbsp;<span class="op" id="3921734">(</span><span class="ident" id="3921735">mux</span>&nbsp;<span class="op" id="3921739">*</span><span class="ident" id="3921740">ServeMux</span><span class="op" id="3921748">)</span>&nbsp;<span class="ident" id="3921750">ServeHTTP</span><span class="op" id="3921759">(</span><span class="ident" id="3921760">w</span>&nbsp;<span class="ident" id="3921762">ResponseWriter</span><span class="op" id="3921776">,</span>&nbsp;<span class="ident" id="3921778">r</span>&nbsp;<span class="op" id="3921780">*</span><span class="ident" id="3921781">Request</span><span class="op" id="3921788">)</span>&nbsp;<span class="op" id="3921790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921793">if</span>&nbsp;<span class="ident" id="3921796">r</span><span class="op" id="3921797">.</span><span class="ident" id="3921798">RequestURI</span>&nbsp;<span class="op" id="3921809">==</span>&nbsp;<span class="string" id="3921812">&#34;*&#34;</span>&nbsp;<span class="op" id="3921816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921820">if</span>&nbsp;<span class="ident" id="3921823">r</span><span class="op" id="3921824">.</span><span class="ident" id="3921825">ProtoAtLeast</span><span class="op" id="3921837">(</span><span class="num" id="3921838">1</span><span class="op" id="3921839">,</span>&nbsp;<span class="num" id="3921841">1</span><span class="op" id="3921842">)</span>&nbsp;<span class="op" id="3921844">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921849">w</span><span class="op" id="3921850">.</span><span class="ident" id="3921851">Header</span><span class="op" id="3921857">(</span><span class="op" id="3921858">)</span><span class="op" id="3921859">.</span><span class="ident" id="3921860">Set</span><span class="op" id="3921863">(</span><span class="string" id="3921864">&#34;Connection&#34;</span><span class="op" id="3921876">,</span>&nbsp;<span class="string" id="3921878">&#34;close&#34;</span><span class="op" id="3921885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921893">w</span><span class="op" id="3921894">.</span><span class="ident" id="3921895">WriteHeader</span><span class="op" id="3921906">(</span><span class="ident" id="3921907">StatusBadRequest</span><span class="op" id="3921923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921927">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921935">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921938">h</span><span class="op" id="3921939">,</span>&nbsp;<span class="ident" id="3921941">_</span>&nbsp;<span class="op" id="3921943">:=</span>&nbsp;<span class="ident" id="3921946">mux</span><span class="op" id="3921949">.</span><span class="ident" id="3921950">Handler</span><span class="op" id="3921957">(</span><span class="ident" id="3921958">r</span><span class="op" id="3921959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921962">h</span><span class="op" id="3921963">.</span><span class="ident" id="3921964">ServeHTTP</span><span class="op" id="3921973">(</span><span class="ident" id="3921974">w</span><span class="op" id="3921975">,</span>&nbsp;<span class="ident" id="3921977">r</span><span class="op" id="3921978">)</span><br>
<span class="lineno"></span><span class="op" id="3921980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3921983">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="3922038">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="3922097">func</span>&nbsp;<span class="op" id="3922102">(</span><span class="ident" id="3922103">mux</span>&nbsp;<span class="op" id="3922107">*</span><span class="ident" id="3922108">ServeMux</span><span class="op" id="3922116">)</span>&nbsp;<span class="ident" id="3922118">Handle</span><span class="op" id="3922124">(</span><span class="ident" id="3922125">pattern</span>&nbsp;<span class="builtintype" id="3922133">string</span><span class="op" id="3922139">,</span>&nbsp;<span class="ident" id="3922141">handler</span>&nbsp;<span class="ident" id="3922149">Handler</span><span class="op" id="3922156">)</span>&nbsp;<span class="op" id="3922158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922161">mux</span><span class="op" id="3922164">.</span><span class="ident" id="3922165">mu</span><span class="op" id="3922167">.</span><span class="ident" id="3922168">Lock</span><span class="op" id="3922172">(</span><span class="op" id="3922173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922176">defer</span>&nbsp;<span class="ident" id="3922182">mux</span><span class="op" id="3922185">.</span><span class="ident" id="3922186">mu</span><span class="op" id="3922188">.</span><span class="ident" id="3922189">Unlock</span><span class="op" id="3922195">(</span><span class="op" id="3922196">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922200">if</span>&nbsp;<span class="ident" id="3922203">pattern</span>&nbsp;<span class="op" id="3922211">==</span>&nbsp;<span class="string" id="3922214">&#34;&#34;</span>&nbsp;<span class="op" id="3922217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3922221">panic</span><span class="op" id="3922226">(</span><span class="string" id="3922227">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="3922252">+</span>&nbsp;<span class="ident" id="3922254">pattern</span><span class="op" id="3922261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922267">if</span>&nbsp;<span class="ident" id="3922270">handler</span>&nbsp;<span class="op" id="3922278">==</span>&nbsp;<span class="ident" id="3922281">nil</span>&nbsp;<span class="op" id="3922285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3922289">panic</span><span class="op" id="3922294">(</span><span class="string" id="3922295">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="3922314">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922320">if</span>&nbsp;<span class="ident" id="3922323">mux</span><span class="op" id="3922326">.</span><span class="ident" id="3922327">m</span><span class="op" id="3922328">[</span><span class="ident" id="3922329">pattern</span><span class="op" id="3922336">]</span><span class="op" id="3922337">.</span><span class="ident" id="3922338">explicit</span>&nbsp;<span class="op" id="3922347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3922351">panic</span><span class="op" id="3922356">(</span><span class="string" id="3922357">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3922393">+</span>&nbsp;<span class="ident" id="3922395">pattern</span><span class="op" id="3922402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922409">mux</span><span class="op" id="3922412">.</span><span class="ident" id="3922413">m</span><span class="op" id="3922414">[</span><span class="ident" id="3922415">pattern</span><span class="op" id="3922422">]</span>&nbsp;<span class="op" id="3922424">=</span>&nbsp;<span class="ident" id="3922426">muxEntry</span><span class="op" id="3922434">{</span><span class="ident" id="3922435">explicit</span><span class="op" id="3922443">:</span>&nbsp;<span class="builtintype" id="3922445">true</span><span class="op" id="3922449">,</span>&nbsp;<span class="ident" id="3922451">h</span><span class="op" id="3922452">:</span>&nbsp;<span class="ident" id="3922454">handler</span><span class="op" id="3922461">,</span>&nbsp;<span class="ident" id="3922463">pattern</span><span class="op" id="3922470">:</span>&nbsp;<span class="ident" id="3922472">pattern</span><span class="op" id="3922479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922483">if</span>&nbsp;<span class="ident" id="3922486">pattern</span><span class="op" id="3922493">[</span><span class="num" id="3922494">0</span><span class="op" id="3922495">]</span>&nbsp;<span class="op" id="3922497">!=</span>&nbsp;<span class="string" id="3922500">&#39;/&#39;</span>&nbsp;<span class="op" id="3922504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922508">mux</span><span class="op" id="3922511">.</span><span class="ident" id="3922512">hosts</span>&nbsp;<span class="op" id="3922518">=</span>&nbsp;<span class="builtintype" id="3922520">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922526">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922530">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922552">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922627">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922681">n</span>&nbsp;<span class="op" id="3922683">:=</span>&nbsp;<span class="builtinfunc" id="3922686">len</span><span class="op" id="3922689">(</span><span class="ident" id="3922690">pattern</span><span class="op" id="3922697">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922700">if</span>&nbsp;<span class="ident" id="3922703">n</span>&nbsp;<span class="op" id="3922705">&gt;</span>&nbsp;<span class="num" id="3922707">0</span>&nbsp;<span class="op" id="3922709">&amp;&amp;</span>&nbsp;<span class="ident" id="3922712">pattern</span><span class="op" id="3922719">[</span><span class="ident" id="3922720">n</span><span class="op" id="3922721">-</span><span class="num" id="3922722">1</span><span class="op" id="3922723">]</span>&nbsp;<span class="op" id="3922725">==</span>&nbsp;<span class="string" id="3922728">&#39;/&#39;</span>&nbsp;<span class="op" id="3922732">&amp;&amp;</span>&nbsp;<span class="op" id="3922735">!</span><span class="ident" id="3922736">mux</span><span class="op" id="3922739">.</span><span class="ident" id="3922740">m</span><span class="op" id="3922741">[</span><span class="ident" id="3922742">pattern</span><span class="op" id="3922749">[</span><span class="num" id="3922750">0</span><span class="op" id="3922751">:</span><span class="ident" id="3922752">n</span><span class="op" id="3922753">-</span><span class="num" id="3922754">1</span><span class="op" id="3922755">]</span><span class="op" id="3922756">]</span><span class="op" id="3922757">.</span><span class="ident" id="3922758">explicit</span>&nbsp;<span class="op" id="3922767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922771">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922836">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922860">path</span>&nbsp;<span class="op" id="3922865">:=</span>&nbsp;<span class="ident" id="3922868">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922878">if</span>&nbsp;<span class="ident" id="3922881">pattern</span><span class="op" id="3922888">[</span><span class="num" id="3922889">0</span><span class="op" id="3922890">]</span>&nbsp;<span class="op" id="3922892">!=</span>&nbsp;<span class="string" id="3922895">&#39;/&#39;</span>&nbsp;<span class="op" id="3922899">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922904">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922963">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922996">path</span>&nbsp;<span class="op" id="3923001">=</span>&nbsp;<span class="ident" id="3923003">pattern</span><span class="op" id="3923010">[</span><span class="ident" id="3923011">strings</span><span class="op" id="3923018">.</span><span class="ident" id="3923019">Index</span><span class="op" id="3923024">(</span><span class="ident" id="3923025">pattern</span><span class="op" id="3923032">,</span>&nbsp;<span class="string" id="3923034">&#34;/&#34;</span><span class="op" id="3923037">)</span><span class="op" id="3923038">:</span><span class="op" id="3923039">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923047">mux</span><span class="op" id="3923050">.</span><span class="ident" id="3923051">m</span><span class="op" id="3923052">[</span><span class="ident" id="3923053">pattern</span><span class="op" id="3923060">[</span><span class="num" id="3923061">0</span><span class="op" id="3923062">:</span><span class="ident" id="3923063">n</span><span class="op" id="3923064">-</span><span class="num" id="3923065">1</span><span class="op" id="3923066">]</span><span class="op" id="3923067">]</span>&nbsp;<span class="op" id="3923069">=</span>&nbsp;<span class="ident" id="3923071">muxEntry</span><span class="op" id="3923079">{</span><span class="ident" id="3923080">h</span><span class="op" id="3923081">:</span>&nbsp;<span class="ident" id="3923083">RedirectHandler</span><span class="op" id="3923098">(</span><span class="ident" id="3923099">path</span><span class="op" id="3923103">,</span>&nbsp;<span class="ident" id="3923105">StatusMovedPermanently</span><span class="op" id="3923127">)</span><span class="op" id="3923128">,</span>&nbsp;<span class="ident" id="3923130">pattern</span><span class="op" id="3923137">:</span>&nbsp;<span class="ident" id="3923139">pattern</span><span class="op" id="3923146">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923149">}</span><br>
<span class="lineno"></span><span class="op" id="3923151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3923154">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3923222">func</span>&nbsp;<span class="op" id="3923227">(</span><span class="ident" id="3923228">mux</span>&nbsp;<span class="op" id="3923232">*</span><span class="ident" id="3923233">ServeMux</span><span class="op" id="3923241">)</span>&nbsp;<span class="ident" id="3923243">HandleFunc</span><span class="op" id="3923253">(</span><span class="ident" id="3923254">pattern</span>&nbsp;<span class="builtintype" id="3923262">string</span><span class="op" id="3923268">,</span>&nbsp;<span class="ident" id="3923270">handler</span>&nbsp;<span class="keyword" id="3923278">func</span><span class="op" id="3923282">(</span><span class="ident" id="3923283">ResponseWriter</span><span class="op" id="3923297">,</span>&nbsp;<span class="op" id="3923299">*</span><span class="ident" id="3923300">Request</span><span class="op" id="3923307">)</span><span class="op" id="3923308">)</span>&nbsp;<span class="op" id="3923310">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923313">mux</span><span class="op" id="3923316">.</span><span class="ident" id="3923317">Handle</span><span class="op" id="3923323">(</span><span class="ident" id="3923324">pattern</span><span class="op" id="3923331">,</span>&nbsp;<span class="ident" id="3923333">HandlerFunc</span><span class="op" id="3923344">(</span><span class="ident" id="3923345">handler</span><span class="op" id="3923352">)</span><span class="op" id="3923353">)</span><br>
<span class="lineno"></span><span class="op" id="3923355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3923358">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3923412">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="3923439">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3923508">func</span>&nbsp;<span class="ident" id="3923513">Handle</span><span class="op" id="3923519">(</span><span class="ident" id="3923520">pattern</span>&nbsp;<span class="builtintype" id="3923528">string</span><span class="op" id="3923534">,</span>&nbsp;<span class="ident" id="3923536">handler</span>&nbsp;<span class="ident" id="3923544">Handler</span><span class="op" id="3923551">)</span>&nbsp;<span class="op" id="3923553">{</span>&nbsp;<span class="ident" id="3923555">DefaultServeMux</span><span class="op" id="3923570">.</span><span class="ident" id="3923571">Handle</span><span class="op" id="3923577">(</span><span class="ident" id="3923578">pattern</span><span class="op" id="3923585">,</span>&nbsp;<span class="ident" id="3923587">handler</span><span class="op" id="3923594">)</span>&nbsp;<span class="op" id="3923596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3923599">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3923666">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="3923693">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3923762">func</span>&nbsp;<span class="ident" id="3923767">HandleFunc</span><span class="op" id="3923777">(</span><span class="ident" id="3923778">pattern</span>&nbsp;<span class="builtintype" id="3923786">string</span><span class="op" id="3923792">,</span>&nbsp;<span class="ident" id="3923794">handler</span>&nbsp;<span class="keyword" id="3923802">func</span><span class="op" id="3923806">(</span><span class="ident" id="3923807">ResponseWriter</span><span class="op" id="3923821">,</span>&nbsp;<span class="op" id="3923823">*</span><span class="ident" id="3923824">Request</span><span class="op" id="3923831">)</span><span class="op" id="3923832">)</span>&nbsp;<span class="op" id="3923834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923837">DefaultServeMux</span><span class="op" id="3923852">.</span><span class="ident" id="3923853">HandleFunc</span><span class="op" id="3923863">(</span><span class="ident" id="3923864">pattern</span><span class="op" id="3923871">,</span>&nbsp;<span class="ident" id="3923873">handler</span><span class="op" id="3923880">)</span><br>
<span class="lineno"></span><span class="op" id="3923882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="3923885">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="3923947">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="3924017">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="3924074">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3924146">func</span>&nbsp;<span class="ident" id="3924151">Serve</span><span class="op" id="3924156">(</span><span class="ident" id="3924157">l</span>&nbsp;<span class="ident" id="3924159">net</span><span class="op" id="3924162">.</span><span class="ident" id="3924163">Listener</span><span class="op" id="3924171">,</span>&nbsp;<span class="ident" id="3924173">handler</span>&nbsp;<span class="ident" id="3924181">Handler</span><span class="op" id="3924188">)</span>&nbsp;<span class="builtintype" id="3924190">error</span>&nbsp;<span class="op" id="3924196">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924199">srv</span>&nbsp;<span class="op" id="3924203">:=</span>&nbsp;<span class="op" id="3924206">&amp;</span><span class="ident" id="3924207">Server</span><span class="op" id="3924213">{</span><span class="ident" id="3924214">Handler</span><span class="op" id="3924221">:</span>&nbsp;<span class="ident" id="3924223">handler</span><span class="op" id="3924230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924233">return</span>&nbsp;<span class="ident" id="3924240">srv</span><span class="op" id="3924243">.</span><span class="ident" id="3924244">Serve</span><span class="op" id="3924249">(</span><span class="ident" id="3924250">l</span><span class="op" id="3924251">)</span><br>
<span class="lineno"></span><span class="op" id="3924253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3924256">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="3924315">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="3924370">type</span>&nbsp;<span class="ident" id="3924375">Server</span>&nbsp;<span class="keyword" id="3924382">struct</span>&nbsp;<span class="op" id="3924389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924392">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3924407">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3924421">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924468">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924483">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3924497">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924548">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3924563">time</span><span class="op" id="3924567">.</span><span class="ident" id="3924568">Duration</span>&nbsp;<span class="comment" id="3924577">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924636">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3924651">time</span><span class="op" id="3924655">.</span><span class="ident" id="3924656">Duration</span>&nbsp;<span class="comment" id="3924665">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924726">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="3924741">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3924755">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924819">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3924834">*</span><span class="ident" id="3924835">tls</span><span class="op" id="3924838">.</span><span class="ident" id="3924839">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3924848">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3924900">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3924962">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925019">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925083">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925143">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925206">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925264">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925316">TLSNextProto</span>&nbsp;<span class="keyword" id="3925329">map</span><span class="op" id="3925332">[</span><span class="builtintype" id="3925333">string</span><span class="op" id="3925339">]</span><span class="keyword" id="3925340">func</span><span class="op" id="3925344">(</span><span class="op" id="3925345">*</span><span class="ident" id="3925346">Server</span><span class="op" id="3925352">,</span>&nbsp;<span class="op" id="3925354">*</span><span class="ident" id="3925355">tls</span><span class="op" id="3925358">.</span><span class="ident" id="3925359">Conn</span><span class="op" id="3925363">,</span>&nbsp;<span class="ident" id="3925365">Handler</span><span class="op" id="3925372">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925376">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925438">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925497">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925554">ConnState</span>&nbsp;<span class="keyword" id="3925564">func</span><span class="op" id="3925568">(</span><span class="ident" id="3925569">net</span><span class="op" id="3925572">.</span><span class="ident" id="3925573">Conn</span><span class="op" id="3925577">,</span>&nbsp;<span class="ident" id="3925579">ConnState</span><span class="op" id="3925588">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925592">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925655">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925710">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925770">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925791">ErrorLog</span>&nbsp;<span class="op" id="3925800">*</span><span class="ident" id="3925801">log</span><span class="op" id="3925804">.</span><span class="ident" id="3925805">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925814">disableKeepAlives</span>&nbsp;<span class="builtintype" id="3925832">int32</span>&nbsp;<span class="comment" id="3925838">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="3925862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3925865">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="3925937">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="3925989">type</span>&nbsp;<span class="ident" id="3925994">ConnState</span>&nbsp;<span class="builtintype" id="3926004">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="3926009">const</span>&nbsp;<span class="op" id="3926015">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926018">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926079">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926137">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926192">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926209">StateNew</span>&nbsp;<span class="ident" id="3926218">ConnState</span>&nbsp;<span class="op" id="3926228">=</span>&nbsp;<span class="ident" id="3926230">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926237">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926301">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926355">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926418">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926472">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926525">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926586">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926600">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926656">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926719">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926780">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926822">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926834">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926886">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926955">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926971">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3927019">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3927077">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927108">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="3927120">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3927123">var</span>&nbsp;<span class="ident" id="3927127">stateName</span>&nbsp;<span class="op" id="3927137">=</span>&nbsp;<span class="keyword" id="3927139">map</span><span class="op" id="3927142">[</span><span class="ident" id="3927143">ConnState</span><span class="op" id="3927152">]</span><span class="builtintype" id="3927153">string</span><span class="op" id="3927159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927162">StateNew</span><span class="op" id="3927170">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3927177">&#34;new&#34;</span><span class="op" id="3927182">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927185">StateActive</span><span class="op" id="3927196">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3927200">&#34;active&#34;</span><span class="op" id="3927208">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927211">StateIdle</span><span class="op" id="3927220">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3927226">&#34;idle&#34;</span><span class="op" id="3927232">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927235">StateHijacked</span><span class="op" id="3927248">:</span>&nbsp;<span class="string" id="3927250">&#34;hijacked&#34;</span><span class="op" id="3927260">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927263">StateClosed</span><span class="op" id="3927274">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3927278">&#34;closed&#34;</span><span class="op" id="3927286">,</span><br>
<span class="lineno"></span><span class="op" id="3927288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="3927291">func</span>&nbsp;<span class="op" id="3927296">(</span><span class="ident" id="3927297">c</span>&nbsp;<span class="ident" id="3927299">ConnState</span><span class="op" id="3927308">)</span>&nbsp;<span class="ident" id="3927310">String</span><span class="op" id="3927316">(</span><span class="op" id="3927317">)</span>&nbsp;<span class="builtintype" id="3927319">string</span>&nbsp;<span class="op" id="3927326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927329">return</span>&nbsp;<span class="ident" id="3927336">stateName</span><span class="op" id="3927345">[</span><span class="ident" id="3927346">c</span><span class="op" id="3927347">]</span><br>
<span class="lineno"></span><span class="op" id="3927349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3927352">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="3927413">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3927471">type</span>&nbsp;<span class="ident" id="3927476">serverHandler</span>&nbsp;<span class="keyword" id="3927490">struct</span>&nbsp;<span class="op" id="3927497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927500">srv</span>&nbsp;<span class="op" id="3927504">*</span><span class="ident" id="3927505">Server</span><br>
<span class="lineno"></span><span class="op" id="3927512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="3927515">func</span>&nbsp;<span class="op" id="3927520">(</span><span class="ident" id="3927521">sh</span>&nbsp;<span class="ident" id="3927524">serverHandler</span><span class="op" id="3927537">)</span>&nbsp;<span class="ident" id="3927539">ServeHTTP</span><span class="op" id="3927548">(</span><span class="ident" id="3927549">rw</span>&nbsp;<span class="ident" id="3927552">ResponseWriter</span><span class="op" id="3927566">,</span>&nbsp;<span class="ident" id="3927568">req</span>&nbsp;<span class="op" id="3927572">*</span><span class="ident" id="3927573">Request</span><span class="op" id="3927580">)</span>&nbsp;<span class="op" id="3927582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927585">handler</span>&nbsp;<span class="op" id="3927593">:=</span>&nbsp;<span class="ident" id="3927596">sh</span><span class="op" id="3927598">.</span><span class="ident" id="3927599">srv</span><span class="op" id="3927602">.</span><span class="ident" id="3927603">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927612">if</span>&nbsp;<span class="ident" id="3927615">handler</span>&nbsp;<span class="op" id="3927623">==</span>&nbsp;<span class="ident" id="3927626">nil</span>&nbsp;<span class="op" id="3927630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927634">handler</span>&nbsp;<span class="op" id="3927642">=</span>&nbsp;<span class="ident" id="3927644">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3927661">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927664">if</span>&nbsp;<span class="ident" id="3927667">req</span><span class="op" id="3927670">.</span><span class="ident" id="3927671">RequestURI</span>&nbsp;<span class="op" id="3927682">==</span>&nbsp;<span class="string" id="3927685">&#34;*&#34;</span>&nbsp;<span class="op" id="3927689">&amp;&amp;</span>&nbsp;<span class="ident" id="3927692">req</span><span class="op" id="3927695">.</span><span class="ident" id="3927696">Method</span>&nbsp;<span class="op" id="3927703">==</span>&nbsp;<span class="string" id="3927706">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="3927716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927720">handler</span>&nbsp;<span class="op" id="3927728">=</span>&nbsp;<span class="ident" id="3927730">globalOptionsHandler</span><span class="op" id="3927750">{</span><span class="op" id="3927751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3927754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927757">handler</span><span class="op" id="3927764">.</span><span class="ident" id="3927765">ServeHTTP</span><span class="op" id="3927774">(</span><span class="ident" id="3927775">rw</span><span class="op" id="3927777">,</span>&nbsp;<span class="ident" id="3927779">req</span><span class="op" id="3927782">)</span><br>
<span class="lineno"></span><span class="op" id="3927784">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="3927787">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3927858">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="3927921">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3927960">func</span>&nbsp;<span class="op" id="3927965">(</span><span class="ident" id="3927966">srv</span>&nbsp;<span class="op" id="3927970">*</span><span class="ident" id="3927971">Server</span><span class="op" id="3927977">)</span>&nbsp;<span class="ident" id="3927979">ListenAndServe</span><span class="op" id="3927993">(</span><span class="op" id="3927994">)</span>&nbsp;<span class="builtintype" id="3927996">error</span>&nbsp;<span class="op" id="3928002">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928005">addr</span>&nbsp;<span class="op" id="3928010">:=</span>&nbsp;<span class="ident" id="3928013">srv</span><span class="op" id="3928016">.</span><span class="ident" id="3928017">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928023">if</span>&nbsp;<span class="ident" id="3928026">addr</span>&nbsp;<span class="op" id="3928031">==</span>&nbsp;<span class="string" id="3928034">&#34;&#34;</span>&nbsp;<span class="op" id="3928037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928041">addr</span>&nbsp;<span class="op" id="3928046">=</span>&nbsp;<span class="string" id="3928048">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928060">ln</span><span class="op" id="3928062">,</span>&nbsp;<span class="ident" id="3928064">err</span>&nbsp;<span class="op" id="3928068">:=</span>&nbsp;<span class="ident" id="3928071">net</span><span class="op" id="3928074">.</span><span class="ident" id="3928075">Listen</span><span class="op" id="3928081">(</span><span class="string" id="3928082">&#34;tcp&#34;</span><span class="op" id="3928087">,</span>&nbsp;<span class="ident" id="3928089">addr</span><span class="op" id="3928093">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928096">if</span>&nbsp;<span class="ident" id="3928099">err</span>&nbsp;<span class="op" id="3928103">!=</span>&nbsp;<span class="ident" id="3928106">nil</span>&nbsp;<span class="op" id="3928110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928114">return</span>&nbsp;<span class="ident" id="3928121">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928129">return</span>&nbsp;<span class="ident" id="3928136">srv</span><span class="op" id="3928139">.</span><span class="ident" id="3928140">Serve</span><span class="op" id="3928145">(</span><span class="ident" id="3928146">tcpKeepAliveListener</span><span class="op" id="3928166">{</span><span class="ident" id="3928167">ln</span><span class="op" id="3928169">.</span><span class="op" id="3928170">(</span><span class="op" id="3928171">*</span><span class="ident" id="3928172">net</span><span class="op" id="3928175">.</span><span class="ident" id="3928176">TCPListener</span><span class="op" id="3928187">)</span><span class="op" id="3928188">}</span><span class="op" id="3928189">)</span><br>
<span class="lineno"></span><span class="op" id="3928191">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="3928194">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3928262">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3928339">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3928382">func</span>&nbsp;<span class="op" id="3928387">(</span><span class="ident" id="3928388">srv</span>&nbsp;<span class="op" id="3928392">*</span><span class="ident" id="3928393">Server</span><span class="op" id="3928399">)</span>&nbsp;<span class="ident" id="3928401">Serve</span><span class="op" id="3928406">(</span><span class="ident" id="3928407">l</span>&nbsp;<span class="ident" id="3928409">net</span><span class="op" id="3928412">.</span><span class="ident" id="3928413">Listener</span><span class="op" id="3928421">)</span>&nbsp;<span class="builtintype" id="3928423">error</span>&nbsp;<span class="op" id="3928429">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928432">defer</span>&nbsp;<span class="ident" id="3928438">l</span><span class="op" id="3928439">.</span><span class="ident" id="3928440">Close</span><span class="op" id="3928445">(</span><span class="op" id="3928446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928449">var</span>&nbsp;<span class="ident" id="3928453">tempDelay</span>&nbsp;<span class="ident" id="3928463">time</span><span class="op" id="3928467">.</span><span class="ident" id="3928468">Duration</span>&nbsp;<span class="comment" id="3928477">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928517">for</span>&nbsp;<span class="op" id="3928521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928525">rw</span><span class="op" id="3928527">,</span>&nbsp;<span class="ident" id="3928529">e</span>&nbsp;<span class="op" id="3928531">:=</span>&nbsp;<span class="ident" id="3928534">l</span><span class="op" id="3928535">.</span><span class="ident" id="3928536">Accept</span><span class="op" id="3928542">(</span><span class="op" id="3928543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928547">if</span>&nbsp;<span class="ident" id="3928550">e</span>&nbsp;<span class="op" id="3928552">!=</span>&nbsp;<span class="ident" id="3928555">nil</span>&nbsp;<span class="op" id="3928559">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928564">if</span>&nbsp;<span class="ident" id="3928567">ne</span><span class="op" id="3928569">,</span>&nbsp;<span class="ident" id="3928571">ok</span>&nbsp;<span class="op" id="3928574">:=</span>&nbsp;<span class="ident" id="3928577">e</span><span class="op" id="3928578">.</span><span class="op" id="3928579">(</span><span class="ident" id="3928580">net</span><span class="op" id="3928583">.</span><span class="ident" id="3928584">Error</span><span class="op" id="3928589">)</span><span class="op" id="3928590">;</span>&nbsp;<span class="ident" id="3928592">ok</span>&nbsp;<span class="op" id="3928595">&amp;&amp;</span>&nbsp;<span class="ident" id="3928598">ne</span><span class="op" id="3928600">.</span><span class="ident" id="3928601">Temporary</span><span class="op" id="3928610">(</span><span class="op" id="3928611">)</span>&nbsp;<span class="op" id="3928613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928619">if</span>&nbsp;<span class="ident" id="3928622">tempDelay</span>&nbsp;<span class="op" id="3928632">==</span>&nbsp;<span class="num" id="3928635">0</span>&nbsp;<span class="op" id="3928637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928644">tempDelay</span>&nbsp;<span class="op" id="3928654">=</span>&nbsp;<span class="num" id="3928656">5</span>&nbsp;<span class="op" id="3928658">*</span>&nbsp;<span class="ident" id="3928660">time</span><span class="op" id="3928664">.</span><span class="ident" id="3928665">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928681">}</span>&nbsp;<span class="keyword" id="3928683">else</span>&nbsp;<span class="op" id="3928688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928695">tempDelay</span>&nbsp;<span class="op" id="3928705">*=</span>&nbsp;<span class="num" id="3928708">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928720">if</span>&nbsp;<span class="ident" id="3928723">max</span>&nbsp;<span class="op" id="3928727">:=</span>&nbsp;<span class="num" id="3928730">1</span>&nbsp;<span class="op" id="3928732">*</span>&nbsp;<span class="ident" id="3928734">time</span><span class="op" id="3928738">.</span><span class="ident" id="3928739">Second</span><span class="op" id="3928745">;</span>&nbsp;<span class="ident" id="3928747">tempDelay</span>&nbsp;<span class="op" id="3928757">&gt;</span>&nbsp;<span class="ident" id="3928759">max</span>&nbsp;<span class="op" id="3928763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928770">tempDelay</span>&nbsp;<span class="op" id="3928780">=</span>&nbsp;<span class="ident" id="3928782">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928796">srv</span><span class="op" id="3928799">.</span><span class="ident" id="3928800">logf</span><span class="op" id="3928804">(</span><span class="string" id="3928805">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="3928845">,</span>&nbsp;<span class="ident" id="3928847">e</span><span class="op" id="3928848">,</span>&nbsp;<span class="ident" id="3928850">tempDelay</span><span class="op" id="3928859">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928865">time</span><span class="op" id="3928869">.</span><span class="ident" id="3928870">Sleep</span><span class="op" id="3928875">(</span><span class="ident" id="3928876">tempDelay</span><span class="op" id="3928885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928891">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928908">return</span>&nbsp;<span class="ident" id="3928915">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928919">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928923">tempDelay</span>&nbsp;<span class="op" id="3928933">=</span>&nbsp;<span class="num" id="3928935">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928939">c</span><span class="op" id="3928940">,</span>&nbsp;<span class="ident" id="3928942">err</span>&nbsp;<span class="op" id="3928946">:=</span>&nbsp;<span class="ident" id="3928949">srv</span><span class="op" id="3928952">.</span><span class="ident" id="3928953">newConn</span><span class="op" id="3928960">(</span><span class="ident" id="3928961">rw</span><span class="op" id="3928963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928967">if</span>&nbsp;<span class="ident" id="3928970">err</span>&nbsp;<span class="op" id="3928974">!=</span>&nbsp;<span class="ident" id="3928977">nil</span>&nbsp;<span class="op" id="3928981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928986">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928997">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929001">c</span><span class="op" id="3929002">.</span><span class="ident" id="3929003">setState</span><span class="op" id="3929011">(</span><span class="ident" id="3929012">c</span><span class="op" id="3929013">.</span><span class="ident" id="3929014">rwc</span><span class="op" id="3929017">,</span>&nbsp;<span class="ident" id="3929019">StateNew</span><span class="op" id="3929027">)</span>&nbsp;<span class="comment" id="3929029">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929058">go</span>&nbsp;<span class="ident" id="3929061">c</span><span class="op" id="3929062">.</span><span class="ident" id="3929063">serve</span><span class="op" id="3929068">(</span><span class="op" id="3929069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929072">}</span><br>
<span class="lineno"></span><span class="op" id="3929074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="3929077">func</span>&nbsp;<span class="op" id="3929082">(</span><span class="ident" id="3929083">s</span>&nbsp;<span class="op" id="3929085">*</span><span class="ident" id="3929086">Server</span><span class="op" id="3929092">)</span>&nbsp;<span class="ident" id="3929094">doKeepAlives</span><span class="op" id="3929106">(</span><span class="op" id="3929107">)</span>&nbsp;<span class="builtintype" id="3929109">bool</span>&nbsp;<span class="op" id="3929114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929117">return</span>&nbsp;<span class="ident" id="3929124">atomic</span><span class="op" id="3929130">.</span><span class="ident" id="3929131">LoadInt32</span><span class="op" id="3929140">(</span><span class="op" id="3929141">&amp;</span><span class="ident" id="3929142">s</span><span class="op" id="3929143">.</span><span class="ident" id="3929144">disableKeepAlives</span><span class="op" id="3929161">)</span>&nbsp;<span class="op" id="3929163">==</span>&nbsp;<span class="num" id="3929166">0</span><br>
<span class="lineno"></span><span class="op" id="3929168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3929171">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="3929242">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="3929299">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3929365">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3929403">func</span>&nbsp;<span class="op" id="3929408">(</span><span class="ident" id="3929409">s</span>&nbsp;<span class="op" id="3929411">*</span><span class="ident" id="3929412">Server</span><span class="op" id="3929418">)</span>&nbsp;<span class="ident" id="3929420">SetKeepAlivesEnabled</span><span class="op" id="3929440">(</span><span class="ident" id="3929441">v</span>&nbsp;<span class="builtintype" id="3929443">bool</span><span class="op" id="3929447">)</span>&nbsp;<span class="op" id="3929449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929452">if</span>&nbsp;<span class="ident" id="3929455">v</span>&nbsp;<span class="op" id="3929457">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929461">atomic</span><span class="op" id="3929467">.</span><span class="ident" id="3929468">StoreInt32</span><span class="op" id="3929478">(</span><span class="op" id="3929479">&amp;</span><span class="ident" id="3929480">s</span><span class="op" id="3929481">.</span><span class="ident" id="3929482">disableKeepAlives</span><span class="op" id="3929499">,</span>&nbsp;<span class="num" id="3929501">0</span><span class="op" id="3929502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929505">}</span>&nbsp;<span class="keyword" id="3929507">else</span>&nbsp;<span class="op" id="3929512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929516">atomic</span><span class="op" id="3929522">.</span><span class="ident" id="3929523">StoreInt32</span><span class="op" id="3929533">(</span><span class="op" id="3929534">&amp;</span><span class="ident" id="3929535">s</span><span class="op" id="3929536">.</span><span class="ident" id="3929537">disableKeepAlives</span><span class="op" id="3929554">,</span>&nbsp;<span class="num" id="3929556">1</span><span class="op" id="3929557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929560">}</span><br>
<span class="lineno"></span><span class="op" id="3929562">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="3929565">func</span>&nbsp;<span class="op" id="3929570">(</span><span class="ident" id="3929571">s</span>&nbsp;<span class="op" id="3929573">*</span><span class="ident" id="3929574">Server</span><span class="op" id="3929580">)</span>&nbsp;<span class="ident" id="3929582">logf</span><span class="op" id="3929586">(</span><span class="ident" id="3929587">format</span>&nbsp;<span class="builtintype" id="3929594">string</span><span class="op" id="3929600">,</span>&nbsp;<span class="ident" id="3929602">args</span>&nbsp;<span class="op" id="3929607">...</span><span class="keyword" id="3929610">interface</span><span class="op" id="3929619">{</span><span class="op" id="3929620">}</span><span class="op" id="3929621">)</span>&nbsp;<span class="op" id="3929623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929626">if</span>&nbsp;<span class="ident" id="3929629">s</span><span class="op" id="3929630">.</span><span class="ident" id="3929631">ErrorLog</span>&nbsp;<span class="op" id="3929640">!=</span>&nbsp;<span class="ident" id="3929643">nil</span>&nbsp;<span class="op" id="3929647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929651">s</span><span class="op" id="3929652">.</span><span class="ident" id="3929653">ErrorLog</span><span class="op" id="3929661">.</span><span class="ident" id="3929662">Printf</span><span class="op" id="3929668">(</span><span class="ident" id="3929669">format</span><span class="op" id="3929675">,</span>&nbsp;<span class="ident" id="3929677">args</span><span class="op" id="3929681">...</span><span class="op" id="3929684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929687">}</span>&nbsp;<span class="keyword" id="3929689">else</span>&nbsp;<span class="op" id="3929694">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929698">log</span><span class="op" id="3929701">.</span><span class="ident" id="3929702">Printf</span><span class="op" id="3929708">(</span><span class="ident" id="3929709">format</span><span class="op" id="3929715">,</span>&nbsp;<span class="ident" id="3929717">args</span><span class="op" id="3929721">...</span><span class="op" id="3929724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929727">}</span><br>
<span class="lineno"></span><span class="op" id="3929729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3929732">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="3929790">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3929846">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="3929901">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3929947">//</span><br>
<span class="lineno"></span><span class="comment" id="3929950">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="3929982">//</span><br>
<span class="lineno"></span><span class="comment" id="3929985">//&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="3930001">//</span><br>
<span class="lineno"></span><span class="comment" id="3930004">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="3930016">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="3930025">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3930040">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3930050">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3930055">//</span><br>
<span class="lineno"></span><span class="comment" id="3930058">//&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="3930092">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3930156">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspio.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3930197">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3930202">//</span><br>
<span class="lineno"></span><span class="comment" id="3930205">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="3930222">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="3930265">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3930311">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3930331">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="3930371">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">1805</span><span class="comment" id="3930377">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="keyword" id="3930382">func</span>&nbsp;<span class="ident" id="3930387">ListenAndServe</span><span class="op" id="3930401">(</span><span class="ident" id="3930402">addr</span>&nbsp;<span class="builtintype" id="3930407">string</span><span class="op" id="3930413">,</span>&nbsp;<span class="ident" id="3930415">handler</span>&nbsp;<span class="ident" id="3930423">Handler</span><span class="op" id="3930430">)</span>&nbsp;<span class="builtintype" id="3930432">error</span>&nbsp;<span class="op" id="3930438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930441">server</span>&nbsp;<span class="op" id="3930448">:=</span>&nbsp;<span class="op" id="3930451">&amp;</span><span class="ident" id="3930452">Server</span><span class="op" id="3930458">{</span><span class="ident" id="3930459">Addr</span><span class="op" id="3930463">:</span>&nbsp;<span class="ident" id="3930465">addr</span><span class="op" id="3930469">,</span>&nbsp;<span class="ident" id="3930471">Handler</span><span class="op" id="3930478">:</span>&nbsp;<span class="ident" id="3930480">handler</span><span class="op" id="3930487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930490">return</span>&nbsp;<span class="ident" id="3930497">server</span><span class="op" id="3930503">.</span><span class="ident" id="3930504">ListenAndServe</span><span class="op" id="3930518">(</span><span class="op" id="3930519">)</span><br>
<span class="lineno"></span><span class="op" id="3930521">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="3930524">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3930596">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3930675">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="3930751">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="3930833">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3930898">//</span><br>
<span class="lineno"></span><span class="comment" id="3930901">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="3930933">//</span><br>
<span class="lineno"></span><span class="comment" id="3930936">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="3930948">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3930958">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3930973">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3930978">//</span><br>
<span class="lineno"></span><span class="comment" id="3930981">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="3931041">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3931090">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="3931142">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3931147">//</span><br>
<span class="lineno"></span><span class="comment" id="3931150">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="3931167">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="3931201">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3931276">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3931348">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3931368">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="3931388">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3931394">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3931399">//</span><br>
<span class="lineno"></span><span class="comment" id="3931402">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="3931482">func</span>&nbsp;<span class="ident" id="3931487">ListenAndServeTLS</span><span class="op" id="3931504">(</span><span class="ident" id="3931505">addr</span>&nbsp;<span class="builtintype" id="3931510">string</span><span class="op" id="3931516">,</span>&nbsp;<span class="ident" id="3931518">certFile</span>&nbsp;<span class="builtintype" id="3931527">string</span><span class="op" id="3931533">,</span>&nbsp;<span class="ident" id="3931535">keyFile</span>&nbsp;<span class="builtintype" id="3931543">string</span><span class="op" id="3931549">,</span>&nbsp;<span class="ident" id="3931551">handler</span>&nbsp;<span class="ident" id="3931559">Handler</span><span class="op" id="3931566">)</span>&nbsp;<span class="builtintype" id="3931568">error</span>&nbsp;<span class="op" id="3931574">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3931577">server</span>&nbsp;<span class="op" id="3931584">:=</span>&nbsp;<span class="op" id="3931587">&amp;</span><span class="ident" id="3931588">Server</span><span class="op" id="3931594">{</span><span class="ident" id="3931595">Addr</span><span class="op" id="3931599">:</span>&nbsp;<span class="ident" id="3931601">addr</span><span class="op" id="3931605">,</span>&nbsp;<span class="ident" id="3931607">Handler</span><span class="op" id="3931614">:</span>&nbsp;<span class="ident" id="3931616">handler</span><span class="op" id="3931623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3931626">return</span>&nbsp;<span class="ident" id="3931633">server</span><span class="op" id="3931639">.</span><span class="ident" id="3931640">ListenAndServeTLS</span><span class="op" id="3931657">(</span><span class="ident" id="3931658">certFile</span><span class="op" id="3931666">,</span>&nbsp;<span class="ident" id="3931668">keyFile</span><span class="op" id="3931675">)</span><br>
<span class="lineno"></span><span class="op" id="3931677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3931680">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="3931749">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="3931817">//</span><br>
<span class="lineno"></span><span class="comment" id="3931820">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3931887">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3931953">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="3932020">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3932085">//</span><br>
<span class="lineno"></span><span class="comment" id="3932088">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3932131">func</span>&nbsp;<span class="op" id="3932136">(</span><span class="ident" id="3932137">srv</span>&nbsp;<span class="op" id="3932141">*</span><span class="ident" id="3932142">Server</span><span class="op" id="3932148">)</span>&nbsp;<span class="ident" id="3932150">ListenAndServeTLS</span><span class="op" id="3932167">(</span><span class="ident" id="3932168">certFile</span><span class="op" id="3932176">,</span>&nbsp;<span class="ident" id="3932178">keyFile</span>&nbsp;<span class="builtintype" id="3932186">string</span><span class="op" id="3932192">)</span>&nbsp;<span class="builtintype" id="3932194">error</span>&nbsp;<span class="op" id="3932200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932203">addr</span>&nbsp;<span class="op" id="3932208">:=</span>&nbsp;<span class="ident" id="3932211">srv</span><span class="op" id="3932214">.</span><span class="ident" id="3932215">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932221">if</span>&nbsp;<span class="ident" id="3932224">addr</span>&nbsp;<span class="op" id="3932229">==</span>&nbsp;<span class="string" id="3932232">&#34;&#34;</span>&nbsp;<span class="op" id="3932235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932239">addr</span>&nbsp;<span class="op" id="3932244">=</span>&nbsp;<span class="string" id="3932246">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932259">config</span>&nbsp;<span class="op" id="3932266">:=</span>&nbsp;<span class="op" id="3932269">&amp;</span><span class="ident" id="3932270">tls</span><span class="op" id="3932273">.</span><span class="ident" id="3932274">Config</span><span class="op" id="3932280">{</span><span class="op" id="3932281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932284">if</span>&nbsp;<span class="ident" id="3932287">srv</span><span class="op" id="3932290">.</span><span class="ident" id="3932291">TLSConfig</span>&nbsp;<span class="op" id="3932301">!=</span>&nbsp;<span class="ident" id="3932304">nil</span>&nbsp;<span class="op" id="3932308">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932312">*</span><span class="ident" id="3932313">config</span>&nbsp;<span class="op" id="3932320">=</span>&nbsp;<span class="op" id="3932322">*</span><span class="ident" id="3932323">srv</span><span class="op" id="3932326">.</span><span class="ident" id="3932327">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932341">if</span>&nbsp;<span class="ident" id="3932344">config</span><span class="op" id="3932350">.</span><span class="ident" id="3932351">NextProtos</span>&nbsp;<span class="op" id="3932362">==</span>&nbsp;<span class="ident" id="3932365">nil</span>&nbsp;<span class="op" id="3932369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932373">config</span><span class="op" id="3932379">.</span><span class="ident" id="3932380">NextProtos</span>&nbsp;<span class="op" id="3932391">=</span>&nbsp;<span class="op" id="3932393">[</span><span class="op" id="3932394">]</span><span class="builtintype" id="3932395">string</span><span class="op" id="3932401">{</span><span class="string" id="3932402">&#34;http/1.1&#34;</span><span class="op" id="3932412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932415">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932419">var</span>&nbsp;<span class="ident" id="3932423">err</span>&nbsp;<span class="builtintype" id="3932427">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932434">config</span><span class="op" id="3932440">.</span><span class="ident" id="3932441">Certificates</span>&nbsp;<span class="op" id="3932454">=</span>&nbsp;<span class="builtinfunc" id="3932456">make</span><span class="op" id="3932460">(</span><span class="op" id="3932461">[</span><span class="op" id="3932462">]</span><span class="ident" id="3932463">tls</span><span class="op" id="3932466">.</span><span class="ident" id="3932467">Certificate</span><span class="op" id="3932478">,</span>&nbsp;<span class="num" id="3932480">1</span><span class="op" id="3932481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932484">config</span><span class="op" id="3932490">.</span><span class="ident" id="3932491">Certificates</span><span class="op" id="3932503">[</span><span class="num" id="3932504">0</span><span class="op" id="3932505">]</span><span class="op" id="3932506">,</span>&nbsp;<span class="ident" id="3932508">err</span>&nbsp;<span class="op" id="3932512">=</span>&nbsp;<span class="ident" id="3932514">tls</span><span class="op" id="3932517">.</span><span class="ident" id="3932518">LoadX509KeyPair</span><span class="op" id="3932533">(</span><span class="ident" id="3932534">certFile</span><span class="op" id="3932542">,</span>&nbsp;<span class="ident" id="3932544">keyFile</span><span class="op" id="3932551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932554">if</span>&nbsp;<span class="ident" id="3932557">err</span>&nbsp;<span class="op" id="3932561">!=</span>&nbsp;<span class="ident" id="3932564">nil</span>&nbsp;<span class="op" id="3932568">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932572">return</span>&nbsp;<span class="ident" id="3932579">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932588">ln</span><span class="op" id="3932590">,</span>&nbsp;<span class="ident" id="3932592">err</span>&nbsp;<span class="op" id="3932596">:=</span>&nbsp;<span class="ident" id="3932599">net</span><span class="op" id="3932602">.</span><span class="ident" id="3932603">Listen</span><span class="op" id="3932609">(</span><span class="string" id="3932610">&#34;tcp&#34;</span><span class="op" id="3932615">,</span>&nbsp;<span class="ident" id="3932617">addr</span><span class="op" id="3932621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932624">if</span>&nbsp;<span class="ident" id="3932627">err</span>&nbsp;<span class="op" id="3932631">!=</span>&nbsp;<span class="ident" id="3932634">nil</span>&nbsp;<span class="op" id="3932638">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932642">return</span>&nbsp;<span class="ident" id="3932649">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3932654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3932658">tlsListener</span>&nbsp;<span class="op" id="3932670">:=</span>&nbsp;<span class="ident" id="3932673">tls</span><span class="op" id="3932676">.</span><span class="ident" id="3932677">NewListener</span><span class="op" id="3932688">(</span><span class="ident" id="3932689">tcpKeepAliveListener</span><span class="op" id="3932709">{</span><span class="ident" id="3932710">ln</span><span class="op" id="3932712">.</span><span class="op" id="3932713">(</span><span class="op" id="3932714">*</span><span class="ident" id="3932715">net</span><span class="op" id="3932718">.</span><span class="ident" id="3932719">TCPListener</span><span class="op" id="3932730">)</span><span class="op" id="3932731">}</span><span class="op" id="3932732">,</span>&nbsp;<span class="ident" id="3932734">config</span><span class="op" id="3932740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3932743">return</span>&nbsp;<span class="ident" id="3932750">srv</span><span class="op" id="3932753">.</span><span class="ident" id="3932754">Serve</span><span class="op" id="3932759">(</span><span class="ident" id="3932760">tlsListener</span><span class="op" id="3932771">)</span><br>
<span class="lineno">1880</span><span class="op" id="3932773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3932776">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="3932851">//</span><br>
<span class="lineno"></span><span class="comment" id="3932854">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="3932924">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3932995">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="3933065">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="3933128">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3933199">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="3933221">func</span>&nbsp;<span class="ident" id="3933226">TimeoutHandler</span><span class="op" id="3933240">(</span><span class="ident" id="3933241">h</span>&nbsp;<span class="ident" id="3933243">Handler</span><span class="op" id="3933250">,</span>&nbsp;<span class="ident" id="3933252">dt</span>&nbsp;<span class="ident" id="3933255">time</span><span class="op" id="3933259">.</span><span class="ident" id="3933260">Duration</span><span class="op" id="3933268">,</span>&nbsp;<span class="ident" id="3933270">msg</span>&nbsp;<span class="builtintype" id="3933274">string</span><span class="op" id="3933280">)</span>&nbsp;<span class="ident" id="3933282">Handler</span>&nbsp;<span class="op" id="3933290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933293">f</span>&nbsp;<span class="op" id="3933295">:=</span>&nbsp;<span class="keyword" id="3933298">func</span><span class="op" id="3933302">(</span><span class="op" id="3933303">)</span>&nbsp;<span class="op" id="3933305">&lt;-</span><span class="keyword" id="3933307">chan</span>&nbsp;<span class="ident" id="3933312">time</span><span class="op" id="3933316">.</span><span class="ident" id="3933317">Time</span>&nbsp;<span class="op" id="3933322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933326">return</span>&nbsp;<span class="ident" id="3933333">time</span><span class="op" id="3933337">.</span><span class="ident" id="3933338">After</span><span class="op" id="3933343">(</span><span class="ident" id="3933344">dt</span><span class="op" id="3933346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933352">return</span>&nbsp;<span class="op" id="3933359">&amp;</span><span class="ident" id="3933360">timeoutHandler</span><span class="op" id="3933374">{</span><span class="ident" id="3933375">h</span><span class="op" id="3933376">,</span>&nbsp;<span class="ident" id="3933378">f</span><span class="op" id="3933379">,</span>&nbsp;<span class="ident" id="3933381">msg</span><span class="op" id="3933384">}</span><br>
<span class="lineno">1895</span><span class="op" id="3933386">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3933389">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3933452">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3933489">var</span>&nbsp;<span class="ident" id="3933493">ErrHandlerTimeout</span>&nbsp;<span class="op" id="3933511">=</span>&nbsp;<span class="ident" id="3933513">errors</span><span class="op" id="3933519">.</span><span class="ident" id="3933520">New</span><span class="op" id="3933523">(</span><span class="string" id="3933524">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="3933547">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="3933550">type</span>&nbsp;<span class="ident" id="3933555">timeoutHandler</span>&nbsp;<span class="keyword" id="3933570">struct</span>&nbsp;<span class="op" id="3933577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933580">handler</span>&nbsp;<span class="ident" id="3933588">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933597">timeout</span>&nbsp;<span class="keyword" id="3933605">func</span><span class="op" id="3933609">(</span><span class="op" id="3933610">)</span>&nbsp;<span class="op" id="3933612">&lt;-</span><span class="keyword" id="3933614">chan</span>&nbsp;<span class="ident" id="3933619">time</span><span class="op" id="3933623">.</span><span class="ident" id="3933624">Time</span>&nbsp;<span class="comment" id="3933629">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933669">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3933677">string</span><br>
<span class="lineno">1905</span><span class="op" id="3933684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3933687">func</span>&nbsp;<span class="op" id="3933692">(</span><span class="ident" id="3933693">h</span>&nbsp;<span class="op" id="3933695">*</span><span class="ident" id="3933696">timeoutHandler</span><span class="op" id="3933710">)</span>&nbsp;<span class="ident" id="3933712">errorBody</span><span class="op" id="3933721">(</span><span class="op" id="3933722">)</span>&nbsp;<span class="builtintype" id="3933724">string</span>&nbsp;<span class="op" id="3933731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933734">if</span>&nbsp;<span class="ident" id="3933737">h</span><span class="op" id="3933738">.</span><span class="ident" id="3933739">body</span>&nbsp;<span class="op" id="3933744">!=</span>&nbsp;<span class="string" id="3933747">&#34;&#34;</span>&nbsp;<span class="op" id="3933750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933754">return</span>&nbsp;<span class="ident" id="3933761">h</span><span class="op" id="3933762">.</span><span class="ident" id="3933763">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3933769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933772">return</span>&nbsp;<span class="string" id="3933779">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3933859">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3933862">func</span>&nbsp;<span class="op" id="3933867">(</span><span class="ident" id="3933868">h</span>&nbsp;<span class="op" id="3933870">*</span><span class="ident" id="3933871">timeoutHandler</span><span class="op" id="3933885">)</span>&nbsp;<span class="ident" id="3933887">ServeHTTP</span><span class="op" id="3933896">(</span><span class="ident" id="3933897">w</span>&nbsp;<span class="ident" id="3933899">ResponseWriter</span><span class="op" id="3933913">,</span>&nbsp;<span class="ident" id="3933915">r</span>&nbsp;<span class="op" id="3933917">*</span><span class="ident" id="3933918">Request</span><span class="op" id="3933925">)</span>&nbsp;<span class="op" id="3933927">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933930">done</span>&nbsp;<span class="op" id="3933935">:=</span>&nbsp;<span class="builtinfunc" id="3933938">make</span><span class="op" id="3933942">(</span><span class="keyword" id="3933943">chan</span>&nbsp;<span class="builtintype" id="3933948">bool</span><span class="op" id="3933952">,</span>&nbsp;<span class="num" id="3933954">1</span><span class="op" id="3933955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3933958">tw</span>&nbsp;<span class="op" id="3933961">:=</span>&nbsp;<span class="op" id="3933964">&amp;</span><span class="ident" id="3933965">timeoutWriter</span><span class="op" id="3933978">{</span><span class="ident" id="3933979">w</span><span class="op" id="3933980">:</span>&nbsp;<span class="ident" id="3933982">w</span><span class="op" id="3933983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3933986">go</span>&nbsp;<span class="keyword" id="3933989">func</span><span class="op" id="3933993">(</span><span class="op" id="3933994">)</span>&nbsp;<span class="op" id="3933996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934000">h</span><span class="op" id="3934001">.</span><span class="ident" id="3934002">handler</span><span class="op" id="3934009">.</span><span class="ident" id="3934010">ServeHTTP</span><span class="op" id="3934019">(</span><span class="ident" id="3934020">tw</span><span class="op" id="3934022">,</span>&nbsp;<span class="ident" id="3934024">r</span><span class="op" id="3934025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934029">done</span>&nbsp;<span class="op" id="3934034">&lt;-</span>&nbsp;<span class="builtintype" id="3934037">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934043">}</span><span class="op" id="3934044">(</span><span class="op" id="3934045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934048">select</span>&nbsp;<span class="op" id="3934055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934058">case</span>&nbsp;<span class="op" id="3934063">&lt;-</span><span class="ident" id="3934065">done</span><span class="op" id="3934069">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934073">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934081">case</span>&nbsp;<span class="op" id="3934086">&lt;-</span><span class="ident" id="3934088">h</span><span class="op" id="3934089">.</span><span class="ident" id="3934090">timeout</span><span class="op" id="3934097">(</span><span class="op" id="3934098">)</span><span class="op" id="3934099">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934103">tw</span><span class="op" id="3934105">.</span><span class="ident" id="3934106">mu</span><span class="op" id="3934108">.</span><span class="ident" id="3934109">Lock</span><span class="op" id="3934113">(</span><span class="op" id="3934114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934118">defer</span>&nbsp;<span class="ident" id="3934124">tw</span><span class="op" id="3934126">.</span><span class="ident" id="3934127">mu</span><span class="op" id="3934129">.</span><span class="ident" id="3934130">Unlock</span><span class="op" id="3934136">(</span><span class="op" id="3934137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934141">if</span>&nbsp;<span class="op" id="3934144">!</span><span class="ident" id="3934145">tw</span><span class="op" id="3934147">.</span><span class="ident" id="3934148">wroteHeader</span>&nbsp;<span class="op" id="3934160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934165">tw</span><span class="op" id="3934167">.</span><span class="ident" id="3934168">w</span><span class="op" id="3934169">.</span><span class="ident" id="3934170">WriteHeader</span><span class="op" id="3934181">(</span><span class="ident" id="3934182">StatusServiceUnavailable</span><span class="op" id="3934206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934211">tw</span><span class="op" id="3934213">.</span><span class="ident" id="3934214">w</span><span class="op" id="3934215">.</span><span class="ident" id="3934216">Write</span><span class="op" id="3934221">(</span><span class="op" id="3934222">[</span><span class="op" id="3934223">]</span><span class="builtintype" id="3934224">byte</span><span class="op" id="3934228">(</span><span class="ident" id="3934229">h</span><span class="op" id="3934230">.</span><span class="ident" id="3934231">errorBody</span><span class="op" id="3934240">(</span><span class="op" id="3934241">)</span><span class="op" id="3934242">)</span><span class="op" id="3934243">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934251">tw</span><span class="op" id="3934253">.</span><span class="ident" id="3934254">timedOut</span>&nbsp;<span class="op" id="3934263">=</span>&nbsp;<span class="builtintype" id="3934265">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934271">}</span><br>
<span class="lineno"></span><span class="op" id="3934273">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="3934276">type</span>&nbsp;<span class="ident" id="3934281">timeoutWriter</span>&nbsp;<span class="keyword" id="3934295">struct</span>&nbsp;<span class="op" id="3934302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934305">w</span>&nbsp;<span class="ident" id="3934307">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934324">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3934336">sync</span><span class="op" id="3934340">.</span><span class="ident" id="3934341">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934348">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3934360">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934366">wroteHeader</span>&nbsp;<span class="builtintype" id="3934378">bool</span><br>
<span class="lineno"></span><span class="op" id="3934383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3934386">func</span>&nbsp;<span class="op" id="3934391">(</span><span class="ident" id="3934392">tw</span>&nbsp;<span class="op" id="3934395">*</span><span class="ident" id="3934396">timeoutWriter</span><span class="op" id="3934409">)</span>&nbsp;<span class="ident" id="3934411">Header</span><span class="op" id="3934417">(</span><span class="op" id="3934418">)</span>&nbsp;<span class="ident" id="3934420">Header</span>&nbsp;<span class="op" id="3934427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934430">return</span>&nbsp;<span class="ident" id="3934437">tw</span><span class="op" id="3934439">.</span><span class="ident" id="3934440">w</span><span class="op" id="3934441">.</span><span class="ident" id="3934442">Header</span><span class="op" id="3934448">(</span><span class="op" id="3934449">)</span><br>
<span class="lineno">1945</span><span class="op" id="3934451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3934454">func</span>&nbsp;<span class="op" id="3934459">(</span><span class="ident" id="3934460">tw</span>&nbsp;<span class="op" id="3934463">*</span><span class="ident" id="3934464">timeoutWriter</span><span class="op" id="3934477">)</span>&nbsp;<span class="ident" id="3934479">Write</span><span class="op" id="3934484">(</span><span class="ident" id="3934485">p</span>&nbsp;<span class="op" id="3934487">[</span><span class="op" id="3934488">]</span><span class="builtintype" id="3934489">byte</span><span class="op" id="3934493">)</span>&nbsp;<span class="op" id="3934495">(</span><span class="builtintype" id="3934496">int</span><span class="op" id="3934499">,</span>&nbsp;<span class="builtintype" id="3934501">error</span><span class="op" id="3934506">)</span>&nbsp;<span class="op" id="3934508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934511">tw</span><span class="op" id="3934513">.</span><span class="ident" id="3934514">mu</span><span class="op" id="3934516">.</span><span class="ident" id="3934517">Lock</span><span class="op" id="3934521">(</span><span class="op" id="3934522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934525">defer</span>&nbsp;<span class="ident" id="3934531">tw</span><span class="op" id="3934533">.</span><span class="ident" id="3934534">mu</span><span class="op" id="3934536">.</span><span class="ident" id="3934537">Unlock</span><span class="op" id="3934543">(</span><span class="op" id="3934544">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934547">tw</span><span class="op" id="3934549">.</span><span class="ident" id="3934550">wroteHeader</span>&nbsp;<span class="op" id="3934562">=</span>&nbsp;<span class="builtintype" id="3934564">true</span>&nbsp;<span class="comment" id="3934569">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934593">if</span>&nbsp;<span class="ident" id="3934596">tw</span><span class="op" id="3934598">.</span><span class="ident" id="3934599">timedOut</span>&nbsp;<span class="op" id="3934608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934612">return</span>&nbsp;<span class="num" id="3934619">0</span><span class="op" id="3934620">,</span>&nbsp;<span class="ident" id="3934622">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934644">return</span>&nbsp;<span class="ident" id="3934651">tw</span><span class="op" id="3934653">.</span><span class="ident" id="3934654">w</span><span class="op" id="3934655">.</span><span class="ident" id="3934656">Write</span><span class="op" id="3934661">(</span><span class="ident" id="3934662">p</span><span class="op" id="3934663">)</span><br>
<span class="lineno">1955</span><span class="op" id="3934665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3934668">func</span>&nbsp;<span class="op" id="3934673">(</span><span class="ident" id="3934674">tw</span>&nbsp;<span class="op" id="3934677">*</span><span class="ident" id="3934678">timeoutWriter</span><span class="op" id="3934691">)</span>&nbsp;<span class="ident" id="3934693">WriteHeader</span><span class="op" id="3934704">(</span><span class="ident" id="3934705">code</span>&nbsp;<span class="builtintype" id="3934710">int</span><span class="op" id="3934713">)</span>&nbsp;<span class="op" id="3934715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934718">tw</span><span class="op" id="3934720">.</span><span class="ident" id="3934721">mu</span><span class="op" id="3934723">.</span><span class="ident" id="3934724">Lock</span><span class="op" id="3934728">(</span><span class="op" id="3934729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934732">defer</span>&nbsp;<span class="ident" id="3934738">tw</span><span class="op" id="3934740">.</span><span class="ident" id="3934741">mu</span><span class="op" id="3934743">.</span><span class="ident" id="3934744">Unlock</span><span class="op" id="3934750">(</span><span class="op" id="3934751">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934754">if</span>&nbsp;<span class="ident" id="3934757">tw</span><span class="op" id="3934759">.</span><span class="ident" id="3934760">timedOut</span>&nbsp;<span class="op" id="3934769">||</span>&nbsp;<span class="ident" id="3934772">tw</span><span class="op" id="3934774">.</span><span class="ident" id="3934775">wroteHeader</span>&nbsp;<span class="op" id="3934787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3934791">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3934799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934802">tw</span><span class="op" id="3934804">.</span><span class="ident" id="3934805">wroteHeader</span>&nbsp;<span class="op" id="3934817">=</span>&nbsp;<span class="builtintype" id="3934819">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3934825">tw</span><span class="op" id="3934827">.</span><span class="ident" id="3934828">w</span><span class="op" id="3934829">.</span><span class="ident" id="3934830">WriteHeader</span><span class="op" id="3934841">(</span><span class="ident" id="3934842">code</span><span class="op" id="3934846">)</span><br>
<span class="lineno">1965</span><span class="op" id="3934848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3934851">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="3934916">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3934985">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="3935055">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="3935067">type</span>&nbsp;<span class="ident" id="3935072">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="3935093">struct</span>&nbsp;<span class="op" id="3935100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935103">*</span><span class="ident" id="3935104">net</span><span class="op" id="3935107">.</span><span class="ident" id="3935108">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="3935120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="3935123">func</span>&nbsp;<span class="op" id="3935128">(</span><span class="ident" id="3935129">ln</span>&nbsp;<span class="ident" id="3935132">tcpKeepAliveListener</span><span class="op" id="3935152">)</span>&nbsp;<span class="ident" id="3935154">Accept</span><span class="op" id="3935160">(</span><span class="op" id="3935161">)</span>&nbsp;<span class="op" id="3935163">(</span><span class="ident" id="3935164">c</span>&nbsp;<span class="ident" id="3935166">net</span><span class="op" id="3935169">.</span><span class="ident" id="3935170">Conn</span><span class="op" id="3935174">,</span>&nbsp;<span class="ident" id="3935176">err</span>&nbsp;<span class="builtintype" id="3935180">error</span><span class="op" id="3935185">)</span>&nbsp;<span class="op" id="3935187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935190">tc</span><span class="op" id="3935192">,</span>&nbsp;<span class="ident" id="3935194">err</span>&nbsp;<span class="op" id="3935198">:=</span>&nbsp;<span class="ident" id="3935201">ln</span><span class="op" id="3935203">.</span><span class="ident" id="3935204">AcceptTCP</span><span class="op" id="3935213">(</span><span class="op" id="3935214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935217">if</span>&nbsp;<span class="ident" id="3935220">err</span>&nbsp;<span class="op" id="3935224">!=</span>&nbsp;<span class="ident" id="3935227">nil</span>&nbsp;<span class="op" id="3935231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935235">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935243">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935246">tc</span><span class="op" id="3935248">.</span><span class="ident" id="3935249">SetKeepAlive</span><span class="op" id="3935261">(</span><span class="builtintype" id="3935262">true</span><span class="op" id="3935266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935269">tc</span><span class="op" id="3935271">.</span><span class="ident" id="3935272">SetKeepAlivePeriod</span><span class="op" id="3935290">(</span><span class="num" id="3935291">3</span>&nbsp;<span class="op" id="3935293">*</span>&nbsp;<span class="ident" id="3935295">time</span><span class="op" id="3935299">.</span><span class="ident" id="3935300">Minute</span><span class="op" id="3935306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935309">return</span>&nbsp;<span class="ident" id="3935316">tc</span><span class="op" id="3935318">,</span>&nbsp;<span class="ident" id="3935320">nil</span><br>
<span class="lineno"></span><span class="op" id="3935324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="3935327">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3935385">type</span>&nbsp;<span class="ident" id="3935390">globalOptionsHandler</span>&nbsp;<span class="keyword" id="3935411">struct</span><span class="op" id="3935417">{</span><span class="op" id="3935418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3935421">func</span>&nbsp;<span class="op" id="3935426">(</span><span class="ident" id="3935427">globalOptionsHandler</span><span class="op" id="3935447">)</span>&nbsp;<span class="ident" id="3935449">ServeHTTP</span><span class="op" id="3935458">(</span><span class="ident" id="3935459">w</span>&nbsp;<span class="ident" id="3935461">ResponseWriter</span><span class="op" id="3935475">,</span>&nbsp;<span class="ident" id="3935477">r</span>&nbsp;<span class="op" id="3935479">*</span><span class="ident" id="3935480">Request</span><span class="op" id="3935487">)</span>&nbsp;<span class="op" id="3935489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935492">w</span><span class="op" id="3935493">.</span><span class="ident" id="3935494">Header</span><span class="op" id="3935500">(</span><span class="op" id="3935501">)</span><span class="op" id="3935502">.</span><span class="ident" id="3935503">Set</span><span class="op" id="3935506">(</span><span class="string" id="3935507">&#34;Content-Length&#34;</span><span class="op" id="3935523">,</span>&nbsp;<span class="string" id="3935525">&#34;0&#34;</span><span class="op" id="3935528">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3935531">if</span>&nbsp;<span class="ident" id="3935534">r</span><span class="op" id="3935535">.</span><span class="ident" id="3935536">ContentLength</span>&nbsp;<span class="op" id="3935550">!=</span>&nbsp;<span class="num" id="3935553">0</span>&nbsp;<span class="op" id="3935555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3935559">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3935616">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3935674">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3935731">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3935790">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935838">mb</span>&nbsp;<span class="op" id="3935841">:=</span>&nbsp;<span class="ident" id="3935844">MaxBytesReader</span><span class="op" id="3935858">(</span><span class="ident" id="3935859">w</span><span class="op" id="3935860">,</span>&nbsp;<span class="ident" id="3935862">r</span><span class="op" id="3935863">.</span><span class="ident" id="3935864">Body</span><span class="op" id="3935868">,</span>&nbsp;<span class="num" id="3935870">4</span><span class="op" id="3935871">&lt;&lt;</span><span class="num" id="3935873">10</span><span class="op" id="3935875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3935879">io</span><span class="op" id="3935881">.</span><span class="ident" id="3935882">Copy</span><span class="op" id="3935886">(</span><span class="ident" id="3935887">ioutil</span><span class="op" id="3935893">.</span><span class="ident" id="3935894">Discard</span><span class="op" id="3935901">,</span>&nbsp;<span class="ident" id="3935903">mb</span><span class="op" id="3935905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3935908">}</span><br>
<span class="lineno"></span><span class="op" id="3935910">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="3935913">type</span>&nbsp;<span class="ident" id="3935918">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="3935939">struct</span><span class="op" id="3935945">{</span><span class="op" id="3935946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3935949">func</span>&nbsp;<span class="op" id="3935954">(</span><span class="ident" id="3935955">eofReaderWithWriteTo</span><span class="op" id="3935975">)</span>&nbsp;<span class="ident" id="3935977">WriteTo</span><span class="op" id="3935984">(</span><span class="ident" id="3935985">io</span><span class="op" id="3935987">.</span><span class="ident" id="3935988">Writer</span><span class="op" id="3935994">)</span>&nbsp;<span class="op" id="3935996">(</span><span class="ident" id="3935997">int64</span><span class="op" id="3936002">,</span>&nbsp;<span class="builtintype" id="3936004">error</span><span class="op" id="3936009">)</span>&nbsp;<span class="op" id="3936011">{</span>&nbsp;<span class="keyword" id="3936013">return</span>&nbsp;<span class="num" id="3936020">0</span><span class="op" id="3936021">,</span>&nbsp;<span class="ident" id="3936023">nil</span>&nbsp;<span class="op" id="3936027">}</span><br>
<span class="lineno"></span><span class="keyword" id="3936029">func</span>&nbsp;<span class="op" id="3936034">(</span><span class="ident" id="3936035">eofReaderWithWriteTo</span><span class="op" id="3936055">)</span>&nbsp;<span class="ident" id="3936057">Read</span><span class="op" id="3936061">(</span><span class="op" id="3936062">[</span><span class="op" id="3936063">]</span><span class="builtintype" id="3936064">byte</span><span class="op" id="3936068">)</span>&nbsp;<span class="op" id="3936070">(</span><span class="builtintype" id="3936071">int</span><span class="op" id="3936074">,</span>&nbsp;<span class="builtintype" id="3936076">error</span><span class="op" id="3936081">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3936091">{</span>&nbsp;<span class="keyword" id="3936093">return</span>&nbsp;<span class="num" id="3936100">0</span><span class="op" id="3936101">,</span>&nbsp;<span class="ident" id="3936103">io</span><span class="op" id="3936105">.</span><span class="ident" id="3936106">EOF</span>&nbsp;<span class="op" id="3936110">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="3936113">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="3936178">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3936237">var</span>&nbsp;<span class="ident" id="3936241">eofReader</span>&nbsp;<span class="op" id="3936251">=</span>&nbsp;<span class="op" id="3936253">&amp;</span><span class="keyword" id="3936254">struct</span>&nbsp;<span class="op" id="3936261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936264">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936286">io</span><span class="op" id="3936288">.</span><span class="ident" id="3936289">Closer</span><br>
<span class="lineno"></span><span class="op" id="3936296">}</span><span class="op" id="3936297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936300">eofReaderWithWriteTo</span><span class="op" id="3936320">{</span><span class="op" id="3936321">}</span><span class="op" id="3936322">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936325">ioutil</span><span class="op" id="3936331">.</span><span class="ident" id="3936332">NopCloser</span><span class="op" id="3936341">(</span><span class="ident" id="3936342">nil</span><span class="op" id="3936345">)</span><span class="op" id="3936346">,</span><br>
<span class="lineno"></span><span class="op" id="3936348">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="3936351">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3936419">var</span>&nbsp;<span class="ident" id="3936423">_</span>&nbsp;<span class="ident" id="3936425">io</span><span class="op" id="3936427">.</span><span class="ident" id="3936428">WriterTo</span>&nbsp;<span class="op" id="3936437">=</span>&nbsp;<span class="ident" id="3936439">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3936450">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="3936512">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="3936580">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="3936625">type</span>&nbsp;<span class="ident" id="3936630">initNPNRequest</span>&nbsp;<span class="keyword" id="3936645">struct</span>&nbsp;<span class="op" id="3936652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936655">c</span>&nbsp;<span class="op" id="3936657">*</span><span class="ident" id="3936658">tls</span><span class="op" id="3936661">.</span><span class="ident" id="3936662">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936668">h</span>&nbsp;<span class="ident" id="3936670">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="3936684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3936687">func</span>&nbsp;<span class="op" id="3936692">(</span><span class="ident" id="3936693">h</span>&nbsp;<span class="ident" id="3936695">initNPNRequest</span><span class="op" id="3936709">)</span>&nbsp;<span class="ident" id="3936711">ServeHTTP</span><span class="op" id="3936720">(</span><span class="ident" id="3936721">rw</span>&nbsp;<span class="ident" id="3936724">ResponseWriter</span><span class="op" id="3936738">,</span>&nbsp;<span class="ident" id="3936740">req</span>&nbsp;<span class="op" id="3936744">*</span><span class="ident" id="3936745">Request</span><span class="op" id="3936752">)</span>&nbsp;<span class="op" id="3936754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936757">if</span>&nbsp;<span class="ident" id="3936760">req</span><span class="op" id="3936763">.</span><span class="ident" id="3936764">TLS</span>&nbsp;<span class="op" id="3936768">==</span>&nbsp;<span class="ident" id="3936771">nil</span>&nbsp;<span class="op" id="3936775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936779">req</span><span class="op" id="3936782">.</span><span class="ident" id="3936783">TLS</span>&nbsp;<span class="op" id="3936787">=</span>&nbsp;<span class="op" id="3936789">&amp;</span><span class="ident" id="3936790">tls</span><span class="op" id="3936793">.</span><span class="ident" id="3936794">ConnectionState</span><span class="op" id="3936809">{</span><span class="op" id="3936810">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936814">*</span><span class="ident" id="3936815">req</span><span class="op" id="3936818">.</span><span class="ident" id="3936819">TLS</span>&nbsp;<span class="op" id="3936823">=</span>&nbsp;<span class="ident" id="3936825">h</span><span class="op" id="3936826">.</span><span class="ident" id="3936827">c</span><span class="op" id="3936828">.</span><span class="ident" id="3936829">ConnectionState</span><span class="op" id="3936844">(</span><span class="op" id="3936845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936851">if</span>&nbsp;<span class="ident" id="3936854">req</span><span class="op" id="3936857">.</span><span class="ident" id="3936858">Body</span>&nbsp;<span class="op" id="3936863">==</span>&nbsp;<span class="ident" id="3936866">nil</span>&nbsp;<span class="op" id="3936870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936874">req</span><span class="op" id="3936877">.</span><span class="ident" id="3936878">Body</span>&nbsp;<span class="op" id="3936883">=</span>&nbsp;<span class="ident" id="3936885">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936896">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3936899">if</span>&nbsp;<span class="ident" id="3936902">req</span><span class="op" id="3936905">.</span><span class="ident" id="3936906">RemoteAddr</span>&nbsp;<span class="op" id="3936917">==</span>&nbsp;<span class="string" id="3936920">&#34;&#34;</span>&nbsp;<span class="op" id="3936923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936927">req</span><span class="op" id="3936930">.</span><span class="ident" id="3936931">RemoteAddr</span>&nbsp;<span class="op" id="3936942">=</span>&nbsp;<span class="ident" id="3936944">h</span><span class="op" id="3936945">.</span><span class="ident" id="3936946">c</span><span class="op" id="3936947">.</span><span class="ident" id="3936948">RemoteAddr</span><span class="op" id="3936958">(</span><span class="op" id="3936959">)</span><span class="op" id="3936960">.</span><span class="ident" id="3936961">String</span><span class="op" id="3936967">(</span><span class="op" id="3936968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3936971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3936974">h</span><span class="op" id="3936975">.</span><span class="ident" id="3936976">h</span><span class="op" id="3936977">.</span><span class="ident" id="3936978">ServeHTTP</span><span class="op" id="3936987">(</span><span class="ident" id="3936988">rw</span><span class="op" id="3936990">,</span>&nbsp;<span class="ident" id="3936992">req</span><span class="op" id="3936995">)</span><br>
<span class="lineno"></span><span class="op" id="3936997">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="3937000">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="3937038">type</span>&nbsp;<span class="ident" id="3937043">loggingConn</span>&nbsp;<span class="keyword" id="3937055">struct</span>&nbsp;<span class="op" id="3937062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937065">name</span>&nbsp;<span class="builtintype" id="3937070">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937078">net</span><span class="op" id="3937081">.</span><span class="ident" id="3937082">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="3937087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3937090">var</span>&nbsp;<span class="op" id="3937094">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937097">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3937110">sync</span><span class="op" id="3937114">.</span><span class="ident" id="3937115">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937122">uniqNameNext</span>&nbsp;<span class="op" id="3937135">=</span>&nbsp;<span class="builtinfunc" id="3937137">make</span><span class="op" id="3937141">(</span><span class="keyword" id="3937142">map</span><span class="op" id="3937145">[</span><span class="builtintype" id="3937146">string</span><span class="op" id="3937152">]</span><span class="builtintype" id="3937153">int</span><span class="op" id="3937156">)</span><br>
<span class="lineno">2050</span><span class="op" id="3937158">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3937161">func</span>&nbsp;<span class="ident" id="3937166">newLoggingConn</span><span class="op" id="3937180">(</span><span class="ident" id="3937181">baseName</span>&nbsp;<span class="builtintype" id="3937190">string</span><span class="op" id="3937196">,</span>&nbsp;<span class="ident" id="3937198">c</span>&nbsp;<span class="ident" id="3937200">net</span><span class="op" id="3937203">.</span><span class="ident" id="3937204">Conn</span><span class="op" id="3937208">)</span>&nbsp;<span class="ident" id="3937210">net</span><span class="op" id="3937213">.</span><span class="ident" id="3937214">Conn</span>&nbsp;<span class="op" id="3937219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937222">uniqNameMu</span><span class="op" id="3937232">.</span><span class="ident" id="3937233">Lock</span><span class="op" id="3937237">(</span><span class="op" id="3937238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937241">defer</span>&nbsp;<span class="ident" id="3937247">uniqNameMu</span><span class="op" id="3937257">.</span><span class="ident" id="3937258">Unlock</span><span class="op" id="3937264">(</span><span class="op" id="3937265">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937268">uniqNameNext</span><span class="op" id="3937280">[</span><span class="ident" id="3937281">baseName</span><span class="op" id="3937289">]</span><span class="op" id="3937290">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937294">return</span>&nbsp;<span class="op" id="3937301">&amp;</span><span class="ident" id="3937302">loggingConn</span><span class="op" id="3937313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937317">name</span><span class="op" id="3937321">:</span>&nbsp;<span class="ident" id="3937323">fmt</span><span class="op" id="3937326">.</span><span class="ident" id="3937327">Sprintf</span><span class="op" id="3937334">(</span><span class="string" id="3937335">&#34;%s-%d&#34;</span><span class="op" id="3937342">,</span>&nbsp;<span class="ident" id="3937344">baseName</span><span class="op" id="3937352">,</span>&nbsp;<span class="ident" id="3937354">uniqNameNext</span><span class="op" id="3937366">[</span><span class="ident" id="3937367">baseName</span><span class="op" id="3937375">]</span><span class="op" id="3937376">)</span><span class="op" id="3937377">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937381">Conn</span><span class="op" id="3937385">:</span>&nbsp;<span class="ident" id="3937387">c</span><span class="op" id="3937388">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3937391">}</span><br>
<span class="lineno">2060</span><span class="op" id="3937393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3937396">func</span>&nbsp;<span class="op" id="3937401">(</span><span class="ident" id="3937402">c</span>&nbsp;<span class="op" id="3937404">*</span><span class="ident" id="3937405">loggingConn</span><span class="op" id="3937416">)</span>&nbsp;<span class="ident" id="3937418">Write</span><span class="op" id="3937423">(</span><span class="ident" id="3937424">p</span>&nbsp;<span class="op" id="3937426">[</span><span class="op" id="3937427">]</span><span class="builtintype" id="3937428">byte</span><span class="op" id="3937432">)</span>&nbsp;<span class="op" id="3937434">(</span><span class="ident" id="3937435">n</span>&nbsp;<span class="builtintype" id="3937437">int</span><span class="op" id="3937440">,</span>&nbsp;<span class="ident" id="3937442">err</span>&nbsp;<span class="builtintype" id="3937446">error</span><span class="op" id="3937451">)</span>&nbsp;<span class="op" id="3937453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937456">log</span><span class="op" id="3937459">.</span><span class="ident" id="3937460">Printf</span><span class="op" id="3937466">(</span><span class="string" id="3937467">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3937488">,</span>&nbsp;<span class="ident" id="3937490">c</span><span class="op" id="3937491">.</span><span class="ident" id="3937492">name</span><span class="op" id="3937496">,</span>&nbsp;<span class="builtinfunc" id="3937498">len</span><span class="op" id="3937501">(</span><span class="ident" id="3937502">p</span><span class="op" id="3937503">)</span><span class="op" id="3937504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937507">n</span><span class="op" id="3937508">,</span>&nbsp;<span class="ident" id="3937510">err</span>&nbsp;<span class="op" id="3937514">=</span>&nbsp;<span class="ident" id="3937516">c</span><span class="op" id="3937517">.</span><span class="ident" id="3937518">Conn</span><span class="op" id="3937522">.</span><span class="ident" id="3937523">Write</span><span class="op" id="3937528">(</span><span class="ident" id="3937529">p</span><span class="op" id="3937530">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937533">log</span><span class="op" id="3937536">.</span><span class="ident" id="3937537">Printf</span><span class="op" id="3937543">(</span><span class="string" id="3937544">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3937567">,</span>&nbsp;<span class="ident" id="3937569">c</span><span class="op" id="3937570">.</span><span class="ident" id="3937571">name</span><span class="op" id="3937575">,</span>&nbsp;<span class="builtinfunc" id="3937577">len</span><span class="op" id="3937580">(</span><span class="ident" id="3937581">p</span><span class="op" id="3937582">)</span><span class="op" id="3937583">,</span>&nbsp;<span class="ident" id="3937585">n</span><span class="op" id="3937586">,</span>&nbsp;<span class="ident" id="3937588">err</span><span class="op" id="3937591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937594">return</span><br>
<span class="lineno"></span><span class="op" id="3937601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3937604">func</span>&nbsp;<span class="op" id="3937609">(</span><span class="ident" id="3937610">c</span>&nbsp;<span class="op" id="3937612">*</span><span class="ident" id="3937613">loggingConn</span><span class="op" id="3937624">)</span>&nbsp;<span class="ident" id="3937626">Read</span><span class="op" id="3937630">(</span><span class="ident" id="3937631">p</span>&nbsp;<span class="op" id="3937633">[</span><span class="op" id="3937634">]</span><span class="builtintype" id="3937635">byte</span><span class="op" id="3937639">)</span>&nbsp;<span class="op" id="3937641">(</span><span class="ident" id="3937642">n</span>&nbsp;<span class="builtintype" id="3937644">int</span><span class="op" id="3937647">,</span>&nbsp;<span class="ident" id="3937649">err</span>&nbsp;<span class="builtintype" id="3937653">error</span><span class="op" id="3937658">)</span>&nbsp;<span class="op" id="3937660">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937663">log</span><span class="op" id="3937666">.</span><span class="ident" id="3937667">Printf</span><span class="op" id="3937673">(</span><span class="string" id="3937674">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3937694">,</span>&nbsp;<span class="ident" id="3937696">c</span><span class="op" id="3937697">.</span><span class="ident" id="3937698">name</span><span class="op" id="3937702">,</span>&nbsp;<span class="builtinfunc" id="3937704">len</span><span class="op" id="3937707">(</span><span class="ident" id="3937708">p</span><span class="op" id="3937709">)</span><span class="op" id="3937710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937713">n</span><span class="op" id="3937714">,</span>&nbsp;<span class="ident" id="3937716">err</span>&nbsp;<span class="op" id="3937720">=</span>&nbsp;<span class="ident" id="3937722">c</span><span class="op" id="3937723">.</span><span class="ident" id="3937724">Conn</span><span class="op" id="3937728">.</span><span class="ident" id="3937729">Read</span><span class="op" id="3937733">(</span><span class="ident" id="3937734">p</span><span class="op" id="3937735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937738">log</span><span class="op" id="3937741">.</span><span class="ident" id="3937742">Printf</span><span class="op" id="3937748">(</span><span class="string" id="3937749">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3937771">,</span>&nbsp;<span class="ident" id="3937773">c</span><span class="op" id="3937774">.</span><span class="ident" id="3937775">name</span><span class="op" id="3937779">,</span>&nbsp;<span class="builtinfunc" id="3937781">len</span><span class="op" id="3937784">(</span><span class="ident" id="3937785">p</span><span class="op" id="3937786">)</span><span class="op" id="3937787">,</span>&nbsp;<span class="ident" id="3937789">n</span><span class="op" id="3937790">,</span>&nbsp;<span class="ident" id="3937792">err</span><span class="op" id="3937795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937798">return</span><br>
<span class="lineno"></span><span class="op" id="3937805">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="3937808">func</span>&nbsp;<span class="op" id="3937813">(</span><span class="ident" id="3937814">c</span>&nbsp;<span class="op" id="3937816">*</span><span class="ident" id="3937817">loggingConn</span><span class="op" id="3937828">)</span>&nbsp;<span class="ident" id="3937830">Close</span><span class="op" id="3937835">(</span><span class="op" id="3937836">)</span>&nbsp;<span class="op" id="3937838">(</span><span class="ident" id="3937839">err</span>&nbsp;<span class="builtintype" id="3937843">error</span><span class="op" id="3937848">)</span>&nbsp;<span class="op" id="3937850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937853">log</span><span class="op" id="3937856">.</span><span class="ident" id="3937857">Printf</span><span class="op" id="3937863">(</span><span class="string" id="3937864">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="3937882">,</span>&nbsp;<span class="ident" id="3937884">c</span><span class="op" id="3937885">.</span><span class="ident" id="3937886">name</span><span class="op" id="3937890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937893">err</span>&nbsp;<span class="op" id="3937897">=</span>&nbsp;<span class="ident" id="3937899">c</span><span class="op" id="3937900">.</span><span class="ident" id="3937901">Conn</span><span class="op" id="3937905">.</span><span class="ident" id="3937906">Close</span><span class="op" id="3937911">(</span><span class="op" id="3937912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3937915">log</span><span class="op" id="3937918">.</span><span class="ident" id="3937919">Printf</span><span class="op" id="3937925">(</span><span class="string" id="3937926">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="3937943">,</span>&nbsp;<span class="ident" id="3937945">c</span><span class="op" id="3937946">.</span><span class="ident" id="3937947">name</span><span class="op" id="3937951">,</span>&nbsp;<span class="ident" id="3937953">err</span><span class="op" id="3937956">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3937959">return</span><br>
<span class="lineno"></span><span class="op" id="3937966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3937969">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="3938049">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="3938116">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3938175">type</span>&nbsp;<span class="ident" id="3938180">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="3938201">struct</span>&nbsp;<span class="op" id="3938208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938211">c</span>&nbsp;<span class="op" id="3938213">*</span><span class="ident" id="3938214">conn</span><br>
<span class="lineno"></span><span class="op" id="3938219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="3938222">func</span>&nbsp;<span class="op" id="3938227">(</span><span class="ident" id="3938228">w</span>&nbsp;<span class="ident" id="3938230">checkConnErrorWriter</span><span class="op" id="3938250">)</span>&nbsp;<span class="ident" id="3938252">Write</span><span class="op" id="3938257">(</span><span class="ident" id="3938258">p</span>&nbsp;<span class="op" id="3938260">[</span><span class="op" id="3938261">]</span><span class="builtintype" id="3938262">byte</span><span class="op" id="3938266">)</span>&nbsp;<span class="op" id="3938268">(</span><span class="ident" id="3938269">n</span>&nbsp;<span class="builtintype" id="3938271">int</span><span class="op" id="3938274">,</span>&nbsp;<span class="ident" id="3938276">err</span>&nbsp;<span class="builtintype" id="3938280">error</span><span class="op" id="3938285">)</span>&nbsp;<span class="op" id="3938287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938290">n</span><span class="op" id="3938291">,</span>&nbsp;<span class="ident" id="3938293">err</span>&nbsp;<span class="op" id="3938297">=</span>&nbsp;<span class="ident" id="3938299">w</span><span class="op" id="3938300">.</span><span class="ident" id="3938301">c</span><span class="op" id="3938302">.</span><span class="ident" id="3938303">w</span><span class="op" id="3938304">.</span><span class="ident" id="3938305">Write</span><span class="op" id="3938310">(</span><span class="ident" id="3938311">p</span><span class="op" id="3938312">)</span>&nbsp;<span class="comment" id="3938314">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938372">if</span>&nbsp;<span class="ident" id="3938375">err</span>&nbsp;<span class="op" id="3938379">!=</span>&nbsp;<span class="ident" id="3938382">nil</span>&nbsp;<span class="op" id="3938386">&amp;&amp;</span>&nbsp;<span class="ident" id="3938389">w</span><span class="op" id="3938390">.</span><span class="ident" id="3938391">c</span><span class="op" id="3938392">.</span><span class="ident" id="3938393">werr</span>&nbsp;<span class="op" id="3938398">==</span>&nbsp;<span class="ident" id="3938401">nil</span>&nbsp;<span class="op" id="3938405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3938409">w</span><span class="op" id="3938410">.</span><span class="ident" id="3938411">c</span><span class="op" id="3938412">.</span><span class="ident" id="3938413">werr</span>&nbsp;<span class="op" id="3938418">=</span>&nbsp;<span class="ident" id="3938420">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3938425">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3938428">return</span><br>
<span class="lineno"></span><span class="op" id="3938435">}</span>
</div>
</body>
</html>
