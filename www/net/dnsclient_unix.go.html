<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3290503">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3290558">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3290612">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3290663">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3290728">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="3290757">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3290805">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="3290819">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="3290880">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="3290909">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="3290969">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3290993">package</span>&nbsp;<span class="ident" id="3291001">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3291006">import</span>&nbsp;<span class="op" id="3291013">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3291016">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3291026">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3291032">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3291045">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3291051">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3291059">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="3291066">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3291069">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="3291119">type</span>&nbsp;<span class="ident" id="3291124">dnsConn</span>&nbsp;<span class="keyword" id="3291132">interface</span>&nbsp;<span class="op" id="3291142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291145">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291152">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291214">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291275">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291288">readDNSResponse</span><span class="op" id="3291303">(</span><span class="op" id="3291304">)</span>&nbsp;<span class="op" id="3291306">(</span><span class="op" id="3291307">*</span><span class="ident" id="3291308">dnsMsg</span><span class="op" id="3291314">,</span>&nbsp;<span class="builtintype" id="3291316">error</span><span class="op" id="3291321">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291325">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291381">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291406">writeDNSQuery</span><span class="op" id="3291419">(</span><span class="op" id="3291420">*</span><span class="ident" id="3291421">dnsMsg</span><span class="op" id="3291427">)</span>&nbsp;<span class="builtintype" id="3291429">error</span><br>
<span class="lineno"></span><span class="op" id="3291435">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3291438">func</span>&nbsp;<span class="op" id="3291443">(</span><span class="ident" id="3291444">c</span>&nbsp;<span class="op" id="3291446">*</span><span class="ident" id="3291447">UDPConn</span><span class="op" id="3291454">)</span>&nbsp;<span class="ident" id="3291456">readDNSResponse</span><span class="op" id="3291471">(</span><span class="op" id="3291472">)</span>&nbsp;<span class="op" id="3291474">(</span><span class="op" id="3291475">*</span><span class="ident" id="3291476">dnsMsg</span><span class="op" id="3291482">,</span>&nbsp;<span class="builtintype" id="3291484">error</span><span class="op" id="3291489">)</span>&nbsp;<span class="op" id="3291491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291494">b</span>&nbsp;<span class="op" id="3291496">:=</span>&nbsp;<span class="builtinfunc" id="3291499">make</span><span class="op" id="3291503">(</span><span class="op" id="3291504">[</span><span class="op" id="3291505">]</span><span class="builtintype" id="3291506">byte</span><span class="op" id="3291510">,</span>&nbsp;<span class="num" id="3291512">512</span><span class="op" id="3291515">)</span>&nbsp;<span class="comment" id="3291517">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291534">n</span><span class="op" id="3291535">,</span>&nbsp;<span class="ident" id="3291537">err</span>&nbsp;<span class="op" id="3291541">:=</span>&nbsp;<span class="ident" id="3291544">c</span><span class="op" id="3291545">.</span><span class="ident" id="3291546">Read</span><span class="op" id="3291550">(</span><span class="ident" id="3291551">b</span><span class="op" id="3291552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291555">if</span>&nbsp;<span class="ident" id="3291558">err</span>&nbsp;<span class="op" id="3291562">!=</span>&nbsp;<span class="ident" id="3291565">nil</span>&nbsp;<span class="op" id="3291569">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291573">return</span>&nbsp;<span class="ident" id="3291580">nil</span><span class="op" id="3291583">,</span>&nbsp;<span class="ident" id="3291585">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291593">msg</span>&nbsp;<span class="op" id="3291597">:=</span>&nbsp;<span class="op" id="3291600">&amp;</span><span class="ident" id="3291601">dnsMsg</span><span class="op" id="3291607">{</span><span class="op" id="3291608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291611">if</span>&nbsp;<span class="op" id="3291614">!</span><span class="ident" id="3291615">msg</span><span class="op" id="3291618">.</span><span class="ident" id="3291619">Unpack</span><span class="op" id="3291625">(</span><span class="ident" id="3291626">b</span><span class="op" id="3291627">[</span><span class="op" id="3291628">:</span><span class="ident" id="3291629">n</span><span class="op" id="3291630">]</span><span class="op" id="3291631">)</span>&nbsp;<span class="op" id="3291633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291637">return</span>&nbsp;<span class="ident" id="3291644">nil</span><span class="op" id="3291647">,</span>&nbsp;<span class="ident" id="3291649">errors</span><span class="op" id="3291655">.</span><span class="ident" id="3291656">New</span><span class="op" id="3291659">(</span><span class="string" id="3291660">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3291690">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291696">return</span>&nbsp;<span class="ident" id="3291703">msg</span><span class="op" id="3291706">,</span>&nbsp;<span class="ident" id="3291708">nil</span><br>
<span class="lineno"></span><span class="op" id="3291712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3291715">func</span>&nbsp;<span class="op" id="3291720">(</span><span class="ident" id="3291721">c</span>&nbsp;<span class="op" id="3291723">*</span><span class="ident" id="3291724">UDPConn</span><span class="op" id="3291731">)</span>&nbsp;<span class="ident" id="3291733">writeDNSQuery</span><span class="op" id="3291746">(</span><span class="ident" id="3291747">msg</span>&nbsp;<span class="op" id="3291751">*</span><span class="ident" id="3291752">dnsMsg</span><span class="op" id="3291758">)</span>&nbsp;<span class="builtintype" id="3291760">error</span>&nbsp;<span class="op" id="3291766">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291769">b</span><span class="op" id="3291770">,</span>&nbsp;<span class="ident" id="3291772">ok</span>&nbsp;<span class="op" id="3291775">:=</span>&nbsp;<span class="ident" id="3291778">msg</span><span class="op" id="3291781">.</span><span class="ident" id="3291782">Pack</span><span class="op" id="3291786">(</span><span class="op" id="3291787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291790">if</span>&nbsp;<span class="op" id="3291793">!</span><span class="ident" id="3291794">ok</span>&nbsp;<span class="op" id="3291797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291801">return</span>&nbsp;<span class="ident" id="3291808">errors</span><span class="op" id="3291814">.</span><span class="ident" id="3291815">New</span><span class="op" id="3291818">(</span><span class="string" id="3291819">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3291847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291853">if</span>&nbsp;<span class="ident" id="3291856">_</span><span class="op" id="3291857">,</span>&nbsp;<span class="ident" id="3291859">err</span>&nbsp;<span class="op" id="3291863">:=</span>&nbsp;<span class="ident" id="3291866">c</span><span class="op" id="3291867">.</span><span class="ident" id="3291868">Write</span><span class="op" id="3291873">(</span><span class="ident" id="3291874">b</span><span class="op" id="3291875">)</span><span class="op" id="3291876">;</span>&nbsp;<span class="ident" id="3291878">err</span>&nbsp;<span class="op" id="3291882">!=</span>&nbsp;<span class="ident" id="3291885">nil</span>&nbsp;<span class="op" id="3291889">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291893">return</span>&nbsp;<span class="ident" id="3291900">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291908">return</span>&nbsp;<span class="ident" id="3291915">nil</span><br>
<span class="lineno"></span><span class="op" id="3291919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="3291922">func</span>&nbsp;<span class="op" id="3291927">(</span><span class="ident" id="3291928">c</span>&nbsp;<span class="op" id="3291930">*</span><span class="ident" id="3291931">TCPConn</span><span class="op" id="3291938">)</span>&nbsp;<span class="ident" id="3291940">readDNSResponse</span><span class="op" id="3291955">(</span><span class="op" id="3291956">)</span>&nbsp;<span class="op" id="3291958">(</span><span class="op" id="3291959">*</span><span class="ident" id="3291960">dnsMsg</span><span class="op" id="3291966">,</span>&nbsp;<span class="builtintype" id="3291968">error</span><span class="op" id="3291973">)</span>&nbsp;<span class="op" id="3291975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291978">b</span>&nbsp;<span class="op" id="3291980">:=</span>&nbsp;<span class="builtinfunc" id="3291983">make</span><span class="op" id="3291987">(</span><span class="op" id="3291988">[</span><span class="op" id="3291989">]</span><span class="builtintype" id="3291990">byte</span><span class="op" id="3291994">,</span>&nbsp;<span class="num" id="3291996">1280</span><span class="op" id="3292000">)</span>&nbsp;<span class="comment" id="3292002">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292075">if</span>&nbsp;<span class="ident" id="3292078">_</span><span class="op" id="3292079">,</span>&nbsp;<span class="ident" id="3292081">err</span>&nbsp;<span class="op" id="3292085">:=</span>&nbsp;<span class="ident" id="3292088">io</span><span class="op" id="3292090">.</span><span class="ident" id="3292091">ReadFull</span><span class="op" id="3292099">(</span><span class="ident" id="3292100">c</span><span class="op" id="3292101">,</span>&nbsp;<span class="ident" id="3292103">b</span><span class="op" id="3292104">[</span><span class="op" id="3292105">:</span><span class="num" id="3292106">2</span><span class="op" id="3292107">]</span><span class="op" id="3292108">)</span><span class="op" id="3292109">;</span>&nbsp;<span class="ident" id="3292111">err</span>&nbsp;<span class="op" id="3292115">!=</span>&nbsp;<span class="ident" id="3292118">nil</span>&nbsp;<span class="op" id="3292122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292126">return</span>&nbsp;<span class="ident" id="3292133">nil</span><span class="op" id="3292136">,</span>&nbsp;<span class="ident" id="3292138">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292143">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292146">l</span>&nbsp;<span class="op" id="3292148">:=</span>&nbsp;<span class="builtintype" id="3292151">int</span><span class="op" id="3292154">(</span><span class="ident" id="3292155">b</span><span class="op" id="3292156">[</span><span class="num" id="3292157">0</span><span class="op" id="3292158">]</span><span class="op" id="3292159">)</span><span class="op" id="3292160">&lt;&lt;</span><span class="num" id="3292162">8</span>&nbsp;<span class="op" id="3292164">|</span>&nbsp;<span class="builtintype" id="3292166">int</span><span class="op" id="3292169">(</span><span class="ident" id="3292170">b</span><span class="op" id="3292171">[</span><span class="num" id="3292172">1</span><span class="op" id="3292173">]</span><span class="op" id="3292174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292177">if</span>&nbsp;<span class="ident" id="3292180">l</span>&nbsp;<span class="op" id="3292182">&gt;</span>&nbsp;<span class="builtinfunc" id="3292184">len</span><span class="op" id="3292187">(</span><span class="ident" id="3292188">b</span><span class="op" id="3292189">)</span>&nbsp;<span class="op" id="3292191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292195">b</span>&nbsp;<span class="op" id="3292197">=</span>&nbsp;<span class="builtinfunc" id="3292199">make</span><span class="op" id="3292203">(</span><span class="op" id="3292204">[</span><span class="op" id="3292205">]</span><span class="builtintype" id="3292206">byte</span><span class="op" id="3292210">,</span>&nbsp;<span class="ident" id="3292212">l</span><span class="op" id="3292213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292219">n</span><span class="op" id="3292220">,</span>&nbsp;<span class="ident" id="3292222">err</span>&nbsp;<span class="op" id="3292226">:=</span>&nbsp;<span class="ident" id="3292229">io</span><span class="op" id="3292231">.</span><span class="ident" id="3292232">ReadFull</span><span class="op" id="3292240">(</span><span class="ident" id="3292241">c</span><span class="op" id="3292242">,</span>&nbsp;<span class="ident" id="3292244">b</span><span class="op" id="3292245">[</span><span class="op" id="3292246">:</span><span class="ident" id="3292247">l</span><span class="op" id="3292248">]</span><span class="op" id="3292249">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292252">if</span>&nbsp;<span class="ident" id="3292255">err</span>&nbsp;<span class="op" id="3292259">!=</span>&nbsp;<span class="ident" id="3292262">nil</span>&nbsp;<span class="op" id="3292266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292270">return</span>&nbsp;<span class="ident" id="3292277">nil</span><span class="op" id="3292280">,</span>&nbsp;<span class="ident" id="3292282">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292290">msg</span>&nbsp;<span class="op" id="3292294">:=</span>&nbsp;<span class="op" id="3292297">&amp;</span><span class="ident" id="3292298">dnsMsg</span><span class="op" id="3292304">{</span><span class="op" id="3292305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292308">if</span>&nbsp;<span class="op" id="3292311">!</span><span class="ident" id="3292312">msg</span><span class="op" id="3292315">.</span><span class="ident" id="3292316">Unpack</span><span class="op" id="3292322">(</span><span class="ident" id="3292323">b</span><span class="op" id="3292324">[</span><span class="op" id="3292325">:</span><span class="ident" id="3292326">n</span><span class="op" id="3292327">]</span><span class="op" id="3292328">)</span>&nbsp;<span class="op" id="3292330">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292334">return</span>&nbsp;<span class="ident" id="3292341">nil</span><span class="op" id="3292344">,</span>&nbsp;<span class="ident" id="3292346">errors</span><span class="op" id="3292352">.</span><span class="ident" id="3292353">New</span><span class="op" id="3292356">(</span><span class="string" id="3292357">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3292387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292393">return</span>&nbsp;<span class="ident" id="3292400">msg</span><span class="op" id="3292403">,</span>&nbsp;<span class="ident" id="3292405">nil</span><br>
<span class="lineno"></span><span class="op" id="3292409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="3292412">func</span>&nbsp;<span class="op" id="3292417">(</span><span class="ident" id="3292418">c</span>&nbsp;<span class="op" id="3292420">*</span><span class="ident" id="3292421">TCPConn</span><span class="op" id="3292428">)</span>&nbsp;<span class="ident" id="3292430">writeDNSQuery</span><span class="op" id="3292443">(</span><span class="ident" id="3292444">msg</span>&nbsp;<span class="op" id="3292448">*</span><span class="ident" id="3292449">dnsMsg</span><span class="op" id="3292455">)</span>&nbsp;<span class="builtintype" id="3292457">error</span>&nbsp;<span class="op" id="3292463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292466">b</span><span class="op" id="3292467">,</span>&nbsp;<span class="ident" id="3292469">ok</span>&nbsp;<span class="op" id="3292472">:=</span>&nbsp;<span class="ident" id="3292475">msg</span><span class="op" id="3292478">.</span><span class="ident" id="3292479">Pack</span><span class="op" id="3292483">(</span><span class="op" id="3292484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292487">if</span>&nbsp;<span class="op" id="3292490">!</span><span class="ident" id="3292491">ok</span>&nbsp;<span class="op" id="3292494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292498">return</span>&nbsp;<span class="ident" id="3292505">errors</span><span class="op" id="3292511">.</span><span class="ident" id="3292512">New</span><span class="op" id="3292515">(</span><span class="string" id="3292516">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="3292544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292547">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292550">l</span>&nbsp;<span class="op" id="3292552">:=</span>&nbsp;<span class="builtintype" id="3292555">uint16</span><span class="op" id="3292561">(</span><span class="builtinfunc" id="3292562">len</span><span class="op" id="3292565">(</span><span class="ident" id="3292566">b</span><span class="op" id="3292567">)</span><span class="op" id="3292568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292571">b</span>&nbsp;<span class="op" id="3292573">=</span>&nbsp;<span class="builtinfunc" id="3292575">append</span><span class="op" id="3292581">(</span><span class="op" id="3292582">[</span><span class="op" id="3292583">]</span><span class="builtintype" id="3292584">byte</span><span class="op" id="3292588">{</span><span class="builtintype" id="3292589">byte</span><span class="op" id="3292593">(</span><span class="ident" id="3292594">l</span>&nbsp;<span class="op" id="3292596">&gt;&gt;</span>&nbsp;<span class="num" id="3292599">8</span><span class="op" id="3292600">)</span><span class="op" id="3292601">,</span>&nbsp;<span class="builtintype" id="3292603">byte</span><span class="op" id="3292607">(</span><span class="ident" id="3292608">l</span><span class="op" id="3292609">)</span><span class="op" id="3292610">}</span><span class="op" id="3292611">,</span>&nbsp;<span class="ident" id="3292613">b</span><span class="op" id="3292614">...</span><span class="op" id="3292617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292620">if</span>&nbsp;<span class="ident" id="3292623">_</span><span class="op" id="3292624">,</span>&nbsp;<span class="ident" id="3292626">err</span>&nbsp;<span class="op" id="3292630">:=</span>&nbsp;<span class="ident" id="3292633">c</span><span class="op" id="3292634">.</span><span class="ident" id="3292635">Write</span><span class="op" id="3292640">(</span><span class="ident" id="3292641">b</span><span class="op" id="3292642">)</span><span class="op" id="3292643">;</span>&nbsp;<span class="ident" id="3292645">err</span>&nbsp;<span class="op" id="3292649">!=</span>&nbsp;<span class="ident" id="3292652">nil</span>&nbsp;<span class="op" id="3292656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292660">return</span>&nbsp;<span class="ident" id="3292667">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292672">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292675">return</span>&nbsp;<span class="ident" id="3292682">nil</span><br>
<span class="lineno"></span><span class="op" id="3292686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3292689">func</span>&nbsp;<span class="op" id="3292694">(</span><span class="ident" id="3292695">d</span>&nbsp;<span class="op" id="3292697">*</span><span class="ident" id="3292698">Dialer</span><span class="op" id="3292704">)</span>&nbsp;<span class="ident" id="3292706">dialDNS</span><span class="op" id="3292713">(</span><span class="ident" id="3292714">network</span><span class="op" id="3292721">,</span>&nbsp;<span class="ident" id="3292723">server</span>&nbsp;<span class="builtintype" id="3292730">string</span><span class="op" id="3292736">)</span>&nbsp;<span class="op" id="3292738">(</span><span class="ident" id="3292739">dnsConn</span><span class="op" id="3292746">,</span>&nbsp;<span class="builtintype" id="3292748">error</span><span class="op" id="3292753">)</span>&nbsp;<span class="op" id="3292755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292758">switch</span>&nbsp;<span class="ident" id="3292765">network</span>&nbsp;<span class="op" id="3292773">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292776">case</span>&nbsp;<span class="string" id="3292781">&#34;tcp&#34;</span><span class="op" id="3292786">,</span>&nbsp;<span class="string" id="3292788">&#34;tcp4&#34;</span><span class="op" id="3292794">,</span>&nbsp;<span class="string" id="3292796">&#34;tcp6&#34;</span><span class="op" id="3292802">,</span>&nbsp;<span class="string" id="3292804">&#34;udp&#34;</span><span class="op" id="3292809">,</span>&nbsp;<span class="string" id="3292811">&#34;udp4&#34;</span><span class="op" id="3292817">,</span>&nbsp;<span class="string" id="3292819">&#34;udp6&#34;</span><span class="op" id="3292825">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292828">default</span><span class="op" id="3292835">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292839">return</span>&nbsp;<span class="ident" id="3292846">nil</span><span class="op" id="3292849">,</span>&nbsp;<span class="ident" id="3292851">UnknownNetworkError</span><span class="op" id="3292870">(</span><span class="ident" id="3292871">network</span><span class="op" id="3292878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292884">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3292944">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3293005">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3293067">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3293122">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293179">c</span><span class="op" id="3293180">,</span>&nbsp;<span class="ident" id="3293182">err</span>&nbsp;<span class="op" id="3293186">:=</span>&nbsp;<span class="ident" id="3293189">d</span><span class="op" id="3293190">.</span><span class="ident" id="3293191">Dial</span><span class="op" id="3293195">(</span><span class="ident" id="3293196">network</span><span class="op" id="3293203">,</span>&nbsp;<span class="ident" id="3293205">server</span><span class="op" id="3293211">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293214">if</span>&nbsp;<span class="ident" id="3293217">err</span>&nbsp;<span class="op" id="3293221">!=</span>&nbsp;<span class="ident" id="3293224">nil</span>&nbsp;<span class="op" id="3293228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293232">return</span>&nbsp;<span class="ident" id="3293239">nil</span><span class="op" id="3293242">,</span>&nbsp;<span class="ident" id="3293244">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293252">switch</span>&nbsp;<span class="ident" id="3293259">network</span>&nbsp;<span class="op" id="3293267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293270">case</span>&nbsp;<span class="string" id="3293275">&#34;tcp&#34;</span><span class="op" id="3293280">,</span>&nbsp;<span class="string" id="3293282">&#34;tcp4&#34;</span><span class="op" id="3293288">,</span>&nbsp;<span class="string" id="3293290">&#34;tcp6&#34;</span><span class="op" id="3293296">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293300">return</span>&nbsp;<span class="ident" id="3293307">c</span><span class="op" id="3293308">.</span><span class="op" id="3293309">(</span><span class="op" id="3293310">*</span><span class="ident" id="3293311">TCPConn</span><span class="op" id="3293318">)</span><span class="op" id="3293319">,</span>&nbsp;<span class="ident" id="3293321">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293326">case</span>&nbsp;<span class="string" id="3293331">&#34;udp&#34;</span><span class="op" id="3293336">,</span>&nbsp;<span class="string" id="3293338">&#34;udp4&#34;</span><span class="op" id="3293344">,</span>&nbsp;<span class="string" id="3293346">&#34;udp6&#34;</span><span class="op" id="3293352">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293356">return</span>&nbsp;<span class="ident" id="3293363">c</span><span class="op" id="3293364">.</span><span class="op" id="3293365">(</span><span class="op" id="3293366">*</span><span class="ident" id="3293367">UDPConn</span><span class="op" id="3293374">)</span><span class="op" id="3293375">,</span>&nbsp;<span class="ident" id="3293377">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3293385">panic</span><span class="op" id="3293390">(</span><span class="string" id="3293391">&#34;unreachable&#34;</span><span class="op" id="3293404">)</span><br>
<span class="lineno">120</span><span class="op" id="3293406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3293409">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3293479">func</span>&nbsp;<span class="ident" id="3293484">exchange</span><span class="op" id="3293492">(</span><span class="ident" id="3293493">server</span><span class="op" id="3293499">,</span>&nbsp;<span class="ident" id="3293501">name</span>&nbsp;<span class="builtintype" id="3293506">string</span><span class="op" id="3293512">,</span>&nbsp;<span class="ident" id="3293514">qtype</span>&nbsp;<span class="builtintype" id="3293520">uint16</span><span class="op" id="3293526">,</span>&nbsp;<span class="ident" id="3293528">timeout</span>&nbsp;<span class="ident" id="3293536">time</span><span class="op" id="3293540">.</span><span class="ident" id="3293541">Duration</span><span class="op" id="3293549">)</span>&nbsp;<span class="op" id="3293551">(</span><span class="op" id="3293552">*</span><span class="ident" id="3293553">dnsMsg</span><span class="op" id="3293559">,</span>&nbsp;<span class="builtintype" id="3293561">error</span><span class="op" id="3293566">)</span>&nbsp;<span class="op" id="3293568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293571">d</span>&nbsp;<span class="op" id="3293573">:=</span>&nbsp;<span class="ident" id="3293576">Dialer</span><span class="op" id="3293582">{</span><span class="ident" id="3293583">Timeout</span><span class="op" id="3293590">:</span>&nbsp;<span class="ident" id="3293592">timeout</span><span class="op" id="3293599">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293602">out</span>&nbsp;<span class="op" id="3293606">:=</span>&nbsp;<span class="ident" id="3293609">dnsMsg</span><span class="op" id="3293615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293619">dnsMsgHdr</span><span class="op" id="3293628">:</span>&nbsp;<span class="ident" id="3293630">dnsMsgHdr</span><span class="op" id="3293639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293644">recursion_desired</span><span class="op" id="3293661">:</span>&nbsp;<span class="ident" id="3293663">true</span><span class="op" id="3293667">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293671">}</span><span class="op" id="3293672">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293676">question</span><span class="op" id="3293684">:</span>&nbsp;<span class="op" id="3293686">[</span><span class="op" id="3293687">]</span><span class="ident" id="3293688">dnsQuestion</span><span class="op" id="3293699">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293704">{</span><span class="ident" id="3293705">name</span><span class="op" id="3293709">,</span>&nbsp;<span class="ident" id="3293711">qtype</span><span class="op" id="3293716">,</span>&nbsp;<span class="ident" id="3293718">dnsClassINET</span><span class="op" id="3293730">}</span><span class="op" id="3293731">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293735">}</span><span class="op" id="3293736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293742">for</span>&nbsp;<span class="ident" id="3293746">_</span><span class="op" id="3293747">,</span>&nbsp;<span class="ident" id="3293749">network</span>&nbsp;<span class="op" id="3293757">:=</span>&nbsp;<span class="keyword" id="3293760">range</span>&nbsp;<span class="op" id="3293766">[</span><span class="op" id="3293767">]</span><span class="builtintype" id="3293768">string</span><span class="op" id="3293774">{</span><span class="string" id="3293775">&#34;udp&#34;</span><span class="op" id="3293780">,</span>&nbsp;<span class="string" id="3293782">&#34;tcp&#34;</span><span class="op" id="3293787">}</span>&nbsp;<span class="op" id="3293789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293793">c</span><span class="op" id="3293794">,</span>&nbsp;<span class="ident" id="3293796">err</span>&nbsp;<span class="op" id="3293800">:=</span>&nbsp;<span class="ident" id="3293803">d</span><span class="op" id="3293804">.</span><span class="ident" id="3293805">dialDNS</span><span class="op" id="3293812">(</span><span class="ident" id="3293813">network</span><span class="op" id="3293820">,</span>&nbsp;<span class="ident" id="3293822">server</span><span class="op" id="3293828">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293832">if</span>&nbsp;<span class="ident" id="3293835">err</span>&nbsp;<span class="op" id="3293839">!=</span>&nbsp;<span class="ident" id="3293842">nil</span>&nbsp;<span class="op" id="3293846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293851">return</span>&nbsp;<span class="ident" id="3293858">nil</span><span class="op" id="3293861">,</span>&nbsp;<span class="ident" id="3293863">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293873">defer</span>&nbsp;<span class="ident" id="3293879">c</span><span class="op" id="3293880">.</span><span class="ident" id="3293881">Close</span><span class="op" id="3293886">(</span><span class="op" id="3293887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3293891">if</span>&nbsp;<span class="ident" id="3293894">timeout</span>&nbsp;<span class="op" id="3293902">&gt;</span>&nbsp;<span class="num" id="3293904">0</span>&nbsp;<span class="op" id="3293906">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293911">c</span><span class="op" id="3293912">.</span><span class="ident" id="3293913">SetDeadline</span><span class="op" id="3293924">(</span><span class="ident" id="3293925">time</span><span class="op" id="3293929">.</span><span class="ident" id="3293930">Now</span><span class="op" id="3293933">(</span><span class="op" id="3293934">)</span><span class="op" id="3293935">.</span><span class="ident" id="3293936">Add</span><span class="op" id="3293939">(</span><span class="ident" id="3293940">timeout</span><span class="op" id="3293947">)</span><span class="op" id="3293948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3293952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3293956">out</span><span class="op" id="3293959">.</span><span class="ident" id="3293960">id</span>&nbsp;<span class="op" id="3293963">=</span>&nbsp;<span class="builtintype" id="3293965">uint16</span><span class="op" id="3293971">(</span><span class="ident" id="3293972">rand</span><span class="op" id="3293976">.</span><span class="ident" id="3293977">Int</span><span class="op" id="3293980">(</span><span class="op" id="3293981">)</span><span class="op" id="3293982">)</span>&nbsp;<span class="op" id="3293984">^</span>&nbsp;<span class="builtintype" id="3293986">uint16</span><span class="op" id="3293992">(</span><span class="ident" id="3293993">time</span><span class="op" id="3293997">.</span><span class="ident" id="3293998">Now</span><span class="op" id="3294001">(</span><span class="op" id="3294002">)</span><span class="op" id="3294003">.</span><span class="ident" id="3294004">UnixNano</span><span class="op" id="3294012">(</span><span class="op" id="3294013">)</span><span class="op" id="3294014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294018">if</span>&nbsp;<span class="ident" id="3294021">err</span>&nbsp;<span class="op" id="3294025">:=</span>&nbsp;<span class="ident" id="3294028">c</span><span class="op" id="3294029">.</span><span class="ident" id="3294030">writeDNSQuery</span><span class="op" id="3294043">(</span><span class="op" id="3294044">&amp;</span><span class="ident" id="3294045">out</span><span class="op" id="3294048">)</span><span class="op" id="3294049">;</span>&nbsp;<span class="ident" id="3294051">err</span>&nbsp;<span class="op" id="3294055">!=</span>&nbsp;<span class="ident" id="3294058">nil</span>&nbsp;<span class="op" id="3294062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294067">return</span>&nbsp;<span class="ident" id="3294074">nil</span><span class="op" id="3294077">,</span>&nbsp;<span class="ident" id="3294079">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3294089">in</span><span class="op" id="3294091">,</span>&nbsp;<span class="ident" id="3294093">err</span>&nbsp;<span class="op" id="3294097">:=</span>&nbsp;<span class="ident" id="3294100">c</span><span class="op" id="3294101">.</span><span class="ident" id="3294102">readDNSResponse</span><span class="op" id="3294117">(</span><span class="op" id="3294118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294122">if</span>&nbsp;<span class="ident" id="3294125">err</span>&nbsp;<span class="op" id="3294129">!=</span>&nbsp;<span class="ident" id="3294132">nil</span>&nbsp;<span class="op" id="3294136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294141">return</span>&nbsp;<span class="ident" id="3294148">nil</span><span class="op" id="3294151">,</span>&nbsp;<span class="ident" id="3294153">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294159">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294163">if</span>&nbsp;<span class="ident" id="3294166">in</span><span class="op" id="3294168">.</span><span class="ident" id="3294169">id</span>&nbsp;<span class="op" id="3294172">!=</span>&nbsp;<span class="ident" id="3294175">out</span><span class="op" id="3294178">.</span><span class="ident" id="3294179">id</span>&nbsp;<span class="op" id="3294182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294187">return</span>&nbsp;<span class="ident" id="3294194">nil</span><span class="op" id="3294197">,</span>&nbsp;<span class="ident" id="3294199">errors</span><span class="op" id="3294205">.</span><span class="ident" id="3294206">New</span><span class="op" id="3294209">(</span><span class="string" id="3294210">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="3294235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294243">if</span>&nbsp;<span class="ident" id="3294246">in</span><span class="op" id="3294248">.</span><span class="ident" id="3294249">truncated</span>&nbsp;<span class="op" id="3294259">{</span>&nbsp;<span class="comment" id="3294261">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294280">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294295">return</span>&nbsp;<span class="ident" id="3294302">in</span><span class="op" id="3294304">,</span>&nbsp;<span class="ident" id="3294306">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294314">return</span>&nbsp;<span class="ident" id="3294321">nil</span><span class="op" id="3294324">,</span>&nbsp;<span class="ident" id="3294326">errors</span><span class="op" id="3294332">.</span><span class="ident" id="3294333">New</span><span class="op" id="3294336">(</span><span class="string" id="3294337">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="3294364">)</span><br>
<span class="lineno"></span><span class="op" id="3294366">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3294369">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="3294424">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="3294473">func</span>&nbsp;<span class="ident" id="3294478">tryOneName</span><span class="op" id="3294488">(</span><span class="ident" id="3294489">cfg</span>&nbsp;<span class="op" id="3294493">*</span><span class="ident" id="3294494">dnsConfig</span><span class="op" id="3294503">,</span>&nbsp;<span class="ident" id="3294505">name</span>&nbsp;<span class="builtintype" id="3294510">string</span><span class="op" id="3294516">,</span>&nbsp;<span class="ident" id="3294518">qtype</span>&nbsp;<span class="builtintype" id="3294524">uint16</span><span class="op" id="3294530">)</span>&nbsp;<span class="op" id="3294532">(</span><span class="builtintype" id="3294533">string</span><span class="op" id="3294539">,</span>&nbsp;<span class="op" id="3294541">[</span><span class="op" id="3294542">]</span><span class="ident" id="3294543">dnsRR</span><span class="op" id="3294548">,</span>&nbsp;<span class="builtintype" id="3294550">error</span><span class="op" id="3294555">)</span>&nbsp;<span class="op" id="3294557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294560">if</span>&nbsp;<span class="builtinfunc" id="3294563">len</span><span class="op" id="3294566">(</span><span class="ident" id="3294567">cfg</span><span class="op" id="3294570">.</span><span class="ident" id="3294571">servers</span><span class="op" id="3294578">)</span>&nbsp;<span class="op" id="3294580">==</span>&nbsp;<span class="num" id="3294583">0</span>&nbsp;<span class="op" id="3294585">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294589">return</span>&nbsp;<span class="string" id="3294596">&#34;&#34;</span><span class="op" id="3294598">,</span>&nbsp;<span class="ident" id="3294600">nil</span><span class="op" id="3294603">,</span>&nbsp;<span class="op" id="3294605">&amp;</span><span class="ident" id="3294606">DNSError</span><span class="op" id="3294614">{</span><span class="ident" id="3294615">Err</span><span class="op" id="3294618">:</span>&nbsp;<span class="string" id="3294620">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="3294636">,</span>&nbsp;<span class="ident" id="3294638">Name</span><span class="op" id="3294642">:</span>&nbsp;<span class="ident" id="3294644">name</span><span class="op" id="3294648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294654">if</span>&nbsp;<span class="builtinfunc" id="3294657">len</span><span class="op" id="3294660">(</span><span class="ident" id="3294661">name</span><span class="op" id="3294665">)</span>&nbsp;<span class="op" id="3294667">&gt;=</span>&nbsp;<span class="num" id="3294670">256</span>&nbsp;<span class="op" id="3294674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294678">return</span>&nbsp;<span class="string" id="3294685">&#34;&#34;</span><span class="op" id="3294687">,</span>&nbsp;<span class="ident" id="3294689">nil</span><span class="op" id="3294692">,</span>&nbsp;<span class="op" id="3294694">&amp;</span><span class="ident" id="3294695">DNSError</span><span class="op" id="3294703">{</span><span class="ident" id="3294704">Err</span><span class="op" id="3294707">:</span>&nbsp;<span class="string" id="3294709">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="3294728">,</span>&nbsp;<span class="ident" id="3294730">Name</span><span class="op" id="3294734">:</span>&nbsp;<span class="ident" id="3294736">name</span><span class="op" id="3294740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3294743">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3294746">timeout</span>&nbsp;<span class="op" id="3294754">:=</span>&nbsp;<span class="ident" id="3294757">time</span><span class="op" id="3294761">.</span><span class="ident" id="3294762">Duration</span><span class="op" id="3294770">(</span><span class="ident" id="3294771">cfg</span><span class="op" id="3294774">.</span><span class="ident" id="3294775">timeout</span><span class="op" id="3294782">)</span>&nbsp;<span class="op" id="3294784">*</span>&nbsp;<span class="ident" id="3294786">time</span><span class="op" id="3294790">.</span><span class="ident" id="3294791">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294799">var</span>&nbsp;<span class="ident" id="3294803">lastErr</span>&nbsp;<span class="builtintype" id="3294811">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294818">for</span>&nbsp;<span class="ident" id="3294822">i</span>&nbsp;<span class="op" id="3294824">:=</span>&nbsp;<span class="num" id="3294827">0</span><span class="op" id="3294828">;</span>&nbsp;<span class="ident" id="3294830">i</span>&nbsp;<span class="op" id="3294832">&lt;</span>&nbsp;<span class="ident" id="3294834">cfg</span><span class="op" id="3294837">.</span><span class="ident" id="3294838">attempts</span><span class="op" id="3294846">;</span>&nbsp;<span class="ident" id="3294848">i</span><span class="op" id="3294849">++</span>&nbsp;<span class="op" id="3294852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294856">for</span>&nbsp;<span class="ident" id="3294860">_</span><span class="op" id="3294861">,</span>&nbsp;<span class="ident" id="3294863">server</span>&nbsp;<span class="op" id="3294870">:=</span>&nbsp;<span class="keyword" id="3294873">range</span>&nbsp;<span class="ident" id="3294879">cfg</span><span class="op" id="3294882">.</span><span class="ident" id="3294883">servers</span>&nbsp;<span class="op" id="3294891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3294896">server</span>&nbsp;<span class="op" id="3294903">=</span>&nbsp;<span class="ident" id="3294905">JoinHostPort</span><span class="op" id="3294917">(</span><span class="ident" id="3294918">server</span><span class="op" id="3294924">,</span>&nbsp;<span class="string" id="3294926">&#34;53&#34;</span><span class="op" id="3294930">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3294935">msg</span><span class="op" id="3294938">,</span>&nbsp;<span class="ident" id="3294940">err</span>&nbsp;<span class="op" id="3294944">:=</span>&nbsp;<span class="ident" id="3294947">exchange</span><span class="op" id="3294955">(</span><span class="ident" id="3294956">server</span><span class="op" id="3294962">,</span>&nbsp;<span class="ident" id="3294964">name</span><span class="op" id="3294968">,</span>&nbsp;<span class="ident" id="3294970">qtype</span><span class="op" id="3294975">,</span>&nbsp;<span class="ident" id="3294977">timeout</span><span class="op" id="3294984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3294989">if</span>&nbsp;<span class="ident" id="3294992">err</span>&nbsp;<span class="op" id="3294996">!=</span>&nbsp;<span class="ident" id="3294999">nil</span>&nbsp;<span class="op" id="3295003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295009">lastErr</span>&nbsp;<span class="op" id="3295017">=</span>&nbsp;<span class="op" id="3295019">&amp;</span><span class="ident" id="3295020">DNSError</span><span class="op" id="3295028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295035">Err</span><span class="op" id="3295038">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3295043">err</span><span class="op" id="3295046">.</span><span class="ident" id="3295047">Error</span><span class="op" id="3295052">(</span><span class="op" id="3295053">)</span><span class="op" id="3295054">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295061">Name</span><span class="op" id="3295065">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3295069">name</span><span class="op" id="3295073">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295080">Server</span><span class="op" id="3295086">:</span>&nbsp;<span class="ident" id="3295088">server</span><span class="op" id="3295094">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295106">if</span>&nbsp;<span class="ident" id="3295109">nerr</span><span class="op" id="3295113">,</span>&nbsp;<span class="ident" id="3295115">ok</span>&nbsp;<span class="op" id="3295118">:=</span>&nbsp;<span class="ident" id="3295121">err</span><span class="op" id="3295124">.</span><span class="op" id="3295125">(</span><span class="ident" id="3295126">Error</span><span class="op" id="3295131">)</span><span class="op" id="3295132">;</span>&nbsp;<span class="ident" id="3295134">ok</span>&nbsp;<span class="op" id="3295137">&amp;&amp;</span>&nbsp;<span class="ident" id="3295140">nerr</span><span class="op" id="3295144">.</span><span class="ident" id="3295145">Timeout</span><span class="op" id="3295152">(</span><span class="op" id="3295153">)</span>&nbsp;<span class="op" id="3295155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295162">lastErr</span><span class="op" id="3295169">.</span><span class="op" id="3295170">(</span><span class="op" id="3295171">*</span><span class="ident" id="3295172">DNSError</span><span class="op" id="3295180">)</span><span class="op" id="3295181">.</span><span class="ident" id="3295182">IsTimeout</span>&nbsp;<span class="op" id="3295192">=</span>&nbsp;<span class="ident" id="3295194">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295203">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295209">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295226">cname</span><span class="op" id="3295231">,</span>&nbsp;<span class="ident" id="3295233">addrs</span><span class="op" id="3295238">,</span>&nbsp;<span class="ident" id="3295240">err</span>&nbsp;<span class="op" id="3295244">:=</span>&nbsp;<span class="ident" id="3295247">answer</span><span class="op" id="3295253">(</span><span class="ident" id="3295254">name</span><span class="op" id="3295258">,</span>&nbsp;<span class="ident" id="3295260">server</span><span class="op" id="3295266">,</span>&nbsp;<span class="ident" id="3295268">msg</span><span class="op" id="3295271">,</span>&nbsp;<span class="ident" id="3295273">qtype</span><span class="op" id="3295278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295283">if</span>&nbsp;<span class="ident" id="3295286">err</span>&nbsp;<span class="op" id="3295290">==</span>&nbsp;<span class="ident" id="3295293">nil</span>&nbsp;<span class="op" id="3295297">||</span>&nbsp;<span class="ident" id="3295300">err</span><span class="op" id="3295303">.</span><span class="op" id="3295304">(</span><span class="op" id="3295305">*</span><span class="ident" id="3295306">DNSError</span><span class="op" id="3295314">)</span><span class="op" id="3295315">.</span><span class="ident" id="3295316">Err</span>&nbsp;<span class="op" id="3295320">==</span>&nbsp;<span class="ident" id="3295323">noSuchHost</span>&nbsp;<span class="op" id="3295334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295340">return</span>&nbsp;<span class="ident" id="3295347">cname</span><span class="op" id="3295352">,</span>&nbsp;<span class="ident" id="3295354">addrs</span><span class="op" id="3295359">,</span>&nbsp;<span class="ident" id="3295361">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295373">lastErr</span>&nbsp;<span class="op" id="3295381">=</span>&nbsp;<span class="ident" id="3295383">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295395">return</span>&nbsp;<span class="string" id="3295402">&#34;&#34;</span><span class="op" id="3295404">,</span>&nbsp;<span class="ident" id="3295406">nil</span><span class="op" id="3295409">,</span>&nbsp;<span class="ident" id="3295411">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="3295419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3295422">func</span>&nbsp;<span class="ident" id="3295427">convertRR_A</span><span class="op" id="3295438">(</span><span class="ident" id="3295439">records</span>&nbsp;<span class="op" id="3295447">[</span><span class="op" id="3295448">]</span><span class="ident" id="3295449">dnsRR</span><span class="op" id="3295454">)</span>&nbsp;<span class="op" id="3295456">[</span><span class="op" id="3295457">]</span><span class="ident" id="3295458">IP</span>&nbsp;<span class="op" id="3295461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295464">addrs</span>&nbsp;<span class="op" id="3295470">:=</span>&nbsp;<span class="builtinfunc" id="3295473">make</span><span class="op" id="3295477">(</span><span class="op" id="3295478">[</span><span class="op" id="3295479">]</span><span class="ident" id="3295480">IP</span><span class="op" id="3295482">,</span>&nbsp;<span class="builtinfunc" id="3295484">len</span><span class="op" id="3295487">(</span><span class="ident" id="3295488">records</span><span class="op" id="3295495">)</span><span class="op" id="3295496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295499">for</span>&nbsp;<span class="ident" id="3295503">i</span><span class="op" id="3295504">,</span>&nbsp;<span class="ident" id="3295506">rr</span>&nbsp;<span class="op" id="3295509">:=</span>&nbsp;<span class="keyword" id="3295512">range</span>&nbsp;<span class="ident" id="3295518">records</span>&nbsp;<span class="op" id="3295526">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295530">a</span>&nbsp;<span class="op" id="3295532">:=</span>&nbsp;<span class="ident" id="3295535">rr</span><span class="op" id="3295537">.</span><span class="op" id="3295538">(</span><span class="op" id="3295539">*</span><span class="ident" id="3295540">dnsRR_A</span><span class="op" id="3295547">)</span><span class="op" id="3295548">.</span><span class="ident" id="3295549">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295553">addrs</span><span class="op" id="3295558">[</span><span class="ident" id="3295559">i</span><span class="op" id="3295560">]</span>&nbsp;<span class="op" id="3295562">=</span>&nbsp;<span class="ident" id="3295564">IPv4</span><span class="op" id="3295568">(</span><span class="builtintype" id="3295569">byte</span><span class="op" id="3295573">(</span><span class="ident" id="3295574">a</span><span class="op" id="3295575">&gt;&gt;</span><span class="num" id="3295577">24</span><span class="op" id="3295579">)</span><span class="op" id="3295580">,</span>&nbsp;<span class="builtintype" id="3295582">byte</span><span class="op" id="3295586">(</span><span class="ident" id="3295587">a</span><span class="op" id="3295588">&gt;&gt;</span><span class="num" id="3295590">16</span><span class="op" id="3295592">)</span><span class="op" id="3295593">,</span>&nbsp;<span class="builtintype" id="3295595">byte</span><span class="op" id="3295599">(</span><span class="ident" id="3295600">a</span><span class="op" id="3295601">&gt;&gt;</span><span class="num" id="3295603">8</span><span class="op" id="3295604">)</span><span class="op" id="3295605">,</span>&nbsp;<span class="builtintype" id="3295607">byte</span><span class="op" id="3295611">(</span><span class="ident" id="3295612">a</span><span class="op" id="3295613">)</span><span class="op" id="3295614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295620">return</span>&nbsp;<span class="ident" id="3295627">addrs</span><br>
<span class="lineno"></span><span class="op" id="3295633">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="3295636">func</span>&nbsp;<span class="ident" id="3295641">convertRR_AAAA</span><span class="op" id="3295655">(</span><span class="ident" id="3295656">records</span>&nbsp;<span class="op" id="3295664">[</span><span class="op" id="3295665">]</span><span class="ident" id="3295666">dnsRR</span><span class="op" id="3295671">)</span>&nbsp;<span class="op" id="3295673">[</span><span class="op" id="3295674">]</span><span class="ident" id="3295675">IP</span>&nbsp;<span class="op" id="3295678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295681">addrs</span>&nbsp;<span class="op" id="3295687">:=</span>&nbsp;<span class="builtinfunc" id="3295690">make</span><span class="op" id="3295694">(</span><span class="op" id="3295695">[</span><span class="op" id="3295696">]</span><span class="ident" id="3295697">IP</span><span class="op" id="3295699">,</span>&nbsp;<span class="builtinfunc" id="3295701">len</span><span class="op" id="3295704">(</span><span class="ident" id="3295705">records</span><span class="op" id="3295712">)</span><span class="op" id="3295713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295716">for</span>&nbsp;<span class="ident" id="3295720">i</span><span class="op" id="3295721">,</span>&nbsp;<span class="ident" id="3295723">rr</span>&nbsp;<span class="op" id="3295726">:=</span>&nbsp;<span class="keyword" id="3295729">range</span>&nbsp;<span class="ident" id="3295735">records</span>&nbsp;<span class="op" id="3295743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295747">a</span>&nbsp;<span class="op" id="3295749">:=</span>&nbsp;<span class="builtinfunc" id="3295752">make</span><span class="op" id="3295756">(</span><span class="ident" id="3295757">IP</span><span class="op" id="3295759">,</span>&nbsp;<span class="ident" id="3295761">IPv6len</span><span class="op" id="3295768">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3295772">copy</span><span class="op" id="3295776">(</span><span class="ident" id="3295777">a</span><span class="op" id="3295778">,</span>&nbsp;<span class="ident" id="3295780">rr</span><span class="op" id="3295782">.</span><span class="op" id="3295783">(</span><span class="op" id="3295784">*</span><span class="ident" id="3295785">dnsRR_AAAA</span><span class="op" id="3295795">)</span><span class="op" id="3295796">.</span><span class="ident" id="3295797">AAAA</span><span class="op" id="3295801">[</span><span class="op" id="3295802">:</span><span class="op" id="3295803">]</span><span class="op" id="3295804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295808">addrs</span><span class="op" id="3295813">[</span><span class="ident" id="3295814">i</span><span class="op" id="3295815">]</span>&nbsp;<span class="op" id="3295817">=</span>&nbsp;<span class="ident" id="3295819">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3295822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3295825">return</span>&nbsp;<span class="ident" id="3295832">addrs</span><br>
<span class="lineno"></span><span class="op" id="3295838">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="3295841">var</span>&nbsp;<span class="ident" id="3295845">cfg</span>&nbsp;<span class="keyword" id="3295849">struct</span>&nbsp;<span class="op" id="3295856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295859">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3295869">chan</span>&nbsp;<span class="keyword" id="3295874">struct</span><span class="op" id="3295880">{</span><span class="op" id="3295881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295884">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3295894">sync</span><span class="op" id="3295898">.</span><span class="ident" id="3295899">RWMutex</span>&nbsp;<span class="comment" id="3295907">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295941">dnsConfig</span>&nbsp;<span class="op" id="3295951">*</span><span class="ident" id="3295952">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3295963">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3295973">error</span><br>
<span class="lineno"></span><span class="op" id="3295979">}</span><br>
<span class="lineno"></span><span class="keyword" id="3295981">var</span>&nbsp;<span class="ident" id="3295985">onceLoadConfig</span>&nbsp;<span class="ident" id="3296000">sync</span><span class="op" id="3296004">.</span><span class="ident" id="3296005">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3296011">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="3296062">func</span>&nbsp;<span class="ident" id="3296067">loadDefaultConfig</span><span class="op" id="3296084">(</span><span class="op" id="3296085">)</span>&nbsp;<span class="op" id="3296087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296090">loadConfig</span><span class="op" id="3296100">(</span><span class="string" id="3296101">&#34;/etc/resolv.conf&#34;</span><span class="op" id="3296119">,</span>&nbsp;<span class="num" id="3296121">5</span><span class="op" id="3296122">*</span><span class="ident" id="3296123">time</span><span class="op" id="3296127">.</span><span class="ident" id="3296128">Second</span><span class="op" id="3296134">,</span>&nbsp;<span class="ident" id="3296136">nil</span><span class="op" id="3296139">)</span><br>
<span class="lineno"></span><span class="op" id="3296141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3296144">func</span>&nbsp;<span class="ident" id="3296149">loadConfig</span><span class="op" id="3296159">(</span><span class="ident" id="3296160">resolvConfPath</span>&nbsp;<span class="builtintype" id="3296175">string</span><span class="op" id="3296181">,</span>&nbsp;<span class="ident" id="3296183">reloadTime</span>&nbsp;<span class="ident" id="3296194">time</span><span class="op" id="3296198">.</span><span class="ident" id="3296199">Duration</span><span class="op" id="3296207">,</span>&nbsp;<span class="ident" id="3296209">quit</span>&nbsp;<span class="op" id="3296214">&lt;-</span><span class="keyword" id="3296216">chan</span>&nbsp;<span class="keyword" id="3296221">chan</span>&nbsp;<span class="keyword" id="3296226">struct</span><span class="op" id="3296232">{</span><span class="op" id="3296233">}</span><span class="op" id="3296234">)</span>&nbsp;<span class="op" id="3296236">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296239">var</span>&nbsp;<span class="ident" id="3296243">mtime</span>&nbsp;<span class="ident" id="3296249">time</span><span class="op" id="3296253">.</span><span class="ident" id="3296254">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296260">cfg</span><span class="op" id="3296263">.</span><span class="ident" id="3296264">ch</span>&nbsp;<span class="op" id="3296267">=</span>&nbsp;<span class="builtinfunc" id="3296269">make</span><span class="op" id="3296273">(</span><span class="keyword" id="3296274">chan</span>&nbsp;<span class="keyword" id="3296279">struct</span><span class="op" id="3296285">{</span><span class="op" id="3296286">}</span><span class="op" id="3296287">,</span>&nbsp;<span class="num" id="3296289">1</span><span class="op" id="3296290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296293">if</span>&nbsp;<span class="ident" id="3296296">fi</span><span class="op" id="3296298">,</span>&nbsp;<span class="ident" id="3296300">err</span>&nbsp;<span class="op" id="3296304">:=</span>&nbsp;<span class="ident" id="3296307">os</span><span class="op" id="3296309">.</span><span class="ident" id="3296310">Stat</span><span class="op" id="3296314">(</span><span class="ident" id="3296315">resolvConfPath</span><span class="op" id="3296329">)</span><span class="op" id="3296330">;</span>&nbsp;<span class="ident" id="3296332">err</span>&nbsp;<span class="op" id="3296336">!=</span>&nbsp;<span class="ident" id="3296339">nil</span>&nbsp;<span class="op" id="3296343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296347">cfg</span><span class="op" id="3296350">.</span><span class="ident" id="3296351">dnserr</span>&nbsp;<span class="op" id="3296358">=</span>&nbsp;<span class="ident" id="3296360">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3296365">}</span>&nbsp;<span class="keyword" id="3296367">else</span>&nbsp;<span class="op" id="3296372">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296376">mtime</span>&nbsp;<span class="op" id="3296382">=</span>&nbsp;<span class="ident" id="3296384">fi</span><span class="op" id="3296386">.</span><span class="ident" id="3296387">ModTime</span><span class="op" id="3296394">(</span><span class="op" id="3296395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296399">cfg</span><span class="op" id="3296402">.</span><span class="ident" id="3296403">dnsConfig</span><span class="op" id="3296412">,</span>&nbsp;<span class="ident" id="3296414">cfg</span><span class="op" id="3296417">.</span><span class="ident" id="3296418">dnserr</span>&nbsp;<span class="op" id="3296425">=</span>&nbsp;<span class="ident" id="3296427">dnsReadConfig</span><span class="op" id="3296440">(</span><span class="ident" id="3296441">resolvConfPath</span><span class="op" id="3296455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3296458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296461">go</span>&nbsp;<span class="keyword" id="3296464">func</span><span class="op" id="3296468">(</span><span class="op" id="3296469">)</span>&nbsp;<span class="op" id="3296471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296475">for</span>&nbsp;<span class="op" id="3296479">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296484">time</span><span class="op" id="3296488">.</span><span class="ident" id="3296489">Sleep</span><span class="op" id="3296494">(</span><span class="ident" id="3296495">reloadTime</span><span class="op" id="3296505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296510">select</span>&nbsp;<span class="op" id="3296517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296522">case</span>&nbsp;<span class="ident" id="3296527">qresp</span>&nbsp;<span class="op" id="3296533">:=</span>&nbsp;<span class="op" id="3296536">&lt;-</span><span class="ident" id="3296538">quit</span><span class="op" id="3296542">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296548">qresp</span>&nbsp;<span class="op" id="3296554">&lt;-</span>&nbsp;<span class="keyword" id="3296557">struct</span><span class="op" id="3296563">{</span><span class="op" id="3296564">}</span><span class="op" id="3296565">{</span><span class="op" id="3296566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296572">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296582">case</span>&nbsp;<span class="op" id="3296587">&lt;-</span><span class="ident" id="3296589">cfg</span><span class="op" id="3296592">.</span><span class="ident" id="3296593">ch</span><span class="op" id="3296595">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3296600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296606">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296658">fi</span><span class="op" id="3296660">,</span>&nbsp;<span class="ident" id="3296662">err</span>&nbsp;<span class="op" id="3296666">:=</span>&nbsp;<span class="ident" id="3296669">os</span><span class="op" id="3296671">.</span><span class="ident" id="3296672">Stat</span><span class="op" id="3296676">(</span><span class="ident" id="3296677">resolvConfPath</span><span class="op" id="3296691">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296696">if</span>&nbsp;<span class="ident" id="3296699">err</span>&nbsp;<span class="op" id="3296703">!=</span>&nbsp;<span class="ident" id="3296706">nil</span>&nbsp;<span class="op" id="3296710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296716">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3296728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296733">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296793">m</span>&nbsp;<span class="op" id="3296795">:=</span>&nbsp;<span class="ident" id="3296798">fi</span><span class="op" id="3296800">.</span><span class="ident" id="3296801">ModTime</span><span class="op" id="3296808">(</span><span class="op" id="3296809">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296814">if</span>&nbsp;<span class="ident" id="3296817">m</span><span class="op" id="3296818">.</span><span class="ident" id="3296819">Equal</span><span class="op" id="3296824">(</span><span class="ident" id="3296825">mtime</span><span class="op" id="3296830">)</span>&nbsp;<span class="op" id="3296832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296838">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3296850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296855">mtime</span>&nbsp;<span class="op" id="3296861">=</span>&nbsp;<span class="ident" id="3296863">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3296868">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3296920">ncfg</span><span class="op" id="3296924">,</span>&nbsp;<span class="ident" id="3296926">err</span>&nbsp;<span class="op" id="3296930">:=</span>&nbsp;<span class="ident" id="3296933">dnsReadConfig</span><span class="op" id="3296946">(</span><span class="ident" id="3296947">resolvConfPath</span><span class="op" id="3296961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3296966">if</span>&nbsp;<span class="ident" id="3296969">err</span>&nbsp;<span class="op" id="3296973">!=</span>&nbsp;<span class="ident" id="3296976">nil</span>&nbsp;<span class="op" id="3296980">||</span>&nbsp;<span class="builtinfunc" id="3296983">len</span><span class="op" id="3296986">(</span><span class="ident" id="3296987">ncfg</span><span class="op" id="3296991">.</span><span class="ident" id="3296992">servers</span><span class="op" id="3296999">)</span>&nbsp;<span class="op" id="3297001">==</span>&nbsp;<span class="num" id="3297004">0</span>&nbsp;<span class="op" id="3297006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297012">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297029">cfg</span><span class="op" id="3297032">.</span><span class="ident" id="3297033">mu</span><span class="op" id="3297035">.</span><span class="ident" id="3297036">Lock</span><span class="op" id="3297040">(</span><span class="op" id="3297041">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297046">cfg</span><span class="op" id="3297049">.</span><span class="ident" id="3297050">dnsConfig</span>&nbsp;<span class="op" id="3297060">=</span>&nbsp;<span class="ident" id="3297062">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297070">cfg</span><span class="op" id="3297073">.</span><span class="ident" id="3297074">dnserr</span>&nbsp;<span class="op" id="3297081">=</span>&nbsp;<span class="ident" id="3297083">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297090">cfg</span><span class="op" id="3297093">.</span><span class="ident" id="3297094">mu</span><span class="op" id="3297096">.</span><span class="ident" id="3297097">Unlock</span><span class="op" id="3297103">(</span><span class="op" id="3297104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297111">}</span><span class="op" id="3297112">(</span><span class="op" id="3297113">)</span><br>
<span class="lineno">270</span><span class="op" id="3297115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3297118">func</span>&nbsp;<span class="ident" id="3297123">lookup</span><span class="op" id="3297129">(</span><span class="ident" id="3297130">name</span>&nbsp;<span class="builtintype" id="3297135">string</span><span class="op" id="3297141">,</span>&nbsp;<span class="ident" id="3297143">qtype</span>&nbsp;<span class="builtintype" id="3297149">uint16</span><span class="op" id="3297155">)</span>&nbsp;<span class="op" id="3297157">(</span><span class="ident" id="3297158">cname</span>&nbsp;<span class="builtintype" id="3297164">string</span><span class="op" id="3297170">,</span>&nbsp;<span class="ident" id="3297172">addrs</span>&nbsp;<span class="op" id="3297178">[</span><span class="op" id="3297179">]</span><span class="ident" id="3297180">dnsRR</span><span class="op" id="3297185">,</span>&nbsp;<span class="ident" id="3297187">err</span>&nbsp;<span class="builtintype" id="3297191">error</span><span class="op" id="3297196">)</span>&nbsp;<span class="op" id="3297198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297201">if</span>&nbsp;<span class="op" id="3297204">!</span><span class="ident" id="3297205">isDomainName</span><span class="op" id="3297217">(</span><span class="ident" id="3297218">name</span><span class="op" id="3297222">)</span>&nbsp;<span class="op" id="3297224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297228">return</span>&nbsp;<span class="ident" id="3297235">name</span><span class="op" id="3297239">,</span>&nbsp;<span class="ident" id="3297241">nil</span><span class="op" id="3297244">,</span>&nbsp;<span class="op" id="3297246">&amp;</span><span class="ident" id="3297247">DNSError</span><span class="op" id="3297255">{</span><span class="ident" id="3297256">Err</span><span class="op" id="3297259">:</span>&nbsp;<span class="string" id="3297261">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="3297282">,</span>&nbsp;<span class="ident" id="3297284">Name</span><span class="op" id="3297288">:</span>&nbsp;<span class="ident" id="3297290">name</span><span class="op" id="3297294">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297300">onceLoadConfig</span><span class="op" id="3297314">.</span><span class="ident" id="3297315">Do</span><span class="op" id="3297317">(</span><span class="ident" id="3297318">loadDefaultConfig</span><span class="op" id="3297335">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297339">select</span>&nbsp;<span class="op" id="3297346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297349">case</span>&nbsp;<span class="ident" id="3297354">cfg</span><span class="op" id="3297357">.</span><span class="ident" id="3297358">ch</span>&nbsp;<span class="op" id="3297361">&lt;-</span>&nbsp;<span class="keyword" id="3297364">struct</span><span class="op" id="3297370">{</span><span class="op" id="3297371">}</span><span class="op" id="3297372">{</span><span class="op" id="3297373">}</span><span class="op" id="3297374">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297377">default</span><span class="op" id="3297384">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297391">cfg</span><span class="op" id="3297394">.</span><span class="ident" id="3297395">mu</span><span class="op" id="3297397">.</span><span class="ident" id="3297398">RLock</span><span class="op" id="3297403">(</span><span class="op" id="3297404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297407">defer</span>&nbsp;<span class="ident" id="3297413">cfg</span><span class="op" id="3297416">.</span><span class="ident" id="3297417">mu</span><span class="op" id="3297419">.</span><span class="ident" id="3297420">RUnlock</span><span class="op" id="3297427">(</span><span class="op" id="3297428">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297432">if</span>&nbsp;<span class="ident" id="3297435">cfg</span><span class="op" id="3297438">.</span><span class="ident" id="3297439">dnserr</span>&nbsp;<span class="op" id="3297446">!=</span>&nbsp;<span class="ident" id="3297449">nil</span>&nbsp;<span class="op" id="3297453">||</span>&nbsp;<span class="ident" id="3297456">cfg</span><span class="op" id="3297459">.</span><span class="ident" id="3297460">dnsConfig</span>&nbsp;<span class="op" id="3297470">==</span>&nbsp;<span class="ident" id="3297473">nil</span>&nbsp;<span class="op" id="3297477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297481">err</span>&nbsp;<span class="op" id="3297485">=</span>&nbsp;<span class="ident" id="3297487">cfg</span><span class="op" id="3297490">.</span><span class="ident" id="3297491">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297500">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297508">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297511">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297568">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297596">rooted</span>&nbsp;<span class="op" id="3297603">:=</span>&nbsp;<span class="builtinfunc" id="3297606">len</span><span class="op" id="3297609">(</span><span class="ident" id="3297610">name</span><span class="op" id="3297614">)</span>&nbsp;<span class="op" id="3297616">&gt;</span>&nbsp;<span class="num" id="3297618">0</span>&nbsp;<span class="op" id="3297620">&amp;&amp;</span>&nbsp;<span class="ident" id="3297623">name</span><span class="op" id="3297627">[</span><span class="builtinfunc" id="3297628">len</span><span class="op" id="3297631">(</span><span class="ident" id="3297632">name</span><span class="op" id="3297636">)</span><span class="op" id="3297637">-</span><span class="num" id="3297638">1</span><span class="op" id="3297639">]</span>&nbsp;<span class="op" id="3297641">==</span>&nbsp;<span class="string" id="3297644">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297649">if</span>&nbsp;<span class="ident" id="3297652">rooted</span>&nbsp;<span class="op" id="3297659">||</span>&nbsp;<span class="ident" id="3297662">count</span><span class="op" id="3297667">(</span><span class="ident" id="3297668">name</span><span class="op" id="3297672">,</span>&nbsp;<span class="string" id="3297674">&#39;.&#39;</span><span class="op" id="3297677">)</span>&nbsp;<span class="op" id="3297679">&gt;=</span>&nbsp;<span class="ident" id="3297682">cfg</span><span class="op" id="3297685">.</span><span class="ident" id="3297686">dnsConfig</span><span class="op" id="3297695">.</span><span class="ident" id="3297696">ndots</span>&nbsp;<span class="op" id="3297702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297706">rname</span>&nbsp;<span class="op" id="3297712">:=</span>&nbsp;<span class="ident" id="3297715">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297722">if</span>&nbsp;<span class="op" id="3297725">!</span><span class="ident" id="3297726">rooted</span>&nbsp;<span class="op" id="3297733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297738">rname</span>&nbsp;<span class="op" id="3297744">+=</span>&nbsp;<span class="string" id="3297747">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297757">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297788">cname</span><span class="op" id="3297793">,</span>&nbsp;<span class="ident" id="3297795">addrs</span><span class="op" id="3297800">,</span>&nbsp;<span class="ident" id="3297802">err</span>&nbsp;<span class="op" id="3297806">=</span>&nbsp;<span class="ident" id="3297808">tryOneName</span><span class="op" id="3297818">(</span><span class="ident" id="3297819">cfg</span><span class="op" id="3297822">.</span><span class="ident" id="3297823">dnsConfig</span><span class="op" id="3297832">,</span>&nbsp;<span class="ident" id="3297834">rname</span><span class="op" id="3297839">,</span>&nbsp;<span class="ident" id="3297841">qtype</span><span class="op" id="3297846">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297850">if</span>&nbsp;<span class="ident" id="3297853">rooted</span>&nbsp;<span class="op" id="3297860">||</span>&nbsp;<span class="ident" id="3297863">err</span>&nbsp;<span class="op" id="3297867">==</span>&nbsp;<span class="ident" id="3297870">nil</span>&nbsp;<span class="op" id="3297874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297879">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3297891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3297895">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3297924">for</span>&nbsp;<span class="ident" id="3297928">i</span>&nbsp;<span class="op" id="3297930">:=</span>&nbsp;<span class="num" id="3297933">0</span><span class="op" id="3297934">;</span>&nbsp;<span class="ident" id="3297936">i</span>&nbsp;<span class="op" id="3297938">&lt;</span>&nbsp;<span class="builtinfunc" id="3297940">len</span><span class="op" id="3297943">(</span><span class="ident" id="3297944">cfg</span><span class="op" id="3297947">.</span><span class="ident" id="3297948">dnsConfig</span><span class="op" id="3297957">.</span><span class="ident" id="3297958">search</span><span class="op" id="3297964">)</span><span class="op" id="3297965">;</span>&nbsp;<span class="ident" id="3297967">i</span><span class="op" id="3297968">++</span>&nbsp;<span class="op" id="3297971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3297975">rname</span>&nbsp;<span class="op" id="3297981">:=</span>&nbsp;<span class="ident" id="3297984">name</span>&nbsp;<span class="op" id="3297989">+</span>&nbsp;<span class="string" id="3297991">&#34;.&#34;</span>&nbsp;<span class="op" id="3297995">+</span>&nbsp;<span class="ident" id="3297997">cfg</span><span class="op" id="3298000">.</span><span class="ident" id="3298001">dnsConfig</span><span class="op" id="3298010">.</span><span class="ident" id="3298011">search</span><span class="op" id="3298017">[</span><span class="ident" id="3298018">i</span><span class="op" id="3298019">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298023">if</span>&nbsp;<span class="ident" id="3298026">rname</span><span class="op" id="3298031">[</span><span class="builtinfunc" id="3298032">len</span><span class="op" id="3298035">(</span><span class="ident" id="3298036">rname</span><span class="op" id="3298041">)</span><span class="op" id="3298042">-</span><span class="num" id="3298043">1</span><span class="op" id="3298044">]</span>&nbsp;<span class="op" id="3298046">!=</span>&nbsp;<span class="string" id="3298049">&#39;.&#39;</span>&nbsp;<span class="op" id="3298053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298058">rname</span>&nbsp;<span class="op" id="3298064">+=</span>&nbsp;<span class="string" id="3298067">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298077">cname</span><span class="op" id="3298082">,</span>&nbsp;<span class="ident" id="3298084">addrs</span><span class="op" id="3298089">,</span>&nbsp;<span class="ident" id="3298091">err</span>&nbsp;<span class="op" id="3298095">=</span>&nbsp;<span class="ident" id="3298097">tryOneName</span><span class="op" id="3298107">(</span><span class="ident" id="3298108">cfg</span><span class="op" id="3298111">.</span><span class="ident" id="3298112">dnsConfig</span><span class="op" id="3298121">,</span>&nbsp;<span class="ident" id="3298123">rname</span><span class="op" id="3298128">,</span>&nbsp;<span class="ident" id="3298130">qtype</span><span class="op" id="3298135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298139">if</span>&nbsp;<span class="ident" id="3298142">err</span>&nbsp;<span class="op" id="3298146">==</span>&nbsp;<span class="ident" id="3298149">nil</span>&nbsp;<span class="op" id="3298153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298158">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298167">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3298174">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3298240">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298302">if</span>&nbsp;<span class="ident" id="3298305">count</span><span class="op" id="3298310">(</span><span class="ident" id="3298311">name</span><span class="op" id="3298315">,</span>&nbsp;<span class="string" id="3298317">&#39;.&#39;</span><span class="op" id="3298320">)</span>&nbsp;<span class="op" id="3298322">&lt;</span>&nbsp;<span class="ident" id="3298324">cfg</span><span class="op" id="3298327">.</span><span class="ident" id="3298328">dnsConfig</span><span class="op" id="3298337">.</span><span class="ident" id="3298338">ndots</span>&nbsp;<span class="op" id="3298344">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298348">cname</span><span class="op" id="3298353">,</span>&nbsp;<span class="ident" id="3298355">addrs</span><span class="op" id="3298360">,</span>&nbsp;<span class="ident" id="3298362">err</span>&nbsp;<span class="op" id="3298366">=</span>&nbsp;<span class="ident" id="3298368">tryOneName</span><span class="op" id="3298378">(</span><span class="ident" id="3298379">cfg</span><span class="op" id="3298382">.</span><span class="ident" id="3298383">dnsConfig</span><span class="op" id="3298392">,</span>&nbsp;<span class="ident" id="3298394">name</span><span class="op" id="3298398">+</span><span class="string" id="3298399">&#34;.&#34;</span><span class="op" id="3298402">,</span>&nbsp;<span class="ident" id="3298404">qtype</span><span class="op" id="3298409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298413">if</span>&nbsp;<span class="ident" id="3298416">err</span>&nbsp;<span class="op" id="3298420">==</span>&nbsp;<span class="ident" id="3298423">nil</span>&nbsp;<span class="op" id="3298427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298432">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298444">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298448">if</span>&nbsp;<span class="ident" id="3298451">e</span><span class="op" id="3298452">,</span>&nbsp;<span class="ident" id="3298454">ok</span>&nbsp;<span class="op" id="3298457">:=</span>&nbsp;<span class="ident" id="3298460">err</span><span class="op" id="3298463">.</span><span class="op" id="3298464">(</span><span class="op" id="3298465">*</span><span class="ident" id="3298466">DNSError</span><span class="op" id="3298474">)</span><span class="op" id="3298475">;</span>&nbsp;<span class="ident" id="3298477">ok</span>&nbsp;<span class="op" id="3298480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3298484">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3298544">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3298603">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3298664">e</span><span class="op" id="3298665">.</span><span class="ident" id="3298666">Name</span>&nbsp;<span class="op" id="3298671">=</span>&nbsp;<span class="ident" id="3298673">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3298679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3298682">return</span><br>
<span class="lineno"></span><span class="op" id="3298689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="3298692">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="3298755">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3298815">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3298879">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3298940">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="3299003">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3299015">func</span>&nbsp;<span class="ident" id="3299020">goLookupHost</span><span class="op" id="3299032">(</span><span class="ident" id="3299033">name</span>&nbsp;<span class="builtintype" id="3299038">string</span><span class="op" id="3299044">)</span>&nbsp;<span class="op" id="3299046">(</span><span class="ident" id="3299047">addrs</span>&nbsp;<span class="op" id="3299053">[</span><span class="op" id="3299054">]</span><span class="builtintype" id="3299055">string</span><span class="op" id="3299061">,</span>&nbsp;<span class="ident" id="3299063">err</span>&nbsp;<span class="builtintype" id="3299067">error</span><span class="op" id="3299072">)</span>&nbsp;<span class="op" id="3299074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3299077">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299124">addrs</span>&nbsp;<span class="op" id="3299130">=</span>&nbsp;<span class="ident" id="3299132">lookupStaticHost</span><span class="op" id="3299148">(</span><span class="ident" id="3299149">name</span><span class="op" id="3299153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299156">if</span>&nbsp;<span class="builtinfunc" id="3299159">len</span><span class="op" id="3299162">(</span><span class="ident" id="3299163">addrs</span><span class="op" id="3299168">)</span>&nbsp;<span class="op" id="3299170">&gt;</span>&nbsp;<span class="num" id="3299172">0</span>&nbsp;<span class="op" id="3299174">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299178">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299189">ips</span><span class="op" id="3299192">,</span>&nbsp;<span class="ident" id="3299194">err</span>&nbsp;<span class="op" id="3299198">:=</span>&nbsp;<span class="ident" id="3299201">goLookupIP</span><span class="op" id="3299211">(</span><span class="ident" id="3299212">name</span><span class="op" id="3299216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299219">if</span>&nbsp;<span class="ident" id="3299222">err</span>&nbsp;<span class="op" id="3299226">!=</span>&nbsp;<span class="ident" id="3299229">nil</span>&nbsp;<span class="op" id="3299233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299237">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299248">addrs</span>&nbsp;<span class="op" id="3299254">=</span>&nbsp;<span class="builtinfunc" id="3299256">make</span><span class="op" id="3299260">(</span><span class="op" id="3299261">[</span><span class="op" id="3299262">]</span><span class="builtintype" id="3299263">string</span><span class="op" id="3299269">,</span>&nbsp;<span class="num" id="3299271">0</span><span class="op" id="3299272">,</span>&nbsp;<span class="builtinfunc" id="3299274">len</span><span class="op" id="3299277">(</span><span class="ident" id="3299278">ips</span><span class="op" id="3299281">)</span><span class="op" id="3299282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299285">for</span>&nbsp;<span class="ident" id="3299289">_</span><span class="op" id="3299290">,</span>&nbsp;<span class="ident" id="3299292">ip</span>&nbsp;<span class="op" id="3299295">:=</span>&nbsp;<span class="keyword" id="3299298">range</span>&nbsp;<span class="ident" id="3299304">ips</span>&nbsp;<span class="op" id="3299308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299312">addrs</span>&nbsp;<span class="op" id="3299318">=</span>&nbsp;<span class="builtinfunc" id="3299320">append</span><span class="op" id="3299326">(</span><span class="ident" id="3299327">addrs</span><span class="op" id="3299332">,</span>&nbsp;<span class="ident" id="3299334">ip</span><span class="op" id="3299336">.</span><span class="ident" id="3299337">String</span><span class="op" id="3299343">(</span><span class="op" id="3299344">)</span><span class="op" id="3299345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299348">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299351">return</span><br>
<span class="lineno"></span><span class="op" id="3299358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3299361">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="3299420">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="3299478">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3299540">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3299601">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3299664">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3299676">func</span>&nbsp;<span class="ident" id="3299681">goLookupIP</span><span class="op" id="3299691">(</span><span class="ident" id="3299692">name</span>&nbsp;<span class="builtintype" id="3299697">string</span><span class="op" id="3299703">)</span>&nbsp;<span class="op" id="3299705">(</span><span class="ident" id="3299706">addrs</span>&nbsp;<span class="op" id="3299712">[</span><span class="op" id="3299713">]</span><span class="ident" id="3299714">IP</span><span class="op" id="3299716">,</span>&nbsp;<span class="ident" id="3299718">err</span>&nbsp;<span class="builtintype" id="3299722">error</span><span class="op" id="3299727">)</span>&nbsp;<span class="op" id="3299729">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3299732">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299777">haddrs</span>&nbsp;<span class="op" id="3299784">:=</span>&nbsp;<span class="ident" id="3299787">lookupStaticHost</span><span class="op" id="3299803">(</span><span class="ident" id="3299804">name</span><span class="op" id="3299808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299811">if</span>&nbsp;<span class="builtinfunc" id="3299814">len</span><span class="op" id="3299817">(</span><span class="ident" id="3299818">haddrs</span><span class="op" id="3299824">)</span>&nbsp;<span class="op" id="3299826">&gt;</span>&nbsp;<span class="num" id="3299828">0</span>&nbsp;<span class="op" id="3299830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299834">for</span>&nbsp;<span class="ident" id="3299838">_</span><span class="op" id="3299839">,</span>&nbsp;<span class="ident" id="3299841">haddr</span>&nbsp;<span class="op" id="3299847">:=</span>&nbsp;<span class="keyword" id="3299850">range</span>&nbsp;<span class="ident" id="3299856">haddrs</span>&nbsp;<span class="op" id="3299863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299868">if</span>&nbsp;<span class="ident" id="3299871">ip</span>&nbsp;<span class="op" id="3299874">:=</span>&nbsp;<span class="ident" id="3299877">ParseIP</span><span class="op" id="3299884">(</span><span class="ident" id="3299885">haddr</span><span class="op" id="3299890">)</span><span class="op" id="3299891">;</span>&nbsp;<span class="ident" id="3299893">ip</span>&nbsp;<span class="op" id="3299896">!=</span>&nbsp;<span class="ident" id="3299899">nil</span>&nbsp;<span class="op" id="3299903">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3299909">addrs</span>&nbsp;<span class="op" id="3299915">=</span>&nbsp;<span class="builtinfunc" id="3299917">append</span><span class="op" id="3299923">(</span><span class="ident" id="3299924">addrs</span><span class="op" id="3299929">,</span>&nbsp;<span class="ident" id="3299931">ip</span><span class="op" id="3299933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299946">if</span>&nbsp;<span class="builtinfunc" id="3299949">len</span><span class="op" id="3299952">(</span><span class="ident" id="3299953">addrs</span><span class="op" id="3299958">)</span>&nbsp;<span class="op" id="3299960">&gt;</span>&nbsp;<span class="num" id="3299962">0</span>&nbsp;<span class="op" id="3299964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299969">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3299981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3299984">type</span>&nbsp;<span class="ident" id="3299989">racer</span>&nbsp;<span class="keyword" id="3299995">struct</span>&nbsp;<span class="op" id="3300002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300006">qtype</span>&nbsp;<span class="builtintype" id="3300012">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300021">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3300027">[</span><span class="op" id="3300028">]</span><span class="ident" id="3300029">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3300037">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300047">lane</span>&nbsp;<span class="op" id="3300052">:=</span>&nbsp;<span class="builtinfunc" id="3300055">make</span><span class="op" id="3300059">(</span><span class="keyword" id="3300060">chan</span>&nbsp;<span class="ident" id="3300065">racer</span><span class="op" id="3300070">,</span>&nbsp;<span class="num" id="3300072">1</span><span class="op" id="3300073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300076">qtypes</span>&nbsp;<span class="op" id="3300083">:=</span>&nbsp;<span class="op" id="3300086">[</span><span class="op" id="3300087">...</span><span class="op" id="3300090">]</span><span class="builtintype" id="3300091">uint16</span><span class="op" id="3300097">{</span><span class="ident" id="3300098">dnsTypeA</span><span class="op" id="3300106">,</span>&nbsp;<span class="ident" id="3300108">dnsTypeAAAA</span><span class="op" id="3300119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300122">for</span>&nbsp;<span class="ident" id="3300126">_</span><span class="op" id="3300127">,</span>&nbsp;<span class="ident" id="3300129">qtype</span>&nbsp;<span class="op" id="3300135">:=</span>&nbsp;<span class="keyword" id="3300138">range</span>&nbsp;<span class="ident" id="3300144">qtypes</span>&nbsp;<span class="op" id="3300151">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300155">go</span>&nbsp;<span class="keyword" id="3300158">func</span><span class="op" id="3300162">(</span><span class="ident" id="3300163">qtype</span>&nbsp;<span class="builtintype" id="3300169">uint16</span><span class="op" id="3300175">)</span>&nbsp;<span class="op" id="3300177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300182">_</span><span class="op" id="3300183">,</span>&nbsp;<span class="ident" id="3300185">rrs</span><span class="op" id="3300188">,</span>&nbsp;<span class="ident" id="3300190">err</span>&nbsp;<span class="op" id="3300194">:=</span>&nbsp;<span class="ident" id="3300197">lookup</span><span class="op" id="3300203">(</span><span class="ident" id="3300204">name</span><span class="op" id="3300208">,</span>&nbsp;<span class="ident" id="3300210">qtype</span><span class="op" id="3300215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300220">lane</span>&nbsp;<span class="op" id="3300225">&lt;-</span>&nbsp;<span class="ident" id="3300228">racer</span><span class="op" id="3300233">{</span><span class="ident" id="3300234">qtype</span><span class="op" id="3300239">,</span>&nbsp;<span class="ident" id="3300241">rrs</span><span class="op" id="3300244">,</span>&nbsp;<span class="ident" id="3300246">err</span><span class="op" id="3300249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300253">}</span><span class="op" id="3300254">(</span><span class="ident" id="3300255">qtype</span><span class="op" id="3300260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300263">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300266">var</span>&nbsp;<span class="ident" id="3300270">lastErr</span>&nbsp;<span class="builtintype" id="3300278">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300285">for</span>&nbsp;<span class="keyword" id="3300289">range</span>&nbsp;<span class="ident" id="3300295">qtypes</span>&nbsp;<span class="op" id="3300302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300306">racer</span>&nbsp;<span class="op" id="3300312">:=</span>&nbsp;<span class="op" id="3300315">&lt;-</span><span class="ident" id="3300317">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300324">if</span>&nbsp;<span class="ident" id="3300327">racer</span><span class="op" id="3300332">.</span><span class="builtintype" id="3300333">error</span>&nbsp;<span class="op" id="3300339">!=</span>&nbsp;<span class="ident" id="3300342">nil</span>&nbsp;<span class="op" id="3300346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300351">lastErr</span>&nbsp;<span class="op" id="3300359">=</span>&nbsp;<span class="ident" id="3300361">racer</span><span class="op" id="3300366">.</span><span class="builtintype" id="3300367">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300376">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300391">switch</span>&nbsp;<span class="ident" id="3300398">racer</span><span class="op" id="3300403">.</span><span class="ident" id="3300404">qtype</span>&nbsp;<span class="op" id="3300410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300414">case</span>&nbsp;<span class="ident" id="3300419">dnsTypeA</span><span class="op" id="3300427">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300432">addrs</span>&nbsp;<span class="op" id="3300438">=</span>&nbsp;<span class="builtinfunc" id="3300440">append</span><span class="op" id="3300446">(</span><span class="ident" id="3300447">addrs</span><span class="op" id="3300452">,</span>&nbsp;<span class="ident" id="3300454">convertRR_A</span><span class="op" id="3300465">(</span><span class="ident" id="3300466">racer</span><span class="op" id="3300471">.</span><span class="ident" id="3300472">rrs</span><span class="op" id="3300475">)</span><span class="op" id="3300476">...</span><span class="op" id="3300479">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300483">case</span>&nbsp;<span class="ident" id="3300488">dnsTypeAAAA</span><span class="op" id="3300499">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3300504">addrs</span>&nbsp;<span class="op" id="3300510">=</span>&nbsp;<span class="builtinfunc" id="3300512">append</span><span class="op" id="3300518">(</span><span class="ident" id="3300519">addrs</span><span class="op" id="3300524">,</span>&nbsp;<span class="ident" id="3300526">convertRR_AAAA</span><span class="op" id="3300540">(</span><span class="ident" id="3300541">racer</span><span class="op" id="3300546">.</span><span class="ident" id="3300547">rrs</span><span class="op" id="3300550">)</span><span class="op" id="3300551">...</span><span class="op" id="3300554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300564">if</span>&nbsp;<span class="builtinfunc" id="3300567">len</span><span class="op" id="3300570">(</span><span class="ident" id="3300571">addrs</span><span class="op" id="3300576">)</span>&nbsp;<span class="op" id="3300578">==</span>&nbsp;<span class="num" id="3300581">0</span>&nbsp;<span class="op" id="3300583">&amp;&amp;</span>&nbsp;<span class="ident" id="3300586">lastErr</span>&nbsp;<span class="op" id="3300594">!=</span>&nbsp;<span class="ident" id="3300597">nil</span>&nbsp;<span class="op" id="3300601">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300605">return</span>&nbsp;<span class="ident" id="3300612">nil</span><span class="op" id="3300615">,</span>&nbsp;<span class="ident" id="3300617">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3300626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3300629">return</span>&nbsp;<span class="ident" id="3300636">addrs</span><span class="op" id="3300641">,</span>&nbsp;<span class="ident" id="3300643">nil</span><br>
<span class="lineno"></span><span class="op" id="3300647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="3300650">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="3300715">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3300776">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="3300841">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3300902">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="3300965">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="3300977">func</span>&nbsp;<span class="ident" id="3300982">goLookupCNAME</span><span class="op" id="3300995">(</span><span class="ident" id="3300996">name</span>&nbsp;<span class="builtintype" id="3301001">string</span><span class="op" id="3301007">)</span>&nbsp;<span class="op" id="3301009">(</span><span class="ident" id="3301010">cname</span>&nbsp;<span class="builtintype" id="3301016">string</span><span class="op" id="3301022">,</span>&nbsp;<span class="ident" id="3301024">err</span>&nbsp;<span class="builtintype" id="3301028">error</span><span class="op" id="3301033">)</span>&nbsp;<span class="op" id="3301035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301038">_</span><span class="op" id="3301039">,</span>&nbsp;<span class="ident" id="3301041">rr</span><span class="op" id="3301043">,</span>&nbsp;<span class="ident" id="3301045">err</span>&nbsp;<span class="op" id="3301049">:=</span>&nbsp;<span class="ident" id="3301052">lookup</span><span class="op" id="3301058">(</span><span class="ident" id="3301059">name</span><span class="op" id="3301063">,</span>&nbsp;<span class="ident" id="3301065">dnsTypeCNAME</span><span class="op" id="3301077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301080">if</span>&nbsp;<span class="ident" id="3301083">err</span>&nbsp;<span class="op" id="3301087">!=</span>&nbsp;<span class="ident" id="3301090">nil</span>&nbsp;<span class="op" id="3301094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301098">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3301106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3301109">cname</span>&nbsp;<span class="op" id="3301115">=</span>&nbsp;<span class="ident" id="3301117">rr</span><span class="op" id="3301119">[</span><span class="num" id="3301120">0</span><span class="op" id="3301121">]</span><span class="op" id="3301122">.</span><span class="op" id="3301123">(</span><span class="op" id="3301124">*</span><span class="ident" id="3301125">dnsRR_CNAME</span><span class="op" id="3301136">)</span><span class="op" id="3301137">.</span><span class="ident" id="3301138">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3301145">return</span><br>
<span class="lineno"></span><span class="op" id="3301152">}</span>
</div>
</body>
</html>
