<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html" class="current">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6408165">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6408220">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6408274">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6408325">package</span>&nbsp;<span class="ident" id="6408333">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6408338">import</span>&nbsp;<span class="op" id="6408345">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408348">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408357">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408365">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408372">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408378">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408384">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408395">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408406">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408416">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408427">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408438">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408446">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6408457">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6408464">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6408467">func</span>&nbsp;<span class="ident" id="6408472">newLocalListener</span><span class="op" id="6408488">(</span><span class="ident" id="6408489">t</span>&nbsp;<span class="op" id="6408491">*</span><span class="ident" id="6408492">testing</span><span class="op" id="6408499">.</span><span class="ident" id="6408500">T</span><span class="op" id="6408501">)</span>&nbsp;<span class="ident" id="6408503">Listener</span>&nbsp;<span class="op" id="6408512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6408515">ln</span><span class="op" id="6408517">,</span>&nbsp;<span class="ident" id="6408519">err</span>&nbsp;<span class="op" id="6408523">:=</span>&nbsp;<span class="ident" id="6408526">Listen</span><span class="op" id="6408532">(</span><span class="string" id="6408533">&#34;tcp&#34;</span><span class="op" id="6408538">,</span>&nbsp;<span class="string" id="6408540">&#34;127.0.0.1:0&#34;</span><span class="op" id="6408553">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6408556">if</span>&nbsp;<span class="ident" id="6408559">err</span>&nbsp;<span class="op" id="6408563">!=</span>&nbsp;<span class="builtintype" id="6408566">nil</span>&nbsp;<span class="op" id="6408570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6408574">ln</span><span class="op" id="6408576">,</span>&nbsp;<span class="ident" id="6408578">err</span>&nbsp;<span class="op" id="6408582">=</span>&nbsp;<span class="ident" id="6408584">Listen</span><span class="op" id="6408590">(</span><span class="string" id="6408591">&#34;tcp6&#34;</span><span class="op" id="6408597">,</span>&nbsp;<span class="string" id="6408599">&#34;[::1]:0&#34;</span><span class="op" id="6408608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6408611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6408614">if</span>&nbsp;<span class="ident" id="6408617">err</span>&nbsp;<span class="op" id="6408621">!=</span>&nbsp;<span class="builtintype" id="6408624">nil</span>&nbsp;<span class="op" id="6408628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6408632">t</span><span class="op" id="6408633">.</span><span class="ident" id="6408634">Fatal</span><span class="op" id="6408639">(</span><span class="ident" id="6408640">err</span><span class="op" id="6408643">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6408646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6408649">return</span>&nbsp;<span class="ident" id="6408656">ln</span><br>
<span class="lineno"></span><span class="op" id="6408659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6408662">func</span>&nbsp;<span class="ident" id="6408667">TestDialTimeout</span><span class="op" id="6408682">(</span><span class="ident" id="6408683">t</span>&nbsp;<span class="op" id="6408685">*</span><span class="ident" id="6408686">testing</span><span class="op" id="6408693">.</span><span class="ident" id="6408694">T</span><span class="op" id="6408695">)</span>&nbsp;<span class="op" id="6408697">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6408700">origBacklog</span>&nbsp;<span class="op" id="6408712">:=</span>&nbsp;<span class="ident" id="6408715">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6408732">defer</span>&nbsp;<span class="keyword" id="6408738">func</span><span class="op" id="6408742">(</span><span class="op" id="6408743">)</span>&nbsp;<span class="op" id="6408745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6408749">listenerBacklog</span>&nbsp;<span class="op" id="6408765">=</span>&nbsp;<span class="ident" id="6408767">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6408780">}</span><span class="op" id="6408781">(</span><span class="op" id="6408782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6408785">listenerBacklog</span>&nbsp;<span class="op" id="6408801">=</span>&nbsp;<span class="num" id="6408803">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6408807">ln</span>&nbsp;<span class="op" id="6408810">:=</span>&nbsp;<span class="ident" id="6408813">newLocalListener</span><span class="op" id="6408829">(</span><span class="ident" id="6408830">t</span><span class="op" id="6408831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6408834">defer</span>&nbsp;<span class="ident" id="6408840">ln</span><span class="op" id="6408842">.</span><span class="ident" id="6408843">Close</span><span class="op" id="6408848">(</span><span class="op" id="6408849">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6408853">errc</span>&nbsp;<span class="op" id="6408858">:=</span>&nbsp;<span class="builtinfunc" id="6408861">make</span><span class="op" id="6408865">(</span><span class="keyword" id="6408866">chan</span>&nbsp;<span class="builtintype" id="6408871">error</span><span class="op" id="6408876">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6408880">numConns</span>&nbsp;<span class="op" id="6408889">:=</span>&nbsp;<span class="ident" id="6408892">listenerBacklog</span>&nbsp;<span class="op" id="6408908">+</span>&nbsp;<span class="num" id="6408910">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6408916">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6408973">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6409022">switch</span>&nbsp;<span class="ident" id="6409029">runtime</span><span class="op" id="6409036">.</span><span class="ident" id="6409037">GOOS</span>&nbsp;<span class="op" id="6409042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6409045">case</span>&nbsp;<span class="string" id="6409050">&#34;linux&#34;</span><span class="op" id="6409057">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409061">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409131">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409201">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6409271">for</span>&nbsp;<span class="ident" id="6409275">i</span>&nbsp;<span class="op" id="6409277">:=</span>&nbsp;<span class="num" id="6409280">0</span><span class="op" id="6409281">;</span>&nbsp;<span class="ident" id="6409283">i</span>&nbsp;<span class="op" id="6409285">&lt;</span>&nbsp;<span class="ident" id="6409287">numConns</span><span class="op" id="6409295">;</span>&nbsp;<span class="ident" id="6409297">i</span><span class="op" id="6409298">++</span>&nbsp;<span class="op" id="6409301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6409306">go</span>&nbsp;<span class="keyword" id="6409309">func</span><span class="op" id="6409313">(</span><span class="op" id="6409314">)</span>&nbsp;<span class="op" id="6409316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6409322">_</span><span class="op" id="6409323">,</span>&nbsp;<span class="ident" id="6409325">err</span>&nbsp;<span class="op" id="6409329">:=</span>&nbsp;<span class="ident" id="6409332">DialTimeout</span><span class="op" id="6409343">(</span><span class="string" id="6409344">&#34;tcp&#34;</span><span class="op" id="6409349">,</span>&nbsp;<span class="ident" id="6409351">ln</span><span class="op" id="6409353">.</span><span class="ident" id="6409354">Addr</span><span class="op" id="6409358">(</span><span class="op" id="6409359">)</span><span class="op" id="6409360">.</span><span class="ident" id="6409361">String</span><span class="op" id="6409367">(</span><span class="op" id="6409368">)</span><span class="op" id="6409369">,</span>&nbsp;<span class="num" id="6409371">200</span><span class="op" id="6409374">*</span><span class="ident" id="6409375">time</span><span class="op" id="6409379">.</span><span class="ident" id="6409380">Millisecond</span><span class="op" id="6409391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6409397">errc</span>&nbsp;<span class="op" id="6409402">&lt;-</span>&nbsp;<span class="ident" id="6409405">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6409412">}</span><span class="op" id="6409413">(</span><span class="op" id="6409414">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6409418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6409421">case</span>&nbsp;<span class="string" id="6409426">&#34;darwin&#34;</span><span class="op" id="6409434">,</span>&nbsp;<span class="string" id="6409436">&#34;plan9&#34;</span><span class="op" id="6409443">,</span>&nbsp;<span class="string" id="6409445">&#34;windows&#34;</span><span class="op" id="6409454">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409458">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409512">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409567">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409621">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409644">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409649">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409711">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409767">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409821">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409881">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409886">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6409953">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6410050">go</span>&nbsp;<span class="keyword" id="6410053">func</span><span class="op" id="6410057">(</span><span class="op" id="6410058">)</span>&nbsp;<span class="op" id="6410060">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410065">c</span><span class="op" id="6410066">,</span>&nbsp;<span class="ident" id="6410068">err</span>&nbsp;<span class="op" id="6410072">:=</span>&nbsp;<span class="ident" id="6410075">DialTimeout</span><span class="op" id="6410086">(</span><span class="string" id="6410087">&#34;tcp&#34;</span><span class="op" id="6410092">,</span>&nbsp;<span class="string" id="6410094">&#34;127.0.71.111:49151&#34;</span><span class="op" id="6410114">,</span>&nbsp;<span class="num" id="6410116">200</span><span class="op" id="6410119">*</span><span class="ident" id="6410120">time</span><span class="op" id="6410124">.</span><span class="ident" id="6410125">Millisecond</span><span class="op" id="6410136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6410141">if</span>&nbsp;<span class="ident" id="6410144">err</span>&nbsp;<span class="op" id="6410148">==</span>&nbsp;<span class="builtintype" id="6410151">nil</span>&nbsp;<span class="op" id="6410155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410161">err</span>&nbsp;<span class="op" id="6410165">=</span>&nbsp;<span class="ident" id="6410167">fmt</span><span class="op" id="6410170">.</span><span class="ident" id="6410171">Errorf</span><span class="op" id="6410177">(</span><span class="string" id="6410178">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="6410208">,</span>&nbsp;<span class="ident" id="6410210">c</span><span class="op" id="6410211">.</span><span class="ident" id="6410212">RemoteAddr</span><span class="op" id="6410222">(</span><span class="op" id="6410223">)</span><span class="op" id="6410224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410230">c</span><span class="op" id="6410231">.</span><span class="ident" id="6410232">Close</span><span class="op" id="6410237">(</span><span class="op" id="6410238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6410243">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410248">errc</span>&nbsp;<span class="op" id="6410253">&lt;-</span>&nbsp;<span class="ident" id="6410256">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6410262">}</span><span class="op" id="6410263">(</span><span class="op" id="6410264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6410267">default</span><span class="op" id="6410274">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6410278">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6410299">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6410365">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6410421">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6410437">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410499">t</span><span class="op" id="6410500">.</span><span class="ident" id="6410501">Skipf</span><span class="op" id="6410506">(</span><span class="string" id="6410507">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="6410539">,</span>&nbsp;<span class="ident" id="6410541">runtime</span><span class="op" id="6410548">.</span><span class="ident" id="6410549">GOOS</span><span class="op" id="6410553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6410556">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410560">connected</span>&nbsp;<span class="op" id="6410570">:=</span>&nbsp;<span class="num" id="6410573">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6410576">for</span>&nbsp;<span class="op" id="6410580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6410584">select</span>&nbsp;<span class="op" id="6410591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6410595">case</span>&nbsp;<span class="op" id="6410600">&lt;-</span><span class="ident" id="6410602">time</span><span class="op" id="6410606">.</span><span class="ident" id="6410607">After</span><span class="op" id="6410612">(</span><span class="num" id="6410613">15</span>&nbsp;<span class="op" id="6410616">*</span>&nbsp;<span class="ident" id="6410618">time</span><span class="op" id="6410622">.</span><span class="ident" id="6410623">Second</span><span class="op" id="6410629">)</span><span class="op" id="6410630">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410635">t</span><span class="op" id="6410636">.</span><span class="ident" id="6410637">Fatal</span><span class="op" id="6410642">(</span><span class="string" id="6410643">&#34;too&nbsp;slow&#34;</span><span class="op" id="6410653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6410657">case</span>&nbsp;<span class="ident" id="6410662">err</span>&nbsp;<span class="op" id="6410666">:=</span>&nbsp;<span class="op" id="6410669">&lt;-</span><span class="ident" id="6410671">errc</span><span class="op" id="6410675">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6410680">if</span>&nbsp;<span class="ident" id="6410683">err</span>&nbsp;<span class="op" id="6410687">==</span>&nbsp;<span class="builtintype" id="6410690">nil</span>&nbsp;<span class="op" id="6410694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410700">connected</span><span class="op" id="6410709">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6410716">if</span>&nbsp;<span class="ident" id="6410719">connected</span>&nbsp;<span class="op" id="6410729">==</span>&nbsp;<span class="ident" id="6410732">numConns</span>&nbsp;<span class="op" id="6410741">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410748">t</span><span class="op" id="6410749">.</span><span class="ident" id="6410750">Fatal</span><span class="op" id="6410755">(</span><span class="string" id="6410756">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="6410810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6410816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6410821">}</span>&nbsp;<span class="keyword" id="6410823">else</span>&nbsp;<span class="op" id="6410828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410834">terr</span><span class="op" id="6410838">,</span>&nbsp;<span class="ident" id="6410840">ok</span>&nbsp;<span class="op" id="6410843">:=</span>&nbsp;<span class="ident" id="6410846">err</span><span class="op" id="6410849">.</span><span class="op" id="6410850">(</span><span class="ident" id="6410851">timeout</span><span class="op" id="6410858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6410864">if</span>&nbsp;<span class="op" id="6410867">!</span><span class="ident" id="6410868">ok</span>&nbsp;<span class="op" id="6410871">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410878">t</span><span class="op" id="6410879">.</span><span class="ident" id="6410880">Fatalf</span><span class="op" id="6410886">(</span><span class="string" id="6410887">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="6410936">,</span>&nbsp;<span class="ident" id="6410938">err</span><span class="op" id="6410941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6410947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6410953">if</span>&nbsp;<span class="op" id="6410956">!</span><span class="ident" id="6410957">terr</span><span class="op" id="6410961">.</span><span class="ident" id="6410962">Timeout</span><span class="op" id="6410969">(</span><span class="op" id="6410970">)</span>&nbsp;<span class="op" id="6410972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6410979">t</span><span class="op" id="6410980">.</span><span class="ident" id="6410981">Fatalf</span><span class="op" id="6410987">(</span><span class="string" id="6410988">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="6411017">,</span>&nbsp;<span class="ident" id="6411019">err</span><span class="op" id="6411022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6411028">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6411034">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6411071">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6411081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6411085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6411088">}</span><br>
<span class="lineno">115</span><span class="op" id="6411090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6411093">func</span>&nbsp;<span class="ident" id="6411098">TestSelfConnect</span><span class="op" id="6411113">(</span><span class="ident" id="6411114">t</span>&nbsp;<span class="op" id="6411116">*</span><span class="ident" id="6411117">testing</span><span class="op" id="6411124">.</span><span class="ident" id="6411125">T</span><span class="op" id="6411126">)</span>&nbsp;<span class="op" id="6411128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6411131">if</span>&nbsp;<span class="ident" id="6411134">runtime</span><span class="op" id="6411141">.</span><span class="ident" id="6411142">GOOS</span>&nbsp;<span class="op" id="6411147">==</span>&nbsp;<span class="string" id="6411150">&#34;windows&#34;</span>&nbsp;<span class="op" id="6411160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6411164">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411211">t</span><span class="op" id="6411212">.</span><span class="ident" id="6411213">Skip</span><span class="op" id="6411217">(</span><span class="string" id="6411218">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="6411257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6411260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6411264">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6411313">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6411346">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411401">l</span><span class="op" id="6411402">,</span>&nbsp;<span class="ident" id="6411404">err</span>&nbsp;<span class="op" id="6411408">:=</span>&nbsp;<span class="ident" id="6411411">Listen</span><span class="op" id="6411417">(</span><span class="string" id="6411418">&#34;tcp&#34;</span><span class="op" id="6411423">,</span>&nbsp;<span class="string" id="6411425">&#34;127.0.0.1:0&#34;</span><span class="op" id="6411438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6411441">if</span>&nbsp;<span class="ident" id="6411444">err</span>&nbsp;<span class="op" id="6411448">!=</span>&nbsp;<span class="builtintype" id="6411451">nil</span>&nbsp;<span class="op" id="6411455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411459">t</span><span class="op" id="6411460">.</span><span class="ident" id="6411461">Fatal</span><span class="op" id="6411466">(</span><span class="ident" id="6411467">err</span><span class="op" id="6411470">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6411473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411476">c</span><span class="op" id="6411477">,</span>&nbsp;<span class="ident" id="6411479">err</span>&nbsp;<span class="op" id="6411483">:=</span>&nbsp;<span class="ident" id="6411486">Dial</span><span class="op" id="6411490">(</span><span class="string" id="6411491">&#34;tcp&#34;</span><span class="op" id="6411496">,</span>&nbsp;<span class="ident" id="6411498">l</span><span class="op" id="6411499">.</span><span class="ident" id="6411500">Addr</span><span class="op" id="6411504">(</span><span class="op" id="6411505">)</span><span class="op" id="6411506">.</span><span class="ident" id="6411507">String</span><span class="op" id="6411513">(</span><span class="op" id="6411514">)</span><span class="op" id="6411515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6411518">if</span>&nbsp;<span class="ident" id="6411521">err</span>&nbsp;<span class="op" id="6411525">!=</span>&nbsp;<span class="builtintype" id="6411528">nil</span>&nbsp;<span class="op" id="6411532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411536">t</span><span class="op" id="6411537">.</span><span class="ident" id="6411538">Fatal</span><span class="op" id="6411543">(</span><span class="ident" id="6411544">err</span><span class="op" id="6411547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6411550">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411553">addr</span>&nbsp;<span class="op" id="6411558">:=</span>&nbsp;<span class="ident" id="6411561">c</span><span class="op" id="6411562">.</span><span class="ident" id="6411563">LocalAddr</span><span class="op" id="6411572">(</span><span class="op" id="6411573">)</span><span class="op" id="6411574">.</span><span class="ident" id="6411575">String</span><span class="op" id="6411581">(</span><span class="op" id="6411582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411585">c</span><span class="op" id="6411586">.</span><span class="ident" id="6411587">Close</span><span class="op" id="6411592">(</span><span class="op" id="6411593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411596">l</span><span class="op" id="6411597">.</span><span class="ident" id="6411598">Close</span><span class="op" id="6411603">(</span><span class="op" id="6411604">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6411608">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411655">n</span>&nbsp;<span class="op" id="6411657">:=</span>&nbsp;<span class="num" id="6411660">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6411668">if</span>&nbsp;<span class="ident" id="6411671">testing</span><span class="op" id="6411678">.</span><span class="ident" id="6411679">Short</span><span class="op" id="6411684">(</span><span class="op" id="6411685">)</span>&nbsp;<span class="op" id="6411687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411691">n</span>&nbsp;<span class="op" id="6411693">=</span>&nbsp;<span class="num" id="6411695">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6411701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6411704">switch</span>&nbsp;<span class="ident" id="6411711">runtime</span><span class="op" id="6411718">.</span><span class="ident" id="6411719">GOOS</span>&nbsp;<span class="op" id="6411724">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6411727">case</span>&nbsp;<span class="string" id="6411732">&#34;darwin&#34;</span><span class="op" id="6411740">,</span>&nbsp;<span class="string" id="6411742">&#34;dragonfly&#34;</span><span class="op" id="6411753">,</span>&nbsp;<span class="string" id="6411755">&#34;freebsd&#34;</span><span class="op" id="6411764">,</span>&nbsp;<span class="string" id="6411766">&#34;netbsd&#34;</span><span class="op" id="6411774">,</span>&nbsp;<span class="string" id="6411776">&#34;openbsd&#34;</span><span class="op" id="6411785">,</span>&nbsp;<span class="string" id="6411787">&#34;plan9&#34;</span><span class="op" id="6411794">,</span>&nbsp;<span class="string" id="6411796">&#34;solaris&#34;</span><span class="op" id="6411805">,</span>&nbsp;<span class="string" id="6411807">&#34;windows&#34;</span><span class="op" id="6411816">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6411820">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6411870">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411925">n</span>&nbsp;<span class="op" id="6411927">=</span>&nbsp;<span class="num" id="6411929">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6411934">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6411937">for</span>&nbsp;<span class="ident" id="6411941">i</span>&nbsp;<span class="op" id="6411943">:=</span>&nbsp;<span class="num" id="6411946">0</span><span class="op" id="6411947">;</span>&nbsp;<span class="ident" id="6411949">i</span>&nbsp;<span class="op" id="6411951">&lt;</span>&nbsp;<span class="ident" id="6411953">n</span><span class="op" id="6411954">;</span>&nbsp;<span class="ident" id="6411956">i</span><span class="op" id="6411957">++</span>&nbsp;<span class="op" id="6411960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6411964">c</span><span class="op" id="6411965">,</span>&nbsp;<span class="ident" id="6411967">err</span>&nbsp;<span class="op" id="6411971">:=</span>&nbsp;<span class="ident" id="6411974">DialTimeout</span><span class="op" id="6411985">(</span><span class="string" id="6411986">&#34;tcp&#34;</span><span class="op" id="6411991">,</span>&nbsp;<span class="ident" id="6411993">addr</span><span class="op" id="6411997">,</span>&nbsp;<span class="ident" id="6411999">time</span><span class="op" id="6412003">.</span><span class="ident" id="6412004">Millisecond</span><span class="op" id="6412015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6412019">if</span>&nbsp;<span class="ident" id="6412022">err</span>&nbsp;<span class="op" id="6412026">==</span>&nbsp;<span class="builtintype" id="6412029">nil</span>&nbsp;<span class="op" id="6412033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6412038">if</span>&nbsp;<span class="ident" id="6412041">c</span><span class="op" id="6412042">.</span><span class="ident" id="6412043">LocalAddr</span><span class="op" id="6412052">(</span><span class="op" id="6412053">)</span><span class="op" id="6412054">.</span><span class="ident" id="6412055">String</span><span class="op" id="6412061">(</span><span class="op" id="6412062">)</span>&nbsp;<span class="op" id="6412064">==</span>&nbsp;<span class="ident" id="6412067">addr</span>&nbsp;<span class="op" id="6412072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6412078">t</span><span class="op" id="6412079">.</span><span class="ident" id="6412080">Errorf</span><span class="op" id="6412086">(</span><span class="string" id="6412087">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="6412114">,</span>&nbsp;<span class="ident" id="6412116">i</span><span class="op" id="6412117">,</span>&nbsp;<span class="ident" id="6412119">addr</span><span class="op" id="6412123">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412128">}</span>&nbsp;<span class="keyword" id="6412130">else</span>&nbsp;<span class="op" id="6412135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6412141">t</span><span class="op" id="6412142">.</span><span class="ident" id="6412143">Logf</span><span class="op" id="6412147">(</span><span class="string" id="6412148">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="6412210">,</span>&nbsp;<span class="ident" id="6412212">i</span><span class="op" id="6412213">,</span>&nbsp;<span class="ident" id="6412215">addr</span><span class="op" id="6412219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6412229">c</span><span class="op" id="6412230">.</span><span class="ident" id="6412231">Close</span><span class="op" id="6412236">(</span><span class="op" id="6412237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412241">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412244">}</span><br>
<span class="lineno"></span><span class="op" id="6412246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6412249">var</span>&nbsp;<span class="ident" id="6412253">runErrorTest</span>&nbsp;<span class="op" id="6412266">=</span>&nbsp;<span class="ident" id="6412268">flag</span><span class="op" id="6412272">.</span><span class="ident" id="6412273">Bool</span><span class="op" id="6412277">(</span><span class="string" id="6412278">&#34;run_error_test&#34;</span><span class="op" id="6412294">,</span>&nbsp;<span class="builtintype" id="6412296">false</span><span class="op" id="6412301">,</span>&nbsp;<span class="string" id="6412303">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="6412343">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6412346">type</span>&nbsp;<span class="ident" id="6412351">DialErrorTest</span>&nbsp;<span class="keyword" id="6412365">struct</span>&nbsp;<span class="op" id="6412372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6412375">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6412383">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6412391">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6412399">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6412407">Pattern</span>&nbsp;<span class="builtintype" id="6412415">string</span><br>
<span class="lineno"></span><span class="op" id="6412422">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="6412425">var</span>&nbsp;<span class="ident" id="6412429">dialErrorTests</span>&nbsp;<span class="op" id="6412444">=</span>&nbsp;<span class="op" id="6412446">[</span><span class="op" id="6412447">]</span><span class="ident" id="6412448">DialErrorTest</span><span class="op" id="6412461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6412468">&#34;datakit&#34;</span><span class="op" id="6412477">,</span>&nbsp;<span class="string" id="6412479">&#34;mh/astro/r70&#34;</span><span class="op" id="6412493">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6412497">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="6412549">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412552">}</span><span class="op" id="6412553">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6412560">&#34;tcp&#34;</span><span class="op" id="6412565">,</span>&nbsp;<span class="string" id="6412567">&#34;127.0.0.1:☺&#34;</span><span class="op" id="6412582">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6412586">&#34;dial&nbsp;tcp&nbsp;127.0.0.1:☺:&nbsp;unknown&nbsp;port&nbsp;tcp/☺&#34;</span><span class="op" id="6412632">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412635">}</span><span class="op" id="6412636">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6412643">&#34;tcp&#34;</span><span class="op" id="6412648">,</span>&nbsp;<span class="string" id="6412650">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="6412679">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6412683">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="6412772">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412775">}</span><span class="op" id="6412776">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412779">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6412783">&#34;tcp&#34;</span><span class="op" id="6412788">,</span>&nbsp;<span class="string" id="6412790">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="6412833">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6412837">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="6412954">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412957">}</span><span class="op" id="6412958">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6412961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6412965">&#34;tcp&#34;</span><span class="op" id="6412970">,</span>&nbsp;<span class="string" id="6412972">&#34;no-such-name:80&#34;</span><span class="op" id="6412989">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6412993">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="6413067">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413070">}</span><span class="op" id="6413071">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6413078">&#34;tcp&#34;</span><span class="op" id="6413083">,</span>&nbsp;<span class="string" id="6413085">&#34;mh/astro/r70:http&#34;</span><span class="op" id="6413104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6413108">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="6413178">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413181">}</span><span class="op" id="6413182">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6413189">&#34;unix&#34;</span><span class="op" id="6413195">,</span>&nbsp;<span class="string" id="6413197">&#34;/etc/file-not-found&#34;</span><span class="op" id="6413218">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6413222">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="6413280">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413283">}</span><span class="op" id="6413284">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6413291">&#34;unix&#34;</span><span class="op" id="6413297">,</span>&nbsp;<span class="string" id="6413299">&#34;/etc/&#34;</span><span class="op" id="6413306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6413310">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="6413398">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413401">}</span><span class="op" id="6413402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413405">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6413409">&#34;unixpacket&#34;</span><span class="op" id="6413421">,</span>&nbsp;<span class="string" id="6413423">&#34;/etc/file-not-found&#34;</span><span class="op" id="6413444">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6413448">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="6413512">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413515">}</span><span class="op" id="6413516">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6413523">&#34;unixpacket&#34;</span><span class="op" id="6413535">,</span>&nbsp;<span class="string" id="6413537">&#34;/etc/&#34;</span><span class="op" id="6413544">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6413548">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="6413642">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413645">}</span><span class="op" id="6413646">,</span><br>
<span class="lineno"></span><span class="op" id="6413648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6413651">var</span>&nbsp;<span class="ident" id="6413655">duplicateErrorPattern</span>&nbsp;<span class="op" id="6413677">=</span>&nbsp;<span class="string" id="6413679">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6413702">func</span>&nbsp;<span class="ident" id="6413707">TestDialError</span><span class="op" id="6413720">(</span><span class="ident" id="6413721">t</span>&nbsp;<span class="op" id="6413723">*</span><span class="ident" id="6413724">testing</span><span class="op" id="6413731">.</span><span class="ident" id="6413732">T</span><span class="op" id="6413733">)</span>&nbsp;<span class="op" id="6413735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6413738">if</span>&nbsp;<span class="op" id="6413741">!</span><span class="op" id="6413742">*</span><span class="ident" id="6413743">runErrorTest</span>&nbsp;<span class="op" id="6413756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6413760">t</span><span class="op" id="6413761">.</span><span class="ident" id="6413762">Logf</span><span class="op" id="6413766">(</span><span class="string" id="6413767">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="6413813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6413817">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6413828">for</span>&nbsp;<span class="ident" id="6413832">i</span><span class="op" id="6413833">,</span>&nbsp;<span class="ident" id="6413835">tt</span>&nbsp;<span class="op" id="6413838">:=</span>&nbsp;<span class="keyword" id="6413841">range</span>&nbsp;<span class="ident" id="6413847">dialErrorTests</span>&nbsp;<span class="op" id="6413862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6413866">c</span><span class="op" id="6413867">,</span>&nbsp;<span class="ident" id="6413869">err</span>&nbsp;<span class="op" id="6413873">:=</span>&nbsp;<span class="ident" id="6413876">Dial</span><span class="op" id="6413880">(</span><span class="ident" id="6413881">tt</span><span class="op" id="6413883">.</span><span class="ident" id="6413884">Net</span><span class="op" id="6413887">,</span>&nbsp;<span class="ident" id="6413889">tt</span><span class="op" id="6413891">.</span><span class="ident" id="6413892">Raddr</span><span class="op" id="6413897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6413901">if</span>&nbsp;<span class="ident" id="6413904">c</span>&nbsp;<span class="op" id="6413906">!=</span>&nbsp;<span class="builtintype" id="6413909">nil</span>&nbsp;<span class="op" id="6413913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6413918">c</span><span class="op" id="6413919">.</span><span class="ident" id="6413920">Close</span><span class="op" id="6413925">(</span><span class="op" id="6413926">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6413930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6413934">if</span>&nbsp;<span class="ident" id="6413937">err</span>&nbsp;<span class="op" id="6413941">==</span>&nbsp;<span class="builtintype" id="6413944">nil</span>&nbsp;<span class="op" id="6413948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6413953">t</span><span class="op" id="6413954">.</span><span class="ident" id="6413955">Errorf</span><span class="op" id="6413961">(</span><span class="string" id="6413962">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="6413998">,</span>&nbsp;<span class="ident" id="6414000">i</span><span class="op" id="6414001">,</span>&nbsp;<span class="ident" id="6414003">tt</span><span class="op" id="6414005">.</span><span class="ident" id="6414006">Pattern</span><span class="op" id="6414013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6414018">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6414029">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6414033">s</span>&nbsp;<span class="op" id="6414035">:=</span>&nbsp;<span class="ident" id="6414038">err</span><span class="op" id="6414041">.</span><span class="ident" id="6414042">Error</span><span class="op" id="6414047">(</span><span class="op" id="6414048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6414052">match</span><span class="op" id="6414057">,</span>&nbsp;<span class="ident" id="6414059">_</span>&nbsp;<span class="op" id="6414061">:=</span>&nbsp;<span class="ident" id="6414064">regexp</span><span class="op" id="6414070">.</span><span class="ident" id="6414071">MatchString</span><span class="op" id="6414082">(</span><span class="ident" id="6414083">tt</span><span class="op" id="6414085">.</span><span class="ident" id="6414086">Pattern</span><span class="op" id="6414093">,</span>&nbsp;<span class="ident" id="6414095">s</span><span class="op" id="6414096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6414100">if</span>&nbsp;<span class="op" id="6414103">!</span><span class="ident" id="6414104">match</span>&nbsp;<span class="op" id="6414110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6414115">t</span><span class="op" id="6414116">.</span><span class="ident" id="6414117">Errorf</span><span class="op" id="6414123">(</span><span class="string" id="6414124">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="6414153">,</span>&nbsp;<span class="ident" id="6414155">i</span><span class="op" id="6414156">,</span>&nbsp;<span class="ident" id="6414158">s</span><span class="op" id="6414159">,</span>&nbsp;<span class="ident" id="6414161">tt</span><span class="op" id="6414163">.</span><span class="ident" id="6414164">Pattern</span><span class="op" id="6414171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6414175">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6414179">match</span><span class="op" id="6414184">,</span>&nbsp;<span class="ident" id="6414186">_</span>&nbsp;<span class="op" id="6414188">=</span>&nbsp;<span class="ident" id="6414190">regexp</span><span class="op" id="6414196">.</span><span class="ident" id="6414197">MatchString</span><span class="op" id="6414208">(</span><span class="ident" id="6414209">duplicateErrorPattern</span><span class="op" id="6414230">,</span>&nbsp;<span class="ident" id="6414232">s</span><span class="op" id="6414233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6414237">if</span>&nbsp;<span class="ident" id="6414240">match</span>&nbsp;<span class="op" id="6414246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6414251">t</span><span class="op" id="6414252">.</span><span class="ident" id="6414253">Errorf</span><span class="op" id="6414259">(</span><span class="string" id="6414260">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="6414303">,</span>&nbsp;<span class="ident" id="6414305">i</span><span class="op" id="6414306">,</span>&nbsp;<span class="ident" id="6414308">s</span><span class="op" id="6414309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6414313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6414316">}</span><br>
<span class="lineno">240</span><span class="op" id="6414318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6414321">var</span>&nbsp;<span class="ident" id="6414325">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="6414354">=</span>&nbsp;<span class="op" id="6414356">[</span><span class="op" id="6414357">]</span><span class="keyword" id="6414358">struct</span>&nbsp;<span class="op" id="6414365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6414368">net</span>&nbsp;&nbsp;<span class="builtintype" id="6414373">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6414381">addr</span>&nbsp;<span class="builtintype" id="6414386">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6414394">err</span>&nbsp;&nbsp;<span class="builtintype" id="6414399">error</span><br>
<span class="lineno"></span><span class="op" id="6414405">}</span><span class="op" id="6414406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6414409">{</span><span class="string" id="6414410">&#34;foo&#34;</span><span class="op" id="6414415">,</span>&nbsp;<span class="string" id="6414417">&#34;bar&#34;</span><span class="op" id="6414422">,</span>&nbsp;<span class="op" id="6414424">&amp;</span><span class="ident" id="6414425">OpError</span><span class="op" id="6414432">{</span><span class="ident" id="6414433">Op</span><span class="op" id="6414435">:</span>&nbsp;<span class="string" id="6414437">&#34;dial&#34;</span><span class="op" id="6414443">,</span>&nbsp;<span class="ident" id="6414445">Net</span><span class="op" id="6414448">:</span>&nbsp;<span class="string" id="6414450">&#34;foo&#34;</span><span class="op" id="6414455">,</span>&nbsp;<span class="ident" id="6414457">Addr</span><span class="op" id="6414461">:</span>&nbsp;<span class="builtintype" id="6414463">nil</span><span class="op" id="6414466">,</span>&nbsp;<span class="ident" id="6414468">Err</span><span class="op" id="6414471">:</span>&nbsp;<span class="ident" id="6414473">UnknownNetworkError</span><span class="op" id="6414492">(</span><span class="string" id="6414493">&#34;foo&#34;</span><span class="op" id="6414498">)</span><span class="op" id="6414499">}</span><span class="op" id="6414500">}</span><span class="op" id="6414501">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6414504">{</span><span class="string" id="6414505">&#34;baz&#34;</span><span class="op" id="6414510">,</span>&nbsp;<span class="string" id="6414512">&#34;&#34;</span><span class="op" id="6414514">,</span>&nbsp;<span class="op" id="6414516">&amp;</span><span class="ident" id="6414517">OpError</span><span class="op" id="6414524">{</span><span class="ident" id="6414525">Op</span><span class="op" id="6414527">:</span>&nbsp;<span class="string" id="6414529">&#34;listen&#34;</span><span class="op" id="6414537">,</span>&nbsp;<span class="ident" id="6414539">Net</span><span class="op" id="6414542">:</span>&nbsp;<span class="string" id="6414544">&#34;baz&#34;</span><span class="op" id="6414549">,</span>&nbsp;<span class="ident" id="6414551">Addr</span><span class="op" id="6414555">:</span>&nbsp;<span class="builtintype" id="6414557">nil</span><span class="op" id="6414560">,</span>&nbsp;<span class="ident" id="6414562">Err</span><span class="op" id="6414565">:</span>&nbsp;<span class="ident" id="6414567">UnknownNetworkError</span><span class="op" id="6414586">(</span><span class="string" id="6414587">&#34;baz&#34;</span><span class="op" id="6414592">)</span><span class="op" id="6414593">}</span><span class="op" id="6414594">}</span><span class="op" id="6414595">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6414598">{</span><span class="string" id="6414599">&#34;tcp&#34;</span><span class="op" id="6414604">,</span>&nbsp;<span class="string" id="6414606">&#34;&#34;</span><span class="op" id="6414608">,</span>&nbsp;<span class="op" id="6414610">&amp;</span><span class="ident" id="6414611">OpError</span><span class="op" id="6414618">{</span><span class="ident" id="6414619">Op</span><span class="op" id="6414621">:</span>&nbsp;<span class="string" id="6414623">&#34;dial&#34;</span><span class="op" id="6414629">,</span>&nbsp;<span class="ident" id="6414631">Net</span><span class="op" id="6414634">:</span>&nbsp;<span class="string" id="6414636">&#34;tcp&#34;</span><span class="op" id="6414641">,</span>&nbsp;<span class="ident" id="6414643">Addr</span><span class="op" id="6414647">:</span>&nbsp;<span class="builtintype" id="6414649">nil</span><span class="op" id="6414652">,</span>&nbsp;<span class="ident" id="6414654">Err</span><span class="op" id="6414657">:</span>&nbsp;<span class="ident" id="6414659">errMissingAddress</span><span class="op" id="6414676">}</span><span class="op" id="6414677">}</span><span class="op" id="6414678">,</span><br>
<span class="lineno">250</span><span class="op" id="6414680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6414683">func</span>&nbsp;<span class="ident" id="6414688">TestInvalidDialAndListenArgs</span><span class="op" id="6414716">(</span><span class="ident" id="6414717">t</span>&nbsp;<span class="op" id="6414719">*</span><span class="ident" id="6414720">testing</span><span class="op" id="6414727">.</span><span class="ident" id="6414728">T</span><span class="op" id="6414729">)</span>&nbsp;<span class="op" id="6414731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6414734">for</span>&nbsp;<span class="ident" id="6414738">_</span><span class="op" id="6414739">,</span>&nbsp;<span class="ident" id="6414741">tt</span>&nbsp;<span class="op" id="6414744">:=</span>&nbsp;<span class="keyword" id="6414747">range</span>&nbsp;<span class="ident" id="6414753">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="6414782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6414786">var</span>&nbsp;<span class="ident" id="6414790">err</span>&nbsp;<span class="builtintype" id="6414794">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6414802">switch</span>&nbsp;<span class="ident" id="6414809">tt</span><span class="op" id="6414811">.</span><span class="ident" id="6414812">err</span><span class="op" id="6414815">.</span><span class="op" id="6414816">(</span><span class="op" id="6414817">*</span><span class="ident" id="6414818">OpError</span><span class="op" id="6414825">)</span><span class="op" id="6414826">.</span><span class="ident" id="6414827">Op</span>&nbsp;<span class="op" id="6414830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6414834">case</span>&nbsp;<span class="string" id="6414839">&#34;dial&#34;</span><span class="op" id="6414845">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6414850">_</span><span class="op" id="6414851">,</span>&nbsp;<span class="ident" id="6414853">err</span>&nbsp;<span class="op" id="6414857">=</span>&nbsp;<span class="ident" id="6414859">Dial</span><span class="op" id="6414863">(</span><span class="ident" id="6414864">tt</span><span class="op" id="6414866">.</span><span class="ident" id="6414867">net</span><span class="op" id="6414870">,</span>&nbsp;<span class="ident" id="6414872">tt</span><span class="op" id="6414874">.</span><span class="ident" id="6414875">addr</span><span class="op" id="6414879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6414883">case</span>&nbsp;<span class="string" id="6414888">&#34;listen&#34;</span><span class="op" id="6414896">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6414901">_</span><span class="op" id="6414902">,</span>&nbsp;<span class="ident" id="6414904">err</span>&nbsp;<span class="op" id="6414908">=</span>&nbsp;<span class="ident" id="6414910">Listen</span><span class="op" id="6414916">(</span><span class="ident" id="6414917">tt</span><span class="op" id="6414919">.</span><span class="ident" id="6414920">net</span><span class="op" id="6414923">,</span>&nbsp;<span class="ident" id="6414925">tt</span><span class="op" id="6414927">.</span><span class="ident" id="6414928">addr</span><span class="op" id="6414932">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6414936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6414940">if</span>&nbsp;<span class="op" id="6414943">!</span><span class="ident" id="6414944">reflect</span><span class="op" id="6414951">.</span><span class="ident" id="6414952">DeepEqual</span><span class="op" id="6414961">(</span><span class="ident" id="6414962">tt</span><span class="op" id="6414964">.</span><span class="ident" id="6414965">err</span><span class="op" id="6414968">,</span>&nbsp;<span class="ident" id="6414970">err</span><span class="op" id="6414973">)</span>&nbsp;<span class="op" id="6414975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6414980">t</span><span class="op" id="6414981">.</span><span class="ident" id="6414982">Fatalf</span><span class="op" id="6414988">(</span><span class="string" id="6414989">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="6415012">,</span>&nbsp;<span class="ident" id="6415014">err</span><span class="op" id="6415017">,</span>&nbsp;<span class="ident" id="6415019">tt</span><span class="op" id="6415021">.</span><span class="ident" id="6415022">err</span><span class="op" id="6415025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6415029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6415032">}</span><br>
<span class="lineno">265</span><span class="op" id="6415034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6415037">func</span>&nbsp;<span class="ident" id="6415042">TestDialTimeoutFDLeak</span><span class="op" id="6415063">(</span><span class="ident" id="6415064">t</span>&nbsp;<span class="op" id="6415066">*</span><span class="ident" id="6415067">testing</span><span class="op" id="6415074">.</span><span class="ident" id="6415075">T</span><span class="op" id="6415076">)</span>&nbsp;<span class="op" id="6415078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415081">if</span>&nbsp;<span class="ident" id="6415084">runtime</span><span class="op" id="6415091">.</span><span class="ident" id="6415092">GOOS</span>&nbsp;<span class="op" id="6415097">!=</span>&nbsp;<span class="string" id="6415100">&#34;linux&#34;</span>&nbsp;<span class="op" id="6415108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6415112">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415157">t</span><span class="op" id="6415158">.</span><span class="ident" id="6415159">Skipf</span><span class="op" id="6415164">(</span><span class="string" id="6415165">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6415186">,</span>&nbsp;<span class="ident" id="6415188">runtime</span><span class="op" id="6415195">.</span><span class="ident" id="6415196">GOOS</span><span class="op" id="6415200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6415203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415207">ln</span>&nbsp;<span class="op" id="6415210">:=</span>&nbsp;<span class="ident" id="6415213">newLocalListener</span><span class="op" id="6415229">(</span><span class="ident" id="6415230">t</span><span class="op" id="6415231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415234">defer</span>&nbsp;<span class="ident" id="6415240">ln</span><span class="op" id="6415242">.</span><span class="ident" id="6415243">Close</span><span class="op" id="6415248">(</span><span class="op" id="6415249">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415253">type</span>&nbsp;<span class="ident" id="6415258">connErr</span>&nbsp;<span class="keyword" id="6415266">struct</span>&nbsp;<span class="op" id="6415273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415277">conn</span>&nbsp;<span class="ident" id="6415282">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415289">err</span>&nbsp;&nbsp;<span class="builtintype" id="6415294">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6415301">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415304">dials</span>&nbsp;<span class="op" id="6415310">:=</span>&nbsp;<span class="ident" id="6415313">listenerBacklog</span>&nbsp;<span class="op" id="6415329">+</span>&nbsp;<span class="num" id="6415331">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6415336">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415416">maxGoodConnect</span>&nbsp;<span class="op" id="6415431">:=</span>&nbsp;<span class="ident" id="6415434">listenerBacklog</span>&nbsp;<span class="op" id="6415450">+</span>&nbsp;<span class="ident" id="6415452">runtime</span><span class="op" id="6415459">.</span><span class="ident" id="6415460">NumCPU</span><span class="op" id="6415466">(</span><span class="op" id="6415467">)</span><span class="op" id="6415468">*</span><span class="num" id="6415469">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415473">resc</span>&nbsp;<span class="op" id="6415478">:=</span>&nbsp;<span class="builtinfunc" id="6415481">make</span><span class="op" id="6415485">(</span><span class="keyword" id="6415486">chan</span>&nbsp;<span class="ident" id="6415491">connErr</span><span class="op" id="6415498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415501">for</span>&nbsp;<span class="ident" id="6415505">i</span>&nbsp;<span class="op" id="6415507">:=</span>&nbsp;<span class="num" id="6415510">0</span><span class="op" id="6415511">;</span>&nbsp;<span class="ident" id="6415513">i</span>&nbsp;<span class="op" id="6415515">&lt;</span>&nbsp;<span class="ident" id="6415517">dials</span><span class="op" id="6415522">;</span>&nbsp;<span class="ident" id="6415524">i</span><span class="op" id="6415525">++</span>&nbsp;<span class="op" id="6415528">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415532">go</span>&nbsp;<span class="keyword" id="6415535">func</span><span class="op" id="6415539">(</span><span class="op" id="6415540">)</span>&nbsp;<span class="op" id="6415542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415547">conn</span><span class="op" id="6415551">,</span>&nbsp;<span class="ident" id="6415553">err</span>&nbsp;<span class="op" id="6415557">:=</span>&nbsp;<span class="ident" id="6415560">DialTimeout</span><span class="op" id="6415571">(</span><span class="string" id="6415572">&#34;tcp&#34;</span><span class="op" id="6415577">,</span>&nbsp;<span class="ident" id="6415579">ln</span><span class="op" id="6415581">.</span><span class="ident" id="6415582">Addr</span><span class="op" id="6415586">(</span><span class="op" id="6415587">)</span><span class="op" id="6415588">.</span><span class="ident" id="6415589">String</span><span class="op" id="6415595">(</span><span class="op" id="6415596">)</span><span class="op" id="6415597">,</span>&nbsp;<span class="num" id="6415599">500</span><span class="op" id="6415602">*</span><span class="ident" id="6415603">time</span><span class="op" id="6415607">.</span><span class="ident" id="6415608">Millisecond</span><span class="op" id="6415619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415624">resc</span>&nbsp;<span class="op" id="6415629">&lt;-</span>&nbsp;<span class="ident" id="6415632">connErr</span><span class="op" id="6415639">{</span><span class="ident" id="6415640">conn</span><span class="op" id="6415644">,</span>&nbsp;<span class="ident" id="6415646">err</span><span class="op" id="6415649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6415653">}</span><span class="op" id="6415654">(</span><span class="op" id="6415655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6415658">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415662">var</span>&nbsp;<span class="ident" id="6415666">firstErr</span>&nbsp;<span class="builtintype" id="6415675">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415683">var</span>&nbsp;<span class="ident" id="6415687">ngood</span>&nbsp;<span class="builtintype" id="6415693">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415698">var</span>&nbsp;<span class="ident" id="6415702">toClose</span>&nbsp;<span class="op" id="6415710">[</span><span class="op" id="6415711">]</span><span class="ident" id="6415712">io</span><span class="op" id="6415714">.</span><span class="ident" id="6415715">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415723">for</span>&nbsp;<span class="ident" id="6415727">i</span>&nbsp;<span class="op" id="6415729">:=</span>&nbsp;<span class="num" id="6415732">0</span><span class="op" id="6415733">;</span>&nbsp;<span class="ident" id="6415735">i</span>&nbsp;<span class="op" id="6415737">&lt;</span>&nbsp;<span class="ident" id="6415739">dials</span><span class="op" id="6415744">;</span>&nbsp;<span class="ident" id="6415746">i</span><span class="op" id="6415747">++</span>&nbsp;<span class="op" id="6415750">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415754">ce</span>&nbsp;<span class="op" id="6415757">:=</span>&nbsp;<span class="op" id="6415760">&lt;-</span><span class="ident" id="6415762">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415769">if</span>&nbsp;<span class="ident" id="6415772">ce</span><span class="op" id="6415774">.</span><span class="ident" id="6415775">err</span>&nbsp;<span class="op" id="6415779">==</span>&nbsp;<span class="builtintype" id="6415782">nil</span>&nbsp;<span class="op" id="6415786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415791">ngood</span><span class="op" id="6415796">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415802">if</span>&nbsp;<span class="ident" id="6415805">ngood</span>&nbsp;<span class="op" id="6415811">&gt;</span>&nbsp;<span class="ident" id="6415813">maxGoodConnect</span>&nbsp;<span class="op" id="6415828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415834">t</span><span class="op" id="6415835">.</span><span class="ident" id="6415836">Errorf</span><span class="op" id="6415842">(</span><span class="string" id="6415843">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="6415882">,</span>&nbsp;<span class="ident" id="6415884">ngood</span><span class="op" id="6415889">,</span>&nbsp;<span class="ident" id="6415891">maxGoodConnect</span><span class="op" id="6415905">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6415910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415915">toClose</span>&nbsp;<span class="op" id="6415923">=</span>&nbsp;<span class="builtinfunc" id="6415925">append</span><span class="op" id="6415931">(</span><span class="ident" id="6415932">toClose</span><span class="op" id="6415939">,</span>&nbsp;<span class="ident" id="6415941">ce</span><span class="op" id="6415943">.</span><span class="ident" id="6415944">conn</span><span class="op" id="6415948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415953">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6415964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6415968">err</span>&nbsp;<span class="op" id="6415972">:=</span>&nbsp;<span class="ident" id="6415975">ce</span><span class="op" id="6415977">.</span><span class="ident" id="6415978">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6415984">if</span>&nbsp;<span class="ident" id="6415987">firstErr</span>&nbsp;<span class="op" id="6415996">==</span>&nbsp;<span class="string" id="6415999">&#34;&#34;</span>&nbsp;<span class="op" id="6416002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6416007">firstErr</span>&nbsp;<span class="op" id="6416016">=</span>&nbsp;<span class="ident" id="6416018">err</span><span class="op" id="6416021">.</span><span class="ident" id="6416022">Error</span><span class="op" id="6416027">(</span><span class="op" id="6416028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6416032">}</span>&nbsp;<span class="keyword" id="6416034">else</span>&nbsp;<span class="keyword" id="6416039">if</span>&nbsp;<span class="ident" id="6416042">err</span><span class="op" id="6416045">.</span><span class="ident" id="6416046">Error</span><span class="op" id="6416051">(</span><span class="op" id="6416052">)</span>&nbsp;<span class="op" id="6416054">!=</span>&nbsp;<span class="ident" id="6416057">firstErr</span>&nbsp;<span class="op" id="6416066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6416071">t</span><span class="op" id="6416072">.</span><span class="ident" id="6416073">Fatalf</span><span class="op" id="6416079">(</span><span class="string" id="6416080">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="6416138">,</span>&nbsp;<span class="ident" id="6416140">firstErr</span><span class="op" id="6416148">,</span>&nbsp;<span class="ident" id="6416150">err</span><span class="op" id="6416153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6416157">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6416160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6416163">for</span>&nbsp;<span class="ident" id="6416167">_</span><span class="op" id="6416168">,</span>&nbsp;<span class="ident" id="6416170">c</span>&nbsp;<span class="op" id="6416172">:=</span>&nbsp;<span class="keyword" id="6416175">range</span>&nbsp;<span class="ident" id="6416181">toClose</span>&nbsp;<span class="op" id="6416189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6416193">c</span><span class="op" id="6416194">.</span><span class="ident" id="6416195">Close</span><span class="op" id="6416200">(</span><span class="op" id="6416201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6416204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6416207">for</span>&nbsp;<span class="ident" id="6416211">i</span>&nbsp;<span class="op" id="6416213">:=</span>&nbsp;<span class="num" id="6416216">0</span><span class="op" id="6416217">;</span>&nbsp;<span class="ident" id="6416219">i</span>&nbsp;<span class="op" id="6416221">&lt;</span>&nbsp;<span class="num" id="6416223">100</span><span class="op" id="6416226">;</span>&nbsp;<span class="ident" id="6416228">i</span><span class="op" id="6416229">++</span>&nbsp;<span class="op" id="6416232">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6416236">if</span>&nbsp;<span class="ident" id="6416239">got</span>&nbsp;<span class="op" id="6416243">:=</span>&nbsp;<span class="ident" id="6416246">numFD</span><span class="op" id="6416251">(</span><span class="op" id="6416252">)</span><span class="op" id="6416253">;</span>&nbsp;<span class="ident" id="6416255">got</span>&nbsp;<span class="op" id="6416259">&lt;</span>&nbsp;<span class="ident" id="6416261">dials</span>&nbsp;<span class="op" id="6416267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6416272">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6416291">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6416300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6416304">time</span><span class="op" id="6416308">.</span><span class="ident" id="6416309">Sleep</span><span class="op" id="6416314">(</span><span class="num" id="6416315">10</span>&nbsp;<span class="op" id="6416318">*</span>&nbsp;<span class="ident" id="6416320">time</span><span class="op" id="6416324">.</span><span class="ident" id="6416325">Millisecond</span><span class="op" id="6416336">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6416339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6416342">if</span>&nbsp;<span class="ident" id="6416345">got</span>&nbsp;<span class="op" id="6416349">:=</span>&nbsp;<span class="ident" id="6416352">numFD</span><span class="op" id="6416357">(</span><span class="op" id="6416358">)</span><span class="op" id="6416359">;</span>&nbsp;<span class="ident" id="6416361">got</span>&nbsp;<span class="op" id="6416365">&gt;=</span>&nbsp;<span class="ident" id="6416368">dials</span>&nbsp;<span class="op" id="6416374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6416378">t</span><span class="op" id="6416379">.</span><span class="ident" id="6416380">Errorf</span><span class="op" id="6416386">(</span><span class="string" id="6416387">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="6416429">,</span>&nbsp;<span class="ident" id="6416431">dials</span><span class="op" id="6416436">,</span>&nbsp;<span class="ident" id="6416438">got</span><span class="op" id="6416441">,</span>&nbsp;<span class="ident" id="6416443">dials</span><span class="op" id="6416448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6416451">}</span><br>
<span class="lineno"></span><span class="op" id="6416453">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="6416456">func</span>&nbsp;<span class="ident" id="6416461">numTCP</span><span class="op" id="6416467">(</span><span class="op" id="6416468">)</span>&nbsp;<span class="op" id="6416470">(</span><span class="ident" id="6416471">ntcp</span><span class="op" id="6416475">,</span>&nbsp;<span class="ident" id="6416477">nopen</span><span class="op" id="6416482">,</span>&nbsp;<span class="ident" id="6416484">nclose</span>&nbsp;<span class="builtintype" id="6416491">int</span><span class="op" id="6416494">,</span>&nbsp;<span class="ident" id="6416496">err</span>&nbsp;<span class="builtintype" id="6416500">error</span><span class="op" id="6416505">)</span>&nbsp;<span class="op" id="6416507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6416510">lsof</span><span class="op" id="6416514">,</span>&nbsp;<span class="ident" id="6416516">err</span>&nbsp;<span class="op" id="6416520">:=</span>&nbsp;<span class="ident" id="6416523">exec</span><span class="op" id="6416527">.</span><span class="ident" id="6416528">Command</span><span class="op" id="6416535">(</span><span class="string" id="6416536">&#34;lsof&#34;</span><span class="op" id="6416542">,</span>&nbsp;<span class="string" id="6416544">&#34;-n&#34;</span><span class="op" id="6416548">,</span>&nbsp;<span class="string" id="6416550">&#34;-p&#34;</span><span class="op" id="6416554">,</span>&nbsp;<span class="ident" id="6416556">strconv</span><span class="op" id="6416563">.</span><span class="ident" id="6416564">Itoa</span><span class="op" id="6416568">(</span><span class="ident" id="6416569">os</span><span class="op" id="6416571">.</span><span class="ident" id="6416572">Getpid</span><span class="op" id="6416578">(</span><span class="op" id="6416579">)</span><span class="op" id="6416580">)</span><span class="op" id="6416581">)</span><span class="op" id="6416582">.</span><span class="ident" id="6416583">Output</span><span class="op" id="6416589">(</span><span class="op" id="6416590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6416593">if</span>&nbsp;<span class="ident" id="6416596">err</span>&nbsp;<span class="op" id="6416600">!=</span>&nbsp;<span class="builtintype" id="6416603">nil</span>&nbsp;<span class="op" id="6416607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6416611">return</span>&nbsp;<span class="num" id="6416618">0</span><span class="op" id="6416619">,</span>&nbsp;<span class="num" id="6416621">0</span><span class="op" id="6416622">,</span>&nbsp;<span class="num" id="6416624">0</span><span class="op" id="6416625">,</span>&nbsp;<span class="ident" id="6416627">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6416632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6416635">ntcp</span>&nbsp;<span class="op" id="6416640">+=</span>&nbsp;<span class="ident" id="6416643">bytes</span><span class="op" id="6416648">.</span><span class="ident" id="6416649">Count</span><span class="op" id="6416654">(</span><span class="ident" id="6416655">lsof</span><span class="op" id="6416659">,</span>&nbsp;<span class="op" id="6416661">[</span><span class="op" id="6416662">]</span><span class="builtintype" id="6416663">byte</span><span class="op" id="6416667">(</span><span class="string" id="6416668">&#34;TCP&#34;</span><span class="op" id="6416673">)</span><span class="op" id="6416674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6416677">for</span>&nbsp;<span class="ident" id="6416681">_</span><span class="op" id="6416682">,</span>&nbsp;<span class="ident" id="6416684">state</span>&nbsp;<span class="op" id="6416690">:=</span>&nbsp;<span class="keyword" id="6416693">range</span>&nbsp;<span class="op" id="6416699">[</span><span class="op" id="6416700">]</span><span class="builtintype" id="6416701">string</span><span class="op" id="6416707">{</span><span class="string" id="6416708">&#34;LISTEN&#34;</span><span class="op" id="6416716">,</span>&nbsp;<span class="string" id="6416718">&#34;SYN_SENT&#34;</span><span class="op" id="6416728">,</span>&nbsp;<span class="string" id="6416730">&#34;SYN_RECEIVED&#34;</span><span class="op" id="6416744">,</span>&nbsp;<span class="string" id="6416746">&#34;ESTABLISHED&#34;</span><span class="op" id="6416759">}</span>&nbsp;<span class="op" id="6416761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6416765">nopen</span>&nbsp;<span class="op" id="6416771">+=</span>&nbsp;<span class="ident" id="6416774">bytes</span><span class="op" id="6416779">.</span><span class="ident" id="6416780">Count</span><span class="op" id="6416785">(</span><span class="ident" id="6416786">lsof</span><span class="op" id="6416790">,</span>&nbsp;<span class="op" id="6416792">[</span><span class="op" id="6416793">]</span><span class="builtintype" id="6416794">byte</span><span class="op" id="6416798">(</span><span class="ident" id="6416799">state</span><span class="op" id="6416804">)</span><span class="op" id="6416805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6416808">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6416811">for</span>&nbsp;<span class="ident" id="6416815">_</span><span class="op" id="6416816">,</span>&nbsp;<span class="ident" id="6416818">state</span>&nbsp;<span class="op" id="6416824">:=</span>&nbsp;<span class="keyword" id="6416827">range</span>&nbsp;<span class="op" id="6416833">[</span><span class="op" id="6416834">]</span><span class="builtintype" id="6416835">string</span><span class="op" id="6416841">{</span><span class="string" id="6416842">&#34;CLOSED&#34;</span><span class="op" id="6416850">,</span>&nbsp;<span class="string" id="6416852">&#34;CLOSE_WAIT&#34;</span><span class="op" id="6416864">,</span>&nbsp;<span class="string" id="6416866">&#34;LAST_ACK&#34;</span><span class="op" id="6416876">,</span>&nbsp;<span class="string" id="6416878">&#34;FIN_WAIT_1&#34;</span><span class="op" id="6416890">,</span>&nbsp;<span class="string" id="6416892">&#34;FIN_WAIT_2&#34;</span><span class="op" id="6416904">,</span>&nbsp;<span class="string" id="6416906">&#34;CLOSING&#34;</span><span class="op" id="6416915">,</span>&nbsp;<span class="string" id="6416917">&#34;TIME_WAIT&#34;</span><span class="op" id="6416928">}</span>&nbsp;<span class="op" id="6416930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6416934">nclose</span>&nbsp;<span class="op" id="6416941">+=</span>&nbsp;<span class="ident" id="6416944">bytes</span><span class="op" id="6416949">.</span><span class="ident" id="6416950">Count</span><span class="op" id="6416955">(</span><span class="ident" id="6416956">lsof</span><span class="op" id="6416960">,</span>&nbsp;<span class="op" id="6416962">[</span><span class="op" id="6416963">]</span><span class="builtintype" id="6416964">byte</span><span class="op" id="6416968">(</span><span class="ident" id="6416969">state</span><span class="op" id="6416974">)</span><span class="op" id="6416975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6416978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6416981">return</span>&nbsp;<span class="ident" id="6416988">ntcp</span><span class="op" id="6416992">,</span>&nbsp;<span class="ident" id="6416994">nopen</span><span class="op" id="6416999">,</span>&nbsp;<span class="ident" id="6417001">nclose</span><span class="op" id="6417007">,</span>&nbsp;<span class="builtintype" id="6417009">nil</span><br>
<span class="lineno"></span><span class="op" id="6417013">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="6417016">func</span>&nbsp;<span class="ident" id="6417021">TestDialMultiFDLeak</span><span class="op" id="6417040">(</span><span class="ident" id="6417041">t</span>&nbsp;<span class="op" id="6417043">*</span><span class="ident" id="6417044">testing</span><span class="op" id="6417051">.</span><span class="ident" id="6417052">T</span><span class="op" id="6417053">)</span>&nbsp;<span class="op" id="6417055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6417058">t</span><span class="op" id="6417059">.</span><span class="ident" id="6417060">Skip</span><span class="op" id="6417064">(</span><span class="string" id="6417065">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="6417101">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6417105">if</span>&nbsp;<span class="op" id="6417108">!</span><span class="ident" id="6417109">supportsIPv4</span>&nbsp;<span class="op" id="6417122">||</span>&nbsp;<span class="op" id="6417125">!</span><span class="ident" id="6417126">supportsIPv6</span>&nbsp;<span class="op" id="6417139">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6417143">t</span><span class="op" id="6417144">.</span><span class="ident" id="6417145">Skip</span><span class="op" id="6417149">(</span><span class="string" id="6417150">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="6417186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6417189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6417193">halfDeadServer</span>&nbsp;<span class="op" id="6417208">:=</span>&nbsp;<span class="keyword" id="6417211">func</span><span class="op" id="6417215">(</span><span class="ident" id="6417216">dss</span>&nbsp;<span class="op" id="6417220">*</span><span class="ident" id="6417221">dualStackServer</span><span class="op" id="6417236">,</span>&nbsp;<span class="ident" id="6417238">ln</span>&nbsp;<span class="ident" id="6417241">Listener</span><span class="op" id="6417249">)</span>&nbsp;<span class="op" id="6417251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6417255">for</span>&nbsp;<span class="op" id="6417259">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6417264">if</span>&nbsp;<span class="ident" id="6417267">c</span><span class="op" id="6417268">,</span>&nbsp;<span class="ident" id="6417270">err</span>&nbsp;<span class="op" id="6417274">:=</span>&nbsp;<span class="ident" id="6417277">ln</span><span class="op" id="6417279">.</span><span class="ident" id="6417280">Accept</span><span class="op" id="6417286">(</span><span class="op" id="6417287">)</span><span class="op" id="6417288">;</span>&nbsp;<span class="ident" id="6417290">err</span>&nbsp;<span class="op" id="6417294">!=</span>&nbsp;<span class="builtintype" id="6417297">nil</span>&nbsp;<span class="op" id="6417301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6417307">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6417317">}</span>&nbsp;<span class="keyword" id="6417319">else</span>&nbsp;<span class="op" id="6417324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6417330">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6417363">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6417406">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6417419">dss</span><span class="op" id="6417422">.</span><span class="ident" id="6417423">putConn</span><span class="op" id="6417430">(</span><span class="ident" id="6417431">c</span><span class="op" id="6417432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6417437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6417441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6417444">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6417447">dss</span><span class="op" id="6417450">,</span>&nbsp;<span class="ident" id="6417452">err</span>&nbsp;<span class="op" id="6417456">:=</span>&nbsp;<span class="ident" id="6417459">newDualStackServer</span><span class="op" id="6417477">(</span><span class="op" id="6417478">[</span><span class="op" id="6417479">]</span><span class="ident" id="6417480">streamListener</span><span class="op" id="6417494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6417498">{</span><span class="ident" id="6417499">net</span><span class="op" id="6417502">:</span>&nbsp;<span class="string" id="6417504">&#34;tcp4&#34;</span><span class="op" id="6417510">,</span>&nbsp;<span class="ident" id="6417512">addr</span><span class="op" id="6417516">:</span>&nbsp;<span class="string" id="6417518">&#34;127.0.0.1&#34;</span><span class="op" id="6417529">}</span><span class="op" id="6417530">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6417534">{</span><span class="ident" id="6417535">net</span><span class="op" id="6417538">:</span>&nbsp;<span class="string" id="6417540">&#34;tcp6&#34;</span><span class="op" id="6417546">,</span>&nbsp;<span class="ident" id="6417548">addr</span><span class="op" id="6417552">:</span>&nbsp;<span class="string" id="6417554">&#34;[::1]&#34;</span><span class="op" id="6417561">}</span><span class="op" id="6417562">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6417565">}</span><span class="op" id="6417566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6417569">if</span>&nbsp;<span class="ident" id="6417572">err</span>&nbsp;<span class="op" id="6417576">!=</span>&nbsp;<span class="builtintype" id="6417579">nil</span>&nbsp;<span class="op" id="6417583">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6417587">t</span><span class="op" id="6417588">.</span><span class="ident" id="6417589">Fatalf</span><span class="op" id="6417595">(</span><span class="string" id="6417596">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6417627">,</span>&nbsp;<span class="ident" id="6417629">err</span><span class="op" id="6417632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6417635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6417638">defer</span>&nbsp;<span class="ident" id="6417644">dss</span><span class="op" id="6417647">.</span><span class="ident" id="6417648">teardown</span><span class="op" id="6417656">(</span><span class="op" id="6417657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6417660">if</span>&nbsp;<span class="ident" id="6417663">err</span>&nbsp;<span class="op" id="6417667">:=</span>&nbsp;<span class="ident" id="6417670">dss</span><span class="op" id="6417673">.</span><span class="ident" id="6417674">buildup</span><span class="op" id="6417681">(</span><span class="ident" id="6417682">halfDeadServer</span><span class="op" id="6417696">)</span><span class="op" id="6417697">;</span>&nbsp;<span class="ident" id="6417699">err</span>&nbsp;<span class="op" id="6417703">!=</span>&nbsp;<span class="builtintype" id="6417706">nil</span>&nbsp;<span class="op" id="6417710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6417714">t</span><span class="op" id="6417715">.</span><span class="ident" id="6417716">Fatalf</span><span class="op" id="6417722">(</span><span class="string" id="6417723">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6417759">,</span>&nbsp;<span class="ident" id="6417761">err</span><span class="op" id="6417764">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6417767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6417771">_</span><span class="op" id="6417772">,</span>&nbsp;<span class="ident" id="6417774">before</span><span class="op" id="6417780">,</span>&nbsp;<span class="ident" id="6417782">_</span><span class="op" id="6417783">,</span>&nbsp;<span class="ident" id="6417785">err</span>&nbsp;<span class="op" id="6417789">:=</span>&nbsp;<span class="ident" id="6417792">numTCP</span><span class="op" id="6417798">(</span><span class="op" id="6417799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6417802">if</span>&nbsp;<span class="ident" id="6417805">err</span>&nbsp;<span class="op" id="6417809">!=</span>&nbsp;<span class="builtintype" id="6417812">nil</span>&nbsp;<span class="op" id="6417816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6417820">t</span><span class="op" id="6417821">.</span><span class="ident" id="6417822">Skipf</span><span class="op" id="6417827">(</span><span class="string" id="6417828">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="6417878">,</span>&nbsp;<span class="ident" id="6417880">err</span><span class="op" id="6417883">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6417886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6417890">var</span>&nbsp;<span class="ident" id="6417894">wg</span>&nbsp;<span class="ident" id="6417897">sync</span><span class="op" id="6417901">.</span><span class="ident" id="6417902">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6417913">portnum</span><span class="op" id="6417920">,</span>&nbsp;<span class="ident" id="6417922">_</span><span class="op" id="6417923">,</span>&nbsp;<span class="ident" id="6417925">_</span>&nbsp;<span class="op" id="6417927">:=</span>&nbsp;<span class="ident" id="6417930">dtoi</span><span class="op" id="6417934">(</span><span class="ident" id="6417935">dss</span><span class="op" id="6417938">.</span><span class="ident" id="6417939">port</span><span class="op" id="6417943">,</span>&nbsp;<span class="num" id="6417945">0</span><span class="op" id="6417946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6417949">ras</span>&nbsp;<span class="op" id="6417953">:=</span>&nbsp;<span class="ident" id="6417956">addrList</span><span class="op" id="6417964">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6417968">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6418021">&amp;</span><span class="ident" id="6418022">TCPAddr</span><span class="op" id="6418029">{</span><span class="ident" id="6418030">IP</span><span class="op" id="6418032">:</span>&nbsp;<span class="ident" id="6418034">IPv4</span><span class="op" id="6418038">(</span><span class="num" id="6418039">198</span><span class="op" id="6418042">,</span>&nbsp;<span class="num" id="6418044">18</span><span class="op" id="6418046">,</span>&nbsp;<span class="num" id="6418048">0</span><span class="op" id="6418049">,</span>&nbsp;<span class="num" id="6418051">254</span><span class="op" id="6418054">)</span><span class="op" id="6418055">,</span>&nbsp;<span class="ident" id="6418057">Port</span><span class="op" id="6418061">:</span>&nbsp;<span class="ident" id="6418063">portnum</span><span class="op" id="6418070">}</span><span class="op" id="6418071">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6418075">&amp;</span><span class="ident" id="6418076">TCPAddr</span><span class="op" id="6418083">{</span><span class="ident" id="6418084">IP</span><span class="op" id="6418086">:</span>&nbsp;<span class="ident" id="6418088">ParseIP</span><span class="op" id="6418095">(</span><span class="string" id="6418096">&#34;2001:2::254&#34;</span><span class="op" id="6418109">)</span><span class="op" id="6418110">,</span>&nbsp;<span class="ident" id="6418112">Port</span><span class="op" id="6418116">:</span>&nbsp;<span class="ident" id="6418118">portnum</span><span class="op" id="6418125">}</span><span class="op" id="6418126">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6418131">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6418168">&amp;</span><span class="ident" id="6418169">TCPAddr</span><span class="op" id="6418176">{</span><span class="ident" id="6418177">IP</span><span class="op" id="6418179">:</span>&nbsp;<span class="ident" id="6418181">IPv4</span><span class="op" id="6418185">(</span><span class="num" id="6418186">127</span><span class="op" id="6418189">,</span>&nbsp;<span class="num" id="6418191">0</span><span class="op" id="6418192">,</span>&nbsp;<span class="num" id="6418194">0</span><span class="op" id="6418195">,</span>&nbsp;<span class="num" id="6418197">1</span><span class="op" id="6418198">)</span><span class="op" id="6418199">,</span>&nbsp;<span class="ident" id="6418201">Port</span><span class="op" id="6418205">:</span>&nbsp;<span class="ident" id="6418207">portnum</span><span class="op" id="6418214">}</span><span class="op" id="6418215">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6418219">&amp;</span><span class="ident" id="6418220">TCPAddr</span><span class="op" id="6418227">{</span><span class="ident" id="6418228">IP</span><span class="op" id="6418230">:</span>&nbsp;<span class="ident" id="6418232">IPv6loopback</span><span class="op" id="6418244">,</span>&nbsp;<span class="ident" id="6418246">Port</span><span class="op" id="6418250">:</span>&nbsp;<span class="ident" id="6418252">portnum</span><span class="op" id="6418259">}</span><span class="op" id="6418260">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6418265">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6418317">&amp;</span><span class="ident" id="6418318">TCPAddr</span><span class="op" id="6418325">{</span><span class="ident" id="6418326">IP</span><span class="op" id="6418328">:</span>&nbsp;<span class="ident" id="6418330">IPv4</span><span class="op" id="6418334">(</span><span class="num" id="6418335">127</span><span class="op" id="6418338">,</span>&nbsp;<span class="num" id="6418340">0</span><span class="op" id="6418341">,</span>&nbsp;<span class="num" id="6418343">0</span><span class="op" id="6418344">,</span>&nbsp;<span class="num" id="6418346">1</span><span class="op" id="6418347">)</span><span class="op" id="6418348">,</span>&nbsp;<span class="ident" id="6418350">Port</span><span class="op" id="6418354">:</span>&nbsp;<span class="ident" id="6418356">portnum</span><span class="op" id="6418363">}</span><span class="op" id="6418364">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6418368">&amp;</span><span class="ident" id="6418369">TCPAddr</span><span class="op" id="6418376">{</span><span class="ident" id="6418377">IP</span><span class="op" id="6418379">:</span>&nbsp;<span class="ident" id="6418381">IPv6loopback</span><span class="op" id="6418393">,</span>&nbsp;<span class="ident" id="6418395">Port</span><span class="op" id="6418399">:</span>&nbsp;<span class="ident" id="6418401">portnum</span><span class="op" id="6418408">}</span><span class="op" id="6418409">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6418412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6418415">const</span>&nbsp;<span class="ident" id="6418421">T1</span>&nbsp;<span class="op" id="6418424">=</span>&nbsp;<span class="num" id="6418426">10</span>&nbsp;<span class="op" id="6418429">*</span>&nbsp;<span class="ident" id="6418431">time</span><span class="op" id="6418435">.</span><span class="ident" id="6418436">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6418449">const</span>&nbsp;<span class="ident" id="6418455">T2</span>&nbsp;<span class="op" id="6418458">=</span>&nbsp;<span class="num" id="6418460">2</span>&nbsp;<span class="op" id="6418462">*</span>&nbsp;<span class="ident" id="6418464">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6418468">const</span>&nbsp;<span class="ident" id="6418474">N</span>&nbsp;<span class="op" id="6418476">=</span>&nbsp;<span class="num" id="6418478">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6418482">for</span>&nbsp;<span class="ident" id="6418486">i</span>&nbsp;<span class="op" id="6418488">:=</span>&nbsp;<span class="num" id="6418491">0</span><span class="op" id="6418492">;</span>&nbsp;<span class="ident" id="6418494">i</span>&nbsp;<span class="op" id="6418496">&lt;</span>&nbsp;<span class="ident" id="6418498">N</span><span class="op" id="6418499">;</span>&nbsp;<span class="ident" id="6418501">i</span><span class="op" id="6418502">++</span>&nbsp;<span class="op" id="6418505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6418509">wg</span><span class="op" id="6418511">.</span><span class="ident" id="6418512">Add</span><span class="op" id="6418515">(</span><span class="num" id="6418516">1</span><span class="op" id="6418517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6418521">go</span>&nbsp;<span class="keyword" id="6418524">func</span><span class="op" id="6418528">(</span><span class="op" id="6418529">)</span>&nbsp;<span class="op" id="6418531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6418536">defer</span>&nbsp;<span class="ident" id="6418542">wg</span><span class="op" id="6418544">.</span><span class="ident" id="6418545">Done</span><span class="op" id="6418549">(</span><span class="op" id="6418550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6418555">if</span>&nbsp;<span class="ident" id="6418558">c</span><span class="op" id="6418559">,</span>&nbsp;<span class="ident" id="6418561">err</span>&nbsp;<span class="op" id="6418565">:=</span>&nbsp;<span class="ident" id="6418568">dialMulti</span><span class="op" id="6418577">(</span><span class="string" id="6418578">&#34;tcp&#34;</span><span class="op" id="6418583">,</span>&nbsp;<span class="string" id="6418585">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="6418605">,</span>&nbsp;<span class="builtintype" id="6418607">nil</span><span class="op" id="6418610">,</span>&nbsp;<span class="ident" id="6418612">ras</span><span class="op" id="6418615">,</span>&nbsp;<span class="ident" id="6418617">time</span><span class="op" id="6418621">.</span><span class="ident" id="6418622">Now</span><span class="op" id="6418625">(</span><span class="op" id="6418626">)</span><span class="op" id="6418627">.</span><span class="ident" id="6418628">Add</span><span class="op" id="6418631">(</span><span class="ident" id="6418632">T1</span><span class="op" id="6418634">)</span><span class="op" id="6418635">)</span><span class="op" id="6418636">;</span>&nbsp;<span class="ident" id="6418638">err</span>&nbsp;<span class="op" id="6418642">==</span>&nbsp;<span class="builtintype" id="6418645">nil</span>&nbsp;<span class="op" id="6418649">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6418655">c</span><span class="op" id="6418656">.</span><span class="ident" id="6418657">Close</span><span class="op" id="6418662">(</span><span class="op" id="6418663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6418668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6418672">}</span><span class="op" id="6418673">(</span><span class="op" id="6418674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6418677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6418680">wg</span><span class="op" id="6418682">.</span><span class="ident" id="6418683">Wait</span><span class="op" id="6418687">(</span><span class="op" id="6418688">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6418691">time</span><span class="op" id="6418695">.</span><span class="ident" id="6418696">Sleep</span><span class="op" id="6418701">(</span><span class="ident" id="6418702">T2</span><span class="op" id="6418704">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6418708">ntcp</span><span class="op" id="6418712">,</span>&nbsp;<span class="ident" id="6418714">after</span><span class="op" id="6418719">,</span>&nbsp;<span class="ident" id="6418721">nclose</span><span class="op" id="6418727">,</span>&nbsp;<span class="ident" id="6418729">err</span>&nbsp;<span class="op" id="6418733">:=</span>&nbsp;<span class="ident" id="6418736">numTCP</span><span class="op" id="6418742">(</span><span class="op" id="6418743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6418746">if</span>&nbsp;<span class="ident" id="6418749">err</span>&nbsp;<span class="op" id="6418753">!=</span>&nbsp;<span class="builtintype" id="6418756">nil</span>&nbsp;<span class="op" id="6418760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6418764">t</span><span class="op" id="6418765">.</span><span class="ident" id="6418766">Skipf</span><span class="op" id="6418771">(</span><span class="string" id="6418772">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="6418822">,</span>&nbsp;<span class="ident" id="6418824">err</span><span class="op" id="6418827">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6418830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6418833">t</span><span class="op" id="6418834">.</span><span class="ident" id="6418835">Logf</span><span class="op" id="6418839">(</span><span class="string" id="6418840">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="6418899">,</span>&nbsp;<span class="ident" id="6418901">ntcp</span><span class="op" id="6418905">,</span>&nbsp;<span class="ident" id="6418907">after</span><span class="op" id="6418912">,</span>&nbsp;<span class="ident" id="6418914">nclose</span><span class="op" id="6418920">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6418924">if</span>&nbsp;<span class="ident" id="6418927">after</span>&nbsp;<span class="op" id="6418933">!=</span>&nbsp;<span class="ident" id="6418936">before</span>&nbsp;<span class="op" id="6418943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6418947">t</span><span class="op" id="6418948">.</span><span class="ident" id="6418949">Fatalf</span><span class="op" id="6418955">(</span><span class="string" id="6418956">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="6418991">,</span>&nbsp;<span class="ident" id="6418993">after</span><span class="op" id="6418998">,</span>&nbsp;<span class="ident" id="6419000">before</span><span class="op" id="6419006">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6419009">}</span><br>
<span class="lineno"></span><span class="op" id="6419011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6419014">func</span>&nbsp;<span class="ident" id="6419019">numFD</span><span class="op" id="6419024">(</span><span class="op" id="6419025">)</span>&nbsp;<span class="builtintype" id="6419027">int</span>&nbsp;<span class="op" id="6419031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419034">if</span>&nbsp;<span class="ident" id="6419037">runtime</span><span class="op" id="6419044">.</span><span class="ident" id="6419045">GOOS</span>&nbsp;<span class="op" id="6419050">==</span>&nbsp;<span class="string" id="6419053">&#34;linux&#34;</span>&nbsp;<span class="op" id="6419061">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419065">f</span><span class="op" id="6419066">,</span>&nbsp;<span class="ident" id="6419068">err</span>&nbsp;<span class="op" id="6419072">:=</span>&nbsp;<span class="ident" id="6419075">os</span><span class="op" id="6419077">.</span><span class="ident" id="6419078">Open</span><span class="op" id="6419082">(</span><span class="string" id="6419083">&#34;/proc/self/fd&#34;</span><span class="op" id="6419098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419102">if</span>&nbsp;<span class="ident" id="6419105">err</span>&nbsp;<span class="op" id="6419109">!=</span>&nbsp;<span class="builtintype" id="6419112">nil</span>&nbsp;<span class="op" id="6419116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6419121">panic</span><span class="op" id="6419126">(</span><span class="ident" id="6419127">err</span><span class="op" id="6419130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6419134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419138">defer</span>&nbsp;<span class="ident" id="6419144">f</span><span class="op" id="6419145">.</span><span class="ident" id="6419146">Close</span><span class="op" id="6419151">(</span><span class="op" id="6419152">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419156">names</span><span class="op" id="6419161">,</span>&nbsp;<span class="ident" id="6419163">err</span>&nbsp;<span class="op" id="6419167">:=</span>&nbsp;<span class="ident" id="6419170">f</span><span class="op" id="6419171">.</span><span class="ident" id="6419172">Readdirnames</span><span class="op" id="6419184">(</span><span class="num" id="6419185">0</span><span class="op" id="6419186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419190">if</span>&nbsp;<span class="ident" id="6419193">err</span>&nbsp;<span class="op" id="6419197">!=</span>&nbsp;<span class="builtintype" id="6419200">nil</span>&nbsp;<span class="op" id="6419204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6419209">panic</span><span class="op" id="6419214">(</span><span class="ident" id="6419215">err</span><span class="op" id="6419218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6419222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419226">return</span>&nbsp;<span class="builtinfunc" id="6419233">len</span><span class="op" id="6419236">(</span><span class="ident" id="6419237">names</span><span class="op" id="6419242">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6419245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6419248">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6419304">panic</span><span class="op" id="6419309">(</span><span class="string" id="6419310">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="6419339">+</span>&nbsp;<span class="ident" id="6419341">runtime</span><span class="op" id="6419348">.</span><span class="ident" id="6419349">GOOS</span><span class="op" id="6419353">)</span><br>
<span class="lineno"></span><span class="op" id="6419355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="6419358">func</span>&nbsp;<span class="ident" id="6419363">TestDialer</span><span class="op" id="6419373">(</span><span class="ident" id="6419374">t</span>&nbsp;<span class="op" id="6419376">*</span><span class="ident" id="6419377">testing</span><span class="op" id="6419384">.</span><span class="ident" id="6419385">T</span><span class="op" id="6419386">)</span>&nbsp;<span class="op" id="6419388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419391">ln</span><span class="op" id="6419393">,</span>&nbsp;<span class="ident" id="6419395">err</span>&nbsp;<span class="op" id="6419399">:=</span>&nbsp;<span class="ident" id="6419402">Listen</span><span class="op" id="6419408">(</span><span class="string" id="6419409">&#34;tcp4&#34;</span><span class="op" id="6419415">,</span>&nbsp;<span class="string" id="6419417">&#34;127.0.0.1:0&#34;</span><span class="op" id="6419430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419433">if</span>&nbsp;<span class="ident" id="6419436">err</span>&nbsp;<span class="op" id="6419440">!=</span>&nbsp;<span class="builtintype" id="6419443">nil</span>&nbsp;<span class="op" id="6419447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419451">t</span><span class="op" id="6419452">.</span><span class="ident" id="6419453">Fatalf</span><span class="op" id="6419459">(</span><span class="string" id="6419460">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6419479">,</span>&nbsp;<span class="ident" id="6419481">err</span><span class="op" id="6419484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6419487">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419490">defer</span>&nbsp;<span class="ident" id="6419496">ln</span><span class="op" id="6419498">.</span><span class="ident" id="6419499">Close</span><span class="op" id="6419504">(</span><span class="op" id="6419505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419508">ch</span>&nbsp;<span class="op" id="6419511">:=</span>&nbsp;<span class="builtinfunc" id="6419514">make</span><span class="op" id="6419518">(</span><span class="keyword" id="6419519">chan</span>&nbsp;<span class="builtintype" id="6419524">error</span><span class="op" id="6419529">,</span>&nbsp;<span class="num" id="6419531">1</span><span class="op" id="6419532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419535">go</span>&nbsp;<span class="keyword" id="6419538">func</span><span class="op" id="6419542">(</span><span class="op" id="6419543">)</span>&nbsp;<span class="op" id="6419545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419549">c</span><span class="op" id="6419550">,</span>&nbsp;<span class="ident" id="6419552">err</span>&nbsp;<span class="op" id="6419556">:=</span>&nbsp;<span class="ident" id="6419559">ln</span><span class="op" id="6419561">.</span><span class="ident" id="6419562">Accept</span><span class="op" id="6419568">(</span><span class="op" id="6419569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419573">if</span>&nbsp;<span class="ident" id="6419576">err</span>&nbsp;<span class="op" id="6419580">!=</span>&nbsp;<span class="builtintype" id="6419583">nil</span>&nbsp;<span class="op" id="6419587">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419592">ch</span>&nbsp;<span class="op" id="6419595">&lt;-</span>&nbsp;<span class="ident" id="6419598">fmt</span><span class="op" id="6419601">.</span><span class="ident" id="6419602">Errorf</span><span class="op" id="6419608">(</span><span class="string" id="6419609">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6419628">,</span>&nbsp;<span class="ident" id="6419630">err</span><span class="op" id="6419633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419638">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6419647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419651">defer</span>&nbsp;<span class="ident" id="6419657">c</span><span class="op" id="6419658">.</span><span class="ident" id="6419659">Close</span><span class="op" id="6419664">(</span><span class="op" id="6419665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419669">ch</span>&nbsp;<span class="op" id="6419672">&lt;-</span>&nbsp;<span class="builtintype" id="6419675">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6419680">}</span><span class="op" id="6419681">(</span><span class="op" id="6419682">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419686">laddr</span><span class="op" id="6419691">,</span>&nbsp;<span class="ident" id="6419693">err</span>&nbsp;<span class="op" id="6419697">:=</span>&nbsp;<span class="ident" id="6419700">ResolveTCPAddr</span><span class="op" id="6419714">(</span><span class="string" id="6419715">&#34;tcp4&#34;</span><span class="op" id="6419721">,</span>&nbsp;<span class="string" id="6419723">&#34;127.0.0.1:0&#34;</span><span class="op" id="6419736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419739">if</span>&nbsp;<span class="ident" id="6419742">err</span>&nbsp;<span class="op" id="6419746">!=</span>&nbsp;<span class="builtintype" id="6419749">nil</span>&nbsp;<span class="op" id="6419753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419757">t</span><span class="op" id="6419758">.</span><span class="ident" id="6419759">Fatalf</span><span class="op" id="6419765">(</span><span class="string" id="6419766">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6419793">,</span>&nbsp;<span class="ident" id="6419795">err</span><span class="op" id="6419798">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6419801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419804">d</span>&nbsp;<span class="op" id="6419806">:=</span>&nbsp;<span class="op" id="6419809">&amp;</span><span class="ident" id="6419810">Dialer</span><span class="op" id="6419816">{</span><span class="ident" id="6419817">LocalAddr</span><span class="op" id="6419826">:</span>&nbsp;<span class="ident" id="6419828">laddr</span><span class="op" id="6419833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419836">c</span><span class="op" id="6419837">,</span>&nbsp;<span class="ident" id="6419839">err</span>&nbsp;<span class="op" id="6419843">:=</span>&nbsp;<span class="ident" id="6419846">d</span><span class="op" id="6419847">.</span><span class="ident" id="6419848">Dial</span><span class="op" id="6419852">(</span><span class="string" id="6419853">&#34;tcp4&#34;</span><span class="op" id="6419859">,</span>&nbsp;<span class="ident" id="6419861">ln</span><span class="op" id="6419863">.</span><span class="ident" id="6419864">Addr</span><span class="op" id="6419868">(</span><span class="op" id="6419869">)</span><span class="op" id="6419870">.</span><span class="ident" id="6419871">String</span><span class="op" id="6419877">(</span><span class="op" id="6419878">)</span><span class="op" id="6419879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419882">if</span>&nbsp;<span class="ident" id="6419885">err</span>&nbsp;<span class="op" id="6419889">!=</span>&nbsp;<span class="builtintype" id="6419892">nil</span>&nbsp;<span class="op" id="6419896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419900">t</span><span class="op" id="6419901">.</span><span class="ident" id="6419902">Fatalf</span><span class="op" id="6419908">(</span><span class="string" id="6419909">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6419926">,</span>&nbsp;<span class="ident" id="6419928">err</span><span class="op" id="6419931">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6419934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419937">defer</span>&nbsp;<span class="ident" id="6419943">c</span><span class="op" id="6419944">.</span><span class="ident" id="6419945">Close</span><span class="op" id="6419950">(</span><span class="op" id="6419951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419954">c</span><span class="op" id="6419955">.</span><span class="ident" id="6419956">Read</span><span class="op" id="6419960">(</span><span class="builtinfunc" id="6419961">make</span><span class="op" id="6419965">(</span><span class="op" id="6419966">[</span><span class="op" id="6419967">]</span><span class="builtintype" id="6419968">byte</span><span class="op" id="6419972">,</span>&nbsp;<span class="num" id="6419974">1</span><span class="op" id="6419975">)</span><span class="op" id="6419976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419979">err</span>&nbsp;<span class="op" id="6419983">=</span>&nbsp;<span class="op" id="6419985">&lt;-</span><span class="ident" id="6419987">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6419991">if</span>&nbsp;<span class="ident" id="6419994">err</span>&nbsp;<span class="op" id="6419998">!=</span>&nbsp;<span class="builtintype" id="6420001">nil</span>&nbsp;<span class="op" id="6420005">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6420009">t</span><span class="op" id="6420010">.</span><span class="ident" id="6420011">Error</span><span class="op" id="6420016">(</span><span class="ident" id="6420017">err</span><span class="op" id="6420020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420023">}</span><br>
<span class="lineno"></span><span class="op" id="6420025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6420028">func</span>&nbsp;<span class="ident" id="6420033">TestDialDualStackLocalhost</span><span class="op" id="6420059">(</span><span class="ident" id="6420060">t</span>&nbsp;<span class="op" id="6420062">*</span><span class="ident" id="6420063">testing</span><span class="op" id="6420070">.</span><span class="ident" id="6420071">T</span><span class="op" id="6420072">)</span>&nbsp;<span class="op" id="6420074">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6420077">switch</span>&nbsp;<span class="ident" id="6420084">runtime</span><span class="op" id="6420091">.</span><span class="ident" id="6420092">GOOS</span>&nbsp;<span class="op" id="6420097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6420100">case</span>&nbsp;<span class="string" id="6420105">&#34;nacl&#34;</span><span class="op" id="6420111">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6420115">t</span><span class="op" id="6420116">.</span><span class="ident" id="6420117">Skipf</span><span class="op" id="6420122">(</span><span class="string" id="6420123">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6420144">,</span>&nbsp;<span class="ident" id="6420146">runtime</span><span class="op" id="6420153">.</span><span class="ident" id="6420154">GOOS</span><span class="op" id="6420158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6420165">if</span>&nbsp;<span class="ident" id="6420168">ips</span><span class="op" id="6420171">,</span>&nbsp;<span class="ident" id="6420173">err</span>&nbsp;<span class="op" id="6420177">:=</span>&nbsp;<span class="ident" id="6420180">LookupIP</span><span class="op" id="6420188">(</span><span class="string" id="6420189">&#34;localhost&#34;</span><span class="op" id="6420200">)</span><span class="op" id="6420201">;</span>&nbsp;<span class="ident" id="6420203">err</span>&nbsp;<span class="op" id="6420207">!=</span>&nbsp;<span class="builtintype" id="6420210">nil</span>&nbsp;<span class="op" id="6420214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6420218">t</span><span class="op" id="6420219">.</span><span class="ident" id="6420220">Fatalf</span><span class="op" id="6420226">(</span><span class="string" id="6420227">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6420248">,</span>&nbsp;<span class="ident" id="6420250">err</span><span class="op" id="6420253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420256">}</span>&nbsp;<span class="keyword" id="6420258">else</span>&nbsp;<span class="keyword" id="6420263">if</span>&nbsp;<span class="builtinfunc" id="6420266">len</span><span class="op" id="6420269">(</span><span class="ident" id="6420270">ips</span><span class="op" id="6420273">)</span>&nbsp;<span class="op" id="6420275">&lt;</span>&nbsp;<span class="num" id="6420277">2</span>&nbsp;<span class="op" id="6420279">||</span>&nbsp;<span class="op" id="6420282">!</span><span class="ident" id="6420283">supportsIPv4</span>&nbsp;<span class="op" id="6420296">||</span>&nbsp;<span class="op" id="6420299">!</span><span class="ident" id="6420300">supportsIPv6</span>&nbsp;<span class="op" id="6420313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6420317">t</span><span class="op" id="6420318">.</span><span class="ident" id="6420319">Skip</span><span class="op" id="6420323">(</span><span class="string" id="6420324">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="6420396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420399">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6420403">touchAndByeServer</span>&nbsp;<span class="op" id="6420421">:=</span>&nbsp;<span class="keyword" id="6420424">func</span><span class="op" id="6420428">(</span><span class="ident" id="6420429">dss</span>&nbsp;<span class="op" id="6420433">*</span><span class="ident" id="6420434">dualStackServer</span><span class="op" id="6420449">,</span>&nbsp;<span class="ident" id="6420451">ln</span>&nbsp;<span class="ident" id="6420454">Listener</span><span class="op" id="6420462">)</span>&nbsp;<span class="op" id="6420464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6420468">for</span>&nbsp;<span class="op" id="6420472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6420477">if</span>&nbsp;<span class="ident" id="6420480">c</span><span class="op" id="6420481">,</span>&nbsp;<span class="ident" id="6420483">err</span>&nbsp;<span class="op" id="6420487">:=</span>&nbsp;<span class="ident" id="6420490">ln</span><span class="op" id="6420492">.</span><span class="ident" id="6420493">Accept</span><span class="op" id="6420499">(</span><span class="op" id="6420500">)</span><span class="op" id="6420501">;</span>&nbsp;<span class="ident" id="6420503">err</span>&nbsp;<span class="op" id="6420507">!=</span>&nbsp;<span class="builtintype" id="6420510">nil</span>&nbsp;<span class="op" id="6420514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6420520">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420530">}</span>&nbsp;<span class="keyword" id="6420532">else</span>&nbsp;<span class="op" id="6420537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6420543">c</span><span class="op" id="6420544">.</span><span class="ident" id="6420545">Close</span><span class="op" id="6420550">(</span><span class="op" id="6420551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420563">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6420566">dss</span><span class="op" id="6420569">,</span>&nbsp;<span class="ident" id="6420571">err</span>&nbsp;<span class="op" id="6420575">:=</span>&nbsp;<span class="ident" id="6420578">newDualStackServer</span><span class="op" id="6420596">(</span><span class="op" id="6420597">[</span><span class="op" id="6420598">]</span><span class="ident" id="6420599">streamListener</span><span class="op" id="6420613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420617">{</span><span class="ident" id="6420618">net</span><span class="op" id="6420621">:</span>&nbsp;<span class="string" id="6420623">&#34;tcp4&#34;</span><span class="op" id="6420629">,</span>&nbsp;<span class="ident" id="6420631">addr</span><span class="op" id="6420635">:</span>&nbsp;<span class="string" id="6420637">&#34;127.0.0.1&#34;</span><span class="op" id="6420648">}</span><span class="op" id="6420649">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420653">{</span><span class="ident" id="6420654">net</span><span class="op" id="6420657">:</span>&nbsp;<span class="string" id="6420659">&#34;tcp6&#34;</span><span class="op" id="6420665">,</span>&nbsp;<span class="ident" id="6420667">addr</span><span class="op" id="6420671">:</span>&nbsp;<span class="string" id="6420673">&#34;[::1]&#34;</span><span class="op" id="6420680">}</span><span class="op" id="6420681">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420684">}</span><span class="op" id="6420685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6420688">if</span>&nbsp;<span class="ident" id="6420691">err</span>&nbsp;<span class="op" id="6420695">!=</span>&nbsp;<span class="builtintype" id="6420698">nil</span>&nbsp;<span class="op" id="6420702">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6420706">t</span><span class="op" id="6420707">.</span><span class="ident" id="6420708">Fatalf</span><span class="op" id="6420714">(</span><span class="string" id="6420715">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6420746">,</span>&nbsp;<span class="ident" id="6420748">err</span><span class="op" id="6420751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6420757">defer</span>&nbsp;<span class="ident" id="6420763">dss</span><span class="op" id="6420766">.</span><span class="ident" id="6420767">teardown</span><span class="op" id="6420775">(</span><span class="op" id="6420776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6420779">if</span>&nbsp;<span class="ident" id="6420782">err</span>&nbsp;<span class="op" id="6420786">:=</span>&nbsp;<span class="ident" id="6420789">dss</span><span class="op" id="6420792">.</span><span class="ident" id="6420793">buildup</span><span class="op" id="6420800">(</span><span class="ident" id="6420801">touchAndByeServer</span><span class="op" id="6420818">)</span><span class="op" id="6420819">;</span>&nbsp;<span class="ident" id="6420821">err</span>&nbsp;<span class="op" id="6420825">!=</span>&nbsp;<span class="builtintype" id="6420828">nil</span>&nbsp;<span class="op" id="6420832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6420836">t</span><span class="op" id="6420837">.</span><span class="ident" id="6420838">Fatalf</span><span class="op" id="6420844">(</span><span class="string" id="6420845">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6420881">,</span>&nbsp;<span class="ident" id="6420883">err</span><span class="op" id="6420886">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6420889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6420893">d</span>&nbsp;<span class="op" id="6420895">:=</span>&nbsp;<span class="op" id="6420898">&amp;</span><span class="ident" id="6420899">Dialer</span><span class="op" id="6420905">{</span><span class="ident" id="6420906">DualStack</span><span class="op" id="6420915">:</span>&nbsp;<span class="builtintype" id="6420917">true</span><span class="op" id="6420921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6420924">for</span>&nbsp;<span class="keyword" id="6420928">range</span>&nbsp;<span class="ident" id="6420934">dss</span><span class="op" id="6420937">.</span><span class="ident" id="6420938">lns</span>&nbsp;<span class="op" id="6420942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6420946">if</span>&nbsp;<span class="ident" id="6420949">c</span><span class="op" id="6420950">,</span>&nbsp;<span class="ident" id="6420952">err</span>&nbsp;<span class="op" id="6420956">:=</span>&nbsp;<span class="ident" id="6420959">d</span><span class="op" id="6420960">.</span><span class="ident" id="6420961">Dial</span><span class="op" id="6420965">(</span><span class="string" id="6420966">&#34;tcp&#34;</span><span class="op" id="6420971">,</span>&nbsp;<span class="string" id="6420973">&#34;localhost:&#34;</span><span class="op" id="6420985">+</span><span class="ident" id="6420986">dss</span><span class="op" id="6420989">.</span><span class="ident" id="6420990">port</span><span class="op" id="6420994">)</span><span class="op" id="6420995">;</span>&nbsp;<span class="ident" id="6420997">err</span>&nbsp;<span class="op" id="6421001">!=</span>&nbsp;<span class="builtintype" id="6421004">nil</span>&nbsp;<span class="op" id="6421008">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421013">t</span><span class="op" id="6421014">.</span><span class="ident" id="6421015">Errorf</span><span class="op" id="6421021">(</span><span class="string" id="6421022">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6421039">,</span>&nbsp;<span class="ident" id="6421041">err</span><span class="op" id="6421044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421048">}</span>&nbsp;<span class="keyword" id="6421050">else</span>&nbsp;<span class="op" id="6421055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421060">if</span>&nbsp;<span class="ident" id="6421063">addr</span>&nbsp;<span class="op" id="6421068">:=</span>&nbsp;<span class="ident" id="6421071">c</span><span class="op" id="6421072">.</span><span class="ident" id="6421073">LocalAddr</span><span class="op" id="6421082">(</span><span class="op" id="6421083">)</span><span class="op" id="6421084">.</span><span class="op" id="6421085">(</span><span class="op" id="6421086">*</span><span class="ident" id="6421087">TCPAddr</span><span class="op" id="6421094">)</span><span class="op" id="6421095">;</span>&nbsp;<span class="ident" id="6421097">addr</span><span class="op" id="6421101">.</span><span class="ident" id="6421102">IP</span><span class="op" id="6421104">.</span><span class="ident" id="6421105">To4</span><span class="op" id="6421108">(</span><span class="op" id="6421109">)</span>&nbsp;<span class="op" id="6421111">!=</span>&nbsp;<span class="builtintype" id="6421114">nil</span>&nbsp;<span class="op" id="6421118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421124">dss</span><span class="op" id="6421127">.</span><span class="ident" id="6421128">teardownNetwork</span><span class="op" id="6421143">(</span><span class="string" id="6421144">&#34;tcp4&#34;</span><span class="op" id="6421150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421155">}</span>&nbsp;<span class="keyword" id="6421157">else</span>&nbsp;<span class="keyword" id="6421162">if</span>&nbsp;<span class="ident" id="6421165">addr</span><span class="op" id="6421169">.</span><span class="ident" id="6421170">IP</span><span class="op" id="6421172">.</span><span class="ident" id="6421173">To16</span><span class="op" id="6421177">(</span><span class="op" id="6421178">)</span>&nbsp;<span class="op" id="6421180">!=</span>&nbsp;<span class="builtintype" id="6421183">nil</span>&nbsp;<span class="op" id="6421187">&amp;&amp;</span>&nbsp;<span class="ident" id="6421190">addr</span><span class="op" id="6421194">.</span><span class="ident" id="6421195">IP</span><span class="op" id="6421197">.</span><span class="ident" id="6421198">To4</span><span class="op" id="6421201">(</span><span class="op" id="6421202">)</span>&nbsp;<span class="op" id="6421204">==</span>&nbsp;<span class="builtintype" id="6421207">nil</span>&nbsp;<span class="op" id="6421211">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421217">dss</span><span class="op" id="6421220">.</span><span class="ident" id="6421221">teardownNetwork</span><span class="op" id="6421236">(</span><span class="string" id="6421237">&#34;tcp6&#34;</span><span class="op" id="6421243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421253">c</span><span class="op" id="6421254">.</span><span class="ident" id="6421255">Close</span><span class="op" id="6421260">(</span><span class="op" id="6421261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421268">}</span><br>
<span class="lineno">515</span><span class="op" id="6421270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6421273">func</span>&nbsp;<span class="ident" id="6421278">TestDialerKeepAlive</span><span class="op" id="6421297">(</span><span class="ident" id="6421298">t</span>&nbsp;<span class="op" id="6421300">*</span><span class="ident" id="6421301">testing</span><span class="op" id="6421308">.</span><span class="ident" id="6421309">T</span><span class="op" id="6421310">)</span>&nbsp;<span class="op" id="6421312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421315">ln</span>&nbsp;<span class="op" id="6421318">:=</span>&nbsp;<span class="ident" id="6421321">newLocalListener</span><span class="op" id="6421337">(</span><span class="ident" id="6421338">t</span><span class="op" id="6421339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421342">defer</span>&nbsp;<span class="ident" id="6421348">ln</span><span class="op" id="6421350">.</span><span class="ident" id="6421351">Close</span><span class="op" id="6421356">(</span><span class="op" id="6421357">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421360">defer</span>&nbsp;<span class="keyword" id="6421366">func</span><span class="op" id="6421370">(</span><span class="op" id="6421371">)</span>&nbsp;<span class="op" id="6421373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421377">testHookSetKeepAlive</span>&nbsp;<span class="op" id="6421398">=</span>&nbsp;<span class="keyword" id="6421400">func</span><span class="op" id="6421404">(</span><span class="op" id="6421405">)</span>&nbsp;<span class="op" id="6421407">{</span><span class="op" id="6421408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421411">}</span><span class="op" id="6421412">(</span><span class="op" id="6421413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421416">go</span>&nbsp;<span class="keyword" id="6421419">func</span><span class="op" id="6421423">(</span><span class="op" id="6421424">)</span>&nbsp;<span class="op" id="6421426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421430">for</span>&nbsp;<span class="op" id="6421434">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421439">c</span><span class="op" id="6421440">,</span>&nbsp;<span class="ident" id="6421442">err</span>&nbsp;<span class="op" id="6421446">:=</span>&nbsp;<span class="ident" id="6421449">ln</span><span class="op" id="6421451">.</span><span class="ident" id="6421452">Accept</span><span class="op" id="6421458">(</span><span class="op" id="6421459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421464">if</span>&nbsp;<span class="ident" id="6421467">err</span>&nbsp;<span class="op" id="6421471">!=</span>&nbsp;<span class="builtintype" id="6421474">nil</span>&nbsp;<span class="op" id="6421478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421484">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421499">c</span><span class="op" id="6421500">.</span><span class="ident" id="6421501">Close</span><span class="op" id="6421506">(</span><span class="op" id="6421507">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421514">}</span><span class="op" id="6421515">(</span><span class="op" id="6421516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421519">for</span>&nbsp;<span class="ident" id="6421523">_</span><span class="op" id="6421524">,</span>&nbsp;<span class="ident" id="6421526">keepAlive</span>&nbsp;<span class="op" id="6421536">:=</span>&nbsp;<span class="keyword" id="6421539">range</span>&nbsp;<span class="op" id="6421545">[</span><span class="op" id="6421546">]</span><span class="builtintype" id="6421547">bool</span><span class="op" id="6421551">{</span><span class="builtintype" id="6421552">false</span><span class="op" id="6421557">,</span>&nbsp;<span class="builtintype" id="6421559">true</span><span class="op" id="6421563">}</span>&nbsp;<span class="op" id="6421565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421569">got</span>&nbsp;<span class="op" id="6421573">:=</span>&nbsp;<span class="builtintype" id="6421576">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421584">testHookSetKeepAlive</span>&nbsp;<span class="op" id="6421605">=</span>&nbsp;<span class="keyword" id="6421607">func</span><span class="op" id="6421611">(</span><span class="op" id="6421612">)</span>&nbsp;<span class="op" id="6421614">{</span>&nbsp;<span class="ident" id="6421616">got</span>&nbsp;<span class="op" id="6421620">=</span>&nbsp;<span class="builtintype" id="6421622">true</span>&nbsp;<span class="op" id="6421627">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421631">var</span>&nbsp;<span class="ident" id="6421635">d</span>&nbsp;<span class="ident" id="6421637">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421646">if</span>&nbsp;<span class="ident" id="6421649">keepAlive</span>&nbsp;<span class="op" id="6421659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421664">d</span><span class="op" id="6421665">.</span><span class="ident" id="6421666">KeepAlive</span>&nbsp;<span class="op" id="6421676">=</span>&nbsp;<span class="num" id="6421678">30</span>&nbsp;<span class="op" id="6421681">*</span>&nbsp;<span class="ident" id="6421683">time</span><span class="op" id="6421687">.</span><span class="ident" id="6421688">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421701">c</span><span class="op" id="6421702">,</span>&nbsp;<span class="ident" id="6421704">err</span>&nbsp;<span class="op" id="6421708">:=</span>&nbsp;<span class="ident" id="6421711">d</span><span class="op" id="6421712">.</span><span class="ident" id="6421713">Dial</span><span class="op" id="6421717">(</span><span class="string" id="6421718">&#34;tcp&#34;</span><span class="op" id="6421723">,</span>&nbsp;<span class="ident" id="6421725">ln</span><span class="op" id="6421727">.</span><span class="ident" id="6421728">Addr</span><span class="op" id="6421732">(</span><span class="op" id="6421733">)</span><span class="op" id="6421734">.</span><span class="ident" id="6421735">String</span><span class="op" id="6421741">(</span><span class="op" id="6421742">)</span><span class="op" id="6421743">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421747">if</span>&nbsp;<span class="ident" id="6421750">err</span>&nbsp;<span class="op" id="6421754">!=</span>&nbsp;<span class="builtintype" id="6421757">nil</span>&nbsp;<span class="op" id="6421761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421766">t</span><span class="op" id="6421767">.</span><span class="ident" id="6421768">Fatal</span><span class="op" id="6421773">(</span><span class="ident" id="6421774">err</span><span class="op" id="6421777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421785">c</span><span class="op" id="6421786">.</span><span class="ident" id="6421787">Close</span><span class="op" id="6421792">(</span><span class="op" id="6421793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6421797">if</span>&nbsp;<span class="ident" id="6421800">got</span>&nbsp;<span class="op" id="6421804">!=</span>&nbsp;<span class="ident" id="6421807">keepAlive</span>&nbsp;<span class="op" id="6421817">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6421822">t</span><span class="op" id="6421823">.</span><span class="ident" id="6421824">Errorf</span><span class="op" id="6421830">(</span><span class="string" id="6421831">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="6421889">,</span>&nbsp;<span class="ident" id="6421891">d</span><span class="op" id="6421892">.</span><span class="ident" id="6421893">KeepAlive</span><span class="op" id="6421902">,</span>&nbsp;<span class="ident" id="6421904">got</span><span class="op" id="6421907">,</span>&nbsp;<span class="op" id="6421909">!</span><span class="ident" id="6421910">got</span><span class="op" id="6421913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6421920">}</span><br>
<span class="lineno"></span><span class="op" id="6421922">}</span>
</div>
</body>
</html>
