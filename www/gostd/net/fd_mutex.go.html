<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3165721">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3165776">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3165830">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3165881">package</span>&nbsp;<span class="ident" id="3165889">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3165894">import</span>&nbsp;<span class="string" id="3165901">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3165916">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="3165970">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="3166026">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="3166065">type</span>&nbsp;<span class="ident" id="3166070">fdMutex</span>&nbsp;<span class="keyword" id="3166078">struct</span>&nbsp;<span class="op" id="3166085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166088">state</span>&nbsp;<span class="ident" id="3166094">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166102">rsema</span>&nbsp;<span class="builtintype" id="3166108">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166116">wsema</span>&nbsp;<span class="builtintype" id="3166122">uint32</span><br>
<span class="lineno"></span><span class="op" id="3166129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3166132">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="3166174">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="3166259">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3166296">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3166334">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="3166393">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="3166442">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="3166492">const</span>&nbsp;<span class="op" id="3166498">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166501">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="3166514">=</span>&nbsp;<span class="num" id="3166516">1</span>&nbsp;<span class="op" id="3166518">&lt;&lt;</span>&nbsp;<span class="num" id="3166521">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166524">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3166537">=</span>&nbsp;<span class="num" id="3166539">1</span>&nbsp;<span class="op" id="3166541">&lt;&lt;</span>&nbsp;<span class="num" id="3166544">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166547">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3166560">=</span>&nbsp;<span class="num" id="3166562">1</span>&nbsp;<span class="op" id="3166564">&lt;&lt;</span>&nbsp;<span class="num" id="3166567">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166570">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3166583">=</span>&nbsp;<span class="num" id="3166585">1</span>&nbsp;<span class="op" id="3166587">&lt;&lt;</span>&nbsp;<span class="num" id="3166590">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166593">mutexRefMask</span>&nbsp;<span class="op" id="3166606">=</span>&nbsp;<span class="op" id="3166608">(</span><span class="num" id="3166609">1</span><span class="op" id="3166610">&lt;&lt;</span><span class="num" id="3166612">20</span>&nbsp;<span class="op" id="3166615">-</span>&nbsp;<span class="num" id="3166617">1</span><span class="op" id="3166618">)</span>&nbsp;<span class="op" id="3166620">&lt;&lt;</span>&nbsp;<span class="num" id="3166623">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166626">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3166639">=</span>&nbsp;<span class="num" id="3166641">1</span>&nbsp;<span class="op" id="3166643">&lt;&lt;</span>&nbsp;<span class="num" id="3166646">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166650">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3166663">=</span>&nbsp;<span class="op" id="3166665">(</span><span class="num" id="3166666">1</span><span class="op" id="3166667">&lt;&lt;</span><span class="num" id="3166669">20</span>&nbsp;<span class="op" id="3166672">-</span>&nbsp;<span class="num" id="3166674">1</span><span class="op" id="3166675">)</span>&nbsp;<span class="op" id="3166677">&lt;&lt;</span>&nbsp;<span class="num" id="3166680">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166684">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3166697">=</span>&nbsp;<span class="num" id="3166699">1</span>&nbsp;<span class="op" id="3166701">&lt;&lt;</span>&nbsp;<span class="num" id="3166704">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3166708">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3166721">=</span>&nbsp;<span class="op" id="3166723">(</span><span class="num" id="3166724">1</span><span class="op" id="3166725">&lt;&lt;</span><span class="num" id="3166727">20</span>&nbsp;<span class="op" id="3166730">-</span>&nbsp;<span class="num" id="3166732">1</span><span class="op" id="3166733">)</span>&nbsp;<span class="op" id="3166735">&lt;&lt;</span>&nbsp;<span class="num" id="3166738">43</span><br>
<span class="lineno">35</span><span class="op" id="3166741">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3166744">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="3166800">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="3166859">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="3166940">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3167017">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="3167090">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="3167140">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3167191">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="3167235">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3167322">func</span>&nbsp;<span class="op" id="3167327">(</span><span class="ident" id="3167328">mu</span>&nbsp;<span class="op" id="3167331">*</span><span class="ident" id="3167332">fdMutex</span><span class="op" id="3167339">)</span>&nbsp;<span class="ident" id="3167341">Incref</span><span class="op" id="3167347">(</span><span class="op" id="3167348">)</span>&nbsp;<span class="builtintype" id="3167350">bool</span>&nbsp;<span class="op" id="3167355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167358">for</span>&nbsp;<span class="op" id="3167362">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167366">old</span>&nbsp;<span class="op" id="3167370">:=</span>&nbsp;<span class="ident" id="3167373">atomic</span><span class="op" id="3167379">.</span><span class="ident" id="3167380">LoadUint64</span><span class="op" id="3167390">(</span><span class="op" id="3167391">&amp;</span><span class="ident" id="3167392">mu</span><span class="op" id="3167394">.</span><span class="ident" id="3167395">state</span><span class="op" id="3167400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167404">if</span>&nbsp;<span class="ident" id="3167407">old</span><span class="op" id="3167410">&amp;</span><span class="ident" id="3167411">mutexClosed</span>&nbsp;<span class="op" id="3167423">!=</span>&nbsp;<span class="num" id="3167426">0</span>&nbsp;<span class="op" id="3167428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167433">return</span>&nbsp;<span class="builtintype" id="3167440">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3167448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3167452">new</span>&nbsp;<span class="op" id="3167456">:=</span>&nbsp;<span class="ident" id="3167459">old</span>&nbsp;<span class="op" id="3167463">+</span>&nbsp;<span class="ident" id="3167465">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167476">if</span>&nbsp;<span class="builtinfunc" id="3167479">new</span><span class="op" id="3167482">&amp;</span><span class="ident" id="3167483">mutexRefMask</span>&nbsp;<span class="op" id="3167496">==</span>&nbsp;<span class="num" id="3167499">0</span>&nbsp;<span class="op" id="3167501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3167506">panic</span><span class="op" id="3167511">(</span><span class="string" id="3167512">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3167539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3167543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167547">if</span>&nbsp;<span class="ident" id="3167550">atomic</span><span class="op" id="3167556">.</span><span class="ident" id="3167557">CompareAndSwapUint64</span><span class="op" id="3167577">(</span><span class="op" id="3167578">&amp;</span><span class="ident" id="3167579">mu</span><span class="op" id="3167581">.</span><span class="ident" id="3167582">state</span><span class="op" id="3167587">,</span>&nbsp;<span class="ident" id="3167589">old</span><span class="op" id="3167592">,</span>&nbsp;<span class="builtinfunc" id="3167594">new</span><span class="op" id="3167597">)</span>&nbsp;<span class="op" id="3167599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167604">return</span>&nbsp;<span class="builtintype" id="3167611">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3167618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3167621">}</span><br>
<span class="lineno"></span><span class="op" id="3167623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3167626">func</span>&nbsp;<span class="op" id="3167631">(</span><span class="ident" id="3167632">mu</span>&nbsp;<span class="op" id="3167635">*</span><span class="ident" id="3167636">fdMutex</span><span class="op" id="3167643">)</span>&nbsp;<span class="ident" id="3167645">IncrefAndClose</span><span class="op" id="3167659">(</span><span class="op" id="3167660">)</span>&nbsp;<span class="builtintype" id="3167662">bool</span>&nbsp;<span class="op" id="3167667">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167670">for</span>&nbsp;<span class="op" id="3167674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3167678">old</span>&nbsp;<span class="op" id="3167682">:=</span>&nbsp;<span class="ident" id="3167685">atomic</span><span class="op" id="3167691">.</span><span class="ident" id="3167692">LoadUint64</span><span class="op" id="3167702">(</span><span class="op" id="3167703">&amp;</span><span class="ident" id="3167704">mu</span><span class="op" id="3167706">.</span><span class="ident" id="3167707">state</span><span class="op" id="3167712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167716">if</span>&nbsp;<span class="ident" id="3167719">old</span><span class="op" id="3167722">&amp;</span><span class="ident" id="3167723">mutexClosed</span>&nbsp;<span class="op" id="3167735">!=</span>&nbsp;<span class="num" id="3167738">0</span>&nbsp;<span class="op" id="3167740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167745">return</span>&nbsp;<span class="builtintype" id="3167752">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3167760">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3167764">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3167809">new</span>&nbsp;<span class="op" id="3167813">:=</span>&nbsp;<span class="op" id="3167816">(</span><span class="ident" id="3167817">old</span>&nbsp;<span class="op" id="3167821">|</span>&nbsp;<span class="ident" id="3167823">mutexClosed</span><span class="op" id="3167834">)</span>&nbsp;<span class="op" id="3167836">+</span>&nbsp;<span class="ident" id="3167838">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167849">if</span>&nbsp;<span class="builtinfunc" id="3167852">new</span><span class="op" id="3167855">&amp;</span><span class="ident" id="3167856">mutexRefMask</span>&nbsp;<span class="op" id="3167869">==</span>&nbsp;<span class="num" id="3167872">0</span>&nbsp;<span class="op" id="3167874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3167879">panic</span><span class="op" id="3167884">(</span><span class="string" id="3167885">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3167912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3167916">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3167920">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3167960">new</span>&nbsp;<span class="op" id="3167964">&amp;^=</span>&nbsp;<span class="ident" id="3167968">mutexRMask</span>&nbsp;<span class="op" id="3167979">|</span>&nbsp;<span class="ident" id="3167981">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3167994">if</span>&nbsp;<span class="ident" id="3167997">atomic</span><span class="op" id="3168003">.</span><span class="ident" id="3168004">CompareAndSwapUint64</span><span class="op" id="3168024">(</span><span class="op" id="3168025">&amp;</span><span class="ident" id="3168026">mu</span><span class="op" id="3168028">.</span><span class="ident" id="3168029">state</span><span class="op" id="3168034">,</span>&nbsp;<span class="ident" id="3168036">old</span><span class="op" id="3168039">,</span>&nbsp;<span class="builtinfunc" id="3168041">new</span><span class="op" id="3168044">)</span>&nbsp;<span class="op" id="3168046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3168051">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3168090">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168140">for</span>&nbsp;<span class="ident" id="3168144">old</span><span class="op" id="3168147">&amp;</span><span class="ident" id="3168148">mutexRMask</span>&nbsp;<span class="op" id="3168159">!=</span>&nbsp;<span class="num" id="3168162">0</span>&nbsp;<span class="op" id="3168164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168170">old</span>&nbsp;<span class="op" id="3168174">-=</span>&nbsp;<span class="ident" id="3168177">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168192">runtime_Semrelease</span><span class="op" id="3168210">(</span><span class="op" id="3168211">&amp;</span><span class="ident" id="3168212">mu</span><span class="op" id="3168214">.</span><span class="ident" id="3168215">rsema</span><span class="op" id="3168220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168230">for</span>&nbsp;<span class="ident" id="3168234">old</span><span class="op" id="3168237">&amp;</span><span class="ident" id="3168238">mutexWMask</span>&nbsp;<span class="op" id="3168249">!=</span>&nbsp;<span class="num" id="3168252">0</span>&nbsp;<span class="op" id="3168254">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168260">old</span>&nbsp;<span class="op" id="3168264">-=</span>&nbsp;<span class="ident" id="3168267">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168282">runtime_Semrelease</span><span class="op" id="3168300">(</span><span class="op" id="3168301">&amp;</span><span class="ident" id="3168302">mu</span><span class="op" id="3168304">.</span><span class="ident" id="3168305">wsema</span><span class="op" id="3168310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168320">return</span>&nbsp;<span class="builtintype" id="3168327">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168334">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168337">}</span><br>
<span class="lineno"></span><span class="op" id="3168339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3168342">func</span>&nbsp;<span class="op" id="3168347">(</span><span class="ident" id="3168348">mu</span>&nbsp;<span class="op" id="3168351">*</span><span class="ident" id="3168352">fdMutex</span><span class="op" id="3168359">)</span>&nbsp;<span class="ident" id="3168361">Decref</span><span class="op" id="3168367">(</span><span class="op" id="3168368">)</span>&nbsp;<span class="builtintype" id="3168370">bool</span>&nbsp;<span class="op" id="3168375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168378">for</span>&nbsp;<span class="op" id="3168382">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168386">old</span>&nbsp;<span class="op" id="3168390">:=</span>&nbsp;<span class="ident" id="3168393">atomic</span><span class="op" id="3168399">.</span><span class="ident" id="3168400">LoadUint64</span><span class="op" id="3168410">(</span><span class="op" id="3168411">&amp;</span><span class="ident" id="3168412">mu</span><span class="op" id="3168414">.</span><span class="ident" id="3168415">state</span><span class="op" id="3168420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168424">if</span>&nbsp;<span class="ident" id="3168427">old</span><span class="op" id="3168430">&amp;</span><span class="ident" id="3168431">mutexRefMask</span>&nbsp;<span class="op" id="3168444">==</span>&nbsp;<span class="num" id="3168447">0</span>&nbsp;<span class="op" id="3168449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3168454">panic</span><span class="op" id="3168459">(</span><span class="string" id="3168460">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3168487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3168495">new</span>&nbsp;<span class="op" id="3168499">:=</span>&nbsp;<span class="ident" id="3168502">old</span>&nbsp;<span class="op" id="3168506">-</span>&nbsp;<span class="ident" id="3168508">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168519">if</span>&nbsp;<span class="ident" id="3168522">atomic</span><span class="op" id="3168528">.</span><span class="ident" id="3168529">CompareAndSwapUint64</span><span class="op" id="3168549">(</span><span class="op" id="3168550">&amp;</span><span class="ident" id="3168551">mu</span><span class="op" id="3168553">.</span><span class="ident" id="3168554">state</span><span class="op" id="3168559">,</span>&nbsp;<span class="ident" id="3168561">old</span><span class="op" id="3168564">,</span>&nbsp;<span class="builtinfunc" id="3168566">new</span><span class="op" id="3168569">)</span>&nbsp;<span class="op" id="3168571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168576">return</span>&nbsp;<span class="builtinfunc" id="3168583">new</span><span class="op" id="3168586">&amp;</span><span class="op" id="3168587">(</span><span class="ident" id="3168588">mutexClosed</span><span class="op" id="3168599">|</span><span class="ident" id="3168600">mutexRefMask</span><span class="op" id="3168612">)</span>&nbsp;<span class="op" id="3168614">==</span>&nbsp;<span class="ident" id="3168617">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168634">}</span><br>
<span class="lineno"></span><span class="op" id="3168636">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3168639">func</span>&nbsp;<span class="op" id="3168644">(</span><span class="ident" id="3168645">mu</span>&nbsp;<span class="op" id="3168648">*</span><span class="ident" id="3168649">fdMutex</span><span class="op" id="3168656">)</span>&nbsp;<span class="ident" id="3168658">RWLock</span><span class="op" id="3168664">(</span><span class="ident" id="3168665">read</span>&nbsp;<span class="builtintype" id="3168670">bool</span><span class="op" id="3168674">)</span>&nbsp;<span class="builtintype" id="3168676">bool</span>&nbsp;<span class="op" id="3168681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168684">var</span>&nbsp;<span class="ident" id="3168688">mutexBit</span><span class="op" id="3168696">,</span>&nbsp;<span class="ident" id="3168698">mutexWait</span><span class="op" id="3168707">,</span>&nbsp;<span class="ident" id="3168709">mutexMask</span>&nbsp;<span class="ident" id="3168719">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168727">var</span>&nbsp;<span class="ident" id="3168731">mutexSema</span>&nbsp;<span class="op" id="3168741">*</span><span class="builtintype" id="3168742">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168750">if</span>&nbsp;<span class="ident" id="3168753">read</span>&nbsp;<span class="op" id="3168758">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168762">mutexBit</span>&nbsp;<span class="op" id="3168771">=</span>&nbsp;<span class="ident" id="3168773">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168786">mutexWait</span>&nbsp;<span class="op" id="3168796">=</span>&nbsp;<span class="ident" id="3168798">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168811">mutexMask</span>&nbsp;<span class="op" id="3168821">=</span>&nbsp;<span class="ident" id="3168823">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168836">mutexSema</span>&nbsp;<span class="op" id="3168846">=</span>&nbsp;<span class="op" id="3168848">&amp;</span><span class="ident" id="3168849">mu</span><span class="op" id="3168851">.</span><span class="ident" id="3168852">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168859">}</span>&nbsp;<span class="keyword" id="3168861">else</span>&nbsp;<span class="op" id="3168866">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168870">mutexBit</span>&nbsp;<span class="op" id="3168879">=</span>&nbsp;<span class="ident" id="3168881">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168894">mutexWait</span>&nbsp;<span class="op" id="3168904">=</span>&nbsp;<span class="ident" id="3168906">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168919">mutexMask</span>&nbsp;<span class="op" id="3168929">=</span>&nbsp;<span class="ident" id="3168931">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168944">mutexSema</span>&nbsp;<span class="op" id="3168954">=</span>&nbsp;<span class="op" id="3168956">&amp;</span><span class="ident" id="3168957">mu</span><span class="op" id="3168959">.</span><span class="ident" id="3168960">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3168967">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3168970">for</span>&nbsp;<span class="op" id="3168974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3168978">old</span>&nbsp;<span class="op" id="3168982">:=</span>&nbsp;<span class="ident" id="3168985">atomic</span><span class="op" id="3168991">.</span><span class="ident" id="3168992">LoadUint64</span><span class="op" id="3169002">(</span><span class="op" id="3169003">&amp;</span><span class="ident" id="3169004">mu</span><span class="op" id="3169006">.</span><span class="ident" id="3169007">state</span><span class="op" id="3169012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169016">if</span>&nbsp;<span class="ident" id="3169019">old</span><span class="op" id="3169022">&amp;</span><span class="ident" id="3169023">mutexClosed</span>&nbsp;<span class="op" id="3169035">!=</span>&nbsp;<span class="num" id="3169038">0</span>&nbsp;<span class="op" id="3169040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169045">return</span>&nbsp;<span class="builtintype" id="3169052">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169060">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169064">var</span>&nbsp;<span class="builtinfunc" id="3169068">new</span>&nbsp;<span class="ident" id="3169072">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169081">if</span>&nbsp;<span class="ident" id="3169084">old</span><span class="op" id="3169087">&amp;</span><span class="ident" id="3169088">mutexBit</span>&nbsp;<span class="op" id="3169097">==</span>&nbsp;<span class="num" id="3169100">0</span>&nbsp;<span class="op" id="3169102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3169107">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3169139">new</span>&nbsp;<span class="op" id="3169143">=</span>&nbsp;<span class="op" id="3169145">(</span><span class="ident" id="3169146">old</span>&nbsp;<span class="op" id="3169150">|</span>&nbsp;<span class="ident" id="3169152">mutexBit</span><span class="op" id="3169160">)</span>&nbsp;<span class="op" id="3169162">+</span>&nbsp;<span class="ident" id="3169164">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169176">if</span>&nbsp;<span class="builtinfunc" id="3169179">new</span><span class="op" id="3169182">&amp;</span><span class="ident" id="3169183">mutexRefMask</span>&nbsp;<span class="op" id="3169196">==</span>&nbsp;<span class="num" id="3169199">0</span>&nbsp;<span class="op" id="3169201">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3169207">panic</span><span class="op" id="3169212">(</span><span class="string" id="3169213">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3169240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169249">}</span>&nbsp;<span class="keyword" id="3169251">else</span>&nbsp;<span class="op" id="3169256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3169261">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3169282">new</span>&nbsp;<span class="op" id="3169286">=</span>&nbsp;<span class="ident" id="3169288">old</span>&nbsp;<span class="op" id="3169292">+</span>&nbsp;<span class="ident" id="3169294">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169307">if</span>&nbsp;<span class="builtinfunc" id="3169310">new</span><span class="op" id="3169313">&amp;</span><span class="ident" id="3169314">mutexMask</span>&nbsp;<span class="op" id="3169324">==</span>&nbsp;<span class="num" id="3169327">0</span>&nbsp;<span class="op" id="3169329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3169335">panic</span><span class="op" id="3169340">(</span><span class="string" id="3169341">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3169368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169381">if</span>&nbsp;<span class="ident" id="3169384">atomic</span><span class="op" id="3169390">.</span><span class="ident" id="3169391">CompareAndSwapUint64</span><span class="op" id="3169411">(</span><span class="op" id="3169412">&amp;</span><span class="ident" id="3169413">mu</span><span class="op" id="3169415">.</span><span class="ident" id="3169416">state</span><span class="op" id="3169421">,</span>&nbsp;<span class="ident" id="3169423">old</span><span class="op" id="3169426">,</span>&nbsp;<span class="builtinfunc" id="3169428">new</span><span class="op" id="3169431">)</span>&nbsp;<span class="op" id="3169433">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169438">if</span>&nbsp;<span class="ident" id="3169441">old</span><span class="op" id="3169444">&amp;</span><span class="ident" id="3169445">mutexBit</span>&nbsp;<span class="op" id="3169454">==</span>&nbsp;<span class="num" id="3169457">0</span>&nbsp;<span class="op" id="3169459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169465">return</span>&nbsp;<span class="builtintype" id="3169472">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169485">runtime_Semacquire</span><span class="op" id="3169503">(</span><span class="ident" id="3169504">mutexSema</span><span class="op" id="3169513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3169518">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169566">}</span><br>
<span class="lineno"></span><span class="op" id="3169568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3169571">func</span>&nbsp;<span class="op" id="3169576">(</span><span class="ident" id="3169577">mu</span>&nbsp;<span class="op" id="3169580">*</span><span class="ident" id="3169581">fdMutex</span><span class="op" id="3169588">)</span>&nbsp;<span class="ident" id="3169590">RWUnlock</span><span class="op" id="3169598">(</span><span class="ident" id="3169599">read</span>&nbsp;<span class="builtintype" id="3169604">bool</span><span class="op" id="3169608">)</span>&nbsp;<span class="builtintype" id="3169610">bool</span>&nbsp;<span class="op" id="3169615">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169618">var</span>&nbsp;<span class="ident" id="3169622">mutexBit</span><span class="op" id="3169630">,</span>&nbsp;<span class="ident" id="3169632">mutexWait</span><span class="op" id="3169641">,</span>&nbsp;<span class="ident" id="3169643">mutexMask</span>&nbsp;<span class="ident" id="3169653">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169661">var</span>&nbsp;<span class="ident" id="3169665">mutexSema</span>&nbsp;<span class="op" id="3169675">*</span><span class="builtintype" id="3169676">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169684">if</span>&nbsp;<span class="ident" id="3169687">read</span>&nbsp;<span class="op" id="3169692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169696">mutexBit</span>&nbsp;<span class="op" id="3169705">=</span>&nbsp;<span class="ident" id="3169707">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169720">mutexWait</span>&nbsp;<span class="op" id="3169730">=</span>&nbsp;<span class="ident" id="3169732">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169745">mutexMask</span>&nbsp;<span class="op" id="3169755">=</span>&nbsp;<span class="ident" id="3169757">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169770">mutexSema</span>&nbsp;<span class="op" id="3169780">=</span>&nbsp;<span class="op" id="3169782">&amp;</span><span class="ident" id="3169783">mu</span><span class="op" id="3169785">.</span><span class="ident" id="3169786">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169793">}</span>&nbsp;<span class="keyword" id="3169795">else</span>&nbsp;<span class="op" id="3169800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169804">mutexBit</span>&nbsp;<span class="op" id="3169813">=</span>&nbsp;<span class="ident" id="3169815">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169828">mutexWait</span>&nbsp;<span class="op" id="3169838">=</span>&nbsp;<span class="ident" id="3169840">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169853">mutexMask</span>&nbsp;<span class="op" id="3169863">=</span>&nbsp;<span class="ident" id="3169865">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169878">mutexSema</span>&nbsp;<span class="op" id="3169888">=</span>&nbsp;<span class="op" id="3169890">&amp;</span><span class="ident" id="3169891">mu</span><span class="op" id="3169893">.</span><span class="ident" id="3169894">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3169901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169904">for</span>&nbsp;<span class="op" id="3169908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3169912">old</span>&nbsp;<span class="op" id="3169916">:=</span>&nbsp;<span class="ident" id="3169919">atomic</span><span class="op" id="3169925">.</span><span class="ident" id="3169926">LoadUint64</span><span class="op" id="3169936">(</span><span class="op" id="3169937">&amp;</span><span class="ident" id="3169938">mu</span><span class="op" id="3169940">.</span><span class="ident" id="3169941">state</span><span class="op" id="3169946">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3169950">if</span>&nbsp;<span class="ident" id="3169953">old</span><span class="op" id="3169956">&amp;</span><span class="ident" id="3169957">mutexBit</span>&nbsp;<span class="op" id="3169966">==</span>&nbsp;<span class="num" id="3169969">0</span>&nbsp;<span class="op" id="3169971">||</span>&nbsp;<span class="ident" id="3169974">old</span><span class="op" id="3169977">&amp;</span><span class="ident" id="3169978">mutexRefMask</span>&nbsp;<span class="op" id="3169991">==</span>&nbsp;<span class="num" id="3169994">0</span>&nbsp;<span class="op" id="3169996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3170001">panic</span><span class="op" id="3170006">(</span><span class="string" id="3170007">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3170034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3170042">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3170106">new</span>&nbsp;<span class="op" id="3170110">:=</span>&nbsp;<span class="op" id="3170113">(</span><span class="ident" id="3170114">old</span>&nbsp;<span class="op" id="3170118">&amp;^</span>&nbsp;<span class="ident" id="3170121">mutexBit</span><span class="op" id="3170129">)</span>&nbsp;<span class="op" id="3170131">-</span>&nbsp;<span class="ident" id="3170133">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170144">if</span>&nbsp;<span class="ident" id="3170147">old</span><span class="op" id="3170150">&amp;</span><span class="ident" id="3170151">mutexMask</span>&nbsp;<span class="op" id="3170161">!=</span>&nbsp;<span class="num" id="3170164">0</span>&nbsp;<span class="op" id="3170166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3170171">new</span>&nbsp;<span class="op" id="3170175">-=</span>&nbsp;<span class="ident" id="3170178">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170194">if</span>&nbsp;<span class="ident" id="3170197">atomic</span><span class="op" id="3170203">.</span><span class="ident" id="3170204">CompareAndSwapUint64</span><span class="op" id="3170224">(</span><span class="op" id="3170225">&amp;</span><span class="ident" id="3170226">mu</span><span class="op" id="3170228">.</span><span class="ident" id="3170229">state</span><span class="op" id="3170234">,</span>&nbsp;<span class="ident" id="3170236">old</span><span class="op" id="3170239">,</span>&nbsp;<span class="builtinfunc" id="3170241">new</span><span class="op" id="3170244">)</span>&nbsp;<span class="op" id="3170246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170251">if</span>&nbsp;<span class="ident" id="3170254">old</span><span class="op" id="3170257">&amp;</span><span class="ident" id="3170258">mutexMask</span>&nbsp;<span class="op" id="3170268">!=</span>&nbsp;<span class="num" id="3170271">0</span>&nbsp;<span class="op" id="3170273">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3170279">runtime_Semrelease</span><span class="op" id="3170297">(</span><span class="ident" id="3170298">mutexSema</span><span class="op" id="3170307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3170317">return</span>&nbsp;<span class="builtinfunc" id="3170324">new</span><span class="op" id="3170327">&amp;</span><span class="op" id="3170328">(</span><span class="ident" id="3170329">mutexClosed</span><span class="op" id="3170340">|</span><span class="ident" id="3170341">mutexRefMask</span><span class="op" id="3170353">)</span>&nbsp;<span class="op" id="3170355">==</span>&nbsp;<span class="ident" id="3170358">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3170375">}</span><br>
<span class="lineno">180</span><span class="op" id="3170377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3170380">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3170415">func</span>&nbsp;<span class="ident" id="3170420">runtime_Semacquire</span><span class="op" id="3170438">(</span><span class="ident" id="3170439">sema</span>&nbsp;<span class="op" id="3170444">*</span><span class="builtintype" id="3170445">uint32</span><span class="op" id="3170451">)</span><br>
<span class="lineno"></span><span class="keyword" id="3170453">func</span>&nbsp;<span class="ident" id="3170458">runtime_Semrelease</span><span class="op" id="3170476">(</span><span class="ident" id="3170477">sema</span>&nbsp;<span class="op" id="3170482">*</span><span class="builtintype" id="3170483">uint32</span><span class="op" id="3170489">)</span>
</div>
</body>
</html>
