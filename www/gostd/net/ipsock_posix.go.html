<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html" class="current">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3793788">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3793844">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3793898">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3793949">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3794027">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3794074">package</span>&nbsp;<span class="ident" id="3794082">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3794087">import</span>&nbsp;<span class="op" id="3794094">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3794097">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3794108">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3794115">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3794118">func</span>&nbsp;<span class="ident" id="3794123">probeIPv4Stack</span><span class="op" id="3794137">(</span><span class="op" id="3794138">)</span>&nbsp;<span class="builtintype" id="3794140">bool</span>&nbsp;<span class="op" id="3794145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3794148">s</span><span class="op" id="3794149">,</span>&nbsp;<span class="ident" id="3794151">err</span>&nbsp;<span class="op" id="3794155">:=</span>&nbsp;<span class="ident" id="3794158">syscall</span><span class="op" id="3794165">.</span><span class="ident" id="3794166">Socket</span><span class="op" id="3794172">(</span><span class="ident" id="3794173">syscall</span><span class="op" id="3794180">.</span><span class="ident" id="3794181">AF_INET</span><span class="op" id="3794188">,</span>&nbsp;<span class="ident" id="3794190">syscall</span><span class="op" id="3794197">.</span><span class="ident" id="3794198">SOCK_STREAM</span><span class="op" id="3794209">,</span>&nbsp;<span class="ident" id="3794211">syscall</span><span class="op" id="3794218">.</span><span class="ident" id="3794219">IPPROTO_TCP</span><span class="op" id="3794230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3794233">switch</span>&nbsp;<span class="ident" id="3794240">err</span>&nbsp;<span class="op" id="3794244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3794247">case</span>&nbsp;<span class="ident" id="3794252">syscall</span><span class="op" id="3794259">.</span><span class="ident" id="3794260">EAFNOSUPPORT</span><span class="op" id="3794272">,</span>&nbsp;<span class="ident" id="3794274">syscall</span><span class="op" id="3794281">.</span><span class="ident" id="3794282">EPROTONOSUPPORT</span><span class="op" id="3794297">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3794301">return</span>&nbsp;<span class="builtintype" id="3794308">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3794315">case</span>&nbsp;<span class="builtintype" id="3794320">nil</span><span class="op" id="3794323">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3794327">closesocket</span><span class="op" id="3794338">(</span><span class="ident" id="3794339">s</span><span class="op" id="3794340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3794343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3794346">return</span>&nbsp;<span class="builtintype" id="3794353">true</span><br>
<span class="lineno">25</span><span class="op" id="3794358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3794361">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="3794420">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="3794483">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="3794549">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="3794610">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="3794673">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3794728">//</span><br>
<span class="lineno"></span><span class="comment" id="3794731">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="3794798">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="3794862">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3794916">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3794981">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="3795047">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="3795108">func</span>&nbsp;<span class="ident" id="3795113">probeIPv6Stack</span><span class="op" id="3795127">(</span><span class="op" id="3795128">)</span>&nbsp;<span class="op" id="3795130">(</span><span class="ident" id="3795131">supportsIPv6</span><span class="op" id="3795143">,</span>&nbsp;<span class="ident" id="3795145">supportsIPv4map</span>&nbsp;<span class="builtintype" id="3795161">bool</span><span class="op" id="3795165">)</span>&nbsp;<span class="op" id="3795167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3795170">var</span>&nbsp;<span class="ident" id="3795174">probes</span>&nbsp;<span class="op" id="3795181">=</span>&nbsp;<span class="op" id="3795183">[</span><span class="op" id="3795184">]</span><span class="keyword" id="3795185">struct</span>&nbsp;<span class="op" id="3795192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3795196">laddr</span>&nbsp;<span class="ident" id="3795202">TCPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3795212">value</span>&nbsp;<span class="builtintype" id="3795218">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3795224">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3795230">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3795236">}</span><span class="op" id="3795237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3795241">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3795276">{</span><span class="ident" id="3795277">laddr</span><span class="op" id="3795282">:</span>&nbsp;<span class="ident" id="3795284">TCPAddr</span><span class="op" id="3795291">{</span><span class="ident" id="3795292">IP</span><span class="op" id="3795294">:</span>&nbsp;<span class="ident" id="3795296">ParseIP</span><span class="op" id="3795303">(</span><span class="string" id="3795304">&#34;::1&#34;</span><span class="op" id="3795309">)</span><span class="op" id="3795310">}</span><span class="op" id="3795311">,</span>&nbsp;<span class="ident" id="3795313">value</span><span class="op" id="3795318">:</span>&nbsp;<span class="num" id="3795320">1</span><span class="op" id="3795321">}</span><span class="op" id="3795322">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3795326">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3795381">{</span><span class="ident" id="3795382">laddr</span><span class="op" id="3795387">:</span>&nbsp;<span class="ident" id="3795389">TCPAddr</span><span class="op" id="3795396">{</span><span class="ident" id="3795397">IP</span><span class="op" id="3795399">:</span>&nbsp;<span class="ident" id="3795401">IPv4</span><span class="op" id="3795405">(</span><span class="num" id="3795406">127</span><span class="op" id="3795409">,</span>&nbsp;<span class="num" id="3795411">0</span><span class="op" id="3795412">,</span>&nbsp;<span class="num" id="3795414">0</span><span class="op" id="3795415">,</span>&nbsp;<span class="num" id="3795417">1</span><span class="op" id="3795418">)</span><span class="op" id="3795419">}</span><span class="op" id="3795420">,</span>&nbsp;<span class="ident" id="3795422">value</span><span class="op" id="3795427">:</span>&nbsp;<span class="num" id="3795429">0</span><span class="op" id="3795430">}</span><span class="op" id="3795431">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3795434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3795438">for</span>&nbsp;<span class="ident" id="3795442">i</span>&nbsp;<span class="op" id="3795444">:=</span>&nbsp;<span class="keyword" id="3795447">range</span>&nbsp;<span class="ident" id="3795453">probes</span>&nbsp;<span class="op" id="3795460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3795464">s</span><span class="op" id="3795465">,</span>&nbsp;<span class="ident" id="3795467">err</span>&nbsp;<span class="op" id="3795471">:=</span>&nbsp;<span class="ident" id="3795474">syscall</span><span class="op" id="3795481">.</span><span class="ident" id="3795482">Socket</span><span class="op" id="3795488">(</span><span class="ident" id="3795489">syscall</span><span class="op" id="3795496">.</span><span class="ident" id="3795497">AF_INET6</span><span class="op" id="3795505">,</span>&nbsp;<span class="ident" id="3795507">syscall</span><span class="op" id="3795514">.</span><span class="ident" id="3795515">SOCK_STREAM</span><span class="op" id="3795526">,</span>&nbsp;<span class="ident" id="3795528">syscall</span><span class="op" id="3795535">.</span><span class="ident" id="3795536">IPPROTO_TCP</span><span class="op" id="3795547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3795551">if</span>&nbsp;<span class="ident" id="3795554">err</span>&nbsp;<span class="op" id="3795558">!=</span>&nbsp;<span class="builtintype" id="3795561">nil</span>&nbsp;<span class="op" id="3795565">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3795570">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3795581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3795585">defer</span>&nbsp;<span class="ident" id="3795591">closesocket</span><span class="op" id="3795602">(</span><span class="ident" id="3795603">s</span><span class="op" id="3795604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3795608">syscall</span><span class="op" id="3795615">.</span><span class="ident" id="3795616">SetsockoptInt</span><span class="op" id="3795629">(</span><span class="ident" id="3795630">s</span><span class="op" id="3795631">,</span>&nbsp;<span class="ident" id="3795633">syscall</span><span class="op" id="3795640">.</span><span class="ident" id="3795641">IPPROTO_IPV6</span><span class="op" id="3795653">,</span>&nbsp;<span class="ident" id="3795655">syscall</span><span class="op" id="3795662">.</span><span class="ident" id="3795663">IPV6_V6ONLY</span><span class="op" id="3795674">,</span>&nbsp;<span class="ident" id="3795676">probes</span><span class="op" id="3795682">[</span><span class="ident" id="3795683">i</span><span class="op" id="3795684">]</span><span class="op" id="3795685">.</span><span class="ident" id="3795686">value</span><span class="op" id="3795691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3795695">sa</span><span class="op" id="3795697">,</span>&nbsp;<span class="ident" id="3795699">err</span>&nbsp;<span class="op" id="3795703">:=</span>&nbsp;<span class="ident" id="3795706">probes</span><span class="op" id="3795712">[</span><span class="ident" id="3795713">i</span><span class="op" id="3795714">]</span><span class="op" id="3795715">.</span><span class="ident" id="3795716">laddr</span><span class="op" id="3795721">.</span><span class="ident" id="3795722">sockaddr</span><span class="op" id="3795730">(</span><span class="ident" id="3795731">syscall</span><span class="op" id="3795738">.</span><span class="ident" id="3795739">AF_INET6</span><span class="op" id="3795747">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3795751">if</span>&nbsp;<span class="ident" id="3795754">err</span>&nbsp;<span class="op" id="3795758">!=</span>&nbsp;<span class="builtintype" id="3795761">nil</span>&nbsp;<span class="op" id="3795765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3795770">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3795781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3795785">if</span>&nbsp;<span class="ident" id="3795788">err</span>&nbsp;<span class="op" id="3795792">:=</span>&nbsp;<span class="ident" id="3795795">syscall</span><span class="op" id="3795802">.</span><span class="ident" id="3795803">Bind</span><span class="op" id="3795807">(</span><span class="ident" id="3795808">s</span><span class="op" id="3795809">,</span>&nbsp;<span class="ident" id="3795811">sa</span><span class="op" id="3795813">)</span><span class="op" id="3795814">;</span>&nbsp;<span class="ident" id="3795816">err</span>&nbsp;<span class="op" id="3795820">!=</span>&nbsp;<span class="builtintype" id="3795823">nil</span>&nbsp;<span class="op" id="3795827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3795832">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3795843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3795847">probes</span><span class="op" id="3795853">[</span><span class="ident" id="3795854">i</span><span class="op" id="3795855">]</span><span class="op" id="3795856">.</span><span class="ident" id="3795857">ok</span>&nbsp;<span class="op" id="3795860">=</span>&nbsp;<span class="builtintype" id="3795862">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3795868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3795872">return</span>&nbsp;<span class="ident" id="3795879">probes</span><span class="op" id="3795885">[</span><span class="num" id="3795886">0</span><span class="op" id="3795887">]</span><span class="op" id="3795888">.</span><span class="ident" id="3795889">ok</span><span class="op" id="3795891">,</span>&nbsp;<span class="ident" id="3795893">probes</span><span class="op" id="3795899">[</span><span class="num" id="3795900">1</span><span class="op" id="3795901">]</span><span class="op" id="3795902">.</span><span class="ident" id="3795903">ok</span><br>
<span class="lineno">70</span><span class="op" id="3795906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3795909">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3795973">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="3796035">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="3796099">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3796161">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="3796227">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="3796291">//</span><br>
<span class="lineno"></span><span class="comment" id="3796294">//&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="3796331">//&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="3796391">//&nbsp;&nbsp;&nbsp;&nbsp;capabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3796450">//&nbsp;&nbsp;&nbsp;&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="3796506">//&nbsp;&nbsp;&nbsp;&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="3796565">//&nbsp;&nbsp;&nbsp;&nbsp;wildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="3796616">//</span><br>
<span class="lineno"></span><span class="comment" id="3796619">//&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3796667">//&nbsp;&nbsp;&nbsp;&nbsp;Same&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3796681">//</span><br>
<span class="lineno"></span><span class="comment" id="3796684">//&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="3796729">//&nbsp;&nbsp;&nbsp;&nbsp;Almost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="3796788">//&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3796846">//&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="3796906">//&nbsp;&nbsp;&nbsp;&nbsp;mapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="3796929">//</span><br>
<span class="lineno">95</span><span class="comment" id="3796932">//&nbsp;&nbsp;&nbsp;&nbsp;4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3796987">//&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3797040">//</span><br>
<span class="lineno"></span><span class="comment" id="3797043">//&nbsp;&nbsp;&nbsp;&nbsp;5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3797095">//&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="3797156">//&nbsp;&nbsp;&nbsp;&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3797167">//</span><br>
<span class="lineno"></span><span class="comment" id="3797170">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="3797238">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="3797305">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="3797339">//</span><br>
<span class="lineno"></span><span class="comment" id="3797342">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="3797410">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="3797471">func</span>&nbsp;<span class="ident" id="3797476">favoriteAddrFamily</span><span class="op" id="3797494">(</span><span class="ident" id="3797495">net</span>&nbsp;<span class="builtintype" id="3797499">string</span><span class="op" id="3797505">,</span>&nbsp;<span class="ident" id="3797507">laddr</span><span class="op" id="3797512">,</span>&nbsp;<span class="ident" id="3797514">raddr</span>&nbsp;<span class="ident" id="3797520">sockaddr</span><span class="op" id="3797528">,</span>&nbsp;<span class="ident" id="3797530">mode</span>&nbsp;<span class="builtintype" id="3797535">string</span><span class="op" id="3797541">)</span>&nbsp;<span class="op" id="3797543">(</span><span class="ident" id="3797544">family</span>&nbsp;<span class="builtintype" id="3797551">int</span><span class="op" id="3797554">,</span>&nbsp;<span class="ident" id="3797556">ipv6only</span>&nbsp;<span class="builtintype" id="3797565">bool</span><span class="op" id="3797569">)</span>&nbsp;<span class="op" id="3797571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797574">switch</span>&nbsp;<span class="ident" id="3797581">net</span><span class="op" id="3797584">[</span><span class="builtinfunc" id="3797585">len</span><span class="op" id="3797588">(</span><span class="ident" id="3797589">net</span><span class="op" id="3797592">)</span><span class="op" id="3797593">-</span><span class="num" id="3797594">1</span><span class="op" id="3797595">]</span>&nbsp;<span class="op" id="3797597">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797600">case</span>&nbsp;<span class="string" id="3797605">&#39;4&#39;</span><span class="op" id="3797608">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797612">return</span>&nbsp;<span class="ident" id="3797619">syscall</span><span class="op" id="3797626">.</span><span class="ident" id="3797627">AF_INET</span><span class="op" id="3797634">,</span>&nbsp;<span class="builtintype" id="3797636">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797643">case</span>&nbsp;<span class="string" id="3797648">&#39;6&#39;</span><span class="op" id="3797651">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797655">return</span>&nbsp;<span class="ident" id="3797662">syscall</span><span class="op" id="3797669">.</span><span class="ident" id="3797670">AF_INET6</span><span class="op" id="3797678">,</span>&nbsp;<span class="builtintype" id="3797680">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3797686">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797690">if</span>&nbsp;<span class="ident" id="3797693">mode</span>&nbsp;<span class="op" id="3797698">==</span>&nbsp;<span class="string" id="3797701">&#34;listen&#34;</span>&nbsp;<span class="op" id="3797710">&amp;&amp;</span>&nbsp;<span class="op" id="3797713">(</span><span class="ident" id="3797714">laddr</span>&nbsp;<span class="op" id="3797720">==</span>&nbsp;<span class="builtintype" id="3797723">nil</span>&nbsp;<span class="op" id="3797727">||</span>&nbsp;<span class="ident" id="3797730">laddr</span><span class="op" id="3797735">.</span><span class="ident" id="3797736">isWildcard</span><span class="op" id="3797746">(</span><span class="op" id="3797747">)</span><span class="op" id="3797748">)</span>&nbsp;<span class="op" id="3797750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797754">if</span>&nbsp;<span class="ident" id="3797757">supportsIPv4map</span>&nbsp;<span class="op" id="3797773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797778">return</span>&nbsp;<span class="ident" id="3797785">syscall</span><span class="op" id="3797792">.</span><span class="ident" id="3797793">AF_INET6</span><span class="op" id="3797801">,</span>&nbsp;<span class="builtintype" id="3797803">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3797811">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797815">if</span>&nbsp;<span class="ident" id="3797818">laddr</span>&nbsp;<span class="op" id="3797824">==</span>&nbsp;<span class="builtintype" id="3797827">nil</span>&nbsp;<span class="op" id="3797831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797836">return</span>&nbsp;<span class="ident" id="3797843">syscall</span><span class="op" id="3797850">.</span><span class="ident" id="3797851">AF_INET</span><span class="op" id="3797858">,</span>&nbsp;<span class="builtintype" id="3797860">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3797868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797872">return</span>&nbsp;<span class="ident" id="3797879">laddr</span><span class="op" id="3797884">.</span><span class="ident" id="3797885">family</span><span class="op" id="3797891">(</span><span class="op" id="3797892">)</span><span class="op" id="3797893">,</span>&nbsp;<span class="builtintype" id="3797895">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3797902">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3797906">if</span>&nbsp;<span class="op" id="3797909">(</span><span class="ident" id="3797910">laddr</span>&nbsp;<span class="op" id="3797916">==</span>&nbsp;<span class="builtintype" id="3797919">nil</span>&nbsp;<span class="op" id="3797923">||</span>&nbsp;<span class="ident" id="3797926">laddr</span><span class="op" id="3797931">.</span><span class="ident" id="3797932">family</span><span class="op" id="3797938">(</span><span class="op" id="3797939">)</span>&nbsp;<span class="op" id="3797941">==</span>&nbsp;<span class="ident" id="3797944">syscall</span><span class="op" id="3797951">.</span><span class="ident" id="3797952">AF_INET</span><span class="op" id="3797959">)</span>&nbsp;<span class="op" id="3797961">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3797966">(</span><span class="ident" id="3797967">raddr</span>&nbsp;<span class="op" id="3797973">==</span>&nbsp;<span class="builtintype" id="3797976">nil</span>&nbsp;<span class="op" id="3797980">||</span>&nbsp;<span class="ident" id="3797983">raddr</span><span class="op" id="3797988">.</span><span class="ident" id="3797989">family</span><span class="op" id="3797995">(</span><span class="op" id="3797996">)</span>&nbsp;<span class="op" id="3797998">==</span>&nbsp;<span class="ident" id="3798001">syscall</span><span class="op" id="3798008">.</span><span class="ident" id="3798009">AF_INET</span><span class="op" id="3798016">)</span>&nbsp;<span class="op" id="3798018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798022">return</span>&nbsp;<span class="ident" id="3798029">syscall</span><span class="op" id="3798036">.</span><span class="ident" id="3798037">AF_INET</span><span class="op" id="3798044">,</span>&nbsp;<span class="builtintype" id="3798046">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3798053">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798056">return</span>&nbsp;<span class="ident" id="3798063">syscall</span><span class="op" id="3798070">.</span><span class="ident" id="3798071">AF_INET6</span><span class="op" id="3798079">,</span>&nbsp;<span class="builtintype" id="3798081">false</span><br>
<span class="lineno"></span><span class="op" id="3798087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3798090">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="3798126">func</span>&nbsp;<span class="ident" id="3798131">internetSocket</span><span class="op" id="3798145">(</span><span class="ident" id="3798146">net</span>&nbsp;<span class="builtintype" id="3798150">string</span><span class="op" id="3798156">,</span>&nbsp;<span class="ident" id="3798158">laddr</span><span class="op" id="3798163">,</span>&nbsp;<span class="ident" id="3798165">raddr</span>&nbsp;<span class="ident" id="3798171">sockaddr</span><span class="op" id="3798179">,</span>&nbsp;<span class="ident" id="3798181">deadline</span>&nbsp;<span class="ident" id="3798190">time</span><span class="op" id="3798194">.</span><span class="ident" id="3798195">Time</span><span class="op" id="3798199">,</span>&nbsp;<span class="ident" id="3798201">sotype</span><span class="op" id="3798207">,</span>&nbsp;<span class="ident" id="3798209">proto</span>&nbsp;<span class="builtintype" id="3798215">int</span><span class="op" id="3798218">,</span>&nbsp;<span class="ident" id="3798220">mode</span>&nbsp;<span class="builtintype" id="3798225">string</span><span class="op" id="3798231">)</span>&nbsp;<span class="op" id="3798233">(</span><span class="ident" id="3798234">fd</span>&nbsp;<span class="op" id="3798237">*</span><span class="ident" id="3798238">netFD</span><span class="op" id="3798243">,</span>&nbsp;<span class="ident" id="3798245">err</span>&nbsp;<span class="builtintype" id="3798249">error</span><span class="op" id="3798254">)</span>&nbsp;<span class="op" id="3798256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3798259">family</span><span class="op" id="3798265">,</span>&nbsp;<span class="ident" id="3798267">ipv6only</span>&nbsp;<span class="op" id="3798276">:=</span>&nbsp;<span class="ident" id="3798279">favoriteAddrFamily</span><span class="op" id="3798297">(</span><span class="ident" id="3798298">net</span><span class="op" id="3798301">,</span>&nbsp;<span class="ident" id="3798303">laddr</span><span class="op" id="3798308">,</span>&nbsp;<span class="ident" id="3798310">raddr</span><span class="op" id="3798315">,</span>&nbsp;<span class="ident" id="3798317">mode</span><span class="op" id="3798321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798324">return</span>&nbsp;<span class="ident" id="3798331">socket</span><span class="op" id="3798337">(</span><span class="ident" id="3798338">net</span><span class="op" id="3798341">,</span>&nbsp;<span class="ident" id="3798343">family</span><span class="op" id="3798349">,</span>&nbsp;<span class="ident" id="3798351">sotype</span><span class="op" id="3798357">,</span>&nbsp;<span class="ident" id="3798359">proto</span><span class="op" id="3798364">,</span>&nbsp;<span class="ident" id="3798366">ipv6only</span><span class="op" id="3798374">,</span>&nbsp;<span class="ident" id="3798376">laddr</span><span class="op" id="3798381">,</span>&nbsp;<span class="ident" id="3798383">raddr</span><span class="op" id="3798388">,</span>&nbsp;<span class="ident" id="3798390">deadline</span><span class="op" id="3798398">)</span><br>
<span class="lineno"></span><span class="op" id="3798400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3798403">func</span>&nbsp;<span class="ident" id="3798408">ipToSockaddr</span><span class="op" id="3798420">(</span><span class="ident" id="3798421">family</span>&nbsp;<span class="builtintype" id="3798428">int</span><span class="op" id="3798431">,</span>&nbsp;<span class="ident" id="3798433">ip</span>&nbsp;<span class="ident" id="3798436">IP</span><span class="op" id="3798438">,</span>&nbsp;<span class="ident" id="3798440">port</span>&nbsp;<span class="builtintype" id="3798445">int</span><span class="op" id="3798448">,</span>&nbsp;<span class="ident" id="3798450">zone</span>&nbsp;<span class="builtintype" id="3798455">string</span><span class="op" id="3798461">)</span>&nbsp;<span class="op" id="3798463">(</span><span class="ident" id="3798464">syscall</span><span class="op" id="3798471">.</span><span class="ident" id="3798472">Sockaddr</span><span class="op" id="3798480">,</span>&nbsp;<span class="builtintype" id="3798482">error</span><span class="op" id="3798487">)</span>&nbsp;<span class="op" id="3798489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798492">switch</span>&nbsp;<span class="ident" id="3798499">family</span>&nbsp;<span class="op" id="3798506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798509">case</span>&nbsp;<span class="ident" id="3798514">syscall</span><span class="op" id="3798521">.</span><span class="ident" id="3798522">AF_INET</span><span class="op" id="3798529">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798533">if</span>&nbsp;<span class="builtinfunc" id="3798536">len</span><span class="op" id="3798539">(</span><span class="ident" id="3798540">ip</span><span class="op" id="3798542">)</span>&nbsp;<span class="op" id="3798544">==</span>&nbsp;<span class="num" id="3798547">0</span>&nbsp;<span class="op" id="3798549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3798554">ip</span>&nbsp;<span class="op" id="3798557">=</span>&nbsp;<span class="ident" id="3798559">IPv4zero</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3798570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798574">if</span>&nbsp;<span class="ident" id="3798577">ip</span>&nbsp;<span class="op" id="3798580">=</span>&nbsp;<span class="ident" id="3798582">ip</span><span class="op" id="3798584">.</span><span class="ident" id="3798585">To4</span><span class="op" id="3798588">(</span><span class="op" id="3798589">)</span><span class="op" id="3798590">;</span>&nbsp;<span class="ident" id="3798592">ip</span>&nbsp;<span class="op" id="3798595">==</span>&nbsp;<span class="builtintype" id="3798598">nil</span>&nbsp;<span class="op" id="3798602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798607">return</span>&nbsp;<span class="builtintype" id="3798614">nil</span><span class="op" id="3798617">,</span>&nbsp;<span class="ident" id="3798619">InvalidAddrError</span><span class="op" id="3798635">(</span><span class="string" id="3798636">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="3798654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3798658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3798662">sa</span>&nbsp;<span class="op" id="3798665">:=</span>&nbsp;<span class="builtinfunc" id="3798668">new</span><span class="op" id="3798671">(</span><span class="ident" id="3798672">syscall</span><span class="op" id="3798679">.</span><span class="ident" id="3798680">SockaddrInet4</span><span class="op" id="3798693">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798697">for</span>&nbsp;<span class="ident" id="3798701">i</span>&nbsp;<span class="op" id="3798703">:=</span>&nbsp;<span class="num" id="3798706">0</span><span class="op" id="3798707">;</span>&nbsp;<span class="ident" id="3798709">i</span>&nbsp;<span class="op" id="3798711">&lt;</span>&nbsp;<span class="ident" id="3798713">IPv4len</span><span class="op" id="3798720">;</span>&nbsp;<span class="ident" id="3798722">i</span><span class="op" id="3798723">++</span>&nbsp;<span class="op" id="3798726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3798731">sa</span><span class="op" id="3798733">.</span><span class="ident" id="3798734">Addr</span><span class="op" id="3798738">[</span><span class="ident" id="3798739">i</span><span class="op" id="3798740">]</span>&nbsp;<span class="op" id="3798742">=</span>&nbsp;<span class="ident" id="3798744">ip</span><span class="op" id="3798746">[</span><span class="ident" id="3798747">i</span><span class="op" id="3798748">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3798752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3798756">sa</span><span class="op" id="3798758">.</span><span class="ident" id="3798759">Port</span>&nbsp;<span class="op" id="3798764">=</span>&nbsp;<span class="ident" id="3798766">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798773">return</span>&nbsp;<span class="ident" id="3798780">sa</span><span class="op" id="3798782">,</span>&nbsp;<span class="builtintype" id="3798784">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798789">case</span>&nbsp;<span class="ident" id="3798794">syscall</span><span class="op" id="3798801">.</span><span class="ident" id="3798802">AF_INET6</span><span class="op" id="3798810">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3798814">if</span>&nbsp;<span class="builtinfunc" id="3798817">len</span><span class="op" id="3798820">(</span><span class="ident" id="3798821">ip</span><span class="op" id="3798823">)</span>&nbsp;<span class="op" id="3798825">==</span>&nbsp;<span class="num" id="3798828">0</span>&nbsp;<span class="op" id="3798830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3798835">ip</span>&nbsp;<span class="op" id="3798838">=</span>&nbsp;<span class="ident" id="3798840">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3798851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3798855">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3798930">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3799001">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3799072">if</span>&nbsp;<span class="ident" id="3799075">ip</span><span class="op" id="3799077">.</span><span class="ident" id="3799078">Equal</span><span class="op" id="3799083">(</span><span class="ident" id="3799084">IPv4zero</span><span class="op" id="3799092">)</span>&nbsp;<span class="op" id="3799094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3799099">ip</span>&nbsp;<span class="op" id="3799102">=</span>&nbsp;<span class="ident" id="3799104">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3799115">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3799119">if</span>&nbsp;<span class="ident" id="3799122">ip</span>&nbsp;<span class="op" id="3799125">=</span>&nbsp;<span class="ident" id="3799127">ip</span><span class="op" id="3799129">.</span><span class="ident" id="3799130">To16</span><span class="op" id="3799134">(</span><span class="op" id="3799135">)</span><span class="op" id="3799136">;</span>&nbsp;<span class="ident" id="3799138">ip</span>&nbsp;<span class="op" id="3799141">==</span>&nbsp;<span class="builtintype" id="3799144">nil</span>&nbsp;<span class="op" id="3799148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3799153">return</span>&nbsp;<span class="builtintype" id="3799160">nil</span><span class="op" id="3799163">,</span>&nbsp;<span class="ident" id="3799165">InvalidAddrError</span><span class="op" id="3799181">(</span><span class="string" id="3799182">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="3799200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3799204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3799208">sa</span>&nbsp;<span class="op" id="3799211">:=</span>&nbsp;<span class="builtinfunc" id="3799214">new</span><span class="op" id="3799217">(</span><span class="ident" id="3799218">syscall</span><span class="op" id="3799225">.</span><span class="ident" id="3799226">SockaddrInet6</span><span class="op" id="3799239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3799243">for</span>&nbsp;<span class="ident" id="3799247">i</span>&nbsp;<span class="op" id="3799249">:=</span>&nbsp;<span class="num" id="3799252">0</span><span class="op" id="3799253">;</span>&nbsp;<span class="ident" id="3799255">i</span>&nbsp;<span class="op" id="3799257">&lt;</span>&nbsp;<span class="ident" id="3799259">IPv6len</span><span class="op" id="3799266">;</span>&nbsp;<span class="ident" id="3799268">i</span><span class="op" id="3799269">++</span>&nbsp;<span class="op" id="3799272">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3799277">sa</span><span class="op" id="3799279">.</span><span class="ident" id="3799280">Addr</span><span class="op" id="3799284">[</span><span class="ident" id="3799285">i</span><span class="op" id="3799286">]</span>&nbsp;<span class="op" id="3799288">=</span>&nbsp;<span class="ident" id="3799290">ip</span><span class="op" id="3799292">[</span><span class="ident" id="3799293">i</span><span class="op" id="3799294">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3799298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3799302">sa</span><span class="op" id="3799304">.</span><span class="ident" id="3799305">Port</span>&nbsp;<span class="op" id="3799310">=</span>&nbsp;<span class="ident" id="3799312">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3799319">sa</span><span class="op" id="3799321">.</span><span class="ident" id="3799322">ZoneId</span>&nbsp;<span class="op" id="3799329">=</span>&nbsp;<span class="builtintype" id="3799331">uint32</span><span class="op" id="3799337">(</span><span class="ident" id="3799338">zoneToInt</span><span class="op" id="3799347">(</span><span class="ident" id="3799348">zone</span><span class="op" id="3799352">)</span><span class="op" id="3799353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3799357">return</span>&nbsp;<span class="ident" id="3799364">sa</span><span class="op" id="3799366">,</span>&nbsp;<span class="builtintype" id="3799368">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3799373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3799376">return</span>&nbsp;<span class="builtintype" id="3799383">nil</span><span class="op" id="3799386">,</span>&nbsp;<span class="ident" id="3799388">InvalidAddrError</span><span class="op" id="3799404">(</span><span class="string" id="3799405">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="3799431">)</span><br>
<span class="lineno"></span><span class="op" id="3799433">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
