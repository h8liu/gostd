<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>text/template/parse</h2>
<ul>
<li><a href="/gostd/text/template/parse/lex.go.html">lex.go</a></li>
<li><a href="/gostd/text/template/parse/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/text/template/parse/node.go.html">node.go</a></li>
<li><a href="/gostd/text/template/parse/parse.go.html" class="current">parse.go</a></li>
<li><a href="/gostd/text/template/parse/parse_test.go.html">parse_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5163539">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5163594">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5163648">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5163699">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="5163777">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="5163856">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="5163932">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="5163961">package</span>&nbsp;<span class="ident" id="5163969">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5163976">import</span>&nbsp;<span class="op" id="5163983">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5163986">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5163995">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5164002">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5164013">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5164024">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="5164034">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5164037">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="5164096">type</span>&nbsp;<span class="ident" id="5164101">Tree</span>&nbsp;<span class="keyword" id="5164106">struct</span>&nbsp;<span class="op" id="5164113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164116">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5164126">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164136">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164186">ParseName</span>&nbsp;<span class="builtintype" id="5164196">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164206">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164277">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164287">*</span><span class="ident" id="5164288">ListNode</span>&nbsp;<span class="comment" id="5164297">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164329">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5164339">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164349">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5164404">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164443">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164453">[</span><span class="op" id="5164454">]</span><span class="keyword" id="5164455">map</span><span class="op" id="5164458">[</span><span class="builtintype" id="5164459">string</span><span class="op" id="5164465">]</span><span class="keyword" id="5164466">interface</span><span class="op" id="5164475">{</span><span class="op" id="5164476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164479">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164489">*</span><span class="ident" id="5164490">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164497">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164507">[</span><span class="num" id="5164508">3</span><span class="op" id="5164509">]</span><span class="ident" id="5164510">item</span>&nbsp;<span class="comment" id="5164515">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164553">peekCount</span>&nbsp;<span class="builtintype" id="5164563">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164568">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164578">[</span><span class="op" id="5164579">]</span><span class="builtintype" id="5164580">string</span>&nbsp;<span class="comment" id="5164587">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="5164623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5164626">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5164694">func</span>&nbsp;<span class="op" id="5164699">(</span><span class="ident" id="5164700">t</span>&nbsp;<span class="op" id="5164702">*</span><span class="ident" id="5164703">Tree</span><span class="op" id="5164707">)</span>&nbsp;<span class="ident" id="5164709">Copy</span><span class="op" id="5164713">(</span><span class="op" id="5164714">)</span>&nbsp;<span class="op" id="5164716">*</span><span class="ident" id="5164717">Tree</span>&nbsp;<span class="op" id="5164722">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164725">if</span>&nbsp;<span class="ident" id="5164728">t</span>&nbsp;<span class="op" id="5164730">==</span>&nbsp;<span class="ident" id="5164733">nil</span>&nbsp;<span class="op" id="5164737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164741">return</span>&nbsp;<span class="ident" id="5164748">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164756">return</span>&nbsp;<span class="op" id="5164763">&amp;</span><span class="ident" id="5164764">Tree</span><span class="op" id="5164768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164772">Name</span><span class="op" id="5164776">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164783">t</span><span class="op" id="5164784">.</span><span class="ident" id="5164785">Name</span><span class="op" id="5164789">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164793">ParseName</span><span class="op" id="5164802">:</span>&nbsp;<span class="ident" id="5164804">t</span><span class="op" id="5164805">.</span><span class="ident" id="5164806">ParseName</span><span class="op" id="5164815">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164819">Root</span><span class="op" id="5164823">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164830">t</span><span class="op" id="5164831">.</span><span class="ident" id="5164832">Root</span><span class="op" id="5164836">.</span><span class="ident" id="5164837">CopyList</span><span class="op" id="5164845">(</span><span class="op" id="5164846">)</span><span class="op" id="5164847">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164851">text</span><span class="op" id="5164855">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164862">t</span><span class="op" id="5164863">.</span><span class="ident" id="5164864">text</span><span class="op" id="5164868">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164871">}</span><br>
<span class="lineno"></span><span class="op" id="5164873">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="5164876">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5164956">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5165034">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5165112">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="5165153">func</span>&nbsp;<span class="ident" id="5165158">Parse</span><span class="op" id="5165163">(</span><span class="ident" id="5165164">name</span><span class="op" id="5165168">,</span>&nbsp;<span class="ident" id="5165170">text</span><span class="op" id="5165174">,</span>&nbsp;<span class="ident" id="5165176">leftDelim</span><span class="op" id="5165185">,</span>&nbsp;<span class="ident" id="5165187">rightDelim</span>&nbsp;<span class="builtintype" id="5165198">string</span><span class="op" id="5165204">,</span>&nbsp;<span class="ident" id="5165206">funcs</span>&nbsp;<span class="op" id="5165212">...</span><span class="keyword" id="5165215">map</span><span class="op" id="5165218">[</span><span class="builtintype" id="5165219">string</span><span class="op" id="5165225">]</span><span class="keyword" id="5165226">interface</span><span class="op" id="5165235">{</span><span class="op" id="5165236">}</span><span class="op" id="5165237">)</span>&nbsp;<span class="op" id="5165239">(</span><span class="ident" id="5165240">treeSet</span>&nbsp;<span class="keyword" id="5165248">map</span><span class="op" id="5165251">[</span><span class="builtintype" id="5165252">string</span><span class="op" id="5165258">]</span><span class="op" id="5165259">*</span><span class="ident" id="5165260">Tree</span><span class="op" id="5165264">,</span>&nbsp;<span class="ident" id="5165266">err</span>&nbsp;<span class="builtintype" id="5165270">error</span><span class="op" id="5165275">)</span>&nbsp;<span class="op" id="5165277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165280">treeSet</span>&nbsp;<span class="op" id="5165288">=</span>&nbsp;<span class="builtinfunc" id="5165290">make</span><span class="op" id="5165294">(</span><span class="keyword" id="5165295">map</span><span class="op" id="5165298">[</span><span class="builtintype" id="5165299">string</span><span class="op" id="5165305">]</span><span class="op" id="5165306">*</span><span class="ident" id="5165307">Tree</span><span class="op" id="5165311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165314">t</span>&nbsp;<span class="op" id="5165316">:=</span>&nbsp;<span class="ident" id="5165319">New</span><span class="op" id="5165322">(</span><span class="ident" id="5165323">name</span><span class="op" id="5165327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165330">t</span><span class="op" id="5165331">.</span><span class="ident" id="5165332">text</span>&nbsp;<span class="op" id="5165337">=</span>&nbsp;<span class="ident" id="5165339">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165345">_</span><span class="op" id="5165346">,</span>&nbsp;<span class="ident" id="5165348">err</span>&nbsp;<span class="op" id="5165352">=</span>&nbsp;<span class="ident" id="5165354">t</span><span class="op" id="5165355">.</span><span class="ident" id="5165356">Parse</span><span class="op" id="5165361">(</span><span class="ident" id="5165362">text</span><span class="op" id="5165366">,</span>&nbsp;<span class="ident" id="5165368">leftDelim</span><span class="op" id="5165377">,</span>&nbsp;<span class="ident" id="5165379">rightDelim</span><span class="op" id="5165389">,</span>&nbsp;<span class="ident" id="5165391">treeSet</span><span class="op" id="5165398">,</span>&nbsp;<span class="ident" id="5165400">funcs</span><span class="op" id="5165405">...</span><span class="op" id="5165408">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165411">return</span><br>
<span class="lineno"></span><span class="op" id="5165418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5165421">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="5165453">func</span>&nbsp;<span class="op" id="5165458">(</span><span class="ident" id="5165459">t</span>&nbsp;<span class="op" id="5165461">*</span><span class="ident" id="5165462">Tree</span><span class="op" id="5165466">)</span>&nbsp;<span class="ident" id="5165468">next</span><span class="op" id="5165472">(</span><span class="op" id="5165473">)</span>&nbsp;<span class="ident" id="5165475">item</span>&nbsp;<span class="op" id="5165480">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165483">if</span>&nbsp;<span class="ident" id="5165486">t</span><span class="op" id="5165487">.</span><span class="ident" id="5165488">peekCount</span>&nbsp;<span class="op" id="5165498">&gt;</span>&nbsp;<span class="num" id="5165500">0</span>&nbsp;<span class="op" id="5165502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165506">t</span><span class="op" id="5165507">.</span><span class="ident" id="5165508">peekCount</span><span class="op" id="5165517">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165521">}</span>&nbsp;<span class="keyword" id="5165523">else</span>&nbsp;<span class="op" id="5165528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165532">t</span><span class="op" id="5165533">.</span><span class="ident" id="5165534">token</span><span class="op" id="5165539">[</span><span class="num" id="5165540">0</span><span class="op" id="5165541">]</span>&nbsp;<span class="op" id="5165543">=</span>&nbsp;<span class="ident" id="5165545">t</span><span class="op" id="5165546">.</span><span class="ident" id="5165547">lex</span><span class="op" id="5165550">.</span><span class="ident" id="5165551">nextItem</span><span class="op" id="5165559">(</span><span class="op" id="5165560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165563">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165566">return</span>&nbsp;<span class="ident" id="5165573">t</span><span class="op" id="5165574">.</span><span class="ident" id="5165575">token</span><span class="op" id="5165580">[</span><span class="ident" id="5165581">t</span><span class="op" id="5165582">.</span><span class="ident" id="5165583">peekCount</span><span class="op" id="5165592">]</span><br>
<span class="lineno"></span><span class="op" id="5165594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5165597">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="5165644">func</span>&nbsp;<span class="op" id="5165649">(</span><span class="ident" id="5165650">t</span>&nbsp;<span class="op" id="5165652">*</span><span class="ident" id="5165653">Tree</span><span class="op" id="5165657">)</span>&nbsp;<span class="ident" id="5165659">backup</span><span class="op" id="5165665">(</span><span class="op" id="5165666">)</span>&nbsp;<span class="op" id="5165668">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165671">t</span><span class="op" id="5165672">.</span><span class="ident" id="5165673">peekCount</span><span class="op" id="5165682">++</span><br>
<span class="lineno"></span><span class="op" id="5165685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5165688">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="5165737">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="5165775">func</span>&nbsp;<span class="op" id="5165780">(</span><span class="ident" id="5165781">t</span>&nbsp;<span class="op" id="5165783">*</span><span class="ident" id="5165784">Tree</span><span class="op" id="5165788">)</span>&nbsp;<span class="ident" id="5165790">backup2</span><span class="op" id="5165797">(</span><span class="ident" id="5165798">t1</span>&nbsp;<span class="ident" id="5165801">item</span><span class="op" id="5165805">)</span>&nbsp;<span class="op" id="5165807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165810">t</span><span class="op" id="5165811">.</span><span class="ident" id="5165812">token</span><span class="op" id="5165817">[</span><span class="num" id="5165818">1</span><span class="op" id="5165819">]</span>&nbsp;<span class="op" id="5165821">=</span>&nbsp;<span class="ident" id="5165823">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165827">t</span><span class="op" id="5165828">.</span><span class="ident" id="5165829">peekCount</span>&nbsp;<span class="op" id="5165839">=</span>&nbsp;<span class="num" id="5165841">2</span><br>
<span class="lineno"></span><span class="op" id="5165843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="5165846">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="5165896">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="5165934">func</span>&nbsp;<span class="op" id="5165939">(</span><span class="ident" id="5165940">t</span>&nbsp;<span class="op" id="5165942">*</span><span class="ident" id="5165943">Tree</span><span class="op" id="5165947">)</span>&nbsp;<span class="ident" id="5165949">backup3</span><span class="op" id="5165956">(</span><span class="ident" id="5165957">t2</span><span class="op" id="5165959">,</span>&nbsp;<span class="ident" id="5165961">t1</span>&nbsp;<span class="ident" id="5165964">item</span><span class="op" id="5165968">)</span>&nbsp;<span class="op" id="5165970">{</span>&nbsp;<span class="comment" id="5165972">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166011">t</span><span class="op" id="5166012">.</span><span class="ident" id="5166013">token</span><span class="op" id="5166018">[</span><span class="num" id="5166019">1</span><span class="op" id="5166020">]</span>&nbsp;<span class="op" id="5166022">=</span>&nbsp;<span class="ident" id="5166024">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166028">t</span><span class="op" id="5166029">.</span><span class="ident" id="5166030">token</span><span class="op" id="5166035">[</span><span class="num" id="5166036">2</span><span class="op" id="5166037">]</span>&nbsp;<span class="op" id="5166039">=</span>&nbsp;<span class="ident" id="5166041">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166045">t</span><span class="op" id="5166046">.</span><span class="ident" id="5166047">peekCount</span>&nbsp;<span class="op" id="5166057">=</span>&nbsp;<span class="num" id="5166059">3</span><br>
<span class="lineno"></span><span class="op" id="5166061">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5166064">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="5166117">func</span>&nbsp;<span class="op" id="5166122">(</span><span class="ident" id="5166123">t</span>&nbsp;<span class="op" id="5166125">*</span><span class="ident" id="5166126">Tree</span><span class="op" id="5166130">)</span>&nbsp;<span class="ident" id="5166132">peek</span><span class="op" id="5166136">(</span><span class="op" id="5166137">)</span>&nbsp;<span class="ident" id="5166139">item</span>&nbsp;<span class="op" id="5166144">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166147">if</span>&nbsp;<span class="ident" id="5166150">t</span><span class="op" id="5166151">.</span><span class="ident" id="5166152">peekCount</span>&nbsp;<span class="op" id="5166162">&gt;</span>&nbsp;<span class="num" id="5166164">0</span>&nbsp;<span class="op" id="5166166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166170">return</span>&nbsp;<span class="ident" id="5166177">t</span><span class="op" id="5166178">.</span><span class="ident" id="5166179">token</span><span class="op" id="5166184">[</span><span class="ident" id="5166185">t</span><span class="op" id="5166186">.</span><span class="ident" id="5166187">peekCount</span><span class="op" id="5166196">-</span><span class="num" id="5166197">1</span><span class="op" id="5166198">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166204">t</span><span class="op" id="5166205">.</span><span class="ident" id="5166206">peekCount</span>&nbsp;<span class="op" id="5166216">=</span>&nbsp;<span class="num" id="5166218">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166221">t</span><span class="op" id="5166222">.</span><span class="ident" id="5166223">token</span><span class="op" id="5166228">[</span><span class="num" id="5166229">0</span><span class="op" id="5166230">]</span>&nbsp;<span class="op" id="5166232">=</span>&nbsp;<span class="ident" id="5166234">t</span><span class="op" id="5166235">.</span><span class="ident" id="5166236">lex</span><span class="op" id="5166239">.</span><span class="ident" id="5166240">nextItem</span><span class="op" id="5166248">(</span><span class="op" id="5166249">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166252">return</span>&nbsp;<span class="ident" id="5166259">t</span><span class="op" id="5166260">.</span><span class="ident" id="5166261">token</span><span class="op" id="5166266">[</span><span class="num" id="5166267">0</span><span class="op" id="5166268">]</span><br>
<span class="lineno"></span><span class="op" id="5166270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5166273">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="5166323">func</span>&nbsp;<span class="op" id="5166328">(</span><span class="ident" id="5166329">t</span>&nbsp;<span class="op" id="5166331">*</span><span class="ident" id="5166332">Tree</span><span class="op" id="5166336">)</span>&nbsp;<span class="ident" id="5166338">nextNonSpace</span><span class="op" id="5166350">(</span><span class="op" id="5166351">)</span>&nbsp;<span class="op" id="5166353">(</span><span class="ident" id="5166354">token</span>&nbsp;<span class="ident" id="5166360">item</span><span class="op" id="5166364">)</span>&nbsp;<span class="op" id="5166366">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166369">for</span>&nbsp;<span class="op" id="5166373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166377">token</span>&nbsp;<span class="op" id="5166383">=</span>&nbsp;<span class="ident" id="5166385">t</span><span class="op" id="5166386">.</span><span class="ident" id="5166387">next</span><span class="op" id="5166391">(</span><span class="op" id="5166392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166396">if</span>&nbsp;<span class="ident" id="5166399">token</span><span class="op" id="5166404">.</span><span class="ident" id="5166405">typ</span>&nbsp;<span class="op" id="5166409">!=</span>&nbsp;<span class="ident" id="5166412">itemSpace</span>&nbsp;<span class="op" id="5166422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166427">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166435">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166441">return</span>&nbsp;<span class="ident" id="5166448">token</span><br>
<span class="lineno"></span><span class="op" id="5166454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5166457">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="5166528">func</span>&nbsp;<span class="op" id="5166533">(</span><span class="ident" id="5166534">t</span>&nbsp;<span class="op" id="5166536">*</span><span class="ident" id="5166537">Tree</span><span class="op" id="5166541">)</span>&nbsp;<span class="ident" id="5166543">peekNonSpace</span><span class="op" id="5166555">(</span><span class="op" id="5166556">)</span>&nbsp;<span class="op" id="5166558">(</span><span class="ident" id="5166559">token</span>&nbsp;<span class="ident" id="5166565">item</span><span class="op" id="5166569">)</span>&nbsp;<span class="op" id="5166571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166574">for</span>&nbsp;<span class="op" id="5166578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166582">token</span>&nbsp;<span class="op" id="5166588">=</span>&nbsp;<span class="ident" id="5166590">t</span><span class="op" id="5166591">.</span><span class="ident" id="5166592">next</span><span class="op" id="5166596">(</span><span class="op" id="5166597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166601">if</span>&nbsp;<span class="ident" id="5166604">token</span><span class="op" id="5166609">.</span><span class="ident" id="5166610">typ</span>&nbsp;<span class="op" id="5166614">!=</span>&nbsp;<span class="ident" id="5166617">itemSpace</span>&nbsp;<span class="op" id="5166627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166632">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166646">t</span><span class="op" id="5166647">.</span><span class="ident" id="5166648">backup</span><span class="op" id="5166654">(</span><span class="op" id="5166655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166658">return</span>&nbsp;<span class="ident" id="5166665">token</span><br>
<span class="lineno"></span><span class="op" id="5166671">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="5166674">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5166687">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="5166742">func</span>&nbsp;<span class="ident" id="5166747">New</span><span class="op" id="5166750">(</span><span class="ident" id="5166751">name</span>&nbsp;<span class="builtintype" id="5166756">string</span><span class="op" id="5166762">,</span>&nbsp;<span class="ident" id="5166764">funcs</span>&nbsp;<span class="op" id="5166770">...</span><span class="keyword" id="5166773">map</span><span class="op" id="5166776">[</span><span class="builtintype" id="5166777">string</span><span class="op" id="5166783">]</span><span class="keyword" id="5166784">interface</span><span class="op" id="5166793">{</span><span class="op" id="5166794">}</span><span class="op" id="5166795">)</span>&nbsp;<span class="op" id="5166797">*</span><span class="ident" id="5166798">Tree</span>&nbsp;<span class="op" id="5166803">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166806">return</span>&nbsp;<span class="op" id="5166813">&amp;</span><span class="ident" id="5166814">Tree</span><span class="op" id="5166818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166822">Name</span><span class="op" id="5166826">:</span>&nbsp;&nbsp;<span class="ident" id="5166829">name</span><span class="op" id="5166833">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166837">funcs</span><span class="op" id="5166842">:</span>&nbsp;<span class="ident" id="5166844">funcs</span><span class="op" id="5166849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166852">}</span><br>
<span class="lineno"></span><span class="op" id="5166854">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5166857">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="5166953">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="5167040">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="5167072">func</span>&nbsp;<span class="op" id="5167077">(</span><span class="ident" id="5167078">t</span>&nbsp;<span class="op" id="5167080">*</span><span class="ident" id="5167081">Tree</span><span class="op" id="5167085">)</span>&nbsp;<span class="ident" id="5167087">ErrorContext</span><span class="op" id="5167099">(</span><span class="ident" id="5167100">n</span>&nbsp;<span class="ident" id="5167102">Node</span><span class="op" id="5167106">)</span>&nbsp;<span class="op" id="5167108">(</span><span class="ident" id="5167109">location</span><span class="op" id="5167117">,</span>&nbsp;<span class="ident" id="5167119">context</span>&nbsp;<span class="builtintype" id="5167127">string</span><span class="op" id="5167133">)</span>&nbsp;<span class="op" id="5167135">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167138">pos</span>&nbsp;<span class="op" id="5167142">:=</span>&nbsp;<span class="builtintype" id="5167145">int</span><span class="op" id="5167148">(</span><span class="ident" id="5167149">n</span><span class="op" id="5167150">.</span><span class="ident" id="5167151">Position</span><span class="op" id="5167159">(</span><span class="op" id="5167160">)</span><span class="op" id="5167161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167164">tree</span>&nbsp;<span class="op" id="5167169">:=</span>&nbsp;<span class="ident" id="5167172">n</span><span class="op" id="5167173">.</span><span class="ident" id="5167174">tree</span><span class="op" id="5167178">(</span><span class="op" id="5167179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167182">if</span>&nbsp;<span class="ident" id="5167185">tree</span>&nbsp;<span class="op" id="5167190">==</span>&nbsp;<span class="ident" id="5167193">nil</span>&nbsp;<span class="op" id="5167197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167201">tree</span>&nbsp;<span class="op" id="5167206">=</span>&nbsp;<span class="ident" id="5167208">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167211">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167214">text</span>&nbsp;<span class="op" id="5167219">:=</span>&nbsp;<span class="ident" id="5167222">tree</span><span class="op" id="5167226">.</span><span class="ident" id="5167227">text</span><span class="op" id="5167231">[</span><span class="op" id="5167232">:</span><span class="ident" id="5167233">pos</span><span class="op" id="5167236">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167239">byteNum</span>&nbsp;<span class="op" id="5167247">:=</span>&nbsp;<span class="ident" id="5167250">strings</span><span class="op" id="5167257">.</span><span class="ident" id="5167258">LastIndex</span><span class="op" id="5167267">(</span><span class="ident" id="5167268">text</span><span class="op" id="5167272">,</span>&nbsp;<span class="string" id="5167274">&#34;\n&#34;</span><span class="op" id="5167278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167281">if</span>&nbsp;<span class="ident" id="5167284">byteNum</span>&nbsp;<span class="op" id="5167292">==</span>&nbsp;<span class="op" id="5167295">-</span><span class="num" id="5167296">1</span>&nbsp;<span class="op" id="5167298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167302">byteNum</span>&nbsp;<span class="op" id="5167310">=</span>&nbsp;<span class="ident" id="5167312">pos</span>&nbsp;<span class="comment" id="5167316">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167335">}</span>&nbsp;<span class="keyword" id="5167337">else</span>&nbsp;<span class="op" id="5167342">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167346">byteNum</span><span class="op" id="5167353">++</span>&nbsp;<span class="comment" id="5167356">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167380">byteNum</span>&nbsp;<span class="op" id="5167388">=</span>&nbsp;<span class="ident" id="5167390">pos</span>&nbsp;<span class="op" id="5167394">-</span>&nbsp;<span class="ident" id="5167396">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167408">lineNum</span>&nbsp;<span class="op" id="5167416">:=</span>&nbsp;<span class="num" id="5167419">1</span>&nbsp;<span class="op" id="5167421">+</span>&nbsp;<span class="ident" id="5167423">strings</span><span class="op" id="5167430">.</span><span class="ident" id="5167431">Count</span><span class="op" id="5167436">(</span><span class="ident" id="5167437">text</span><span class="op" id="5167441">,</span>&nbsp;<span class="string" id="5167443">&#34;\n&#34;</span><span class="op" id="5167447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167450">context</span>&nbsp;<span class="op" id="5167458">=</span>&nbsp;<span class="ident" id="5167460">n</span><span class="op" id="5167461">.</span><span class="ident" id="5167462">String</span><span class="op" id="5167468">(</span><span class="op" id="5167469">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167472">if</span>&nbsp;<span class="builtinfunc" id="5167475">len</span><span class="op" id="5167478">(</span><span class="ident" id="5167479">context</span><span class="op" id="5167486">)</span>&nbsp;<span class="op" id="5167488">&gt;</span>&nbsp;<span class="num" id="5167490">20</span>&nbsp;<span class="op" id="5167493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167497">context</span>&nbsp;<span class="op" id="5167505">=</span>&nbsp;<span class="ident" id="5167507">fmt</span><span class="op" id="5167510">.</span><span class="ident" id="5167511">Sprintf</span><span class="op" id="5167518">(</span><span class="string" id="5167519">&#34;%.20s...&#34;</span><span class="op" id="5167529">,</span>&nbsp;<span class="ident" id="5167531">context</span><span class="op" id="5167538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167544">return</span>&nbsp;<span class="ident" id="5167551">fmt</span><span class="op" id="5167554">.</span><span class="ident" id="5167555">Sprintf</span><span class="op" id="5167562">(</span><span class="string" id="5167563">&#34;%s:%d:%d&#34;</span><span class="op" id="5167573">,</span>&nbsp;<span class="ident" id="5167575">tree</span><span class="op" id="5167579">.</span><span class="ident" id="5167580">ParseName</span><span class="op" id="5167589">,</span>&nbsp;<span class="ident" id="5167591">lineNum</span><span class="op" id="5167598">,</span>&nbsp;<span class="ident" id="5167600">byteNum</span><span class="op" id="5167607">)</span><span class="op" id="5167608">,</span>&nbsp;<span class="ident" id="5167610">context</span><br>
<span class="lineno"></span><span class="op" id="5167618">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5167621">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="5167676">func</span>&nbsp;<span class="op" id="5167681">(</span><span class="ident" id="5167682">t</span>&nbsp;<span class="op" id="5167684">*</span><span class="ident" id="5167685">Tree</span><span class="op" id="5167689">)</span>&nbsp;<span class="ident" id="5167691">errorf</span><span class="op" id="5167697">(</span><span class="ident" id="5167698">format</span>&nbsp;<span class="builtintype" id="5167705">string</span><span class="op" id="5167711">,</span>&nbsp;<span class="ident" id="5167713">args</span>&nbsp;<span class="op" id="5167718">...</span><span class="keyword" id="5167721">interface</span><span class="op" id="5167730">{</span><span class="op" id="5167731">}</span><span class="op" id="5167732">)</span>&nbsp;<span class="op" id="5167734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167737">t</span><span class="op" id="5167738">.</span><span class="ident" id="5167739">Root</span>&nbsp;<span class="op" id="5167744">=</span>&nbsp;<span class="ident" id="5167746">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167751">format</span>&nbsp;<span class="op" id="5167758">=</span>&nbsp;<span class="ident" id="5167760">fmt</span><span class="op" id="5167763">.</span><span class="ident" id="5167764">Sprintf</span><span class="op" id="5167771">(</span><span class="string" id="5167772">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="5167793">,</span>&nbsp;<span class="ident" id="5167795">t</span><span class="op" id="5167796">.</span><span class="ident" id="5167797">ParseName</span><span class="op" id="5167806">,</span>&nbsp;<span class="ident" id="5167808">t</span><span class="op" id="5167809">.</span><span class="ident" id="5167810">lex</span><span class="op" id="5167813">.</span><span class="ident" id="5167814">lineNumber</span><span class="op" id="5167824">(</span><span class="op" id="5167825">)</span><span class="op" id="5167826">,</span>&nbsp;<span class="ident" id="5167828">format</span><span class="op" id="5167834">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5167837">panic</span><span class="op" id="5167842">(</span><span class="ident" id="5167843">fmt</span><span class="op" id="5167846">.</span><span class="ident" id="5167847">Errorf</span><span class="op" id="5167853">(</span><span class="ident" id="5167854">format</span><span class="op" id="5167860">,</span>&nbsp;<span class="ident" id="5167862">args</span><span class="op" id="5167866">...</span><span class="op" id="5167869">)</span><span class="op" id="5167870">)</span><br>
<span class="lineno"></span><span class="op" id="5167872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5167875">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="5167907">func</span>&nbsp;<span class="op" id="5167912">(</span><span class="ident" id="5167913">t</span>&nbsp;<span class="op" id="5167915">*</span><span class="ident" id="5167916">Tree</span><span class="op" id="5167920">)</span>&nbsp;<span class="builtintype" id="5167922">error</span><span class="op" id="5167927">(</span><span class="ident" id="5167928">err</span>&nbsp;<span class="builtintype" id="5167932">error</span><span class="op" id="5167937">)</span>&nbsp;<span class="op" id="5167939">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167942">t</span><span class="op" id="5167943">.</span><span class="ident" id="5167944">errorf</span><span class="op" id="5167950">(</span><span class="string" id="5167951">&#34;%s&#34;</span><span class="op" id="5167955">,</span>&nbsp;<span class="ident" id="5167957">err</span><span class="op" id="5167960">)</span><br>
<span class="lineno"></span><span class="op" id="5167962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5167965">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5168040">func</span>&nbsp;<span class="op" id="5168045">(</span><span class="ident" id="5168046">t</span>&nbsp;<span class="op" id="5168048">*</span><span class="ident" id="5168049">Tree</span><span class="op" id="5168053">)</span>&nbsp;<span class="ident" id="5168055">expect</span><span class="op" id="5168061">(</span><span class="ident" id="5168062">expected</span>&nbsp;<span class="ident" id="5168071">itemType</span><span class="op" id="5168079">,</span>&nbsp;<span class="ident" id="5168081">context</span>&nbsp;<span class="builtintype" id="5168089">string</span><span class="op" id="5168095">)</span>&nbsp;<span class="ident" id="5168097">item</span>&nbsp;<span class="op" id="5168102">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168105">token</span>&nbsp;<span class="op" id="5168111">:=</span>&nbsp;<span class="ident" id="5168114">t</span><span class="op" id="5168115">.</span><span class="ident" id="5168116">nextNonSpace</span><span class="op" id="5168128">(</span><span class="op" id="5168129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168132">if</span>&nbsp;<span class="ident" id="5168135">token</span><span class="op" id="5168140">.</span><span class="ident" id="5168141">typ</span>&nbsp;<span class="op" id="5168145">!=</span>&nbsp;<span class="ident" id="5168148">expected</span>&nbsp;<span class="op" id="5168157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168161">t</span><span class="op" id="5168162">.</span><span class="ident" id="5168163">unexpected</span><span class="op" id="5168173">(</span><span class="ident" id="5168174">token</span><span class="op" id="5168179">,</span>&nbsp;<span class="ident" id="5168181">context</span><span class="op" id="5168188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168194">return</span>&nbsp;<span class="ident" id="5168201">token</span><br>
<span class="lineno">175</span><span class="op" id="5168207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5168210">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="5168298">func</span>&nbsp;<span class="op" id="5168303">(</span><span class="ident" id="5168304">t</span>&nbsp;<span class="op" id="5168306">*</span><span class="ident" id="5168307">Tree</span><span class="op" id="5168311">)</span>&nbsp;<span class="ident" id="5168313">expectOneOf</span><span class="op" id="5168324">(</span><span class="ident" id="5168325">expected1</span><span class="op" id="5168334">,</span>&nbsp;<span class="ident" id="5168336">expected2</span>&nbsp;<span class="ident" id="5168346">itemType</span><span class="op" id="5168354">,</span>&nbsp;<span class="ident" id="5168356">context</span>&nbsp;<span class="builtintype" id="5168364">string</span><span class="op" id="5168370">)</span>&nbsp;<span class="ident" id="5168372">item</span>&nbsp;<span class="op" id="5168377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168380">token</span>&nbsp;<span class="op" id="5168386">:=</span>&nbsp;<span class="ident" id="5168389">t</span><span class="op" id="5168390">.</span><span class="ident" id="5168391">nextNonSpace</span><span class="op" id="5168403">(</span><span class="op" id="5168404">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168407">if</span>&nbsp;<span class="ident" id="5168410">token</span><span class="op" id="5168415">.</span><span class="ident" id="5168416">typ</span>&nbsp;<span class="op" id="5168420">!=</span>&nbsp;<span class="ident" id="5168423">expected1</span>&nbsp;<span class="op" id="5168433">&amp;&amp;</span>&nbsp;<span class="ident" id="5168436">token</span><span class="op" id="5168441">.</span><span class="ident" id="5168442">typ</span>&nbsp;<span class="op" id="5168446">!=</span>&nbsp;<span class="ident" id="5168449">expected2</span>&nbsp;<span class="op" id="5168459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168463">t</span><span class="op" id="5168464">.</span><span class="ident" id="5168465">unexpected</span><span class="op" id="5168475">(</span><span class="ident" id="5168476">token</span><span class="op" id="5168481">,</span>&nbsp;<span class="ident" id="5168483">context</span><span class="op" id="5168490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168496">return</span>&nbsp;<span class="ident" id="5168503">token</span><br>
<span class="lineno"></span><span class="op" id="5168509">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="5168512">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="5168579">func</span>&nbsp;<span class="op" id="5168584">(</span><span class="ident" id="5168585">t</span>&nbsp;<span class="op" id="5168587">*</span><span class="ident" id="5168588">Tree</span><span class="op" id="5168592">)</span>&nbsp;<span class="ident" id="5168594">unexpected</span><span class="op" id="5168604">(</span><span class="ident" id="5168605">token</span>&nbsp;<span class="ident" id="5168611">item</span><span class="op" id="5168615">,</span>&nbsp;<span class="ident" id="5168617">context</span>&nbsp;<span class="builtintype" id="5168625">string</span><span class="op" id="5168631">)</span>&nbsp;<span class="op" id="5168633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168636">t</span><span class="op" id="5168637">.</span><span class="ident" id="5168638">errorf</span><span class="op" id="5168644">(</span><span class="string" id="5168645">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="5168666">,</span>&nbsp;<span class="ident" id="5168668">token</span><span class="op" id="5168673">,</span>&nbsp;<span class="ident" id="5168675">context</span><span class="op" id="5168682">)</span><br>
<span class="lineno"></span><span class="op" id="5168684">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5168687">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="5168773">func</span>&nbsp;<span class="op" id="5168778">(</span><span class="ident" id="5168779">t</span>&nbsp;<span class="op" id="5168781">*</span><span class="ident" id="5168782">Tree</span><span class="op" id="5168786">)</span>&nbsp;<span class="builtinfunc" id="5168788">recover</span><span class="op" id="5168795">(</span><span class="ident" id="5168796">errp</span>&nbsp;<span class="op" id="5168801">*</span><span class="builtintype" id="5168802">error</span><span class="op" id="5168807">)</span>&nbsp;<span class="op" id="5168809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168812">e</span>&nbsp;<span class="op" id="5168814">:=</span>&nbsp;<span class="builtinfunc" id="5168817">recover</span><span class="op" id="5168824">(</span><span class="op" id="5168825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168828">if</span>&nbsp;<span class="ident" id="5168831">e</span>&nbsp;<span class="op" id="5168833">!=</span>&nbsp;<span class="ident" id="5168836">nil</span>&nbsp;<span class="op" id="5168840">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168844">if</span>&nbsp;<span class="ident" id="5168847">_</span><span class="op" id="5168848">,</span>&nbsp;<span class="ident" id="5168850">ok</span>&nbsp;<span class="op" id="5168853">:=</span>&nbsp;<span class="ident" id="5168856">e</span><span class="op" id="5168857">.</span><span class="op" id="5168858">(</span><span class="ident" id="5168859">runtime</span><span class="op" id="5168866">.</span><span class="ident" id="5168867">Error</span><span class="op" id="5168872">)</span><span class="op" id="5168873">;</span>&nbsp;<span class="ident" id="5168875">ok</span>&nbsp;<span class="op" id="5168878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5168883">panic</span><span class="op" id="5168888">(</span><span class="ident" id="5168889">e</span><span class="op" id="5168890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168898">if</span>&nbsp;<span class="ident" id="5168901">t</span>&nbsp;<span class="op" id="5168903">!=</span>&nbsp;<span class="ident" id="5168906">nil</span>&nbsp;<span class="op" id="5168910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168915">t</span><span class="op" id="5168916">.</span><span class="ident" id="5168917">stopParse</span><span class="op" id="5168926">(</span><span class="op" id="5168927">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168935">*</span><span class="ident" id="5168936">errp</span>&nbsp;<span class="op" id="5168941">=</span>&nbsp;<span class="ident" id="5168943">e</span><span class="op" id="5168944">.</span><span class="op" id="5168945">(</span><span class="builtintype" id="5168946">error</span><span class="op" id="5168951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168957">return</span><br>
<span class="lineno"></span><span class="op" id="5168964">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="5168967">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="5169022">func</span>&nbsp;<span class="op" id="5169027">(</span><span class="ident" id="5169028">t</span>&nbsp;<span class="op" id="5169030">*</span><span class="ident" id="5169031">Tree</span><span class="op" id="5169035">)</span>&nbsp;<span class="ident" id="5169037">startParse</span><span class="op" id="5169047">(</span><span class="ident" id="5169048">funcs</span>&nbsp;<span class="op" id="5169054">[</span><span class="op" id="5169055">]</span><span class="keyword" id="5169056">map</span><span class="op" id="5169059">[</span><span class="builtintype" id="5169060">string</span><span class="op" id="5169066">]</span><span class="keyword" id="5169067">interface</span><span class="op" id="5169076">{</span><span class="op" id="5169077">}</span><span class="op" id="5169078">,</span>&nbsp;<span class="ident" id="5169080">lex</span>&nbsp;<span class="op" id="5169084">*</span><span class="ident" id="5169085">lexer</span><span class="op" id="5169090">)</span>&nbsp;<span class="op" id="5169092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169095">t</span><span class="op" id="5169096">.</span><span class="ident" id="5169097">Root</span>&nbsp;<span class="op" id="5169102">=</span>&nbsp;<span class="ident" id="5169104">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169109">t</span><span class="op" id="5169110">.</span><span class="ident" id="5169111">lex</span>&nbsp;<span class="op" id="5169115">=</span>&nbsp;<span class="ident" id="5169117">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169122">t</span><span class="op" id="5169123">.</span><span class="ident" id="5169124">vars</span>&nbsp;<span class="op" id="5169129">=</span>&nbsp;<span class="op" id="5169131">[</span><span class="op" id="5169132">]</span><span class="builtintype" id="5169133">string</span><span class="op" id="5169139">{</span><span class="string" id="5169140">&#34;$&#34;</span><span class="op" id="5169143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169146">t</span><span class="op" id="5169147">.</span><span class="ident" id="5169148">funcs</span>&nbsp;<span class="op" id="5169154">=</span>&nbsp;<span class="ident" id="5169156">funcs</span><br>
<span class="lineno"></span><span class="op" id="5169162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5169165">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="5169198">func</span>&nbsp;<span class="op" id="5169203">(</span><span class="ident" id="5169204">t</span>&nbsp;<span class="op" id="5169206">*</span><span class="ident" id="5169207">Tree</span><span class="op" id="5169211">)</span>&nbsp;<span class="ident" id="5169213">stopParse</span><span class="op" id="5169222">(</span><span class="op" id="5169223">)</span>&nbsp;<span class="op" id="5169225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169228">t</span><span class="op" id="5169229">.</span><span class="ident" id="5169230">lex</span>&nbsp;<span class="op" id="5169234">=</span>&nbsp;<span class="ident" id="5169236">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169241">t</span><span class="op" id="5169242">.</span><span class="ident" id="5169243">vars</span>&nbsp;<span class="op" id="5169248">=</span>&nbsp;<span class="ident" id="5169250">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169255">t</span><span class="op" id="5169256">.</span><span class="ident" id="5169257">funcs</span>&nbsp;<span class="op" id="5169263">=</span>&nbsp;<span class="ident" id="5169265">nil</span><br>
<span class="lineno"></span><span class="op" id="5169269">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="5169272">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5169352">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5169431">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5169509">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="5169529">func</span>&nbsp;<span class="op" id="5169534">(</span><span class="ident" id="5169535">t</span>&nbsp;<span class="op" id="5169537">*</span><span class="ident" id="5169538">Tree</span><span class="op" id="5169542">)</span>&nbsp;<span class="ident" id="5169544">Parse</span><span class="op" id="5169549">(</span><span class="ident" id="5169550">text</span><span class="op" id="5169554">,</span>&nbsp;<span class="ident" id="5169556">leftDelim</span><span class="op" id="5169565">,</span>&nbsp;<span class="ident" id="5169567">rightDelim</span>&nbsp;<span class="builtintype" id="5169578">string</span><span class="op" id="5169584">,</span>&nbsp;<span class="ident" id="5169586">treeSet</span>&nbsp;<span class="keyword" id="5169594">map</span><span class="op" id="5169597">[</span><span class="builtintype" id="5169598">string</span><span class="op" id="5169604">]</span><span class="op" id="5169605">*</span><span class="ident" id="5169606">Tree</span><span class="op" id="5169610">,</span>&nbsp;<span class="ident" id="5169612">funcs</span>&nbsp;<span class="op" id="5169618">...</span><span class="keyword" id="5169621">map</span><span class="op" id="5169624">[</span><span class="builtintype" id="5169625">string</span><span class="op" id="5169631">]</span><span class="keyword" id="5169632">interface</span><span class="op" id="5169641">{</span><span class="op" id="5169642">}</span><span class="op" id="5169643">)</span>&nbsp;<span class="op" id="5169645">(</span><span class="ident" id="5169646">tree</span>&nbsp;<span class="op" id="5169651">*</span><span class="ident" id="5169652">Tree</span><span class="op" id="5169656">,</span>&nbsp;<span class="ident" id="5169658">err</span>&nbsp;<span class="builtintype" id="5169662">error</span><span class="op" id="5169667">)</span>&nbsp;<span class="op" id="5169669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5169672">defer</span>&nbsp;<span class="ident" id="5169678">t</span><span class="op" id="5169679">.</span><span class="builtinfunc" id="5169680">recover</span><span class="op" id="5169687">(</span><span class="op" id="5169688">&amp;</span><span class="ident" id="5169689">err</span><span class="op" id="5169692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169695">t</span><span class="op" id="5169696">.</span><span class="ident" id="5169697">ParseName</span>&nbsp;<span class="op" id="5169707">=</span>&nbsp;<span class="ident" id="5169709">t</span><span class="op" id="5169710">.</span><span class="ident" id="5169711">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169717">t</span><span class="op" id="5169718">.</span><span class="ident" id="5169719">startParse</span><span class="op" id="5169729">(</span><span class="ident" id="5169730">funcs</span><span class="op" id="5169735">,</span>&nbsp;<span class="ident" id="5169737">lex</span><span class="op" id="5169740">(</span><span class="ident" id="5169741">t</span><span class="op" id="5169742">.</span><span class="ident" id="5169743">Name</span><span class="op" id="5169747">,</span>&nbsp;<span class="ident" id="5169749">text</span><span class="op" id="5169753">,</span>&nbsp;<span class="ident" id="5169755">leftDelim</span><span class="op" id="5169764">,</span>&nbsp;<span class="ident" id="5169766">rightDelim</span><span class="op" id="5169776">)</span><span class="op" id="5169777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169780">t</span><span class="op" id="5169781">.</span><span class="ident" id="5169782">text</span>&nbsp;<span class="op" id="5169787">=</span>&nbsp;<span class="ident" id="5169789">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169795">t</span><span class="op" id="5169796">.</span><span class="ident" id="5169797">parse</span><span class="op" id="5169802">(</span><span class="ident" id="5169803">treeSet</span><span class="op" id="5169810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169813">t</span><span class="op" id="5169814">.</span><span class="ident" id="5169815">add</span><span class="op" id="5169818">(</span><span class="ident" id="5169819">treeSet</span><span class="op" id="5169826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169829">t</span><span class="op" id="5169830">.</span><span class="ident" id="5169831">stopParse</span><span class="op" id="5169840">(</span><span class="op" id="5169841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5169844">return</span>&nbsp;<span class="ident" id="5169851">t</span><span class="op" id="5169852">,</span>&nbsp;<span class="ident" id="5169854">nil</span><br>
<span class="lineno"></span><span class="op" id="5169858">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="5169861">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="5169894">func</span>&nbsp;<span class="op" id="5169899">(</span><span class="ident" id="5169900">t</span>&nbsp;<span class="op" id="5169902">*</span><span class="ident" id="5169903">Tree</span><span class="op" id="5169907">)</span>&nbsp;<span class="ident" id="5169909">add</span><span class="op" id="5169912">(</span><span class="ident" id="5169913">treeSet</span>&nbsp;<span class="keyword" id="5169921">map</span><span class="op" id="5169924">[</span><span class="builtintype" id="5169925">string</span><span class="op" id="5169931">]</span><span class="op" id="5169932">*</span><span class="ident" id="5169933">Tree</span><span class="op" id="5169937">)</span>&nbsp;<span class="op" id="5169939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5169942">tree</span>&nbsp;<span class="op" id="5169947">:=</span>&nbsp;<span class="ident" id="5169950">treeSet</span><span class="op" id="5169957">[</span><span class="ident" id="5169958">t</span><span class="op" id="5169959">.</span><span class="ident" id="5169960">Name</span><span class="op" id="5169964">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5169967">if</span>&nbsp;<span class="ident" id="5169970">tree</span>&nbsp;<span class="op" id="5169975">==</span>&nbsp;<span class="ident" id="5169978">nil</span>&nbsp;<span class="op" id="5169982">||</span>&nbsp;<span class="ident" id="5169985">IsEmptyTree</span><span class="op" id="5169996">(</span><span class="ident" id="5169997">tree</span><span class="op" id="5170001">.</span><span class="ident" id="5170002">Root</span><span class="op" id="5170006">)</span>&nbsp;<span class="op" id="5170008">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5170012">treeSet</span><span class="op" id="5170019">[</span><span class="ident" id="5170020">t</span><span class="op" id="5170021">.</span><span class="ident" id="5170022">Name</span><span class="op" id="5170026">]</span>&nbsp;<span class="op" id="5170028">=</span>&nbsp;<span class="ident" id="5170030">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170034">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5170042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170045">if</span>&nbsp;<span class="op" id="5170048">!</span><span class="ident" id="5170049">IsEmptyTree</span><span class="op" id="5170060">(</span><span class="ident" id="5170061">t</span><span class="op" id="5170062">.</span><span class="ident" id="5170063">Root</span><span class="op" id="5170067">)</span>&nbsp;<span class="op" id="5170069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5170073">t</span><span class="op" id="5170074">.</span><span class="ident" id="5170075">errorf</span><span class="op" id="5170081">(</span><span class="string" id="5170082">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="5170128">,</span>&nbsp;<span class="ident" id="5170130">t</span><span class="op" id="5170131">.</span><span class="ident" id="5170132">Name</span><span class="op" id="5170136">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5170139">}</span><br>
<span class="lineno"></span><span class="op" id="5170141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5170144">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="5170226">func</span>&nbsp;<span class="ident" id="5170231">IsEmptyTree</span><span class="op" id="5170242">(</span><span class="ident" id="5170243">n</span>&nbsp;<span class="ident" id="5170245">Node</span><span class="op" id="5170249">)</span>&nbsp;<span class="builtintype" id="5170251">bool</span>&nbsp;<span class="op" id="5170256">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170259">switch</span>&nbsp;<span class="ident" id="5170266">n</span>&nbsp;<span class="op" id="5170268">:=</span>&nbsp;<span class="ident" id="5170271">n</span><span class="op" id="5170272">.</span><span class="op" id="5170273">(</span><span class="keyword" id="5170274">type</span><span class="op" id="5170278">)</span>&nbsp;<span class="op" id="5170280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170283">case</span>&nbsp;<span class="ident" id="5170288">nil</span><span class="op" id="5170291">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170295">return</span>&nbsp;<span class="builtintype" id="5170302">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170308">case</span>&nbsp;<span class="op" id="5170313">*</span><span class="ident" id="5170314">ActionNode</span><span class="op" id="5170324">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170327">case</span>&nbsp;<span class="op" id="5170332">*</span><span class="ident" id="5170333">IfNode</span><span class="op" id="5170339">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170342">case</span>&nbsp;<span class="op" id="5170347">*</span><span class="ident" id="5170348">ListNode</span><span class="op" id="5170356">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170360">for</span>&nbsp;<span class="ident" id="5170364">_</span><span class="op" id="5170365">,</span>&nbsp;<span class="ident" id="5170367">node</span>&nbsp;<span class="op" id="5170372">:=</span>&nbsp;<span class="keyword" id="5170375">range</span>&nbsp;<span class="ident" id="5170381">n</span><span class="op" id="5170382">.</span><span class="ident" id="5170383">Nodes</span>&nbsp;<span class="op" id="5170389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170394">if</span>&nbsp;<span class="op" id="5170397">!</span><span class="ident" id="5170398">IsEmptyTree</span><span class="op" id="5170409">(</span><span class="ident" id="5170410">node</span><span class="op" id="5170414">)</span>&nbsp;<span class="op" id="5170416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170422">return</span>&nbsp;<span class="builtintype" id="5170429">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5170438">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5170442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170446">return</span>&nbsp;<span class="builtintype" id="5170453">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170459">case</span>&nbsp;<span class="op" id="5170464">*</span><span class="ident" id="5170465">RangeNode</span><span class="op" id="5170474">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170477">case</span>&nbsp;<span class="op" id="5170482">*</span><span class="ident" id="5170483">TemplateNode</span><span class="op" id="5170495">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170498">case</span>&nbsp;<span class="op" id="5170503">*</span><span class="ident" id="5170504">TextNode</span><span class="op" id="5170512">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170516">return</span>&nbsp;<span class="builtinfunc" id="5170523">len</span><span class="op" id="5170526">(</span><span class="ident" id="5170527">bytes</span><span class="op" id="5170532">.</span><span class="ident" id="5170533">TrimSpace</span><span class="op" id="5170542">(</span><span class="ident" id="5170543">n</span><span class="op" id="5170544">.</span><span class="ident" id="5170545">Text</span><span class="op" id="5170549">)</span><span class="op" id="5170550">)</span>&nbsp;<span class="op" id="5170552">==</span>&nbsp;<span class="num" id="5170555">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170558">case</span>&nbsp;<span class="op" id="5170563">*</span><span class="ident" id="5170564">WithNode</span><span class="op" id="5170572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170575">default</span><span class="op" id="5170582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5170586">panic</span><span class="op" id="5170591">(</span><span class="string" id="5170592">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="5170609">+</span>&nbsp;<span class="ident" id="5170611">n</span><span class="op" id="5170612">.</span><span class="ident" id="5170613">String</span><span class="op" id="5170619">(</span><span class="op" id="5170620">)</span><span class="op" id="5170621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5170624">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170627">return</span>&nbsp;<span class="builtintype" id="5170634">false</span><br>
<span class="lineno"></span><span class="op" id="5170640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5170643">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="5170713">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="5170770">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="5170789">func</span>&nbsp;<span class="op" id="5170794">(</span><span class="ident" id="5170795">t</span>&nbsp;<span class="op" id="5170797">*</span><span class="ident" id="5170798">Tree</span><span class="op" id="5170802">)</span>&nbsp;<span class="ident" id="5170804">parse</span><span class="op" id="5170809">(</span><span class="ident" id="5170810">treeSet</span>&nbsp;<span class="keyword" id="5170818">map</span><span class="op" id="5170821">[</span><span class="builtintype" id="5170822">string</span><span class="op" id="5170828">]</span><span class="op" id="5170829">*</span><span class="ident" id="5170830">Tree</span><span class="op" id="5170834">)</span>&nbsp;<span class="op" id="5170836">(</span><span class="ident" id="5170837">next</span>&nbsp;<span class="ident" id="5170842">Node</span><span class="op" id="5170846">)</span>&nbsp;<span class="op" id="5170848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5170851">t</span><span class="op" id="5170852">.</span><span class="ident" id="5170853">Root</span>&nbsp;<span class="op" id="5170858">=</span>&nbsp;<span class="ident" id="5170860">t</span><span class="op" id="5170861">.</span><span class="ident" id="5170862">newList</span><span class="op" id="5170869">(</span><span class="ident" id="5170870">t</span><span class="op" id="5170871">.</span><span class="ident" id="5170872">peek</span><span class="op" id="5170876">(</span><span class="op" id="5170877">)</span><span class="op" id="5170878">.</span><span class="ident" id="5170879">pos</span><span class="op" id="5170882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170885">for</span>&nbsp;<span class="ident" id="5170889">t</span><span class="op" id="5170890">.</span><span class="ident" id="5170891">peek</span><span class="op" id="5170895">(</span><span class="op" id="5170896">)</span><span class="op" id="5170897">.</span><span class="ident" id="5170898">typ</span>&nbsp;<span class="op" id="5170902">!=</span>&nbsp;<span class="ident" id="5170905">itemEOF</span>&nbsp;<span class="op" id="5170913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170917">if</span>&nbsp;<span class="ident" id="5170920">t</span><span class="op" id="5170921">.</span><span class="ident" id="5170922">peek</span><span class="op" id="5170926">(</span><span class="op" id="5170927">)</span><span class="op" id="5170928">.</span><span class="ident" id="5170929">typ</span>&nbsp;<span class="op" id="5170933">==</span>&nbsp;<span class="ident" id="5170936">itemLeftDelim</span>&nbsp;<span class="op" id="5170950">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5170955">delim</span>&nbsp;<span class="op" id="5170961">:=</span>&nbsp;<span class="ident" id="5170964">t</span><span class="op" id="5170965">.</span><span class="ident" id="5170966">next</span><span class="op" id="5170970">(</span><span class="op" id="5170971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5170976">if</span>&nbsp;<span class="ident" id="5170979">t</span><span class="op" id="5170980">.</span><span class="ident" id="5170981">nextNonSpace</span><span class="op" id="5170993">(</span><span class="op" id="5170994">)</span><span class="op" id="5170995">.</span><span class="ident" id="5170996">typ</span>&nbsp;<span class="op" id="5171000">==</span>&nbsp;<span class="ident" id="5171003">itemDefine</span>&nbsp;<span class="op" id="5171014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171020">newT</span>&nbsp;<span class="op" id="5171025">:=</span>&nbsp;<span class="ident" id="5171028">New</span><span class="op" id="5171031">(</span><span class="string" id="5171032">&#34;definition&#34;</span><span class="op" id="5171044">)</span>&nbsp;<span class="comment" id="5171046">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171091">newT</span><span class="op" id="5171095">.</span><span class="ident" id="5171096">text</span>&nbsp;<span class="op" id="5171101">=</span>&nbsp;<span class="ident" id="5171103">t</span><span class="op" id="5171104">.</span><span class="ident" id="5171105">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171114">newT</span><span class="op" id="5171118">.</span><span class="ident" id="5171119">ParseName</span>&nbsp;<span class="op" id="5171129">=</span>&nbsp;<span class="ident" id="5171131">t</span><span class="op" id="5171132">.</span><span class="ident" id="5171133">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171147">newT</span><span class="op" id="5171151">.</span><span class="ident" id="5171152">startParse</span><span class="op" id="5171162">(</span><span class="ident" id="5171163">t</span><span class="op" id="5171164">.</span><span class="ident" id="5171165">funcs</span><span class="op" id="5171170">,</span>&nbsp;<span class="ident" id="5171172">t</span><span class="op" id="5171173">.</span><span class="ident" id="5171174">lex</span><span class="op" id="5171177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171183">newT</span><span class="op" id="5171187">.</span><span class="ident" id="5171188">parseDefinition</span><span class="op" id="5171203">(</span><span class="ident" id="5171204">treeSet</span><span class="op" id="5171211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5171217">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5171229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171234">t</span><span class="op" id="5171235">.</span><span class="ident" id="5171236">backup2</span><span class="op" id="5171243">(</span><span class="ident" id="5171244">delim</span><span class="op" id="5171249">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5171253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171257">n</span>&nbsp;<span class="op" id="5171259">:=</span>&nbsp;<span class="ident" id="5171262">t</span><span class="op" id="5171263">.</span><span class="ident" id="5171264">textOrAction</span><span class="op" id="5171276">(</span><span class="op" id="5171277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5171281">if</span>&nbsp;<span class="ident" id="5171284">n</span><span class="op" id="5171285">.</span><span class="ident" id="5171286">Type</span><span class="op" id="5171290">(</span><span class="op" id="5171291">)</span>&nbsp;<span class="op" id="5171293">==</span>&nbsp;<span class="ident" id="5171296">nodeEnd</span>&nbsp;<span class="op" id="5171304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171309">t</span><span class="op" id="5171310">.</span><span class="ident" id="5171311">errorf</span><span class="op" id="5171317">(</span><span class="string" id="5171318">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="5171333">,</span>&nbsp;<span class="ident" id="5171335">n</span><span class="op" id="5171336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5171340">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171344">t</span><span class="op" id="5171345">.</span><span class="ident" id="5171346">Root</span><span class="op" id="5171350">.</span><span class="builtinfunc" id="5171351">append</span><span class="op" id="5171357">(</span><span class="ident" id="5171358">n</span><span class="op" id="5171359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5171362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5171365">return</span>&nbsp;<span class="ident" id="5171372">nil</span><br>
<span class="lineno"></span><span class="op" id="5171376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="5171379">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5171455">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="5171536">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="5171553">func</span>&nbsp;<span class="op" id="5171558">(</span><span class="ident" id="5171559">t</span>&nbsp;<span class="op" id="5171561">*</span><span class="ident" id="5171562">Tree</span><span class="op" id="5171566">)</span>&nbsp;<span class="ident" id="5171568">parseDefinition</span><span class="op" id="5171583">(</span><span class="ident" id="5171584">treeSet</span>&nbsp;<span class="keyword" id="5171592">map</span><span class="op" id="5171595">[</span><span class="builtintype" id="5171596">string</span><span class="op" id="5171602">]</span><span class="op" id="5171603">*</span><span class="ident" id="5171604">Tree</span><span class="op" id="5171608">)</span>&nbsp;<span class="op" id="5171610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5171613">const</span>&nbsp;<span class="ident" id="5171619">context</span>&nbsp;<span class="op" id="5171627">=</span>&nbsp;<span class="string" id="5171629">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171646">name</span>&nbsp;<span class="op" id="5171651">:=</span>&nbsp;<span class="ident" id="5171654">t</span><span class="op" id="5171655">.</span><span class="ident" id="5171656">expectOneOf</span><span class="op" id="5171667">(</span><span class="ident" id="5171668">itemString</span><span class="op" id="5171678">,</span>&nbsp;<span class="ident" id="5171680">itemRawString</span><span class="op" id="5171693">,</span>&nbsp;<span class="ident" id="5171695">context</span><span class="op" id="5171702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5171705">var</span>&nbsp;<span class="ident" id="5171709">err</span>&nbsp;<span class="builtintype" id="5171713">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171720">t</span><span class="op" id="5171721">.</span><span class="ident" id="5171722">Name</span><span class="op" id="5171726">,</span>&nbsp;<span class="ident" id="5171728">err</span>&nbsp;<span class="op" id="5171732">=</span>&nbsp;<span class="ident" id="5171734">strconv</span><span class="op" id="5171741">.</span><span class="ident" id="5171742">Unquote</span><span class="op" id="5171749">(</span><span class="ident" id="5171750">name</span><span class="op" id="5171754">.</span><span class="ident" id="5171755">val</span><span class="op" id="5171758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5171761">if</span>&nbsp;<span class="ident" id="5171764">err</span>&nbsp;<span class="op" id="5171768">!=</span>&nbsp;<span class="ident" id="5171771">nil</span>&nbsp;<span class="op" id="5171775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171779">t</span><span class="op" id="5171780">.</span><span class="builtintype" id="5171781">error</span><span class="op" id="5171786">(</span><span class="ident" id="5171787">err</span><span class="op" id="5171790">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5171793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171796">t</span><span class="op" id="5171797">.</span><span class="ident" id="5171798">expect</span><span class="op" id="5171804">(</span><span class="ident" id="5171805">itemRightDelim</span><span class="op" id="5171819">,</span>&nbsp;<span class="ident" id="5171821">context</span><span class="op" id="5171828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5171831">var</span>&nbsp;<span class="ident" id="5171835">end</span>&nbsp;<span class="ident" id="5171839">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171845">t</span><span class="op" id="5171846">.</span><span class="ident" id="5171847">Root</span><span class="op" id="5171851">,</span>&nbsp;<span class="ident" id="5171853">end</span>&nbsp;<span class="op" id="5171857">=</span>&nbsp;<span class="ident" id="5171859">t</span><span class="op" id="5171860">.</span><span class="ident" id="5171861">itemList</span><span class="op" id="5171869">(</span><span class="op" id="5171870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5171873">if</span>&nbsp;<span class="ident" id="5171876">end</span><span class="op" id="5171879">.</span><span class="ident" id="5171880">Type</span><span class="op" id="5171884">(</span><span class="op" id="5171885">)</span>&nbsp;<span class="op" id="5171887">!=</span>&nbsp;<span class="ident" id="5171890">nodeEnd</span>&nbsp;<span class="op" id="5171898">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171902">t</span><span class="op" id="5171903">.</span><span class="ident" id="5171904">errorf</span><span class="op" id="5171910">(</span><span class="string" id="5171911">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="5171932">,</span>&nbsp;<span class="ident" id="5171934">end</span><span class="op" id="5171937">,</span>&nbsp;<span class="ident" id="5171939">context</span><span class="op" id="5171946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5171949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171952">t</span><span class="op" id="5171953">.</span><span class="ident" id="5171954">add</span><span class="op" id="5171957">(</span><span class="ident" id="5171958">treeSet</span><span class="op" id="5171965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5171968">t</span><span class="op" id="5171969">.</span><span class="ident" id="5171970">stopParse</span><span class="op" id="5171979">(</span><span class="op" id="5171980">)</span><br>
<span class="lineno"></span><span class="op" id="5171982">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="5171985">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="5171998">//&nbsp;&nbsp;&nbsp;&nbsp;textOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="5172015">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="5172074">func</span>&nbsp;<span class="op" id="5172079">(</span><span class="ident" id="5172080">t</span>&nbsp;<span class="op" id="5172082">*</span><span class="ident" id="5172083">Tree</span><span class="op" id="5172087">)</span>&nbsp;<span class="ident" id="5172089">itemList</span><span class="op" id="5172097">(</span><span class="op" id="5172098">)</span>&nbsp;<span class="op" id="5172100">(</span><span class="ident" id="5172101">list</span>&nbsp;<span class="op" id="5172106">*</span><span class="ident" id="5172107">ListNode</span><span class="op" id="5172115">,</span>&nbsp;<span class="ident" id="5172117">next</span>&nbsp;<span class="ident" id="5172122">Node</span><span class="op" id="5172126">)</span>&nbsp;<span class="op" id="5172128">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172131">list</span>&nbsp;<span class="op" id="5172136">=</span>&nbsp;<span class="ident" id="5172138">t</span><span class="op" id="5172139">.</span><span class="ident" id="5172140">newList</span><span class="op" id="5172147">(</span><span class="ident" id="5172148">t</span><span class="op" id="5172149">.</span><span class="ident" id="5172150">peekNonSpace</span><span class="op" id="5172162">(</span><span class="op" id="5172163">)</span><span class="op" id="5172164">.</span><span class="ident" id="5172165">pos</span><span class="op" id="5172168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172171">for</span>&nbsp;<span class="ident" id="5172175">t</span><span class="op" id="5172176">.</span><span class="ident" id="5172177">peekNonSpace</span><span class="op" id="5172189">(</span><span class="op" id="5172190">)</span><span class="op" id="5172191">.</span><span class="ident" id="5172192">typ</span>&nbsp;<span class="op" id="5172196">!=</span>&nbsp;<span class="ident" id="5172199">itemEOF</span>&nbsp;<span class="op" id="5172207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172211">n</span>&nbsp;<span class="op" id="5172213">:=</span>&nbsp;<span class="ident" id="5172216">t</span><span class="op" id="5172217">.</span><span class="ident" id="5172218">textOrAction</span><span class="op" id="5172230">(</span><span class="op" id="5172231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172235">switch</span>&nbsp;<span class="ident" id="5172242">n</span><span class="op" id="5172243">.</span><span class="ident" id="5172244">Type</span><span class="op" id="5172248">(</span><span class="op" id="5172249">)</span>&nbsp;<span class="op" id="5172251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172255">case</span>&nbsp;<span class="ident" id="5172260">nodeEnd</span><span class="op" id="5172267">,</span>&nbsp;<span class="ident" id="5172269">nodeElse</span><span class="op" id="5172277">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172282">return</span>&nbsp;<span class="ident" id="5172289">list</span><span class="op" id="5172293">,</span>&nbsp;<span class="ident" id="5172295">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5172299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172303">list</span><span class="op" id="5172307">.</span><span class="builtinfunc" id="5172308">append</span><span class="op" id="5172314">(</span><span class="ident" id="5172315">n</span><span class="op" id="5172316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5172319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172322">t</span><span class="op" id="5172323">.</span><span class="ident" id="5172324">errorf</span><span class="op" id="5172330">(</span><span class="string" id="5172331">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="5172347">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172350">return</span><br>
<span class="lineno"></span><span class="op" id="5172357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5172360">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="5172377">//&nbsp;&nbsp;&nbsp;&nbsp;text&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="5172394">func</span>&nbsp;<span class="op" id="5172399">(</span><span class="ident" id="5172400">t</span>&nbsp;<span class="op" id="5172402">*</span><span class="ident" id="5172403">Tree</span><span class="op" id="5172407">)</span>&nbsp;<span class="ident" id="5172409">textOrAction</span><span class="op" id="5172421">(</span><span class="op" id="5172422">)</span>&nbsp;<span class="ident" id="5172424">Node</span>&nbsp;<span class="op" id="5172429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172432">switch</span>&nbsp;<span class="ident" id="5172439">token</span>&nbsp;<span class="op" id="5172445">:=</span>&nbsp;<span class="ident" id="5172448">t</span><span class="op" id="5172449">.</span><span class="ident" id="5172450">nextNonSpace</span><span class="op" id="5172462">(</span><span class="op" id="5172463">)</span><span class="op" id="5172464">;</span>&nbsp;<span class="ident" id="5172466">token</span><span class="op" id="5172471">.</span><span class="ident" id="5172472">typ</span>&nbsp;<span class="op" id="5172476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172479">case</span>&nbsp;<span class="ident" id="5172484">itemText</span><span class="op" id="5172492">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172496">return</span>&nbsp;<span class="ident" id="5172503">t</span><span class="op" id="5172504">.</span><span class="ident" id="5172505">newText</span><span class="op" id="5172512">(</span><span class="ident" id="5172513">token</span><span class="op" id="5172518">.</span><span class="ident" id="5172519">pos</span><span class="op" id="5172522">,</span>&nbsp;<span class="ident" id="5172524">token</span><span class="op" id="5172529">.</span><span class="ident" id="5172530">val</span><span class="op" id="5172533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172536">case</span>&nbsp;<span class="ident" id="5172541">itemLeftDelim</span><span class="op" id="5172554">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172558">return</span>&nbsp;<span class="ident" id="5172565">t</span><span class="op" id="5172566">.</span><span class="ident" id="5172567">action</span><span class="op" id="5172573">(</span><span class="op" id="5172574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172577">default</span><span class="op" id="5172584">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5172588">t</span><span class="op" id="5172589">.</span><span class="ident" id="5172590">unexpected</span><span class="op" id="5172600">(</span><span class="ident" id="5172601">token</span><span class="op" id="5172606">,</span>&nbsp;<span class="string" id="5172608">&#34;input&#34;</span><span class="op" id="5172615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5172618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172621">return</span>&nbsp;<span class="ident" id="5172628">nil</span><br>
<span class="lineno">350</span><span class="op" id="5172632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5172635">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="5172646">//&nbsp;&nbsp;&nbsp;&nbsp;control</span><br>
<span class="lineno"></span><span class="comment" id="5172657">//&nbsp;&nbsp;&nbsp;&nbsp;command&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="5172683">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="5172723">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="5172771">func</span>&nbsp;<span class="op" id="5172776">(</span><span class="ident" id="5172777">t</span>&nbsp;<span class="op" id="5172779">*</span><span class="ident" id="5172780">Tree</span><span class="op" id="5172784">)</span>&nbsp;<span class="ident" id="5172786">action</span><span class="op" id="5172792">(</span><span class="op" id="5172793">)</span>&nbsp;<span class="op" id="5172795">(</span><span class="ident" id="5172796">n</span>&nbsp;<span class="ident" id="5172798">Node</span><span class="op" id="5172802">)</span>&nbsp;<span class="op" id="5172804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172807">switch</span>&nbsp;<span class="ident" id="5172814">token</span>&nbsp;<span class="op" id="5172820">:=</span>&nbsp;<span class="ident" id="5172823">t</span><span class="op" id="5172824">.</span><span class="ident" id="5172825">nextNonSpace</span><span class="op" id="5172837">(</span><span class="op" id="5172838">)</span><span class="op" id="5172839">;</span>&nbsp;<span class="ident" id="5172841">token</span><span class="op" id="5172846">.</span><span class="ident" id="5172847">typ</span>&nbsp;<span class="op" id="5172851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172854">case</span>&nbsp;<span class="ident" id="5172859">itemElse</span><span class="op" id="5172867">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172871">return</span>&nbsp;<span class="ident" id="5172878">t</span><span class="op" id="5172879">.</span><span class="ident" id="5172880">elseControl</span><span class="op" id="5172891">(</span><span class="op" id="5172892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172895">case</span>&nbsp;<span class="ident" id="5172900">itemEnd</span><span class="op" id="5172907">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172911">return</span>&nbsp;<span class="ident" id="5172918">t</span><span class="op" id="5172919">.</span><span class="ident" id="5172920">endControl</span><span class="op" id="5172930">(</span><span class="op" id="5172931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172934">case</span>&nbsp;<span class="ident" id="5172939">itemIf</span><span class="op" id="5172945">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172949">return</span>&nbsp;<span class="ident" id="5172956">t</span><span class="op" id="5172957">.</span><span class="ident" id="5172958">ifControl</span><span class="op" id="5172967">(</span><span class="op" id="5172968">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172971">case</span>&nbsp;<span class="ident" id="5172976">itemRange</span><span class="op" id="5172985">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5172989">return</span>&nbsp;<span class="ident" id="5172996">t</span><span class="op" id="5172997">.</span><span class="ident" id="5172998">rangeControl</span><span class="op" id="5173010">(</span><span class="op" id="5173011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173014">case</span>&nbsp;<span class="ident" id="5173019">itemTemplate</span><span class="op" id="5173031">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173035">return</span>&nbsp;<span class="ident" id="5173042">t</span><span class="op" id="5173043">.</span><span class="ident" id="5173044">templateControl</span><span class="op" id="5173059">(</span><span class="op" id="5173060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173063">case</span>&nbsp;<span class="ident" id="5173068">itemWith</span><span class="op" id="5173076">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173080">return</span>&nbsp;<span class="ident" id="5173087">t</span><span class="op" id="5173088">.</span><span class="ident" id="5173089">withControl</span><span class="op" id="5173100">(</span><span class="op" id="5173101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5173104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5173107">t</span><span class="op" id="5173108">.</span><span class="ident" id="5173109">backup</span><span class="op" id="5173115">(</span><span class="op" id="5173116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173119">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173171">return</span>&nbsp;<span class="ident" id="5173178">t</span><span class="op" id="5173179">.</span><span class="ident" id="5173180">newAction</span><span class="op" id="5173189">(</span><span class="ident" id="5173190">t</span><span class="op" id="5173191">.</span><span class="ident" id="5173192">peek</span><span class="op" id="5173196">(</span><span class="op" id="5173197">)</span><span class="op" id="5173198">.</span><span class="ident" id="5173199">pos</span><span class="op" id="5173202">,</span>&nbsp;<span class="ident" id="5173204">t</span><span class="op" id="5173205">.</span><span class="ident" id="5173206">lex</span><span class="op" id="5173209">.</span><span class="ident" id="5173210">lineNumber</span><span class="op" id="5173220">(</span><span class="op" id="5173221">)</span><span class="op" id="5173222">,</span>&nbsp;<span class="ident" id="5173224">t</span><span class="op" id="5173225">.</span><span class="ident" id="5173226">pipeline</span><span class="op" id="5173234">(</span><span class="string" id="5173235">&#34;command&#34;</span><span class="op" id="5173244">)</span><span class="op" id="5173245">)</span><br>
<span class="lineno">375</span><span class="op" id="5173247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5173250">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="5173263">//&nbsp;&nbsp;&nbsp;&nbsp;declarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="5173303">func</span>&nbsp;<span class="op" id="5173308">(</span><span class="ident" id="5173309">t</span>&nbsp;<span class="op" id="5173311">*</span><span class="ident" id="5173312">Tree</span><span class="op" id="5173316">)</span>&nbsp;<span class="ident" id="5173318">pipeline</span><span class="op" id="5173326">(</span><span class="ident" id="5173327">context</span>&nbsp;<span class="builtintype" id="5173335">string</span><span class="op" id="5173341">)</span>&nbsp;<span class="op" id="5173343">(</span><span class="ident" id="5173344">pipe</span>&nbsp;<span class="op" id="5173349">*</span><span class="ident" id="5173350">PipeNode</span><span class="op" id="5173358">)</span>&nbsp;<span class="op" id="5173360">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173363">var</span>&nbsp;<span class="ident" id="5173367">decl</span>&nbsp;<span class="op" id="5173372">[</span><span class="op" id="5173373">]</span><span class="op" id="5173374">*</span><span class="ident" id="5173375">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5173389">pos</span>&nbsp;<span class="op" id="5173393">:=</span>&nbsp;<span class="ident" id="5173396">t</span><span class="op" id="5173397">.</span><span class="ident" id="5173398">peekNonSpace</span><span class="op" id="5173410">(</span><span class="op" id="5173411">)</span><span class="op" id="5173412">.</span><span class="ident" id="5173413">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173418">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173446">for</span>&nbsp;<span class="op" id="5173450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173454">if</span>&nbsp;<span class="ident" id="5173457">v</span>&nbsp;<span class="op" id="5173459">:=</span>&nbsp;<span class="ident" id="5173462">t</span><span class="op" id="5173463">.</span><span class="ident" id="5173464">peekNonSpace</span><span class="op" id="5173476">(</span><span class="op" id="5173477">)</span><span class="op" id="5173478">;</span>&nbsp;<span class="ident" id="5173480">v</span><span class="op" id="5173481">.</span><span class="ident" id="5173482">typ</span>&nbsp;<span class="op" id="5173486">==</span>&nbsp;<span class="ident" id="5173489">itemVariable</span>&nbsp;<span class="op" id="5173502">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5173507">t</span><span class="op" id="5173508">.</span><span class="ident" id="5173509">next</span><span class="op" id="5173513">(</span><span class="op" id="5173514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173519">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173600">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173683">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5173756">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5173824">tokenAfterVariable</span>&nbsp;<span class="op" id="5173843">:=</span>&nbsp;<span class="ident" id="5173846">t</span><span class="op" id="5173847">.</span><span class="ident" id="5173848">peek</span><span class="op" id="5173852">(</span><span class="op" id="5173853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5173858">if</span>&nbsp;<span class="ident" id="5173861">next</span>&nbsp;<span class="op" id="5173866">:=</span>&nbsp;<span class="ident" id="5173869">t</span><span class="op" id="5173870">.</span><span class="ident" id="5173871">peekNonSpace</span><span class="op" id="5173883">(</span><span class="op" id="5173884">)</span><span class="op" id="5173885">;</span>&nbsp;<span class="ident" id="5173887">next</span><span class="op" id="5173891">.</span><span class="ident" id="5173892">typ</span>&nbsp;<span class="op" id="5173896">==</span>&nbsp;<span class="ident" id="5173899">itemColonEquals</span>&nbsp;<span class="op" id="5173915">||</span>&nbsp;<span class="op" id="5173918">(</span><span class="ident" id="5173919">next</span><span class="op" id="5173923">.</span><span class="ident" id="5173924">typ</span>&nbsp;<span class="op" id="5173928">==</span>&nbsp;<span class="ident" id="5173931">itemChar</span>&nbsp;<span class="op" id="5173940">&amp;&amp;</span>&nbsp;<span class="ident" id="5173943">next</span><span class="op" id="5173947">.</span><span class="ident" id="5173948">val</span>&nbsp;<span class="op" id="5173952">==</span>&nbsp;<span class="string" id="5173955">&#34;,&#34;</span><span class="op" id="5173958">)</span>&nbsp;<span class="op" id="5173960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5173966">t</span><span class="op" id="5173967">.</span><span class="ident" id="5173968">nextNonSpace</span><span class="op" id="5173980">(</span><span class="op" id="5173981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5173987">variable</span>&nbsp;<span class="op" id="5173996">:=</span>&nbsp;<span class="ident" id="5173999">t</span><span class="op" id="5174000">.</span><span class="ident" id="5174001">newVariable</span><span class="op" id="5174012">(</span><span class="ident" id="5174013">v</span><span class="op" id="5174014">.</span><span class="ident" id="5174015">pos</span><span class="op" id="5174018">,</span>&nbsp;<span class="ident" id="5174020">v</span><span class="op" id="5174021">.</span><span class="ident" id="5174022">val</span><span class="op" id="5174025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174031">decl</span>&nbsp;<span class="op" id="5174036">=</span>&nbsp;<span class="builtinfunc" id="5174038">append</span><span class="op" id="5174044">(</span><span class="ident" id="5174045">decl</span><span class="op" id="5174049">,</span>&nbsp;<span class="ident" id="5174051">variable</span><span class="op" id="5174059">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174065">t</span><span class="op" id="5174066">.</span><span class="ident" id="5174067">vars</span>&nbsp;<span class="op" id="5174072">=</span>&nbsp;<span class="builtinfunc" id="5174074">append</span><span class="op" id="5174080">(</span><span class="ident" id="5174081">t</span><span class="op" id="5174082">.</span><span class="ident" id="5174083">vars</span><span class="op" id="5174087">,</span>&nbsp;<span class="ident" id="5174089">v</span><span class="op" id="5174090">.</span><span class="ident" id="5174091">val</span><span class="op" id="5174094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174100">if</span>&nbsp;<span class="ident" id="5174103">next</span><span class="op" id="5174107">.</span><span class="ident" id="5174108">typ</span>&nbsp;<span class="op" id="5174112">==</span>&nbsp;<span class="ident" id="5174115">itemChar</span>&nbsp;<span class="op" id="5174124">&amp;&amp;</span>&nbsp;<span class="ident" id="5174127">next</span><span class="op" id="5174131">.</span><span class="ident" id="5174132">val</span>&nbsp;<span class="op" id="5174136">==</span>&nbsp;<span class="string" id="5174139">&#34;,&#34;</span>&nbsp;<span class="op" id="5174143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174150">if</span>&nbsp;<span class="ident" id="5174153">context</span>&nbsp;<span class="op" id="5174161">==</span>&nbsp;<span class="string" id="5174164">&#34;range&#34;</span>&nbsp;<span class="op" id="5174172">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5174175">len</span><span class="op" id="5174178">(</span><span class="ident" id="5174179">decl</span><span class="op" id="5174183">)</span>&nbsp;<span class="op" id="5174185">&lt;</span>&nbsp;<span class="num" id="5174187">2</span>&nbsp;<span class="op" id="5174189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174197">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174211">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174218">t</span><span class="op" id="5174219">.</span><span class="ident" id="5174220">errorf</span><span class="op" id="5174226">(</span><span class="string" id="5174227">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="5174256">,</span>&nbsp;<span class="ident" id="5174258">context</span><span class="op" id="5174265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174276">}</span>&nbsp;<span class="keyword" id="5174278">else</span>&nbsp;<span class="keyword" id="5174283">if</span>&nbsp;<span class="ident" id="5174286">tokenAfterVariable</span><span class="op" id="5174304">.</span><span class="ident" id="5174305">typ</span>&nbsp;<span class="op" id="5174309">==</span>&nbsp;<span class="ident" id="5174312">itemSpace</span>&nbsp;<span class="op" id="5174322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174328">t</span><span class="op" id="5174329">.</span><span class="ident" id="5174330">backup3</span><span class="op" id="5174337">(</span><span class="ident" id="5174338">v</span><span class="op" id="5174339">,</span>&nbsp;<span class="ident" id="5174341">tokenAfterVariable</span><span class="op" id="5174359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174364">}</span>&nbsp;<span class="keyword" id="5174366">else</span>&nbsp;<span class="op" id="5174371">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174377">t</span><span class="op" id="5174378">.</span><span class="ident" id="5174379">backup2</span><span class="op" id="5174386">(</span><span class="ident" id="5174387">v</span><span class="op" id="5174388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174401">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174408">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174411">pipe</span>&nbsp;<span class="op" id="5174416">=</span>&nbsp;<span class="ident" id="5174418">t</span><span class="op" id="5174419">.</span><span class="ident" id="5174420">newPipeline</span><span class="op" id="5174431">(</span><span class="ident" id="5174432">pos</span><span class="op" id="5174435">,</span>&nbsp;<span class="ident" id="5174437">t</span><span class="op" id="5174438">.</span><span class="ident" id="5174439">lex</span><span class="op" id="5174442">.</span><span class="ident" id="5174443">lineNumber</span><span class="op" id="5174453">(</span><span class="op" id="5174454">)</span><span class="op" id="5174455">,</span>&nbsp;<span class="ident" id="5174457">decl</span><span class="op" id="5174461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174464">for</span>&nbsp;<span class="op" id="5174468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174472">switch</span>&nbsp;<span class="ident" id="5174479">token</span>&nbsp;<span class="op" id="5174485">:=</span>&nbsp;<span class="ident" id="5174488">t</span><span class="op" id="5174489">.</span><span class="ident" id="5174490">nextNonSpace</span><span class="op" id="5174502">(</span><span class="op" id="5174503">)</span><span class="op" id="5174504">;</span>&nbsp;<span class="ident" id="5174506">token</span><span class="op" id="5174511">.</span><span class="ident" id="5174512">typ</span>&nbsp;<span class="op" id="5174516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174520">case</span>&nbsp;<span class="ident" id="5174525">itemRightDelim</span><span class="op" id="5174539">,</span>&nbsp;<span class="ident" id="5174541">itemRightParen</span><span class="op" id="5174555">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174560">if</span>&nbsp;<span class="builtinfunc" id="5174563">len</span><span class="op" id="5174566">(</span><span class="ident" id="5174567">pipe</span><span class="op" id="5174571">.</span><span class="ident" id="5174572">Cmds</span><span class="op" id="5174576">)</span>&nbsp;<span class="op" id="5174578">==</span>&nbsp;<span class="num" id="5174581">0</span>&nbsp;<span class="op" id="5174583">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174589">t</span><span class="op" id="5174590">.</span><span class="ident" id="5174591">errorf</span><span class="op" id="5174597">(</span><span class="string" id="5174598">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="5174620">,</span>&nbsp;<span class="ident" id="5174622">context</span><span class="op" id="5174629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174639">if</span>&nbsp;<span class="ident" id="5174642">token</span><span class="op" id="5174647">.</span><span class="ident" id="5174648">typ</span>&nbsp;<span class="op" id="5174652">==</span>&nbsp;<span class="ident" id="5174655">itemRightParen</span>&nbsp;<span class="op" id="5174670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174676">t</span><span class="op" id="5174677">.</span><span class="ident" id="5174678">backup</span><span class="op" id="5174684">(</span><span class="op" id="5174685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174690">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174695">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174704">case</span>&nbsp;<span class="ident" id="5174709">itemBool</span><span class="op" id="5174717">,</span>&nbsp;<span class="ident" id="5174719">itemCharConstant</span><span class="op" id="5174735">,</span>&nbsp;<span class="ident" id="5174737">itemComplex</span><span class="op" id="5174748">,</span>&nbsp;<span class="ident" id="5174750">itemDot</span><span class="op" id="5174757">,</span>&nbsp;<span class="ident" id="5174759">itemField</span><span class="op" id="5174768">,</span>&nbsp;<span class="ident" id="5174770">itemIdentifier</span><span class="op" id="5174784">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174789">itemNumber</span><span class="op" id="5174799">,</span>&nbsp;<span class="ident" id="5174801">itemNil</span><span class="op" id="5174808">,</span>&nbsp;<span class="ident" id="5174810">itemRawString</span><span class="op" id="5174823">,</span>&nbsp;<span class="ident" id="5174825">itemString</span><span class="op" id="5174835">,</span>&nbsp;<span class="ident" id="5174837">itemVariable</span><span class="op" id="5174849">,</span>&nbsp;<span class="ident" id="5174851">itemLeftParen</span><span class="op" id="5174864">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174869">t</span><span class="op" id="5174870">.</span><span class="ident" id="5174871">backup</span><span class="op" id="5174877">(</span><span class="op" id="5174878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174883">pipe</span><span class="op" id="5174887">.</span><span class="builtinfunc" id="5174888">append</span><span class="op" id="5174894">(</span><span class="ident" id="5174895">t</span><span class="op" id="5174896">.</span><span class="ident" id="5174897">command</span><span class="op" id="5174904">(</span><span class="op" id="5174905">)</span><span class="op" id="5174906">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5174910">default</span><span class="op" id="5174917">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5174922">t</span><span class="op" id="5174923">.</span><span class="ident" id="5174924">unexpected</span><span class="op" id="5174934">(</span><span class="ident" id="5174935">token</span><span class="op" id="5174940">,</span>&nbsp;<span class="ident" id="5174942">context</span><span class="op" id="5174949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5174956">}</span><br>
<span class="lineno"></span><span class="op" id="5174958">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5174961">func</span>&nbsp;<span class="op" id="5174966">(</span><span class="ident" id="5174967">t</span>&nbsp;<span class="op" id="5174969">*</span><span class="ident" id="5174970">Tree</span><span class="op" id="5174974">)</span>&nbsp;<span class="ident" id="5174976">parseControl</span><span class="op" id="5174988">(</span><span class="ident" id="5174989">allowElseIf</span>&nbsp;<span class="builtintype" id="5175001">bool</span><span class="op" id="5175005">,</span>&nbsp;<span class="ident" id="5175007">context</span>&nbsp;<span class="builtintype" id="5175015">string</span><span class="op" id="5175021">)</span>&nbsp;<span class="op" id="5175023">(</span><span class="ident" id="5175024">pos</span>&nbsp;<span class="ident" id="5175028">Pos</span><span class="op" id="5175031">,</span>&nbsp;<span class="ident" id="5175033">line</span>&nbsp;<span class="builtintype" id="5175038">int</span><span class="op" id="5175041">,</span>&nbsp;<span class="ident" id="5175043">pipe</span>&nbsp;<span class="op" id="5175048">*</span><span class="ident" id="5175049">PipeNode</span><span class="op" id="5175057">,</span>&nbsp;<span class="ident" id="5175059">list</span><span class="op" id="5175063">,</span>&nbsp;<span class="ident" id="5175065">elseList</span>&nbsp;<span class="op" id="5175074">*</span><span class="ident" id="5175075">ListNode</span><span class="op" id="5175083">)</span>&nbsp;<span class="op" id="5175085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175088">defer</span>&nbsp;<span class="ident" id="5175094">t</span><span class="op" id="5175095">.</span><span class="ident" id="5175096">popVars</span><span class="op" id="5175103">(</span><span class="builtinfunc" id="5175104">len</span><span class="op" id="5175107">(</span><span class="ident" id="5175108">t</span><span class="op" id="5175109">.</span><span class="ident" id="5175110">vars</span><span class="op" id="5175114">)</span><span class="op" id="5175115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175118">line</span>&nbsp;<span class="op" id="5175123">=</span>&nbsp;<span class="ident" id="5175125">t</span><span class="op" id="5175126">.</span><span class="ident" id="5175127">lex</span><span class="op" id="5175130">.</span><span class="ident" id="5175131">lineNumber</span><span class="op" id="5175141">(</span><span class="op" id="5175142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175145">pipe</span>&nbsp;<span class="op" id="5175150">=</span>&nbsp;<span class="ident" id="5175152">t</span><span class="op" id="5175153">.</span><span class="ident" id="5175154">pipeline</span><span class="op" id="5175162">(</span><span class="ident" id="5175163">context</span><span class="op" id="5175170">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175173">var</span>&nbsp;<span class="ident" id="5175177">next</span>&nbsp;<span class="ident" id="5175182">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175188">list</span><span class="op" id="5175192">,</span>&nbsp;<span class="ident" id="5175194">next</span>&nbsp;<span class="op" id="5175199">=</span>&nbsp;<span class="ident" id="5175201">t</span><span class="op" id="5175202">.</span><span class="ident" id="5175203">itemList</span><span class="op" id="5175211">(</span><span class="op" id="5175212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175215">switch</span>&nbsp;<span class="ident" id="5175222">next</span><span class="op" id="5175226">.</span><span class="ident" id="5175227">Type</span><span class="op" id="5175231">(</span><span class="op" id="5175232">)</span>&nbsp;<span class="op" id="5175234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175237">case</span>&nbsp;<span class="ident" id="5175242">nodeEnd</span><span class="op" id="5175249">:</span>&nbsp;<span class="comment" id="5175251">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175259">case</span>&nbsp;<span class="ident" id="5175264">nodeElse</span><span class="op" id="5175272">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175276">if</span>&nbsp;<span class="ident" id="5175279">allowElseIf</span>&nbsp;<span class="op" id="5175291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5175296">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5175380">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5175447">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5175484">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5175493">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5175541">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5175627">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5175699">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175754">if</span>&nbsp;<span class="ident" id="5175757">t</span><span class="op" id="5175758">.</span><span class="ident" id="5175759">peek</span><span class="op" id="5175763">(</span><span class="op" id="5175764">)</span><span class="op" id="5175765">.</span><span class="ident" id="5175766">typ</span>&nbsp;<span class="op" id="5175770">==</span>&nbsp;<span class="ident" id="5175773">itemIf</span>&nbsp;<span class="op" id="5175780">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175786">t</span><span class="op" id="5175787">.</span><span class="ident" id="5175788">next</span><span class="op" id="5175792">(</span><span class="op" id="5175793">)</span>&nbsp;<span class="comment" id="5175795">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175826">elseList</span>&nbsp;<span class="op" id="5175835">=</span>&nbsp;<span class="ident" id="5175837">t</span><span class="op" id="5175838">.</span><span class="ident" id="5175839">newList</span><span class="op" id="5175846">(</span><span class="ident" id="5175847">next</span><span class="op" id="5175851">.</span><span class="ident" id="5175852">Position</span><span class="op" id="5175860">(</span><span class="op" id="5175861">)</span><span class="op" id="5175862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175868">elseList</span><span class="op" id="5175876">.</span><span class="builtinfunc" id="5175877">append</span><span class="op" id="5175883">(</span><span class="ident" id="5175884">t</span><span class="op" id="5175885">.</span><span class="ident" id="5175886">ifControl</span><span class="op" id="5175895">(</span><span class="op" id="5175896">)</span><span class="op" id="5175897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5175903">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5175968">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5175981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5175985">elseList</span><span class="op" id="5175993">,</span>&nbsp;<span class="ident" id="5175995">next</span>&nbsp;<span class="op" id="5176000">=</span>&nbsp;<span class="ident" id="5176002">t</span><span class="op" id="5176003">.</span><span class="ident" id="5176004">itemList</span><span class="op" id="5176012">(</span><span class="op" id="5176013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176017">if</span>&nbsp;<span class="ident" id="5176020">next</span><span class="op" id="5176024">.</span><span class="ident" id="5176025">Type</span><span class="op" id="5176029">(</span><span class="op" id="5176030">)</span>&nbsp;<span class="op" id="5176032">!=</span>&nbsp;<span class="ident" id="5176035">nodeEnd</span>&nbsp;<span class="op" id="5176043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5176048">t</span><span class="op" id="5176049">.</span><span class="ident" id="5176050">errorf</span><span class="op" id="5176056">(</span><span class="string" id="5176057">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="5176081">,</span>&nbsp;<span class="ident" id="5176083">next</span><span class="op" id="5176087">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5176091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5176094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176097">return</span>&nbsp;<span class="ident" id="5176104">pipe</span><span class="op" id="5176108">.</span><span class="ident" id="5176109">Position</span><span class="op" id="5176117">(</span><span class="op" id="5176118">)</span><span class="op" id="5176119">,</span>&nbsp;<span class="ident" id="5176121">line</span><span class="op" id="5176125">,</span>&nbsp;<span class="ident" id="5176127">pipe</span><span class="op" id="5176131">,</span>&nbsp;<span class="ident" id="5176133">list</span><span class="op" id="5176137">,</span>&nbsp;<span class="ident" id="5176139">elseList</span><br>
<span class="lineno"></span><span class="op" id="5176148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="5176151">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="5176158">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5176194">//&nbsp;&nbsp;&nbsp;&nbsp;{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5176248">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="5176271">func</span>&nbsp;<span class="op" id="5176276">(</span><span class="ident" id="5176277">t</span>&nbsp;<span class="op" id="5176279">*</span><span class="ident" id="5176280">Tree</span><span class="op" id="5176284">)</span>&nbsp;<span class="ident" id="5176286">ifControl</span><span class="op" id="5176295">(</span><span class="op" id="5176296">)</span>&nbsp;<span class="ident" id="5176298">Node</span>&nbsp;<span class="op" id="5176303">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176306">return</span>&nbsp;<span class="ident" id="5176313">t</span><span class="op" id="5176314">.</span><span class="ident" id="5176315">newIf</span><span class="op" id="5176320">(</span><span class="ident" id="5176321">t</span><span class="op" id="5176322">.</span><span class="ident" id="5176323">parseControl</span><span class="op" id="5176335">(</span><span class="builtintype" id="5176336">true</span><span class="op" id="5176340">,</span>&nbsp;<span class="string" id="5176342">&#34;if&#34;</span><span class="op" id="5176346">)</span><span class="op" id="5176347">)</span><br>
<span class="lineno"></span><span class="op" id="5176349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5176352">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="5176362">//&nbsp;&nbsp;&nbsp;&nbsp;{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="5176401">//&nbsp;&nbsp;&nbsp;&nbsp;{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5176458">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="5176484">func</span>&nbsp;<span class="op" id="5176489">(</span><span class="ident" id="5176490">t</span>&nbsp;<span class="op" id="5176492">*</span><span class="ident" id="5176493">Tree</span><span class="op" id="5176497">)</span>&nbsp;<span class="ident" id="5176499">rangeControl</span><span class="op" id="5176511">(</span><span class="op" id="5176512">)</span>&nbsp;<span class="ident" id="5176514">Node</span>&nbsp;<span class="op" id="5176519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176522">return</span>&nbsp;<span class="ident" id="5176529">t</span><span class="op" id="5176530">.</span><span class="ident" id="5176531">newRange</span><span class="op" id="5176539">(</span><span class="ident" id="5176540">t</span><span class="op" id="5176541">.</span><span class="ident" id="5176542">parseControl</span><span class="op" id="5176554">(</span><span class="builtintype" id="5176555">false</span><span class="op" id="5176560">,</span>&nbsp;<span class="string" id="5176562">&#34;range&#34;</span><span class="op" id="5176569">)</span><span class="op" id="5176570">)</span><br>
<span class="lineno"></span><span class="op" id="5176572">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5176575">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="5176584">//&nbsp;&nbsp;&nbsp;&nbsp;{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5176622">//&nbsp;&nbsp;&nbsp;&nbsp;{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5176678">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="5176701">func</span>&nbsp;<span class="op" id="5176706">(</span><span class="ident" id="5176707">t</span>&nbsp;<span class="op" id="5176709">*</span><span class="ident" id="5176710">Tree</span><span class="op" id="5176714">)</span>&nbsp;<span class="ident" id="5176716">withControl</span><span class="op" id="5176727">(</span><span class="op" id="5176728">)</span>&nbsp;<span class="ident" id="5176730">Node</span>&nbsp;<span class="op" id="5176735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176738">return</span>&nbsp;<span class="ident" id="5176745">t</span><span class="op" id="5176746">.</span><span class="ident" id="5176747">newWith</span><span class="op" id="5176754">(</span><span class="ident" id="5176755">t</span><span class="op" id="5176756">.</span><span class="ident" id="5176757">parseControl</span><span class="op" id="5176769">(</span><span class="builtintype" id="5176770">false</span><span class="op" id="5176775">,</span>&nbsp;<span class="string" id="5176777">&#34;with&#34;</span><span class="op" id="5176783">)</span><span class="op" id="5176784">)</span><br>
<span class="lineno"></span><span class="op" id="5176786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5176789">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="5176797">//&nbsp;&nbsp;&nbsp;&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="5176808">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="5176832">func</span>&nbsp;<span class="op" id="5176837">(</span><span class="ident" id="5176838">t</span>&nbsp;<span class="op" id="5176840">*</span><span class="ident" id="5176841">Tree</span><span class="op" id="5176845">)</span>&nbsp;<span class="ident" id="5176847">endControl</span><span class="op" id="5176857">(</span><span class="op" id="5176858">)</span>&nbsp;<span class="ident" id="5176860">Node</span>&nbsp;<span class="op" id="5176865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5176868">return</span>&nbsp;<span class="ident" id="5176875">t</span><span class="op" id="5176876">.</span><span class="ident" id="5176877">newEnd</span><span class="op" id="5176883">(</span><span class="ident" id="5176884">t</span><span class="op" id="5176885">.</span><span class="ident" id="5176886">expect</span><span class="op" id="5176892">(</span><span class="ident" id="5176893">itemRightDelim</span><span class="op" id="5176907">,</span>&nbsp;<span class="string" id="5176909">&#34;end&#34;</span><span class="op" id="5176914">)</span><span class="op" id="5176915">.</span><span class="ident" id="5176916">pos</span><span class="op" id="5176919">)</span><br>
<span class="lineno"></span><span class="op" id="5176921">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="5176924">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="5176933">//&nbsp;&nbsp;&nbsp;&nbsp;{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="5176945">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="5176970">func</span>&nbsp;<span class="op" id="5176975">(</span><span class="ident" id="5176976">t</span>&nbsp;<span class="op" id="5176978">*</span><span class="ident" id="5176979">Tree</span><span class="op" id="5176983">)</span>&nbsp;<span class="ident" id="5176985">elseControl</span><span class="op" id="5176996">(</span><span class="op" id="5176997">)</span>&nbsp;<span class="ident" id="5176999">Node</span>&nbsp;<span class="op" id="5177004">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5177007">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177039">peek</span>&nbsp;<span class="op" id="5177044">:=</span>&nbsp;<span class="ident" id="5177047">t</span><span class="op" id="5177048">.</span><span class="ident" id="5177049">peekNonSpace</span><span class="op" id="5177061">(</span><span class="op" id="5177062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177065">if</span>&nbsp;<span class="ident" id="5177068">peek</span><span class="op" id="5177072">.</span><span class="ident" id="5177073">typ</span>&nbsp;<span class="op" id="5177077">==</span>&nbsp;<span class="ident" id="5177080">itemIf</span>&nbsp;<span class="op" id="5177087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5177091">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177168">return</span>&nbsp;<span class="ident" id="5177175">t</span><span class="op" id="5177176">.</span><span class="ident" id="5177177">newElse</span><span class="op" id="5177184">(</span><span class="ident" id="5177185">peek</span><span class="op" id="5177189">.</span><span class="ident" id="5177190">pos</span><span class="op" id="5177193">,</span>&nbsp;<span class="ident" id="5177195">t</span><span class="op" id="5177196">.</span><span class="ident" id="5177197">lex</span><span class="op" id="5177200">.</span><span class="ident" id="5177201">lineNumber</span><span class="op" id="5177211">(</span><span class="op" id="5177212">)</span><span class="op" id="5177213">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5177216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177219">return</span>&nbsp;<span class="ident" id="5177226">t</span><span class="op" id="5177227">.</span><span class="ident" id="5177228">newElse</span><span class="op" id="5177235">(</span><span class="ident" id="5177236">t</span><span class="op" id="5177237">.</span><span class="ident" id="5177238">expect</span><span class="op" id="5177244">(</span><span class="ident" id="5177245">itemRightDelim</span><span class="op" id="5177259">,</span>&nbsp;<span class="string" id="5177261">&#34;else&#34;</span><span class="op" id="5177267">)</span><span class="op" id="5177268">.</span><span class="ident" id="5177269">pos</span><span class="op" id="5177272">,</span>&nbsp;<span class="ident" id="5177274">t</span><span class="op" id="5177275">.</span><span class="ident" id="5177276">lex</span><span class="op" id="5177279">.</span><span class="ident" id="5177280">lineNumber</span><span class="op" id="5177290">(</span><span class="op" id="5177291">)</span><span class="op" id="5177292">)</span><br>
<span class="lineno"></span><span class="op" id="5177294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5177297">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="5177310">//&nbsp;&nbsp;&nbsp;&nbsp;{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="5177347">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="5177422">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="5177438">func</span>&nbsp;<span class="op" id="5177443">(</span><span class="ident" id="5177444">t</span>&nbsp;<span class="op" id="5177446">*</span><span class="ident" id="5177447">Tree</span><span class="op" id="5177451">)</span>&nbsp;<span class="ident" id="5177453">templateControl</span><span class="op" id="5177468">(</span><span class="op" id="5177469">)</span>&nbsp;<span class="ident" id="5177471">Node</span>&nbsp;<span class="op" id="5177476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177479">var</span>&nbsp;<span class="ident" id="5177483">name</span>&nbsp;<span class="builtintype" id="5177488">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177496">token</span>&nbsp;<span class="op" id="5177502">:=</span>&nbsp;<span class="ident" id="5177505">t</span><span class="op" id="5177506">.</span><span class="ident" id="5177507">nextNonSpace</span><span class="op" id="5177519">(</span><span class="op" id="5177520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177523">switch</span>&nbsp;<span class="ident" id="5177530">token</span><span class="op" id="5177535">.</span><span class="ident" id="5177536">typ</span>&nbsp;<span class="op" id="5177540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177543">case</span>&nbsp;<span class="ident" id="5177548">itemString</span><span class="op" id="5177558">,</span>&nbsp;<span class="ident" id="5177560">itemRawString</span><span class="op" id="5177573">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177577">s</span><span class="op" id="5177578">,</span>&nbsp;<span class="ident" id="5177580">err</span>&nbsp;<span class="op" id="5177584">:=</span>&nbsp;<span class="ident" id="5177587">strconv</span><span class="op" id="5177594">.</span><span class="ident" id="5177595">Unquote</span><span class="op" id="5177602">(</span><span class="ident" id="5177603">token</span><span class="op" id="5177608">.</span><span class="ident" id="5177609">val</span><span class="op" id="5177612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177616">if</span>&nbsp;<span class="ident" id="5177619">err</span>&nbsp;<span class="op" id="5177623">!=</span>&nbsp;<span class="ident" id="5177626">nil</span>&nbsp;<span class="op" id="5177630">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177635">t</span><span class="op" id="5177636">.</span><span class="builtintype" id="5177637">error</span><span class="op" id="5177642">(</span><span class="ident" id="5177643">err</span><span class="op" id="5177646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5177650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177654">name</span>&nbsp;<span class="op" id="5177659">=</span>&nbsp;<span class="ident" id="5177661">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177664">default</span><span class="op" id="5177671">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177675">t</span><span class="op" id="5177676">.</span><span class="ident" id="5177677">unexpected</span><span class="op" id="5177687">(</span><span class="ident" id="5177688">token</span><span class="op" id="5177693">,</span>&nbsp;<span class="string" id="5177695">&#34;template&nbsp;invocation&#34;</span><span class="op" id="5177716">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5177719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177722">var</span>&nbsp;<span class="ident" id="5177726">pipe</span>&nbsp;<span class="op" id="5177731">*</span><span class="ident" id="5177732">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177742">if</span>&nbsp;<span class="ident" id="5177745">t</span><span class="op" id="5177746">.</span><span class="ident" id="5177747">nextNonSpace</span><span class="op" id="5177759">(</span><span class="op" id="5177760">)</span><span class="op" id="5177761">.</span><span class="ident" id="5177762">typ</span>&nbsp;<span class="op" id="5177766">!=</span>&nbsp;<span class="ident" id="5177769">itemRightDelim</span>&nbsp;<span class="op" id="5177784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177788">t</span><span class="op" id="5177789">.</span><span class="ident" id="5177790">backup</span><span class="op" id="5177796">(</span><span class="op" id="5177797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5177801">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5177854">pipe</span>&nbsp;<span class="op" id="5177859">=</span>&nbsp;<span class="ident" id="5177861">t</span><span class="op" id="5177862">.</span><span class="ident" id="5177863">pipeline</span><span class="op" id="5177871">(</span><span class="string" id="5177872">&#34;template&#34;</span><span class="op" id="5177882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5177885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5177888">return</span>&nbsp;<span class="ident" id="5177895">t</span><span class="op" id="5177896">.</span><span class="ident" id="5177897">newTemplate</span><span class="op" id="5177908">(</span><span class="ident" id="5177909">token</span><span class="op" id="5177914">.</span><span class="ident" id="5177915">pos</span><span class="op" id="5177918">,</span>&nbsp;<span class="ident" id="5177920">t</span><span class="op" id="5177921">.</span><span class="ident" id="5177922">lex</span><span class="op" id="5177925">.</span><span class="ident" id="5177926">lineNumber</span><span class="op" id="5177936">(</span><span class="op" id="5177937">)</span><span class="op" id="5177938">,</span>&nbsp;<span class="ident" id="5177940">name</span><span class="op" id="5177944">,</span>&nbsp;<span class="ident" id="5177946">pipe</span><span class="op" id="5177950">)</span><br>
<span class="lineno"></span><span class="op" id="5177952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="5177955">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="5177967">//&nbsp;&nbsp;&nbsp;&nbsp;operand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="5177995">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="5178071">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="5178155">func</span>&nbsp;<span class="op" id="5178160">(</span><span class="ident" id="5178161">t</span>&nbsp;<span class="op" id="5178163">*</span><span class="ident" id="5178164">Tree</span><span class="op" id="5178168">)</span>&nbsp;<span class="ident" id="5178170">command</span><span class="op" id="5178177">(</span><span class="op" id="5178178">)</span>&nbsp;<span class="op" id="5178180">*</span><span class="ident" id="5178181">CommandNode</span>&nbsp;<span class="op" id="5178193">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178196">cmd</span>&nbsp;<span class="op" id="5178200">:=</span>&nbsp;<span class="ident" id="5178203">t</span><span class="op" id="5178204">.</span><span class="ident" id="5178205">newCommand</span><span class="op" id="5178215">(</span><span class="ident" id="5178216">t</span><span class="op" id="5178217">.</span><span class="ident" id="5178218">peekNonSpace</span><span class="op" id="5178230">(</span><span class="op" id="5178231">)</span><span class="op" id="5178232">.</span><span class="ident" id="5178233">pos</span><span class="op" id="5178236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178239">for</span>&nbsp;<span class="op" id="5178243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178247">t</span><span class="op" id="5178248">.</span><span class="ident" id="5178249">peekNonSpace</span><span class="op" id="5178261">(</span><span class="op" id="5178262">)</span>&nbsp;<span class="comment" id="5178264">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178290">operand</span>&nbsp;<span class="op" id="5178298">:=</span>&nbsp;<span class="ident" id="5178301">t</span><span class="op" id="5178302">.</span><span class="ident" id="5178303">operand</span><span class="op" id="5178310">(</span><span class="op" id="5178311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178315">if</span>&nbsp;<span class="ident" id="5178318">operand</span>&nbsp;<span class="op" id="5178326">!=</span>&nbsp;<span class="ident" id="5178329">nil</span>&nbsp;<span class="op" id="5178333">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178338">cmd</span><span class="op" id="5178341">.</span><span class="builtinfunc" id="5178342">append</span><span class="op" id="5178348">(</span><span class="ident" id="5178349">operand</span><span class="op" id="5178356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5178360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178364">switch</span>&nbsp;<span class="ident" id="5178371">token</span>&nbsp;<span class="op" id="5178377">:=</span>&nbsp;<span class="ident" id="5178380">t</span><span class="op" id="5178381">.</span><span class="ident" id="5178382">next</span><span class="op" id="5178386">(</span><span class="op" id="5178387">)</span><span class="op" id="5178388">;</span>&nbsp;<span class="ident" id="5178390">token</span><span class="op" id="5178395">.</span><span class="ident" id="5178396">typ</span>&nbsp;<span class="op" id="5178400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178404">case</span>&nbsp;<span class="ident" id="5178409">itemSpace</span><span class="op" id="5178418">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178423">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178434">case</span>&nbsp;<span class="ident" id="5178439">itemError</span><span class="op" id="5178448">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178453">t</span><span class="op" id="5178454">.</span><span class="ident" id="5178455">errorf</span><span class="op" id="5178461">(</span><span class="string" id="5178462">&#34;%s&#34;</span><span class="op" id="5178466">,</span>&nbsp;<span class="ident" id="5178468">token</span><span class="op" id="5178473">.</span><span class="ident" id="5178474">val</span><span class="op" id="5178477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178481">case</span>&nbsp;<span class="ident" id="5178486">itemRightDelim</span><span class="op" id="5178500">,</span>&nbsp;<span class="ident" id="5178502">itemRightParen</span><span class="op" id="5178516">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178521">t</span><span class="op" id="5178522">.</span><span class="ident" id="5178523">backup</span><span class="op" id="5178529">(</span><span class="op" id="5178530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178534">case</span>&nbsp;<span class="ident" id="5178539">itemPipe</span><span class="op" id="5178547">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178551">default</span><span class="op" id="5178558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178563">t</span><span class="op" id="5178564">.</span><span class="ident" id="5178565">errorf</span><span class="op" id="5178571">(</span><span class="string" id="5178572">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="5178614">,</span>&nbsp;<span class="ident" id="5178616">token</span><span class="op" id="5178621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5178625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178629">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5178636">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178639">if</span>&nbsp;<span class="builtinfunc" id="5178642">len</span><span class="op" id="5178645">(</span><span class="ident" id="5178646">cmd</span><span class="op" id="5178649">.</span><span class="ident" id="5178650">Args</span><span class="op" id="5178654">)</span>&nbsp;<span class="op" id="5178656">==</span>&nbsp;<span class="num" id="5178659">0</span>&nbsp;<span class="op" id="5178661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178665">t</span><span class="op" id="5178666">.</span><span class="ident" id="5178667">errorf</span><span class="op" id="5178673">(</span><span class="string" id="5178674">&#34;empty&nbsp;command&#34;</span><span class="op" id="5178689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5178692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178695">return</span>&nbsp;<span class="ident" id="5178702">cmd</span><br>
<span class="lineno"></span><span class="op" id="5178706">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="5178709">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="5178721">//&nbsp;&nbsp;&nbsp;&nbsp;term&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="5178737">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="5178796">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="5178843">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="5178898">func</span>&nbsp;<span class="op" id="5178903">(</span><span class="ident" id="5178904">t</span>&nbsp;<span class="op" id="5178906">*</span><span class="ident" id="5178907">Tree</span><span class="op" id="5178911">)</span>&nbsp;<span class="ident" id="5178913">operand</span><span class="op" id="5178920">(</span><span class="op" id="5178921">)</span>&nbsp;<span class="ident" id="5178923">Node</span>&nbsp;<span class="op" id="5178928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5178931">node</span>&nbsp;<span class="op" id="5178936">:=</span>&nbsp;<span class="ident" id="5178939">t</span><span class="op" id="5178940">.</span><span class="ident" id="5178941">term</span><span class="op" id="5178945">(</span><span class="op" id="5178946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178949">if</span>&nbsp;<span class="ident" id="5178952">node</span>&nbsp;<span class="op" id="5178957">==</span>&nbsp;<span class="ident" id="5178960">nil</span>&nbsp;<span class="op" id="5178964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178968">return</span>&nbsp;<span class="ident" id="5178975">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5178980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5178983">if</span>&nbsp;<span class="ident" id="5178986">t</span><span class="op" id="5178987">.</span><span class="ident" id="5178988">peek</span><span class="op" id="5178992">(</span><span class="op" id="5178993">)</span><span class="op" id="5178994">.</span><span class="ident" id="5178995">typ</span>&nbsp;<span class="op" id="5178999">==</span>&nbsp;<span class="ident" id="5179002">itemField</span>&nbsp;<span class="op" id="5179012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179016">chain</span>&nbsp;<span class="op" id="5179022">:=</span>&nbsp;<span class="ident" id="5179025">t</span><span class="op" id="5179026">.</span><span class="ident" id="5179027">newChain</span><span class="op" id="5179035">(</span><span class="ident" id="5179036">t</span><span class="op" id="5179037">.</span><span class="ident" id="5179038">peek</span><span class="op" id="5179042">(</span><span class="op" id="5179043">)</span><span class="op" id="5179044">.</span><span class="ident" id="5179045">pos</span><span class="op" id="5179048">,</span>&nbsp;<span class="ident" id="5179050">node</span><span class="op" id="5179054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179058">for</span>&nbsp;<span class="ident" id="5179062">t</span><span class="op" id="5179063">.</span><span class="ident" id="5179064">peek</span><span class="op" id="5179068">(</span><span class="op" id="5179069">)</span><span class="op" id="5179070">.</span><span class="ident" id="5179071">typ</span>&nbsp;<span class="op" id="5179075">==</span>&nbsp;<span class="ident" id="5179078">itemField</span>&nbsp;<span class="op" id="5179088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179093">chain</span><span class="op" id="5179098">.</span><span class="ident" id="5179099">Add</span><span class="op" id="5179102">(</span><span class="ident" id="5179103">t</span><span class="op" id="5179104">.</span><span class="ident" id="5179105">next</span><span class="op" id="5179109">(</span><span class="op" id="5179110">)</span><span class="op" id="5179111">.</span><span class="ident" id="5179112">val</span><span class="op" id="5179115">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5179119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5179123">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5179194">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5179254">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5179291">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179339">switch</span>&nbsp;<span class="ident" id="5179346">node</span><span class="op" id="5179350">.</span><span class="ident" id="5179351">Type</span><span class="op" id="5179355">(</span><span class="op" id="5179356">)</span>&nbsp;<span class="op" id="5179358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179362">case</span>&nbsp;<span class="ident" id="5179367">NodeField</span><span class="op" id="5179376">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179381">node</span>&nbsp;<span class="op" id="5179386">=</span>&nbsp;<span class="ident" id="5179388">t</span><span class="op" id="5179389">.</span><span class="ident" id="5179390">newField</span><span class="op" id="5179398">(</span><span class="ident" id="5179399">chain</span><span class="op" id="5179404">.</span><span class="ident" id="5179405">Position</span><span class="op" id="5179413">(</span><span class="op" id="5179414">)</span><span class="op" id="5179415">,</span>&nbsp;<span class="ident" id="5179417">chain</span><span class="op" id="5179422">.</span><span class="ident" id="5179423">String</span><span class="op" id="5179429">(</span><span class="op" id="5179430">)</span><span class="op" id="5179431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179435">case</span>&nbsp;<span class="ident" id="5179440">NodeVariable</span><span class="op" id="5179452">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179457">node</span>&nbsp;<span class="op" id="5179462">=</span>&nbsp;<span class="ident" id="5179464">t</span><span class="op" id="5179465">.</span><span class="ident" id="5179466">newVariable</span><span class="op" id="5179477">(</span><span class="ident" id="5179478">chain</span><span class="op" id="5179483">.</span><span class="ident" id="5179484">Position</span><span class="op" id="5179492">(</span><span class="op" id="5179493">)</span><span class="op" id="5179494">,</span>&nbsp;<span class="ident" id="5179496">chain</span><span class="op" id="5179501">.</span><span class="ident" id="5179502">String</span><span class="op" id="5179508">(</span><span class="op" id="5179509">)</span><span class="op" id="5179510">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179514">default</span><span class="op" id="5179521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179526">node</span>&nbsp;<span class="op" id="5179531">=</span>&nbsp;<span class="ident" id="5179533">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5179541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5179544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179547">return</span>&nbsp;<span class="ident" id="5179554">node</span><br>
<span class="lineno">595</span><span class="op" id="5179559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5179562">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="5179571">//&nbsp;&nbsp;&nbsp;&nbsp;literal&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="5179613">//&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="5179638">//&nbsp;&nbsp;&nbsp;&nbsp;.</span><br>
<span class="lineno"></span><span class="comment" id="5179643">//&nbsp;&nbsp;&nbsp;&nbsp;.Field</span><br>
<span class="lineno"></span><span class="comment" id="5179653">//&nbsp;&nbsp;&nbsp;&nbsp;$</span><br>
<span class="lineno"></span><span class="comment" id="5179658">//&nbsp;&nbsp;&nbsp;&nbsp;&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="5179678">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="5179714">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="5179765">func</span>&nbsp;<span class="op" id="5179770">(</span><span class="ident" id="5179771">t</span>&nbsp;<span class="op" id="5179773">*</span><span class="ident" id="5179774">Tree</span><span class="op" id="5179778">)</span>&nbsp;<span class="ident" id="5179780">term</span><span class="op" id="5179784">(</span><span class="op" id="5179785">)</span>&nbsp;<span class="ident" id="5179787">Node</span>&nbsp;<span class="op" id="5179792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179795">switch</span>&nbsp;<span class="ident" id="5179802">token</span>&nbsp;<span class="op" id="5179808">:=</span>&nbsp;<span class="ident" id="5179811">t</span><span class="op" id="5179812">.</span><span class="ident" id="5179813">nextNonSpace</span><span class="op" id="5179825">(</span><span class="op" id="5179826">)</span><span class="op" id="5179827">;</span>&nbsp;<span class="ident" id="5179829">token</span><span class="op" id="5179834">.</span><span class="ident" id="5179835">typ</span>&nbsp;<span class="op" id="5179839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179842">case</span>&nbsp;<span class="ident" id="5179847">itemError</span><span class="op" id="5179856">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179860">t</span><span class="op" id="5179861">.</span><span class="ident" id="5179862">errorf</span><span class="op" id="5179868">(</span><span class="string" id="5179869">&#34;%s&#34;</span><span class="op" id="5179873">,</span>&nbsp;<span class="ident" id="5179875">token</span><span class="op" id="5179880">.</span><span class="ident" id="5179881">val</span><span class="op" id="5179884">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179887">case</span>&nbsp;<span class="ident" id="5179892">itemIdentifier</span><span class="op" id="5179906">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179910">if</span>&nbsp;<span class="op" id="5179913">!</span><span class="ident" id="5179914">t</span><span class="op" id="5179915">.</span><span class="ident" id="5179916">hasFunction</span><span class="op" id="5179927">(</span><span class="ident" id="5179928">token</span><span class="op" id="5179933">.</span><span class="ident" id="5179934">val</span><span class="op" id="5179937">)</span>&nbsp;<span class="op" id="5179939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5179944">t</span><span class="op" id="5179945">.</span><span class="ident" id="5179946">errorf</span><span class="op" id="5179952">(</span><span class="string" id="5179953">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="5179978">,</span>&nbsp;<span class="ident" id="5179980">token</span><span class="op" id="5179985">.</span><span class="ident" id="5179986">val</span><span class="op" id="5179989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5179993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5179997">return</span>&nbsp;<span class="ident" id="5180004">NewIdentifier</span><span class="op" id="5180017">(</span><span class="ident" id="5180018">token</span><span class="op" id="5180023">.</span><span class="ident" id="5180024">val</span><span class="op" id="5180027">)</span><span class="op" id="5180028">.</span><span class="ident" id="5180029">SetTree</span><span class="op" id="5180036">(</span><span class="ident" id="5180037">t</span><span class="op" id="5180038">)</span><span class="op" id="5180039">.</span><span class="ident" id="5180040">SetPos</span><span class="op" id="5180046">(</span><span class="ident" id="5180047">token</span><span class="op" id="5180052">.</span><span class="ident" id="5180053">pos</span><span class="op" id="5180056">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180059">case</span>&nbsp;<span class="ident" id="5180064">itemDot</span><span class="op" id="5180071">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180075">return</span>&nbsp;<span class="ident" id="5180082">t</span><span class="op" id="5180083">.</span><span class="ident" id="5180084">newDot</span><span class="op" id="5180090">(</span><span class="ident" id="5180091">token</span><span class="op" id="5180096">.</span><span class="ident" id="5180097">pos</span><span class="op" id="5180100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180103">case</span>&nbsp;<span class="ident" id="5180108">itemNil</span><span class="op" id="5180115">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180119">return</span>&nbsp;<span class="ident" id="5180126">t</span><span class="op" id="5180127">.</span><span class="ident" id="5180128">newNil</span><span class="op" id="5180134">(</span><span class="ident" id="5180135">token</span><span class="op" id="5180140">.</span><span class="ident" id="5180141">pos</span><span class="op" id="5180144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180147">case</span>&nbsp;<span class="ident" id="5180152">itemVariable</span><span class="op" id="5180164">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180168">return</span>&nbsp;<span class="ident" id="5180175">t</span><span class="op" id="5180176">.</span><span class="ident" id="5180177">useVar</span><span class="op" id="5180183">(</span><span class="ident" id="5180184">token</span><span class="op" id="5180189">.</span><span class="ident" id="5180190">pos</span><span class="op" id="5180193">,</span>&nbsp;<span class="ident" id="5180195">token</span><span class="op" id="5180200">.</span><span class="ident" id="5180201">val</span><span class="op" id="5180204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180207">case</span>&nbsp;<span class="ident" id="5180212">itemField</span><span class="op" id="5180221">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180225">return</span>&nbsp;<span class="ident" id="5180232">t</span><span class="op" id="5180233">.</span><span class="ident" id="5180234">newField</span><span class="op" id="5180242">(</span><span class="ident" id="5180243">token</span><span class="op" id="5180248">.</span><span class="ident" id="5180249">pos</span><span class="op" id="5180252">,</span>&nbsp;<span class="ident" id="5180254">token</span><span class="op" id="5180259">.</span><span class="ident" id="5180260">val</span><span class="op" id="5180263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180266">case</span>&nbsp;<span class="ident" id="5180271">itemBool</span><span class="op" id="5180279">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180283">return</span>&nbsp;<span class="ident" id="5180290">t</span><span class="op" id="5180291">.</span><span class="ident" id="5180292">newBool</span><span class="op" id="5180299">(</span><span class="ident" id="5180300">token</span><span class="op" id="5180305">.</span><span class="ident" id="5180306">pos</span><span class="op" id="5180309">,</span>&nbsp;<span class="ident" id="5180311">token</span><span class="op" id="5180316">.</span><span class="ident" id="5180317">val</span>&nbsp;<span class="op" id="5180321">==</span>&nbsp;<span class="string" id="5180324">&#34;true&#34;</span><span class="op" id="5180330">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180333">case</span>&nbsp;<span class="ident" id="5180338">itemCharConstant</span><span class="op" id="5180354">,</span>&nbsp;<span class="ident" id="5180356">itemComplex</span><span class="op" id="5180367">,</span>&nbsp;<span class="ident" id="5180369">itemNumber</span><span class="op" id="5180379">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180383">number</span><span class="op" id="5180389">,</span>&nbsp;<span class="ident" id="5180391">err</span>&nbsp;<span class="op" id="5180395">:=</span>&nbsp;<span class="ident" id="5180398">t</span><span class="op" id="5180399">.</span><span class="ident" id="5180400">newNumber</span><span class="op" id="5180409">(</span><span class="ident" id="5180410">token</span><span class="op" id="5180415">.</span><span class="ident" id="5180416">pos</span><span class="op" id="5180419">,</span>&nbsp;<span class="ident" id="5180421">token</span><span class="op" id="5180426">.</span><span class="ident" id="5180427">val</span><span class="op" id="5180430">,</span>&nbsp;<span class="ident" id="5180432">token</span><span class="op" id="5180437">.</span><span class="ident" id="5180438">typ</span><span class="op" id="5180441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180445">if</span>&nbsp;<span class="ident" id="5180448">err</span>&nbsp;<span class="op" id="5180452">!=</span>&nbsp;<span class="ident" id="5180455">nil</span>&nbsp;<span class="op" id="5180459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180464">t</span><span class="op" id="5180465">.</span><span class="builtintype" id="5180466">error</span><span class="op" id="5180471">(</span><span class="ident" id="5180472">err</span><span class="op" id="5180475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5180479">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180483">return</span>&nbsp;<span class="ident" id="5180490">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180498">case</span>&nbsp;<span class="ident" id="5180503">itemLeftParen</span><span class="op" id="5180516">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180520">pipe</span>&nbsp;<span class="op" id="5180525">:=</span>&nbsp;<span class="ident" id="5180528">t</span><span class="op" id="5180529">.</span><span class="ident" id="5180530">pipeline</span><span class="op" id="5180538">(</span><span class="string" id="5180539">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="5180563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180567">if</span>&nbsp;<span class="ident" id="5180570">token</span>&nbsp;<span class="op" id="5180576">:=</span>&nbsp;<span class="ident" id="5180579">t</span><span class="op" id="5180580">.</span><span class="ident" id="5180581">next</span><span class="op" id="5180585">(</span><span class="op" id="5180586">)</span><span class="op" id="5180587">;</span>&nbsp;<span class="ident" id="5180589">token</span><span class="op" id="5180594">.</span><span class="ident" id="5180595">typ</span>&nbsp;<span class="op" id="5180599">!=</span>&nbsp;<span class="ident" id="5180602">itemRightParen</span>&nbsp;<span class="op" id="5180617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180622">t</span><span class="op" id="5180623">.</span><span class="ident" id="5180624">errorf</span><span class="op" id="5180630">(</span><span class="string" id="5180631">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="5180668">,</span>&nbsp;<span class="ident" id="5180670">token</span><span class="op" id="5180675">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5180679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180683">return</span>&nbsp;<span class="ident" id="5180690">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180696">case</span>&nbsp;<span class="ident" id="5180701">itemString</span><span class="op" id="5180711">,</span>&nbsp;<span class="ident" id="5180713">itemRawString</span><span class="op" id="5180726">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180730">s</span><span class="op" id="5180731">,</span>&nbsp;<span class="ident" id="5180733">err</span>&nbsp;<span class="op" id="5180737">:=</span>&nbsp;<span class="ident" id="5180740">strconv</span><span class="op" id="5180747">.</span><span class="ident" id="5180748">Unquote</span><span class="op" id="5180755">(</span><span class="ident" id="5180756">token</span><span class="op" id="5180761">.</span><span class="ident" id="5180762">val</span><span class="op" id="5180765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180769">if</span>&nbsp;<span class="ident" id="5180772">err</span>&nbsp;<span class="op" id="5180776">!=</span>&nbsp;<span class="ident" id="5180779">nil</span>&nbsp;<span class="op" id="5180783">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180788">t</span><span class="op" id="5180789">.</span><span class="builtintype" id="5180790">error</span><span class="op" id="5180795">(</span><span class="ident" id="5180796">err</span><span class="op" id="5180799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5180803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180807">return</span>&nbsp;<span class="ident" id="5180814">t</span><span class="op" id="5180815">.</span><span class="ident" id="5180816">newString</span><span class="op" id="5180825">(</span><span class="ident" id="5180826">token</span><span class="op" id="5180831">.</span><span class="ident" id="5180832">pos</span><span class="op" id="5180835">,</span>&nbsp;<span class="ident" id="5180837">token</span><span class="op" id="5180842">.</span><span class="ident" id="5180843">val</span><span class="op" id="5180846">,</span>&nbsp;<span class="ident" id="5180848">s</span><span class="op" id="5180849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5180852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5180855">t</span><span class="op" id="5180856">.</span><span class="ident" id="5180857">backup</span><span class="op" id="5180863">(</span><span class="op" id="5180864">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180867">return</span>&nbsp;<span class="ident" id="5180874">nil</span><br>
<span class="lineno"></span><span class="op" id="5180878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5180881">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="5180950">func</span>&nbsp;<span class="op" id="5180955">(</span><span class="ident" id="5180956">t</span>&nbsp;<span class="op" id="5180958">*</span><span class="ident" id="5180959">Tree</span><span class="op" id="5180963">)</span>&nbsp;<span class="ident" id="5180965">hasFunction</span><span class="op" id="5180976">(</span><span class="ident" id="5180977">name</span>&nbsp;<span class="builtintype" id="5180982">string</span><span class="op" id="5180988">)</span>&nbsp;<span class="builtintype" id="5180990">bool</span>&nbsp;<span class="op" id="5180995">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5180998">for</span>&nbsp;<span class="ident" id="5181002">_</span><span class="op" id="5181003">,</span>&nbsp;<span class="ident" id="5181005">funcMap</span>&nbsp;<span class="op" id="5181013">:=</span>&nbsp;<span class="keyword" id="5181016">range</span>&nbsp;<span class="ident" id="5181022">t</span><span class="op" id="5181023">.</span><span class="ident" id="5181024">funcs</span>&nbsp;<span class="op" id="5181030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5181034">if</span>&nbsp;<span class="ident" id="5181037">funcMap</span>&nbsp;<span class="op" id="5181045">==</span>&nbsp;<span class="ident" id="5181048">nil</span>&nbsp;<span class="op" id="5181052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5181057">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5181068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5181072">if</span>&nbsp;<span class="ident" id="5181075">funcMap</span><span class="op" id="5181082">[</span><span class="ident" id="5181083">name</span><span class="op" id="5181087">]</span>&nbsp;<span class="op" id="5181089">!=</span>&nbsp;<span class="ident" id="5181092">nil</span>&nbsp;<span class="op" id="5181096">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5181101">return</span>&nbsp;<span class="builtintype" id="5181108">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5181115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5181118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5181121">return</span>&nbsp;<span class="builtintype" id="5181128">false</span><br>
<span class="lineno"></span><span class="op" id="5181134">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="5181137">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="5181196">func</span>&nbsp;<span class="op" id="5181201">(</span><span class="ident" id="5181202">t</span>&nbsp;<span class="op" id="5181204">*</span><span class="ident" id="5181205">Tree</span><span class="op" id="5181209">)</span>&nbsp;<span class="ident" id="5181211">popVars</span><span class="op" id="5181218">(</span><span class="ident" id="5181219">n</span>&nbsp;<span class="builtintype" id="5181221">int</span><span class="op" id="5181224">)</span>&nbsp;<span class="op" id="5181226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181229">t</span><span class="op" id="5181230">.</span><span class="ident" id="5181231">vars</span>&nbsp;<span class="op" id="5181236">=</span>&nbsp;<span class="ident" id="5181238">t</span><span class="op" id="5181239">.</span><span class="ident" id="5181240">vars</span><span class="op" id="5181244">[</span><span class="op" id="5181245">:</span><span class="ident" id="5181246">n</span><span class="op" id="5181247">]</span><br>
<span class="lineno"></span><span class="op" id="5181249">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="5181252">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5181320">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="5181348">func</span>&nbsp;<span class="op" id="5181353">(</span><span class="ident" id="5181354">t</span>&nbsp;<span class="op" id="5181356">*</span><span class="ident" id="5181357">Tree</span><span class="op" id="5181361">)</span>&nbsp;<span class="ident" id="5181363">useVar</span><span class="op" id="5181369">(</span><span class="ident" id="5181370">pos</span>&nbsp;<span class="ident" id="5181374">Pos</span><span class="op" id="5181377">,</span>&nbsp;<span class="ident" id="5181379">name</span>&nbsp;<span class="builtintype" id="5181384">string</span><span class="op" id="5181390">)</span>&nbsp;<span class="ident" id="5181392">Node</span>&nbsp;<span class="op" id="5181397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181400">v</span>&nbsp;<span class="op" id="5181402">:=</span>&nbsp;<span class="ident" id="5181405">t</span><span class="op" id="5181406">.</span><span class="ident" id="5181407">newVariable</span><span class="op" id="5181418">(</span><span class="ident" id="5181419">pos</span><span class="op" id="5181422">,</span>&nbsp;<span class="ident" id="5181424">name</span><span class="op" id="5181428">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5181431">for</span>&nbsp;<span class="ident" id="5181435">_</span><span class="op" id="5181436">,</span>&nbsp;<span class="ident" id="5181438">varName</span>&nbsp;<span class="op" id="5181446">:=</span>&nbsp;<span class="keyword" id="5181449">range</span>&nbsp;<span class="ident" id="5181455">t</span><span class="op" id="5181456">.</span><span class="ident" id="5181457">vars</span>&nbsp;<span class="op" id="5181462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5181466">if</span>&nbsp;<span class="ident" id="5181469">varName</span>&nbsp;<span class="op" id="5181477">==</span>&nbsp;<span class="ident" id="5181480">v</span><span class="op" id="5181481">.</span><span class="ident" id="5181482">Ident</span><span class="op" id="5181487">[</span><span class="num" id="5181488">0</span><span class="op" id="5181489">]</span>&nbsp;<span class="op" id="5181491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5181496">return</span>&nbsp;<span class="ident" id="5181503">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5181507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5181510">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5181513">t</span><span class="op" id="5181514">.</span><span class="ident" id="5181515">errorf</span><span class="op" id="5181521">(</span><span class="string" id="5181522">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="5181545">,</span>&nbsp;<span class="ident" id="5181547">v</span><span class="op" id="5181548">.</span><span class="ident" id="5181549">Ident</span><span class="op" id="5181554">[</span><span class="num" id="5181555">0</span><span class="op" id="5181556">]</span><span class="op" id="5181557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5181560">return</span>&nbsp;<span class="ident" id="5181567">nil</span><br>
<span class="lineno"></span><span class="op" id="5181571">}</span>
</div>
</body>
</html>
