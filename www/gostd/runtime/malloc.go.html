<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html" class="current">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1535313">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1535368">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1535422">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1535473">package</span>&nbsp;<span class="ident" id="1535481">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1535490">import</span>&nbsp;<span class="op" id="1535497">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1535500">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1535509">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1535512">const</span>&nbsp;<span class="op" id="1535518">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535521">debugMalloc</span>&nbsp;<span class="op" id="1535533">=</span>&nbsp;<span class="builtintype" id="1535535">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535543">flagNoScan</span>&nbsp;<span class="op" id="1535554">=</span>&nbsp;<span class="ident" id="1535556">_FlagNoScan</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535569">flagNoZero</span>&nbsp;<span class="op" id="1535580">=</span>&nbsp;<span class="ident" id="1535582">_FlagNoZero</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535596">maxTinySize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1535610">=</span>&nbsp;<span class="ident" id="1535612">_TinySize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535623">tinySizeClass</span>&nbsp;<span class="op" id="1535637">=</span>&nbsp;<span class="ident" id="1535639">_TinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535655">maxSmallSize</span>&nbsp;&nbsp;<span class="op" id="1535669">=</span>&nbsp;<span class="ident" id="1535671">_MaxSmallSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535687">pageShift</span>&nbsp;<span class="op" id="1535697">=</span>&nbsp;<span class="ident" id="1535699">_PageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535711">pageSize</span>&nbsp;&nbsp;<span class="op" id="1535721">=</span>&nbsp;<span class="ident" id="1535723">_PageSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535734">pageMask</span>&nbsp;&nbsp;<span class="op" id="1535744">=</span>&nbsp;<span class="ident" id="1535746">_PageMask</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535758">bitsPerPointer</span>&nbsp;&nbsp;<span class="op" id="1535774">=</span>&nbsp;<span class="ident" id="1535776">_BitsPerPointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535793">bitsMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1535809">=</span>&nbsp;<span class="ident" id="1535811">_BitsMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535822">pointersPerByte</span>&nbsp;<span class="op" id="1535838">=</span>&nbsp;<span class="ident" id="1535840">_PointersPerByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535858">maxGCMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1535874">=</span>&nbsp;<span class="ident" id="1535876">_MaxGCMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535888">bitsDead</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1535904">=</span>&nbsp;<span class="ident" id="1535906">_BitsDead</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535917">bitsPointer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1535933">=</span>&nbsp;<span class="ident" id="1535935">_BitsPointer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535950">mSpanInUse</span>&nbsp;<span class="op" id="1535961">=</span>&nbsp;<span class="ident" id="1535963">_MSpanInUse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1535977">concurrentSweep</span>&nbsp;<span class="op" id="1535993">=</span>&nbsp;<span class="ident" id="1535995">_ConcurrentSweep</span>&nbsp;<span class="op" id="1536012">!=</span>&nbsp;<span class="num" id="1536015">0</span><br>
<span class="lineno">35</span><span class="op" id="1536017">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1536020">//&nbsp;Page&nbsp;number&nbsp;(address&gt;&gt;pageShift)</span><br>
<span class="lineno"></span><span class="keyword" id="1536056">type</span>&nbsp;<span class="ident" id="1536061">pageID</span>&nbsp;<span class="builtintype" id="1536068">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1536077">//&nbsp;base&nbsp;address&nbsp;for&nbsp;all&nbsp;0-byte&nbsp;allocations</span><br>
<span class="lineno"></span><span class="keyword" id="1536120">var</span>&nbsp;<span class="ident" id="1536124">zerobase</span>&nbsp;<span class="builtintype" id="1536133">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1536142">//&nbsp;Allocate&nbsp;an&nbsp;object&nbsp;of&nbsp;size&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="1536179">//&nbsp;Small&nbsp;objects&nbsp;are&nbsp;allocated&nbsp;from&nbsp;the&nbsp;per-P&nbsp;cache&#39;s&nbsp;free&nbsp;lists.</span><br>
<span class="lineno">45</span><span class="comment" id="1536245">//&nbsp;Large&nbsp;objects&nbsp;(&gt;&nbsp;32&nbsp;kB)&nbsp;are&nbsp;allocated&nbsp;straight&nbsp;from&nbsp;the&nbsp;heap.</span><br>
<span class="lineno"></span><span class="keyword" id="1536310">func</span>&nbsp;<span class="ident" id="1536315">mallocgc</span><span class="op" id="1536323">(</span><span class="ident" id="1536324">size</span>&nbsp;<span class="builtintype" id="1536329">uintptr</span><span class="op" id="1536336">,</span>&nbsp;<span class="ident" id="1536338">typ</span>&nbsp;<span class="op" id="1536342">*</span><span class="ident" id="1536343">_type</span><span class="op" id="1536348">,</span>&nbsp;<span class="ident" id="1536350">flags</span>&nbsp;<span class="builtintype" id="1536356">uint32</span><span class="op" id="1536362">)</span>&nbsp;<span class="ident" id="1536364">unsafe</span><span class="op" id="1536370">.</span><span class="ident" id="1536371">Pointer</span>&nbsp;<span class="op" id="1536379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536382">if</span>&nbsp;<span class="ident" id="1536385">size</span>&nbsp;<span class="op" id="1536390">==</span>&nbsp;<span class="num" id="1536393">0</span>&nbsp;<span class="op" id="1536395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536399">return</span>&nbsp;<span class="ident" id="1536406">unsafe</span><span class="op" id="1536412">.</span><span class="ident" id="1536413">Pointer</span><span class="op" id="1536420">(</span><span class="op" id="1536421">&amp;</span><span class="ident" id="1536422">zerobase</span><span class="op" id="1536430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536433">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536436">size0</span>&nbsp;<span class="op" id="1536442">:=</span>&nbsp;<span class="ident" id="1536445">size</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536452">if</span>&nbsp;<span class="ident" id="1536455">flags</span><span class="op" id="1536460">&amp;</span><span class="ident" id="1536461">flagNoScan</span>&nbsp;<span class="op" id="1536472">==</span>&nbsp;<span class="num" id="1536475">0</span>&nbsp;<span class="op" id="1536477">&amp;&amp;</span>&nbsp;<span class="ident" id="1536480">typ</span>&nbsp;<span class="op" id="1536484">==</span>&nbsp;<span class="ident" id="1536487">nil</span>&nbsp;<span class="op" id="1536491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536495">gothrow</span><span class="op" id="1536502">(</span><span class="string" id="1536503">&#34;malloc&nbsp;missing&nbsp;type&#34;</span><span class="op" id="1536524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536527">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536531">//&nbsp;This&nbsp;function&nbsp;must&nbsp;be&nbsp;atomic&nbsp;wrt&nbsp;GC,&nbsp;but&nbsp;for&nbsp;performance&nbsp;reasons</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536600">//&nbsp;we&nbsp;don&#39;t&nbsp;acquirem/releasem&nbsp;on&nbsp;fast&nbsp;path.&nbsp;The&nbsp;code&nbsp;below&nbsp;does&nbsp;not&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536674">//&nbsp;split&nbsp;stack&nbsp;checks,&nbsp;so&nbsp;it&nbsp;can&#39;t&nbsp;be&nbsp;preempted&nbsp;by&nbsp;GC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536730">//&nbsp;Functions&nbsp;like&nbsp;roundup/add&nbsp;are&nbsp;inlined.&nbsp;And&nbsp;onM/racemalloc&nbsp;are&nbsp;nosplit.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1536806">//&nbsp;If&nbsp;debugMalloc&nbsp;=&nbsp;true,&nbsp;these&nbsp;assumptions&nbsp;are&nbsp;checked&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536870">if</span>&nbsp;<span class="ident" id="1536873">debugMalloc</span>&nbsp;<span class="op" id="1536885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536889">mp</span>&nbsp;<span class="op" id="1536892">:=</span>&nbsp;<span class="ident" id="1536895">acquirem</span><span class="op" id="1536903">(</span><span class="op" id="1536904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536908">if</span>&nbsp;<span class="ident" id="1536911">mp</span><span class="op" id="1536913">.</span><span class="ident" id="1536914">mallocing</span>&nbsp;<span class="op" id="1536924">!=</span>&nbsp;<span class="num" id="1536927">0</span>&nbsp;<span class="op" id="1536929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536934">gothrow</span><span class="op" id="1536941">(</span><span class="string" id="1536942">&#34;malloc&nbsp;deadlock&#34;</span><span class="op" id="1536959">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1536963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1536967">mp</span><span class="op" id="1536969">.</span><span class="ident" id="1536970">mallocing</span>&nbsp;<span class="op" id="1536980">=</span>&nbsp;<span class="num" id="1536982">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1536986">if</span>&nbsp;<span class="ident" id="1536989">mp</span><span class="op" id="1536991">.</span><span class="ident" id="1536992">curg</span>&nbsp;<span class="op" id="1536997">!=</span>&nbsp;<span class="ident" id="1537000">nil</span>&nbsp;<span class="op" id="1537004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537009">mp</span><span class="op" id="1537011">.</span><span class="ident" id="1537012">curg</span><span class="op" id="1537016">.</span><span class="ident" id="1537017">stackguard0</span>&nbsp;<span class="op" id="1537029">=</span>&nbsp;<span class="op" id="1537031">^</span><span class="builtintype" id="1537032">uintptr</span><span class="op" id="1537039">(</span><span class="num" id="1537040">0xfff</span><span class="op" id="1537045">)</span>&nbsp;<span class="op" id="1537047">|</span>&nbsp;<span class="num" id="1537049">0xbad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1537057">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1537060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1537064">c</span>&nbsp;<span class="op" id="1537066">:=</span>&nbsp;<span class="ident" id="1537069">gomcache</span><span class="op" id="1537077">(</span><span class="op" id="1537078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1537081">var</span>&nbsp;<span class="ident" id="1537085">s</span>&nbsp;<span class="op" id="1537087">*</span><span class="ident" id="1537088">mspan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1537095">var</span>&nbsp;<span class="ident" id="1537099">x</span>&nbsp;<span class="ident" id="1537101">unsafe</span><span class="op" id="1537107">.</span><span class="ident" id="1537108">Pointer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1537117">if</span>&nbsp;<span class="ident" id="1537120">size</span>&nbsp;<span class="op" id="1537125">&lt;=</span>&nbsp;<span class="ident" id="1537128">maxSmallSize</span>&nbsp;<span class="op" id="1537141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1537145">if</span>&nbsp;<span class="ident" id="1537148">flags</span><span class="op" id="1537153">&amp;</span><span class="ident" id="1537154">flagNoScan</span>&nbsp;<span class="op" id="1537165">!=</span>&nbsp;<span class="num" id="1537168">0</span>&nbsp;<span class="op" id="1537170">&amp;&amp;</span>&nbsp;<span class="ident" id="1537173">size</span>&nbsp;<span class="op" id="1537178">&lt;</span>&nbsp;<span class="ident" id="1537180">maxTinySize</span>&nbsp;<span class="op" id="1537192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537197">//&nbsp;Tiny&nbsp;allocator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537219">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537225">//&nbsp;Tiny&nbsp;allocator&nbsp;combines&nbsp;several&nbsp;tiny&nbsp;allocation&nbsp;requests</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537288">//&nbsp;into&nbsp;a&nbsp;single&nbsp;memory&nbsp;block.&nbsp;The&nbsp;resulting&nbsp;memory&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537349">//&nbsp;is&nbsp;freed&nbsp;when&nbsp;all&nbsp;subobjects&nbsp;are&nbsp;unreachable.&nbsp;The&nbsp;subobjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537416">//&nbsp;must&nbsp;be&nbsp;FlagNoScan&nbsp;(don&#39;t&nbsp;have&nbsp;pointers),&nbsp;this&nbsp;ensures&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537482">//&nbsp;the&nbsp;amount&nbsp;of&nbsp;potentially&nbsp;wasted&nbsp;memory&nbsp;is&nbsp;bounded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537540">//</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537546">//&nbsp;Size&nbsp;of&nbsp;the&nbsp;memory&nbsp;block&nbsp;used&nbsp;for&nbsp;combining&nbsp;(maxTinySize)&nbsp;is&nbsp;tunable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537622">//&nbsp;Current&nbsp;setting&nbsp;is&nbsp;16&nbsp;bytes,&nbsp;which&nbsp;relates&nbsp;to&nbsp;2x&nbsp;worst&nbsp;case&nbsp;memory</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537695">//&nbsp;wastage&nbsp;(when&nbsp;all&nbsp;but&nbsp;one&nbsp;subobjects&nbsp;are&nbsp;unreachable).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537756">//&nbsp;8&nbsp;bytes&nbsp;would&nbsp;result&nbsp;in&nbsp;no&nbsp;wastage&nbsp;at&nbsp;all,&nbsp;but&nbsp;provides&nbsp;less</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537823">//&nbsp;opportunities&nbsp;for&nbsp;combining.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537858">//&nbsp;32&nbsp;bytes&nbsp;provides&nbsp;more&nbsp;opportunities&nbsp;for&nbsp;combining,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537916">//&nbsp;but&nbsp;can&nbsp;lead&nbsp;to&nbsp;4x&nbsp;worst&nbsp;case&nbsp;wastage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1537961">//&nbsp;The&nbsp;best&nbsp;case&nbsp;winning&nbsp;is&nbsp;8x&nbsp;regardless&nbsp;of&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538021">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538027">//&nbsp;Objects&nbsp;obtained&nbsp;from&nbsp;tiny&nbsp;allocator&nbsp;must&nbsp;not&nbsp;be&nbsp;freed&nbsp;explicitly.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538100">//&nbsp;So&nbsp;when&nbsp;an&nbsp;object&nbsp;will&nbsp;be&nbsp;freed&nbsp;explicitly,&nbsp;we&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538165">//&nbsp;its&nbsp;size&nbsp;&gt;=&nbsp;maxTinySize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538196">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538202">//&nbsp;SetFinalizer&nbsp;has&nbsp;a&nbsp;special&nbsp;case&nbsp;for&nbsp;objects&nbsp;potentially&nbsp;coming</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538271">//&nbsp;from&nbsp;tiny&nbsp;allocator,&nbsp;it&nbsp;such&nbsp;case&nbsp;it&nbsp;allows&nbsp;to&nbsp;set&nbsp;finalizers</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538339">//&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte&nbsp;of&nbsp;a&nbsp;memory&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538382">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538388">//&nbsp;The&nbsp;main&nbsp;targets&nbsp;of&nbsp;tiny&nbsp;allocator&nbsp;are&nbsp;small&nbsp;strings&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538451">//&nbsp;standalone&nbsp;escaping&nbsp;variables.&nbsp;On&nbsp;a&nbsp;json&nbsp;benchmark</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538508">//&nbsp;the&nbsp;allocator&nbsp;reduces&nbsp;number&nbsp;of&nbsp;allocations&nbsp;by&nbsp;~12%&nbsp;and</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538570">//&nbsp;reduces&nbsp;heap&nbsp;size&nbsp;by&nbsp;~20%.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538603">tinysize</span>&nbsp;<span class="op" id="1538612">:=</span>&nbsp;<span class="builtintype" id="1538615">uintptr</span><span class="op" id="1538622">(</span><span class="ident" id="1538623">c</span><span class="op" id="1538624">.</span><span class="ident" id="1538625">tinysize</span><span class="op" id="1538633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1538638">if</span>&nbsp;<span class="ident" id="1538641">size</span>&nbsp;<span class="op" id="1538646">&lt;=</span>&nbsp;<span class="ident" id="1538649">tinysize</span>&nbsp;<span class="op" id="1538658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538664">tiny</span>&nbsp;<span class="op" id="1538669">:=</span>&nbsp;<span class="ident" id="1538672">unsafe</span><span class="op" id="1538678">.</span><span class="ident" id="1538679">Pointer</span><span class="op" id="1538686">(</span><span class="ident" id="1538687">c</span><span class="op" id="1538688">.</span><span class="ident" id="1538689">tiny</span><span class="op" id="1538693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1538699">//&nbsp;Align&nbsp;tiny&nbsp;pointer&nbsp;for&nbsp;required&nbsp;(conservative)&nbsp;alignment.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1538764">if</span>&nbsp;<span class="ident" id="1538767">size</span><span class="op" id="1538771">&amp;</span><span class="num" id="1538772">7</span>&nbsp;<span class="op" id="1538774">==</span>&nbsp;<span class="num" id="1538777">0</span>&nbsp;<span class="op" id="1538779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538786">tiny</span>&nbsp;<span class="op" id="1538791">=</span>&nbsp;<span class="ident" id="1538793">roundup</span><span class="op" id="1538800">(</span><span class="ident" id="1538801">tiny</span><span class="op" id="1538805">,</span>&nbsp;<span class="num" id="1538807">8</span><span class="op" id="1538808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1538814">}</span>&nbsp;<span class="keyword" id="1538816">else</span>&nbsp;<span class="keyword" id="1538821">if</span>&nbsp;<span class="ident" id="1538824">size</span><span class="op" id="1538828">&amp;</span><span class="num" id="1538829">3</span>&nbsp;<span class="op" id="1538831">==</span>&nbsp;<span class="num" id="1538834">0</span>&nbsp;<span class="op" id="1538836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538843">tiny</span>&nbsp;<span class="op" id="1538848">=</span>&nbsp;<span class="ident" id="1538850">roundup</span><span class="op" id="1538857">(</span><span class="ident" id="1538858">tiny</span><span class="op" id="1538862">,</span>&nbsp;<span class="num" id="1538864">4</span><span class="op" id="1538865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1538871">}</span>&nbsp;<span class="keyword" id="1538873">else</span>&nbsp;<span class="keyword" id="1538878">if</span>&nbsp;<span class="ident" id="1538881">size</span><span class="op" id="1538885">&amp;</span><span class="num" id="1538886">1</span>&nbsp;<span class="op" id="1538888">==</span>&nbsp;<span class="num" id="1538891">0</span>&nbsp;<span class="op" id="1538893">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538900">tiny</span>&nbsp;<span class="op" id="1538905">=</span>&nbsp;<span class="ident" id="1538907">roundup</span><span class="op" id="1538914">(</span><span class="ident" id="1538915">tiny</span><span class="op" id="1538919">,</span>&nbsp;<span class="num" id="1538921">2</span><span class="op" id="1538922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1538928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1538934">size1</span>&nbsp;<span class="op" id="1538940">:=</span>&nbsp;<span class="ident" id="1538943">size</span>&nbsp;<span class="op" id="1538948">+</span>&nbsp;<span class="op" id="1538950">(</span><span class="builtintype" id="1538951">uintptr</span><span class="op" id="1538958">(</span><span class="ident" id="1538959">tiny</span><span class="op" id="1538963">)</span>&nbsp;<span class="op" id="1538965">-</span>&nbsp;<span class="builtintype" id="1538967">uintptr</span><span class="op" id="1538974">(</span><span class="ident" id="1538975">unsafe</span><span class="op" id="1538981">.</span><span class="ident" id="1538982">Pointer</span><span class="op" id="1538989">(</span><span class="ident" id="1538990">c</span><span class="op" id="1538991">.</span><span class="ident" id="1538992">tiny</span><span class="op" id="1538996">)</span><span class="op" id="1538997">)</span><span class="op" id="1538998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539004">if</span>&nbsp;<span class="ident" id="1539007">size1</span>&nbsp;<span class="op" id="1539013">&lt;=</span>&nbsp;<span class="ident" id="1539016">tinysize</span>&nbsp;<span class="op" id="1539025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1539032">//&nbsp;The&nbsp;object&nbsp;fits&nbsp;into&nbsp;existing&nbsp;tiny&nbsp;block.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539082">x</span>&nbsp;<span class="op" id="1539084">=</span>&nbsp;<span class="ident" id="1539086">tiny</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539096">c</span><span class="op" id="1539097">.</span><span class="ident" id="1539098">tiny</span>&nbsp;<span class="op" id="1539103">=</span>&nbsp;<span class="op" id="1539105">(</span><span class="op" id="1539106">*</span><span class="builtintype" id="1539107">byte</span><span class="op" id="1539111">)</span><span class="op" id="1539112">(</span><span class="ident" id="1539113">add</span><span class="op" id="1539116">(</span><span class="ident" id="1539117">x</span><span class="op" id="1539118">,</span>&nbsp;<span class="ident" id="1539120">size</span><span class="op" id="1539124">)</span><span class="op" id="1539125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539132">c</span><span class="op" id="1539133">.</span><span class="ident" id="1539134">tinysize</span>&nbsp;<span class="op" id="1539143">-=</span>&nbsp;<span class="builtintype" id="1539146">uintptr</span><span class="op" id="1539153">(</span><span class="ident" id="1539154">size1</span><span class="op" id="1539159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539166">c</span><span class="op" id="1539167">.</span><span class="ident" id="1539168">local_tinyallocs</span><span class="op" id="1539184">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539192">if</span>&nbsp;<span class="ident" id="1539195">debugMalloc</span>&nbsp;<span class="op" id="1539207">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539215">mp</span>&nbsp;<span class="op" id="1539218">:=</span>&nbsp;<span class="ident" id="1539221">acquirem</span><span class="op" id="1539229">(</span><span class="op" id="1539230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539238">if</span>&nbsp;<span class="ident" id="1539241">mp</span><span class="op" id="1539243">.</span><span class="ident" id="1539244">mallocing</span>&nbsp;<span class="op" id="1539254">==</span>&nbsp;<span class="num" id="1539257">0</span>&nbsp;<span class="op" id="1539259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539268">gothrow</span><span class="op" id="1539275">(</span><span class="string" id="1539276">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1539288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539304">mp</span><span class="op" id="1539306">.</span><span class="ident" id="1539307">mallocing</span>&nbsp;<span class="op" id="1539317">=</span>&nbsp;<span class="num" id="1539319">0</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539327">if</span>&nbsp;<span class="ident" id="1539330">mp</span><span class="op" id="1539332">.</span><span class="ident" id="1539333">curg</span>&nbsp;<span class="op" id="1539338">!=</span>&nbsp;<span class="ident" id="1539341">nil</span>&nbsp;<span class="op" id="1539345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539354">mp</span><span class="op" id="1539356">.</span><span class="ident" id="1539357">curg</span><span class="op" id="1539361">.</span><span class="ident" id="1539362">stackguard0</span>&nbsp;<span class="op" id="1539374">=</span>&nbsp;<span class="ident" id="1539376">mp</span><span class="op" id="1539378">.</span><span class="ident" id="1539379">curg</span><span class="op" id="1539383">.</span><span class="ident" id="1539384">stack</span><span class="op" id="1539389">.</span><span class="ident" id="1539390">lo</span>&nbsp;<span class="op" id="1539393">+</span>&nbsp;<span class="ident" id="1539395">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1539421">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1539478">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539534">releasem</span><span class="op" id="1539542">(</span><span class="ident" id="1539543">mp</span><span class="op" id="1539545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539553">releasem</span><span class="op" id="1539561">(</span><span class="ident" id="1539562">mp</span><span class="op" id="1539564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539578">return</span>&nbsp;<span class="ident" id="1539585">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539591">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1539601">//&nbsp;Allocate&nbsp;a&nbsp;new&nbsp;maxTinySize&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539641">s</span>&nbsp;<span class="op" id="1539643">=</span>&nbsp;<span class="ident" id="1539645">c</span><span class="op" id="1539646">.</span><span class="ident" id="1539647">alloc</span><span class="op" id="1539652">[</span><span class="ident" id="1539653">tinySizeClass</span><span class="op" id="1539666">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539671">v</span>&nbsp;<span class="op" id="1539673">:=</span>&nbsp;<span class="ident" id="1539676">s</span><span class="op" id="1539677">.</span><span class="ident" id="1539678">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1539690">if</span>&nbsp;<span class="ident" id="1539693">v</span>&nbsp;<span class="op" id="1539695">==</span>&nbsp;<span class="ident" id="1539698">nil</span>&nbsp;<span class="op" id="1539702">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539708">mp</span>&nbsp;<span class="op" id="1539711">:=</span>&nbsp;<span class="ident" id="1539714">acquirem</span><span class="op" id="1539722">(</span><span class="op" id="1539723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539729">mp</span><span class="op" id="1539731">.</span><span class="ident" id="1539732">scalararg</span><span class="op" id="1539741">[</span><span class="num" id="1539742">0</span><span class="op" id="1539743">]</span>&nbsp;<span class="op" id="1539745">=</span>&nbsp;<span class="ident" id="1539747">tinySizeClass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539765">onM</span><span class="op" id="1539768">(</span><span class="ident" id="1539769">mcacheRefill_m</span><span class="op" id="1539783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539789">releasem</span><span class="op" id="1539797">(</span><span class="ident" id="1539798">mp</span><span class="op" id="1539800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539806">s</span>&nbsp;<span class="op" id="1539808">=</span>&nbsp;<span class="ident" id="1539810">c</span><span class="op" id="1539811">.</span><span class="ident" id="1539812">alloc</span><span class="op" id="1539817">[</span><span class="ident" id="1539818">tinySizeClass</span><span class="op" id="1539831">]</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539837">v</span>&nbsp;<span class="op" id="1539839">=</span>&nbsp;<span class="ident" id="1539841">s</span><span class="op" id="1539842">.</span><span class="ident" id="1539843">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539860">s</span><span class="op" id="1539861">.</span><span class="ident" id="1539862">freelist</span>&nbsp;<span class="op" id="1539871">=</span>&nbsp;<span class="ident" id="1539873">v</span><span class="op" id="1539874">.</span><span class="ident" id="1539875">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539883">s</span><span class="op" id="1539884">.</span><span class="ident" id="1539885">ref</span><span class="op" id="1539888">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1539894">//TODO:&nbsp;prefetch&nbsp;v.next</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1539921">x</span>&nbsp;<span class="op" id="1539923">=</span>&nbsp;<span class="ident" id="1539925">unsafe</span><span class="op" id="1539931">.</span><span class="ident" id="1539932">Pointer</span><span class="op" id="1539939">(</span><span class="ident" id="1539940">v</span><span class="op" id="1539941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539946">(</span><span class="op" id="1539947">*</span><span class="op" id="1539948">[</span><span class="num" id="1539949">2</span><span class="op" id="1539950">]</span><span class="ident" id="1539951">uint64</span><span class="op" id="1539957">)</span><span class="op" id="1539958">(</span><span class="ident" id="1539959">x</span><span class="op" id="1539960">)</span><span class="op" id="1539961">[</span><span class="num" id="1539962">0</span><span class="op" id="1539963">]</span>&nbsp;<span class="op" id="1539965">=</span>&nbsp;<span class="num" id="1539967">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1539972">(</span><span class="op" id="1539973">*</span><span class="op" id="1539974">[</span><span class="num" id="1539975">2</span><span class="op" id="1539976">]</span><span class="ident" id="1539977">uint64</span><span class="op" id="1539983">)</span><span class="op" id="1539984">(</span><span class="ident" id="1539985">x</span><span class="op" id="1539986">)</span><span class="op" id="1539987">[</span><span class="num" id="1539988">1</span><span class="op" id="1539989">]</span>&nbsp;<span class="op" id="1539991">=</span>&nbsp;<span class="num" id="1539993">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1539998">//&nbsp;See&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;replace&nbsp;the&nbsp;existing&nbsp;tiny&nbsp;block&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1540071">//&nbsp;based&nbsp;on&nbsp;amount&nbsp;of&nbsp;remaining&nbsp;free&nbsp;space.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1540118">if</span>&nbsp;<span class="ident" id="1540121">maxTinySize</span><span class="op" id="1540132">-</span><span class="ident" id="1540133">size</span>&nbsp;<span class="op" id="1540138">&gt;</span>&nbsp;<span class="ident" id="1540140">tinysize</span>&nbsp;<span class="op" id="1540149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540155">c</span><span class="op" id="1540156">.</span><span class="ident" id="1540157">tiny</span>&nbsp;<span class="op" id="1540162">=</span>&nbsp;<span class="op" id="1540164">(</span><span class="op" id="1540165">*</span><span class="builtintype" id="1540166">byte</span><span class="op" id="1540170">)</span><span class="op" id="1540171">(</span><span class="ident" id="1540172">add</span><span class="op" id="1540175">(</span><span class="ident" id="1540176">x</span><span class="op" id="1540177">,</span>&nbsp;<span class="ident" id="1540179">size</span><span class="op" id="1540183">)</span><span class="op" id="1540184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540190">c</span><span class="op" id="1540191">.</span><span class="ident" id="1540192">tinysize</span>&nbsp;<span class="op" id="1540201">=</span>&nbsp;<span class="builtintype" id="1540203">uintptr</span><span class="op" id="1540210">(</span><span class="ident" id="1540211">maxTinySize</span>&nbsp;<span class="op" id="1540223">-</span>&nbsp;<span class="ident" id="1540225">size</span><span class="op" id="1540229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540239">size</span>&nbsp;<span class="op" id="1540244">=</span>&nbsp;<span class="ident" id="1540246">maxTinySize</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540260">}</span>&nbsp;<span class="keyword" id="1540262">else</span>&nbsp;<span class="op" id="1540267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1540272">var</span>&nbsp;<span class="ident" id="1540276">sizeclass</span>&nbsp;<span class="builtintype" id="1540286">int8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1540294">if</span>&nbsp;<span class="ident" id="1540297">size</span>&nbsp;<span class="op" id="1540302">&lt;=</span>&nbsp;<span class="num" id="1540305">1024</span><span class="op" id="1540309">-</span><span class="num" id="1540310">8</span>&nbsp;<span class="op" id="1540312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540318">sizeclass</span>&nbsp;<span class="op" id="1540328">=</span>&nbsp;<span class="ident" id="1540330">size_to_class8</span><span class="op" id="1540344">[</span><span class="op" id="1540345">(</span><span class="ident" id="1540346">size</span><span class="op" id="1540350">+</span><span class="num" id="1540351">7</span><span class="op" id="1540352">)</span><span class="op" id="1540353">&gt;&gt;</span><span class="num" id="1540355">3</span><span class="op" id="1540356">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540361">}</span>&nbsp;<span class="keyword" id="1540363">else</span>&nbsp;<span class="op" id="1540368">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540374">sizeclass</span>&nbsp;<span class="op" id="1540384">=</span>&nbsp;<span class="ident" id="1540386">size_to_class128</span><span class="op" id="1540402">[</span><span class="op" id="1540403">(</span><span class="ident" id="1540404">size</span><span class="op" id="1540408">-</span><span class="num" id="1540409">1024</span><span class="op" id="1540413">+</span><span class="num" id="1540414">127</span><span class="op" id="1540417">)</span><span class="op" id="1540418">&gt;&gt;</span><span class="num" id="1540420">7</span><span class="op" id="1540421">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540431">size</span>&nbsp;<span class="op" id="1540436">=</span>&nbsp;<span class="builtintype" id="1540438">uintptr</span><span class="op" id="1540445">(</span><span class="ident" id="1540446">class_to_size</span><span class="op" id="1540459">[</span><span class="ident" id="1540460">sizeclass</span><span class="op" id="1540469">]</span><span class="op" id="1540470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540475">s</span>&nbsp;<span class="op" id="1540477">=</span>&nbsp;<span class="ident" id="1540479">c</span><span class="op" id="1540480">.</span><span class="ident" id="1540481">alloc</span><span class="op" id="1540486">[</span><span class="ident" id="1540487">sizeclass</span><span class="op" id="1540496">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540501">v</span>&nbsp;<span class="op" id="1540503">:=</span>&nbsp;<span class="ident" id="1540506">s</span><span class="op" id="1540507">.</span><span class="ident" id="1540508">freelist</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1540520">if</span>&nbsp;<span class="ident" id="1540523">v</span>&nbsp;<span class="op" id="1540525">==</span>&nbsp;<span class="ident" id="1540528">nil</span>&nbsp;<span class="op" id="1540532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540538">mp</span>&nbsp;<span class="op" id="1540541">:=</span>&nbsp;<span class="ident" id="1540544">acquirem</span><span class="op" id="1540552">(</span><span class="op" id="1540553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540559">mp</span><span class="op" id="1540561">.</span><span class="ident" id="1540562">scalararg</span><span class="op" id="1540571">[</span><span class="num" id="1540572">0</span><span class="op" id="1540573">]</span>&nbsp;<span class="op" id="1540575">=</span>&nbsp;<span class="builtintype" id="1540577">uintptr</span><span class="op" id="1540584">(</span><span class="ident" id="1540585">sizeclass</span><span class="op" id="1540594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540600">onM</span><span class="op" id="1540603">(</span><span class="ident" id="1540604">mcacheRefill_m</span><span class="op" id="1540618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540624">releasem</span><span class="op" id="1540632">(</span><span class="ident" id="1540633">mp</span><span class="op" id="1540635">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540641">s</span>&nbsp;<span class="op" id="1540643">=</span>&nbsp;<span class="ident" id="1540645">c</span><span class="op" id="1540646">.</span><span class="ident" id="1540647">alloc</span><span class="op" id="1540652">[</span><span class="ident" id="1540653">sizeclass</span><span class="op" id="1540662">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540668">v</span>&nbsp;<span class="op" id="1540670">=</span>&nbsp;<span class="ident" id="1540672">s</span><span class="op" id="1540673">.</span><span class="ident" id="1540674">freelist</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540691">s</span><span class="op" id="1540692">.</span><span class="ident" id="1540693">freelist</span>&nbsp;<span class="op" id="1540702">=</span>&nbsp;<span class="ident" id="1540704">v</span><span class="op" id="1540705">.</span><span class="ident" id="1540706">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540714">s</span><span class="op" id="1540715">.</span><span class="ident" id="1540716">ref</span><span class="op" id="1540719">++</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1540725">//TODO:&nbsp;prefetch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540745">x</span>&nbsp;<span class="op" id="1540747">=</span>&nbsp;<span class="ident" id="1540749">unsafe</span><span class="op" id="1540755">.</span><span class="ident" id="1540756">Pointer</span><span class="op" id="1540763">(</span><span class="ident" id="1540764">v</span><span class="op" id="1540765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1540770">if</span>&nbsp;<span class="ident" id="1540773">flags</span><span class="op" id="1540778">&amp;</span><span class="ident" id="1540779">flagNoZero</span>&nbsp;<span class="op" id="1540790">==</span>&nbsp;<span class="num" id="1540793">0</span>&nbsp;<span class="op" id="1540795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540801">v</span><span class="op" id="1540802">.</span><span class="ident" id="1540803">next</span>&nbsp;<span class="op" id="1540808">=</span>&nbsp;<span class="ident" id="1540810">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1540818">if</span>&nbsp;<span class="ident" id="1540821">size</span>&nbsp;<span class="op" id="1540826">&gt;</span>&nbsp;<span class="num" id="1540828">2</span><span class="op" id="1540829">*</span><span class="ident" id="1540830">ptrSize</span>&nbsp;<span class="op" id="1540838">&amp;&amp;</span>&nbsp;<span class="op" id="1540841">(</span><span class="op" id="1540842">(</span><span class="op" id="1540843">*</span><span class="op" id="1540844">[</span><span class="num" id="1540845">2</span><span class="op" id="1540846">]</span><span class="builtintype" id="1540847">uintptr</span><span class="op" id="1540854">)</span><span class="op" id="1540855">(</span><span class="ident" id="1540856">x</span><span class="op" id="1540857">)</span><span class="op" id="1540858">)</span><span class="op" id="1540859">[</span><span class="num" id="1540860">1</span><span class="op" id="1540861">]</span>&nbsp;<span class="op" id="1540863">!=</span>&nbsp;<span class="num" id="1540866">0</span>&nbsp;<span class="op" id="1540868">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540875">memclr</span><span class="op" id="1540881">(</span><span class="ident" id="1540882">unsafe</span><span class="op" id="1540888">.</span><span class="ident" id="1540889">Pointer</span><span class="op" id="1540896">(</span><span class="ident" id="1540897">v</span><span class="op" id="1540898">)</span><span class="op" id="1540899">,</span>&nbsp;<span class="ident" id="1540901">size</span><span class="op" id="1540905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540924">c</span><span class="op" id="1540925">.</span><span class="ident" id="1540926">local_cachealloc</span>&nbsp;<span class="op" id="1540943">+=</span>&nbsp;<span class="ident" id="1540946">intptr</span><span class="op" id="1540952">(</span><span class="ident" id="1540953">size</span><span class="op" id="1540957">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1540960">}</span>&nbsp;<span class="keyword" id="1540962">else</span>&nbsp;<span class="op" id="1540967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540971">mp</span>&nbsp;<span class="op" id="1540974">:=</span>&nbsp;<span class="ident" id="1540977">acquirem</span><span class="op" id="1540985">(</span><span class="op" id="1540986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1540990">mp</span><span class="op" id="1540992">.</span><span class="ident" id="1540993">scalararg</span><span class="op" id="1541002">[</span><span class="num" id="1541003">0</span><span class="op" id="1541004">]</span>&nbsp;<span class="op" id="1541006">=</span>&nbsp;<span class="builtintype" id="1541008">uintptr</span><span class="op" id="1541015">(</span><span class="ident" id="1541016">size</span><span class="op" id="1541020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541024">mp</span><span class="op" id="1541026">.</span><span class="ident" id="1541027">scalararg</span><span class="op" id="1541036">[</span><span class="num" id="1541037">1</span><span class="op" id="1541038">]</span>&nbsp;<span class="op" id="1541040">=</span>&nbsp;<span class="builtintype" id="1541042">uintptr</span><span class="op" id="1541049">(</span><span class="ident" id="1541050">flags</span><span class="op" id="1541055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541059">onM</span><span class="op" id="1541062">(</span><span class="ident" id="1541063">largeAlloc_m</span><span class="op" id="1541075">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541079">s</span>&nbsp;<span class="op" id="1541081">=</span>&nbsp;<span class="op" id="1541083">(</span><span class="op" id="1541084">*</span><span class="ident" id="1541085">mspan</span><span class="op" id="1541090">)</span><span class="op" id="1541091">(</span><span class="ident" id="1541092">mp</span><span class="op" id="1541094">.</span><span class="ident" id="1541095">ptrarg</span><span class="op" id="1541101">[</span><span class="num" id="1541102">0</span><span class="op" id="1541103">]</span><span class="op" id="1541104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541108">mp</span><span class="op" id="1541110">.</span><span class="ident" id="1541111">ptrarg</span><span class="op" id="1541117">[</span><span class="num" id="1541118">0</span><span class="op" id="1541119">]</span>&nbsp;<span class="op" id="1541121">=</span>&nbsp;<span class="ident" id="1541123">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541129">releasem</span><span class="op" id="1541137">(</span><span class="ident" id="1541138">mp</span><span class="op" id="1541140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541144">x</span>&nbsp;<span class="op" id="1541146">=</span>&nbsp;<span class="ident" id="1541148">unsafe</span><span class="op" id="1541154">.</span><span class="ident" id="1541155">Pointer</span><span class="op" id="1541162">(</span><span class="builtintype" id="1541163">uintptr</span><span class="op" id="1541170">(</span><span class="ident" id="1541171">s</span><span class="op" id="1541172">.</span><span class="ident" id="1541173">start</span>&nbsp;<span class="op" id="1541179">&lt;&lt;</span>&nbsp;<span class="ident" id="1541182">pageShift</span><span class="op" id="1541191">)</span><span class="op" id="1541192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541196">size</span>&nbsp;<span class="op" id="1541201">=</span>&nbsp;<span class="builtintype" id="1541203">uintptr</span><span class="op" id="1541210">(</span><span class="ident" id="1541211">s</span><span class="op" id="1541212">.</span><span class="ident" id="1541213">elemsize</span><span class="op" id="1541221">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1541224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1541228">if</span>&nbsp;<span class="ident" id="1541231">flags</span><span class="op" id="1541236">&amp;</span><span class="ident" id="1541237">flagNoScan</span>&nbsp;<span class="op" id="1541248">!=</span>&nbsp;<span class="num" id="1541251">0</span>&nbsp;<span class="op" id="1541253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541257">//&nbsp;All&nbsp;objects&nbsp;are&nbsp;pre-marked&nbsp;as&nbsp;noscan.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1541300">goto</span>&nbsp;<span class="ident" id="1541305">marked</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1541313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541317">//&nbsp;If&nbsp;allocating&nbsp;a&nbsp;defer+arg&nbsp;block,&nbsp;now&nbsp;that&nbsp;we&#39;ve&nbsp;picked&nbsp;a&nbsp;malloc&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541390">//&nbsp;large&nbsp;enough&nbsp;to&nbsp;hold&nbsp;everything,&nbsp;cut&nbsp;the&nbsp;&#34;asked&nbsp;for&#34;&nbsp;size&nbsp;down&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541460">//&nbsp;just&nbsp;the&nbsp;defer&nbsp;header,&nbsp;so&nbsp;that&nbsp;the&nbsp;GC&nbsp;bitmap&nbsp;will&nbsp;record&nbsp;the&nbsp;arg&nbsp;block</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541535">//&nbsp;as&nbsp;containing&nbsp;nothing&nbsp;at&nbsp;all&nbsp;(as&nbsp;if&nbsp;it&nbsp;were&nbsp;unused&nbsp;space&nbsp;at&nbsp;the&nbsp;end&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541610">//&nbsp;a&nbsp;malloc&nbsp;block&nbsp;caused&nbsp;by&nbsp;size&nbsp;rounding).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541655">//&nbsp;The&nbsp;defer&nbsp;arg&nbsp;areas&nbsp;are&nbsp;scanned&nbsp;as&nbsp;part&nbsp;of&nbsp;scanstack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1541713">if</span>&nbsp;<span class="ident" id="1541716">typ</span>&nbsp;<span class="op" id="1541720">==</span>&nbsp;<span class="ident" id="1541723">deferType</span>&nbsp;<span class="op" id="1541733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541737">size0</span>&nbsp;<span class="op" id="1541743">=</span>&nbsp;<span class="ident" id="1541745">unsafe</span><span class="op" id="1541751">.</span><span class="ident" id="1541752">Sizeof</span><span class="op" id="1541758">(</span><span class="ident" id="1541759">_defer</span><span class="op" id="1541765">{</span><span class="op" id="1541766">}</span><span class="op" id="1541767">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1541770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541774">//&nbsp;From&nbsp;here&nbsp;till&nbsp;marked&nbsp;label&nbsp;marking&nbsp;the&nbsp;object&nbsp;as&nbsp;allocated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1541838">//&nbsp;and&nbsp;storing&nbsp;type&nbsp;info&nbsp;in&nbsp;the&nbsp;GC&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1541882">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541886">arena_start</span>&nbsp;<span class="op" id="1541898">:=</span>&nbsp;<span class="builtintype" id="1541901">uintptr</span><span class="op" id="1541908">(</span><span class="ident" id="1541909">unsafe</span><span class="op" id="1541915">.</span><span class="ident" id="1541916">Pointer</span><span class="op" id="1541923">(</span><span class="ident" id="1541924">mheap_</span><span class="op" id="1541930">.</span><span class="ident" id="1541931">arena_start</span><span class="op" id="1541942">)</span><span class="op" id="1541943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541947">off</span>&nbsp;<span class="op" id="1541951">:=</span>&nbsp;<span class="op" id="1541954">(</span><span class="builtintype" id="1541955">uintptr</span><span class="op" id="1541962">(</span><span class="ident" id="1541963">x</span><span class="op" id="1541964">)</span>&nbsp;<span class="op" id="1541966">-</span>&nbsp;<span class="ident" id="1541968">arena_start</span><span class="op" id="1541979">)</span>&nbsp;<span class="op" id="1541981">/</span>&nbsp;<span class="ident" id="1541983">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1541993">xbits</span>&nbsp;<span class="op" id="1541999">:=</span>&nbsp;<span class="op" id="1542002">(</span><span class="op" id="1542003">*</span><span class="builtintype" id="1542004">uint8</span><span class="op" id="1542009">)</span><span class="op" id="1542010">(</span><span class="ident" id="1542011">unsafe</span><span class="op" id="1542017">.</span><span class="ident" id="1542018">Pointer</span><span class="op" id="1542025">(</span><span class="ident" id="1542026">arena_start</span>&nbsp;<span class="op" id="1542038">-</span>&nbsp;<span class="ident" id="1542040">off</span><span class="op" id="1542043">/</span><span class="ident" id="1542044">wordsPerBitmapByte</span>&nbsp;<span class="op" id="1542063">-</span>&nbsp;<span class="num" id="1542065">1</span><span class="op" id="1542066">)</span><span class="op" id="1542067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1542071">shift</span>&nbsp;<span class="op" id="1542077">:=</span>&nbsp;<span class="op" id="1542080">(</span><span class="ident" id="1542081">off</span>&nbsp;<span class="op" id="1542085">%</span>&nbsp;<span class="ident" id="1542087">wordsPerBitmapByte</span><span class="op" id="1542105">)</span>&nbsp;<span class="op" id="1542107">*</span>&nbsp;<span class="ident" id="1542109">gcBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542118">if</span>&nbsp;<span class="ident" id="1542121">debugMalloc</span>&nbsp;<span class="op" id="1542133">&amp;&amp;</span>&nbsp;<span class="op" id="1542136">(</span><span class="op" id="1542137">(</span><span class="op" id="1542138">*</span><span class="ident" id="1542139">xbits</span><span class="op" id="1542144">&gt;&gt;</span><span class="ident" id="1542146">shift</span><span class="op" id="1542151">)</span><span class="op" id="1542152">&amp;</span><span class="op" id="1542153">(</span><span class="ident" id="1542154">bitMask</span><span class="op" id="1542161">|</span><span class="ident" id="1542162">bitPtrMask</span><span class="op" id="1542172">)</span><span class="op" id="1542173">)</span>&nbsp;<span class="op" id="1542175">!=</span>&nbsp;<span class="ident" id="1542178">bitBoundary</span>&nbsp;<span class="op" id="1542190">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1542195">println</span><span class="op" id="1542202">(</span><span class="string" id="1542203">&#34;runtime:&nbsp;bits&nbsp;=&#34;</span><span class="op" id="1542220">,</span>&nbsp;<span class="op" id="1542222">(</span><span class="op" id="1542223">*</span><span class="ident" id="1542224">xbits</span><span class="op" id="1542229">&gt;&gt;</span><span class="ident" id="1542231">shift</span><span class="op" id="1542236">)</span><span class="op" id="1542237">&amp;</span><span class="op" id="1542238">(</span><span class="ident" id="1542239">bitMask</span><span class="op" id="1542246">|</span><span class="ident" id="1542247">bitPtrMask</span><span class="op" id="1542257">)</span><span class="op" id="1542258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1542263">gothrow</span><span class="op" id="1542270">(</span><span class="string" id="1542271">&#34;bad&nbsp;bits&nbsp;in&nbsp;markallocated&#34;</span><span class="op" id="1542298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1542302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542307">var</span>&nbsp;<span class="ident" id="1542311">ti</span><span class="op" id="1542313">,</span>&nbsp;<span class="ident" id="1542315">te</span>&nbsp;<span class="builtintype" id="1542318">uintptr</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542328">var</span>&nbsp;<span class="ident" id="1542332">ptrmask</span>&nbsp;<span class="op" id="1542340">*</span><span class="builtintype" id="1542341">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542349">if</span>&nbsp;<span class="ident" id="1542352">size</span>&nbsp;<span class="op" id="1542357">==</span>&nbsp;<span class="ident" id="1542360">ptrSize</span>&nbsp;<span class="op" id="1542368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1542373">//&nbsp;It&#39;s&nbsp;one&nbsp;word&nbsp;and&nbsp;it&nbsp;has&nbsp;pointers,&nbsp;it&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1542436">*</span><span class="ident" id="1542437">xbits</span>&nbsp;<span class="op" id="1542443">|=</span>&nbsp;<span class="op" id="1542446">(</span><span class="ident" id="1542447">bitsPointer</span>&nbsp;<span class="op" id="1542459">&lt;&lt;</span>&nbsp;<span class="num" id="1542462">2</span><span class="op" id="1542463">)</span>&nbsp;<span class="op" id="1542465">&lt;&lt;</span>&nbsp;<span class="ident" id="1542468">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542477">goto</span>&nbsp;<span class="ident" id="1542482">marked</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1542491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542495">if</span>&nbsp;<span class="ident" id="1542498">typ</span><span class="op" id="1542501">.</span><span class="ident" id="1542502">kind</span><span class="op" id="1542506">&amp;</span><span class="ident" id="1542507">kindGCProg</span>&nbsp;<span class="op" id="1542518">!=</span>&nbsp;<span class="num" id="1542521">0</span>&nbsp;<span class="op" id="1542523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1542528">nptr</span>&nbsp;<span class="op" id="1542533">:=</span>&nbsp;<span class="op" id="1542536">(</span><span class="builtintype" id="1542537">uintptr</span><span class="op" id="1542544">(</span><span class="ident" id="1542545">typ</span><span class="op" id="1542548">.</span><span class="ident" id="1542549">size</span><span class="op" id="1542553">)</span>&nbsp;<span class="op" id="1542555">+</span>&nbsp;<span class="ident" id="1542557">ptrSize</span>&nbsp;<span class="op" id="1542565">-</span>&nbsp;<span class="num" id="1542567">1</span><span class="op" id="1542568">)</span>&nbsp;<span class="op" id="1542570">/</span>&nbsp;<span class="ident" id="1542572">ptrSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1542583">masksize</span>&nbsp;<span class="op" id="1542592">:=</span>&nbsp;<span class="ident" id="1542595">nptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542603">if</span>&nbsp;<span class="ident" id="1542606">masksize</span><span class="op" id="1542614">%</span><span class="num" id="1542615">2</span>&nbsp;<span class="op" id="1542617">!=</span>&nbsp;<span class="num" id="1542620">0</span>&nbsp;<span class="op" id="1542622">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1542628">masksize</span>&nbsp;<span class="op" id="1542637">*=</span>&nbsp;<span class="num" id="1542640">2</span>&nbsp;<span class="comment" id="1542642">//&nbsp;repeated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1542657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1542662">masksize</span>&nbsp;<span class="op" id="1542671">=</span>&nbsp;<span class="ident" id="1542673">masksize</span>&nbsp;<span class="op" id="1542682">*</span>&nbsp;<span class="ident" id="1542684">pointersPerByte</span>&nbsp;<span class="op" id="1542700">/</span>&nbsp;<span class="num" id="1542702">8</span>&nbsp;<span class="comment" id="1542704">//&nbsp;4&nbsp;bits&nbsp;per&nbsp;word</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1542726">masksize</span><span class="op" id="1542734">++</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1542768">//&nbsp;unroll&nbsp;flag&nbsp;in&nbsp;the&nbsp;beginning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1542803">if</span>&nbsp;<span class="ident" id="1542806">masksize</span>&nbsp;<span class="op" id="1542815">&gt;</span>&nbsp;<span class="ident" id="1542817">maxGCMask</span>&nbsp;<span class="op" id="1542827">&amp;&amp;</span>&nbsp;<span class="ident" id="1542830">typ</span><span class="op" id="1542833">.</span><span class="ident" id="1542834">gc</span><span class="op" id="1542836">[</span><span class="num" id="1542837">1</span><span class="op" id="1542838">]</span>&nbsp;<span class="op" id="1542840">!=</span>&nbsp;<span class="num" id="1542843">0</span>&nbsp;<span class="op" id="1542845">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1542851">//&nbsp;If&nbsp;the&nbsp;mask&nbsp;is&nbsp;too&nbsp;large,&nbsp;unroll&nbsp;the&nbsp;program&nbsp;directly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1542912">//&nbsp;into&nbsp;the&nbsp;GC&nbsp;bitmap.&nbsp;It&#39;s&nbsp;7&nbsp;times&nbsp;slower&nbsp;than&nbsp;copying</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1542972">//&nbsp;from&nbsp;the&nbsp;pre-unrolled&nbsp;mask,&nbsp;but&nbsp;saves&nbsp;1/16&nbsp;of&nbsp;type&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1543035">//&nbsp;memory&nbsp;for&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543063">mp</span>&nbsp;<span class="op" id="1543066">:=</span>&nbsp;<span class="ident" id="1543069">acquirem</span><span class="op" id="1543077">(</span><span class="op" id="1543078">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543084">mp</span><span class="op" id="1543086">.</span><span class="ident" id="1543087">ptrarg</span><span class="op" id="1543093">[</span><span class="num" id="1543094">0</span><span class="op" id="1543095">]</span>&nbsp;<span class="op" id="1543097">=</span>&nbsp;<span class="ident" id="1543099">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543105">mp</span><span class="op" id="1543107">.</span><span class="ident" id="1543108">ptrarg</span><span class="op" id="1543114">[</span><span class="num" id="1543115">1</span><span class="op" id="1543116">]</span>&nbsp;<span class="op" id="1543118">=</span>&nbsp;<span class="ident" id="1543120">unsafe</span><span class="op" id="1543126">.</span><span class="ident" id="1543127">Pointer</span><span class="op" id="1543134">(</span><span class="ident" id="1543135">typ</span><span class="op" id="1543138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543144">mp</span><span class="op" id="1543146">.</span><span class="ident" id="1543147">scalararg</span><span class="op" id="1543156">[</span><span class="num" id="1543157">0</span><span class="op" id="1543158">]</span>&nbsp;<span class="op" id="1543160">=</span>&nbsp;<span class="builtintype" id="1543162">uintptr</span><span class="op" id="1543169">(</span><span class="ident" id="1543170">size</span><span class="op" id="1543174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543180">mp</span><span class="op" id="1543182">.</span><span class="ident" id="1543183">scalararg</span><span class="op" id="1543192">[</span><span class="num" id="1543193">1</span><span class="op" id="1543194">]</span>&nbsp;<span class="op" id="1543196">=</span>&nbsp;<span class="builtintype" id="1543198">uintptr</span><span class="op" id="1543205">(</span><span class="ident" id="1543206">size0</span><span class="op" id="1543211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543217">onM</span><span class="op" id="1543220">(</span><span class="ident" id="1543221">unrollgcproginplace_m</span><span class="op" id="1543242">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543248">releasem</span><span class="op" id="1543256">(</span><span class="ident" id="1543257">mp</span><span class="op" id="1543259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543265">goto</span>&nbsp;<span class="ident" id="1543270">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543285">ptrmask</span>&nbsp;<span class="op" id="1543293">=</span>&nbsp;<span class="op" id="1543295">(</span><span class="op" id="1543296">*</span><span class="builtintype" id="1543297">uint8</span><span class="op" id="1543302">)</span><span class="op" id="1543303">(</span><span class="ident" id="1543304">unsafe</span><span class="op" id="1543310">.</span><span class="ident" id="1543311">Pointer</span><span class="op" id="1543318">(</span><span class="builtintype" id="1543319">uintptr</span><span class="op" id="1543326">(</span><span class="ident" id="1543327">typ</span><span class="op" id="1543330">.</span><span class="ident" id="1543331">gc</span><span class="op" id="1543333">[</span><span class="num" id="1543334">0</span><span class="op" id="1543335">]</span><span class="op" id="1543336">)</span><span class="op" id="1543337">)</span><span class="op" id="1543338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1543343">//&nbsp;Check&nbsp;whether&nbsp;the&nbsp;program&nbsp;is&nbsp;already&nbsp;unrolled.</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543396">if</span>&nbsp;<span class="builtintype" id="1543399">uintptr</span><span class="op" id="1543406">(</span><span class="ident" id="1543407">atomicloadp</span><span class="op" id="1543418">(</span><span class="ident" id="1543419">unsafe</span><span class="op" id="1543425">.</span><span class="ident" id="1543426">Pointer</span><span class="op" id="1543433">(</span><span class="ident" id="1543434">ptrmask</span><span class="op" id="1543441">)</span><span class="op" id="1543442">)</span><span class="op" id="1543443">)</span><span class="op" id="1543444">&amp;</span><span class="num" id="1543445">0xff</span>&nbsp;<span class="op" id="1543450">==</span>&nbsp;<span class="num" id="1543453">0</span>&nbsp;<span class="op" id="1543455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543461">mp</span>&nbsp;<span class="op" id="1543464">:=</span>&nbsp;<span class="ident" id="1543467">acquirem</span><span class="op" id="1543475">(</span><span class="op" id="1543476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543482">mp</span><span class="op" id="1543484">.</span><span class="ident" id="1543485">ptrarg</span><span class="op" id="1543491">[</span><span class="num" id="1543492">0</span><span class="op" id="1543493">]</span>&nbsp;<span class="op" id="1543495">=</span>&nbsp;<span class="ident" id="1543497">unsafe</span><span class="op" id="1543503">.</span><span class="ident" id="1543504">Pointer</span><span class="op" id="1543511">(</span><span class="ident" id="1543512">typ</span><span class="op" id="1543515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543521">onM</span><span class="op" id="1543524">(</span><span class="ident" id="1543525">unrollgcprog_m</span><span class="op" id="1543539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543545">releasem</span><span class="op" id="1543553">(</span><span class="ident" id="1543554">mp</span><span class="op" id="1543556">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543566">ptrmask</span>&nbsp;<span class="op" id="1543574">=</span>&nbsp;<span class="op" id="1543576">(</span><span class="op" id="1543577">*</span><span class="builtintype" id="1543578">uint8</span><span class="op" id="1543583">)</span><span class="op" id="1543584">(</span><span class="ident" id="1543585">add</span><span class="op" id="1543588">(</span><span class="ident" id="1543589">unsafe</span><span class="op" id="1543595">.</span><span class="ident" id="1543596">Pointer</span><span class="op" id="1543603">(</span><span class="ident" id="1543604">ptrmask</span><span class="op" id="1543611">)</span><span class="op" id="1543612">,</span>&nbsp;<span class="num" id="1543614">1</span><span class="op" id="1543615">)</span><span class="op" id="1543616">)</span>&nbsp;<span class="comment" id="1543618">//&nbsp;skip&nbsp;the&nbsp;unroll&nbsp;flag&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543649">}</span>&nbsp;<span class="keyword" id="1543651">else</span>&nbsp;<span class="op" id="1543656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543661">ptrmask</span>&nbsp;<span class="op" id="1543669">=</span>&nbsp;<span class="op" id="1543671">(</span><span class="op" id="1543672">*</span><span class="builtintype" id="1543673">uint8</span><span class="op" id="1543678">)</span><span class="op" id="1543679">(</span><span class="ident" id="1543680">unsafe</span><span class="op" id="1543686">.</span><span class="ident" id="1543687">Pointer</span><span class="op" id="1543694">(</span><span class="ident" id="1543695">typ</span><span class="op" id="1543698">.</span><span class="ident" id="1543699">gc</span><span class="op" id="1543701">[</span><span class="num" id="1543702">0</span><span class="op" id="1543703">]</span><span class="op" id="1543704">)</span><span class="op" id="1543705">)</span>&nbsp;<span class="comment" id="1543707">//&nbsp;pointer&nbsp;to&nbsp;unrolled&nbsp;mask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543737">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543741">if</span>&nbsp;<span class="ident" id="1543744">size</span>&nbsp;<span class="op" id="1543749">==</span>&nbsp;<span class="num" id="1543752">2</span><span class="op" id="1543753">*</span><span class="ident" id="1543754">ptrSize</span>&nbsp;<span class="op" id="1543762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543767">*</span><span class="ident" id="1543768">xbits</span>&nbsp;<span class="op" id="1543774">=</span>&nbsp;<span class="op" id="1543776">*</span><span class="ident" id="1543777">ptrmask</span>&nbsp;<span class="op" id="1543785">|</span>&nbsp;<span class="ident" id="1543787">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543802">goto</span>&nbsp;<span class="ident" id="1543807">marked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543820">te</span>&nbsp;<span class="op" id="1543823">=</span>&nbsp;<span class="builtintype" id="1543825">uintptr</span><span class="op" id="1543832">(</span><span class="ident" id="1543833">typ</span><span class="op" id="1543836">.</span><span class="ident" id="1543837">size</span><span class="op" id="1543841">)</span>&nbsp;<span class="op" id="1543843">/</span>&nbsp;<span class="ident" id="1543845">ptrSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1543855">//&nbsp;If&nbsp;the&nbsp;type&nbsp;occupies&nbsp;odd&nbsp;number&nbsp;of&nbsp;words,&nbsp;its&nbsp;mask&nbsp;is&nbsp;repeated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543924">if</span>&nbsp;<span class="ident" id="1543927">te</span><span class="op" id="1543929">%</span><span class="num" id="1543930">2</span>&nbsp;<span class="op" id="1543932">==</span>&nbsp;<span class="num" id="1543935">0</span>&nbsp;<span class="op" id="1543937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1543942">te</span>&nbsp;<span class="op" id="1543945">/=</span>&nbsp;<span class="num" id="1543948">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1543952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1543956">//&nbsp;Copy&nbsp;pointer&nbsp;bitmask&nbsp;into&nbsp;the&nbsp;bitmap.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1543999">for</span>&nbsp;<span class="ident" id="1544003">i</span>&nbsp;<span class="op" id="1544005">:=</span>&nbsp;<span class="builtintype" id="1544008">uintptr</span><span class="op" id="1544015">(</span><span class="num" id="1544016">0</span><span class="op" id="1544017">)</span><span class="op" id="1544018">;</span>&nbsp;<span class="ident" id="1544020">i</span>&nbsp;<span class="op" id="1544022">&lt;</span>&nbsp;<span class="ident" id="1544024">size0</span><span class="op" id="1544029">;</span>&nbsp;<span class="ident" id="1544031">i</span>&nbsp;<span class="op" id="1544033">+=</span>&nbsp;<span class="num" id="1544036">2</span>&nbsp;<span class="op" id="1544038">*</span>&nbsp;<span class="ident" id="1544040">ptrSize</span>&nbsp;<span class="op" id="1544048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544053">v</span>&nbsp;<span class="op" id="1544055">:=</span>&nbsp;<span class="op" id="1544058">*</span><span class="op" id="1544059">(</span><span class="op" id="1544060">*</span><span class="builtintype" id="1544061">uint8</span><span class="op" id="1544066">)</span><span class="op" id="1544067">(</span><span class="ident" id="1544068">add</span><span class="op" id="1544071">(</span><span class="ident" id="1544072">unsafe</span><span class="op" id="1544078">.</span><span class="ident" id="1544079">Pointer</span><span class="op" id="1544086">(</span><span class="ident" id="1544087">ptrmask</span><span class="op" id="1544094">)</span><span class="op" id="1544095">,</span>&nbsp;<span class="ident" id="1544097">ti</span><span class="op" id="1544099">)</span><span class="op" id="1544100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544105">ti</span><span class="op" id="1544107">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544113">if</span>&nbsp;<span class="ident" id="1544116">ti</span>&nbsp;<span class="op" id="1544119">==</span>&nbsp;<span class="ident" id="1544122">te</span>&nbsp;<span class="op" id="1544125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544131">ti</span>&nbsp;<span class="op" id="1544134">=</span>&nbsp;<span class="num" id="1544136">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544146">if</span>&nbsp;<span class="ident" id="1544149">i</span>&nbsp;<span class="op" id="1544151">==</span>&nbsp;<span class="num" id="1544154">0</span>&nbsp;<span class="op" id="1544156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544162">v</span>&nbsp;<span class="op" id="1544164">|=</span>&nbsp;<span class="ident" id="1544167">bitBoundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544187">if</span>&nbsp;<span class="ident" id="1544190">i</span><span class="op" id="1544191">+</span><span class="ident" id="1544192">ptrSize</span>&nbsp;<span class="op" id="1544200">==</span>&nbsp;<span class="ident" id="1544203">size0</span>&nbsp;<span class="op" id="1544209">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544215">v</span>&nbsp;<span class="op" id="1544217">&amp;^=</span>&nbsp;<span class="builtintype" id="1544221">uint8</span><span class="op" id="1544226">(</span><span class="ident" id="1544227">bitPtrMask</span>&nbsp;<span class="op" id="1544238">&lt;&lt;</span>&nbsp;<span class="num" id="1544241">4</span><span class="op" id="1544242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544253">*</span><span class="ident" id="1544254">xbits</span>&nbsp;<span class="op" id="1544260">=</span>&nbsp;<span class="ident" id="1544262">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544267">xbits</span>&nbsp;<span class="op" id="1544273">=</span>&nbsp;<span class="op" id="1544275">(</span><span class="op" id="1544276">*</span><span class="builtintype" id="1544277">byte</span><span class="op" id="1544281">)</span><span class="op" id="1544282">(</span><span class="ident" id="1544283">add</span><span class="op" id="1544286">(</span><span class="ident" id="1544287">unsafe</span><span class="op" id="1544293">.</span><span class="ident" id="1544294">Pointer</span><span class="op" id="1544301">(</span><span class="ident" id="1544302">xbits</span><span class="op" id="1544307">)</span><span class="op" id="1544308">,</span>&nbsp;<span class="op" id="1544310">^</span><span class="builtintype" id="1544311">uintptr</span><span class="op" id="1544318">(</span><span class="num" id="1544319">0</span><span class="op" id="1544320">)</span><span class="op" id="1544321">)</span><span class="op" id="1544322">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544330">if</span>&nbsp;<span class="ident" id="1544333">size0</span><span class="op" id="1544338">%</span><span class="op" id="1544339">(</span><span class="num" id="1544340">2</span><span class="op" id="1544341">*</span><span class="ident" id="1544342">ptrSize</span><span class="op" id="1544349">)</span>&nbsp;<span class="op" id="1544351">==</span>&nbsp;<span class="num" id="1544354">0</span>&nbsp;<span class="op" id="1544356">&amp;&amp;</span>&nbsp;<span class="ident" id="1544359">size0</span>&nbsp;<span class="op" id="1544365">&lt;</span>&nbsp;<span class="ident" id="1544367">size</span>&nbsp;<span class="op" id="1544372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1544377">//&nbsp;Mark&nbsp;the&nbsp;word&nbsp;after&nbsp;last&nbsp;object&#39;s&nbsp;word&nbsp;as&nbsp;bitsDead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544435">*</span><span class="ident" id="1544436">xbits</span>&nbsp;<span class="op" id="1544442">=</span>&nbsp;<span class="ident" id="1544444">bitsDead</span>&nbsp;<span class="op" id="1544453">&lt;&lt;</span>&nbsp;<span class="num" id="1544456">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544460">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544463">}</span><br>
<span class="lineno"></span><span class="ident" id="1544465">marked</span><span class="op" id="1544471">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544474">if</span>&nbsp;<span class="ident" id="1544477">raceenabled</span>&nbsp;<span class="op" id="1544489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544493">racemalloc</span><span class="op" id="1544503">(</span><span class="ident" id="1544504">x</span><span class="op" id="1544505">,</span>&nbsp;<span class="ident" id="1544507">size</span><span class="op" id="1544511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544514">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544518">if</span>&nbsp;<span class="ident" id="1544521">debugMalloc</span>&nbsp;<span class="op" id="1544533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544537">mp</span>&nbsp;<span class="op" id="1544540">:=</span>&nbsp;<span class="ident" id="1544543">acquirem</span><span class="op" id="1544551">(</span><span class="op" id="1544552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544556">if</span>&nbsp;<span class="ident" id="1544559">mp</span><span class="op" id="1544561">.</span><span class="ident" id="1544562">mallocing</span>&nbsp;<span class="op" id="1544572">==</span>&nbsp;<span class="num" id="1544575">0</span>&nbsp;<span class="op" id="1544577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544582">gothrow</span><span class="op" id="1544589">(</span><span class="string" id="1544590">&#34;bad&nbsp;malloc&#34;</span><span class="op" id="1544602">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544610">mp</span><span class="op" id="1544612">.</span><span class="ident" id="1544613">mallocing</span>&nbsp;<span class="op" id="1544623">=</span>&nbsp;<span class="num" id="1544625">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544629">if</span>&nbsp;<span class="ident" id="1544632">mp</span><span class="op" id="1544634">.</span><span class="ident" id="1544635">curg</span>&nbsp;<span class="op" id="1544640">!=</span>&nbsp;<span class="ident" id="1544643">nil</span>&nbsp;<span class="op" id="1544647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544652">mp</span><span class="op" id="1544654">.</span><span class="ident" id="1544655">curg</span><span class="op" id="1544659">.</span><span class="ident" id="1544660">stackguard0</span>&nbsp;<span class="op" id="1544672">=</span>&nbsp;<span class="ident" id="1544674">mp</span><span class="op" id="1544676">.</span><span class="ident" id="1544677">curg</span><span class="op" id="1544681">.</span><span class="ident" id="1544682">stack</span><span class="op" id="1544687">.</span><span class="ident" id="1544688">lo</span>&nbsp;<span class="op" id="1544691">+</span>&nbsp;<span class="ident" id="1544693">_StackGuard</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544707">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1544711">//&nbsp;Note:&nbsp;one&nbsp;releasem&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;just&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1544764">//&nbsp;The&nbsp;other&nbsp;for&nbsp;the&nbsp;acquirem&nbsp;at&nbsp;start&nbsp;of&nbsp;malloc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544816">releasem</span><span class="op" id="1544824">(</span><span class="ident" id="1544825">mp</span><span class="op" id="1544827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544831">releasem</span><span class="op" id="1544839">(</span><span class="ident" id="1544840">mp</span><span class="op" id="1544842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544845">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544849">if</span>&nbsp;<span class="ident" id="1544852">debug</span><span class="op" id="1544857">.</span><span class="ident" id="1544858">allocfreetrace</span>&nbsp;<span class="op" id="1544873">!=</span>&nbsp;<span class="num" id="1544876">0</span>&nbsp;<span class="op" id="1544878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1544882">tracealloc</span><span class="op" id="1544892">(</span><span class="ident" id="1544893">x</span><span class="op" id="1544894">,</span>&nbsp;<span class="ident" id="1544896">size</span><span class="op" id="1544900">,</span>&nbsp;<span class="ident" id="1544902">typ</span><span class="op" id="1544905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1544908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544912">if</span>&nbsp;<span class="ident" id="1544915">rate</span>&nbsp;<span class="op" id="1544920">:=</span>&nbsp;<span class="ident" id="1544923">MemProfileRate</span><span class="op" id="1544937">;</span>&nbsp;<span class="ident" id="1544939">rate</span>&nbsp;<span class="op" id="1544944">&gt;</span>&nbsp;<span class="num" id="1544946">0</span>&nbsp;<span class="op" id="1544948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1544952">if</span>&nbsp;<span class="ident" id="1544955">size</span>&nbsp;<span class="op" id="1544960">&lt;</span>&nbsp;<span class="builtintype" id="1544962">uintptr</span><span class="op" id="1544969">(</span><span class="ident" id="1544970">rate</span><span class="op" id="1544974">)</span>&nbsp;<span class="op" id="1544976">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1544979">int32</span><span class="op" id="1544984">(</span><span class="ident" id="1544985">size</span><span class="op" id="1544989">)</span>&nbsp;<span class="op" id="1544991">&lt;</span>&nbsp;<span class="ident" id="1544993">c</span><span class="op" id="1544994">.</span><span class="ident" id="1544995">next_sample</span>&nbsp;<span class="op" id="1545007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545012">c</span><span class="op" id="1545013">.</span><span class="ident" id="1545014">next_sample</span>&nbsp;<span class="op" id="1545026">-=</span>&nbsp;<span class="builtintype" id="1545029">int32</span><span class="op" id="1545034">(</span><span class="ident" id="1545035">size</span><span class="op" id="1545039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545043">}</span>&nbsp;<span class="keyword" id="1545045">else</span>&nbsp;<span class="op" id="1545050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545055">mp</span>&nbsp;<span class="op" id="1545058">:=</span>&nbsp;<span class="ident" id="1545061">acquirem</span><span class="op" id="1545069">(</span><span class="op" id="1545070">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545075">profilealloc</span><span class="op" id="1545087">(</span><span class="ident" id="1545088">mp</span><span class="op" id="1545090">,</span>&nbsp;<span class="ident" id="1545092">x</span><span class="op" id="1545093">,</span>&nbsp;<span class="ident" id="1545095">size</span><span class="op" id="1545099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545104">releasem</span><span class="op" id="1545112">(</span><span class="ident" id="1545113">mp</span><span class="op" id="1545115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545126">if</span>&nbsp;<span class="ident" id="1545129">memstats</span><span class="op" id="1545137">.</span><span class="ident" id="1545138">heap_alloc</span>&nbsp;<span class="op" id="1545149">&gt;=</span>&nbsp;<span class="ident" id="1545152">memstats</span><span class="op" id="1545160">.</span><span class="ident" id="1545161">next_gc</span>&nbsp;<span class="op" id="1545169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545173">gogc</span><span class="op" id="1545177">(</span><span class="num" id="1545178">0</span><span class="op" id="1545179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545186">return</span>&nbsp;<span class="ident" id="1545193">x</span><br>
<span class="lineno">345</span><span class="op" id="1545195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1545198">//&nbsp;implementation&nbsp;of&nbsp;new&nbsp;builtin</span><br>
<span class="lineno"></span><span class="keyword" id="1545231">func</span>&nbsp;<span class="ident" id="1545236">newobject</span><span class="op" id="1545245">(</span><span class="ident" id="1545246">typ</span>&nbsp;<span class="op" id="1545250">*</span><span class="ident" id="1545251">_type</span><span class="op" id="1545256">)</span>&nbsp;<span class="ident" id="1545258">unsafe</span><span class="op" id="1545264">.</span><span class="ident" id="1545265">Pointer</span>&nbsp;<span class="op" id="1545273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545276">flags</span>&nbsp;<span class="op" id="1545282">:=</span>&nbsp;<span class="builtintype" id="1545285">uint32</span><span class="op" id="1545291">(</span><span class="num" id="1545292">0</span><span class="op" id="1545293">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545296">if</span>&nbsp;<span class="ident" id="1545299">typ</span><span class="op" id="1545302">.</span><span class="ident" id="1545303">kind</span><span class="op" id="1545307">&amp;</span><span class="ident" id="1545308">kindNoPointers</span>&nbsp;<span class="op" id="1545323">!=</span>&nbsp;<span class="num" id="1545326">0</span>&nbsp;<span class="op" id="1545328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545332">flags</span>&nbsp;<span class="op" id="1545338">|=</span>&nbsp;<span class="ident" id="1545341">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545356">return</span>&nbsp;<span class="ident" id="1545363">mallocgc</span><span class="op" id="1545371">(</span><span class="builtintype" id="1545372">uintptr</span><span class="op" id="1545379">(</span><span class="ident" id="1545380">typ</span><span class="op" id="1545383">.</span><span class="ident" id="1545384">size</span><span class="op" id="1545388">)</span><span class="op" id="1545389">,</span>&nbsp;<span class="ident" id="1545391">typ</span><span class="op" id="1545394">,</span>&nbsp;<span class="ident" id="1545396">flags</span><span class="op" id="1545401">)</span><br>
<span class="lineno"></span><span class="op" id="1545403">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="1545406">//&nbsp;implementation&nbsp;of&nbsp;make&nbsp;builtin&nbsp;for&nbsp;slices</span><br>
<span class="lineno"></span><span class="keyword" id="1545451">func</span>&nbsp;<span class="ident" id="1545456">newarray</span><span class="op" id="1545464">(</span><span class="ident" id="1545465">typ</span>&nbsp;<span class="op" id="1545469">*</span><span class="ident" id="1545470">_type</span><span class="op" id="1545475">,</span>&nbsp;<span class="ident" id="1545477">n</span>&nbsp;<span class="builtintype" id="1545479">uintptr</span><span class="op" id="1545486">)</span>&nbsp;<span class="ident" id="1545488">unsafe</span><span class="op" id="1545494">.</span><span class="ident" id="1545495">Pointer</span>&nbsp;<span class="op" id="1545503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545506">flags</span>&nbsp;<span class="op" id="1545512">:=</span>&nbsp;<span class="builtintype" id="1545515">uint32</span><span class="op" id="1545521">(</span><span class="num" id="1545522">0</span><span class="op" id="1545523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545526">if</span>&nbsp;<span class="ident" id="1545529">typ</span><span class="op" id="1545532">.</span><span class="ident" id="1545533">kind</span><span class="op" id="1545537">&amp;</span><span class="ident" id="1545538">kindNoPointers</span>&nbsp;<span class="op" id="1545553">!=</span>&nbsp;<span class="num" id="1545556">0</span>&nbsp;<span class="op" id="1545558">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1545562">flags</span>&nbsp;<span class="op" id="1545568">|=</span>&nbsp;<span class="ident" id="1545571">flagNoScan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545586">if</span>&nbsp;<span class="builtintype" id="1545589">int</span><span class="op" id="1545592">(</span><span class="ident" id="1545593">n</span><span class="op" id="1545594">)</span>&nbsp;<span class="op" id="1545596">&lt;</span>&nbsp;<span class="num" id="1545598">0</span>&nbsp;<span class="op" id="1545600">||</span>&nbsp;<span class="op" id="1545603">(</span><span class="ident" id="1545604">typ</span><span class="op" id="1545607">.</span><span class="ident" id="1545608">size</span>&nbsp;<span class="op" id="1545613">&gt;</span>&nbsp;<span class="num" id="1545615">0</span>&nbsp;<span class="op" id="1545617">&amp;&amp;</span>&nbsp;<span class="ident" id="1545620">n</span>&nbsp;<span class="op" id="1545622">&gt;</span>&nbsp;<span class="ident" id="1545624">maxmem</span><span class="op" id="1545630">/</span><span class="builtintype" id="1545631">uintptr</span><span class="op" id="1545638">(</span><span class="ident" id="1545639">typ</span><span class="op" id="1545642">.</span><span class="ident" id="1545643">size</span><span class="op" id="1545647">)</span><span class="op" id="1545648">)</span>&nbsp;<span class="op" id="1545650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1545654">panic</span><span class="op" id="1545659">(</span><span class="string" id="1545660">&#34;runtime:&nbsp;allocation&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1545699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1545702">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545705">return</span>&nbsp;<span class="ident" id="1545712">mallocgc</span><span class="op" id="1545720">(</span><span class="builtintype" id="1545721">uintptr</span><span class="op" id="1545728">(</span><span class="ident" id="1545729">typ</span><span class="op" id="1545732">.</span><span class="ident" id="1545733">size</span><span class="op" id="1545737">)</span><span class="op" id="1545738">*</span><span class="ident" id="1545739">n</span><span class="op" id="1545740">,</span>&nbsp;<span class="ident" id="1545742">typ</span><span class="op" id="1545745">,</span>&nbsp;<span class="ident" id="1545747">flags</span><span class="op" id="1545752">)</span><br>
<span class="lineno"></span><span class="op" id="1545754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1545757">//&nbsp;rawmem&nbsp;returns&nbsp;a&nbsp;chunk&nbsp;of&nbsp;pointerless&nbsp;memory.&nbsp;&nbsp;It&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1545813">//&nbsp;not&nbsp;zeroed.</span><br>
<span class="lineno">370</span><span class="keyword" id="1545828">func</span>&nbsp;<span class="ident" id="1545833">rawmem</span><span class="op" id="1545839">(</span><span class="ident" id="1545840">size</span>&nbsp;<span class="builtintype" id="1545845">uintptr</span><span class="op" id="1545852">)</span>&nbsp;<span class="ident" id="1545854">unsafe</span><span class="op" id="1545860">.</span><span class="ident" id="1545861">Pointer</span>&nbsp;<span class="op" id="1545869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1545872">return</span>&nbsp;<span class="ident" id="1545879">mallocgc</span><span class="op" id="1545887">(</span><span class="ident" id="1545888">size</span><span class="op" id="1545892">,</span>&nbsp;<span class="ident" id="1545894">nil</span><span class="op" id="1545897">,</span>&nbsp;<span class="ident" id="1545899">flagNoScan</span><span class="op" id="1545909">|</span><span class="ident" id="1545910">flagNoZero</span><span class="op" id="1545920">)</span><br>
<span class="lineno"></span><span class="op" id="1545922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1545925">//&nbsp;round&nbsp;size&nbsp;up&nbsp;to&nbsp;next&nbsp;size&nbsp;class</span><br>
<span class="lineno">375</span><span class="keyword" id="1545961">func</span>&nbsp;<span class="ident" id="1545966">goroundupsize</span><span class="op" id="1545979">(</span><span class="ident" id="1545980">size</span>&nbsp;<span class="builtintype" id="1545985">uintptr</span><span class="op" id="1545992">)</span>&nbsp;<span class="builtintype" id="1545994">uintptr</span>&nbsp;<span class="op" id="1546002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546005">if</span>&nbsp;<span class="ident" id="1546008">size</span>&nbsp;<span class="op" id="1546013">&lt;</span>&nbsp;<span class="ident" id="1546015">maxSmallSize</span>&nbsp;<span class="op" id="1546028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546032">if</span>&nbsp;<span class="ident" id="1546035">size</span>&nbsp;<span class="op" id="1546040">&lt;=</span>&nbsp;<span class="num" id="1546043">1024</span><span class="op" id="1546047">-</span><span class="num" id="1546048">8</span>&nbsp;<span class="op" id="1546050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546055">return</span>&nbsp;<span class="builtintype" id="1546062">uintptr</span><span class="op" id="1546069">(</span><span class="ident" id="1546070">class_to_size</span><span class="op" id="1546083">[</span><span class="ident" id="1546084">size_to_class8</span><span class="op" id="1546098">[</span><span class="op" id="1546099">(</span><span class="ident" id="1546100">size</span><span class="op" id="1546104">+</span><span class="num" id="1546105">7</span><span class="op" id="1546106">)</span><span class="op" id="1546107">&gt;&gt;</span><span class="num" id="1546109">3</span><span class="op" id="1546110">]</span><span class="op" id="1546111">]</span><span class="op" id="1546112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546116">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546120">return</span>&nbsp;<span class="builtintype" id="1546127">uintptr</span><span class="op" id="1546134">(</span><span class="ident" id="1546135">class_to_size</span><span class="op" id="1546148">[</span><span class="ident" id="1546149">size_to_class128</span><span class="op" id="1546165">[</span><span class="op" id="1546166">(</span><span class="ident" id="1546167">size</span><span class="op" id="1546171">-</span><span class="num" id="1546172">1024</span><span class="op" id="1546176">+</span><span class="num" id="1546177">127</span><span class="op" id="1546180">)</span><span class="op" id="1546181">&gt;&gt;</span><span class="num" id="1546183">7</span><span class="op" id="1546184">]</span><span class="op" id="1546185">]</span><span class="op" id="1546186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546192">if</span>&nbsp;<span class="ident" id="1546195">size</span><span class="op" id="1546199">+</span><span class="ident" id="1546200">pageSize</span>&nbsp;<span class="op" id="1546209">&lt;</span>&nbsp;<span class="ident" id="1546211">size</span>&nbsp;<span class="op" id="1546216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546220">return</span>&nbsp;<span class="ident" id="1546227">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546233">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546236">return</span>&nbsp;<span class="op" id="1546243">(</span><span class="ident" id="1546244">size</span>&nbsp;<span class="op" id="1546249">+</span>&nbsp;<span class="ident" id="1546251">pageSize</span>&nbsp;<span class="op" id="1546260">-</span>&nbsp;<span class="num" id="1546262">1</span><span class="op" id="1546263">)</span>&nbsp;<span class="op" id="1546265">&amp;^</span>&nbsp;<span class="ident" id="1546268">pageMask</span><br>
<span class="lineno"></span><span class="op" id="1546277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1546280">func</span>&nbsp;<span class="ident" id="1546285">profilealloc</span><span class="op" id="1546297">(</span><span class="ident" id="1546298">mp</span>&nbsp;<span class="op" id="1546301">*</span><span class="ident" id="1546302">m</span><span class="op" id="1546303">,</span>&nbsp;<span class="ident" id="1546305">x</span>&nbsp;<span class="ident" id="1546307">unsafe</span><span class="op" id="1546313">.</span><span class="ident" id="1546314">Pointer</span><span class="op" id="1546321">,</span>&nbsp;<span class="ident" id="1546323">size</span>&nbsp;<span class="builtintype" id="1546328">uintptr</span><span class="op" id="1546335">)</span>&nbsp;<span class="op" id="1546337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546340">c</span>&nbsp;<span class="op" id="1546342">:=</span>&nbsp;<span class="ident" id="1546345">mp</span><span class="op" id="1546347">.</span><span class="ident" id="1546348">mcache</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546356">rate</span>&nbsp;<span class="op" id="1546361">:=</span>&nbsp;<span class="ident" id="1546364">MemProfileRate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546380">if</span>&nbsp;<span class="ident" id="1546383">size</span>&nbsp;<span class="op" id="1546388">&lt;</span>&nbsp;<span class="builtintype" id="1546390">uintptr</span><span class="op" id="1546397">(</span><span class="ident" id="1546398">rate</span><span class="op" id="1546402">)</span>&nbsp;<span class="op" id="1546404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1546408">//&nbsp;pick&nbsp;next&nbsp;profile&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1546436">//&nbsp;If&nbsp;you&nbsp;change&nbsp;this,&nbsp;also&nbsp;change&nbsp;allocmcache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546486">if</span>&nbsp;<span class="ident" id="1546489">rate</span>&nbsp;<span class="op" id="1546494">&gt;</span>&nbsp;<span class="num" id="1546496">0x3fffffff</span>&nbsp;<span class="op" id="1546507">{</span>&nbsp;<span class="comment" id="1546509">//&nbsp;make&nbsp;2*rate&nbsp;not&nbsp;overflow</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546540">rate</span>&nbsp;<span class="op" id="1546545">=</span>&nbsp;<span class="num" id="1546547">0x3fffffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546564">next</span>&nbsp;<span class="op" id="1546569">:=</span>&nbsp;<span class="builtintype" id="1546572">int32</span><span class="op" id="1546577">(</span><span class="ident" id="1546578">fastrand1</span><span class="op" id="1546587">(</span><span class="op" id="1546588">)</span><span class="op" id="1546589">)</span>&nbsp;<span class="op" id="1546591">%</span>&nbsp;<span class="op" id="1546593">(</span><span class="num" id="1546594">2</span>&nbsp;<span class="op" id="1546596">*</span>&nbsp;<span class="builtintype" id="1546598">int32</span><span class="op" id="1546603">(</span><span class="ident" id="1546604">rate</span><span class="op" id="1546608">)</span><span class="op" id="1546609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1546613">//&nbsp;Subtract&nbsp;the&nbsp;&#34;remainder&#34;&nbsp;of&nbsp;the&nbsp;current&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1546670">//&nbsp;Otherwise&nbsp;objects&nbsp;that&nbsp;are&nbsp;close&nbsp;in&nbsp;size&nbsp;to&nbsp;sampling&nbsp;rate</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1546733">//&nbsp;will&nbsp;be&nbsp;under-sampled,&nbsp;because&nbsp;we&nbsp;consistently&nbsp;discard&nbsp;this&nbsp;remainder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546809">next</span>&nbsp;<span class="op" id="1546814">-=</span>&nbsp;<span class="op" id="1546817">(</span><span class="builtintype" id="1546818">int32</span><span class="op" id="1546823">(</span><span class="ident" id="1546824">size</span><span class="op" id="1546828">)</span>&nbsp;<span class="op" id="1546830">-</span>&nbsp;<span class="ident" id="1546832">c</span><span class="op" id="1546833">.</span><span class="ident" id="1546834">next_sample</span><span class="op" id="1546845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1546849">if</span>&nbsp;<span class="ident" id="1546852">next</span>&nbsp;<span class="op" id="1546857">&lt;</span>&nbsp;<span class="num" id="1546859">0</span>&nbsp;<span class="op" id="1546861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546866">next</span>&nbsp;<span class="op" id="1546871">=</span>&nbsp;<span class="num" id="1546873">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546877">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546881">c</span><span class="op" id="1546882">.</span><span class="ident" id="1546883">next_sample</span>&nbsp;<span class="op" id="1546895">=</span>&nbsp;<span class="ident" id="1546897">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1546903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1546907">mProf_Malloc</span><span class="op" id="1546919">(</span><span class="ident" id="1546920">x</span><span class="op" id="1546921">,</span>&nbsp;<span class="ident" id="1546923">size</span><span class="op" id="1546927">)</span><br>
<span class="lineno"></span><span class="op" id="1546929">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="1546932">//&nbsp;force&nbsp;=&nbsp;1&nbsp;-&nbsp;do&nbsp;GC&nbsp;regardless&nbsp;of&nbsp;current&nbsp;heap&nbsp;usage</span><br>
<span class="lineno"></span><span class="comment" id="1546986">//&nbsp;force&nbsp;=&nbsp;2&nbsp;-&nbsp;go&nbsp;GC&nbsp;and&nbsp;eager&nbsp;sweep</span><br>
<span class="lineno"></span><span class="keyword" id="1547023">func</span>&nbsp;<span class="ident" id="1547028">gogc</span><span class="op" id="1547032">(</span><span class="ident" id="1547033">force</span>&nbsp;<span class="builtintype" id="1547039">int32</span><span class="op" id="1547044">)</span>&nbsp;<span class="op" id="1547046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1547049">//&nbsp;The&nbsp;gc&nbsp;is&nbsp;turned&nbsp;off&nbsp;(via&nbsp;enablegc)&nbsp;until&nbsp;the&nbsp;bootstrap&nbsp;has&nbsp;completed.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1547124">//&nbsp;Also,&nbsp;malloc&nbsp;gets&nbsp;called&nbsp;in&nbsp;the&nbsp;guts&nbsp;of&nbsp;a&nbsp;number&nbsp;of&nbsp;libraries&nbsp;that&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1547204">//&nbsp;holding&nbsp;locks.&nbsp;To&nbsp;avoid&nbsp;deadlocks&nbsp;during&nbsp;stoptheworld,&nbsp;don&#39;t&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1547276">//&nbsp;trying&nbsp;to&nbsp;run&nbsp;gc&nbsp;while&nbsp;holding&nbsp;a&nbsp;lock.&nbsp;The&nbsp;next&nbsp;mallocgc&nbsp;without&nbsp;a&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1547352">//&nbsp;will&nbsp;do&nbsp;the&nbsp;gc&nbsp;instead.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547380">mp</span>&nbsp;<span class="op" id="1547383">:=</span>&nbsp;<span class="ident" id="1547386">acquirem</span><span class="op" id="1547394">(</span><span class="op" id="1547395">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547398">if</span>&nbsp;<span class="ident" id="1547401">gp</span>&nbsp;<span class="op" id="1547404">:=</span>&nbsp;<span class="ident" id="1547407">getg</span><span class="op" id="1547411">(</span><span class="op" id="1547412">)</span><span class="op" id="1547413">;</span>&nbsp;<span class="ident" id="1547415">gp</span>&nbsp;<span class="op" id="1547418">==</span>&nbsp;<span class="ident" id="1547421">mp</span><span class="op" id="1547423">.</span><span class="ident" id="1547424">g0</span>&nbsp;<span class="op" id="1547427">||</span>&nbsp;<span class="ident" id="1547430">mp</span><span class="op" id="1547432">.</span><span class="ident" id="1547433">locks</span>&nbsp;<span class="op" id="1547439">&gt;</span>&nbsp;<span class="num" id="1547441">1</span>&nbsp;<span class="op" id="1547443">||</span>&nbsp;<span class="op" id="1547446">!</span><span class="ident" id="1547447">memstats</span><span class="op" id="1547455">.</span><span class="ident" id="1547456">enablegc</span>&nbsp;<span class="op" id="1547465">||</span>&nbsp;<span class="ident" id="1547468">panicking</span>&nbsp;<span class="op" id="1547478">!=</span>&nbsp;<span class="num" id="1547481">0</span>&nbsp;<span class="op" id="1547483">||</span>&nbsp;<span class="ident" id="1547486">gcpercent</span>&nbsp;<span class="op" id="1547496">&lt;</span>&nbsp;<span class="num" id="1547498">0</span>&nbsp;<span class="op" id="1547500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547504">releasem</span><span class="op" id="1547512">(</span><span class="ident" id="1547513">mp</span><span class="op" id="1547515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547519">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547530">releasem</span><span class="op" id="1547538">(</span><span class="ident" id="1547539">mp</span><span class="op" id="1547541">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547544">mp</span>&nbsp;<span class="op" id="1547547">=</span>&nbsp;<span class="ident" id="1547549">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547555">semacquire</span><span class="op" id="1547565">(</span><span class="op" id="1547566">&amp;</span><span class="ident" id="1547567">worldsema</span><span class="op" id="1547576">,</span>&nbsp;<span class="builtintype" id="1547578">false</span><span class="op" id="1547583">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547587">if</span>&nbsp;<span class="ident" id="1547590">force</span>&nbsp;<span class="op" id="1547596">==</span>&nbsp;<span class="num" id="1547599">0</span>&nbsp;<span class="op" id="1547601">&amp;&amp;</span>&nbsp;<span class="ident" id="1547604">memstats</span><span class="op" id="1547612">.</span><span class="ident" id="1547613">heap_alloc</span>&nbsp;<span class="op" id="1547624">&lt;</span>&nbsp;<span class="ident" id="1547626">memstats</span><span class="op" id="1547634">.</span><span class="ident" id="1547635">next_gc</span>&nbsp;<span class="op" id="1547643">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1547647">//&nbsp;typically&nbsp;threads&nbsp;which&nbsp;lost&nbsp;the&nbsp;race&nbsp;to&nbsp;grab</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1547698">//&nbsp;worldsema&nbsp;exit&nbsp;here&nbsp;when&nbsp;gc&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547740">semrelease</span><span class="op" id="1547750">(</span><span class="op" id="1547751">&amp;</span><span class="ident" id="1547752">worldsema</span><span class="op" id="1547761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547765">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547773">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1547777">//&nbsp;Ok,&nbsp;we&#39;re&nbsp;doing&nbsp;it!&nbsp;&nbsp;Stop&nbsp;everybody&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547822">startTime</span>&nbsp;<span class="op" id="1547832">:=</span>&nbsp;<span class="ident" id="1547835">nanotime</span><span class="op" id="1547843">(</span><span class="op" id="1547844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547847">mp</span>&nbsp;<span class="op" id="1547850">=</span>&nbsp;<span class="ident" id="1547852">acquirem</span><span class="op" id="1547860">(</span><span class="op" id="1547861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547864">mp</span><span class="op" id="1547866">.</span><span class="ident" id="1547867">gcing</span>&nbsp;<span class="op" id="1547873">=</span>&nbsp;<span class="num" id="1547875">1</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547878">releasem</span><span class="op" id="1547886">(</span><span class="ident" id="1547887">mp</span><span class="op" id="1547889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547892">onM</span><span class="op" id="1547895">(</span><span class="ident" id="1547896">stoptheworld</span><span class="op" id="1547908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1547911">if</span>&nbsp;<span class="ident" id="1547914">mp</span>&nbsp;<span class="op" id="1547917">!=</span>&nbsp;<span class="ident" id="1547920">acquirem</span><span class="op" id="1547928">(</span><span class="op" id="1547929">)</span>&nbsp;<span class="op" id="1547931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547935">gothrow</span><span class="op" id="1547942">(</span><span class="string" id="1547943">&#34;gogc:&nbsp;rescheduled&#34;</span><span class="op" id="1547962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1547965">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1547969">clearpools</span><span class="op" id="1547979">(</span><span class="op" id="1547980">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1547984">//&nbsp;Run&nbsp;gc&nbsp;on&nbsp;the&nbsp;g0&nbsp;stack.&nbsp;&nbsp;We&nbsp;do&nbsp;this&nbsp;so&nbsp;that&nbsp;the&nbsp;g&nbsp;stack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1548044">//&nbsp;we&#39;re&nbsp;currently&nbsp;running&nbsp;on&nbsp;will&nbsp;no&nbsp;longer&nbsp;change.&nbsp;&nbsp;Cuts</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1548104">//&nbsp;the&nbsp;root&nbsp;set&nbsp;down&nbsp;a&nbsp;bit&nbsp;(g0&nbsp;stacks&nbsp;are&nbsp;not&nbsp;scanned,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1548164">//&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;scan&nbsp;gc&#39;s&nbsp;internal&nbsp;state).&nbsp;&nbsp;We&nbsp;also</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1548221">//&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;g0&nbsp;so&nbsp;we&nbsp;can&nbsp;shrink&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548274">n</span>&nbsp;<span class="op" id="1548276">:=</span>&nbsp;<span class="num" id="1548279">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1548282">if</span>&nbsp;<span class="ident" id="1548285">debug</span><span class="op" id="1548290">.</span><span class="ident" id="1548291">gctrace</span>&nbsp;<span class="op" id="1548299">&gt;</span>&nbsp;<span class="num" id="1548301">1</span>&nbsp;<span class="op" id="1548303">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548307">n</span>&nbsp;<span class="op" id="1548309">=</span>&nbsp;<span class="num" id="1548311">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1548317">for</span>&nbsp;<span class="ident" id="1548321">i</span>&nbsp;<span class="op" id="1548323">:=</span>&nbsp;<span class="num" id="1548326">0</span><span class="op" id="1548327">;</span>&nbsp;<span class="ident" id="1548329">i</span>&nbsp;<span class="op" id="1548331">&lt;</span>&nbsp;<span class="ident" id="1548333">n</span><span class="op" id="1548334">;</span>&nbsp;<span class="ident" id="1548336">i</span><span class="op" id="1548337">++</span>&nbsp;<span class="op" id="1548340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1548344">if</span>&nbsp;<span class="ident" id="1548347">i</span>&nbsp;<span class="op" id="1548349">&gt;</span>&nbsp;<span class="num" id="1548351">0</span>&nbsp;<span class="op" id="1548353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548358">startTime</span>&nbsp;<span class="op" id="1548368">=</span>&nbsp;<span class="ident" id="1548370">nanotime</span><span class="op" id="1548378">(</span><span class="op" id="1548379">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1548387">//&nbsp;switch&nbsp;to&nbsp;g0,&nbsp;call&nbsp;gc,&nbsp;then&nbsp;switch&nbsp;back</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548432">mp</span><span class="op" id="1548434">.</span><span class="ident" id="1548435">scalararg</span><span class="op" id="1548444">[</span><span class="num" id="1548445">0</span><span class="op" id="1548446">]</span>&nbsp;<span class="op" id="1548448">=</span>&nbsp;<span class="builtintype" id="1548450">uintptr</span><span class="op" id="1548457">(</span><span class="builtintype" id="1548458">uint32</span><span class="op" id="1548464">(</span><span class="ident" id="1548465">startTime</span><span class="op" id="1548474">)</span><span class="op" id="1548475">)</span>&nbsp;<span class="comment" id="1548477">//&nbsp;low&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548494">mp</span><span class="op" id="1548496">.</span><span class="ident" id="1548497">scalararg</span><span class="op" id="1548506">[</span><span class="num" id="1548507">1</span><span class="op" id="1548508">]</span>&nbsp;<span class="op" id="1548510">=</span>&nbsp;<span class="builtintype" id="1548512">uintptr</span><span class="op" id="1548519">(</span><span class="ident" id="1548520">startTime</span>&nbsp;<span class="op" id="1548530">&gt;&gt;</span>&nbsp;<span class="num" id="1548533">32</span><span class="op" id="1548535">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1548539">//&nbsp;high&nbsp;32&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1548557">if</span>&nbsp;<span class="ident" id="1548560">force</span>&nbsp;<span class="op" id="1548566">&gt;=</span>&nbsp;<span class="num" id="1548569">2</span>&nbsp;<span class="op" id="1548571">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548576">mp</span><span class="op" id="1548578">.</span><span class="ident" id="1548579">scalararg</span><span class="op" id="1548588">[</span><span class="num" id="1548589">2</span><span class="op" id="1548590">]</span>&nbsp;<span class="op" id="1548592">=</span>&nbsp;<span class="num" id="1548594">1</span>&nbsp;<span class="comment" id="1548596">//&nbsp;eagersweep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548612">}</span>&nbsp;<span class="keyword" id="1548614">else</span>&nbsp;<span class="op" id="1548619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548624">mp</span><span class="op" id="1548626">.</span><span class="ident" id="1548627">scalararg</span><span class="op" id="1548636">[</span><span class="num" id="1548637">2</span><span class="op" id="1548638">]</span>&nbsp;<span class="op" id="1548640">=</span>&nbsp;<span class="num" id="1548642">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548650">onM</span><span class="op" id="1548653">(</span><span class="ident" id="1548654">gc_m</span><span class="op" id="1548658">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1548665">//&nbsp;all&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548678">mp</span><span class="op" id="1548680">.</span><span class="ident" id="1548681">gcing</span>&nbsp;<span class="op" id="1548687">=</span>&nbsp;<span class="num" id="1548689">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548692">semrelease</span><span class="op" id="1548702">(</span><span class="op" id="1548703">&amp;</span><span class="ident" id="1548704">worldsema</span><span class="op" id="1548713">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548716">onM</span><span class="op" id="1548719">(</span><span class="ident" id="1548720">starttheworld</span><span class="op" id="1548733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548736">releasem</span><span class="op" id="1548744">(</span><span class="ident" id="1548745">mp</span><span class="op" id="1548747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548750">mp</span>&nbsp;<span class="op" id="1548753">=</span>&nbsp;<span class="ident" id="1548755">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1548761">//&nbsp;now&nbsp;that&nbsp;gc&nbsp;is&nbsp;done,&nbsp;kick&nbsp;off&nbsp;finalizer&nbsp;thread&nbsp;if&nbsp;needed</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1548822">if</span>&nbsp;<span class="op" id="1548825">!</span><span class="ident" id="1548826">concurrentSweep</span>&nbsp;<span class="op" id="1548842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1548846">//&nbsp;give&nbsp;the&nbsp;queued&nbsp;finalizers,&nbsp;if&nbsp;any,&nbsp;a&nbsp;chance&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548903">Gosched</span><span class="op" id="1548910">(</span><span class="op" id="1548911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1548914">}</span><br>
<span class="lineno"></span><span class="op" id="1548916">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="1548919">//&nbsp;GC&nbsp;runs&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span><span class="keyword" id="1548952">func</span>&nbsp;<span class="ident" id="1548957">GC</span><span class="op" id="1548959">(</span><span class="op" id="1548960">)</span>&nbsp;<span class="op" id="1548962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1548965">gogc</span><span class="op" id="1548969">(</span><span class="num" id="1548970">2</span><span class="op" id="1548971">)</span><br>
<span class="lineno"></span><span class="op" id="1548973">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="comment" id="1548976">//&nbsp;linker-provided</span><br>
<span class="lineno"></span><span class="keyword" id="1548995">var</span>&nbsp;<span class="ident" id="1548999">noptrdata</span>&nbsp;<span class="keyword" id="1549009">struct</span><span class="op" id="1549015">{</span><span class="op" id="1549016">}</span><br>
<span class="lineno"></span><span class="keyword" id="1549018">var</span>&nbsp;<span class="ident" id="1549022">enoptrdata</span>&nbsp;<span class="keyword" id="1549033">struct</span><span class="op" id="1549039">{</span><span class="op" id="1549040">}</span><br>
<span class="lineno"></span><span class="keyword" id="1549042">var</span>&nbsp;<span class="ident" id="1549046">noptrbss</span>&nbsp;<span class="keyword" id="1549055">struct</span><span class="op" id="1549061">{</span><span class="op" id="1549062">}</span><br>
<span class="lineno">495</span><span class="keyword" id="1549064">var</span>&nbsp;<span class="ident" id="1549068">enoptrbss</span>&nbsp;<span class="keyword" id="1549078">struct</span><span class="op" id="1549084">{</span><span class="op" id="1549085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1549088">//&nbsp;SetFinalizer&nbsp;sets&nbsp;the&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1549147">//&nbsp;When&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;finds&nbsp;an&nbsp;unreachable&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="1549204">//&nbsp;with&nbsp;an&nbsp;associated&nbsp;finalizer,&nbsp;it&nbsp;clears&nbsp;the&nbsp;association&nbsp;and&nbsp;runs</span><br>
<span class="lineno">500</span><span class="comment" id="1549272">//&nbsp;f(x)&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine.&nbsp;&nbsp;This&nbsp;makes&nbsp;x&nbsp;reachable&nbsp;again,&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="1549340">//&nbsp;now&nbsp;without&nbsp;an&nbsp;associated&nbsp;finalizer.&nbsp;&nbsp;Assuming&nbsp;that&nbsp;SetFinalizer</span><br>
<span class="lineno"></span><span class="comment" id="1549408">//&nbsp;is&nbsp;not&nbsp;called&nbsp;again,&nbsp;the&nbsp;next&nbsp;time&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;sees</span><br>
<span class="lineno"></span><span class="comment" id="1549473">//&nbsp;that&nbsp;x&nbsp;is&nbsp;unreachable,&nbsp;it&nbsp;will&nbsp;free&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1549515">//</span><br>
<span class="lineno">505</span><span class="comment" id="1549518">//&nbsp;SetFinalizer(x,&nbsp;nil)&nbsp;clears&nbsp;any&nbsp;finalizer&nbsp;associated&nbsp;with&nbsp;x.</span><br>
<span class="lineno"></span><span class="comment" id="1549582">//</span><br>
<span class="lineno"></span><span class="comment" id="1549585">//&nbsp;The&nbsp;argument&nbsp;x&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;object&nbsp;allocated&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="1549647">//&nbsp;calling&nbsp;new&nbsp;or&nbsp;by&nbsp;taking&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;composite&nbsp;literal.</span><br>
<span class="lineno"></span><span class="comment" id="1549711">//&nbsp;The&nbsp;argument&nbsp;f&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;that&nbsp;takes&nbsp;a&nbsp;single&nbsp;argument</span><br>
<span class="lineno">510</span><span class="comment" id="1549777">//&nbsp;to&nbsp;which&nbsp;x&#39;s&nbsp;type&nbsp;can&nbsp;be&nbsp;assigned,&nbsp;and&nbsp;can&nbsp;have&nbsp;arbitrary&nbsp;ignored&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="1549853">//&nbsp;values.&nbsp;If&nbsp;either&nbsp;of&nbsp;these&nbsp;is&nbsp;not&nbsp;true,&nbsp;SetFinalizer&nbsp;aborts&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1549920">//&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1549932">//</span><br>
<span class="lineno"></span><span class="comment" id="1549935">//&nbsp;Finalizers&nbsp;are&nbsp;run&nbsp;in&nbsp;dependency&nbsp;order:&nbsp;if&nbsp;A&nbsp;points&nbsp;at&nbsp;B,&nbsp;both&nbsp;have</span><br>
<span class="lineno">515</span><span class="comment" id="1550006">//&nbsp;finalizers,&nbsp;and&nbsp;they&nbsp;are&nbsp;otherwise&nbsp;unreachable,&nbsp;only&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1550076">//&nbsp;for&nbsp;A&nbsp;runs;&nbsp;once&nbsp;A&nbsp;is&nbsp;freed,&nbsp;the&nbsp;finalizer&nbsp;for&nbsp;B&nbsp;can&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="1550137">//&nbsp;If&nbsp;a&nbsp;cyclic&nbsp;structure&nbsp;includes&nbsp;a&nbsp;block&nbsp;with&nbsp;a&nbsp;finalizer,&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="1550202">//&nbsp;cycle&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;and&nbsp;the&nbsp;finalizer</span><br>
<span class="lineno"></span><span class="comment" id="1550271">//&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;to&nbsp;run,&nbsp;because&nbsp;there&nbsp;is&nbsp;no&nbsp;ordering&nbsp;that</span><br>
<span class="lineno">520</span><span class="comment" id="1550334">//&nbsp;respects&nbsp;the&nbsp;dependencies.</span><br>
<span class="lineno"></span><span class="comment" id="1550364">//</span><br>
<span class="lineno"></span><span class="comment" id="1550367">//&nbsp;The&nbsp;finalizer&nbsp;for&nbsp;x&nbsp;is&nbsp;scheduled&nbsp;to&nbsp;run&nbsp;at&nbsp;some&nbsp;arbitrary&nbsp;time&nbsp;after</span><br>
<span class="lineno"></span><span class="comment" id="1550439">//&nbsp;x&nbsp;becomes&nbsp;unreachable.</span><br>
<span class="lineno"></span><span class="comment" id="1550465">//&nbsp;There&nbsp;is&nbsp;no&nbsp;guarantee&nbsp;that&nbsp;finalizers&nbsp;will&nbsp;run&nbsp;before&nbsp;a&nbsp;program&nbsp;exits,</span><br>
<span class="lineno">525</span><span class="comment" id="1550539">//&nbsp;so&nbsp;typically&nbsp;they&nbsp;are&nbsp;useful&nbsp;only&nbsp;for&nbsp;releasing&nbsp;non-memory&nbsp;resources</span><br>
<span class="lineno"></span><span class="comment" id="1550611">//&nbsp;associated&nbsp;with&nbsp;an&nbsp;object&nbsp;during&nbsp;a&nbsp;long-running&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="1550671">//&nbsp;For&nbsp;example,&nbsp;an&nbsp;os.File&nbsp;object&nbsp;could&nbsp;use&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;close&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1550740">//&nbsp;associated&nbsp;operating&nbsp;system&nbsp;file&nbsp;descriptor&nbsp;when&nbsp;a&nbsp;program&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="1550811">//&nbsp;an&nbsp;os.File&nbsp;without&nbsp;calling&nbsp;Close,&nbsp;but&nbsp;it&nbsp;would&nbsp;be&nbsp;a&nbsp;mistake</span><br>
<span class="lineno">530</span><span class="comment" id="1550874">//&nbsp;to&nbsp;depend&nbsp;on&nbsp;a&nbsp;finalizer&nbsp;to&nbsp;flush&nbsp;an&nbsp;in-memory&nbsp;I/O&nbsp;buffer&nbsp;such&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1550945">//&nbsp;bufio.Writer,&nbsp;because&nbsp;the&nbsp;buffer&nbsp;would&nbsp;not&nbsp;be&nbsp;flushed&nbsp;at&nbsp;program&nbsp;exit.</span><br>
<span class="lineno"></span><span class="comment" id="1551019">//</span><br>
<span class="lineno"></span><span class="comment" id="1551022">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;*x&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1551093">//&nbsp;zero&nbsp;bytes.</span><br>
<span class="lineno">535</span><span class="comment" id="1551108">//</span><br>
<span class="lineno"></span><span class="comment" id="1551111">//&nbsp;It&nbsp;is&nbsp;not&nbsp;guaranteed&nbsp;that&nbsp;a&nbsp;finalizer&nbsp;will&nbsp;run&nbsp;for&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1551183">//&nbsp;in&nbsp;initializers&nbsp;for&nbsp;package-level&nbsp;variables.&nbsp;Such&nbsp;objects&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="1551251">//&nbsp;linker-allocated,&nbsp;not&nbsp;heap-allocated.</span><br>
<span class="lineno"></span><span class="comment" id="1551292">//</span><br>
<span class="lineno">540</span><span class="comment" id="1551295">//&nbsp;A&nbsp;single&nbsp;goroutine&nbsp;runs&nbsp;all&nbsp;finalizers&nbsp;for&nbsp;a&nbsp;program,&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="comment" id="1551366">//&nbsp;If&nbsp;a&nbsp;finalizer&nbsp;must&nbsp;run&nbsp;for&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;should&nbsp;do&nbsp;so&nbsp;by&nbsp;starting</span><br>
<span class="lineno"></span><span class="comment" id="1551438">//&nbsp;a&nbsp;new&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1551458">func</span>&nbsp;<span class="ident" id="1551463">SetFinalizer</span><span class="op" id="1551475">(</span><span class="ident" id="1551476">obj</span>&nbsp;<span class="keyword" id="1551480">interface</span><span class="op" id="1551489">{</span><span class="op" id="1551490">}</span><span class="op" id="1551491">,</span>&nbsp;<span class="ident" id="1551493">finalizer</span>&nbsp;<span class="keyword" id="1551503">interface</span><span class="op" id="1551512">{</span><span class="op" id="1551513">}</span><span class="op" id="1551514">)</span>&nbsp;<span class="op" id="1551516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551519">e</span>&nbsp;<span class="op" id="1551521">:=</span>&nbsp;<span class="op" id="1551524">(</span><span class="op" id="1551525">*</span><span class="ident" id="1551526">eface</span><span class="op" id="1551531">)</span><span class="op" id="1551532">(</span><span class="ident" id="1551533">unsafe</span><span class="op" id="1551539">.</span><span class="ident" id="1551540">Pointer</span><span class="op" id="1551547">(</span><span class="op" id="1551548">&amp;</span><span class="ident" id="1551549">obj</span><span class="op" id="1551552">)</span><span class="op" id="1551553">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551556">etyp</span>&nbsp;<span class="op" id="1551561">:=</span>&nbsp;<span class="ident" id="1551564">e</span><span class="op" id="1551565">.</span><span class="ident" id="1551566">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551573">if</span>&nbsp;<span class="ident" id="1551576">etyp</span>&nbsp;<span class="op" id="1551581">==</span>&nbsp;<span class="ident" id="1551584">nil</span>&nbsp;<span class="op" id="1551588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551592">gothrow</span><span class="op" id="1551599">(</span><span class="string" id="1551600">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;nil&#34;</span><span class="op" id="1551645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551651">if</span>&nbsp;<span class="ident" id="1551654">etyp</span><span class="op" id="1551658">.</span><span class="ident" id="1551659">kind</span><span class="op" id="1551663">&amp;</span><span class="ident" id="1551664">kindMask</span>&nbsp;<span class="op" id="1551673">!=</span>&nbsp;<span class="ident" id="1551676">kindPtr</span>&nbsp;<span class="op" id="1551684">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551688">gothrow</span><span class="op" id="1551695">(</span><span class="string" id="1551696">&#34;runtime.SetFinalizer:&nbsp;first&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1551739">+</span>&nbsp;<span class="op" id="1551741">*</span><span class="ident" id="1551742">etyp</span><span class="op" id="1551746">.</span><span class="ident" id="1551747">_string</span>&nbsp;<span class="op" id="1551755">+</span>&nbsp;<span class="string" id="1551757">&#34;,&nbsp;not&nbsp;pointer&#34;</span><span class="op" id="1551772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551778">ot</span>&nbsp;<span class="op" id="1551781">:=</span>&nbsp;<span class="op" id="1551784">(</span><span class="op" id="1551785">*</span><span class="ident" id="1551786">ptrtype</span><span class="op" id="1551793">)</span><span class="op" id="1551794">(</span><span class="ident" id="1551795">unsafe</span><span class="op" id="1551801">.</span><span class="ident" id="1551802">Pointer</span><span class="op" id="1551809">(</span><span class="ident" id="1551810">etyp</span><span class="op" id="1551814">)</span><span class="op" id="1551815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551818">if</span>&nbsp;<span class="ident" id="1551821">ot</span><span class="op" id="1551823">.</span><span class="ident" id="1551824">elem</span>&nbsp;<span class="op" id="1551829">==</span>&nbsp;<span class="ident" id="1551832">nil</span>&nbsp;<span class="op" id="1551836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551840">gothrow</span><span class="op" id="1551847">(</span><span class="string" id="1551848">&#34;nil&nbsp;elem&nbsp;type!&#34;</span><span class="op" id="1551864">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1551867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551871">//&nbsp;find&nbsp;the&nbsp;containing&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1551902">_</span><span class="op" id="1551903">,</span>&nbsp;<span class="ident" id="1551905">base</span><span class="op" id="1551909">,</span>&nbsp;<span class="ident" id="1551911">_</span>&nbsp;<span class="op" id="1551913">:=</span>&nbsp;<span class="ident" id="1551916">findObject</span><span class="op" id="1551926">(</span><span class="ident" id="1551927">e</span><span class="op" id="1551928">.</span><span class="ident" id="1551929">data</span><span class="op" id="1551933">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551937">if</span>&nbsp;<span class="ident" id="1551940">base</span>&nbsp;<span class="op" id="1551945">==</span>&nbsp;<span class="ident" id="1551948">nil</span>&nbsp;<span class="op" id="1551952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1551956">//&nbsp;0-length&nbsp;objects&nbsp;are&nbsp;okay.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1551988">if</span>&nbsp;<span class="ident" id="1551991">e</span><span class="op" id="1551992">.</span><span class="ident" id="1551993">data</span>&nbsp;<span class="op" id="1551998">==</span>&nbsp;<span class="ident" id="1552001">unsafe</span><span class="op" id="1552007">.</span><span class="ident" id="1552008">Pointer</span><span class="op" id="1552015">(</span><span class="op" id="1552016">&amp;</span><span class="ident" id="1552017">zerobase</span><span class="op" id="1552025">)</span>&nbsp;<span class="op" id="1552027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552032">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552041">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552046">//&nbsp;Global&nbsp;initializers&nbsp;might&nbsp;be&nbsp;linker-allocated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552098">//&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;Foo&nbsp;=&nbsp;&amp;Object{}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552123">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552142">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime.SetFinalizer(Foo,&nbsp;nil)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552179">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552186">//&nbsp;The&nbsp;relevant&nbsp;segments&nbsp;are:&nbsp;noptrdata,&nbsp;data,&nbsp;bss,&nbsp;noptrbss.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552250">//&nbsp;We&nbsp;cannot&nbsp;assume&nbsp;they&nbsp;are&nbsp;in&nbsp;any&nbsp;order&nbsp;or&nbsp;even&nbsp;contiguous,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552314">//&nbsp;due&nbsp;to&nbsp;external&nbsp;linking.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552344">if</span>&nbsp;<span class="builtintype" id="1552347">uintptr</span><span class="op" id="1552354">(</span><span class="ident" id="1552355">unsafe</span><span class="op" id="1552361">.</span><span class="ident" id="1552362">Pointer</span><span class="op" id="1552369">(</span><span class="op" id="1552370">&amp;</span><span class="ident" id="1552371">noptrdata</span><span class="op" id="1552380">)</span><span class="op" id="1552381">)</span>&nbsp;<span class="op" id="1552383">&lt;=</span>&nbsp;<span class="builtintype" id="1552386">uintptr</span><span class="op" id="1552393">(</span><span class="ident" id="1552394">e</span><span class="op" id="1552395">.</span><span class="ident" id="1552396">data</span><span class="op" id="1552400">)</span>&nbsp;<span class="op" id="1552402">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1552405">uintptr</span><span class="op" id="1552412">(</span><span class="ident" id="1552413">e</span><span class="op" id="1552414">.</span><span class="ident" id="1552415">data</span><span class="op" id="1552419">)</span>&nbsp;<span class="op" id="1552421">&lt;</span>&nbsp;<span class="builtintype" id="1552423">uintptr</span><span class="op" id="1552430">(</span><span class="ident" id="1552431">unsafe</span><span class="op" id="1552437">.</span><span class="ident" id="1552438">Pointer</span><span class="op" id="1552445">(</span><span class="op" id="1552446">&amp;</span><span class="ident" id="1552447">enoptrdata</span><span class="op" id="1552457">)</span><span class="op" id="1552458">)</span>&nbsp;<span class="op" id="1552460">||</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1552466">uintptr</span><span class="op" id="1552473">(</span><span class="ident" id="1552474">unsafe</span><span class="op" id="1552480">.</span><span class="ident" id="1552481">Pointer</span><span class="op" id="1552488">(</span><span class="op" id="1552489">&amp;</span><span class="ident" id="1552490">data</span><span class="op" id="1552494">)</span><span class="op" id="1552495">)</span>&nbsp;<span class="op" id="1552497">&lt;=</span>&nbsp;<span class="builtintype" id="1552500">uintptr</span><span class="op" id="1552507">(</span><span class="ident" id="1552508">e</span><span class="op" id="1552509">.</span><span class="ident" id="1552510">data</span><span class="op" id="1552514">)</span>&nbsp;<span class="op" id="1552516">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1552519">uintptr</span><span class="op" id="1552526">(</span><span class="ident" id="1552527">e</span><span class="op" id="1552528">.</span><span class="ident" id="1552529">data</span><span class="op" id="1552533">)</span>&nbsp;<span class="op" id="1552535">&lt;</span>&nbsp;<span class="builtintype" id="1552537">uintptr</span><span class="op" id="1552544">(</span><span class="ident" id="1552545">unsafe</span><span class="op" id="1552551">.</span><span class="ident" id="1552552">Pointer</span><span class="op" id="1552559">(</span><span class="op" id="1552560">&amp;</span><span class="ident" id="1552561">edata</span><span class="op" id="1552566">)</span><span class="op" id="1552567">)</span>&nbsp;<span class="op" id="1552569">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1552575">uintptr</span><span class="op" id="1552582">(</span><span class="ident" id="1552583">unsafe</span><span class="op" id="1552589">.</span><span class="ident" id="1552590">Pointer</span><span class="op" id="1552597">(</span><span class="op" id="1552598">&amp;</span><span class="ident" id="1552599">bss</span><span class="op" id="1552602">)</span><span class="op" id="1552603">)</span>&nbsp;<span class="op" id="1552605">&lt;=</span>&nbsp;<span class="builtintype" id="1552608">uintptr</span><span class="op" id="1552615">(</span><span class="ident" id="1552616">e</span><span class="op" id="1552617">.</span><span class="ident" id="1552618">data</span><span class="op" id="1552622">)</span>&nbsp;<span class="op" id="1552624">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1552627">uintptr</span><span class="op" id="1552634">(</span><span class="ident" id="1552635">e</span><span class="op" id="1552636">.</span><span class="ident" id="1552637">data</span><span class="op" id="1552641">)</span>&nbsp;<span class="op" id="1552643">&lt;</span>&nbsp;<span class="builtintype" id="1552645">uintptr</span><span class="op" id="1552652">(</span><span class="ident" id="1552653">unsafe</span><span class="op" id="1552659">.</span><span class="ident" id="1552660">Pointer</span><span class="op" id="1552667">(</span><span class="op" id="1552668">&amp;</span><span class="ident" id="1552669">ebss</span><span class="op" id="1552673">)</span><span class="op" id="1552674">)</span>&nbsp;<span class="op" id="1552676">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1552682">uintptr</span><span class="op" id="1552689">(</span><span class="ident" id="1552690">unsafe</span><span class="op" id="1552696">.</span><span class="ident" id="1552697">Pointer</span><span class="op" id="1552704">(</span><span class="op" id="1552705">&amp;</span><span class="ident" id="1552706">noptrbss</span><span class="op" id="1552714">)</span><span class="op" id="1552715">)</span>&nbsp;<span class="op" id="1552717">&lt;=</span>&nbsp;<span class="builtintype" id="1552720">uintptr</span><span class="op" id="1552727">(</span><span class="ident" id="1552728">e</span><span class="op" id="1552729">.</span><span class="ident" id="1552730">data</span><span class="op" id="1552734">)</span>&nbsp;<span class="op" id="1552736">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1552739">uintptr</span><span class="op" id="1552746">(</span><span class="ident" id="1552747">e</span><span class="op" id="1552748">.</span><span class="ident" id="1552749">data</span><span class="op" id="1552753">)</span>&nbsp;<span class="op" id="1552755">&lt;</span>&nbsp;<span class="builtintype" id="1552757">uintptr</span><span class="op" id="1552764">(</span><span class="ident" id="1552765">unsafe</span><span class="op" id="1552771">.</span><span class="ident" id="1552772">Pointer</span><span class="op" id="1552779">(</span><span class="op" id="1552780">&amp;</span><span class="ident" id="1552781">enoptrbss</span><span class="op" id="1552790">)</span><span class="op" id="1552791">)</span>&nbsp;<span class="op" id="1552793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552798">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552807">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1552811">gothrow</span><span class="op" id="1552818">(</span><span class="string" id="1552819">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;in&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1552873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1552876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1552880">if</span>&nbsp;<span class="ident" id="1552883">e</span><span class="op" id="1552884">.</span><span class="ident" id="1552885">data</span>&nbsp;<span class="op" id="1552890">!=</span>&nbsp;<span class="ident" id="1552893">base</span>&nbsp;<span class="op" id="1552898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552902">//&nbsp;As&nbsp;an&nbsp;implementation&nbsp;detail&nbsp;we&nbsp;allow&nbsp;to&nbsp;set&nbsp;finalizers&nbsp;for&nbsp;an&nbsp;inner&nbsp;byte</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1552980">//&nbsp;of&nbsp;an&nbsp;object&nbsp;if&nbsp;it&nbsp;could&nbsp;come&nbsp;from&nbsp;tiny&nbsp;alloc&nbsp;(see&nbsp;mallocgc&nbsp;for&nbsp;details).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553059">if</span>&nbsp;<span class="ident" id="1553062">ot</span><span class="op" id="1553064">.</span><span class="ident" id="1553065">elem</span>&nbsp;<span class="op" id="1553070">==</span>&nbsp;<span class="ident" id="1553073">nil</span>&nbsp;<span class="op" id="1553077">||</span>&nbsp;<span class="ident" id="1553080">ot</span><span class="op" id="1553082">.</span><span class="ident" id="1553083">elem</span><span class="op" id="1553087">.</span><span class="ident" id="1553088">kind</span><span class="op" id="1553092">&amp;</span><span class="ident" id="1553093">kindNoPointers</span>&nbsp;<span class="op" id="1553108">==</span>&nbsp;<span class="num" id="1553111">0</span>&nbsp;<span class="op" id="1553113">||</span>&nbsp;<span class="ident" id="1553116">ot</span><span class="op" id="1553118">.</span><span class="ident" id="1553119">elem</span><span class="op" id="1553123">.</span><span class="ident" id="1553124">size</span>&nbsp;<span class="op" id="1553129">&gt;=</span>&nbsp;<span class="ident" id="1553132">maxTinySize</span>&nbsp;<span class="op" id="1553144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553149">gothrow</span><span class="op" id="1553156">(</span><span class="string" id="1553157">&#34;runtime.SetFinalizer:&nbsp;pointer&nbsp;not&nbsp;at&nbsp;beginning&nbsp;of&nbsp;allocated&nbsp;block&#34;</span><span class="op" id="1553224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553231">}</span><br>
<span class="lineno">590</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553235">f</span>&nbsp;<span class="op" id="1553237">:=</span>&nbsp;<span class="op" id="1553240">(</span><span class="op" id="1553241">*</span><span class="ident" id="1553242">eface</span><span class="op" id="1553247">)</span><span class="op" id="1553248">(</span><span class="ident" id="1553249">unsafe</span><span class="op" id="1553255">.</span><span class="ident" id="1553256">Pointer</span><span class="op" id="1553263">(</span><span class="op" id="1553264">&amp;</span><span class="ident" id="1553265">finalizer</span><span class="op" id="1553274">)</span><span class="op" id="1553275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553278">ftyp</span>&nbsp;<span class="op" id="1553283">:=</span>&nbsp;<span class="ident" id="1553286">f</span><span class="op" id="1553287">.</span><span class="ident" id="1553288">_type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553295">if</span>&nbsp;<span class="ident" id="1553298">ftyp</span>&nbsp;<span class="op" id="1553303">==</span>&nbsp;<span class="ident" id="1553306">nil</span>&nbsp;<span class="op" id="1553310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1553314">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;and&nbsp;remove&nbsp;finalizer</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553358">mp</span>&nbsp;<span class="op" id="1553361">:=</span>&nbsp;<span class="ident" id="1553364">acquirem</span><span class="op" id="1553372">(</span><span class="op" id="1553373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553377">mp</span><span class="op" id="1553379">.</span><span class="ident" id="1553380">ptrarg</span><span class="op" id="1553386">[</span><span class="num" id="1553387">0</span><span class="op" id="1553388">]</span>&nbsp;<span class="op" id="1553390">=</span>&nbsp;<span class="ident" id="1553392">e</span><span class="op" id="1553393">.</span><span class="ident" id="1553394">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553401">onM</span><span class="op" id="1553404">(</span><span class="ident" id="1553405">removeFinalizer_m</span><span class="op" id="1553422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553426">releasem</span><span class="op" id="1553434">(</span><span class="ident" id="1553435">mp</span><span class="op" id="1553437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553441">return</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553453">if</span>&nbsp;<span class="ident" id="1553456">ftyp</span><span class="op" id="1553460">.</span><span class="ident" id="1553461">kind</span><span class="op" id="1553465">&amp;</span><span class="ident" id="1553466">kindMask</span>&nbsp;<span class="op" id="1553475">!=</span>&nbsp;<span class="ident" id="1553478">kindFunc</span>&nbsp;<span class="op" id="1553487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553491">gothrow</span><span class="op" id="1553498">(</span><span class="string" id="1553499">&#34;runtime.SetFinalizer:&nbsp;second&nbsp;argument&nbsp;is&nbsp;&#34;</span>&nbsp;<span class="op" id="1553543">+</span>&nbsp;<span class="op" id="1553545">*</span><span class="ident" id="1553546">ftyp</span><span class="op" id="1553550">.</span><span class="ident" id="1553551">_string</span>&nbsp;<span class="op" id="1553559">+</span>&nbsp;<span class="string" id="1553561">&#34;,&nbsp;not&nbsp;a&nbsp;function&#34;</span><span class="op" id="1553579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553582">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553585">ft</span>&nbsp;<span class="op" id="1553588">:=</span>&nbsp;<span class="op" id="1553591">(</span><span class="op" id="1553592">*</span><span class="ident" id="1553593">functype</span><span class="op" id="1553601">)</span><span class="op" id="1553602">(</span><span class="ident" id="1553603">unsafe</span><span class="op" id="1553609">.</span><span class="ident" id="1553610">Pointer</span><span class="op" id="1553617">(</span><span class="ident" id="1553618">ftyp</span><span class="op" id="1553622">)</span><span class="op" id="1553623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553626">ins</span>&nbsp;<span class="op" id="1553630">:=</span>&nbsp;<span class="op" id="1553633">*</span><span class="op" id="1553634">(</span><span class="op" id="1553635">*</span><span class="op" id="1553636">[</span><span class="op" id="1553637">]</span><span class="op" id="1553638">*</span><span class="ident" id="1553639">_type</span><span class="op" id="1553644">)</span><span class="op" id="1553645">(</span><span class="ident" id="1553646">unsafe</span><span class="op" id="1553652">.</span><span class="ident" id="1553653">Pointer</span><span class="op" id="1553660">(</span><span class="op" id="1553661">&amp;</span><span class="ident" id="1553662">ft</span><span class="op" id="1553664">.</span><span class="ident" id="1553665">in</span><span class="op" id="1553667">)</span><span class="op" id="1553668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553671">if</span>&nbsp;<span class="ident" id="1553674">ft</span><span class="op" id="1553676">.</span><span class="ident" id="1553677">dotdotdot</span>&nbsp;<span class="op" id="1553687">||</span>&nbsp;<span class="builtinfunc" id="1553690">len</span><span class="op" id="1553693">(</span><span class="ident" id="1553694">ins</span><span class="op" id="1553697">)</span>&nbsp;<span class="op" id="1553699">!=</span>&nbsp;<span class="num" id="1553702">1</span>&nbsp;<span class="op" id="1553704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553708">gothrow</span><span class="op" id="1553715">(</span><span class="string" id="1553716">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1553753">+</span>&nbsp;<span class="op" id="1553755">*</span><span class="ident" id="1553756">etyp</span><span class="op" id="1553760">.</span><span class="ident" id="1553761">_string</span>&nbsp;<span class="op" id="1553769">+</span>&nbsp;<span class="string" id="1553771">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1553788">+</span>&nbsp;<span class="op" id="1553790">*</span><span class="ident" id="1553791">ftyp</span><span class="op" id="1553795">.</span><span class="ident" id="1553796">_string</span><span class="op" id="1553803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1553806">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1553809">fint</span>&nbsp;<span class="op" id="1553814">:=</span>&nbsp;<span class="ident" id="1553817">ins</span><span class="op" id="1553820">[</span><span class="num" id="1553821">0</span><span class="op" id="1553822">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553825">switch</span>&nbsp;<span class="op" id="1553832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553835">case</span>&nbsp;<span class="ident" id="1553840">fint</span>&nbsp;<span class="op" id="1553845">==</span>&nbsp;<span class="ident" id="1553848">etyp</span><span class="op" id="1553852">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1553856">//&nbsp;ok&nbsp;-&nbsp;same&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553876">goto</span>&nbsp;<span class="ident" id="1553881">okarg</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553888">case</span>&nbsp;<span class="ident" id="1553893">fint</span><span class="op" id="1553897">.</span><span class="ident" id="1553898">kind</span><span class="op" id="1553902">&amp;</span><span class="ident" id="1553903">kindMask</span>&nbsp;<span class="op" id="1553912">==</span>&nbsp;<span class="ident" id="1553915">kindPtr</span><span class="op" id="1553922">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1553926">if</span>&nbsp;<span class="op" id="1553929">(</span><span class="ident" id="1553930">fint</span><span class="op" id="1553934">.</span><span class="ident" id="1553935">x</span>&nbsp;<span class="op" id="1553937">==</span>&nbsp;<span class="ident" id="1553940">nil</span>&nbsp;<span class="op" id="1553944">||</span>&nbsp;<span class="ident" id="1553947">fint</span><span class="op" id="1553951">.</span><span class="ident" id="1553952">x</span><span class="op" id="1553953">.</span><span class="ident" id="1553954">name</span>&nbsp;<span class="op" id="1553959">==</span>&nbsp;<span class="ident" id="1553962">nil</span>&nbsp;<span class="op" id="1553966">||</span>&nbsp;<span class="ident" id="1553969">etyp</span><span class="op" id="1553973">.</span><span class="ident" id="1553974">x</span>&nbsp;<span class="op" id="1553976">==</span>&nbsp;<span class="ident" id="1553979">nil</span>&nbsp;<span class="op" id="1553983">||</span>&nbsp;<span class="ident" id="1553986">etyp</span><span class="op" id="1553990">.</span><span class="ident" id="1553991">x</span><span class="op" id="1553992">.</span><span class="ident" id="1553993">name</span>&nbsp;<span class="op" id="1553998">==</span>&nbsp;<span class="ident" id="1554001">nil</span><span class="op" id="1554004">)</span>&nbsp;<span class="op" id="1554006">&amp;&amp;</span>&nbsp;<span class="op" id="1554009">(</span><span class="op" id="1554010">*</span><span class="ident" id="1554011">ptrtype</span><span class="op" id="1554018">)</span><span class="op" id="1554019">(</span><span class="ident" id="1554020">unsafe</span><span class="op" id="1554026">.</span><span class="ident" id="1554027">Pointer</span><span class="op" id="1554034">(</span><span class="ident" id="1554035">fint</span><span class="op" id="1554039">)</span><span class="op" id="1554040">)</span><span class="op" id="1554041">.</span><span class="ident" id="1554042">elem</span>&nbsp;<span class="op" id="1554047">==</span>&nbsp;<span class="ident" id="1554050">ot</span><span class="op" id="1554052">.</span><span class="ident" id="1554053">elem</span>&nbsp;<span class="op" id="1554058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554063">//&nbsp;ok&nbsp;-&nbsp;not&nbsp;same&nbsp;type,&nbsp;but&nbsp;both&nbsp;pointers,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554108">//&nbsp;one&nbsp;or&nbsp;the&nbsp;other&nbsp;is&nbsp;unnamed,&nbsp;and&nbsp;same&nbsp;element&nbsp;type,&nbsp;so&nbsp;assignable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554181">goto</span>&nbsp;<span class="ident" id="1554186">okarg</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554197">case</span>&nbsp;<span class="ident" id="1554202">fint</span><span class="op" id="1554206">.</span><span class="ident" id="1554207">kind</span><span class="op" id="1554211">&amp;</span><span class="ident" id="1554212">kindMask</span>&nbsp;<span class="op" id="1554221">==</span>&nbsp;<span class="ident" id="1554224">kindInterface</span><span class="op" id="1554237">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554241">ityp</span>&nbsp;<span class="op" id="1554246">:=</span>&nbsp;<span class="op" id="1554249">(</span><span class="op" id="1554250">*</span><span class="ident" id="1554251">interfacetype</span><span class="op" id="1554264">)</span><span class="op" id="1554265">(</span><span class="ident" id="1554266">unsafe</span><span class="op" id="1554272">.</span><span class="ident" id="1554273">Pointer</span><span class="op" id="1554280">(</span><span class="ident" id="1554281">fint</span><span class="op" id="1554285">)</span><span class="op" id="1554286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554290">if</span>&nbsp;<span class="builtinfunc" id="1554293">len</span><span class="op" id="1554296">(</span><span class="ident" id="1554297">ityp</span><span class="op" id="1554301">.</span><span class="ident" id="1554302">mhdr</span><span class="op" id="1554306">)</span>&nbsp;<span class="op" id="1554308">==</span>&nbsp;<span class="num" id="1554311">0</span>&nbsp;<span class="op" id="1554313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554318">//&nbsp;ok&nbsp;-&nbsp;satisfies&nbsp;empty&nbsp;interface</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554355">goto</span>&nbsp;<span class="ident" id="1554360">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554372">if</span>&nbsp;<span class="ident" id="1554375">_</span><span class="op" id="1554376">,</span>&nbsp;<span class="ident" id="1554378">ok</span>&nbsp;<span class="op" id="1554381">:=</span>&nbsp;<span class="ident" id="1554384">assertE2I2</span><span class="op" id="1554394">(</span><span class="ident" id="1554395">ityp</span><span class="op" id="1554399">,</span>&nbsp;<span class="ident" id="1554401">obj</span><span class="op" id="1554404">)</span><span class="op" id="1554405">;</span>&nbsp;<span class="ident" id="1554407">ok</span>&nbsp;<span class="op" id="1554410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554415">goto</span>&nbsp;<span class="ident" id="1554420">okarg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554428">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554434">gothrow</span><span class="op" id="1554441">(</span><span class="string" id="1554442">&#34;runtime.SetFinalizer:&nbsp;cannot&nbsp;pass&nbsp;&#34;</span>&nbsp;<span class="op" id="1554479">+</span>&nbsp;<span class="op" id="1554481">*</span><span class="ident" id="1554482">etyp</span><span class="op" id="1554486">.</span><span class="ident" id="1554487">_string</span>&nbsp;<span class="op" id="1554495">+</span>&nbsp;<span class="string" id="1554497">&#34;&nbsp;to&nbsp;finalizer&nbsp;&#34;</span>&nbsp;<span class="op" id="1554514">+</span>&nbsp;<span class="op" id="1554516">*</span><span class="ident" id="1554517">ftyp</span><span class="op" id="1554521">.</span><span class="ident" id="1554522">_string</span><span class="op" id="1554529">)</span><br>
<span class="lineno"></span><span class="ident" id="1554531">okarg</span><span class="op" id="1554536">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554539">//&nbsp;compute&nbsp;size&nbsp;needed&nbsp;for&nbsp;return&nbsp;parameters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554585">nret</span>&nbsp;<span class="op" id="1554590">:=</span>&nbsp;<span class="builtintype" id="1554593">uintptr</span><span class="op" id="1554600">(</span><span class="num" id="1554601">0</span><span class="op" id="1554602">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1554605">for</span>&nbsp;<span class="ident" id="1554609">_</span><span class="op" id="1554610">,</span>&nbsp;<span class="ident" id="1554612">t</span>&nbsp;<span class="op" id="1554614">:=</span>&nbsp;<span class="keyword" id="1554617">range</span>&nbsp;<span class="op" id="1554623">*</span><span class="op" id="1554624">(</span><span class="op" id="1554625">*</span><span class="op" id="1554626">[</span><span class="op" id="1554627">]</span><span class="op" id="1554628">*</span><span class="ident" id="1554629">_type</span><span class="op" id="1554634">)</span><span class="op" id="1554635">(</span><span class="ident" id="1554636">unsafe</span><span class="op" id="1554642">.</span><span class="ident" id="1554643">Pointer</span><span class="op" id="1554650">(</span><span class="op" id="1554651">&amp;</span><span class="ident" id="1554652">ft</span><span class="op" id="1554654">.</span><span class="ident" id="1554655">out</span><span class="op" id="1554658">)</span><span class="op" id="1554659">)</span>&nbsp;<span class="op" id="1554661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554665">nret</span>&nbsp;<span class="op" id="1554670">=</span>&nbsp;<span class="ident" id="1554672">round</span><span class="op" id="1554677">(</span><span class="ident" id="1554678">nret</span><span class="op" id="1554682">,</span>&nbsp;<span class="builtintype" id="1554684">uintptr</span><span class="op" id="1554691">(</span><span class="ident" id="1554692">t</span><span class="op" id="1554693">.</span><span class="ident" id="1554694">align</span><span class="op" id="1554699">)</span><span class="op" id="1554700">)</span>&nbsp;<span class="op" id="1554702">+</span>&nbsp;<span class="builtintype" id="1554704">uintptr</span><span class="op" id="1554711">(</span><span class="ident" id="1554712">t</span><span class="op" id="1554713">.</span><span class="ident" id="1554714">size</span><span class="op" id="1554718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1554721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554724">nret</span>&nbsp;<span class="op" id="1554729">=</span>&nbsp;<span class="ident" id="1554731">round</span><span class="op" id="1554736">(</span><span class="ident" id="1554737">nret</span><span class="op" id="1554741">,</span>&nbsp;<span class="ident" id="1554743">ptrSize</span><span class="op" id="1554750">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554754">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;have&nbsp;a&nbsp;finalizer&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554798">createfing</span><span class="op" id="1554808">(</span><span class="op" id="1554809">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1554813">//&nbsp;switch&nbsp;to&nbsp;M&nbsp;stack&nbsp;to&nbsp;add&nbsp;finalizer&nbsp;record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554859">mp</span>&nbsp;<span class="op" id="1554862">:=</span>&nbsp;<span class="ident" id="1554865">acquirem</span><span class="op" id="1554873">(</span><span class="op" id="1554874">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554877">mp</span><span class="op" id="1554879">.</span><span class="ident" id="1554880">ptrarg</span><span class="op" id="1554886">[</span><span class="num" id="1554887">0</span><span class="op" id="1554888">]</span>&nbsp;<span class="op" id="1554890">=</span>&nbsp;<span class="ident" id="1554892">f</span><span class="op" id="1554893">.</span><span class="ident" id="1554894">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554900">mp</span><span class="op" id="1554902">.</span><span class="ident" id="1554903">ptrarg</span><span class="op" id="1554909">[</span><span class="num" id="1554910">1</span><span class="op" id="1554911">]</span>&nbsp;<span class="op" id="1554913">=</span>&nbsp;<span class="ident" id="1554915">e</span><span class="op" id="1554916">.</span><span class="ident" id="1554917">data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554923">mp</span><span class="op" id="1554925">.</span><span class="ident" id="1554926">scalararg</span><span class="op" id="1554935">[</span><span class="num" id="1554936">0</span><span class="op" id="1554937">]</span>&nbsp;<span class="op" id="1554939">=</span>&nbsp;<span class="ident" id="1554941">nret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554947">mp</span><span class="op" id="1554949">.</span><span class="ident" id="1554950">ptrarg</span><span class="op" id="1554956">[</span><span class="num" id="1554957">2</span><span class="op" id="1554958">]</span>&nbsp;<span class="op" id="1554960">=</span>&nbsp;<span class="ident" id="1554962">unsafe</span><span class="op" id="1554968">.</span><span class="ident" id="1554969">Pointer</span><span class="op" id="1554976">(</span><span class="ident" id="1554977">fint</span><span class="op" id="1554981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1554984">mp</span><span class="op" id="1554986">.</span><span class="ident" id="1554987">ptrarg</span><span class="op" id="1554993">[</span><span class="num" id="1554994">3</span><span class="op" id="1554995">]</span>&nbsp;<span class="op" id="1554997">=</span>&nbsp;<span class="ident" id="1554999">unsafe</span><span class="op" id="1555005">.</span><span class="ident" id="1555006">Pointer</span><span class="op" id="1555013">(</span><span class="ident" id="1555014">ot</span><span class="op" id="1555016">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555019">onM</span><span class="op" id="1555022">(</span><span class="ident" id="1555023">setFinalizer_m</span><span class="op" id="1555037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555040">if</span>&nbsp;<span class="ident" id="1555043">mp</span><span class="op" id="1555045">.</span><span class="ident" id="1555046">scalararg</span><span class="op" id="1555055">[</span><span class="num" id="1555056">0</span><span class="op" id="1555057">]</span>&nbsp;<span class="op" id="1555059">!=</span>&nbsp;<span class="num" id="1555062">1</span>&nbsp;<span class="op" id="1555064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555068">gothrow</span><span class="op" id="1555075">(</span><span class="string" id="1555076">&#34;runtime.SetFinalizer:&nbsp;finalizer&nbsp;already&nbsp;set&#34;</span><span class="op" id="1555121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555127">releasem</span><span class="op" id="1555135">(</span><span class="ident" id="1555136">mp</span><span class="op" id="1555138">)</span><br>
<span class="lineno">655</span><span class="op" id="1555140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1555143">//&nbsp;round&nbsp;n&nbsp;up&nbsp;to&nbsp;a&nbsp;multiple&nbsp;of&nbsp;a.&nbsp;&nbsp;a&nbsp;must&nbsp;be&nbsp;a&nbsp;power&nbsp;of&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword" id="1555202">func</span>&nbsp;<span class="ident" id="1555207">round</span><span class="op" id="1555212">(</span><span class="ident" id="1555213">n</span><span class="op" id="1555214">,</span>&nbsp;<span class="ident" id="1555216">a</span>&nbsp;<span class="builtintype" id="1555218">uintptr</span><span class="op" id="1555225">)</span>&nbsp;<span class="builtintype" id="1555227">uintptr</span>&nbsp;<span class="op" id="1555235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555238">return</span>&nbsp;<span class="op" id="1555245">(</span><span class="ident" id="1555246">n</span>&nbsp;<span class="op" id="1555248">+</span>&nbsp;<span class="ident" id="1555250">a</span>&nbsp;<span class="op" id="1555252">-</span>&nbsp;<span class="num" id="1555254">1</span><span class="op" id="1555255">)</span>&nbsp;<span class="op" id="1555257">&amp;^</span>&nbsp;<span class="op" id="1555260">(</span><span class="ident" id="1555261">a</span>&nbsp;<span class="op" id="1555263">-</span>&nbsp;<span class="num" id="1555265">1</span><span class="op" id="1555266">)</span><br>
<span class="lineno">660</span><span class="op" id="1555268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1555271">//&nbsp;Look&nbsp;up&nbsp;pointer&nbsp;v&nbsp;in&nbsp;heap.&nbsp;&nbsp;Return&nbsp;the&nbsp;span&nbsp;containing&nbsp;the&nbsp;object,</span><br>
<span class="lineno"></span><span class="comment" id="1555341">//&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;object,&nbsp;and&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;If&nbsp;the&nbsp;object</span><br>
<span class="lineno"></span><span class="comment" id="1555412">//&nbsp;does&nbsp;not&nbsp;exist,&nbsp;return&nbsp;nil,&nbsp;nil,&nbsp;0.</span><br>
<span class="lineno">665</span><span class="keyword" id="1555451">func</span>&nbsp;<span class="ident" id="1555456">findObject</span><span class="op" id="1555466">(</span><span class="ident" id="1555467">v</span>&nbsp;<span class="ident" id="1555469">unsafe</span><span class="op" id="1555475">.</span><span class="ident" id="1555476">Pointer</span><span class="op" id="1555483">)</span>&nbsp;<span class="op" id="1555485">(</span><span class="ident" id="1555486">s</span>&nbsp;<span class="op" id="1555488">*</span><span class="ident" id="1555489">mspan</span><span class="op" id="1555494">,</span>&nbsp;<span class="ident" id="1555496">x</span>&nbsp;<span class="ident" id="1555498">unsafe</span><span class="op" id="1555504">.</span><span class="ident" id="1555505">Pointer</span><span class="op" id="1555512">,</span>&nbsp;<span class="ident" id="1555514">n</span>&nbsp;<span class="builtintype" id="1555516">uintptr</span><span class="op" id="1555523">)</span>&nbsp;<span class="op" id="1555525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555528">c</span>&nbsp;<span class="op" id="1555530">:=</span>&nbsp;<span class="ident" id="1555533">gomcache</span><span class="op" id="1555541">(</span><span class="op" id="1555542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555545">c</span><span class="op" id="1555546">.</span><span class="ident" id="1555547">local_nlookup</span><span class="op" id="1555560">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555564">if</span>&nbsp;<span class="ident" id="1555567">ptrSize</span>&nbsp;<span class="op" id="1555575">==</span>&nbsp;<span class="num" id="1555578">4</span>&nbsp;<span class="op" id="1555580">&amp;&amp;</span>&nbsp;<span class="ident" id="1555583">c</span><span class="op" id="1555584">.</span><span class="ident" id="1555585">local_nlookup</span>&nbsp;<span class="op" id="1555599">&gt;=</span>&nbsp;<span class="num" id="1555602">1</span><span class="op" id="1555603">&lt;&lt;</span><span class="num" id="1555605">30</span>&nbsp;<span class="op" id="1555608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555612">//&nbsp;purge&nbsp;cache&nbsp;stats&nbsp;to&nbsp;prevent&nbsp;overflow</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555655">lock</span><span class="op" id="1555659">(</span><span class="op" id="1555660">&amp;</span><span class="ident" id="1555661">mheap_</span><span class="op" id="1555667">.</span><span class="ident" id="1555668">lock</span><span class="op" id="1555672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555676">purgecachedstats</span><span class="op" id="1555692">(</span><span class="ident" id="1555693">c</span><span class="op" id="1555694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555698">unlock</span><span class="op" id="1555704">(</span><span class="op" id="1555705">&amp;</span><span class="ident" id="1555706">mheap_</span><span class="op" id="1555712">.</span><span class="ident" id="1555713">lock</span><span class="op" id="1555717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1555724">//&nbsp;find&nbsp;span</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555738">arena_start</span>&nbsp;<span class="op" id="1555750">:=</span>&nbsp;<span class="builtintype" id="1555753">uintptr</span><span class="op" id="1555760">(</span><span class="ident" id="1555761">unsafe</span><span class="op" id="1555767">.</span><span class="ident" id="1555768">Pointer</span><span class="op" id="1555775">(</span><span class="ident" id="1555776">mheap_</span><span class="op" id="1555782">.</span><span class="ident" id="1555783">arena_start</span><span class="op" id="1555794">)</span><span class="op" id="1555795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555798">arena_used</span>&nbsp;<span class="op" id="1555809">:=</span>&nbsp;<span class="builtintype" id="1555812">uintptr</span><span class="op" id="1555819">(</span><span class="ident" id="1555820">unsafe</span><span class="op" id="1555826">.</span><span class="ident" id="1555827">Pointer</span><span class="op" id="1555834">(</span><span class="ident" id="1555835">mheap_</span><span class="op" id="1555841">.</span><span class="ident" id="1555842">arena_used</span><span class="op" id="1555852">)</span><span class="op" id="1555853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555856">if</span>&nbsp;<span class="builtintype" id="1555859">uintptr</span><span class="op" id="1555866">(</span><span class="ident" id="1555867">v</span><span class="op" id="1555868">)</span>&nbsp;<span class="op" id="1555870">&lt;</span>&nbsp;<span class="ident" id="1555872">arena_start</span>&nbsp;<span class="op" id="1555884">||</span>&nbsp;<span class="builtintype" id="1555887">uintptr</span><span class="op" id="1555894">(</span><span class="ident" id="1555895">v</span><span class="op" id="1555896">)</span>&nbsp;<span class="op" id="1555898">&gt;=</span>&nbsp;<span class="ident" id="1555901">arena_used</span>&nbsp;<span class="op" id="1555912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1555916">return</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1555924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555927">p</span>&nbsp;<span class="op" id="1555929">:=</span>&nbsp;<span class="builtintype" id="1555932">uintptr</span><span class="op" id="1555939">(</span><span class="ident" id="1555940">v</span><span class="op" id="1555941">)</span>&nbsp;<span class="op" id="1555943">&gt;&gt;</span>&nbsp;<span class="ident" id="1555946">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555957">q</span>&nbsp;<span class="op" id="1555959">:=</span>&nbsp;<span class="ident" id="1555962">p</span>&nbsp;<span class="op" id="1555964">-</span>&nbsp;<span class="ident" id="1555966">arena_start</span><span class="op" id="1555977">&gt;&gt;</span><span class="ident" id="1555979">pageShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1555990">s</span>&nbsp;<span class="op" id="1555992">=</span>&nbsp;<span class="op" id="1555994">*</span><span class="op" id="1555995">(</span><span class="op" id="1555996">*</span><span class="op" id="1555997">*</span><span class="ident" id="1555998">mspan</span><span class="op" id="1556003">)</span><span class="op" id="1556004">(</span><span class="ident" id="1556005">add</span><span class="op" id="1556008">(</span><span class="ident" id="1556009">unsafe</span><span class="op" id="1556015">.</span><span class="ident" id="1556016">Pointer</span><span class="op" id="1556023">(</span><span class="ident" id="1556024">mheap_</span><span class="op" id="1556030">.</span><span class="ident" id="1556031">spans</span><span class="op" id="1556036">)</span><span class="op" id="1556037">,</span>&nbsp;<span class="ident" id="1556039">q</span><span class="op" id="1556040">*</span><span class="ident" id="1556041">ptrSize</span><span class="op" id="1556048">)</span><span class="op" id="1556049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556052">if</span>&nbsp;<span class="ident" id="1556055">s</span>&nbsp;<span class="op" id="1556057">==</span>&nbsp;<span class="ident" id="1556060">nil</span>&nbsp;<span class="op" id="1556064">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556068">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556079">x</span>&nbsp;<span class="op" id="1556081">=</span>&nbsp;<span class="ident" id="1556083">unsafe</span><span class="op" id="1556089">.</span><span class="ident" id="1556090">Pointer</span><span class="op" id="1556097">(</span><span class="builtintype" id="1556098">uintptr</span><span class="op" id="1556105">(</span><span class="ident" id="1556106">s</span><span class="op" id="1556107">.</span><span class="ident" id="1556108">start</span><span class="op" id="1556113">)</span>&nbsp;<span class="op" id="1556115">&lt;&lt;</span>&nbsp;<span class="ident" id="1556118">pageShift</span><span class="op" id="1556127">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556131">if</span>&nbsp;<span class="builtintype" id="1556134">uintptr</span><span class="op" id="1556141">(</span><span class="ident" id="1556142">v</span><span class="op" id="1556143">)</span>&nbsp;<span class="op" id="1556145">&lt;</span>&nbsp;<span class="builtintype" id="1556147">uintptr</span><span class="op" id="1556154">(</span><span class="ident" id="1556155">x</span><span class="op" id="1556156">)</span>&nbsp;<span class="op" id="1556158">||</span>&nbsp;<span class="builtintype" id="1556161">uintptr</span><span class="op" id="1556168">(</span><span class="ident" id="1556169">v</span><span class="op" id="1556170">)</span>&nbsp;<span class="op" id="1556172">&gt;=</span>&nbsp;<span class="builtintype" id="1556175">uintptr</span><span class="op" id="1556182">(</span><span class="ident" id="1556183">unsafe</span><span class="op" id="1556189">.</span><span class="ident" id="1556190">Pointer</span><span class="op" id="1556197">(</span><span class="ident" id="1556198">s</span><span class="op" id="1556199">.</span><span class="ident" id="1556200">limit</span><span class="op" id="1556205">)</span><span class="op" id="1556206">)</span>&nbsp;<span class="op" id="1556208">||</span>&nbsp;<span class="ident" id="1556211">s</span><span class="op" id="1556212">.</span><span class="ident" id="1556213">state</span>&nbsp;<span class="op" id="1556219">!=</span>&nbsp;<span class="ident" id="1556222">mSpanInUse</span>&nbsp;<span class="op" id="1556233">{</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556237">s</span>&nbsp;<span class="op" id="1556239">=</span>&nbsp;<span class="ident" id="1556241">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556247">x</span>&nbsp;<span class="op" id="1556249">=</span>&nbsp;<span class="ident" id="1556251">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556257">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556269">n</span>&nbsp;<span class="op" id="1556271">=</span>&nbsp;<span class="builtintype" id="1556273">uintptr</span><span class="op" id="1556280">(</span><span class="ident" id="1556281">s</span><span class="op" id="1556282">.</span><span class="ident" id="1556283">elemsize</span><span class="op" id="1556291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556294">if</span>&nbsp;<span class="ident" id="1556297">s</span><span class="op" id="1556298">.</span><span class="ident" id="1556299">sizeclass</span>&nbsp;<span class="op" id="1556309">!=</span>&nbsp;<span class="num" id="1556312">0</span>&nbsp;<span class="op" id="1556314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556318">x</span>&nbsp;<span class="op" id="1556320">=</span>&nbsp;<span class="ident" id="1556322">add</span><span class="op" id="1556325">(</span><span class="ident" id="1556326">x</span><span class="op" id="1556327">,</span>&nbsp;<span class="op" id="1556329">(</span><span class="builtintype" id="1556330">uintptr</span><span class="op" id="1556337">(</span><span class="ident" id="1556338">v</span><span class="op" id="1556339">)</span><span class="op" id="1556340">-</span><span class="builtintype" id="1556341">uintptr</span><span class="op" id="1556348">(</span><span class="ident" id="1556349">x</span><span class="op" id="1556350">)</span><span class="op" id="1556351">)</span><span class="op" id="1556352">/</span><span class="ident" id="1556353">n</span><span class="op" id="1556354">*</span><span class="ident" id="1556355">n</span><span class="op" id="1556356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556362">return</span><br>
<span class="lineno">700</span><span class="op" id="1556369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1556372">var</span>&nbsp;<span class="ident" id="1556376">fingCreate</span>&nbsp;<span class="builtintype" id="1556387">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1556395">func</span>&nbsp;<span class="ident" id="1556400">createfing</span><span class="op" id="1556410">(</span><span class="op" id="1556411">)</span>&nbsp;<span class="op" id="1556413">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1556416">//&nbsp;start&nbsp;the&nbsp;finalizer&nbsp;goroutine&nbsp;exactly&nbsp;once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556463">if</span>&nbsp;<span class="ident" id="1556466">fingCreate</span>&nbsp;<span class="op" id="1556477">==</span>&nbsp;<span class="num" id="1556480">0</span>&nbsp;<span class="op" id="1556482">&amp;&amp;</span>&nbsp;<span class="ident" id="1556485">cas</span><span class="op" id="1556488">(</span><span class="op" id="1556489">&amp;</span><span class="ident" id="1556490">fingCreate</span><span class="op" id="1556500">,</span>&nbsp;<span class="num" id="1556502">0</span><span class="op" id="1556503">,</span>&nbsp;<span class="num" id="1556505">1</span><span class="op" id="1556506">)</span>&nbsp;<span class="op" id="1556508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556512">go</span>&nbsp;<span class="ident" id="1556515">runfinq</span><span class="op" id="1556522">(</span><span class="op" id="1556523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556526">}</span><br>
<span class="lineno"></span><span class="op" id="1556528">}</span><br>
<span class="lineno">710</span><br>
<span class="lineno"></span><span class="comment" id="1556531">//&nbsp;This&nbsp;is&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;runs&nbsp;all&nbsp;of&nbsp;the&nbsp;finalizers</span><br>
<span class="lineno"></span><span class="keyword" id="1556588">func</span>&nbsp;<span class="ident" id="1556593">runfinq</span><span class="op" id="1556600">(</span><span class="op" id="1556601">)</span>&nbsp;<span class="op" id="1556603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556606">var</span>&nbsp;<span class="op" id="1556610">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556614">frame</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556623">unsafe</span><span class="op" id="1556629">.</span><span class="ident" id="1556630">Pointer</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556640">framecap</span>&nbsp;<span class="builtintype" id="1556649">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556658">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556662">for</span>&nbsp;<span class="op" id="1556666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556670">lock</span><span class="op" id="1556674">(</span><span class="op" id="1556675">&amp;</span><span class="ident" id="1556676">finlock</span><span class="op" id="1556683">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556687">fb</span>&nbsp;<span class="op" id="1556690">:=</span>&nbsp;<span class="ident" id="1556693">finq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556700">finq</span>&nbsp;<span class="op" id="1556705">=</span>&nbsp;<span class="ident" id="1556707">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556713">if</span>&nbsp;<span class="ident" id="1556716">fb</span>&nbsp;<span class="op" id="1556719">==</span>&nbsp;<span class="ident" id="1556722">nil</span>&nbsp;<span class="op" id="1556726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556731">gp</span>&nbsp;<span class="op" id="1556734">:=</span>&nbsp;<span class="ident" id="1556737">getg</span><span class="op" id="1556741">(</span><span class="op" id="1556742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556747">fing</span>&nbsp;<span class="op" id="1556752">=</span>&nbsp;<span class="ident" id="1556754">gp</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556760">fingwait</span>&nbsp;<span class="op" id="1556769">=</span>&nbsp;<span class="builtintype" id="1556771">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556779">gp</span><span class="op" id="1556781">.</span><span class="ident" id="1556782">issystem</span>&nbsp;<span class="op" id="1556791">=</span>&nbsp;<span class="builtintype" id="1556793">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556801">goparkunlock</span><span class="op" id="1556813">(</span><span class="op" id="1556814">&amp;</span><span class="ident" id="1556815">finlock</span><span class="op" id="1556822">,</span>&nbsp;<span class="string" id="1556824">&#34;finalizer&nbsp;wait&#34;</span><span class="op" id="1556840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556845">gp</span><span class="op" id="1556847">.</span><span class="ident" id="1556848">issystem</span>&nbsp;<span class="op" id="1556857">=</span>&nbsp;<span class="builtintype" id="1556859">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556868">continue</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556883">unlock</span><span class="op" id="1556889">(</span><span class="op" id="1556890">&amp;</span><span class="ident" id="1556891">finlock</span><span class="op" id="1556898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556902">if</span>&nbsp;<span class="ident" id="1556905">raceenabled</span>&nbsp;<span class="op" id="1556917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1556922">racefingo</span><span class="op" id="1556931">(</span><span class="op" id="1556932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1556936">}</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556940">for</span>&nbsp;<span class="ident" id="1556944">fb</span>&nbsp;<span class="op" id="1556947">!=</span>&nbsp;<span class="ident" id="1556950">nil</span>&nbsp;<span class="op" id="1556954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1556959">for</span>&nbsp;<span class="ident" id="1556963">i</span>&nbsp;<span class="op" id="1556965">:=</span>&nbsp;<span class="builtintype" id="1556968">int32</span><span class="op" id="1556973">(</span><span class="num" id="1556974">0</span><span class="op" id="1556975">)</span><span class="op" id="1556976">;</span>&nbsp;<span class="ident" id="1556978">i</span>&nbsp;<span class="op" id="1556980">&lt;</span>&nbsp;<span class="ident" id="1556982">fb</span><span class="op" id="1556984">.</span><span class="ident" id="1556985">cnt</span><span class="op" id="1556988">;</span>&nbsp;<span class="ident" id="1556990">i</span><span class="op" id="1556991">++</span>&nbsp;<span class="op" id="1556994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557000">f</span>&nbsp;<span class="op" id="1557002">:=</span>&nbsp;<span class="op" id="1557005">(</span><span class="op" id="1557006">*</span><span class="ident" id="1557007">finalizer</span><span class="op" id="1557016">)</span><span class="op" id="1557017">(</span><span class="ident" id="1557018">add</span><span class="op" id="1557021">(</span><span class="ident" id="1557022">unsafe</span><span class="op" id="1557028">.</span><span class="ident" id="1557029">Pointer</span><span class="op" id="1557036">(</span><span class="op" id="1557037">&amp;</span><span class="ident" id="1557038">fb</span><span class="op" id="1557040">.</span><span class="ident" id="1557041">fin</span><span class="op" id="1557044">)</span><span class="op" id="1557045">,</span>&nbsp;<span class="builtintype" id="1557047">uintptr</span><span class="op" id="1557054">(</span><span class="ident" id="1557055">i</span><span class="op" id="1557056">)</span><span class="op" id="1557057">*</span><span class="ident" id="1557058">unsafe</span><span class="op" id="1557064">.</span><span class="ident" id="1557065">Sizeof</span><span class="op" id="1557071">(</span><span class="ident" id="1557072">finalizer</span><span class="op" id="1557081">{</span><span class="op" id="1557082">}</span><span class="op" id="1557083">)</span><span class="op" id="1557084">)</span><span class="op" id="1557085">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557092">framesz</span>&nbsp;<span class="op" id="1557100">:=</span>&nbsp;<span class="ident" id="1557103">unsafe</span><span class="op" id="1557109">.</span><span class="ident" id="1557110">Sizeof</span><span class="op" id="1557116">(</span><span class="op" id="1557117">(</span><span class="keyword" id="1557118">interface</span><span class="op" id="1557127">{</span><span class="op" id="1557128">}</span><span class="op" id="1557129">)</span><span class="op" id="1557130">(</span><span class="ident" id="1557131">nil</span><span class="op" id="1557134">)</span><span class="op" id="1557135">)</span>&nbsp;<span class="op" id="1557137">+</span>&nbsp;<span class="builtintype" id="1557139">uintptr</span><span class="op" id="1557146">(</span><span class="ident" id="1557147">f</span><span class="op" id="1557148">.</span><span class="ident" id="1557149">nret</span><span class="op" id="1557153">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557159">if</span>&nbsp;<span class="ident" id="1557162">framecap</span>&nbsp;<span class="op" id="1557171">&lt;</span>&nbsp;<span class="ident" id="1557173">framesz</span>&nbsp;<span class="op" id="1557181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557188">//&nbsp;The&nbsp;frame&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557252">//&nbsp;all&nbsp;not&nbsp;yet&nbsp;finalized&nbsp;objects&nbsp;are&nbsp;stored&nbsp;in&nbsp;finq.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557310">//&nbsp;If&nbsp;we&nbsp;do&nbsp;not&nbsp;mark&nbsp;it&nbsp;as&nbsp;FlagNoScan,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557354">//&nbsp;the&nbsp;last&nbsp;finalized&nbsp;object&nbsp;is&nbsp;not&nbsp;collected.</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557406">frame</span>&nbsp;<span class="op" id="1557412">=</span>&nbsp;<span class="ident" id="1557414">mallocgc</span><span class="op" id="1557422">(</span><span class="ident" id="1557423">framesz</span><span class="op" id="1557430">,</span>&nbsp;<span class="ident" id="1557432">nil</span><span class="op" id="1557435">,</span>&nbsp;<span class="ident" id="1557437">flagNoScan</span><span class="op" id="1557447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557454">framecap</span>&nbsp;<span class="op" id="1557463">=</span>&nbsp;<span class="ident" id="1557465">framesz</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557484">if</span>&nbsp;<span class="ident" id="1557487">f</span><span class="op" id="1557488">.</span><span class="ident" id="1557489">fint</span>&nbsp;<span class="op" id="1557494">==</span>&nbsp;<span class="ident" id="1557497">nil</span>&nbsp;<span class="op" id="1557501">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557508">gothrow</span><span class="op" id="1557515">(</span><span class="string" id="1557516">&#34;missing&nbsp;type&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1557541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557553">switch</span>&nbsp;<span class="ident" id="1557560">f</span><span class="op" id="1557561">.</span><span class="ident" id="1557562">fint</span><span class="op" id="1557566">.</span><span class="ident" id="1557567">kind</span>&nbsp;<span class="op" id="1557572">&amp;</span>&nbsp;<span class="ident" id="1557574">kindMask</span>&nbsp;<span class="op" id="1557583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557589">case</span>&nbsp;<span class="ident" id="1557594">kindPtr</span><span class="op" id="1557601">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557608">//&nbsp;direct&nbsp;use&nbsp;of&nbsp;pointer</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557638">*</span><span class="op" id="1557639">(</span><span class="op" id="1557640">*</span><span class="ident" id="1557641">unsafe</span><span class="op" id="1557647">.</span><span class="ident" id="1557648">Pointer</span><span class="op" id="1557655">)</span><span class="op" id="1557656">(</span><span class="ident" id="1557657">frame</span><span class="op" id="1557662">)</span>&nbsp;<span class="op" id="1557664">=</span>&nbsp;<span class="ident" id="1557666">f</span><span class="op" id="1557667">.</span><span class="ident" id="1557668">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557676">case</span>&nbsp;<span class="ident" id="1557681">kindInterface</span><span class="op" id="1557694">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1557701">ityp</span>&nbsp;<span class="op" id="1557706">:=</span>&nbsp;<span class="op" id="1557709">(</span><span class="op" id="1557710">*</span><span class="ident" id="1557711">interfacetype</span><span class="op" id="1557724">)</span><span class="op" id="1557725">(</span><span class="ident" id="1557726">unsafe</span><span class="op" id="1557732">.</span><span class="ident" id="1557733">Pointer</span><span class="op" id="1557740">(</span><span class="ident" id="1557741">f</span><span class="op" id="1557742">.</span><span class="ident" id="1557743">fint</span><span class="op" id="1557747">)</span><span class="op" id="1557748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557755">//&nbsp;set&nbsp;up&nbsp;with&nbsp;empty&nbsp;interface</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557791">(</span><span class="op" id="1557792">*</span><span class="ident" id="1557793">eface</span><span class="op" id="1557798">)</span><span class="op" id="1557799">(</span><span class="ident" id="1557800">frame</span><span class="op" id="1557805">)</span><span class="op" id="1557806">.</span><span class="ident" id="1557807">_type</span>&nbsp;<span class="op" id="1557813">=</span>&nbsp;<span class="op" id="1557815">&amp;</span><span class="ident" id="1557816">f</span><span class="op" id="1557817">.</span><span class="ident" id="1557818">ot</span><span class="op" id="1557820">.</span><span class="ident" id="1557821">typ</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1557830">(</span><span class="op" id="1557831">*</span><span class="ident" id="1557832">eface</span><span class="op" id="1557837">)</span><span class="op" id="1557838">(</span><span class="ident" id="1557839">frame</span><span class="op" id="1557844">)</span><span class="op" id="1557845">.</span><span class="ident" id="1557846">data</span>&nbsp;<span class="op" id="1557851">=</span>&nbsp;<span class="ident" id="1557853">f</span><span class="op" id="1557854">.</span><span class="ident" id="1557855">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1557864">if</span>&nbsp;<span class="builtinfunc" id="1557867">len</span><span class="op" id="1557870">(</span><span class="ident" id="1557871">ityp</span><span class="op" id="1557875">.</span><span class="ident" id="1557876">mhdr</span><span class="op" id="1557880">)</span>&nbsp;<span class="op" id="1557882">!=</span>&nbsp;<span class="num" id="1557885">0</span>&nbsp;<span class="op" id="1557887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557895">//&nbsp;convert&nbsp;to&nbsp;interface&nbsp;with&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1557938">//&nbsp;this&nbsp;conversion&nbsp;is&nbsp;guaranteed&nbsp;to&nbsp;succeed&nbsp;-&nbsp;we&nbsp;checked&nbsp;in&nbsp;SetFinalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558017">*</span><span class="op" id="1558018">(</span><span class="op" id="1558019">*</span><span class="ident" id="1558020">fInterface</span><span class="op" id="1558030">)</span><span class="op" id="1558031">(</span><span class="ident" id="1558032">frame</span><span class="op" id="1558037">)</span>&nbsp;<span class="op" id="1558039">=</span>&nbsp;<span class="ident" id="1558041">assertE2I</span><span class="op" id="1558050">(</span><span class="ident" id="1558051">ityp</span><span class="op" id="1558055">,</span>&nbsp;<span class="op" id="1558057">*</span><span class="op" id="1558058">(</span><span class="op" id="1558059">*</span><span class="keyword" id="1558060">interface</span><span class="op" id="1558069">{</span><span class="op" id="1558070">}</span><span class="op" id="1558071">)</span><span class="op" id="1558072">(</span><span class="ident" id="1558073">frame</span><span class="op" id="1558078">)</span><span class="op" id="1558079">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558092">default</span><span class="op" id="1558099">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558106">gothrow</span><span class="op" id="1558113">(</span><span class="string" id="1558114">&#34;bad&nbsp;kind&nbsp;in&nbsp;runfinq&#34;</span><span class="op" id="1558135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558147">reflectcall</span><span class="op" id="1558158">(</span><span class="ident" id="1558159">unsafe</span><span class="op" id="1558165">.</span><span class="ident" id="1558166">Pointer</span><span class="op" id="1558173">(</span><span class="ident" id="1558174">f</span><span class="op" id="1558175">.</span><span class="ident" id="1558176">fn</span><span class="op" id="1558178">)</span><span class="op" id="1558179">,</span>&nbsp;<span class="ident" id="1558181">frame</span><span class="op" id="1558186">,</span>&nbsp;<span class="builtintype" id="1558188">uint32</span><span class="op" id="1558194">(</span><span class="ident" id="1558195">framesz</span><span class="op" id="1558202">)</span><span class="op" id="1558203">,</span>&nbsp;<span class="builtintype" id="1558205">uint32</span><span class="op" id="1558211">(</span><span class="ident" id="1558212">framesz</span><span class="op" id="1558219">)</span><span class="op" id="1558220">)</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1558227">//&nbsp;drop&nbsp;finalizer&nbsp;queue&nbsp;references&nbsp;to&nbsp;finalized&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558286">f</span><span class="op" id="1558287">.</span><span class="ident" id="1558288">fn</span>&nbsp;<span class="op" id="1558291">=</span>&nbsp;<span class="ident" id="1558293">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558301">f</span><span class="op" id="1558302">.</span><span class="ident" id="1558303">arg</span>&nbsp;<span class="op" id="1558307">=</span>&nbsp;<span class="ident" id="1558309">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558317">f</span><span class="op" id="1558318">.</span><span class="ident" id="1558319">ot</span>&nbsp;<span class="op" id="1558322">=</span>&nbsp;<span class="ident" id="1558324">nil</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558336">fb</span><span class="op" id="1558338">.</span><span class="ident" id="1558339">cnt</span>&nbsp;<span class="op" id="1558343">=</span>&nbsp;<span class="num" id="1558345">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558350">next</span>&nbsp;<span class="op" id="1558355">:=</span>&nbsp;<span class="ident" id="1558358">fb</span><span class="op" id="1558360">.</span><span class="ident" id="1558361">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558369">lock</span><span class="op" id="1558373">(</span><span class="op" id="1558374">&amp;</span><span class="ident" id="1558375">finlock</span><span class="op" id="1558382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558387">fb</span><span class="op" id="1558389">.</span><span class="ident" id="1558390">next</span>&nbsp;<span class="op" id="1558395">=</span>&nbsp;<span class="ident" id="1558397">finc</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558405">finc</span>&nbsp;<span class="op" id="1558410">=</span>&nbsp;<span class="ident" id="1558412">fb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558418">unlock</span><span class="op" id="1558424">(</span><span class="op" id="1558425">&amp;</span><span class="ident" id="1558426">finlock</span><span class="op" id="1558433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558438">fb</span>&nbsp;<span class="op" id="1558441">=</span>&nbsp;<span class="ident" id="1558443">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558453">}</span><br>
<span class="lineno">785</span><span class="op" id="1558455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1558458">var</span>&nbsp;<span class="ident" id="1558462">persistent</span>&nbsp;<span class="keyword" id="1558473">struct</span>&nbsp;<span class="op" id="1558480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558483">lock</span>&nbsp;<span class="ident" id="1558488">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558495">pos</span>&nbsp;&nbsp;<span class="ident" id="1558500">unsafe</span><span class="op" id="1558506">.</span><span class="ident" id="1558507">Pointer</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558516">end</span>&nbsp;&nbsp;<span class="ident" id="1558521">unsafe</span><span class="op" id="1558527">.</span><span class="ident" id="1558528">Pointer</span><br>
<span class="lineno"></span><span class="op" id="1558536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1558539">//&nbsp;Wrapper&nbsp;around&nbsp;sysAlloc&nbsp;that&nbsp;can&nbsp;allocate&nbsp;small&nbsp;chunks.</span><br>
<span class="lineno"></span><span class="comment" id="1558598">//&nbsp;There&nbsp;is&nbsp;no&nbsp;associated&nbsp;free&nbsp;operation.</span><br>
<span class="lineno">795</span><span class="comment" id="1558640">//&nbsp;Intended&nbsp;for&nbsp;things&nbsp;like&nbsp;function/type/debug-related&nbsp;persistent&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="1558713">//&nbsp;If&nbsp;align&nbsp;is&nbsp;0,&nbsp;uses&nbsp;default&nbsp;align&nbsp;(currently&nbsp;8).</span><br>
<span class="lineno"></span><span class="keyword" id="1558765">func</span>&nbsp;<span class="ident" id="1558770">persistentalloc</span><span class="op" id="1558785">(</span><span class="ident" id="1558786">size</span><span class="op" id="1558790">,</span>&nbsp;<span class="ident" id="1558792">align</span>&nbsp;<span class="builtintype" id="1558798">uintptr</span><span class="op" id="1558805">,</span>&nbsp;<span class="ident" id="1558807">stat</span>&nbsp;<span class="op" id="1558812">*</span><span class="ident" id="1558813">uint64</span><span class="op" id="1558819">)</span>&nbsp;<span class="ident" id="1558821">unsafe</span><span class="op" id="1558827">.</span><span class="ident" id="1558828">Pointer</span>&nbsp;<span class="op" id="1558836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558839">const</span>&nbsp;<span class="op" id="1558845">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558849">chunk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558858">=</span>&nbsp;<span class="num" id="1558860">256</span>&nbsp;<span class="op" id="1558864">&lt;&lt;</span>&nbsp;<span class="num" id="1558867">10</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558872">maxBlock</span>&nbsp;<span class="op" id="1558881">=</span>&nbsp;<span class="num" id="1558883">64</span>&nbsp;<span class="op" id="1558886">&lt;&lt;</span>&nbsp;<span class="num" id="1558889">10</span>&nbsp;<span class="comment" id="1558892">//&nbsp;VM&nbsp;reservation&nbsp;granularity&nbsp;is&nbsp;64K&nbsp;on&nbsp;windows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1558941">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558945">if</span>&nbsp;<span class="ident" id="1558948">align</span>&nbsp;<span class="op" id="1558954">!=</span>&nbsp;<span class="num" id="1558957">0</span>&nbsp;<span class="op" id="1558959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1558963">if</span>&nbsp;<span class="ident" id="1558966">align</span><span class="op" id="1558971">&amp;</span><span class="op" id="1558972">(</span><span class="ident" id="1558973">align</span><span class="op" id="1558978">-</span><span class="num" id="1558979">1</span><span class="op" id="1558980">)</span>&nbsp;<span class="op" id="1558982">!=</span>&nbsp;<span class="num" id="1558985">0</span>&nbsp;<span class="op" id="1558987">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1558992">gothrow</span><span class="op" id="1558999">(</span><span class="string" id="1559000">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;not&nbsp;a&nbsp;power&nbsp;of&nbsp;2&#34;</span><span class="op" id="1559044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559052">if</span>&nbsp;<span class="ident" id="1559055">align</span>&nbsp;<span class="op" id="1559061">&gt;</span>&nbsp;<span class="ident" id="1559063">_PageSize</span>&nbsp;<span class="op" id="1559073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559078">gothrow</span><span class="op" id="1559085">(</span><span class="string" id="1559086">&#34;persistentalloc:&nbsp;align&nbsp;is&nbsp;too&nbsp;large&#34;</span><span class="op" id="1559123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559127">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559130">}</span>&nbsp;<span class="keyword" id="1559132">else</span>&nbsp;<span class="op" id="1559137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559141">align</span>&nbsp;<span class="op" id="1559147">=</span>&nbsp;<span class="num" id="1559149">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559156">if</span>&nbsp;<span class="ident" id="1559159">size</span>&nbsp;<span class="op" id="1559164">&gt;=</span>&nbsp;<span class="ident" id="1559167">maxBlock</span>&nbsp;<span class="op" id="1559176">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559180">return</span>&nbsp;<span class="ident" id="1559187">sysAlloc</span><span class="op" id="1559195">(</span><span class="ident" id="1559196">size</span><span class="op" id="1559200">,</span>&nbsp;<span class="ident" id="1559202">stat</span><span class="op" id="1559206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559213">lock</span><span class="op" id="1559217">(</span><span class="op" id="1559218">&amp;</span><span class="ident" id="1559219">persistent</span><span class="op" id="1559229">.</span><span class="ident" id="1559230">lock</span><span class="op" id="1559234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559237">persistent</span><span class="op" id="1559247">.</span><span class="ident" id="1559248">pos</span>&nbsp;<span class="op" id="1559252">=</span>&nbsp;<span class="ident" id="1559254">roundup</span><span class="op" id="1559261">(</span><span class="ident" id="1559262">persistent</span><span class="op" id="1559272">.</span><span class="ident" id="1559273">pos</span><span class="op" id="1559276">,</span>&nbsp;<span class="ident" id="1559278">align</span><span class="op" id="1559283">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559286">if</span>&nbsp;<span class="builtintype" id="1559289">uintptr</span><span class="op" id="1559296">(</span><span class="ident" id="1559297">persistent</span><span class="op" id="1559307">.</span><span class="ident" id="1559308">pos</span><span class="op" id="1559311">)</span><span class="op" id="1559312">+</span><span class="ident" id="1559313">size</span>&nbsp;<span class="op" id="1559318">&gt;</span>&nbsp;<span class="builtintype" id="1559320">uintptr</span><span class="op" id="1559327">(</span><span class="ident" id="1559328">persistent</span><span class="op" id="1559338">.</span><span class="ident" id="1559339">end</span><span class="op" id="1559342">)</span>&nbsp;<span class="op" id="1559344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559348">persistent</span><span class="op" id="1559358">.</span><span class="ident" id="1559359">pos</span>&nbsp;<span class="op" id="1559363">=</span>&nbsp;<span class="ident" id="1559365">sysAlloc</span><span class="op" id="1559373">(</span><span class="ident" id="1559374">chunk</span><span class="op" id="1559379">,</span>&nbsp;<span class="op" id="1559381">&amp;</span><span class="ident" id="1559382">memstats</span><span class="op" id="1559390">.</span><span class="ident" id="1559391">other_sys</span><span class="op" id="1559400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559404">if</span>&nbsp;<span class="ident" id="1559407">persistent</span><span class="op" id="1559417">.</span><span class="ident" id="1559418">pos</span>&nbsp;<span class="op" id="1559422">==</span>&nbsp;<span class="ident" id="1559425">nil</span>&nbsp;<span class="op" id="1559429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559434">unlock</span><span class="op" id="1559440">(</span><span class="op" id="1559441">&amp;</span><span class="ident" id="1559442">persistent</span><span class="op" id="1559452">.</span><span class="ident" id="1559453">lock</span><span class="op" id="1559457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559462">gothrow</span><span class="op" id="1559469">(</span><span class="string" id="1559470">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1559503">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559511">persistent</span><span class="op" id="1559521">.</span><span class="ident" id="1559522">end</span>&nbsp;<span class="op" id="1559526">=</span>&nbsp;<span class="ident" id="1559528">add</span><span class="op" id="1559531">(</span><span class="ident" id="1559532">persistent</span><span class="op" id="1559542">.</span><span class="ident" id="1559543">pos</span><span class="op" id="1559546">,</span>&nbsp;<span class="ident" id="1559548">chunk</span><span class="op" id="1559553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559559">p</span>&nbsp;<span class="op" id="1559561">:=</span>&nbsp;<span class="ident" id="1559564">persistent</span><span class="op" id="1559574">.</span><span class="ident" id="1559575">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559580">persistent</span><span class="op" id="1559590">.</span><span class="ident" id="1559591">pos</span>&nbsp;<span class="op" id="1559595">=</span>&nbsp;<span class="ident" id="1559597">add</span><span class="op" id="1559600">(</span><span class="ident" id="1559601">persistent</span><span class="op" id="1559611">.</span><span class="ident" id="1559612">pos</span><span class="op" id="1559615">,</span>&nbsp;<span class="ident" id="1559617">size</span><span class="op" id="1559621">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559624">unlock</span><span class="op" id="1559630">(</span><span class="op" id="1559631">&amp;</span><span class="ident" id="1559632">persistent</span><span class="op" id="1559642">.</span><span class="ident" id="1559643">lock</span><span class="op" id="1559647">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559651">if</span>&nbsp;<span class="ident" id="1559654">stat</span>&nbsp;<span class="op" id="1559659">!=</span>&nbsp;<span class="op" id="1559662">&amp;</span><span class="ident" id="1559663">memstats</span><span class="op" id="1559671">.</span><span class="ident" id="1559672">other_sys</span>&nbsp;<span class="op" id="1559682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559686">xadd64</span><span class="op" id="1559692">(</span><span class="ident" id="1559693">stat</span><span class="op" id="1559697">,</span>&nbsp;<span class="ident" id="1559699">int64</span><span class="op" id="1559704">(</span><span class="ident" id="1559705">size</span><span class="op" id="1559709">)</span><span class="op" id="1559710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1559714">xadd64</span><span class="op" id="1559720">(</span><span class="op" id="1559721">&amp;</span><span class="ident" id="1559722">memstats</span><span class="op" id="1559730">.</span><span class="ident" id="1559731">other_sys</span><span class="op" id="1559740">,</span>&nbsp;<span class="op" id="1559742">-</span><span class="ident" id="1559743">int64</span><span class="op" id="1559748">(</span><span class="ident" id="1559749">size</span><span class="op" id="1559753">)</span><span class="op" id="1559754">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1559757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1559760">return</span>&nbsp;<span class="ident" id="1559767">p</span><br>
<span class="lineno"></span><span class="op" id="1559769">}</span>
</div>
</body>
</html>
