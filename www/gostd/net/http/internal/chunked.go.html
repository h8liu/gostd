<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4090305">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4090360">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4090414">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4090465">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4090527">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4090594">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="4090616">package</span>&nbsp;<span class="ident" id="4090624">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4090634">import</span>&nbsp;<span class="op" id="4090641">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4090644">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4090653">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4090662">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4090672">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4090679">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4090684">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4090687">const</span>&nbsp;<span class="ident" id="4090693">maxLineLength</span>&nbsp;<span class="op" id="4090707">=</span>&nbsp;<span class="num" id="4090709">4096</span>&nbsp;<span class="comment" id="4090714">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4090750">var</span>&nbsp;<span class="ident" id="4090754">ErrLineTooLong</span>&nbsp;<span class="op" id="4090769">=</span>&nbsp;<span class="ident" id="4090771">errors</span><span class="op" id="4090777">.</span><span class="ident" id="4090778">New</span><span class="op" id="4090781">(</span><span class="string" id="4090782">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="4090804">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4090807">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4090892">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="4090945">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="4091020">//</span><br>
<span class="lineno"></span><span class="comment" id="4091023">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4091098">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="4091162">func</span>&nbsp;<span class="ident" id="4091167">NewChunkedReader</span><span class="op" id="4091183">(</span><span class="ident" id="4091184">r</span>&nbsp;<span class="ident" id="4091186">io</span><span class="op" id="4091188">.</span><span class="ident" id="4091189">Reader</span><span class="op" id="4091195">)</span>&nbsp;<span class="ident" id="4091197">io</span><span class="op" id="4091199">.</span><span class="ident" id="4091200">Reader</span>&nbsp;<span class="op" id="4091207">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091210">br</span><span class="op" id="4091212">,</span>&nbsp;<span class="ident" id="4091214">ok</span>&nbsp;<span class="op" id="4091217">:=</span>&nbsp;<span class="ident" id="4091220">r</span><span class="op" id="4091221">.</span><span class="op" id="4091222">(</span><span class="op" id="4091223">*</span><span class="ident" id="4091224">bufio</span><span class="op" id="4091229">.</span><span class="ident" id="4091230">Reader</span><span class="op" id="4091236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091239">if</span>&nbsp;<span class="op" id="4091242">!</span><span class="ident" id="4091243">ok</span>&nbsp;<span class="op" id="4091246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091250">br</span>&nbsp;<span class="op" id="4091253">=</span>&nbsp;<span class="ident" id="4091255">bufio</span><span class="op" id="4091260">.</span><span class="ident" id="4091261">NewReader</span><span class="op" id="4091270">(</span><span class="ident" id="4091271">r</span><span class="op" id="4091272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4091275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091278">return</span>&nbsp;<span class="op" id="4091285">&amp;</span><span class="ident" id="4091286">chunkedReader</span><span class="op" id="4091299">{</span><span class="ident" id="4091300">r</span><span class="op" id="4091301">:</span>&nbsp;<span class="ident" id="4091303">br</span><span class="op" id="4091305">}</span><br>
<span class="lineno">35</span><span class="op" id="4091307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4091310">type</span>&nbsp;<span class="ident" id="4091315">chunkedReader</span>&nbsp;<span class="keyword" id="4091329">struct</span>&nbsp;<span class="op" id="4091336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091339">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4091343">*</span><span class="ident" id="4091344">bufio</span><span class="op" id="4091349">.</span><span class="ident" id="4091350">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091358">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4091362">uint64</span>&nbsp;<span class="comment" id="4091369">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091395">err</span>&nbsp;<span class="builtintype" id="4091399">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091406">buf</span>&nbsp;<span class="op" id="4091410">[</span><span class="num" id="4091411">2</span><span class="op" id="4091412">]</span><span class="builtintype" id="4091413">byte</span><br>
<span class="lineno"></span><span class="op" id="4091418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4091421">func</span>&nbsp;<span class="op" id="4091426">(</span><span class="ident" id="4091427">cr</span>&nbsp;<span class="op" id="4091430">*</span><span class="ident" id="4091431">chunkedReader</span><span class="op" id="4091444">)</span>&nbsp;<span class="ident" id="4091446">beginChunk</span><span class="op" id="4091456">(</span><span class="op" id="4091457">)</span>&nbsp;<span class="op" id="4091459">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4091462">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091482">var</span>&nbsp;<span class="ident" id="4091486">line</span>&nbsp;<span class="op" id="4091491">[</span><span class="op" id="4091492">]</span><span class="builtintype" id="4091493">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091499">line</span><span class="op" id="4091503">,</span>&nbsp;<span class="ident" id="4091505">cr</span><span class="op" id="4091507">.</span><span class="ident" id="4091508">err</span>&nbsp;<span class="op" id="4091512">=</span>&nbsp;<span class="ident" id="4091514">readLine</span><span class="op" id="4091522">(</span><span class="ident" id="4091523">cr</span><span class="op" id="4091525">.</span><span class="ident" id="4091526">r</span><span class="op" id="4091527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091530">if</span>&nbsp;<span class="ident" id="4091533">cr</span><span class="op" id="4091535">.</span><span class="ident" id="4091536">err</span>&nbsp;<span class="op" id="4091540">!=</span>&nbsp;<span class="ident" id="4091543">nil</span>&nbsp;<span class="op" id="4091547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091551">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4091559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091562">cr</span><span class="op" id="4091564">.</span><span class="ident" id="4091565">n</span><span class="op" id="4091566">,</span>&nbsp;<span class="ident" id="4091568">cr</span><span class="op" id="4091570">.</span><span class="ident" id="4091571">err</span>&nbsp;<span class="op" id="4091575">=</span>&nbsp;<span class="ident" id="4091577">parseHexUint</span><span class="op" id="4091589">(</span><span class="ident" id="4091590">line</span><span class="op" id="4091594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091597">if</span>&nbsp;<span class="ident" id="4091600">cr</span><span class="op" id="4091602">.</span><span class="ident" id="4091603">err</span>&nbsp;<span class="op" id="4091607">!=</span>&nbsp;<span class="ident" id="4091610">nil</span>&nbsp;<span class="op" id="4091614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091618">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4091626">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091629">if</span>&nbsp;<span class="ident" id="4091632">cr</span><span class="op" id="4091634">.</span><span class="ident" id="4091635">n</span>&nbsp;<span class="op" id="4091637">==</span>&nbsp;<span class="num" id="4091640">0</span>&nbsp;<span class="op" id="4091642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091646">cr</span><span class="op" id="4091648">.</span><span class="ident" id="4091649">err</span>&nbsp;<span class="op" id="4091653">=</span>&nbsp;<span class="ident" id="4091655">io</span><span class="op" id="4091657">.</span><span class="ident" id="4091658">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4091663">}</span><br>
<span class="lineno"></span><span class="op" id="4091665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4091668">func</span>&nbsp;<span class="op" id="4091673">(</span><span class="ident" id="4091674">cr</span>&nbsp;<span class="op" id="4091677">*</span><span class="ident" id="4091678">chunkedReader</span><span class="op" id="4091691">)</span>&nbsp;<span class="ident" id="4091693">chunkHeaderAvailable</span><span class="op" id="4091713">(</span><span class="op" id="4091714">)</span>&nbsp;<span class="builtintype" id="4091716">bool</span>&nbsp;<span class="op" id="4091721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091724">n</span>&nbsp;<span class="op" id="4091726">:=</span>&nbsp;<span class="ident" id="4091729">cr</span><span class="op" id="4091731">.</span><span class="ident" id="4091732">r</span><span class="op" id="4091733">.</span><span class="ident" id="4091734">Buffered</span><span class="op" id="4091742">(</span><span class="op" id="4091743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091746">if</span>&nbsp;<span class="ident" id="4091749">n</span>&nbsp;<span class="op" id="4091751">&gt;</span>&nbsp;<span class="num" id="4091753">0</span>&nbsp;<span class="op" id="4091755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4091759">peek</span><span class="op" id="4091763">,</span>&nbsp;<span class="ident" id="4091765">_</span>&nbsp;<span class="op" id="4091767">:=</span>&nbsp;<span class="ident" id="4091770">cr</span><span class="op" id="4091772">.</span><span class="ident" id="4091773">r</span><span class="op" id="4091774">.</span><span class="ident" id="4091775">Peek</span><span class="op" id="4091779">(</span><span class="ident" id="4091780">n</span><span class="op" id="4091781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091785">return</span>&nbsp;<span class="ident" id="4091792">bytes</span><span class="op" id="4091797">.</span><span class="ident" id="4091798">IndexByte</span><span class="op" id="4091807">(</span><span class="ident" id="4091808">peek</span><span class="op" id="4091812">,</span>&nbsp;<span class="string" id="4091814">&#39;\n&#39;</span><span class="op" id="4091818">)</span>&nbsp;<span class="op" id="4091820">&gt;=</span>&nbsp;<span class="num" id="4091823">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4091826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091829">return</span>&nbsp;<span class="builtintype" id="4091836">false</span><br>
<span class="lineno"></span><span class="op" id="4091842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4091845">func</span>&nbsp;<span class="op" id="4091850">(</span><span class="ident" id="4091851">cr</span>&nbsp;<span class="op" id="4091854">*</span><span class="ident" id="4091855">chunkedReader</span><span class="op" id="4091868">)</span>&nbsp;<span class="ident" id="4091870">Read</span><span class="op" id="4091874">(</span><span class="ident" id="4091875">b</span>&nbsp;<span class="op" id="4091877">[</span><span class="op" id="4091878">]</span><span class="builtintype" id="4091879">uint8</span><span class="op" id="4091884">)</span>&nbsp;<span class="op" id="4091886">(</span><span class="ident" id="4091887">n</span>&nbsp;<span class="builtintype" id="4091889">int</span><span class="op" id="4091892">,</span>&nbsp;<span class="ident" id="4091894">err</span>&nbsp;<span class="builtintype" id="4091898">error</span><span class="op" id="4091903">)</span>&nbsp;<span class="op" id="4091905">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091908">for</span>&nbsp;<span class="ident" id="4091912">cr</span><span class="op" id="4091914">.</span><span class="ident" id="4091915">err</span>&nbsp;<span class="op" id="4091919">==</span>&nbsp;<span class="ident" id="4091922">nil</span>&nbsp;<span class="op" id="4091926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091930">if</span>&nbsp;<span class="ident" id="4091933">cr</span><span class="op" id="4091935">.</span><span class="ident" id="4091936">n</span>&nbsp;<span class="op" id="4091938">==</span>&nbsp;<span class="num" id="4091941">0</span>&nbsp;<span class="op" id="4091943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4091948">if</span>&nbsp;<span class="ident" id="4091951">n</span>&nbsp;<span class="op" id="4091953">&gt;</span>&nbsp;<span class="num" id="4091955">0</span>&nbsp;<span class="op" id="4091957">&amp;&amp;</span>&nbsp;<span class="op" id="4091960">!</span><span class="ident" id="4091961">cr</span><span class="op" id="4091963">.</span><span class="ident" id="4091964">chunkHeaderAvailable</span><span class="op" id="4091984">(</span><span class="op" id="4091985">)</span>&nbsp;<span class="op" id="4091987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4091993">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4092043">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092078">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4092087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092092">cr</span><span class="op" id="4092094">.</span><span class="ident" id="4092095">beginChunk</span><span class="op" id="4092105">(</span><span class="op" id="4092106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092111">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4092122">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092126">if</span>&nbsp;<span class="builtinfunc" id="4092129">len</span><span class="op" id="4092132">(</span><span class="ident" id="4092133">b</span><span class="op" id="4092134">)</span>&nbsp;<span class="op" id="4092136">==</span>&nbsp;<span class="num" id="4092139">0</span>&nbsp;<span class="op" id="4092141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092146">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4092154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092158">rbuf</span>&nbsp;<span class="op" id="4092163">:=</span>&nbsp;<span class="ident" id="4092166">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092170">if</span>&nbsp;<span class="ident" id="4092173">uint64</span><span class="op" id="4092179">(</span><span class="builtinfunc" id="4092180">len</span><span class="op" id="4092183">(</span><span class="ident" id="4092184">rbuf</span><span class="op" id="4092188">)</span><span class="op" id="4092189">)</span>&nbsp;<span class="op" id="4092191">&gt;</span>&nbsp;<span class="ident" id="4092193">cr</span><span class="op" id="4092195">.</span><span class="ident" id="4092196">n</span>&nbsp;<span class="op" id="4092198">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092203">rbuf</span>&nbsp;<span class="op" id="4092208">=</span>&nbsp;<span class="ident" id="4092210">rbuf</span><span class="op" id="4092214">[</span><span class="op" id="4092215">:</span><span class="ident" id="4092216">cr</span><span class="op" id="4092218">.</span><span class="ident" id="4092219">n</span><span class="op" id="4092220">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4092224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092228">var</span>&nbsp;<span class="ident" id="4092232">n0</span>&nbsp;<span class="builtintype" id="4092235">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092241">n0</span><span class="op" id="4092243">,</span>&nbsp;<span class="ident" id="4092245">cr</span><span class="op" id="4092247">.</span><span class="ident" id="4092248">err</span>&nbsp;<span class="op" id="4092252">=</span>&nbsp;<span class="ident" id="4092254">cr</span><span class="op" id="4092256">.</span><span class="ident" id="4092257">r</span><span class="op" id="4092258">.</span><span class="ident" id="4092259">Read</span><span class="op" id="4092263">(</span><span class="ident" id="4092264">rbuf</span><span class="op" id="4092268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092272">n</span>&nbsp;<span class="op" id="4092274">+=</span>&nbsp;<span class="ident" id="4092277">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092282">b</span>&nbsp;<span class="op" id="4092284">=</span>&nbsp;<span class="ident" id="4092286">b</span><span class="op" id="4092287">[</span><span class="ident" id="4092288">n0</span><span class="op" id="4092290">:</span><span class="op" id="4092291">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092295">cr</span><span class="op" id="4092297">.</span><span class="ident" id="4092298">n</span>&nbsp;<span class="op" id="4092300">-=</span>&nbsp;<span class="ident" id="4092303">uint64</span><span class="op" id="4092309">(</span><span class="ident" id="4092310">n0</span><span class="op" id="4092312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4092316">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4092371">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092409">if</span>&nbsp;<span class="ident" id="4092412">cr</span><span class="op" id="4092414">.</span><span class="ident" id="4092415">n</span>&nbsp;<span class="op" id="4092417">==</span>&nbsp;<span class="num" id="4092420">0</span>&nbsp;<span class="op" id="4092422">&amp;&amp;</span>&nbsp;<span class="ident" id="4092425">cr</span><span class="op" id="4092427">.</span><span class="ident" id="4092428">err</span>&nbsp;<span class="op" id="4092432">==</span>&nbsp;<span class="ident" id="4092435">nil</span>&nbsp;<span class="op" id="4092439">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092444">if</span>&nbsp;<span class="ident" id="4092447">_</span><span class="op" id="4092448">,</span>&nbsp;<span class="ident" id="4092450">cr</span><span class="op" id="4092452">.</span><span class="ident" id="4092453">err</span>&nbsp;<span class="op" id="4092457">=</span>&nbsp;<span class="ident" id="4092459">io</span><span class="op" id="4092461">.</span><span class="ident" id="4092462">ReadFull</span><span class="op" id="4092470">(</span><span class="ident" id="4092471">cr</span><span class="op" id="4092473">.</span><span class="ident" id="4092474">r</span><span class="op" id="4092475">,</span>&nbsp;<span class="ident" id="4092477">cr</span><span class="op" id="4092479">.</span><span class="ident" id="4092480">buf</span><span class="op" id="4092483">[</span><span class="op" id="4092484">:</span><span class="num" id="4092485">2</span><span class="op" id="4092486">]</span><span class="op" id="4092487">)</span><span class="op" id="4092488">;</span>&nbsp;<span class="ident" id="4092490">cr</span><span class="op" id="4092492">.</span><span class="ident" id="4092493">err</span>&nbsp;<span class="op" id="4092497">==</span>&nbsp;<span class="ident" id="4092500">nil</span>&nbsp;<span class="op" id="4092504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092510">if</span>&nbsp;<span class="ident" id="4092513">cr</span><span class="op" id="4092515">.</span><span class="ident" id="4092516">buf</span><span class="op" id="4092519">[</span><span class="num" id="4092520">0</span><span class="op" id="4092521">]</span>&nbsp;<span class="op" id="4092523">!=</span>&nbsp;<span class="string" id="4092526">&#39;\r&#39;</span>&nbsp;<span class="op" id="4092531">||</span>&nbsp;<span class="ident" id="4092534">cr</span><span class="op" id="4092536">.</span><span class="ident" id="4092537">buf</span><span class="op" id="4092540">[</span><span class="num" id="4092541">1</span><span class="op" id="4092542">]</span>&nbsp;<span class="op" id="4092544">!=</span>&nbsp;<span class="string" id="4092547">&#39;\n&#39;</span>&nbsp;<span class="op" id="4092552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4092559">cr</span><span class="op" id="4092561">.</span><span class="ident" id="4092562">err</span>&nbsp;<span class="op" id="4092566">=</span>&nbsp;<span class="ident" id="4092568">errors</span><span class="op" id="4092574">.</span><span class="ident" id="4092575">New</span><span class="op" id="4092578">(</span><span class="string" id="4092579">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="4092607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4092613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4092618">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4092622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4092625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092628">return</span>&nbsp;<span class="ident" id="4092635">n</span><span class="op" id="4092636">,</span>&nbsp;<span class="ident" id="4092638">cr</span><span class="op" id="4092640">.</span><span class="ident" id="4092641">err</span><br>
<span class="lineno"></span><span class="op" id="4092645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4092648">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4092691">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="4092737">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4092789">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4092853">func</span>&nbsp;<span class="ident" id="4092858">readLine</span><span class="op" id="4092866">(</span><span class="ident" id="4092867">b</span>&nbsp;<span class="op" id="4092869">*</span><span class="ident" id="4092870">bufio</span><span class="op" id="4092875">.</span><span class="ident" id="4092876">Reader</span><span class="op" id="4092882">)</span>&nbsp;<span class="op" id="4092884">(</span><span class="ident" id="4092885">p</span>&nbsp;<span class="op" id="4092887">[</span><span class="op" id="4092888">]</span><span class="builtintype" id="4092889">byte</span><span class="op" id="4092893">,</span>&nbsp;<span class="ident" id="4092895">err</span>&nbsp;<span class="builtintype" id="4092899">error</span><span class="op" id="4092904">)</span>&nbsp;<span class="op" id="4092906">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4092909">if</span>&nbsp;<span class="ident" id="4092912">p</span><span class="op" id="4092913">,</span>&nbsp;<span class="ident" id="4092915">err</span>&nbsp;<span class="op" id="4092919">=</span>&nbsp;<span class="ident" id="4092921">b</span><span class="op" id="4092922">.</span><span class="ident" id="4092923">ReadSlice</span><span class="op" id="4092932">(</span><span class="string" id="4092933">&#39;\n&#39;</span><span class="op" id="4092937">)</span><span class="op" id="4092938">;</span>&nbsp;<span class="ident" id="4092940">err</span>&nbsp;<span class="op" id="4092944">!=</span>&nbsp;<span class="ident" id="4092947">nil</span>&nbsp;<span class="op" id="4092951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4092955">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4092995">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093056">if</span>&nbsp;<span class="ident" id="4093059">err</span>&nbsp;<span class="op" id="4093063">==</span>&nbsp;<span class="ident" id="4093066">io</span><span class="op" id="4093068">.</span><span class="ident" id="4093069">EOF</span>&nbsp;<span class="op" id="4093073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4093078">err</span>&nbsp;<span class="op" id="4093082">=</span>&nbsp;<span class="ident" id="4093084">io</span><span class="op" id="4093086">.</span><span class="ident" id="4093087">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4093106">}</span>&nbsp;<span class="keyword" id="4093108">else</span>&nbsp;<span class="keyword" id="4093113">if</span>&nbsp;<span class="ident" id="4093116">err</span>&nbsp;<span class="op" id="4093120">==</span>&nbsp;<span class="ident" id="4093123">bufio</span><span class="op" id="4093128">.</span><span class="ident" id="4093129">ErrBufferFull</span>&nbsp;<span class="op" id="4093143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4093148">err</span>&nbsp;<span class="op" id="4093152">=</span>&nbsp;<span class="ident" id="4093154">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4093171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093175">return</span>&nbsp;<span class="ident" id="4093182">nil</span><span class="op" id="4093185">,</span>&nbsp;<span class="ident" id="4093187">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4093192">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093195">if</span>&nbsp;<span class="builtinfunc" id="4093198">len</span><span class="op" id="4093201">(</span><span class="ident" id="4093202">p</span><span class="op" id="4093203">)</span>&nbsp;<span class="op" id="4093205">&gt;=</span>&nbsp;<span class="ident" id="4093208">maxLineLength</span>&nbsp;<span class="op" id="4093222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093226">return</span>&nbsp;<span class="ident" id="4093233">nil</span><span class="op" id="4093236">,</span>&nbsp;<span class="ident" id="4093238">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4093254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093257">return</span>&nbsp;<span class="ident" id="4093264">trimTrailingWhitespace</span><span class="op" id="4093286">(</span><span class="ident" id="4093287">p</span><span class="op" id="4093288">)</span><span class="op" id="4093289">,</span>&nbsp;<span class="ident" id="4093291">nil</span><br>
<span class="lineno"></span><span class="op" id="4093295">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4093298">func</span>&nbsp;<span class="ident" id="4093303">trimTrailingWhitespace</span><span class="op" id="4093325">(</span><span class="ident" id="4093326">b</span>&nbsp;<span class="op" id="4093328">[</span><span class="op" id="4093329">]</span><span class="builtintype" id="4093330">byte</span><span class="op" id="4093334">)</span>&nbsp;<span class="op" id="4093336">[</span><span class="op" id="4093337">]</span><span class="builtintype" id="4093338">byte</span>&nbsp;<span class="op" id="4093343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093346">for</span>&nbsp;<span class="builtinfunc" id="4093350">len</span><span class="op" id="4093353">(</span><span class="ident" id="4093354">b</span><span class="op" id="4093355">)</span>&nbsp;<span class="op" id="4093357">&gt;</span>&nbsp;<span class="num" id="4093359">0</span>&nbsp;<span class="op" id="4093361">&amp;&amp;</span>&nbsp;<span class="ident" id="4093364">isASCIISpace</span><span class="op" id="4093376">(</span><span class="ident" id="4093377">b</span><span class="op" id="4093378">[</span><span class="builtinfunc" id="4093379">len</span><span class="op" id="4093382">(</span><span class="ident" id="4093383">b</span><span class="op" id="4093384">)</span><span class="op" id="4093385">-</span><span class="num" id="4093386">1</span><span class="op" id="4093387">]</span><span class="op" id="4093388">)</span>&nbsp;<span class="op" id="4093390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4093394">b</span>&nbsp;<span class="op" id="4093396">=</span>&nbsp;<span class="ident" id="4093398">b</span><span class="op" id="4093399">[</span><span class="op" id="4093400">:</span><span class="builtinfunc" id="4093401">len</span><span class="op" id="4093404">(</span><span class="ident" id="4093405">b</span><span class="op" id="4093406">)</span><span class="op" id="4093407">-</span><span class="num" id="4093408">1</span><span class="op" id="4093409">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4093412">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093415">return</span>&nbsp;<span class="ident" id="4093422">b</span><br>
<span class="lineno"></span><span class="op" id="4093424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4093427">func</span>&nbsp;<span class="ident" id="4093432">isASCIISpace</span><span class="op" id="4093444">(</span><span class="ident" id="4093445">b</span>&nbsp;<span class="builtintype" id="4093447">byte</span><span class="op" id="4093451">)</span>&nbsp;<span class="builtintype" id="4093453">bool</span>&nbsp;<span class="op" id="4093458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4093461">return</span>&nbsp;<span class="ident" id="4093468">b</span>&nbsp;<span class="op" id="4093470">==</span>&nbsp;<span class="string" id="4093473">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4093477">||</span>&nbsp;<span class="ident" id="4093480">b</span>&nbsp;<span class="op" id="4093482">==</span>&nbsp;<span class="string" id="4093485">&#39;\t&#39;</span>&nbsp;<span class="op" id="4093490">||</span>&nbsp;<span class="ident" id="4093493">b</span>&nbsp;<span class="op" id="4093495">==</span>&nbsp;<span class="string" id="4093498">&#39;\n&#39;</span>&nbsp;<span class="op" id="4093503">||</span>&nbsp;<span class="ident" id="4093506">b</span>&nbsp;<span class="op" id="4093508">==</span>&nbsp;<span class="string" id="4093511">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="4093516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4093519">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="4093600">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="4093681">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="4093749">//</span><br>
<span class="lineno"></span><span class="comment" id="4093752">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="4093819">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4093882">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4093948">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="4094017">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="4094053">func</span>&nbsp;<span class="ident" id="4094058">NewChunkedWriter</span><span class="op" id="4094074">(</span><span class="ident" id="4094075">w</span>&nbsp;<span class="ident" id="4094077">io</span><span class="op" id="4094079">.</span><span class="ident" id="4094080">Writer</span><span class="op" id="4094086">)</span>&nbsp;<span class="ident" id="4094088">io</span><span class="op" id="4094090">.</span><span class="ident" id="4094091">WriteCloser</span>&nbsp;<span class="op" id="4094103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094106">return</span>&nbsp;<span class="op" id="4094113">&amp;</span><span class="ident" id="4094114">chunkedWriter</span><span class="op" id="4094127">{</span><span class="ident" id="4094128">w</span><span class="op" id="4094129">}</span><br>
<span class="lineno"></span><span class="op" id="4094131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4094134">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="4094209">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4094271">type</span>&nbsp;<span class="ident" id="4094276">chunkedWriter</span>&nbsp;<span class="keyword" id="4094290">struct</span>&nbsp;<span class="op" id="4094297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094300">Wire</span>&nbsp;<span class="ident" id="4094305">io</span><span class="op" id="4094307">.</span><span class="ident" id="4094308">Writer</span><br>
<span class="lineno"></span><span class="op" id="4094315">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4094318">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="4094370">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4094449">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="4094512">func</span>&nbsp;<span class="op" id="4094517">(</span><span class="ident" id="4094518">cw</span>&nbsp;<span class="op" id="4094521">*</span><span class="ident" id="4094522">chunkedWriter</span><span class="op" id="4094535">)</span>&nbsp;<span class="ident" id="4094537">Write</span><span class="op" id="4094542">(</span><span class="ident" id="4094543">data</span>&nbsp;<span class="op" id="4094548">[</span><span class="op" id="4094549">]</span><span class="builtintype" id="4094550">byte</span><span class="op" id="4094554">)</span>&nbsp;<span class="op" id="4094556">(</span><span class="ident" id="4094557">n</span>&nbsp;<span class="builtintype" id="4094559">int</span><span class="op" id="4094562">,</span>&nbsp;<span class="ident" id="4094564">err</span>&nbsp;<span class="builtintype" id="4094568">error</span><span class="op" id="4094573">)</span>&nbsp;<span class="op" id="4094575">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4094579">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094649">if</span>&nbsp;<span class="builtinfunc" id="4094652">len</span><span class="op" id="4094655">(</span><span class="ident" id="4094656">data</span><span class="op" id="4094660">)</span>&nbsp;<span class="op" id="4094662">==</span>&nbsp;<span class="num" id="4094665">0</span>&nbsp;<span class="op" id="4094667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094671">return</span>&nbsp;<span class="num" id="4094678">0</span><span class="op" id="4094679">,</span>&nbsp;<span class="ident" id="4094681">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4094686">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094690">if</span>&nbsp;<span class="ident" id="4094693">_</span><span class="op" id="4094694">,</span>&nbsp;<span class="ident" id="4094696">err</span>&nbsp;<span class="op" id="4094700">=</span>&nbsp;<span class="ident" id="4094702">fmt</span><span class="op" id="4094705">.</span><span class="ident" id="4094706">Fprintf</span><span class="op" id="4094713">(</span><span class="ident" id="4094714">cw</span><span class="op" id="4094716">.</span><span class="ident" id="4094717">Wire</span><span class="op" id="4094721">,</span>&nbsp;<span class="string" id="4094723">&#34;%x\r\n&#34;</span><span class="op" id="4094731">,</span>&nbsp;<span class="builtinfunc" id="4094733">len</span><span class="op" id="4094736">(</span><span class="ident" id="4094737">data</span><span class="op" id="4094741">)</span><span class="op" id="4094742">)</span><span class="op" id="4094743">;</span>&nbsp;<span class="ident" id="4094745">err</span>&nbsp;<span class="op" id="4094749">!=</span>&nbsp;<span class="ident" id="4094752">nil</span>&nbsp;<span class="op" id="4094756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094760">return</span>&nbsp;<span class="num" id="4094767">0</span><span class="op" id="4094768">,</span>&nbsp;<span class="ident" id="4094770">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4094775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094778">if</span>&nbsp;<span class="ident" id="4094781">n</span><span class="op" id="4094782">,</span>&nbsp;<span class="ident" id="4094784">err</span>&nbsp;<span class="op" id="4094788">=</span>&nbsp;<span class="ident" id="4094790">cw</span><span class="op" id="4094792">.</span><span class="ident" id="4094793">Wire</span><span class="op" id="4094797">.</span><span class="ident" id="4094798">Write</span><span class="op" id="4094803">(</span><span class="ident" id="4094804">data</span><span class="op" id="4094808">)</span><span class="op" id="4094809">;</span>&nbsp;<span class="ident" id="4094811">err</span>&nbsp;<span class="op" id="4094815">!=</span>&nbsp;<span class="ident" id="4094818">nil</span>&nbsp;<span class="op" id="4094822">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094826">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4094834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094837">if</span>&nbsp;<span class="ident" id="4094840">n</span>&nbsp;<span class="op" id="4094842">!=</span>&nbsp;<span class="builtinfunc" id="4094845">len</span><span class="op" id="4094848">(</span><span class="ident" id="4094849">data</span><span class="op" id="4094853">)</span>&nbsp;<span class="op" id="4094855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094859">err</span>&nbsp;<span class="op" id="4094863">=</span>&nbsp;<span class="ident" id="4094865">io</span><span class="op" id="4094867">.</span><span class="ident" id="4094868">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094884">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4094892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094895">_</span><span class="op" id="4094896">,</span>&nbsp;<span class="ident" id="4094898">err</span>&nbsp;<span class="op" id="4094902">=</span>&nbsp;<span class="ident" id="4094904">io</span><span class="op" id="4094906">.</span><span class="ident" id="4094907">WriteString</span><span class="op" id="4094918">(</span><span class="ident" id="4094919">cw</span><span class="op" id="4094921">.</span><span class="ident" id="4094922">Wire</span><span class="op" id="4094926">,</span>&nbsp;<span class="string" id="4094928">&#34;\r\n&#34;</span><span class="op" id="4094934">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094938">return</span><br>
<span class="lineno"></span><span class="op" id="4094945">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="4094948">func</span>&nbsp;<span class="op" id="4094953">(</span><span class="ident" id="4094954">cw</span>&nbsp;<span class="op" id="4094957">*</span><span class="ident" id="4094958">chunkedWriter</span><span class="op" id="4094971">)</span>&nbsp;<span class="ident" id="4094973">Close</span><span class="op" id="4094978">(</span><span class="op" id="4094979">)</span>&nbsp;<span class="builtintype" id="4094981">error</span>&nbsp;<span class="op" id="4094987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4094990">_</span><span class="op" id="4094991">,</span>&nbsp;<span class="ident" id="4094993">err</span>&nbsp;<span class="op" id="4094997">:=</span>&nbsp;<span class="ident" id="4095000">io</span><span class="op" id="4095002">.</span><span class="ident" id="4095003">WriteString</span><span class="op" id="4095014">(</span><span class="ident" id="4095015">cw</span><span class="op" id="4095017">.</span><span class="ident" id="4095018">Wire</span><span class="op" id="4095022">,</span>&nbsp;<span class="string" id="4095024">&#34;0\r\n&#34;</span><span class="op" id="4095031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095034">return</span>&nbsp;<span class="ident" id="4095041">err</span><br>
<span class="lineno"></span><span class="op" id="4095045">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="4095048">func</span>&nbsp;<span class="ident" id="4095053">parseHexUint</span><span class="op" id="4095065">(</span><span class="ident" id="4095066">v</span>&nbsp;<span class="op" id="4095068">[</span><span class="op" id="4095069">]</span><span class="builtintype" id="4095070">byte</span><span class="op" id="4095074">)</span>&nbsp;<span class="op" id="4095076">(</span><span class="ident" id="4095077">n</span>&nbsp;<span class="ident" id="4095079">uint64</span><span class="op" id="4095085">,</span>&nbsp;<span class="ident" id="4095087">err</span>&nbsp;<span class="builtintype" id="4095091">error</span><span class="op" id="4095096">)</span>&nbsp;<span class="op" id="4095098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095101">for</span>&nbsp;<span class="ident" id="4095105">_</span><span class="op" id="4095106">,</span>&nbsp;<span class="ident" id="4095108">b</span>&nbsp;<span class="op" id="4095110">:=</span>&nbsp;<span class="keyword" id="4095113">range</span>&nbsp;<span class="ident" id="4095119">v</span>&nbsp;<span class="op" id="4095121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095125">n</span>&nbsp;<span class="op" id="4095127">&lt;&lt;=</span>&nbsp;<span class="num" id="4095131">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095135">switch</span>&nbsp;<span class="op" id="4095142">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095146">case</span>&nbsp;<span class="string" id="4095151">&#39;0&#39;</span>&nbsp;<span class="op" id="4095155">&lt;=</span>&nbsp;<span class="ident" id="4095158">b</span>&nbsp;<span class="op" id="4095160">&amp;&amp;</span>&nbsp;<span class="ident" id="4095163">b</span>&nbsp;<span class="op" id="4095165">&lt;=</span>&nbsp;<span class="string" id="4095168">&#39;9&#39;</span><span class="op" id="4095171">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095176">b</span>&nbsp;<span class="op" id="4095178">=</span>&nbsp;<span class="ident" id="4095180">b</span>&nbsp;<span class="op" id="4095182">-</span>&nbsp;<span class="string" id="4095184">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095190">case</span>&nbsp;<span class="string" id="4095195">&#39;a&#39;</span>&nbsp;<span class="op" id="4095199">&lt;=</span>&nbsp;<span class="ident" id="4095202">b</span>&nbsp;<span class="op" id="4095204">&amp;&amp;</span>&nbsp;<span class="ident" id="4095207">b</span>&nbsp;<span class="op" id="4095209">&lt;=</span>&nbsp;<span class="string" id="4095212">&#39;f&#39;</span><span class="op" id="4095215">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095220">b</span>&nbsp;<span class="op" id="4095222">=</span>&nbsp;<span class="ident" id="4095224">b</span>&nbsp;<span class="op" id="4095226">-</span>&nbsp;<span class="string" id="4095228">&#39;a&#39;</span>&nbsp;<span class="op" id="4095232">+</span>&nbsp;<span class="num" id="4095234">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095239">case</span>&nbsp;<span class="string" id="4095244">&#39;A&#39;</span>&nbsp;<span class="op" id="4095248">&lt;=</span>&nbsp;<span class="ident" id="4095251">b</span>&nbsp;<span class="op" id="4095253">&amp;&amp;</span>&nbsp;<span class="ident" id="4095256">b</span>&nbsp;<span class="op" id="4095258">&lt;=</span>&nbsp;<span class="string" id="4095261">&#39;F&#39;</span><span class="op" id="4095264">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095269">b</span>&nbsp;<span class="op" id="4095271">=</span>&nbsp;<span class="ident" id="4095273">b</span>&nbsp;<span class="op" id="4095275">-</span>&nbsp;<span class="string" id="4095277">&#39;A&#39;</span>&nbsp;<span class="op" id="4095281">+</span>&nbsp;<span class="num" id="4095283">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095288">default</span><span class="op" id="4095295">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095300">return</span>&nbsp;<span class="num" id="4095307">0</span><span class="op" id="4095308">,</span>&nbsp;<span class="ident" id="4095310">errors</span><span class="op" id="4095316">.</span><span class="ident" id="4095317">New</span><span class="op" id="4095320">(</span><span class="string" id="4095321">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="4095351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4095355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095359">n</span>&nbsp;<span class="op" id="4095361">|=</span>&nbsp;<span class="ident" id="4095364">uint64</span><span class="op" id="4095370">(</span><span class="ident" id="4095371">b</span><span class="op" id="4095372">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4095375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095378">return</span><br>
<span class="lineno"></span><span class="op" id="4095385">}</span>
</div>
</body>
</html>
