<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="keyword" id="5366319">package</span>&nbsp;<span class="ident" id="5366327">link8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5366334">import</span>&nbsp;<span class="op" id="5366341">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5366344">&#34;math&#34;</span><br>
<span class="lineno">5</span><span class="op" id="5366351">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5366354">//&nbsp;link&nbsp;is&nbsp;a&nbsp;piece&nbsp;of&nbsp;linking&nbsp;information&nbsp;for&nbsp;an&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5366415">//&nbsp;in&nbsp;a&nbsp;code&nbsp;section&nbsp;at&nbsp;a&nbsp;particular&nbsp;offset.</span><br>
<span class="lineno"></span><span class="comment" id="5366460">//&nbsp;it&nbsp;uses&nbsp;the&nbsp;indices&nbsp;in&nbsp;the&nbsp;package&nbsp;for&nbsp;symbol&nbsp;lookup</span><br>
<span class="lineno">10</span><span class="keyword" id="5366516">type</span>&nbsp;<span class="ident" id="5366521">link</span>&nbsp;<span class="keyword" id="5366526">struct</span>&nbsp;<span class="op" id="5366533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366536">offset</span>&nbsp;<span class="builtintype" id="5366543">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366551">pkg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5366558">uint32</span>&nbsp;<span class="comment" id="5366565">//&nbsp;relative&nbsp;package&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366592">sym</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5366599">uint32</span><br>
<span class="lineno"></span><span class="op" id="5366606">}</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5366609">//&nbsp;Func&nbsp;is&nbsp;a&nbsp;relocatable&nbsp;code&nbsp;section</span><br>
<span class="lineno"></span><span class="keyword" id="5366647">type</span>&nbsp;<span class="ident" id="5366652">Func</span>&nbsp;<span class="keyword" id="5366657">struct</span>&nbsp;<span class="op" id="5366664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366667">insts</span>&nbsp;<span class="op" id="5366673">[</span><span class="op" id="5366674">]</span><span class="builtintype" id="5366675">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366683">links</span>&nbsp;<span class="op" id="5366689">[</span><span class="op" id="5366690">]</span><span class="op" id="5366691">*</span><span class="ident" id="5366692"><a href="/lonnie.io/e8vm/link8/func.go.html#5366521">link</a></span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366699">addr</span>&nbsp;<span class="builtintype" id="5366704">uint32</span><br>
<span class="lineno"></span><span class="op" id="5366711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5366714">//&nbsp;NewFunc&nbsp;creates&nbsp;a&nbsp;new&nbsp;relocatable&nbsp;code&nbsp;section.</span><br>
<span class="lineno">25</span><span class="keyword" id="5366765">func</span>&nbsp;<span class="ident" id="5366770">NewFunc</span><span class="op" id="5366777">(</span><span class="op" id="5366778">)</span>&nbsp;<span class="op" id="5366780">*</span><span class="ident" id="5366781"><a href="/lonnie.io/e8vm/link8/func.go.html#5366652">Func</a></span>&nbsp;<span class="op" id="5366786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366789">return</span>&nbsp;<span class="builtinfunc" id="5366796">new</span><span class="op" id="5366799">(</span><span class="ident" id="5366800"><a href="/lonnie.io/e8vm/link8/func.go.html#5366652">Func</a></span><span class="op" id="5366804">)</span><br>
<span class="lineno"></span><span class="op" id="5366806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5366809">//&nbsp;AddInst&nbsp;appends&nbsp;an&nbsp;instruction&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;function.</span><br>
<span class="lineno">30</span><span class="keyword" id="5366871">func</span>&nbsp;<span class="op" id="5366876">(</span><span class="ident" id="5366877">f</span>&nbsp;<span class="op" id="5366879">*</span><span class="ident" id="5366880"><a href="/lonnie.io/e8vm/link8/func.go.html#5366652">Func</a></span><span class="op" id="5366884">)</span>&nbsp;<span class="ident" id="5366886">AddInst</span><span class="op" id="5366893">(</span><span class="ident" id="5366894">i</span>&nbsp;<span class="builtintype" id="5366896">uint32</span><span class="op" id="5366902">)</span>&nbsp;<span class="op" id="5366904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366907"><a href="/lonnie.io/e8vm/link8/func.go.html#5366877">f</a></span><span class="op" id="5366908">.</span><span class="ident" id="5366909">insts</span>&nbsp;<span class="op" id="5366915">=</span>&nbsp;<span class="builtinfunc" id="5366917">append</span><span class="op" id="5366923">(</span><span class="ident" id="5366924"><a href="/lonnie.io/e8vm/link8/func.go.html#5366877">f</a></span><span class="op" id="5366925">.</span><span class="ident" id="5366926">insts</span><span class="op" id="5366931">,</span>&nbsp;<span class="ident" id="5366933"><a href="/lonnie.io/e8vm/link8/func.go.html#5366894">i</a></span><span class="op" id="5366934">)</span><br>
<span class="lineno"></span><span class="op" id="5366936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5366939">//&nbsp;TooLarge&nbsp;checks&nbsp;if&nbsp;the&nbsp;function&nbsp;size&nbsp;is&nbsp;larger&nbsp;than&nbsp;4GB.</span><br>
<span class="lineno">35</span><span class="keyword" id="5366999">func</span>&nbsp;<span class="op" id="5367004">(</span><span class="ident" id="5367005">f</span>&nbsp;<span class="op" id="5367007">*</span><span class="ident" id="5367008"><a href="/lonnie.io/e8vm/link8/func.go.html#5366652">Func</a></span><span class="op" id="5367012">)</span>&nbsp;<span class="ident" id="5367014">TooLarge</span><span class="op" id="5367022">(</span><span class="op" id="5367023">)</span>&nbsp;<span class="builtintype" id="5367025">bool</span>&nbsp;<span class="op" id="5367030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367033">return</span>&nbsp;<span class="builtinfunc" id="5367040">len</span><span class="op" id="5367043">(</span><span class="ident" id="5367044"><a href="/lonnie.io/e8vm/link8/func.go.html#5367005">f</a></span><span class="op" id="5367045">.</span><span class="ident" id="5367046">insts</span><span class="op" id="5367051">)</span><span class="op" id="5367052">*</span><span class="num" id="5367053">4</span>&nbsp;<span class="op" id="5367055">&gt;=</span>&nbsp;<span class="ident" id="5367058"><a href="/lonnie.io/e8vm/link8/func.go.html#5366344">math</a></span><span class="op" id="5367062">.</span><span class="ident" id="5367063">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="5367072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5367075">//&nbsp;Size&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;function.</span><br>
<span class="lineno">40</span><span class="keyword" id="5367117">func</span>&nbsp;<span class="op" id="5367122">(</span><span class="ident" id="5367123">f</span>&nbsp;<span class="op" id="5367125">*</span><span class="ident" id="5367126"><a href="/lonnie.io/e8vm/link8/func.go.html#5366652">Func</a></span><span class="op" id="5367130">)</span>&nbsp;<span class="ident" id="5367132">Size</span><span class="op" id="5367136">(</span><span class="op" id="5367137">)</span>&nbsp;<span class="builtintype" id="5367139">uint32</span>&nbsp;<span class="op" id="5367146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367149">return</span>&nbsp;<span class="builtintype" id="5367156">uint32</span><span class="op" id="5367162">(</span><span class="builtinfunc" id="5367163">len</span><span class="op" id="5367166">(</span><span class="ident" id="5367167"><a href="/lonnie.io/e8vm/link8/func.go.html#5367123">f</a></span><span class="op" id="5367168">.</span><span class="ident" id="5367169">insts</span><span class="op" id="5367174">)</span>&nbsp;<span class="op" id="5367176">*</span>&nbsp;<span class="num" id="5367178">4</span><span class="op" id="5367179">)</span><br>
<span class="lineno"></span><span class="op" id="5367181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5367184">//&nbsp;AddLink&nbsp;links&nbsp;the&nbsp;last&nbsp;instruction&nbsp;in&nbsp;inst&nbsp;to</span><br>
<span class="lineno">45</span><span class="comment" id="5367233">//&nbsp;the&nbsp;symbol&nbsp;pkg.sym,&nbsp;where&nbsp;pkg&nbsp;and&nbsp;sym&nbsp;are&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5367288">//&nbsp;indexing&nbsp;of&nbsp;the&nbsp;object&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="5367320">//&nbsp;fill&nbsp;field&nbsp;must&nbsp;be&nbsp;less&nbsp;than&nbsp;4&nbsp;so&nbsp;that&nbsp;it&nbsp;fits&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5367377">//&nbsp;lowest&nbsp;2&nbsp;bits&nbsp;in&nbsp;the&nbsp;offset&nbsp;field.&nbsp;The&nbsp;other&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="5367430">//&nbsp;of&nbsp;the&nbsp;offset&nbsp;fields&nbsp;will&nbsp;be&nbsp;automatically&nbsp;calculated</span><br>
<span class="lineno">50</span><span class="comment" id="5367487">//&nbsp;based&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;instructions&nbsp;in&nbsp;insts.</span><br>
<span class="lineno"></span><span class="keyword" id="5367536">func</span>&nbsp;<span class="op" id="5367541">(</span><span class="ident" id="5367542">f</span>&nbsp;<span class="op" id="5367544">*</span><span class="ident" id="5367545"><a href="/lonnie.io/e8vm/link8/func.go.html#5366652">Func</a></span><span class="op" id="5367549">)</span>&nbsp;<span class="ident" id="5367551">AddLink</span><span class="op" id="5367558">(</span><span class="ident" id="5367559">fill</span>&nbsp;<span class="builtintype" id="5367564">int</span><span class="op" id="5367567">,</span>&nbsp;<span class="ident" id="5367569">pkg</span><span class="op" id="5367572">,</span>&nbsp;<span class="ident" id="5367574">sym</span>&nbsp;<span class="builtintype" id="5367578">uint32</span><span class="op" id="5367584">)</span>&nbsp;<span class="op" id="5367586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367589">if</span>&nbsp;<span class="builtinfunc" id="5367592">len</span><span class="op" id="5367595">(</span><span class="ident" id="5367596"><a href="/lonnie.io/e8vm/link8/func.go.html#5367542">f</a></span><span class="op" id="5367597">.</span><span class="ident" id="5367598">insts</span><span class="op" id="5367603">)</span>&nbsp;<span class="op" id="5367605">==</span>&nbsp;<span class="num" id="5367608">0</span>&nbsp;<span class="op" id="5367610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5367614">panic</span><span class="op" id="5367619">(</span><span class="string" id="5367620">&#34;no&nbsp;inst&nbsp;to&nbsp;link&#34;</span><span class="op" id="5367637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367640">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367643">if</span>&nbsp;<span class="op" id="5367646">!</span><span class="op" id="5367647">(</span><span class="ident" id="5367648"><a href="/lonnie.io/e8vm/link8/func.go.html#5367559">fill</a></span>&nbsp;<span class="op" id="5367653">&gt;</span>&nbsp;<span class="num" id="5367655">0</span>&nbsp;<span class="op" id="5367657">&amp;&amp;</span>&nbsp;<span class="ident" id="5367660"><a href="/lonnie.io/e8vm/link8/func.go.html#5367559">fill</a></span>&nbsp;<span class="op" id="5367665">&lt;=</span>&nbsp;<span class="num" id="5367668">3</span><span class="op" id="5367669">)</span>&nbsp;<span class="op" id="5367671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5367675">panic</span><span class="op" id="5367680">(</span><span class="string" id="5367681">&#34;invalid&nbsp;fill&#34;</span><span class="op" id="5367695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367702">offset</span>&nbsp;<span class="op" id="5367709">:=</span>&nbsp;<span class="builtintype" id="5367712">uint32</span><span class="op" id="5367718">(</span><span class="builtinfunc" id="5367719">len</span><span class="op" id="5367722">(</span><span class="ident" id="5367723"><a href="/lonnie.io/e8vm/link8/func.go.html#5367542">f</a></span><span class="op" id="5367724">.</span><span class="ident" id="5367725">insts</span><span class="op" id="5367730">)</span><span class="op" id="5367731">)</span><span class="op" id="5367732">*</span><span class="num" id="5367733">4</span>&nbsp;<span class="op" id="5367735">-</span>&nbsp;<span class="num" id="5367737">4</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367740"><a href="/lonnie.io/e8vm/link8/func.go.html#5367702">offset</a></span>&nbsp;<span class="op" id="5367747">|=</span>&nbsp;<span class="builtintype" id="5367750">uint32</span><span class="op" id="5367756">(</span><span class="ident" id="5367757"><a href="/lonnie.io/e8vm/link8/func.go.html#5367559">fill</a></span><span class="op" id="5367761">)</span>&nbsp;<span class="op" id="5367763">&amp;</span>&nbsp;<span class="num" id="5367765">0x3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367770">link</span>&nbsp;<span class="op" id="5367775">:=</span>&nbsp;<span class="op" id="5367778">&amp;</span><span class="ident" id="5367779"><a href="/lonnie.io/e8vm/link8/func.go.html#5366521">link</a></span><span class="op" id="5367783">{</span><span class="ident" id="5367784">offset</span><span class="op" id="5367790">:</span>&nbsp;<span class="ident" id="5367792"><a href="/lonnie.io/e8vm/link8/func.go.html#5367702">offset</a></span><span class="op" id="5367798">,</span>&nbsp;<span class="ident" id="5367800">pkg</span><span class="op" id="5367803">:</span>&nbsp;<span class="ident" id="5367805"><a href="/lonnie.io/e8vm/link8/func.go.html#5367569">pkg</a></span><span class="op" id="5367808">,</span>&nbsp;<span class="ident" id="5367810">sym</span><span class="op" id="5367813">:</span>&nbsp;<span class="ident" id="5367815"><a href="/lonnie.io/e8vm/link8/func.go.html#5367574">sym</a></span><span class="op" id="5367818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367821"><a href="/lonnie.io/e8vm/link8/func.go.html#5367542">f</a></span><span class="op" id="5367822">.</span><span class="ident" id="5367823">links</span>&nbsp;<span class="op" id="5367829">=</span>&nbsp;<span class="builtinfunc" id="5367831">append</span><span class="op" id="5367837">(</span><span class="ident" id="5367838"><a href="/lonnie.io/e8vm/link8/func.go.html#5367542">f</a></span><span class="op" id="5367839">.</span><span class="ident" id="5367840">links</span><span class="op" id="5367845">,</span>&nbsp;<span class="ident" id="5367847"><a href="/lonnie.io/e8vm/link8/func.go.html#5367770">link</a></span><span class="op" id="5367851">)</span><br>
<span class="lineno"></span><span class="op" id="5367853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5367856">//&nbsp;Constant&nbsp;fill-later&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="5367888">const</span>&nbsp;<span class="op" id="5367894">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367897">FillNone</span>&nbsp;<span class="op" id="5367906">=</span>&nbsp;<span class="ident" id="5367908">iota</span>&nbsp;<span class="comment" id="5367913">//&nbsp;no&nbsp;fill</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367925">FillLink</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5367941">//&nbsp;fill&nbsp;as&nbsp;linking&nbsp;offset&nbsp;for&nbsp;jump&nbsp;instructions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367990">FillLow</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5368006">//&nbsp;fill&nbsp;with&nbsp;the&nbsp;lower&nbsp;16&nbsp;bits</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368038">FillHigh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5368054">//&nbsp;fill&nbsp;with&nbsp;the&nbsp;higher&nbsp;16&nbsp;bits</span><br>
<span class="lineno"></span><span class="op" id="5368086">)</span>
</div>
</body>
</html>
