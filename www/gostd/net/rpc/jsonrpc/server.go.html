<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html" class="current">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5424130">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5424186">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5424240">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5424291">package</span>&nbsp;<span class="ident" id="5424299">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5424308">import</span>&nbsp;<span class="op" id="5424315">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5424318">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5424335">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5424345">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5424351">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5424362">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5424369">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5424372">var</span>&nbsp;<span class="ident" id="5424376">errMissingParams</span>&nbsp;<span class="op" id="5424393">=</span>&nbsp;<span class="ident" id="5424395">errors</span><span class="op" id="5424401">.</span><span class="ident" id="5424402">New</span><span class="op" id="5424405">(</span><span class="string" id="5424406">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="5424444">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5424447">type</span>&nbsp;<span class="ident" id="5424452">serverCodec</span>&nbsp;<span class="keyword" id="5424464">struct</span>&nbsp;<span class="op" id="5424471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5424474">dec</span>&nbsp;<span class="op" id="5424478">*</span><span class="ident" id="5424479">json</span><span class="op" id="5424483">.</span><span class="ident" id="5424484">Decoder</span>&nbsp;<span class="comment" id="5424492">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5424520">enc</span>&nbsp;<span class="op" id="5424524">*</span><span class="ident" id="5424525">json</span><span class="op" id="5424529">.</span><span class="ident" id="5424530">Encoder</span>&nbsp;<span class="comment" id="5424538">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5424566">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5424570">io</span><span class="op" id="5424572">.</span><span class="ident" id="5424573">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5424582">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5424607">req</span>&nbsp;<span class="ident" id="5424611">serverRequest</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5424627">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5424694">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5424738">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5424797">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5424854">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5424907">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5424957">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5424965">sync</span><span class="op" id="5424969">.</span><span class="ident" id="5424970">Mutex</span>&nbsp;<span class="comment" id="5424976">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425002">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425010">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425018">pending</span>&nbsp;<span class="keyword" id="5425026">map</span><span class="op" id="5425029">[</span><span class="ident" id="5425030">uint64</span><span class="op" id="5425036">]</span><span class="op" id="5425037">*</span><span class="ident" id="5425038">json</span><span class="op" id="5425042">.</span><span class="ident" id="5425043">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="5425054">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="5425057">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="5425129">func</span>&nbsp;<span class="ident" id="5425134">NewServerCodec</span><span class="op" id="5425148">(</span><span class="ident" id="5425149">conn</span>&nbsp;<span class="ident" id="5425154">io</span><span class="op" id="5425156">.</span><span class="ident" id="5425157">ReadWriteCloser</span><span class="op" id="5425172">)</span>&nbsp;<span class="ident" id="5425174">rpc</span><span class="op" id="5425177">.</span><span class="ident" id="5425178">ServerCodec</span>&nbsp;<span class="op" id="5425190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5425193">return</span>&nbsp;<span class="op" id="5425200">&amp;</span><span class="ident" id="5425201">serverCodec</span><span class="op" id="5425212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425216">dec</span><span class="op" id="5425219">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425225">json</span><span class="op" id="5425229">.</span><span class="ident" id="5425230">NewDecoder</span><span class="op" id="5425240">(</span><span class="ident" id="5425241">conn</span><span class="op" id="5425245">)</span><span class="op" id="5425246">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425250">enc</span><span class="op" id="5425253">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425259">json</span><span class="op" id="5425263">.</span><span class="ident" id="5425264">NewEncoder</span><span class="op" id="5425274">(</span><span class="ident" id="5425275">conn</span><span class="op" id="5425279">)</span><span class="op" id="5425280">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425284">c</span><span class="op" id="5425285">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425293">conn</span><span class="op" id="5425297">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425301">pending</span><span class="op" id="5425308">:</span>&nbsp;<span class="builtinfunc" id="5425310">make</span><span class="op" id="5425314">(</span><span class="keyword" id="5425315">map</span><span class="op" id="5425318">[</span><span class="ident" id="5425319">uint64</span><span class="op" id="5425325">]</span><span class="op" id="5425326">*</span><span class="ident" id="5425327">json</span><span class="op" id="5425331">.</span><span class="ident" id="5425332">RawMessage</span><span class="op" id="5425342">)</span><span class="op" id="5425343">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5425346">}</span><br>
<span class="lineno"></span><span class="op" id="5425348">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="5425351">type</span>&nbsp;<span class="ident" id="5425356">serverRequest</span>&nbsp;<span class="keyword" id="5425370">struct</span>&nbsp;<span class="op" id="5425377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425380">Method</span>&nbsp;<span class="builtintype" id="5425387">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5425404">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425421">Params</span>&nbsp;<span class="op" id="5425428">*</span><span class="ident" id="5425429">json</span><span class="op" id="5425433">.</span><span class="ident" id="5425434">RawMessage</span>&nbsp;<span class="string" id="5425445">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425462">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5425469">*</span><span class="ident" id="5425470">json</span><span class="op" id="5425474">.</span><span class="ident" id="5425475">RawMessage</span>&nbsp;<span class="string" id="5425486">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="5425498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5425501">func</span>&nbsp;<span class="op" id="5425506">(</span><span class="ident" id="5425507">r</span>&nbsp;<span class="op" id="5425509">*</span><span class="ident" id="5425510">serverRequest</span><span class="op" id="5425523">)</span>&nbsp;<span class="ident" id="5425525">reset</span><span class="op" id="5425530">(</span><span class="op" id="5425531">)</span>&nbsp;<span class="op" id="5425533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425536">r</span><span class="op" id="5425537">.</span><span class="ident" id="5425538">Method</span>&nbsp;<span class="op" id="5425545">=</span>&nbsp;<span class="string" id="5425547">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425551">r</span><span class="op" id="5425552">.</span><span class="ident" id="5425553">Params</span>&nbsp;<span class="op" id="5425560">=</span>&nbsp;<span class="builtintype" id="5425562">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425567">r</span><span class="op" id="5425568">.</span><span class="ident" id="5425569">Id</span>&nbsp;<span class="op" id="5425572">=</span>&nbsp;<span class="builtintype" id="5425574">nil</span><br>
<span class="lineno"></span><span class="op" id="5425578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5425581">type</span>&nbsp;<span class="ident" id="5425586">serverResponse</span>&nbsp;<span class="keyword" id="5425601">struct</span>&nbsp;<span class="op" id="5425608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425611">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5425618">*</span><span class="ident" id="5425619">json</span><span class="op" id="5425623">.</span><span class="ident" id="5425624">RawMessage</span>&nbsp;<span class="string" id="5425635">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425648">Result</span>&nbsp;<span class="keyword" id="5425655">interface</span><span class="op" id="5425664">{</span><span class="op" id="5425665">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5425672">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425689">Error</span>&nbsp;&nbsp;<span class="keyword" id="5425696">interface</span><span class="op" id="5425705">{</span><span class="op" id="5425706">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5425713">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="5425728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5425731">func</span>&nbsp;<span class="op" id="5425736">(</span><span class="ident" id="5425737">c</span>&nbsp;<span class="op" id="5425739">*</span><span class="ident" id="5425740">serverCodec</span><span class="op" id="5425751">)</span>&nbsp;<span class="ident" id="5425753">ReadRequestHeader</span><span class="op" id="5425770">(</span><span class="ident" id="5425771">r</span>&nbsp;<span class="op" id="5425773">*</span><span class="ident" id="5425774">rpc</span><span class="op" id="5425777">.</span><span class="ident" id="5425778">Request</span><span class="op" id="5425785">)</span>&nbsp;<span class="builtintype" id="5425787">error</span>&nbsp;<span class="op" id="5425793">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425796">c</span><span class="op" id="5425797">.</span><span class="ident" id="5425798">req</span><span class="op" id="5425801">.</span><span class="ident" id="5425802">reset</span><span class="op" id="5425807">(</span><span class="op" id="5425808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5425811">if</span>&nbsp;<span class="ident" id="5425814">err</span>&nbsp;<span class="op" id="5425818">:=</span>&nbsp;<span class="ident" id="5425821">c</span><span class="op" id="5425822">.</span><span class="ident" id="5425823">dec</span><span class="op" id="5425826">.</span><span class="ident" id="5425827">Decode</span><span class="op" id="5425833">(</span><span class="op" id="5425834">&amp;</span><span class="ident" id="5425835">c</span><span class="op" id="5425836">.</span><span class="ident" id="5425837">req</span><span class="op" id="5425840">)</span><span class="op" id="5425841">;</span>&nbsp;<span class="ident" id="5425843">err</span>&nbsp;<span class="op" id="5425847">!=</span>&nbsp;<span class="builtintype" id="5425850">nil</span>&nbsp;<span class="op" id="5425854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5425858">return</span>&nbsp;<span class="ident" id="5425865">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5425870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5425873">r</span><span class="op" id="5425874">.</span><span class="ident" id="5425875">ServiceMethod</span>&nbsp;<span class="op" id="5425889">=</span>&nbsp;<span class="ident" id="5425891">c</span><span class="op" id="5425892">.</span><span class="ident" id="5425893">req</span><span class="op" id="5425896">.</span><span class="ident" id="5425897">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5425906">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5425949">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5425995">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426042">c</span><span class="op" id="5426043">.</span><span class="ident" id="5426044">mutex</span><span class="op" id="5426049">.</span><span class="ident" id="5426050">Lock</span><span class="op" id="5426054">(</span><span class="op" id="5426055">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426058">c</span><span class="op" id="5426059">.</span><span class="ident" id="5426060">seq</span><span class="op" id="5426063">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426067">c</span><span class="op" id="5426068">.</span><span class="ident" id="5426069">pending</span><span class="op" id="5426076">[</span><span class="ident" id="5426077">c</span><span class="op" id="5426078">.</span><span class="ident" id="5426079">seq</span><span class="op" id="5426082">]</span>&nbsp;<span class="op" id="5426084">=</span>&nbsp;<span class="ident" id="5426086">c</span><span class="op" id="5426087">.</span><span class="ident" id="5426088">req</span><span class="op" id="5426091">.</span><span class="ident" id="5426092">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426096">c</span><span class="op" id="5426097">.</span><span class="ident" id="5426098">req</span><span class="op" id="5426101">.</span><span class="ident" id="5426102">Id</span>&nbsp;<span class="op" id="5426105">=</span>&nbsp;<span class="builtintype" id="5426107">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426112">r</span><span class="op" id="5426113">.</span><span class="ident" id="5426114">Seq</span>&nbsp;<span class="op" id="5426118">=</span>&nbsp;<span class="ident" id="5426120">c</span><span class="op" id="5426121">.</span><span class="ident" id="5426122">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426127">c</span><span class="op" id="5426128">.</span><span class="ident" id="5426129">mutex</span><span class="op" id="5426134">.</span><span class="ident" id="5426135">Unlock</span><span class="op" id="5426141">(</span><span class="op" id="5426142">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5426146">return</span>&nbsp;<span class="builtintype" id="5426153">nil</span><br>
<span class="lineno"></span><span class="op" id="5426157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5426160">func</span>&nbsp;<span class="op" id="5426165">(</span><span class="ident" id="5426166">c</span>&nbsp;<span class="op" id="5426168">*</span><span class="ident" id="5426169">serverCodec</span><span class="op" id="5426180">)</span>&nbsp;<span class="ident" id="5426182">ReadRequestBody</span><span class="op" id="5426197">(</span><span class="ident" id="5426198">x</span>&nbsp;<span class="keyword" id="5426200">interface</span><span class="op" id="5426209">{</span><span class="op" id="5426210">}</span><span class="op" id="5426211">)</span>&nbsp;<span class="builtintype" id="5426213">error</span>&nbsp;<span class="op" id="5426219">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5426222">if</span>&nbsp;<span class="ident" id="5426225">x</span>&nbsp;<span class="op" id="5426227">==</span>&nbsp;<span class="builtintype" id="5426230">nil</span>&nbsp;<span class="op" id="5426234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5426238">return</span>&nbsp;<span class="builtintype" id="5426245">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5426250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5426253">if</span>&nbsp;<span class="ident" id="5426256">c</span><span class="op" id="5426257">.</span><span class="ident" id="5426258">req</span><span class="op" id="5426261">.</span><span class="ident" id="5426262">Params</span>&nbsp;<span class="op" id="5426269">==</span>&nbsp;<span class="builtintype" id="5426272">nil</span>&nbsp;<span class="op" id="5426276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5426280">return</span>&nbsp;<span class="ident" id="5426287">errMissingParams</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5426305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5426308">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5426340">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5426366">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5426418">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5426466">var</span>&nbsp;<span class="ident" id="5426470">params</span>&nbsp;<span class="op" id="5426477">[</span><span class="num" id="5426478">1</span><span class="op" id="5426479">]</span><span class="keyword" id="5426480">interface</span><span class="op" id="5426489">{</span><span class="op" id="5426490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426493">params</span><span class="op" id="5426499">[</span><span class="num" id="5426500">0</span><span class="op" id="5426501">]</span>&nbsp;<span class="op" id="5426503">=</span>&nbsp;<span class="ident" id="5426505">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5426508">return</span>&nbsp;<span class="ident" id="5426515">json</span><span class="op" id="5426519">.</span><span class="ident" id="5426520">Unmarshal</span><span class="op" id="5426529">(</span><span class="op" id="5426530">*</span><span class="ident" id="5426531">c</span><span class="op" id="5426532">.</span><span class="ident" id="5426533">req</span><span class="op" id="5426536">.</span><span class="ident" id="5426537">Params</span><span class="op" id="5426543">,</span>&nbsp;<span class="op" id="5426545">&amp;</span><span class="ident" id="5426546">params</span><span class="op" id="5426552">)</span><br>
<span class="lineno"></span><span class="op" id="5426554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5426557">var</span>&nbsp;<span class="ident" id="5426561">null</span>&nbsp;<span class="op" id="5426566">=</span>&nbsp;<span class="ident" id="5426568">json</span><span class="op" id="5426572">.</span><span class="ident" id="5426573">RawMessage</span><span class="op" id="5426583">(</span><span class="op" id="5426584">[</span><span class="op" id="5426585">]</span><span class="builtintype" id="5426586">byte</span><span class="op" id="5426590">(</span><span class="string" id="5426591">&#34;null&#34;</span><span class="op" id="5426597">)</span><span class="op" id="5426598">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5426601">func</span>&nbsp;<span class="op" id="5426606">(</span><span class="ident" id="5426607">c</span>&nbsp;<span class="op" id="5426609">*</span><span class="ident" id="5426610">serverCodec</span><span class="op" id="5426621">)</span>&nbsp;<span class="ident" id="5426623">WriteResponse</span><span class="op" id="5426636">(</span><span class="ident" id="5426637">r</span>&nbsp;<span class="op" id="5426639">*</span><span class="ident" id="5426640">rpc</span><span class="op" id="5426643">.</span><span class="ident" id="5426644">Response</span><span class="op" id="5426652">,</span>&nbsp;<span class="ident" id="5426654">x</span>&nbsp;<span class="keyword" id="5426656">interface</span><span class="op" id="5426665">{</span><span class="op" id="5426666">}</span><span class="op" id="5426667">)</span>&nbsp;<span class="builtintype" id="5426669">error</span>&nbsp;<span class="op" id="5426675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426678">c</span><span class="op" id="5426679">.</span><span class="ident" id="5426680">mutex</span><span class="op" id="5426685">.</span><span class="ident" id="5426686">Lock</span><span class="op" id="5426690">(</span><span class="op" id="5426691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426694">b</span><span class="op" id="5426695">,</span>&nbsp;<span class="ident" id="5426697">ok</span>&nbsp;<span class="op" id="5426700">:=</span>&nbsp;<span class="ident" id="5426703">c</span><span class="op" id="5426704">.</span><span class="ident" id="5426705">pending</span><span class="op" id="5426712">[</span><span class="ident" id="5426713">r</span><span class="op" id="5426714">.</span><span class="ident" id="5426715">Seq</span><span class="op" id="5426718">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5426721">if</span>&nbsp;<span class="op" id="5426724">!</span><span class="ident" id="5426725">ok</span>&nbsp;<span class="op" id="5426728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426732">c</span><span class="op" id="5426733">.</span><span class="ident" id="5426734">mutex</span><span class="op" id="5426739">.</span><span class="ident" id="5426740">Unlock</span><span class="op" id="5426746">(</span><span class="op" id="5426747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5426751">return</span>&nbsp;<span class="ident" id="5426758">errors</span><span class="op" id="5426764">.</span><span class="ident" id="5426765">New</span><span class="op" id="5426768">(</span><span class="string" id="5426769">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="5426806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5426809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5426812">delete</span><span class="op" id="5426818">(</span><span class="ident" id="5426819">c</span><span class="op" id="5426820">.</span><span class="ident" id="5426821">pending</span><span class="op" id="5426828">,</span>&nbsp;<span class="ident" id="5426830">r</span><span class="op" id="5426831">.</span><span class="ident" id="5426832">Seq</span><span class="op" id="5426835">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426838">c</span><span class="op" id="5426839">.</span><span class="ident" id="5426840">mutex</span><span class="op" id="5426845">.</span><span class="ident" id="5426846">Unlock</span><span class="op" id="5426852">(</span><span class="op" id="5426853">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5426857">if</span>&nbsp;<span class="ident" id="5426860">b</span>&nbsp;<span class="op" id="5426862">==</span>&nbsp;<span class="builtintype" id="5426865">nil</span>&nbsp;<span class="op" id="5426869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5426873">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426920">b</span>&nbsp;<span class="op" id="5426922">=</span>&nbsp;<span class="op" id="5426924">&amp;</span><span class="ident" id="5426925">null</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5426931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426934">resp</span>&nbsp;<span class="op" id="5426939">:=</span>&nbsp;<span class="ident" id="5426942">serverResponse</span><span class="op" id="5426956">{</span><span class="ident" id="5426957">Id</span><span class="op" id="5426959">:</span>&nbsp;<span class="ident" id="5426961">b</span><span class="op" id="5426962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5426965">if</span>&nbsp;<span class="ident" id="5426968">r</span><span class="op" id="5426969">.</span><span class="ident" id="5426970">Error</span>&nbsp;<span class="op" id="5426976">==</span>&nbsp;<span class="string" id="5426979">&#34;&#34;</span>&nbsp;<span class="op" id="5426982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5426986">resp</span><span class="op" id="5426990">.</span><span class="ident" id="5426991">Result</span>&nbsp;<span class="op" id="5426998">=</span>&nbsp;<span class="ident" id="5427000">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5427003">}</span>&nbsp;<span class="keyword" id="5427005">else</span>&nbsp;<span class="op" id="5427010">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5427014">resp</span><span class="op" id="5427018">.</span><span class="ident" id="5427019">Error</span>&nbsp;<span class="op" id="5427025">=</span>&nbsp;<span class="ident" id="5427027">r</span><span class="op" id="5427028">.</span><span class="ident" id="5427029">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5427036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5427039">return</span>&nbsp;<span class="ident" id="5427046">c</span><span class="op" id="5427047">.</span><span class="ident" id="5427048">enc</span><span class="op" id="5427051">.</span><span class="ident" id="5427052">Encode</span><span class="op" id="5427058">(</span><span class="ident" id="5427059">resp</span><span class="op" id="5427063">)</span><br>
<span class="lineno"></span><span class="op" id="5427065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="5427068">func</span>&nbsp;<span class="op" id="5427073">(</span><span class="ident" id="5427074">c</span>&nbsp;<span class="op" id="5427076">*</span><span class="ident" id="5427077">serverCodec</span><span class="op" id="5427088">)</span>&nbsp;<span class="ident" id="5427090">Close</span><span class="op" id="5427095">(</span><span class="op" id="5427096">)</span>&nbsp;<span class="builtintype" id="5427098">error</span>&nbsp;<span class="op" id="5427104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5427107">return</span>&nbsp;<span class="ident" id="5427114">c</span><span class="op" id="5427115">.</span><span class="ident" id="5427116">c</span><span class="op" id="5427117">.</span><span class="ident" id="5427118">Close</span><span class="op" id="5427123">(</span><span class="op" id="5427124">)</span><br>
<span class="lineno"></span><span class="op" id="5427126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5427129">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="5427191">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5427262">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5427323">func</span>&nbsp;<span class="ident" id="5427328">ServeConn</span><span class="op" id="5427337">(</span><span class="ident" id="5427338">conn</span>&nbsp;<span class="ident" id="5427343">io</span><span class="op" id="5427345">.</span><span class="ident" id="5427346">ReadWriteCloser</span><span class="op" id="5427361">)</span>&nbsp;<span class="op" id="5427363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5427366">rpc</span><span class="op" id="5427369">.</span><span class="ident" id="5427370">ServeCodec</span><span class="op" id="5427380">(</span><span class="ident" id="5427381">NewServerCodec</span><span class="op" id="5427395">(</span><span class="ident" id="5427396">conn</span><span class="op" id="5427400">)</span><span class="op" id="5427401">)</span><br>
<span class="lineno"></span><span class="op" id="5427403">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
