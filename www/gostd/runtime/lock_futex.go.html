<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1505691">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1505746">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1505800">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1505851">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1505886">package</span>&nbsp;<span class="ident" id="1505894">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1505903">import</span>&nbsp;<span class="string" id="1505910">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1505920">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1505985">//</span><br>
<span class="lineno"></span><span class="comment" id="1505988">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1506047">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspAtomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1506063">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1506091">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspMight&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1506141">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspDon&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1506195">//</span><br>
<span class="lineno"></span><span class="comment" id="1506198">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1506248">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1506309">const</span>&nbsp;<span class="op" id="1506315">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506318">mutex_unlocked</span>&nbsp;<span class="op" id="1506333">=</span>&nbsp;<span class="num" id="1506335">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506338">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1506353">=</span>&nbsp;<span class="num" id="1506355">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506358">mutex_sleeping</span>&nbsp;<span class="op" id="1506373">=</span>&nbsp;<span class="num" id="1506375">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506379">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506395">=</span>&nbsp;<span class="num" id="1506397">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506400">active_spin_cnt</span>&nbsp;<span class="op" id="1506416">=</span>&nbsp;<span class="num" id="1506418">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506422">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1506438">=</span>&nbsp;<span class="num" id="1506440">1</span><br>
<span class="lineno">30</span><span class="op" id="1506442">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1506445">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1506522">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1506601">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1506676">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1506702">func</span>&nbsp;<span class="ident" id="1506707">futexsleep</span><span class="op" id="1506717">(</span><span class="ident" id="1506718">addr</span>&nbsp;<span class="op" id="1506723">*</span><span class="builtintype" id="1506724">uint32</span><span class="op" id="1506730">,</span>&nbsp;<span class="ident" id="1506732">val</span>&nbsp;<span class="builtintype" id="1506736">uint32</span><span class="op" id="1506742">,</span>&nbsp;<span class="ident" id="1506744">ns</span>&nbsp;<span class="ident" id="1506747">int64</span><span class="op" id="1506752">)</span><br>
<span class="lineno"></span><span class="keyword" id="1506754">func</span>&nbsp;<span class="ident" id="1506759">futexwakeup</span><span class="op" id="1506770">(</span><span class="ident" id="1506771">addr</span>&nbsp;<span class="op" id="1506776">*</span><span class="builtintype" id="1506777">uint32</span><span class="op" id="1506783">,</span>&nbsp;<span class="ident" id="1506785">cnt</span>&nbsp;<span class="builtintype" id="1506789">uint32</span><span class="op" id="1506795">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1506798">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1506856">func</span>&nbsp;<span class="ident" id="1506861">key32</span><span class="op" id="1506866">(</span><span class="ident" id="1506867">p</span>&nbsp;<span class="op" id="1506869">*</span><span class="builtintype" id="1506870">uintptr</span><span class="op" id="1506877">)</span>&nbsp;<span class="op" id="1506879">*</span><span class="builtintype" id="1506880">uint32</span>&nbsp;<span class="op" id="1506887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506890">return</span>&nbsp;<span class="op" id="1506897">(</span><span class="op" id="1506898">*</span><span class="builtintype" id="1506899">uint32</span><span class="op" id="1506905">)</span><span class="op" id="1506906">(</span><span class="ident" id="1506907">unsafe</span><span class="op" id="1506913">.</span><span class="ident" id="1506914">Pointer</span><span class="op" id="1506921">(</span><span class="ident" id="1506922">p</span><span class="op" id="1506923">)</span><span class="op" id="1506924">)</span><br>
<span class="lineno"></span><span class="op" id="1506926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1506929">func</span>&nbsp;<span class="ident" id="1506934">lock</span><span class="op" id="1506938">(</span><span class="ident" id="1506939">l</span>&nbsp;<span class="op" id="1506941">*</span><span class="ident" id="1506942">mutex</span><span class="op" id="1506947">)</span>&nbsp;<span class="op" id="1506949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506952">gp</span>&nbsp;<span class="op" id="1506955">:=</span>&nbsp;<span class="ident" id="1506958">getg</span><span class="op" id="1506962">(</span><span class="op" id="1506963">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1506967">if</span>&nbsp;<span class="ident" id="1506970">gp</span><span class="op" id="1506972">.</span><span class="ident" id="1506973">m</span><span class="op" id="1506974">.</span><span class="ident" id="1506975">locks</span>&nbsp;<span class="op" id="1506981">&lt;</span>&nbsp;<span class="num" id="1506983">0</span>&nbsp;<span class="op" id="1506985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1506989">gothrow</span><span class="op" id="1506996">(</span><span class="string" id="1506997">&#34;runtime路lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1507024">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507030">gp</span><span class="op" id="1507032">.</span><span class="ident" id="1507033">m</span><span class="op" id="1507034">.</span><span class="ident" id="1507035">locks</span><span class="op" id="1507040">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507045">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507076">v</span>&nbsp;<span class="op" id="1507078">:=</span>&nbsp;<span class="ident" id="1507081">xchg</span><span class="op" id="1507085">(</span><span class="ident" id="1507086">key32</span><span class="op" id="1507091">(</span><span class="op" id="1507092">&amp;</span><span class="ident" id="1507093">l</span><span class="op" id="1507094">.</span><span class="ident" id="1507095">key</span><span class="op" id="1507098">)</span><span class="op" id="1507099">,</span>&nbsp;<span class="ident" id="1507101">mutex_locked</span><span class="op" id="1507113">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507116">if</span>&nbsp;<span class="ident" id="1507119">v</span>&nbsp;<span class="op" id="1507121">==</span>&nbsp;<span class="ident" id="1507124">mutex_unlocked</span>&nbsp;<span class="op" id="1507139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507143">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507155">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507205">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507257">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507307">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507358">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507413">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507468">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507489">wait</span>&nbsp;<span class="op" id="1507494">:=</span>&nbsp;<span class="ident" id="1507497">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507501">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507542">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507597">spin</span>&nbsp;<span class="op" id="1507602">:=</span>&nbsp;<span class="num" id="1507605">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507608">if</span>&nbsp;<span class="ident" id="1507611">ncpu</span>&nbsp;<span class="op" id="1507616">&gt;</span>&nbsp;<span class="num" id="1507618">1</span>&nbsp;<span class="op" id="1507620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507624">spin</span>&nbsp;<span class="op" id="1507629">=</span>&nbsp;<span class="ident" id="1507631">active_spin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507647">for</span>&nbsp;<span class="op" id="1507651">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507655">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507684">for</span>&nbsp;<span class="ident" id="1507688">i</span>&nbsp;<span class="op" id="1507690">:=</span>&nbsp;<span class="num" id="1507693">0</span><span class="op" id="1507694">;</span>&nbsp;<span class="ident" id="1507696">i</span>&nbsp;<span class="op" id="1507698">&lt;</span>&nbsp;<span class="ident" id="1507700">spin</span><span class="op" id="1507704">;</span>&nbsp;<span class="ident" id="1507706">i</span><span class="op" id="1507707">++</span>&nbsp;<span class="op" id="1507710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507715">for</span>&nbsp;<span class="ident" id="1507719">l</span><span class="op" id="1507720">.</span><span class="ident" id="1507721">key</span>&nbsp;<span class="op" id="1507725">==</span>&nbsp;<span class="ident" id="1507728">mutex_unlocked</span>&nbsp;<span class="op" id="1507743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507749">if</span>&nbsp;<span class="ident" id="1507752">cas</span><span class="op" id="1507755">(</span><span class="ident" id="1507756">key32</span><span class="op" id="1507761">(</span><span class="op" id="1507762">&amp;</span><span class="ident" id="1507763">l</span><span class="op" id="1507764">.</span><span class="ident" id="1507765">key</span><span class="op" id="1507768">)</span><span class="op" id="1507769">,</span>&nbsp;<span class="ident" id="1507771">mutex_unlocked</span><span class="op" id="1507785">,</span>&nbsp;<span class="ident" id="1507787">wait</span><span class="op" id="1507791">)</span>&nbsp;<span class="op" id="1507793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507800">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1507821">procyield</span><span class="op" id="1507830">(</span><span class="ident" id="1507831">active_spin_cnt</span><span class="op" id="1507846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1507850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1507855">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507888">for</span>&nbsp;<span class="ident" id="1507892">i</span>&nbsp;<span class="op" id="1507894">:=</span>&nbsp;<span class="num" id="1507897">0</span><span class="op" id="1507898">;</span>&nbsp;<span class="ident" id="1507900">i</span>&nbsp;<span class="op" id="1507902">&lt;</span>&nbsp;<span class="ident" id="1507904">passive_spin</span><span class="op" id="1507916">;</span>&nbsp;<span class="ident" id="1507918">i</span><span class="op" id="1507919">++</span>&nbsp;<span class="op" id="1507922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507927">for</span>&nbsp;<span class="ident" id="1507931">l</span><span class="op" id="1507932">.</span><span class="ident" id="1507933">key</span>&nbsp;<span class="op" id="1507937">==</span>&nbsp;<span class="ident" id="1507940">mutex_unlocked</span>&nbsp;<span class="op" id="1507955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1507961">if</span>&nbsp;<span class="ident" id="1507964">cas</span><span class="op" id="1507967">(</span><span class="ident" id="1507968">key32</span><span class="op" id="1507973">(</span><span class="op" id="1507974">&amp;</span><span class="ident" id="1507975">l</span><span class="op" id="1507976">.</span><span class="ident" id="1507977">key</span><span class="op" id="1507980">)</span><span class="op" id="1507981">,</span>&nbsp;<span class="ident" id="1507983">mutex_unlocked</span><span class="op" id="1507997">,</span>&nbsp;<span class="ident" id="1507999">wait</span><span class="op" id="1508003">)</span>&nbsp;<span class="op" id="1508005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508012">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508033">osyield</span><span class="op" id="1508040">(</span><span class="op" id="1508041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1508050">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508062">v</span>&nbsp;<span class="op" id="1508064">=</span>&nbsp;<span class="ident" id="1508066">xchg</span><span class="op" id="1508070">(</span><span class="ident" id="1508071">key32</span><span class="op" id="1508076">(</span><span class="op" id="1508077">&amp;</span><span class="ident" id="1508078">l</span><span class="op" id="1508079">.</span><span class="ident" id="1508080">key</span><span class="op" id="1508083">)</span><span class="op" id="1508084">,</span>&nbsp;<span class="ident" id="1508086">mutex_sleeping</span><span class="op" id="1508100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508104">if</span>&nbsp;<span class="ident" id="1508107">v</span>&nbsp;<span class="op" id="1508109">==</span>&nbsp;<span class="ident" id="1508112">mutex_unlocked</span>&nbsp;<span class="op" id="1508127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508132">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508141">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508145">wait</span>&nbsp;<span class="op" id="1508150">=</span>&nbsp;<span class="ident" id="1508152">mutex_sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508169">futexsleep</span><span class="op" id="1508179">(</span><span class="ident" id="1508180">key32</span><span class="op" id="1508185">(</span><span class="op" id="1508186">&amp;</span><span class="ident" id="1508187">l</span><span class="op" id="1508188">.</span><span class="ident" id="1508189">key</span><span class="op" id="1508192">)</span><span class="op" id="1508193">,</span>&nbsp;<span class="ident" id="1508195">mutex_sleeping</span><span class="op" id="1508209">,</span>&nbsp;<span class="op" id="1508211">-</span><span class="num" id="1508212">1</span><span class="op" id="1508213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508216">}</span><br>
<span class="lineno"></span><span class="op" id="1508218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1508221">func</span>&nbsp;<span class="ident" id="1508226">unlock</span><span class="op" id="1508232">(</span><span class="ident" id="1508233">l</span>&nbsp;<span class="op" id="1508235">*</span><span class="ident" id="1508236">mutex</span><span class="op" id="1508241">)</span>&nbsp;<span class="op" id="1508243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508246">v</span>&nbsp;<span class="op" id="1508248">:=</span>&nbsp;<span class="ident" id="1508251">xchg</span><span class="op" id="1508255">(</span><span class="ident" id="1508256">key32</span><span class="op" id="1508261">(</span><span class="op" id="1508262">&amp;</span><span class="ident" id="1508263">l</span><span class="op" id="1508264">.</span><span class="ident" id="1508265">key</span><span class="op" id="1508268">)</span><span class="op" id="1508269">,</span>&nbsp;<span class="ident" id="1508271">mutex_unlocked</span><span class="op" id="1508285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508288">if</span>&nbsp;<span class="ident" id="1508291">v</span>&nbsp;<span class="op" id="1508293">==</span>&nbsp;<span class="ident" id="1508296">mutex_unlocked</span>&nbsp;<span class="op" id="1508311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508315">gothrow</span><span class="op" id="1508322">(</span><span class="string" id="1508323">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1508348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508351">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508354">if</span>&nbsp;<span class="ident" id="1508357">v</span>&nbsp;<span class="op" id="1508359">==</span>&nbsp;<span class="ident" id="1508362">mutex_sleeping</span>&nbsp;<span class="op" id="1508377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508381">futexwakeup</span><span class="op" id="1508392">(</span><span class="ident" id="1508393">key32</span><span class="op" id="1508398">(</span><span class="op" id="1508399">&amp;</span><span class="ident" id="1508400">l</span><span class="op" id="1508401">.</span><span class="ident" id="1508402">key</span><span class="op" id="1508405">)</span><span class="op" id="1508406">,</span>&nbsp;<span class="num" id="1508408">1</span><span class="op" id="1508409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508416">gp</span>&nbsp;<span class="op" id="1508419">:=</span>&nbsp;<span class="ident" id="1508422">getg</span><span class="op" id="1508426">(</span><span class="op" id="1508427">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508430">gp</span><span class="op" id="1508432">.</span><span class="ident" id="1508433">m</span><span class="op" id="1508434">.</span><span class="ident" id="1508435">locks</span><span class="op" id="1508440">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508444">if</span>&nbsp;<span class="ident" id="1508447">gp</span><span class="op" id="1508449">.</span><span class="ident" id="1508450">m</span><span class="op" id="1508451">.</span><span class="ident" id="1508452">locks</span>&nbsp;<span class="op" id="1508458">&lt;</span>&nbsp;<span class="num" id="1508460">0</span>&nbsp;<span class="op" id="1508462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508466">gothrow</span><span class="op" id="1508473">(</span><span class="string" id="1508474">&#34;runtime路unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1508503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508509">if</span>&nbsp;<span class="ident" id="1508512">gp</span><span class="op" id="1508514">.</span><span class="ident" id="1508515">m</span><span class="op" id="1508516">.</span><span class="ident" id="1508517">locks</span>&nbsp;<span class="op" id="1508523">==</span>&nbsp;<span class="num" id="1508526">0</span>&nbsp;<span class="op" id="1508528">&amp;&amp;</span>&nbsp;<span class="ident" id="1508531">gp</span><span class="op" id="1508533">.</span><span class="ident" id="1508534">preempt</span>&nbsp;<span class="op" id="1508542">{</span>&nbsp;<span class="comment" id="1508544">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508617">gp</span><span class="op" id="1508619">.</span><span class="ident" id="1508620">stackguard0</span>&nbsp;<span class="op" id="1508632">=</span>&nbsp;<span class="ident" id="1508634">stackPreempt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508648">}</span><br>
<span class="lineno"></span><span class="op" id="1508650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1508653">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1508680">func</span>&nbsp;<span class="ident" id="1508685">noteclear</span><span class="op" id="1508694">(</span><span class="ident" id="1508695">n</span>&nbsp;<span class="op" id="1508697">*</span><span class="ident" id="1508698">note</span><span class="op" id="1508702">)</span>&nbsp;<span class="op" id="1508704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508707">n</span><span class="op" id="1508708">.</span><span class="ident" id="1508709">key</span>&nbsp;<span class="op" id="1508713">=</span>&nbsp;<span class="num" id="1508715">0</span><br>
<span class="lineno"></span><span class="op" id="1508717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1508720">func</span>&nbsp;<span class="ident" id="1508725">notewakeup</span><span class="op" id="1508735">(</span><span class="ident" id="1508736">n</span>&nbsp;<span class="op" id="1508738">*</span><span class="ident" id="1508739">note</span><span class="op" id="1508743">)</span>&nbsp;<span class="op" id="1508745">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508748">old</span>&nbsp;<span class="op" id="1508752">:=</span>&nbsp;<span class="ident" id="1508755">xchg</span><span class="op" id="1508759">(</span><span class="ident" id="1508760">key32</span><span class="op" id="1508765">(</span><span class="op" id="1508766">&amp;</span><span class="ident" id="1508767">n</span><span class="op" id="1508768">.</span><span class="ident" id="1508769">key</span><span class="op" id="1508772">)</span><span class="op" id="1508773">,</span>&nbsp;<span class="num" id="1508775">1</span><span class="op" id="1508776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508779">if</span>&nbsp;<span class="ident" id="1508782">old</span>&nbsp;<span class="op" id="1508786">!=</span>&nbsp;<span class="num" id="1508789">0</span>&nbsp;<span class="op" id="1508791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1508795">print</span><span class="op" id="1508800">(</span><span class="string" id="1508801">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1508831">,</span>&nbsp;<span class="ident" id="1508833">old</span><span class="op" id="1508836">,</span>&nbsp;<span class="string" id="1508838">&#34;)\n&#34;</span><span class="op" id="1508843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508847">gothrow</span><span class="op" id="1508854">(</span><span class="string" id="1508855">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1508883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1508886">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508889">futexwakeup</span><span class="op" id="1508900">(</span><span class="ident" id="1508901">key32</span><span class="op" id="1508906">(</span><span class="op" id="1508907">&amp;</span><span class="ident" id="1508908">n</span><span class="op" id="1508909">.</span><span class="ident" id="1508910">key</span><span class="op" id="1508913">)</span><span class="op" id="1508914">,</span>&nbsp;<span class="num" id="1508916">1</span><span class="op" id="1508917">)</span><br>
<span class="lineno"></span><span class="op" id="1508919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1508922">func</span>&nbsp;<span class="ident" id="1508927">notesleep</span><span class="op" id="1508936">(</span><span class="ident" id="1508937">n</span>&nbsp;<span class="op" id="1508939">*</span><span class="ident" id="1508940">note</span><span class="op" id="1508944">)</span>&nbsp;<span class="op" id="1508946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508949">gp</span>&nbsp;<span class="op" id="1508952">:=</span>&nbsp;<span class="ident" id="1508955">getg</span><span class="op" id="1508959">(</span><span class="op" id="1508960">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1508963">if</span>&nbsp;<span class="ident" id="1508966">gp</span>&nbsp;<span class="op" id="1508969">!=</span>&nbsp;<span class="ident" id="1508972">gp</span><span class="op" id="1508974">.</span><span class="ident" id="1508975">m</span><span class="op" id="1508976">.</span><span class="ident" id="1508977">g0</span>&nbsp;<span class="op" id="1508980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1508984">gothrow</span><span class="op" id="1508991">(</span><span class="string" id="1508992">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1509013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509019">for</span>&nbsp;<span class="ident" id="1509023">atomicload</span><span class="op" id="1509033">(</span><span class="ident" id="1509034">key32</span><span class="op" id="1509039">(</span><span class="op" id="1509040">&amp;</span><span class="ident" id="1509041">n</span><span class="op" id="1509042">.</span><span class="ident" id="1509043">key</span><span class="op" id="1509046">)</span><span class="op" id="1509047">)</span>&nbsp;<span class="op" id="1509049">==</span>&nbsp;<span class="num" id="1509052">0</span>&nbsp;<span class="op" id="1509054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509058">gp</span><span class="op" id="1509060">.</span><span class="ident" id="1509061">m</span><span class="op" id="1509062">.</span><span class="ident" id="1509063">blocked</span>&nbsp;<span class="op" id="1509071">=</span>&nbsp;<span class="builtintype" id="1509073">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509080">futexsleep</span><span class="op" id="1509090">(</span><span class="ident" id="1509091">key32</span><span class="op" id="1509096">(</span><span class="op" id="1509097">&amp;</span><span class="ident" id="1509098">n</span><span class="op" id="1509099">.</span><span class="ident" id="1509100">key</span><span class="op" id="1509103">)</span><span class="op" id="1509104">,</span>&nbsp;<span class="num" id="1509106">0</span><span class="op" id="1509107">,</span>&nbsp;<span class="op" id="1509109">-</span><span class="num" id="1509110">1</span><span class="op" id="1509111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509115">gp</span><span class="op" id="1509117">.</span><span class="ident" id="1509118">m</span><span class="op" id="1509119">.</span><span class="ident" id="1509120">blocked</span>&nbsp;<span class="op" id="1509128">=</span>&nbsp;<span class="builtintype" id="1509130">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509137">}</span><br>
<span class="lineno"></span><span class="op" id="1509139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1509142">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1509155">func</span>&nbsp;<span class="ident" id="1509160">notetsleep_internal</span><span class="op" id="1509179">(</span><span class="ident" id="1509180">n</span>&nbsp;<span class="op" id="1509182">*</span><span class="ident" id="1509183">note</span><span class="op" id="1509187">,</span>&nbsp;<span class="ident" id="1509189">ns</span>&nbsp;<span class="ident" id="1509192">int64</span><span class="op" id="1509197">)</span>&nbsp;<span class="builtintype" id="1509199">bool</span>&nbsp;<span class="op" id="1509204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509207">gp</span>&nbsp;<span class="op" id="1509210">:=</span>&nbsp;<span class="ident" id="1509213">getg</span><span class="op" id="1509217">(</span><span class="op" id="1509218">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509222">if</span>&nbsp;<span class="ident" id="1509225">ns</span>&nbsp;<span class="op" id="1509228">&lt;</span>&nbsp;<span class="num" id="1509230">0</span>&nbsp;<span class="op" id="1509232">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509236">for</span>&nbsp;<span class="ident" id="1509240">atomicload</span><span class="op" id="1509250">(</span><span class="ident" id="1509251">key32</span><span class="op" id="1509256">(</span><span class="op" id="1509257">&amp;</span><span class="ident" id="1509258">n</span><span class="op" id="1509259">.</span><span class="ident" id="1509260">key</span><span class="op" id="1509263">)</span><span class="op" id="1509264">)</span>&nbsp;<span class="op" id="1509266">==</span>&nbsp;<span class="num" id="1509269">0</span>&nbsp;<span class="op" id="1509271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509276">gp</span><span class="op" id="1509278">.</span><span class="ident" id="1509279">m</span><span class="op" id="1509280">.</span><span class="ident" id="1509281">blocked</span>&nbsp;<span class="op" id="1509289">=</span>&nbsp;<span class="builtintype" id="1509291">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509299">futexsleep</span><span class="op" id="1509309">(</span><span class="ident" id="1509310">key32</span><span class="op" id="1509315">(</span><span class="op" id="1509316">&amp;</span><span class="ident" id="1509317">n</span><span class="op" id="1509318">.</span><span class="ident" id="1509319">key</span><span class="op" id="1509322">)</span><span class="op" id="1509323">,</span>&nbsp;<span class="num" id="1509325">0</span><span class="op" id="1509326">,</span>&nbsp;<span class="op" id="1509328">-</span><span class="num" id="1509329">1</span><span class="op" id="1509330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509335">gp</span><span class="op" id="1509337">.</span><span class="ident" id="1509338">m</span><span class="op" id="1509339">.</span><span class="ident" id="1509340">blocked</span>&nbsp;<span class="op" id="1509348">=</span>&nbsp;<span class="builtintype" id="1509350">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509358">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509362">return</span>&nbsp;<span class="builtintype" id="1509369">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509379">if</span>&nbsp;<span class="ident" id="1509382">atomicload</span><span class="op" id="1509392">(</span><span class="ident" id="1509393">key32</span><span class="op" id="1509398">(</span><span class="op" id="1509399">&amp;</span><span class="ident" id="1509400">n</span><span class="op" id="1509401">.</span><span class="ident" id="1509402">key</span><span class="op" id="1509405">)</span><span class="op" id="1509406">)</span>&nbsp;<span class="op" id="1509408">!=</span>&nbsp;<span class="num" id="1509411">0</span>&nbsp;<span class="op" id="1509413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509417">return</span>&nbsp;<span class="builtintype" id="1509424">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509434">deadline</span>&nbsp;<span class="op" id="1509443">:=</span>&nbsp;<span class="ident" id="1509446">nanotime</span><span class="op" id="1509454">(</span><span class="op" id="1509455">)</span>&nbsp;<span class="op" id="1509457">+</span>&nbsp;<span class="ident" id="1509459">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509463">for</span>&nbsp;<span class="op" id="1509467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509471">gp</span><span class="op" id="1509473">.</span><span class="ident" id="1509474">m</span><span class="op" id="1509475">.</span><span class="ident" id="1509476">blocked</span>&nbsp;<span class="op" id="1509484">=</span>&nbsp;<span class="builtintype" id="1509486">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509493">futexsleep</span><span class="op" id="1509503">(</span><span class="ident" id="1509504">key32</span><span class="op" id="1509509">(</span><span class="op" id="1509510">&amp;</span><span class="ident" id="1509511">n</span><span class="op" id="1509512">.</span><span class="ident" id="1509513">key</span><span class="op" id="1509516">)</span><span class="op" id="1509517">,</span>&nbsp;<span class="num" id="1509519">0</span><span class="op" id="1509520">,</span>&nbsp;<span class="ident" id="1509522">ns</span><span class="op" id="1509524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509528">gp</span><span class="op" id="1509530">.</span><span class="ident" id="1509531">m</span><span class="op" id="1509532">.</span><span class="ident" id="1509533">blocked</span>&nbsp;<span class="op" id="1509541">=</span>&nbsp;<span class="builtintype" id="1509543">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509551">if</span>&nbsp;<span class="ident" id="1509554">atomicload</span><span class="op" id="1509564">(</span><span class="ident" id="1509565">key32</span><span class="op" id="1509570">(</span><span class="op" id="1509571">&amp;</span><span class="ident" id="1509572">n</span><span class="op" id="1509573">.</span><span class="ident" id="1509574">key</span><span class="op" id="1509577">)</span><span class="op" id="1509578">)</span>&nbsp;<span class="op" id="1509580">!=</span>&nbsp;<span class="num" id="1509583">0</span>&nbsp;<span class="op" id="1509585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509590">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509598">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509602">now</span>&nbsp;<span class="op" id="1509606">:=</span>&nbsp;<span class="ident" id="1509609">nanotime</span><span class="op" id="1509617">(</span><span class="op" id="1509618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509622">if</span>&nbsp;<span class="ident" id="1509625">now</span>&nbsp;<span class="op" id="1509629">&gt;=</span>&nbsp;<span class="ident" id="1509632">deadline</span>&nbsp;<span class="op" id="1509641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509646">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509658">ns</span>&nbsp;<span class="op" id="1509661">=</span>&nbsp;<span class="ident" id="1509663">deadline</span>&nbsp;<span class="op" id="1509672">-</span>&nbsp;<span class="ident" id="1509674">now</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509682">return</span>&nbsp;<span class="ident" id="1509689">atomicload</span><span class="op" id="1509699">(</span><span class="ident" id="1509700">key32</span><span class="op" id="1509705">(</span><span class="op" id="1509706">&amp;</span><span class="ident" id="1509707">n</span><span class="op" id="1509708">.</span><span class="ident" id="1509709">key</span><span class="op" id="1509712">)</span><span class="op" id="1509713">)</span>&nbsp;<span class="op" id="1509715">!=</span>&nbsp;<span class="num" id="1509718">0</span><br>
<span class="lineno"></span><span class="op" id="1509720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1509723">func</span>&nbsp;<span class="ident" id="1509728">notetsleep</span><span class="op" id="1509738">(</span><span class="ident" id="1509739">n</span>&nbsp;<span class="op" id="1509741">*</span><span class="ident" id="1509742">note</span><span class="op" id="1509746">,</span>&nbsp;<span class="ident" id="1509748">ns</span>&nbsp;<span class="ident" id="1509751">int64</span><span class="op" id="1509756">)</span>&nbsp;<span class="builtintype" id="1509758">bool</span>&nbsp;<span class="op" id="1509763">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509766">gp</span>&nbsp;<span class="op" id="1509769">:=</span>&nbsp;<span class="ident" id="1509772">getg</span><span class="op" id="1509776">(</span><span class="op" id="1509777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509780">if</span>&nbsp;<span class="ident" id="1509783">gp</span>&nbsp;<span class="op" id="1509786">!=</span>&nbsp;<span class="ident" id="1509789">gp</span><span class="op" id="1509791">.</span><span class="ident" id="1509792">m</span><span class="op" id="1509793">.</span><span class="ident" id="1509794">g0</span>&nbsp;<span class="op" id="1509797">&amp;&amp;</span>&nbsp;<span class="ident" id="1509800">gp</span><span class="op" id="1509802">.</span><span class="ident" id="1509803">m</span><span class="op" id="1509804">.</span><span class="ident" id="1509805">gcing</span>&nbsp;<span class="op" id="1509811">==</span>&nbsp;<span class="num" id="1509814">0</span>&nbsp;<span class="op" id="1509816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1509820">gothrow</span><span class="op" id="1509827">(</span><span class="string" id="1509828">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1509850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1509853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1509857">return</span>&nbsp;<span class="ident" id="1509864">notetsleep_internal</span><span class="op" id="1509883">(</span><span class="ident" id="1509884">n</span><span class="op" id="1509885">,</span>&nbsp;<span class="ident" id="1509887">ns</span><span class="op" id="1509889">)</span><br>
<span class="lineno"></span><span class="op" id="1509891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1509894">//&nbsp;same&nbsp;as&nbsp;runtime路notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1509956">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1510026">func</span>&nbsp;<span class="ident" id="1510031">notetsleepg</span><span class="op" id="1510042">(</span><span class="ident" id="1510043">n</span>&nbsp;<span class="op" id="1510045">*</span><span class="ident" id="1510046">note</span><span class="op" id="1510050">,</span>&nbsp;<span class="ident" id="1510052">ns</span>&nbsp;<span class="ident" id="1510055">int64</span><span class="op" id="1510060">)</span>&nbsp;<span class="builtintype" id="1510062">bool</span>&nbsp;<span class="op" id="1510067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510070">gp</span>&nbsp;<span class="op" id="1510073">:=</span>&nbsp;<span class="ident" id="1510076">getg</span><span class="op" id="1510080">(</span><span class="op" id="1510081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510084">if</span>&nbsp;<span class="ident" id="1510087">gp</span>&nbsp;<span class="op" id="1510090">==</span>&nbsp;<span class="ident" id="1510093">gp</span><span class="op" id="1510095">.</span><span class="ident" id="1510096">m</span><span class="op" id="1510097">.</span><span class="ident" id="1510098">g0</span>&nbsp;<span class="op" id="1510101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510105">gothrow</span><span class="op" id="1510112">(</span><span class="string" id="1510113">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1510132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1510135">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510139">entersyscallblock</span><span class="op" id="1510156">(</span><span class="op" id="1510157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510160">ok</span>&nbsp;<span class="op" id="1510163">:=</span>&nbsp;<span class="ident" id="1510166">notetsleep_internal</span><span class="op" id="1510185">(</span><span class="ident" id="1510186">n</span><span class="op" id="1510187">,</span>&nbsp;<span class="ident" id="1510189">ns</span><span class="op" id="1510191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1510194">exitsyscall</span><span class="op" id="1510205">(</span><span class="op" id="1510206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1510209">return</span>&nbsp;<span class="ident" id="1510216">ok</span><br>
<span class="lineno">205</span><span class="op" id="1510219">}</span>
</div>
</body>
</html>
